000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT400.                                        00020000
000300 AUTHOR.         MARY KING.                                       00030000
000400*DATE-WRITTEN.   JUNE 7, 1995.                                    00040000
000500*DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*    PURCHASE ORDER EXTRACT PROGRAM :                       *     00090000
001000*    PULL SPECIFIC PO INFORMATION FOR DATES PROVIDED ON     *     00100000
001100*    CONTROL CARD.                                          *     00110000
001200*                                                           *     00120000
001300* INPUT:                                                    *     00130000
001400*    DATE PARM CONTROL CARD                                 *     00140000
001500*    TPURCHS - PO TABLE                                     *     00150000
001600*    TPLNSHP - PLANNED SHIPMENT TABLE                       *     00160000
001700*    TPOAGMT - PO AGREEMENT TABLE                           *     00170000
001800*    TPAYTRM - PAY TERMS TABLE                              *     00180000
001900*    TPURITM - PURCHASE ITEM TABLE                          *     00190000
002000*    TEXTENT - EXTERNAL ENTITY TABLE                        *     00200000
002100*    TPOINST - PO INSTRUCTIONS TABLE                        *     00210000
002200*    TINSTCD - SPECIAL INSTRUCTIONS CODE TABLE              *     00220000
002300*                                                           *     00230000
002400* OUTPUT:                                                   *     00240000
002500* 1.  PKMO.AP.PURCHORD.YR9999 --                            *     00250000
002600*     TAPE OF PO INFORMATION FOR SPECIFIC DATE RANGE.       *     00260000
002700*************************************************************     00270000
002800* CHANGE LOG:                                               *     00280000
002900*                                                           *     00290000
003000* 06/07/95    INITIAL VERSION.                              *     00300000
003100*                                                           *     00310000
003200* 04/20/2000  JILL JUEL                    WR# 20563        *     00320000
003300*             INCLUDED RECIP_CDE = 'VN' IN THE INSTRUCTION  *     00330000
003400*             CUSROR.  CHANGED THE LOGIC TO PLACE THE VN    *     00340000
003500*             SPECIAL INSTRUCTIONS IN THE 3RD OCCURANCE OF  *     00350000
003600*             AP400-SPECIAL-INSTR. ADDED THE 3RD OCCURANCE  *     00360000
003700*             OF AP400-SPECIAL-INSTR INCREASING THE SIZE OF *     00370000
003800*             THE COPYBOOK FROM 650 TO 800.                 *     00380000
003900*                                                           *     00390000
004000* 11/10/2000  JILL JUEL                    WR# 20224        *     00400000
004100*             MODIFIED TO CAPTURE THE NEW DISCOUNTS AND     *     00410000
004200*             ADDITIONAL EXTENDED DAYS FROM THE PO.         *     00420000
004300*                                                           *     00430000
004400* 08/16/02 - ADDED EXTRA () IN THE IF STMT TO CHECK THE     *     00440003
004500*            VALIDITY OF THE CONTROL CARD DATES.            *     00450003
004600*        BY: MIKE BESKE                        WR#: 22902   *     00460003
004700*                                                           *     00470002
004800* DATE  02/10/2004                                          *     00480014
004900*     CHANGE MADE: ADDED PO NUMBER TO DISPLAY ON ABEND IN   *     00490014
005000*     PARAGRAPHS THAT OBTAIN TPOAGMT INFORMATION.  THIS WILL*     00500014
005100*     ALLOW RESEARCH TO BE EASIER ON ABEND SITUATIONS.      *     00510014
005200*     MADE BY: ROLLIN KRING            WR/IR #: P000631544  *     00520014
005300*                                                           *     00530014
005400*   DATE  09/26/2006                                        *     00540014
005500*       CHANGE MADE: ADDED CODE TO FETCH ADDITIONAL DISCOUNT*     00550014
005600*       PERCENTAGES FOR RECENTLY ADDED INCENTIVE TYPES FROM *     00560014
005700*       THE TPOAGMT TABLE.  THESE INCLUDE CO-OP OFF INVOICE,*     00570014
005800*       PROFIT ASSIT/AD COOP AND BRIDAL OFF INVOICE.  ADDED *     00580014
005900*       SQL TO SELECT TABLE AND TOWER EXTENDED DAYS FROM    *     00590014
006000*       TPOAGMT ALSO.  APRD400 COPYBOOK WAS MODIFIED TO     *     00600014
006100*       HAVE NEW FIELDS FOR THE 3 ADDL PERCENTAGES.  THE    *     00610014
006200*       TABLE AND TOWER EXTENDED DAYS WILL BE ADDED INTO THE*     00620014
006300*       FIELD THAT ALREADY CONTAINS THE NEW STORE DAYS.     *     00630014
006400*       MOD PARA: R400-, R825-                              *     00640014
006500*       MADE BY: MIKE BESKE              WR/IR #: P000930566*     00650014
006600*************************************************************     00660014
006700                                                                  00670014
006800 ENVIRONMENT DIVISION.                                            00680014
006900                                                                  00690014
007000 INPUT-OUTPUT SECTION.                                            00700014
007100                                                                  00710014
007200 FILE-CONTROL.                                                    00720014
007300                                                                  00730014
007400     SELECT AP-PO-EXTRACT-FILE                                    00740014
007500         ASSIGN TO UT-S-OUT01.                                    00750014
007600                                                                  00760014
007700     SELECT CONTROL-CARD-FILE                                     00770014
007800         ASSIGN TO CARDIN.                                        00780014
007900                                                                  00790014
008000 DATA DIVISION.                                                   00800014
008100                                                                  00810014
008200 FILE SECTION.                                                    00820014
008300                                                                  00830014
008400 FD  AP-PO-EXTRACT-FILE                                           00840014
008500         LABEL RECORDS  ARE STANDARD                              00850014
008600         RECORDING MODE IS  F                                     00860014
008700         DATA RECORD    IS  AP-PO-EXTRACT-RECORD.                 00870014
008800                                                                  00880014
008900 01  AP-PO-EXTRACT-RECORD          PIC X(800).                    00890014
009000                                                                  00900014
009100                                                                  00910014
009200 FD  CONTROL-CARD-FILE                                            00920014
009300     RECORDING MODE IS F                                          00930014
009400     BLOCK CONTAINS 0 RECORDS.                                    00940014
009500 01  CC-RECORD                       PIC X(80).                   00950014
009600*                                                                 00960014
009700/                                                                 00970014
009800 WORKING-STORAGE SECTION.                                         00980014
009900                                                                  00990014
010000 01  FILLER                        PIC X(25) VALUE                01000014
010100                             'WS FOR APKUT400 BEGINS==>'.         01010014
010200 01  ABEND-CODE                    PIC S9(4) COMP SYNC            01020014
010300                                             VALUE ZEROS.         01030014
010400     88 AP-TABLE-FULL              VALUE +4004.                   01040014
010500     88 AP-EMPTY-FILE              VALUE +4005.                   01050014
010600     88 AP-INVALID-CONTROL-CARD    VALUE +4006.                   01060014
010700     88 AP-DB2-ERROR               VALUE +4013.                   01070014
010800                                                                  01080014
010900 01  WS-RETRY-COUNT                PIC S9(4) COMP VALUE ZERO.     01090014
011000 01  WS-RETRY-MAX                  PIC S9(4) COMP VALUE 3.        01100014
011100 01  WS-START-DATE                 PIC X(10) VALUE SPACES.        01110014
011200 01  WS-END-DATE                   PIC X(10) VALUE SPACES.        01120014
011300                                                                  01130014
011400 01  WS-SWITCH-AREA.                                              01140014
011500     05  WS-PO-CSR-SW              PIC X   VALUE 'N'.             01150014
011600         88  END-OF-POS                    VALUE 'Y'.             01160014
011700         88  NOT-END-OF-POS                VALUE 'N'.             01170014
011800     05  WS-INSTRUCTION-SW         PIC X   VALUE 'N'.             01180014
011900         88  END-OF-INSTRUCTIONS           VALUE 'Y'.             01190014
012000         88  NOT-END-OF-INSTRUCTIONS       VALUE 'N'.             01200014
012100     05  WS-PO-AGREEMENT-SW        PIC X   VALUE 'N'.             01210014
012200         88  NO-AGREEMENT-FOUND            VALUE 'N'.             01220014
012300         88  AGREEMENT-FOUND               VALUE 'Y'.             01230014
012400     05  WS-CONTROL-CARD-SW        PIC X   VALUE ' '.             01240014
012500         88  END-OF-CONTROL-CARD           VALUE 'E'.             01250014
012600     05  WS-DISCOUNT-CSR-SW        PIC X   VALUE 'N'.             01260014
012700         88  END-OF-DISCOUNT-CSR           VALUE 'Y'.             01270014
012800         88  NOT-END-OF-DISCOUNT-CSR       VALUE 'N'.             01280014
012900                                                                  01290014
013000 01  WS-ABEND-FIELDS.                                             01300014
013100     05  WS-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUT400'. 01310014
013200     05  WS-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     01320014
013300     05  WS-ABEND-OPERATION           PIC X(50) VALUE SPACES.     01330014
013400     05  WS-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     01340014
013500     05  WS-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     01350014
013600     05  WS-ABEND-STRUCTURE-3         PIC X(9)  VALUE SPACES.     01360014
013700     05  WS-ABEND-STATUS              PIC XX    VALUE SPACES.     01370014
013800                                                                  01380014
013900                                                                  01390014
014000 01  CONTROL-CARD-RECORD.                                         01400014
014100     05  CC-START-DATE.                                           01410014
014200         10  CC-START-YEAR           PIC X(04).                   01420014
014300             88  CC-ST-YEAR-VALID    VALUE '1990' THRU '2099'.    01430014
014400         10  CC-START-HYPHEN1        PIC X.                       01440014
014500             88  CC-ST-HYPEN1-VALID  VALUE '-'.                   01450014
014600         10  CC-START-MONTH          PIC X(02).                   01460014
014700             88  CC-ST-MONTH-VALID   VALUE '01' THRU '12'.        01470014
014800         10  CC-START-HYPHEN2        PIC X.                       01480014
014900             88  CC-ST-HYPEN2-VALID  VALUE '-'.                   01490014
015000         10  CC-START-DAY            PIC X(02).                   01500014
015100             88  CC-ST-DAY-VALID     VALUE '01' THRU '31'.        01510014
015200     05  FILLER                      PIC X(01).                   01520014
015300     05  CC-END-DATE.                                             01530014
015400         10  CC-END-YEAR             PIC X(04).                   01540014
015500             88  CC-END-YEAR-VALID   VALUE '1990' THRU '2099'.    01550014
015600         10  CC-END-HYPHEN1          PIC X.                       01560014
015700             88  CC-END-HYPEN1-VALID VALUE '-'.                   01570014
015800         10  CC-END-MONTH            PIC X(02).                   01580014
015900             88  CC-END-MONTH-VALID  VALUE '01' THRU '12'.        01590014
016000         10  CC-END-HYPHEN2          PIC X.                       01600014
016100             88  CC-END-HYPEN2-VALID VALUE '-'.                   01610014
016200         10  CC-END-DAY              PIC X(02).                   01620014
016300             88  CC-END-DAY-VALID    VALUE '01' THRU '31'.        01630014
016400     05  FILLER                      PIC X(58).                   01640014
016500                                                                  01650014
016600 01  PV-PROGRAM-VARIABLES.                                        01660014
016700     05  PV-DB2-COUNT            PIC S9(09) VALUE +0   COMP-3.    01670014
016800     05  PV-NULL-IND             PIC S9(04) VALUE +0   COMP SYNC. 01680014
016900     05  PV-DB2-DATE             PIC  X(10) VALUE SPACES.         01690014
017000     05  PV-TABLE-TOWER-DAYS     PIC S9(04) COMP.                 01700014
017100     05  PV-DISC-EXTENDED-DAYS   PIC S9(04) COMP.                 01710014
017200     05  PV-NW-STR-DISC-PCT      PIC SV9(4) COMP-3.               01720014
017300     05  PV-INCENTIVE-TYP-CDE    PIC S9(4)  COMP.                 01730014
017400     05  PV-INCENTIVE-DISC-PCT   PIC SV9(4) COMP-3.               01740014
017500                                                                  01750014
017600 01  WS-PROGRAM-COUNTERS.                                         01760014
017700     05  PO-COUNT                PIC 9(9)  VALUE ZEROS.           01770014
017800     05  PO-COUNT-DISPLAY        PIC ZZZZZZZZ9.                   01780014
017900     05  INSTRUC-COUNT           PIC 9(9)  VALUE ZEROS.           01790014
018000                                                                  01800014
018100     COPY DPWS004.                                                01810014
018200                                                                  01820014
018300 01  FILLER                      PIC X(35)  VALUE                 01830014
018400     'PO EXTRACT FILE BEGINS HERE   '.                            01840014
018500     COPY APRD400.                                                01850014
018600                                                                  01860014
018700 01  FILLER                      PIC X(35)  VALUE                 01870014
018800     'END OF AP WORK RECORD AREA       **'.                       01880014
018900                                                                  01890014
019000                                                                  01900014
019100*---------------------------------------------------------------* 01910014
019200*  COMMUNICATIONS AREA2 FOR DB2                                   01920014
019300*---------------------------------------------------------------* 01930014
019400     COPY SQLCA2.                                                 01940014
019500                                                                  01950014
019600*---------------------------------------------------------------* 01960014
019700*    DB2 AREA FOR COMMUNICATIONS                                * 01970014
019800*---------------------------------------------------------------* 01980014
019900     EXEC SQL                                                     01990014
020000          INCLUDE SQLCA                                           02000014
020100     END-EXEC.                                                    02010014
020200 EJECT                                                            02020014
020300*---------------------------------------------------------------* 02030014
020400*    DB2 AREA FOR PO TABLE                                      * 02040014
020500*---------------------------------------------------------------* 02050014
020600     EXEC SQL                                                     02060014
020700          INCLUDE TPURCHS                                         02070014
020800     END-EXEC.                                                    02080014
020900 EJECT                                                            02090014
021000*---------------------------------------------------------------* 02100014
021100*    DB2 AREA FOR PLAN SHIP TABLE                               * 02110014
021200*---------------------------------------------------------------* 02120014
021300     EXEC SQL                                                     02130014
021400          INCLUDE TPLNSHP                                         02140014
021500     END-EXEC.                                                    02150014
021600 EJECT                                                            02160014
021700*---------------------------------------------------------------* 02170014
021800*    DB2 AREA FOR PO AGREEMENT TABLE                            * 02180014
021900*---------------------------------------------------------------* 02190014
022000     EXEC SQL                                                     02200014
022100          INCLUDE TPOAGMT                                         02210014
022200     END-EXEC.                                                    02220014
022300 EJECT                                                            02230014
022400*---------------------------------------------------------------* 02240014
022500*    DB2 AREA FOR PAY TERMS TABLE                               * 02250014
022600*---------------------------------------------------------------* 02260014
022700     EXEC SQL                                                     02270014
022800          INCLUDE TPAYTRM                                         02280014
022900     END-EXEC.                                                    02290014
023000 EJECT                                                            02300014
023100*---------------------------------------------------------------* 02310014
023200*    DB2 AREA FOR PURCHASE ITEM TABLE                           * 02320014
023300*---------------------------------------------------------------* 02330014
023400     EXEC SQL                                                     02340014
023500          INCLUDE TPURITM                                         02350014
023600     END-EXEC.                                                    02360014
023700 EJECT                                                            02370014
023800*---------------------------------------------------------------* 02380014
023900*    DB2 AREA FOR EXTERNAL ENTITY TABLE                         * 02390014
024000*---------------------------------------------------------------* 02400014
024100     EXEC SQL                                                     02410014
024200          INCLUDE TEXTENT                                         02420014
024300     END-EXEC.                                                    02430014
024400 EJECT                                                            02440014
024500*---------------------------------------------------------------* 02450014
024600*    DB2 AREA FOR PO INSTRUCTIONS TABLE                         * 02460014
024700*---------------------------------------------------------------* 02470014
024800     EXEC SQL                                                     02480014
024900          INCLUDE TPOINST                                         02490014
025000     END-EXEC.                                                    02500014
025100 EJECT                                                            02510014
025200*---------------------------------------------------------------* 02520014
025300*    DB2 AREA FOR SPECIAL INSTRUCTIONS TABLE                    * 02530014
025400*---------------------------------------------------------------* 02540014
025500     EXEC SQL                                                     02550014
025600          INCLUDE TINSTCD                                         02560014
025700     END-EXEC.                                                    02570014
025800 EJECT                                                            02580014
025900*---------------------------------------------------------------* 02590014
026000* DECLARE DRIVING PO CURSOR                                     * 02600014
026100*---------------------------------------------------------------* 02610014
026200     EXEC SQL                                                     02620014
026300         DECLARE PO_CSR CURSOR FOR                                02630014
026400          SELECT PO.PO_NBR                                        02640014
026500                ,PO.VER_NBR                                       02650014
026600                ,PO.STATUS_CDE                                    02660014
026700                ,PO.PO_TYP_CDE                                    02670014
026800                ,PO.EDI_IND                                       02680014
026900                ,PO.TOT_VAL_COST_AMT                              02690014
027000                ,PO.TOT_VAL_RTL_AMT                               02700014
027100                ,PO.TOT_MU_PCT                                    02710014
027200                ,PO.TOT_UNT_QTY                                   02720014
027300                ,PO.TOT_SKUS_QTY                                  02730014
027400                ,PO.OTB_PER_NBR                                   02740014
027500                ,PO.NEW_STR_PO_IND                                02750014
027600                ,PO.DIR_STR_IND                                   02760014
027700                ,PO.DEPT_NBR                                      02770014
027800                ,PO.ENT_ID                                        02780014
027900                ,DATE(PO.LAST_UPD_TMST)                           02790014
028000                ,PO.ORD_DTE                                       02800014
028100                ,PO.RLSE_DTE                                      02810014
028200                ,DATE(PS.DONT_SHIP_BEF_DTE)                       02820014
028300                ,DATE(PS.CAN_IFNOT_SHIP_DTE)                      02830014
028400                ,DATE(PS.EXT_CAN_DTE)                             02840014
028500                ,PS.SHIPT_POINT_TXT                               02850014
028600                ,PS.FOB_POINT_TXT                                 02860014
028700                ,PS.LATE_SHIPT_IND                                02870014
028800                ,PS.EARLY_SHIPT_IND                               02880014
028900                ,PS.PARTIAL_SHIPT_IND                             02890014
029000                ,PS.BCKORDS_PERMTD_IND                            02900014
029100                ,PS.FRGT_PAYT_CDE                                 02910014
029200                ,PS.VEND_FRGT_PCT                                 02920014
029300                ,PS.KOHLS_FRGT_PCT                                02930014
029400            FROM TPURCHS PO                                       02940014
029500                ,TPLNSHP PS                                       02950014
029600           WHERE PO.VER_STATUS_CDE    = 'A'                       02960014
029700             AND PO.PO_CATEG_CDE      = 'MR'                      02970014
029800             AND PS.PO_NBR            = PO.PO_NBR                 02980014
029900             AND PS.VER_STATUS_CDE    = PO.VER_STATUS_CDE         02990014
030000             AND DATE(PS.DONT_SHIP_BEF_DTE)                       03000014
030100                 BETWEEN :WS-START-DATE AND :WS-END-DATE          03010014
030200         END-EXEC.                                                03020014
030300 EJECT                                                            03030014
030400*---------------------------------------------------------------* 03040014
030500* DECLARE SPECIAL INSTRUCTION CURSOR                            * 03050014
030600*---------------------------------------------------------------* 03060014
030700     EXEC SQL                                                     03070014
030800         DECLARE INSTRUC_CSR CURSOR FOR                           03080014
030900          SELECT IC.INSTR_DESC                                    03090014
031000                ,SI.INSTR_NBR                                     03100014
031100                ,SI.RECIP_CDE                                     03110014
031200          FROM   TPOINST SI                                       03120014
031300                ,TINSTCD IC                                       03130014
031400          WHERE SI.PO_NBR    = :PURCHS-PO-NBR                     03140014
031500            AND SI.RECIP_CDE IN ('AP', 'VN')                      03150014
031600            AND IC.INSTR_NBR = SI.INSTR_NBR                       03160014
031700          ORDER BY SI.RECIP_CDE, SI.INSTR_NBR                     03170014
031800         END-EXEC.                                                03180014
031900                                                                  03190014
032000*---------------------------------------------------------------* 03200014
032100* DECLARE DISCOUNT CURSOR                                       * 03210014
032200*---------------------------------------------------------------* 03220014
032300     EXEC SQL                                                     03230014
032400         DECLARE DISCOUNT_CSR CURSOR FOR                          03240014
032500          SELECT TYP_CDE                                          03250014
032600                ,DISC_PCT                                         03260014
032700          FROM   TPOAGMT                                          03270014
032800          WHERE PO_NBR         = :PURCHS-PO-NBR                   03280014
032900            AND AGRMT_TYP_ID   = '5'                              03290014
033000            AND VER_STATUS_CDE = 'A'                              03300014
033100            AND DISC_PCT       > 0                                03310014
033200            AND TYP_CDE IN (7, 8, 9, 10, 11, 13)                  03320014
033300     END-EXEC.                                                    03330014
033400                                                                  03340014
033500 01  FILLER                        PIC X(25) VALUE                03350014
033600          '<====WS FOR APKUT400 ENDS'.                            03360014
033700 EJECT                                                            03370014
033800 PROCEDURE DIVISION.                                              03380014
033900                                                                  03390014
034000                                                                  03400014
034100     PERFORM A100-HOUSEKEEPING.                                   03410014
034200                                                                  03420014
034300     PERFORM B100-PROCESSING                                      03430014
034400       UNTIL END-OF-POS.                                          03440014
034500                                                                  03450014
034600     PERFORM B900-END-OF-JOB.                                     03460014
034700                                                                  03470014
034800     GOBACK.                                                      03480014
034900        EJECT                                                     03490014
035000 A100-HOUSEKEEPING.                                               03500014
035100                                                                  03510014
035200                                                                  03520014
035300***************************************************************** 03530014
035400*    PERFORM ALL OF THE DATE AND FILE OPENING ROUTINES          * 03540014
035500***************************************************************** 03550014
035600                                                                  03560014
035700     DISPLAY '*************** PROGRAM: APKUT400 ****************' 03570014
035800     OPEN  OUTPUT  AP-PO-EXTRACT-FILE                             03580014
035900           INPUT   CONTROL-CARD-FILE.                             03590014
036000                                                                  03600014
036100     INITIALIZE DCLTPURCHS                                        03610014
036200                DCLTPLNSHP                                        03620014
036300                DCLTPOAGMT                                        03630014
036400                DCLTPAYTRM                                        03640014
036500                DCLTPURITM                                        03650014
036600                DCLTEXTENT                                        03660014
036700                DCLTPOINST                                        03670014
036800                DCLTINSTCD                                        03680014
036900                AP400-PO-EXTRACT-RECORD                           03690014
037000                AP400-INSTR-DESC (1)                              03700014
037100                AP400-INSTR-DESC (2)                              03710014
037200                AP400-INSTR-DESC (3)                              03720014
037300                PV-PROGRAM-VARIABLES.                             03730014
037400                                                                  03740014
037500     PERFORM Y100-READ-CONTROL-CARD.                              03750014
037600                                                                  03760014
037700     IF  END-OF-CONTROL-CARD                                      03770014
037800         DISPLAY '** APKUT400 ABEND **'                           03780014
037900         DISPLAY '** CONTROL CARD FILE IS EMPTY **'               03790014
038000         SET AP-EMPTY-FILE TO TRUE                                03800014
038100         CALL 'ILBOABN0' USING ABEND-CODE                         03810014
038200     END-IF.                                                      03820014
038300                                                                  03830014
038400     DISPLAY 'CONTROL CARD VALUES =======> '.                     03840014
038500     DISPLAY CONTROL-CARD-RECORD.                                 03850014
038600                                                                  03860014
038700     IF  CC-ST-YEAR-VALID                                         03870014
038800     AND CC-ST-HYPEN1-VALID                                       03880014
038900     AND CC-ST-MONTH-VALID                                        03890014
039000     AND CC-ST-HYPEN2-VALID                                       03900014
039100     AND CC-ST-DAY-VALID                                          03910014
039200     AND CC-END-YEAR-VALID                                        03920014
039300     AND CC-END-HYPEN1-VALID                                      03930014
039400     AND CC-END-MONTH-VALID                                       03940014
039500     AND CC-END-HYPEN2-VALID                                      03950014
039600     AND CC-END-DAY-VALID                                         03960014
039700         IF  ((CC-START-MONTH = '02') AND (CC-START-DAY > '29'))  03970014
039800         OR  ((CC-END-MONTH = '02') AND (CC-END-DAY > '29'))      03980014
039900         OR  ((CC-END-MONTH = '04' OR '06' OR '09' OR '11')       03990014
040000              AND (CC-END-DAY > '30'))                            04000014
040100         OR  ((CC-START-MONTH = '04' OR '06' OR '09' OR '11')     04010014
040200              AND (CC-START-DAY > '30'))                          04020014
040300             DISPLAY '** APKUT400 ABEND **'                       04030014
040400             DISPLAY '** CONTROL CARD DATES INVALID  **'          04040014
040500             SET AP-INVALID-CONTROL-CARD TO TRUE                  04050014
040600             CALL 'ILBOABN0' USING ABEND-CODE                     04060014
040700         ELSE                                                     04070014
040800             MOVE CC-START-DATE TO WS-START-DATE                  04080014
040900             MOVE CC-END-DATE TO WS-END-DATE                      04090014
041000         END-IF                                                   04100014
041100     ELSE                                                         04110014
041200         DISPLAY '** APKUT400 ABEND **'                           04120014
041300         DISPLAY '** CONTROL CARD DATES INVALID  **'              04130014
041400         SET AP-INVALID-CONTROL-CARD TO TRUE                      04140014
041500         CALL 'ILBOABN0' USING ABEND-CODE                         04150014
041600     END-IF.                                                      04160014
041700                                                                  04170014
041800     PERFORM R150-OPEN-PO-CURSOR.                                 04180014
041900                                                                  04190014
042000     PERFORM R100-FETCH-PO-CURSOR.                                04200014
042100                                                                  04210014
042200     IF   END-OF-POS                                              04220014
042300          DISPLAY '**********************************'            04230014
042400          DISPLAY '*   NO POS MEET DATE CRITERIA    *'            04240014
042500          DISPLAY '*   PROGRAM ** = APKUT400        *'            04250014
042600          DISPLAY '**********************************'            04260014
042700     END-IF.                                                      04270014
042800 EJECT                                                            04280014
042900 B100-PROCESSING.                                                 04290014
043000*                                                                 04300014
043100***************************************************************** 04310014
043200*     PROCESS FETCHED POS TO WRITE TO OUTPUT                      04320014
043300***************************************************************** 04330014
043400*                                                                 04340014
043500                                                                  04350014
043600     MOVE PURCHS-PO-NBR             TO AP400-PO-NBR.              04360014
043700     MOVE PURCHS-DEPT-NBR           TO AP400-DEPT-NBR.            04370014
043800     MOVE PURCHS-VER-NBR            TO AP400-VER-NBR.             04380014
043900     MOVE PURCHS-STATUS-CDE         TO AP400-STATUS-CDE.          04390014
044000     MOVE PURCHS-PO-TYP-CDE         TO AP400-PO-TYP-CDE.          04400014
044100     MOVE PURCHS-EDI-IND            TO AP400-EDI-IND.             04410014
044200     MOVE PURCHS-TOT-VAL-COST-AMT   TO AP400-TOT-VAL-COST-AMT.    04420014
044300     MOVE PURCHS-TOT-VAL-RTL-AMT    TO AP400-TOT-VAL-RTL-AMT.     04430014
044400     MOVE PURCHS-TOT-MU-PCT         TO AP400-TOT-MU-PCT.          04440014
044500     MOVE PURCHS-TOT-UNT-QTY        TO AP400-TOT-UNT-QTY.         04450014
044600     MOVE PURCHS-TOT-SKUS-QTY       TO AP400-TOT-SKUS-QTY.        04460014
044700     MOVE PURCHS-OTB-PER-NBR        TO AP400-OTB-PER-NBR.         04470014
044800     MOVE PURCHS-NEW-STR-PO-IND     TO AP400-NEW-STR-PO-IND.      04480014
044900     MOVE PURCHS-DIR-STR-IND        TO AP400-DIR-STR-IND.         04490014
045000     IF PURCHS-ORD-DTE = '0001-01-01'                             04500014
045100         MOVE SPACES                TO AP400-ORD-DTE              04510014
045200     ELSE                                                         04520014
045300         MOVE PURCHS-ORD-DTE        TO AP400-ORD-DTE              04530014
045400     END-IF.                                                      04540014
045500     IF PURCHS-RLSE-DTE = '0001-01-01'                            04550014
045600         MOVE SPACES                TO AP400-RLSE-DTE             04560014
045700     ELSE                                                         04570014
045800         MOVE PURCHS-RLSE-DTE       TO AP400-RLSE-DTE             04580014
045900     END-IF.                                                      04590014
046000     IF PV-DB2-DATE = '0001-01-01'                                04600014
046100         MOVE SPACES                TO AP400-LAST-UPD-DTE         04610014
046200     ELSE                                                         04620014
046300         MOVE PV-DB2-DATE           TO AP400-LAST-UPD-DTE         04630014
046400     END-IF.                                                      04640014
046500                                                                  04650014
046600                                                                  04660014
046700     MOVE PLNSHP-DONT-SHIP-BEF-DTE  TO AP400-DONT-SHIP-BEF-DTE.   04670014
046800     IF PLNSHP-CAN-IFNOT-SHIP-DTE = '0001-01-01'                  04680014
046900         MOVE SPACES                TO AP400-CAN-IFNOT-SHIP-DTE   04690014
047000     ELSE                                                         04700014
047100         MOVE PLNSHP-CAN-IFNOT-SHIP-DTE                           04710014
047200                                    TO AP400-CAN-IFNOT-SHIP-DTE   04720014
047300     END-IF.                                                      04730014
047400     IF PLNSHP-EXT-CAN-DTE = '0001-01-01'                         04740014
047500         MOVE SPACES                TO AP400-EXT-CAN-DTE          04750014
047600     ELSE                                                         04760014
047700         MOVE PLNSHP-EXT-CAN-DTE    TO AP400-EXT-CAN-DTE          04770014
047800     END-IF.                                                      04780014
047900     MOVE PLNSHP-SHIPT-POINT-TXT    TO AP400-SHIPT-POINT-TXT.     04790014
048000     MOVE PLNSHP-FOB-POINT-TXT      TO AP400-FOB-POINT-TXT.       04800014
048100     MOVE PLNSHP-LATE-SHIPT-IND     TO AP400-LATE-SHIPT-IND.      04810014
048200     MOVE PLNSHP-EARLY-SHIPT-IND    TO AP400-EARLY-SHIPT-IND.     04820014
048300     MOVE PLNSHP-PARTIAL-SHIPT-IND  TO AP400-PARTIAL-SHIPT-IND.   04830014
048400     MOVE PLNSHP-BCKORDS-PERMTD-IND TO AP400-BCKORDS-PERMTD-IND.  04840014
048500     MOVE PLNSHP-FRGT-PAYT-CDE      TO AP400-FRGT-PAYT-CDE.       04850014
048600     MOVE PLNSHP-VEND-FRGT-PCT      TO AP400-VEND-FRGT-PCT.       04860014
048700     MOVE PLNSHP-KOHLS-FRGT-PCT     TO AP400-KOHLS-FRGT-PCT.      04870014
048800                                                                  04880014
048900                                                                  04890014
049000     PERFORM R200-GET-DUNS-NBR.                                   04900014
049100     MOVE EXTENT-DUN-NBR            TO AP400-DUN-NBR.             04910014
049200                                                                  04920014
049300                                                                  04930014
049400     PERFORM R300-GET-EDI-PROMO-TXT.                              04940014
049500     MOVE POAGMT-EDI-PROMO-TXT      TO AP400-EDI-PROMO-TXT.       04950014
049600                                                                  04960014
049700                                                                  04970014
049800     SET NO-AGREEMENT-FOUND TO TRUE.                              04980014
049900     PERFORM R400-GET-PO-AGREEMENT-INFO.                          04990014
050000     IF AGREEMENT-FOUND                                           05000014
050100         MOVE POAGMT-DISC-DOL-AMT   TO AP400-DISC-DOL-AMT         05010014
050200         MOVE POAGMT-DISC-PCT       TO AP400-DISC-PCT             05020014
050300         MOVE POAGMT-DISC-PAY-DAY-QTY                             05030014
050400                                    TO AP400-DISC-PAY-DAY-QTY     05040014
050500                                                                  05050014
050600         MOVE PV-NW-STR-DISC-PCT    TO AP400-NW-STR-DISC-PCT      05060014
050700         MOVE PAYTRM-DISCOUNT-DAYS-QTY                            05070014
050800                                    TO AP400-DISCOUNT-DAYS-QTY    05080014
050900         MOVE PAYTRM-DISCOUNT-PCT   TO AP400-DISCOUNT-PCT         05090014
051000         MOVE PAYTRM-DUE-DAY-QTY    TO AP400-DUE-DAY-QTY          05100014
051100         MOVE PAYTRM-DUE-DAY-FR-DTE-TXT                           05110014
051200                                    TO AP400-DUE-DAY-FR-DTE-TXT   05120014
051300         MOVE PAYTRM-OTHER-TXT      TO AP400-OTHER-TXT            05130014
051400     END-IF.                                                      05140014
051500                                                                  05150014
051600     PERFORM R800-OPEN-DISCOUNT-CSR.                              05160014
051700     PERFORM R825-FETCH-DISCOUNT-CSR.                             05170014
051800     PERFORM UNTIL END-OF-DISCOUNT-CSR                            05180014
051900         EVALUATE PV-INCENTIVE-TYP-CDE                            05190014
052000           WHEN 7                                                 05200014
052100              MOVE PV-INCENTIVE-DISC-PCT TO AP400-MOS-DISC-PCT    05210014
052200           WHEN 8                                                 05220014
052300              MOVE PV-INCENTIVE-DISC-PCT TO AP400-TRD-DISC-PCT    05230014
052400           WHEN 9                                                 05240014
052500              MOVE PV-INCENTIVE-DISC-PCT TO AP400-ADV-DISC-PCT    05250014
052600           WHEN 10                                                05260014
052700              MOVE PV-INCENTIVE-DISC-PCT TO                       05270014
052800                                       AP400-COOP-OFF-INVC-PCT    05280014
052900           WHEN 11                                                05290014
053000              MOVE PV-INCENTIVE-DISC-PCT TO                       05300014
053100                                     AP400-PRFT-ASST-ADCOOP-PCT   05310014
053200           WHEN 13                                                05320014
053300              MOVE PV-INCENTIVE-DISC-PCT TO                       05330014
053400                                      AP400-BRIDAL-OFF-INVC-PCT   05340014
053500         END-EVALUATE                                             05350014
053600         PERFORM R825-FETCH-DISCOUNT-CSR                          05360014
053700     END-PERFORM.                                                 05370014
053800     PERFORM R850-CLOSE-DISCOUNT-CSR.                             05380014
053900     INITIALIZE PV-DB2-COUNT.                                     05390014
054000     PERFORM R500-GET-PRETICKET.                                  05400014
054100     IF  PV-DB2-COUNT > +0                                        05410014
054200         MOVE 'Y'                   TO AP400-PRETICKET-IND        05420014
054300     ELSE                                                         05430014
054400         MOVE 'N'                   TO AP400-PRETICKET-IND        05440014
054500     END-IF.                                                      05450014
054600                                                                  05460014
054700                                                                  05470014
054800     INITIALIZE PV-DB2-COUNT.                                     05480014
054900     PERFORM R550-GET-PACK-BY-STR.                                05490014
055000     IF  PV-DB2-COUNT > +0                                        05500014
055100         MOVE 'Y'                   TO AP400-PACK-BY-STORE-IND    05510014
055200     ELSE                                                         05520014
055300         MOVE 'N'                   TO AP400-PACK-BY-STORE-IND    05530014
055400     END-IF.                                                      05540014
055500                                                                  05550014
055600                                                                  05560014
055700     SET NOT-END-OF-INSTRUCTIONS    TO TRUE.                      05570014
055800     PERFORM R650-OPEN-INSTRUC-CURSOR.                            05580014
055900     PERFORM R600-FETCH-INSTRUC-CURSOR.                           05590014
056000     PERFORM WITH TEST BEFORE                                     05600014
056100       VARYING INSTRUC-INDX FROM 1 BY 1                           05610014
056200       UNTIL INSTRUC-INDX > 3                                     05620014
056300          OR END-OF-INSTRUCTIONS                                  05630014
056400             IF POINST-RECIP-CDE = 'AP' AND INSTRUC-INDX < 3      05640014
056500                MOVE INSTCD-INSTR-DESC                            05650014
056600                     TO AP400-INSTR-DESC (INSTRUC-INDX)           05660014
056700             ELSE                                                 05670014
056800                IF POINST-RECIP-CDE = 'VN'                        05680014
056900                   MOVE INSTCD-INSTR-DESC                         05690014
057000                        TO AP400-INSTR-DESC (3)                   05700014
057100                END-IF                                            05710014
057200             END-IF                                               05720014
057300             PERFORM R600-FETCH-INSTRUC-CURSOR                    05730014
057400     END-PERFORM.                                                 05740014
057500     PERFORM R675-CLOSE-INSTRUC-CURSOR.                           05750014
057600                                                                  05760014
057700                                                                  05770014
057800     PERFORM R700-GET-AD-EVNT-DTE.                                05780014
057900     IF  PV-NULL-IND < +0                                         05790014
058000         MOVE SPACES                TO AP400-AD-EVNT-DTE          05800014
058100     ELSE                                                         05810014
058200         MOVE PV-DB2-DATE           TO AP400-AD-EVNT-DTE          05820014
058300     END-IF.                                                      05830014
058400                                                                  05840014
058500     WRITE AP-PO-EXTRACT-RECORD FROM AP400-PO-EXTRACT-RECORD.     05850014
058600     ADD +1 TO PO-COUNT.                                          05860014
058700                                                                  05870014
058800     INITIALIZE DCLTPURCHS                                        05880014
058900                DCLTPLNSHP                                        05890014
059000                DCLTPOAGMT                                        05900014
059100                DCLTPAYTRM                                        05910014
059200                DCLTPURITM                                        05920014
059300                DCLTEXTENT                                        05930014
059400                DCLTPOINST                                        05940014
059500                DCLTINSTCD                                        05950014
059600                AP400-PO-EXTRACT-RECORD                           05960014
059700                AP400-INSTR-DESC (1)                              05970014
059800                AP400-INSTR-DESC (2)                              05980014
059900                AP400-INSTR-DESC (3)                              05990014
060000                PV-PROGRAM-VARIABLES.                             06000014
060100                                                                  06010014
060200     PERFORM R100-FETCH-PO-CURSOR.                                06020014
060300 EJECT                                                            06030014
060400 B900-END-OF-JOB.                                                 06040014
060500***************************************************************** 06050014
060600*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       06060014
060700*     AND CLOSE ALL FILES                                         06070014
060800***************************************************************** 06080014
060900                                                                  06090014
061000     PERFORM R175-CLOSE-PO-CURSOR.                                06100014
061100                                                                  06110014
061200     CLOSE AP-PO-EXTRACT-FILE                                     06120014
061300           CONTROL-CARD-FILE.                                     06130014
061400                                                                  06140014
061500     MOVE PO-COUNT TO PO-COUNT-DISPLAY.                           06150014
061600     DISPLAY '*****************************************'.         06160014
061700     DISPLAY 'TOTAL POS EXTRACTED = ' PO-COUNT-DISPLAY.           06170014
061800     DISPLAY '*****************************************'.         06180014
061900 EJECT                                                            06190014
062000 R100-FETCH-PO-CURSOR.                                            06200014
062100                                                                  06210014
062200     PERFORM WITH TEST AFTER                                      06220014
062300        VARYING WS-RETRY-COUNT FROM 1 BY 1                        06230014
062400          UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                     06240014
062500             OR SQLCODE = ZERO                                    06250014
062600             OR SQLCODE = +100                                    06260014
062700        EXEC SQL                                                  06270014
062800            FETCH PO_CSR                                          06280014
062900            INTO :PURCHS-PO-NBR                                   06290014
063000                ,:PURCHS-VER-NBR                                  06300014
063100                ,:PURCHS-STATUS-CDE                               06310014
063200                ,:PURCHS-PO-TYP-CDE                               06320014
063300                ,:PURCHS-EDI-IND                                  06330014
063400                ,:PURCHS-TOT-VAL-COST-AMT                         06340014
063500                ,:PURCHS-TOT-VAL-RTL-AMT                          06350014
063600                ,:PURCHS-TOT-MU-PCT                               06360014
063700                ,:PURCHS-TOT-UNT-QTY                              06370014
063800                ,:PURCHS-TOT-SKUS-QTY                             06380014
063900                ,:PURCHS-OTB-PER-NBR                              06390014
064000                ,:PURCHS-NEW-STR-PO-IND                           06400014
064100                ,:PURCHS-DIR-STR-IND                              06410014
064200                ,:PURCHS-DEPT-NBR                                 06420014
064300                ,:PURCHS-ENT-ID                                   06430014
064400                ,:PV-DB2-DATE                                     06440014
064500                ,:PURCHS-ORD-DTE                                  06450014
064600                ,:PURCHS-RLSE-DTE                                 06460014
064700                ,:PLNSHP-DONT-SHIP-BEF-DTE                        06470014
064800                ,:PLNSHP-CAN-IFNOT-SHIP-DTE                       06480014
064900                ,:PLNSHP-EXT-CAN-DTE                              06490014
065000                ,:PLNSHP-SHIPT-POINT-TXT                          06500014
065100                ,:PLNSHP-FOB-POINT-TXT                            06510014
065200                ,:PLNSHP-LATE-SHIPT-IND                           06520014
065300                ,:PLNSHP-EARLY-SHIPT-IND                          06530014
065400                ,:PLNSHP-PARTIAL-SHIPT-IND                        06540014
065500                ,:PLNSHP-BCKORDS-PERMTD-IND                       06550014
065600                ,:PLNSHP-FRGT-PAYT-CDE                            06560014
065700                ,:PLNSHP-VEND-FRGT-PCT                            06570014
065800                ,:PLNSHP-KOHLS-FRGT-PCT                           06580014
065900        END-EXEC                                                  06590014
066000                                                                  06600014
066100        EVALUATE TRUE                                             06610014
066200            WHEN SQLCODE = ZERO                                   06620014
066300                 CONTINUE                                         06630014
066400            WHEN SQLCODE = +100                                   06640014
066500                 SET END-OF-POS TO TRUE                           06650014
066600            WHEN SQLCODE = -904                                   06660014
066700            WHEN SQLCODE = -913                                   06670014
066800                 CONTINUE                                         06680014
066900            WHEN SQLWARN0 NOT = SPACES                            06690014
067000            WHEN SQLCODE  NOT = ZERO                              06700014
067100              MOVE 'R100-FETCH-PO-CURSOR             '            06710014
067200                            TO WS-ABEND-PARAGRAPH                 06720014
067300              MOVE 'UNSUCCESSFUL FETCH  PURCHS'                   06730014
067400                            TO WS-ABEND-OPERATION                 06740014
067500              MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1             06750014
067600              MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2             06760014
067700              PERFORM Z999-SQL-ERROR                              06770014
067800           END-EVALUATE                                           06780014
067900     END-PERFORM.                                                 06790014
068000                                                                  06800014
068100     IF WS-RETRY-COUNT > 3                                        06810014
068200         MOVE 'R100-FETCH                    '                    06820014
068300                       TO WS-ABEND-PARAGRAPH                      06830014
068400         MOVE 'MAX RETRIES EXCEEDED ON FETCH  PURCHS'             06840014
068500                         TO WS-ABEND-OPERATION                    06850014
068600         MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1                  06860014
068700         MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2                  06870014
068800         PERFORM Z999-SQL-ERROR                                   06880014
068900     END-IF.                                                      06890014
069000  EJECT                                                           06900014
069100 R150-OPEN-PO-CURSOR.                                             06910014
069200                                                                  06920014
069300     PERFORM WITH TEST AFTER                                      06930014
069400         VARYING WS-RETRY-COUNT FROM 1 BY 1                       06940014
069500         UNTIL   WS-RETRY-COUNT > WS-RETRY-MAX                    06950014
069600            OR   SQLCODE = ZERO                                   06960014
069700            OR   SQLCODE = +100                                   06970014
069800                                                                  06980014
069900         EXEC SQL                                                 06990014
070000            OPEN PO_CSR                                           07000014
070100         END-EXEC                                                 07010014
070200                                                                  07020014
070300         EVALUATE TRUE                                            07030014
070400             WHEN SQLCODE = ZERO                                  07040014
070500             WHEN SQLCODE = +100                                  07050014
070600             WHEN SQLCODE = -904                                  07060014
070700             WHEN SQLCODE = -913                                  07070014
070800                  CONTINUE                                        07080014
070900                                                                  07090014
071000             WHEN SQLWARN0 NOT = SPACES                           07100014
071100             WHEN SQLCODE  NOT = ZERO                             07110014
071200                  MOVE 'R150-OPEN-PO-CURSOR      '                07120014
071300                                TO WS-ABEND-PARAGRAPH             07130014
071400                  MOVE 'UNSUCCESSFUL OPEN   PURCHS'               07140014
071500                                TO WS-ABEND-OPERATION             07150014
071600                  MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1         07160014
071700                  MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2         07170014
071800                  PERFORM Z999-SQL-ERROR                          07180014
071900         END-EVALUATE                                             07190014
072000     END-PERFORM.                                                 07200014
072100                                                                  07210014
072200     IF WS-RETRY-COUNT > WS-RETRY-MAX                             07220014
072300         MOVE 'R150-OPEN-PO-CURSOR      '                         07230014
072400                       TO WS-ABEND-PARAGRAPH                      07240014
072500         MOVE 'MAX RETRIES EXCEEDED ON OPEN   PURCHS'             07250014
072600                         TO WS-ABEND-OPERATION                    07260014
072700         MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1                  07270014
072800         MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2                  07280014
072900         PERFORM Z999-SQL-ERROR.                                  07290014
073000                                                                  07300014
073100                                                                  07310014
073200 R175-CLOSE-PO-CURSOR.                                            07320014
073300                                                                  07330014
073400     PERFORM WITH TEST AFTER                                      07340014
073500         VARYING WS-RETRY-COUNT FROM 1 BY 1                       07350014
073600           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    07360014
073700              OR SQLCODE = ZERO                                   07370014
073800              OR SQLCODE = +100                                   07380014
073900                                                                  07390014
074000         EXEC SQL                                                 07400014
074100            CLOSE PO_CSR                                          07410014
074200         END-EXEC                                                 07420014
074300                                                                  07430014
074400         EVALUATE TRUE                                            07440014
074500             WHEN SQLCODE = ZERO                                  07450014
074600             WHEN SQLCODE = +100                                  07460014
074700             WHEN SQLCODE = -904                                  07470014
074800             WHEN SQLCODE = -913                                  07480014
074900                  CONTINUE                                        07490014
075000             WHEN SQLWARN0 NOT = SPACES                           07500014
075100             WHEN SQLCODE  NOT = ZERO                             07510014
075200                  MOVE 'R175-CLOSE-PO-CURSOR     '                07520014
075300                                TO WS-ABEND-PARAGRAPH             07530014
075400                  MOVE 'UNSUCCESSFUL CLOSE  PURCHS'               07540014
075500                                TO WS-ABEND-OPERATION             07550014
075600                  MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1         07560014
075700                  MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2         07570014
075800                  PERFORM Z999-SQL-ERROR                          07580014
075900         END-EVALUATE                                             07590014
076000     END-PERFORM.                                                 07600014
076100                                                                  07610014
076200     IF WS-RETRY-COUNT > WS-RETRY-MAX                             07620014
076300         MOVE 'R175-CLOSE-PO-CURSOR     '                         07630014
076400                       TO WS-ABEND-PARAGRAPH                      07640014
076500         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  PURCHS'             07650014
076600                         TO WS-ABEND-OPERATION                    07660014
076700         MOVE 'TPURCHS ' TO WS-ABEND-STRUCTURE-1                  07670014
076800         MOVE 'TPLNSHP ' TO WS-ABEND-STRUCTURE-2                  07680014
076900         PERFORM Z999-SQL-ERROR.                                  07690014
077000  EJECT                                                           07700014
077100 R200-GET-DUNS-NBR.                                               07710014
077200                                                                  07720014
077300     PERFORM WITH TEST AFTER                                      07730014
077400         VARYING WS-RETRY-COUNT FROM 1 BY 1                       07740014
077500           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    07750014
077600              OR SQLCODE = ZERO                                   07760014
077700                                                                  07770014
077800         EXEC SQL                                                 07780014
077900             SELECT                                               07790014
078000                 DUN_NBR                                          07800014
078100             INTO                                                 07810014
078200                 :EXTENT-DUN-NBR                                  07820014
078300             FROM TEXTENT                                         07830014
078400             WHERE ENT_ID = :PURCHS-ENT-ID                        07840014
078500         END-EXEC                                                 07850014
078600                                                                  07860014
078700         EVALUATE TRUE                                            07870014
078800             WHEN SQLCODE = ZERO                                  07880014
078900             WHEN SQLCODE = -904                                  07890014
079000             WHEN SQLCODE = -913                                  07900014
079100                  CONTINUE                                        07910014
079200             WHEN OTHER                                           07920014
079300                 MOVE 'R200-GET-DUNS-NBR             '            07930014
079400                                     TO WS-ABEND-PARAGRAPH        07940014
079500                 MOVE 'DUNS NBR NOT FOUND ON TEXTENT TABLE'       07950014
079600                                     TO WS-ABEND-OPERATION        07960014
079700                 MOVE 'TEXTENT'      TO WS-ABEND-STRUCTURE-1      07970014
079800                 PERFORM Z999-SQL-ERROR                           07980014
079900         END-EVALUATE                                             07990014
080000     END-PERFORM.                                                 08000014
080100                                                                  08010014
080200     IF WS-RETRY-COUNT > WS-RETRY-MAX                             08020014
080300         MOVE 'R200-GET-DUNS-NBR             '                    08030014
080400                             TO WS-ABEND-PARAGRAPH                08040014
080500         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF DUNS'            08050014
080600                             TO WS-ABEND-OPERATION                08060014
080700         MOVE 'TEXTENT'      TO WS-ABEND-STRUCTURE-1              08070014
080800         PERFORM Z999-SQL-ERROR                                   08080014
080900     END-IF.                                                      08090014
081000 EJECT                                                            08100014
081100 R300-GET-EDI-PROMO-TXT.                                          08110014
081200                                                                  08120014
081300     PERFORM WITH TEST AFTER                                      08130014
081400         VARYING WS-RETRY-COUNT FROM 1 BY 1                       08140014
081500           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    08150014
081600              OR (SQLCODE = ZERO)                                 08160014
081700              OR (SQLCODE = +100)                                 08170014
081800                                                                  08180014
081900         EXEC SQL                                                 08190014
082000             SELECT                                               08200014
082100                 EDI_PROMO_TXT                                    08210014
082200             INTO                                                 08220014
082300                 :POAGMT-EDI-PROMO-TXT                            08230014
082400              FROM TPOAGMT                                        08240014
082500              WHERE PO_NBR         = :PURCHS-PO-NBR               08250014
082600                AND AGRMT_TYP_ID   = '3'                          08260014
082700                AND VER_STATUS_CDE = 'A'                          08270014
082800         END-EXEC                                                 08280014
082900                                                                  08290014
083000         EVALUATE TRUE                                            08300014
083100             WHEN SQLCODE = ZERO                                  08310014
083200             WHEN SQLCODE = +100                                  08320014
083300             WHEN SQLCODE = -904                                  08330014
083400             WHEN SQLCODE = -913                                  08340014
083500                  CONTINUE                                        08350014
083600             WHEN SQLCODE = +100                                  08360014
083700                 MOVE SPACES         TO POAGMT-EDI-PROMO-TXT      08370014
083800             WHEN OTHER                                           08380014
083900                 MOVE 'R300-GET-EDI-PROMO-TXT         '           08390014
084000                                     TO WS-ABEND-PARAGRAPH        08400014
084100                 MOVE 'UNSUCCESSFUL SELECT POAGMT'                08410014
084200                                     TO WS-ABEND-OPERATION        08420014
084300                 MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1      08430014
084400                 MOVE PURCHS-PO-NBR  TO WS-ABEND-STRUCTURE-3      08440014
084500                 DISPLAY 'PO # IS ' WS-ABEND-STRUCTURE-3          08450014
084600                 PERFORM Z999-SQL-ERROR                           08460014
084700         END-EVALUATE                                             08470014
084800     END-PERFORM.                                                 08480014
084900                                                                  08490014
085000     IF WS-RETRY-COUNT > WS-RETRY-MAX                             08500014
085100         MOVE 'R300-GET-EDI-PROMO-TXT         '                   08510014
085200                             TO WS-ABEND-PARAGRAPH                08520014
085300         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF EDI PROMO TXT'   08530014
085400                             TO WS-ABEND-OPERATION                08540014
085500         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              08550014
085600         PERFORM Z999-SQL-ERROR                                   08560014
085700     END-IF.                                                      08570014
085800 EJECT                                                            08580014
085900                                                                  08590014
086000 R400-GET-PO-AGREEMENT-INFO.                                      08600014
086100                                                                  08610014
086200     PERFORM WITH TEST AFTER                                      08620014
086300         VARYING WS-RETRY-COUNT FROM 1 BY 1                       08630014
086400           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    08640014
086500              OR (SQLCODE = ZERO)                                 08650014
086600              OR (SQLCODE = +100)                                 08660014
086700                                                                  08670014
086800         EXEC SQL                                                 08680014
086900             SELECT  PA.PAYT_TERM_ID                              08690014
087000                    ,PA.DISC_DOL_AMT                              08700014
087100                    ,PA.DISC_PCT                                  08710014
087200                    ,PA.DISC_PAY_DAY_QTY                          08720014
087300                    ,PT.DISCOUNT_DAYS_QTY                         08730014
087400                    ,PT.DISCOUNT_PCT                              08740014
087500                    ,PT.DUE_DAY_QTY                               08750014
087600                    ,PT.DUE_DAY_FR_DTE_TXT                        08760014
087700                    ,PT.OTHER_TXT                                 08770014
087800               INTO :POAGMT-PAYT-TERM-ID                          08780014
087900                   ,:POAGMT-DISC-DOL-AMT                          08790014
088000                   ,:POAGMT-DISC-PCT                              08800014
088100                   ,:POAGMT-DISC-PAY-DAY-QTY                      08810014
088200                   ,:PAYTRM-DISCOUNT-DAYS-QTY                     08820014
088300                   ,:PAYTRM-DISCOUNT-PCT                          08830014
088400                   ,:PAYTRM-DUE-DAY-QTY                           08840014
088500                   ,:PAYTRM-DUE-DAY-FR-DTE-TXT                    08850014
088600                   ,:PAYTRM-OTHER-TXT                             08860014
088700               FROM  TPOAGMT PA                                   08870014
088800                    ,TPAYTRM PT                                   08880014
088900              WHERE  PA.PO_NBR         = :PURCHS-PO-NBR           08890014
089000                AND  PA.PAYT_TERM_ID   = PT.PAY_TERM_ID           08900014
089100                AND  PA.AGRMT_TYP_ID   = '2'                      08910014
089200                AND  PA.VER_STATUS_CDE = 'A'                      08920014
089300         END-EXEC                                                 08930014
089400                                                                  08940014
089500         EVALUATE TRUE                                            08950014
089600             WHEN SQLCODE = -904                                  08960014
089700             WHEN SQLCODE = -913                                  08970014
089800                  CONTINUE                                        08980014
089900             WHEN SQLCODE = ZERO                                  08990014
090000                  SET AGREEMENT-FOUND    TO TRUE                  09000014
090100             WHEN SQLCODE = +100                                  09010014
090200                  SET NO-AGREEMENT-FOUND TO TRUE                  09020014
090300             WHEN OTHER                                           09030014
090400                 MOVE 'R400-GET-PO-AGREEMENT-INFO     '           09040014
090500                                     TO WS-ABEND-PARAGRAPH        09050014
090600                 MOVE 'UNSUCCESSFUL SELECT'                       09060014
090700                                     TO WS-ABEND-OPERATION        09070014
090800                 MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1      09080014
090900                 MOVE 'TPAYTRM'      TO WS-ABEND-STRUCTURE-2      09090014
091000                 MOVE PURCHS-PO-NBR  TO WS-ABEND-STRUCTURE-3      09100014
091100                 DISPLAY 'PO # IS ' WS-ABEND-STRUCTURE-3          09110014
091200                 PERFORM Z999-SQL-ERROR                           09120014
091300         END-EVALUATE                                             09130014
091400     END-PERFORM.                                                 09140014
091500                                                                  09150014
091600     IF WS-RETRY-COUNT > WS-RETRY-MAX                             09160014
091700         MOVE 'R400-GET-PO-AGREEMENT-INFO     '                   09170014
091800                             TO WS-ABEND-PARAGRAPH                09180014
091900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    09190014
092000                             TO WS-ABEND-OPERATION                09200014
092100         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              09210014
092200         MOVE 'TPAYTRM'      TO WS-ABEND-STRUCTURE-2              09220014
092300         PERFORM Z999-SQL-ERROR                                   09230014
092400     END-IF.                                                      09240014
092500                                                                  09250014
092600     PERFORM WITH TEST AFTER                                      09260014
092700         VARYING WS-RETRY-COUNT FROM 1 BY 1                       09270014
092800           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    09280014
092900              OR (SQLCODE = ZERO)                                 09290014
093000              OR (SQLCODE = +100)                                 09300014
093100                                                                  09310014
093200         EXEC SQL                                                 09320014
093300             SELECT  PA.DISC_PAY_DAY_QTY                          09330014
093400                    ,PA.DISC_PCT                                  09340014
093500               INTO :PV-DISC-EXTENDED-DAYS                        09350014
093600                   ,:PV-NW-STR-DISC-PCT                           09360014
093700               FROM  TPOAGMT PA                                   09370014
093800              WHERE  PA.PO_NBR         = :PURCHS-PO-NBR           09380014
093900                AND  PA.VER_STATUS_CDE = 'A'                      09390014
094000                AND  PA.AGRMT_TYP_ID   = '5'                      09400014
094100                AND  PA.TYP_CDE        =  1                       09410014
094200         END-EXEC                                                 09420014
094300                                                                  09430014
094400         EVALUATE TRUE                                            09440014
094500             WHEN SQLCODE = -904                                  09450014
094600             WHEN SQLCODE = -913                                  09460014
094700                  CONTINUE                                        09470014
094800             WHEN SQLCODE = +100                                  09480014
094900                  MOVE ZERO TO PV-DISC-EXTENDED-DAYS              09490014
095000                  MOVE ZERO TO PV-NW-STR-DISC-PCT                 09500014
095100             WHEN SQLCODE = ZERO                                  09510014
095200                  SET AGREEMENT-FOUND TO TRUE                     09520014
095300                  ADD PV-DISC-EXTENDED-DAYS                       09530014
095400                      TO POAGMT-DISC-PAY-DAY-QTY                  09540014
095500             WHEN OTHER                                           09550014
095600                 MOVE 'R400-GET-PO-AGREEMENT-INFO     '           09560014
095700                                      TO WS-ABEND-PARAGRAPH       09570014
095800                 MOVE 'UNSUCCESSFUL SELECT'                       09580014
095900                                      TO WS-ABEND-OPERATION       09590014
096000                 MOVE 'TPOAGMT'       TO WS-ABEND-STRUCTURE-1     09600014
096100                 MOVE SPACES          TO WS-ABEND-STRUCTURE-2     09610014
096200                 MOVE PURCHS-PO-NBR  TO WS-ABEND-STRUCTURE-3      09620014
096300                 DISPLAY 'PO # IS ' WS-ABEND-STRUCTURE-3          09630014
096400                 PERFORM Z999-SQL-ERROR                           09640014
096500         END-EVALUATE                                             09650014
096600     END-PERFORM.                                                 09660014
096700                                                                  09670014
096800     IF WS-RETRY-COUNT > WS-RETRY-MAX                             09680014
096900         MOVE 'R400-GET-PO-AGREEMENT-INFO     '                   09690014
097000                             TO WS-ABEND-PARAGRAPH                09700014
097100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    09710014
097200                             TO WS-ABEND-OPERATION                09720014
097300         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              09730014
097400         MOVE SPACES         TO WS-ABEND-STRUCTURE-2              09740014
097500         PERFORM Z999-SQL-ERROR                                   09750014
097600     END-IF.                                                      09760014
097700                                                                  09770014
097800     PERFORM WITH TEST AFTER                                      09780014
097900         VARYING WS-RETRY-COUNT FROM 1 BY 1                       09790014
098000           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    09800014
098100              OR (SQLCODE = ZERO)                                 09810014
098200              OR (SQLCODE = +100)                                 09820014
098300                                                                  09830014
098400         EXEC SQL                                                 09840014
098500             SELECT  PA.DISC_PAY_DAY_QTY                          09850014
098600               INTO :PV-TABLE-TOWER-DAYS                          09860014
098700               FROM  TPOAGMT PA                                   09870014
098800              WHERE  PA.PO_NBR         = :PURCHS-PO-NBR           09880014
098900                AND  PA.VER_STATUS_CDE = 'A'                      09890014
099000                AND  PA.AGRMT_TYP_ID   = '5'                      09900014
099100                AND  PA.TYP_CDE        =  12                      09910014
099200         END-EXEC                                                 09920014
099300                                                                  09930014
099400         EVALUATE TRUE                                            09940014
099500             WHEN SQLCODE = -904                                  09950014
099600             WHEN SQLCODE = -913                                  09960014
099700                  CONTINUE                                        09970014
099800             WHEN SQLCODE = +100                                  09980014
099900                  MOVE ZERO TO PV-TABLE-TOWER-DAYS                09990014
100000             WHEN SQLCODE = ZERO                                  10000014
100100                  SET AGREEMENT-FOUND TO TRUE                     10010014
100200                  ADD PV-TABLE-TOWER-DAYS                         10020014
100300                      TO POAGMT-DISC-PAY-DAY-QTY                  10030014
100400             WHEN OTHER                                           10040014
100500                 MOVE 'R400-GET-PO-AGREEMENT-INFO     '           10050014
100600                                      TO WS-ABEND-PARAGRAPH       10060014
100700                 MOVE 'UNSUCCESSFUL SELECT TBL TWR DAYS'          10070014
100800                                      TO WS-ABEND-OPERATION       10080014
100900                 MOVE 'TPOAGMT'       TO WS-ABEND-STRUCTURE-1     10090014
101000                 MOVE SPACES          TO WS-ABEND-STRUCTURE-2     10100014
101100                 MOVE PURCHS-PO-NBR  TO WS-ABEND-STRUCTURE-3      10110014
101200                 DISPLAY 'PO # IS ' WS-ABEND-STRUCTURE-3          10120014
101300                 PERFORM Z999-SQL-ERROR                           10130014
101400         END-EVALUATE                                             10140014
101500     END-PERFORM.                                                 10150014
101600                                                                  10160014
101700     IF WS-RETRY-COUNT > WS-RETRY-MAX                             10170014
101800         MOVE 'R400-GET-PO-AGREEMENT-INFO     '                   10180014
101900                             TO WS-ABEND-PARAGRAPH                10190014
102000         MOVE 'MAX RETRIES EXCEEDED ON SELECT TBL TWR DAYS'       10200014
102100                             TO WS-ABEND-OPERATION                10210014
102200         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              10220014
102300         MOVE SPACES         TO WS-ABEND-STRUCTURE-2              10230014
102400         PERFORM Z999-SQL-ERROR                                   10240014
102500     END-IF.                                                      10250014
102600 EJECT                                                            10260014
102700                                                                  10270014
102800 R500-GET-PRETICKET.                                              10280014
102900                                                                  10290014
103000     PERFORM WITH TEST AFTER                                      10300014
103100         VARYING WS-RETRY-COUNT FROM 1 BY 1                       10310014
103200           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    10320014
103300              OR (SQLCODE = ZERO)                                 10330014
103400              OR (SQLCODE = +100)                                 10340014
103500                                                                  10350014
103600         EXEC SQL                                                 10360014
103700              SELECT COUNT(*)                                     10370014
103800                INTO :PV-DB2-COUNT                                10380014
103900                FROM TPOAGMT                                      10390014
104000               WHERE PO_NBR         = :PURCHS-PO-NBR              10400014
104100                 AND AGRMT_TYP_ID   = '4'                         10410014
104200                 AND VER_STATUS_CDE = 'A'                         10420014
104300                 AND TYP_CDE        = 1                           10430014
104400         END-EXEC                                                 10440014
104500                                                                  10450014
104600         EVALUATE TRUE                                            10460014
104700             WHEN SQLCODE = ZERO                                  10470014
104800             WHEN SQLCODE = -904                                  10480014
104900             WHEN SQLCODE = -913                                  10490014
105000             WHEN SQLCODE = +100                                  10500014
105100                  CONTINUE                                        10510014
105200             WHEN OTHER                                           10520014
105300                 MOVE 'R500-GET-PRETICKET             '           10530014
105400                                     TO WS-ABEND-PARAGRAPH        10540014
105500                 MOVE 'UNSUCCESSFUL SELECT POAGMT'                10550014
105600                                     TO WS-ABEND-OPERATION        10560014
105700                 MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1      10570014
105800                 PERFORM Z999-SQL-ERROR                           10580014
105900         END-EVALUATE                                             10590014
106000     END-PERFORM.                                                 10600014
106100                                                                  10610014
106200     IF WS-RETRY-COUNT > WS-RETRY-MAX                             10620014
106300         MOVE 'R500-GET-PRETICKET             '                   10630014
106400                             TO WS-ABEND-PARAGRAPH                10640014
106500         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF PRETICKET'       10650014
106600                             TO WS-ABEND-OPERATION                10660014
106700         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              10670014
106800         PERFORM Z999-SQL-ERROR                                   10680014
106900     END-IF.                                                      10690014
107000 EJECT                                                            10700014
107100 R550-GET-PACK-BY-STR.                                            10710014
107200                                                                  10720014
107300     PERFORM WITH TEST AFTER                                      10730014
107400         VARYING WS-RETRY-COUNT FROM 1 BY 1                       10740014
107500           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    10750014
107600              OR (SQLCODE = ZERO OR +100)                         10760014
107700                                                                  10770014
107800         EXEC SQL                                                 10780014
107900              SELECT COUNT(*)                                     10790014
108000                INTO :PV-DB2-COUNT                                10800014
108100                FROM TPOAGMT                                      10810014
108200               WHERE PO_NBR         = :PURCHS-PO-NBR              10820014
108300                 AND AGRMT_TYP_ID   = '4'                         10830014
108400                 AND VER_STATUS_CDE = 'A'                         10840014
108500                 AND TYP_CDE        = 4                           10850014
108600         END-EXEC                                                 10860014
108700                                                                  10870014
108800         EVALUATE TRUE                                            10880014
108900             WHEN SQLCODE = ZERO                                  10890014
109000             WHEN SQLCODE = -904                                  10900014
109100             WHEN SQLCODE = -913                                  10910014
109200             WHEN SQLCODE = +100                                  10920014
109300                  CONTINUE                                        10930014
109400             WHEN OTHER                                           10940014
109500                 MOVE 'R550-GET-PACK-BY-STR           '           10950014
109600                                     TO WS-ABEND-PARAGRAPH        10960014
109700                 MOVE 'UNSUCCESSFUL SELECT POAGMT'                10970014
109800                                     TO WS-ABEND-OPERATION        10980014
109900                 MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1      10990014
110000                 PERFORM Z999-SQL-ERROR                           11000014
110100         END-EVALUATE                                             11010014
110200     END-PERFORM.                                                 11020014
110300                                                                  11030014
110400     IF WS-RETRY-COUNT > WS-RETRY-MAX                             11040014
110500         MOVE 'R550-GET-PACK-BY-STR           '                   11050014
110600                             TO WS-ABEND-PARAGRAPH                11060014
110700         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF PRETICKET'       11070014
110800                             TO WS-ABEND-OPERATION                11080014
110900         MOVE 'TPOAGMT'      TO WS-ABEND-STRUCTURE-1              11090014
111000         PERFORM Z999-SQL-ERROR                                   11100014
111100     END-IF.                                                      11110014
111200 EJECT                                                            11120014
111300 R600-FETCH-INSTRUC-CURSOR.                                       11130014
111400                                                                  11140014
111500     PERFORM WITH TEST AFTER                                      11150014
111600        VARYING WS-RETRY-COUNT FROM 1 BY 1                        11160014
111700          UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                     11170014
111800             OR SQLCODE = ZERO                                    11180014
111900             OR SQLCODE = +100                                    11190014
112000        EXEC SQL                                                  11200014
112100            FETCH INSTRUC_CSR                                     11210014
112200            INTO :INSTCD-INSTR-DESC                               11220014
112300               , :POINST-INSTR-NBR                                11230014
112400               , :POINST-RECIP-CDE                                11240014
112500        END-EXEC                                                  11250014
112600                                                                  11260014
112700        EVALUATE TRUE                                             11270014
112800            WHEN SQLCODE = ZERO                                   11280014
112900                 CONTINUE                                         11290014
113000            WHEN SQLCODE = +100                                   11300014
113100                 SET END-OF-INSTRUCTIONS TO TRUE                  11310014
113200            WHEN SQLCODE = -904                                   11320014
113300            WHEN SQLCODE = -913                                   11330014
113400              CONTINUE                                            11340014
113500            WHEN SQLWARN0 NOT = SPACES                            11350014
113600            WHEN SQLCODE  NOT = ZERO                              11360014
113700              MOVE 'R600-FETCH-INSTRUC-CURSOR        '            11370014
113800                            TO WS-ABEND-PARAGRAPH                 11380014
113900              MOVE 'UNSUCCESSFUL FETCH POINST/INSTCD'             11390014
114000                            TO WS-ABEND-OPERATION                 11400014
114100              PERFORM Z999-SQL-ERROR                              11410014
114200           END-EVALUATE                                           11420014
114300     END-PERFORM.                                                 11430014
114400                                                                  11440014
114500     IF WS-RETRY-COUNT > 3                                        11450014
114600         MOVE 'R600-FETCH-INSTRUC-CURSOR        '                 11460014
114700                         TO WS-ABEND-PARAGRAPH                    11470014
114800         MOVE 'MAX RETRIES EXCEEDED ON FETCH POINST/INSTCD'       11480014
114900                         TO WS-ABEND-OPERATION                    11490014
115000         MOVE 'TPOINST ' TO WS-ABEND-STRUCTURE-1                  11500014
115100         MOVE 'TINSTCD ' TO WS-ABEND-STRUCTURE-2                  11510014
115200         PERFORM Z999-SQL-ERROR                                   11520014
115300     END-IF.                                                      11530014
115400  EJECT                                                           11540014
115500 R650-OPEN-INSTRUC-CURSOR.                                        11550014
115600                                                                  11560014
115700     PERFORM WITH TEST AFTER                                      11570014
115800         VARYING WS-RETRY-COUNT FROM 1 BY 1                       11580014
115900         UNTIL   WS-RETRY-COUNT > WS-RETRY-MAX                    11590014
116000            OR   SQLCODE = ZERO                                   11600014
116100            OR   SQLCODE = +100                                   11610014
116200                                                                  11620014
116300         EXEC SQL                                                 11630014
116400            OPEN INSTRUC_CSR                                      11640014
116500         END-EXEC                                                 11650014
116600                                                                  11660014
116700         EVALUATE TRUE                                            11670014
116800             WHEN SQLCODE = ZERO                                  11680014
116900             WHEN SQLCODE = +100                                  11690014
117000             WHEN SQLCODE = -904                                  11700014
117100             WHEN SQLCODE = -913                                  11710014
117200                  CONTINUE                                        11720014
117300                                                                  11730014
117400             WHEN SQLWARN0 NOT = SPACES                           11740014
117500             WHEN SQLCODE  NOT = ZERO                             11750014
117600                  MOVE 'R650-OPEN-INSTRUC-CURSOR      '           11760014
117700                                TO WS-ABEND-PARAGRAPH             11770014
117800                  MOVE 'UNSUCCESSFUL OPEN   INSTRUC'              11780014
117900                                TO WS-ABEND-OPERATION             11790014
118000                  MOVE 'TPOINST ' TO WS-ABEND-STRUCTURE-1         11800014
118100                  MOVE 'TINSTCD ' TO WS-ABEND-STRUCTURE-2         11810014
118200                  PERFORM Z999-SQL-ERROR                          11820014
118300         END-EVALUATE                                             11830014
118400     END-PERFORM.                                                 11840014
118500                                                                  11850014
118600     IF WS-RETRY-COUNT > WS-RETRY-MAX                             11860014
118700         MOVE 'R650-OPEN-INSTRUC-CURSOR      '                    11870014
118800                       TO WS-ABEND-PARAGRAPH                      11880014
118900         MOVE 'MAX RETRIES EXCEEDED ON OPEN  INSTRUC'             11890014
119000                         TO WS-ABEND-OPERATION                    11900014
119100          MOVE 'TPOINST ' TO WS-ABEND-STRUCTURE-1                 11910014
119200          MOVE 'TINSTCD ' TO WS-ABEND-STRUCTURE-2                 11920014
119300         PERFORM Z999-SQL-ERROR.                                  11930014
119400                                                                  11940014
119500                                                                  11950014
119600 R675-CLOSE-INSTRUC-CURSOR.                                       11960014
119700                                                                  11970014
119800     PERFORM WITH TEST AFTER                                      11980014
119900         VARYING WS-RETRY-COUNT FROM 1 BY 1                       11990014
120000           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    12000014
120100              OR SQLCODE = ZERO                                   12010014
120200              OR SQLCODE = +100                                   12020014
120300                                                                  12030014
120400         EXEC SQL                                                 12040014
120500            CLOSE INSTRUC_CSR                                     12050014
120600         END-EXEC                                                 12060014
120700                                                                  12070014
120800         EVALUATE TRUE                                            12080014
120900             WHEN SQLCODE = ZERO                                  12090014
121000             WHEN SQLCODE = +100                                  12100014
121100             WHEN SQLCODE = -904                                  12110014
121200             WHEN SQLCODE = -913                                  12120014
121300                  CONTINUE                                        12130014
121400             WHEN SQLWARN0 NOT = SPACES                           12140014
121500             WHEN SQLCODE  NOT = ZERO                             12150014
121600                  MOVE 'R675-CLOSE-INSTRUC-CURSOR     '           12160014
121700                                TO WS-ABEND-PARAGRAPH             12170014
121800                  MOVE 'UNSUCCESSFUL CLOSE  INSTRUC'              12180014
121900                                TO WS-ABEND-OPERATION             12190014
122000                  MOVE 'TPOINST ' TO WS-ABEND-STRUCTURE-1         12200014
122100                  MOVE 'TINSTCD ' TO WS-ABEND-STRUCTURE-2         12210014
122200                  PERFORM Z999-SQL-ERROR                          12220014
122300         END-EVALUATE                                             12230014
122400     END-PERFORM.                                                 12240014
122500                                                                  12250014
122600     IF WS-RETRY-COUNT > WS-RETRY-MAX                             12260014
122700         MOVE 'R675-CLOSE-INSTRUC-CURSOR     '                    12270014
122800                       TO WS-ABEND-PARAGRAPH                      12280014
122900         MOVE 'MAX RETRIES EXCEEDED ON CLOSE  INSTRUC'            12290014
123000                         TO WS-ABEND-OPERATION                    12300014
123100          MOVE 'TPOINST ' TO WS-ABEND-STRUCTURE-1                 12310014
123200          MOVE 'TINSTCD ' TO WS-ABEND-STRUCTURE-2                 12320014
123300         PERFORM Z999-SQL-ERROR.                                  12330014
123400  EJECT                                                           12340014
123500 R700-GET-AD-EVNT-DTE.                                            12350014
123600                                                                  12360014
123700     PERFORM WITH TEST AFTER                                      12370014
123800         VARYING WS-RETRY-COUNT FROM 1 BY 1                       12380014
123900           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    12390014
124000              OR (SQLCODE = ZERO)                                 12400014
124100              OR (SQLCODE = +100)                                 12410014
124200                                                                  12420014
124300         EXEC SQL                                                 12430014
124400            SELECT                                                12440014
124500                MIN(AD_EVNT_DTE)                                  12450014
124600            INTO                                                  12460014
124700                :PV-DB2-DATE :PV-NULL-IND                         12470014
124800            FROM TPURITM                                          12480014
124900            WHERE PO_NBR         = :PURCHS-PO-NBR                 12490014
125000              AND VER_STATUS_CDE = 'A'                            12500014
125100              AND AD_EVNT_DTE > '0001-01-01'                      12510014
125200              AND STATUS_CDE NOT IN ('CA')                        12520014
125300         END-EXEC                                                 12530014
125400                                                                  12540014
125500         EVALUATE TRUE                                            12550014
125600             WHEN SQLCODE = ZERO                                  12560014
125700             WHEN SQLCODE = -904                                  12570014
125800             WHEN SQLCODE = -913                                  12580014
125900                  CONTINUE                                        12590014
126000             WHEN SQLCODE = +100                                  12600014
126100                 MOVE -1 TO PV-NULL-IND                           12610014
126200             WHEN OTHER                                           12620014
126300                 MOVE 'R700-GET-AD-EVNT-DTE           '           12630014
126400                                     TO WS-ABEND-PARAGRAPH        12640014
126500                 MOVE 'UNSUCCESSFUL SELECT PURITM'                12650014
126600                                     TO WS-ABEND-OPERATION        12660014
126700                 MOVE 'TPURITM'      TO WS-ABEND-STRUCTURE-1      12670014
126800                 PERFORM Z999-SQL-ERROR                           12680014
126900         END-EVALUATE                                             12690014
127000     END-PERFORM.                                                 12700014
127100                                                                  12710014
127200     IF WS-RETRY-COUNT > WS-RETRY-MAX                             12720014
127300         MOVE 'R700-GET-AD-EVNT-DTE           '                   12730014
127400                             TO WS-ABEND-PARAGRAPH                12740014
127500         MOVE 'MAX RETRIES EXCEEDED ON SELECT OF AD EVENT DTE'    12750014
127600                             TO WS-ABEND-OPERATION                12760014
127700         MOVE 'TPURITM'      TO WS-ABEND-STRUCTURE-1              12770014
127800         PERFORM Z999-SQL-ERROR                                   12780014
127900     END-IF.                                                      12790014
128000 EJECT                                                            12800014
128100**************************************************************    12810014
128200**  OPEN DISCOUNT CURSOR                                    **    12820014
128300**************************************************************    12830014
128400 R800-OPEN-DISCOUNT-CSR.                                          12840014
128500                                                                  12850014
128600     SET NOT-END-OF-DISCOUNT-CSR TO TRUE                          12860014
128700     PERFORM WITH TEST AFTER                                      12870014
128800         VARYING WS-RETRY-COUNT FROM 1 BY 1                       12880014
128900         UNTIL   WS-RETRY-COUNT > WS-RETRY-MAX                    12890014
129000            OR   SQLCODE = ZERO                                   12900014
129100            OR   SQLCODE = +100                                   12910014
129200                                                                  12920014
129300         EXEC SQL                                                 12930014
129400            OPEN DISCOUNT_CSR                                     12940014
129500         END-EXEC                                                 12950014
129600                                                                  12960014
129700         EVALUATE TRUE                                            12970014
129800             WHEN SQLCODE = ZERO                                  12980014
129900             WHEN SQLCODE = +100                                  12990014
130000             WHEN SQLCODE = -904                                  13000014
130100             WHEN SQLCODE = -913                                  13010014
130200                  CONTINUE                                        13020014
130300                                                                  13030014
130400             WHEN SQLWARN0 NOT = SPACES                           13040014
130500             WHEN SQLCODE  NOT = ZERO                             13050014
130600                  MOVE 'R800-OPEN-DISCOUNT-CSR'                   13060014
130700                                TO WS-ABEND-PARAGRAPH             13070014
130800                  MOVE 'UNSUCCESSFUL OPEN'                        13080014
130900                                TO WS-ABEND-OPERATION             13090014
131000                  MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1         13100014
131100                  MOVE SPACES     TO WS-ABEND-STRUCTURE-2         13110014
131200                  PERFORM Z999-SQL-ERROR                          13120014
131300         END-EVALUATE                                             13130014
131400     END-PERFORM.                                                 13140014
131500                                                                  13150014
131600     IF WS-RETRY-COUNT > WS-RETRY-MAX                             13160014
131700         MOVE 'R800-OPEN-DISCOUNT-CSR'                            13170014
131800                       TO WS-ABEND-PARAGRAPH                      13180014
131900         MOVE 'MAX RETRIES EXCEEDED ON OPEN'                      13190014
132000                         TO WS-ABEND-OPERATION                    13200014
132100         MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1                  13210014
132200         MOVE SPACES     TO WS-ABEND-STRUCTURE-2                  13220014
132300         PERFORM Z999-SQL-ERROR                                   13230014
132400     END-IF.                                                      13240014
132500                                                                  13250014
132600**************************************************************    13260014
132700**  FETCH DISCOUNT CURSOR                                   **    13270014
132800**************************************************************    13280014
132900 R825-FETCH-DISCOUNT-CSR.                                         13290014
133000                                                                  13300014
133100     PERFORM WITH TEST AFTER                                      13310014
133200        VARYING WS-RETRY-COUNT FROM 1 BY 1                        13320014
133300          UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                     13330014
133400             OR SQLCODE = ZERO                                    13340014
133500             OR SQLCODE = +100                                    13350014
133600        EXEC SQL                                                  13360014
133700            FETCH DISCOUNT_CSR                                    13370014
133800            INTO :PV-INCENTIVE-TYP-CDE                            13380014
133900               , :PV-INCENTIVE-DISC-PCT                           13390014
134000        END-EXEC                                                  13400014
134100                                                                  13410014
134200        EVALUATE TRUE                                             13420014
134300            WHEN SQLCODE = ZERO                                   13430014
134400                 CONTINUE                                         13440014
134500            WHEN SQLCODE = +100                                   13450014
134600                 SET END-OF-DISCOUNT-CSR TO TRUE                  13460014
134700            WHEN SQLCODE = -904                                   13470014
134800            WHEN SQLCODE = -913                                   13480014
134900              CONTINUE                                            13490014
135000            WHEN SQLWARN0 NOT = SPACES                            13500014
135100            WHEN SQLCODE  NOT = ZERO                              13510014
135200              MOVE 'R825-FETCH-DISCOUNT-CSR'                      13520014
135300                            TO WS-ABEND-PARAGRAPH                 13530014
135400              MOVE 'UNSUCCESSFUL FETCH'                           13540014
135500                            TO WS-ABEND-OPERATION                 13550014
135600              MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1             13560014
135700              MOVE SPACES     TO WS-ABEND-STRUCTURE-2             13570014
135800              PERFORM Z999-SQL-ERROR                              13580014
135900           END-EVALUATE                                           13590014
136000     END-PERFORM.                                                 13600014
136100                                                                  13610014
136200     IF WS-RETRY-COUNT > 3                                        13620014
136300         MOVE 'R825-FETCH-DISCOUNT-CSR'                           13630014
136400                         TO WS-ABEND-PARAGRAPH                    13640014
136500         MOVE 'MAX RETRIES EXCEEDED ON FETCH'                     13650014
136600                         TO WS-ABEND-OPERATION                    13660014
136700         MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1                  13670014
136800         MOVE SPACES     TO WS-ABEND-STRUCTURE-2                  13680014
136900         PERFORM Z999-SQL-ERROR                                   13690014
137000     END-IF.                                                      13700014
137100  EJECT                                                           13710014
137200**************************************************************    13720014
137300**  CLOSE DISCOUNT CURSOR                                   **    13730014
137400**************************************************************    13740014
137500 R850-CLOSE-DISCOUNT-CSR.                                         13750014
137600                                                                  13760014
137700     PERFORM WITH TEST AFTER                                      13770014
137800         VARYING WS-RETRY-COUNT FROM 1 BY 1                       13780014
137900           UNTIL WS-RETRY-COUNT > WS-RETRY-MAX                    13790014
138000              OR SQLCODE = ZERO                                   13800014
138100              OR SQLCODE = +100                                   13810014
138200                                                                  13820014
138300         EXEC SQL                                                 13830014
138400            CLOSE DISCOUNT_CSR                                    13840014
138500         END-EXEC                                                 13850014
138600                                                                  13860014
138700         EVALUATE TRUE                                            13870014
138800             WHEN SQLCODE = ZERO                                  13880014
138900             WHEN SQLCODE = +100                                  13890014
139000             WHEN SQLCODE = -904                                  13900014
139100             WHEN SQLCODE = -913                                  13910014
139200                  CONTINUE                                        13920014
139300             WHEN SQLWARN0 NOT = SPACES                           13930014
139400             WHEN SQLCODE  NOT = ZERO                             13940014
139500                  MOVE 'R850-CLOSE-DISCOUNT-CSR'                  13950014
139600                                  TO WS-ABEND-PARAGRAPH           13960014
139700                  MOVE 'UNSUCCESSFUL CLOSE'                       13970014
139800                                  TO WS-ABEND-OPERATION           13980014
139900                  MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1         13990014
140000                  MOVE SPACES     TO WS-ABEND-STRUCTURE-2         14000014
140100                  PERFORM Z999-SQL-ERROR                          14010014
140200         END-EVALUATE                                             14020014
140300     END-PERFORM.                                                 14030014
140400                                                                  14040014
140500     IF WS-RETRY-COUNT > WS-RETRY-MAX                             14050014
140600         MOVE 'R850-CLOSE-DISCOUNT-CSR'                           14060014
140700                         TO WS-ABEND-PARAGRAPH                    14070014
140800         MOVE 'MAX RETRIES EXCEEDED ON CLOSE'                     14080014
140900                         TO WS-ABEND-OPERATION                    14090014
141000         MOVE 'TPOAGMT ' TO WS-ABEND-STRUCTURE-1                  14100014
141100         MOVE SPACES     TO WS-ABEND-STRUCTURE-2                  14110014
141200         PERFORM Z999-SQL-ERROR                                   14120014
141300     END-IF.                                                      14130014
141400  EJECT                                                           14140014
141500******************************************************************14150014
141600* Y100-READ-CONTROL-CARD                                          14160014
141700******************************************************************14170014
141800 Y100-READ-CONTROL-CARD.                                          14180014
141900     READ CONTROL-CARD-FILE INTO CONTROL-CARD-RECORD              14190014
142000        AT END                                                    14200014
142100           SET END-OF-CONTROL-CARD TO TRUE.                       14210014
142200                                                                  14220014
142300 Z999-SQL-ERROR.                                                  14230014
142400*                                                                 14240014
142500***************************************************************** 14250014
142600*     PROCESS DB2 ABENDS                                          14260014
142700***************************************************************** 14270014
142800*                                                                 14280014
142900     DISPLAY '*** DB2 ERROR '.                                    14290014
143000     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 14300014
143100     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               14310014
143200     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               14320014
143300     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             14330014
143400     IF WS-ABEND-STRUCTURE-2 > SPACES                             14340014
143500         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         14350014
143600                                                                  14360014
143700     MOVE +4013                    TO ABEND-CODE.                 14370014
143800                                                                  14380014
143900     COPY DPPD004.                                                14390014
144000     CALL 'ILBOABN0' USING ABEND-CODE.                            14400014
144100                                                                  14410014
