000100 ID  DIVISION.                                                    00010000
000200 PROGRAM-ID.         POKUT218.                                    00020000
000300 AUTHOR.             COGNIZANT.                                   00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       04/10.                                       00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*     PO/LINE OPEN TO RECEIVE                                     00090000
001000******************************************************************00100000
001100*     CHANGE LOG                                                 *        
001200******************************************************************        
001300*    DATE  04/10/10                                              *        
001400*  CHANGE MADE: NEW PROGRAM                                      *        
001500*  MADE BY: COGNIZANT                              WR #: 2344    *        
001600******************************************************************        
001700* 04/12/12 MADE BY: COGNIZANT               WR/IR #: CRQ 23538            
001800* CHANGES: CHANGED RECORD LAYOUT FOR PO RECORDS.                          
001900******************************************************************        
002000* 07/18/12 MADE BY: COGNIZANT               WR/IR #: CRQ 29188            
002100* CHANGES: CHANGED RECORD LAYOUT FOR PO RECORDS TO INCLUDE DIST           
002200*          DATE WEEK NUMBER                                               
002300******************************************************************        
002000* 02/04/13 MADE BY: L. FRIESS               WR/IR #: CRQ 40236            
002100* CHANGES: ADDED PARAGRAPH C110 TO GET ECOMM INDICATOR                    
002300******************************************************************        
100368******************************************************************        
100368* 01/16/2015 - COGNIZANT                          CHG0100368              
100368*   MADE CHANGES TO PO_RECEIPTS_CURSOR FOR PERFORMANCE TUNING             
      * 01/19/2015 - COGNIZANT                          CHG0102554              
      *   RECOMPILATION WITH PROD COPYBOOK POWS010, THE PROGRAM                 
      *   COMPILED IN PRODUCTION WITH QA COPYBOOK WHICH HAS PO                  
      *   EXTENDED DIGIT CHANGES                                                
100368*****************************************************************         
C98147* 01/21/15 MADE BY: L. FRIESS               CHG0098147                    
C98147* CHANGES: RECOMPILED TO BRING IN POWS010 COPYBOOK WITH                   
C98147*          EXPANDED PO NUMBER & REPLACED HARD-CODED REFERENCES            
C98147*          TO POWS010 E-BUS-IND                                           
C98147*****************************************************************         
002400                                                                  00110000
002500 ENVIRONMENT DIVISION.                                            00120000
002600*                                                                 00130000
002700 CONFIGURATION SECTION.                                           00140000
002800*                                                                 00150000
002900 SOURCE-COMPUTER.        IBM-3090.                                00160000
003000 OBJECT-COMPUTER.        IBM-3090.                                00170000
003100*                                                                 00180000
003200 INPUT-OUTPUT SECTION.                                            00190000
003300 FILE-CONTROL.                                                    00200000
003400     SELECT  OPEN-TO-RECEIVE-FILE                                 00210000
003500         ASSIGN TO OUT01.                                         00220000
003600                                                                  00230000
003700 DATA DIVISION.                                                   00240000
003800 FILE SECTION.                                                    00250000
003900*                                                                 00260000
004000 FD  OPEN-TO-RECEIVE-FILE                                         00270000
004100     RECORDING MODE IS F                                          00280000
004200     LABEL RECORDS ARE STANDARD                                   00290000
004300     BLOCK CONTAINS 0 RECORDS.                                    00300000
004400 01  OPEN-TO-RECEIVE-RECORD        PIC X(210).                    00310000
004500*                                                                 00320000
004600                                                                  00330000
004700 WORKING-STORAGE SECTION.                                         00340000
004800*                                                                 00350000
004900 01  SD-SYSTEM-DATE                                VALUE ZERO.    00360000
005000     05  SD-SYSTEM-YEAR              PIC  9(02).                  00370000
005100     05  SD-SYSTEM-MONTH             PIC  9(02).                  00380000
005200     05  SD-SYSTEM-DAY               PIC  9(02).                  00390000
005300*                                                                 00400000
005400 01  SD-SYSTEM-DATE-CENT                           VALUE ZERO.    00410000
005500     05  SD-SYSTEM-CENT-CC           PIC  9(02).                  00420000
005600     05  SD-SYSTEM-CENT-YY           PIC  9(02).                  00430000
005700     05  SD-SYSTEM-CENT-MM           PIC  9(02).                  00440000
005800     05  SD-SYSTEM-CENT-DD           PIC  9(02).                  00450000
005900 01  CC-CONTROL-CARD.                                             00451005
006000     05 CC-CALENDAR-TYPE                 PIC X(02)   VALUE SPACES.00452005
006100     05  FILLER                          PIC X(01)   VALUE SPACES.00453005
006200     05 CC-DATE.                                                  00454005
006300         10  CC-MM                       PIC 9(02)   VALUE ZEROES.00455005
006400         10 CC-DD                        PIC 9(02)   VALUE ZEROES.00456005
006500         10  CC-CC                       PIC 9(02)   VALUE ZEROES.00457005
006600         10 CC-YY                        PIC 9(02)   VALUE ZEROES.00458005
006700     05  FILLER                          PIC X(71)   VALUE SPACES.00459005
006800*                                                                 00459105
006900*                                                                 00460000
007000 01  DD-DATES.                                                    00470000
007100     05  DD-START-DATE        PIC X(10).                          00480000
007200     05  DD-START-DATE-X REDEFINES DD-START-DATE.                 00490000
007300         10  DD-START-CENT    PIC 9(02).                          00500000
007400         10  DD-START-YEAR    PIC 9(02).                          00510000
007500         10  FILLER           PIC X(01).                          00520000
007600         10  DD-START-MONTH   PIC 9(02).                          00530000
007700         10  FILLER           PIC X(01).                          00540000
007800         10  DD-START-DAY     PIC 9(02).                          00550000
007900     05  DD-STOP-DATE         PIC X(10).                          00560000
008000     05  DD-STOP-DATE-X REDEFINES DD-STOP-DATE.                   00570000
008100         10  DD-STOP-CENT     PIC 9(02).                          00580000
008200         10  DD-STOP-YEAR     PIC 9(02).                          00590000
008300         10  FILLER           PIC X(01).                          00600000
008400         10  DD-STOP-MONTH    PIC 9(02).                          00610000
008500         10  FILLER           PIC X(01).                          00620000
008600         10  DD-STOP-DAY      PIC 9(02).                          00630000
008700     05  DD-CONVT-START1-DATE PIC X(08).                          00640000
008800     05  DD-CONVT-START1-DATE-X REDEFINES DD-CONVT-START1-DATE.   00650000
008900         10  DDC-START1-CENT  PIC 9(02).                          00660000
009000         10  DDC-START1-YEAR  PIC 9(02).                          00670000
009100         10  DDC-START1-MONTH PIC 9(02).                          00680000
009200         10  DDC-START1-DAY   PIC 9(02).                          00690000
009300     05  DD-CONVT-STOP1-DATE PIC X(08).                           00700000
009400     05  DD-CONVT-STOP1-DATE-X REDEFINES DD-CONVT-STOP1-DATE.     00710000
009500         10  DDC-STOP1-CENT  PIC 9(02).                           00720000
009600         10  DDC-STOP1-YEAR  PIC 9(02).                           00730000
009700         10  DDC-STOP1-MONTH PIC 9(02).                           00740000
009800         10  DDC-STOP1-DAY   PIC 9(02).                           00750000
009900     05  DD-CONVT-START2-DATE PIC X(08).                          00760000
010000     05  DD-CONVT-START2-DATE-X REDEFINES DD-CONVT-START2-DATE.   00770000
010100         10  DDC-START2-CENT  PIC 9(02).                          00780000
010200         10  DDC-START2-YEAR  PIC 9(02).                          00790000
010300         10  DDC-START2-MONTH PIC 9(02).                          00800000
010400         10  DDC-START2-DAY   PIC 9(02).                          00810000
010500     05  DD-CONVT-STOP2-DATE PIC X(08).                           00820000
010600     05  DD-CONVT-STOP2-DATE-X REDEFINES DD-CONVT-STOP2-DATE.     00830000
010700         10  DDC-STOP2-CENT  PIC 9(02).                           00840000
010800         10  DDC-STOP2-YEAR  PIC 9(02).                           00850000
010900         10  DDC-STOP2-MONTH PIC 9(02).                           00860000
011000         10  DDC-STOP2-DAY   PIC 9(02).                           00870000
011100     05  DD-CONVT-CLOSED-DATE PIC X(08).                          00880000
011200     05  DD-CONVT-CLOSED-DATE-X REDEFINES DD-CONVT-CLOSED-DATE.   00890000
011300         10  DDC-CLOSED-CENT  PIC 9(02).                          00900000
011400         10  DDC-CLOSED-YEAR  PIC 9(02).                          00910000
011500         10  DDC-CLOSED-MONTH PIC 9(02).                          00920000
011600         10  DDC-CLOSED-DAY   PIC 9(02).                          00930000
011700*                                                                 00940000
011800 01  DK-DATABASE-KEYS.                                            00950000
011900     05  DK-ORD-NBR                 PIC  S9(9) COMP.              00960000
012000     05  DK-ORD-LNE-NBR             PIC  S9(9) COMP.              00970000
012100*                                                                 00980000
012200 01  PC-PROGRAM-CONSTANTS.                                        00990000
012300     05  PC-MAX-RETRIES             PIC S9(03)   VALUE +03        01000000
012400                                                 COMP-3.          01010000
012500     05  PC-OPERCO-NBR              PIC X(02)    VALUE '03'.      01020000
012600*                                                                 01030000
012700 01  PV-PROGRAM-VARIABLES.                                        01040000
012800     05  PV-PARAGRAPH-NAME          PIC X(30)    VALUE SPACE.     01050000
012900     05  PV-DB2-OPER-ATTEMPTED      PIC X(30)    VALUE SPACE.     01060000
013000     05  PV-PO-UNITS-RECEIVED       PIC 9(09)    VALUE ZERO.      01070000
013100     05  PV-PO-RETAIL-RECEIVED      PIC 9(11)V99 VALUE ZERO.      01080000
013200     05  PV-SQL-SUB                 PIC S9(4)    VALUE ZERO  COMP.01090000
010800     05  E-BUS-NULL-IND             PIC S9(04)   COMP VALUE ZERO.         
013300     05  PV-UNIT-RTL                PIC S9(9)V99 VALUE ZERO       01100000
013400                                                 COMP-3.          01110000
013500     05  PV-STORE-NBR               PIC 9(04).                    01120014
013600     05  PV-STORE-NBR-X   REDEFINES                               01130000
013700                  PV-STORE-NBR      PIC X(04).                    01140014
013800     05  PV-STR-DC-NBR              PIC S9(04) COMP.              01141014
013900*                                                                 01150000
014000     05  PV-STR-TABLE.                                            01160000
014100         10  PV-STR-ENTRY                OCCURS 2000 TIMES        01170014
014200                                         INDEXED BY PV-STR-INDEX. 01180000
014300             15  PV-STORE-NMBR           PIC X(004).              01190014
014400             15  PV-DC-NMBR              PIC X(004).              01200014
014500     05  PV-END-DATE                     PIC X(10).               01201002
014600     05  PV-END-DATE-RED REDEFINES PV-END-DATE.                   01202002
014700         10  PV-END-DATE-CC       PIC 9(02).                      01203002
014800         10  PV-END-DATE-YY       PIC 9(02).                      01204002
014900         10  PV-END-DATE-FILLER   PIC X(01).                      01205014
015000         10  PV-END-DATE-MM       PIC 9(02).                      01206002
015100         10  PV-END-DATE-FILLER2  PIC X(01).                      01207014
015200         10  PV-END-DATE-DD       PIC 9(02).                      01208002
015300*                                                                 01210000
015400 01  PS-PROGRAM-SWITCHES.                                         01220000
015500     05  PS-MORE-INPUT-RECS-SW           PIC X(01)   VALUE 'Y'.   01230000
015600         88  PS-MORE-INPUT-RECS                      VALUE 'Y'.   01240000
015700         88  PS-NO-MORE-INPUT-RECS                   VALUE 'N'.   01250000
015800     05  PS-MORE-PO-RCPT-ROWS-SW         PIC X(01)   VALUE 'Y'.   01260000
015900         88  PS-MORE-PO-RCPT-ROWS                    VALUE 'Y'.   01270000
016000         88  PS-NO-MORE-PO-RCPT-ROWS                 VALUE 'N'.   01280000
016100     05  PS-MORE-STORE-ROWS-SW           PIC X(01)   VALUE 'Y'.   01290000
016200         88  PS-MORE-STORE-ROWS                      VALUE 'Y'.   01300000
016300         88  PS-NO-MORE-STORE-ROWS                   VALUE 'N'.   01310000
016400******************************************************************01311005
016500*    CALENDAR ROUTINE                                             01312005
016600******************************************************************01313005
016700     COPY DPWS500.                                                01314005
016800*                                                                 01320000
016900******************************************************************01330000
017000*  INPUT/OUTPUT RECORD LAYOUT.                                    01340000
017100******************************************************************01350000
017200     COPY POWS010.                                                01360000
017300*                                                                 01370000
017400******************************************************************01380000
017500*** SQL ABEND ROUTINE WORKING STORAGE                             01390000
017600******************************************************************01400000
017700*                                                                 01410000
017800     COPY DPWS004.                                                01420000
017900     EJECT                                                        01430000
018000*                                                                 01440000
018100*****  DB2 PURCHASE ORDER STATUS CODE TABLE                       01450000
018200*                                                                 01460000
018300     EXEC SQL                                                     01470000
018400         INCLUDE TSTATCD                                          01480000
018500     END-EXEC.                                                    01490000
018600*                                                                 01500000
018700*                                                                 01510000
018800*****  DB2 RECEIVER HEADER TABLE                                  01520000
018900*                                                                 01530000
019000     EXEC SQL                                                     01540000
019100         INCLUDE TRECEIV                                          01550000
019200     END-EXEC.                                                    01560000
019300*                                                                 01570000
019400*                                                                 01580000
019500*****  DB2 RECIEVER DISTRIBUTION TABLE                            01590000
019600*                                                                 01600000
019700     EXEC SQL                                                     01610000
019800         INCLUDE TRECDIS                                          01620000
019900     END-EXEC.                                                    01630000
020000*                                                                 01640000
020100*****  DB2 PURCHASE ORDER TABLE                                   01650000
020200*                                                                 01660000
020300     EXEC SQL                                                     01670000
020400         INCLUDE TPURCHS                                          01680000
020500     END-EXEC.                                                    01690000
020600*                                                                 01752014
020700*****  DB2   LOCATION  TABLE                                      01753014
020800*                                                                 01754014
020900     EXEC SQL                                                     01755014
021000         INCLUDE XMT00001                                         01756014
021100     END-EXEC.                                                    01757014
021200*                                                                 01758014
021300*****  DB2   DC/LOC    TABLE                                      01759014
021400*                                                                 01759114
021500     EXEC SQL                                                     01759214
021600         INCLUDE XMT00002                                         01759314
021700     END-EXEC.                                                    01759414
021800*                                                                 01760000
021900***************************************************************** 01770000
022000     EXEC SQL                                                     01780000
022100         INCLUDE SQLCA                                            01790000
022200     END-EXEC.                                                    01800000
022300     EJECT                                                        01810000
022400                                                                  01820000
022500     COPY SQLCA2.                                                 01830000
022600                                                                  01840000
022700***************************************************************** 01850000
022800*                                                                 01860000
022900***************************************************************** 01870000
023000     EXEC SQL                                                     01880000
023100        DECLARE PO_RECEIPTS_CURSOR CURSOR FOR                     01890000
023200                                                                  01900000
023300           SELECT  SUM(B.AP_VERIFY_ITM_QTY),                      01910000
023400                   B.STR_NBR,                                     01920000
023500                   B.ORD_NBR,                                     01930000
023600                   B.ORD_LNE_NBR                                  01940000
023700            FROM TSTATCD A,                                       01950000
023800                 TRECDIS B,                                       01960000
023900                 TRECEIV D,                                       01970000
024000                 TPURCHS E                                        01980000
024100            WHERE                                                 01990000
024200              (DATE(D.VERFYD_TMST) <= :PV-END-DATE) AND           01991011
PTUNE               (E.STATUS_TMST = E.STATUS_TMST)       AND                   
024300              (E.PO_CATEG_CDE= 'MR')                AND           02000000
024400              (E.VER_STATUS_CDE = 'A')              AND           02010000
024500              (E.STATUS_CDE = A.STATUS_CDE)         AND           02020000
024600              (A.STATUS_TYP_CDE = 'P')              AND           02030000
024700              (A.STATUS_CLS = 'ACT')                AND           02040000
024800              (D.ORD_NBR = E.PO_NBR)                AND           02050000
024900              (D.VER_STATUS_CDE = 'A')              AND           02060000
025000              (D.STATUS_CDE = 'VE')                 AND           02070000
025100              (D.ORD_NBR = B.ORD_NBR)               AND           02080000
025200              (D.REC_SEQ_NBR = B.REC_SEQ_NBR)       AND           02090000
025300              (D.OPER_UNT_ID  = B.OPER_UNT_ID)      AND           02100000
025400              (B.VER_STATUS_CDE = 'A')                            02110000
025500        GROUP BY                                                  02120000
025600                   B.STR_NBR,                                     02130000
025700                   B.ORD_NBR,                                     02140000
025800                   B.ORD_LNE_NBR                                  02150000
025900        WITH UR                                                   02151024
026000     END-EXEC.                                                    02160000
026100                                                                  02170000
026200***************************************************************** 02180000
026300*                                                                 02190000
026400***************************************************************** 02200000
026500     EXEC SQL                                                     02210000
026600        DECLARE STORE_CURSOR CURSOR FOR                           02220000
026700           SELECT XL1.LOC_NBR,                                    02230014
026800                  XL1.LOC_5_ABBR_NM,                              02240014
026900                  XL2.LOC_NBR                                     02250014
027000             FROM XMT_LOC XL1,                                    02260014
027100                  XMT_LOC XL2                                     02270014
027200            WHERE XL2.LOC_TYP_CDE = 'DC'                          02280014
027300              AND XL2.LOC_NBR =                                   02290014
027400                 (SELECT DC_NBR                                   02300014
027500                    FROM XMT_DC_LOC_ASGMT DLA1                    02310014
027600                   WHERE DLA1.LOC_NBR = XL1.LOC_NBR               02320014
027700                     AND DLA1.PO_STRT_DTE =                       02330014
027800                        (SELECT MAX(PO_STRT_DTE)                  02340014
027900                           FROM XMT_DC_LOC_ASGMT DLA2             02350014
028000                          WHERE DLA2.PO_STRT_DTE <=               02360014
028100                                CURRENT DATE                      02370014
028200                           AND DLA1.LOC_NBR = DLA2.LOC_NBR))      02380014
028300            ORDER BY XL1.LOC_NBR                                  02390014
028400        WITH UR                                                           
028500     END-EXEC.                                                    02480000
028600 01  ABEND-CODE               PIC S9(04)  VALUE ZERO              02490000
028700                                          COMP SYNC.              02500000
028800     EJECT                                                        02510000
028900 LINKAGE SECTION.                                                 02520000
029000*                                                                 02530000
029100 PROCEDURE DIVISION.                                              02540000
029200*                                                                 02550000
029300******************************************************************02560000
029400*                                                                 02570000
029500******************************************************************02580000
029600 A100-MAIN-MODULE.                                                02590000
029700                                                                  02600000
029800     PERFORM B100-OPEN-FILES.                                     02610000
029900     PERFORM B125-EDIT-CONTROL-CARD.                              02611008
030000     PERFORM B150-PROCESS-STORE-CURSOR.                           02620000
030100     PERFORM B200-UNLOAD.                                         02630000
030200     PERFORM B300-CLOSE-FILES.                                    02640000
030300                                                                  02650000
030400     STOP RUN.                                                    02660000
030500                                                                  02670000
030600*                                                                 02671005
030700******************************************************************02682000
030800*                                                                 02690000
030900******************************************************************02700000
031000 B100-OPEN-FILES.                                                 02710000
031100*                                                                 02720000
031200     OPEN                                                         02730000
031300           OUTPUT OPEN-TO-RECEIVE-FILE.                           02740000
031400*                                                                 02750000
031500******************************************************************02672005
031600*                                                                 02673005
031700******************************************************************02674005
031800 B125-EDIT-CONTROL-CARD.                                          02675005
031900*                                                                 02676005
032000     ACCEPT CC-CONTROL-CARD FROM SYSIN.                           02677005
032100     ACCEPT DPG51-SYSTEM-DATE FROM DATE.                          02678005
032200                                                                  02679005
032300     DISPLAY 'CONTROL CARD : ' CC-CONTROL-CARD.                   02679105
032400                                                                  02679205
032500     MOVE CC-DATE TO DPG52-LK-DATE-INPUT                          02679305
032600     MOVE CC-CALENDAR-TYPE TO DPG51-CALENDAR-TYPE.                02679405
032700     SET  DPG52-LK-DTE-GREG-CC TO TRUE.                           02679505
032800                                                                  02679605
032900     CALL DP500-KOHLS-CALENDAR-ROUTINE USING                      02679705
033000                                DPG51 DPG52                       02679805
033100                                DPG53 DPG54                       02679905
033200                                DPG55 DPG56.                      02680005
033300                                                                  02680105
033400     IF DPG54-NO-ERROR                                            02680205
033500         MOVE DPG55-DB2-ISO-DATE-FMT     TO PV-END-DATE           02680305
033600     ELSE                                                         02680905
033700         DISPLAY '** ABEND ** IN POKUT218'                        02681005
033800         DISPLAY 'DATE ERROR : ' DPG54-ERROR-MESSAGE              02681105
033900         MOVE +4003 TO ABEND-CODE                                 02681205
034000         CALL 'ILBOABN0' USING ABEND-CODE                         02681305
034100     END-IF.                                                      02681405
034200******************************************************************02760000
034300*                                                                 02770000
034400******************************************************************02780000
034500 B150-PROCESS-STORE-CURSOR.                                       02790000
034600     ACCEPT SD-SYSTEM-DATE FROM DATE.                             02800000
034700     DISPLAY 'SD-SYSTEM-DATE ' SD-SYSTEM-DATE.                    02810000
034800                                                                  02820000
034900     MOVE SD-SYSTEM-YEAR  TO SD-SYSTEM-CENT-YY                    02830000
035000     MOVE SD-SYSTEM-MONTH TO SD-SYSTEM-CENT-MM                    02840000
035100     MOVE SD-SYSTEM-DAY   TO SD-SYSTEM-CENT-DD                    02850000
035200     IF SD-SYSTEM-YEAR > 80                                       02860000
035300        MOVE '19' TO SD-SYSTEM-CENT-CC                            02870000
035400     ELSE                                                         02880000
035500        MOVE '20' TO SD-SYSTEM-CENT-CC                            02890000
035600     END-IF                                                       02900000
035700     INITIALIZE PV-STR-TABLE.                                     02910000
035800     PERFORM  Z600-OPEN-STORE-CURSOR.                             02920000
035900     PERFORM  Z610-FETCH-STORE-CURSOR.                            02930000
036000     PERFORM UNTIL PS-NO-MORE-STORE-ROWS                          02940000
036100        PERFORM B170-LOAD-STORE-TABLE                             02950000
036200        PERFORM  Z610-FETCH-STORE-CURSOR                          02960000
036300     END-PERFORM.                                                 02970000
036400     PERFORM Z620-CLOSE-STORE-CURSOR.                             02980000
036500******************************************************************02990000
036600*                                                                 03000000
036700******************************************************************03010000
036800 B170-LOAD-STORE-TABLE.                                           03020000
036900     IF PV-STR-INDEX          >  2000                             03030014
037000         DISPLAY             '*** ABEND ***'                      03040000
037100         DISPLAY  '*** STORE TABLE HAS EXCEEDED 2000 ENTRIES***'  03050014
037200         MOVE                  +4002 TO ABEND-CODE                03060000
037300         CALL                 'ILBOABN0' USING ABEND-CODE         03070001
037400     END-IF.                                                      03080000
037500     MOVE XMT00001-LOC-NBR TO PV-STORE-NMBR(PV-STR-INDEX).        03090014
037600     MOVE PV-STR-DC-NBR    TO PV-DC-NMBR(PV-STR-INDEX)            03100014
037700     SET PV-STR-INDEX UP BY 1.                                    03110000
037800                                                                  03120000
037900******************************************************************03930000
038000*  GET ALL RECEIPTS FOR THIS PO/LINE.                             03940000
038100******************************************************************03950000
038200 B200-UNLOAD.                                                     03960000
038300                                                                  03970000
038400     SET PS-MORE-PO-RCPT-ROWS TO TRUE.                            03980000
038500     PERFORM Z300-OPEN-PO-RECEIPTS-CURSOR.                        03990000
038600     PERFORM Z400-FETCH-PO-RECEIPTS-ROW.                          04000000
038700                                                                  04010000
038800     INITIALIZE PO010-RECORD.                                     04020000
038900                                                                  04030000
039000     PERFORM UNTIL PS-NO-MORE-PO-RCPT-ROWS                        04040000
039100                                                                  04050000
039200         COMPUTE PO010-OPEN-UNITS =                               04060000
039300                            RECDIS-AP-VERIFY-ITM-QTY  * -1        04070000
039400         END-COMPUTE                                              04080000
039500                                                                  04090000
039600         MOVE RECDIS-ORD-NBR TO PO010-PO-NUMBER                   04100000
039700         MOVE RECDIS-ORD-LNE-NBR TO PO010-PO-LINE                 04110000
039800         IF RECDIS-STR-NBR = PV-STORE-NBR                         04120000
039900             MOVE PV-DC-NMBR(PV-STR-INDEX) TO PO010-DC-NBR        04130000
040000          ELSE                                                    04140000
040100             MOVE RECDIS-STR-NBR     TO PV-STORE-NBR              04150000
040200             SET PV-STR-INDEX TO 1                                04160000
040300             PERFORM C100-SEARCH-STORE-TABLE                      04170000
040400          END-IF                                                  04180000
171100                                                                          
171200          MOVE PO010-DC-NBR TO XMT00001-LOC-NBR                           
171300          PERFORM C110-PROCESS-EBUS-DATA                                  
040500          PERFORM Z200-WRITE-OUTPUT-RECORD                        04190000
040600          PERFORM Z400-FETCH-PO-RECEIPTS-ROW                      04200000
040700     END-PERFORM.                                                 04210000
040800                                                                  04220000
040900     PERFORM Z500-CLOSE-PO-RECEIPTS-CURSOR.                       04230000
041000                                                                  04240000
041100******************************************************************04400000
041200*  CLOSE ALL FILES USED BY THIS PROGRAM.                          04410000
041300******************************************************************04420000
041400 B300-CLOSE-FILES.                                                04430000
041500*                                                                 04440000
041600     CLOSE                                                        04450000
041700           OPEN-TO-RECEIVE-FILE.                                  04460000
                                                                                
041800*                                                                 04470000
041900******************************************************************04250000
042000*  SEARCH THE STORE TABLE FOR THE CORRECT DC NUMBER.              04260000
042100******************************************************************04270000
042200 C100-SEARCH-STORE-TABLE.                                         04280000
042300         SEARCH                      PV-STR-ENTRY                 04290000
042400             AT  END                                              04300000
042500                 DISPLAY 'STORE NOT FOUND '                       04310000
042600                          'STORE NUMBER =  '  PV-STORE-NBR        04320000
042700                 MOVE PV-STORE-NBR  TO   PO010-DC-NBR             04330000
042800                 INITIALIZE PV-STORE-NBR                          04340000
042900             WHEN PV-STORE-NMBR(PV-STR-INDEX) = PV-STORE-NBR      04350000
043000             MOVE PV-DC-NMBR(PV-STR-INDEX) TO PO010-DC-NBR        04360000
043100         END-SEARCH.                                              04370000
043200                                                                  04380000
173600*                                                                         
173700******************************************************************        
173800* GET THE E-BUSINESS INDICATOR FOR ACTIVE PO DATA                         
173900******************************************************************        
174100 C110-PROCESS-EBUS-DATA.                                                  
174200                                                                          
174300     INITIALIZE E-BUS-NULL-IND XMT00001-E-BUS-IND                         
174400     EXEC SQL                                                             
174500          SELECT                                                          
174600                LOC.E_BUS_IND                                             
174700          INTO                                                            
174800               :XMT00001-E-BUS-IND                                        
174900               :E-BUS-NULL-IND                                            
175000           FROM                                                           
175100                XMT_LOC  LOC                                              
175200           WHERE                                                          
175300                LOC.LOC_NBR  = :XMT00001-LOC-NBR                          
175400           WITH UR                                                        
175500     END-EXEC                                                             
175600                                                                          
175700     IF SQLCODE = 0                                                       
175800         IF E-BUS-NULL-IND < 0 THEN                                       
C98147           MOVE 'N'   TO  PO010-E-BUS-IND                                 
176100         ELSE                                                             
C98147           MOVE XMT00001-E-BUS-IND  TO  PO010-E-BUS-IND                   
176400         END-IF                                                           
176500     ELSE                                                                 
176600         MOVE 'C110-PROCESS-EBUS-DATA'                                    
176700                                    TO PV-PARAGRAPH-NAME                  
176800         MOVE 'RETRIEVING E-BUSINESS INDICATOR'                           
176900                                    TO PV-DB2-OPER-ATTEMPTED              
177000         DISPLAY 'PURCHS-PO-NBR' PURCHS-PO-NBR                            
177100         PERFORM Z900-SQL-ABEND                                           
177200     END-IF.                                                              
177300                                                                          
043300*                                                                 04390000
043400******************************************************************04490000
043500* WRITE THE RECORD TO THE OUTPUT FILE.                            04500000
043600******************************************************************04510000
043700 Z200-WRITE-OUTPUT-RECORD.                                        04520000
043800*                                                                 04530000
043900     WRITE OPEN-TO-RECEIVE-RECORD  FROM PO010-RECORD.             04540000
044000*                                                                 04550000
044100******************************************************************04560000
044200*    OPEN THE CURSOR WHICH WILL RETRIEVE ALL RECEIPTS FOR THIS    04570000
044300*    PO/LINE COMBINATION AND THE RETAIL IT WS RECEIVED AT.        04580000
044400***************************************************************** 04590000
044500 Z300-OPEN-PO-RECEIPTS-CURSOR.                                    04600000
044600                                                                  04610000
044700     PERFORM                                                      04620000
044800         WITH TEST AFTER                                          04630000
044900         VARYING PV-SQL-SUB                                       04640000
045000         FROM 1 BY 1                                              04650000
045100         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       04660000
045200                   OR SQLCODE = 0                                 04670000
045300                   OR SQLCODE = +100)                             04680000
045400                                                                  04690000
045500         EXEC SQL                                                 04700000
045600             OPEN PO_RECEIPTS_CURSOR                              04710000
045700         END-EXEC                                                 04720000
045800                                                                  04730000
045900         EVALUATE TRUE                                            04740000
046000             WHEN SQLCODE = -904                                  04750000
046100             WHEN SQLCODE = -911                                  04760000
046200             WHEN SQLCODE = 0                                     04770000
046300                 CONTINUE                                         04780000
046400             WHEN SQLCODE = +100                                  04790000
046500                 SET PS-NO-MORE-PO-RCPT-ROWS TO TRUE              04800000
046600             WHEN SQLWARN NOT = SPACES                            04810000
046700             WHEN SQLCODE NOT = ZERO                              04820000
046800                 MOVE 'Z300-OPEN-PO-RECEIPTS-CURSOR'              04830000
046900                               TO  PV-PARAGRAPH-NAME              04840000
047000                 MOVE 'OPEN ON CURSOR'                            04850000
047100                               TO  PV-DB2-OPER-ATTEMPTED          04860000
047200                 PERFORM Z900-SQL-ABEND                           04870000
047300         END-EVALUATE                                             04880000
047400     END-PERFORM.                                                 04890000
047500*                                                                 04900000
047600     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        04910000
047700         MOVE 'Z300-OPEN-PO-RECEIPTS-CURSOR'                      04920000
047800                               TO  PV-PARAGRAPH-NAME              04930000
047900         MOVE 'OPEN RETRIES EXCEEDED'                             04940000
048000                               TO  PV-DB2-OPER-ATTEMPTED          04950000
048100         PERFORM Z900-SQL-ABEND                                   04960000
048200     END-IF.                                                      04970000
048300                                                                  04980000
048400*                                                                 04990000
048500******************************************************************05000000
048600*    FETCH THE NEXT ROW OF THE CURSOR.                            05010000
048700******************************************************************05020000
048800 Z400-FETCH-PO-RECEIPTS-ROW.                                      05030000
048900                                                                  05040000
049000     EXEC SQL                                                     05050000
049100         FETCH PO_RECEIPTS_CURSOR                                 05060000
049200         INTO  :RECDIS-AP-VERIFY-ITM-QTY,                         05070000
049300               :RECDIS-STR-NBR,                                   05080000
049400               :RECDIS-ORD-NBR,                                   05090000
049500               :RECDIS-ORD-LNE-NBR                                05100000
049600     END-EXEC.                                                    05110000
049700                                                                  05120000
049800     IF SQLCODE = +100                                            05130000
049900         SET PS-NO-MORE-PO-RCPT-ROWS TO TRUE                      05140000
050000     ELSE                                                         05150000
050100         IF SQLCODE NOT = 0                                       05160000
050200              MOVE 'Z400-FETCH-PO-RECEIPTS-ROW'                   05170000
050300                                       TO PV-PARAGRAPH-NAME       05180000
050400              MOVE 'FETCH ROW FROM ACTIVE PO CURSOR'              05190000
050500                                      TO PV-DB2-OPER-ATTEMPTED    05200000
050600             PERFORM Z900-SQL-ABEND                               05210000
050700         END-IF                                                   05220000
050800     END-IF.                                                      05230000
050900*                                                                 05240000
051000******************************************************************05250000
051100*    CLOSE THE CURSOR.                                            05260000
051200******************************************************************05270000
051300 Z500-CLOSE-PO-RECEIPTS-CURSOR.                                   05280000
051400                                                                  05290000
051500     PERFORM                                                      05300000
051600         WITH TEST AFTER                                          05310000
051700         VARYING PV-SQL-SUB                                       05320000
051800         FROM 1 BY 1                                              05330000
051900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       05340000
052000                   OR SQLCODE = 0)                                05350000
052100                                                                  05360000
052200         EXEC SQL                                                 05370000
052300             CLOSE PO_RECEIPTS_CURSOR                             05380000
052400         END-EXEC                                                 05390000
052500                                                                  05400000
052600         EVALUATE TRUE                                            05410000
052700             WHEN SQLCODE = -904                                  05420000
052800             WHEN SQLCODE = -911                                  05430000
052900             WHEN SQLCODE = 0                                     05440000
053000                 CONTINUE                                         05450000
053100             WHEN SQLWARN NOT = SPACES                            05460000
053200             WHEN SQLCODE NOT = ZERO                              05470000
053300                 MOVE 'Z500-CLOSE-PO-RECEIPTS-CURSOR'             05480000
053400                               TO  PV-PARAGRAPH-NAME              05490000
053500                 MOVE 'CLOSE ON CURSOR'                           05500000
053600                               TO  PV-DB2-OPER-ATTEMPTED          05510000
053700                 PERFORM Z900-SQL-ABEND                           05520000
053800         END-EVALUATE                                             05530000
053900     END-PERFORM.                                                 05540000
054000*                                                                 05550000
054100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        05560000
054200         MOVE 'Z500-CLOSE-PO-RECEIPTS-CURSOR'                     05570000
054300                               TO  PV-PARAGRAPH-NAME              05580000
054400         MOVE 'CLOSE RETRIES EXCEEDED'                            05590000
054500                               TO  PV-DB2-OPER-ATTEMPTED          05600000
054600         PERFORM Z900-SQL-ABEND                                   05610000
054700     END-IF.                                                      05620000
054800*                                                                 05630000
054900******************************************************************05640000
055000*    OPEN THE CURSOR WHICH WILL RETRIEVE STORE AND DC NUMBERS     05650000
055100*    FROM THE XMT_LOC TABLE.                                      05660014
055200******************************************************************05670000
055300 Z600-OPEN-STORE-CURSOR.                                          05680000
055400                                                                  05690000
055500     PERFORM                                                      05700000
055600         WITH TEST AFTER                                          05710000
055700         VARYING PV-SQL-SUB                                       05720000
055800         FROM 1 BY 1                                              05730000
055900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       05740000
056000                   OR SQLCODE = 0                                 05750000
056100                   OR SQLCODE = +100)                             05760000
056200                                                                  05770000
056300         EXEC SQL                                                 05780000
056400             OPEN STORE_CURSOR                                    05790000
056500         END-EXEC                                                 05800000
056600                                                                  05810000
056700         EVALUATE TRUE                                            05820000
056800             WHEN SQLCODE = -904                                  05830000
056900             WHEN SQLCODE = -911                                  05840000
057000             WHEN SQLCODE = 0                                     05850000
057100                 CONTINUE                                         05860000
057200             WHEN SQLCODE = +100                                  05870000
057300                 SET PS-NO-MORE-STORE-ROWS TO TRUE                05880000
057400             WHEN SQLWARN NOT = SPACES                            05890000
057500             WHEN SQLCODE NOT = ZERO                              05900000
057600                 MOVE 'Z600-OPEN-STORE-CURSOR'                    05910000
057700                               TO  PV-PARAGRAPH-NAME              05920000
057800                 MOVE 'OPEN ON CURSOR'                            05930000
057900                               TO  PV-DB2-OPER-ATTEMPTED          05940000
058000                 PERFORM Z900-SQL-ABEND                           05950000
058100         END-EVALUATE                                             05960000
058200     END-PERFORM.                                                 05970000
058300*                                                                 05980000
058400     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        05990000
058500         MOVE 'Z600-OPEN-STORE-CURSOR'                            06000000
058600                               TO  PV-PARAGRAPH-NAME              06010000
058700         MOVE 'OPEN RETRIES EXCEEDED'                             06020000
058800                               TO  PV-DB2-OPER-ATTEMPTED          06030000
058900         PERFORM Z900-SQL-ABEND                                   06040000
059000     END-IF.                                                      06050000
059100                                                                  06060000
059200*                                                                 06070000
059300******************************************************************06080000
059400*    FETCH THE NEXT ROW OF THE STORE CURSOR.                      06090000
059500*                                                                 06100000
059600******************************************************************06110000
059700 Z610-FETCH-STORE-CURSOR.                                         06120000
059800                                                                  06130000
059900     EXEC SQL                                                     06140000
060000         FETCH STORE_CURSOR                                       06150000
060100         INTO  :XMT00001-LOC-NBR                                  06160014
060200              ,:XMT00001-LOC-5-ABBR-NM                            06170014
060300              ,:PV-STR-DC-NBR                                     06180014
060400     END-EXEC.                                                    06250000
060500                                                                  06260000
060600     IF SQLCODE = +100                                            06270000
060700         SET PS-NO-MORE-STORE-ROWS TO TRUE                        06280000
060800     ELSE                                                         06290000
060900         IF SQLCODE NOT = 0                                       06300000
061000              MOVE 'Z610-FETCH-STORE-CURSOR'                      06310000
061100                                       TO PV-PARAGRAPH-NAME       06320000
061200              MOVE 'FETCH ROW FROM STORE CURSOR     '             06330000
061300                                      TO PV-DB2-OPER-ATTEMPTED    06340000
061400             PERFORM Z900-SQL-ABEND                               06350000
061500         END-IF                                                   06360000
061600     END-IF.                                                      06370000
061700*                                                                 06380000
061800******************************************************************06390000
061900*    CLOSE THE STORE CURSOR.                                      06400000
062000******************************************************************06410000
062100 Z620-CLOSE-STORE-CURSOR.                                         06420000
062200                                                                  06430000
062300     PERFORM                                                      06440000
062400         WITH TEST AFTER                                          06450000
062500         VARYING PV-SQL-SUB                                       06460000
062600         FROM 1 BY 1                                              06470000
062700         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       06480000
062800                   OR SQLCODE = 0)                                06490000
062900                                                                  06500000
063000         EXEC SQL                                                 06510000
063100             CLOSE STORE_CURSOR                                   06520000
063200         END-EXEC                                                 06530000
063300                                                                  06540000
063400         EVALUATE TRUE                                            06550000
063500             WHEN SQLCODE = -904                                  06560000
063600             WHEN SQLCODE = -911                                  06570000
063700             WHEN SQLCODE = 0                                     06580000
063800                 CONTINUE                                         06590000
063900             WHEN SQLWARN NOT = SPACES                            06600000
064000             WHEN SQLCODE NOT = ZERO                              06610000
064100                 MOVE 'Z620-CLOSE-STORE-CURSOR'                   06620000
064200                               TO  PV-PARAGRAPH-NAME              06630000
064300                 MOVE 'CLOSE ON CURSOR'                           06640000
064400                               TO  PV-DB2-OPER-ATTEMPTED          06650000
064500                 PERFORM Z900-SQL-ABEND                           06660000
064600         END-EVALUATE                                             06670000
064700     END-PERFORM.                                                 06680000
064800*                                                                 06690000
064900     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        06700000
065000         MOVE 'Z620-CLOSE-STORE-CURSOR'                           06710000
065100                               TO  PV-PARAGRAPH-NAME              06720000
065200         MOVE 'CLOSE RETRIES EXCEEDED'                            06730000
065300                               TO  PV-DB2-OPER-ATTEMPTED          06740000
065400         PERFORM Z900-SQL-ABEND                                   06750000
065500     END-IF.                                                      06760000
065600******************************************************************06770000
065700*  STANDARD DB2 ERROR ABEND ROUTINE                               06780000
065800*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             06790000
065900******************************************************************06800000
066000 Z900-SQL-ABEND.                                                  06810000
066100                                                                  06820000
066200     MOVE +4013                 TO ABEND-CODE.                    06830000
066300     DISPLAY '**  ABEND     **'.                                  06840000
066400     DISPLAY '**  PROGRAM   **  =  POKUT218'.                     06850000
066500     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            06860000
066600     DISPLAY '**  OPERATION **  = ' PV-DB2-OPER-ATTEMPTED.        06870000
066700                                                                  06880000
066800*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         06890000
066900*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        06900000
067000                                                                  06910000
067100     COPY DPPD004.                                                06920000
067200                                                                  06930000
067300     CALL 'ILBOABN0'  USING ABEND-CODE.                           06940000
