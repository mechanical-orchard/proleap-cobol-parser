000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.    APKUP151.                                         00020001
000300 AUTHOR.        JILL JUEL.                                        00030001
000400 DATE-WRITTEN.  DECEMBER 1998.                                    00040001
000500 DATE-COMPILED.                                                   00050001
000600***************************************************************** 00060001
001100*                  COBOL II WITH SQL                            * 00070001
000700*    ****** NOTE!! - THIS PROGRAM IS CALLED BY CICS PROGRAMS    * 00080001
001200***************************************************************** 00090001
001300**********     GET NEXT DOCUMENT NUMBER ROUTINE        ********** 00100001
001400***************************************************************** 00110001
001500*  THIS PROGRAM IS A SUB ROUTINE THAT WILL UPDATE AND GET THE   * 00120001
001600*  NEXT AVAILABLE AP DOCUMENT NUMBER.                           * 00130001
001700*  ** NOTE THERE ARE INSPECT STATEMENTS THAT USE THE NUMBER     * 00140001
001800*  ** 16 AS A CONSTANT FOR THE LENGTH OF THE DOCUMENT NUMBER.   * 00150001
001900***************************************************************** 00160001
002000*                                                               * 00170001
002100* DB2 TABLES:                                                   * 00180001
002200*  1. AP CONTROL TABLE                 (TAPCNTL)                * 00190001
002300*  2. ADJUSTMENT JOURNAL HEADER TABLE  (TADJRNL)                * 00200001
002400***************************************************************** 00210001
      * CHANGE LOG:                                                   * 00210102
      * 10/18/1999                                                    * 00210202
      *   CREATED A CICS VERSION OF DPKUP151, ADDED VENDOR NUMBER TO  * 00210402
      *   TO THE WHERE CLAUSE IN S100-SELECT-TADJRNL, AND CHANGED THE * 00210502
      *   COPYBOOK FROM APWS151 TO APWS364.                           * 00210603
      * MADE BY: JILL JUEL                            WR: 5998        * 00210702
      *                                                               * 00210802
      ***************************************************************** 00211002
002500 ENVIRONMENT DIVISION.                                            00220001
002900                                                                  00230001
003000 DATA DIVISION.                                                   00240001
003100                                                                  00250001
003400*************************                                         00260001
003500 WORKING-STORAGE SECTION.                                         00270001
003600*************************                                         00280001
003700 01  PC-PROGRAM-CONSTANTS.                                        00290001
003800     05  PC-PROGRAM-NAME         PIC X(08) VALUE 'APKUP151'.      00300001
003900     05  PC-MAX-RETRIES-DOC-NBR  PIC S9(04) VALUE +10             00310001
004000                                                COMP.             00320001
004100 01  PV-PROGRAM-VARIABLES.                                        00330001
004200     05 PV-RETRY-COUNTER         PIC S9(04)  VALUE +0             00340001
004300                                             COMP SYNC.           00350001
004400     05 PV-NEXT-DOC-NBR          PIC  9(16).                      00360001
004500     05 PV-NEW-DOC-NBR           PIC  9(16).                      00370001
004600     05 PV-CURR-DOC-NBR          PIC  9(16).                      00380001
004700     05 PV-END-SPACE-CNT         PIC S9(04)  VALUE +0             00390001
004800                                             COMP SYNC.           00400001
004900     05 PV-BEG-ZERO-CNT          PIC S9(04)  VALUE +0             00410001
005000                                             COMP SYNC.           00420001
005100                                                                  00430001
005200 01  PS-PROGRAM-SWITCHES.                                         00440001
005300     05 PS-UNIQUE-DOC-NBR-SW     PIC X(01).                       00450001
005400        88 PS-UNIQUE-DOC             VALUE 'Y'.                   00460001
005500        88 PS-NOT-UNIQUE-DOC         VALUE 'N'.                   00470001
005600                                                                  00480001
005700 01  ERROR-MESSAGES.                                              00490001
005800     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                00500001
005900             '*****   PROGRAM: APKUP151'.                         00510001
006000     05  AA-PARAGRAPH-LIT.                                        00520001
006100         10  FILLER              PIC  X(17)  VALUE                00530001
006200             '***** PARAGRAPH: '.                                 00540001
006300         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        00550001
006400     05  AA-MESSAGE-LINE.                                         00560001
006500         10  FILLER              PIC  X(06)  VALUE '*****'.       00570001
006600         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        00580001
006700     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                00590001
006800             '*****    DB2 ERROR'.                                00600001
006900     05  AA-DB2-OPERATION-LIT.                                    00610001
007000         10  FILLER              PIC  X(17)  VALUE                00620001
007100             '***** OPERATION: '.                                 00630001
007200         10  AA-DB2-OPERATION.                                    00640001
007300             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        00650001
007400             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        00660001
007500     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        00670001
007600     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        00680001
007700     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        00690001
007800 EJECT                                                            00700001
007900                                                                  00710001
008000*--------------------------------------------------------------*  00720001
008100*  DPWS004 CONTAINS THE FIELDS NECESSARY TO CALL THE SQLCA     *  00730001
008200*  MESSAGE MODULE 'DSNTIAR' AND DISPLAY THE FORMATTED RESULTS. *  00740001
008300*--------------------------------------------------------------*  00750001
008400     COPY DPWS004.                                                00760001
008500 EJECT                                                            00770001
008600                                                                  00780001
008700*--------------------------------------------------------------*  00790001
008800*  COMMUNICATIONS AREA2 FOR DB2                                *  00800001
008900*--------------------------------------------------------------*  00810001
009000*    COPY SQLCA2.                                                 00820001
009100                                                                  00830001
009200*--------------------------------------------------------------*  00840001
009300*     SQL COMMUNICATIONS AREA DCLGEN                           *  00850001
009400*--------------------------------------------------------------*  00860001
009500     EXEC SQL                                                     00870001
009600         INCLUDE SQLCA                                            00880001
009700     END-EXEC.                                                    00890001
009800 EJECT                                                            00900001
009900                                                                  00910001
010000*--------------------------------------------------------------*  00920001
010100*  AP CONTROL TABLE                                            *  00930001
010200*--------------------------------------------------------------*  00940001
010300     EXEC SQL                                                     00950001
010400          INCLUDE TAPCNTL                                         00960001
010500     END-EXEC.                                                    00970001
010600                                                                  00980001
010700*--------------------------------------------------------------*  00990001
010800*  ADJUSTMENT HEADER TABLE                                     *  01000001
010900*--------------------------------------------------------------*  01010001
011000     EXEC SQL                                                     01020001
011100          INCLUDE TADJRNL                                         01030001
011200     END-EXEC.                                                    01040001
011300 EJECT                                                            01050001
011400                                                                  01060001
011500*--------------------------------------------------------------*  01070001
011600*  THIS IS THE UPDATE CURSOR FOR GETTING THE NEXT AVAILABLE    *  01080001
011700*  DOCUMENT NUMBER.  THIS CURSOR IS NEEDED IN ORDER TO "LOCK"  *  01090001
011800*  THE ROW SO NO COLLISIONS WILL OCCUR ON THE INSERT.          *  01100001
011900*--------------------------------------------------------------*  01110001
012000     EXEC SQL                                                     01120001
012100       DECLARE UPD_CSR CURSOR FOR                                 01130001
012200         SELECT NEXT_AP_DOC_NBR                                   01140001
012300           FROM TAPCNTL                                           01150001
012400            FOR UPDATE OF NEXT_AP_DOC_NBR                         01160001
012500     END-EXEC.                                                    01170001
012600 EJECT                                                            01180001
012700                                                                  01190001
012800 LINKAGE SECTION.                                                 01200001
012900                                                                  01210001
013000     COPY APWS364.                                                01220001
013100                                                                  01230001
013200***************************************************               01240001
013300 PROCEDURE DIVISION USING WS364-DOC-NBR-PARAMETERS.               01250001
013400***************************************************               01260001
013500 A100-MAIN-ROUTINE.                                               01270001
013600                                                                  01280001
013700     PERFORM Y100-OPEN-UPD-CSR.                                   01290001
013800                                                                  01300001
013900     IF WS364-SUCCESSFUL-CALL                                     01310001
014000        PERFORM R100-FETCH-UPD-CSR                                01320001
014100                                                                  01330001
014200** INSPECT THE NEXT AP DOCUMENT NUMBER CHARACTER FIELD TO COUNT   01340001
014300** FOR SPACES THAT ARE TRAILING.                                  01350001
014400        INITIALIZE PV-END-SPACE-CNT                               01360001
014500        INSPECT APCNTL-NEXT-AP-DOC-NBR                            01370001
014600            TALLYING PV-END-SPACE-CNT FOR ALL SPACES              01380001
014700                                                                  01390001
014800** MOVE THE NEXT AP DOCUMENT NUMBER CHARACTER FIELD (SPACES       01400001
014900** EXCLUDED) TO THE NUMERIC PV-NEW-DOC-NBR FIELD FOR INCREMENTING.01410001
015000** WHILE THE DOCUMENT NUMBER WILL BE STORED ON THE DB2 TABLES AS  01420001
015100** A CHARACTER FIELD, IT WILL NEED TO BE A NUMERIC FIELD IN THIS  01430001
015200** MODULE FOR CALCULATION PURPOSES.                               01440001
015300        MOVE APCNTL-NEXT-AP-DOC-NBR (1 : 16 - PV-END-SPACE-CNT)   01450001
015400             TO PV-NEW-DOC-NBR                                    01460001
015500        SET PS-NOT-UNIQUE-DOC TO TRUE                             01470001
015600        PERFORM UNTIL PS-UNIQUE-DOC                               01480001
015700           INITIALIZE PV-BEG-ZERO-CNT                             01490001
015800           INSPECT PV-NEW-DOC-NBR                                 01500001
015900             TALLYING PV-BEG-ZERO-CNT FOR LEADING ZEROS           01510001
016000           MOVE PV-NEW-DOC-NBR TO PV-CURR-DOC-NBR                 01520001
016100           MOVE PV-NEW-DOC-NBR (PV-BEG-ZERO-CNT + 1 :             01530001
016200                                16 - PV-BEG-ZERO-CNT) TO          01540001
016300                                ADJRNL-DOC-NBR                    01550001
                 MOVE WS364-VENDOR-NBR TO ADJRNL-VND-NBR                01551001
016400           PERFORM S100-SELECT-TADJRNL                            01560001
016500           ADD +1 TO PV-NEW-DOC-NBR                               01570001
016600        END-PERFORM                                               01580001
016700     END-IF.                                                      01590001
016800                                                                  01600001
016900     MOVE ADJRNL-DOC-NBR   TO WS364-NEXT-DOC-NBR.                 01610001
017000     ADD +1 TO PV-CURR-DOC-NBR GIVING PV-NEXT-DOC-NBR.            01620001
017100** INSPECT THE NUMERIC NEXT DOCUMENT NUMBER FIELD TO COUNT FOR    01630001
017200** LEADING ZEROS.  THE LEADING ZEROS WILL NOT BE INCLUDED WHEN    01640001
017300** THE NEXT AVAILABLE DOCUMENT NUMBER IS STORED ON THE DB2 TABLES.01650001
017400     INITIALIZE PV-BEG-ZERO-CNT.                                  01660001
017500     INSPECT PV-NEXT-DOC-NBR                                      01670001
017600       TALLYING PV-BEG-ZERO-CNT FOR LEADING ZEROS.                01680001
017700     MOVE PV-NEXT-DOC-NBR (PV-BEG-ZERO-CNT + 1 :                  01690001
017800                           16 - PV-BEG-ZERO-CNT) TO               01700001
017900                              APCNTL-NEXT-AP-DOC-NBR.             01710001
018000                                                                  01720001
018100     PERFORM U100-UPDATE-TAPCNTL.                                 01730001
018200     PERFORM Y200-CLOSE-UPD-CSR.                                  01740001
018300     GOBACK.                                                      01750001
018400 EJECT                                                            01760001
018500                                                                  01770001
018600*--------------------------------------------------------------*  01780001
018700*  FETCHS THE NEXT AVAILABLE AP DOCUMENT NUMBER                *  01790001
018800*--------------------------------------------------------------*  01800001
018900 R100-FETCH-UPD-CSR.                                              01810001
019000     EXEC SQL                                                     01820001
019100         FETCH UPD_CSR                                            01830001
019200          INTO :APCNTL-NEXT-AP-DOC-NBR                            01840001
019300     END-EXEC.                                                    01850001
019400     EVALUATE TRUE                                                01860001
019500         WHEN SQLCODE = +0                                        01870001
019600             MOVE SPACES                   TO WS364-ERROR-MESSAGE 01880001
019700             SET WS364-SUCCESSFUL-CALL     TO TRUE                01890001
020000         WHEN SQLCODE = +100                                      01900001
020100             MOVE 'ERROR FETCHING UPD-CSR' TO WS364-ERROR-MESSAGE 01910001
020200             SET WS364-ERRORS-FOUND        TO TRUE                01920001
020900     END-EVALUATE.                                                01930001
021000     MOVE SQLCODE                          TO WS364-SQLCODE.      01940001
021100 EJECT                                                            01950001
021200                                                                  01960001
021300****************************************************************  01970001
021400* THIS PARAGRAPH WILL PERFORM A SELECT ON THE TADJRNL DB2      *  01980001
021500* TABLE IN ORDER TO DETERMINE IF THE NEXT AVAILABLE DOCUMENT   *  01990001
021600* NUMBER HAS ALREADY BEEN KEYED IN BY A USER.                  *  02000001
021700****************************************************************  02010001
021800 S100-SELECT-TADJRNL.                                             02020001
021900                                                                  02030001
022000     EXEC SQL                                                     02040001
022100         SELECT DOC_NBR                                           02050001
022200         INTO   :ADJRNL-DOC-NBR                                   02060001
022300         FROM   TADJRNL                                           02070001
022400         WHERE  DOC_NBR = :ADJRNL-DOC-NBR                         02080001
022400           AND  VND_NBR = :ADJRNL-VND-NBR                         02081001
022500     END-EXEC.                                                    02090001
022600                                                                  02100001
022700     EVALUATE TRUE                                                02110001
022800         WHEN SQLCODE = ZERO                                      02120001
022900         WHEN SQLCODE = -811                                      02130001
023000             SET PS-NOT-UNIQUE-DOC TO TRUE                        02140001
023100         WHEN SQLCODE = +100                                      02150001
023200             SET PS-UNIQUE-DOC TO TRUE                            02160001
023300         WHEN SQLCODE = -904                                      02170001
023400         WHEN SQLCODE = -913                                      02180001
023500         WHEN SQLWARN0 NOT = SPACES                               02190001
023600         WHEN SQLCODE < ZERO                                      02200001
023700         WHEN SQLCODE > ZERO                                      02210001
023800              MOVE 'ERROR IN S100-     '                          02220001
023900                                TO WS364-ERROR-MESSAGE            02230001
024000              SET WS364-ERRORS-FOUND                              02240001
024100                                TO TRUE                           02250001
024200              MOVE SQLCODE      TO WS364-SQLCODE                  02260001
024300     END-EVALUATE.                                                02270001
024400                                                                  02280001
024500*--------------------------------------------------------------*  02290001
024600*  UPDATES THE DOC NBR ON TAPCNTL TABLE                        *  02300001
024700*--------------------------------------------------------------*  02310001
024800 U100-UPDATE-TAPCNTL.                                             02320001
024900     EXEC SQL                                                     02330001
025000         UPDATE TAPCNTL                                           02340001
025100         SET NEXT_AP_DOC_NBR = :APCNTL-NEXT-AP-DOC-NBR            02350001
025200         WHERE NEXT_AP_DOC_NBR > ' '                              02360001
025300     END-EXEC.                                                    02370001
025400     EVALUATE TRUE                                                02380001
025500         WHEN SQLCODE = +0                                        02390001
025600             MOVE SPACES                 TO WS364-ERROR-MESSAGE   02400001
025700             SET WS364-SUCCESSFUL-CALL   TO TRUE                  02410001
025800         WHEN SQLCODE = -904                                      02420001
025900         WHEN SQLCODE = -913                                      02430001
026000             CONTINUE                                             02440001
026100         WHEN SQLWARN0 NOT = SPACES                               02450001
026200         WHEN SQLCODE < +0                                        02460001
026300         WHEN SQLCODE > +0                                        02470001
026400             MOVE 'ERROR UPDATE TAPCNTL' TO WS364-ERROR-MESSAGE   02480001
026500             SET WS364-ERRORS-FOUND      TO TRUE                  02490001
027200     END-EVALUATE.                                                02500001
027300     MOVE SQLCODE                        TO WS364-SQLCODE.        02510001
027400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES-DOC-NBR                02520001
027500         MOVE ZERO                       TO WS364-SQLCODE         02530001
027600         MOVE 'TAPCNTL TABLE BUSY'       TO WS364-ERROR-MESSAGE   02540001
027700         SET WS364-ERRORS-FOUND          TO TRUE                  02550001
028500     END-IF.                                                      02560001
028600 EJECT                                                            02570001
028700                                                                  02580001
028800*--------------------------------------------------------------*  02590001
028900*  OPENS THE UPDATE CURSOR                                     *  02600001
029000*--------------------------------------------------------------*  02610001
029100 Y100-OPEN-UPD-CSR.                                               02620001
029200     PERFORM                                                      02630001
029300        WITH TEST AFTER                                           02640001
029400          VARYING PV-RETRY-COUNTER                                02650001
029500             FROM 1 BY 1                                          02660001
029600            UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES-DOC-NBR)    02670001
029700                   OR (SQLCODE = ZERO))                           02680001
029800                                                                  02690001
029900          EXEC SQL                                                02700001
030000              OPEN UPD_CSR                                        02710001
030100          END-EXEC                                                02720001
030200          EVALUATE TRUE                                           02730001
030300              WHEN SQLCODE = ZERO                                 02740001
030400                  SET WS364-SUCCESSFUL-CALL TO TRUE               02750001
030500              WHEN SQLCODE NOT ZERO                               02760001
030600                  MOVE 'ERROR OPENING UPD-CSR'                    02770001
030700                                           TO WS364-ERROR-MESSAGE 02780001
030800                  SET WS364-ERRORS-FOUND   TO TRUE                02790001
031500          END-EVALUATE                                            02800001
031600     END-PERFORM.                                                 02810001
031700     MOVE SQLCODE                          TO WS364-SQLCODE.      02820001
031800 EJECT                                                            02830001
031900                                                                  02840001
032000*--------------------------------------------------------------*  02850001
032100*  CLOSES THE UPDATE CURSOR                                    *  02860001
032200*--------------------------------------------------------------*  02870001
032300 Y200-CLOSE-UPD-CSR.                                              02880001
032400     EXEC SQL                                                     02890001
032500          CLOSE UPD_CSR                                           02900001
032600     END-EXEC.                                                    02910001
032700     EVALUATE TRUE                                                02920001
032800         WHEN SQLCODE = ZERO                                      02930001
032900             SET WS364-SUCCESSFUL-CALL     TO TRUE                02940001
033000         WHEN OTHER                                               02950001
033100             MOVE 'ERROR OPENING UPD-CSR'  TO WS364-ERROR-MESSAGE 02960001
033200             SET WS364-ERRORS-FOUND        TO TRUE                02970001
033900     END-EVALUATE.                                                02980001
034000     MOVE SQLCODE                          TO WS364-SQLCODE.      02990001
034100 EJECT                                                            03000001
034200                                                                  03010001
035800 EJECT                                                            03020001
