000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.   RCKUP070.                                          00040001
000500 AUTHOR.       DAN HINTZ.                                         00050001
000600 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060001
000700 DATE-WRITTEN. DECEMBER 2014.                                     00070001
000800 DATE-COMPILED.                                                   00080001
000900******************************************************************00090001
001000*        LOAD TRANSACTION REPOSITORY PURGE CLEANUP PROGRAM        00100001
001100*                                                                 00110001
001200* THIS PROGRAM READS THE "ORPHANED" ROWS FROM THE WFT_LOD_XFER    00120001
001300* TABLE AND PURGES THESE ROWS.  THESE ARE ROWS THAT DO NOT HAVE   00130001
001400* A CORRESPONDING ROW IN THE WFT_LOD_CNTL TABLE.                  00140001
001500*                                                                 00150001
001501******************************************************************00150101
001510* 9/2020 GERMAN BANDA - RENAMED WFKUP018 TO RCKUP070 AS PART OF   00151001
001520*                       OF WF APPLICATION RETIREMENT              00152001
001600******************************************************************00160001
001700 ENVIRONMENT DIVISION.                                            00170001
001800******************************************************************00180001
001900 CONFIGURATION SECTION.                                           00190001
002000 SOURCE-COMPUTER.        IBM-3090.                                00200001
002100 OBJECT-COMPUTER.        IBM-3090.                                00210001
002200                                                                  00220001
002300 INPUT-OUTPUT SECTION.                                            00230001
002400 FILE-CONTROL.                                                    00240001
002500                                                                  00250001
002600******************************************************************00260001
002700 DATA DIVISION.                                                   00270001
002800******************************************************************00280001
002900 FILE SECTION.                                                    00290001
003000                                                                  00300001
003100 WORKING-STORAGE SECTION.                                         00310001
003200 01  PS-PROGRAM-SWITCHES.                                         00320001
003300     05  PS-END-OF-XFER-CSR-SW       PIC X(01) VALUE 'N'.         00330001
003400         88  PS-END-OF-XFER-CSR-YES            VALUE 'Y'.         00340001
003500         88  PS-END-OF-XFER-CSR-NO             VALUE 'N'.         00350001
003600     05  PS-FIRST-TRN-TYP-SW         PIC X(01) VALUE 'Y'.         00360001
003700         88  PS-FIRST-TRN-TYP-YES              VALUE 'Y'.         00370001
003800         88  PS-FIRST-TRN-TYP-NO               VALUE 'N'.         00380001
003900     05  PS-FIRST-TIME-SW            PIC X(01) VALUE 'Y'.         00390001
004000         88  PS-FIRST-TIME-YES                 VALUE 'Y'.         00400001
004100         88  PS-FIRST-TIME-NO                  VALUE 'N'.         00410001
004200                                                                  00420001
004300 01  PC-PROGRAM-CONSTANTS.                                        00430001
004400     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'RCKUP070'.  00440001
004500     05  PC-MAX-TABLE-ENTRIES        PIC S9(3) VALUE +15 COMP-3.  00450001
004600     05  PC-ONE                      PIC S9(1) VALUE +1  COMP-3.  00460001
004700                                                                  00470001
004800 01  PA-PROGRAM-ACCUMULATORS.                                     00480001
004900     05  PA-TOTALS.                                               00490001
005000         10  PA-TOTAL-XFER-READ      PIC S9(7) VALUE +0 COMP-3.   00500001
005100         10  PA-TOTAL-XFER-DELETED   PIC S9(7) VALUE +0 COMP-3.   00510001
005200                                                                  00520001
005300 01  PV-PROGRAM-VARIABLES.                                        00530001
005400     05  PV-DISPLAY-RECORD           PIC Z,ZZZ,ZZ9-.              00540001
005500     05  PV-DB2-COUNT                PIC S9(9) VALUE +0 COMP-3.   00550001
005600                                                                  00560001
005700     05  PV-COMMIT-TMST              PIC X(26) VALUE SPACE.       00570001
005800     05  PV-CURRENT-TMST             PIC X(26) VALUE SPACE.       00580001
005900     05  PV-CURRENT-TRN-TYP-CDE      PIC X(06) VALUE SPACE.       00590001
006000     05  PV-PREVIOUS-TRN-TYP-CDE     PIC X(06) VALUE SPACE.       00600001
006100     05  PV-SUB                      PIC S9(3) VALUE +0 COMP-3.   00610001
006200     05  PV-NBR-TABLE-ENTRIES        PIC S9(3) VALUE +0 COMP-3.   00620001
006300                                                                  00630001
006400 01  PV-ABEND-VARIABLES.                                          00640001
006500     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.00650001
006600     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP.     00660001
006700     05  PV-SQLCODE                  PIC S9(9).                   00670001
006800     05  PV-DISPLAY-SQLCODE          PIC -------999.              00680001
006900     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'RCKUP070'.  00690001
007000     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      00700001
007100     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      00710001
007200     05  PV-ABEND-TABLE-NAME         PIC X(12) VALUE SPACES.      00720001
007300     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      00730001
007400                                                                  00740001
007500 01  PV-TRN-TYP-CDE-TABLE.                                        00750001
007600     05  PV-TRN-TYP-CDE-ENTRIES      OCCURS 15 TIMES.             00760001
007700         10 PV-TRN-TYP-CDE           PIC X(06) VALUE SPACES.      00770001
007800         10 PV-TRN-TYP-QTY           PIC S9(5) VALUE +0 COMP-3.   00780001
007900                                                                  00790001
008000******************************************************************00800001
008100*  DB2 FORMATTED MESSAGE AREA                                     00810001
008200******************************************************************00820001
008300     COPY DPWS004.                                                00830001
008400                                                                  00840001
008500******************************************************************00850001
008600*  COMMUNICATIONS AREA FOR DB2                                    00860001
008700******************************************************************00870001
008800     EXEC SQL                                                     00880001
008900         INCLUDE SQLCA                                            00890001
009000     END-EXEC.                                                    00900001
009100                                                                  00910001
009200******************************************************************00920001
009300*  DB2 TABLE DECLARATION - E-FULFILLMENT LOAD CONTROL             00930001
009400*      TABLE (WFT_LOD_CNTL)                                       00940001
009500******************************************************************00950001
009600     EXEC SQL                                                     00960001
009700         INCLUDE WFT00001                                         00970001
009800     END-EXEC.                                                    00980001
009900                                                                  00990001
010000******************************************************************01000001
010100*  DB2 TABLE DECLARATION - E-FULFILLMENT LOAD TRANSACTIONS        01010001
010200*      TABLE (WFT_LOD_XFER)                                       01020001
010300******************************************************************01030001
010400     EXEC SQL                                                     01040001
010500         INCLUDE WFT00002                                         01050001
010600     END-EXEC.                                                    01060001
010700                                                                  01070001
010800******************************************************************01080001
010900* COBOL CURSOR DECLARATION TO READ E-FULFILLMENT LOAD TRANSACTION*01090001
011000******************************************************************01100001
011100     EXEC SQL                                                     01110001
011200       DECLARE XFER-CSR CURSOR WITH HOLD FOR                      01120001
011300        SELECT A.PRC_CNTL_TMST                                    01130001
011400             , A.TRN_TYP_CDE                                      01140001
011500             , A.BTCH_LOD_SEQ_ID                                  01150001
011600             , A.LOD_DAT_TXT                                      01160001
011700          FROM WFT_LOD_XFER A                                     01170001
011800         WHERE NOT EXISTS                                         01180001
011900              (SELECT B.PRC_CNTL_TMST                             01190001
012000                 FROM WFT_LOD_CNTL B                              01200001
012100                WHERE B.PRC_CNTL_TMST = A.PRC_CNTL_TMST)          01210001
012200      ORDER BY A.TRN_TYP_CDE                                      01220001
012300     END-EXEC.                                                    01230001
012400                                                                  01240001
012500                                                                  01250001
012600******************************************************************01260001
012700 LINKAGE SECTION.                                                 01270001
012800******************************************************************01280001
012900                                                                  01290001
013000                                                                  01300001
013100******************************************************************01310001
013200 PROCEDURE DIVISION.                                              01320001
013300******************************************************************01330001
013400 0000-PROGRAM-MAINLINE.                                           01340001
013500     DISPLAY '************ START OF RCKUP070 ***************'     01350001
013600                                                                  01360001
013700*INIT COUNTERS.                                                   01370001
013800     INITIALIZE PA-TOTAL-XFER-READ                                01380001
013900                PA-TOTAL-XFER-DELETED.                            01390001
014000                                                                  01400001
014100*PROCESS ORPHANED TRANSACTIONS.                                   01410001
014200     PERFORM 2000-PROCESS-ORPHANED-ROWS.                          01420001
014300                                                                  01430001
014400*EOJ ROUTINE.                                                     01440001
014500     PERFORM 9000-EOJ-ROUTINE.                                    01450001
014600                                                                  01460001
014700*STOP                                                             01470001
014800     DISPLAY ' '.                                                 01480001
014900     DISPLAY '************  END OF RCKUP070  ***************'     01490001
015000     STOP RUN.                                                    01500001
015100                                                                  01510001
015200                                                                  01520001
015300******************************************************************01530001
015400*  FETCH THE CURRENT TIMESTAMP                                    01540001
015500******************************************************************01550001
015600 1100-FETCH-CURRENT-TIMESTAMP.                                    01560001
015700                                                                  01570001
015800     EXEC SQL                                                     01580001
015900         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01590001
016000     END-EXEC.                                                    01600001
016100                                                                  01610001
016200     EVALUATE TRUE                                                01620001
016300       WHEN SQLCODE = ZERO                                        01630001
016400           CONTINUE                                               01640001
016500                                                                  01650001
016600       WHEN OTHER                                                 01660001
016700           MOVE '1100-FETCH-CURRENT-TIMESTAMP'                    01670001
016800                                      TO PV-ABEND-PARAGRAPH       01680001
016900           MOVE 'GET DB2 TMST'        TO PV-ABEND-OPERATION       01690001
017000           PERFORM 9900-DB2-ABEND                                 01700001
017100     END-EVALUATE.                                                01710001
017200                                                                  01720001
017300                                                                  01730001
017400******************************************************************01740001
017500*  FETCH THE TIMESTAMP THAT WILL BE USED TO DETERMINE WHEN A      01750001
017600*  COMMIT IS TAKEN.  WE WILL BE TAKING A COMMIT EVERY SECOND,     01760001
017700*  BASED ON THE HARD-CODED VALUE WE ARE USING.                    01770001
017800******************************************************************01780001
017900 1200-FETCH-COMMIT-TIMESTAMP.                                     01790001
018000                                                                  01800001
018100     EXEC SQL                                                     01810001
018200         SET :PV-COMMIT-TMST = CURRENT TIMESTAMP +                01820001
018300                               :PC-ONE SECONDS                    01830001
018400     END-EXEC.                                                    01840001
018500                                                                  01850001
018600     EVALUATE TRUE                                                01860001
018700       WHEN SQLCODE = ZERO                                        01870001
018800           CONTINUE                                               01880001
018900                                                                  01890001
019000       WHEN OTHER                                                 01900001
019100           MOVE '1200-FETCH-COMMIT-TIMESTAMP'                     01910001
019200                                      TO PV-ABEND-PARAGRAPH       01920001
019300           MOVE 'FETCH COMMIT TMST'   TO PV-ABEND-OPERATION       01930001
019400           PERFORM 9900-DB2-ABEND                                 01940001
019500     END-EVALUATE.                                                01950001
019600                                                                  01960001
019700                                                                  01970001
019800******************************************************************01980001
019900*                                                                *01990001
020000*      P R O C E S S   O R P H A N E D   R E C O R D S           *02000001
020100*                                                                *02010001
020200******************************************************************02020001
020300 2000-PROCESS-ORPHANED-ROWS.                                      02030001
020400                                                                  02040001
020500     PERFORM 2100-OPEN-XFER-CURSOR.                               02050001
020600                                                                  02060001
020700     PERFORM 2200-FETCH-XFER-CURSOR.                              02070001
020800                                                                  02080001
020900     IF PS-END-OF-XFER-CSR-YES                                    02090001
021000         DISPLAY ' '                                              02100001
021100         DISPLAY '*************************************'          02110001
021200         DISPLAY '**    NO ORPHANED ROWS FOUND ON    **'          02120001
021300         DISPLAY '**          WFT_LOD_XFER           **'          02130001
021400         DISPLAY '*************************************'          02140001
021500         DISPLAY ' '                                              02150001
021600     END-IF.                                                      02160001
021700                                                                  02170001
021800*PROCESS COMPLETED TRANSACTIONS.                                  02180001
021900     PERFORM                                                      02190001
022000       UNTIL PS-END-OF-XFER-CSR-YES                               02200001
022100                                                                  02210001
022200*INCREMENT COUNTER OF CNTL RECORDS READ.                          02220001
022300         ADD +1 TO PA-TOTAL-XFER-READ                             02230001
022400                                                                  02240001
022500*DELETE THE ROW FROM THE WFT_LOD_XFER TABLE.                      02250001
022600         PERFORM 2400-DELETE-XFER                                 02260001
022700                                                                  02270001
022800*COMMIT THE DATA.                                                 02280001
022900         IF  PS-FIRST-TIME-YES                                    02290001
023000             SET PS-FIRST-TIME-NO TO TRUE                         02300001
023100             PERFORM 1100-FETCH-CURRENT-TIMESTAMP                 02310001
023200             DISPLAY ' CURRENT TIMESTAMP       = '                02320001
023300                     PV-CURRENT-TMST                              02330001
023400             PERFORM 1200-FETCH-COMMIT-TIMESTAMP                  02340001
023500         ELSE                                                     02350001
023600             PERFORM 1100-FETCH-CURRENT-TIMESTAMP                 02360001
023700         END-IF                                                   02370001
023800                                                                  02380001
023900         IF  PV-CURRENT-TMST > PV-COMMIT-TMST                     02390001
024000             PERFORM 2800-COMMIT                                  02400001
024100             PERFORM 1200-FETCH-COMMIT-TIMESTAMP                  02410001
024200         END-IF                                                   02420001
024300                                                                  02430001
024400*INCREMENT COUNTER OF ROWS DELETED.  WE ARE SUMMARIZING THE ROWS  02440001
024500*DELETED BY UNIQUE TRANSACTION TYPE CODE.                         02450001
024600         IF  PS-FIRST-TRN-TYP-YES                                 02460001
024700             SET PS-FIRST-TRN-TYP-NO                              02470001
024800                                 TO TRUE                          02480001
024900             MOVE 1              TO PV-SUB                        02490001
025000                                    PV-NBR-TABLE-ENTRIES          02500001
025100             MOVE WFT00002-TRN-TYP-CDE                            02510001
025200                                 TO PV-CURRENT-TRN-TYP-CDE        02520001
025300                                    PV-PREVIOUS-TRN-TYP-CDE       02530001
025400                                    PV-TRN-TYP-CDE(PV-SUB)        02540001
025500         ELSE                                                     02550001
025600             MOVE WFT00002-TRN-TYP-CDE                            02560001
025700                                 TO PV-CURRENT-TRN-TYP-CDE        02570001
025800         END-IF                                                   02580001
025900                                                                  02590001
026000         IF  PV-CURRENT-TRN-TYP-CDE = PV-PREVIOUS-TRN-TYP-CDE     02600001
026100             IF  PV-SUB <= PC-MAX-TABLE-ENTRIES                   02610001
026200                 ADD 1           TO PV-TRN-TYP-QTY(PV-SUB)        02620001
026300             END-IF                                               02630001
026400         ELSE                                                     02640001
026500             MOVE WFT00002-TRN-TYP-CDE                            02650001
026600                                 TO PV-PREVIOUS-TRN-TYP-CDE       02660001
026700             ADD 1               TO PV-SUB                        02670001
026800                                    PV-NBR-TABLE-ENTRIES          02680001
026900             IF  PV-SUB > PC-MAX-TABLE-ENTRIES                    02690001
027000                 DISPLAY '** PV-SUB = ' PV-SUB                    02700001
027100                         ' TOO MANY ENTRIES - PLEASE EXPAND TABLE'02710001
027200                 DISPLAY '** ' WFT00002-TRN-TYP-CDE ' TOTALS NOT '02720001
027300                         'INCLUDED'                               02730001
027400             ELSE                                                 02740001
027500                 MOVE WFT00002-TRN-TYP-CDE                        02750001
027600                                 TO PV-TRN-TYP-CDE(PV-SUB)        02760001
027700                 MOVE 1          TO PV-TRN-TYP-QTY(PV-SUB)        02770001
027800             END-IF                                               02780001
027900         END-IF                                                   02790001
028000                                                                  02800001
028100*GET NEXT 'ORPHANED' RECORD.                                      02810001
028200         PERFORM 2200-FETCH-XFER-CURSOR                           02820001
028300                                                                  02830001
028400     END-PERFORM.                                                 02840001
028500                                                                  02850001
028600*CLOSE THE 'XFER' CURSOR.                                         02860001
028700     PERFORM 2500-CLOSE-XFER-CURSOR.                              02870001
028800                                                                  02880001
028900******************************************************************02890001
029000 2100-OPEN-XFER-CURSOR.                                           02900001
029100                                                                  02910001
029200     EXEC SQL                                                     02920001
029300         OPEN XFER-CSR                                            02930001
029400     END-EXEC.                                                    02940001
029500                                                                  02950001
029600     EVALUATE TRUE                                                02960001
029700       WHEN SQLCODE = ZERO                                        02970001
029800           SET PS-END-OF-XFER-CSR-NO TO TRUE                      02980001
029900                                                                  02990001
030000       WHEN OTHER                                                 03000001
030100           MOVE '2100-OPEN-XFER-CURSOR'                           03010001
030200                                     TO PV-ABEND-PARAGRAPH        03020001
030300           MOVE 'OPEN XFER-CSR '     TO PV-ABEND-OPERATION        03030001
030400           MOVE 'WFT_LOD_XFER'       TO PV-ABEND-TABLE-NAME       03040001
030500           PERFORM 9900-DB2-ABEND                                 03050001
030600     END-EVALUATE.                                                03060001
030700                                                                  03070001
030800******************************************************************03080001
030900 2200-FETCH-XFER-CURSOR.                                          03090001
031000                                                                  03100001
031100     EXEC SQL                                                     03110001
031200         FETCH XFER-CSR                                           03120001
031300          INTO :WFT00002-PRC-CNTL-TMST                            03130001
031400             , :WFT00002-TRN-TYP-CDE                              03140001
031500             , :WFT00002-BTCH-LOD-SEQ-ID                          03150001
031600             , :WFT00002-LOD-DAT-TXT                              03160001
031700     END-EXEC.                                                    03170001
031800                                                                  03180001
031900     EVALUATE TRUE                                                03190001
032000       WHEN SQLCODE = +100                                        03200001
032100           SET PS-END-OF-XFER-CSR-YES TO TRUE                     03210001
032200                                                                  03220001
032300       WHEN SQLCODE = ZERO                                        03230001
032400           CONTINUE                                               03240001
032500                                                                  03250001
032600       WHEN OTHER                                                 03260001
032700           MOVE '2200-FETCH-XFER-CURSOR'                          03270001
032800                                  TO PV-ABEND-PARAGRAPH           03280001
032900           MOVE 'FETCH XFER-CSR ' TO PV-ABEND-OPERATION           03290001
033000           MOVE 'WFT_LOD_XFER'    TO PV-ABEND-TABLE-NAME          03300001
033100           PERFORM 9900-DB2-ABEND                                 03310001
033200     END-EVALUATE.                                                03320001
033300                                                                  03330001
033400******************************************************************03340001
033500 2400-DELETE-XFER.                                                03350001
033600                                                                  03360001
033700     EXEC SQL                                                     03370001
033800         DELETE FROM WFT_LOD_XFER                                 03380001
033900          WHERE PRC_CNTL_TMST   = :WFT00002-PRC-CNTL-TMST         03390001
034000            AND TRN_TYP_CDE     = :WFT00002-TRN-TYP-CDE           03400001
034100            AND BTCH_LOD_SEQ_ID = :WFT00002-BTCH-LOD-SEQ-ID       03410001
034200            AND LOD_DAT_TXT     = :WFT00002-LOD-DAT-TXT           03420001
034300     END-EXEC.                                                    03430001
034400                                                                  03440001
034500     EVALUATE TRUE                                                03450001
034600       WHEN SQLCODE = ZERO                                        03460001
034700           ADD +1 TO PA-TOTAL-XFER-DELETED                        03470001
034800                                                                  03480001
034900       WHEN OTHER                                                 03490001
035000           MOVE '2400-DELETE-XFER'    TO PV-ABEND-PARAGRAPH       03500001
035100           MOVE 'DELETE WFT_LOD_XFER' TO PV-ABEND-OPERATION       03510001
035200           MOVE 'WFT_LOD_XFER'        TO PV-ABEND-TABLE-NAME      03520001
035300           PERFORM 9900-DB2-ABEND                                 03530001
035400     END-EVALUATE.                                                03540001
035500                                                                  03550001
035600******************************************************************03560001
035700 2500-CLOSE-XFER-CURSOR.                                          03570001
035800                                                                  03580001
035900     EXEC SQL                                                     03590001
036000         CLOSE XFER-CSR                                           03600001
036100     END-EXEC.                                                    03610001
036200                                                                  03620001
036300     EVALUATE TRUE                                                03630001
036400       WHEN SQLCODE = ZERO                                        03640001
036500           CONTINUE                                               03650001
036600                                                                  03660001
036700       WHEN OTHER                                                 03670001
036800           MOVE '2500-CLOSE-XFER-CURSOR'                          03680001
036900                                  TO PV-ABEND-PARAGRAPH           03690001
037000           MOVE 'CLOSE XFER-CSR ' TO PV-ABEND-OPERATION           03700001
037100           MOVE 'WFT_LOD_XFER'    TO PV-ABEND-TABLE-NAME          03710001
037200           PERFORM 9900-DB2-ABEND                                 03720001
037300     END-EVALUATE.                                                03730001
037400                                                                  03740001
037500******************************************************************03750001
037600 2800-COMMIT.                                                     03760001
037700                                                                  03770001
037800     EXEC SQL                                                     03780001
037900         COMMIT                                                   03790001
038000     END-EXEC.                                                    03800001
038100                                                                  03810001
038200     EVALUATE TRUE                                                03820001
038300       WHEN SQLCODE = ZERO                                        03830001
038400           DISPLAY '** COMMIT TAKEN AT '                          03840001
038500                   PV-CURRENT-TMST                                03850001
038600                                                                  03860001
038700       WHEN OTHER                                                 03870001
038800           MOVE '2800-COMMIT'        TO PV-ABEND-PARAGRAPH        03880001
038900           MOVE 'COMMIT LOAD TABLES' TO PV-ABEND-OPERATION        03890001
039000           PERFORM 9900-DB2-ABEND                                 03900001
039100     END-EVALUATE.                                                03910001
039200                                                                  03920001
039300******************************************************************03930001
039400*                                                                *03940001
039500*                   E O J   P R O C E S S I N G                  *03950001
039600*                                                                *03960001
039700******************************************************************03970001
039800 9000-EOJ-ROUTINE.                                                03980001
039900                                                                  03990001
040000     DISPLAY ' '.                                                 04000001
040100     DISPLAY '*******************************************'.       04010001
040200     DISPLAY '      * RCKUP070 SUMMARY STATISTICS *      '.       04020001
040300     DISPLAY ' '.                                                 04030001
040400     DISPLAY '      -------------------------------      '.       04040001
040500     DISPLAY '       LOAD REPOSITORY PURGE RESULTS       '.       04050001
040600     DISPLAY '      -------------------------------      '.       04060001
040700     MOVE PA-TOTAL-XFER-READ              TO PV-DISPLAY-RECORD.   04070001
040800     DISPLAY ' WFT_LOD_XFER READ       = '                        04080001
040900                                             PV-DISPLAY-RECORD.   04090001
041000     MOVE PA-TOTAL-XFER-DELETED           TO PV-DISPLAY-RECORD.   04100001
041100     DISPLAY ' WFT_LOD_XFER DELETED    = '                        04110001
041200                                             PV-DISPLAY-RECORD.   04120001
041300     PERFORM                                                      04130001
041400       VARYING PV-SUB FROM 1 BY 1                                 04140001
041500       UNTIL PV-SUB > PV-NBR-TABLE-ENTRIES                        04150001
041600          OR PV-SUB > PC-MAX-TABLE-ENTRIES                        04160001
041700         MOVE PV-TRN-TYP-QTY(PV-SUB)      TO PV-DISPLAY-RECORD    04170001
041800         DISPLAY ' ' PV-TRN-TYP-CDE(PV-SUB) ' ROWS DELETED     = '04180001
041900                 PV-DISPLAY-RECORD                                04190001
042000     END-PERFORM.                                                 04200001
042100                                                                  04210001
042200     IF  PV-NBR-TABLE-ENTRIES > PC-MAX-TABLE-ENTRIES              04220001
042300         DISPLAY ' TOO MANY ROWS IN TOTALS TABLE...MISSING TOTALS'04230001
042400     END-IF.                                                      04240001
042500                                                                  04250001
042600     DISPLAY '*******************************************'.       04260001
042700                                                                  04270001
042800******************************************************************04280001
042900* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      04290001
043000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 04300001
043100******************************************************************04310001
043200 9900-DB2-ABEND.                                                  04320001
043300                                                                  04330001
043400     MOVE SQLCODE    TO PV-SQLCODE.                               04340001
043500     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       04350001
043600     DISPLAY '*** DB2 ERROR ***'.                                 04360001
043700     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               04370001
043800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 04380001
043900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               04390001
044000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               04400001
044100     DISPLAY '*** TABLE     = ' PV-ABEND-TABLE-NAME.              04410001
044200                                                                  04420001
044300******************************************************************04430001
044400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04440001
044500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04450001
044600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04460001
044700* FORMAT.                                                         04470001
044800******************************************************************04480001
044900     COPY DPPD004.                                                04490001
045000                                                                  04500001
045100     IF SQLCODE NOT = -911                                        04510001
045200         EXEC SQL                                                 04520001
045300             ROLLBACK                                             04530001
045400         END-EXEC                                                 04540001
045500     END-IF.                                                      04550001
045600                                                                  04560001
045700     MOVE +4013         TO PV-ABEND-CODE.                         04570001
045800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         04580001
045900******************************************************************04590001
046000******************************************************************04600001
