000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      EPKUT081.                                       00030029
000400 AUTHOR.          STEVEN NOWAK.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    04/20/10.                                       00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*                PRICE CHECKER EXTRACT PROGRAM                    00090000
001000*=================================================================00100000
001100* THIS PROGRAM WILL READ MESSAGES OFF OF A PRICE CHECK QUEUE AND  00110000
001200* WRITE THE INFORMATION TO AN OUTPUT FILE TO BE USED TO UPDATE    00120000
001300* THE EPT_CUST_MDSE_SCNR TABLE IN EPKUP060.                       00130000
001400*                                                                 00140000
001500*========================== CHANGE LOG ===========================00150000
001600*  AUTH        BY        DATE                 DESCRIPTION         00160000
001700*=================================================================00170000
001800* WR37120    S. NOWAK    04-20-10   CREATE PROGRAM                00180000
001900*                                                                 00190000
IN2431* INC1850802 COGNIZANT   09-23-11   INCLUDED BAD FILE TO WRITE THE00200000
IN2431*                                   BAD DATAS AND SKIP TO READ THE00210000
IN2431*                                   NEXT RECORD FROM QUEUE.       00220000
IN2431*                                   CODE CHANGES ARE TAGGED WITH  00230000
IN2431*                                   IN2431.                       00240000
002000******************************************************************00250000
002100                                                                  00260000
002200 ENVIRONMENT DIVISION.                                            00270000
002300 CONFIGURATION SECTION.                                           00280000
002400                                                                  00290000
002500 SOURCE-COMPUTER.        IBM-3090.                                00300000
002600 OBJECT-COMPUTER.        IBM-3090.                                00310000
002700                                                                  00320000
002800 INPUT-OUTPUT SECTION.                                            00330000
002900 FILE-CONTROL.                                                    00340000
003000                                                                  00350000
003100     SELECT CNTL-CARD-1 ASSIGN TO INP01.                          00360000
003200     SELECT CNTL-CARD-2 ASSIGN TO INP02.                          00370000
003300                                                                  00380000
003400     SELECT BKUP-FILE   ASSIGN TO OUT01.                          00390000
003500     SELECT UPDT-FILE   ASSIGN TO OUT02.                          00400000
IN2431     SELECT BAD-FILE    ASSIGN TO OUT03.                          00410000
003600                                                                  00420000
003700 DATA DIVISION.                                                   00430000
003800 FILE SECTION.                                                    00440000
003900                                                                  00450000
004000 FD  CNTL-CARD-1                                                  00460000
004100     RECORDING MODE F                                             00470000
004200     BLOCK CONTAINS 0 RECORDS                                     00480000
004300     LABEL RECORDS ARE OMITTED.                                   00490000
004400                                                                  00500000
004500 01  CARD-1-REC                    PIC  X(80).                    00510000
004600                                                                  00520000
004700 FD  CNTL-CARD-2                                                  00530000
004800     RECORDING MODE F                                             00540000
004900     BLOCK CONTAINS 0 RECORDS                                     00550000
005000     LABEL RECORDS ARE OMITTED.                                   00560000
005100                                                                  00570000
005200 01  CARD-2-REC                    PIC  X(80).                    00580000
005300                                                                  00590000
005400 FD  BKUP-FILE                                                    00600000
005500     RECORDING MODE IS F                                          00610000
005600     BLOCK CONTAINS 0  RECORDS                                    00620000
005700     LABEL RECORDS ARE STANDARD                                   00630000
005800     RECORD CONTAINS 100 CHARACTERS                               00640000
005900     DATA RECORD IS BKUP-REC.                                     00650000
006000                                                                  00660000
006100 01  BKUP-REC                      PIC  X(100).                   00670000
IN2431 FD  BAD-FILE                                                     00680000
IN2431     RECORDING MODE IS F                                          00690000
IN2431     BLOCK CONTAINS 0  RECORDS                                    00700000
IN2431     LABEL RECORDS ARE STANDARD                                   00710000
IN2431     RECORD CONTAINS 100 CHARACTERS                               00720000
IN2431     DATA RECORD IS BAD-REC.                                      00730000
IN2431                                                                  00740000
IN2431 01  BAD-REC                       PIC  X(100).                   00750000
006200                                                                  00760000
006300 FD  UPDT-FILE                                                    00770000
006400     RECORDING MODE IS F                                          00780000
006500     BLOCK CONTAINS 0  RECORDS                                    00790000
006600     LABEL RECORDS ARE STANDARD                                   00800000
006700     RECORD CONTAINS 63 CHARACTERS                                00810000
006800     DATA RECORD IS UPDT-REC.                                     00820000
006900                                                                  00830000
007000 01  UPDT-REC                      PIC  X(63).                    00840000
007100                                                                  00850000
007200******************************************************************00860000
007300*                       WORKING STORAGE                           00870000
007400******************************************************************00880000
007500 WORKING-STORAGE SECTION.                                         00890000
007600                                                                  00900000
007700 01  W-START                       PIC  X(40)                     00910000
007800     VALUE 'EPKUT081 - WORKING STORAGE BEGINS HERE'.              00920000
007900                                                                  00930000
008000******************************************************************00940000
008100*                         SWITCHES                                00950000
008200******************************************************************00960000
008300 01  PS-PGM-SWITCHES.                                             00970000
008400     05  PS-CNTL-CARD-1-SW         PIC  X(01) VALUE 'N'.          00980000
008500         88  PS-CNTL-CARD-1-END               VALUE 'Y'.          00990000
008600         88  PS-CNTL-CARD-1-START             VALUE 'N'.          01000000
008700     05  PS-CNTL-CARD-2-SW         PIC  X(01) VALUE 'N'.          01010000
008800         88  PS-CNTL-CARD-2-END               VALUE 'Y'.          01020000
008900         88  PS-CNTL-CARD-2-START             VALUE 'N'.          01030000
009000                                                                  01040000
009100     05  PS-MORE-MESSAGES          PIC  X(01) VALUE 'Y'.          01050000
009200         88  PS-MORE-MSG                      VALUE 'Y'.          01060000
009300         88  PS-NO-MORE-MSG                   VALUE 'N'.          01070000
PR0926                                                                  01080032
PR0926     05  PS-SIKP-MESSAGES-SW       PIC  X(01) VALUE 'N'.          01081030
PR0926         88   PS-SKIP-BAD-MESSAGE             VALUE 'Y'.          01082030
PR0926         88   PS-NO-BAD-MESSAGE               VALUE 'N'.          01083030
PR0926                                                                  01084030
009500     05  PS-SPACES-FOUND           PIC  X(01) VALUE 'N'.          01090000
009600         88  PS-SPACES-FOUND-Y                VALUE 'Y'.          01100000
009700         88  PS-SPACES-FOUND-N                VALUE 'N'.          01110000
009800                                                                  01120000
009900     05  PS-ERROR-FOUND            PIC  X(01) VALUE 'N'.          01130000
010000         88  PS-ERROR-FOUND-Y                 VALUE 'Y'.          01140000
010100         88  PS-ERROR-FOUND-N                 VALUE 'N'.          01150000
010200                                                                  01160000
010300     05  PS-SKU-STATUS-SW          PIC  X(01) VALUE 'N'.          01170000
010400         88  PS-SKU-STATUS-FOUND              VALUE 'Y'.          01180000
010500                                                                  01190000
010600******************************************************************01200000
010700*                       ACCUMULATORS                              01210000
010800******************************************************************01220000
010900 01  PA-PROGRAM-ACCUMS.                                           01230000
011000     05  PA-READ                   PIC  9(07) VALUE ZERO.         01240000
011100     05  PA-BKUP-WRITTEN           PIC  9(07) VALUE ZERO.         01250000
IN2431     05  PA-BAD-WRITTEN            PIC  9(07) VALUE ZERO.         01260000
011200     05  PA-UPDT-WRITTEN           PIC  9(07) VALUE ZERO.         01270000
011300                                                                  01280000
011400******************************************************************01290000
011500*                         CONSTANTS                               01300000
011600******************************************************************01310000
011700 01 PC-CONSTANTS.                                                 01320000
011800     05  PC-PGM-NAME               PIC  X(08) VALUE 'EPKUT081'.   01330000
011900     05  PC-FIFTY-STARS            PIC  X(50) VALUE ALL '*'.      01340000
012000     05  PC-MAX-MESSAGE            PIC  9(03) VALUE 100.          01350000
012100     05  PC-MAX-FIELDS             PIC  9(01) VALUE 8.            01360000
012200     05  PC-MAX-UPC-LENGTH         PIC  9(02) VALUE 15.           01370000
012300     05  PC-DATE-DASH              PIC  X(01) VALUE '-'.          01380000
012400     05  PC-TIME-DOT               PIC  X(01) VALUE '.'.          01390000
012500     05  PC-DATE-FINAL             PIC  X(06) VALUE '000000'.     01400000
012600                                                                  01410000
012700******************************************************************01420000
012800*                       CONTROL CARDS                             01430000
012900******************************************************************01440000
013000 01  CC-CNTL-CARD-1.                                              01450000
013100     05  CC-PC-QMGR-NAME           PIC  X(08) VALUE SPACES.       01460000
013200     05  FILLER                    PIC  X(72) VALUE SPACES.       01470000
013300                                                                  01480000
013400 01  CC-CNTL-CARD-2.                                              01490000
013500     05  CC-PC-QUEUE-NAME          PIC  X(24) VALUE SPACES.       01500000
013600     05  FILLER                    PIC  X(56) VALUE SPACES.       01510000
013700                                                                  01520000
013800******************************************************************01530000
013900*               SYSTEM TIME AND DATE VARIABLES                    01540000
014000******************************************************************01550000
014100 01  SYS-DATE-TIME.                                               01560000
014200     05  SYS-DATE                  PIC  X(08) VALUE SPACES.       01570000
014300     05  SYS-TIME                  PIC  X(08) VALUE SPACES.       01580000
014400                                                                  01590000
014500 01  ST-BEG-TIME.                                                 01600000
014600     05  ST-BEG-HR                 PIC  9(02) VALUE ZEROS.        01610000
014700     05  FILLER                    PIC  X(01) VALUE ':'.          01620000
014800     05  ST-BEG-MN                 PIC  9(02) VALUE ZEROS.        01630000
014900                                                                  01640000
015000 01  ST-END-TIME.                                                 01650000
015100     05  ST-END-HR                 PIC  9(02) VALUE ZEROS.        01660000
015200     05  FILLER                    PIC  X(01) VALUE ':'.          01670000
015300     05  ST-END-MN                 PIC  9(02) VALUE ZEROS.        01680000
015400                                                                  01690000
015500 01  SD-EDIT-DATE.                                                01700000
015600     05  SD-MONTH                  PIC  9(02) VALUE ZEROS.        01710000
015700     05  FILLER                    PIC  X(01) VALUE '-'.          01720000
015800     05  SD-DAY                    PIC  9(02) VALUE ZEROS.        01730000
015900     05  FILLER                    PIC  X(01) VALUE '-'.          01740000
016000     05  SD-CENT                   PIC  9(02) VALUE ZEROS.        01750000
016100     05  SD-YEAR                   PIC  9(02) VALUE ZEROS.        01760000
016200                                                                  01770000
016300******************************************************************01780000
016400* OBJECT DESCRIPTOR STRUCTURE                                     01790000
016500******************************************************************01800000
016600 01  MQM-OBJECT-DESCRIPTOR.                                       01810000
016700     COPY CMQODV.                                                 01820000
016800                                                                  01830000
016900******************************************************************01840000
017000* MESSAGE DESCRIPTOR STRUCTURE                                    01850000
017100******************************************************************01860000
017200 01  MQM-MESSAGE-DESCRIPTOR.                                      01870000
017300     COPY CMQMDV.                                                 01880000
017400                                                                  01890000
017500******************************************************************01900000
017600* GET MESSAGE OPTIONS STRUCTURE                                   01910000
017700******************************************************************01920000
017800 01  MQM-GET-MESSAGE-OPTIONS.                                     01930000
017900     COPY CMQGMOV.                                                01940000
018000                                                                  01950000
018100******************************************************************01960000
018200* MQV CONTAINS CONSTANTS (FOR FILLING IN THE CONTROL BLOCKS)      01970000
018300* AND RETURN CODES (FOR TESTING THE RESULT OF A CALL)             01980000
018400******************************************************************01990000
018500 01  MQM-CONSTANTS.                                               02000000
018600     COPY CMQV.                                                   02010000
018700                                                                  02020000
018800******************************************************************02030000
018900*                       MQ CONSTANTS                              02040000
019000******************************************************************02050000
019100 01  MQ-WORKING-STORAGE.                                          02060000
019200     05  WS-MQCONN                 PIC  X(08) VALUE 'CSQBCONN'.   02070000
019300     05  WS-MQOPEN                 PIC  X(08) VALUE 'CSQBOPEN'.   02080000
019400     05  WS-MQGET                  PIC  X(08) VALUE 'CSQBGET'.    02090000
019500     05  WS-MQBACK                 PIC  X(08) VALUE 'CSQBBACK'.   02100000
019600     05  WS-MQCMIT                 PIC  X(08) VALUE 'CSQBCOMM'.   02110000
019700     05  WS-MQCLOSE                PIC  X(08) VALUE 'CSQBCLOS'.   02120000
019800     05  WS-MQDISC                 PIC  X(08) VALUE 'CSQBDISC'.   02130000
019900     05  WS-MQCHECK                PIC  X(08) VALUE 'MQR2C'.      02140000
020000                                                                  02150000
020100******************************************************************02160000
020200*                       MQ VARIABLES                              02170000
020300******************************************************************02180000
020400 01 PV-MQ-PROGRAM-VARIABLES.                                      02190000
020500     05  PV-QM-NAME                PIC  X(48).                    02200000
020600     05  PV-HCONN                  PIC S9(09) BINARY VALUE 0.     02210000
020700     05  PV-SAVE-REASON            PIC S9(09) BINARY.             02220000
020800     05  PV-SAVE-COMP-CODE         PIC S9(09) BINARY.             02230000
020900     05  PV-COMPLETION-CODE        PIC S9(09) BINARY.             02240000
021000     05  PV-REASON                 PIC S9(09) BINARY.             02250000
021100     05  PV-CON-REASON             PIC S9(09) BINARY.             02260000
021200     05  PV-PARAGRAPH-NAME         PIC  X(48) VALUE SPACES.       02270000
021300     05  PV-DB2-OPERATION          PIC  X(30) VALUE SPACE.        02280000
021400     05  PV-ERROR-MESSAGE          PIC  X(48) VALUE SPACES.       02290000
021500     05  PV-OPEN-OPTIONS           PIC S9(09) BINARY.             02300000
021600     05  PV-HANDLE                 PIC S9(09) BINARY VALUE 0.     02310000
021700     05  PV-CLOSE-HANDLE           PIC S9(09) BINARY VALUE 0.     02320000
021800     05  PV-INT-OPEN-INPUT-HNDL    PIC S9(09) BINARY VALUE 0.     02330000
021900     05  PV-MSGBUFFER              PIC X(100) VALUE SPACES.       02340000
022000     05  PV-MSGLENGTH              PIC S9(09) BINARY VALUE +100.  02350000
022100     05  PV-DATA-LENGTH            PIC S9(09) BINARY.             02360000
022200     05  PV-MQ-REASON-TEXT         PIC  X(30) VALUE SPACES.       02370000
022300                                                                  02380000
022400     05  PV-LAST-DB2-ACTION        PIC  X(50) VALUE SPACES.       02390000
022500         88  PV-EPT00021-LOAD-ERROR           VALUE               02400000
022600             'INSERTING INTO PRICE CHECK TABLE, PARA 5000     '.  02410000
022700                                                                  02420000
022800     05  PV-DATE-TMSTMP            PIC  X(26) VALUE SPACES.       02430000
022900     05  FILLER REDEFINES PV-DATE-TMSTMP.                         02440000
023000         10  PV-DATE-CCYY-MM-DD    PIC  X(10).                    02450000
023100         10  FILLER                PIC  X(16).                    02460000
023200                                                                  02470000
023300     05  FILLER REDEFINES PV-DATE-TMSTMP.                         02480000
023400         10  PV-DATE-CCYY          PIC  X(04).                    02490000
023500         10  PV-DATE-DASH1         PIC  X(01).                    02500000
023600         10  PV-DATE-MM            PIC  X(02).                    02510000
023700         10  PV-DATE-DASH2         PIC  X(01).                    02520000
023800         10  PV-DATE-DD            PIC  X(02).                    02530000
023900         10  PV-DATE-DASH3         PIC  X(01).                    02540000
024000         10  PV-DATE-TIME-HH       PIC  X(02).                    02550000
024100         10  PV-DATE-TIME-DOT1     PIC  X(01).                    02560000
024200         10  PV-DATE-TIME-MM       PIC  X(02).                    02570000
024300         10  PV-DATE-TIME-DOT2     PIC  X(01).                    02580000
024400         10  PV-DATE-TIME-SS       PIC  X(02).                    02590000
024500         10  PV-DATE-TIME-DOT3     PIC  X(01).                    02600000
024600         10  PV-DATE-FINAL         PIC  X(06).                    02610000
024700                                                                  02620000
024800     05  PV-TIME                   PIC  X(08) VALUE SPACES.       02630000
024900     05  FILLER REDEFINES PV-TIME.                                02640000
025000         10  PV-TIME-HH            PIC  X(02).                    02650000
025100         10  PV-TIME-DOT1          PIC  X(01).                    02660000
025200         10  PV-TIME-MM            PIC  X(02).                    02670000
025300         10  PV-TIME-DOT2          PIC  X(01).                    02680000
025400         10  PV-TIME-SS            PIC  X(02).                    02690000
025500                                                                  02700000
025600     05  PV-UPC-NBR                PIC  9(15) VALUE ZEROS.        02710000
025700     05  PV-UPC-NBR-CHAR                                          02720000
025800         REDEFINES PV-UPC-NBR OCCURS 15 TIMES                     02730000
025900                              INDEXED BY PV-UPC-INDEX             02740000
026000                                 PIC X(01).                       02750000
026100                                                                  02760000
026200     05  PV-UPC-NBR-NEW            PIC S9(15)V COMP-3 VALUE ZEROS.02770000
026300     05  PV-LOC-NBR                PIC S9(04)  COMP   VALUE ZEROS.02780000
026400                                                                  02790000
026500******************************************************************02800000
026600*                     MQ PRICE CHECK MSG                          02810000
026700******************************************************************02820000
026800 01  PV-PRICE-CHECK-MESSAGE.                                      02830000
026900     05  PV-HOLD-MESSAGE           PIC X(100) VALUE SPACES.       02840000
027000                                                                  02850000
027100     05  PV-PRICE-CHECK-FIELD    OCCURS 20 TIMES                  02860000
027200                                   PIC  X(30) VALUE SPACES.       02870000
027300                                                                  02880000
027400     05  PV-PRICE-CHECK-INDEX      PIC  9(03) VALUE ZERO.         02890000
027500     05  PV-WS-CTR                 PIC  9(04) VALUE ZEROS.        02900000
027600     05  PV-MESSAGE-CNTR           PIC  9(04) VALUE ZERO.         02910000
027700     05  PV-HOLD-UPC-LENGTH        PIC  9(02) VALUE ZEROS.        02920000
027800                                                                  02930000
027900******************************************************************02940000
028000*                       INPUT FIELDS                              02950000
028100******************************************************************02960000
028200 01  IF-INPUT-FIELDS.                                             02970000
028300     05  IF-01-LOC-SRVR-NM         PIC  X(08) VALUE SPACES.       02980000
028400     05  FILLER REDEFINES IF-01-LOC-SRVR-NM.                      02990000
028500         10  FILLER                PIC  X(03).                    03000000
028600         10  IF-01-LOC-NBR         PIC  X(04).                    03010000
028700         10  FILLER                PIC  X(01).                    03020000
028800                                                                  03030000
028900     05  IF-02-DATE                PIC  X(08) VALUE SPACES.       03040000
029000     05  FILLER REDEFINES IF-02-DATE.                             03050000
029100         10  IF-02-DATE-MM         PIC  X(02).                    03060000
029200         10  IF-02-DATE-DD         PIC  X(02).                    03070000
029300         10  IF-02-DATE-CCYY       PIC  X(04).                    03080000
029400                                                                  03090000
029500     05  IF-03-TIME                PIC  X(06) VALUE SPACES.       03100000
029600     05  FILLER REDEFINES IF-03-TIME.                             03110000
029700         10  IF-03-TIME-HH         PIC  X(02).                    03120000
029800         10  IF-03-TIME-MM         PIC  X(02).                    03130000
029900         10  IF-03-TIME-SS         PIC  X(02).                    03140000
030000                                                                  03150000
030100     05  IF-04-IP                  PIC  X(15) VALUE SPACES.       03160000
030200     05  IF-05-DEVICE-TYPE         PIC  X(10) VALUE SPACES.       03170000
030300                                                                  03180000
030400     05  IF-06-UPC                 PIC  X(15) VALUE SPACES.       03190000
030500     05  IF-06-UPC-CHAR                                           03200000
030600         REDEFINES IF-06-UPC OCCURS 15 TIMES                      03210000
030700                             INDEXED BY PV-CHAR-INDEX             03220000
030800                                   PIC  X(01).                    03230000
030900                                                                  03240000
031000     05  IF-07-SKU-STATUS          PIC  X(02) VALUE SPACES.       03250000
031100                                                                  03260000
031200                                                                  03270000
031300******************************************************************03280000
031400*                        ERROR HANDLING                           03290000
031500******************************************************************03300000
031600 01  ABEND-CODE                    PIC S9(04) VALUE ZERO          03310000
031700                                              COMP SYNC.          03320000
031800     88  AC-CNTL-CARD-ERROR                   VALUE +4003.        03330000
031900     88  AC-DB2-ERROR                         VALUE +4013.        03340000
032000     88  AC-MQ-ERROR                          VALUE +4020.        03350000
032100                                                                  03360000
032200                                                                  03370000
032300******************************************************************03380000
032400* OUTPUT RECORD                                                   03390000
032500******************************************************************03400000
032600     COPY EPRD018.                                                03410000
032700                                                                  03420000
032800******************************************************************03430000
032900* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         03440000
033000******************************************************************03450000
033100     COPY DPWS004.                                                03460000
033200                                                                  03470000
033300******************************************************************03480000
033400* DB2 MESSAGE AREA                                                03490000
033500******************************************************************03500000
033600     COPY SQLCA2.                                                 03510000
033700                                                                  03520000
033800******************************************************************03530000
033900* DB2 COMMUNICATION AREA                                          03540000
034000******************************************************************03550000
034100     EXEC SQL                                                     03560000
034200        INCLUDE SQLCA                                             03570000
034300     END-EXEC.                                                    03580000
034400                                                                  03590000
034500******************************************************************03600000
034600* DB2 TABLE DB2PDBA.XST_UPC                                       03610000
034700******************************************************************03620000
034800     EXEC SQL                                                     03630000
034900          INCLUDE XST00012                                        03640000
035000     END-EXEC.                                                    03650000
035100                                                                  03660000
035200******************************************************************03670000
035300* DB2 TABLE DB2PDBA.XST_SKU_LOC                                   03680000
035400******************************************************************03690000
035500     EXEC SQL                                                     03700000
035600          INCLUDE XST00008                                        03710000
035700     END-EXEC.                                                    03720000
035800                                                                  03730000
035900                                                                  03740000
036000                                                                  03750000
036100 PROCEDURE DIVISION.                                              03760000
036200******************************************************************03770000
036300* MAINLINE                                                        03780000
036400******************************************************************03790000
036500 0000-MAINLINE.                                                   03800000
036600                                                                  03810000
036700     PERFORM 1000-INITIALIZE.                                     03820000
036800                                                                  03830000
036900     PERFORM 2000-PROCESS-MSGS                                    03840000
037000       UNTIL PS-NO-MORE-MSG.                                      03850000
037100                                                                  03860000
037200     PERFORM 9900-END-OF-JOB.                                     03870000
037300                                                                  03880000
037400     PERFORM 9200-DISCONNECT-QMGR.                                03890000
037500                                                                  03900000
037600     GOBACK.                                                      03910000
037700                                                                  03920000
037800                                                                  03930000
037900******************************************************************03940000
038000* PREFORMS TASK INITIATION                                        03950000
038100******************************************************************03960000
038200 1000-INITIALIZE.                                                 03970000
038300                                                                  03980000
038400     OPEN OUTPUT BKUP-FILE                                        03990000
IN2431                 BAD-FILE                                         04000000
038500                 UPDT-FILE.                                       04010000
038600                                                                  04020000
038700     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 04030000
038800                                                                  04040000
038900     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            04050000
039000     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            04060000
039100                                                                  04070000
039200     MOVE SYS-DATE (1:2) TO SD-CENT.                              04080000
039300     MOVE SYS-DATE (3:2) TO SD-YEAR.                              04090000
039400     MOVE SYS-DATE (5:2) TO SD-MONTH.                             04100000
039500     MOVE SYS-DATE (7:2) TO SD-DAY.                               04110000
039600                                                                  04120000
039700     PERFORM 1500-MQSETUP.                                        04130000
039800                                                                  04140000
039900     PERFORM 7000-GET-MQ-MESSAGE.                                 04150000
040000                                                                  04160000
040100                                                                  04170000
040200******************************************************************04180000
040300* MQ SETUP                                                        04190000
040400******************************************************************04200000
040500 1500-MQSETUP.                                                    04210000
040600                                                                  04220000
040700*=================================================================04230000
040800* READ CONTROL CARD TO GET QUEUE MANAGER NAME FOR PRICE CHECK     04240000
040900*=================================================================04250000
041000      SET PS-CNTL-CARD-1-START TO TRUE.                           04260000
041100      OPEN INPUT CNTL-CARD-1.                                     04270000
041200      READ CNTL-CARD-1 INTO CC-CNTL-CARD-1                        04280000
041300          AT END                                                  04290000
041400              SET PS-CNTL-CARD-1-END                              04300000
041500                                  TO TRUE.                        04310000
041600                                                                  04320000
041700      IF PS-CNTL-CARD-1-END                                       04330000
041800          DISPLAY PC-PGM-NAME                                     04340000
041900              'CONTROL CARD 1 MISSING - QMGR NAME FOR PRICE CHECK'04350000
042000          SET AC-CNTL-CARD-ERROR TO TRUE                          04360000
042100          CALL 'ILBOABN0' USING ABEND-CODE                        04370033
042200      ELSE                                                        04380000
042300          DISPLAY '         '                                     04390000
042400          DISPLAY PC-PGM-NAME                                     04400000
042500                  '- '                                            04410000
042600                  PC-FIFTY-STARS                                  04420000
042700          DISPLAY PC-PGM-NAME                                     04430000
042800                  '- CONTROL CARD: '                              04440000
042900                  CC-CNTL-CARD-1                                  04450000
043000      END-IF.                                                     04460000
043100                                                                  04470000
043200      CLOSE CNTL-CARD-1.                                          04480000
043300                                                                  04490000
043400*=================================================================04500000
043500* READ CONTROL CARD TO GET QUEUE NAME FOR PRICE CHECK             04510000
043600*=================================================================04520000
043700      SET PS-CNTL-CARD-2-START TO TRUE.                           04530000
043800      OPEN INPUT CNTL-CARD-2.                                     04540000
043900      READ CNTL-CARD-2 INTO CC-CNTL-CARD-2                        04550000
044000          AT END                                                  04560000
044100              SET PS-CNTL-CARD-2-END                              04570000
044200                                  TO TRUE.                        04580000
044300                                                                  04590000
044400      IF PS-CNTL-CARD-2-END                                       04600000
044500          DISPLAY PC-PGM-NAME                                     04610000
044600             'CONTROL CARD 2 MISSING - QUEUE NAME FOR PRICE CHECK'04620000
044700          SET AC-CNTL-CARD-ERROR TO TRUE                          04630000
044800          CALL 'ILBOABN0' USING ABEND-CODE                        04640033
044900      ELSE                                                        04650000
045000          DISPLAY PC-PGM-NAME                                     04660000
045100                  '- '                                            04670000
045200                  PC-FIFTY-STARS                                  04680000
045300          DISPLAY PC-PGM-NAME                                     04690000
045400                  '- CONTROL CARD: '                              04700000
045500                  CC-CNTL-CARD-2                                  04710000
045600      END-IF.                                                     04720000
045700                                                                  04730000
045800      CLOSE CNTL-CARD-2.                                          04740000
045900                                                                  04750000
046000*=================================================================04760000
046100* CONNECT TO THE QUEUE MANAGER                                    04770000
046200*=================================================================04780000
046300* SUPPLY QM-NAME, GET BACK HCONN, COMPLETION CODE AND REASON      04790000
046400                                                                  04800000
046500     MOVE CC-PC-QMGR-NAME TO PV-QM-NAME.                          04810000
046600     CALL WS-MQCONN USING PV-QM-NAME                              04820000
046700                          PV-HCONN                                04830000
046800                          PV-COMPLETION-CODE                      04840000
046900                          PV-REASON.                              04850000
047000                                                                  04860000
047100*    IF CONNECTION FAILED THEN DISPLAY ERROR MESSAGE              04870000
047200*    AND EXIT                                                     04880000
047300                                                                  04890000
047400     MOVE PV-REASON TO PV-CON-REASON.                             04900000
047500     IF (PV-COMPLETION-CODE     NOT = MQCC-OK) THEN               04910000
047600        MOVE 'MQCONN ERROR'        TO PV-ERROR-MESSAGE            04920000
047700        MOVE '1500-MQ-SETUP'       TO PV-PARAGRAPH-NAME           04930000
047800        PERFORM 9400-DISPLAY-MQ-ERROR                             04940000
047900     END-IF.                                                      04950000
048000     DISPLAY 'MQCONN SUCCESSFUL    TO ', PV-QM-NAME.              04960000
048100                                                                  04970000
048200*=================================================================04980000
048300* OPEN THE PRICE CHECK QUEUE FOR INPUT                            04990000
048400*=================================================================05000000
048500     COMPUTE PV-OPEN-OPTIONS = MQOO-INPUT-SHARED +                05010000
048600                               MQOO-FAIL-IF-QUIESCING +           05020000
048700                               MQOO-SAVE-ALL-CONTEXT.             05030000
048800                                                                  05040000
048900     MOVE CC-PC-QUEUE-NAME  TO MQOD-OBJECTNAME.                   05050000
049000     MOVE PV-QM-NAME        TO MQOD-OBJECTQMGRNAME.               05060000
049100                                                                  05070000
049200     CALL WS-MQOPEN USING PV-HCONN                                05080000
049300                          MQM-OBJECT-DESCRIPTOR                   05090000
049400                          PV-OPEN-OPTIONS                         05100000
049500                          PV-HANDLE                               05110000
049600                          PV-COMPLETION-CODE                      05120000
049700                          PV-REASON.                              05130000
049800                                                                  05140000
049900*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE                    05150000
050000*    AND EXIT.                                                    05160000
050100*                                                                 05170000
050200     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   05180000
050300        DISPLAY '                    '                            05190000
050400        DISPLAY 'PV-REASON         = ' PV-REASON                  05200000
050500        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         05210000
050600        DISPLAY 'PV-HCONN          = ' PV-HCONN                   05220000
050700                                                                  05230000
050800        MOVE 'MQOPEN ERROR'        TO PV-ERROR-MESSAGE            05240000
050900        MOVE '1500-MQ-SETUP'       TO PV-PARAGRAPH-NAME           05250000
051000        MOVE PV-REASON             TO PV-SAVE-REASON              05260000
051100        MOVE PV-COMPLETION-CODE    TO PV-SAVE-COMP-CODE           05270000
051200                                                                  05280000
051300        PERFORM 9200-DISCONNECT-QMGR                              05290000
051400        PERFORM 9400-DISPLAY-MQ-ERROR                             05300000
051500     END-IF.                                                      05310000
051600                                                                  05320000
051700     MOVE PV-HANDLE                TO PV-INT-OPEN-INPUT-HNDL.     05330000
051800     DISPLAY 'MQOPEN OF PRICE CHECK-INPUT DC QUEUE SUCCESSFUL'.   05340000
051900     DISPLAY '                                               '.   05350000
052000                                                                  05360000
052100                                                                  05370000
052200******************************************************************05380000
052300* PROCESS MESSAGES                                                05390000
052400******************************************************************05400000
052500 2000-PROCESS-MSGS.                                               05410000
052600                                                                  05420000
PR0926       IF  PS-NO-BAD-MESSAGE                                      05421029
PR0926          PERFORM 3000-UNSTRING-DETAIL                            05430029
PR0926          PERFORM 4000-MOVE-INPUT-FIELDS                          05440029
PR0926                                                                  05450029
PR0926          IF  PS-ERROR-FOUND-N                                    05460029
PR0926              PERFORM 5000-PRICE-CHECK-LOAD                       05470029
PR0926          ELSE                                                    05480029
PR0926              SET PS-ERROR-FOUND-N TO TRUE                        05490029
PR0926          END-IF                                                  05500029
PR0926        ELSE                                                      05501029
PR0926          PERFORM  7150-WRITE-BAD                                 05501229
PR0926      END-IF.                                                     05502029
PR0926     SET  PS-NO-BAD-MESSAGE TO TRUE.                              05510029
PR0926     PERFORM 7000-GET-MQ-MESSAGE.                                 05520029
053700                                                                  05530000
053800                                                                  05540000
053900******************************************************************05550000
054000* UNSTRING DETAIL                                                 05560000
054100******************************************************************05570000
054200 3000-UNSTRING-DETAIL.                                            05580000
054300                                                                  05590000
054400     MOVE 1 TO PV-PRICE-CHECK-INDEX.                              05600000
054500     MOVE 1 TO PV-WS-CTR.                                         05610000
054600                                                                  05620000
054700     PERFORM UNTIL PV-WS-CTR            > PC-MAX-MESSAGE          05630000
054800                OR PV-PRICE-CHECK-INDEX > PC-MAX-FIELDS           05640000
054900                                                                  05650000
055000          UNSTRING PV-HOLD-MESSAGE                                05660000
055100             DELIMITED BY ','                                     05670000
055200             INTO PV-PRICE-CHECK-FIELD (PV-PRICE-CHECK-INDEX)     05680000
055300             WITH POINTER PV-WS-CTR                               05690000
055400          END-UNSTRING                                            05700000
055500                                                                  05710000
055600          ADD 1 TO PV-PRICE-CHECK-INDEX                           05720000
055700                                                                  05730000
055800     END-PERFORM.                                                 05740000
055900                                                                  05750000
056000                                                                  05760000
056100******************************************************************05770000
056200* MOVE INPUT FIELDS                                               05780000
056300******************************************************************05790000
056400 4000-MOVE-INPUT-FIELDS.                                          05800000
056500                                                                  05810000
056600     MOVE PV-PRICE-CHECK-FIELD (01) TO IF-01-LOC-SRVR-NM.         05820000
056700     MOVE PV-PRICE-CHECK-FIELD (02) TO IF-02-DATE.                05830000
056800     MOVE IF-02-DATE-MM             TO PV-DATE-MM.                05840000
056900     MOVE IF-02-DATE-DD             TO PV-DATE-DD.                05850000
057000     MOVE IF-02-DATE-CCYY           TO PV-DATE-CCYY.              05860000
057100                                                                  05870000
057200     MOVE PC-DATE-DASH              TO PV-DATE-DASH1              05880000
057300                                       PV-DATE-DASH2              05890000
057400                                       PV-DATE-DASH3.             05900000
057500                                                                  05910000
057600     MOVE PC-DATE-FINAL             TO PV-DATE-FINAL.             05920000
057700     MOVE PV-PRICE-CHECK-FIELD (03) TO IF-03-TIME.                05930000
057800                                                                  05940000
057900     MOVE IF-03-TIME-HH             TO PV-TIME-HH                 05950000
058000                                       PV-DATE-TIME-HH.           05960000
058100     MOVE IF-03-TIME-MM             TO PV-TIME-MM                 05970000
058200                                       PV-DATE-TIME-MM.           05980000
058300     MOVE IF-03-TIME-SS             TO PV-TIME-SS                 05990000
058400                                       PV-DATE-TIME-SS.           06000000
058500                                                                  06010000
058600     MOVE PC-TIME-DOT               TO PV-TIME-DOT1               06020000
058700                                       PV-TIME-DOT2               06030000
058800                                       PV-DATE-TIME-DOT1          06040000
058900                                       PV-DATE-TIME-DOT2          06050000
059000                                       PV-DATE-TIME-DOT3.         06060000
059100                                                                  06070000
059200     MOVE PV-PRICE-CHECK-FIELD (04) TO IF-04-IP.                  06080000
059300     MOVE PV-PRICE-CHECK-FIELD (05) TO IF-05-DEVICE-TYPE.         06090000
059400     MOVE PV-PRICE-CHECK-FIELD (06) TO IF-06-UPC.                 06100000
059500     MOVE IF-01-LOC-NBR             TO PV-LOC-NBR.                06110000
059600                                                                  06120000
059700     PERFORM 4100-MOVE-UPC-DIGITS.                                06130000
059800                                                                  06140000
059900     MOVE PV-UPC-NBR                TO PV-UPC-NBR-NEW.            06150000
060000                                                                  06160000
060100     MOVE 'N' TO PS-SKU-STATUS-SW.                                06170000
060200     PERFORM 4200-FIND-SKU-STATUS.                                06180000
060300                                                                  06190000
060400     IF  PS-SKU-STATUS-FOUND                                      06200000
060500         CONTINUE                                                 06210000
060600     ELSE                                                         06220000
060700         PERFORM 4300-FIND-SKU-STATUS                             06230000
060800     END-IF.                                                      06240000
060900                                                                  06250000
061000                                                                  06260000
061100******************************************************************06270000
061200* MOVE UPC DIGITS                                                 06280000
061300******************************************************************06290000
061400 4100-MOVE-UPC-DIGITS.                                            06300000
061500                                                                  06310000
061600     SET PV-CHAR-INDEX TO 1.                                      06320000
061700                                                                  06330000
061800     PERFORM UNTIL PV-CHAR-INDEX     > PC-MAX-UPC-LENGTH          06340000
061900                OR PS-SPACES-FOUND-Y                              06350000
062000                                                                  06360000
062100        IF  IF-06-UPC-CHAR (PV-CHAR-INDEX) = ' '                  06370000
062200            SET PS-SPACES-FOUND-Y TO TRUE                         06380000
062300        END-IF                                                    06390000
062400                                                                  06400000
062500        SET PV-CHAR-INDEX UP BY 1                                 06410000
062600     END-PERFORM.                                                 06420000
062700                                                                  06430000
062800     SET PS-SPACES-FOUND-N  TO TRUE.                              06440000
062900     SET PV-CHAR-INDEX      DOWN BY 2.                            06450000
063000     SET PV-HOLD-UPC-LENGTH TO PV-CHAR-INDEX.                     06460000
063100     SET PV-UPC-INDEX       TO PC-MAX-UPC-LENGTH.                 06470000
063200                                                                  06480000
063300     PERFORM UNTIL PV-CHAR-INDEX = 0                              06490000
063400        MOVE IF-06-UPC-CHAR (PV-CHAR-INDEX)                       06500000
063500                             TO PV-UPC-NBR-CHAR (PV-UPC-INDEX)    06510000
063600                                                                  06520000
063700        SET PV-CHAR-INDEX DOWN BY 1                               06530000
063800        SET PV-UPC-INDEX  DOWN BY 1                               06540000
063900     END-PERFORM.                                                 06550000
064000                                                                  06560000
064100                                                                  06570000
064200******************************************************************06580000
064300* FIND SKU STATUS                                                 06590000
064400******************************************************************06600000
064500 4200-FIND-SKU-STATUS.                                            06610000
064600                                                                  06620000
064700     EXEC SQL                                                     06630000
064800          SELECT LOC_SKU_STAT_CDE                                 06640000
064900                                                                  06650000
065000            INTO :IF-07-SKU-STATUS                                06660000
065100                                                                  06670000
065200            FROM XST_UPC     A                                    06680000
065300                ,XST_SKU_LOC B                                    06690000
065400                                                                  06700000
065500          WHERE  A.UPC_NBR         = :PV-UPC-NBR-NEW              06710000
065600            AND  A.INTR_UPC_ID     = B.INTR_UPC_ID                06720000
065700            AND  B.LOC_NBR         = :PV-LOC-NBR                  06730000
065800            AND  B.BEG_TMST       <= :PV-DATE-TMSTMP              06740000
065900                                                                  06750000
066000            AND  (B.END_TMST      >= :PV-DATE-TMSTMP              06760000
066100             OR   B.END_TMST      IS NULL)                        06770000
066200                                                                  06780000
066300            AND  A.LAST_UPD_TMST   =                              06790000
066400                (SELECT MAX(C.LAST_UPD_TMST)                      06800000
066500                   FROM XST_UPC C                                 06810000
066600                  WHERE A.UPC_NBR = C.UPC_NBR)                    06820037
066700        WITH UR                                                   06830000
066800     END-EXEC.                                                    06840000
066900                                                                  06850000
067000     EVALUATE TRUE                                                06860000
067100         WHEN SQLCODE = ZERO                                      06870000
067200              SET PS-SKU-STATUS-FOUND TO TRUE                     06880000
067300                                                                  06890000
067400         WHEN SQLCODE = +100                                      06900000
067500              CONTINUE                                            06910000
067600                                                                  06920000
067700         WHEN SQLCODE = -310                                      06930000
067800              SET PS-ERROR-FOUND-Y  TO TRUE                       06940000
067900              DISPLAY 'NON-DECIMAL DATA IN UPC'                   06950000
068000              DISPLAY 'DATE = ' PV-DATE-TMSTMP                    06960000
068100              DISPLAY 'UPC  = ' PV-UPC-NBR-NEW                    06970000
068200              DISPLAY 'STR  = ' PV-LOC-NBR                        06980000
068300                                                                  06990000
068400         WHEN SQLWARN0 NOT EQUAL SPACE                            07000000
068500         WHEN SQLCODE  NOT EQUAL ZERO                             07010000
068600             DISPLAY 'SQLCODE = ' SQLCODE                         07020000
068700             DISPLAY 'DATE    = ' PV-DATE-TMSTMP                  07030000
068800             DISPLAY 'UPC     = ' PV-UPC-NBR-NEW                  07040000
068900             DISPLAY 'STR     = ' PV-LOC-NBR                      07050000
069000                                                                  07060000
069100             MOVE '4200-FIND-SKU-STATUS'                          07070000
069200                                    TO PV-PARAGRAPH-NAME          07080000
069300             MOVE 'ERROR ON SELECT OF SKU STATUS'                 07090000
069400                                    TO PV-DB2-OPERATION           07100000
069500                                                                  07110000
069600             PERFORM 9100-SQL-ABEND                               07120000
069700     END-EVALUATE.                                                07130000
069800                                                                  07140000
069900                                                                  07150000
070000******************************************************************07160000
070100* FIND SKU STATUS                                                 07170000
070200******************************************************************07180000
070300 4300-FIND-SKU-STATUS.                                            07190000
070400                                                                  07200000
070500     EXEC SQL                                                     07210000
070600          SELECT LOC_SKU_STAT_CDE                                 07220000
070700                                                                  07230000
070800            INTO :IF-07-SKU-STATUS                                07240000
070900                                                                  07250000
071000            FROM XST_UPC     A                                    07260000
071100                ,XST_SKU_LOC B                                    07270000
071200                                                                  07280000
071300          WHERE  A.UPC_NBR         = :PV-UPC-NBR-NEW              07290000
071400            AND  A.INTR_UPC_ID     = B.INTR_UPC_ID                07300000
071500            AND  B.LOC_NBR         = 0                            07310000
071600            AND  B.BEG_TMST       <= :PV-DATE-TMSTMP              07320000
071700                                                                  07330000
071800            AND  (B.END_TMST      >= :PV-DATE-TMSTMP              07340000
071900             OR   B.END_TMST      IS NULL)                        07350000
072000                                                                  07360000
072100            AND  A.LAST_UPD_TMST   =                              07370000
072200                (SELECT MAX(C.LAST_UPD_TMST)                      07380000
072300                   FROM XST_UPC C                                 07390000
072400                  WHERE A.UPC_NBR = C.UPC_NBR)                    07400000
                  FETCH FIRST 1 ROW ONLY                                07401036
072500        WITH UR                                                   07410000
072600     END-EXEC.                                                    07420000
072700                                                                  07430000
072800     EVALUATE TRUE                                                07440000
072900         WHEN SQLCODE = ZERO                                      07450000
073000              CONTINUE                                            07460000
073100                                                                  07470000
073200         WHEN SQLCODE = +100                                      07480000
073300              SET PS-ERROR-FOUND-Y  TO TRUE                       07490000
073400              DISPLAY 'SKU STATUS NOT FOUND'                      07500000
073500              DISPLAY 'DATE = ' PV-DATE-TMSTMP                    07510000
073600              DISPLAY 'UPC  = ' PV-UPC-NBR-NEW                    07520000
073700              DISPLAY 'STR  = ' PV-LOC-NBR                        07530000
073800                                                                  07540000
073900         WHEN SQLCODE = -310                                      07550000
074000              SET PS-ERROR-FOUND-Y  TO TRUE                       07560000
074100              DISPLAY 'NON-DECIMAL DATA IN UPC'                   07570000
074200              DISPLAY 'DATE = ' PV-DATE-TMSTMP                    07580000
074300              DISPLAY 'UPC  = ' PV-UPC-NBR-NEW                    07590000
074400              DISPLAY 'STR  = ' PV-LOC-NBR                        07600000
074500                                                                  07610000
074600         WHEN SQLWARN0 NOT EQUAL SPACE                            07620000
074700         WHEN SQLCODE  NOT EQUAL ZERO                             07630000
074800             DISPLAY 'SQLCODE = ' SQLCODE                         07640000
074900             DISPLAY 'DATE    = ' PV-DATE-TMSTMP                  07650000
075000             DISPLAY 'UPC     = ' PV-UPC-NBR-NEW                  07660000
075100             DISPLAY 'STR     = ' PV-LOC-NBR                      07670000
075200                                                                  07680000
075300             MOVE '4300-FIND-SKU-STATUS'                          07690000
075400                                    TO PV-PARAGRAPH-NAME          07700000
075500             MOVE 'ERROR ON SELECT OF SKU STATUS'                 07710000
075600                                    TO PV-DB2-OPERATION           07720000
075700                                                                  07730000
075800             PERFORM 9100-SQL-ABEND                               07740000
075900     END-EVALUATE.                                                07750000
076000                                                                  07760000
076100                                                                  07770000
076200******************************************************************07780000
076300* PRICE CHECK LOAD                                                07790000
076400******************************************************************07800000
076500  5000-PRICE-CHECK-LOAD.                                          07810000
076600                                                                  07820000
076700     MOVE PV-DATE-CCYY-MM-DD        TO EP018-SCN-DTE.             07830000
076800     MOVE PV-LOC-NBR                TO EP018-LOC-NBR.             07840000
076900     MOVE PV-TIME                   TO EP018-SCN-TM.              07850000
077000     MOVE IF-04-IP                  TO EP018-IP-ADDR.             07860000
077100     MOVE IF-01-LOC-SRVR-NM         TO EP018-LOC-SRVR-NM.         07870000
077200     MOVE IF-05-DEVICE-TYPE         TO EP018-SCNR-MKR-NM.         07880000
077300     MOVE PV-UPC-NBR                TO EP018-UPC-NBR.             07890000
077400     MOVE IF-07-SKU-STATUS          TO EP018-LOC-SKU-STAT-CDE.    07900000
077500                                                                  07910000
077600     WRITE UPDT-REC FROM EP018-UPDT-REC.                          07920000
077700                                                                  07930000
077800     ADD 1 TO PA-UPDT-WRITTEN.                                    07940000
077900                                                                  07950000
078000                                                                  07960000
078100******************************************************************07970000
078200*  PERFORM AN MQGET TO RETRIEVE A MESSAGE FROM THE MQ QUEUE.      07980000
078300*  THE OPTIONS ARE SET SO THAT IT WILL WAIT UNTIL A MESSAGE       07990000
078400*  APPEARS ON THE QUEUE, AND THAT SYNCPOINT IS SET FOR COMMITING  08000000
078500*  AND ROLLING BACK MESSAGES. THE MESSAGE IS EXAMINED, THE        08010000
078600*  PROGRAM WILL END AFTER 4 END OF DAY MESSAGES ARE RECEIVED.     08020000
078700******************************************************************08030000
078800 7000-GET-MQ-MESSAGE.                                             08040000
078900                                                                  08050000
079000      INITIALIZE PV-MSGBUFFER                                     08060000
079100                 IF-INPUT-FIELDS                                  08070000
079200                 PV-UPC-NBR                                       08080000
079300                 PV-UPC-NBR-NEW                                   08090000
079400                 PV-LOC-NBR.                                      08100000
079500                                                                  08110000
079600      MOVE +100                  TO PV-MSGLENGTH.                 08120009
079700      MOVE MQMI-NONE             TO MQMD-MSGID.                   08130000
079800      MOVE MQCI-NONE             TO MQMD-CORRELID.                08140000
079900      MOVE CC-PC-QUEUE-NAME      TO MQOD-OBJECTNAME.              08150000
PR0926      MOVE '7000-GET-MQ-MESSAGE' TO PV-PARAGRAPH-NAME.            08151002
080000                                                                  08160000
080100      COMPUTE MQGMO-OPTIONS       = MQGMO-CONVERT   +             08170000
PR0926                                    MQGMO-SYNCPOINT +             08180031
PR0926                                    MQGMO-ACCEPT-TRUNCATED-MSG    08181029
080300                                                                  08190000
080400      CALL WS-MQGET USING PV-HCONN                                08200000
080500                          PV-INT-OPEN-INPUT-HNDL                  08210000
080600                          MQM-MESSAGE-DESCRIPTOR                  08220000
080700                          MQM-GET-MESSAGE-OPTIONS                 08230000
080800                          PV-MSGLENGTH                            08240000
080900                          PV-MSGBUFFER                            08250000
081000                          PV-DATA-LENGTH                          08260000
081100                          PV-COMPLETION-CODE                      08270000
081200                          PV-REASON.                              08280000
081300                                                                  08290000
081400*     IF GET FAILED THEN DISPLAY ERROR MESSAGE                    08300000
081500*     AND BREAK OUT OF LOOP                                       08310000
081600                                                                  08320000
081700     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        08330000
PR0926       EVALUATE TRUE                                              08340029
PR0926           WHEN PV-REASON = MQRC-FORMAT-ERROR                     08340126
PR0926           WHEN PV-REASON = MQRC-TRUNCATED-MSG-FAILED             08340226
PR0926           WHEN PV-REASON = MQRC-TRUNCATED-MSG-ACCEPTED           08340329
PR0926                 SET PS-SKIP-BAD-MESSAGE TO TRUE                  08340529
PR0926           WHEN PV-REASON = MQRC-NO-MSG-AVAILABLE                 08341326
PR0926                 SET PS-NO-MORE-MSG TO TRUE                       08341429
PR0926           WHEN OTHER                                             08343026
PR0926                  PERFORM 9400-DISPLAY-MQ-ERROR                   08344001
PR0926       END-EVALUATE                                               08345029
082300                                                                  08440000
082400     ELSE                                                         08450027
082500         ADD 1 TO PA-READ                                         08460000
082600                                                                  08470000
082700         PERFORM 7100-WRITE-BKUP                                  08480000
082800                                                                  08490000
082900         MOVE LOW-VALUES    TO PV-HOLD-MESSAGE                    08500000
083000         MOVE PV-MSGBUFFER  TO PV-HOLD-MESSAGE                    08510000
083100                                                                  08520000
083200         PERFORM 7200-CHECK-COMMIT                                08530000
083300                                                                  08540000
083400     END-IF.                                                      08550000
083500                                                                  08560000
083600                                                                  08570000
083700******************************************************************08580000
083800* WRITE THE BACKUP OUTPUT REC                                     08590000
083900******************************************************************08600000
084000 7100-WRITE-BKUP.                                                 08610000
084100                                                                  08620000
084200     WRITE BKUP-REC FROM PV-MSGBUFFER.                            08630000
084300                                                                  08640000
084400     ADD 1 TO PA-BKUP-WRITTEN.                                    08650000
084500                                                                  08660000
IN2431******************************************************************08670000
IN2431* WRITE THE BAD OUTPUT REC                                        08680000
IN2431******************************************************************08690000
IN2431 7150-WRITE-BAD.                                                  08700000
IN2431                                                                  08710000
IN2431     WRITE BAD-REC FROM PV-MSGBUFFER.                             08720000
IN2431                                                                  08730000
IN2431     ADD 1 TO PA-BAD-WRITTEN.                                     08740000
084700******************************************************************08770000
084800* CHECK TO SEE IF NEED TO COMMIT THE QUEUE                        08780000
084900******************************************************************08790000
085000 7200-CHECK-COMMIT.                                               08800000
085100                                                                  08810000
085200     ADD +1 TO PV-MESSAGE-CNTR.                                   08820000
085300                                                                  08830000
085400     IF PV-MESSAGE-CNTR = 1000                                    08840000
085500        PERFORM 7300-COMMIT-MQ                                    08850000
085600                                                                  08860000
085700        MOVE ZERO TO PV-MESSAGE-CNTR                              08870000
085800     END-IF.                                                      08880000
085900                                                                  08890000
086000                                                                  08900000
086100******************************************************************08910000
086200* COMMIT MQ                                                       08920000
086300******************************************************************08930000
086400 7300-COMMIT-MQ.                                                  08940000
086500                                                                  08950000
086600     CALL WS-MQCMIT USING PV-HCONN                                08960000
086700                          PV-COMPLETION-CODE                      08970000
086800                          PV-REASON.                              08980000
086900                                                                  08990000
087000     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   09000000
087100        MOVE '7300-COMMIT-MQ'  TO PV-PARAGRAPH-NAME               09010000
087200        MOVE 'MQCMIT ERROR'    TO PV-ERROR-MESSAGE                09020000
087300                                                                  09030000
087400        PERFORM 9300-BACK-OUT-MQ                                  09040000
087500        PERFORM 9400-DISPLAY-MQ-ERROR                             09050000
087600     END-IF.                                                      09060000
087700                                                                  09070000
087800                                                                  09080000
087900******************************************************************09090000
088000* FORMAT A DB2 ERROR MESSAGE, AND ABEND THE PROGRAM               09100000
088100******************************************************************09110000
088200 9100-SQL-ABEND.                                                  09120000
088300                                                                  09130000
088400     PERFORM 9900-END-OF-JOB.                                     09140000
088500                                                                  09150000
088600     DISPLAY '** ABEND      **'.                                  09160000
088700     DISPLAY '** PROGRAM    ** = ' PC-PGM-NAME.                   09170000
088800     DISPLAY '** PARAGRAPH  ** = ' PV-PARAGRAPH-NAME.             09180000
088900     DISPLAY '** DB2 ACTION ** = ' PV-LAST-DB2-ACTION.            09190000
089000                                                                  09200000
089100******************************************************************09210000
089200* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     09220000
089300* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      09230000
089400******************************************************************09240000
089500     COPY DPPD004.                                                09250000
089600                                                                  09260000
089700     SET AC-DB2-ERROR TO TRUE.                                    09270000
089800                                                                  09280000
089900     CALL 'ILBOABN0' USING ABEND-CODE.                            09290000
090000                                                                  09300000
090100                                                                  09310000
090200******************************************************************09320000
090300* DISCONNECT FROM THE QUEUE MANAGER                               09330000
090400******************************************************************09340000
090500 9200-DISCONNECT-QMGR.                                            09350000
090600                                                                  09360000
090700     IF  PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED     09370000
090800         CALL WS-MQDISC USING PV-HCONN                            09380000
090900                              PV-COMPLETION-CODE                  09390000
091000                              PV-REASON                           09400000
091100                                                                  09410000
091200        IF  (PV-COMPLETION-CODE NOT = MQCC-OK) THEN               09420000
091300            MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE       09430000
091400            MOVE '9200-DISCONNECT-QMGR' TO PV-PARAGRAPH-NAME      09440000
091500            MOVE PV-REASON              TO PV-SAVE-REASON         09450000
091600            MOVE PV-COMPLETION-CODE     TO PV-SAVE-COMP-CODE      09460000
091700                                                                  09470000
091800            PERFORM 9400-DISPLAY-MQ-ERROR                         09480000
091900                                                                  09490000
092000        ELSE                                                      09500000
092100            DISPLAY 'MQDISC SUCCESSFUL'                           09510000
092200                                                                  09520000
092300        END-IF                                                    09530000
092400     END-IF.                                                      09540000
092500                                                                  09550000
092600                                                                  09560000
092700******************************************************************09570000
092800* BACK OUT MQ                                                     09580000
092900******************************************************************09590000
093000 9300-BACK-OUT-MQ.                                                09600000
093100                                                                  09610000
093200     CALL WS-MQBACK USING PV-HCONN                                09620000
093300                          PV-COMPLETION-CODE                      09630000
093400                          PV-REASON.                              09640000
093500                                                                  09650000
093600     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   09660000
093700        MOVE '9300-BACK-OUT-MQ' TO PV-PARAGRAPH-NAME              09670000
093800        MOVE 'MQBACK ERROR'     TO PV-ERROR-MESSAGE               09680000
093900                                                                  09690000
094000        PERFORM 9400-DISPLAY-MQ-ERROR                             09700000
094100     END-IF.                                                      09710000
094200                                                                  09720000
094300                                                                  09730000
094400******************************************************************09740000
094500* DISPLAY THE VALUES OF A FAILED MQ API COMMAND, AND ABEND PGM    09750000
094600******************************************************************09760000
094700 9400-DISPLAY-MQ-ERROR.                                           09770000
094800                                                                  09780000
094900     CALL WS-MQCHECK USING PV-SAVE-REASON                         09790000
095000                           PV-MQ-REASON-TEXT.                     09800000
095100                                                                  09810000
095200     DISPLAY '**** ABEND *************************************'.  09820000
095300     DISPLAY '** MQSERIES ERROR **'.                              09830000
095400     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      09840000
095500     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH-NAME.                09850000
095600     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 09860000
095700     DISPLAY '** COMP CODE:  ', PV-SAVE-COMP-CODE.                09870000
095800     DISPLAY '** RSN CODE:   ', PV-SAVE-REASON.                   09880000
095900     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                09890000
096000     DISPLAY '************************************************'.  09900000
096100                                                                  09910000
096200     SET AC-MQ-ERROR TO TRUE.                                     09920000
096300                                                                  09930000
096400     CALL 'ILBOABN0' USING ABEND-CODE.                            09940000
096500                                                                  09950000
096600                                                                  09960000
096700******************************************************************09970000
096800* PREFORMS TASK TERMINATION PROCESSING                            09980000
096900******************************************************************09990000
097000 9900-END-OF-JOB.                                                 10000000
097100                                                                  10010000
097200     CALL WS-MQCLOSE USING PV-HCONN                               10020000
097300                           PV-CLOSE-HANDLE                        10030000
097400                           MQCO-NONE                              10040000
097500                           PV-COMPLETION-CODE                     10050000
097600                           PV-REASON.                             10060000
097700                                                                  10070000
097800     CLOSE BKUP-FILE                                              10080000
IN2431           BAD-FILE                                               10090000
097900           UPDT-FILE.                                             10100000
098000                                                                  10110000
098100     PERFORM 9999-CONTROLS.                                       10120000
098200                                                                  10130000
098300                                                                  10140000
098400******************************************************************10150000
098500* DISPLAY CONTROLS FROM THE PROGRAM                               10160000
098600******************************************************************10170000
098700 9999-CONTROLS.                                                   10180000
098800                                                                  10190000
098900     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 10200000
099000                                                                  10210000
099100     MOVE SYS-TIME (1:2) TO ST-END-HR.                            10220000
099200     MOVE SYS-TIME (3:2) TO ST-END-MN.                            10230000
099300                                                                  10240000
099400     DISPLAY '                    '.                              10250000
099500     DISPLAY '**********************'.                            10260000
099600     DISPLAY '   EPKUT081 CONTROLS  '.                            10270000
099700     DISPLAY '**********************'.                            10280000
099800     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         10290000
099900     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          10300000
100000     DISPLAY 'END TIME  = ' ST-END-TIME.                          10310000
100100     DISPLAY '======================'.                            10320000
100200     DISPLAY 'QUEUE RECS READ = ' PA-READ.                        10330000
100300     DISPLAY '               '.                                   10340000
100400     DISPLAY 'BKUP WRITTEN = ' PA-BKUP-WRITTEN.                   10350000
IN2431     DISPLAY 'BAD  WRITTEN = ' PA-BAD-WRITTEN.                    10360000
100500     DISPLAY 'UPDT WRITTEN = ' PA-UPDT-WRITTEN.                   10370000
100600     DISPLAY '                '.                                  10380000
100700                                                                  10390000
100800                                                                  10400000
