000100******************************************************************00010031
000200 IDENTIFICATION DIVISION.                                         00020031
000300******************************************************************00030031
000400                                                                  00040031
000500 PROGRAM-ID.    SUKUT039.                                         00050031
000600 AUTHOR.        GERMAN BANDA                                      00060031
000700 INSTALLATION.  KOHLS.                                            00070031
000800 DATE-WRITTEN   OCTOBER, 2000.                                    00080031
000900 DATE-COMPILED.                                                   00090031
001000                                                                  00100031
001100******************************************************************00110031
001200*  THIS PROGRAM WILL EXTRACT PO'S FOR REPORTING BY PO VERSUS      00120031
001300*  ENTIRE TRIP.                                                   00130031
001400******************************************************************00140031
001500                                                                  00150031
001600******************************************************************00160031
001700 ENVIRONMENT DIVISION.                                            00170031
001800******************************************************************00180031
001900                                                                  00190031
002000 CONFIGURATION SECTION.                                           00200031
002100                                                                  00210031
002200 SOURCE-COMPUTER.        IBM-3090.                                00220031
002300 OBJECT-COMPUTER.        IBM-3090.                                00230031
002400                                                                  00240031
002500 INPUT-OUTPUT SECTION.                                            00250031
002600                                                                  00260031
002700 FILE-CONTROL.                                                    00270031
002800*                                                                 00280031
002900     SELECT EXTRACT-FILE-IN                                       00290031
003000         ASSIGN TO INP01.                                         00300031
003100                                                                  00310031
003200     SELECT EXTRACT-FILE-OUT                                      00320031
003300         ASSIGN TO OUT01.                                         00330031
003400                                                                  00340031
003500******************************************************************00350031
003600 DATA DIVISION.                                                   00360031
003700******************************************************************00370031
003800*                                                                 00380031
003900 FILE SECTION.                                                    00390031
004000*                                                                 00400031
004100 FD  EXTRACT-FILE-IN                                              00410031
004200     LABEL RECORDS ARE STANDARD                                   00420031
004300     RECORDING MODE IS F                                          00430031
004400     BLOCK CONTAINS 0 RECORDS                                     00440031
004500     RECORD CONTAINS 200 CHARACTERS.                              00450031
004600 01  EXTRACT-RECORD-IN               PIC X(200).                  00460031
004700                                                                  00470031
004800 FD  EXTRACT-FILE-OUT                                             00480031
004900     RECORDING MODE IS F                                          00490031
005000     BLOCK CONTAINS 0  RECORDS.                                   00500031
005100 01  EXTRACT-RECORD-OUT              PIC X(200).                  00510031
005200*                                                                 00520031
005300                                                                  00530031
005400******************************************************************00540031
005500 WORKING-STORAGE SECTION.                                         00550031
005600******************************************************************00560031
005700**************************************************************    00570031
005800* FORMAT OF THE CONTROL CARD INFORMATION PASSED INTO THE PGM *    00580031
005900**************************************************************    00590031
006000 01  CC-CONTROL-CARD.                                             00600031
006100     05  CC-TRIP-ID                   PIC  X(09).                 00610031
006200     05  FILLER                       PIC  X(01).                 00620031
006300     05  CC-WRKR-USER-ID              PIC  X(08).                 00630031
006400     05  FILLER                       PIC  X(01).                 00640031
006500     05  CC-TIMESTAMP                 PIC  X(26).                 00650031
006600                                                                  00660031
006700 01  DK-DB2-KEYS.                                                 00670031
006800     05  DK-TRIP-ID                   PIC  X(9).                  00680031
006900*    05  DK-TRIP-ID-R REDEFINES                                   00690031
007000*        DK-TRIP-ID                   PIC  S9(9) COMP.            00700031
007100     05  DK-WRKR-USER-ID              PIC  X(08).                 00710031
007200     05  DK-TIMESTAMP                 PIC  X(26).                 00720031
007300                                                                  00730031
007400*-----------------------------------------------------------------00740031
007500*  RECORD LAYOUT FOR THE INPUT/OUTPUT FILE                        00750031
007600*-----------------------------------------------------------------00760031
007700     COPY SURD001.                                                00770031
007800                                                                  00780031
007900*-----------------------------------------------------------------00790031
008000*  DB2 FORMATTED MESSAGE AREA                                     00800031
008100*-----------------------------------------------------------------00810031
008200     COPY DPWS004.                                                00820033
008300                                                                  00830031
008400*-----------------------------------------------------------------00840031
008500*  COMMUNICATIONS AREA FOR DB2                                    00850031
008600*-----------------------------------------------------------------00860031
008700     EXEC SQL                                                     00870031
008800          INCLUDE SQLCA                                           00880031
008900     END-EXEC.                                                    00890031
009000                                                                  00900031
009100*-----------------------------------------------------------------00910031
009200*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE REPORT REQUEST     00920031
009300*  TABLE                                                          00930031
009400*-----------------------------------------------------------------00940031
009500     EXEC SQL                                                     00950031
009600          INCLUDE TSURPRQ                                         00960031
009700     END-EXEC.                                                    00970031
009800                                                                  00980031
009900*-----------------------------------------------------------------00990031
010000*                                                                 01000031
010100*-----------------------------------------------------------------01010031
010200 01  ABEND-CODE                    PIC S9(04) VALUE +0            01020031
010300                                              COMP SYNC.          01030031
010400                                                                  01040031
010500 01  PS-PROGRAM-SWITCHES.                                         01050031
010600     05  PS-EOF-PRNT-REQ-PO-CSR-SW  PIC  X(01)   VALUE 'N'.       01060031
010700         88  PS-EOF-PRT-REQ-PO-CSR               VALUE 'Y'.       01070031
010800         88  PS-MORE-PRT-REQ-PO-CSR              VALUE 'N'.       01080031
010900     05  PS-PS-END-OF-EXTRACT-SW      PIC  X(01) VALUE 'N'.       01090031
011000         88  PS-END-OF-EXTRACT                   VALUE 'Y'.       01100031
011100         88  PS-NOT-END-OF-EXTRACT               VALUE 'N'.       01110031
011110     05  PS-RECORD-TYPE-SW           PIC  X(01)    VALUE 'B'.     01111031
011120         88  PS-ERROR-RECORD                       VALUE 'A'.     01112031
011130         88  PS-DETAIL-RECORD                      VALUE 'B'.     01113031
011140                                                                  01114031
011150                                                                  01115031
011160 01  PC-PROGRAM-CONSTANTS.                                        01116031
011170     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08) VALUE 'SUKUT039'.   01117031
011180     05  PC-CURRENT-TIMESTAMP      PIC  X(26) VALUE SPACES.       01118031
011190                                                                  01119031
011200 01  PV-PROGRAM-VARIABLES.                                        01120031
011300     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01130031
011400     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01140031
011500     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     01150031
011600                                                   COMP SYNC.     01160031
011700     05  PV-DISPLAY-COUNT            PIC S9(09)    VALUE ZERO     01170031
011800                                                   COMP SYNC.     01180031
011900     05  PV-WRITE-COUNTER            PIC S9(09)    VALUE ZERO     01190031
012000                                                   COMP SYNC.     01200031
012100     05  PV-PO-NUMBER                PIC S9(09)    COMP.          01210031
012200*                                                                 01220031
012300*-----------------------------------------------------------------01230031
012400*  CURSOR TO DETERMINE ENTIRE TRIP OR SELECTED PO'S               01240031
012500*-----------------------------------------------------------------01250031
012600     EXEC SQL                                                     01260031
012700       DECLARE TRIP-CSR CURSOR FOR                                01270031
012800         SELECT DISTINCT                                          01280031
012900                PO_NBR                                            01290031
013000              , ALL_PO_IND                                        01300031
013100          FROM  TSURPRQ                                           01310031
013200**        WHERE TRIP_ID     = :DK-TRIP-ID                         01320031
013300          WHERE TRIP_ID     = :SURPRQ-TRIP-ID                     01330031
013400          AND   WRKR_USR_ID = :DK-WRKR-USER-ID                    01340031
013500          AND   RQST_TMST   = :DK-TIMESTAMP                       01350031
013600       ORDER BY PO_NBR                                            01360031
013700     END-EXEC.                                                    01370031
013800                                                                  01380031
013900                                                                  01390031
014000******************************************************************01400031
014100 PROCEDURE DIVISION.                                              01410031
014200******************************************************************01420031
014300                                                                  01430031
014400                                                                  01440031
014500*-----------------------------------------------------------------01450031
014600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01460031
014700*      PROGRAM.                                                   01470031
014800*-----------------------------------------------------------------01480031
014900 0000-PROGRAM-MAINLINE.                                           01490031
015000     ACCEPT CC-CONTROL-CARD FROM SYSIN.                           01500031
015100     DISPLAY 'CONTROL CARD = ' CC-CONTROL-CARD.                   01510031
015200     MOVE   CC-TRIP-ID       TO   DK-TRIP-ID.                     01520031
015300     MOVE   DK-TRIP-ID       TO   SURPRQ-TRIP-ID.                 01530031
015400     MOVE   CC-WRKR-USER-ID  TO   DK-WRKR-USER-ID.                01540031
015500     MOVE   CC-TIMESTAMP     TO   DK-TIMESTAMP.                   01550031
015600                                                                  01560031
015700                                                                  01570031
015800     PERFORM 1000-INITIALIZE.                                     01580031
015900     IF PS-ERROR-RECORD                                           01590031
016000         CONTINUE                                                 01600031
016100     ELSE                                                         01610031
016200         IF  PS-MORE-PRT-REQ-PO-CSR                               01620031
016300             PERFORM 2000-PROCESS-REQ-PO                          01630031
016400               UNTIL PS-END-OF-EXTRACT OR                         01640031
016500                     PS-EOF-PRT-REQ-PO-CSR                        01650031
016600         END-IF                                                   01660031
016700     END-IF.                                                      01670031
016800     PERFORM 9000-EOJ-ROUTINE.                                    01680031
016900                                                                  01690031
017000     STOP RUN.                                                    01700031
017100                                                                  01710031
017200                                                                  01720031
017300*-----------------------------------------------------------------01730031
017400*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01740031
017500*    -- OPEN OUTPUT FILE                                          01750031
017600*    -- OPEN CURSOR                                               01760031
017700*    -- FETCH CURSOR                                              01770031
017800*-----------------------------------------------------------------01780031
017900 1000-INITIALIZE.                                                 01790031
018000                                                                  01800031
018100     OPEN INPUT  EXTRACT-FILE-IN.                                 01810031
018200     OPEN OUTPUT EXTRACT-FILE-OUT.                                01820031
018300     PERFORM 3000-READ-EXTRACT.                                   01830031
018400                                                                  01840031
018500     IF PS-END-OF-EXTRACT                                         01850031
018600         DISPLAY '** SUKUT039 ABEND **'                           01860031
018700         DISPLAY '** SURD001 EXTRACT RECORD  FILE IS EMPTY **'    01870031
018800         MOVE +4019                  TO PV-ABEND-CODE             01880031
018900         CALL 'ILBOABN0' USING PV-ABEND-CODE                      01890031
019000     END-IF.                                                      01900031
019100                                                                  01910031
019200***IF ERROR RECORD WRITE AND END PROCESSING                       01920031
019201***ELSE WRITE HEADER RECORD, FETCH, AND PROCESS SELECTED PO'S     01920131
019202     IF  SU001-ERROR-RECORD                                       01920231
019203         SET PS-ERROR-RECORD  TO TRUE                             01920331
019204         PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD                   01920431
019205     ELSE                                                         01920531
019206         PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD                   01920631
019207         PERFORM 3000-READ-EXTRACT                                01920731
019208         PERFORM 2100-OPEN-TRIP-CURSOR                            01920831
019209         PERFORM 2200-FETCH-TRIP-CURSOR                           01920931
019210     END-IF.                                                      01921031
019220                                                                  01922031
019230                                                                  01923031
019240*-----------------------------------------------------------------01924031
019250*  LOOP THROUGH THE RESULTS TABLE.                                01925031
019260*  FORMAT THE OUTPUT RECORD.  WRITE THE RECORDS THAT MEET CRITERIA01926031
019270*-----------------------------------------------------------------01927031
019280 2000-PROCESS-REQ-PO.                                             01928031
019290                                                                  01929031
019300                                                                  01930031
019400     IF SURPRQ-ALL-PO-IND = 'Y'                                   01940031
019500*       PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD                    01950031
019600        SET PS-EOF-PRT-REQ-PO-CSR TO TRUE                         01960031
019700        PERFORM UNTIL PS-END-OF-EXTRACT                           01970031
019800           PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD                 01980031
019900           PERFORM 3000-READ-EXTRACT                              01990031
020000        END-PERFORM                                               02000031
020100     ELSE                                                         02010031
020200       IF SURPRQ-PO-NBR <  SU001-PO-NUMBER                        02020031
020300          PERFORM 2200-FETCH-TRIP-CURSOR                          02030031
020400*         PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD                  02040032
020500       ELSE                                                       02050031
020600          IF SURPRQ-PO-NBR =  SU001-PO-NUMBER                     02060031
020700             MOVE SU001-PO-NUMBER   TO  PV-PO-NUMBER              02070031
020800             PERFORM UNTIL SU001-PO-NUMBER NOT EQUAL              02080031
020900                           PV-PO-NUMBER OR PS-END-OF-EXTRACT      02090031
021000                PERFORM 8000-WRITE-PRT-REQ-DATA-RECORD            02100031
021100                PERFORM 3000-READ-EXTRACT                         02110031
021200             END-PERFORM                                          02120031
021300             PERFORM 2200-FETCH-TRIP-CURSOR                       02130031
021400          ELSE                                                    02140031
021500             IF SURPRQ-PO-NBR > SU001-PO-NUMBER                   02150031
021600                PERFORM 3000-READ-EXTRACT                         02160031
021700          END-IF                                                  02170031
021800       END-IF                                                     02180031
021900     END-IF.                                                      02190031
022000                                                                  02200031
022100******************************************************************02210031
022200 2100-OPEN-TRIP-CURSOR.                                           02220031
022300******************************************************************02230031
022400     EXEC SQL                                                     02240031
022500         OPEN TRIP-CSR                                            02250031
022600     END-EXEC.                                                    02260031
022700     EVALUATE TRUE                                                02270031
022800       WHEN SQLCODE = ZEROS                                       02280031
022900         CONTINUE                                                 02290031
023000       WHEN SQLWARN0 NOT = SPACES                                 02300031
023100         WHEN SQLCODE > ZERO                                      02310031
023200         WHEN SQLCODE < ZERO                                      02320031
023300             MOVE '2100-OPEN-TRIP-CURSOR '                        02330031
023400                                 TO PV-PARAGRAPH-NAME             02340031
023500             MOVE 'OPEN THE TRIP_CSR      '                       02350031
023600                                 TO PV-DB2-OPERATION-ATTEMPTED    02360031
023700             PERFORM 9100-SQL-ABEND                               02370031
023800     END-EVALUATE.                                                02380031
023900                                                                  02390031
024000******************************************************************02400031
024100 2200-FETCH-TRIP-CURSOR.                                          02410031
024200******************************************************************02420031
024300                                                                  02430031
024400     EXEC SQL                                                     02440031
024500          FETCH TRIP-CSR                                          02450031
024600          INTO  :SURPRQ-PO-NBR                                    02460031
024700              , :SURPRQ-ALL-PO-IND                                02470031
024800     END-EXEC.                                                    02480031
024900                                                                  02490031
025000     EVALUATE TRUE                                                02500031
025100       WHEN SQLCODE = ZEROS                                       02510031
025200         CONTINUE                                                 02520031
025300       WHEN SQLCODE = +100                                        02530031
025400         SET PS-EOF-PRT-REQ-PO-CSR TO TRUE                        02540031
025500       WHEN SQLWARN0 NOT = SPACES                                 02550031
025600       WHEN SQLCODE < ZERO                                        02560031
025700       WHEN SQLCODE > ZERO                                        02570031
025800           MOVE '2200-FETCH-TRIP-CURSOR    '                      02580031
025900                               TO PV-PARAGRAPH-NAME               02590031
026000           MOVE 'FETCH THE TRIP_CSR  CURSOR     '                 02600031
026100                               TO PV-DB2-OPERATION-ATTEMPTED      02610031
026200           PERFORM 9100-SQL-ABEND                                 02620031
026300     END-EVALUATE.                                                02630031
026400                                                                  02640031
026500                                                                  02650031
026600 3000-READ-EXTRACT.                                               02660031
026700     READ EXTRACT-FILE-IN INTO SU001-EXTRACT-RECORD               02670031
026800        AT END                                                    02680031
026900           SET PS-END-OF-EXTRACT TO TRUE.                         02690031
027000*                                                                 02700031
027100*-----------------------------------------------------------------02710031
027200*  WRITE THE SHIPMENT-UNIT-RECORD                                 02720031
027300*-----------------------------------------------------------------02730031
027400 8000-WRITE-PRT-REQ-DATA-RECORD.                                  02740031
027500     WRITE EXTRACT-RECORD-OUT                                     02750031
027600       FROM SU001-EXTRACT-RECORD.                                 02760031
027700                                                                  02770031
027800     ADD +1 TO PV-WRITE-COUNTER.                                  02780031
027900                                                                  02790031
028000                                                                  02800031
028100*-----------------------------------------------------------------02810031
028200*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          02820031
028300*-----------------------------------------------------------------02830031
028400 9000-EOJ-ROUTINE.                                                02840031
028500     CLOSE EXTRACT-FILE-IN                                        02850031
028600           EXTRACT-FILE-OUT.                                      02860031
028700                                                                  02870031
028800     MOVE PV-WRITE-COUNTER TO PV-DISPLAY-COUNT.                   02880031
028900     DISPLAY 'TOTL PO REQ BATCH RECORDS WRITTEN' PV-DISPLAY-COUNT 02890031
029000**FOR ERROR RECORDS, THE CURSOR IS NOT OPENED                     02900031
029100     IF PS-DETAIL-RECORD                                          02910031
029200         EXEC SQL                                                 02920031
029300              CLOSE TRIP-CSR                                      02930031
029400         END-EXEC                                                 02940031
029500                                                                  02950031
029600         EVALUATE TRUE                                            02960031
029700             WHEN SQLCODE = ZERO                                  02970031
029800                  CONTINUE                                        02980031
029900             WHEN SQLCODE = -904                                  02990031
030000             WHEN SQLCODE = -911                                  03000031
030100                  CONTINUE                                        03010031
030200             WHEN SQLWARN0 NOT = SPACES                           03020031
030300             WHEN SQLCODE < ZERO                                  03030031
030400             WHEN SQLCODE > ZERO                                  03040031
030500                  MOVE '9000-EOJ-ROUTINE               '          03050031
030600                                     TO PV-PARAGRAPH-NAME         03060031
030700                  MOVE 'CLOSE THE TRIP-CSR              '         03070031
030800                                     TO PV-DB2-OPERATION-ATTEMPTED03080031
030900                  PERFORM 9100-SQL-ABEND                          03090031
031000         END-EVALUATE                                             03100031
031100     END-IF.                                                      03110031
031200                                                                  03120031
031300                                                                  03130031
031400*-----------------------------------------------------------------03140031
031500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03150031
031600*  ERROR OR WARNING CODE OCCURS.                                  03160031
031700*-----------------------------------------------------------------03170031
031800 9100-SQL-ABEND.                                                  03180031
031900     DISPLAY '9100-SQL-ABEND'.                                    03190031
032000     DISPLAY '** ABEND     **'.                                   03200031
032100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03210031
032200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03220031
032300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03230031
032400                                                                  03240031
032500******************************************************************03250031
032600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03260031
032700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03270031
032800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03280031
032900* FORMAT.                                                         03290031
033000******************************************************************03300031
033100     COPY DPPD004.                                                03310031
033200                                                                  03320031
033300     MOVE +4013                  TO ABEND-CODE.                   03330031
033400     CALL 'ILBOABN0' USING ABEND-CODE.                            03340031
