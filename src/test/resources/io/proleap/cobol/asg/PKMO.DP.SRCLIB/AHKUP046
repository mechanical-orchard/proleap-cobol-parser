000500 IDENTIFICATION DIVISION.                                         00050001
000600 PROGRAM-ID.         AHKUP046.                                    00060001
000700 AUTHOR.             PATRICK BURKE.                               00070001
000800 DATE-WRITTEN.       MAY 2000.                                    00080001
000900 DATE-COMPILED.                                                   00090001
001000*************************************************************     00100001
001100*    COBOL 2 WITH SQL                                       *     00110001
001200*                                                           *     00120001
001300*   AHKUP046 - ARCHIVE HISTORY DATA DELETION - TPKITEM      *     00130001
001400*                                                           *     00140001
001500*   PROGRAM OVERVIEW:                                       *     00150001
001600*                                                           *     00160001
001700*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPKITEM.  *     00170001
001800*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00180001
001900*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00190001
002000*                                                           *     00200001
002100*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00210001
002200*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00220001
002300*  THESE COLUMNS ARE PO_NBR, SEQ_NBR, PKSL_LNE_NBR,         *     00230006
002310*  CRE_TMST.                                                *     00231006
002400*                                                           *     00240001
002500*                                                           *     00250001
002600*   INPUT:                                                  *     00260001
002700*                                                           *     00270001
002800*     1. TPKITEM DELETION FILE  COPYBOOK DCLTPKITEM         *     00280001
002900*                                                           *     00290001
003000*   DB2 TABLES:                                             *     00300001
003100*                                                           *     00310001
003200*        TPKITEM - RECEIVING HEADER TABLE                   *     00320001
003300*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00330001
003400*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00340001
003500*                                                           *     00350001
003600*************************************************************     00360001
003700*                                                           *     00370001
003800*************************************************************     00380001
003900 EJECT                                                            00390001
004000 ENVIRONMENT DIVISION.                                            00400001
004100 CONFIGURATION SECTION.                                           00410001
004200 SOURCE-COMPUTER.        IBM-370.                                 00420001
004300 OBJECT-COMPUTER.        IBM-370.                                 00430001
004400                                                                  00440001
004500 INPUT-OUTPUT SECTION.                                            00450001
004600 FILE-CONTROL.                                                    00460001
004700     SELECT TPKITEM-EXTRACT-FILE ASSIGN TO INP01.                 00470001
004800                                                                  00480001
004900 DATA DIVISION.                                                   00490001
005000 FILE SECTION.                                                    00500001
005100 FD  TPKITEM-EXTRACT-FILE                                         00510001
005200     RECORDING MODE IS F                                          00520001
005300     LABEL RECORDS ARE STANDARD                                   00530001
005400     BLOCK CONTAINS 0 RECORDS                                     00540001
005500     RECORD CONTAINS  53 CHARACTERS                               00550012
005600     DATA RECORD IS TPKITEM-EXTRACT-DATA.                         00560001
005700 01  TPKITEM-EXTRACT-DATA       PIC X(53).                        00570012
005800                                                                  00580001
005900                                                                  00590001
006000 EJECT                                                            00600001
006100 WORKING-STORAGE SECTION.                                         00610001
006200                                                                  00620001
006300 01  FILLER                       PIC X(58)     VALUE             00630001
006400     '************WORKING STORAGE STARTS HERE*******************'.00640001
006500                                                                  00650001
006600 01  PV-PROGRAM-VARIABLES.                                        00660001
006700     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP046'.  00670002
006800     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00680001
006900     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00690001
007000     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00700001
007100                                                                  00710001
007200     05  PV-TPKITEM-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00720002
007300                                               COMP-3.            00730001
007400     05  PV-TPKITEM-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00740002
007500                                               COMP-3.            00750001
007600     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00760001
007700                                               COMP-3.            00770001
007800     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00780001
007900                                               COMP-3.            00790001
008000     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00800006
008010     05  PV-DISP-SEQ-NBR          PIC X(09)    VALUE SPACES.      00801002
008100     05  PV-DISP-PKSL-LNE-NBR     PIC X(09)    VALUE SPACES.      00810002
008300     05  PV-DISP-CRE-TMST         PIC X(10)    VALUE SPACES.      00830006
008500 01  PC-PROGRAM-CONSTANTS.                                        00850001
008600     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00860001
008700                                                COMP SYNC.        00870001
008800     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00880001
008900     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00890001
009000     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00900001
009100                                                                  00910001
009200 01  PS-PROGRAM-SWITCHES.                                         00920001
009300     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00930001
009400         88  COMMITS-TAKEN                      VALUE 'T'.        00940001
009500         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00950001
009600     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00960001
009700         88  MORE-EXTRACT                       VALUE 'M'.        00970001
009800         88  END-OF-EXTRACT                     VALUE 'E'.        00980001
009900     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00990001
010000         88  NORMAL-RUN                         VALUE '0'.        01000001
010100         88  RESTART-RUN                        VALUE '9'.        01010001
010200                                                                  01020001
010300 01  WS-COUNTER.                                                  01030001
010400     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01040001
010500     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01050001
010600                                                                  01060001
010700 01  CKPT-RESTART-INFO.                                           01070001
010800     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01080001
010900                                                                  01090001
011000*----------------------------------------------------------------*01100001
011100*  ABEND DATA AREAS                                              *01110001
011200*----------------------------------------------------------------*01120001
011300 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01130001
011400                                             COMP SYNC.           01140001
011500     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01150001
011600     88  AC-BAD-DATA                         VALUE +4008.         01160001
011700     88  AC-DB2-ERROR                        VALUE +4013.         01170001
011800     88  AC-DATE-ERROR                       VALUE +4019.         01180001
011900                                                                  01190001
012000                                                                  01200001
012100 01  ABEND-AREAS.                                                 01210001
012200     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01220001
012300             '*****       ABEND'.                                 01230001
012400     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01240001
012500             '*****   PROGRAM: AHKUP046'.                         01250003
012600     05  AA-PARAGRAPH-LIT.                                        01260001
012700         10  FILLER              PIC  X(17)  VALUE                01270001
012800             '***** PARAGRAPH: '.                                 01280001
012900         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01290001
013000     05  AA-MESSAGE-LINE-1.                                       01300001
013100         10  FILLER              PIC  X(06)  VALUE '*****'.       01310001
013200         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01320001
013300     05  AA-MESSAGE-LINE-2.                                       01330001
013400         10  FILLER              PIC  X(06)  VALUE '*****'.       01340001
013500         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01350001
013600     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01360001
013700             '*****    DB2 ERROR'.                                01370001
013800     05  AA-DB2-OPERATION-LIT.                                    01380001
013900         10  FILLER              PIC  X(17)  VALUE                01390001
014000             '***** OPERATION: '.                                 01400001
014100         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01410001
014200     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01420001
014300     EJECT                                                        01430001
014400                                                                  01440001
014500     COPY DPWS004.                                                01450001
014600     EJECT                                                        01460001
014700*----------------------------------------------------------------*01470001
014800*      TPKITEM TABLE LAYOUT                                       01480003
014900*----------------------------------------------------------------*01490001
015000         EXEC SQL                                                 01500001
015100             INCLUDE TPKITEM                                      01510003
015200         END-EXEC.                                                01520001
015300                                                                  01530001
015400*----------------------------------------------------------------*01540001
015500*      TCKRSTCNTL TABLE LAYOUT                                    01550001
015600*----------------------------------------------------------------*01560001
015700         EXEC SQL                                                 01570001
015800             INCLUDE TCKRSTCN                                     01580001
015900         END-EXEC.                                                01590001
016000                                                                  01600001
016100*----------------------------------------------------------------*01610001
016200*      TCKRSTINF TABLE LAYOUT                                     01620001
016300*----------------------------------------------------------------*01630001
016400         EXEC SQL                                                 01640001
016500             INCLUDE TCKRSTIN                                     01650001
016600         END-EXEC.                                                01660001
016700 EJECT                                                            01670001
016800*----------------------------------------------------------------*01680001
016900*  DB2 COMMUNICATION AREA                                         01690001
017000*----------------------------------------------------------------*01700001
017100*                                                                 01710001
017200     EXEC SQL                                                     01720001
017300         INCLUDE SQLCA                                            01730001
017400     END-EXEC.                                                    01740001
017500                                                                  01750001
017600*----------------------------------------------------------------*01760001
017700*  DB2 COMMUNICATION AREA2                                        01770001
017800*----------------------------------------------------------------*01780001
017900*                                                                 01790001
018000     COPY SQLCA2.                                                 01800001
018100     EJECT                                                        01810001
018200 PROCEDURE DIVISION.                                              01820001
018300 A100-MAINLINE-ROUTINE.                                           01830001
018400                                                                  01840001
018500     PERFORM B100-INITIALIZATION.                                 01850001
018600                                                                  01860001
018700     PERFORM B200-TPKITEM-EXTRACT-PROCESS                         01870003
018800       UNTIL END-OF-EXTRACT.                                      01880001
018900                                                                  01890001
019000     PERFORM B300-EOJ-PROCESSING.                                 01900001
019100                                                                  01910001
019200     GOBACK.                                                      01920001
019300 EJECT                                                            01930001
019400 B100-INITIALIZATION.                                             01940001
019500                                                                  01950001
019600     EXEC SQL                                                     01960001
019700         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01970001
019800     END-EXEC.                                                    01980001
019900                                                                  01990001
020000     PERFORM X300-GET-CHECKPOINT-CNTL.                            02000001
020100     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02010001
020200                                                                  02020001
020300     OPEN INPUT TPKITEM-EXTRACT-FILE.                             02030003
020400                                                                  02040001
020500     IF RESTART-RUN                                               02050001
020600         PERFORM X200-CHECKPOINT-RESTART                          02060001
020700     ELSE                                                         02070001
020800         PERFORM R100-READ-EXTRACT-FILE                           02080001
020900     END-IF.                                                      02090001
021000                                                                  02100001
021100     PERFORM X500-SET-CHECKPOINT-TIME.                            02110001
021200                                                                  02120001
021300                                                                  02130001
021400     EJECT                                                        02140001
021500 B200-TPKITEM-EXTRACT-PROCESS.                                    02150003
021600                                                                  02160001
021700     MOVE PKITEM-PO-NBR             TO PV-DISP-PO-NBR.            02170003
021800     MOVE PKITEM-SEQ-NBR            TO PV-DISP-SEQ-NBR.           02180003
021810     MOVE PKITEM-PKSL-LNE-NBR       TO PV-DISP-PKSL-LNE-NBR.      02181003
021900     MOVE PKITEM-CRE-TMST           TO PV-DISP-CRE-TMST.          02190003
022000                                                                  02200001
022100     PERFORM D100-DELETE-TPKITEM.                                 02210003
022200                                                                  02220001
022300     PERFORM X100-CHECKPOINT-CHECK.                               02230001
022400                                                                  02240001
022500     PERFORM R100-READ-EXTRACT-FILE.                              02250001
022600     EJECT                                                        02260001
022700                                                                  02270001
022800                                                                  02280001
022900 B300-EOJ-PROCESSING.                                             02290001
023000                                                                  02300001
023100     DISPLAY '** AHKUP046 SUMMARY **'.                            02310003
023200     DISPLAY '** TPKITEM INPUT COUNT = ' PV-TPKITEM-INPUT-COUNT.  02320003
023300     DISPLAY '** TPKITEM DELETE COUNT = ' PV-TPKITEM-DELETE-COUNT.02330004
023400     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02340001
023500                                                                  02350001
023600     CLOSE  TPKITEM-EXTRACT-FILE.                                 02360004
023700                                                                  02370001
023800     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02380001
023900     PERFORM X600-UPDATE-TCKRSTCNTL.                              02390001
024000                                                                  02400001
024100     EJECT                                                        02410001
024200*----------------------------------------------------------------*02420001
024300*    DELETES FROM THE TPKITEM TABLE. NO OTHER TABLES REFERENCE   *02430004
024400*    THIS TABLE.                                                 *02440001
024500*----------------------------------------------------------------*02450001
024600 D100-DELETE-TPKITEM.                                             02460004
024700                                                                  02470001
024800     MOVE 'D100-DELETE-TPKITEM' TO PV-CURRENT-PARAGRAPH.          02480004
024900                                                                  02490001
025000     PERFORM WITH TEST AFTER                                      02500001
025100        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02510001
025200          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02520001
025300             OR SQLCODE = ZERO                                    02530001
025400                                                                  02540001
025500         EXEC SQL                                                 02550001
025600              DELETE                                              02560001
025700                FROM TPKITEM                                      02570010
025800               WHERE PO_NBR       = :PKITEM-PO-NBR                02580010
025900                 AND SEQ_NBR      = :PKITEM-SEQ-NBR               02590010
025910                 AND PKSL_LNE_NBR = :PKITEM-PKSL-LNE-NBR          02591010
026000                 AND CRE_TMST     = :PKITEM-CRE-TMST              02600010
026100         END-EXEC                                                 02610001
026200                                                                  02620001
026300         EVALUATE TRUE                                            02630001
026400             WHEN SQLCODE = ZERO                                  02640001
026500                 ADD 1 TO PV-TPKITEM-DELETE-COUNT                 02650004
026600                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02660013
026700                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02670001
026800                                                                  02680001
026900             WHEN SQLCODE = -904                                  02690001
027000             WHEN SQLCODE = -913                                  02700001
027100                  CONTINUE                                        02710001
027200                                                                  02720001
027300             WHEN SQLCODE = +100                                  02730001
027400                 MOVE PV-CURRENT-PARAGRAPH                        02740001
027500                                     TO AA-PARAGRAPH-NAME         02750001
027600                 DISPLAY '******** PO NBR:'                       02760001
027700                          PV-DISP-PO-NBR                          02770001
027800                 DISPLAY '******** SEQ NBR:'                      02780001
027900                          PV-DISP-SEQ-NBR                         02790001
027910                 DISPLAY '******** PKSL LNE NBR:'                 02791004
027920                          PV-DISP-PKSL-LNE-NBR                    02792004
028000                 DISPLAY '******** CRE TMST:'                     02800001
028100                          PV-DISP-CRE-TMST                        02810001
028200                 MOVE 'ROW NOT ON TABLE ********'                 02820001
028300                          TO AA-MESSAGE-1                         02830001
028400                 MOVE SPACES TO AA-MESSAGE-2                      02840001
028500                 MOVE 'UNSUCCESSFUL DELETE'                       02850001
028600                          TO AA-DB2-OPERATION                     02860001
028700                 MOVE 'TPKITEM'  TO AA-DB2-TABLE                  02870004
028800                 PERFORM Z999-DB2-ABEND                           02880001
028900             WHEN SQLWARN0 NOT = SPACES                           02890001
029000             WHEN SQLCODE  NOT = ZERO                             02900001
029100                 MOVE PV-CURRENT-PARAGRAPH                        02910001
029200                                     TO AA-PARAGRAPH-NAME         02920001
029300                 DISPLAY '******** PO NBR:'                       02930001
029400                          PV-DISP-PO-NBR                          02940001
029500                 DISPLAY '******** SEQ NBR:'                      02950001
029600                          PV-DISP-SEQ-NBR                         02960001
029610                 DISPLAY '******** PKSL LNE NBR:'                 02961004
029620                          PV-DISP-PKSL-LNE-NBR                    02962004
029700                 DISPLAY '******** CRE TMST:'                     02970001
029800                          PV-DISP-CRE-TMST                        02980001
029900                 MOVE SPACES TO AA-MESSAGE-1                      02990001
030000                                AA-MESSAGE-2                      03000001
030100                 MOVE 'UNSUCCESSFUL DELETE'                       03010001
030200                                     TO AA-DB2-OPERATION          03020001
030300                 MOVE 'TPKITEM'      TO AA-DB2-TABLE              03030004
030400                 PERFORM Z999-DB2-ABEND                           03040001
030500         END-EVALUATE                                             03050001
030600     END-PERFORM.                                                 03060001
030700                                                                  03070001
030800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03080001
030900         MOVE PV-CURRENT-PARAGRAPH                                03090001
031000                             TO AA-PARAGRAPH-NAME                 03100001
031100         DISPLAY '******** PO NBR:'                               03110001
031200                          PV-DISP-PO-NBR                          03120001
031300         DISPLAY '******** SEQ NBR:'                              03130001
031400                          PV-DISP-SEQ-NBR                         03140001
031410         DISPLAY '******** PKSL LNE NBR:'                         03141004
031420                          PV-DISP-PKSL-LNE-NBR                    03142004
031500         DISPLAY '******** CRE TMST:'                             03150001
031600                          PV-DISP-CRE-TMST                        03160001
031700         MOVE SPACES TO AA-MESSAGE-1                              03170001
031800                        AA-MESSAGE-2                              03180001
031900         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03190001
032000                             TO AA-DB2-OPERATION                  03200001
032100         MOVE 'TPKITEM'      TO AA-DB2-TABLE                      03210004
032200         PERFORM Z999-DB2-ABEND                                   03220001
032300     END-IF.                                                      03230001
032400                                                                  03240001
032500     EJECT                                                        03250001
032600 R100-READ-EXTRACT-FILE.                                          03260001
032700                                                                  03270001
032800     READ TPKITEM-EXTRACT-FILE                                    03280009
032900          INTO DCLTPKITEM                                         03290004
033000          AT END SET END-OF-EXTRACT TO TRUE.                      03300001
033100                                                                  03310001
033200     IF MORE-EXTRACT                                              03320001
033300         ADD 1 TO PV-TPKITEM-INPUT-COUNT                          03330004
033400     END-IF.                                                      03340001
033500                                                                  03350001
033600                                                                  03360001
033700     EJECT                                                        03370001
033800*----------------------------------------------------------------*03380001
033900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03390001
034000*----------------------------------------------------------------*03400001
034100 X100-CHECKPOINT-CHECK.                                           03410001
034200                                                                  03420001
034300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03430001
034400                                                                  03440001
034500     EXEC SQL                                                     03450001
034600       SET :WS-TMST = CURRENT TIMESTAMP                           03460001
034700     END-EXEC.                                                    03470001
034800                                                                  03480001
034900     IF SQLCODE = +0                                              03490001
035000         CONTINUE                                                 03500001
035100     ELSE                                                         03510001
035200         MOVE PV-CURRENT-PARAGRAPH                                03520001
035300                             TO AA-PARAGRAPH-NAME                 03530001
035400         MOVE SPACES TO AA-MESSAGE-1                              03540001
035500                        AA-MESSAGE-2                              03550001
035600         MOVE 'BAD SET COMMAND'                                   03560001
035700                             TO AA-DB2-OPERATION                  03570001
035800         MOVE SPACES             TO AA-DB2-TABLE                  03580001
035900         PERFORM Z999-DB2-ABEND                                   03590001
036000     END-IF.                                                      03600001
036100                                                                  03610001
036200     IF WS-TMST > WS-HOLD-TMST                                    03620001
036300         IF NO-COMMITS-TAKEN                                      03630001
036400             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03640001
036500             PERFORM X600-UPDATE-TCKRSTCNTL                       03650001
036600             SET COMMITS-TAKEN TO TRUE                            03660001
036700         END-IF                                                   03670001
036800         PERFORM X700-UPDATE-TCKRSTINF                            03680001
036900         PERFORM Y100-COMMIT                                      03690001
037000         PERFORM X500-SET-CHECKPOINT-TIME                         03700001
037100     END-IF.                                                      03710001
037200                                                                  03720001
037300 EJECT                                                            03730001
037400*----------------------------------------------------------------*03740001
037500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03750001
037600*----------------------------------------------------------------*03760001
037700 X200-CHECKPOINT-RESTART.                                         03770001
037800                                                                  03780001
037900     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03790001
038000                                                                  03800001
038100     PERFORM X400-GET-CHECKPOINT-INFO.                            03810001
038200     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03820001
038300                                                                  03830001
038400     DISPLAY '** AHKUP046 CHECKPOINT RESTART **'                  03840007
038500     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03850001
038600              CR-EXTRACT-RECS-WORKED.                             03860001
038700     DISPLAY '***********************************************'    03870001
038800                                                                  03880001
038900     PERFORM R100-READ-EXTRACT-FILE                               03890001
039000         CR-EXTRACT-RECS-WORKED TIMES.                            03900001
039100     PERFORM R100-READ-EXTRACT-FILE.                              03910001
039200 EJECT                                                            03920001
039300*----------------------------------------------------------------*03930001
039400*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03940001
039500*----------------------------------------------------------------*03950001
039600 X300-GET-CHECKPOINT-CNTL.                                        03960001
039700                                                                  03970001
039800     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     03980001
039900                                                                  03990001
040000     PERFORM WITH TEST AFTER                                      04000001
040100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04010001
040200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04020001
040300                     SQLCODE = ZERO                               04030001
040400                                                                  04040001
040500             EXEC SQL                                             04050001
040600              SELECT CKPT_STAT_CODE                               04060001
040700               INTO :PV-CKPT-STAT-CODE                            04070001
040800               FROM TCKRSTCNTL                                    04080001
040900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04090001
041000             END-EXEC                                             04100001
041100                                                                  04110001
041200             EVALUATE TRUE                                        04120001
041300                 WHEN SQLCODE = ZERO                              04130001
041400                 WHEN SQLCODE = -904                              04140001
041500                 WHEN SQLCODE = -913                              04150001
041600                      CONTINUE                                    04160001
041700                                                                  04170001
041800                 WHEN SQLWARN0 NOT = SPACES                       04180001
041900                 WHEN SQLCODE  NOT = ZERO                         04190001
042000                     MOVE PV-CURRENT-PARAGRAPH                    04200001
042100                                         TO AA-PARAGRAPH-NAME     04210001
042200                     DISPLAY '******** PLAN_NAME:'                04220001
042300                              PV-PROGRAM-NAME                     04230001
042400                     MOVE SPACES TO AA-MESSAGE-1                  04240001
042500                                    AA-MESSAGE-2                  04250001
042600                     MOVE 'UNSUCCESSFUL SELECT'                   04260001
042700                                         TO AA-DB2-OPERATION      04270001
042800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04280001
042900                     PERFORM Z999-DB2-ABEND                       04290001
043000             END-EVALUATE                                         04300001
043100     END-PERFORM.                                                 04310001
043200                                                                  04320001
043300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04330001
043400         MOVE PV-CURRENT-PARAGRAPH                                04340001
043500                             TO AA-PARAGRAPH-NAME                 04350001
043600         DISPLAY '******** PLAN_NAME:'                            04360001
043700                  PV-PROGRAM-NAME                                 04370001
043800         MOVE SPACES TO AA-MESSAGE-1                              04380001
043900                        AA-MESSAGE-2                              04390001
044000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04400001
044100                             TO AA-DB2-OPERATION                  04410001
044200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04420001
044300         PERFORM Z999-DB2-ABEND                                   04430001
044400     END-IF.                                                      04440001
044500                                                                  04450001
044600 EJECT                                                            04460001
044700*----------------------------------------------------------------*04470001
044800*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04480001
044900*----------------------------------------------------------------*04490001
045000 X400-GET-CHECKPOINT-INFO.                                        04500001
045100                                                                  04510001
045200     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04520001
045300                                                                  04530001
045400     PERFORM WITH TEST AFTER                                      04540001
045500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04550001
045600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04560001
045700                     SQLCODE = ZERO                               04570001
045800                                                                  04580001
045900             EXEC SQL                                             04590001
046000              SELECT WORK_STRG_DESC                               04600001
046100               INTO :TCKRSTINF-WORK-STRG-DESC                     04610001
046200               FROM TCKRSTINF                                     04620001
046300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04630001
046400             END-EXEC                                             04640001
046500                                                                  04650001
046600             EVALUATE TRUE                                        04660001
046700                 WHEN SQLCODE = ZERO                              04670001
046800                 WHEN SQLCODE = -904                              04680001
046900                 WHEN SQLCODE = -913                              04690001
047000                      CONTINUE                                    04700001
047100                                                                  04710001
047200                 WHEN SQLWARN0 NOT = SPACES                       04720001
047300                 WHEN SQLCODE  NOT = ZERO                         04730001
047400                     MOVE PV-CURRENT-PARAGRAPH                    04740001
047500                                         TO AA-PARAGRAPH-NAME     04750001
047600                     DISPLAY '******** PLAN_NAME:'                04760001
047700                              PV-PROGRAM-NAME                     04770001
047800                     MOVE SPACES TO AA-MESSAGE-1                  04780001
047900                                    AA-MESSAGE-2                  04790001
048000                     MOVE 'UNSUCCESSFUL SELECT'                   04800001
048100                                         TO AA-DB2-OPERATION      04810001
048200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04820001
048300                     PERFORM Z999-DB2-ABEND                       04830001
048400             END-EVALUATE                                         04840001
048500     END-PERFORM.                                                 04850001
048600                                                                  04860001
048700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04870001
048800         MOVE PV-CURRENT-PARAGRAPH                                04880001
048900                             TO AA-PARAGRAPH-NAME                 04890001
049000         DISPLAY '******** PLAN_NAME:'                            04900001
049100                  PV-PROGRAM-NAME                                 04910001
049200         MOVE SPACES TO AA-MESSAGE-1                              04920001
049300                        AA-MESSAGE-2                              04930001
049400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04940001
049500                             TO AA-DB2-OPERATION                  04950001
049600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      04960001
049700         PERFORM Z999-DB2-ABEND                                   04970001
049800     END-IF.                                                      04980001
049900                                                                  04990001
050000 EJECT                                                            05000001
050100*----------------------------------------------------------------*05010001
050200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05020001
050300*----------------------------------------------------------------*05030001
050400 X500-SET-CHECKPOINT-TIME.                                        05040001
050500                                                                  05050001
050600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05060001
050700                                                                  05070001
050800     PERFORM WITH TEST AFTER                                      05080001
050900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05090001
051000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05100001
051100                     SQLCODE = ZERO                               05110001
051200                                                                  05120001
051300             EXEC SQL                                             05130001
051400              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05140001
051500               INTO :WS-HOLD-TMST                                 05150001
051600               FROM TCKRSTCNTL                                    05160001
051700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05170001
051800             END-EXEC                                             05180001
051900                                                                  05190001
052000             EVALUATE TRUE                                        05200001
052100                 WHEN SQLCODE = ZERO                              05210001
052200                 WHEN SQLCODE = -904                              05220001
052300                 WHEN SQLCODE = -913                              05230001
052400                      CONTINUE                                    05240001
052500                                                                  05250001
052600                 WHEN SQLWARN0 NOT = SPACES                       05260001
052700                 WHEN SQLCODE  NOT = ZERO                         05270001
052800                     MOVE PV-CURRENT-PARAGRAPH                    05280001
052900                                         TO AA-PARAGRAPH-NAME     05290001
053000                     DISPLAY '******** PLAN_NAME:'                05300001
053100                              PV-PROGRAM-NAME                     05310001
053200                     MOVE SPACES TO AA-MESSAGE-1                  05320001
053300                                    AA-MESSAGE-2                  05330001
053400                     MOVE 'UNSUCCESSFUL SELECT'                   05340001
053500                                         TO AA-DB2-OPERATION      05350001
053600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05360001
053700                     PERFORM Z999-DB2-ABEND                       05370001
053800             END-EVALUATE                                         05380001
053900     END-PERFORM.                                                 05390001
054000                                                                  05400001
054100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05410001
054200         MOVE PV-CURRENT-PARAGRAPH                                05420001
054300                             TO AA-PARAGRAPH-NAME                 05430001
054400         DISPLAY '******** PLAN_NAME:'                            05440001
054500                  PV-PROGRAM-NAME                                 05450001
054600         MOVE SPACES TO AA-MESSAGE-1                              05460001
054700                        AA-MESSAGE-2                              05470001
054800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05480001
054900                             TO AA-DB2-OPERATION                  05490001
055000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05500001
055100         PERFORM Z999-DB2-ABEND                                   05510001
055200     END-IF.                                                      05520001
055300                                                                  05530001
055400 EJECT                                                            05540001
055500*----------------------------------------------------------------*05550001
055600*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05560001
055700*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05570001
055800*----------------------------------------------------------------*05580001
055900 X600-UPDATE-TCKRSTCNTL.                                          05590001
056000                                                                  05600001
056100     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05610001
056200                                                                  05620001
056300     PERFORM WITH TEST AFTER                                      05630001
056400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05640001
056500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05650001
056600                     SQLCODE = ZERO                               05660001
056700                                                                  05670001
056800             EXEC SQL                                             05680001
056900                 UPDATE TCKRSTCNTL                                05690001
057000                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05700001
057100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05710001
057200             END-EXEC                                             05720001
057300                                                                  05730001
057400             EVALUATE TRUE                                        05740001
057500                 WHEN SQLCODE = ZERO                              05750001
057600                 WHEN SQLCODE = -904                              05760001
057700                 WHEN SQLCODE = -913                              05770001
057800                      CONTINUE                                    05780001
057900                                                                  05790001
058000                 WHEN SQLWARN0 NOT = SPACES                       05800001
058100                 WHEN SQLCODE  NOT = ZERO                         05810001
058200                     MOVE PV-CURRENT-PARAGRAPH                    05820001
058300                                         TO AA-PARAGRAPH-NAME     05830001
058400                     DISPLAY '******** PLAN_NAME:'                05840001
058500                              PV-PROGRAM-NAME                     05850001
058600                     MOVE SPACES TO AA-MESSAGE-1                  05860001
058700                                    AA-MESSAGE-2                  05870001
058800                     MOVE 'UNSUCCESSFUL UPDATE'                   05880001
058900                                         TO AA-DB2-OPERATION      05890001
059000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05900001
059100                     PERFORM Z999-DB2-ABEND                       05910001
059200             END-EVALUATE                                         05920001
059300     END-PERFORM.                                                 05930001
059400                                                                  05940001
059500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05950001
059600         MOVE PV-CURRENT-PARAGRAPH                                05960001
059700                             TO AA-PARAGRAPH-NAME                 05970001
059800         DISPLAY '******** PLAN_NAME:'                            05980001
059900                  PV-PROGRAM-NAME                                 05990001
060000         MOVE SPACES TO AA-MESSAGE-1                              06000001
060100                        AA-MESSAGE-2                              06010001
060200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06020001
060300                             TO AA-DB2-OPERATION                  06030001
060400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06040001
060500         PERFORM Z999-DB2-ABEND                                   06050001
060600     END-IF.                                                      06060001
060700                                                                  06070001
060800     EJECT                                                        06080001
060900*----------------------------------------------------------------*06090001
061000*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06100001
061100*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06110001
061200*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06120001
061300*----------------------------------------------------------------*06130001
061400 X700-UPDATE-TCKRSTINF.                                           06140001
061500                                                                  06150001
061600     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06160001
061700                                                                  06170001
061800     MOVE PV-TPKITEM-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06180008
061900     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06190001
062000     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06200001
062100                                                                  06210001
062200     PERFORM WITH TEST AFTER                                      06220001
062300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06230001
062400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06240001
062500                     SQLCODE = ZERO                               06250001
062600                                                                  06260001
062700             EXEC SQL                                             06270001
062800                 UPDATE TCKRSTINF                                 06280001
062900                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06290001
063000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06300001
063100             END-EXEC                                             06310001
063200                                                                  06320001
063300             EVALUATE TRUE                                        06330001
063400                 WHEN SQLCODE = ZERO                              06340001
063500                 WHEN SQLCODE = -904                              06350001
063600                 WHEN SQLCODE = -913                              06360001
063700                      CONTINUE                                    06370001
063800                                                                  06380001
063900                 WHEN SQLWARN0 NOT = SPACES                       06390001
064000                 WHEN SQLCODE  NOT = ZERO                         06400001
064100                     MOVE PV-CURRENT-PARAGRAPH                    06410001
064200                                         TO AA-PARAGRAPH-NAME     06420001
064300                     DISPLAY '******** PLAN_NAME:'                06430001
064400                              PV-PROGRAM-NAME                     06440001
064500                     MOVE SPACES TO AA-MESSAGE-1                  06450001
064600                                    AA-MESSAGE-2                  06460001
064700                     MOVE 'UNSUCCESSFUL UPDATE'                   06470001
064800                                         TO AA-DB2-OPERATION      06480001
064900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06490001
065000                     PERFORM Z999-DB2-ABEND                       06500001
065100             END-EVALUATE                                         06510001
065200     END-PERFORM.                                                 06520001
065300                                                                  06530001
065400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06540001
065500         MOVE PV-CURRENT-PARAGRAPH                                06550001
065600                             TO AA-PARAGRAPH-NAME                 06560001
065700         DISPLAY '******** PLAN_NAME:'                            06570001
065800                  PV-PROGRAM-NAME                                 06580001
065900         MOVE SPACES TO AA-MESSAGE-1                              06590001
066000                        AA-MESSAGE-2                              06600001
066100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06610001
066200                             TO AA-DB2-OPERATION                  06620001
066300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06630001
066400         PERFORM Z999-DB2-ABEND                                   06640001
066500     END-IF.                                                      06650001
066600                                                                  06660001
066700 EJECT                                                            06670001
066800                                                                  06680001
066900*----------------------------------------------------------------*06690001
067000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06700001
067100*----------------------------------------------------------------*06710001
067200 Y100-COMMIT.                                                     06720001
067300                                                                  06730001
067400     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06740001
067500                                                                  06750001
067600     EXEC SQL                                                     06760001
067700         COMMIT                                                   06770001
067800     END-EXEC.                                                    06780001
067900                                                                  06790001
068000     EVALUATE TRUE                                                06800001
068100         WHEN SQLCODE = ZEROS                                     06810001
068200             CONTINUE                                             06820001
068300         WHEN OTHER                                               06830001
068400             MOVE PV-CURRENT-PARAGRAPH                            06840001
068500                                 TO AA-PARAGRAPH-NAME             06850001
068600             MOVE SPACES TO AA-MESSAGE-1                          06860001
068700                            AA-MESSAGE-2                          06870001
068800             MOVE 'UNSUCCESSFUL COMMIT'                           06880001
068900                                 TO AA-DB2-OPERATION              06890001
069000             MOVE SPACES         TO AA-DB2-TABLE                  06900001
069100             PERFORM Z999-DB2-ABEND                               06910001
069200     END-EVALUATE.                                                06920001
069300 EJECT                                                            06930001
069400 Z900-PROCESS-ABEND.                                              06940001
069500                                                                  06950001
069600     DISPLAY '*** ABEND'.                                         06960001
069700     DISPLAY '*** PROGRAM   = AHKUP046'.                          06970004
069800     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             06980001
069900     DISPLAY AA-MESSAGE-LINE-1.                                   06990001
070000     DISPLAY AA-MESSAGE-LINE-2.                                   07000001
070100     COPY DPPD004.                                                07010001
070200     CALL 'ILBOABN0' USING ABEND-CODE.                            07020001
070300                                                                  07030001
070400                                                                  07040001
070500                                                                  07050001
070600 Z999-DB2-ABEND.                                                  07060001
070700                                                                  07070001
070800     DISPLAY AA-ABEND-LIT.                                        07080001
070900     DISPLAY AA-DB2-ERROR-LIT.                                    07090001
071000     DISPLAY AA-PROGRAM-LIT.                                      07100001
071100     DISPLAY AA-PARAGRAPH-LIT.                                    07110001
071200     DISPLAY AA-DB2-OPERATION-LIT.                                07120001
071300     DISPLAY AA-DB2-TABLE.                                        07130001
071400     SET AC-DB2-ERROR TO TRUE.                                    07140001
071500                                                                  07150001
071600     COPY DPPD004.                                                07160001
071700                                                                  07170001
071800     CALL 'ILBOABN0' USING ABEND-CODE.                            07180001
