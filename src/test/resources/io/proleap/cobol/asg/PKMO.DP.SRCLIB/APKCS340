000100*-----------------------*                                         00010090
000200 IDENTIFICATION DIVISION.                                         00020090
000300*-----------------------*                                         00030090
000400 PROGRAM-ID.    APKCS340.                                         00040090
000500 AUTHOR.        CHRIS KUNSTMANN - IBS.                            00050090
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060090
000700 DATE-WRITTEN.  04-29-97.                                         00070090
000800 DATE-COMPILED.                                                   00080090
000900                                                                  00090090
001000*---------------------------------------------------------------* 00100090
001100*    TRANID      - A340                                         * 00110090
001200*    DESCRIPTION - AP - IMPORT INVOICE PAY RELEASE              * 00120090
001300*    MAPSET      - APKM340                                      * 00130090
001400*                                                               * 00140090
001500*    THIS PROGRAM WILL PAY RELEASE, OR REVERSE, MERCHANDISE     * 00150090
001600*    INVOICES FOR IMPORT PO'S. INVOICES DISPLAYED WILL HAVE     * 00160090
001700*    THE STATUS OF (EN, OB, RC, IB, OR BM). IF ANY OF THE       * 00170090
001800*    INVOICES DISPLAYED ARE IN STATUS OB OR IB, NONE OF THE     * 00180090
001900*    INVOICES CAN BE RELEASED. RELEASING THE INVOICES CHANGES   * 00190090
002000*    THE STATUS TO 'BM'. AN OPTION IS AVAILABLE TO UNRELEASE    * 00200090
002100*    ALL BM INVOICES. IF ANY OF THE INVOICES DISPLAYED ARE IN   * 00210090
002200*    STATUS OB OR IB, NONE OF THEM CAN BE UNRELEASED. THE       * 00220090
002300*    STATUS WILL BE CHANGED TO 'EN', NO MATTER WHAT THE         * 00230090
002400*    ORIGINAL STATUS WAS.                                       * 00240090
002500*                                                               * 00250090
002600*---------------------------------------------------------------* 00260090
002700* CHANGE LOG:                                                   * 00270090
002800*  8/25/97   INITIAL VERSION.                                   * 00280090
002900*                                                               * 00290090
003000* 04/10/00 - ADDED 'IE' AS AN ADDITIONAL VALUE IN PARA 1100-    * 00300092
003100*            WHEN CHECKING THE PO TYPE CODE FOR IMPORT TYPES.   * 00310092
003200*            THIS IS PART OF THE PO TEAMS PROJECT OF ADDING     * 00320092
003300*            4 NEW PO TYPE CODES TO TPURCHS.                    * 00330092
003400*        BY: MIKE BESKE                             WR #: 20997 * 00340093
003500*                                                               * 00350094
003600* 04/13/00 - ADDED 'IF' AS AN ADDITIONAL VALUE IN PARA 1100-    * 00360094
003700*            WHEN CHECKING THE PO TYPE CODE FOR IMPORT TYPES.   * 00370094
003800*        BY: MIKE BESKE                             WR #: 20997 * 00380094
003900*                                                               * 00390099
004000* 09/25/01 - ADDED A SQL THAT ISSUES A WARNING MESSAGE WHEN     * 00400099
004100*            THERE ARE EXPENSE INVOICES ARE IN PENDING STATUS   * 00410099
004200*            FOR THE PO THAT IS BEING RELEASED.  THE USER MAY   * 00420099
004300*            WANT TO DEFER RELEASING THIS PO UNTIL THE PENDING  * 00430099
004400*            STATUS IS REMOVED, SO THE WARNING WILL GIVE THEM   * 00440099
004500*            THE OPTION OF GOING AHEAD WITH THE RELEASE OR      * 00450099
004600*            CANCELING IT. (PARAS 2000-, 4350-)                 * 00460099
004700*        BY: MIKE BESKE                             WR #: 20530 * 00470099
004800*                                                               * 00480099
004900* 08/24/02 - ARK PO PROJECT PHASE 2.  REMOVED TALCHRG TABLE     * 00490099
005000*            FROM PROGRAM AS IT'S NOT BEING USED.               * 00500099
005100*        BY: KEVIN CATLIN                   WR #: 23500         * 00510099
005200*                                                               * 00520099
005300* 09/03/02 - COLBY DATING PROJECT.                              * 00530099
005400*            ADDED 'PJ' AS A NEW STATUS CODE FOR IMPORT MI'S    * 00540099
005500*            THAT CAN BE SET TO 'BM' (BATCH MATCH) STATUS. ALSO * 00550099
005600*            IF THE MI'S ARE IN A 'BM' STATUS AND ARE UNRELEASED* 00560099
005700*            THEN THE STATUS WILL BE SET BACK TO 'EN' IF THE    * 00570099
005800*            CREATE DATE = CURRENT DATE, OTHERWISE IT WILL BE   * 00580099
005900*            SET TO 'PJ'.  TPAYREQ WAS REMOVED FROM THE PROGRAM.* 00590099
006000*        BY: MIKE BESKE                       WR #: 23750       * 00600099
006100*                                                               * 00610099
006200* 10/17/02 - COLBY DATING PROJECT.                              * 00620099
006300*            CHANGED CODE IN PARAGRAPH 2000 DEALING WITH PAY    * 00630099
006400*            RELEASING (PF13).  WHEN THERE ARE INVOICES FOR A   * 00640099
006500*            PO IN 'PR' STATUS, THE PO WILL NOT BE ALLOWED TO   * 00650099
006600*            BE PAY RELEASED.                                   * 00660099
006700*        BY: KEVIN CATLIN                     WR #: 23750       * 00670099
006800*                                                               * 00680099
006900* 12/17/02 - ADDED LENGTH PARAMETER TO READQ AND WRITEQ         * 00690099
007000*            STATEMENTS TO TRY TO PREVENT THE LENGTHERR AND     * 00700099
007100*            ASRA ABENDS THAT KEEP OCCURRING.                   * 00710099
007200*        BY: NANCY EILBES                     IR #: P00514025   * 00720099
007300*                                                               * 00730099
007400* 04/23/04 - INCREASED THE LENGTH OF THE STORE NUMBER SCREEN    * 00740099
007500*            OUTPUT VARIABLE TO DISPLAY 4 DIGITS AS PART OF     * 00750099
007600*            THE STORE CONSTRAINTS PROJECT.                     * 00760099
007700*        BY: MIKE BESKE                       WR #: 25805       * 00770099
007710*                                                               * 00771099
007720* 11/03/06 - MODIFIED PARAGRAPH 6000-MODIFY-TEMPSTOR-QUEUE TO   * 00772099
007730*            SET THE STATUS TO 'EN' FOR AN UNRELEASE FOR ANY    * 00773099
007740*            VENDOR OTHER THAN LI & FUNG.  FOR LI & FUNG, IF    * 00774099
007741*            THE CREATE DATE EQUALS THE CURRENT DATE THEN THE   * 00774199
007742*            STATUS IS SET TO 'EN' OTHERWISE IT IS SET TO       * 00774299
007743*            'PJ' FOR AN UNRELEASE.                             * 00774399
007750*        BY: ROLF NOHE                        WR #: P00939689   * 00775099
007760* 10/30/14 - CHANGE MADE: PO EXTENDED DIGIT CHANGES.            * 00776099
007770*            EXTENDED PO# FROM 7 TO 9                           * 00777099
007780*        BY: COGNIZANT                        WR #: CHG0094517  * 00778099
007781*                                                               * 00778199
007790* DATE  09/01/2021                                                00779099
007791*            - CHANGE CALL OF  DPKUT100  TO                     * 00779199
007792*              CALL DP010I-NUMERIC-EDIT-ROUTINE                 * 00779299
007793*              MAKING THE CALL DYNAMIC VS STATIC                * 00779399
007794*     MADE BY: GERMAN BANDA            WR/IR #: CHG0261053        00779499
007795* DATE  10/24/2022                                              * 00779599
007796*     ADD COPYBOOK DPWS930                                      * 00779699
007797*     CHANGE CICS ARCHITECTURE CALL TO USE DP930-CICS-ARCH-API  * 00779799
007798*     MADE BY: BOB MCASEY              WR/IR #: CHG0276864      * 00779899
007795* DATE  12/11/2023                                              * 00779999
007796*     FOR AN UNRELEASE, INFOR NEXUS INVOICES WILL BE PROCESSED  * 00780099
007797*     THE SAME AS LI & FUNG                                     * 00780199
007798*     MADE BY: JEAN KURK               WR/IR #: CHG0297720      * 00780299
007799*---------------------------------------------------------------* 00780399
007800*---------------------------------------------------------------* 00781090
007900                                                                  00790090
008000 ENVIRONMENT DIVISION.                                            00800090
008100                                                                  00810090
008200 DATA DIVISION.                                                   00820090
008300                                                                  00830090
008400 WORKING-STORAGE SECTION.                                         00840090
008500                                                                  00850090
008600 01  PC-PROGRAM-CONSTANTS.                                        00860090
008700     05  PC-CURRENT-MAP-NAME            PIC  X(08)  VALUE         00870090
008800                                                    'AP340A  '.   00880090
008900     05  PC-CURRENT-MAPSET-NAME         PIC  X(08)  VALUE         00890090
009000                                                    'APKM340 '.   00900090
009100     05  PC-CURRENT-PROGRAM-NAME        PIC  X(08)  VALUE         00910090
009200                                                    'APKCS340'.   00920090
009100     05  PC-INFOR-NEXUS                 PIC  X(03)  VALUE '1NX'.  00921099
009300     05  PC-ITEMS-PER-PANEL             PIC S9(04)  VALUE +14     00930090
009400                                                    COMP SYNC.    00940090
009500     05  PC-MAX-BLOCKS-IN-ARRAY         PIC S9(04)  VALUE +2      00950090
009600                                                    COMP SYNC.    00960090
009700     05  PC-MAX-ITEMS                   PIC S9(09)  VALUE         00970090
009800                                                    +1000000      00980090
009900                                                    COMP-3.       00990090
010000     05  PC-MSG-NUMBER-LENGTH           PIC S9(04)  VALUE +5      01000090
010100                                                    COMP SYNC.    01010090
010200     05  PC-MAX-RETRIES                 PIC S9(3)    VALUE 3      01020090
010300                                                     COMP-3.      01030090
010400                                                                  01040090
010500 01  PC-TSYMSG-NUMBERS.                                           01050090
010600     05  PC-TSYMSG-00004                PIC 9(5)    VALUE 00004.  01060090
010700     05  PC-TSYMSG-00007                PIC 9(5)    VALUE 00007.  01070090
010800     05  PC-TSYMSG-00008                PIC 9(5)    VALUE 00008.  01080090
010900     05  PC-TSYMSG-00016                PIC 9(5)    VALUE 00016.  01090090
011000     05  PC-TSYMSG-00046                PIC 9(5)    VALUE 00046.  01100090
011100     05  PC-TSYMSG-00050                PIC 9(5)    VALUE 00050.  01110090
011200     05  PC-TSYMSG-00059                PIC 9(5)    VALUE 00059.  01120090
011300     05  PC-TSYMSG-00069                PIC 9(5)    VALUE 00069.  01130090
011400     05  PC-TSYMSG-00070                PIC 9(5)    VALUE 00070.  01140090
011500     05  PC-TSYMSG-00101                PIC 9(5)    VALUE 00101.  01150090
011600     05  PC-TSYMSG-00170                PIC 9(5)    VALUE 00170.  01160090
011700     05  PC-TSYMSG-00279                PIC 9(5)    VALUE 00279.  01170090
011800     05  PC-TSYMSG-00587                PIC 9(5)    VALUE 00587.  01180090
011900     05  PC-TSYMSG-00726                PIC 9(5)    VALUE 00726.  01190090
012000     05  PC-TSYMSG-00807                PIC 9(5)    VALUE 00807.  01200090
012100     05  PC-TSYMSG-02740                PIC 9(5)    VALUE 02740.  01210096
012200                                                                  01220090
012210 01  PC-LI-FUNG-VENDOR-NBR.                                       01221099
012220     05  PC-LI-FUNG-NBR                 PIC 9(09)   VALUE 9206194.01222099
012230                                                                  01223099
012300 01  PS-PROGRAM-SUBSCRIPTS.                                       01230090
012400     05  PS-SUB                         PIC S9(04)   VALUE +0     01240090
012500                                                     COMP SYNC.   01250090
012600 01  PS-PROGRAM-SWITCHES.                                         01260090
012700     05  PS-ERROR-SW                    PIC X(01)    VALUE 'N'.   01270090
012800         88  PS-NO-ERROR                             VALUE 'N'.   01280090
012900         88  PS-ERROR                                VALUE 'Y'.   01290090
013000     05  PS-COMMAREA-SW                 PIC X(01)    VALUE 'N'.   01300090
013100         88  PS-COMMAREA-VALID                       VALUE 'Y'.   01310090
013200         88  PS-COMMAREA-NOT-VALID                   VALUE 'N'.   01320090
013300     05  PS-TPURCHS-FOUND-SW            PIC X(01)    VALUE 'N'.   01330090
013400         88  PS-TPURCHS-FOUND                        VALUE 'Y'.   01340090
013500         88  PS-TPURCHS-NOT-FOUND                    VALUE 'N'.   01350090
013300     05  PS-INFOR-NEXUS-SW              PIC X(01)    VALUE 'N'.   01351099
013400         88  PS-INFOR-NEXUS-YES                      VALUE 'Y'.   01352099
013400         88  PS-INFOR-NEXUS-NO                       VALUE 'N'.   01353099
013600                                                                  01360090
013700 01  PV-PROGRAM-VARIABLES.                                        01370090
013800     05  PV-RETRY-COUNTER               PIC S9(04)  VALUE +0      01380090
013900                                                    COMP SYNC.    01390090
014000     05  PV-REMAINDER                   PIC S9(04)   VALUE +0     01400090
014100                                                     COMP SYNC.   01410090
014200     05  PV-READ-COUNT                  PIC S9(09)   VALUE +0     01420090
014300                                                     COMP-3.      01430090
014400     05  PV-TOP-ITEM                    PIC S9(09)   VALUE +0     01440090
014500                                                     COMP-3.      01450090
014600     05  PV-BOTTOM-ITEM                 PIC S9(09)   VALUE +0     01460090
014700                                                     COMP-3.      01470090
014800     05  PV-BLOCK-NUMBER                PIC S9(04)   VALUE +0     01480090
014900                                                     COMP SYNC.   01490090
015000     05  PV-QUEUE-LENGTH                PIC S9(04)   VALUE +896   01500099
015100                                                     COMP SYNC.   01510099
015200     05  PV-CICS-RESP                   PIC S9(04)   VALUE +0     01520090
015300                                                     COMP SYNC.   01530090
015400     05  PV-HIGHEST-BLOCK-WRITTEN       PIC S9(04)   VALUE +0     01540090
015500                                                     COMP SYNC.   01550090
015600     05  PV-ITEM-NUMBER                 PIC S9(04)   VALUE +0     01560090
015700                                                     COMP SYNC.   01570090
015800     05  PV-STR-NBR                     PIC S9(04)   VALUE +0.    01580099
015900     05  PV-NEW-STATUS                  PIC  X(02)   VALUE SPACE. 01590090
016000     05  PV-INVC-ID                     PIC X(22)   VALUE SPACES. 01600099
016100     05  PV-ONE                         PIC X(01)   VALUE SPACES. 01610099
016200     05  PV-SQL-SUB                     PIC S9(4)    COMP.        01620090
016300     05  PV-DATE-FORMAT-DB2.                                      01630090
016400         10  PV-DATE-DB2-CC             PIC X(02)   VALUE SPACES. 01640090
016500         10  PV-DATE-DB2-YY             PIC X(02)   VALUE SPACES. 01650090
016600         10  FILLER                     PIC X(01)   VALUE SPACES. 01660090
016700         10  PV-DATE-DB2-MM             PIC X(02)   VALUE SPACES. 01670090
016800         10  FILLER                     PIC X(01)   VALUE SPACES. 01680090
016900         10  PV-DATE-DB2-DD             PIC X(02)   VALUE SPACES. 01690090
017000     05  PV-DATE-FORMAT.                                          01700090
017100         10  PV-DATE-MM                 PIC X(02)   VALUE SPACES. 01710090
017200         10  FILLER                     PIC X(01)   VALUE '/'.    01720090
017300         10  PV-DATE-DD                 PIC X(02)   VALUE SPACES. 01730090
017400         10  FILLER                     PIC X(01)   VALUE '/'.    01740090
017500         10  PV-DATE-CC                 PIC X(02)   VALUE SPACES. 01750090
017600         10  PV-DATE-YY                 PIC X(02)   VALUE SPACES. 01760090
017700                                                                  01770090
017800 01  PV-DB2-CRITERIA-AREA.                                        01780090
017900     15  PV-DB2-MESSAGE-NUMBER          PIC S9(05)  VALUE ZERO    01790090
018000                                                    COMP-3.       01800090
018100                                                                  01810090
018200                                                                  01820090
018300*---------------------------------------------------------------* 01830090
018400*    PARAMETERS FOR CALLING CICS ARCHITECTURE API (DPKCS030).   * 01840090
018500*---------------------------------------------------------------* 01850090
018600                                                                  01860090
018700     COPY DPWS030.                                                01870090
018710     COPY DPWS930.                                                01871099
018800                                                                  01880090
018900*---------------------------------------------------------------* 01890090
019000*    STANDARD COMMAREA.                                         * 01900090
019100*---------------------------------------------------------------* 01910090
019200                                                                  01920090
019300     COPY DPWS020.                                                01930090
019400     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                01940090
019500                                                                  01950090
019600*---------------------------------------------------------------* 01960090
019700*    INTER-APPLICATION COMMAREA.                                * 01970090
019800*---------------------------------------------------------------* 01980090
019900                                                                  01990090
020000         10  INTER-APPL-COMM-AREA       PIC X(200).               02000090
020100     COPY APWS300.                                                02010090
020200*---------------------------------------------------------------* 02020090
020300*    SPECIFIC COMMMAREA FOR APKCS340.                           * 02030090
020400*---------------------------------------------------------------* 02040090
020500         10  ASC-SPECIFIC-COMMAREA.                               02050090
020600             15  ASC-SWITCHS.                                     02060090
020700                 20 ASC-REQUEST-SW                   PIC X(03).   02070090
020800                     88 ASC-RELEASE-REQUESTED         VALUE 'RLS'.02080097
020900                     88 ASC-UNRELEAS-REQUESTED        VALUE 'UNR'.02090097
021000                     88 ASC-UPDATE-COMPLETED          VALUE 'CMP'.02100097
021100                 20  ASC-ITEMS-LEFT-INDICATOR        PIC  X(01).  02110090
021200                     88  ASC-ITEMS-LEFT-ON-DB           VALUE 'Y'.02120097
021300                     88  ASC-NO-ITEMS-LEFT-ON-DB        VALUE 'N'.02130097
021400                 20  ASC-PENDING-EXPINVC-FOUND-SW    PIC  X(01).  02140097
021500                     88  ASC-PENDING-EXPINVC-FOUND      VALUE 'Y'.02150097
021600                     88  ASC-PENDING-EXPINVC-NOT-FOUND  VALUE 'N'.02160097
021700                 20  ASC-BAD-DATA-SW                 PIC  X(01).  02170090
021800                     88  ASC-BAD-DATA                   VALUE 'Y'.02180097
021900                     88  ASC-NO-BAD-DATA                VALUE 'N'.02190097
022000                     88  ASC-UPD-DATA                   VALUE 'U'.02200097
022100                                                                  02210090
022200             15  ASC-KEYS.                                        02220090
022300                 20  ASC-KEY-PO-NBR                  PIC S9(09)   02230090
022400                                                     COMP.        02240090
022500                 20  ASC-ALP-PO-NBR                  PIC  9(9).   02250099
022600                                                                  02260090
022700             15  ASC-BLOCK-ENTRIES OCCURS 2 TIMES.                02270090
022800                 20  ASC-ITEM-ARRAY.                              02280090
022900                     25  ASC-ITEM-ENTRIES OCCURS 14 TIMES.        02290090
023000                         30  ASC-ITEM-NUMBER         PIC S9(09)   02300090
023100                                                     COMP-3.      02310090
023200                         30  ASC-ITEM-UPD-SW         PIC  X.      02320090
023300                             88  ASC-ITEM-UPD       VALUE 'Y'.    02330090
023400                         30  ASC-INVC-NBR            PIC  X(22).  02340090
023500                         30  ASC-INVC-DTE            PIC  X(10).  02350090
023600                         30  ASC-STR-NBR             PIC S9(04)   02360090
023700                                                          COMP.   02370090
023800                         30  ASC-TYPE                PIC  X(02).  02380090
023900                         30  ASC-ENTR-MTHD           PIC  X(02).  02390090
024000                         30  ASC-STATUS              PIC  X(02).  02400090
024100                             88  ASC-STATUS-BM      VALUE 'BM'.   02410090
024200                             88  ASC-STATUS-EN      VALUE 'EN'.   02420090
024300                             88  ASC-STATUS-PJ      VALUE 'PJ'.   02430099
024400                         30  ASC-NEW-STATUS          PIC  X(02).  02440090
024500                             88  ASC-NEW-BM         VALUE 'BM'.   02450090
024600                             88  ASC-NEW-EN         VALUE 'EN'.   02460090
024700                             88  ASC-NEW-PJ         VALUE 'PJ'.   02470099
024800                         30  ASC-GROSS-AMT          PIC S9(09)V99 02480090
024900                                                          COMP-3. 02490090
025000                         30  ASC-CRE-DTE             PIC  X(10).  02500099
025100                                                                  02510090
025200             15  ASC-BLK-SUB                         PIC S9(04)   02520090
025300                                                         COMP     02530090
025400                                                         SYNC.    02540090
025500             15  ASC-ITEM-SUB                        PIC S9(04)   02550090
025600                                                         COMP     02560090
025700                                                         SYNC.    02570090
025800             15  ASC-NUMBER-OF-ITEMS-READ            PIC S9(09)   02580090
025900                                                         COMP-3.  02590090
026000             15  ASC-ITEMS-UPDATED                   PIC S9(03)   02600090
026100                                                         COMP-3.  02610090
026200             15  ASC-ITEM-AT-TOP-OF-PANEL            PIC S9(09)   02620090
026300                                                         COMP-3.  02630090
026400             15  ASC-ITEM-AT-BOT-OF-PANEL            PIC S9(09)   02640090
026500                                                         COMP-3.  02650090
026600             15  ASC-HIGHEST-BLOCK-WRITTEN           PIC S9(04)   02660090
026700                                                         COMP     02670090
026800                                                         SYNC.    02680090
026900             15  ASC-QUEUE-NAME.                                  02690090
027000                 20  ASC-TERM-ID                     PIC  X(04).  02700090
027100                 20  ASC-TASK-NUMBER                 PIC S9(05)   02710090
027200                                                         COMP-3.  02720090
027300                 20  ASC-SEQ                         PIC  9(01).  02730090
027400                                                                  02740090
027500             15  ASC-START-ITEM-REQUEST.                          02750090
027600                 20  ASC-START-ITEM-REQUEST-N        PIC  9(05).  02760090
027700             15  ASC-OTHER-FILEDS.                                02770090
027800                 20  ASC-VENDOR-NBR               PIC  9(09).     02780090
027900                 20  ASC-VENDOR-NAME              PIC  X(14).     02790090
028000                 20  ASC-CURRENT-TIMESTAMP        PIC  X(26).     02800090
028100                 20  ASC-CURRENT-DATE             PIC  X(10).     02810099
028200                                                                  02820090
028300                                                                  02830090
028400*---------------------------------------------------------------* 02840090
028500*    MESSAGE SELECTION TSQ B QUEUE RECORD LAYOUT.               * 02850090
028600*---------------------------------------------------------------* 02860090
028700                                                                  02870090
028800     COPY DPWS057.                                                02880090
028900                                                                  02890090
029000                                                                  02900090
029100*---------------------------------------------------------------* 02910090
029200*    ABEND PROCESSING COPYBOOK.                                 * 02920090
029300*---------------------------------------------------------------* 02930090
029400                                                                  02940090
029500     COPY DPWS013.                                                02950090
029600                                                                  02960090
029700                                                                  02970090
029800*---------------------------------------------------------------* 02980090
029900*    ATTRIBUTE SETTINGS COPYBOOK.                               * 02990090
030000*---------------------------------------------------------------* 03000090
030100                                                                  03010090
030200     COPY DPWS015.                                                03020090
030300                                                                  03030090
030400*---------------------------------------------------------------* 03040090
030500*    FUNCTION KEYS COPYBOOK.                                    * 03050090
030600*---------------------------------------------------------------* 03060090
030700                                                                  03070090
030800     COPY DPWS016.                                                03080090
030900                                                                  03090090
031000*---------------------------------------------------------------* 03100090
031100*    NUMERIC EDIT LAYOUT.                                       * 03110090
031200*---------------------------------------------------------------* 03120090
031300                                                                  03130090
031400     COPY DPWS010I.                                               03140090
031500                                                                  03150090
031600*---------------------------------------------------------------* 03160090
031700*    MAP LAYOUT                                                 * 03170090
031800*---------------------------------------------------------------* 03180090
031900                                                                  03190090
032000     COPY APKM340.                                                03200090
032100                                                                  03210090
032200 01  MR-OCCURS-LAYOUT            REDEFINES  AP340AO.              03220090
032300     05  FILLER                  PIC X(95).                       03230090
032400     05  MR-SCROLL-AREA     OCCURS 14 TIMES.                      03240090
032500                                                                  03250090
032600         10  MR-INVC-NBRL        PIC S9(04) COMP.                 03260090
032700         10  MR-INVC-NBRA        PIC  X(01).                      03270090
032800         10  MR-INVC-NBRC        PIC  X(01).                      03280090
032900         10  MR-INVC-NBRH        PIC  X(01).                      03290090
033000         10  MR-INVC-NBR         PIC  X(14).                      03300090
033100                                                                  03310090
033200         10  MR-INVC-DTEL        PIC S9(04) COMP.                 03320090
033300         10  MR-INVC-DTEA        PIC  X(01).                      03330090
033400         10  MR-INVC-DTEC        PIC  X(01).                      03340090
033500         10  MR-INVC-DTEH        PIC  X(01).                      03350090
033600         10  MR-INVC-DTE         PIC  X(10).                      03360090
033700                                                                  03370090
033800         10  MR-STR-NBRL         PIC S9(04) COMP.                 03380090
033900         10  MR-STR-NBRA         PIC  X(01).                      03390090
034000         10  MR-STR-NBRC         PIC  X(01).                      03400090
034100         10  MR-STR-NBRH         PIC  X(01).                      03410090
034200         10  MR-STR-NBR-X.                                        03420090
034300             15  MR-STR-NBR-N    PIC  9(04).                      03430099
034400                                                                  03440090
034500         10  MR-TYPEL            PIC S9(04) COMP.                 03450090
034600         10  MR-TYPEA            PIC  X(01).                      03460090
034700         10  MR-TYPEC            PIC  X(01).                      03470090
034800         10  MR-TYPEH            PIC  X(01).                      03480090
034900         10  MR-TYPE             PIC  X(02).                      03490090
035000                                                                  03500090
035100         10  MR-ENTR-MTHDL       PIC S9(04) COMP.                 03510090
035200         10  MR-ENTR-MTHDA       PIC  X(01).                      03520090
035300         10  MR-ENTR-MTHDC       PIC  X(01).                      03530090
035400         10  MR-ENTR-MTHDH       PIC  X(01).                      03540090
035500         10  MR-ENTR-MTHD        PIC  X(02).                      03550090
035600                                                                  03560090
035700         10  MR-STATUSL          PIC S9(04) COMP.                 03570090
035800         10  MR-STATUSA          PIC  X(01).                      03580090
035900         10  MR-STATUSC          PIC  X(01).                      03590090
036000         10  MR-STATUSH          PIC  X(01).                      03600090
036100         10  MR-STATUS           PIC  X(02).                      03610090
036200                                                                  03620090
036300         10  MR-GROSS-AMTL       PIC S9(04) COMP.                 03630090
036400         10  MR-GROSS-AMTA       PIC  X(01).                      03640090
036500         10  MR-GROSS-AMTC       PIC  X(01).                      03650090
036600         10  MR-GROSS-AMTH       PIC  X(01).                      03660090
036700         10  MR-GROSS-AMT-X.                                      03670090
036800             15  MR-GROSS-AMT-N  PIC  Z,ZZZ,ZZ9.99.               03680090
036900                                                                  03690090
037000         10  MR-ENTR-DTEL        PIC S9(04) COMP.                 03700090
037100         10  MR-ENTR-DTEA        PIC  X(01).                      03710090
037200         10  MR-ENTR-DTEC        PIC  X(01).                      03720090
037300         10  MR-ENTR-DTEH        PIC  X(01).                      03730090
037400         10  MR-ENTR-DTE         PIC  X(10).                      03740090
037500                                                                  03750090
037600                                                                  03760090
037700*---------------------------------------------------------------* 03770090
037800*    DB2 AREA FOR INVOICE TABLE                                 * 03780090
037900*---------------------------------------------------------------* 03790090
038000     EXEC SQL                                                     03800090
038100          INCLUDE TINVOIC                                         03810090
038200     END-EXEC.                                                    03820090
038300                                                                  03830090
038400*---------------------------------------------------------------* 03840090
038500*    DB2 AREA FOR PURCHASE TABLE                                * 03850090
038600*---------------------------------------------------------------* 03860090
038700     EXEC SQL                                                     03870090
038800          INCLUDE TPURCHS                                         03880090
038900     END-EXEC.                                                    03890090
039000                                                                  03900090
039100*---------------------------------------------------------------* 03910090
039200*    DB2 AREA FOR MERCHANDISE INVOICE TABLE                     * 03920099
039300*---------------------------------------------------------------* 03930090
039400     EXEC SQL                                                     03940090
039500          INCLUDE TMDINVC                                         03950099
039600     END-EXEC.                                                    03960090
039700                                                                  03970090
039100*---------------------------------------------------------------* 03971099
039200*    DB2 AREA FOR EXTERNAL ENTERPRISE TABLE                     * 03972099
039300*---------------------------------------------------------------* 03973099
039400     EXEC SQL                                                     03974099
039500          INCLUDE TEXTENT                                         03975099
039600     END-EXEC.                                                    03976099
039700                                                                  03977099
039800*---------------------------------------------------------------* 03980090
039900*    DB2 AREA FOR EXTERNAL ENTERPRISE NAME TABLE                * 03990090
040000*---------------------------------------------------------------* 04000090
040100     EXEC SQL                                                     04010090
040200          INCLUDE TENTNME                                         04020090
040300     END-EXEC.                                                    04030090
040400                                                                  04040090
040500*---------------------------------------------------------------* 04050099
040600*    DB2 AREA FOR SYSDUMMY1                                     * 04060099
040700*---------------------------------------------------------------* 04070099
040800     EXEC SQL                                                     04080099
040900          INCLUDE SYSDUMMY                                        04090099
041000     END-EXEC.                                                    04100099
041100                                                                  04110099
041200*---------------------------------------------------------------* 04120090
041300*    DB2 AREA FOR COMMUNICATIONS                                * 04130090
041400*---------------------------------------------------------------* 04140090
041500     EXEC SQL                                                     04150090
041600          INCLUDE SQLCA                                           04160090
041700     END-EXEC.                                                    04170090
041800                                                                  04180090
041900*---------------------------------------------------------------* 04190090
042000*    CURSOR WHEN PO NUMBER IS PROVIDED                          * 04200090
042100*---------------------------------------------------------------* 04210090
042200                                                                  04220090
042300     EXEC SQL                                                     04230090
042400          DECLARE INVOICE-CSR CURSOR                              04240090
042500          FOR SELECT                                              04250090
042600                INVC_ID                                           04260099
042700               ,INVC_DTE                                          04270099
042800               ,STR_NBR                                           04280099
042900               ,INVC_TYP_CDE                                      04290099
043000               ,ENTR_MTHD_CDE                                     04300099
043100               ,STATUS_CDE                                        04310099
043200               ,GRO_COST_AMT                                      04320099
043300               ,CRE_DTE                                           04330099
043400          FROM  TINVOIC                                           04340099
043500          WHERE PO_NBR         = :ASC-KEY-PO-NBR                  04350099
043600            AND STATUS_CDE    IN ( 'EN', 'RC', 'OB',              04360099
043700                                   'IB', 'BM', 'PJ')              04370099
043800            AND INVC_TYP_CDE   = 'MI'                             04380099
043900          ORDER BY                                                04390099
044000                INVC_ID                                           04400099
044100     END-EXEC.                                                    04410090
044200                                                                  04420090
044300                                                                  04430096
044400 LINKAGE SECTION.                                                 04440096
044500                                                                  04450090
044600 01  DFHCOMMAREA.                                                 04460090
044700     05  FILLER                         OCCURS  1 TO 4072 TIMES   04470090
044800                                        DEPENDING ON EIBCALEN.    04480090
044900         10  FILLER                     PIC X.                    04490090
045000                                                                  04500090
045100                                                                  04510090
045200 PROCEDURE DIVISION.                                              04520090
045300                                                                  04530090
045400 0000-MAIN-MODULE.                                                04540090
045500                                                                  04550090
045600     INITIALIZE DP030-CICS-API-FIELDS.                            04560090
045700     MOVE +1                      TO DP030-NUMBER-OF-MAPS.        04570090
045800     MOVE PC-CURRENT-MAPSET-NAME  TO DP030-MAPSET-NAME.           04580090
045900     MOVE PC-CURRENT-MAP-NAME     TO DP030-MAP-NAME (1).          04590090
046000     SET DP030-RECEIVE-APPL-MAP   TO TRUE.                        04600090
046100     MOVE LENGTH OF AP340AI       TO DP030-MAP-LENGTH (1).        04610090
046200     MOVE 'PROGRAM ENTRY CALL'    TO DP013-MESSAGE-TEXT (1).      04620090
046300     PERFORM 0001-CALL-CICS-ARCH-API.                             04630090
046400                                                                  04640090
046500     PERFORM 1000-CONTROL-PROCESSING.                             04650090
046600                                                                  04660090
046700     MOVE 'PROGRAM EXIT CALL'     TO DP013-MESSAGE-TEXT (1).      04670090
046800     PERFORM 0001-CALL-CICS-ARCH-API.                             04680090
046900                                                                  04690090
047000*----------------------------------------------------------------*04700090
047100*   THIS PARAGRAPH CALLS THE CICS ARCHITECTURE API SUBROUTINE    *04710090
047200*   AND WILL ABEND IF ANY ERRORS OCCURRED IN THAT CALL.          *04720090
047300*----------------------------------------------------------------*04730090
047400                                                                  04740090
047500 0001-CALL-CICS-ARCH-API.                                         04750090
047600                                                                  04760090
047700     CALL DP930-CICS-ARCH-API  USING DFHEIBLK                     04770099
047800                                     DFHCOMMAREA                  04780099
047900                                     DP030-CICS-API-FIELDS        04790099
048000                                     DP020-STANDARD-COMMAREA      04800099
048100                                     AP340AI.                     04810099
048200                                                                  04820090
048300     IF  DP030-RC-CALL-SUCCESSFUL                                 04830090
048400         CONTINUE                                                 04840090
048500     ELSE                                                         04850090
048600         SET DP013-NO-ROLLBACK   TO TRUE                          04860090
048700         SET DP013-XCTL-DISPLAY-RESTART TO TRUE                   04870090
048800         SET DP013-CICS-ABEND    TO TRUE                          04880090
048900         MOVE 'BEFORE 0000-MAIN-MODULE' TO DP013-PARAGRAPH        04890090
049110         MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O04911099
049120-             'N NEXT LINE'      TO DP013-MESSAGE-TEXT (2)        04912099
049200         MOVE DP030-RETURN-CODE  TO DP013-MESSAGE-TEXT (3)        04920090
049300         PERFORM DP013-0000-PROCESS-ABEND                         04930090
049400     END-IF.                                                      04940090
049500                                                                  04950090
049600*----------------------------------------------------------------*04960090
049700* PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT      *04970090
049800* COURSE OF ACTION IS FOR THIS TRANSACTION.                      *04980090
049900*                                                                *04990090
050000* NOTE:  PV-TOP-ITEM IS THE ITEM THAT IS REQUESTED TO BE AT THE  *05000090
050100*  TOP OF THE PANEL.  MOVING ASC-ITEM-AT-TOP-OF-PANEL TO THIS    *05010090
050200*  MEANS THAT POSITION WITHIN THE LIST WILL NOT CHANGE -- THIS   *05020090
050300*  IS THE DEFAULT WHICH WILL BE OVERRIDDEN BY SCROLLING ACTIONS. *05030090
050400*----------------------------------------------------------------*05040090
050500                                                                  05050090
050600 1000-CONTROL-PROCESSING.                                         05060090
050700                                                                  05070090
050800     EVALUATE TRUE                                                05080090
050900         WHEN DP020-NEXT-ACT-INITIAL                              05090090
051000             INITIALIZE ASC-SPECIFIC-COMMAREA                     05100090
051100             MOVE EIBTRMID          TO ASC-TERM-ID                05110090
051200             MOVE DP020-SRC-TASK-NUMBER                           05120090
051300                                    TO ASC-TASK-NUMBER            05130090
051400             MOVE 1                 TO ASC-SEQ                    05140090
051500             PERFORM 1100-PROCESS-INTER-APPL-COMM                 05150090
051600             IF  PS-COMMAREA-NOT-VALID                            05160090
051700               OR PS-ERROR                                        05170090
051800                 SET DP020-NEXT-ACT-APPL-ERROR                    05180090
051900                               TO  TRUE                           05190090
052000             ELSE                                                 05200090
052100                 PERFORM 2050-DELETE-QUEUE                        05210090
052200                 PERFORM 4000-BUILD-INITIAL-PANEL                 05220090
052300             END-IF                                               05230090
052400                                                                  05240090
052500         WHEN DP020-NEXT-ACT-READ-MAP                             05250090
052600             MOVE ASC-ITEM-AT-TOP-OF-PANEL                        05260090
052700                               TO PV-TOP-ITEM                     05270090
052800             PERFORM 2000-PROCESS-PANEL                           05280090
052900                                                                  05290090
053000         WHEN DP020-NEXT-ACT-RETURN                               05300090
053100             MOVE ASC-ITEM-AT-TOP-OF-PANEL                        05310090
053200                               TO PV-TOP-ITEM                     05320090
053300             MOVE ZERO         TO ASC-ITEM-AT-TOP-OF-PANEL        05330090
053400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 05340090
053500                                                                  05350090
053600         WHEN OTHER                                               05360090
053700             SET DP013-LOGIC-ABEND TO TRUE                        05370090
053800             SET DP013-NO-ROLLBACK TO TRUE                        05380090
053900             MOVE '1000-CONTROL-PROCESSING'                       05390090
054000                               TO  DP013-PARAGRAPH                05400090
054100             MOVE 'INVALID NEXT APPLICATION ACTIVITY RECEIVED'    05410090
054200                               TO  DP013-MESSAGE-TEXT(1)          05420090
054300             PERFORM DP013-0000-PROCESS-ABEND                     05430090
054400     END-EVALUATE                                                 05440090
054500     .                                                            05450090
054600                                                                  05460090
054700*----------------------------------------------------------------*05470090
054800* DETERMINE IF DATA WAS PASSED THROUGH INTER-APPL COMMAREA OR    *05480090
054900* IF THERE IS DATA TO BE USED IN THE NAV-KEY FIELD.              *05490090
055000*----------------------------------------------------------------*05500090
055100                                                                  05510090
055200 1100-PROCESS-INTER-APPL-COMM.                                    05520090
055300                                                                  05530090
055400     SET PS-COMMAREA-VALID       TO TRUE.                         05540090
055500     INITIALIZE ASC-SPECIFIC-COMMAREA.                            05550090
055600     MOVE SPACE                  TO ASC-START-ITEM-REQUEST.       05560090
055700     MOVE AP300-PO-NBR           TO ASC-KEY-PO-NBR                05570090
055800                                    ASC-ALP-PO-NBR.               05580090
055900     IF ASC-ALP-PO-NBR = SPACES                                   05590090
056000       OR ASC-KEY-PO-NBR = ZEROS                                  05600090
056100*        -- MUST EXIST --                                         05610090
056200         IF PS-NO-ERROR                                           05620090
056300             MOVE PC-TSYMSG-00007 TO DP020-MSG-NUMBER             05630090
056400         END-IF                                                   05640090
056500         SET DP020-MSG-FATAL                                      05650090
056600             PS-ERROR            TO TRUE                          05660090
056700     ELSE                                                         05670090
056800         MOVE ASC-ALP-PO-NBR     TO DP010I-UNEDITED-FIELD         05680090
056900         MOVE 9                  TO DP010I-MAXIMUM-DIGITS         05690099
057000         MOVE 0                  TO DP010I-MAXIMUM-DECIMALS       05700090
057100         SET  DP010I-NEGATIVE-NOT-ALLOWED                         05710090
057200                                 TO TRUE                          05720090
057320         CALL DP010I-NUMERIC-EDIT-ROUTINE                         05732099
057330                         USING DP010I-NUMERIC-EDIT-AREA           05733099
057400         IF DP010I-ERROR-DETECTED                                 05740090
057500*            -- MUST BE NUMERIC --                                05750090
057600             IF PS-NO-ERROR                                       05760090
057700                 MOVE PC-TSYMSG-00008 TO DP020-MSG-NUMBER         05770090
057800             END-IF                                               05780090
057900             SET DP020-MSG-FATAL                                  05790090
058000                 PS-ERROR        TO TRUE                          05800090
058100         END-IF                                                   05810090
058200     END-IF                                                       05820090
058300                                                                  05830090
058400     IF PS-NO-ERROR                                               05840090
058500         PERFORM 1110-GET-TPURCHS-DATA                            05850090
058600         IF PS-TPURCHS-NOT-FOUND                                  05860090
058700             IF PS-NO-ERROR                                       05870090
058800*  -- PURCHASE ORDER NOT FOUND --                                 05880090
058900                 MOVE PC-TSYMSG-00726                             05890090
059000                                 TO DP020-MSG-NUMBER              05900090
059100             END-IF                                               05910090
059200             SET DP020-MSG-FATAL                                  05920090
059300                 PS-ERROR        TO TRUE                          05930090
059400         ELSE                                                     05940090
059500             IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'          05950095
059600                 MOVE EXTENT-DUN-NBR                              05960092
059700                                 TO ASC-VENDOR-NBR                05970092
059800                 MOVE ENTNME-ENT-NAME-DESC                        05980092
059900                                 TO ASC-VENDOR-NAME               05990092
060000             ELSE                                                 06000090
060100                 IF PS-NO-ERROR                                   06010092
060200*  -- INVALID PURCHASE ORDER TYPE CODE FOR THIS FUNCTION --       06020092
060300                     MOVE PC-TSYMSG-00587                         06030092
060400                                 TO DP020-MSG-NUMBER              06040092
060500                 END-IF                                           06050092
060600                 SET DP020-MSG-FATAL                              06060092
060700                     PS-ERROR    TO TRUE                          06070092
060800             END-IF                                               06080090
060900         END-IF                                                   06090090
061000     END-IF                                                       06100090
061100     IF PS-ERROR                                                  06110090
061200         SET DP020-NEXT-ACT-APPL-ERROR                            06120090
061300                                 TO TRUE                          06130090
061400     END-IF                                                       06140090
061500     .                                                            06150090
061600                                                                  06160090
061700 1110-GET-TPURCHS-DATA.                                           06170090
061800                                                                  06180090
061900     PERFORM                                                      06190090
062000         WITH TEST AFTER                                          06200090
062100         VARYING PV-RETRY-COUNTER                                 06210090
062200         FROM 1 BY 1                                              06220090
062300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               06230090
062400            OR (SQLCODE = +0)                                     06240090
062500            OR (SQLCODE = +100))                                  06250090
062600                                                                  06260090
062700         EXEC SQL                                                 06270090
062800           SELECT    P.PO_TYP_CDE                                 06280090
062900                    ,N.ENT_NAME_DESC                              06290090
063000                    ,E.DUN_NBR                                    06300090
063100             INTO    :PURCHS-PO-TYP-CDE                           06310090
063200                    ,:ENTNME-ENT-NAME-DESC                        06320090
063300                    ,:EXTENT-DUN-NBR                              06330090
063400             FROM    TPURCHS P                                    06340090
063500                    ,TENTNME N                                    06350090
063600                    ,TEXTENT E                                    06360090
063700            WHERE    PO_NBR           = :ASC-KEY-PO-NBR           06370090
063800* ?DO I NEED? AND    PO_CATEG_CDE     = 'MR'                      06380090
063900*             AND    PO_TYP_CDE       = 'IM'                      06390090
064000              AND    P.VER_STATUS_CDE = 'A'                       06400090
064100              AND    N.TYPE_CDE       = '01'                      06410090
064200              AND    P.ENT_ID         = N.ENT_ID                  06420090
064300              AND    P.ENT_ID         = E.ENT_ID                  06430090
064400         END-EXEC                                                 06440090
064500                                                                  06450090
064600         EVALUATE TRUE                                            06460090
064700             WHEN SQLCODE = +0                                    06470090
064800                 SET PS-TPURCHS-FOUND      TO TRUE                06480090
064900             WHEN SQLCODE = +100                                  06490090
065000                 SET PS-TPURCHS-NOT-FOUND  TO TRUE                06500090
065100             WHEN SQLCODE = -904                                  06510090
065200             WHEN SQLCODE = -913                                  06520090
065300                 CONTINUE                                         06530090
065400                                                                  06540090
065500             WHEN SQLWARN0 NOT = SPACES                           06550090
065600             WHEN SQLCODE < ZERO                                  06560090
065700             WHEN SQLCODE > ZERO                                  06570090
065800                 MOVE '1110-GET-TPURCHS-DATA'                     06580090
065900                                 TO DP013-PARAGRAPH               06590090
066000                 MOVE 'SELECT ON TPURCHS'                         06600090
066100                                 TO DP013-MESSAGE-TEXT (1)        06610090
066200                 MOVE SQLCA TO DP013-SQLCA                        06620090
066300                 MOVE 'TPURCHS'  TO DP013-DB2-TABLE-NAME (1)      06630090
066400                 SET DP013-DB2-ABEND                              06640090
066500                     DP013-XCTL-DISPLAY-RESTART                   06650090
066600                                 TO TRUE                          06660090
066700                 PERFORM DP013-0000-PROCESS-ABEND                 06670090
066800         END-EVALUATE                                             06680090
066900     END-PERFORM.                                                 06690090
067000                                                                  06700090
067100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        06710090
067200         MOVE '1110-GET-TPURCHS-DATA'                             06720090
067300                                 TO DP013-PARAGRAPH               06730090
067400         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     06740090
067500                                 TO DP013-MESSAGE-TEXT (1)        06750090
067600         MOVE SQLCA              TO DP013-SQLCA                   06760090
067700         MOVE 'TPURCHS'          TO DP013-DB2-TABLE-NAME (1)      06770090
067800         SET DP013-DB2-ABEND                                      06780090
067900             DP013-XCTL-DISPLAY-RESTART                           06790090
068000                                 TO TRUE                          06800090
068100         PERFORM DP013-0000-PROCESS-ABEND                         06810090
068200     END-IF                                                       06820090
068300     .                                                            06830090
068400                                                                  06840090
061700 1120-GET-IMPRT-CHRG-CDE.                                         06841099
061800                                                                  06842099
062700     EXEC SQL                                                     06849299
062800       SELECT    IMPRT_CHRG_PRC_CDE                               06849399
063100         INTO    :MDINVC-IMPRT-CHRG-PRC-CDE                       06849699
063400         FROM    TMDINVC                                          06849999
063700        WHERE    PO_NBR           = :ASC-KEY-PO-NBR               06850299
064400     END-EXEC.                                                    06850999
064500                                                                  06851099
064600     EVALUATE TRUE                                                06851199
064700         WHEN SQLCODE = +0                                        06851299
064800             IF MDINVC-IMPRT-CHRG-PRC-CDE = PC-INFOR-NEXUS        06851399
064800                 SET PS-INFOR-NEXUS-YES    TO TRUE                06851499
064800             ELSE                                                 06851599
064800                 SET PS-INFOR-NEXUS-NO     TO TRUE                06851699
064800             END-IF                                               06851799
064900         WHEN SQLCODE = +100                                      06851899
065100         WHEN SQLCODE = -904                                      06852199
065200         WHEN SQLCODE = -913                                      06852299
064800             SET PS-INFOR-NEXUS-NO     TO TRUE                    06852399
065400                                                                  06852599
065500         WHEN SQLWARN0 NOT = SPACES                               06852699
065600         WHEN SQLCODE < ZERO                                      06852799
065700         WHEN SQLCODE > ZERO                                      06852899
065800             MOVE '1120-GET-IMPRT-CHRG-CDE'                       06852999
065900                                 TO DP013-PARAGRAPH               06853099
066000             MOVE 'SELECT ON TMDINVC'                             06853199
066100                                 TO DP013-MESSAGE-TEXT (1)        06853299
066200             MOVE SQLCA TO DP013-SQLCA                            06853399
066300             MOVE 'TMDINVC'  TO DP013-DB2-TABLE-NAME (1)          06853499
066400             SET DP013-DB2-ABEND                                  06853599
066500                 DP013-XCTL-DISPLAY-RESTART                       06853699
066600                                 TO TRUE                          06853799
066700             PERFORM DP013-0000-PROCESS-ABEND                     06853899
066800     END-EVALUATE.                                                06853999
068400                                                                  06854999
068500*----------------------------------------------------------------*06855090
068600*    RECEIVE THE MAP AND PERFORM THE APPROPRIATE PARAGRAPH BASED *06860090
068700*    ON WHAT FUNCTION KEY WAS SELECTED.                          *06870090
068800*----------------------------------------------------------------*06880090
068900                                                                  06890090
069000 2000-PROCESS-PANEL.                                              06900090
069100                                                                  06910090
069200     EVALUATE TRUE                                                06920090
069300                                                                  06930090
069400         WHEN DP020-FK-CONFIRM (DP020-SRC-AID)                    06940090
069500             IF ASC-UNRELEAS-REQUESTED                            06950090
069600               OR ASC-RELEASE-REQUESTED                           06960090
069700                 IF ASC-UPD-DATA                                  06970090
069800                     SET ASC-UPDATE-COMPLETED                     06980090
069900                                 TO TRUE                          06990090
070000                     PERFORM 6100-UPDATE-INVOICES                 07000090
070100*  -- UPDATE(S) SUCCESSFUL --                                     07010090
070200                     MOVE PC-TSYMSG-00059                         07020090
070300                                 TO DP020-MSG-NUMBER              07030090
070400                     MOVE +0     TO ASC-ITEM-AT-TOP-OF-PANEL      07040090
070500                     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN         07050090
070600                 ELSE                                             07060090
070700                     IF ASC-BAD-DATA                              07070090
070800*  -- NO UPDATES ALLOWED FOR THIS STATUS --                       07080090
070900                         MOVE PC-TSYMSG-00170                     07090090
071000                                 TO DP020-MSG-NUMBER              07100090
071100                         SET DP020-MSG-FATAL                      07110090
071200                        PS-ERROR TO TRUE                          07120090
071300                     END-IF                                       07130090
071400                 END-IF                                           07140090
071500             ELSE                                                 07150090
071600*  -- UPDATE MUST BE REQUESTED BEFORE CONFIRM --                  07160090
071700                 MOVE PC-TSYMSG-00016                             07170090
071800                                 TO DP020-MSG-NUMBER              07180090
071900                 SET DP020-MSG-FATAL                              07190090
072000                         PS-ERROR TO TRUE                         07200090
072100             END-IF                                               07210090
072200                                                                  07220090
072300         WHEN DP020-SRC-AID = DP016-PF13                          07230090
072400             IF ASC-UNRELEAS-REQUESTED                            07240090
072500                 MOVE SPACE      TO ASC-REQUEST-SW                07250090
072600                 PERFORM 2050-DELETE-QUEUE                        07260090
072700                 PERFORM 4000-BUILD-INITIAL-PANEL                 07270090
072800             ELSE                                                 07280090
072900                 SET ASC-RELEASE-REQUESTED TO TRUE                07290099
073000                 PERFORM 4350-CHECK-FOR-PENDING-EXPINVC           07300099
073100                 IF ASC-PENDING-EXPINVC-FOUND                     07310099
073200*  -- EXPENSE INVOICES IN 'PR' (PENDING REVIEW) STATUS EXIST --   07320099
073300*  -- PO CANNOT BE PAY RELEASED --                                07330099
073400                     MOVE PC-TSYMSG-02740 TO DP020-MSG-NUMBER     07340099
073500                     SET DP020-MSG-FATAL                          07350099
073600                         PS-ERROR        TO TRUE                  07360099
073700                 ELSE                                             07370099
073800                     MOVE 'BM'       TO PV-NEW-STATUS             07380099
073900                     MOVE ZERO       TO ASC-ITEMS-UPDATED         07390099
074000                                        AUPDITO                   07400099
074100                     PERFORM 2140-UPDATE-ALL-ITEMS                07410099
074200                     IF ASC-UPD-DATA                              07420099
074300*                   MOVE +0     TO ASC-ITEM-AT-TOP-OF-PANEL       07430099
074400*                   PERFORM 4400-MOVE-COMMAREA-TO-SCREEN          07440099
074500* -- PRESS F2 TO CONFIRM REQUEST --                               07450099
074600                         MOVE PC-TSYMSG-00004                     07460099
074700                                     TO DP020-MSG-NUMBER          07470099
074800                         SET DP020-MSG-INFORMATIONAL              07480099
074900                                     TO TRUE                      07490099
075000                     ELSE                                         07500099
075100* -- DATA NOT CHANGED; NO UPDATE PERFORMED --                     07510099
075200                         IF PS-NO-ERROR                           07520099
075300                             MOVE PC-TSYMSG-00046                 07530099
075400                                  TO DP020-MSG-NUMBER             07540099
075500                             SET DP020-MSG-INFORMATIONAL          07550099
075600                                  TO TRUE                         07560099
075700                         END-IF                                   07570099
075800                     END-IF                                       07580099
075900                 END-IF                                           07590099
076000             END-IF                                               07600090
076100                                                                  07610090
076200         WHEN DP020-SRC-AID = DP016-PF19                          07620090
076300             IF ASC-RELEASE-REQUESTED                             07630090
076400*  IF THEY'VE HIT F13, THEN HIT F19 WITHOUT CONFIRMING THE UPD,   07640090
076500*    TREAT LIKE A REFRESH AND REDISPLAY THE DB DATA.              07650090
076600                 MOVE SPACE      TO ASC-REQUEST-SW                07660090
076700                 PERFORM 2050-DELETE-QUEUE                        07670090
076800                 PERFORM 4000-BUILD-INITIAL-PANEL                 07680090
076900             ELSE                                                 07690090
077000                 MOVE 'EN'       TO PV-NEW-STATUS                 07700090
077100                 SET ASC-UNRELEAS-REQUESTED                       07710090
077200                                 TO TRUE                          07720090
077300                 MOVE ZERO       TO ASC-ITEMS-UPDATED             07730090
077400                                    AUPDITO                       07740090
077500                 PERFORM 2140-UPDATE-ALL-ITEMS                    07750090
077600                 IF ASC-UPD-DATA                                  07760090
077700*                    MOVE +0     TO ASC-ITEM-AT-TOP-OF-PANEL      07770090
077800*                    PERFORM 4400-MOVE-COMMAREA-TO-SCREEN         07780090
077900*    -- PRESS F2 TO CONFIRM REQUEST --                            07790090
078000                     MOVE PC-TSYMSG-00004                         07800090
078100                                 TO DP020-MSG-NUMBER              07810090
078200                     SET DP020-MSG-INFORMATIONAL                  07820090
078300                                 TO TRUE                          07830090
078400                 ELSE                                             07840090
078500*    -- DATA NOT CHANGED; NO UPDATE PERFORMED --                  07850090
078600                     IF PS-NO-ERROR                               07860090
078700                         MOVE PC-TSYMSG-00046                     07870090
078800                                 TO DP020-MSG-NUMBER              07880090
078900                         SET DP020-MSG-INFORMATIONAL              07890090
079000                                 TO TRUE                          07900090
079100                     END-IF                                       07910090
079200                 END-IF                                           07920090
079300             END-IF                                               07930090
079400                                                                  07940090
079500         WHEN DP020-SRC-AID = DP016-CLEAR                         07950090
079600             MOVE ZERO           TO ASC-ITEM-AT-TOP-OF-PANEL      07960090
079700             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 07970090
079800                                                                  07980090
079900         WHEN DP020-FK-REFRESH (DP020-SRC-AID)                    07990090
080000             MOVE SPACE          TO ASC-REQUEST-SW                08000090
080100             PERFORM 2050-DELETE-QUEUE                            08010090
080200             PERFORM 4000-BUILD-INITIAL-PANEL                     08020090
080300                                                                  08030090
080400         WHEN DP020-FK-FIRST-PAGE(DP020-SRC-AID)                  08040090
080500             MOVE +1 TO PV-TOP-ITEM                               08050090
080600             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 08060090
080700                                                                  08070090
080800         WHEN DP020-FK-PREV-PAGE(DP020-SRC-AID)                   08080090
080900             PERFORM 2110-BROWSE-BACKWARD                         08090090
081000             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 08100090
081100                                                                  08110090
081200         WHEN DP020-FK-NEXT-PAGE(DP020-SRC-AID)                   08120090
081300             PERFORM 2120-BROWSE-FORWARD                          08130090
081400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 08140090
081500                                                                  08150090
081600         WHEN DP020-SRC-AID = DP016-ENTER                         08160090
081700             PERFORM 2130-CHECK-FOR-JUMP-BROWSE                   08170090
081800             IF PS-NO-ERROR                                       08180090
081900                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN             08190090
082000             END-IF                                               08200090
082100                                                                  08210090
082200         WHEN OTHER                                               08220090
082300             SET DP013-NO-ROLLBACK TO TRUE                        08230090
082400             SET DP013-XCTL-DISPLAY-RESTART TO TRUE               08240090
082500             SET DP013-CICS-ABEND TO TRUE                         08250090
082600             MOVE '2000-CHECK-FUNCTION-KEY' TO DP013-PARAGRAPH    08260090
082700             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      08270090
082800                                   TO DP013-MESSAGE-TEXT (1)      08280090
082900             PERFORM DP013-0000-PROCESS-ABEND                     08290090
083000                                                                  08300090
083100     END-EVALUATE.                                                08310090
083200                                                                  08320090
083300*----------------------------------------------------------------*08330090
083400*    DELETE THE TEMPORARY STORAGE QUEUE.                         *08340090
083500*----------------------------------------------------------------*08350090
083600                                                                  08360090
083700 2050-DELETE-QUEUE.                                               08370090
083800                                                                  08380090
083900     EXEC CICS                                                    08390090
084000         DELETEQ TS                                               08400090
084100             QUEUE (ASC-QUEUE-NAME)                               08410090
084200             RESP  (PV-CICS-RESP)                                 08420090
084300     END-EXEC.                                                    08430090
084400                                                                  08440090
084500     IF (PV-CICS-RESP = DFHRESP(NORMAL)) OR                       08450090
084600        (PV-CICS-RESP = DFHRESP(QIDERR))                          08460090
084700         CONTINUE                                                 08470090
084800     ELSE                                                         08480090
084900         SET DP013-CICS-ABEND TO TRUE                             08490090
085000         SET DP013-NO-ROLLBACK TO TRUE                            08500090
085100                                                                  08510090
085200         MOVE '2050-DELETE-QUEUE' TO DP013-PARAGRAPH              08520090
085300         MOVE 'ERROR TRYING TO DELETE TEMP STORAGE QUEUE'         08530090
085400                                 TO DP013-MESSAGE-TEXT (1)        08540090
085500         PERFORM DP013-0000-PROCESS-ABEND                         08550090
085600     END-IF.                                                      08560090
085700                                                                  08570090
085800     MOVE +0 TO ASC-HIGHEST-BLOCK-WRITTEN.                        08580090
085900                                                                  08590090
086000*----------------------------------------------------------------*08600090
086100*    IF THE USER HITS THE PAGE BACKWARD KEY, COMPUTE THE TOP     *08610090
086200*    ITEM NUMBER FOR THE NEW PAGE.  IF IT IS ABOVE THE TOP,      *08620090
086300*    SET THE TOP ITEM NUMBER TO +1 AND DISPLAY THE TOP OF LIST   *08630090
086400*    MESSAGE.                                                    *08640090
086500*----------------------------------------------------------------*08650090
086600                                                                  08660090
086700 2110-BROWSE-BACKWARD.                                            08670090
086800                                                                  08680090
086900     SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-AT-TOP-OF-PANEL    08690090
087000         GIVING PV-TOP-ITEM.                                      08700090
087100                                                                  08710090
087200     IF  PV-TOP-ITEM < +1                                         08720090
087300         MOVE +1              TO PV-TOP-ITEM                      08730090
087400*        -- TOP OF LIST --                                        08740090
087500         MOVE PC-TSYMSG-00069 TO DP020-MSG-NUMBER                 08750090
087600         SET DP020-MSG-INFORMATIONAL TO TRUE                      08760090
087700     END-IF.                                                      08770090
087800                                                                  08780090
087900*----------------------------------------------------------------*08790090
088000*    IF THE USER HITS THE PAGE FORWARD KEY, COMPUTE THE TOP      *08800090
088100*    ITEM NUMBER FOR THE NEW PAGE.  IF THE USER ATTEMPTS TO GO   *08810090
088200*    PAST THE END, ISSUE THE BOTTOM OF LIST MESSAGE.             *08820090
088300*----------------------------------------------------------------*08830090
088400                                                                  08840090
088500 2120-BROWSE-FORWARD.                                             08850090
088600                                                                  08860090
088700     ADD PC-ITEMS-PER-PANEL ASC-ITEM-AT-TOP-OF-PANEL              08870090
088800         GIVING PV-TOP-ITEM.                                      08880090
088900     IF  PV-TOP-ITEM > ASC-NUMBER-OF-ITEMS-READ                   08890090
089000         MOVE ASC-ITEM-AT-TOP-OF-PANEL                            08900090
089100                                   TO PV-TOP-ITEM                 08910090
089200*        -- BOTTOM OF LIST --                                     08920090
089300         MOVE PC-TSYMSG-00070      TO DP020-MSG-NUMBER            08930090
089400         SET DP020-MSG-INFORMATIONAL                              08940090
089500                                   TO TRUE                        08950090
089600     ELSE                                                         08960090
089700         COMPUTE PV-BOTTOM-ITEM =                                 08970090
089800             PV-TOP-ITEM + PC-ITEMS-PER-PANEL - 1                 08980090
089900         IF  PV-BOTTOM-ITEM > ASC-NUMBER-OF-ITEMS-READ            08990090
090000*            -- BOTTOM OF LIST --                                 09000090
090100             MOVE PC-TSYMSG-00070  TO DP020-MSG-NUMBER            09010090
090200             SET DP020-MSG-INFORMATIONAL                          09020090
090300                                   TO TRUE                        09030090
090400         END-IF                                                   09040090
090500     END-IF.                                                      09050090
090600                                                                  09060090
090700*----------------------------------------------------------------*09070090
090800*    THE USER CAN CHANGE THE CURRENT BEGINNING LIST NUMBER SO    *09080090
090900*    THAT THE TRANSACTION WILL JUMP TO THAT POINT IN THE LIST.   *09090090
091000*    THIS IS A FASTER WAY TO GET TO A CERTAIN POINT IN THE LIST  *09100090
091100*    RATHER THAN HITTING PF8 TO PAGE FORWARD TO THAT POINT.      *09110090
091200*    THE NEW LIST NUMBER ENTERED IS EDITED TO MAKE SURE THAT     *09120090
091300*    IT IS NUMERIC AND FALLS BETWEEN A SPECIFIED RANGE.          *09130090
091400*----------------------------------------------------------------*09140090
091500                                                                  09150090
091600 2130-CHECK-FOR-JUMP-BROWSE.                                      09160090
091700                                                                  09170090
091800     IF ASTRTITL > ZERO                                           09180090
091900         MOVE ASTRTITI             TO ASC-START-ITEM-REQUEST      09190090
092000     ELSE                                                         09200090
092100         IF ASTRTITF = DP015-ERASE-EOF                            09210090
092200             INITIALIZE ASC-START-ITEM-REQUEST                    09220090
092300         END-IF                                                   09230090
092400     END-IF.                                                      09240090
092500                                                                  09250090
092600     MOVE -1                       TO ASTRTITL.                   09260090
092700     SET DP030-SET-CURSOR-APPL-1   TO TRUE.                       09270090
092800     MOVE DP015-UNP-ALP-NOR-OFF    TO ASTRTITA.                   09280090
092900     MOVE DP015-GREEN              TO ASTRTITC.                   09290090
093000     MOVE DP015-UNDERLINE          TO ASTRTITH.                   09300090
093100                                                                  09310090
093200     IF (ASC-START-ITEM-REQUEST = SPACE)                          09320090
093300         MOVE ASC-ITEM-AT-TOP-OF-PANEL                            09330090
093400                                   TO PV-TOP-ITEM                 09340090
093500     ELSE                                                         09350090
093600         MOVE ASC-START-ITEM-REQUEST                              09360090
093700                                   TO DP010I-UNEDITED-FIELD       09370090
093800         MOVE PC-MSG-NUMBER-LENGTH TO DP010I-MAXIMUM-DIGITS       09380090
093900         MOVE +0                   TO DP010I-MAXIMUM-DECIMALS     09390090
094000         SET DP010I-NEGATIVE-NOT-ALLOWED                          09400090
094100                                   TO TRUE                        09410090
094220         CALL DP010I-NUMERIC-EDIT-ROUTINE                         09422099
094230                         USING DP010I-NUMERIC-EDIT-AREA           09423099
094300                                                                  09430090
094400         IF DP010I-ERROR-DETECTED                                 09440090
094500             MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER            09450090
094600             MOVE DP015-REVERSE    TO ASTRTITH                    09460090
094700             MOVE DP015-RED        TO ASTRTITC                    09470090
094800             MOVE DP015-UNP-NUM-BRT-MDT                           09480090
094900                                   TO ASTRTITA                    09490090
095000             SET DP020-MSG-FATAL   TO TRUE                        09500090
095100             SET PS-ERROR          TO TRUE                        09510090
095200         END-IF                                                   09520090
095300         IF PS-NO-ERROR                                           09530090
095400             MOVE DP010I-NUMERIC-FIELD                            09540090
095500                                   TO  ASC-START-ITEM-REQUEST-N   09550090
095600             IF ASC-START-ITEM-REQUEST-N = ZERO                   09560090
095700                 MOVE +1           TO  ASC-START-ITEM-REQUEST-N   09570090
095800             END-IF                                               09580090
095900             IF  ASC-START-ITEM-REQUEST-N < ZERO                  09590090
096000*                --- VALUE OUT OF RANGE ----                      09600090
096100                 MOVE PC-TSYMSG-00101                             09610090
096200                                   TO DP020-MSG-NUMBER            09620090
096300                 MOVE DP015-REVERSE                               09630090
096400                                   TO ASTRTITH                    09640090
096500                 MOVE DP015-RED    TO ASTRTITC                    09650090
096600                 MOVE DP015-UNP-NUM-BRT-MDT                       09660090
096700                                   TO ASTRTITA                    09670090
096800                 SET DP020-MSG-FATAL                              09680090
096900                                   TO TRUE                        09690090
097000                 SET PS-ERROR      TO TRUE                        09700090
097100             END-IF                                               09710090
097200         END-IF                                                   09720090
097300         IF PS-NO-ERROR                                           09730090
097400             IF ASC-START-ITEM-REQUEST-N >                        09740090
097500                                      ASC-NUMBER-OF-ITEMS-READ    09750090
097600                 MOVE SPACE      TO ASC-START-ITEM-REQUEST        09760090
097700                 COMPUTE PV-TOP-ITEM = ASC-NUMBER-OF-ITEMS-READ   09770090
097800                              - PC-ITEMS-PER-PANEL + 1            09780090
097900                 IF PV-TOP-ITEM < +1                              09790090
098000                     MOVE +1     TO PV-TOP-ITEM                   09800090
098100                     MOVE PC-TSYMSG-00070                         09810090
098200                                 TO DP020-MSG-NUMBER              09820090
098300                     SET DP020-MSG-INFORMATIONAL                  09830090
098400                                 TO TRUE                          09840090
098500                 END-IF                                           09850090
098600             ELSE                                                 09860090
098700                 MOVE ASC-START-ITEM-REQUEST-N                    09870090
098800                                 TO PV-TOP-ITEM                   09880090
098900                 MOVE SPACE      TO ASC-START-ITEM-REQUEST        09890090
099000                 COMPUTE PV-BOTTOM-ITEM =                         09900090
099100                     PV-TOP-ITEM + PC-ITEMS-PER-PANEL - 1         09910090
099200                 IF PV-BOTTOM-ITEM > ASC-NUMBER-OF-ITEMS-READ     09920090
099300*                        -- BOTTOM OF LIST --                     09930090
099400                     MOVE PC-TSYMSG-00070                         09940090
099500                                 TO DP020-MSG-NUMBER              09950090
099600                     SET DP020-MSG-INFORMATIONAL                  09960090
099700                                 TO TRUE                          09970090
099800                 END-IF                                           09980090
099900             END-IF                                               09990090
100000         END-IF                                                   10000090
100100     END-IF.                                                      10010090
100200                                                                  10020090
100300*----------------------------------------------------------------*10030090
100400*    UPDATE ALL INVOICES TO NEW STATUS                            10040090
100500*----------------------------------------------------------------*10050090
100600                                                                  10060090
100700 2140-UPDATE-ALL-ITEMS.                                           10070090
100800                                                                  10080090
100900     IF ASC-BAD-DATA                                              10090090
101000*       -- INVALID COMBINATION OF STATUS CODES --                 10100090
101100         MOVE PC-TSYMSG-00807    TO DP020-MSG-NUMBER              10110090
101200         SET DP020-MSG-WARNING                                    10120090
101300             PS-ERROR            TO TRUE                          10130090
101400     ELSE                                                         10140090
101500         PERFORM 5999-GET-CURRENT-DATE                            10150099
101600         SET PS-NO-ERROR                                          10160090
101700             ASC-NO-BAD-DATA     TO TRUE                          10170090
101800         MOVE +1                 TO PV-BLOCK-NUMBER               10180090
101900         MOVE +0                 TO ASC-BLK-SUB                   10190090
102000                                                                  10200090
102100         PERFORM                                                  10210090
102200           UNTIL PV-BLOCK-NUMBER > ASC-HIGHEST-BLOCK-WRITTEN      10220090
102300           OR PS-ERROR                                            10230090
102400                                                                  10240090
102500             ADD +1              TO ASC-BLK-SUB                   10250090
102600             PERFORM 4410-READ-TEMP-STORAGE                       10260090
102700                                                                  10270090
102800*  UPDATE TEMP STORAGE WITH NEW STATUS                            10280090
102900             PERFORM 6000-MODIFY-TEMPSTOR-QUEUE                   10290090
103000               VARYING ASC-ITEM-SUB  FROM +1 BY +1                10300090
103100                 UNTIL ASC-ITEM-SUB > PC-ITEMS-PER-PANEL          10310090
103200                                                                  10320090
103300             PERFORM 5105-REWRITE-TEMP-STORAGE                    10330090
103400                                                                  10340090
103500             ADD +1                  TO PV-BLOCK-NUMBER           10350090
103600                                                                  10360090
103700         END-PERFORM                                              10370090
103800     END-IF                                                       10380090
103900     .                                                            10390090
104000                                                                  10400090
104100* NOW THAT ALL THE UPDATING IS DONE, RESET PV-TOP-ITEM TO +1      10410090
104200*  AND RELOAD THE SCREEN WITH THE UPDATED DATA.                   10420090
104300*    MOVE +1                     TO PV-TOP-ITEM                   10430090
104400                                                                  10440090
104500     IF (((PV-TOP-ITEM > ASC-ITEM-NUMBER (1 1))                   10450090
104600       AND (PV-TOP-ITEM > ASC-ITEM-NUMBER (2 1)))                 10460090
104700       OR  (PV-TOP-ITEM < ASC-ITEM-NUMBER (1 1)))                 10470090
104800         MOVE +1                 TO ASC-BLK-SUB                   10480090
104900         PERFORM 5100-WRITE-TEMP-STORAGE                          10490090
105000         ADD +1                  TO ASC-BLK-SUB                   10500090
105100         PERFORM 5100-WRITE-TEMP-STORAGE                          10510090
105200         DIVIDE PV-TOP-ITEM BY PC-ITEMS-PER-PANEL                 10520090
105300           GIVING PV-BLOCK-NUMBER                                 10530090
105400           REMAINDER PV-REMAINDER                                 10540090
105500         IF PV-REMAINDER > ZERO                                   10550090
105600             ADD +1 TO PV-BLOCK-NUMBER                            10560090
105700         END-IF                                                   10570090
105800         MOVE +1                 TO ASC-BLK-SUB                   10580090
105900         PERFORM 4410-READ-TEMP-STORAGE                           10590090
106000         ADD +1                  TO ASC-BLK-SUB                   10600090
106100                                    PV-BLOCK-NUMBER               10610090
106200         PERFORM 4410-READ-TEMP-STORAGE                           10620090
106300     END-IF                                                       10630090
106400     .                                                            10640090
106500                                                                  10650090
106600*----------------------------------------------------------------*10660090
106700*    INITIALIZE BOTH BLOCKS IN THE ARRAY.                        *10670090
106800*    INITIALIZE ALL COUNTERS AND FLAGS.                          *10680090
106900*    READ THE DATA BASE FOR THE 1ST TIME AND FILL UP THE ARRAY.  *10690090
107000*    DISPLAY THE PANEL TO USER.                                  *10700090
107100*----------------------------------------------------------------*10710090
107200                                                                  10720090
107300 4000-BUILD-INITIAL-PANEL.                                        10730090
107400                                                                  10740090
107500     INITIALIZE                  ASC-BLOCK-ENTRIES (1)            10750090
107600                                 ASC-BLOCK-ENTRIES (2)            10760090
107700                                 DCLTENTNME                       10770090
107800                                 DCLTINVOIC                       10780090
107900                                 DCLTPURCHS.                      10790090
108000     SET ASC-ITEMS-LEFT-ON-DB                                     10800090
108100         ASC-NO-BAD-DATA         TO  TRUE.                        10810090
108200     MOVE -1                     TO ASTRTITL.                     10820090
108300     SET DP030-SET-CURSOR-APPL-1 TO TRUE.                         10830090
108400                                                                  10840090
108500     MOVE +1                     TO  ASC-BLK-SUB.                 10850090
108600     MOVE +0                     TO  ASC-ITEM-SUB                 10860090
108700                                     ASC-ITEMS-UPDATED            10870090
108800                                     AUPDITO                      10880090
108900                                     ASC-NUMBER-OF-ITEMS-READ     10890090
109000                                     ASC-HIGHEST-BLOCK-WRITTEN    10900090
109100                                     ASC-ITEM-AT-TOP-OF-PANEL.    10910090
109200                                                                  10920090
109300     EXEC SQL                                                     10930090
109400         SET :ASC-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           10940090
109500     END-EXEC                                                     10950090
109600                                                                  10960090
109700     PERFORM 4010-OPEN-CURSOR.                                    10970090
109800                                                                  10980090
109900     PERFORM 4300-READ-ITEMS-FROM-DB                              10990090
110000                                                                  11000090
110100     PERFORM 4020-CLOSE-CURSOR                                    11010090
110200                                                                  11020090
110300     MOVE +1                     TO  PV-TOP-ITEM.                 11030090
110400     IF ASC-NUMBER-OF-ITEMS-READ = ZERO                           11040090
110500         SET DP020-NEXT-ACT-APPL-ERROR                            11050090
110600             DP020-MSG-FATAL     TO TRUE                          11060090
110700         MOVE PC-TSYMSG-00050    TO DP020-MSG-NUMBER              11070090
110800     ELSE                                                         11080090
110900         PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                     11090090
111000     END-IF                                                       11100090
111100     .                                                            11110090
111200                                                                  11120090
111300*----------------------------------------------------------------*11130090
111400* OPEN THE CURSOR.                                               *11140090
111500*----------------------------------------------------------------*11150090
111600                                                                  11160090
111700 4010-OPEN-CURSOR.                                                11170090
111800                                                                  11180090
111900     EXEC SQL                                                     11190090
112000          OPEN INVOICE-CSR                                        11200090
112100     END-EXEC.                                                    11210090
112200                                                                  11220090
112300     EVALUATE TRUE                                                11230090
112400         WHEN SQLCODE = ZERO                                      11240090
112500              CONTINUE                                            11250090
112600         WHEN SQLWARN0 NOT EQUAL SPACE                            11260090
112700         WHEN SQLCODE NOT EQUAL ZERO                              11270090
112800              MOVE '4010-OPEN-CURSOR'                             11280090
112900                           TO  DP013-PARAGRAPH                    11290090
113000              MOVE 'OPEN MESSAGE CURSOR'                          11300090
113100                           TO  DP013-MESSAGE-TEXT (1)             11310090
113200              MOVE SQLCA   TO  DP013-SQLCA                        11320090
113300              SET DP013-DB2-ABEND                                 11330090
113400                           TO  TRUE                               11340090
113500              PERFORM DP013-0000-PROCESS-ABEND                    11350090
113600     END-EVALUATE.                                                11360090
113700                                                                  11370090
113800                                                                  11380090
113900*----------------------------------------------------------------*11390090
114000* CLOSE THE CURSOR.                                              *11400090
114100*----------------------------------------------------------------*11410090
114200                                                                  11420090
114300 4020-CLOSE-CURSOR.                                               11430090
114400                                                                  11440090
114500     EXEC SQL                                                     11450090
114600         CLOSE INVOICE-CSR                                        11460090
114700     END-EXEC.                                                    11470090
114800                                                                  11480090
114900     EVALUATE TRUE                                                11490090
115000         WHEN SQLCODE = ZERO                                      11500090
115100              CONTINUE                                            11510090
115200         WHEN SQLWARN0 NOT EQUAL SPACE                            11520090
115300         WHEN SQLCODE NOT EQUAL ZERO                              11530090
115400              MOVE '4020-CLOSE-CURSOR'                            11540090
115500                           TO  DP013-PARAGRAPH                    11550090
115600              MOVE 'CLOSE MESSAGE CURSOR'                         11560090
115700                           TO  DP013-MESSAGE-TEXT (1)             11570090
115800              MOVE SQLCA   TO  DP013-SQLCA                        11580090
115900              SET DP013-DB2-ABEND                                 11590090
116000                           TO  TRUE                               11600090
116100              PERFORM DP013-0000-PROCESS-ABEND                    11610090
116200     END-EVALUATE.                                                11620090
116300                                                                  11630090
116400                                                                  11640090
116500*----------------------------------------------------------------*11650090
116600*    READ THE ITEMS FROM THE DATA BASE AND MOVE THEM INTO THE    *11660090
116700*    BLOCKS IN THE ARRAY.  WHENEVER BOTH BLOCKS BECOME FULL,     *11670090
116800*    WRITE OUT THE 1ST BLOCK TO TEMPORARY STORAGE, MOVE THE 2ND  *11680090
116900*    BLOCK IN THE ARRAY TO THE 1ST BLOCK, AND INITIALIZE THE     *11690090
117000*    2ND BLOCK MAKING IT AVAILABLE TO BE USED.                   *11700090
117100*                                                                *11710090
117200*    DUE TO THE SIZE OF THE TABLE, AND THE ORDER IN WHICH THE    *11720090
117300*    ROWS ARE SORTED, THE ENTIRE TABLE IS READ INTO THE PROGRAM  *11730090
117400*    UPON INITIALIZATION.                                        *11740090
117500*----------------------------------------------------------------*11750090
117600                                                                  11760090
117700 4300-READ-ITEMS-FROM-DB.                                         11770090
117800                                                                  11780090
117900     PERFORM                                                      11790090
118000         VARYING PV-READ-COUNT                                    11800090
118100         FROM 1 BY 1                                              11810090
118200         UNTIL PV-READ-COUNT > PC-MAX-ITEMS                       11820090
118300            OR ASC-NO-ITEMS-LEFT-ON-DB                            11830090
118400                                                                  11840090
118500         PERFORM 4310-FETCH                                       11850090
118600                                                                  11860090
118700         IF ASC-ITEMS-LEFT-ON-DB                                  11870090
118800             IF ASC-ITEM-SUB < PC-ITEMS-PER-PANEL                 11880090
118900                 ADD +1          TO ASC-ITEM-SUB                  11890090
119000             ELSE                                                 11900090
119100                 ADD +1          TO ASC-BLK-SUB                   11910090
119200                 MOVE +1         TO ASC-ITEM-SUB                  11920090
119300                                                                  11930090
119400                 IF ASC-BLK-SUB > PC-MAX-BLOCKS-IN-ARRAY          11940090
119500                     MOVE +1 TO ASC-BLK-SUB                       11950090
119600                     PERFORM 5100-WRITE-TEMP-STORAGE              11960090
119700                     MOVE ASC-BLOCK-ENTRIES                       11970090
119800                             (PC-MAX-BLOCKS-IN-ARRAY)             11980090
119900                                 TO ASC-BLOCK-ENTRIES             11990090
120000                                       (ASC-BLK-SUB)              12000090
120100                     ADD +1      TO ASC-BLK-SUB                   12010090
120200                     INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)   12020090
120300                 END-IF                                           12030090
120400             END-IF                                               12040090
120500                                                                  12050090
120600             ADD +1              TO ASC-NUMBER-OF-ITEMS-READ      12060090
120700             MOVE ASC-NUMBER-OF-ITEMS-READ                        12070090
120800                                 TO ASC-ITEM-NUMBER               12080090
120900                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12090090
121000                                                                  12100090
121100             MOVE INVOIC-INVC-ID TO ASC-INVC-NBR                  12110090
121200                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12120090
121300             MOVE INVOIC-INVC-DTE TO ASC-INVC-DTE                 12130090
121400                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12140090
121500             MOVE INVOIC-STR-NBR TO ASC-STR-NBR                   12150090
121600                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12160090
121700             MOVE INVOIC-INVC-TYP-CDE                             12170090
121800                                 TO ASC-TYPE                      12180090
121900                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12190090
122000             MOVE INVOIC-ENTR-MTHD-CDE                            12200090
122100                                 TO ASC-ENTR-MTHD                 12210090
122200                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12220090
122300             MOVE INVOIC-STATUS-CDE                               12230090
122400                                 TO ASC-STATUS                    12240090
122500                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12250090
122600                                    ASC-NEW-STATUS                12260090
122700                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12270090
122800             MOVE INVOIC-GRO-COST-AMT                             12280090
122900                                 TO ASC-GROSS-AMT                 12290090
123000                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12300090
123100             MOVE INVOIC-CRE-DTE TO ASC-CRE-DTE                   12310099
123200                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 12320090
123300             IF INVOIC-STATUS-CDE = 'OB'                          12330090
123400               OR INVOIC-STATUS-CDE = 'IB'                        12340090
123500                 SET ASC-BAD-DATA TO TRUE                         12350090
123600             END-IF                                               12360090
123700         END-IF                                                   12370090
123800     END-PERFORM.                                                 12380090
123900                                                                  12390090
124000     IF ASC-NUMBER-OF-ITEMS-READ > ZERO                           12400090
124100         MOVE +1                 TO ASC-BLK-SUB                   12410090
124200         PERFORM 5100-WRITE-TEMP-STORAGE                          12420090
124300         ADD +1                  TO ASC-BLK-SUB                   12430090
124400         PERFORM 5100-WRITE-TEMP-STORAGE                          12440090
124500         MOVE 1                  TO ASC-BLK-SUB                   12450090
124600                                    PV-BLOCK-NUMBER               12460090
124700         PERFORM 4410-READ-TEMP-STORAGE                           12470090
124800         IF  ASC-HIGHEST-BLOCK-WRITTEN GREATER THAN 1             12480090
124900             MOVE 2              TO ASC-BLK-SUB                   12490090
125000                                    PV-BLOCK-NUMBER               12500090
125100             PERFORM 4410-READ-TEMP-STORAGE                       12510090
125200         END-IF                                                   12520090
125300     END-IF.                                                      12530090
125400                                                                  12540090
125500*----------------------------------------------------------------*12550090
125600*    FETCH THE INVOICE CURSOR                                    *12560090
125700*----------------------------------------------------------------*12570090
125800                                                                  12580090
125900 4310-FETCH.                                                      12590090
126000                                                                  12600090
126100     INITIALIZE DP013-DB2-INFO.                                   12610090
126200                                                                  12620090
126300     PERFORM                                                      12630090
126400         WITH TEST AFTER                                          12640090
126500         VARYING PV-SQL-SUB                                       12650090
126600         FROM 1 BY 1                                              12660090
126700         UNTIL PV-SQL-SUB GREATER THAN PC-MAX-RETRIES             12670090
126800            OR SQLCODE = 0                                        12680090
126900            OR SQLCODE = +100                                     12690090
127000                                                                  12700090
127100         EXEC SQL                                                 12710090
127200              FETCH INVOICE-CSR                                   12720090
127300              INTO  :INVOIC-INVC-ID                               12730099
127400                   ,:INVOIC-INVC-DTE                              12740090
127500                   ,:INVOIC-STR-NBR                               12750090
127600                   ,:INVOIC-INVC-TYP-CDE                          12760090
127700                   ,:INVOIC-ENTR-MTHD-CDE                         12770090
127800                   ,:INVOIC-STATUS-CDE                            12780090
127900                   ,:INVOIC-GRO-COST-AMT                          12790090
128000                   ,:INVOIC-CRE-DTE                               12800099
128100         END-EXEC                                                 12810090
128200                                                                  12820090
128300         EVALUATE TRUE                                            12830090
128400             WHEN SQLCODE = +100                                  12840090
128500                SET ASC-NO-ITEMS-LEFT-ON-DB                       12850090
128600                                 TO TRUE                          12860090
128700             WHEN SQLCODE = ZERO                                  12870090
128800             WHEN SQLCODE = -904                                  12880090
128900             WHEN SQLCODE = -913                                  12890090
129000                CONTINUE                                          12900090
129100             WHEN OTHER                                           12910090
129200                  MOVE '4310-FETCH-CURSOR'                        12920090
129300                               TO  DP013-PARAGRAPH                12930090
129400                  MOVE 'FETCH MESSAGE CURSOR'                     12940090
129500                               TO  DP013-MESSAGE-TEXT (1)         12950090
129600                  MOVE 'TINVOIC' TO DP013-DB2-TABLE-NAME (1)      12960099
129700                  MOVE SPACES    TO DP013-DB2-TABLE-NAME (2)      12970099
129800                  MOVE SQLCA   TO  DP013-SQLCA                    12980090
129900                  SET DP013-DB2-ABEND                             12990090
130000                               TO  TRUE                           13000090
130100                  PERFORM DP013-0000-PROCESS-ABEND                13010090
130200         END-EVALUATE                                             13020090
130300     END-PERFORM.                                                 13030090
130400                                                                  13040090
130500     IF  PV-SQL-SUB GREATER THAN PC-MAX-RETRIES                   13050090
130600         MOVE '4310-FETCH-CURSOR'                                 13060090
130700                               TO  DP013-PARAGRAPH                13070090
130800         MOVE 'MAX RETRIES EXCEEDED FOR FETCH CURSOR'             13080090
130900                               TO  DP013-MESSAGE-TEXT (1)         13090090
131000         MOVE SQLCA            TO  DP013-SQLCA                    13100090
131100         SET DP013-DB2-ABEND   TO  TRUE                           13110090
131200         PERFORM DP013-0000-PROCESS-ABEND                         13120090
131300     END-IF                                                       13130090
131400     .                                                            13140090
131500                                                                  13150090
131600*----------------------------------------------------------------*13160096
131700*    CHECK FOR ANY EXPENSE INVOICES IN PENDING (PR) STATUS FOR   *13170096
131800*    THE PURCHASE ORDER ENTERED.                                 *13180097
131900*----------------------------------------------------------------*13190096
132000                                                                  13200096
132100 4350-CHECK-FOR-PENDING-EXPINVC.                                  13210096
132200                                                                  13220096
132300     INITIALIZE DP013-DB2-INFO.                                   13230099
132400                                                                  13240096
132500     IF ASC-RELEASE-REQUESTED                                     13250097
132600        PERFORM                                                   13260097
132700            WITH TEST AFTER                                       13270097
132800            VARYING PV-SQL-SUB                                    13280097
132900            FROM 1 BY 1                                           13290097
133000            UNTIL PV-SQL-SUB GREATER THAN PC-MAX-RETRIES          13300097
133100               OR SQLCODE = 0                                     13310097
133200               OR SQLCODE = +100                                  13320097
133300                                                                  13330097
133400            EXEC SQL                                              13340099
133500              SELECT '1'                                          13350099
133600                INTO  :PV-ONE                                     13360099
133700                FROM SYSIBM.SYSDUMMY1 X                           13370099
133800               WHERE EXISTS                                       13380099
133900                    (SELECT 1                                     13390099
134000                       FROM  TINVOIC A                            13400099
134100                      WHERE A.PO_NBR        = :ASC-KEY-PO-NBR     13410099
134200                        AND A.INVC_TYP_CDE  = 'EI'                13420099
134300                        AND A.STATUS_CDE    = 'PR'                13430099
134400                        AND X.IBMREQD       = X.IBMREQD)          13440099
134500            END-EXEC                                              13450099
134600                                                                  13460097
134700            EVALUATE TRUE                                         13470097
134800                WHEN SQLCODE = ZERO                               13480097
134900                   SET ASC-PENDING-EXPINVC-FOUND TO TRUE          13490099
135000                WHEN SQLCODE = +100                               13500097
135100                   SET ASC-PENDING-EXPINVC-NOT-FOUND TO TRUE      13510099
135200                WHEN SQLCODE = -904                               13520097
135300                WHEN SQLCODE = -913                               13530097
135400                   CONTINUE                                       13540097
135500                WHEN OTHER                                        13550097
135600                     MOVE '4350-CHECK-FOR-PENDING-EXPINVC'        13560097
135700                                  TO  DP013-PARAGRAPH             13570097
135800                     MOVE 'UNSUCCESSFUL SELECT COUNT'             13580097
135900                                  TO  DP013-MESSAGE-TEXT (1)      13590097
136000                     MOVE 'TINVOIC' TO DP013-DB2-TABLE-NAME (1)   13600099
136100                     MOVE SPACES    TO DP013-DB2-TABLE-NAME (2)   13610099
136200                     MOVE SQLCA   TO  DP013-SQLCA                 13620097
136300                     SET DP013-DB2-ABEND                          13630097
136400                                  TO  TRUE                        13640097
136500                     PERFORM DP013-0000-PROCESS-ABEND             13650097
136600            END-EVALUATE                                          13660097
136700        END-PERFORM                                               13670097
136800                                                                  13680097
136900        IF  PV-SQL-SUB GREATER THAN PC-MAX-RETRIES                13690097
137000            MOVE '4350-CHECK-FOR-PENDING-EXPINVC'                 13700097
137100                                  TO  DP013-PARAGRAPH             13710097
137200            MOVE 'MAX RETRIES EXCEEDED FOR SELECT COUNT'          13720097
137300                                  TO  DP013-MESSAGE-TEXT (1)      13730097
137400            MOVE SQLCA            TO  DP013-SQLCA                 13740097
137500            SET DP013-DB2-ABEND   TO  TRUE                        13750097
137600            PERFORM DP013-0000-PROCESS-ABEND                      13760097
137700        END-IF.                                                   13770099
137800                                                                  13780097
137900                                                                  13790097
138000*----------------------------------------------------------------*13800096
138100*    FORMAT THE MAP AND DETERMINE THE CURSOR POSITION.           *13810090
138200*----------------------------------------------------------------*13820090
138300                                                                  13830090
138400 4400-MOVE-COMMAREA-TO-SCREEN.                                    13840090
138500                                                                  13850090
138600     MOVE ASC-KEY-PO-NBR         TO APONBRO.                      13860090
138700     MOVE ASC-VENDOR-NBR         TO AVNDNBRO.                     13870090
138800     MOVE ASC-VENDOR-NAME        TO AVNDNMEO.                     13880090
138900                                                                  13890090
139000     IF  (((PV-TOP-ITEM > ASC-ITEM-NUMBER (1 1))                  13900090
139100         AND (PV-TOP-ITEM > ASC-ITEM-NUMBER (2 1)))               13910090
139200         OR  (PV-TOP-ITEM < ASC-ITEM-NUMBER (1 1)))               13920090
139300             DIVIDE PV-TOP-ITEM BY PC-ITEMS-PER-PANEL             13930090
139400                 GIVING PV-BLOCK-NUMBER                           13940090
139500                 REMAINDER PV-REMAINDER                           13950090
139600             IF  PV-REMAINDER > ZERO                              13960090
139700                 ADD +1          TO PV-BLOCK-NUMBER               13970090
139800             END-IF                                               13980090
139900             MOVE +1             TO ASC-BLK-SUB                   13990090
140000             PERFORM 4410-READ-TEMP-STORAGE                       14000090
140100             ADD +1              TO ASC-BLK-SUB                   14010090
140200                                    PV-BLOCK-NUMBER               14020090
140300             PERFORM 4410-READ-TEMP-STORAGE                       14030090
140400     END-IF.                                                      14040090
140500     MOVE +1                     TO ASC-BLK-SUB.                  14050090
140600     COMPUTE ASC-ITEM-SUB =                                       14060090
140700         ((PV-TOP-ITEM - ASC-ITEM-NUMBER (1 1))                   14070090
140800         + PC-ITEMS-PER-PANEL).                                   14080090
140900                                                                  14090090
141000     IF  ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                        14100090
141100         ADD +1                  TO ASC-BLK-SUB                   14110090
141200         SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-SUB            14120090
141300     END-IF.                                                      14130090
141400                                                                  14140090
141500     COMPUTE ASC-ITEM-AT-BOT-OF-PANEL =                           14150090
141600         ((PV-TOP-ITEM + PC-ITEMS-PER-PANEL) - 1).                14160090
141700     PERFORM 4420-FORMAT-LINES                                    14170090
141800         VARYING PS-SUB                                           14180090
141900         FROM PC-ITEMS-PER-PANEL BY -1                            14190090
142000         UNTIL PS-SUB < +1.                                       14200090
142100                                                                  14210090
142200     MOVE PV-TOP-ITEM              TO ASC-ITEM-AT-TOP-OF-PANEL    14220090
142300                                      ASTRTITO.                   14230090
142400     MOVE ASC-ITEM-AT-BOT-OF-PANEL TO AENDITO.                    14240090
142500     MOVE ASC-NUMBER-OF-ITEMS-READ TO ATOTITO.                    14250090
142600     MOVE ASC-ITEMS-UPDATED        TO AUPDITO.                    14260090
142700                                                                  14270090
142800     IF  DP020-MSG-NUMBER-X = SPACE                               14280090
142900         IF  ASC-ITEM-AT-BOT-OF-PANEL < ASC-NUMBER-OF-ITEMS-READ  14290090
143000*            --- MORE ITEMS TO DISPLAY ----                       14300090
143100             MOVE PC-TSYMSG-00279  TO DP020-MSG-NUMBER            14310090
143200             SET DP020-MSG-INFORMATIONAL TO TRUE                  14320090
143300         END-IF                                                   14330090
143400     END-IF.                                                      14340090
143500                                                                  14350090
143600*----------------------------------------------------------------*14360090
143700*    READ A BLOCK FROM TEMPORARY STORAGE INTO THE ARRAY.         *14370090
143800*----------------------------------------------------------------*14380090
143900                                                                  14390090
144000 4410-READ-TEMP-STORAGE.                                          14400090
144100                                                                  14410090
144200     EXEC CICS                                                    14420090
144300         READQ TS                                                 14430090
144400             QUEUE (ASC-QUEUE-NAME)                               14440090
144500             INTO  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))               14450090
144600             ITEM  (PV-BLOCK-NUMBER)                              14460090
144700             LENGTH(PV-QUEUE-LENGTH)                              14470099
144800             RESP  (PV-CICS-RESP)                                 14480090
144900     END-EXEC.                                                    14490090
145000                                                                  14500090
145100     IF  ((PV-CICS-RESP = DFHRESP (NORMAL))                       14510090
145200       OR (PV-CICS-RESP = DFHRESP (ITEMERR)))                     14520090
145300         CONTINUE                                                 14530090
145400     ELSE                                                         14540090
145500         SET DP013-CICS-ABEND TO  TRUE                            14550090
145600         SET DP013-NO-ROLLBACK TO  TRUE                           14560090
145700         MOVE '4410-READ-TEMP-STORAGE'                            14570090
145800                               TO  DP013-PARAGRAPH                14580090
145900         MOVE 'ERROR TRYING TO READ FROM TEMP STORAGE QUEUE'      14590090
146000                               TO  DP013-MESSAGE-TEXT(1)          14600090
146100         PERFORM DP013-0000-PROCESS-ABEND                         14610090
146200     END-IF.                                                      14620090
146300                                                                  14630090
146400     IF  PV-CICS-RESP = DFHRESP (ITEMERR)                         14640090
146500         INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)               14650090
146600     END-IF.                                                      14660090
146700                                                                  14670090
146800*----------------------------------------------------------------*14680090
146900*    PROCESS THE ITEMS IN THE ARRAY AND MOVE THEM TO THE MAP.    *14690090
147000*----------------------------------------------------------------*14700090
147100                                                                  14710090
147200 4420-FORMAT-LINES.                                               14720090
147300                                                                  14730090
147400     IF  ASC-ITEM-AT-BOT-OF-PANEL > ASC-NUMBER-OF-ITEMS-READ      14740090
147500         SUBTRACT +1 FROM ASC-ITEM-AT-BOT-OF-PANEL                14750090
147600         MOVE SPACE              TO                               14760090
147700                                    MR-INVC-NBR    (PS-SUB)       14770090
147800                                    MR-INVC-DTE    (PS-SUB)       14780090
147900                                    MR-STR-NBR-X   (PS-SUB)       14790090
148000                                    MR-TYPE        (PS-SUB)       14800090
148100                                    MR-ENTR-MTHD   (PS-SUB)       14810090
148200                                    MR-STATUS      (PS-SUB)       14820090
148300                                    MR-GROSS-AMT-X (PS-SUB)       14830090
148400                                    MR-ENTR-DTE    (PS-SUB)       14840090
148500     ELSE                                                         14850090
148600         IF  PV-TOP-ITEM NOT = ASC-ITEM-AT-TOP-OF-PANEL           14860090
148700             MOVE ASC-INVC-NBR (ASC-BLK-SUB ASC-ITEM-SUB)         14870090
148800                                 TO MR-INVC-NBR (PS-SUB)          14880090
148900             MOVE ASC-INVC-DTE (ASC-BLK-SUB ASC-ITEM-SUB)         14890090
149000                                 TO PV-DATE-FORMAT-DB2            14900090
149100             MOVE PV-DATE-DB2-MM TO PV-DATE-MM                    14910090
149200             MOVE PV-DATE-DB2-DD TO PV-DATE-DD                    14920090
149300             MOVE PV-DATE-DB2-CC TO PV-DATE-CC                    14930090
149400             MOVE PV-DATE-DB2-YY TO PV-DATE-YY                    14940090
149500             MOVE PV-DATE-FORMAT TO MR-INVC-DTE (PS-SUB)          14950090
149600             MOVE ASC-STR-NBR (ASC-BLK-SUB ASC-ITEM-SUB)          14960090
149700                                 TO PV-STR-NBR                    14970099
149800             MOVE PV-STR-NBR     TO MR-STR-NBR-N (PS-SUB)         14980099
149900             MOVE ASC-TYPE (ASC-BLK-SUB ASC-ITEM-SUB)             14990090
150000                                 TO MR-TYPE (PS-SUB)              15000090
150100             MOVE ASC-ENTR-MTHD (ASC-BLK-SUB ASC-ITEM-SUB)        15010090
150200                                 TO MR-ENTR-MTHD (PS-SUB)         15020090
150300             MOVE ASC-STATUS (ASC-BLK-SUB ASC-ITEM-SUB)           15030090
150400                                 TO MR-STATUS (PS-SUB)            15040090
150500             MOVE ASC-GROSS-AMT (ASC-BLK-SUB ASC-ITEM-SUB)        15050090
150600                                 TO MR-GROSS-AMT-N (PS-SUB)       15060090
150700             MOVE ASC-CRE-DTE (ASC-BLK-SUB ASC-ITEM-SUB)          15070099
150800                                 TO PV-DATE-FORMAT-DB2            15080090
150900             MOVE PV-DATE-DB2-MM TO PV-DATE-MM                    15090090
151000             MOVE PV-DATE-DB2-DD TO PV-DATE-DD                    15100090
151100             MOVE PV-DATE-DB2-CC TO PV-DATE-CC                    15110090
151200             MOVE PV-DATE-DB2-YY TO PV-DATE-YY                    15120090
151300             MOVE PV-DATE-FORMAT TO MR-ENTR-DTE (PS-SUB)          15130090
151400         END-IF                                                   15140090
151500     END-IF.                                                      15150090
151600                                                                  15160090
151700*  IF BAD DATA SET THE STATUS ATTRB TO YELLOW, BRIGHT,            15170090
151800*   OTHERWISE RESET IT.                                           15180090
151900     IF ASC-STATUS (ASC-BLK-SUB ASC-ITEM-SUB) = 'OB'              15190090
152000       OR ASC-STATUS (ASC-BLK-SUB ASC-ITEM-SUB) = 'IB'            15200090
152100         MOVE PC-TSYMSG-00807  TO DP020-MSG-NUMBER                15210090
152200         MOVE DP015-PRO-BRT-OFF  TO MR-STATUSA (PS-SUB)           15220090
152300         MOVE DP015-YELLOW       TO MR-STATUSC (PS-SUB)           15230090
152400         SET DP020-MSG-WARNING                                    15240090
152500             PS-ERROR            TO TRUE                          15250090
152600     ELSE                                                         15260090
152700         MOVE DP015-PRO-NOR-OFF  TO MR-STATUSA (PS-SUB)           15270090
152800         MOVE DP015-BLUE         TO MR-STATUSC (PS-SUB)           15280090
152900     END-IF                                                       15290090
153000                                                                  15300090
153100     SUBTRACT +1 FROM ASC-ITEM-SUB.                               15310090
153200     IF  ASC-ITEM-SUB < + 1                                       15320090
153300         MOVE PC-ITEMS-PER-PANEL TO ASC-ITEM-SUB                  15330090
153400         MOVE +1                 TO ASC-BLK-SUB                   15340090
153500     END-IF.                                                      15350090
153600                                                                  15360090
153700*----------------------------------------------------------------*15370090
153800*    WRITE A NEW BLOCK FROM THE ARRAY TO TEMPORARY STORAGE.      *15380090
153900*----------------------------------------------------------------*15390090
154000                                                                  15400090
154100 5100-WRITE-TEMP-STORAGE.                                         15410090
154200                                                                  15420090
154300     MOVE ASC-ITEM-NUMBER(ASC-BLK-SUB 1)                          15430090
154400                               TO  PV-ITEM-NUMBER.                15440090
154500     COMPUTE PV-HIGHEST-BLOCK-WRITTEN =                           15450090
154600         ASC-HIGHEST-BLOCK-WRITTEN + 1.                           15460090
154700                                                                  15470090
154800     EXEC CICS                                                    15480090
154900         WRITEQ TS                                                15490090
155000             QUEUE (ASC-QUEUE-NAME)                               15500090
155100             FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))               15510090
155200             ITEM  (PV-HIGHEST-BLOCK-WRITTEN)                     15520090
155300             LENGTH(PV-QUEUE-LENGTH)                              15530099
155400             RESP  (PV-CICS-RESP)                                 15540090
155500     END-EXEC.                                                    15550090
155600                                                                  15560090
155700     IF  PV-CICS-RESP NOT = DFHRESP (NORMAL)                      15570090
155800         SET DP013-CICS-ABEND    TO TRUE                          15580090
155900         SET DP013-NO-ROLLBACK   TO TRUE                          15590090
156000         MOVE '5100-WRITE-TEMP-STORAGE'                           15600090
156100                                 TO  DP013-PARAGRAPH              15610090
156200         MOVE 'ATTEMPTING TO WRITE TEMP STORAGE LIST BLOCK'       15620090
156300                                 TO  DP013-MESSAGE-TEXT(1)        15630090
156400         PERFORM DP013-0000-PROCESS-ABEND                         15640090
156500     END-IF.                                                      15650090
156600     ADD +1                      TO  ASC-HIGHEST-BLOCK-WRITTEN.   15660090
156700                                                                  15670090
156800*----------------------------------------------------------------*15680090
156900*  REWRITE THE TEMP STORAGE QUEUE FROM THE APPLICATION-SPECIFIC- *15690090
157000*  COMMAREA.                                                     *15700090
157100*----------------------------------------------------------------*15710090
157200                                                                  15720090
157300 5105-REWRITE-TEMP-STORAGE.                                       15730090
157400                                                                  15740090
157500     EXEC CICS                                                    15750090
157600        WRITEQ TS                                                 15760090
157700             QUEUE (ASC-QUEUE-NAME)                               15770090
157800            FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))                15780090
157900             ITEM  (PV-BLOCK-NUMBER)                              15790090
158000             LENGTH(PV-QUEUE-LENGTH)                              15800099
158100            REWRITE                                               15810090
158200             RESP  (PV-CICS-RESP)                                 15820090
158300     END-EXEC.                                                    15830090
158400                                                                  15840090
158500     IF PV-CICS-RESP NOT = DFHRESP(NORMAL)                        15850090
158600         SET DP013-CICS-ABEND    TO TRUE                          15860090
158700         SET DP013-NO-ROLLBACK   TO TRUE                          15870090
158800         MOVE '5105-REWRITE-TEMP-STORAGE'                         15880090
158900                                  TO DP013-PARAGRAPH              15890090
159000         MOVE 'ATTEMPTING TO REWRITE TEMP STORAGE QUEUE'          15900090
159100                                  TO DP013-MESSAGE-TEXT(1)        15910090
159200         PERFORM DP013-0000-PROCESS-ABEND                         15920090
159300     END-IF.                                                      15930090
159400                                                                  15940090
159500*----------------------------------------------------------------*15950090
159600*  GET THE CURRENT DATE                                          *15960099
159700*----------------------------------------------------------------*15970090
159800                                                                  15980090
159900 5999-GET-CURRENT-DATE.                                           15990099
160000                                                                  16000090
160100     EXEC SQL                                                     16010099
160200         SET :ASC-CURRENT-DATE      = CURRENT DATE                16020099
160300     END-EXEC.                                                    16030099
160400                                                                  16040099
160500*----------------------------------------------------------------*16050099
160600*  MODIFY TEMP STORAGE MODULE                                    *16060099
160700*----------------------------------------------------------------*16070099
160800                                                                  16080099
160900 6000-MODIFY-TEMPSTOR-QUEUE.                                      16090099
161000                                                                  16100099
161100     IF ASC-RELEASE-REQUESTED                                     16110099
161200         IF ASC-STATUS (ASC-BLK-SUB, ASC-ITEM-SUB) = 'EN'         16120099
161300           OR ASC-STATUS (ASC-BLK-SUB, ASC-ITEM-SUB) = 'RC'       16130099
161400           OR ASC-STATUS (ASC-BLK-SUB, ASC-ITEM-SUB) = 'PJ'       16140099
161500             SET ASC-NEW-BM (ASC-BLK-SUB, ASC-ITEM-SUB)           16150099
161600                 ASC-ITEM-UPD (ASC-BLK-SUB, ASC-ITEM-SUB)         16160099
161700                 ASC-UPD-DATA    TO TRUE                          16170099
161800         END-IF                                                   16180099
161900     ELSE                                                         16190099
162000         IF ASC-STATUS (ASC-BLK-SUB, ASC-ITEM-SUB) = 'BM'         16200099
162100            SET ASC-ITEM-UPD (ASC-BLK-SUB, ASC-ITEM-SUB)          16210099
162200                ASC-UPD-DATA    TO TRUE                           16220099
162300            IF ASC-CRE-DTE (ASC-BLK-SUB, ASC-ITEM-SUB) =          16230099
162400                       ASC-CURRENT-DATE                           16240099
162500               SET ASC-NEW-EN (ASC-BLK-SUB, ASC-ITEM-SUB) TO TRUE 16250099
162600            ELSE                                                  16260099
162711               SET PS-INFOR-NEXUS-NO TO TRUE                      16271199
162711               PERFORM 1120-GET-IMPRT-CHRG-CDE                    16271299
162711               IF ASC-VENDOR-NBR = PC-LI-FUNG-NBR                 16271399
162711               OR PS-INFOR-NEXUS-YES                              16271499
162712                  SET ASC-NEW-PJ (ASC-BLK-SUB, ASC-ITEM-SUB)      16271599
162713                      TO TRUE                                     16271699
162740               ELSE                                               16274099
162750                  SET ASC-NEW-EN (ASC-BLK-SUB, ASC-ITEM-SUB)      16275099
162760                      TO TRUE                                     16276099
162800               END-IF                                             16280099
162810            END-IF                                                16281099
162900         END-IF                                                   16290099
163000     END-IF.                                                      16300099
163100                                                                  16310099
163200*----------------------------------------------------------------*16320099
163300*  UPDATE DATABASE WITH MODIFIED TEMP STORAGE                     16330099
163400*----------------------------------------------------------------*16340099
163500 6100-UPDATE-INVOICES.                                            16350099
163600                                                                  16360099
163700     MOVE +1                 TO PV-BLOCK-NUMBER                   16370099
163800     PERFORM                                                      16380099
163900      VARYING ASC-BLK-SUB   FROM +1 BY +1                         16390099
164000       UNTIL PV-BLOCK-NUMBER > ASC-HIGHEST-BLOCK-WRITTEN          16400099
164100                                                                  16410099
164200         PERFORM 4410-READ-TEMP-STORAGE                           16420099
164300                                                                  16430099
164400         PERFORM 6150-UPDATE-TINVOIC                              16440099
164500          VARYING ASC-ITEM-SUB  FROM +1 BY +1                     16450099
164600           UNTIL ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                16460099
164700                                                                  16470099
164800         PERFORM 5105-REWRITE-TEMP-STORAGE                        16480099
164900                                                                  16490099
165000         ADD +1              TO PV-BLOCK-NUMBER                   16500099
165100                                                                  16510099
165200     END-PERFORM                                                  16520099
165300     .                                                            16530099
165400                                                                  16540099
165500 6150-UPDATE-TINVOIC.                                             16550099
165600                                                                  16560099
165700     IF ASC-ITEM-UPD (ASC-BLK-SUB, ASC-ITEM-SUB)                  16570099
165800         MOVE ASC-NEW-STATUS (ASC-BLK-SUB, ASC-ITEM-SUB)          16580099
165900                             TO PV-NEW-STATUS                     16590099
166000                                ASC-STATUS                        16600099
166100                                      (ASC-BLK-SUB, ASC-ITEM-SUB) 16610099
166200         MOVE ASC-INVC-NBR   (ASC-BLK-SUB, ASC-ITEM-SUB)          16620099
166300                             TO PV-INVC-ID                        16630099
166400                                                                  16640099
166500         PERFORM                                                  16650099
166600          WITH TEST AFTER                                         16660099
166700          VARYING PV-RETRY-COUNTER FROM 1 BY 1                    16670099
166800           UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)             16680099
166900                 OR (SQLCODE = +0))                               16690099
167000                                                                  16700099
167100             EXEC SQL UPDATE TINVOIC                              16710099
167200                 SET STATUS_CDE         = :PV-NEW-STATUS          16720099
167300                    ,STATUS_CHG_TMST    = CURRENT TIMESTAMP       16730099
167400                                                                  16740099
167500                 WHERE PO_NBR   = :ASC-KEY-PO-NBR                 16750099
167600                   AND INVC_ID  = :PV-INVC-ID                     16760099
167700             END-EXEC                                             16770099
167800                                                                  16780099
167900             EVALUATE TRUE                                        16790099
168000                 WHEN SQLCODE = +0                                16800099
168100                    COMPUTE ASC-ITEMS-UPDATED =                   16810099
168200                                  ASC-ITEMS-UPDATED + 1           16820099
168300                 WHEN SQLCODE = -904                              16830099
168400                 WHEN SQLCODE = -913                              16840099
168500                     CONTINUE                                     16850099
168600                                                                  16860099
168700                 WHEN SQLWARN0 NOT = SPACES                       16870099
168800                 WHEN SQLCODE < +0                                16880099
168900                 WHEN SQLCODE > +0                                16890099
169000                     MOVE '6150-UPDATE-TINVOIC'                   16900099
169100                                 TO DP013-PARAGRAPH               16910099
169200                     MOVE 'UPDATE A ROW ON TINVOIC'               16920099
169300                                 TO DP013-MESSAGE-TEXT(1)         16930099
169400                     MOVE SQLCA  TO DP013-SQLCA                   16940099
169500                     MOVE 'TINVOIC'                               16950099
169600                                 TO DP013-DB2-TABLE-NAME (1)      16960099
169700                     SET DP013-DB2-ABEND                          16970099
169800                         DP013-XCTL-DISPLAY-RESTART               16980099
169900                                 TO TRUE                          16990099
170000                     PERFORM DP013-0000-PROCESS-ABEND             17000099
170100             END-EVALUATE                                         17010099
170200         END-PERFORM                                              17020099
170300                                                                  17030099
170400         IF PV-RETRY-COUNTER > PC-MAX-RETRIES                     17040099
170500             MOVE '6150-UPDATE-TINVOIC'                           17050099
170600                                 TO DP013-PARAGRAPH               17060099
170700             MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '          17070099
170800                                 TO DP013-MESSAGE-TEXT (1)        17080099
170900             MOVE 'TO UPDATE A TINVOIC ROW'                       17090099
171000                                 TO DP013-MESSAGE-TEXT (2)        17100099
171100             MOVE SQLCA          TO DP013-SQLCA                   17110099
171200             MOVE 'TINVOIC'      TO DP013-DB2-TABLE-NAME (1)      17120099
171300             SET DP013-DB2-ABEND                                  17130099
171400                 DP013-XCTL-DISPLAY-RESTART                       17140099
171500                                 TO TRUE                          17150099
171600             PERFORM DP013-0000-PROCESS-ABEND                     17160099
171700         END-IF                                                   17170099
171800     END-IF                                                       17180099
171900     .                                                            17190099
172000                                                                  17200099
172100*----------------------------------------------------------------*17210099
172200*    ABEND PROCESSOR MODULE                                      *17220099
172300*----------------------------------------------------------------*17230099
172400                                                                  17240099
172500     COPY DPPD013.                                                17250099
