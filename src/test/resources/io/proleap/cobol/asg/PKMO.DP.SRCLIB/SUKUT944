000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300 PROGRAM-ID.             sukut944.                                00030000
000400 AUTHOR.                 DENISE HAHN.                             00040000
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050000
000600 DATE-WRITTEN.           March, 2016.                             00060000
000700 DATE-COMPILED.                                                   00070000
000800***************************************************************** 00080000
001000*                                                               * 00100000
001100*  MACON DC lost diverts due to virtual conveyor server being   * 00110000
001200*  brought up by the server team incorrectly - lost diverts     * 00120000
001300*                                                               * 00130000
001400*  200+ CARTONS KICKED OUT                                      * 00140000
001500*  THE FILE GENERATED FROM THIS PROGRAM WILL BE FED INTO        * 00150000
001600*  SUKUT944 TO GENERATE SQL INSERT STATEMENTS INTO tsucdot      * 00160004
001700*                                                               * 00170000
001800***************************************************************** 00180000
001900 ENVIRONMENT DIVISION.                                            00190000
002000 CONFIGURATION SECTION.                                           00200000
002100                                                                  00210000
002200 SOURCE-COMPUTER.        IBM-3090.                                00220000
002300 OBJECT-COMPUTER.        IBM-3090.                                00230000
002400                                                                  00240000
002500***************************************************************** 00250000
002600 INPUT-OUTPUT SECTION.                                            00260000
002700                                                                  00270000
002800 FILE-CONTROL.                                                    00280000
002900                                                                  00290000
003000     SELECT carton-FILE                                           00300000
003100         ASSIGN TO inp01.                                         00310000
003200                                                                  00320000
003300***************************************************************** 00330000
003400 DATA DIVISION.                                                   00340000
003500***************************************************************** 00350000
003600 FILE SEction.                                                    00360016
003700                                                                  00370000
003800 FD  carton-FILE                                                  00380000
003900     RECORDING MODE IS F                                          00390000
004000     BLOCK CONTAINS 0  RECORDS.                                   00400000
004100 01  carton-RECORD                   PIC X(80).                   00410000
004200                                                                  00420000
004300***************************************************************** 00430000
004400 WORKING-STORAGE SECTION.                                         00440000
004500                                                                  00450000
004510******************************************************************00451001
004520*  INPUT RECORD LAYOUT                                            00452001
004530******************************************************************00453001
004540 01  PV-carton-RECORD.                                            00454003
004550     10  PV-oper                      PIC  9(04).                 00455020
004551     10  filler                       PIC  x(01).                 00455112
004552     10  PV-store                     PIC  9(04).                 00455220
004553     10  filler                       PIC  x(01).                 00455320
004554     10  PV-SHIPT-UNT-ID              PIC  9(20).                 00455409
004555     10  PV-SHIPT-UNT-ID-r redefines pv-shipt-unt-id.             00455504
004556         15  PV-SHIPT-1-5             PIC  9(05).                 00455609
004557         15  PV-STORE-NBR             PIC  9(04).                 00455704
004558         15  PV-SHIPT-10-20           PIC  9(11).                 00455820
004560     10  FILLER                       PIC  X(55).                 00456012
004570                                                                  00457001
004600 01  PROGRAM-SWITCHES.                                            00460000
004700     05  PS-Error-sw                 PIC X(01) VALUE 'N'.         00470005
004800         88  PS-error                          VALUE 'Y'.         00480005
004900         88  PS-NO-error                       VALUE 'N'.         00490005
004901     05  PS-EOF-sw                   PIC X(01) VALUE 'N'.         00490105
004902         88  PS-EOF                            VALUE 'Y'.         00490205
004903         88  PS-NOT-EOF                        VALUE 'N'.         00490305
004910     05  ps-door-asgmt-sw            PIC X(01) VALUE ' '.         00491001
004920         88  PS-door-asgmt                     VALUE '1'.         00492001
004930         88  PS-no-door-asgmt                  VALUE '2'.         00493001
004940         88  PS-mult-door-asgmt                VALUE '3'.         00494001
005000                                                                  00500000
005500 01  PC-PROGRAM-CONSTANTS.                                        00550000
005600     05  PC-sukut944                 PIC X(08) VALUE              00560000
005700                                               'sukut944'.        00570000
005800     05  PC-DEFAULT-TMST             PIC X(26)  VALUE             00580000
005900                                    '9999-09-09-09.09.09.999999'. 00590000
006000                                                                  00600000
006100                                                                  00610000
006200     05  PV-READ-COUNT                PIC 9(09)  VALUE ZERO.      00620000
006210     05  PV-divert-count              PIC 9(09)  VALUE ZERO.      00621005
006220     05  PV-shon-COUNT                PIC 9(09)  VALUE ZERO.      00622005
006230     05  PV-no-trip-count             PIC 9(09)  VALUE ZERO.      00623005
006240     05  PV-str-scan-count            PIC 9(09)  VALUE ZERO.      00624024
006300     05  PV-READ-COUNT-2              PIC 9(09)  VALUE ZERO.      00630000
006400     05  PV-WRITE-COUNT               PIC 9(09)  VALUE ZERO.      00640000
006401                                                                  00640105
006410     05  PV-disp-trip                 PIC z(09)  VALUE ZERO.      00641005
006420     05  PV-disp-count                PIC zzz,zzz,zz9.            00642005
006421     05  PV-disp-store                PIC 9999.                   00642108
006430     05  PV-disp-sql                  PIC -999.                   00643006
006500                                                                  00650000
006600     05  PV-DVRT-NBR.                                             00660000
006700         10  PV-DVRT-1-5               PIC X(05).                 00670000
006800         10  PV-DVRT-6-9               PIC X(4).                  00680000
006900                                                                  00690000
007000     05  PV-WORK-DATE.                                            00700000
007100         10   PV-WORK-YY              PIC X(4).                   00710000
007200         10   PV-WORK-MM              PIC X(02).                  00720000
007300         10   PV-WORK-DD              PIC X(02).                  00730000
007400     05  PV-DATE.                                                 00740000
007500         10  PV-DATE-YEAR             PIC X(04).                  00750000
007600         10  PV-DATE-DASH1            PIC X.                      00760000
007700         10  PV-DATE-MONTH            PIC XX.                     00770000
007800         10  PV-DATE-DASH2            PIC X.                      00780000
007900         10  PV-DATE-DAY              PIC XX.                     00790000
008000                                                                  00800000
008100     05  PV-WORK-TIME.                                            00810000
008200         10  PV-WORK-HOUR             PIC XX.                     00820000
008300         10  PV-WORK-MIN              PIC XX.                     00830000
008400         10  PV-WORK-SEC              PIC XX.                     00840000
008500     05  PV-TIME.                                                 00850000
008600         10  PV-TIME-HOUR             PIC XX.                     00860000
008700         10  PV-TIME-COLON1           PIC X.                      00870000
008800         10  PV-TIME-MIN              PIC XX.                     00880000
008900         10  PV-TIME-COLON2           PIC X.                      00890000
009000         10  PV-TIME-SEC              PIC XX.                     00900000
009100                                                                  00910000
009200     05  PV-SQLCODE                  PIC 9(09) VALUE ZERO.        00920000
009300     05  PV-DISP-SQLCODE             PIC -999.                    00930000
009400                                                                  00940000
009500                                                                  00950000
009600 01  PV-ABEND-FIELDS.                                             00960000
009700     05  PV-ABEND-CODE               PIC S9(4) VALUE +0           00970000
009800                                               COMP SYNC.         00980000
009900     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'sukut944'.  00990000
010000     05  PV-ABEND-PARAGRAPH          PIC X(50) VALUE SPACES.      01000000
010100     05  PV-ABEND-OPERATION          PIC X(50) VALUE SPACES.      01010000
010200     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01020000
010300     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01030000
010400     05  PV-DB2-OPERATION-MESSAGE-2  PIC X(79) VALUE SPACES.      01040000
010500     05  PV-DB2-OPERATION-MESSAGE-3  PIC X(79) VALUE SPACES.      01050000
010600     05  PV-DB2-OPERATION-MESSAGE-4  PIC X(79) VALUE SPACES.      01060000
010700     05  PV-DB2-TABLE-NAME-1         PIC X(08) VALUE SPACES.      01070000
010800     05  PV-DB2-TABLE-NAME-2         PIC X(08) VALUE SPACES.      01080000
010900                                                                  01090000
011000     05  PV-DISPLAY-OPER             PIC  9(04) VALUE ZEROES.     01100000
011100     05  PV-DISPLAY-SQLCODE          PIC  9(03)- VALUE ZEROES.    01110000
011200     05  PV-DB2-TABLE-NAME1          PIC  X(15) VALUE SPACES.     01120000
011300                                                                  01130000
011400     05  PV-DISPLAY-READ-COUNT1      PIC ZZZ,ZZZ,ZZ9.             01140000
011500     05  PV-DISPLAY-WRITE-COUNT      PIC ZZZ,ZZZ,ZZ9.             01150000
011600 01  DK-DB-KEYS.                                                  01160000
011700     05  DK-SHIPT-UNT-ID             PIC S9(18)V COMP-3.          01170000
011800     05  DK-OPER                     PIC S9(04) COMP.             01180000
011900     05  DK-DIVERT-TMST              PIC  X(26).                  01190000
012000                                                                  01200000
012261                                                                  01226100
012270******************************************************************01227000
012300* OUTPUT RECORD LAYOUT                                            01230000
012400******************************************************************01240000
012500     COPY SURD945.                                                01250000
012600                                                                  01260000
012700******************************************************************01270000
012800*  USED FOR DB2 ERROR MESSAGE BUILDING                            01280000
012900******************************************************************01290000
013000     COPY DPWS004.                                                01300000
013100                                                                  01310000
013200******************************************************************01320000
013300*   DB2 SQL COMMUNICATION AREA                                    01330000
013400******************************************************************01340000
013500     EXEC SQL                                                     01350000
013600          INCLUDE SQLCA                                           01360000
013700     END-EXEC.                                                    01370000
013800                                                                  01380000
013900                                                                  01390000
014000*---------------------------------------------------------------* 01400000
014100*  Tcndcdr                                                        01410001
014200*---------------------------------------------------------------* 01420000
014300     EXEC SQL                                                     01430000
014400          INCLUDE Tcndcdr                                         01440001
014500     END-EXEC.                                                    01450000
014600                                                                  01460000
017170                                                                  01717000
017171*---------------------------------------------------------------* 01717101
017172*  Tcndrst                                                        01717201
017173*---------------------------------------------------------------* 01717301
017174     EXEC SQL                                                     01717401
017175          INCLUDE Tcndrst                                         01717501
017176     END-EXEC.                                                    01717601
017177                                                                  01717701
017178                                                                  01717801
017179*---------------------------------------------------------------* 01717903
017180*  sut_otbnd_loc                                                  01718004
017181*---------------------------------------------------------------* 01718103
017182     EXEC SQL                                                     01718203
017183          INCLUDE sut00027                                        01718304
017184     END-EXEC.                                                    01718403
017185                                                                  01718503
017186*---------------------------------------------------------------* 01718604
017187*  Tsuobtr                                                        01718704
017188*---------------------------------------------------------------* 01718804
017189     EXEC SQL                                                     01718904
017190          INCLUDE Tsuobtr                                         01719004
017191     END-EXEC.                                                    01719104
017192                                                                  01719204
017193*---------------------------------------------------------------* 01719304
017194*  Tsuobts                                                        01719404
017195*---------------------------------------------------------------* 01719504
017196     EXEC SQL                                                     01719604
017197          INCLUDE Tsuobts                                         01719704
017198     END-EXEC.                                                    01719804
017199                                                                  01719904
017200                                                                  01720003
017201*---------------------------------------------------------------* 01720104
017202*  Tsucrdv                                                        01720204
017203*---------------------------------------------------------------* 01720304
017204     EXEC SQL                                                     01720404
017205          INCLUDE Tsucrdv                                         01720504
017206     END-EXEC.                                                    01720604
017207                                                                  01720704
017208                                                                  01720804
017209*---------------------------------------------------------------* 01720924
017210*  sut_otbnd_str_scn                                              01721024
017211*---------------------------------------------------------------* 01721124
017212     EXEC SQL                                                     01721224
017213          INCLUDE sut00121                                        01721325
017214     END-EXEC.                                                    01721424
017215                                                                  01721524
017216                                                                  01721624
017217******************************************************************01721700
017218 PROCEDURE DIVISION.                                              01721800
017220     DISPLAY '**** START OF sukut944 ****'.                       01722000
017300                                                                  01730000
017400*OPEN FILES.                                                      01740000
017500     OPEN input  carton-FILE.                                     01750000
017600                                                                  01760000
017700     SET   PS-NOT-EOF              to  true                       01770002
017900                                                                  01790000
018000     PERFORM 1000-INITIALIZATION.                                 01800000
018100                                                                  01810000
018200     PERFORM 2000-PROCESS-INPUT                                   01820000
018300       UNTIL PS-EOF.                                              01830001
018400                                                                  01840000
018710     move  pv-read-count  to  pv-disp-count                       01871005
018720     DISPLAY '***'                                                01872005
018800     DISPLAY '*   INPUT COUNT:  ' pv-disp-count                   01880005
018810                                                                  01881005
018820     move  pv-divert-count to  pv-disp-count                      01882005
018840     DISPLAY '*   divert count: ' pv-disp-count                   01884005
018850                                                                  01885005
018860     move  pv-shon-count   to  pv-disp-count                      01886005
018870     DISPLAY '*   shon count:   ' pv-disp-count                   01887005
018880                                                                  01888005
018881     move  PV-str-scan-COUNT to  pv-disp-count                    01888126
018882     DISPLAY '*   store scan:   ' pv-disp-count                   01888224
018883                                                                  01888324
018890     move  pv-no-trip-count  to  pv-disp-count                    01889005
018891     DISPLAY '*   no trip count:' pv-disp-count                   01889105
018892                                                                  01889205
018893     move  pv-write-count    to  pv-disp-count                    01889305
018900     DISPLAY '*   INSERT COUNT: ' PV-disp-count                   01890021
019000     DISPLAY '***'.                                               01900000
019100                                                                  01910000
019200*CLOSE FILES.                                                     01920000
019300     CLOSE carton-FILE.                                           01930000
019400                                                                  01940000
019500                                                                  01950000
019600     GOBACK.                                                      01960000
019700                                                                  01970000
019800******************************************************************01980000
019900*  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               *01990000
020000******************************************************************02000000
020100 1000-INITIALIZATION.                                             02010000
020200     DISPLAY '1000-INITIALIZE '.                                  02020000
020300                                                                  02030000
020301     perform 4000-read-input.                                     02030101
020320                                                                  02032001
020600                                                                  02060000
020700                                                                  02070000
020800******************************************************************02080000
020900**  READ INPUT-FILE, WHEN DC CHANGES, DO A PAGE BREAK             02090000
021000******************************************************************02100000
021100 2000-PROCESS-INPUT.                                              02110000
021200                                                                  02120000
021201     SET  PS-NO-ERROR  TO  TRUE.                                  02120104
021210                                                                  02121004
021300     perform 2000-get-current-door.                               02130001
021301     if  ps-door-asgmt                                            02130104
021302         perform 2010-check-if-diverted                           02130204
021303     end-if.                                                      02130304
021304                                                                  02130404
021305     if  ps-door-asgmt  AND                                       02130504
021306         ps-NO-ERROR                                              02130604
021307         perform 2020-check-if-shon                               02130704
021308     end-if.                                                      02130804
021309                                                                  02130904
021310     if  ps-door-asgmt  AND                                       02131024
021311         ps-NO-ERROR                                              02131124
021312         perform 2040-check-str-scan                              02131224
021313     end-if.                                                      02131324
021314                                                                  02131424
021315     if  ps-door-asgmt  AND                                       02131504
021316         ps-NO-ERROR                                              02131604
021317         perform 2030-get-current-trip                            02131704
021318     end-if.                                                      02131804
021319                                                                  02131901
021320     if  ps-door-asgmt  AND                                       02132004
021330         ps-NO-ERROR                                              02133004
021400         PERFORM 7000-create-sql                                  02140002
021500     end-if.                                                      02150001
021600                                                                  02160000
021700     PERFORM 4000-read-input.                                     02170001
021800                                                                  02180000
021900                                                                  02190000
021901*---------------------------------------------------------------- 02190101
021902*                                                                 02190201
021903*---------------------------------------------------------------- 02190301
021910 2000-get-current-door.                                           02191001
021911                                                                  02191101
021912     move space to ps-door-asgmt-sw.                              02191208
021913                                                                  02191301
021914     move pv-store-nbr  to  cndrst-str-nbr.                       02191408
021915     move PV-oper       to  cndrst-oper-unt-id                    02191521
021916                                                                  02191621
021920     EXEC SQL                                                     02192001
021930           Select G.door_id                                       02193001
021931                , h.DIVERT_NBR                                    02193101
021932                , h.DIVERT_LOC_ID                                 02193201
021940             INTO :CNDRST-DOOR-ID                                 02194001
021941                , :CNDCDR-DIVERT-NBR                              02194101
021942                , :CNDCDR-DIVERT-LOC-ID                           02194201
021950             from tcndrst g                                       02195001
021960                , tcndcdr h                                       02196001
021970            where g.OPER_UNT_ID = :cndrst-oper-unt-id             02197021
021980              and g.str_nbr     = :cndrst-str-nbr                 02198001
021990              and g.OPER_UNT_ID = h.oper_unt_id                   02199001
022000              and g.door_id     =  h.door_id                      02200001
022001              and g.STRT_TMST  <=  current timestamp              02200101
022002              and g.END_TMST   >=  current timestamp              02200201
022003              AND h.DOOR_LOC_DESC NOT LIKE '%RE-OPEN%'            02200301
022004              AND h.DOOR_LOC_DESC NOT LIKE '%UPS%'                02200401
022005              AND h.DOOR_LOC_DESC NOT LIKE '%VIRTUAL%'            02200501
022006             WITH UR                                              02200601
022007     END-EXEC.                                                    02200701
022008                                                                  02200801
022009     EVALUATE TRUE                                                02200901
022010         WHEN SQLCODE = ZERO                                      02201001
022011              set  ps-door-asgmt  to  true                        02201101
022013                                                                  02201301
022048         WHEN SQLCODE = -811                                      02204801
022049              set  ps-mult-door-asgmt  to  true                   02204901
022050              display ' Multiple Door Asgmt:'                     02205001
022051                      pv-carton-record                            02205103
022052                                                                  02205201
022053         WHEN SQLCODE = +100                                      02205301
022054              set  ps-no-door-asgmt  to  true                     02205401
022055              move  cndrst-str-nbr  to  pv-disp-store             02205508
022056              display ' store:'  pv-disp-store                    02205608
022057                      ' no door assignment: '                     02205708
022058                      pv-carton-record                            02205808
022059                                                                  02205908
022060                                                                  02206008
022061         WHEN SQLWARN0 NOT = SPACES                               02206108
022062         WHEN SQLCODE < ZERO                                      02206208
022063         WHEN SQLCODE > ZERO                                      02206308
022064             move  SQLCODE to  PV-disp-sql                        02206408
022065             display '2000-get-current-door '                     02206508
022066                   ' SQL:'    pv-disp-sql                         02206608
022067                   ' store:'  pv-store-nbr                        02206708
022068                   ' sml:   ' PV-SHIPT-UNT-ID                     02206808
022069             MOVE '2000-get-current-door    '                     02206908
022070                                 TO PV-ABEND-PARAGRAPH            02207008
022071             MOVE 'get current door      '                        02207108
022072                                 TO PV-ABEND-OPERATION            02207208
022073             PERFORM 9900-DB2-ABEND                               02207308
022074     END-EVALUATE.                                                02207408
022080                                                                  02208000
022100                                                                  02210000
022101*---------------------------------------------------------------- 02210104
022102*                                                                 02210204
022103*---------------------------------------------------------------- 02210304
022110 2010-check-if-diverted.                                          02211004
022111                                                                  02211104
022112     move PV-SHIPT-UNT-ID  TO  SUCRDV-SHIPT-UNT-ID                02211204
022113                                                                  02211304
022114     EXEC SQL                                                     02211404
022115           Select MAX(DIVERT_TMST)                                02211504
022118             INTO :SUCRDV-DIVERT-TMST                             02211804
022121             from tSUCRDV                                         02212104
022123            where SHIPT_UNT_ID  = :SUCRDV-SHIPT-UNT-ID            02212304
022124              and ACTV_CDE      = 'A'                             02212404
022132             WITH UR                                              02213204
022133     END-EXEC.                                                    02213304
022134                                                                  02213404
022135     EVALUATE TRUE                                                02213504
022136         WHEN SQLCODE = ZERO                                      02213604
022137              set  ps-ERROR       to  true                        02213704
022138              ADD  1  TO  PV-DIVERT-COUNT                         02213804
022139              display ' HAS ACTIVE DIVERT:  '                     02213904
022140                      PV-SHIPT-UNT-ID                             02214004
022141                                                                  02214104
022147         WHEN SQLCODE = +100                                      02214704
022148         WHEN SQLCODE = -305                                      02214807
022149              set  ps-no-ERROR       to  true                     02214907
022152                                                                  02215204
022153         WHEN SQLWARN0 NOT = SPACES                               02215304
022154         WHEN SQLCODE < ZERO                                      02215404
022155         WHEN SQLCODE > ZERO                                      02215504
022156             move  SQLCODE to  PV-disp-sql                        02215606
022157             display '2010-check-if-diverted '                    02215706
022158                   ' SQL:'    pv-disp-sql                         02215806
022159                   ' store:'  pv-store-nbr                        02215906
022160                   ' sml:   ' PV-SHIPT-UNT-ID                     02216006
022161             MOVE '2010-check-if-diverted   '                     02216104
022162                                 TO PV-ABEND-PARAGRAPH            02216204
022163             MOVE 'CHECK IF CARTON DIVERTED'                      02216304
022164                                 TO PV-ABEND-OPERATION            02216404
022165             PERFORM 9900-DB2-ABEND                               02216504
022166     END-EVALUATE.                                                02216604
022167                                                                  02216704
022168                                                                  02216804
022169*---------------------------------------------------------------- 02216904
022170*                                                                 02217004
022171*---------------------------------------------------------------- 02217104
022172 2020-check-if-shon.                                              02217204
022173                                                                  02217304
022174     move PV-SHIPT-UNT-ID  TO  SUT00027-SHIPT-UNT-ID              02217404
022175                                                                  02217504
022176     EXEC SQL                                                     02217604
022177           Select CRE_TMST                                        02217705
022178                , OTBND_TRIP_ID                                   02217804
022179             INTO :SUT00027-CRE-TMST                              02217904
022180                , :SUT00027-OTBND-TRIP-ID                         02218004
022181             from SUT_OTBND_LOC                                   02218104
022182            where SHIPT_UNT_ID  = :SUT00027-SHIPT-UNT-ID          02218204
022183              and ACTV_CDE      = 'A'                             02218304
022184              and SCN_CDE       = 'SHON'                          02218404
022185             WITH UR                                              02218504
022186     END-EXEC.                                                    02218604
022187                                                                  02218704
022188     EVALUATE TRUE                                                02218804
022189         WHEN SQLCODE = ZERO                                      02218904
022190              set  ps-ERROR       to  true                        02219004
022191              ADD  1  TO  PV-SHON-COUNT                           02219104
022192              MOVE  SUT00027-OTBND-TRIP-ID  TO  PV-DISP-TRIP      02219204
022193              display ' HAS PREVIOUS SHON:  '                     02219304
022194                      PV-SHIPT-UNT-ID                             02219404
022195                      '   TRIP:' pv-DISP-TRIP                     02219504
022196                                                                  02219604
022197         WHEN SQLCODE = +100                                      02219704
022198              set  ps-no-ERROR       to  true                     02219804
022199                                                                  02219904
022200         WHEN SQLWARN0 NOT = SPACES                               02220004
022201         WHEN SQLCODE < ZERO                                      02220104
022202         WHEN SQLCODE > ZERO                                      02220204
022203             move  SQLCODE to  PV-disp-sql                        02220306
022204             display '2020-check-if-shon     '                    02220406
022205                   ' SQL:'    pv-disp-sql                         02220506
022206                   ' store:'  pv-store-nbr                        02220606
022207                   ' sml:   ' PV-SHIPT-UNT-ID                     02220706
022208             MOVE '2020-check-if-shon       '                     02220804
022209                                 TO PV-ABEND-PARAGRAPH            02220904
022210             MOVE 'CHECK IF PREVIOUS SHON  '                      02221004
022211                                 TO PV-ABEND-OPERATION            02221104
022212             PERFORM 9900-DB2-ABEND                               02221204
022213     END-EVALUATE.                                                02221304
022214                                                                  02221404
022215                                                                  02221504
022216*---------------------------------------------------------------- 02221604
022217*                                                                 02221704
022218*---------------------------------------------------------------- 02221804
022219 2030-get-current-trip.                                           02221904
022220                                                                  02222004
022221     MOVE PV-STORE-NBR     to  SUOBTR-DEST-OPER-UNT-ID            02222104
022222     MOVE PV-oper          to  SUOBTR-orgn-OPER-UNT-ID            02222221
022223                                                                  02222321
022224     EXEC SQL                                                     02222421
022225          SELECT a.OTBND_TRIP_ID                                  02222521
022226            into :SUOBTR-OTBND-TRIP-ID                            02222621
022227            FROM TSUOBTR A                                        02222721
022228               , TSUOBTS B                                        02222821
022229           WHERE A.ORGN_OPER_UNT_ID = :SUOBTR-orgn-OPER-UNT-ID    02222921
022230             AND A.DEST_OPER_UNT_ID = :SUOBTR-DEST-OPER-UNT-ID    02223021
022231             AND A.OTBND_TRIP_ID    =  B.OTBND_TRIP_ID            02223121
022232             AND B.OTBND_STAT_TMST  IN                            02223221
022233                 (SELECT MAX(C.OTBND_STAT_TMST)                   02223321
022234                    FROM TSUOBTS C                                02223421
022235                   WHERE B.OTBND_TRIP_ID  =  C.OTBND_TRIP_ID)     02223521
022236             AND B.TRIP_STAT_CDE IN ('DO')                        02223621
022237             and b.DOOR_ID        =  :CNDRST-DOOR-ID              02223721
022239     END-EXEC.                                                    02223904
022240                                                                  02224004
022241     EVALUATE TRUE                                                02224104
022242         WHEN SQLCODE = ZERO                                      02224204
022243              set  ps-no-ERROR       to  true                     02224304
022249                                                                  02224904
022250         WHEN SQLCODE = +100                                      02225004
022251              set  ps-ERROR       to  true                        02225104
022252              ADD  1  TO  PV-no-trip-COUNT                        02225204
022254              display ' no open trip:       '                     02225404
022255                      PV-SHIPT-UNT-ID                             02225504
022256                      '   door:' CNDRST-DOOR-ID                   02225604
022257                                                                  02225704
022258         WHEN SQLWARN0 NOT = SPACES                               02225804
022259         WHEN SQLCODE < ZERO                                      02225904
022260         WHEN SQLCODE > ZERO                                      02226004
022261             move  SQLCODE to  PV-disp-sql                        02226106
022262             display '2030-get-current-trip  '                    02226206
022263                   ' SQL:'    pv-disp-sql                         02226306
022264                   ' store:'  pv-store-nbr                        02226406
022265                   ' sml:   ' PV-SHIPT-UNT-ID                     02226506
022266             MOVE '2030-get-current-trip    '                     02226604
022267                                 TO PV-ABEND-PARAGRAPH            02226704
022268             MOVE 'CHECK IF open trip      '                      02226804
022269                                 TO PV-ABEND-OPERATION            02226904
022270             PERFORM 9900-DB2-ABEND                               02227004
022271     END-EVALUATE.                                                02227104
022272                                                                  02227204
022280                                                                  02228004
022291*---------------------------------------------------------------- 02229124
022292*                                                                 02229224
022293*---------------------------------------------------------------- 02229324
022294 2040-check-str-scan.                                             02229424
022295                                                                  02229524
022296     move PV-SHIPT-UNT-ID  TO  SUT00121-SHIPT-UNT-ID              02229624
022299                                                                  02229924
022300     EXEC SQL                                                     02230024
022301          SELECT SCN_TYP_CDE                                      02230124
022302               , cre_tmst                                         02230224
022303            into :SUT00121-SCN-TYP-CDE                            02230324
022304               , :SUT00121-CRE-TMST                               02230424
022305            FROM sut_otbnd_str_scn                                02230524
022306           where SHIPT_UNT_ID  = :SUT00121-SHIPT-UNT-ID           02230624
022307           order by cre_tmst                                      02230724
022308           fetch first 1 row only                                 02230824
022314     END-EXEC.                                                    02231424
022315                                                                  02231524
022316     EVALUATE TRUE                                                02231624
022317         WHEN SQLCODE = ZERO                                      02231724
022318         WHEN SQLCODE = -811                                      02231824
022319              set  ps-ERROR       to  true                        02231924
022320              ADD  1  TO  PV-str-scan-COUNT                       02232027
022321              display ' scanned by store:   '                     02232124
022322                      PV-SHIPT-UNT-ID                             02232224
022323                      '   type:' SUT00121-SCN-TYP-CDE             02232324
022324                                                                  02232424
022325         WHEN SQLCODE = +100                                      02232524
022326              set  ps-no-ERROR       to  true                     02232624
022327                                                                  02232724
022328         WHEN SQLWARN0 NOT = SPACES                               02232824
022329         WHEN SQLCODE < ZERO                                      02232924
022330         WHEN SQLCODE > ZERO                                      02233024
022331             move  SQLCODE to  PV-disp-sql                        02233124
022332             display '2040-check-str-scan    '                    02233224
022333                   ' SQL:'    pv-disp-sql                         02233324
022334                   ' store:'  pv-store-nbr                        02233424
022335                   ' sml:   ' PV-SHIPT-UNT-ID                     02233524
022336             MOVE '2040-check-str-scan      '                     02233624
022337                                 TO PV-ABEND-PARAGRAPH            02233724
022338             MOVE 'CHECK IF scanned by str '                      02233824
022339                                 TO PV-ABEND-OPERATION            02233924
022340             PERFORM 9900-DB2-ABEND                               02234024
022341     END-EVALUATE.                                                02234124
022342                                                                  02234224
022343                                                                  02234324
022350*---------------------------------------------------------------- 02235000
022400*                                                                 02240000
022500*---------------------------------------------------------------- 02250000
022600 4000-read-input.                                                 02260001
022700                                                                  02270000
022710     read  carton-FILE                                            02271001
022720     into  pv-carton-record                                       02272003
022800       at end  set ps-eof to true.                                02280003
022801                                                                  02280108
022803                                                                  02280322
022804     if  ps-eof                                                   02280422
022805         continue                                                 02280522
022806     else                                                         02280622
022807         DISPLAY  PV-CARTON-RECORD                                02280723
022808         add  1  to  pv-read-count                                02280822
022809     end-if.                                                      02280922
022810                                                                  02281001
022820*                                                                 02282001
022830******************************************************************02283001
022831*   INSERT INTO DB2PDBA.SUT_OTBND_LOC                             02283104
022832*          ( SHIPT_UNT_ID                                         02283204
022833*           ,CRE_TMST                                             02283304
022834*           ,OTBND_TRIP_ID                                        02283404
022835*           ,LOC_NBR                                              02283504
022836*           ,SCN_CDE                                              02283604
022837*           ,CRE_USR_ID                                           02283704
022838*           ,ACTV_CDE                                             02283804
022839*           ,INBD_TRIP_ID                                         02283904
022850*          )                                                      02285001
022851*   VALUES                                                        02285101
022852*          ( :SUT00027-SHIPT-UNT-ID                               02285204
022853*           ,'2016-04-03-15.00.00.000000'                         02285304
022854*           ,:SUT00027-OTBND-TRIP-ID                              02285404
022855*           , 875                                                 02285504
022856*           ,'SHON'                                               02285604
022857*           ,'TKMA408'                                            02285704
022858*           ,'A'                                                  02285804
022859*           ,0                                                    02285901
022867*          )                                                      02286701
022871*          ;                                                      02287101
022872*                                                                *02287201
022880******************************************************************02288001
022900 7000-create-sql.                                                 02290002
022901                                                                  02290121
022902     move  PV-SHIPT-UNT-ID      to  SUT00027-SHIPT-UNT-ID.        02290221
022903     move  SUOBTR-OTBND-TRIP-ID to  SUT00027-OTBND-TRIP-ID.       02290321
022904     move  pv-oper              to  sut00027-loc-nbr.             02290421
022910                                                                  02291001
022920     EXEC SQL                                                     02292021
022921          INSERT INTO SUT_OTBND_LOC                               02292121
022922                 ( SHIPT_UNT_ID                                   02292221
022923                  ,CRE_TMST                                       02292321
022924                  ,OTBND_TRIP_ID                                  02292421
022925                  ,LOC_NBR                                        02292521
022926                  ,SCN_CDE                                        02292621
022927                  ,CRE_USR_ID                                     02292721
022928                  ,ACTV_CDE                                       02292821
022929                  ,INBD_TRIP_ID                                   02292921
022930                 )                                                02293021
022931          VALUES                                                  02293121
022932                 ( :SUT00027-SHIPT-UNT-ID                         02293221
022933                  ,current timestamp                              02293321
022934                  ,:SUT00027-OTBND-TRIP-ID                        02293421
022935                  ,:sut00027-loc-nbr                              02293521
022936                  ,'SHON'                                         02293621
022937                  ,'SUKUT944'                                     02293721
022938                  ,'A'                                            02293821
022939                  ,0                                              02293921
022940                 )                                                02294021
022997     END-EXEC.                                                    02299721
022998                                                                  02299821
022999     EVALUATE TRUE                                                02299921
023000         WHEN SQLCODE = ZERO                                      02300021
023001              ADD +1 TO PV-WRITE-COUNT                            02300121
023003                                                                  02300321
023011         WHEN SQLWARN0 NOT = SPACES                               02301121
023012         WHEN SQLCODE < ZERO                                      02301221
023013         WHEN SQLCODE > ZERO                                      02301321
023014             move  SQLCODE to  PV-disp-sql                        02301421
023015             display '7000-create-sql        '                    02301521
023016                   ' SQL:'    pv-disp-sql                         02301621
023017                   ' oper:'   pv-oper                             02301721
023018                   ' store:'  pv-store-nbr                        02301821
023019                   ' sml:   ' PV-SHIPT-UNT-ID                     02301921
023020             MOVE '7000-create-sql          '                     02302021
023021                                 TO PV-ABEND-PARAGRAPH            02302121
023022             MOVE 'CHECK IF open trip      '                      02302221
023023                                 TO PV-ABEND-OPERATION            02302321
023024             PERFORM 9900-DB2-ABEND                               02302421
023025     END-EVALUATE.                                                02302521
036250                                                                  03625000
036300                                                                  03630000
036400******************************************************************03640000
036500*  ABEND ROUTINE                                                 *03650000
036600******************************************************************03660000
036700 9900-DB2-ABEND.                                                  03670000
036800                                                                  03680000
036900     MOVE SQLCODE TO PV-SQLCODE.                                  03690000
037000     DISPLAY '*** DB2 ERROR '.                                    03700000
037100     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       03710000
037200     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 03720000
037300     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               03730000
037400     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               03740000
037500     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       03750000
037600     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       03760000
037700     DISPLAY '*** TABLE 1   = ' PV-DB2-TABLE-NAME-1.              03770000
037800     DISPLAY '*** TABLE 2   = ' PV-DB2-TABLE-NAME-2.              03780000
037900                                                                  03790000
038000     COPY DPPD004.                                                03800000
038100                                                                  03810000
038200     MOVE +4013 TO PV-ABEND-CODE.                                 03820000
038300     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03830000
038400                                                                  03840000
038500 9999-ABEND.                                                      03850000
038600                                                                  03860000
038700     DISPLAY '***************'.                                   03870000
038800     DISPLAY '** ABEND     **'.                                   03880000
038900     DISPLAY '** PROGRAM   ** = ' PV-ABEND-PROGRAM.               03890000
039000     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             03900000
039100     DISPLAY '***************'.                                   03910000
039200                                                                  03920000
039300     MOVE +4008                  TO PV-ABEND-CODE.                03930000
039400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         03940000
039500                                                                  03950000
039600******************************************************************03960000
039700*                 E N D   O F   P R O G R A M                    *03970000
039800******************************************************************03980000
