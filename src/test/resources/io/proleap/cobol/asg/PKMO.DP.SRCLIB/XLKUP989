000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400 PROGRAM-ID.    XLKUP989.                                         00040001
000500 AUTHOR.        DAN HINTZ.                                        00050001
000600 INSTALLATION.  KOHLS.                                            00060001
000700 DATE-WRITTEN   MAY 2005.                                         00070001
000800 DATE-COMPILED.                                                   00080001
000900******************************************************************00090001
001000*  THIS BATCH DB2 PROGRAM UPDATES XLT_UPC FROM THE VSM UPC NIGHTLY00100001
001000*  EXTRACT FILE.  THE EXTRACT FILE WILL BE READ AND FOR EACH UPC  00101001
001000*  RECORD FOUND ON THE FILE, THE ASSOCIATED UPC ROW ON XLT_UPC    00102001
001000*  WILL HAVE THE PREPK_IND COLUMN UPDATED WITH THE PREPK_IND VALUE00103001
001000*  FOUND ON THE EXTRACT FILE.                                     00104001
001400******************************************************************00104201
001500 ENVIRONMENT DIVISION.                                            00104301
001600 INPUT-OUTPUT SECTION.                                            00104401
001700                                                                  00104501
001800 FILE-CONTROL.                                                    00104601
001900                                                                  00104701
002000     SELECT XLT-UPC-EXTRACT                                       00104801
002010         ASSIGN TO INP01.                                         00104901
002100                                                                  00105001
002200***************************************************************** 00106001
002300 DATA DIVISION.                                                   00107001
002400***************************************************************** 00108001
002500 FILE SECTION.                                                    00109001
002600                                                                  00110001
002700 FD  XLT-UPC-EXTRACT                                              00120001
002800     RECORDING MODE IS F                                          00130001
002810     BLOCK CONTAINS 0 RECORDS                                     00140001
002900     LABEL RECORDS ARE STANDARD.                                  00150001
003000                                                                  00160001
003300 01  XLT-UPC-EXTRACT-RECORD           PIC X(250).                 00170001
003700                                                                  00180001
003800                                                                  00190001
003900***************************************************************** 00200001
004000 WORKING-STORAGE SECTION.                                         00210001
004100                                                                  00220001
       01  PA-DB2-COMMIT-COUNT              PIC S9(09) VALUE +0         00230001
                                                          COMP-3.       00240001
004200 01  PS-PROGRAM-SWITCHES.                                         00250001
004300     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00260001
004400         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00270001
004500         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00280001
004600                                                                  00290001
004700 01  PC-PROGRAM-CONSTANTS.                                        00300001
004800     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XLKUP989'.00310001
005000                                                                  00320001
005100 01  PV-PROGRAM-VARIABLES.                                        00330001
005900     05  PV-RECORDS-READ              PIC  9(09) VALUE  0.        00340001
006000     05  PV-RECORDS-UPDATED           PIC  9(09) VALUE  0.        00350001
           05  PV-DISP-UPC-ID               PIC  9(09) VALUE  0.        00361001
           05  PV-DISP-UPC-NBR              PIC  9(15) VALUE  0.        00362001
006700     05  PV-SQLCODE                   PIC  S9(9) VALUE +0.        00370001
006800     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00380001
006900                                                                  00390001
007000                                                                  00400001
007100 01  PV-ABEND-FIELDS.                                             00410001
007200     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00420001
007300                                                 COMP SYNC.       00430001
007400     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'XLKUP989'.00440001
007500     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00450001
007600     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00460001
007700     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00470001
007900     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00480001
008000     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00490001
008100     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00500001
008200                                                                  00510001
008300                                                                  00520001
008400***********************************************************       00530001
008500*  COPYBOOK USED FOR THE VSM UPC EXTRACT FILE             *       00540001
008600***********************************************************       00550001
008700     COPY IMRD055.                                                00560001
008800                                                                  00570001
008900***********************************************************       00580001
009000*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00590001
009100***********************************************************       00600001
009200     COPY DPWS004.                                                00610001
009300                                                                  00620001
009400***********************************************************       00630001
009500*  DB2 SQL COMMUNICATION AREA                             *       00640001
009600***********************************************************       00650001
009700     EXEC SQL                                                     00660001
009800          INCLUDE SQLCA                                           00670001
009900     END-EXEC.                                                    00680001
010000                                                                  00690001
010100***********************************************************       00700001
010200*  LOGISTICS DOMAIN UPC TABLE (XLT_UPC)                  *        00710001
010300***********************************************************       00720001
010400     EXEC SQL                                                     00730001
010500          INCLUDE XLT00006                                        00740001
010600     END-EXEC.                                                    00750001
010700                                                                  00760001
010800***************************************************************** 00770001
010900 PROCEDURE DIVISION.                                              00780001
011000***************************************************************** 00790001
011100     DISPLAY '**** BEGINNING XLKUP989 ****'.                      00800001
011200     DISPLAY ' '.                                                 00810001
011300                                                                  00820001
011400     OPEN INPUT XLT-UPC-EXTRACT.                                  00830001
011500                                                                  00840001
011600     PERFORM 1000-READ-INPUT-FILE.                                00850001
011700                                                                  00860001
012100     PERFORM 2000-PROCESS-INPUT-FILE                              00870001
012200       UNTIL PS-EOF-INPUT-YES.                                    00880001
012300                                                                  00890001
012400     CLOSE XLT-UPC-EXTRACT.                                       00900001
012500                                                                  00910001
012510     PERFORM 3000-TABLE-COMMIT.                                   00920001
012520                                                                  00930001
012600     DISPLAY '**  INPUT VSM UPC RECS READ = '                     00940001
                    PV-RECORDS-READ.                                    00950001
012700     DISPLAY '**  XLT_UPC ROWS UPDATED... = '                     00960001
                    PV-RECORDS-UPDATED.                                 00970001
012800     DISPLAY ' '.                                                 00980001
012900     DISPLAY '****  END OF  XLKUP989  ****'.                      00990001
013000                                                                  01000001
013100     STOP RUN.                                                    01010001
013200                                                                  01020001
013300                                                                  01030001
013400***************************************************************** 01040001
013500*  READ A VSM UPC EXTRACT RECORD THAT WILL BE USED TO UPDATE    * 01050001
013510*  THE PREPK_IND COLUMN ON THE XLT_UPC TABLE.                   * 01060001
013600***************************************************************** 01070001
013700 1000-READ-INPUT-FILE.                                            01080001
013800                                                                  01090001
013900     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       01100001
014000                                                                  01110001
           INITIALIZE PA-DB2-COMMIT-COUNT.                              01120001
014020                                                                  01130001
014100     READ XLT-UPC-EXTRACT                                         01140001
014200          INTO IM055-ITEM-UPC-DOMAIN-REC                          01150001
014300            AT END                                                01160001
014400               SET PS-EOF-INPUT-YES TO TRUE                       01170001
014500                                                                  01180001
014600            NOT AT END                                            01190001
014700               SET PS-EOF-INPUT-NO  TO TRUE                       01200001
014800               ADD +1 TO PV-RECORDS-READ                          01210001
014900     END-READ.                                                    01220001
015000                                                                  01230001
015100                                                                  01240001
015200***************************************************************** 01250001
015300*  LOAD THE INFORMATION FROM THE VSM UPC EXTRACT FILE INTO      * 01260001
015310*  THE HOST VARIABLE AND PERFORM A PARAGRAPH TO UPDATE THE      * 01270001
015320*  ASSOCIATED ROW IN THE XLT_UPC TABLE.                         * 01280001
015400***************************************************************** 01290001
015500 2000-PROCESS-INPUT-FILE.                                         01300001
015600                                                                  01310001
015700     MOVE '2000-PROCESS-INPUT-FILE ' TO PV-ABEND-PARAGRAPH.       01320001
015800                                                                  01330001
016361     MOVE IM055-PREPK-IND            TO XLT00006-PREPK-IND.       01340001
016380                                                                  01350001
016400     PERFORM 2100-UPDATE-XLT-UPC.                                 01360001
017700                                                                  01370001
017800     PERFORM 1000-READ-INPUT-FILE.                                01380001
018500                                                                  01390001
018600                                                                  01400001
021600***************************************************************** 01410001
021700*  UPDATE PREPK_IND ON THE XLT_UPC TABLE.                       * 01420001
021800***************************************************************** 01430001
021900 2100-UPDATE-XLT-UPC.                                             01440001
022000                                                                  01450001
022100     EXEC SQL                                                     01460001
022200          UPDATE XLT_UPC                                          01470001
022300             SET PREPK_IND = :XLT00006-PREPK-IND                  01480001
023093           WHERE UPC_ID    = :IM055-UPC-ID                        01490001
023093             AND UPC_NBR   = :IM055-UPC-NBR                       01491001
024010     END-EXEC.                                                    01500001
024100                                                                  01510001
024200     EVALUATE TRUE                                                01520001
024300         WHEN SQLCODE = ZERO                                      01530001
024400              ADD +1                 TO PV-RECORDS-UPDATED        01540001
                    ADD +1                 TO PA-DB2-COMMIT-COUNT       01550001
                    IF PA-DB2-COMMIT-COUNT > 4500                       01560001
                        PERFORM 3000-TABLE-COMMIT                       01570001
                        MOVE 0 TO PA-DB2-COMMIT-COUNT                   01580001
                    END-IF                                              01590001
024300         WHEN SQLCODE = +100                                      01600001
024300              CONTINUE                                            01610001
024500         WHEN SQLCODE NOT = +0                                    01620001
024600              MOVE '2100-UPDATE-XLT-UPC'                          01630001
024700                                     TO PV-ABEND-PARAGRAPH        01640001
024800              MOVE 'UPDATE PREPK_IND COLUMN'                      01650001
024810                                     TO PV-ABEND-OPERATION        01660001
023093              MOVE IM055-UPC-ID      TO PV-DISP-UPC-ID            01671001
023093              MOVE IM055-UPC-NBR     TO PV-DISP-UPC-NBR           01672001
025500              STRING 'RMS UPC ID: '        DELIMITED BY SIZE      01680001
025600                     PV-DISP-UPC-ID        DELIMITED BY SIZE      01690001
025500                     '  RMS UPC NBR: '     DELIMITED BY SIZE      01691001
025600                     PV-DISP-UPC-NBR       DELIMITED BY SIZE      01692001
026700                                   INTO PV-DB2-OPERATION-MESSAGE-101700001
026900              MOVE 'XLT_UPC'         TO PV-ABEND-TABLE            01720002
027000              PERFORM Z999-SQL-ABEND                              01730001
027100     END-EVALUATE.                                                01740001
027200                                                                  01750001
027300                                                                  01760001
027400***************************************************************** 01770001
027500* COMMIT THE PENDING TABLE CHANGES.                             * 01780001
027600***************************************************************** 01790001
027700 3000-TABLE-COMMIT.                                               01800001
027800                                                                  01810001
027900     EXEC SQL                                                     01820001
028000          COMMIT                                                  01830001
028100     END-EXEC.                                                    01840001
028200                                                                  01850001
028300                                                                  01860001
028400***************************************************************** 01870001
028500*  DISPLAY DB2 ERROR INFORMATION, ROLLBACK ANY PENDING CHANGES, * 01880001
028510*  AND ABEND THE PROGRAM.                                       * 01890001
028600***************************************************************** 01900001
028700 Z999-SQL-ABEND.                                                  01910001
028800                                                                  01920001
028900     MOVE SQLCODE            TO PV-SQLCODE.                       01930001
029000     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  01940001
029100     DISPLAY '*** DB2 ERROR '.                                    01950001
029200     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  01960001
029300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 01970001
029400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               01980001
029500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               01990001
029600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02000001
029700     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02010001
029800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02020001
029900     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE.                   02030001
030000                                                                  02040001
030100     COPY DPPD004.                                                02050001
030200                                                                  02060001
030300     MOVE +4013         TO PV-ABEND-CODE.                         02070001
030400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02080001
