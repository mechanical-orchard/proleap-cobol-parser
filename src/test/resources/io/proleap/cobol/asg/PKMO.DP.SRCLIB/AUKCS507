000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000500 PROGRAM-ID.        AUKCS507.                                     00030001
000600 AUTHOR.            BRAD GROCHOWSKI TKMA557.                      00040001
000700 INSTALLATION.      KOHLS.                                        00050001
000800 DATE-WRITTEN       08/17/2004.                                   00060001
000900 DATE-COMPILED.                                                   00070001
001000                                                                  00080001
001100******************************************************************00090001
001200*  CICS PROGRAM - AUKCS507 - A507                                *00100001
001300*                                                                *00110001
001400*  SAFEWAY - KOHLS GIFT CARD AUTHORIZATION PROCESSOR.            *00120001
001500*                                                                *00130001
001600*  RECEIVE GIFT CARD AUTHORIZATION REQUESTS FROM THE TCP/IP      *00140001
001700*  LISTENER PROGRAM AUKCS505, PERFORM THE AUTHORIZATION, AND     *00150001
001800*  SEND RESPONSE TO TEMP STORAGE QUEUE TO BE PICKED UP BY THE    *00160001
001900*  LISTENER PROGRAM.                                             *00170001
002000*  THE KMC ACTIVITY TABLE WILL BE UPDATED WITH ANY APPROVED      *00180001
002100*  RESPONSES.                                                    *00190001
002200*  THIS PROGRAM IS STARTED BY THE LISTENER AUKCS505.             *00200001
002300*                                                                *00210001
002400*  THIS PROGRAM WAS WRITTEN USING AUKCS502 AS A BASE.            *00220001
002500*                                                                *00230001
002600*  Note: This program must be compiled with DB2 option on.       *00240001
002700******************************************************************00250001
003070                                                                  00260001
00CHG0*---------------------------------------------------------------* 00270001
00CHG0*   07-10-2014 - COGNIZANT                                        00280001
00CHG0*  TO CHANGE THE RESPONSE OF REQUEST FROM THE STATUS OF           00290001
00CHG0*  'GENERAL DECLINE'(RC :35) TO 'ALREADY ACTIVE'(RC :08)          00300001
00CHG0*   FOR THOSE CARDS WHICH GOT ACTIVATED ALREADY.                  00310001
208819*---------------------------------------------------------------* 00320003
208819*   09-20-2018 - Jim Hunter       CHG0208819                      00330003
208819*   MAINFRAME REFACTORING - REPLACE CGU042MC WITH DPWS036.        00340003
003080******************************************************************00350001
003090 ENVIRONMENT DIVISION.                                            00360001
003100******************************************************************00370001
003200                                                                  00380001
003300******************************************************************00390001
003400 DATA DIVISION.                                                   00400001
003500******************************************************************00410001
003600                                                                  00420001
003700 WORKING-STORAGE SECTION.                                         00430001
003800                                                                  00440001
003900*                                                                 00450001
004000*  LISTENER QUEUE NAMES                                           00460001
004100*                                                                 00470001
004200     COPY AUWS002.                                                00480001
004300                                                                  00490001
004400*                                                                 00500001
004500*  RECORD LAYOUT BEING TRANSMITTED FROM THE REQUESTING PLATFORM   00510001
004600*                                                                 00520001
004700     COPY AURD003.                                                00530001
004800                                                                  00540001
004900*                                                                 00550001
005000*  RECORD LAYOUT BEING TRANSMITTED TO THE REQUESTING PLATFORM     00560001
005100*                                                                 00570001
005200     COPY AURD004.                                                00580001
005300*                                                                 00590001
005400*  WORKING-STORAGE VARIABLES REQUIRED FOR THE USE OF THE          00600001
005500*  LOG MESSAGE ROUTING (EPPD000).                                 00610001
005600*                                                                 00620001
005700     COPY EPWS000.                                                00630001
005800                                                                  00640001
005900*                                                                 00650001
006000* STORED VALUE CONSTANTS                                          00660001
006100*                                                                 00670001
006200     COPY SVWS004.                                                00680001
006300*                                                                 00690001
006400* SAFEWAY ISO 8583 0200 REQUEST                                   00700001
006500*                                                                 00710001
006600     COPY AUWS003.                                                00720001
006700*                                                                 00730001
006800* SAFEWAY ISO 8583 0210 RESPONSE                                  00740001
006900*                                                                 00750001
007000     COPY AUWS004.                                                00760001
007100*                                                                 00770001
007200* SAFEWAY ISO 8583 0220 SAF REQUEST                               00780001
007300*                                                                 00790001
007400     COPY AUWS005.                                                00800001
007500*                                                                 00810001
007600* SAFEWAY ISO 8583 0230 SAF RESPONSE                              00820001
007700*                                                                 00830001
007800     COPY AUWS006.                                                00840001
007900*                                                                 00850001
008000* SAFEWAY ISO 8583 0800 NETWORK REQUEST                           00860001
008100*                                                                 00870001
008200     COPY AUWS007.                                                00880001
008300*                                                                 00890001
008400* SAFEWAY ISO 8583 0810 NETWORK RESPONSE                          00900001
008500*                                                                 00910001
008600     COPY AUWS008.                                                00920001
008700                                                                  00930001
008710* SAFEWAY ISO 8583 0420 REVERSAL REQUEST                          00940001
008720*                                                                 00950001
008730     COPY AUWS009.                                                00960001
008740*                                                                 00970001
008750* SAFEWAY ISO 8583 0430 REVERSAL RESPONSE                         00980001
008760*                                                                 00990001
008770     COPY AUWS010.                                                01000001
008780                                                                  01010001
008800 01  PS-PROGRAM-SWITCHES.                                         01020001
008900     05  PS-SYSTEM-ERROR-IND     PIC X(1)     VALUE 'N'.          01030001
009000         88  PS-SYSTEM-ERROR-DETECTED         VALUE 'Y'.          01040001
009100         88  PS-NO-SYSTEM-ERROR-DETECTED      VALUE 'N'.          01050001
009200     05  PS-ERROR-TYPE           PIC X(1).                        01060001
009300         88  PS-DB2-ERROR                     VALUE 'D'.          01070001
009400         88  PS-AUTH-MESSAGE-ERROR            VALUE 'M'.          01080001
009500         88  PS-SYSTEM-ERROR                  VALUE 'S'.          01090001
009600                                                                  01100001
009700 01  PC-PROGRAM-CONSTANTS.                                        01110001
009800     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'AUKCS507'.   01120001
009900     05  PC-COMMUNICATIONS-IN-LENGTH                              01130001
010000                                 PIC S9(4)    VALUE +4121         01140001
010100                                 COMP SYNC.                       01150001
010200     05  PC-MAXIMUM-RETRY-COUNT  PIC S9(4)    VALUE +2            01160001
010300                                 COMP SYNC.                       01170001
010400     05  PC-ONE                  PIC S9(1)    VALUE  +1.          01180001
010500                                                                  01190001
010600     05  PC-TEST-GIFT-1000000321 PIC  9(10)   VALUE 1000000321.   01200001
010700     05  PC-TEST-GIFT-1000000107 PIC  9(10)   VALUE 1000000107.   01210001
010800     05  PC-TEST-GIFT-1000000370 PIC  9(10)   VALUE 1000000370.   01220001
010900     05  PC-TEST-GIFT-1000000388 PIC  9(10)   VALUE 1000000388.   01230001
011000     05  PC-TEST-GIFT-1000000396 PIC  9(10)   VALUE 1000000396.   01240001
011100***************************************************************   01250001
011200* NOTE, IF STATE CODE IS NOT FOUND IN TSTATE TABLE, THEN          01260001
011300* THE DEFAULT STATE IS DELAWARE, THE KOHLS INCORPORATION          01270001
011400* STATE. PER JOE JESTER TAX DEPT ON 1/10/2005                     01280001
011500***************************************************************   01290001
011600     05  PC-DEFAULT-STATE-CD     PIC  X(2)    VALUE 'DE'.         01300001
011700*                                                                 01310001
011800                                                                  01320001
011900 01  PV-PROGRAM-VARIABLES.                                        01330001
012000     05  PV-CICS-RESPONSE        PIC S9(9)   VALUE ZERO COMP SYNC.01340001
012200     05  PV-CICS-RESPONSE-DISP   PIC ZZZZZ9999-.                  01350001
012300     05  PV-RETRY-COUNT          PIC S9(4)   VALUE ZERO COMP SYNC.01360001
012500     05  PV-STATE-CD             PIC X(2)     VALUE SPACES.       01370001
012600     05  PV-KMC-AMT              PIC 9(7)V99 COMP-3 VALUE ZERO.   01380001
012700     05  PV-KMC-ID               PIC  9(12)        VALUE 0.       01390001
012800         88 PV-TEST-GIFT-CARD-ACCOUNTS             VALUE          01400001
012900         1000000321, 1000000107, 1000000370, 1000000388,          01410001
013000         1000000396.                                              01420001
013100     05  PV-SAFEWAY-RESP-CODE      PIC 9(2)  VALUE ZERO.          01430001
013100     05  PV-SAFEWAY-RESPONSE-CODES PIC 9(2)  VALUE ZERO.          01440001
013200         88  PV-SRC-APPROVED                  VALUE ZERO.         01450001
013300         88  PV-SRC-UNKNOWN-ACCOUNT           VALUE 3.            01460001
013400         88  PV-SRC-ALREADY-ACTIVE            VALUE 8.            01470001
013400         88  PV-SRC-INVALID-AMT               VALUE 18.           01480001
013500         88  PV-ALREADY-REVERSED              VALUE 34.           01490001
013500         88  PV-SRC-GENERIC-DENIAL            VALUE 35.           01500001
013600                                                                  01510001
013700     05 PV-REQUEST-TYPE-INFO.                                     01520001
013800        10 PV-REVERSAL-IND       PIC S9(1) COMP-3.                01530001
013900           88 PV-NORMAL          VALUE  0.                        01540001
014000           88 PV-REVERSAL        VALUE  1.                        01550001
014100        10 PV-REQUEST-TYPE       PIC S9(1) COMP-3.                01560001
014200           88 PV-BALANCE-INQUIRY       VALUE 0.                   01570001
014300           88 PV-ISSUANCE-AS-KMRC      VALUE 1.                   01580001
014400           88 PV-ISSUANCE-AS-GIFT-CARD VALUE 2.                   01590001
014500           88 PV-TENDER                VALUE 3.                   01600001
014600           88 PV-INVALID-REQUEST-TYPE  VALUE 9.                   01610001
014700     05 PV-SCAN-SOURCE-CODE      PIC X(02).                       01620001
014800        88  PV-KMC-KEY-ENTERED                VALUE '00'.         01630001
014900        88  PV-KMC-SCANNED                    VALUE '02'.         01640001
015000     05 PV-SAFEWAY-PROCESSING-CODE  PIC X(1).                     01650001
015100        88  PV-SPC-ONLINE-NORMAL              VALUE 'N'.          01660001
015200        88  PV-SPC-OFFLINE-SAF                VALUE 'S'.          01670001
008900     05  PV-NO-TABLE-LOCK-IND    PIC X(1)     VALUE 'Y'.          01680001
009000        88  PV-TABLE-LOCK                    VALUE 'Y'.           01690001
009100        88  PV-NO-TABLE-LOCK                 VALUE 'N'.           01700001
015300     05 PV-APPROVAL-NBR          PIC 9(6).                        01710001
015400     05 PV-DISPLAY-ACCT-LENGTH   PIC  9(3).                       01720001
015500     05  PV-TSQ-DATA-RECORD.                                      01730001
015600         10  PV-TSQ-DATA-PORTION         PIC X(4120) VALUE SPACE. 01740001
015700                                                                  01750001
015800     05  PV-ITEM-NBR                     PIC S9(04)  VALUE ZEROS  01760001
015900                                                     COMP SYNC.   01770001
016000     05  PV-TSQ-LENGTH                   PIC S9(04)  VALUE ZEROS  01780001
016100                                                     COMP SYNC.   01790001
016200     05  PV-TSQ-NAME                     PIC  X(08)  VALUE SPACES.01800001
016300                                                                  01810001
016400     05  PV-TCPIPPRQ-RECORD1.                                     01820001
016500         10  PV-NEXT-RECORD              PIC  9(08)  VALUE ZEROS. 01830001
016600         10  PV-TOTAL-RECORDS            PIC  9(08)  VALUE ZEROS. 01840001
016700         10  FILLER                      PIC X(4104) VALUE SPACES.01850001
016800                                                                  01860001
016900     05  PV-E-BUS-IND                    PIC X(1)    VALUE 'N'.   01870001
017000         88  PV-E-ECOMMERCE-STORE             VALUE 'Y'.          01880001
017100         88  PV-E-NON-ECOMM-STORE             VALUE 'N'.          01890001
017200     05  PV-WS-CTR                       PIC 9(04)   VALUE ZEROS. 01900001
017300     05  PV-MSG-LEN-WHDR                 PIC 9(04)   VALUE ZEROS. 01910001
017400     05  PV-MSG-LEN-WOHDR                PIC 9(04)   VALUE ZEROS. 01920001
017500     05  PV-HEX-BINARY                   PIC 9(04) BINARY.        01930001
017600     05  PV-HEX-CHAR REDEFINES PV-HEX-BINARY.                     01940001
017700         10  PV-HEX-LENGTH               PIC X(02).               01950001
017800     05  PV-POS-ENTR-CDE                 PIC 9(3).                01960001
017900     05  PV-TRACK2-LEN                   PIC 9(2).                01970001
018000     05  PV-DATA-POSITION                PIC 9(4).                01980001
018100     05  PV-REST-OF-DATA-LEN             PIC 9(4).                01990001
018110     05  PV-RESPONSE-LEN                 PIC 9(4).                02000001
015000     05 PV-SAFEWAY-RELOAD-CODE      PIC X(1).                     02010001
015100        88  PV-SAFEWAY-RELOAD                 VALUE 'Y'.          02020001
015200        88  PV-SAFEWAY-NO-RELOAD              VALUE 'N'.          02030001
018111                                                                  02040001
018130*---------------------------------------------------------        02050001
018131 01  LM-LOG-MESSAGE.                                              02060001
018140     05  LM-MESSAGE-NUMBER            PIC X(02) VALUE '99'.       02070001
018150     05  LM-LOG-DISPLAY-MESSAGE.                                  02080001
018160         10  LM-DM-AUTH-TYPE          PIC X(3)  VALUE 'SV '.      02090001
018170         10  FILLER                   PIC X(3)  VALUE SPACES.     02100001
018180             88  LM-DM-REQ                      VALUE 'REQ'.      02110001
018190             88  LM-DM-RSP                      VALUE 'RSP'.      02120001
018200         10  FILLER                   PIC X(1)  VALUE SPACES.     02130001
018300         10  FILLER                   PIC X(3)  VALUE SPACES.     02140001
018400             88  LM-DM-BALINQ                   VALUE 'BAL'.      02150001
018500             88  LM-DM-TENDER                   VALUE 'TND'.      02160001
018600             88  LM-DM-ISSUE                    VALUE 'ISS'.      02170001
018700             88  LM-DM-NETWORK                  VALUE 'NET'.      02180001
018710             88  LM-DM-REVERSAL                 VALUE 'REV'.      02190001
018800             88  LM-DM-UNKNOWN                  VALUE '???'.      02200001
018900             88  LM-DM-VOID-ISSUE               VALUE 'VIS'.      02210001
019000             88  LM-DM-VOID-TENDER              VALUE 'VTN'.      02220001
019100         10  FILLER                   PIC X(1)  VALUE SPACES.     02230001
019200         10  FILLER                   PIC X(3)  VALUE SPACES.     02240001
019300             88  LM-DM-KMRC-MSG                 VALUE 'KC '.      02250001
019400             88  LM-DM-GC-MSG                   VALUE 'GC '.      02260001
019500             88  LM-DM-REQUEST-MSG              VALUE SPACES.     02270001
019600         10  FILLER                   PIC X(3)  VALUE SPACES.     02280001
019700             88  LM-DM-RC-DISPLAY               VALUE 'RC:'.      02290001
019800         10  LM-DM-RESP-CD            PIC X(2)  VALUE SPACES.     02300001
019900         10  FILLER                   PIC X(1)  VALUE SPACES.     02310001
020000         10  LM-DM-STORE-NBR          PIC X(4)  VALUE SPACES.     02320001
020100         10  FILLER                   PIC X(1)  VALUE '/'.        02330001
020200         10  LM-DM-TERM-NBR           PIC X(4)  VALUE SPACES.     02340001
020300         10  FILLER                   PIC X(1)  VALUE '/'.        02350001
020400         10  LM-DM-TRAN-NBR           PIC X(4)  VALUE SPACES.     02360001
020500         10  FILLER                   PIC X(1)  VALUE SPACES.     02370001
020600         10  LM-DM-ACCOUNT-NBR        PIC X(19) VALUE SPACES.     02380001
020700         10  FILLER                   PIC X(8)  VALUE             02390001
020800                                                ' TRNAMT='.       02400001
020900         10  LM-DM-TRAN-AMOUNT       PIC -Z(3)9.99 VALUE ZERO.    02410001
021000         10  FILLER                   PIC X(10)  VALUE            02420001
021100                                                ' APRVAMT='.      02430001
021200         10  LM-DM-APPROVE-AMOUNT    PIC -Z(3)9.99 VALUE ZERO.    02440001
021300         10  FILLER                   PIC X(5)  VALUE             02450001
021400                                                ' BAL='.          02460001
021500         10  LM-DM-BALANCE           PIC -Z(3)9.99 VALUE ZERO.    02470001
021600                                                                  02480001
021700 01  FW-FIELD-WORK-AREA.                                          02490001
021800     05  FW-KMC-ID-INT           PIC 9(19) VALUE ZEROS.           02500001
021900                                                                  02510001
022000 01  CD-CURRENT-DATE-AREA.                                        02520001
022100     05  CD-CURRENT-DATE-YYYYMMDD-X.                              02530001
022200         10  CD-CURRENT-YEAR     PIC 9(4)     VALUE ZERO.         02540001
022300         10  CD-CURRENT-MONTH    PIC 9(2)     VALUE ZERO.         02550001
022400         10  CD-CURRENT-DAY      PIC 9(2)     VALUE ZERO.         02560001
022500     05  CD-DB2-DATE-FORMAT.                                      02570001
022600         10  CD-YYYY             PIC 9(4)     VALUE ZEROS.        02580001
022700         10  FILLER              PIC X(1)     VALUE '-'.          02590001
022800         10  CD-MM               PIC 9(2)     VALUE ZEROS.        02600001
022900         10  FILLER              PIC X(1)     VALUE '-'.          02610001
023000         10  CD-DD               PIC 9(2)     VALUE ZEROS.        02620001
023100     05  PV-AUTH-TIME.                                            02630001
023200         10  PV-AUTH-TIME-HH     PIC  X(2)    VALUE ZEROS.        02640001
023300         10  PV-AUTH-TIME-MM     PIC  X(2)    VALUE ZEROS.        02650001
023400         10  PV-AUTH-TIME-SS     PIC  X(2)    VALUE ZEROS.        02660001
023500                                                                  02670001
023600 01  AM-AUTH-MESSAGE-ERROR-MESSAGE.                               02680001
023700     05  FILLER                  PIC X(21)    VALUE               02690001
023800         'AUTHORIZATION MSG = ('.                                 02700001
023900     05  AM-POS-INQ-REMOTE-AUTH-MSG                               02710001
024000                                 PIC X(85)    VALUE SPACES.       02720001
024100     05  FILLER                  PIC X(1)     VALUE ')'.          02730001
024200                                                                  02740001
024300 01  DE-DB2-ERROR-MESSAGE.                                        02750001
024400     05  FILLER                  PIC X(11)    VALUE               02760001
024500         'SQLCODE = ('.                                           02770001
024600     05  DE-SQLCODE              PIC Z(8)9-   VALUE ZERO.         02780001
024700     05  FILLER                  PIC X(21)    VALUE               02790001
024800         ')  ROWS PROCESSED = ('.                                 02800001
024900     05  DE-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         02810001
025000     05  FILLER                  PIC X(25)    VALUE ')'.          02820001
025100                                                                  02830001
025200 01  DW-DB2-WARNING-MESSAGE.                                      02840001
025300     05  FILLER                  PIC X(11)    VALUE               02850001
025400         'SQLCODE = ('.                                           02860001
025500     05  DW-SQLCODE              PIC Z(8)9-   VALUE ZERO.         02870001
025600     05  FILLER                  PIC X(21)    VALUE               02880001
025700         ')  ROWS PROCESSED = ('.                                 02890001
025800     05  DW-ROWS-PROCESSED       PIC Z(8)9-   VALUE ZERO.         02900001
025900     05  FILLER                  PIC X(14)    VALUE               02910001
026000         ')  SQLWARN = ('.                                        02920001
026100     05  DW-SQLWARN              PIC X(8)     VALUE ZERO.         02930001
026200     05  FILLER                  PIC X(3)     VALUE ')'.          02940001
026300                                                                  02950001
026400 01  DS-DB2-SQLERRMC-MESSAGE.                                     02960001
026500     05  FILLER                  PIC X(11)    VALUE               02970001
026600         'SQLERRMC = '.                                           02980001
026700     05  DS-SQLERRMC             PIC X(66)    VALUE SPACES.       02990001
026800                                                                  03000001
026900 01  AA-ATTEMPTED-ACTION-MESSAGE.                                 03010001
027000     05  FILLER                  PIC X(14)    VALUE               03020001
027100         'ATTEMPTING TO '.                                        03030001
027200     05  AA-ATTEMPTED-ACTION     PIC X(90)    VALUE SPACES.       03040001
027300                                                                  03050001
027400*                                                                 03060001
027500*  SQL AND COBOL DECLARATIONS FOR THE STORED VALUE ACTIVITY TABLE 03070001
027600*                                                                 03080001
027800     EXEC SQL                                                     03090001
027900         INCLUDE SVT00002                                         03100001
028000     END-EXEC.                                                    03110001
028100                                                                  03120001
028200*                                                                 03130001
028300*  STORED VALUE LOCK TABLE                                        03140001
028400*                                                                 03150001
028600     EXEC SQL                                                     03160001
028700         INCLUDE SVT00004                                         03170001
028800     END-EXEC.                                                    03180001
028900*                                                                 03190001
029000*  STORED VALUE CARD TABLE                                        03200001
029100*                                                                 03210001
029300     EXEC SQL                                                     03220001
029400         INCLUDE SVT00001                                         03230001
029500     END-EXEC.                                                    03240001
029600*                                                                 03250001
029700*  STORED VALUE CONTROL TABLE                                     03260001
029800*                                                                 03270001
030000     EXEC SQL                                                     03280001
030100         INCLUDE SVT00000                                         03290001
030200     END-EXEC.                                                    03300001
030300                                                                  03310001
030400*                                                                 03320001
030500*  STORED VALUE card stock denomination table                     03330001
030600*                                                                 03340001
030800     EXEC SQL                                                     03350001
030900         INCLUDE SVT00008                                         03360001
031000     END-EXEC.                                                    03370001
031100                                                                  03380001
031200*                                                                 03390001
031300*  STORED VALUE 3rd Party Transaction Info Table                  03400001
031400*                                                                 03410001
031600     EXEC SQL                                                     03420001
031700         INCLUDE SVT00015                                         03430001
031800     END-EXEC.                                                    03440001
031900                                                                  03450001
032000*                                                                 03460001
032100*  STATE TABLE Used for verifying state code                      03470001
032200*                                                                 03480001
032300     EXEC SQL                                                     03490001
032400         INCLUDE TSTATE                                           03500001
032500     END-EXEC.                                                    03510001
032600                                                                  03520001
032700*  STANDARD LAYOUT FOR THE SQL COMMUNICATION AREA.                03530001
032800                                                                  03540001
032900     EXEC SQL                                                     03550001
033000         INCLUDE SQLCA                                            03560001
033100     END-EXEC.                                                    03570001
033200                                                                  03580001
033300                                                                  03590001
033400* DATA AREA USED BY SV005-A100-MAINLINE.                          03600001
033500     COPY SVWS005.                                                03610001
033600                                                                  03620001
033700* DATA AREA USED BY SV006-A100-MAINLINE.                          03630001
033800     COPY SVWS006.                                                03640001
033900                                                                  03650001
034000*----------------------------------------------------------------*03660001
034100* CONVERT CARD NUMBER WORKING STORAGE AREA                       *03670001
034200*----------------------------------------------------------------*03680001
034300     COPY SVWS007.                                                03690001
034400                                                                  03700001
034500* DATA AREA USED BY THE CHECK DIGIT ROUTINE IN SVPD006.           03710001
208819     COPY DPWS036.                                                03720003
034700                                                                  03730001
034900*----------------------------------------------------------------*03740001
035100 LINKAGE SECTION.                                                 03750001
035200******************************************************************03760001
035300 PROCEDURE DIVISION.                                              03770001
035400******************************************************************03780001
035600 0000-MAINLINE.                                                   03790001
035700                                                                  03800001
035800     PERFORM 1000-INITIALIZE.                                     03810001
035900                                                                  03820001
036100*   IF THIS IS A GIFT CARD ISSUE REQUEST, THEN AUTHORIZE          03830001
036200*   IT. OTHERWISE IT MUST BE A NETWORK ECHO MESSAGE.              03840001
036300                                                                  03850001
036310* 8/31/06 - Deanna Brantner - we will now be processing reversal  03860001
036320*   requests (420).                                               03870001
036330                                                                  03880001
     0****** DISPLAY MESSAGE FOR TESTING PURPOSES                       03890001
      *                                                                 03900001
082800*    SET EP000-SL-INFORMATION TO  TRUE.                           03910001
082900*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      03920001
083000*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   03930001
083100*    STRING 'IN 000-    ' AURD003-MESSAGE-ID DELIMITED BY SIZE    03940001
083200*                   INTO EP000-MD-SYSTEM-LOG-MESSAGE              03950001
083300*                (EP000-MESSAGE-LINE-COUNTER)                     03960001
083400*    END-STRING.                                                  03970001
083500*    PERFORM EP000-1000-POST-MESSAGE.                             03980001
   600* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       03990001
                                                                        04000001
036400     IF AURD003-MID-0200 OR AURD003-MID-0220 OR AURD003-MID-0420  04010001
036500         PERFORM 2000-AUTHORIZE-REQUEST                           04020001
036600     END-IF.                                                      04030001
036700                                                                  04040001
036900*  FORMAT AND SEND AN AUTHORIZATION RESPONSE TO THE ISP.          04050001
037100*  CHECK FOR AUTH INQUIRY OR NETWORK MESSAGE TYPE                 04060001
037200*                                                                 04070001
037400*  RESPONSES ARE ONLY SENT FOR APPROVALS AND DECLINES,            04080001
037500*  ANY SYSTEM ERROR DOES NOT SEND A RESPONSE SO THAT              04090001
037600*  SAFEWAY WILL TIME OUT AND STORE-AND-FORWARD THE TRANSACTION.   04100001
037610     IF AURD003-MID-0200 OR AURD003-MID-0220 OR AURD003-MID-0420  04110001
037700         IF SV005-APPROVE OR SV005-HARD-DECLINE                   04120001
037800             IF AURD003-MID-0200                                  04130001
037900                 PERFORM 5000-FORMAT-0210-AUTH-RESP               04140001
038000             ELSE                                                 04150001
038010                 IF AURD003-MID-0220                              04160001
038100                     PERFORM 5300-FORMAT-0230-SAF-RESP            04170001
038200                 ELSE                                             04180001
038210                     IF AURD003-MID-0420                          04190001
038221                         PERFORM 5400-FORMAT-0430-RVSL-RESP       04200001
038222                     END-IF                                       04210001
038223                 END-IF                                           04220001
038224             END-IF                                               04230001
038230         END-IF                                                   04240001
038400***** AT END OF THE TRANSACTION (WHETHER IT                       04250001
038500***** COMPLETES SUCCESSFULLY OR NOT), THE SVT_CRD_ACCT_LCK ROW    04260001
038600***** MUST STILL BE DELETED.                                      04270001
*********** SOME TRANSACTIONS ARE REJECTED BEFORE THEY ARE CHECKED      04280001
*********** AGAINST THE DATABASES DUE TO INVALID PROCESSING CODE AND    04290001
*********** POS ENTRY.                                                  04300001
009100        IF PV-TABLE-LOCK                                          04310001
038700         PERFORM 4500-DELETE-KMC-LOCK-TABLE                       04320001
009100        END-IF                                                    04330001
038800     ELSE                                                         04340001
038900         PERFORM 5500-FORMAT-NETWORK-MGMT-RESP                    04350001
039000     END-IF.                                                      04360001
039100*                                                                 04370001
039200*  COMMIT ALL CHANGES BEFORE  TERMINATING THE TRANSACTION.        04380001
039300*                                                                 04390001
039400     EXEC CICS                                                    04400001
039500         SYNCPOINT                                                04410001
039600     END-EXEC.                                                    04420001
039700                                                                  04430001
039800* DISPLAY EPCL RESPONSE LOG MESSAGE                               04440001
039900     SET LM-DM-RSP TO TRUE.                                       04450001
040000     PERFORM 8500-MESSAGE-MONITORING.                             04460001
040100                                                                  04470001
040200     GOBACK.                                                      04480001
040400                                                                  04490001
040500*----------------------------------------------------------------*04500001
040600* INITIALIZE                                                     *04510001
040700*----------------------------------------------------------------*04520001
040800 1000-INITIALIZE.                                                 04530001
040900     INITIALIZE SV005-KMC-AUTH-PARAMETERS.                        04540001
041000                                                                  04550001
041100     PERFORM EP000-0000-INITIALIZE.                               04560001
041200                                                                  04570001
041300     MOVE EP000-DT-CURR-DATE-YYYYMMDD                             04580001
041400         TO CD-CURRENT-DATE-YYYYMMDD-X.                           04590001
041500     MOVE CD-CURRENT-YEAR   TO  CD-YYYY.                          04600001
041600     MOVE CD-CURRENT-MONTH  TO  CD-MM.                            04610001
041700     MOVE CD-CURRENT-DAY    TO  CD-DD.                            04620001
041800                                                                  04630001
041900     SET SV005-PS-TENDER-W-ISSUE TO TRUE.                         04640001
009000     SET PV-TABLE-LOCK           TO TRUE.                         04650001
042000                                                                  04660001
042100     PERFORM 7000-RETRIEVE-AUTH-REQUEST.                          04670001
042200     PERFORM 1100-DETERMINE-MSG-TYPE.                             04680001
042300                                                                  04690001
042400*----------------------------------------------------------------*04700001
042500* DETERMINE MESSAGE TYPE                                         *04710001
042600* The message can either be a Online Request (0200), Store and   *04720001
042700* Forward Request (0220), Network Management Request (800) or    *04730001
042800* Gift Card Reversal Request (420).                              *04740001
042900*----------------------------------------------------------------*04750001
043000 1100-DETERMINE-MSG-TYPE.                                         04760001
                                                                        04770001
043100     EVALUATE TRUE                                                04780001
043200       WHEN AURD003-MID-0200                                      04790001
043300         MOVE AURD003-DATA-BUF                                    04800001
043400              TO AU003-SAFEWAY-REQUEST-MESSAGE                    04810001
043500         PERFORM 1200-VERIFY-0200-REQ-MSG                         04820001
043600       WHEN AURD003-MID-0220                                      04830001
043700         MOVE AURD003-DATA-BUF                                    04840001
043800              TO AU005-SAFEWAY-SAF-REQUEST-MSG                    04850001
043900         PERFORM 1300-VERIFY-0220-SAF-REQ-MSG                     04860001
044000       WHEN AURD003-MID-0800                                      04870001
044100         MOVE AURD003-DATA-BUF                                    04880001
044200              TO AU007-SAFEWAY-NETWORK-REQ-MSG                    04890001
044210       WHEN AURD003-MID-0420                                      04900001
044220         MOVE AURD003-DATA-BUF                                    04910001
044230              TO AU009-SAFEWAY-REVERSAL-REQ-MSG                   04920001
044240         PERFORM 1350-VERIFY-0420-RVSL-REQ-MSG                    04930001
044300       WHEN OTHER                                                 04940001
044400         SET PV-INVALID-REQUEST-TYPE TO TRUE                      04950001
044500     END-EVALUATE.                                                04960001
044600*                                                                 04970001
   700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       04980001
044800*    PERFORM VARYING PV-WS-CTR FROM 1 BY 89                       04990001
044900*             UNTIL PV-WS-CTR > 400                               05000001
045000*       SET EP000-SL-INFORMATION TO  TRUE                         05010001
045100*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER    05020001
045200*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 05030001
045300*       MOVE AURD003-DATA-BUF (PV-WS-CTR:89) TO                   05040001
045400*         EP000-MD-SYSTEM-LOG-MESSAGE                             05050001
045500*              (EP000-MESSAGE-LINE-COUNTER)                       05060001
045600*       PERFORM EP000-1000-POST-MESSAGE                           05070001
045700*    END-PERFORM.                                                 05080001
   800* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       05090001
046000                                                                  05100001
046100*---------------------------------------------------------------* 05110001
046200*  VERIFY 0200 REQUEST MESSAGE                                  * 05120001
046300* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 05130001
046400* VERIFY THAT DATA IS VALID.                                    * 05140001
046500*---------------------------------------------------------------* 05150001
046600 1200-VERIFY-0200-REQ-MSG.                                        05160001
046700* FIRST GET ACCOUNT NUMBER FROM TRACK 2 DATA                      05170001
046800* Account number is always 19 digits, but                         05180001
046900* to be flexible, this program will look for the                  05190001
047000* "=" separator between the account number                        05200001
047100* and expiration date.                                            05210001
047200     UNSTRING AU003-P35-ACCOUNT-NBR                               05220001
047300       DELIMITED BY "="                                           05230001
047400       INTO FW-KMC-ID-INT                                         05240001
047410     END-UNSTRING.                                                05250001
047420     MOVE FW-KMC-ID-INT TO LM-DM-ACCOUNT-NBR.                     05260001
047430                                                                  05270001
047440* SECOND MOVE THE REST OF THE DATA AFTER THE TRACK 2 INTO         05280001
047450* THE REST OF THE COPYBOOK.                                       05290001
047460* THE LENGTH OF TRACK2 IS SENT IN THE MESSAGE.                    05300001
047470* The first 72 bytes are fixed length.                            05310001
047471*  FIND END OF TRACK 2 DATA BASED ON TRACK2 LENGTH                05320001
047472     MOVE AU003-P35-TRACK-2-DATA-LEN TO PV-TRACK2-LEN.            05330001
047473     COMPUTE PV-DATA-POSITION = 72 + PV-TRACK2-LEN.               05340001
047474     COMPUTE PV-REST-OF-DATA-LEN = 4090 - PV-DATA-POSITION.       05350001
047475* AURD003-DATA IS 4090 BYTES, SO TAKE EVERYTHING                  05360001
047476* AFTER THE FIRST 72 PLUS THE LEN OF THE TRACK 2.                 05370001
047477     MOVE AURD003-DATA (PV-DATA-POSITION:PV-REST-OF-DATA-LEN)     05380001
047478       TO AU003-ADDL-REQUEST-DATA.                                05390001
047479                                                                  05400001
047480* SET PROCESSING CODE TO ONLINE                                   05410001
047490     SET  PV-SPC-ONLINE-NORMAL TO TRUE.                           05420001
047500* MOVE STORE NUMBER                                               05430001
047600     MOVE SV004-SAFEWAY-LOCATION TO SV005-STORE-NBR.              05440001
047700* MOVE TERMINAL NUMBER                                            05450001
047800     IF AU003-P41-STORE-NBR IS NUMERIC                            05460001
047900       MOVE AU003-P41-STORE-NBR TO SV005-TERMINAL-NBR             05470001
048000     ELSE                                                         05480001
048100       MOVE ZEROS TO SV005-TERMINAL-NBR                           05490001
048200     END-IF.                                                      05500001
048300* MOVE TRANSACTION NUMBER                                         05510001
048400     IF AU003-P41-TERMINAL-ID IS NUMERIC                          05520001
048500       MOVE AU003-P41-TERMINAL-ID TO SV005-TRANSACTION-NBR        05530001
048600     ELSE                                                         05540001
048700       MOVE ZEROS TO SV005-TRANSACTION-NBR                        05550001
048800     END-IF.                                                      05560001
                                                                        05570001
048900* SETTING THE NO RELOAD TO TRUE SO THAT WE CAN CHECK THE          05580001
      * PROCESSING CODE FOR GO WALLET.                                  05590001
                                                                        05600001
015200     SET PV-SAFEWAY-NO-RELOAD TO TRUE.                            05610001
                                                                        05620001
048900* DETERMINE TRANSACTION TYPE AND CARD TYPE                        05630001
                                                                        05640001
           IF (AU003-P3-PC-TRAN-CODE IS NUMERIC) AND                    05650001
              (AU003-P3-PC-TYPE-OF-ACCOUNT IS NUMERIC) AND              05660001
              (AU003-P3-PC-TO-ACCT IS NUMERIC)                          05670001
             IF (AU003-P3-PC-TRAN-CODE = 60 OR 72) AND                  05680001
                (AU003-P3-PC-TYPE-OF-ACCOUNT = 42) AND                  05690001
                (AU003-P3-PC-TO-ACCT = ZEROES)                          05700001
049000          SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                    05710001
                 IF (AU003-P3-PC-TRAN-CODE = 60)                        05720001
015200              SET PV-SAFEWAY-RELOAD TO TRUE                       05730001
                 END-IF                                                 05740001
             ELSE                                                       05750001
             IF (AU003-P3-PC-TRAN-CODE = 31) AND                        05760001
                (AU003-P3-PC-TYPE-OF-ACCOUNT = 42) AND                  05770001
                (AU003-P3-PC-TO-ACCT = ZEROES)                          05780001
                SET PV-BALANCE-INQUIRY       TO TRUE                    05790001
             ELSE                                                       05800001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     05810001
                SET SV005-HARD-DECLINE TO TRUE                          05820001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          05830001
             END-IF                                                     05840001
             END-IF                                                     05850001
           ELSE                                                         05860001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     05870001
                SET SV005-HARD-DECLINE TO TRUE                          05880001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          05890001
           END-IF.                                                      05900001
                                                                        05910001
           MOVE PV-SAFEWAY-RELOAD-CODE TO  SV005-RELOAD-CODE.           05920001
                                                                        05930001
049100* SET REVERSAL-IND                                                05940001
049200     SET PV-NORMAL TO TRUE.                                       05950001
049300* MOVE TRANSACTION AMOUNT                                         05960001
           IF  PV-BALANCE-INQUIRY                                       05970001
049400        MOVE ZEROES                      TO PV-KMC-AMT            05980001
           ELSE                                                         05990001
049400        MOVE AU003-P4-TRANSACTION-AMOUNT TO PV-KMC-AMT            06000001
           END-IF.                                                      06010001
                                                                        06020001
049500* MOVE STATE ID                                                   06030001
049600     MOVE AU003-P43-ML-STR-LOC-STATE TO PV-STATE-CD.              06040001
049700     PERFORM 1500-VERIFY-STATE-CD.                                06050001
049800                                                                  06060001
049900* DETERMINE KEYED OR SWIPED                                       06070001
050000                                                                  06080001
050100     IF AU003-P22-MAG-STRIPE-READ                                 06090001
050200        SET PV-KMC-SCANNED TO TRUE                                06100001
050300     ELSE                                                         06110001
050100     IF AU003-P22-ONLINE-ENTRY AND PV-BALANCE-INQUIRY             06120001
050200        SET PV-KMC-SCANNED TO TRUE                                06130001
050300     ELSE                                                         06140001
050100       IF AU003-P22-ONLINE-ENTRY AND PV-SAFEWAY-RELOAD            06150001
050200          SET PV-KMC-SCANNED TO TRUE                              06160001
050300       ELSE                                                       06170001
050400          SET PV-KMC-KEY-ENTERED TO TRUE                          06180001
050300       END-IF                                                     06190001
050500     END-IF.                                                      06200001
050600                                                                  06210001
050700                                                                  06220001
050800* MOVE LOCAL DATE                                                 06230001
050900* IF LOCAL DATE IS NOT ZEROS, MOVE TO POS DATE.                   06240001
051000* IF IT IS ZEROS, THEN POS DATE WILL BE THE CURRENT DATE.         06250001
051100* (CURRENT DATE IS DEFAULTED AND MOVED IN PARAG 1000-INIT)        06260001
051200     IF AU003-P13-LOCAL-TRAN-DATE NOT = ZEROS                     06270001
051300       MOVE AU003-P13-LD-DD   TO CD-DD                            06280001
051400       MOVE AU003-P13-LD-MM   TO CD-MM                            06290001
051500* WE DON'T GET LOCAL YEAR PASSED IN THE AUTH, SO IT HAS           06300001
051600* TO BE CALCULATED.                                               06310001
051700* I AM ASSUMING THAT A SAF AUTH WILL NEVER COME IN                06320001
051800* MORE THAN 4 MONTHS OLD.                                         06330001
051900* IF LOCAL MONTH IS SEPT - DEC, CHECK CURRENT MONTH FOR           06340001
052000* JAN - MAY.  IF BOTH ARE TRUE, SUBTRACT ONE FROM YEAR.           06350001
052100* NOTE: I SKIPPED JUNE-AUG BECAUSE OF EOM CONFLICTS.              06360001
052200*       YOU CANNOT CHECK LOCAL = JUNE AND CURRENT = JULY          06370001
052300*       BECAUSE AT THE END OF THE MONTH THAT WOULD BE VALID       06380001
052400*       FOR SAF AND TIME ZONE DIFFERENCES FOR WHICH YOU           06390001
052500*       WOULD NOT WANT THE YEAR CHANGED.                          06400001
052600* IF LOCAL MONTH IS JANUARY, AND CURRENT MONTH                    06410001
052700* IS DECEMBER, ADD ONE TO THE YEAR.                               06420001
052800* IF THE LOCAL AND CURRENT MONTH ARE THE SAME, THEN THE           06430001
052900* YEAR WILL BE THE CURRENT YEAR.                                  06440001
053000       IF AU003-P13-LD-MM > 8 AND CD-CURRENT-MONTH < 6            06450001
053100         SUBTRACT 1 FROM CD-YYYY                                  06460001
053200       END-IF                                                     06470001
053300       IF AU003-P13-LD-MM = 1 AND CD-CURRENT-MONTH = 12           06480001
053400         ADD 1 TO CD-YYYY                                         06490001
053500       END-IF                                                     06500001
053600     END-IF.                                                      06510001
053700     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               06520001
053800                                                                  06530001
053900* DISPLAY EPCL REQUEST LOG MESSAGE                                06540001
054000     SET LM-DM-REQ TO TRUE.                                       06550001
054100     PERFORM 8500-MESSAGE-MONITORING.                             06560001
054200                                                                  06570001
054300* CONVERT CARD NUMBER                                             06580001
054400     PERFORM 1400-CONVERT-CARD-NBR.                               06590001
054600                                                                  06600001
054700*---------------------------------------------------------------* 06610001
054800*  VERIFY 0220 SAF REQUEST MESSAGE                              * 06620001
054900* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 06630001
055000* VERIFY THAT DATA IS VALID.                                    * 06640001
055100*---------------------------------------------------------------* 06650001
055200 1300-VERIFY-0220-SAF-REQ-MSG.                                    06660001
055300* FIRST GET ACCOUNT NUMBER FROM TRACK 2 DATA                      06670001
055400* Account number is always 19 digits, but                         06680001
055500* to be flexible, this program will look for the                  06690001
055600* "=" separator between the account number                        06700001
055700* and expiration date.                                            06710001
055710     UNSTRING AU005-P35-ACCOUNT-NBR                               06720001
055720       DELIMITED BY "="                                           06730001
055730       INTO FW-KMC-ID-INT                                         06740001
055740     END-UNSTRING.                                                06750001
055750     MOVE FW-KMC-ID-INT TO LM-DM-ACCOUNT-NBR.                     06760001
055760* SECOND MOVE THE REST OF THE DATA AFTER THE TRACK 2 INTO         06770001
055770* THE REST OF THE COPYBOOK.                                       06780001
055780* THE LENGTH OF TRACK2 IS SENT IN THE MESSAGE.                    06790001
055781* First 88 bytes of the SAF message are fixed length.             06800001
055782*  FIND END OF TRACK2 DATA USING TRACK2 LENGTH                    06810001
055783     MOVE AU005-P35-TRACK-2-DATA-LEN TO PV-TRACK2-LEN.            06820001
055784     COMPUTE PV-DATA-POSITION = 88 + PV-TRACK2-LEN.               06830001
055785     COMPUTE PV-REST-OF-DATA-LEN = 4090 - PV-DATA-POSITION.       06840001
055786* AURD003-DATA IS 4090 BYTES, SO TAKE EVERYTHING                  06850001
055787* AFTER THE FIRST 88 PLUS THE LEN OF THE TRACK 2.                 06860001
055788     MOVE AURD003-DATA (PV-DATA-POSITION:PV-REST-OF-DATA-LEN)     06870001
055789       TO AU005-ADDL-REQUEST-DATA.                                06880001
055790* SET PROCESSING CODE TO OFFLINE SAF                              06890001
055800     SET  PV-SPC-OFFLINE-SAF  TO TRUE.                            06900001
055900* MOVE STORE NUMBER                                               06910001
056000     MOVE SV004-SAFEWAY-LOCATION TO SV005-STORE-NBR.              06920001
056100* MOVE TERMINAL NUMBER                                            06930001
056200     IF AU005-P41-STORE-NBR IS NUMERIC                            06940001
056300       MOVE AU005-P41-STORE-NBR TO SV005-TERMINAL-NBR             06950001
056400     ELSE                                                         06960001
056500       MOVE ZEROS TO SV005-TERMINAL-NBR                           06970001
056600     END-IF.                                                      06980001
056700* MOVE TRANSACTION NUMBER                                         06990001
056800     IF AU005-P41-TERMINAL-ID IS NUMERIC                          07000001
056900       MOVE AU005-P41-TERMINAL-ID TO SV005-TRANSACTION-NBR        07010001
057000     ELSE                                                         07020001
057100       MOVE ZEROS TO SV005-TRANSACTION-NBR                        07030001
057200     END-IF.                                                      07040001
                                                                        07050001
           SET PV-SAFEWAY-NO-RELOAD TO TRUE.                            07060001
                                                                        07070001
057300* DETERMINE TRANSACTION TYPE AND CARD TYPE                        07080001
           IF (AU005-P3-PC-TRAN-CODE IS NUMERIC) AND                    07090001
              (AU005-P3-PC-TYPE-OF-ACCOUNT IS NUMERIC) AND              07100001
              (AU005-P3-PC-TO-ACCT IS NUMERIC)                          07110001
             IF (AU005-P3-PC-TRAN-CODE = 60 OR 72) AND                  07120001
                (AU005-P3-PC-TYPE-OF-ACCOUNT = 42) AND                  07130001
                (AU005-P3-PC-TO-ACCT = ZEROES)                          07140001
049000          SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                    07150001
                 IF (AU005-P3-PC-TRAN-CODE = 60)                        07160001
015200              SET PV-SAFEWAY-RELOAD TO TRUE                       07170001
                 END-IF                                                 07180001
             ELSE                                                       07190001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     07200001
                SET SV005-HARD-DECLINE TO TRUE                          07210001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          07220001
             END-IF                                                     07230001
           ELSE                                                         07240001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     07250001
                SET SV005-HARD-DECLINE TO TRUE                          07260001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          07270001
           END-IF.                                                      07280001
                                                                        07290001
           MOVE PV-SAFEWAY-RELOAD-CODE TO  SV005-RELOAD-CODE.           07300001
                                                                        07310001
057500* SET REVERSAL-IND                                                07320001
057600     SET PV-NORMAL TO TRUE.                                       07330001
                                                                        07340001
                                                                        07350001
057700* MOVE TRANSACTION AMOUNT                                         07360001
057800     MOVE AU005-P4-TRANSACTION-AMOUNT TO PV-KMC-AMT.              07370001
057900* MOVE STATE ID                                                   07380001
058000     MOVE AU005-P43-ML-STR-LOC-STATE TO PV-STATE-CD.              07390001
058100     PERFORM 1500-VERIFY-STATE-CD.                                07400001
058200                                                                  07410001
058300* DETERMINE KEYED OR SWIPED                                       07420001
058400                                                                  07430001
058500     IF AU005-P22-MAG-STRIPE-READ                                 07440001
058600        SET PV-KMC-SCANNED TO TRUE                                07450001
058700     ELSE                                                         07460001
050100       IF AU005-P22-ONLINE-ENTRY AND PV-SAFEWAY-RELOAD            07470001
058600          SET PV-KMC-SCANNED TO TRUE                              07480001
058700       ELSE                                                       07490001
058800          SET PV-KMC-KEY-ENTERED TO TRUE                          07500001
058700       END-IF                                                     07510001
058900     END-IF.                                                      07520001
059000                                                                  07530001
050600                                                                  07540001
059100                                                                  07550001
059200* MOVE LOCAL DATE                                                 07560001
059300* IF LOCAL DATE IS NOT ZEROS, MOVE TO POS DATE.                   07570001
059400* IF IT IS ZEROS, THEN POS DATE WILL BE THE CURRENT DATE.         07580001
059500* (CURRENT DATE IS DEFAULTED AND MOVED IN PARAG 1000-INIT)        07590001
059600     IF AU005-P13-LOCAL-TRAN-DATE NOT = ZEROS                     07600001
059700       MOVE AU005-P13-LD-DD   TO CD-DD                            07610001
059800       MOVE AU005-P13-LD-MM   TO CD-MM                            07620001
059900* WE DON'T GET LOCAL YEAR PASSED IN THE AUTH, SO IT HAS           07630001
060000* TO BE CALCULATED.                                               07640001
060100* I AM ASSUMING THAT A SAF AUTH WILL NEVER COME IN                07650001
060200* MORE THAN 4 MONTHS OLD.                                         07660001
060300* IF LOCAL MONTH IS SEPT - DEC, CHECK CURRENT MONTH FOR           07670001
060400* JAN - MAY.  IF BOTH ARE TRUE, SUBTRACT ONE FROM YEAR.           07680001
060500* NOTE: I SKIPPED JUNE-AUG BECAUSE OF EOM CONFLICTS.              07690001
060600*       YOU CANNOT CHECK LOCAL = JUNE AND CURRENT = JULY          07700001
060700*       BECAUSE AT THE END OF THE MONTH THAT WOULD BE VALID       07710001
060800*       FOR SAF AND TIME ZONE DIFFERENCES FOR WHICH YOU           07720001
060900*       WOULD NOT WANT THE YEAR CHANGED.                          07730001
061000* IF LOCAL MONTH IS JANUARY, AND CURRENT MONTH                    07740001
061100* IS DECEMBER, ADD ONE TO THE YEAR.                               07750001
061200* IF THE LOCAL AND CURRENT MONTH ARE THE SAME, THEN THE           07760001
061300* YEAR WILL BE THE CURRENT YEAR.                                  07770001
061400       IF AU005-P13-LD-MM > 8 AND CD-CURRENT-MONTH < 6            07780001
061500         SUBTRACT 1 FROM CD-YYYY                                  07790001
061600       END-IF                                                     07800001
061700       IF AU005-P13-LD-MM = 1 AND CD-CURRENT-MONTH = 12           07810001
061800         ADD 1 TO CD-YYYY                                         07820001
061900       END-IF                                                     07830001
062000     END-IF.                                                      07840001
062100     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               07850001
062200                                                                  07860001
062300                                                                  07870001
062400* DISPLAY EPCL REQUEST LOG MESSAGE                                07880001
062500     SET LM-DM-REQ TO TRUE.                                       07890001
062600     PERFORM 8500-MESSAGE-MONITORING.                             07900001
062700                                                                  07910001
062800* CONVERT CARD NUMBER                                             07920001
062900     PERFORM 1400-CONVERT-CARD-NBR.                               07930001
063000                                                                  07940001
063200                                                                  07950001
063220*---------------------------------------------------------------* 07960001
063230*  VERIFY 0420 REVERSAL REQUEST MESSAGE                           07970001
063240* MOVE DATA FROM INPUT MESSAGE INTO WORKING FIELDS.             * 07980001
063250* VERIFY THAT DATA IS VALID.                                    * 07990001
063260*---------------------------------------------------------------* 08000001
063261 1350-VERIFY-0420-RVSL-REQ-MSG.                                   08010001
063262                                                                  08020001
063280* FIRST GET ACCOUNT NUMBER FROM TRACK 2 DATA                      08030001
063290* Account number is always 19 digits, but                         08040001
063291* to be flexible, this program will look for the                  08050001
063292* "=" separator between the account number                        08060001
063293* and expiration date.                                            08070001
063294     UNSTRING AU009-P35-ACCOUNT-NBR                               08080001
063295       DELIMITED BY "="                                           08090001
063296       INTO FW-KMC-ID-INT                                         08100001
063297     END-UNSTRING.                                                08110001
063298     MOVE FW-KMC-ID-INT TO LM-DM-ACCOUNT-NBR.                     08120001
063299                                                                  08130001
063300* SECOND MOVE THE REST OF THE DATA AFTER THE TRACK 2 INTO         08140001
063301* THE REST OF THE COPYBOOK.                                       08150001
063302* THE LENGTH OF TRACK2 IS SENT IN THE MESSAGE.                    08160001
063303* The first 101 bytes are fixed length.                           08170001
063304*  FIND END OF TRACK2 DATA USING TRACK2 LENGTH                    08180001
063305     MOVE AU009-P35-TRACK-2-DATA-LEN TO PV-TRACK2-LEN.            08190001
063306     COMPUTE PV-DATA-POSITION = 101 + PV-TRACK2-LEN.              08200001
063307     COMPUTE PV-REST-OF-DATA-LEN = 4090 - PV-DATA-POSITION.       08210001
063308                                                                  08220001
063309* AURD003-DATA IS 4090 BYTES, SO TAKE EVERYTHING                  08230001
063310* AFTER THE FIRST 101 PLUS THE LEN OF THE TRACK 2.                08240001
063311     MOVE AURD003-DATA (PV-DATA-POSITION:PV-REST-OF-DATA-LEN)     08250001
063312       TO AU009-ADDL-REQUEST-DATA.                                08260001
063313                                                                  08270001
063314* SET PROCESSING CODE TO ONLINE                                   08280001
063316     SET  PV-SPC-ONLINE-NORMAL TO TRUE.                           08290001
063317* MOVE STORE NUMBER                                               08300001
063318     MOVE SV004-SAFEWAY-LOCATION TO SV005-STORE-NBR.              08310001
063319* MOVE TERMINAL NUMBER                                            08320001
063320     IF AU009-P41-STORE-NBR IS NUMERIC                            08330001
063321       MOVE AU009-P41-STORE-NBR TO SV005-TERMINAL-NBR             08340001
063322     ELSE                                                         08350001
063323       MOVE ZEROS TO SV005-TERMINAL-NBR                           08360001
063324     END-IF.                                                      08370001
063325* MOVE TRANSACTION NUMBER                                         08380001
063326     IF AU009-P41-TERMINAL-ID IS NUMERIC                          08390001
063327       MOVE AU009-P41-TERMINAL-ID TO SV005-TRANSACTION-NBR        08400001
063328     ELSE                                                         08410001
063329       MOVE ZEROS TO SV005-TRANSACTION-NBR                        08420001
063330     END-IF.                                                      08430001
                                                                        08440001
063334     SET PV-REVERSAL TO TRUE.                                     08450001
      * SETTING THE NO RELOAD TO TRUE SO THAT WE CAN CHECK THE          08460001
      * PROCESSING CODE FOR GO WALLET.                                  08470001
                                                                        08480001
           SET PV-SAFEWAY-NO-RELOAD TO TRUE.                            08490001
                                                                        08500001
063331* DETERMINE TRANSACTION TYPE AND CARD TYPE                        08510001
           IF (AU009-P3-PC-TRAN-CODE IS NUMERIC) AND                    08520001
              (AU009-P3-PC-TYPE-OF-ACCOUNT IS NUMERIC) AND              08530001
              (AU009-P3-PC-TO-ACCT IS NUMERIC)                          08540001
             IF (AU009-P3-PC-TRAN-CODE = 60 OR 72) AND                  08550001
                (AU009-P3-PC-TYPE-OF-ACCOUNT = 42) AND                  08560001
                (AU009-P3-PC-TO-ACCT = ZEROES)                          08570001
049000          SET PV-ISSUANCE-AS-GIFT-CARD TO TRUE                    08580001
                  IF (AU009-P3-PC-TRAN-CODE = 60)                       08590001
                     SET PV-SAFEWAY-RELOAD TO TRUE                      08600001
                  END-IF                                                08610001
             ELSE                                                       08620001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     08630001
                SET SV005-HARD-DECLINE TO TRUE                          08640001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          08650001
             END-IF                                                     08660001
           ELSE                                                         08670001
044400          SET PV-INVALID-REQUEST-TYPE TO TRUE                     08680001
                SET SV005-HARD-DECLINE TO TRUE                          08690001
009100          SET PV-NO-TABLE-LOCK   TO TRUE                          08700001
           END-IF.                                                      08710001
                                                                        08720001
           MOVE PV-SAFEWAY-RELOAD-CODE TO  SV005-RELOAD-CODE.           08730001
                                                                        08740001
063333* SET REVERSAL-IND                                                08750001
063335* MOVE TRANSACTION AMOUNT                                         08760001
063336     MOVE AU009-P4-TRANSACTION-AMOUNT TO PV-KMC-AMT.              08770001
063337* MOVE STATE ID                                                   08780001
063338     MOVE AU009-P43-ML-STR-LOC-STATE TO PV-STATE-CD.              08790001
063339     PERFORM 1500-VERIFY-STATE-CD.                                08800001
063340                                                                  08810001
063341* DETERMINE KEYED OR SWIPED                                       08820001
063342     IF AU009-P22-MAG-STRIPE-READ                                 08830001
063343        SET PV-KMC-SCANNED TO TRUE                                08840001
063344     ELSE                                                         08850001
           IF AU009-P22-ONLINE-ENTRY AND PV-SAFEWAY-RELOAD              08860001
               SET PV-KMC-SCANNED TO TRUE                               08870001
           ELSE                                                         08880001
               SET PV-KMC-KEY-ENTERED TO TRUE                           08890001
063346     END-IF.                                                      08900001
063347                                                                  08910001
063349* MOVE LOCAL DATE                                                 08920001
063350* IF LOCAL DATE IS NOT ZEROS, MOVE TO POS DATE.                   08930001
063351* IF IT IS ZEROS, THEN POS DATE WILL BE THE CURRENT DATE.         08940001
063352* (CURRENT DATE IS DEFAULTED AND MOVED IN PARAG 1000-INIT)        08950001
063353     IF AU009-P13-LOCAL-TRAN-DATE NOT = ZEROS                     08960001
063354       MOVE AU009-P13-LD-DD   TO CD-DD                            08970001
063355       MOVE AU009-P13-LD-MM   TO CD-MM                            08980001
063356* WE DON'T GET LOCAL YEAR PASSED IN THE AUTH, SO IT HAS           08990001
063357* TO BE CALCULATED.                                               09000001
063360* IF LOCAL MONTH IS SEPT - DEC, CHECK CURRENT MONTH FOR           09010001
063361* JAN - MAY.  IF BOTH ARE TRUE, SUBTRACT ONE FROM YEAR.           09020001
063362* NOTE: I SKIPPED JUNE-AUG BECAUSE OF EOM CONFLICTS.              09030001
063363*       YOU CANNOT CHECK LOCAL = JUNE AND CURRENT = JULY          09040001
063364*       BECAUSE AT THE END OF THE MONTH THAT WOULD BE VALID       09050001
063365*       FOR SAF AND TIME ZONE DIFFERENCES FOR WHICH YOU           09060001
063366*       WOULD NOT WANT THE YEAR CHANGED.                          09070001
063367* IF LOCAL MONTH IS JANUARY, AND CURRENT MONTH                    09080001
063368* IS DECEMBER, ADD ONE TO THE YEAR.                               09090001
063369* IF THE LOCAL AND CURRENT MONTH ARE THE SAME, THEN THE           09100001
063370* YEAR WILL BE THE CURRENT YEAR.                                  09110001
063371       IF AU009-P13-LD-MM > 8 AND CD-CURRENT-MONTH < 6            09120001
063372         SUBTRACT 1 FROM CD-YYYY                                  09130001
063373       END-IF                                                     09140001
063374       IF AU009-P13-LD-MM = 1 AND CD-CURRENT-MONTH = 12           09150001
063375         ADD 1 TO CD-YYYY                                         09160001
063376       END-IF                                                     09170001
063377     END-IF.                                                      09180001
063378     MOVE CD-DB2-DATE-FORMAT     TO SV005-POS-DATE.               09190001
063379                                                                  09200001
063381* DISPLAY EPCL REQUEST LOG MESSAGE                                09210001
063382     SET LM-DM-REQ TO TRUE.                                       09220001
063383     PERFORM 8500-MESSAGE-MONITORING.                             09230001
063384                                                                  09240001
063385* CONVERT CARD NUMBER                                             09250001
063386     PERFORM 1400-CONVERT-CARD-NBR.                               09260001
063387                                                                  09270001
063390*----------------------------------------------------------------*09280001
063400*  CONVERT-CARD-NBR                                              *09290001
063500*  CONVERT CARD FROM 19 DIGITS TO THE STANDARD LENGTH            *09300001
063600*----------------------------------------------------------------*09310001
063700 1400-CONVERT-CARD-NBR.                                           09320001
063800* VERIFY ACCOUNT NUMBER                                           09330001
063900* Routine SV007-FORMAT-CARD is used to get 12-digit               09340001
064000* card number that is used on database.                           09350001
064100*    SET SV003-SAFEWAY-AUTH-PGM TO TRUE                           09360001
064110     MOVE SV004-PC-SAFEWAY-CRD-LGTH TO SV007-CARD-NUMBER-LENGTH.  09370001
064200     MOVE FW-KMC-ID-INT TO SV007-CARD-NUMBER-IN.                  09380001
064300     PERFORM SV007-FORMAT-CARD.                                   09390001
064400                                                                  09400001
064500* IF CARD IS INVALID LENGTH, SEND A DECLINE.                      09410001
064600     IF SV007-CARD-NBR > 0                                        09420001
064700         MOVE SV007-CARD-NBR TO PV-KMC-ID                         09430001
064800     ELSE                                                         09440001
064900         SET PS-AUTH-MESSAGE-ERROR                                09450001
065000             SV005-HARD-DECLINE                                   09460001
009100             PV-NO-TABLE-LOCK                                     09470001
065100             PV-SRC-UNKNOWN-ACCOUNT                               09480001
065200             EP000-SL-ERROR  TO TRUE                              09490001
065300         MOVE AURD003-DATA-BUF TO                                 09500001
065400                   AM-POS-INQ-REMOTE-AUTH-MSG                     09510001
065500         MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                09520001
065600         MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE                       09530001
065700             TO   EP000-MD-SYSTEM-LOG-MESSAGE                     09540001
065800                     (EP000-MESSAGE-LINE-COUNTER)                 09550001
065900         ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 09560001
066000         MOVE SV007-CARD-NUMBER-LENGTH TO                         09570001
066100              PV-DISPLAY-ACCT-LENGTH                              09580001
066200         STRING                                                   09590001
066300             'ACCOUNT '                                           09600001
066400              FW-KMC-ID-INT                                       09610001
066500              ' IS INVALID LENGTH: '                              09620001
066600              PV-DISPLAY-ACCT-LENGTH                              09630001
066700            DELIMITED BY SIZE                                     09640001
066800            INTO EP000-MD-SYSTEM-LOG-MESSAGE                      09650001
066900                     (EP000-MESSAGE-LINE-COUNTER)                 09660001
067000         END-STRING                                               09670001
067100         PERFORM EP000-1000-POST-MESSAGE                          09680001
067200     END-IF.                                                      09690001
067300                                                                  09700001
067700******************************************************************09710001
067800* VERIFY THAT THE STATE CODE IS A VALID STATE.                   *09720001
067900* If state code is not valid or is blank, then move the default  *09730001
068000* state code.                                                    *09740001
068100******************************************************************09750001
068200 1500-VERIFY-STATE-CD.                                            09760001
068300                                                                  09770001
068400     MOVE PV-STATE-CD TO TSTATE-STATE-CODE.                       09780001
068500                                                                  09790001
068600     EXEC SQL                                                     09800001
068700         SELECT STATE_NAME                                        09810001
068800           INTO :TSTATE-STATE-NAME                                09820001
068900           FROM TSTATE                                            09830001
069000          WHERE STATE_CODE = :TSTATE-STATE-CODE                   09840001
069100          WITH UR                                                 09850001
069200     END-EXEC.                                                    09860001
069300                                                                  09870001
069400     EVALUATE SQLCODE                                             09880001
069500         WHEN ZERO                                                09890001
069600             CONTINUE                                             09900001
069700         WHEN +100                                                09910001
069800             MOVE PC-DEFAULT-STATE-CD TO PV-STATE-CD              09920001
069900         WHEN OTHER                                               09930001
070000             MOVE 'SELECT FROM TSTATE'                            09940001
070100                          TO AA-ATTEMPTED-ACTION                  09950001
070200             PERFORM 9100-DB2-ERROR                               09960001
070300             MOVE PC-DEFAULT-STATE-CD TO PV-STATE-CD              09970001
070400     END-EVALUATE.                                                09980001
070500                                                                  09990001
070600*---------------------------------------------------------------* 10000001
070700* AUTHORIZE REQUEST                                             * 10010001
070800*  AUTHORIZE THE STORED VALUE REQUEST                           * 10020001
070900*---------------------------------------------------------------* 10030001
071000 2000-AUTHORIZE-REQUEST.                                          10040001
071194                                                                  10050001
071200     EVALUATE TRUE                                                10060001
071300        WHEN (NOT SV005-APPROVE)                                  10070001
071400            MOVE ZEROS              TO SV005-APPROVED-TENDER-AMT  10080001
071500            MOVE PV-KMC-AMT         TO SV005-TRANS-AMT            10090001
071600            MOVE ZEROS              TO SV005-KMC-REMAINING-BALANCE10100001
071700            SET SV005-GIFT-CRD      TO TRUE                       10110001
071800                                                                  10120001
071900        WHEN OTHER                                                10130001
072000            PERFORM 2100-AUTHORIZE-KMC                            10140001
072100            IF (PV-TEST-GIFT-CARD-ACCOUNTS)                       10150001
072200               CONTINUE                                           10160001
072300            ELSE                                                  10170001
072400              EVALUATE TRUE                                       10180001
072500               WHEN SV005-REFERRAL                                10190001
072600               WHEN SV005-PGM-ABEND                               10200001
072700                    SET PS-AUTH-MESSAGE-ERROR                     10210001
072800                        EP000-SL-ERROR TO TRUE                    10220001
072900                    MOVE AURD003-DATA-BUF           TO            10230001
073000                                       AM-POS-INQ-REMOTE-AUTH-MSG 10240001
073100                    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER     10250001
073200                    MOVE AM-AUTH-MESSAGE-ERROR-MESSAGE            10260001
073300                        TO  EP000-MD-SYSTEM-LOG-MESSAGE           10270001
073400                                (EP000-MESSAGE-LINE-COUNTER)      10280001
073500                    IF SV005-MESSAGE-1 = SPACE AND                10290001
073600                        SV005-MESSAGE-2 = SPACE                   10300001
073700                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  10310001
073800                        MOVE 'UNEXPECTED ABEND IN SVPD005 '       10320001
073900                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       10330001
074000                                    (EP000-MESSAGE-LINE-COUNTER)  10340001
074100                    ELSE                                          10350001
074200                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  10360001
074300                        MOVE SV005-MESSAGE-1                      10370001
074400                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       10380001
074500                                    (EP000-MESSAGE-LINE-COUNTER)  10390001
074600                        ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER  10400001
074700                        MOVE SV005-MESSAGE-2                      10410001
074800                            TO  EP000-MD-SYSTEM-LOG-MESSAGE       10420001
074900                                    (EP000-MESSAGE-LINE-COUNTER)  10430001
075000                    END-IF                                        10440001
075100                    PERFORM EP000-1000-POST-MESSAGE               10450001
075200                                                                  10460001
075300               WHEN SV005-APPROVE                                 10470001
                                                                        10480001
      *  FOR BALANCE INQUIRIES WE WILL NOT BE SETTING ANY DATABASE FIELD10490001
                                                                        10500001
                         IF SV005-INQUIRE                               10510001
                            NEXT SENTENCE                               10520001
                         END-IF                                         10530001
                                                                        10540001
075400                   PERFORM 3000-SET-COLUMNS                       10550001
                                                                        10560001
075410                   IF PV-REVERSAL                                 10570001
075420                       INITIALIZE PV-RETRY-COUNT                  10580001
075430                       PERFORM 4200-UPDATE-KMC-ACTIVITY-TABLE     10590001
075440                          WITH TEST AFTER                         10600001
075450                          UNTIL ((SQLCODE = ZERO) OR              10610001
075460                                 (PV-RETRY-COUNT >                10620001
075470                                  PC-MAXIMUM-RETRY-COUNT))        10630001
075480                       IF ((SQLCODE = -904) OR                    10640001
075490                            (SQLCODE = -913))                     10650001
075491                            MOVE 'UPDATE A ROW (SVT00002)'        10660001
075493                                           TO  AA-ATTEMPTED-ACTION10670001
075494                            PERFORM 9100-DB2-ERROR                10680001
075495                            PERFORM 9999-RETURN-TO-NATIVE-CICS    10690001
075496                       END-IF                                     10700001
075497                       SET SV005-REVERSAL TO TRUE                 10710001
075498                       MOVE SV005-REVERSAL-CODE                   10720001
075499                                        TO SVT00002-TRN-RVRSL-CDE 10730001
075500                       MOVE SV004-VOID-TRANS                      10740001
075501                                        TO SVT00002-TRN-VOID-IND  10750001
075502                       MOVE SV005-REVERSAL-AMT                    10760001
075503                                        TO SVT00002-APP-AUTH-AMT  10770001
075504                   END-IF                                         10780001
075530                   INITIALIZE PV-RETRY-COUNT                      10790001
075600                   PERFORM 4000-INSERT-KMC-ACTIVITY-TABLE         10800001
075700                                                                  10810001
075800                      WITH TEST AFTER                             10820001
075900                      UNTIL ((SQLCODE = ZERO) OR                  10830001
076000                             (PV-RETRY-COUNT >                    10840001
076100                              PC-MAXIMUM-RETRY-COUNT))            10850001
076200                   IF ((SQLCODE = -904) OR                        10860001
076300                        (SQLCODE = -913))                         10870001
076400                        MOVE                                      10880001
076500                       'INSERT A ROW (SVT00002)'                  10890001
076600                                  TO       AA-ATTEMPTED-ACTION    10900001
076700                      PERFORM 9100-DB2-ERROR                      10910001
076800                      PERFORM 9999-RETURN-TO-NATIVE-CICS          10920001
076900                   END-IF                                         10930001
077000                   INITIALIZE PV-RETRY-COUNT                      10940001
077100                   PERFORM 4100-INSERT-KMC-3RD-PRTY-TABLE         10950001
077300                        WITH TEST AFTER                           10960001
077400                          UNTIL ((SQLCODE = ZERO) OR              10970001
077500                             (PV-RETRY-COUNT >                    10980001
077600                              PC-MAXIMUM-RETRY-COUNT))            10990001
077700                   IF ((SQLCODE = -904) OR   (SQLCODE = -913))    11000001
077900                       MOVE  'INSERT A ROW (SVT00015)'            11010001
078100                                          TO   AA-ATTEMPTED-ACTION11020001
078200                       PERFORM 9100-DB2-ERROR                     11030001
078300                       PERFORM 9999-RETURN-TO-NATIVE-CICS         11040001
078410                   END-IF                                         11050001
078500            END-EVALUATE                                          11060001
078600         END-IF                                                   11070001
078700     END-EVALUATE.                                                11080001
078900                                                                  11090001
079000*----------------------------------------------------------------*11100001
079100*  PERFORM THE AUTHORIZATION AGAINST THE SV DATABASE             *11110001
079200*----------------------------------------------------------------*11120001
079300 2100-AUTHORIZE-KMC.                                              11130001
079400                                                                  11140001
079500     MOVE PV-KMC-ID              TO SV005-KMC-ID.                 11150001
079600     MOVE PV-REQUEST-TYPE        TO SV005-ACTIVITY-TYPE.          11160001
079800     MOVE PV-KMC-AMT             TO SV005-TRANS-AMT.              11170001
079900     SET  PV-E-NON-ECOMM-STORE   TO TRUE.                         11180001
080000     MOVE PV-E-BUS-IND           TO SV005-E-BUS-LOC-IND.          11190001
080010     IF AURD003-MID-0420                                          11200001
080100         SET SV005-VOID          TO TRUE                          11210001
               SET PV-REVERSAL         TO TRUE                          11220001
079700         MOVE PV-REVERSAL-IND    TO SV005-REVERSAL-CODE           11230001
080110     ELSE                                                         11240001
080120         SET SV005-NOT-VOID      TO TRUE                          11250001
080130     END-IF.                                                      11260001
080200     SET SV005-GIFT-CRD          TO TRUE.                         11270001
080300                                                                  11280001
080400     SET SV005-PV-FROM-AUKCS507 TO TRUE.                          11290001
080500                                                                  11300001
080600     IF (PV-TEST-GIFT-CARD-ACCOUNTS)                              11310001
080700                                                                  11320001
080800* TEST ACCOUNTS GET FIXED RESPONSES                               11330001
080900       IF EP000-PV-KOHLS-PROD-SYSTEM                              11340001
081000           MOVE 7      TO SV005-RESPONSE-CODE                     11350001
081100           MOVE 0      TO SV005-TRANS-AMT                         11360001
081200       ELSE                                                       11370001
081300           PERFORM 2200-TEST-ACCOUNTS                             11380001
081400       END-IF                                                     11390001
081500     ELSE                                                         11400001
081600                                                                  11410001
081700* NON-TEST ACCOUNTS GET REAL DATABASE AUTHORIZATIONS              11420001
081800* NOTE: KEY-ENTERED SALES ARE NOT ALLOWED FOR SAFEWAY             11430001
081900        IF PV-KMC-KEY-ENTERED                                     11440001
082000               MOVE 0      TO SV005-TRANS-AMT                     11450001
                     SET SV005-HARD-DECLINE TO TRUE                     11460001
                     SET PV-NO-TABLE-LOCK   TO TRUE                     11470001
082200        ELSE                                                      11480001
                IF SV005-HARD-DECLINE                                   11490001
082000               MOVE 0                 TO SV005-TRANS-AMT          11500001
                     SET PV-NO-TABLE-LOCK   TO TRUE                     11510001
082200          ELSE                                                    11520001
082300             MOVE ZEROES TO XST00025-POS-CAP-LVL-ID               11530001
082310             PERFORM SV005-A100-MAINLINE                          11540001
082400          END-IF                                                  11550001
082200        END-IF                                                    11560001
082500     END-IF.                                                      11570001
082630*                                                                 11580001
    30* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       11590001
082800*    SET EP000-SL-INFORMATION TO  TRUE.                           11600001
082900*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      11610001
083000*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   11620001
083100*    STRING 'RESPONSE = ' SV005-RESPONSE-CODE DELIMITED BY SIZE   11630001
083200*                   INTO EP000-MD-SYSTEM-LOG-MESSAGE              11640001
083300*                (EP000-MESSAGE-LINE-COUNTER)                     11650001
083400*    END-STRING.                                                  11660001
083500*    PERFORM EP000-1000-POST-MESSAGE.                             11670001
   600* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       11680001
083700                                                                  11690001
083800*----------------------------------------------------------------*11700001
083900* POS TEST ACCOUNT RESPONSES                                     *11710001
084000* STANDARD TEST RESPONSES USED BY POS SYSTEM TESTING             *11720001
084100* RESPONSES ARE THE SAME NO MATTER WHAT TRANSACTION AMOUNT IS.   *11730001
084200*----------------------------------------------------------------*11740001
084300 2200-TEST-ACCOUNTS.                                              11750001
084400*  GIFT CARD ISSUE APPROVALS                                      11760001
084500     IF (PV-KMC-ID = PC-TEST-GIFT-1000000321)                     11770001
084600        MOVE 0              TO SV005-RESPONSE-CODE                11780001
084700        MOVE PV-KMC-AMT     TO SV005-TRANS-AMT                    11790001
084800     END-IF.                                                      11800001
084900*  GIFT CARD ISSUE DECLINES                                       11810001
085000     IF (PV-KMC-ID = PC-TEST-GIFT-1000000107)                     11820001
085100        MOVE 7      TO SV005-RESPONSE-CODE                        11830001
085200        MOVE 0      TO SV005-TRANS-AMT                            11840001
085300     END-IF.                                                      11850001
085400                                                                  11860001
085500*  GIFT CARD ISSUE REFERAL                                        11870001
085600     IF (PV-KMC-ID = PC-TEST-GIFT-1000000370)                     11880001
085700        MOVE 8      TO SV005-RESPONSE-CODE                        11890001
085800        MOVE 0      TO SV005-TRANS-AMT                            11900001
085900     END-IF.                                                      11910001
086000                                                                  11920001
086100*  GIFT CARD ISSUE PGM ABEND                                      11930001
086200     IF (PV-KMC-ID = PC-TEST-GIFT-1000000388)                     11940001
086300        MOVE 9      TO SV005-RESPONSE-CODE                        11950001
086400        MOVE 0      TO SV005-TRANS-AMT                            11960001
086500     END-IF.                                                      11970001
086600                                                                  11980001
086700*  GIFT CARD ISSUE REFERAL                                        11990001
086800     IF (PV-KMC-ID = PC-TEST-GIFT-1000000396)                     12000001
086900        SET SV005-REFERRAL TO TRUE                                12010001
087000        MOVE 0      TO SV005-TRANS-AMT                            12020001
087100     END-IF.                                                      12030001
087200                                                                  12040001
087400*----------------------------------------------------------------*12050001
087500* SET-COLUMNS                                                    *12060001
087600* POPULATE DATABASE VARIABLES                                    *12070001
087700*----------------------------------------------------------------*12080001
087800 3000-SET-COLUMNS.                                                12090001
087900     MOVE SV005-KMC-ID            TO SVT00002-CRD-NBR             12100001
088000                                     SVT00015-CRD-NBR.            12110001
088100     EXEC SQL                                                     12120001
088200         SELECT  CURRENT TIMESTAMP                                12130001
088300           INTO  :SVT00002-TRN-AUTH-TMST                          12140001
088400           FROM  SYSIBM.SYSDUMMY1                                 12150001
088500     END-EXEC.                                                    12160001
088600     MOVE SVT00002-TRN-AUTH-TMST  TO SVT00015-TRN-AUTH-TMST.      12170001
088700     MOVE SPACES                  TO SVT00002-DRV-LIC-NBR         12180001
088800     MOVE SV005-REVERSAL-CODE     TO SVT00002-TRN-RVRSL-CDE.      12190001
088900     MOVE 'N'                     TO SVT00002-TRN-VOID-IND.       12200001
089000     MOVE SV005-ACTIVITY-TYPE     TO SVT00002-ACTVY-TYP-CDE.      12210001
089100     MOVE SV005-POS-DATE          TO SVT00002-POS-DTE.            12220001
089200     MOVE SV005-STORE-NBR         TO SVT00002-STR-NBR.            12230001
089300     MOVE SV005-TERMINAL-NBR      TO SVT00002-POS-TRMNL-NBR.      12240001
089400     MOVE SV005-TRANSACTION-NBR   TO SVT00002-POS-TRN-NBR.        12250001
089500     MOVE SV004-DEFAULT-TIMESTAMP TO SVT00002-TRN-PSTD-TMST.      12260001
089510         EVALUATE TRUE                                            12270001
089520             WHEN SV005-NORMAL                                    12280001
089530               IF PV-TENDER                                       12290001
089540                  MULTIPLY -1 BY  SV005-APPROVED-TENDER-AMT       12300001
089560               END-IF                                             12310001
089570             WHEN PV-REVERSAL                                     12320001
089591                 MULTIPLY -1  BY  SV005-APPROVED-TENDER-AMT       12330001
089594         END-EVALUATE                                             12340001
089600     MOVE SV005-APPROVED-TENDER-AMT TO SVT00002-APP-AUTH-AMT      12350001
089700                                       SVT00002-ORIG-AUTH-AMT.    12360001
089800     MOVE ZEROS                   TO SVT00002-POS-OPRT-ID.        12370001
089900     MOVE 'SAFEWAY'               TO SVT00002-APVL-USR-ID.        12380001
090000     MOVE SV004-STAT-AUTH-RECEIVED-CD                             12390001
090100                                 TO SVT00002-ACTVY-STAT-CDE.      12400001
090200     MOVE PV-STATE-CD            TO SVT00002-ST-CDE.              12410001
090210     IF SV005-APPROVED-TENDER-AMT < ZERO                          12420001
090220         MULTIPLY -1  BY    SV005-APPROVED-TENDER-AMT             12430001
090240     END-IF.                                                      12440001
090300     MOVE SPACES                 TO SVT00015-SELR-PSTL-CDE        12450001
090400                                    SVT00015-SELR-TRN-ID.         12460001
090500     MOVE PV-SAFEWAY-PROCESSING-CODE                              12470001
090600                                 TO SVT00015-PRCG-CDE.            12480001
090700     MOVE SV005-KMC-APPROVAL-NBR TO SVT00015-KOHLS-AUTH-CDE.      12490001
090800                                                                  12500001
090900                                                                  12510001
091000     IF AURD003-MID-0200                                          12520001
091100        MOVE AU003-P7-TRANSMIT-DATE-TIME TO                       12530001
091200                                    SVT00015-TRSM-DTE-TM-TXT      12540001
091300        MOVE AU003-P11-SYS-TRACE-AUDIT-NBR TO                     12550001
091400                                    SVT00015-AUD-NBR              12560001
091500        MOVE AU003-P12-LOCAL-TRAN-TIME TO                         12570001
091600                                    SVT00015-SELR-TRN-TM-TXT      12580001
091700        MOVE AU003-P13-LOCAL-TRAN-DATE TO                         12590001
091800                                    SVT00015-SELR-TRN-DTE-TXT     12600001
091900        MOVE AU003-P22-POS-ENTRY-MODE  TO PV-POS-ENTR-CDE         12610001
092000        MOVE PV-POS-ENTR-CDE TO     SVT00015-POS-ENTR-CDE         12620001
092100        MOVE AU003-P25-POS-CONDITION-CODE TO                      12630001
092200                                    SVT00015-POS-CND-CDE          12640001
092300        MOVE AU003-P37-RETRIEVAL-REF-NBR  TO                      12650001
092400                                    SVT00015-POS-REF-NBR          12660001
092500        MOVE AU003-P41-STORE-NBR      TO                          12670001
092600                                    SVT00015-SELR-STR-NBR         12680001
092700        MOVE AU003-P41-TERMINAL-ID    TO                          12690001
092800                                    SVT00015-SELR-TRMNL-ID        12700001
092900        MOVE AU003-P41-DIVISION       TO                          12710001
093000                                    SVT00015-DIV-ID               12720001
093100        MOVE AU003-P41-FILLER         TO                          12730001
093200                                    SVT00015-CMNT-TXT             12740001
093300        MOVE AU003-P43-ML-STR-LOC-NAME TO                         12750001
093400                                    SVT00015-SELR-NM              12760001
093500        MOVE AU003-P43-ML-STR-LOC-CITY TO                         12770001
093600                                    SVT00015-SELR-CTY-NM          12780001
093700        MOVE AU003-P43-ML-STR-LOC-CNTRY TO                        12790001
093800                                    SVT00015-SELR-CNTRY-CDE       12800001
093900        MOVE AU003-P60-TERM-DIV-ID      TO                        12810001
094000                                    SVT00015-TRMNL-DIV-ID         12820001
094100     ELSE                                                         12830001
094110        IF AURD003-MID-0220                                       12840001
094200            MOVE AU005-P7-TRANSMIT-DATE-TIME TO                   12850001
094300                                          SVT00015-TRSM-DTE-TM-TXT12860001
094400            MOVE AU005-P11-SYS-TRACE-AUDIT-NBR TO                 12870001
094500                                          SVT00015-AUD-NBR        12880001
094600            MOVE AU005-P12-LOCAL-TRAN-TIME TO                     12890001
094700                                          SVT00015-SELR-TRN-TM-TXT12900001
094800            MOVE AU005-P13-LOCAL-TRAN-DATE TO                     12910001
094900                                         SVT00015-SELR-TRN-DTE-TXT12920001
095000            MOVE AU005-P22-POS-ENTRY-MODE  TO PV-POS-ENTR-CDE     12930001
095100            MOVE PV-POS-ENTR-CDE TO      SVT00015-POS-ENTR-CDE    12940001
095200            MOVE AU005-P25-POS-CONDITION-CODE TO                  12950001
095300                                         SVT00015-POS-CND-CDE     12960001
095400            MOVE AU005-P37-RETRIEVAL-REF-NBR  TO                  12970001
095500                                           SVT00015-POS-REF-NBR   12980001
095600            MOVE AU005-P41-STORE-NBR   TO  SVT00015-SELR-STR-NBR  12990001
095800            MOVE AU005-P41-TERMINAL-ID TO  SVT00015-SELR-TRMNL-ID 13000001
096000            MOVE AU005-P41-DIVISION    TO  SVT00015-DIV-ID        13010001
096200            MOVE AU005-P41-FILLER      TO  SVT00015-CMNT-TXT      13020001
096400            MOVE AU005-P43-ML-STR-LOC-NAME TO SVT00015-SELR-NM    13030001
096600            MOVE AU005-P43-ML-STR-LOC-CITY TO SVT00015-SELR-CTY-NM13040001
096800            MOVE AU005-P43-ML-STR-LOC-CNTRY TO                    13050001
096900                                           SVT00015-SELR-CNTRY-CDE13060001
097000            MOVE AU005-P60-TERM-DIV-ID TO  SVT00015-TRMNL-DIV-ID  13070001
097111        ELSE                                                      13080001
097120            MOVE AU009-P7-TRANSMIT-DATE-TIME TO                   13090001
097130                                          SVT00015-TRSM-DTE-TM-TXT13100001
097140            MOVE AU009-P11-SYS-TRACE-AUDIT-NBR TO SVT00015-AUD-NBR13110001
097160            MOVE AU009-P12-LOCAL-TRAN-TIME TO                     13120001
097170                                          SVT00015-SELR-TRN-TM-TXT13130001
097180            MOVE AU009-P13-LOCAL-TRAN-DATE TO                     13140001
097190                                         SVT00015-SELR-TRN-DTE-TXT13150001
097193            MOVE AU009-P25-POS-CONDITION-CODE TO                  13160001
097194                                              SVT00015-POS-CND-CDE13170001
097195            MOVE AU009-P37-RETRIEVAL-REF-NBR  TO                  13180001
097196                                              SVT00015-POS-REF-NBR13190001
097197            MOVE AU009-P41-STORE-NBR   TO SVT00015-SELR-STR-NBR   13200001
097199            MOVE AU009-P41-TERMINAL-ID TO SVT00015-SELR-TRMNL-ID  13210001
097201            MOVE AU009-P41-DIVISION    TO SVT00015-DIV-ID         13220001
097203            MOVE AU009-P41-FILLER      TO SVT00015-CMNT-TXT       13230001
097211            MOVE AU009-P60-TERM-DIV-ID TO SVT00015-TRMNL-DIV-ID   13240001
097220        END-IF                                                    13250001
097230     END-IF.                                                      13260001
097300                                                                  13270001
097600*----------------------------------------------------------------*13280001
097700* INSERT-KMC-ACTIVITY-TABLE                                      *13290001
097800* INSERT THE TRANSACTION INTO THE SVT_KOHLS_CRD_TXN TABLE        *13300001
097900*----------------------------------------------------------------*13310001
098000 4000-INSERT-KMC-ACTIVITY-TABLE.                                  13320001
098100                                                                  13330001
098200* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       13340001
098300*       SET EP000-SL-INFORMATION TO  TRUE.                        13350001
098400*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.   13360001
098500*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                13370001
098600*       STRING 'ENTRYMODE: ' AU003-P22-POS-ENTRY-MODE             13380001
098700*              'SVT00015-POS-ENTR-CDE ON NEXT LINE:'              13390001
098800*             DELIMITED BY SIZE                                   13400001
098900*                   INTO EP000-MD-SYSTEM-LOG-MESSAGE              13410001
099000*                (EP000-MESSAGE-LINE-COUNTER)                     13420001
099100*       END-STRING.                                               13430001
099200*       PERFORM EP000-1000-POST-MESSAGE.                          13440001
099300* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       13450001
099400* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       13460001
099500*       SET EP000-SL-INFORMATION TO  TRUE.                        13470001
099600*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.   13480001
099700*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                13490001
099800*       MOVE SVT00015-POS-ENTR-CDE TO                             13500001
099900*                   EP000-MD-SYSTEM-LOG-MESSAGE                   13510001
100000*                (EP000-MESSAGE-LINE-COUNTER).                    13520001
100100*       PERFORM EP000-1000-POST-MESSAGE.                          13530001
100200* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       13540001
100300                                                                  13550001
100400     EXEC SQL INSERT                                              13560001
100500              INTO SVT_KOHLS_CRD_TXN                              13570001
100600                  (CRD_NBR                                        13580001
100700                  ,TRN_AUTH_TMST                                  13590001
100800                  ,DRV_LIC_NBR                                    13600001
100900                  ,TRN_RVRSL_CDE                                  13610001
101000                  ,TRN_VOID_IND                                   13620001
101100                  ,ACTVY_TYP_CDE                                  13630001
101200                  ,POS_DTE                                        13640001
101300                  ,STR_NBR                                        13650001
101400                  ,POS_TRMNL_NBR                                  13660001
101500                  ,POS_TRN_NBR                                    13670001
101600                  ,TRN_PSTD_TMST                                  13680001
101700                  ,APP_AUTH_AMT                                   13690001
101800                  ,POS_OPRT_ID                                    13700001
101900                  ,APVL_USR_ID                                    13710001
102000                  ,ACTVY_STAT_CDE                                 13720001
102100                  ,ORIG_AUTH_AMT                                  13730001
102200                  ,ST_CDE)                                        13740001
102300           VALUES                                                 13750001
102400              (:SVT00002-CRD-NBR                                  13760001
102500              ,:SVT00002-TRN-AUTH-TMST                            13770001
102600              ,:SVT00002-DRV-LIC-NBR                              13780001
102700              ,:SVT00002-TRN-RVRSL-CDE                            13790001
102800              ,:SVT00002-TRN-VOID-IND                             13800001
102900              ,:SVT00002-ACTVY-TYP-CDE                            13810001
103000              ,:SVT00002-POS-DTE                                  13820001
103100              ,:SVT00002-STR-NBR                                  13830001
103200              ,:SVT00002-POS-TRMNL-NBR                            13840001
103300              ,:SVT00002-POS-TRN-NBR                              13850001
103400              ,:SVT00002-TRN-PSTD-TMST                            13860001
103500              ,:SVT00002-APP-AUTH-AMT                             13870001
103600              ,:SVT00002-POS-OPRT-ID                              13880001
103700              ,:SVT00002-APVL-USR-ID                              13890001
103800              ,:SVT00002-ACTVY-STAT-CDE                           13900001
103900              ,:SVT00002-ORIG-AUTH-AMT                            13910001
104000              ,:SVT00002-ST-CDE)                                  13920001
104100      END-EXEC.                                                   13930001
104200                                                                  13940001
104300      EVALUATE TRUE                                               13950001
104400               WHEN SQLCODE = -904                                13960001
104500               WHEN SQLCODE = -913                                13970001
104600                    ADD 1 TO PV-RETRY-COUNT                       13980001
104700               WHEN SQLCODE < 0                                   13990001
104800                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00002)'     14000001
104900                                 TO AA-ATTEMPTED-ACTION           14010001
105000                    PERFORM 9100-DB2-ERROR                        14020001
105100                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14030001
105200               WHEN SQLCODE > 0                                   14040001
105300               WHEN SQLWARN0 NOT = SPACES                         14050001
105400                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00002)'     14060001
105500                                 TO AA-ATTEMPTED-ACTION           14070001
105600                    PERFORM 9200-DB2-WARNING                      14080001
105700                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14090001
105800               WHEN OTHER                                         14100001
105900                    CONTINUE                                      14110001
106000      END-EVALUATE.                                               14120001
106200                                                                  14130001
106300*----------------------------------------------------------------*14140001
106400* INSERT-KMC-3RD-PRTY-TABLE                                      *14150001
106500* INSERT THE TRANSACTION INTO THE SVT_3RD_PTY_TRN TABLE          *14160001
106600*----------------------------------------------------------------*14170001
106700 4100-INSERT-KMC-3RD-PRTY-TABLE.                                  14180001
106800                                                                  14190001
107000     EXEC SQL INSERT                                              14200001
107100              INTO SVT_3RD_PTY_TRN                                14210001
107200                  (CRD_NBR                                        14220001
107300                  ,TRN_AUTH_TMST                                  14230001
107400                  ,TRSM_DTE_TM_TXT                                14240001
107500                  ,AUD_NBR                                        14250001
107600                  ,SELR_TRN_TM_TXT                                14260001
107700                  ,SELR_TRN_DTE_TXT                               14270001
107800                  ,POS_ENTR_CDE                                   14280001
107900                  ,POS_CND_CDE                                    14290001
108000                  ,POS_REF_NBR                                    14300001
108100                  ,SELR_STR_NBR                                   14310001
108200                  ,SELR_TRMNL_ID                                  14320001
108300                  ,DIV_ID                                         14330001
108400                  ,CMNT_TXT                                       14340001
108500                  ,SELR_NM                                        14350001
108600                  ,SELR_CTY_NM                                    14360001
108700                  ,SELR_PSTL_CDE                                  14370001
108800                  ,SELR_CNTRY_CDE                                 14380001
108900                  ,TRMNL_DIV_ID                                   14390001
109000                  ,KOHLS_AUTH_CDE                                 14400001
109100                  ,PRCG_CDE                                       14410001
109200                  ,SELR_TRN_ID)                                   14420001
109300           VALUES                                                 14430001
109400              (:SVT00015-CRD-NBR                                  14440001
109500              ,:SVT00015-TRN-AUTH-TMST                            14450001
109600              ,:SVT00015-TRSM-DTE-TM-TXT                          14460001
109700              ,:SVT00015-AUD-NBR                                  14470001
109800              ,:SVT00015-SELR-TRN-TM-TXT                          14480001
109900              ,:SVT00015-SELR-TRN-DTE-TXT                         14490001
110000              ,:SVT00015-POS-ENTR-CDE                             14500001
110100              ,:SVT00015-POS-CND-CDE                              14510001
110200              ,:SVT00015-POS-REF-NBR                              14520001
110300              ,:SVT00015-SELR-STR-NBR                             14530001
110400              ,:SVT00015-SELR-TRMNL-ID                            14540001
110500              ,:SVT00015-DIV-ID                                   14550001
110600              ,:SVT00015-CMNT-TXT                                 14560001
110700              ,:SVT00015-SELR-NM                                  14570001
110800              ,:SVT00015-SELR-CTY-NM                              14580001
110900              ,:SVT00015-SELR-PSTL-CDE                            14590001
111000              ,:SVT00015-SELR-CNTRY-CDE                           14600001
111100              ,:SVT00015-TRMNL-DIV-ID                             14610001
111200              ,:SVT00015-KOHLS-AUTH-CDE                           14620001
111300              ,:SVT00015-PRCG-CDE                                 14630001
111400              ,:SVT00015-SELR-TRN-ID)                             14640001
111500      END-EXEC.                                                   14650001
111600                                                                  14660001
111700      EVALUATE TRUE                                               14670001
111800               WHEN SQLCODE = -904                                14680001
111900               WHEN SQLCODE = -913                                14690001
112000                    ADD 1 TO PV-RETRY-COUNT                       14700001
112100               WHEN SQLCODE < 0                                   14710001
112200                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00015)'     14720001
112300                                 TO AA-ATTEMPTED-ACTION           14730001
112400                    PERFORM 9100-DB2-ERROR                        14740001
112500                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14750001
112600               WHEN SQLCODE > 0                                   14760001
112700               WHEN SQLWARN0 NOT = SPACES                         14770001
112800                    MOVE 'INSERT KMC ACTIVITY ROW (SVT00015)'     14780001
112900                                 TO AA-ATTEMPTED-ACTION           14790001
113000                    PERFORM 9200-DB2-WARNING                      14800001
113100                    PERFORM 9999-RETURN-TO-NATIVE-CICS            14810001
113200               WHEN OTHER                                         14820001
113300                    CONTINUE                                      14830001
113400      END-EVALUATE.                                               14840001
113600                                                                  14850001
113700*----------------------------------------------------------------*14860001
113800* DELETE-KMC-LOCK-TABLE                                          *14870001
113900*----------------------------------------------------------------*14880001
114000 4500-DELETE-KMC-LOCK-TABLE.                                      14890001
114100                                                                  14900001
114200     EXEC SQL DELETE                                              14910001
114300              FROM SVT_CRD_ACCT_LCK                               14920001
114400         WHERE CRD_NBR       = :SV005-KMC-ID                      14930001
114500     END-EXEC.                                                    14940001
114600                                                                  14950001
114700     EVALUATE TRUE                                                14960001
114800              WHEN SQLCODE = 0                                    14970001
114900              WHEN SQLCODE = +100                                 14980001
115000              WHEN SQLCODE = -310                                 14990001
115100              WHEN SQLCODE = -904                                 15000001
115200              WHEN SQLCODE = -913                                 15010001
115300                  CONTINUE                                        15020001
115400              WHEN SQLCODE < 0                                    15030001
115500                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          15040001
115600                                TO AA-ATTEMPTED-ACTION            15050001
115700                   PERFORM 9100-DB2-ERROR                         15060001
115800                   PERFORM 9999-RETURN-TO-NATIVE-CICS             15070001
115900              WHEN SQLCODE > 0                                    15080001
116000              WHEN SQLWARN0 NOT = SPACES                          15090001
116100                   MOVE 'DELETE KMC LOCK ROW (SVT00004)'          15100001
116200                                TO AA-ATTEMPTED-ACTION            15110001
116300                   PERFORM 9200-DB2-WARNING                       15120001
116400                   PERFORM 9999-RETURN-TO-NATIVE-CICS             15130001
116500              WHEN OTHER                                          15140001
116600                   CONTINUE                                       15150001
116700     END-EVALUATE.                                                15160001
116900                                                                  15170001
116910*----------------------------------------------------------------*15180001
116920* UPDATE TRANSACTION IN TABLE FOR REVERSAL                       *15190001
116930*----------------------------------------------------------------*15200001
116940 4200-UPDATE-KMC-ACTIVITY-TABLE.                                  15210001
116950                                                                  15220001
116960     SET SV005-NORMAL TO TRUE                                     15230001
116970     MOVE SV005-REVERSAL-CODE TO SVT00002-TRN-RVRSL-CDE.          15240001
116980     COMPUTE SVT00002-APP-AUTH-AMT = SVT00002-APP-AUTH-AMT        15250001
116990                                       * -1.                      15260001
116991                                                                  15270001
116992     EXEC SQL                                                     15280001
116993         UPDATE SVT_KOHLS_CRD_TXN                                 15290001
116994           SET TRN_VOID_IND  = :SV004-VOID-TRANS                  15300001
116995         WHERE CRD_NBR       = :SVT00002-CRD-NBR                  15310001
116996           AND TRN_RVRSL_CDE = :SVT00002-TRN-RVRSL-CDE            15320001
116997           AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS              15330001
116998           AND ACTVY_TYP_CDE = :SVT00002-ACTVY-TYP-CDE            15340001
116999           AND POS_DTE       = :SVT00002-POS-DTE                  15350001
117000           AND STR_NBR       = :SVT00002-STR-NBR                  15360001
117001           AND POS_TRMNL_NBR = :SVT00002-POS-TRMNL-NBR            15370001
117002           AND POS_TRN_NBR   = :SVT00002-POS-TRN-NBR              15380001
117003           AND APP_AUTH_AMT  = :SVT00002-APP-AUTH-AMT             15390001
117004     END-EXEC.                                                    15400001
117005                                                                  15410001
117006     EVALUATE TRUE                                                15420001
117007         WHEN SQLCODE = -904                                      15430001
117008         WHEN SQLCODE = -913                                      15440001
117009             ADD 1 TO PV-RETRY-COUNT                              15450001
117010         WHEN SQLCODE < 0                                         15460001
117011             MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'            15470001
117012                                           TO AA-ATTEMPTED-ACTION 15480001
117013             PERFORM 9100-DB2-ERROR                               15490001
117014             PERFORM 9999-RETURN-TO-NATIVE-CICS                   15500001
117015         WHEN SQLCODE > 0                                         15510001
117016         WHEN SQLWARN0 NOT = SPACES                               15520001
117017              MOVE 'UPDATE KMC ACTIVITY ROW (SVT00002)'           15530001
117018                                            TO AA-ATTEMPTED-ACTION15540001
117019              PERFORM 9200-DB2-WARNING                            15550001
117020              PERFORM 9999-RETURN-TO-NATIVE-CICS                  15560001
117021         WHEN OTHER                                               15570001
117022              CONTINUE                                            15580001
117023     END-EVALUATE.                                                15590001
117024                                                                  15600001
117030*----------------------------------------------------------------*15610001
117100*  FORMAT-0210-AUTH-RESP                                         *15620001
117200*  FORMAT THE 0210 ONLINE AUTH RESPONSE MESSAGE, WHICH WILL      *15630001
117300*  BE SENT BACK TO THE STORE ISP.                                *15640001
117400*----------------------------------------------------------------*15650001
117500 5000-FORMAT-0210-AUTH-RESP.                                      15660001
117600     INITIALIZE AURD004-TOT-REC-LENGTH                            15670001
117700                AURD004-MATCHING-NBR-FIELD.                       15680001
117800                                                                  15690001
117900     MOVE AU003-SAFEWAY-REQUEST-DATA TO                           15700001
118000          AU004-SAFEWAY-RESPONSE-DATA.                            15710001
118100     MOVE AU003-SAFEWAY-TRACK2-DATA                               15720001
118200       TO AU004-SAFEWAY-TRACK2-DATA.                              15730001
118300                                                                  15740001
118400     SET AU004-B24-RESP             TO TRUE.                      15750001
118500     SET AU004-MI-ISO-AUTH-RESPONSE TO TRUE.                      15760001
118600     SET AU004-PRI-BIT-MAP-DEFAULT  TO TRUE.                      15770001
118700     MOVE AU003-P37-RETRIEVAL-REF-NBR TO                          15780001
118710          AU004-P37-RETRIEVAL-REF-NBR.                            15790001
118720     MOVE AU003-P41-CARD-ACCEPTOR-TERM TO                         15800001
118730          AU004-P41-CARD-ACCEPTOR-TERM.                           15810001
118740     MOVE AU003-P49-CURRENCY-CODE   TO                            15820001
118750          AU004-P49-CURRENCY-CODE.                                15830001
118760     MOVE AU003-P60-TERM-DIVISION   TO                            15840001
118770          AU004-P60-TERM-DIVISION.                                15850001
118780                                                                  15860001
118790     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          15870001
118800       IF SV005-APPROVE                                           15880001
118900           MOVE SV005-KMC-APPROVAL-NBR TO                         15890001
119000                AU004-P38-AUTHORIZATION-CODE                      15900001
             ELSE                                                       15910001
                 MOVE SPACES TO                                         15920001
119000                AU004-P38-AUTHORIZATION-CODE                      15930001
119100       END-IF                                                     15940001
119200     ELSE                                                         15950001
119300         MULTIPLY SV005-TRANS-AMT BY 100                          15960001
119400                                GIVING PV-APPROVAL-NBR            15970001
119500         MOVE PV-APPROVAL-NBR TO                                  15980001
119600           AU004-P38-AUTHORIZATION-CODE                           15990001
119700     END-IF.                                                      16000001
119800                                                                  16010001
119900                                                                  16020001
120000* TRANSLATE KOHL'S RESPONSE CODES TO SAFEWAY RESPONSE CODES       16030001
120900     EVALUATE SV005-RESPONSE-CODE                                 16040001
121000       WHEN 0                                                     16050001
121100         SET AU004-P39-APPROVAL                                   16060001
121200             PV-SRC-APPROVED TO TRUE                              16070001
121300       WHEN 7                                                     16080001
121400         IF SV005-DUPLICATE                                       16090001
                 IF PV-REVERSAL                                         16100001
                    SET AU004-P39-ALREADY-REVERSED                      16110001
                        PV-ALREADY-REVERSED TO TRUE                     16120001
                 ELSE                                                   16130001
                   IF PV-SAFEWAY-RELOAD                                 16140001
122600                SET AU004-P39-GENERIC-DENIAL                      16150001
122700                    PV-SRC-GENERIC-DENIAL    TO TRUE              16160001
                   ELSE                                                 16170001
121500                SET AU004-P39-ALREADY-ACTIVE                      16180001
121600                    PV-SRC-ALREADY-ACTIVE TO TRUE                 16190001
                   END-IF                                               16200001
                 END-IF                                                 16210001
121700         ELSE                                                     16220001
121800           IF (PV-SRC-UNKNOWN-ACCOUNT) OR                         16230001
                    (SV005-CARD-ID-INVALID-ISSUE) OR                    16240001
                    (SV005-CARD-ID-INVALID-ADD-ON)                      16250001
121900             SET AU004-P39-UNKNOWN-ACCOUNT                        16260001
                       PV-SRC-GENERIC-DENIAL    TO TRUE                 16270001
122000           ELSE                                                   16280001
                   IF (SV005-TRAN-DLR-OVER-LIM-ADD-ON) OR               16290001
                       (SV005-CARD-BAL-OVER-LIM-ADD-ON)                 16300001
                       SET AU004-P39-INVALID-AMT TO TRUE                16310001
                   ELSE                                                 16320001
                     IF (SV005-CARD-STAT-INV-ISSUE) OR                  16330001
                        (SV005-CARD-STAT-INV-ADD-ON)                    16340001
                         SET AU004-P39-INACTIVE-ACCOUNT TO TRUE         16350001
00CHG0               ELSE                                               16360001
00CHG0                 IF SV005-DUPLICATE-NOT-FOUND                     16370001
00CHG0                    SET AU004-P39-ALREADY-ACTIVE                  16380001
00CHG0                        PV-SRC-ALREADY-ACTIVE TO TRUE             16390001
                       ELSE                                             16400001
122100                    SET AU004-P39-GENERIC-DENIAL                  16410001
122200                        PV-SRC-GENERIC-DENIAL TO TRUE             16420001
00CHG0                 END-IF                                           16430001
                     END-IF                                             16440001
                   END-IF                                               16450001
122300           END-IF                                                 16460001
122400         END-IF                                                   16470001
122500       WHEN OTHER                                                 16480001
122600         SET AU004-P39-GENERIC-DENIAL                             16490001
122700             PV-SRC-GENERIC-DENIAL    TO TRUE                     16500001
122800     END-EVALUATE.                                                16510001
122900                                                                  16520001
171200     MOVE AU004-P39-RESPONSE-CODE TO PV-SAFEWAY-RESP-CODE.        16530001
122900                                                                  16540001
122910     SET AU004-P54-LEN12 TO TRUE.                                 16550001
122920     IF PV-SRC-APPROVED                                           16560001
015200       IF PV-SAFEWAY-RELOAD                                       16570001
122930         MULTIPLY SV005-KMC-REMAINING-BALANCE by 100              16580001
122940                                GIVING   AU004-P54-BALANCE-AMT    16590001
015200       ELSE                                                       16600001
               IF SV005-INQUIRE                                         16610001
122930           MOVE SV005-KMC-REMAINING-BALANCE                       16620001
                                  TO AU004-P4-TRANSACTION-AMOUNT        16630001
122930           MULTIPLY AU004-P4-TRANSACTION-AMOUNT by 100            16640001
122940                                GIVING   AU004-P54-BALANCE-AMT    16650001
               ELSE                                                     16660001
122930           MULTIPLY AU004-P4-TRANSACTION-AMOUNT by 100            16670001
122940                                GIVING   AU004-P54-BALANCE-AMT    16680001
               END-IF                                                   16690001
             END-IF                                                     16700001
122950     ELSE                                                         16710001
122960***** WHEN THE GIFT CARD IS NOT APPROVED, RETURN ZEROES           16720001
122970         MOVE ZEROES                      TO AU004-P54-BALANCE-AMT16730001
122980     END-IF.                                                      16740001
122990                                                                  16750001
123000** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               16760001
123001     MOVE 1 TO PV-RESPONSE-LEN.                                   16770001
123002     STRING AU004-ISO-HEADER-FIELDS,                              16780001
123003            AU004-SAFEWAY-RESPONSE-DATA,                          16790001
123004            AU004-SAFEWAY-TRACK2-DATA (1:PV-TRACK2-LEN),          16800001
123005            AU004-ADDL-RESPONSE-DATA                              16810001
123006            DELIMITED BY SIZE                                     16820001
123007            INTO AURD004-RESPONSE-MESSAGE                         16830001
123008            WITH POINTER PV-RESPONSE-LEN                          16840001
123009     END-STRING.                                                  16850001
123010     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             16860001
123020                                                                  16870001
123030** NOW YOU CAN CALCULATE THE HEX LENGTH OF THE RESPONSE.          16880001
123040     MOVE PV-RESPONSE-LEN TO PV-MSG-LEN-WOHDR.                    16890001
123050** FOR MESSAGE LENGTH WITH HEADER, ADD 2.                         16900001
123060     COMPUTE PV-MSG-LEN-WHDR = PV-MSG-LEN-WOHDR + 2.              16910001
123070** CONVERT MESSAGE LENGTH WITHOUT HEADER TO HEX AND INSERT        16920001
123080** INTO THE RESPONSE MESSAGE.                                     16930001
123090     MOVE PV-MSG-LEN-WOHDR TO PV-HEX-BINARY.                      16940001
123100                                                                  16950001
123200     MOVE PV-HEX-LENGTH TO AURD004-DATA-LEN-HEX.                  16960001
123300                                                                  16970001
123400** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          16980001
123500** HEADER.                                                        16990001
123600     MOVE PV-MSG-LEN-WHDR TO AURD004-TOT-REC-LENGTH.              17000001
123700*                                                                 17010001
   700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       17020001
123900*    SET EP000-SL-INFORMATION TO  TRUE.                           17030001
124000*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      17040001
124100*                                                                 17050001
124200*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   17060001
124300*    MOVE 'IN 5000-FORMAT-0210-AUTH-RESP'                         17070001
124400*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              17080001
124500*                (EP000-MESSAGE-LINE-COUNTER).                    17090001
124600*    PERFORM EP000-1000-POST-MESSAGE.                             17100001
124700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       17110001
124800* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       17120001
124900*    PERFORM VARYING PV-WS-CTR FROM 1 BY 89                       17130001
125000*             UNTIL PV-WS-CTR > 400                               17140001
125100*       SET EP000-SL-INFORMATION TO  TRUE                         17150001
125200*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER    17160001
125300*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 17170001
125400*       MOVE AU004-SAFEWAY-RESPONSE-MESSAGE (PV-WS-CTR:89) TO     17180001
125500*         EP000-MD-SYSTEM-LOG-MESSAGE                             17190001
125600*              (EP000-MESSAGE-LINE-COUNTER)                       17200001
125700*       PERFORM EP000-1000-POST-MESSAGE                           17210001
125800*    END-PERFORM.                                                 17220001
   900* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       17230001
126000                                                                  17240001
126100* SEND DATA TO LISTENER                                           17250001
126200     PERFORM 8000-SEND-DATA-TO-LISTENER.                          17260001
126300                                                                  17270001
126500*----------------------------------------------------------------*17280001
126600*  FORMAT-0230-SAF-RESP                                          *17290001
126700*  FORMAT THE 0230 SAF    AUTH RESPONSE MESSAGE, WHICH WILL      *17300001
126800*  BE SENT BACK TO THE STORE ISP.                                *17310001
126900*----------------------------------------------------------------*17320001
127000 5300-FORMAT-0230-SAF-RESP.                                       17330001
127100     INITIALIZE AURD004-TOT-REC-LENGTH                            17340001
127200                AURD004-MATCHING-NBR-FIELD.                       17350001
127300                                                                  17360001
127400     MOVE AU005-SAFEWAY-SAF-REQUEST-DATA TO                       17370001
127500          AU006-SAFEWAY-SAF-RESP-DATA.                            17380001
127600     MOVE AU005-SAFEWAY-SAF-TRACK2-DATA                           17390001
127700       TO AU006-SAFEWAY-SAF-TRACK2-DATA.                          17400001
127800                                                                  17410001
127900     SET AU006-B24-RESP             TO TRUE.                      17420001
128000     SET AU006-MI-ISO-SAF-RESPONSE  TO TRUE.                      17430001
128100     SET AU006-PRI-BIT-MAP-DEFAULT  TO TRUE.                      17440001
128200     SET AU006-SEC-BIT-MAP-DEFAULT  TO TRUE.                      17450001
128300     MOVE AU005-P37-RETRIEVAL-REF-NBR TO                          17460001
128400          AU006-P37-RETRIEVAL-REF-NBR.                            17470001
128500     MOVE AU005-P41-CARD-ACCEPTOR-TERM TO                         17480001
128600          AU006-P41-CARD-ACCEPTOR-TERM.                           17490001
128700     MOVE AU005-P49-CURRENCY-CODE   TO                            17500001
128800          AU006-P49-CURRENCY-CODE.                                17510001
128900     MOVE AU005-P60-TERM-DIVISION   TO                            17520001
129000          AU006-P60-TERM-DIVISION.                                17530001
129100     MOVE AU005-S110-ORIGINAL-INFO TO                             17540001
129200          AU006-S110-ORIGINAL-INFO.                               17550001
129300     MOVE AU005-S111-UPC TO AU006-S111-UPC.                       17560001
129400                                                                  17570001
129500     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          17580001
118800       IF SV005-APPROVE                                           17590001
118900           MOVE SV005-KMC-APPROVAL-NBR TO                         17600001
119000                AU006-P38-AUTHORIZATION-CODE                      17610001
             ELSE                                                       17620001
                 MOVE SPACES TO                                         17630001
119000                AU006-P38-AUTHORIZATION-CODE                      17640001
119100       END-IF                                                     17650001
130000     ELSE                                                         17660001
130100         MULTIPLY SV005-TRANS-AMT BY 100                          17670001
130200                                GIVING PV-APPROVAL-NBR            17680001
130300         MOVE PV-APPROVAL-NBR TO                                  17690001
130400           AU006-P38-AUTHORIZATION-CODE                           17700001
130500     END-IF.                                                      17710001
130600                                                                  17720001
130700                                                                  17730001
120000* TRANSLATE KOHL'S RESPONSE CODES TO SAFEWAY RESPONSE CODES       17740001
120900     EVALUATE SV005-RESPONSE-CODE                                 17750001
121000       WHEN 0                                                     17760001
121100         SET AU006-P39-APPROVAL                                   17770001
121200             PV-SRC-APPROVED TO TRUE                              17780001
121300       WHEN 7                                                     17790001
121400         IF SV005-DUPLICATE                                       17800001
                 IF PV-REVERSAL                                         17810001
                    SET AU006-P39-ALREADY-REVERSED                      17820001
                        PV-ALREADY-REVERSED TO TRUE                     17830001
                 ELSE                                                   17840001
                   IF PV-SAFEWAY-RELOAD                                 17850001
122600                SET AU006-P39-GENERIC-DENIAL                      17860001
122700                    PV-SRC-GENERIC-DENIAL    TO TRUE              17870001
                   ELSE                                                 17880001
121500                SET AU006-P39-ALREADY-ACTIVE                      17890001
121600                    PV-SRC-ALREADY-ACTIVE TO TRUE                 17900001
                   END-IF                                               17910001
                 END-IF                                                 17920001
121700         ELSE                                                     17930001
121800           IF (PV-SRC-UNKNOWN-ACCOUNT) OR                         17940001
                    (SV005-CARD-ID-INVALID-ISSUE) OR                    17950001
                    (SV005-CARD-ID-INVALID-ADD-ON)                      17960001
121900             SET AU006-P39-UNKNOWN-ACCOUNT                        17970001
                       PV-SRC-GENERIC-DENIAL    TO TRUE                 17980001
122000           ELSE                                                   17990001
                   IF (SV005-TRAN-DLR-OVER-LIM-ADD-ON) OR               18000001
                        (SV005-CARD-BAL-OVER-LIM-ADD-ON)                18010001
                       SET AU006-P39-INVALID-AMT TO TRUE                18020001
                   ELSE                                                 18030001
                     IF (SV005-CARD-STAT-INV-ISSUE) OR                  18040001
                        (SV005-CARD-STAT-INV-ADD-ON)                    18050001
                         SET AU006-P39-INACTIVE-ACCOUNT TO TRUE         18060001
00CHG0               ELSE                                               18070001
00CHG0                 IF SV005-DUPLICATE-NOT-FOUND                     18080001
00CHG0                    SET AU004-P39-ALREADY-ACTIVE                  18090001
00CHG0                        PV-SRC-ALREADY-ACTIVE TO TRUE             18100001
                       ELSE                                             18110001
122100                    SET AU006-P39-GENERIC-DENIAL                  18120001
122200                        PV-SRC-GENERIC-DENIAL TO TRUE             18130001
00CHG0                 END-IF                                           18140001
                     END-IF                                             18150001
                   END-IF                                               18160001
122300           END-IF                                                 18170001
122400         END-IF                                                   18180001
122500       WHEN OTHER                                                 18190001
122600         SET AU006-P39-GENERIC-DENIAL                             18200001
122700             PV-SRC-GENERIC-DENIAL    TO TRUE                     18210001
122800     END-EVALUATE.                                                18220001
132900                                                                  18230001
171200     MOVE AU006-P39-RESPONSE-CODE TO PV-SAFEWAY-RESP-CODE.        18240001
132900                                                                  18250001
133000** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               18260001
133100     MOVE 1 TO PV-RESPONSE-LEN.                                   18270001
133200     STRING AU006-ISO-HEADER-FIELDS,                              18280001
133300            AU006-SAFEWAY-SAF-RESP-DATA,                          18290001
133400            AU006-SAFEWAY-SAF-TRACK2-DATA (1:PV-TRACK2-LEN),      18300001
133500            AU006-ADDL-RESPONSE-DATA                              18310001
133510            DELIMITED BY SIZE                                     18320001
133520            INTO AURD004-RESPONSE-MESSAGE                         18330001
133530            WITH POINTER PV-RESPONSE-LEN                          18340001
133540     END-STRING.                                                  18350001
133550     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             18360001
133560                                                                  18370001
133570** NOW YOU CAN CALCULATE THE HEX LENGTH OF THE RESPONSE.          18380001
133580     MOVE PV-RESPONSE-LEN TO PV-MSG-LEN-WOHDR.                    18390001
133590** FOR MESSAGE LENGTH WITH HEADER, ADD 2.                         18400001
133600     COMPUTE PV-MSG-LEN-WHDR = PV-MSG-LEN-WOHDR + 2.              18410001
133700** CONVERT MESSAGE LENGTH WITHOUT HEADER TO HEX AND INSERT        18420001
133800** INTO THE RESPONSE MESSAGE.                                     18430001
133900     MOVE PV-MSG-LEN-WOHDR TO PV-HEX-BINARY.                      18440001
134000                                                                  18450001
134100     MOVE PV-HEX-LENGTH TO AURD004-DATA-LEN-HEX.                  18460001
134200                                                                  18470001
134300** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          18480001
134400** HEADER.                                                        18490001
134500     MOVE PV-MSG-LEN-WHDR TO AURD004-TOT-REC-LENGTH.              18500001
134600                                                                  18510001
134700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       18520001
134800*    SET EP000-SL-INFORMATION TO  TRUE.                           18530001
134900*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      18540001
135000*                                                                 18550001
135100*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   18560001
135200*    MOVE 'IN 5300-0230-SAF-RESP'                                 18570001
135300*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              18580001
135400*                (EP000-MESSAGE-LINE-COUNTER).                    18590001
135500*    PERFORM EP000-1000-POST-MESSAGE.                             18600001
135600* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       18610001
135700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       18620001
135800*    PERFORM VARYING PV-WS-CTR FROM 1 BY 89                       18630001
135900*             UNTIL PV-WS-CTR > 400                               18640001
136000*       SET EP000-SL-INFORMATION TO  TRUE                         18650001
136100*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER    18660001
136200*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 18670001
136300*       MOVE AURD004-DATA-BUF (PV-WS-CTR:89) TO                   18680001
136400*         EP000-MD-SYSTEM-LOG-MESSAGE                             18690001
136500*              (EP000-MESSAGE-LINE-COUNTER)                       18700001
136600*       PERFORM EP000-1000-POST-MESSAGE                           18710001
136700*    END-PERFORM.                                                 18720001
136800* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       18730001
136900                                                                  18740001
137000* SEND DATA TO LISTENER                                           18750001
137100     PERFORM 8000-SEND-DATA-TO-LISTENER.                          18760001
137200                                                                  18770001
137410*----------------------------------------------------------------*18780001
137430*  FORMAT THE 0430 REVERSAL RESPONSE MESSAGE, WHICH WILL         *18790001
137440*  BE SENT BACK TO THE STORE ISP.                                *18800001
137450*----------------------------------------------------------------*18810001
137461 5400-FORMAT-0430-RVSL-RESP.                                      18820001
137470     INITIALIZE AURD004-TOT-REC-LENGTH                            18830001
137480                AURD004-MATCHING-NBR-FIELD.                       18840001
137490                                                                  18850001
137491     MOVE AU009-SAFEWAY-RVSL-REQ-DATA TO                          18860001
137492          AU010-SAFEWAY-RVSL-RSP-DATA.                            18870001
137493     MOVE AU009-SAFEWAY-RVSL-TRACK2-DATA                          18880001
137494       TO AU010-SAFEWAY-RVSL-TRACK2-DATA.                         18890001
137495                                                                  18900001
137496     SET AU010-B24-RESP             TO TRUE.                      18910001
137497     SET AU010-MI-ISO-RVSL-RESPONSE TO TRUE.                      18920001
137498     SET AU010-PRI-BIT-MAP-DFLT     TO TRUE.                      18930001
137499     SET AU010-SEC-BIT-MAP-DFLT     TO TRUE.                      18940001
137500     MOVE AU009-P25-POS-CONDITION-CODE to                         18950001
137501          AU010-P25-POS-CONDITION-CODE.                           18960001
137502     MOVE AU009-P32-ACQR-INST-ID TO                               18970001
137503          AU010-P32-ACQR-INST-ID.                                 18980001
137504     MOVE AU009-P35-TRACK-2-DATA-LEN TO                           18990001
137505          AU010-P35-TRACK-2-DATA-LEN.                             19000001
137506     MOVE AU009-P35-TRACK-2-DATA TO                               19010001
137507          AU010-P35-TRACK-2-DATA.                                 19020001
137508     MOVE AU009-P37-RETRIEVAL-REF-NBR TO                          19030001
137509          AU010-P37-RETRIEVAL-REF-NBR.                            19040001
137510     MOVE AU009-P41-CARD-ACCEPTOR-TERM TO                         19050001
137511          AU010-P41-CARD-ACCEPTOR-TERM.                           19060001
137512     MOVE AU009-P49-CURRENCY-CODE   TO                            19070001
137513          AU010-P49-CURRENCY-CODE.                                19080001
137514     MOVE AU009-P60-TERM-DIVISION   TO                            19090001
137515          AU010-P60-TERM-DIVISION.                                19100001
137516     MOVE AU009-S110-ORIGINAL-INFO TO                             19110001
137517          AU010-S110-ORIGINAL-INFO.                               19120001
137518     MOVE AU009-S111-UPC TO AU010-S111-UPC.                       19130001
137519                                                                  19140001
137520     IF (NOT PV-TEST-GIFT-CARD-ACCOUNTS)                          19150001
137521       IF SV005-APPROVE                                           19160001
137522           MOVE SV005-KMC-APPROVAL-NBR TO                         19170001
137523                AU010-P38-AUTHORIZATION-CODE                      19180001
137524       ELSE                                                       19190001
137522           MOVE SPACES TO                                         19200001
137523                AU010-P38-AUTHORIZATION-CODE                      19210001
137524       END-IF                                                     19220001
137525     ELSE                                                         19230001
137526         MULTIPLY SV005-TRANS-AMT BY 100                          19240001
137527                                GIVING PV-APPROVAL-NBR            19250001
137528         MOVE PV-APPROVAL-NBR TO                                  19260001
137529           AU010-P38-AUTHORIZATION-CODE                           19270001
137530     END-IF.                                                      19280001
137531                                                                  19290001
120000* TRANSLATE KOHL'S RESPONSE CODES TO SAFEWAY RESPONSE CODES       19300001
120900     EVALUATE SV005-RESPONSE-CODE                                 19310001
121000       WHEN 0                                                     19320001
121100         SET AU010-P39-APPROVAL                                   19330001
121200             PV-SRC-APPROVED TO TRUE                              19340001
121300       WHEN 7                                                     19350001
121400         IF SV005-DUPLICATE                                       19360001
                 IF PV-REVERSAL                                         19370001
                    SET AU010-P39-ALREADY-REVERSED                      19380001
                        PV-ALREADY-REVERSED TO TRUE                     19390001
                 ELSE                                                   19400001
                   IF PV-SAFEWAY-RELOAD                                 19410001
122600                SET AU010-P39-GENERIC-DENIAL                      19420001
122700                    PV-SRC-GENERIC-DENIAL    TO TRUE              19430001
                   ELSE                                                 19440001
121500                SET AU010-P39-ALREADY-ACTIVE                      19450001
121600                    PV-SRC-ALREADY-ACTIVE TO TRUE                 19460001
                   END-IF                                               19470001
                 END-IF                                                 19480001
121700         ELSE                                                     19490001
121800           IF (PV-SRC-UNKNOWN-ACCOUNT) OR                         19500001
                   (SV005-CARD-ID-INVALID-ISSUE) OR                     19510001
                   (SV005-CARD-ID-INVALID-ADD-ON)                       19520001
121900             SET AU010-P39-UNKNOWN-ACCOUNT                        19530001
                       PV-SRC-GENERIC-DENIAL    TO TRUE                 19540001
122000           ELSE                                                   19550001
                   IF (SV005-TRAN-DLR-OVER-LIM-ADD-ON) OR               19560001
                        (SV005-CARD-BAL-OVER-LIM-ADD-ON)                19570001
                       SET AU010-P39-INVALID-AMT TO TRUE                19580001
                   ELSE                                                 19590001
                     IF (SV005-CARD-STAT-INV-ISSUE) OR                  19600001
                        (SV005-CARD-STAT-INV-ADD-ON)                    19610001
                         SET AU010-P39-INACTIVE-ACCOUNT TO TRUE         19620001
                     ELSE                                               19630001
122100                  SET AU010-P39-GENERIC-DENIAL                    19640001
122200                      PV-SRC-GENERIC-DENIAL TO TRUE               19650001
                     END-IF                                             19660001
                   END-IF                                               19670001
122300           END-IF                                                 19680001
122400         END-IF                                                   19690001
122500       WHEN OTHER                                                 19700001
122600         SET AU010-P39-GENERIC-DENIAL                             19710001
122700             PV-SRC-GENERIC-DENIAL    TO TRUE                     19720001
122800     END-EVALUATE.                                                19730001
137555                                                                  19740001
171200     MOVE AU010-P39-RESPONSE-CODE TO PV-SAFEWAY-RESP-CODE.        19750001
137555                                                                  19760001
137556** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               19770001
137557     MOVE 1 TO PV-RESPONSE-LEN.                                   19780001
137558     STRING AU010-ISO-HEADER-FIELDS,                              19790001
137559            AU010-SAFEWAY-RVSL-RSP-DATA,                          19800001
137560            AU010-SAFEWAY-RVSL-TRACK2-DATA (1:PV-TRACK2-LEN),     19810001
137561            AU010-ADDL-RESPONSE-DATA                              19820001
137562            DELIMITED BY SIZE                                     19830001
137563            INTO AURD004-RESPONSE-MESSAGE                         19840001
137564            WITH POINTER PV-RESPONSE-LEN                          19850001
137565     END-STRING.                                                  19860001
137566     SUBTRACT 1 FROM PV-RESPONSE-LEN.                             19870001
137567                                                                  19880001
137568** NOW YOU CAN CALCULATE THE HEX LENGTH OF THE RESPONSE.          19890001
137569     MOVE PV-RESPONSE-LEN TO PV-MSG-LEN-WOHDR.                    19900001
137570** FOR MESSAGE LENGTH WITH HEADER, ADD 2.                         19910001
137571     COMPUTE PV-MSG-LEN-WHDR = PV-MSG-LEN-WOHDR + 2.              19920001
137572** CONVERT MESSAGE LENGTH WITHOUT HEADER TO HEX AND INSERT        19930001
137573** INTO THE RESPONSE MESSAGE.                                     19940001
137574     MOVE PV-MSG-LEN-WOHDR TO PV-HEX-BINARY.                      19950001
137575                                                                  19960001
137576     MOVE PV-HEX-LENGTH TO AURD004-DATA-LEN-HEX.                  19970001
137577                                                                  19980001
137578** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          19990001
137579** HEADER.                                                        20000001
137580     MOVE PV-MSG-LEN-WHDR TO AURD004-TOT-REC-LENGTH.              20010001
137581                                                                  20020001
137582* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20030001
137583*    SET EP000-SL-INFORMATION TO  TRUE.                           20040001
137584*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      20050001
137585*                                                                 20060001
137586*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   20070001
137587*    MOVE 'IN 5300-0230-SAF-RESP'                                 20080001
137588*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              20090001
137589*                (EP000-MESSAGE-LINE-COUNTER).                    20100001
137590*    PERFORM EP000-1000-POST-MESSAGE.                             20110001
137591* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20120001
137592* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20130001
137593*    PERFORM VARYING PV-WS-CTR FROM 1 BY 89                       20140001
137594*             UNTIL PV-WS-CTR > 400                               20150001
137595*       SET EP000-SL-INFORMATION TO  TRUE                         20160001
137596*       MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER    20170001
137597*       MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                 20180001
137598*       MOVE AURD004-DATA-BUF (PV-WS-CTR:89) TO                   20190001
137599*         EP000-MD-SYSTEM-LOG-MESSAGE                             20200001
137600*              (EP000-MESSAGE-LINE-COUNTER)                       20210001
137601*       PERFORM EP000-1000-POST-MESSAGE                           20220001
137602*    END-PERFORM.                                                 20230001
137603* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20240001
137604                                                                  20250001
137605* SEND DATA TO LISTENER                                           20260001
137606     PERFORM 8000-SEND-DATA-TO-LISTENER.                          20270001
137607                                                                  20280001
137608*----------------------------------------------------------------*20290001
137610*  FORMAT-NETWORK-MGMT-RESP                                      *20300001
137700*  FORMAT THE NETWORK MANAGEMENT RESPONSE MESSAGE                *20310001
137800*----------------------------------------------------------------*20320001
137900 5500-FORMAT-NETWORK-MGMT-RESP.                                   20330001
138000     INITIALIZE AURD004-TOT-REC-LENGTH                            20340001
138100                AURD004-MATCHING-NBR-FIELD.                       20350001
138200     SET AU008-B24-RESP TO TRUE.                                  20360001
138300     SET AU008-IM-ISO-NET-MGMT-RESPONSE TO TRUE.                  20370001
138400     SET AU008-PRI-BIT-MAP-DEFAULT TO TRUE.                       20380001
138500     SET AU008-SEC-BIT-MAP-DEFAULT TO TRUE.                       20390001
138600     MOVE AU007-P7-TRANSMIT-DATE-TIME TO                          20400001
138700          AU008-P7-TRANSMIT-DATE-TIME.                            20410001
138800     MOVE AU007-P11-SYS-TRACE-AUDIT-NBR TO                        20420001
138900          AU008-P11-SYS-TRACE-AUDIT-NBR.                          20430001
139000     SET AU008-P39-RESPONSE-00 TO TRUE.                           20440001
139100     MOVE AU007-S70-NET-MGMT-CD TO AU008-S70-NET-MGMT-CD.         20450001
139200     MOVE 69 TO PV-MSG-LEN-WOHDR.                                 20460001
139300     COMPUTE PV-MSG-LEN-WHDR = PV-MSG-LEN-WOHDR + 2.              20470001
139400** CONVERT MESSAGE LENGTH WITHOUT HEADER TO HEX AND INSERT        20480001
139500** INTO THE RESPONSE MESSAGE.                                     20490001
139600     MOVE PV-MSG-LEN-WOHDR TO PV-HEX-BINARY.                      20500001
139700                                                                  20510001
139800     MOVE PV-HEX-LENGTH TO AU008-IH-HEADER-LENGTH.                20520001
139900                                                                  20530001
140000** THE TOTAL MESSAGE LENGTH TO BE SENT BACK INCLUDES THE          20540001
140100** HEADER.                                                        20550001
140200     MOVE PV-MSG-LEN-WHDR TO AURD004-TOT-REC-LENGTH.              20560001
140300*                                                                 20570001
    00* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20580001
082800*    SET EP000-SL-INFORMATION TO  TRUE.                           20590001
082900*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      20600001
083000*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   20610001
083100*    STRING 'IN 5500A-  ' AU008-SAFEWAY-NETWORK-RSP-MSG           20620001
140300*                         DELIMITED BY SIZE                       20630001
083200*                   INTO EP000-MD-SYSTEM-LOG-MESSAGE              20640001
083300*                (EP000-MESSAGE-LINE-COUNTER)                     20650001
083400*    END-STRING.                                                  20660001
083500*    PERFORM EP000-1000-POST-MESSAGE.                             20670001
   600* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20680001
                                                                        20690001
171200     MOVE AU008-P39-RESPONSE-CODE TO PV-SAFEWAY-RESP-CODE.        20700001
140400** FILL THE DATA BUFFER RESPONSE MESSAGE TO BE SENT               20710001
140500     MOVE AU008-SAFEWAY-NETWORK-RSP-MSG                           20720001
140600                                  TO AURD004-RESPONSE-MESSAGE.    20730001
140700*                                                                 20740001
0JEZ00* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20750001
082800*    SET EP000-SL-INFORMATION TO  TRUE.                           20760001
082900*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      20770001
083000*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   20780001
083100*    STRING 'IN 5500B-  ' AURD004-RESPONSE-MESSAGE                20790001
140700*                         DELIMITED BY SIZE                       20800001
083200*                   INTO EP000-MD-SYSTEM-LOG-MESSAGE              20810001
083300*                (EP000-MESSAGE-LINE-COUNTER)                     20820001
083400*    END-STRING.                                                  20830001
083500*    PERFORM EP000-1000-POST-MESSAGE.                             20840001
140700*                                                                 20850001
   700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20860001
140900*    SET EP000-SL-INFORMATION TO  TRUE.                           20870001
141000*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      20880001
141100*                                                                 20890001
141200*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   20900001
141300*    MOVE 'IN 5500-FORMAT-NETWORK-MGMT-RESP'                      20910001
141400*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              20920001
141500*                (EP000-MESSAGE-LINE-COUNTER).                    20930001
141600*    PERFORM EP000-1000-POST-MESSAGE.                             20940001
141700* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       20950001
141800* **** DISPLAY MESSAGE IN EPCL (for testing purposes)             20960001
141900*    SET EP000-SL-INFORMATION TO  TRUE.                           20970001
142000*    MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      20980001
142100*    MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   20990001
142200*    MOVE AURD004-DATA-BUF                                        21000001
142300*                     TO EP000-MD-SYSTEM-LOG-MESSAGE              21010001
142400*                (EP000-MESSAGE-LINE-COUNTER).                    21020001
142500*    PERFORM EP000-1000-POST-MESSAGE.                             21030001
    00* **** DISPLAY MESSAGE FOR TESTING PURPOSES                       21040001
142700                                                                  21050001
142800* SEND DATA TO LISTENER                                           21060001
142900     PERFORM 8000-SEND-DATA-TO-LISTENER.                          21070001
143000                                                                  21080001
143361*----------------------------------------------------------------*21090001
143370* RETRIEVE AUTH REQUEST                                          *21100001
143400*  RETRIEVE THE AUTHORIZATION REQUEST FROM THE LISTENER.         *21110001
143500*   ERROR CHECKING:                                              *21120001
143600*  IF A CONDITION OTHER THAN END-OF-DATA (RECEIVED DATA WAS LESS *21130001
143700*  THAN EXPLICITYLY STATED LENGTH, WHICH IS NORMAL), AN ERROR    *21140001
143800*  WILL BE POSTED, AND THE TRANSACTION WILL BE TERMINATED,       *21150001
143900*  WITHOUT A RESPONSE TO THE ISP.  BECAUSE THERE IS NO RESPONSE, *21160001
144000*  FLOOR LIMITS WILL THEN BE USED BY THE ISP, AFTER THE REQUEST  *21170001
144100*  TIMES OUT.                                                    *21180001
144200*----------------------------------------------------------------*21190001
144300 7000-RETRIEVE-AUTH-REQUEST.                                      21200001
144400                                                                  21210001
144500     EXEC CICS                                                    21220001
144600         RETRIEVE                                                 21230001
144700             INTO    (AURD003-GC-AUTH-REQ-RECORD)                 21240001
144800             LENGTH  (PC-COMMUNICATIONS-IN-LENGTH)                21250001
144900             RESP    (PV-CICS-RESPONSE)                           21260001
145000     END-EXEC.                                                    21270001
145100                                                                  21280001
145200     EVALUATE TRUE                                                21290001
145300         WHEN ((PV-CICS-RESPONSE NOT = DFHRESP(NORMAL))           21300001
145400                      AND (PV-CICS-RESPONSE NOT = DFHRESP(EOC)))  21310001
145500             SET EP000-SL-ERROR TO TRUE                           21320001
145600             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       21330001
145700             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            21340001
145800             STRING 'ERROR RETRIEVING RESPONSE MESSAGE '          21350001
145900                                         DELIMITED BY SIZE        21360001
146000                ' - CICS RESPONSE = '    DELIMITED BY SIZE        21370001
146100                PV-CICS-RESPONSE-DISP    DELIMITED BY SIZE        21380001
146200                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                21390001
146300                           (EP000-MESSAGE-LINE-COUNTER)           21400001
146400             PERFORM EP000-1000-POST-MESSAGE                      21410001
146500             PERFORM 9999-RETURN-TO-NATIVE-CICS                   21420001
146600     END-EVALUATE.                                                21430001
146700     MOVE AURD003-LISTENER-CODE TO AUWS002-QUEUE-PARM.            21440001
146800                                                                  21450001
146900* CHECK FOR VALID PARM, AND FILL IN TSQ NAME.                     21460001
147000     IF  AUWS002-VALID-PARM                                       21470001
147100         MOVE AUWS002-QUEUE-NAME(AUWS002-QUEUE-PARM-N)            21480001
147200                TO PV-TSQ-NAME                                    21490001
147400     ELSE                                                         21500001
147500             SET EP000-SL-ERROR TO TRUE                           21510001
147600             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            21520001
147700             STRING '7000-RETRIEVE-AUTH-REQUEST '                 21530001
147800                                         DELIMITED BY SIZE        21540001
147900                'INVALID PARM VALUE= '   DELIMITED BY SIZE        21550001
148000                AURD003-LISTENER-CODE      DELIMITED BY SIZE      21560001
148100                 INTO  EP000-MD-SYSTEM-LOG-MESSAGE                21570001
148200                           (EP000-MESSAGE-LINE-COUNTER)           21580001
148300             PERFORM EP000-1000-POST-MESSAGE                      21590001
148400             PERFORM 9999-RETURN-TO-NATIVE-CICS                   21600001
148500     END-IF.                                                      21610001
148600                                                                  21620001
148800*----------------------------------------------------------------*21630001
148900* SEND DATA TO LISTENER.                                         *21640001
149000* PUT THE RESPONSE ON THE TEMP STORAGE QUEUE TO BE READ BY       *21650001
149100* BY THE LISTENER PROGRAM.                                       *21660001
149200*  QUEUE FORMAT:                                                 *21670001
149300*  LINE 1: # OF NEXT RECORD TO BE WRITTEN TO THE QUEUE BY THE    *21680001
149400*          CHILD PROGRAM, FOLLOWED BY THE TOTAL NUMBER OF        *21690001
149500*          POSSIBLE ENTRIES IN THE QUEUE (100)                   *21700001
149600*  LINE 2: # OF NEXT RECORD TO BE READ BY LISTENER FOLLOWED BY   *21710001
149700*          TOTAL NUMBER OF POSSIBLE ENTRIES IN THE QUEUE (100)   *21720001
149800*          (ONLY USED BY LISTENER)                               *21730001
149900*  LINES 3 TO 100: RESPONSES FROM CHILD PROGRAMS IN FORMAT       *21740001
150000*                  TCP-BUF-OUT                                   *21750001
150100*----------------------------------------------------------------*21760001
150200 8000-SEND-DATA-TO-LISTENER.                                      21770001
150300     PERFORM 8110-ENQ-TCPIPPRQ.                                   21780001
150400     PERFORM 8120-READQ-TCPIPPRQ-RECORD1.                         21790001
150500                                                                  21800001
150600     PERFORM 8140-REWRITE-TCPIPPRQ-NEXT-REC.                      21810001
150700     ADD 1 TO PV-NEXT-RECORD.                                     21820001
150800                                                                  21830001
150900     IF PV-NEXT-RECORD > PV-TOTAL-RECORDS                         21840001
151000         MOVE 3 TO PV-NEXT-RECORD                                 21850001
151100     END-IF.                                                      21860001
151200                                                                  21870001
151300     PERFORM 8150-REWRITE-TCPIPPRQ-RECORD1.                       21880001
151400     PERFORM 8160-DEQ-TCPIPPRQ.                                   21890001
151500                                                                  21900001
151600*----------------------------------------------------------------*21910001
151700 8110-ENQ-TCPIPPRQ.                                               21920001
151800     EXEC CICS                                                    21930001
151900         ENQ                                                      21940001
152000             RESOURCE  (PV-TSQ-NAME)                              21950001
152100             RESP      (PV-CICS-RESPONSE)                         21960001
152200     END-EXEC.                                                    21970001
152300                                                                  21980001
152400     EVALUATE TRUE                                                21990001
152500         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 22000001
152600             CONTINUE                                             22010001
152700         WHEN OTHER                                               22020001
152800             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            22030001
152900             SET EP000-SL-ERROR TO TRUE                           22040001
153000             STRING '8110-ENQ-TCPIPPRQ'                           22050001
153100                    ' ERROR ON ENQ TEMP STORAGE QUEUE: '          22060001
153200                     PV-TSQ-NAME                                  22070001
153300                     ' RESP:'                                     22080001
153400                     PV-CICS-RESPONSE-DISP                        22090001
153500                       DELIMITED BY SIZE                          22100001
153600                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           22110001
153700                                (EP000-MESSAGE-LINE-COUNTER)      22120001
153800             END-STRING                                           22130001
153900             PERFORM EP000-1000-POST-MESSAGE                      22140001
154000             PERFORM 9999-RETURN-TO-NATIVE-CICS                   22150001
154100     END-EVALUATE.                                                22160001
154200                                                                  22170001
154300*----------------------------------------------------------------*22180001
154400 8120-READQ-TCPIPPRQ-RECORD1.                                     22190001
154500     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         22200001
154600                                                                  22210001
154700     EXEC CICS                                                    22220001
154800         READQ TS                                                 22230001
154900             QUEUE   (PV-TSQ-NAME)                                22240001
155000             INTO    (PV-TCPIPPRQ-RECORD1)                        22250001
155100             LENGTH  (PV-TSQ-LENGTH)                              22260001
155200             ITEM    (1)                                          22270001
155300             RESP    (PV-CICS-RESPONSE)                           22280001
155400     END-EXEC.                                                    22290001
155500                                                                  22300001
155600     EVALUATE TRUE                                                22310001
155700         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 22320001
155800             CONTINUE                                             22330001
155900         WHEN OTHER                                               22340001
156000             SET EP000-SL-ERROR         TO TRUE                   22350001
156100             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       22360001
156200             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            22370001
156300             STRING '8120-READQ-TCPIPPRQ-RECORD1'                 22380001
156400                    ' ERROR ON READ TEMP STORAGE QUEUE: '         22390001
156500                     PV-TSQ-NAME                                  22400001
156600                     ' RESP:'                                     22410001
156700                     PV-CICS-RESPONSE-DISP                        22420001
156800                       DELIMITED BY SIZE                          22430001
156900                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           22440001
157000                                (EP000-MESSAGE-LINE-COUNTER)      22450001
157100             END-STRING                                           22460001
157200             PERFORM EP000-1000-POST-MESSAGE                      22470001
157300             PERFORM 9999-RETURN-TO-NATIVE-CICS                   22480001
157400     END-EVALUATE.                                                22490001
157500                                                                  22500001
157600*----------------------------------------------------------------*22510001
157700 8140-REWRITE-TCPIPPRQ-NEXT-REC.                                  22520001
157800                                                                  22530001
157900     INITIALIZE   PV-TSQ-DATA-RECORD.                             22540001
158000     MOVE +4120                      TO  PV-TSQ-LENGTH.           22550001
158100     MOVE AURD003-MATCHING-NBR-FIELD                              22560001
158200                                  TO AURD004-MATCHING-NBR-FIELD.  22570001
158300     MOVE AURD004-GC-RESP-TSQ-RECORD   TO  PV-TSQ-DATA-PORTION.   22580001
158400     MOVE PV-NEXT-RECORD             TO  PV-ITEM-NBR.             22590001
158500                                                                  22600001
158600     EXEC CICS                                                    22610001
158700         WRITEQ TS                                                22620001
158800             QUEUE   (PV-TSQ-NAME)                                22630001
158900             FROM    (PV-TSQ-DATA-RECORD)                         22640001
159000             LENGTH  (PV-TSQ-LENGTH)                              22650001
159100             ITEM    (PV-ITEM-NBR)                                22660001
159200                 REWRITE                                          22670001
159300             RESP    (PV-CICS-RESPONSE)                           22680001
159400     END-EXEC.                                                    22690001
159500                                                                  22700001
159600     EVALUATE TRUE                                                22710001
159700         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 22720001
159800             CONTINUE                                             22730001
159900         WHEN OTHER                                               22740001
160000             SET EP000-SL-ERROR         TO TRUE                   22750001
160100             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       22760001
160200             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            22770001
160300             STRING '8140-REWRITE-TCPIPPRQ-NEXT-REC'              22780001
160400                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      22790001
160500                     PV-TSQ-NAME                                  22800001
160600                     ' RESP:'                                     22810001
160700                     PV-CICS-RESPONSE-DISP                        22820001
160800                       DELIMITED BY SIZE                          22830001
160900                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           22840001
161000                                (EP000-MESSAGE-LINE-COUNTER)      22850001
161100             END-STRING                                           22860001
161200             PERFORM EP000-1000-POST-MESSAGE                      22870001
161300             PERFORM 9999-RETURN-TO-NATIVE-CICS                   22880001
161400     END-EVALUATE.                                                22890001
161500                                                                  22900001
161600*----------------------------------------------------------------*22910001
161700 8150-REWRITE-TCPIPPRQ-RECORD1.                                   22920001
161800     MOVE LENGTH OF PV-TCPIPPRQ-RECORD1 TO PV-TSQ-LENGTH.         22930001
161900     MOVE +1 TO PV-ITEM-NBR.                                      22940001
162000                                                                  22950001
162100     EXEC CICS                                                    22960001
162200         WRITEQ TS                                                22970001
162300             QUEUE   (PV-TSQ-NAME)                                22980001
162400             FROM    (PV-TCPIPPRQ-RECORD1)                        22990001
162500             LENGTH  (PV-TSQ-LENGTH)                              23000001
162600             ITEM    (PV-ITEM-NBR)                                23010001
162700                 REWRITE                                          23020001
162800             RESP    (PV-CICS-RESPONSE)                           23030001
162900     END-EXEC.                                                    23040001
163000                                                                  23050001
163100     EVALUATE TRUE                                                23060001
163200         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 23070001
163300             CONTINUE                                             23080001
163400         WHEN OTHER                                               23090001
163500             SET EP000-SL-ERROR         TO TRUE                   23100001
163600             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       23110001
163700             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            23120001
163800             STRING '8140-REWRITE-TCPIPPRQ-RECORD1'               23130001
163900                    ' ERROR WRITING TO TEMP STORAGE QUEUE: '      23140001
164000                     PV-TSQ-NAME                                  23150001
164100                     ' RESP:'                                     23160001
164200                     PV-CICS-RESPONSE-DISP                        23170001
164300                       DELIMITED BY SIZE                          23180001
164400                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           23190001
164500                                (EP000-MESSAGE-LINE-COUNTER)      23200001
164600             END-STRING                                           23210001
164700             PERFORM EP000-1000-POST-MESSAGE                      23220001
164800             PERFORM 9999-RETURN-TO-NATIVE-CICS                   23230001
164900     END-EVALUATE.                                                23240001
165000                                                                  23250001
165100*----------------------------------------------------------------*23260001
165200 8160-DEQ-TCPIPPRQ.                                               23270001
165300     EXEC CICS                                                    23280001
165400         DEQ                                                      23290001
165500             RESOURCE  (PV-TSQ-NAME)                              23300001
165600             RESP      (PV-CICS-RESPONSE)                         23310001
165700     END-EXEC.                                                    23320001
165800                                                                  23330001
165900     EVALUATE TRUE                                                23340001
166000         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 23350001
166100             CONTINUE                                             23360001
166200         WHEN OTHER                                               23370001
166300             SET EP000-SL-ERROR         TO TRUE                   23380001
166400             MOVE PV-CICS-RESPONSE TO PV-CICS-RESPONSE-DISP       23390001
166500             MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER            23400001
166600             STRING '8160-DEQ-TCPIPPRQ'                           23410001
166700                    ' ERROR ON DEQ TEMP STORAGE QUEUE: '          23420001
166800                     PV-TSQ-NAME                                  23430001
166900                     ' RESP:'                                     23440001
167000                     PV-CICS-RESPONSE-DISP                        23450001
167100                       DELIMITED BY SIZE                          23460001
167200                       INTO EP000-MD-SYSTEM-LOG-MESSAGE           23470001
167300                                (EP000-MESSAGE-LINE-COUNTER)      23480001
167400             END-STRING                                           23490001
167500             PERFORM EP000-1000-POST-MESSAGE                      23500001
167600             PERFORM 9999-RETURN-TO-NATIVE-CICS                   23510001
167700     END-EVALUATE.                                                23520001
167900                                                                  23530001
168000*----------------------------------------------------------------*23540001
168100* MESSAGE MONITORING                                             *23550001
168200* DISPLAY A MESSAGE TO THE EPCL LOG                              *23560001
168300*----------------------------------------------------------------*23570001
168400 8500-MESSAGE-MONITORING.                                         23580001
168500                                                                  23590001
168600     SET EP000-SL-INFORMATION TO  TRUE.                           23600001
168700     MOVE LM-MESSAGE-NUMBER  TO  EP000-SL-PI-MESSAGE-NUMBER.      23610001
168800                                                                  23620001
168900     IF AURD003-MID-0200 OR AURD003-MID-0220                      23630001
169000       SET LM-DM-ISSUE       TO TRUE                              23640001
169100     ELSE                                                         23650001
169200       IF AURD003-MID-0800                                        23660001
169300         SET LM-DM-NETWORK   TO TRUE                              23670001
169400       ELSE                                                       23680001
169410         IF AURD003-MID-0420                                      23690001
169420           SET LM-DM-REVERSAL  TO TRUE                            23700001
169430         ELSE                                                     23710001
169500           SET LM-DM-UNKNOWN   TO TRUE                            23720001
169600         END-IF                                                   23730001
169610       END-IF                                                     23740001
169700     END-IF.                                                      23750001
169800     SET LM-DM-REQUEST-MSG TO TRUE.                               23760001
169900     IF SV005-CARD-TYPE NOT = ZERO                                23770001
170000       EVALUATE TRUE                                              23780001
170100         WHEN SV005-KMRC-CRD                                      23790001
170200           SET LM-DM-KMRC-MSG TO  TRUE                            23800001
170300         WHEN SV005-GIFT-CRD                                      23810001
170400           SET LM-DM-GC-MSG TO  TRUE                              23820001
170500       END-EVALUATE                                               23830001
170600     END-IF.                                                      23840001
170700                                                                  23850001
170800     MOVE ZERO TO LM-DM-APPROVE-AMOUNT.                           23860001
170900     MOVE ZERO TO LM-DM-BALANCE.                                  23870001
171000     IF LM-DM-RSP                                                 23880001
171100       SET LM-DM-RC-DISPLAY TO TRUE                               23890001
171200       MOVE PV-SAFEWAY-RESP-CODE    TO  LM-DM-RESP-CD             23900001
171300       MOVE SV005-APPROVED-TENDER-AMT TO LM-DM-APPROVE-AMOUNT     23910001
171400       MOVE SV005-KMC-REMAINING-BALANCE TO LM-DM-BALANCE          23920001
171500     END-IF.                                                      23930001
171600     MOVE SV005-STORE-NBR        TO  LM-DM-STORE-NBR.             23940001
171700     MOVE SV005-TERMINAL-NBR     TO  LM-DM-TERM-NBR.              23950001
171800     MOVE SV005-TRANSACTION-NBR  TO  LM-DM-TRAN-NBR.              23960001
171900     MOVE PV-KMC-AMT             TO  LM-DM-TRAN-AMOUNT.           23970001
172000                                                                  23980001
172100     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER.                   23990001
172200     MOVE LM-LOG-DISPLAY-MESSAGE                                  24000001
172300         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24010001
172400                 (EP000-MESSAGE-LINE-COUNTER).                    24020001
172500     PERFORM EP000-1000-POST-MESSAGE.                             24030001
172600                                                                  24040001
172700*----------------------------------------------------------------*24050001
172800*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 ERROR.  ROLL    *24060001
172900*  BACK ALL RESOURCES.                                           *24070001
173000*----------------------------------------------------------------*24080001
173200 9100-DB2-ERROR.                                                  24090001
173300     SET PS-DB2-ERROR                                             24100001
173400         EP000-SL-ERROR TO TRUE.                                  24110001
173500                                                                  24120001
173600     MOVE SQLCODE TO DE-SQLCODE.                                  24130001
173700     MOVE SQLERRD(3) TO DE-ROWS-PROCESSED.                        24140001
173800     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    24150001
173900     MOVE DE-DB2-ERROR-MESSAGE                                    24160001
174000         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24170001
174100                 (EP000-MESSAGE-LINE-COUNTER).                    24180001
174200                                                                  24190001
174300     MOVE SQLERRMC TO DS-SQLERRMC.                                24200001
174400     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     24210001
174500     MOVE DS-DB2-SQLERRMC-MESSAGE                                 24220001
174600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24230001
174700                 (EP000-MESSAGE-LINE-COUNTER).                    24240001
174800                                                                  24250001
174900     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     24260001
175000     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             24270001
175100         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24280001
175200                 (EP000-MESSAGE-LINE-COUNTER).                    24290001
175300                                                                  24300001
175400     PERFORM EP000-1000-POST-MESSAGE.                             24310001
175500                                                                  24320001
175600     EXEC CICS                                                    24330001
175700         SYNCPOINT                                                24340001
175800             ROLLBACK                                             24350001
175900     END-EXEC.                                                    24360001
176100                                                                  24370001
176200*----------------------------------------------------------------*24380001
176300*  FORMAT AND POST INFORMATION RELATIVE TO A DB2 WARNING.  ROLL  *24390001
176400*  BACK ALL RESOURCES.                                           *24400001
176500*----------------------------------------------------------------*24410001
176700 9200-DB2-WARNING.                                                24420001
176800     SET PS-DB2-ERROR                                             24430001
176900         EP000-SL-ERROR TO TRUE.                                  24440001
177000                                                                  24450001
177100     MOVE SQLCODE TO DW-SQLCODE.                                  24460001
177200     MOVE SQLERRD(3) TO DW-ROWS-PROCESSED.                        24470001
177300     MOVE SQLWARN TO DW-SQLWARN.                                  24480001
177400     MOVE PC-ONE TO EP000-MESSAGE-LINE-COUNTER                    24490001
177500     MOVE DW-DB2-WARNING-MESSAGE                                  24500001
177600         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24510001
177700                 (EP000-MESSAGE-LINE-COUNTER)                     24520001
177800                                                                  24530001
177900     MOVE SQLERRMC TO DS-SQLERRMC.                                24540001
178000     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     24550001
178100     MOVE DS-DB2-SQLERRMC-MESSAGE                                 24560001
178200         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24570001
178300                 (EP000-MESSAGE-LINE-COUNTER)                     24580001
178400                                                                  24590001
178500     ADD PC-ONE TO EP000-MESSAGE-LINE-COUNTER                     24600001
178600     MOVE AA-ATTEMPTED-ACTION-MESSAGE                             24610001
178700         TO  EP000-MD-SYSTEM-LOG-MESSAGE                          24620001
178800                 (EP000-MESSAGE-LINE-COUNTER)                     24630001
178900                                                                  24640001
179000     PERFORM EP000-1000-POST-MESSAGE.                             24650001
179100                                                                  24660001
179200     EXEC CICS                                                    24670001
179300         SYNCPOINT                                                24680001
179400             ROLLBACK                                             24690001
179500     END-EXEC.                                                    24700001
179700                                                                  24710001
179800*----------------------------------------------------------------*24720001
179900*  TERMINATE THE TRANSACTION.                                    *24730001
180000*----------------------------------------------------------------*24740001
180200 9999-RETURN-TO-NATIVE-CICS.                                      24750001
180300     EXEC CICS                                                    24760001
180400         RETURN                                                   24770001
180500     END-EXEC.                                                    24780001
180700                                                                  24790001
180800*----------------------------------------------------------------*24800001
180900     COPY SVPD005.                                                24810001
181000                                                                  24820001
181100*----------------------------------------------------------------*24830001
181200*    CONVERSION OF CARD NUMBER                                   *24840001
181300*----------------------------------------------------------------*24850001
181400     COPY SVPD007.                                                24860001
181500                                                                  24870001
181600*----------------------------------------------------------------*24880001
181700*  POST ALERT/ERROR ROUTINE.                                      24890001
181710*----------------------------------------------------------------*24900001
181900     COPY EPPD000.                                                24910001
181910                                                                  24920001
