       IDENTIFICATION DIVISION.                                         00010094
       PROGRAM-ID.           DAKUP003.                                  00020094
       AUTHOR.               V. LEE YANG                                00030094
       INSTALLATION.         KOHLS DEPARTMENT STORES.                   00040094
       DATE-WRITTEN          04/29/2006.                                00050094
       DATE-COMPILED.                                                   00060094
                                                                        00070094
      ******************************************************************00080094
      *   DAKUP003 - AVAILABLE VENDOR FUNDING COST UPDATE              *00090094
      *                                                                *00100094
      *   THIS PROGRAM SEQUENTIALLY READS AN INPUT FILE (MLRD015)      *00110094
      *   AND UPDATE DA'S AVAILABLE VENDOR FUNDING (DAT_AVL_VND_FUND)  *00120094
      *   TABLE.  IT WILL SUBTRACT THE ML015-PURCH-NET AMOUNT FROM     *00130094
      *   THE TABLE'S COLUMNS, BECAUSE THE INPUT FIELD FROM MLRD015    *00140094
      *   WILL BE NEGATIVE FOR THESE TYPE OF TRANSACTIONS.             *00150094
      *                                                                *00160094
      *   IF A TRANSACTION COMING IN CAUSES THE TOTAL AVAILABLE OR     *00170094
      *   REMAINING AVAILABLE COST FIELDS TO BE NEGATIVE (BELOW ZERO), *00180094
      *   THE TRANSACTION WILL BE IGNORED/DROPPED AND A RETURN CODE    *00190094
      *   WILL BE SET FOR THE JOB TO RESPONSE.                         *00200094
      *                                                                *00210094
      ******************** HISTORY OF CHANGES **************************00220094
      * CHG ID/                                                        *00230094
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00240094
      * -------  ----------  ----------------------------------------  *00250094
W30975* WR30975  2006-07-03  ADD OUTPUT FILE TO CAPTURE REJECTED       *00260094
      *                      TRANSACTION.  -V.L. YANG                  *00270094
W30812* WR30812  2006-07-31  CHANGE UPDATE OF TTL-AVL-COST-AMT AND     *00280094
W30812*                      RMNG-AVL-COST-AMT BASED ON VALUE OF       *00290094
W30812*                      ML015-PURCH-TRANS-CDE FIELD. -R KELLEN    *00300094
RK0806* WR30812  2006-08-22  CHANGE SELECT AND UPDATE SQL TO QUALIFY   *00310094
RK0806*                      ROW TO USE ROW WITH THE LATEST END_EFF_DTE*00320094
RK0806*                      INSTEAD OF ROW WITH A BEG_EFF_DTE IN THE  *00330094
RK0806*                      CURRENT PERIOD.-R KELLEN                  *00340094
RK0824* WR30812  2006-08-24  CHANGE LOGIC TO USE ALL ROWS WITH MATCHING*00350094
RK0824*                      END_ID/DEPT IN DESC EFF DATE SEQUENCE     *00360094
RK0824*                      WHEN PROCESSING TRANSACTIONS THAT WILL    *00370094
RK0824*                      DECREMENT THE RMNG_AVL_COST_AMT AND       *00380094
RK0824*                      TTL_AVL_COST_AMT AMTS. WHEN INCREASING    *00390094
RK0824*                      THESE AMTS, THE MOST CURRENT END_EFF-DTE  *00400094
RK0824*                      ROW IS ADJUSTED. AS BEFORE A DECREMENT    *00410094
RK0824*                      THAT RESULTS IN A NEGATIVE VALUE AMONG ALL*00420094
RK0824*                      MATCHING ROWS WILL BE ERRORED OUT AND     *00430094
RK0824*                      REJECTED. -R KELLEN                       *00440094
955568* P955568  2006-11-30  UTILIZE EFF_BEG_DTE IN CURSOR AND LOGIC.   00450094
955568*                      EMPTY OLDEST BUCKETS FIRST/ADD DOLLARS TO  00460094
955568*                      CURRENT QTR (OR INSERT ROW IF NONE EXISTS).00470094
955568*                      ONCE QTR IS CLOSED-NO FURTHER ADDS TO QTR  00480094
955568*                                -S JACKSON                      *00490094
955568* I693362  2009-03-11  ADDED CODE TO PREVENT COMMIT FROM          00500094
955568*                      OCCURRING IN THE MIDDLE OF PROCESSING      00510094
955568*                      DEBIT_ALLWNC                               00520094
955568*                                -R STAUFFACHER                  *00530094
PK5621* PKE5621 2010-01-11   CREATED A NEW REPORT FILE TO WRITE THE    *00540094
PK5621*                      NEGATIVE BALANCE RECORDS INTO REPORT FILE *00550094
PK5621*                                -SAI PRIYADHARSHINI             *00560094
P52134* PB52134 2015-03-20   INCLUDED PARA TO GET VENDOR NAME ALONG    *00570094
P52134*                      WITH OURPUT FILE                           00580099
8613F *8613F   07-17-2015    RMS 9 REMEDIATION. CHANGED FROM            00581099
      *                      AUTO LOGON TO EXTERNAL SIGN ON             00582099
      *                                -S  BARTELT                      00583099
P58235* P58235 03-02-2016    TO HANDLE BLANK VENDOR NAME IN THE         00584099
      *                      NEGATIVE FUNDING REPORT.USED XMT_VND       00585099
      *                      TO FETCH THE VENDOR NAME                   00586099
      ******************************************************************00590094
                                                                        00600094
                                                                        00610094
       ENVIRONMENT DIVISION.                                            00620094
                                                                        00630094
       CONFIGURATION SECTION.                                           00640094
                                                                        00650094
       SOURCE-COMPUTER. IBM-3090.                                       00660094
       OBJECT-COMPUTER. IBM-3090.                                       00670094
                                                                        00680094
       INPUT-OUTPUT SECTION.                                            00690094
       FILE-CONTROL.                                                    00700094
           SELECT CONTROL-CARD-FILE                                     00710094
               ASSIGN TO INP01.                                         00720094
                                                                        00730094
           SELECT PURCHASE-ADJ-FILE                                     00740094
               ASSIGN TO INP02.                                         00750094
                                                                        00760094
8613F      SELECT ORACLE-LOGIN-FILE                                     00761099
8613F          ASSIGN TO ORALOGON.                                      00761199
                                                                        00762097
W30975     SELECT REJECTED-ADJ-FILE                                     00770094
W30975         ASSIGN TO OUT01.                                         00780094
                                                                        00790094
PK5621     SELECT NEGATIVE-BAL-REPORT                                   00800094
PK5621         ASSIGN TO RPT01.                                         00810094
                                                                        00820094
       DATA DIVISION.                                                   00830094
                                                                        00840094
       FILE SECTION.                                                    00850094
       FD  CONTROL-CARD-FILE                                            00860094
           RECORDING MODE IS F                                          00870094
           LABEL RECORDS ARE STANDARD                                   00880094
           BLOCK CONTAINS 0 RECORDS.                                    00890094
       01  CONTROL-CARD-RECORD             PIC X(80).                   00900094
                                                                        00910094
       FD  PURCHASE-ADJ-FILE                                            00920094
           LABEL RECORDS ARE STANDARD                                   00930094
           RECORDING MODE IS F                                          00940094
           BLOCK CONTAINS 0 RECORDS.                                    00950094
       01  PURCHASE-ADJ-RECORD             PIC X(150).                  00960094
                                                                        00970094
8613F  FD  ORACLE-LOGIN-FILE                                            00970199
8613F      RECORDING MODE IS F                                          00970299
8613F      LABEL RECORDS ARE STANDARD                                   00970399
8613F      BLOCK CONTAINS 0 RECORDS                                     00970499
8613F      DATA RECORD IS ORACLE-LOGIN-REC.                             00970599
8613F  01  ORACLE-LOGIN-REC.                                            00970699
8613F      05  FILLER                  PIC X(80).                       00970799
                                                                        00971097
W30975 FD  REJECTED-ADJ-FILE                                            00980094
W30975     LABEL RECORDS ARE STANDARD                                   00990094
W30975     RECORDING MODE IS F                                          01000094
W30975     BLOCK CONTAINS 0 RECORDS.                                    01010094
W30975 01  REJECTED-ADJ-RECORD             PIC X(150).                  01020094
                                                                        01030094
PK5621 FD  NEGATIVE-BAL-REPORT                                          01040094
PK5621     LABEL RECORDS ARE STANDARD                                   01050094
PK5621     RECORDING MODE IS F                                          01060094
PK5621     BLOCK CONTAINS 0 RECORDS.                                    01070094
P52134 01  NEGATIVE-BAL-REC                PIC X(200).                  01080094
                                                                        01090094
       WORKING-STORAGE SECTION.                                         01100094
                                                                        01110094
      ***************************************************************** 01120094
      *  INPUT PURCHASE ADJUSTMENT EXTRACT LAYOUT                     * 01130094
      ***************************************************************** 01140094
      *01  ML015-PURCHASE-RECORD.                                       01150094
           COPY MLRD015.                                                01160094
                                                                        01170094
PK5621 01 RPT-FILE-HD1.                                                 01180094
P52134    05 FILLER                      PIC X(200) VALUE SPACES.       01190094
PK5621 01 RPT-FILE-HD2.                                                 01200094
PK5621     05 FILLER                      PIC X(30) VALUE               01210094
PK5621                            '*** NEGATIVE BALANCE FOUND ***'.     01220094
PK5621 01 RPT-FILE-HD3.                                                 01230094
P52134     05 FILLER                      PIC X(200) VALUE SPACES.      01240094
PK5621 01 RPT-FILE-HD4.                                                 01250094
PK5621     05 FILLER                      PIC X(4)  VALUE 'DEPT'.       01260094
PK5621     05 FILLER                      PIC X(1)  VALUE SPACES.       01270094
PK5621     05 FILLER                      PIC X(5)  VALUE 'CLASS'.      01280094
PK5621     05 FILLER                      PIC X(5)  VALUE SPACES.       01290094
PK5621     05 FILLER                      PIC X(6)  VALUE 'ENT-ID'.     01300094
PK5621     05 FILLER                      PIC X(4)  VALUE SPACES.       01310094
PK5621     05 FILLER                      PIC X(14) VALUE               01320094
PK5621                                    'PURCH ADJ COST'.             01330094
PK5621     05 FILLER                      PIC X(6)  VALUE SPACES.       01340094
PK5621     05 FILLER                      PIC X(15) VALUE               01350094
PK5621                                    'TOTAL AVAILABLE'.            01360094
PK5621     05 FILLER                      PIC X(8)  VALUE SPACES.       01370094
PK5621     05 FILLER                      PIC X(13) VALUE               01380094
PK5621                                    'REMAINING BAL'.              01390094
PK5621     05 FILLER                      PIC X(1)  VALUE SPACES.       01400094
PK5621     05 FILLER                      PIC X(8)  VALUE 'FUNCTION'.   01410094
P52134     05 FILLER                      PIC X(11)  VALUE SPACES.      01420094
P52134     05 FILLER                      PIC X(11) VALUE               01430094
P52134                                    'VENDOR NAME'.                01440094
P52134     05 FILLER                      PIC X(1)  VALUE SPACES.       01450094
PK5621 01 RPT-FILE-HD5.                                                 01460094
PK5621     05 FILLER                      PIC X(4)  VALUE '----'.       01470094
PK5621     05 FILLER                      PIC X(1)  VALUE SPACES.       01480094
PK5621     05 FILLER                      PIC X(5)  VALUE '-----'.      01490094
PK5621     05 FILLER                      PIC X(1)  VALUE SPACES.       01500094
PK5621     05 FILLER                      PIC X(10) VALUE '---------'.  01510094
PK5621     05 FILLER                      PIC X(2)  VALUE SPACES.       01520094
PK5621     05 FILLER                      PIC X(16) VALUE               01530094
PK5621                                    '----------------'.           01540094
PK5621     05 FILLER                      PIC X(2)  VALUE SPACES.       01550094
PK5621     05 FILLER                      PIC X(19) VALUE               01560094
PK5621                                    '-------------------'.        01570094
PK5621     05 FILLER                      PIC X(2)  VALUE SPACES.       01580094
PK5621     05 FILLER                      PIC X(19) VALUE               01590094
PK5621                                    '-------------------'.        01600094
PK5621     05 FILLER                      PIC X(1)  VALUE SPACES.       01610094
P52134     05 FILLER                      PIC X(18)  VALUE              01620094
P52134                                    '------------------'.         01630094
P52134     05 FILLER                      PIC X(1)  VALUE SPACES.       01640094
P52134     05 FILLER                      PIC X(20)  VALUE              01650094
P52134                                    '--------------------'.       01660094
PK5621 01 RPT-DTL-LINE.                                                 01670094
PK5621     05 FILLER                      PIC X(200) VALUE SPACES.      01680094
       01 NEGATIVE-BAL-LAYOUT.                                          01690094
PK5621     05  DEPT-NBR-NEG               PIC 9(04)       VALUE ZEROES. 01700094
PK5621     05  FILLER                     PIC X(02)       VALUE SPACES. 01710094
PKPK21     05  SUB-CL-NBR-NEG             PIC 9(04)       VALUE ZEROES. 01720094
PK5621     05  FILLER                     PIC X(02)       VALUE SPACES. 01730094
PK5621     05  ENT-ID-NEG                 PIC 9(09)       VALUE ZEROES. 01740094
PK5621     05  FILLER                     PIC X(02)       VALUE SPACES. 01750094
PK5621     05  PV-PURCH-NET-NEG           PIC $ZZZ,ZZZ,ZZ9.99-.         01760094
PK5621     05  FILLER                     PIC X(02)       VALUE SPACES. 01770094
PK5621     05  PV-TTL-AVL-COST-AMT-NEG    PIC $ZZ,ZZZ,ZZZ,ZZ9.99-.      01780094
PK5621     05  FILLER                     PIC X(02)       VALUE SPACES. 01790094
PK5621     05  PV-RMNG-AVL-COST-AMT-NEG   PIC $ZZ,ZZZ,ZZZ,ZZ9.99-.      01800094
PK5621     05  FILLER                     PIC X(01)       VALUE SPACES. 01810094
PK5621     05  PS-REQUEST-STATUS          PIC X(06)       VALUE SPACES. 01820094
PK5621         88  PS-UPDATE-REQUEST                      VALUE         01830094
PK5621             'UPDATE'.                                            01840094
PK5621         88  PS-INSERT-REQUEST                      VALUE         01850094
PK5621             'INSERT'.                                            01860094
PK5621         88  PS-NEGATIVE-FOUND                      VALUE         01870094
PK5621             '-V FND'.                                            01880094
PK5621     05 FILLER                     PIC X(11) VALUE                01890094
PK5621                                   ' IS IGNORED'.                 01900094
P52134     05  FILLER                     PIC X(04)       VALUE SPACES. 01910094
P52134     05  VEND-NAME                  PIC X(44)       VALUE SPACES. 01920094
P52134     05  FILLER                     PIC X(02)       VALUE SPACES. 01930094
      ****************************************************************  01940094
8613F  01  CC-ORACLE-CONNECTION.                                        01941099
8613F      05  CC-ORACLE-USERID           PIC X(40).                    01942099
8613F          88 CC-AUTO-LOGON                           VALUE '/'.    01943099
8613F      05  CC-ORACLE-PASSWORD         PIC X(40).                    01944099
8613F *                                                                 01945099
       01  CC-CONTROL-CARD.                                             01950094
           05  FILLER                      PIC X(01)       VALUE SPACES.01960094
               88  CC-COMMENT                              VALUE '*'.   01970094
               88  CC-NOT-COMMENT                          VALUE SPACES.01980094
           05  CC-PROCESS-DTE              PIC X(10)       VALUE SPACES.01990094
           05  FILLER                      PIC X(01)       VALUE SPACES.02000099
           05  FILLER                      PIC X(04)       VALUE SPACES.02010099
           05  FILLER                      PIC X(01)       VALUE SPACES.02070099
           05  FILLER                      PIC X(08)       VALUE SPACES.02080099
           05  FILLER                      PIC X(01)       VALUE SPACES.02090099
           05  FILLER                      PIC 9(02)       VALUE ZEROES.02100099
           05  FILLER                      PIC X(01)       VALUE SPACES.02110099
           05  FILLER                      PIC X(08)       VALUE SPACES.02120099
           05  FILLER                      PIC X(01)       VALUE SPACES.02130099
           05  FILLER                      PIC 9(02)       VALUE ZEROES.02140099
           05  FILLER                      PIC X(40)       VALUE SPACES.02150099
                                                                        02160094
      ***************************************************************** 02170094
      *  KOHLS CALENDAR ROUTINE COPYBOOK                              * 02180094
      ***************************************************************** 02190094
      *01  DP500-KOHLS-CALENDAR-ROUTINE.                                02200094
      *01  DPG51.                                                       02210094
      *01  DPG52.                                                       02220094
      *01  DPG53.                                                       02230094
      *01  DPG54.                                                       02240094
      *01  DPG55.                                                       02250094
      *01  DPG56.                                                       02260094
           COPY DPWS500.                                                02270094
                                                                        02280094
      ***************************************************************** 02290094
      *  PROGRAM'S ACCUMULATORS                                       * 02300094
      ***************************************************************** 02310094
       01  PA-PROGRAM-ACCUMULATORS.                                     02320094
           05  PA-RECORDS-READ             PIC 9(09)       VALUE ZEROES.02330094
           05  PA-ROWS-UPDATED             PIC 9(09)       VALUE ZEROES.02340094
           05  PA-ROWS-INSERTED            PIC 9(09)       VALUE ZEROES.02350094
           05  PA-ROWS-TO-COMMIT           PIC 9(09)       VALUE ZEROES.02360094
           05  PA-NUMBER-OF-COMMIT         PIC 9(09)       VALUE ZEROES.02370094
           05  PA-NEGATIVE-COUNT           PIC 9(09)       VALUE ZEROES.02380094
RK0824     05  PA-ROWS-FETCHED             PIC 9(09)       VALUE ZEROES.02390094
                                                                        02400094
      ***************************************************************** 02410094
      *  PROGRAM'S CONSTANTS                                          * 02420094
      ***************************************************************** 02430094
       01  PC-PROGRAM-CONSTANTS.                                        02440094
           05  PC-MAX-DEADLOCKS            PIC S9(04)      VALUE +3.    02450094
           05  PC-PROGRAM-NAME             PIC X(08)       VALUE        02460094
               'DAKUP003'.                                              02470099
           05  PC-JOB-NAME                 PIC X(08)       VALUE        02480094
               'DAK006  '.                                              02490094
           05  PC-ORACLE-PROD-ID           PIC X(1)        VALUE '/'.   02500094
           05  PC-ORACLE-PROD-ID-LGTH      PIC 9(02)       VALUE 1.     02510094
8613F      05  PC-AUTO-LOGON               PIC X(01)       VALUE '/'.   02511099
                                                                        02520094
      ***************************************************************** 02530094
      *  PROGRAM'S SWITCHES                                           * 02540094
      ***************************************************************** 02550094
       01  PS-PROGRAM-SWITCHES.                                         02560094
           05  PS-END-OF-PURCH-FILE-SW     PIC X(01)       VALUE 'N'.   02570094
               88  PS-END-OF-PURCH-FILE                    VALUE 'Y'.   02580094
               88  PS-NOT-END-OF-PURCH-FILE                VALUE 'N'.   02590094
           05  PS-END-OF-CONTROL-CARDS-SW  PIC X(01)       VALUE 'N'.   02600094
               88  PS-END-OF-CONTROL-CARDS                 VALUE 'Y'.   02610094
               88  PS-NOT-END-OF-CONTROL-CARDS             VALUE 'N'.   02620094
           05  PS-ROW-PROCESSED-SW         PIC X(01)       VALUE 'N'.   02630094
               88  PS-ROW-PROCESSED                        VALUE 'Y'.   02640094
               88  PS-ROW-NOT-PROCESSED                    VALUE 'N'.   02650094
RK0824     05  PS-ROW-FOUND-SW             PIC X(01)       VALUE 'N'.   02660094
RK0824         88  PS-ROW-FOUND                            VALUE 'Y'.   02670094
RK0824         88  PS-ROW-NOT-FOUND                        VALUE 'N'.   02680094
RK0824     05  PS-NET-RESULT-SW            PIC X(01)       VALUE ' '.   02690094
RK0824         88  PS-ADD-DOLLARS                          VALUE 'A'.   02700094
RK0824         88  PS-SUBTRACT-DOLLARS                     VALUE 'S'.   02710094
RK0824     05  PS-NO-MORE-AVL-FUNDS-SW     PIC X(01)       VALUE 'N'.   02720094
RK0824         88  PS-NO-MORE-AVL-FUNDS                    VALUE 'Y'.   02730094
RK0824         88  PS-MORE-AVL-FUNDS                       VALUE 'N'.   02740094
           05  PS-FIRST-COMMIT-SW          PIC X(01)       VALUE 'N'.   02750094
               88  PS-FIRST-COMMIT                         VALUE 'Y'.   02760094
               88  PS-NOT-FIRST-COMMIT                     VALUE 'N'.   02770094
           05  PS-VALID-COMMIT-POINT-SW    PIC X(01)       VALUE 'Y'.   02780094
               88  PS-VALID-COMMIT-POINT                   VALUE 'Y'.   02790094
               88  PS-INVALID-COMMIT-POINT                 VALUE 'N'.   02800094
PK5621*    05  PS-REQUEST-STATUS           PIC X(08)       VALUE SPACES.02810094
PK5621*        88  PS-UPDATE-REQUEST                       VALUE        02820094
PK5621*            'UPDATE  '.                                          02830094
PK5621*        88  PS-INSERT-REQUEST                       VALUE        02840094
PK5621*            'INSERT  '.                                          02850094
PK5621*        88  PS-NEGATIVE-FOUND                       VALUE        02860094
PK5621*            'NEG FND '.                                          02870094
           05  PS-OPERATION-ATTEMPTED      PIC X(40)       VALUE SPACES.02880094
               88  PS-DEADLOCK-MSG                         VALUE        02890094
                   'MAXIMUM DEADLOCK COUNT EXCEEDED         '.          02900094
               88  PS-CHECK-AVL-FUND-MSG                   VALUE        02910094
                   'CHECKING AVAILABLE FUND FAILED          '.          02920094
               88  PS-CHECKPOINT-UPDATE-MSG                VALUE        02930094
                   'UPDATE CHECKPOINT FAILED                '.          02940094
               88  PS-COMMIT-MSG                           VALUE        02950094
                   'COMMIT FAILED                           '.          02960094
               88  PS-ORA-LOGIN-MSG                        VALUE        02970094
                   'ORACLE LOGIN FAILED                     '.          02980094
               88  PS-UPDATE-AVL-FUND-MSG                  VALUE        02990094
                   'UPDATE OF AVAILABLE FUND FAILED         '.          03000094
               88  PS-INSERT-AVL-FUND-MSG                  VALUE        03010094
                   'INSERT OF NEW AVAILABLE FUND FAILED     '.          03020094
               88  PS-GET-RESTART-MSG                      VALUE        03030094
                   'GETTING RESTARTING INFORMATION FAILED   '.          03040094
               88  PS-CHECK-RESTART-MSG                    VALUE        03050094
                   'CHECKING RESTARTING CONTROL FAILED      '.          03060094
8613F      05  PS-ORACLE-LOGIN-EOF-SW      PIC  X          VALUE 'N'.   03061099
8613F          88  ORACLE-LOGIN-EOF                       VALUE 'Y'.    03062099
                                                                        03070094
      ***************************************************************** 03080094
      *  PROGRAM'S VARIABLES                                          * 03090094
      ***************************************************************** 03100094
       01  PV-PROGRAM-VARIABLES.                                        03110094
W30975     05  PV-PURCH-NET                PIC $ZZZ,ZZZ,ZZ9.99-.        03120094
RK0824     05  PV-PURCH-NET-HOLD           PIC S9(9)V99.                03130094
           05  PV-TTL-AVL-COST-AMT         PIC $ZZ,ZZZ,ZZZ,ZZ9.99-.     03140094
           05  PV-RMNG-AVL-COST-AMT        PIC $ZZ,ZZZ,ZZZ,ZZ9.99-.     03150094
           05  PV-RETRY-COUNT              PIC S9(04)      VALUE ZEROES.03160094
           05  PV-PARAGRAPH-NAME           PIC X(40)       VALUE SPACES.03170094
PK5621     05  PV-HEADER-COUNT             PIC S9(3)       VALUE ZEROES.03180094
PK5621     05  PV-MAX-HEADER-COUNT         PIC S9(3)       VALUE 1.     03190094
           05  PV-NULL-RETURN              PIC S9(04)      VALUE ZEROES 03200094
                               COMP.                                    03210094
P52134     05  PV-VEND-NAME               PIC X(50)       VALUE SPACES. 03220094
P52134     05  FILLER                     PIC X(02)       VALUE SPACES. 03230094
           05  PV-CURR-FSCL-QTR-BEG.                                    03240094
               10  PV-CURR-BEG-DTE         PIC X(10)       VALUE SPACES.03250094
               10  PV-CURR-BEG-TIME        PIC X(09)       VALUE        03260094
                   '-00.00.00'.                                         03270094
           05  PV-CURR-FSCL-QTR-END.                                    03280094
               10  PV-CURR-END-DTE         PIC X(10)       VALUE SPACES.03290094
               10  PV-CURR-END-TIME        PIC X(09)       VALUE        03300094
                   '-23.59.59'.                                         03310094
8613F      05  PV-ORACLE-USERID-LEN        PIC S9(04)      VALUE ZEROS. 03311099
8613F      05  PV-ORACLE-PASSWORD-LEN      PIC S9(04)      VALUE ZEROS. 03312099
                                                                        03320094
      ***************************************************************** 03330094
      *  CHECKPOINT RESTART VARIABLE AREA                             * 03340094
      ***************************************************************** 03350094
       01  CR-CHECKPOINT-RESTART-AREA.                                  03360094
           05  CR-AREA-LEN                 PIC S9(04)      VALUE +81    03370094
                               COMP.                                    03380094
           05  CR-CHECKPOINT-RESTART-VAR.                               03390094
               10  CR-ROWS-UPDATED         PIC 9(09)       VALUE ZEROES.03400094
               10  CR-ROWS-INSERTED        PIC 9(09)       VALUE ZEROES.03410094
               10  CR-NUMBER-OF-COMMIT     PIC 9(09)       VALUE ZEROES.03420094
               10  CR-NEGATIVE-COUNT       PIC 9(09)       VALUE ZEROES.03430094
               05  CR-RECORDS-READ         PIC 9(09)       VALUE ZEROES.03440094
               05  CR-ENT-ID               PIC 9(09)       VALUE ZEROES.03450094
               05  CR-DEPT-NBR             PIC 9(04)       VALUE ZEROES.03460094
               05  CR-SCL-NBR              PIC 9(04)       VALUE ZEROES.03470094
               05  CR-BEG-DTE              PIC X(19)       VALUE SPACES.03480094
                                                                        03490094
                                                                        03500094
      ***************************************************************** 03510094
      *  ABEND CODE AREA                                              * 03520094
      ***************************************************************** 03530094
       01  PV-ABEND-CODE                   PIC S9(04)      VALUE ZEROES 03540094
                               COMP SYNC.                               03550094
           88  ABEND-4001-INV-WRITE-KEY                    VALUE +4001. 03560094
           88  ABEND-4002-INV-READ-KEY                     VALUE +4002. 03570094
           88  ABEND-4003-CNTL-CARD-ERRORS                 VALUE +4003. 03580094
           88  ABEND-4004-SEQUENCE-ERROR                   VALUE +4004. 03590094
           88  ABEND-4005-OPEN-FILE-ERROR                  VALUE +4005. 03600094
           88  ABEND-4006-CLOSE-FILE-ERROR                 VALUE +4006. 03610094
           88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 03620094
           88  ABEND-4009-INVALID-DATA                     VALUE +4009. 03630094
           88  ABEND-4012-BAD-INTR-SORT                    VALUE +4012. 03640094
           88  ABEND-4013-DB-ERROR                         VALUE +4013. 03650094
                                                                        03660094
                                                                        03670094
       01  WS-MSG-TEXT                     PIC X(512)      VALUE SPACES.03680094
       01  WS-MAX-SIZE                     PIC S9(09)      VALUE +512   03690094
                               COMP.                                    03700094
       01  WS-MSG-LENGTH                   PIC S9(09)      VALUE ZEROES 03710094
                               COMP.                                    03720094
                                                                        03730094
      ******************************************************************03740094
      *    ORACLE DECLARE SECTION                                       03750094
      ******************************************************************03760094
           EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     03770094
                                                                        03780094
       01  USERNAME                        PIC X(10)      VARYING.      03790094
       01  PASSWD                          PIC X(10)      VARYING.      03800094
                                                                        03810094
      ******************************************************************03820094
      * COBOL DECLARATION FOR TABLE TCKRSTINF                          *03830094
      ******************************************************************03840094
       01  DCLTCKRSTINF.                                                03850094
           10 TCKRSTINF-JOB-NAME                PIC X(8).               03860094
           10 TCKRSTINF-PLAN-NAME               PIC X(8).               03870094
           10 TCKRSTINF-RST-TRANS-SEQ-NMBR PIC S999999999V USAGE COMP-3.03880094
           10 TCKRSTINF-SEQ-NMBR                PIC S999V USAGE COMP-3. 03890094
           10 TCKRSTINF-WORK-STRG-DESC          PIC X(102).             03900094
           10 FILLER REDEFINES TCKRSTINF-WORK-STRG-DESC.                03910094
              15 TCKRSTINF-WORK-STRG-DESC-LEN   PIC S9(4) USAGE COMP.   03920094
              15 TCKRSTINF-WORK-STRG-DESC-TEXT  PIC X(0100).            03930094
                                                                        03940094
      ******************************************************************03950094
      * COBOL DECLARATION FOR TABLE TCKRSTCNTL                         *03960094
      ******************************************************************03970094
       01  DCLTCKRSTCNTL.                                               03980094
           10 TCKRSTCNTL-JOB-NAME             PIC X(8).                 03990094
           10 TCKRSTCNTL-PLAN-NAME            PIC X(8).                 04000094
           10 TCKRSTCNTL-CKPT-STAT-CODE       PIC X(1).                 04010094
           10 TCKRSTCNTL-CKPT-CNTL-CODE       PIC X(1).                 04020094
           10 TCKRSTCNTL-CKPT-TYPE-CODE       PIC X(1).                 04030094
           10 TCKRSTCNTL-CKPT-FRQNCY-QTY      PIC S99999V USAGE COMP-3. 04040094
           10 TCKRSTCNTL-TRANS-QTY        PIC S999999999V USAGE COMP-3. 04050094
           10 TCKRSTCNTL-PREP-TMESTP          PIC X(26).                04060094
           10 TCKRSTCNTL-CKPT-TAKEN-QTY   PIC S999999999V USAGE COMP-3. 04070094
           10 TCKRSTCNTL-TRANS-PRCSD-QTY  PIC S999999999V USAGE COMP-3. 04080094
           10 TCKRSTCNTL-RST-QTY              PIC S99999V USAGE COMP-3. 04090094
           10 TCKRSTCNTL-PRCSD-TMESTP         PIC X(26).                04100094
           10 TCKRSTCNTL-CKPT-DURATION-TIME   PIC X(8).                 04110094
                                                                        04120094
P58235******************************************************************04121099
P58235*COBOL DECLARATION FOR DB2 XMT_VND TABLE                          04122099
P58235***************************************************************** 04123099
P58235 01  DCLXMT00000.                                                 04127099
P58235     10 XMT00000-ENT-ID               PIC   S9(10) COMP-3.        04128099
P58235     10 XMT00000-PRIM-VND-NM          PIC   X(30).                04129099
P58235     10 XMT00000-VND-NBR              PIC   X(9).                 04129199
P58235     10 XMT00000-STAT-CDE             PIC   X(1).                 04129299
P58235     10 XMT00000-VND-CRE-TMST         PIC   X(26).                04129399
P58235     10 XMT00000-VND-LAST-UPD-TMST    PIC   X(26).                04129499
                                                                        04129699
      ******************************************************************04129799
      ******************************************************************04130094
      * COBOL DECLARATION FOR TABLE DAT_AVL_VND_FUND                    04140094
      ******************************************************************04150094
           EXEC SQL                                                     04160094
               INCLUDE DAT00002                                         04170094
           END-EXEC.                                                    04180094
                                                                        04190094
RK0824******************************************************************04200094
RK0824* DEBIT ALLOWANCE  CURSOR TO FIND DEBIT ALLOWANCE FUNDING.        04210094
RK0824******************************************************************04220094
RK0824     EXEC SQL                                                     04230094
RK0824     DECLARE DEBIT_ALLWNC CURSOR FOR                              04240094
RK0824         SELECT                                                   04250094
RK0824                 A.TTL_AVL_COST_AMT                               04260094
RK0824                ,A.RMNG_AVL_COST_AMT                              04270094
955568                ,TO_CHAR(A.EFF_BEG_DTE, 'YYYY-MM-DD-HH24.MI.SS')  04280094
RK0824                ,TO_CHAR(A.EFF_END_DTE, 'YYYY-MM-DD-HH24.MI.SS')  04290094
RK0824           FROM                                                   04300094
RK0824                 DAT_AVL_VND_FUND A                               04310094
RK0824           WHERE                                                  04320094
RK0824                 A.ENT_ID      = :ENT-ID                          04330094
RK0824             AND A.DEPT_NBR    = :DEPT-NBR                        04340094
RK0824             AND A.SUB_CL_NBR  = :SUB-CL-NBR                      04350094
955568*        ORDER BY    EFF_END_DTE                                  04360094
955568         ORDER BY    EFF_BEG_DTE                                  04370094
955568                    ,EFF_END_DTE                                  04380094
RK0824         FOR UPDATE NOWAIT                                        04390094
RK0824     END-EXEC.                                                    04400094
RK0824                                                                  04410094
           EXEC SQL END DECLARE SECTION END-EXEC.                       04420094
      *                                                                 04430094
      * ORA COMMUNICATION AREA                                          04440094
      *                                                                 04450094
        01       SQLCA.                                                 04460094
                 05  SQLCAID               PIC X(8).                    04470094
                 05  SQLCABC               PIC S9(9) COMPUTATIONAL.     04480094
                 05  SQLCODE               PIC S9(9) COMPUTATIONAL.     04490094
                 05  SQLERRM.                                           04500094
                     49 SQLERRML           PIC S9(4) COMPUTATIONAL.     04510094
                     49 SQLERRMC           PIC X(70).                   04520094
                 05  SQLERRP               PIC X(8).                    04530094
                 05  SQLERRD OCCURS 6 TIMES                             04540094
                                           PIC S9(9) COMPUTATIONAL.     04550094
                 05  SQLWARN.                                           04560094
                     10 SQLWARN0           PIC X(1).                    04570094
                     10 SQLWARN1           PIC X(1).                    04580094
                     10 SQLWARN2           PIC X(1).                    04590094
                     10 SQLWARN3           PIC X(1).                    04600094
                     10 SQLWARN4           PIC X(1).                    04610094
                     10 SQLWARN5           PIC X(1).                    04620094
                     10 SQLWARN6           PIC X(1).                    04630094
                     10 SQLWARN7           PIC X(1).                    04640094
                 05  SQLEXT                PIC X(8).                    04650094
      ******************************************************************04660094
      * ORA COMMUNICATION AREA2                                         04670094
           COPY SQLCA2.                                                 04680094
                                                                        04690094
       PROCEDURE DIVISION.                                              04700094
                                                                        04710094
      ******************************************************************04720094
      *    MAINLINE LOGIC                                              *04730094
      ******************************************************************04740094
                                                                        04750094
       0000-MAINLINE.                                                   04760094
                                                                        04770094
           PERFORM 1000-INITIALIZATION.                                 04780094
                                                                        04790094
           PERFORM 2000-PROCESS-INPUT                                   04800094
               UNTIL PS-END-OF-PURCH-FILE.                              04810094
                                                                        04820094
PK5621     PERFORM 9000-RPT-TRAILER.                                    04830094
                                                                        04840094
           PERFORM 9900-EOJ-LOGIC.                                      04850094
                                                                        04860094
           IF PA-NEGATIVE-COUNT > ZEROES                                04870094
               MOVE +4091          TO RETURN-CODE                       04880094
           END-IF.                                                      04890094
                                                                        04900094
           GOBACK.                                                      04910094
                                                                        04920094
      ******************************************************************04930094
      *    LOGON TO ORACLE, AND DECLARE THE ORACLE CURSORS.            *04940094
      ******************************************************************04950094
       1000-INITIALIZATION.                                             04960094
                                                                        04970094
           INITIALIZE DPG51                                             04980094
                      DPG52                                             04990094
                      DPG53                                             05000094
                      DPG54                                             05010094
                      DPG55                                             05020094
                      DPG56.                                            05030094
                                                                        05040094
           OPEN INPUT  CONTROL-CARD-FILE                                05050094
W30975                 PURCHASE-ADJ-FILE                                05060094
8613F                  ORACLE-LOGIN-FILE                                05061099
W30975          OUTPUT REJECTED-ADJ-FILE                                05070094
PK5621                 NEGATIVE-BAL-REPORT.                             05080094
                                                                        05090094
           PERFORM 6000-READ-CONTROL-CARD-FILE.                         05100094
                                                                        05110094
           IF PS-END-OF-CONTROL-CARDS                                   05120094
               DISPLAY '** ABEND **'                                    05130094
               DISPLAY '** PROGRAM ' PC-PROGRAM-NAME ' **'              05140094
               DISPLAY '** CONTROL CARD DATE EMPTY'                     05150094
               SET ABEND-4003-CNTL-CARD-ERRORS TO TRUE                  05160094
               PERFORM 9999-ABEND                                       05170094
           ELSE                                                         05180094
               DISPLAY ' EXECUTING WITH THESE CONTROL CARDS:'           05190094
               DISPLAY ' ----+----1----+----2----+----3----+----4'      05200094
                       '----+----5----+----6----+----7'                 05210094
               DISPLAY ' ' CC-CONTROL-CARD                              05220094
               PERFORM                                                  05230094
                   UNTIL PS-END-OF-CONTROL-CARDS                        05240094
                       OR CC-NOT-COMMENT                                05250094
                   PERFORM 6000-READ-CONTROL-CARD-FILE                  05260094
                   DISPLAY ' ' CC-CONTROL-CARD                          05270094
               END-PERFORM                                              05280094
               IF CC-NOT-COMMENT                                        05290094
                   SET DPG51-FISCAL-454-CALENDAR TO TRUE                05300094
                   SET DPG52-LK-DTE-ISO-FMT      TO TRUE                05310094
                   MOVE CC-PROCESS-DTE        TO DPG52-DB2-ISO-DATE-FMT 05320094
                   CALL DP500-KOHLS-CALENDAR-ROUTINE                    05330094
                       USING DPG51 DPG52 DPG53 DPG54 DPG55 DPG56        05340094
                   IF DPG54-NO-ERROR                                    05350094
                       MOVE DPG56-FIRST-FQ-DB2-ISO-FMT                  05360094
                           TO PV-CURR-BEG-DTE                           05370094
                       MOVE DPG56-LAST-FQ-DB2-ISO-FMT                   05380094
                           TO PV-CURR-END-DTE                           05390094
                   ELSE                                                 05400094
                       DISPLAY '** ABEND **'                            05410094
                       DISPLAY '** PROGRAM ' PC-PROGRAM-NAME ' **'      05420094
                       DISPLAY '** CALENDAR CALL ROUTINE FAIL'          05430094
                       SET ABEND-4003-CNTL-CARD-ERRORS TO TRUE          05440094
                       PERFORM 9999-ABEND                               05450094
                   END-IF                                               05460094
               ELSE                                                     05470094
                   DISPLAY '** ABEND **'                                05480094
                   DISPLAY '** PROGRAM ' PC-PROGRAM-NAME ' **'          05490094
                   DISPLAY '** CONTROL CARD ARE ALL COMMENTS'           05500094
                   SET ABEND-4003-CNTL-CARD-ERRORS TO TRUE              05510094
                   PERFORM 9999-ABEND                                   05520094
               END-IF                                                   05530094
           END-IF.                                                      05540094
                                                                        05550094
           DISPLAY ' '.                                                 05560094
                                                                        05570094
           PERFORM 6100-READ-PURCHASE-ADJ-FILE.                         05580094
           IF PS-END-OF-PURCH-FILE                                      05590094
               DISPLAY ' *** NOTHING TO PROCESS ***'                    05600094
               DISPLAY ' '                                              05610094
           ELSE                                                         05620094
               PERFORM 1100-LOGON-TO-ORACLE                             05630094
               PERFORM 1200-RESTART-PREP                                05640099
           END-IF.                                                      05650094
                                                                        05660094
      ****************************************************************  05670094
      * LOGON                                                        *  05680094
      ****************************************************************  05690094
       1100-LOGON-TO-ORACLE.                                            05700094
                                                                        05710094
           DISPLAY '**------ LOGGING ON TO ORACLE ------**'.            05720094
                                                                        05730094
 |         MOVE '1100-LOGON-TO-ORACLE'   TO PV-PARAGRAPH-NAME.          05730197
                                                                        05730297
8613F      READ ORACLE-LOGIN-FILE INTO CC-ORACLE-CONNECTION             05730399
8613F         AT END                                                    05730499
8613F            SET ORACLE-LOGIN-EOF      TO TRUE.                     05730599
8613F                                                                   05730699
8613F      IF CC-AUTO-LOGON                                             05730799
8613F         DISPLAY PC-PROGRAM-NAME ' - AUTO LOGON TO ORACLE'         05730899
8613F         EXEC SQL                                                  05730999
8613F              CONNECT :PC-AUTO-LOGON                               05731099
8613F         END-EXEC                                                  05731199
8613F      ELSE                                                         05731299
8613F         INITIALIZE PV-ORACLE-USERID-LEN                           05731399
8613F                    PV-ORACLE-PASSWORD-LEN                         05731499
8613F         INSPECT CC-ORACLE-USERID                                  05731599
8613F                 TALLYING PV-ORACLE-USERID-LEN                     05731699
8613F                 FOR CHARACTERS BEFORE INITIAL SPACE               05731799
8613F         INSPECT CC-ORACLE-PASSWORD                                05731899
8613F                 TALLYING PV-ORACLE-PASSWORD-LEN                   05731999
8613F                 FOR CHARACTERS BEFORE INITIAL SPACE               05732099
8613F         MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN)     TO     05732199
8613F                 USERNAME-ARR                                      05732299
8613F         MOVE PV-ORACLE-USERID-LEN    TO USERNAME-LEN              05732399
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     05732499
8613F                 PASSWD-ARR                                        05732599
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                05732699
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     05732799
8613F              PASSWD-ARR                                           05732899
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                05732999
8613F         MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN)     TO     05733099
8613F              USERNAME-ARR                                         05733199
8613F         MOVE PV-ORACLE-USERID-LEN    TO USERNAME-LEN              05733299
8613F         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO     05733399
8613F              PASSWD-ARR                                           05733499
8613F         MOVE PV-ORACLE-PASSWORD-LEN  TO PASSWD-LEN                05733599
8613F         DISPLAY PC-PROGRAM-NAME  ' - LOGON TO ORACLE AS USER '    05733699
8613F              USERNAME-ARR                                         05733799
8613F         EXEC SQL                                                  05733899
8613F              CONNECT :USERNAME IDENTIFIED BY :PASSWD              05733999
8613F         END-EXEC                                                  05734099
8613F         INITIALIZE CC-ORACLE-PASSWORD                             05734199
8613F                    PASSWD                                         05734299
8613F      END-IF.                                                      05734399
8613F                                                                   05734499
8613F      IF (SQLCODE NOT = 0)                                         05734599
8613F          SET PS-ORA-LOGIN-MSG        TO TRUE                      05734699
8613F          PERFORM 9990-SQL-ERROR                                   05734799
8613F      END-IF.                                                      05735099
                                                                        06230094
      ******************************************************************06240094
      *      PREPARE CHECKPOINT RESTART OR SET INPUT TO THE PROPER     *06250094
      *      RESTARTING POINT.                                         *06260094
      ******************************************************************06270094
       1200-RESTART-PREP.                                               06280094
                                                                        06290094
           PERFORM 8600-INIT-CHECKPOINT-SELECT.                         06300099
                                                                        06310094
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           06320094
               PERFORM 8700-SELECT-RESTART-INFO                         06330094
               MOVE TCKRSTINF-WORK-STRG-DESC                            06340094
                   TO CR-CHECKPOINT-RESTART-AREA                        06350094
      * RE-ESTABLISH COUNTS FOR PROCESSED INPUT                         06360094
               MOVE CR-ROWS-UPDATED     TO PA-ROWS-UPDATED              06370094
               MOVE CR-ROWS-INSERTED    TO PA-ROWS-INSERTED             06380094
               MOVE CR-NUMBER-OF-COMMIT TO PA-NUMBER-OF-COMMIT          06390094
               MOVE CR-NEGATIVE-COUNT   TO PA-NEGATIVE-COUNT            06400094
                                                                        06410094
               DISPLAY '*** RESTART AFTER'                              06420094
                       ' RECORD #' CR-RECORDS-READ                      06430094
                       ' DEPT: ' CR-DEPT-NBR                            06440094
                       ' ENT-ENT: ' CR-ENT-ID                           06450094
                       ' SUB-CLASS: ' CR-SCL-NBR                        06460094
                       ' FSCL-BEG-DATE: ' CR-BEG-DTE                    06470094
                                                                        06480094
               PERFORM 6100-READ-PURCHASE-ADJ-FILE                      06490094
                   VARYING PA-RECORDS-READ FROM 1 BY 1                  06500094
                   UNTIL PA-RECORDS-READ > CR-RECORDS-READ              06510094
                       OR PS-END-OF-PURCH-FILE                          06520094
      * ADJUST THE RECORD COUNTER DOWN BY ONE BECAUSE WHEN THE RECORD   06530094
      * GET PROCESSED, THE COUNTER WILL GO UP                           06540094
               COMPUTE PA-RECORDS-READ = PA-RECORDS-READ - 1            06550094
               IF PS-END-OF-PURCH-FILE                                  06560094
                   DISPLAY 'NOTHING TO COMMIT AFTER RESTART'            06570094
               ELSE                                                     06580094
                    DISPLAY '*** RESTART RECORD IS'                     06590094
                            ' DEPT: ' ML015-PURCH-DEPT-NBR              06600094
                            ' ENT-ENT: ' ML015-PURCH-ENT-ID             06610094
               END-IF                                                   06620094
           ELSE                                                         06630094
               SET PS-FIRST-COMMIT      TO TRUE                         06640094
               INITIALIZE CR-CHECKPOINT-RESTART-VAR                     06650094
           END-IF.                                                      06660094
                                                                        06670094
           DISPLAY 'COMMITS WILL BE TAKEN EVERY '                       06680094
                   TCKRSTCNTL-CKPT-FRQNCY-QTY ' RECORD(S).'.            06690094
                                                                        06700094
      ******************************************************************06710094
      *    2000-PROCESS-INPUT                                          *06720094
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE              *06730094
      *      PURPOSE: READ AND PROCESS THE PURCHASE ADJUSTMENT FILE    *06740094
      *               TO UPDATE THE DAT_AVL_VND_FUND TABLE             *06750094
      ******************************************************************06760094
       2000-PROCESS-INPUT.                                              06770094
                                                                        06780094
           ADD +1                    TO PA-RECORDS-READ.                06790094
                                                                        06800094
           PERFORM 7000-CHECK-FOR-POSTING.                              06810094
                                                                        06820094
           PERFORM 6100-READ-PURCHASE-ADJ-FILE.                         06830094
                                                                        06840094
                                                                        06850094
      ******************************************************************06860094
      *  READ CONTROL CARD FILE                                        *06870094
      ******************************************************************06880094
       6000-READ-CONTROL-CARD-FILE.                                     06890094
                                                                        06900094
           READ CONTROL-CARD-FILE INTO CC-CONTROL-CARD                  06910094
               AT END SET PS-END-OF-CONTROL-CARDS TO TRUE.              06920094
                                                                        06930094
      ******************************************************************06940094
      *  READ PURCHASE ADJUSTMENT FILE                                 *06950094
      ******************************************************************06960094
       6100-READ-PURCHASE-ADJ-FILE.                                     06970094
                                                                        06980094
           READ PURCHASE-ADJ-FILE INTO ML015-PURCHASE-RECORD            06990094
               AT END SET PS-END-OF-PURCH-FILE TO TRUE.                 07000094
                                                                        07010094
      ******************************************************************07020094
      *  WRITE OUT REJECTED ADJUSTMENT RECORD                          *07030094
      ******************************************************************07040094
W30975 6200-WRITE-REJECTED-ADJ-FILE.                                    07050094
W30975                                                                  07060094
W30975     WRITE REJECTED-ADJ-RECORD FROM ML015-PURCHASE-RECORD.        07070094
                                                                        07080094
                                                                        07090094
      ******************************************************************07100094
      *  GET INFORMATION BEFORE UPDATE                                 *07110094
      ******************************************************************07120094
       7000-CHECK-FOR-POSTING.                                          07130094
                                                                        07140094
           MOVE '7000-CHECK-FOR-POSTING' TO PV-PARAGRAPH-NAME.          07150094
           MOVE ML015-PURCH-ENT-ID       TO ENT-ID.                     07160094
           MOVE ML015-PURCH-DEPT-NBR     TO DEPT-NBR.                   07170094
           MOVE ZEROES                   TO SUB-CL-NBR.                 07180094
955568     MOVE PV-CURR-FSCL-QTR-BEG     TO EFF-BEG-DTE.                07190094
           MOVE PV-CURR-FSCL-QTR-END     TO EFF-END-DTE.                07200094
RK0824* IF THE NET EFFECT OF THE TRANS IS TO SUBTRACT DOLLARS, THEN     07210094
RK0824* THE AFFECTED ROWS WILL BE ADJUSTED IN OLDEST TO NEWEST SEQ. IF  07220094
RK0824* THE NET EFFECT IS TO ADD DOLLARS, ONLY THE LATEST EFF DATE ROW  07230094
RK0824* WILL BE ADJUSTED.                                               07240094
RK0824* BY USER DEFINITION '01' TRANS TYPE VALUES WILL BE SUBTRACTED    07250094
RK0824* FROM THE AVL_FUND VALUE AND THEREFORE A NEG ML015-PURCH-NET WILL07260094
RK0824* RESULT IN AN ADD AND POSTIVE VALUE IN A SUBTRACTION.  '02'      07270094
RK0824* TRAN TYPE IS THE OPPOSITE.                                      07280094
RK0824     IF ML015-PURCH-TRANS-CDE = '01'                              07290094
RK0824       IF 0 < ML015-PURCH-NET                                     07300094
RK0824         SET PS-SUBTRACT-DOLLARS TO TRUE                          07310094
RK0824         MOVE ML015-PURCH-NET TO PV-PURCH-NET-HOLD                07320094
RK0824       ELSE                                                       07330094
RK0824         SET PS-ADD-DOLLARS TO TRUE                               07340094
RK0824         COMPUTE PV-PURCH-NET-HOLD = (ML015-PURCH-NET * -1)       07350094
RK0824       END-IF                                                     07360094
RK0824     ELSE                                                         07370094
RK0824       IF 0 < ML015-PURCH-NET                                     07380094
RK0824         SET PS-ADD-DOLLARS TO TRUE                               07390094
RK0824         MOVE ML015-PURCH-NET TO PV-PURCH-NET-HOLD                07400094
RK0824       ELSE                                                       07410094
RK0824         SET PS-SUBTRACT-DOLLARS TO TRUE                          07420094
RK0824         COMPUTE PV-PURCH-NET-HOLD = (ML015-PURCH-NET * -1)       07430094
RK0824       END-IF                                                     07440094
RK0824     END-IF.                                                      07450094
RK0824     IF PS-SUBTRACT-DOLLARS                                       07460094
RK0824       SET PS-ROW-NOT-PROCESSED  TO TRUE                          07470094
RK0824       MOVE ZEROES               TO PV-RETRY-COUNT                07480094
P58235       PERFORM 8400-GET-VENDOR                                    07481099
RK0824       PERFORM 7900-SELECT-SUM                                    07490094
RK0824         UNTIL PS-ROW-PROCESSED                                   07500094
RK0824             OR PV-RETRY-COUNT > PC-MAX-DEADLOCKS                 07510094
RK0824       IF PS-ROW-FOUND                                            07520094
RK0824* AT THIS POINT TTL-AVL-COST-AMT AND RMNG-AVL-COST-AMT CONTAIN    07530094
RK0824* THE SUM OF ALL ROWS FOR A ENT_ID/DEPT/SUB_CL_NBR KEY.           07540094
RK0824         IF TTL-AVL-COST-AMT  < PV-PURCH-NET-HOLD                 07550094
RK0824           OR RMNG-AVL-COST-AMT < PV-PURCH-NET-HOLD               07560094
RK0824           SET PS-UPDATE-REQUEST       TO TRUE                    07570094
PK5621          IF PV-HEADER-COUNT < PV-MAX-HEADER-COUNT                07580094
PK5621           PERFORM 7300-WRITE-HEADINGS                            07590094
PK5621          END-IF                                                  07600094
RK0824           PERFORM 7500-DISPLAY-NEGATIVE-BALANCE                  07610094
RK0824           PERFORM 6200-WRITE-REJECTED-ADJ-FILE                   07620094
RK0824         ELSE                                                     07630094
RK0824* AFTER DETERMINING THAT THERE IS ENOUGH COST AMTS ON THE         07640094
RK0824* AVL_FUND TABLE, THE INDIVIDUAL ROW AMOUNTS WILL NOW BE          07650094
RK0824* DECREMENTED IN OLDEST TO NEWEST EFF DATE SEQUENCE.              07660094
RK0824           SET PS-ROW-NOT-PROCESSED  TO TRUE                      07670094
RK0824           MOVE ZEROES               TO PV-RETRY-COUNT            07680094
RK0824           PERFORM 7600-OPEN-DEBIT-ALLWNC-CSR                     07690094
RK0824             UNTIL PS-ROW-PROCESSED                               07700094
RK0824                 OR PV-RETRY-COUNT > PC-MAX-DEADLOCKS             07710094
RK0824           MOVE 0 TO PA-ROWS-FETCHED                              07720094
RK0824           SET PS-MORE-AVL-FUNDS TO TRUE                          07730094
RK0824           SET PS-ROW-NOT-PROCESSED  TO TRUE                      07740094
RK0824           MOVE ZEROES               TO PV-RETRY-COUNT            07750094
RK0824           PERFORM 7800-FETCH-DEBIT-ALLWNC-CSR                    07760094
RK0824             UNTIL PS-ROW-PROCESSED                               07770094
RK0824                 OR PV-RETRY-COUNT > PC-MAX-DEADLOCKS             07780094
RK0824           PERFORM 7050-PROCESS-SUB-POSTING                       07790094
RK0824             UNTIL PS-NO-MORE-AVL-FUNDS                           07800094
RK0824             OR PV-PURCH-NET-HOLD = 0                             07810094
RK0824           SET PS-ROW-NOT-PROCESSED  TO TRUE                      07820094
RK0824           MOVE ZEROES               TO PV-RETRY-COUNT            07830094
RK0824           PERFORM 7700-CLOSE-DEBIT-ALLWNC-CSR                    07840094
RK0824* THIS COND SHOULD ONLY HAPPEN IF THE RMNG-AVL-COST-AMT WAS       07850094
RK0824* CHANGED DURING THE EXECUTION OF THIS PGM BY ANOTHER PGM.        07860094
RK0824           IF PV-PURCH-NET-HOLD > 0                               07870094
RK0824             SET PS-UPDATE-REQUEST       TO TRUE                  07880094
PK5621          IF PV-HEADER-COUNT < PV-MAX-HEADER-COUNT                07890094
PK5621           PERFORM 7300-WRITE-HEADINGS                            07900094
PK5621          END-IF                                                  07910094
RK0824             PERFORM 7500-DISPLAY-NEGATIVE-BALANCE                07920094
RK0824             PERFORM 6200-WRITE-REJECTED-ADJ-FILE                 07930094
RK0824           END-IF                                                 07940094
RK0824         END-IF                                                   07950094
RK0824       ELSE                                                       07960094
RK0824* A SUBTRACTION IS TO BE PROCESSED AND THE ROW WAS NOT FOUND,     07970094
RK0824* THEREFORE A NEW ROW WITH A SUBTRACTION WOULD CREATE A NEGATIVE  07980094
RK0824* VALUE AND IS AN ERROR.                                          07990094
RK0824         MOVE 0 TO RMNG-AVL-COST-AMT                              08000094
RK0824                   TTL-AVL-COST-AMT                               08010094
RK0824         SET PS-INSERT-REQUEST       TO TRUE                      08020094
PK5621          IF PV-HEADER-COUNT < PV-MAX-HEADER-COUNT                08030094
PK5621           PERFORM 7300-WRITE-HEADINGS                            08040094
PK5621          END-IF                                                  08050094
RK0824         PERFORM 7500-DISPLAY-NEGATIVE-BALANCE                    08060094
RK0824         PERFORM 6200-WRITE-REJECTED-ADJ-FILE                     08070094
RK0824     ELSE                                                         08080094
RK0824* ADD ADJUSMENTS ARE DONE TO THE LATEST EFFECTIVE ROW.            08090094
RK0824       SET PS-ROW-NOT-PROCESSED  TO TRUE                          08100094
RK0824       MOVE ZEROES               TO PV-RETRY-COUNT                08110094
RK0824       PERFORM 7950-SELECT-NEWEST-ROW                             08120094
RK0824         UNTIL PS-ROW-PROCESSED                                   08130094
RK0824             OR PV-RETRY-COUNT > PC-MAX-DEADLOCKS                 08140094
955568*      IF PS-ROW-FOUND                                            08150094
955568       IF (PS-ROW-FOUND AND                                       08160094
955568           EFF-BEG-DTE = PV-CURR-FSCL-QTR-BEG)                    08170094
RK0824         ADD PV-PURCH-NET-HOLD TO TTL-AVL-COST-AMT                08180094
RK0824                                  RMNG-AVL-COST-AMT               08190094
RK0824         SET PS-UPDATE-REQUEST       TO TRUE                      08200094
RK0824         PERFORM 7100-UPDATE-DAT00002                             08210099
RK0824* IF NO MATCHING ROW WAS FOUND, INSERT NEW ROW,                   08220094
RK0824       ELSE                                                       08230094
RK0824         SET PS-INSERT-REQUEST       TO TRUE                      08240094
RK0824         MOVE PV-PURCH-NET-HOLD TO TTL-AVL-COST-AMT               08250094
RK0824                                   RMNG-AVL-COST-AMT              08260094
RK0824         MOVE PV-CURR-FSCL-QTR-BEG     TO EFF-BEG-DTE             08270094
RK0824         MOVE PV-CURR-FSCL-QTR-END     TO EFF-END-DTE             08280094
RK0824         PERFORM 7200-INSERT-DAT00002                             08290099
RK0824       END-IF.                                                    08300094
RK0824******************************************************************08310094
RK0824*  ADJUST RMNG-AVL-COST-AMT AND TTL-AVL-COST-AMT DOWNWARD        *08320094
RK0824******************************************************************08330094
RK0824 7050-PROCESS-SUB-POSTING.                                        08340094
RK0824     MOVE '7050-PROCESS-01-POSTING' TO PV-PARAGRAPH-NAME.         08350094
RK0824     IF PV-PURCH-NET-HOLD > TTL-AVL-COST-AMT                      08360094
RK0824       MOVE 0 TO TTL-AVL-COST-AMT                                 08370094
RK0824     ELSE                                                         08380094
RK0824       SUBTRACT PV-PURCH-NET-HOLD FROM TTL-AVL-COST-AMT           08390094
RK0824     END-IF.                                                      08400094
RK0824     IF PV-PURCH-NET-HOLD > RMNG-AVL-COST-AMT                     08410094
RK0824       SUBTRACT RMNG-AVL-COST-AMT FROM PV-PURCH-NET-HOLD          08420094
RK0824       MOVE 0 TO RMNG-AVL-COST-AMT                                08430094
RK0824     ELSE                                                         08440094
RK0824       SUBTRACT PV-PURCH-NET-HOLD FROM RMNG-AVL-COST-AMT          08450094
RK0824       MOVE 0 TO PV-PURCH-NET-HOLD                                08460094
RK0824     END-IF.                                                      08470094
RK0824                                                                  08480094
RK0824     SET PS-UPDATE-REQUEST       TO TRUE.                         08490094
RK0824     PERFORM 7100-UPDATE-DAT00002.                                08500099
RK0824                                                                  08510094
RK0824     IF PV-PURCH-NET-HOLD > 0                                     08520094
RK0824       PERFORM 7800-FETCH-DEBIT-ALLWNC-CSR                        08530094
RK0824     END-IF.                                                      08540094
                                                                        08550094
      ******************************************************************08560094
      *  UPDATE EXISTING ROW                                           *08570094
      ******************************************************************08580094
       7100-UPDATE-DAT00002.                                            08590094
                                                                        08600094
           MOVE '7100-UPDATE-DAT00002' TO PV-PARAGRAPH-NAME.            08610094
                                                                        08620094
           EXEC SQL                                                     08630094
               UPDATE                                                   08640094
                       DAT_AVL_VND_FUND                                 08650094
                  SET                                                   08660094
                      TTL_AVL_COST_AMT   = :TTL-AVL-COST-AMT            08670094
                     ,RMNG_AVL_COST_AMT  = :RMNG-AVL-COST-AMT           08680094
                     ,LAST_UPD_BY_USR_ID = :PC-PROGRAM-NAME             08690099
                     ,LAST_UPD_DTE = SYSDATE                            08700094
                 WHERE                                                  08710094
                       ENT_ID      = :ENT-ID                            08720094
                   AND DEPT_NBR    = :DEPT-NBR                          08730094
                   AND SUB_CL_NBR  = :SUB-CL-NBR                        08740094
                   AND EFF_END_DTE =                                    08750094
                       TO_DATE(:EFF-END-DTE,'YYYY-MM-DD-HH24.MI.SS')    08760094
           END-EXEC.                                                    08770094
                                                                        08780094
           EVALUATE TRUE                                                08790094
               WHEN SQLCODE = 0                                         08800094
                   ADD +1                        TO PA-ROWS-UPDATED     08810094
                   IF PS-VALID-COMMIT-POINT                             08820094
                      PERFORM 8000-CHECK-COMMIT                         08830094
                   END-IF                                               08840094
               WHEN OTHER                                               08850094
                   DISPLAY '** ENT-ID:      ' ENT-ID                    08860094
                   DISPLAY '** DEPT-NBR:    ' DEPT-NBR                  08870094
                   DISPLAY '** SUB-CLASS:   ' SUB-CL-NBR                08880094
                   DISPLAY '** EFF-END-DTE: ' EFF-END-DTE               08890094
                   DISPLAY '** RECORD NUMB: ' PA-RECORDS-READ           08900094
                   SET PS-UPDATE-AVL-FUND-MSG  TO TRUE                  08910094
                   PERFORM 9990-SQL-ERROR                               08920094
           END-EVALUATE.                                                08930094
                                                                        08940094
      ******************************************************************08950094
      *  INSERT NEW ROW                                                *08960094
      ******************************************************************08970094
       7200-INSERT-DAT00002.                                            08980094
                                                                        08990094
           MOVE '7200-INSERT-DAT00002' TO PV-PARAGRAPH-NAME.            09000094
                                                                        09010094
           EXEC SQL                                                     09020094
             INSERT INTO                                                09030094
                     DAT_AVL_VND_FUND                                   09040094
                ( ENT_ID                                                09050094
                 ,DEPT_NBR                                              09060094
                 ,SUB_CL_NBR                                            09070094
                 ,EFF_BEG_DTE                                           09080094
                 ,EFF_END_DTE                                           09090094
                 ,TTL_AVL_COST_AMT                                      09100094
                 ,RMNG_AVL_COST_AMT                                     09110094
                 ,LAST_UPD_BY_USR_ID                                    09120094
                 ,LAST_UPD_DTE )                                        09130094
               VALUES                                                   09140094
                ( :ENT-ID                                               09150094
                 ,:DEPT-NBR                                             09160094
                 ,:SUB-CL-NBR                                           09170094
                 ,TO_DATE(:EFF-BEG-DTE, 'YYYY-MM-DD-HH24.MI.SS')        09180094
                 ,TO_DATE(:EFF-END-DTE, 'YYYY-MM-DD-HH24.MI.SS')        09190094
                 ,:TTL-AVL-COST-AMT                                     09200094
                 ,:RMNG-AVL-COST-AMT                                    09210094
                 ,:PC-PROGRAM-NAME                                      09220099
                 ,SYSDATE)                                              09230094
           END-EXEC.                                                    09240094
                                                                        09250094
           EVALUATE TRUE                                                09260094
               WHEN SQLCODE = 0                                         09270094
                   ADD +1                        TO PA-ROWS-INSERTED    09280094
                   IF PS-VALID-COMMIT-POINT                             09290094
                      PERFORM 8000-CHECK-COMMIT                         09300094
                   END-IF                                               09310094
               WHEN OTHER                                               09320094
                   DISPLAY '** ENT-ID:      ' ENT-ID                    09330094
                   DISPLAY '** DEPT-NBR:    ' DEPT-NBR                  09340094
                   DISPLAY '** SUB-CLASS:   ' SUB-CL-NBR                09350094
                   DISPLAY '** EFF-BEG-DTE: ' EFF-BEG-DTE               09360094
                   DISPLAY '** RECORD NUMB: ' PA-RECORDS-READ           09370094
                   SET PS-INSERT-AVL-FUND-MSG  TO TRUE                  09380094
                   PERFORM 9990-SQL-ERROR                               09390094
           END-EVALUATE.                                                09400094
PK5621******************************************************************09410094
PK5621*  WRITING THE HEADER FOR REPORT FILE                             09420094
PK5621***********************************************************       09430094
PK5621 7300-WRITE-HEADINGS.                                             09440094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-FILE-HD1.                    09450094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-FILE-HD2.                    09460094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-FILE-HD3.                    09470094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-FILE-HD4.                    09480094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-FILE-HD5.                    09490094
RK0824******************************************************************09500094
RK0824*  CHECK FOR AND PROCESS NEGATIVE BALANCING                      *09510094
RK0824******************************************************************09520094
RK0824 7500-DISPLAY-NEGATIVE-BALANCE.                                   09530094
RK0824                                                                  09540094
RK0824     DISPLAY '*** NEGATIVE BALANCE FOUND ***'.                    09550094
RK0824     DISPLAY '  DEPT CLASS     ENT-ID  '                          09560094
RK0824             '  PURCH ADJ COST  '                                 09570094
RK0824             '    TOTAL AVAILABLE        REMAINING BAL'           09580094
RK0824             ' FUNCTION          '                                09590094
P52134             ' VENDOR NAME'.                                      09600094
RK0824     DISPLAY ' ----- ----- ----------  '                          09610094
RK0824             '----------------  '                                 09620094
RK0824             '-------------------  -------------------'           09630094
PK5621             ' -----------------'                                 09640094
PK5621             ' -----------------'.                                09650094
RK0824     ADD +1                    TO PA-NEGATIVE-COUNT.              09660094
RK0824     MOVE ML015-PURCH-NET      TO PV-PURCH-NET.                   09670094
PK5621     MOVE ML015-PURCH-NET      TO PV-PURCH-NET-NEG.               09680094
RK0824     MOVE TTL-AVL-COST-AMT     TO PV-TTL-AVL-COST-AMT.            09690094
PK5621     MOVE TTL-AVL-COST-AMT     TO PV-TTL-AVL-COST-AMT-NEG.        09700094
RK0824     MOVE RMNG-AVL-COST-AMT    TO PV-RMNG-AVL-COST-AMT.           09710094
PK5621     MOVE RMNG-AVL-COST-AMT    TO PV-RMNG-AVL-COST-AMT-NEG.       09720094
PK5621     MOVE DEPT-NBR TO DEPT-NBR-NEG                                09730094
P52134     MOVE VEND-NAME TO PV-VEND-NAME                               09740094
PK5621     MOVE SUB-CL-NBR TO SUB-CL-NBR-NEG                            09750094
PK5621     MOVE ENT-ID TO ENT-ID-NEG                                    09760094
PK5621                                                                  09770094
RK0824     DISPLAY '  ' DEPT-NBR                                        09780094
RK0824             '  ' SUB-CL-NBR                                      09790094
RK0824             ' ' ENT-ID                                           09800094
RK0824             '  ' PV-PURCH-NET                                    09810094
RK0824             '  ' PV-TTL-AVL-COST-AMT                             09820094
RK0824             '  ' PV-RMNG-AVL-COST-AMT                            09830094
RK0824             ' ' PS-REQUEST-STATUS                                09840094
PK5621             ' IS IGNORED.'                                       09850094
P52134             ' ' PV-VEND-NAME.                                    09860094
PK5621                                                                  09870094
PK5621     WRITE NEGATIVE-BAL-REC FROM NEGATIVE-BAL-LAYOUT.             09880094
PK5621     MOVE +1 TO PV-HEADER-COUNT.                                  09890094
RK0824     SET PS-NEGATIVE-FOUND     TO TRUE.                           09900094
RK0824                                                                  09910094
RK0824******************************************************************09920094
RK0824*  OPEN DEBIT ALLOWANCE CURSOR                                   *09930094
RK0824******************************************************************09940094
RK0824 7600-OPEN-DEBIT-ALLWNC-CSR.                                      09950094
RK0824                                                                  09960094
RK0824     MOVE '7600-OPEN-DEBIT-ALLWNC-CSR' TO PV-PARAGRAPH-NAME.      09970094
RK0824                                                                  09980094
RK0824     EXEC SQL                                                     09990094
RK0824         OPEN DEBIT_ALLWNC                                        10000094
RK0824     END-EXEC.                                                    10010094
RK0824                                                                  10020094
RK0824     EVALUATE TRUE                                                10030094
RK0824         WHEN SQLCODE = 0                                         10040094
RK0824             SET PS-ROW-PROCESSED           TO TRUE               10050094
RK0824         WHEN SQLCODE = 1403                                      10060094
RK0824             SET PS-ROW-PROCESSED           TO TRUE               10070094
RK0824         WHEN OTHER                                               10080094
RK0824             PERFORM 9990-SQL-ERROR                               10090094
RK0824     END-EVALUATE.                                                10100094
RK0824                                                                  10110094
RK0824******************************************************************10120094
RK0824*  CLOSE DEBIT ALLOWANCE CURSOR                                  *10130094
RK0824******************************************************************10140094
RK0824 7700-CLOSE-DEBIT-ALLWNC-CSR.                                     10150094
RK0824                                                                  10160094
RK0824     MOVE '7700-CLOSE-DEBIT-ALLWNC-CSR ' TO PV-PARAGRAPH-NAME.    10170094
RK0824                                                                  10180094
RK0824     EXEC SQL                                                     10190094
RK0824         CLOSE DEBIT_ALLWNC                                       10200094
RK0824     END-EXEC.                                                    10210094
RK0824                                                                  10220094
RK0824     EVALUATE TRUE                                                10230094
RK0824         WHEN SQLCODE = 0                                         10240094
RK0824             CONTINUE                                             10250094
RK0824         WHEN OTHER                                               10260094
RK0824             PERFORM 9990-SQL-ERROR                               10270094
RK0824     END-EVALUATE.                                                10280094
RK0824                                                                  10290094
RK0824******************************************************************10300094
RK0824*  FETCH THE NEXT ROW                                            *10310094
RK0824******************************************************************10320094
RK0824 7800-FETCH-DEBIT-ALLWNC-CSR.                                     10330094
RK0824                                                                  10340094
RK0824     MOVE '7800-FETCH-DEBIT-ALLWNC-CSR' TO PV-PARAGRAPH-NAME.     10350094
RK0824                                                                  10360094
RK0824     EXEC SQL                                                     10370094
RK0824         FETCH DEBIT_ALLWNC                                       10380094
RK0824           INTO                                                   10390094
RK0824                 :TTL-AVL-COST-AMT   :PV-NULL-RETURN              10400094
RK0824                ,:RMNG-AVL-COST-AMT  :PV-NULL-RETURN              10410094
955568                ,:EFF-BEG-DTE                                     10420094
RK0824                ,:EFF-END-DTE                                     10430094
RK0824     END-EXEC.                                                    10440094
RK0824                                                                  10450094
RK0824     EVALUATE TRUE                                                10460094
RK0824         WHEN SQLCODE = 0                                         10470094
RK0824             ADD +1                      TO PA-ROWS-FETCHED       10480094
RK0824             SET PS-MORE-AVL-FUNDS       TO TRUE                  10490094
RK0824             SET PS-ROW-PROCESSED        TO TRUE                  10500094
                   SET PS-INVALID-COMMIT-POINT TO TRUE                  10510094
RK0824         WHEN SQLCODE = 1403                                      10520094
RK0824             SET PS-NO-MORE-AVL-FUNDS    TO TRUE                  10530094
RK0824             SET PS-ROW-PROCESSED        TO TRUE                  10540094
                   SET PS-VALID-COMMIT-POINT   TO TRUE                  10550094
RK0824         WHEN OTHER                                               10560094
RK0824             PERFORM 9990-SQL-ERROR                               10570094
RK0824     END-EVALUATE.                                                10580094
RK0824                                                                  10590094
P58235******************************************************************10591099
P58235*  GET VENDOR INFORMATION                                        *10592099
P58235******************************************************************10593099
P58235 8400-GET-VENDOR.                                                 10594099
P58235                                                                  10595099
P58235     MOVE '8400-GET-VENDOR     ' TO PV-PARAGRAPH-NAME.            10596099
P58235                                                                  10597099
P58235     EXEC SQL                                                     10598099
P58235         SELECT                                                   10599099
P58235                 PRIM_VND_NM                                      10599199
P58235                ,VND_NBR                                          10599299
P58235           INTO                                                   10599399
P58235                :XMT00000-PRIM-VND-NM                             10599499
P58235               ,:XMT00000-VND-NBR                                 10599599
P58235           FROM                                                   10599699
P58235                 XMT_VND                                          10599799
P58235           WHERE                                                  10599899
P58235                 ENT_ID = :ENT-ID                                 10599999
P58235     END-EXEC.                                                    10600099
P58235                                                                  10600199
P58235     EVALUATE TRUE                                                10600299
P58235         WHEN SQLCODE = 0                                         10600399
P58235             MOVE  XMT00000-PRIM-VND-NM  TO VEND-NAME             10600499
P58235             CONTINUE                                             10600599
P58235         WHEN SQLCODE = 1403                                      10600699
P58235           DISPLAY '  *** COULD NOT FIND VENDOR INFO WITH '       10600799
P58235                      ENT-ID                                      10600899
P58235                   ' AS PV-ENT-ID'                                10600999
P58235           MOVE SPACE TO VEND-NAME                                10601099
P58235         WHEN OTHER                                               10601499
P58235             DISPLAY '**ERROR IN VENDOR RETRIEVAL'                10601599
P58235                         ENT-ID                                   10601699
P58235             PERFORM 9990-SQL-ERROR                               10601799
P58235             MOVE SPACES             TO XMT00000-PRIM-VND-NM      10601999
P58235     END-EVALUATE.                                                10602099
P58235                                                                  10602199
RK0824 7900-SELECT-SUM.                                                 10603094
RK0824     MOVE '7900-SELECT-SUM' TO PV-PARAGRAPH-NAME.                 10610094
RK0824                                                                  10620094
RK0824     EXEC SQL                                                     10630094
RK0824           SELECT                                                 10640094
RK0824                 SUM(A.TTL_AVL_COST_AMT)                          10650094
RK0824                ,SUM(A.RMNG_AVL_COST_AMT)                         10660094
RK0824           INTO                                                   10680094
RK0824                 :TTL-AVL-COST-AMT   :PV-NULL-RETURN              10690094
RK0824                ,:RMNG-AVL-COST-AMT  :PV-NULL-RETURN              10700094
RK0824           FROM                                                   10720094
P52134                 DAT_AVL_VND_FUND A                               10730099
RK0824           WHERE                                                  10750094
RK0824                 A.ENT_ID      = :ENT-ID                          10760094
RK0824             AND A.DEPT_NBR    = :DEPT-NBR                        10770094
RK0824             AND A.SUB_CL_NBR  = :SUB-CL-NBR                      10780094
RK0824     END-EXEC.                                                    10820094
RK0824                                                                  10830094
RK0824     EVALUATE TRUE                                                10840094
RK0824         WHEN SQLCODE = 0                                         10850094
RK0824           SET PS-ROW-PROCESSED         TO TRUE                   10860094
RK0824           IF PV-NULL-RETURN = -1                                 10870094
RK0824             SET PS-ROW-NOT-FOUND       TO TRUE                   10880094
RK0824           ELSE                                                   10890094
RK0824             SET PS-ROW-FOUND             TO TRUE                 10900094
RK0824           END-IF                                                 10910094
RK0824         WHEN SQLCODE = 1403                                      10920094
RK0824             SET PS-ROW-NOT-FOUND       TO TRUE                   10930094
RK0824             SET PS-ROW-PROCESSED       TO TRUE                   10940094
RK0824         WHEN SQLCODE = -54                                       10950094
RK0824             ADD +1                        TO PV-RETRY-COUNT      10960094
RK0824             DISPLAY 'DEADLOCK ORA-00054 7000-CHECK-FOR-POSTING'  10970094
RK0824             IF PV-RETRY-COUNT > PC-MAX-DEADLOCKS                 10980094
RK0824                 SET PS-DEADLOCK-MSG         TO TRUE              10990094
RK0824                 PERFORM 9990-SQL-ERROR                           11000094
RK0824             END-IF                                               11010094
RK0824         WHEN OTHER                                               11020094
RK0824             DISPLAY '** ENT-ID:      ' ENT-ID                    11030094
RK0824             DISPLAY '** DEPT-NBR:    ' DEPT-NBR                  11040094
RK0824             DISPLAY '** SUB-CLASS:   ' SUB-CL-NBR                11050094
RK0824             DISPLAY '** RECORD NUMB: ' PA-RECORDS-READ           11060094
RK0824             SET PS-CHECK-AVL-FUND-MSG   TO TRUE                  11070094
RK0824             PERFORM 9990-SQL-ERROR                               11080094
RK0824     END-EVALUATE.                                                11090094
RK0824                                                                  11100094
RK0824 7950-SELECT-NEWEST-ROW.                                          11110094
RK0824                                                                  11120094
RK0824     MOVE '7950-SELECT-NEWEST-ROW' TO PV-PARAGRAPH-NAME.          11130094
RK0824                                                                  11140094
RK0824     EXEC SQL                                                     11150094
RK0824         SELECT                                                   11160094
RK0824                 A.TTL_AVL_COST_AMT                               11170094
RK0824                ,A.RMNG_AVL_COST_AMT                              11180094
955568                ,TO_CHAR(A.EFF_BEG_DTE, 'YYYY-MM-DD-HH24.MI.SS')  11190094
RK0824                ,TO_CHAR(A.EFF_END_DTE, 'YYYY-MM-DD-HH24.MI.SS')  11200094
RK0824           INTO                                                   11210094
RK0824                 :TTL-AVL-COST-AMT   :PV-NULL-RETURN              11220094
RK0824                ,:RMNG-AVL-COST-AMT  :PV-NULL-RETURN              11230094
955568                ,:EFF-BEG-DTE                                     11240094
RK0824                ,:EFF-END-DTE                                     11250094
RK0824           FROM                                                   11260094
RK0824                 DAT_AVL_VND_FUND A                               11270094
RK0824           WHERE                                                  11280094
RK0824                 A.ENT_ID      = :ENT-ID                          11290094
RK0824             AND A.DEPT_NBR    = :DEPT-NBR                        11300094
RK0824             AND A.SUB_CL_NBR  = :SUB-CL-NBR                      11310094
RK0824             AND A.EFF_END_DTE =                                  11320094
RK0824                 (SELECT MAX(B.EFF_END_DTE)                       11330094
RK0824                   FROM                                           11340094
RK0824                     DAT_AVL_VND_FUND B                           11350094
RK0824                  WHERE                                           11360094
RK0824                     B.ENT_ID      = :ENT-ID                      11370094
RK0824                 AND B.DEPT_NBR    = :DEPT-NBR                    11380094
RK0824                 AND B.SUB_CL_NBR  = :SUB-CL-NBR)                 11390094
RK0824         FOR UPDATE NOWAIT                                        11400094
RK0824     END-EXEC.                                                    11410094
RK0824                                                                  11420094
RK0824     EVALUATE TRUE                                                11430094
RK0824         WHEN SQLCODE = 0                                         11440094
RK0824           SET PS-ROW-FOUND             TO TRUE                   11450094
RK0824           SET PS-ROW-PROCESSED         TO TRUE                   11460094
RK0824         WHEN SQLCODE = 1403                                      11470094
RK0824             SET PS-ROW-NOT-FOUND       TO TRUE                   11480094
RK0824             SET PS-ROW-PROCESSED       TO TRUE                   11490094
RK0824         WHEN SQLCODE = -54                                       11500094
RK0824             ADD +1                        TO PV-RETRY-COUNT      11510094
RK0824             DISPLAY 'DEADLOCK ORA-00054 7000-CHECK-FOR-POSTING'  11520094
RK0824             IF PV-RETRY-COUNT > PC-MAX-DEADLOCKS                 11530094
RK0824                 SET PS-DEADLOCK-MSG         TO TRUE              11540094
RK0824                 PERFORM 9990-SQL-ERROR                           11550094
RK0824             END-IF                                               11560094
RK0824         WHEN OTHER                                               11570094
RK0824             DISPLAY '** ENT-ID:      ' ENT-ID                    11580094
RK0824             DISPLAY '** DEPT-NBR:    ' DEPT-NBR                  11590094
RK0824             DISPLAY '** SUB-CLASS:   ' SUB-CL-NBR                11600094
RK0824             DISPLAY '** RECORD NUMB: ' PA-RECORDS-READ           11610094
RK0824             SET PS-CHECK-AVL-FUND-MSG   TO TRUE                  11620094
RK0824             PERFORM 9990-SQL-ERROR                               11630094
RK0824     END-EVALUATE.                                                11640094
RK0824                                                                  11650094
      ******************************************************************11660094
      *    COMMIT-CHANGES.                                             *11670094
      *      PURPOSE: COMMIT CHANGES TO THUS FAR                       *11680094
      ******************************************************************11690094
       8000-CHECK-COMMIT.                                               11700094
                                                                        11710094
           ADD +1                        TO PA-ROWS-TO-COMMIT.          11720094
           IF PA-ROWS-TO-COMMIT >= TCKRSTCNTL-CKPT-FRQNCY-QTY           11730094
               MOVE PA-ROWS-UPDATED          TO CR-ROWS-UPDATED         11740094
               MOVE PA-ROWS-INSERTED         TO CR-ROWS-INSERTED        11750094
               MOVE PA-NUMBER-OF-COMMIT      TO CR-NUMBER-OF-COMMIT     11760094
               MOVE PA-NEGATIVE-COUNT        TO CR-NEGATIVE-COUNT       11770094
               MOVE PA-RECORDS-READ          TO CR-RECORDS-READ         11780094
               MOVE ENT-ID                   TO CR-ENT-ID               11790094
               MOVE DEPT-NBR                 TO CR-DEPT-NBR             11800094
               MOVE SUB-CL-NBR               TO CR-SCL-NBR              11810094
               MOVE EFF-BEG-DTE              TO CR-BEG-DTE              11820094
               MOVE CR-CHECKPOINT-RESTART-AREA                          11830094
                   TO TCKRSTINF-WORK-STRG-DESC                          11840094
               IF PS-FIRST-COMMIT                                       11850094
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                11860094
                   PERFORM 8900-UPDATE-CHECKPOINT-STATUS                11870099
                   SET PS-NOT-FIRST-COMMIT   TO TRUE                    11880094
               END-IF                                                   11890094
               PERFORM 8800-COMMIT-CHANGES                              11900099
           END-IF.                                                      11910094
                                                                        11920094
      ******************************************************************11930094
      * CHECK STATUS CODE TO SEE IF THIS IS A RESTART CONDITION        *11940094
      ******************************************************************11950094
       8600-INIT-CHECKPOINT-SELECT.                                     11960094
                                                                        11970094
           EXEC SQL                                                     11980094
             SELECT                                                     11990094
                     CKPT_STAT_CODE                                     12000094
                    ,CKPT_FRQNCY_QTY                                    12010094
               INTO                                                     12020094
                     :TCKRSTCNTL-CKPT-STAT-CODE                         12030094
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        12040094
               FROM                                                     12050094
                     TCKRSTCNTL                                         12060094
               WHERE                                                    12070094
                     JOB_NAME  = :PC-JOB-NAME                           12080094
                 AND PLAN_NAME = :PC-PROGRAM-NAME                       12090094
           END-EXEC.                                                    12100094
                                                                        12110094
           IF SQLCODE = 0                                               12120094
               CONTINUE                                                 12130094
           ELSE                                                         12140094
               MOVE '8600-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  12150094
               SET PS-CHECK-RESTART-MSG           TO TRUE               12160094
               PERFORM 9990-SQL-ERROR                                   12170094
           END-IF.                                                      12180094
                                                                        12190094
      ******************************************************************12200094
      * OBTAIN INFORMATION REGARDING WHERE TO RESTART TABLE PROCESSING *12210094
      ******************************************************************12220094
       8700-SELECT-RESTART-INFO.                                        12230094
                                                                        12240094
           EXEC SQL                                                     12250094
               SELECT                                                   12260094
                        WORK_STRG_DESC                                  12270094
                 INTO                                                   12280094
                       :TCKRSTINF-WORK-STRG-DESC                        12290094
                 FROM                                                   12300094
                       TCKRSTINF                                        12310094
                 WHERE                                                  12320094
                       JOB_NAME  = :PC-JOB-NAME                         12330094
                   AND PLAN_NAME = :PC-PROGRAM-NAME                     12340094
           END-EXEC.                                                    12350094
                                                                        12360094
           IF SQLCODE = 0                                               12370094
               CONTINUE                                                 12380094
           ELSE                                                         12390094
               MOVE '8700-SELECT-RESTART-INFO  ' TO PV-PARAGRAPH-NAME   12400094
               SET PS-GET-RESTART-MSG            TO TRUE                12410094
               PERFORM 9990-SQL-ERROR                                   12420094
           END-IF.                                                      12430094
                                                                        12440094
                                                                        12450094
      ******************************************************************12460094
      * UPDATE CHECKPOINT INFORMATION TABLE. TAKE A COMMIT.             12470094
      ******************************************************************12480094
       8800-COMMIT-CHANGES.                                             12490094
                                                                        12500094
           EXEC SQL                                                     12510094
               UPDATE                                                   12520094
                      TCKRSTINF                                         12530094
                  SET                                                   12540094
                      WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC        12550094
                WHERE                                                   12560094
                      JOB_NAME       = :PC-JOB-NAME                     12570094
                  AND PLAN_NAME      = :PC-PROGRAM-NAME                 12580094
           END-EXEC.                                                    12590094
                                                                        12600094
           IF SQLCODE = 0                                               12610094
               CONTINUE                                                 12620094
           ELSE                                                         12630094
               MOVE  '8800-COMMIT-CHANGES    ' TO PV-PARAGRAPH-NAME     12640094
               SET PS-CHECKPOINT-UPDATE-MSG    TO TRUE                  12650094
               PERFORM 9990-SQL-ERROR                                   12660094
           END-IF.                                                      12670094
                                                                        12680094
           EXEC SQL                                                     12690094
               COMMIT                                                   12700094
           END-EXEC.                                                    12710094
                                                                        12720094
           IF SQLCODE = 0                                               12730094
               ADD +1                        TO PA-NUMBER-OF-COMMIT     12740094
               MOVE ZEROES                   TO PA-ROWS-TO-COMMIT       12750094
           ELSE                                                         12760094
               MOVE  '8800-COMMIT-CHANGES    ' TO PV-PARAGRAPH-NAME     12770094
               SET PS-COMMIT-MSG               TO TRUE                  12780094
               PERFORM 9990-SQL-ERROR                                   12790094
           END-IF.                                                      12800094
                                                                        12810094
      ******************************************************************12820094
      * UPDATE CHECKPOINT STATUS                                        12830094
      ******************************************************************12840094
       8900-UPDATE-CHECKPOINT-STATUS.                                   12850094
                                                                        12860094
           EXEC SQL                                                     12870094
               UPDATE                                                   12880094
                      TCKRSTCNTL                                        12890094
                  SET                                                   12900094
                      CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE       12910094
                WHERE                                                   12920094
                      JOB_NAME  = :PC-JOB-NAME                          12930094
                  AND PLAN_NAME = :PC-PROGRAM-NAME                      12940094
           END-EXEC.                                                    12950094
                                                                        12960094
           IF SQLCODE = 0                                               12970094
               CONTINUE                                                 12980094
           ELSE                                                         12990094
               MOVE '8900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME13000094
               SET PS-CHECKPOINT-UPDATE-MSG         TO TRUE             13010094
               PERFORM 9990-SQL-ERROR                                   13020094
           END-IF.                                                      13030094
                                                                        13040094
                                                                        13050094
PK5621 9000-RPT-TRAILER.                                                13060094
PK5621     WRITE NEGATIVE-BAL-REC FROM RPT-DTL-LINE.                    13070094
      ******************************************************************13080094
      *    9900-EOJ-LOGIC.                                             *13090094
      *      THIS IS PERFORMED AT END OF INPUT FILE.                   *13100094
      *      PURPOSE: CLOSE INPUT FILE, COMMIT CHANGES AND DISPLAY     *13110094
      *      RECORD COUNTS.                                            *13120094
      ******************************************************************13130094
       9900-EOJ-LOGIC.                                                  13140094
      * FORCE A COMMIT, IF THERE ARE UNCOMMITTED ROWS                   13150094
           IF PA-ROWS-TO-COMMIT > ZEROES                                13160094
               MOVE TCKRSTCNTL-CKPT-FRQNCY-QTY                          13170094
                   TO PA-ROWS-TO-COMMIT                                 13180094
               PERFORM 8000-CHECK-COMMIT                                13190094
           END-IF.                                                      13200094
                                                                        13210094
           IF PA-RECORDS-READ > ZEROES                                  13220094
               MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE                    13230094
               PERFORM 8900-UPDATE-CHECKPOINT-STATUS                    13240099
                                                                        13250094
               EXEC SQL                                                 13260094
                   COMMIT RELEASE                                       13270094
               END-EXEC                                                 13280094
           END-IF.                                                      13290094
                                                                        13300094
           CLOSE CONTROL-CARD-FILE                                      13310094
W30975           PURCHASE-ADJ-FILE                                      13320094
W30975           REJECTED-ADJ-FILE                                      13330094
PK5621           NEGATIVE-BAL-REPORT.                                   13340094
                                                                        13350094
           DISPLAY ' '.                                                 13360094
           DISPLAY 'RECORDS READ    ' PA-RECORDS-READ.                  13370094
           DISPLAY 'NEGATIVE RECORD ' PA-NEGATIVE-COUNT.                13380094
           DISPLAY 'ROWS UPDATED    ' PA-ROWS-UPDATED.                  13390094
           DISPLAY 'ROWS INSERTED   ' PA-ROWS-INSERTED.                 13400094
           DISPLAY 'COMMITS         ' PA-NUMBER-OF-COMMIT.              13410094
           DISPLAY '**------ END ' PC-PROGRAM-NAME ' ------**'.         13420094
                                                                        13430094
                                                                        13440094
      ******************************************************************13450094
      * DISPLAYS ERRORS ENCOUNTERED ON SQL REQUEST                      13460094
      ******************************************************************13470094
       9990-SQL-ERROR.                                                  13480094
                                                                        13490094
           MOVE SQLCODE    TO SQLCODE2.                                 13500094
           MOVE SQLERRD(3) TO SQLERRD3.                                 13510094
           DISPLAY '** ABEND **       ** = SQLERROR'.                   13520094
           DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.           13530094
           DISPLAY '** PARAGRAPH      ** = ' PV-PARAGRAPH-NAME.         13540094
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  13550094
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  13560094
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   13570094
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  13580094
           DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                13590094
           DISPLAY '** OPERATION      ** = ' PS-OPERATION-ATTEMPTED.    13600094
           DISPLAY '** LAST COMMIT RECORD  = ' CR-RECORDS-READ.         13610094
           DISPLAY '** LAST COMMIT ENT-ID  = ' CR-ENT-ID.               13620094
           DISPLAY '** LAST COMMIT DEPT    = ' CR-DEPT-NBR.             13630094
           DISPLAY '** LAST COMMIT SUB-CLS = ' CR-SCL-NBR.              13640094
           DISPLAY '** LAST COMMIT BEG-DTE = ' CR-BEG-DTE.              13650094
                                                                        13660094
           MOVE SPACES TO WS-MSG-TEXT.                                  13670094
      *    GET FULL TEXT OF ERROR MESSAGE                               13680094
                                                                        13690094
           CALL 'SQLGLM' USING WS-MSG-TEXT,                             13700094
                               WS-MAX-SIZE,                             13710094
                               WS-MSG-LENGTH.                           13720094
           DISPLAY 'MESSAGE TEXT      ** = ' WS-MSG-TEXT.               13730094
                                                                        13740094
           EXEC SQL                                                     13750094
               ROLLBACK WORK RELEASE                                    13760094
           END-EXEC.                                                    13770094
                                                                        13780094
           SET ABEND-4013-DB-ERROR  TO TRUE.                            13790094
                                                                        13800094
           PERFORM 9999-ABEND.                                          13810094
                                                                        13820094
      ******************************************************************13830094
      * PROGRAM ABEND PARAGRAPH                                         13840094
      ******************************************************************13850094
       9999-ABEND.                                                      13860094
                                                                        13870094
           CALL 'ILBOABN0'  USING PV-ABEND-CODE.                        13880094
                                                                        13890094
      ******************************************************************13900094
      *    END OF SOURCE CODE FOR DAKUP003                             *13910094
      ******************************************************************13920094
