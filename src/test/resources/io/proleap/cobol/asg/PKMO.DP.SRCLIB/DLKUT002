000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.    DLKUT002.                                         00020001
000300 AUTHOR.        PAUL OMAN.                                        00030001
000400                                                                  00040001
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050001
000600 DATE-WRITTEN.  NOVEMBER 2003.                                    00060001
000700 DATE-COMPILED.                                                   00070001
000800                                                                  00080001
000900 ENVIRONMENT DIVISION.                                            00090001
001000 CONFIGURATION SECTION.                                           00100001
001100 SOURCE-COMPUTER. IBM-3090.                                       00110001
001200 OBJECT-COMPUTER. IBM-3090.                                       00120001
001300                                                                  00130001
001400****************************************************************  00140001
001500*                                                              *  00150001
001600*    CALLED BY DLKUP001 WITH COPYBOOK DLWS004.                 *  00160016
001700*                                                              *  00170001
001800*    DETERMINES IF AN ASSIGNMENT IS ALREADY ACTIVE FOR A       *  00180013
001900*    DC/WORK TYPE/WORK AREA.  IF SO, IT PASSES BACK THE        *  00190039
002000*    ASSIGNMENT START DATE, NUMBER TEXT, AND NUMBER SEQUENCE   *  00200039
002100*    NUMBER.                                                   *  00210039
002200*                                                              *  00220039
002300*  DB2 ACCESS:                                                 *  00230016
002400*    DLT_TEM_ASGMT (DLT00003) TABLE                            *  00240016
002500*               SELECTS                                        *  00250016
002600*                                                              *  00260001
002700*    DLT_ASGMT (DLT00004) TABLE                                *  00270016
002800*               SELECTS                                        *  00280016
002900*                                                              *  00290001
003000*                                                              *  00300001
003100*                                                              *  00310001
003200*                                                              *  00320001
003300****************************************************************  00330001
003400                                                                  00340001
003500 DATA DIVISION.                                                   00350001
003600 WORKING-STORAGE SECTION.                                         00360001
003700                                                                  00370001
003800 01  PV-CHARACTER-FIELDS.                                         00380001
003900     05  PV-CURRENT-DATE          PIC X(10)  VALUE SPACES.        00390001
004000     05  PV-KEY-START-DATE        PIC X(10)  VALUE SPACES.        00400001
004100                                                                  00410001
004200 01  PV-COMP-FIELDS.                                              00420001
004300     05  PV-RETRY-COUNTER         PIC S9(04) VALUE 0 COMP.        00430001
004400     05  PV-WORK-TYPE-COUNT       PIC S9(07) VALUE 0 COMP-3.      00440001
004500     05  PV-ASGMT-COUNT           PIC S9(07) VALUE 0 COMP-3.      00450001
004600                                                                  00460001
004700 01  PS-SWITCHES.                                                 00470001
004800     05  PS-WORK-TYPE-SW              PIC X(01)  VALUE SPACE.     00480001
004900         88  PS-NO-WORK-TYPE-FOUND               VALUE '0'.       00490001
005000         88  PS-ONE-WORK-TYPE-FOUND              VALUE '1'.       00500001
005100         88  PS-MULTIPLE-WORK-TYPE-FOUND         VALUE '2'.       00510001
005200                                                                  00520001
005300 01  PC-CONSTANTS.                                                00530001
005400     05  PC-MAX-RETRIES           PIC S9(04) VALUE +3 COMP.       00540001
005500     05  PC-N                        PIC X      VALUE 'N'.        00550001
005600     05  PC-ASTERISK-LINE            PIC X(40)  VALUE ALL '*'.    00560001
005700                                                                  00570001
005800****************************************************************  00580001
005900*                                                              *  00590001
006000*                                                              *  00600001
006100****************************************************************  00610001
006200                                                                  00620001
006300     EXEC SQL                                                     00630001
006400         INCLUDE DLT00004                                         00640001
006500     END-EXEC.                                                    00650001
006600                                                                  00660001
006700     EXEC SQL                                                     00670001
006800         INCLUDE DLT00003                                         00680001
006900     END-EXEC.                                                    00690001
007000                                                                  00700001
007100     EXEC SQL                                                     00710001
007200          INCLUDE SQLCA                                           00720001
007300     END-EXEC.                                                    00730001
007400                                                                  00740001
007500                                                                  00750001
007600 LINKAGE SECTION.                                                 00760001
007700     COPY DLWS004.                                                00770001
007800                                                                  00780001
007900                                                                  00790001
008000 PROCEDURE DIVISION USING DL004-ASGMT-COMMAREA.                   00800001
008100                                                                  00810001
008200     SET DL004-SUCCESSFUL TO TRUE.                                00820001
008300                                                                  00830001
008400     EVALUATE TRUE                                                00840001
008500         WHEN DL004-BY-WK-TYP-AREA-KEY                            00850001
008600              PERFORM 1000-FIND-WORK-TYPE                         00860001
008700                                                                  00870001
008800         WHEN OTHER                                               00880001
008900              SET DL004-INVALID-ACCESS TO TRUE                    00890001
009000                                                                  00900001
009100     END-EVALUATE.                                                00910001
009200                                                                  00920001
009300                                                                  00930001
009400     MOVE SQLCA                       TO DL004-SQLCA.             00940001
009500                                                                  00950007
009600     GOBACK.                                                      00960001
009700                                                                  00970001
009800****************************************************************  00980023
009900*                                                              *  00990023
010000*                                                              *  01000023
010100****************************************************************  01010023
010200                                                                  01020001
010300 1000-FIND-WORK-TYPE.                                             01030001
010400                                                                  01040001
010500     EVALUATE TRUE                                                01050001
010600         WHEN DL004-NO-KEY-WK-TYP                                 01060001
010700              SET DL004-MISSING-KEY-FIELDS TO TRUE                01070001
010800                                                                  01080001
010900         WHEN DL004-NO-KEY-WK-AREA                                01090001
011000              SET DL004-MISSING-KEY-FIELDS TO TRUE                01100001
011100                                                                  01110001
011200         WHEN DL004-NO-KEY-DC-NBR                                 01120001
011300              SET DL004-MISSING-KEY-FIELDS TO TRUE                01130001
011400                                                                  01140001
011500         WHEN OTHER                                               01150001
011600              PERFORM 2000-CHECK-ASSIGNMENTS                      01160001
011700                                                                  01170001
011800     END-EVALUATE.                                                01180001
011900                                                                  01190001
012000****************************************************************  01200001
012100*                                                              *  01210001
012200*                                                              *  01220001
012300*                                                              *  01230001
012400****************************************************************  01240001
012500                                                                  01250001
012600 2000-CHECK-ASSIGNMENTS.                                          01260001
012700                                                                  01270001
012800     PERFORM 3000-SELECT-BY-WORK-TYPE.                            01280001
012900                                                                  01290001
013000     EVALUATE TRUE                                                01300001
013100         WHEN DL004-SQL-ERROR                                     01310001
013200              CONTINUE                                            01320036
013300                                                                  01330001
013400         WHEN PS-ONE-WORK-TYPE-FOUND                              01340001
013500              PERFORM 2400-FORMAT-OUTPUT-FIELDS                   01350009
013600              PERFORM 5400-COUNT-BY-ASGMT                         01360001
013700                                                                  01370001
013800              EVALUATE TRUE                                       01380001
013900                  WHEN DL004-SQL-ERROR                            01390001
014000                       CONTINUE                                   01400001
014100                                                                  01410001
014200                  WHEN OTHER                                      01420001
014300                       SET DL004-SUCCESSFUL TO TRUE               01430001
014400                       SET DL004-ASGMT-FOUND TO TRUE              01440011
014500                                                                  01450001
014600              END-EVALUATE                                        01460001
014700                                                                  01470001
014800         WHEN PS-MULTIPLE-WORK-TYPE-FOUND                         01480001
014900              SET DL004-ASGMT-MULT-FOUND TO TRUE                  01490011
015000              PERFORM 5000-COUNT-BY-WORK-TYPE                     01500001
015100                                                                  01510001
015200              EVALUATE TRUE                                       01520001
015300                  WHEN DL004-SQL-ERROR                            01530001
015400                       CONTINUE                                   01540001
015500                                                                  01550001
015600                  WHEN OTHER                                      01560001
015700                       SET DL004-SUCCESSFUL TO TRUE               01570001
015800                                                                  01580001
015900              END-EVALUATE                                        01590001
016000                                                                  01600001
016100         WHEN PS-NO-WORK-TYPE-FOUND                               01610001
016200              SET DL004-ASGMT-NOT-FOUND TO TRUE                   01620001
016300                                                                  01630001
016400     END-EVALUATE.                                                01640001
016500                                                                  01650001
016600                                                                  01660023
016700****************************************************************  01670023
016800*                                                              *  01680023
016900*                                                              *  01690023
017000****************************************************************  01700023
017100                                                                  01710001
017200 2400-FORMAT-OUTPUT-FIELDS.                                       01720009
017300                                                                  01730001
017400     MOVE DLT00004-ASGMT-STRT-DTE    TO DL004-ASGMT-START-DTE.    01740011
017500     MOVE DLT00004-ASGMT-NBR-TXT     TO DL004-ASGMT-NBR-TXT.      01750011
017600     MOVE DLT00004-ASGMT-NBR-SEQ-NBR TO DL004-ASGMT-NBR-SEQ-NBR.  01760011
017700     MOVE DLT00004-ASGMT-STRT-TM     TO DL004-ASGMT-STRT-TM.      01770029
017800     MOVE DLT00004-CRE-BY-USR-ID     TO                           01780029
017900                            DL004-ASGMT-CRE-BY-USR-ID.            01790029
018000     MOVE DLT00004-CRE-BY-PGM-NM     TO                           01800011
018100                            DL004-ASGMT-CRE-BY-PGM-NM.            01810012
018200     MOVE DLT00004-LAST-USD-SEQ-NBR  TO                           01820011
018300                            DL004-ASGMT-LAST-USD-SEQ-NBR.         01830011
018400                                                                  01840009
018500****************************************************************  01850023
018600*                                                              *  01860023
018700*                                                              *  01870023
018800****************************************************************  01880023
018900                                                                  01890009
019000 3000-SELECT-BY-WORK-TYPE.                                        01900009
019100                                                                  01910001
019200     PERFORM                                                      01920001
019300         WITH TEST AFTER                                          01930001
019400         VARYING PV-RETRY-COUNTER                                 01940001
019500         FROM 1 BY 1                                              01950001
019600         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  01960001
019700            OR SQLCODE = ZERO                                     01970001
019800            OR SQLCODE = +100                                     01980001
019900            OR SQLCODE = -811                                     01990001
020000                                                                  02000001
020100         EXEC SQL                                                 02010001
020200             SELECT                                               02020001
020300                    ASGMT.ASGMT_STRT_DTE                          02030001
020400                   ,ASGMT.ASGMT_NBR_TXT                           02040001
020500                   ,ASGMT.ASGMT_NBR_SEQ_NBR                       02050001
020600                   ,ASGMT.ASGMT_STRT_TM                           02060017
020700                   ,ASGMT.CRE_BY_USR_ID                           02070001
020800                   ,ASGMT.CRE_BY_PGM_NM                           02080001
020900                   ,ASGMT.LAST_USD_SEQ_NBR                        02090001
021000              INTO                                                02100001
021100                    :DLT00004-ASGMT-STRT-DTE                      02110001
021200                   ,:DLT00004-ASGMT-NBR-TXT                       02120001
021300                   ,:DLT00004-ASGMT-NBR-SEQ-NBR                   02130001
021400                   ,:DLT00004-ASGMT-STRT-TM                       02140017
021500                   ,:DLT00004-CRE-BY-USR-ID                       02150017
021600                   ,:DLT00004-CRE-BY-PGM-NM                       02160001
021700                   ,:DLT00004-LAST-USD-SEQ-NBR                    02170001
021800                                                                  02180001
021900              FROM  DLT_ASGMT     ASGMT                           02190001
022000                                                                  02200001
022100             WHERE  (ASGMT.WK_TYP_DESC  = :DL004-KEY-WK-TYP       02210041
022200               OR   ASGMT.WK_TYP_DESC = 'MASTCON')                02220041
022210               AND  ASGMT.WK_AREA_DESC = :DL004-KEY-WK-AREA       02221041
022300               AND  ASGMT.DC_NBR       = :DL004-KEY-DC-NBR        02230001
022400               AND  ASGMT.ASGMT_STP_RSN_CDE = :PC-N               02240005
022500         END-EXEC                                                 02250001
022600                                                                  02260001
022700         EVALUATE TRUE                                            02270001
022800             WHEN SQLCODE = ZERO                                  02280001
022900                  SET PS-ONE-WORK-TYPE-FOUND TO TRUE              02290004
023000                                                                  02300001
023100             WHEN SQLCODE = -904                                  02310001
023200             WHEN SQLCODE = -911                                  02320001
023300             WHEN SQLCODE = -913                                  02330001
023400                  CONTINUE                                        02340001
023500                                                                  02350001
023600             WHEN SQLCODE = +100                                  02360001
023700                  SET PS-NO-WORK-TYPE-FOUND TO TRUE               02370004
023800                                                                  02380001
023900             WHEN SQLCODE = -811                                  02390001
024000                  SET PS-MULTIPLE-WORK-TYPE-FOUND TO TRUE         02400001
024100                                                                  02410001
024200             WHEN SQLWARN0 NOT = SPACES                           02420001
024300             WHEN SQLCODE NOT = ZERO                              02430001
024400                  MOVE +4             TO PV-RETRY-COUNTER         02440001
024500         END-EVALUATE                                             02450001
024600     END-PERFORM.                                                 02460001
024700                                                                  02470001
024800     IF SQLCODE = ZERO OR                                         02480001
024900        SQLCODE = +100 OR                                         02490001
025000        SQLCODE = -811                                            02500001
025100        CONTINUE                                                  02510001
025200     ELSE                                                         02520001
025300        IF PV-RETRY-COUNTER > PC-MAX-RETRIES                      02530001
025400           SET DL004-SQL-ERROR TO TRUE                            02540008
025500           MOVE SQLCODE        TO DL004-ASGMT-SQLCODE             02550008
025600           MOVE '3000-'        TO DL004-SQL-ERROR-PARA            02560022
025700           MOVE SQLCA          TO DL004-SQLCA                     02570036
025800        END-IF                                                    02580001
025900     END-IF.                                                      02590001
026000                                                                  02600023
026100****************************************************************  02610023
026200*                                                              *  02620023
026300*                                                              *  02630023
026400****************************************************************  02640023
026500                                                                  02650001
026600 5000-COUNT-BY-WORK-TYPE.                                         02660001
026700                                                                  02670001
026800     PERFORM                                                      02680001
026900         WITH TEST AFTER                                          02690001
027000         VARYING PV-RETRY-COUNTER                                 02700001
027100         FROM 1 BY 1                                              02710001
027200         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  02720001
027300            OR SQLCODE = ZERO                                     02730001
027400            OR SQLCODE = +100                                     02740001
027500                                                                  02750001
027600         EXEC SQL                                                 02760001
027700             SELECT COUNT (*)                                     02770001
027800                                                                  02780001
027900              INTO  :PV-ASGMT-COUNT                               02790001
028000                                                                  02800001
028100              FROM  DLT_ASGMT    ASGMT                            02810006
028200                                                                  02820001
028300             WHERE  (ASGMT.WK_TYP_DESC  = :DL004-KEY-WK-TYP       02830042
028310                OR   ASGMT.WK_TYP_DESC = 'MASTCON')               02831042
028400               AND  ASGMT.WK_AREA_DESC = :DL004-KEY-WK-AREA       02840001
028500               AND  ASGMT.DC_NBR       = :DL004-KEY-DC-NBR        02850001
028600               AND  ASGMT.ASGMT_STP_RSN_CDE = :PC-N               02860005
028700                                                                  02870001
028800         END-EXEC                                                 02880001
028900                                                                  02890001
029000         EVALUATE TRUE                                            02900001
029100             WHEN SQLCODE = ZERO                                  02910001
029200                  CONTINUE                                        02920010
029300                                                                  02930001
029400             WHEN SQLCODE = +100                                  02940001
029500                  MOVE 0 TO PV-ASGMT-COUNT                        02950010
029600                                                                  02960001
029700             WHEN SQLCODE = -904                                  02970001
029800             WHEN SQLCODE = -913                                  02980001
029900             WHEN SQLCODE = -911                                  02990001
030000                  CONTINUE                                        03000001
030100                                                                  03010001
030200             WHEN SQLWARN0 NOT = SPACES                           03020001
030300             WHEN SQLCODE NOT = ZERO                              03030001
030400                  MOVE +4             TO PV-RETRY-COUNTER         03040001
030500         END-EVALUATE                                             03050001
030600     END-PERFORM.                                                 03060001
030700                                                                  03070001
030800     IF SQLCODE = ZERO OR                                         03080001
030900        SQLCODE = +100                                            03090001
031000        MOVE PV-ASGMT-COUNT TO DL004-ASGMT-ACTV-USR-QTY           03100012
031100     ELSE                                                         03110001
031200        IF PV-RETRY-COUNTER > PC-MAX-RETRIES                      03120001
031300           SET DL004-SQL-ERROR TO TRUE                            03130008
031400           MOVE SQLCODE        TO DL004-ASGMT-SQLCODE             03140008
031500           MOVE '5000-'        TO DL004-SQL-ERROR-PARA            03150022
031600           MOVE SQLCA          TO DL004-SQLCA                     03160036
031700        END-IF                                                    03170001
031800     END-IF.                                                      03180001
031900                                                                  03190023
032000****************************************************************  03200023
032100*                                                              *  03210023
032200*                                                              *  03220023
032300****************************************************************  03230023
032400                                                                  03240001
032500 5400-COUNT-BY-ASGMT.                                             03250001
032600                                                                  03260001
032700     PERFORM                                                      03270001
032800         WITH TEST AFTER                                          03280001
032900         VARYING PV-RETRY-COUNTER                                 03290001
033000         FROM 1 BY 1                                              03300001
033100         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03310001
033200            OR SQLCODE = ZERO                                     03320001
033300            OR SQLCODE = +100                                     03330001
033400                                                                  03340001
033500         EXEC SQL                                                 03350001
033600            SELECT  COUNT(*)                                      03360001
033700                                                                  03370001
033800              INTO  :PV-WORK-TYPE-COUNT                           03380001
033900                                                                  03390001
034000              FROM  DLT_TEM_ASGMT     TEM                         03400002
034100                                                                  03410001
034200             WHERE  TEM.ASGMT_STRT_DTE    =                       03420001
034300                                  :DLT00004-ASGMT-STRT-DTE        03430003
034400               AND  TEM.ASGMT_NBR_SEQ_NBR =                       03440001
034500                                  :DLT00004-ASGMT-NBR-SEQ-NBR     03450003
034600               AND  TEM.ASGMT_NBR_TXT     =                       03460001
034700                                  :DLT00004-ASGMT-NBR-TXT         03470003
034800               AND  TEM.LVE_RSN_CDE = :PC-N                       03480005
034900                                                                  03490001
035000         END-EXEC                                                 03500001
035100                                                                  03510001
035200         EVALUATE TRUE                                            03520001
035300             WHEN SQLCODE = ZERO                                  03530001
035400                  CONTINUE                                        03540010
035500                                                                  03550010
035600             WHEN SQLCODE = +100                                  03560010
035700                  MOVE 0 TO PV-WORK-TYPE-COUNT                    03570010
035800                                                                  03580001
035900             WHEN SQLCODE = -904                                  03590001
036000             WHEN SQLCODE = -913                                  03600001
036100             WHEN SQLCODE = -911                                  03610001
036200                  CONTINUE                                        03620001
036300                                                                  03630001
036400             WHEN SQLWARN0 NOT = SPACES                           03640001
036500             WHEN SQLCODE NOT = ZERO                              03650001
036600                  MOVE +4             TO PV-RETRY-COUNTER         03660001
036700         END-EVALUATE                                             03670001
036800     END-PERFORM.                                                 03680001
036900                                                                  03690010
037000     IF SQLCODE = ZERO OR                                         03700010
037100        SQLCODE = +100                                            03710010
037200        MOVE PV-WORK-TYPE-COUNT TO DL004-ASGMT-ACTV-USR-QTY       03720012
037300     ELSE                                                         03730010
037400        SET DL004-SQL-ERROR TO TRUE                               03740008
037500        MOVE SQLCODE        TO DL004-ASGMT-SQLCODE                03750008
037600        MOVE '5400-'        TO DL004-SQL-ERROR-PARA               03760022
037700        MOVE SQLCA          TO DL004-SQLCA                        03770036
037800     END-IF.                                                      03780001
037900                                                                  03790001
038000                                                                  03800001
038100                                                                  03810001
