000100****************************************************************  00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300****************************************************************  00030000
000400 PROGRAM-ID.    TMKUP501.                                         00040024
000500 AUTHOR.        THERESE RAMSEYER.                                 00050000
000600                                                                  00060000
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070025
000800 DATE-WRITTEN.  JANUARY 2005.                                     00080025
000900 DATE-COMPILED.                                                   00090025
001000                                                                  00100025
001100 ENVIRONMENT DIVISION.                                            00110025
001200 CONFIGURATION SECTION.                                           00120025
001300 SOURCE-COMPUTER. IBM-3090.                                       00130025
001400 OBJECT-COMPUTER. IBM-3090.                                       00140025
001500                                                                  00150025
001600****************************************************************  00160025
001700* !!!!!!!!!!!!!     I M P O R T A N T   !!!!!!!!!!!!!!!!!!     *  00170025
001800* THIS MODULE CAN BE ACCESSED FROM BOTH BATCH AND CICS, SO     *  00180025
001900* IT MUST BE COMPILED FOR BOTH ENVIRONMENTS.                   *  00190025
002000****************************************************************  00200025
002100*  THIS PROGRAM WILL EITHER INSERT A NEW ROW INTO THE DB2      *  00210041
002200*  RCT_AUTOACKNL_TRBL, OR IT WILL UPDATE A CURRENT ROW ON      *  00220041
002300*  THE SAME TABLE - CHANGING THE STATUS TO CMPLT, FAIL OR      *  00230041
002400*  ERROR.  THE SUPPORT TEAM WILL LOOK AT THE ERROR ROWS        *  00240041
002500*  AND DECIDE HOW TO HANDLE THEM OR PUT BACK INTO 'WAIT'       *  00250041
002600*  STATUS. THIS PROGRAM IS CALLED FROM TMKUT500.               *  00260041
002700****************************************************************  00270025
002800 DATA DIVISION.                                                   00280025
002900 WORKING-STORAGE SECTION.                                         00290025
003000                                                                  00300000
003100 01  PV-PROGRAM-VARIABLES.                                        00310000
003300     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO       00330032
003400                                                  COMP SYNC.      00340032
003500                                                                  00350000
003600 01  PC-PROGRAM-CONSTANTS.                                        00360000
003700     05  PC-MAX-RETRIES                  PIC S9(4) VALUE +3       00370031
003800                                                   COMP SYNC.     00380031
003900     05  PC-DEFAULT-TMST                 PIC  X(26)  VALUE        00390015
004000         '9999-09-09-09.09.09.999999'.                            00400038
004100     05  PC-CURRENT-PROGRAM-NAME         PIC  X(08)  VALUE        00410000
004200         'TMKUP501'.                                              00420024
004300                                                                  00430000
004400 01  PS-PROGRAM-SWITCHES.                                         00440000
004500     05  PS-UPDATE-SW                  PIC  X(01)    VALUE 'N'.   00450025
004600         88  PS-UPDATE-COMPLETE-YES                  VALUE 'Y'.   00460025
004700         88  PS-UPDATE-COMPLETE-NO                   VALUE 'N'.   00470025
004800     05  PS-INSERT-SW                  PIC  X(01)    VALUE 'N'.   00480025
004900         88  PS-INSERT-COMPLETE-YES                  VALUE 'Y'.   00490025
005000         88  PS-INSERT-COMPLETE-NO                   VALUE 'N'.   00500025
005100                                                                  00510000
005200*                                                                 00520000
005300*  DCLGEN FOR THE DB2 AUTO ACKNOWLEDGE TROUBLE TABLE              00530000
005400*  RCT_AUTOACKNL_TRBL                                             00540003
005500*                                                                 00550000
005600     EXEC SQL                                                     00560000
005700          INCLUDE RCT00020                                        00570000
005800     END-EXEC.                                                    00580000
005900                                                                  00590000
006000*                                                                 00600000
006100*  COPY BOOK FOR DB2 FORMATTED MESSAGE AREA                       00610000
006200*                                                                 00620000
006300     COPY DPWS004.                                                00630000
006400                                                                  00640000
006500*                                                                 00650000
006600*                                                                 00660000
006700*  COMMUNICATION AREAS FOR DB2                                    00670000
006800*                                                                 00680000
006900     EXEC SQL                                                     00690000
007000         INCLUDE SQLCA                                            00700000
007100     END-EXEC.                                                    00710000
007200                                                                  00720000
007300                                                                  00730030
007400 LINKAGE SECTION.                                                 00740030
007500     COPY TMRD007.                                                00750030
007600                                                                  00760030
007700******************************************************************00770000
007800 PROCEDURE DIVISION USING TM007-COMMUNICATIONS-AREA.              00780029
007900******************************************************************00790000
008000******************************************************************00800002
008100*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.  *00810002
008200******************************************************************00820002
008300 0000-PROGRAM-MAINLINE.                                           00830002
008400                                                                  00840002
008410     MOVE PC-CURRENT-PROGRAM-NAME   TO TM007-CALLED-MODULE.       00841043
008420                                                                  00842042
008500     PERFORM 2000-PROCESS                                         00850025
008600                                                                  00860002
008700     GOBACK.                                                      00870025
008800                                                                  00880002
008900******************************************************************00890002
009000** EITHER PERFORM AN INSERT OR UPDATE DEPENDING UPON THE REQUEST**00900028
009100******************************************************************00910002
009200 2000-PROCESS.                                                    00920028
009300                                                                  00930002
009400     IF TM007-UPDATE                                              00940026
009500        PERFORM 7000-UPDATE                                       00950002
009600     END-IF.                                                      00960026
009700                                                                  00970026
009800     IF TM007-INSERT                                              00980026
009900        PERFORM 7100-INSERT                                       00990002
010000     END-IF.                                                      01000002
010100                                                                  01010002
010200******************************************************************01020000
010300**  UPDATE THE STATUS CODE (EITHER CMPLT, FAIL OR ERROR)        **01030039
010400******************************************************************01040000
010500 7000-UPDATE.                                                     01050002
010700     MOVE '7000-UPDATE'  TO TM007-RETURNED-PARA.                  01070034
011000                                                                  01100002
011100     PERFORM WITH TEST AFTER                                      01110031
011200         VARYING PV-RETRY-COUNTER  FROM 1 BY 1                    01120031
011300         UNTIL   SQLCODE = +0 OR                                  01130031
011400                 PV-RETRY-COUNTER > PC-MAX-RETRIES                01140031
011500                                                                  01150031
011600        EXEC SQL                                                  01160031
011700          UPDATE RCT_AUTOACKNL_TRBL                               01170031
011800          SET AUTOACKNL_STAT_CDE  = :TM007-STATUS-IND             01180031
011810             ,AUTOACKNL_END_TMST  = CURRENT TIMESTAMP             01181039
011900          WHERE NOTIF_NBR         = :TM007-NOTIF-NBR              01190031
012000        END-EXEC                                                  01200031
012100                                                                  01210002
012200        EVALUATE TRUE                                             01220031
012300            WHEN SQLCODE = +0                                     01230031
012400                SET TM007-CALL-SUCCESSFUL TO TRUE                 01240035
012500            WHEN SQLCODE = -904                                   01250031
012600            WHEN SQLCODE = -911                                   01260031
012700            WHEN SQLCODE = -913                                   01270031
012800                SET TM007-SQL-CONTENTION  TO TRUE                 01280040
012900                MOVE SQLCODE              TO TM007-SQLCODE        01290031
013000                MOVE SQLCA                TO TM007-SQLCA          01300031
013100            WHEN SQLWARN0 NOT EQUAL SPACE                         01310031
013200                SET TM007-SQL-UNRECOVERABLE-ERROR  TO TRUE        01320040
013300                MOVE SQLCODE              TO TM007-SQLCODE        01330033
013400                MOVE SQLCA                TO TM007-SQLCA          01340033
013500            WHEN OTHER                                            01350031
013600                SET TM007-SQL-UNRECOVERABLE-ERROR  TO TRUE        01360040
013700                MOVE SQLCODE              TO TM007-SQLCODE        01370031
013800                MOVE SQLCA                TO TM007-SQLCA          01380031
013900        END-EVALUATE                                              01390031
014000     END-PERFORM.                                                 01400031
014100                                                                  01410002
014200******************************************************************01420002
014300**  INSERT A NEW ROW INTO RCT_AUTOACKNL_TRBL                    **01430002
014400******************************************************************01440002
014500 7100-INSERT.                                                     01450002
014700     MOVE '7100-INSERT'  TO TM007-RETURNED-PARA.                  01470034
015000                                                                  01500019
015100     INITIALIZE DCLRCT00020.                                      01510003
015200                                                                  01520003
015300     MOVE TM007-NOTIF-NBR       TO RCT00020-NOTIF-NBR.            01530026
015400     MOVE TM007-STATUS-IND      TO RCT00020-AUTOACKNL-STAT-CDE.   01540026
015500     MOVE PC-DEFAULT-TMST       TO RCT00020-AUTOACKNL-END-TMST.   01550026
015600                                                                  01560002
015700     PERFORM WITH TEST AFTER                                      01570031
015800         VARYING PV-RETRY-COUNTER  FROM 1 BY 1                    01580031
015900         UNTIL   SQLCODE = +0 OR                                  01590031
016000                 SQLCODE = +100 OR                                01600036
016100                 PV-RETRY-COUNTER > PC-MAX-RETRIES                01610031
016200                                                                  01620031
016300        EXEC SQL                                                  01630031
016400            INSERT INTO RCT_AUTOACKNL_TRBL                        01640031
016500                (  NOTIF_NBR                                      01650031
016600                 , AUTOACKNL_STAT_CDE                             01660031
016700                 , AUTOACKNL_BEG_TMST                             01670031
016800                 , AUTOACKNL_END_TMST                             01680031
016900                )                                                 01690031
017000               VALUES                                             01700031
017100                ( :RCT00020-NOTIF-NBR                             01710031
017200                 ,:RCT00020-AUTOACKNL-STAT-CDE                    01720031
017300                 , CURRENT TIMESTAMP                              01730031
017400                 ,:RCT00020-AUTOACKNL-END-TMST                    01740031
017500                )                                                 01750031
017600        END-EXEC                                                  01760031
017700                                                                  01770031
017800        EVALUATE TRUE                                             01780031
017900            WHEN SQLCODE = +0                                     01790031
018000                SET TM007-CALL-SUCCESSFUL TO TRUE                 01800035
018100            WHEN SQLCODE = +100                                   01810036
018200                IF TM007-ERROR-STATUS                             01820037
018300                   SET TM007-CALL-SUCCESSFUL TO TRUE              01830036
018700                ELSE                                              01870036
018710                   SET TM007-SQL-UNRECOVERABLE-ERROR  TO TRUE     01871040
018720                   MOVE SQLCODE              TO TM007-SQLCODE     01872036
018730                   MOVE SQLCA                TO TM007-SQLCA       01873036
018800                END-IF                                            01880036
018900            WHEN SQLCODE = -904                                   01890031
019000            WHEN SQLCODE = -911                                   01900031
019100            WHEN SQLCODE = -913                                   01910031
019200                SET TM007-SQL-CONTENTION  TO TRUE                 01920040
019300                MOVE SQLCODE              TO TM007-SQLCODE        01930031
019400                MOVE SQLCA                TO TM007-SQLCA          01940031
019500            WHEN SQLWARN0 NOT EQUAL SPACE                         01950031
019600                SET TM007-SQL-UNRECOVERABLE-ERROR  TO TRUE        01960040
019700                MOVE SQLCODE              TO TM007-SQLCODE        01970033
019800                MOVE SQLCA                TO TM007-SQLCA          01980033
019900            WHEN OTHER                                            01990031
020000                SET TM007-SQL-UNRECOVERABLE-ERROR  TO TRUE        02000040
020100                MOVE SQLCODE              TO TM007-SQLCODE        02010031
020200                MOVE SQLCA                TO TM007-SQLCA          02020031
020300        END-EVALUATE                                              02030031
020400     END-PERFORM.                                                 02040031
020500                                                                  02050031
