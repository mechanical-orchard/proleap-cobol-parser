000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SUKUT196.                                00050000
000600 AUTHOR.                 DENISE HAHN.                             00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            SEPTEMBER, 2018.                         00080000
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001100*                                                               * 00110000
001200*  THIS PROGRAM WILL CREATE AN EXTRACT FILE CONTAINING PO       * 00120000
001300*  AUDIT EXCEPTION ROWS TO BE DELETED.                          * 00130000
001400*   -  FOR CANCELLED PO'S > X DAYS  (TKRPRPM AUEXP1)            * 00140001
001410*   -  FOR COMPLETED PO'S > X DAYS  (TKRPRPM AUEXP2)            * 00141001
001420*   -  FOR PO'S THAT HAVE BEEN PURGED FROM TPURCHS              * 00142000
001430*  EXTRACT FILE WILL BE USED BY NEXT PROGRAM TO DO THE ACTUAL   * 00143000
001431*  DELETE.                                                      * 00143100
001440***************************************************************** 00144000
001450***************************************************************** 00145000
001460 ENVIRONMENT DIVISION.                                            00146000
001470***************************************************************** 00147000
001480                                                                  00148000
001490 CONFIGURATION SECTION.                                           00149000
001500                                                                  00150000
001600 SOURCE-COMPUTER.        IBM-3090.                                00160000
001700 OBJECT-COMPUTER.        IBM-3090.                                00170000
001800                                                                  00180000
001900 INPUT-OUTPUT SECTION.                                            00190000
002000                                                                  00200000
002100 FILE-CONTROL.                                                    00210000
002200*                                                                 00220000
002300     SELECT SU-PO-AUD-EXTRACT-FILE                                00230001
002400         ASSIGN TO OUT01.                                         00240000
002500                                                                  00250001
002600***************************************************************** 00260000
002700 DATA DIVISION.                                                   00270000
002800***************************************************************** 00280000
002900*                                                                 00290000
003000 FILE SECTION.                                                    00300000
003100*                                                                 00310000
003200 FD  SU-PO-AUD-EXTRACT-FILE                                       00320001
003300     RECORDING MODE IS F                                          00330000
003400     BLOCK CONTAINS 0  RECORDS.                                   00340000
003500 01  SU-EXTRACT-RECORD               PIC  X(100).                 00350005
003600*                                                                 00360000
003700                                                                  00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900*                                                                 00390000
004000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00400000
004100                                                   COMP SYNC.     00410000
004200*                                                                 00420000
004300 01  PROGRAM-SWITCHES.                                            00430000
004400     05  PS-EOF-CURSOR-SW            PIC  X(01)    VALUE 'N'.     00440001
004500         88  PS-EOF-CSR                            VALUE 'Y'.     00450001
004600         88  PS-NOT-EOF-CSR                        VALUE 'N'.     00460001
005000                                                                  00500000
005100 01  PC-PROGRAM-CONSTANTS.                                        00510000
005200     05  PC-CURRENT-PROGRAM-NAME    PIC  X(08)     VALUE          00520000
005300                                                   'SUKUT196'.    00530000
005400                                                                  00540000
005500 01  PV-PROGRAM-VARIABLES.                                        00550000
005600     05  PV-DISP-CANCEL-PURGE-DAYS   PIC  Z(09).                  00560001
005610     05  PV-DISP-COMPLETE-PURGE-DAYS PIC  Z(09).                  00561001
005700     05  PV-CANCELLED-PURGE-TMST     PIC  X(26).                  00570001
005800     05  PV-CANCELLED-PURGE-DATE     PIC  X(10).                  00580001
005810     05  PV-COMPLETED-PURGE-TMST     PIC  X(26).                  00581001
005820     05  PV-COMPLETED-PURGE-DATE     PIC  X(10).                  00582001
005900                                                                  00590000
006000     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00600000
006100     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00610000
006200     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00620000
006300                                                                  00630000
006400     05  PV-CANCEL-CNT               PIC  9(09)    VALUE ZERO.    00640006
006500     05  PV-COMPLETE-CNT             PIC  9(09)    VALUE ZERO.    00650006
006510     05  PV-NO-PO-CNT                PIC  9(09)    VALUE ZERO.    00651006
006520     05  PV-FETCH-CNT                PIC  9(09)    VALUE ZERO.    00652006
006530     05  PV-PROCESS-CNT              PIC  9(09)    VALUE ZERO.    00653007
006600     05  PV-OUTPUT-CNT               PIC  9(09)    VALUE ZERO.    00660001
006800     05  PV-TOTAL-CNT                PIC  9(09)    VALUE ZERO.    00680000
006900     05  PV-DELETE-TYPE              PIC  X(01)    VALUE SPACE.   00690006
007100                                                                  00710000
007200 01  DK-DB-KEYS.                                                  00720000
007300     05  DK-CANCEL-PURGE-DAYS        PIC S9(09)  COMP.            00730001
007310     05  DK-COMPLETE-PURGE-DAYS      PIC S9(09)  COMP.            00731001
007400                                                                  00740000
007700                                                                  00770000
007900******************************************************************00790000
008000*  OUTPUT RECORD LAYOUT                                           00800001
008100******************************************************************00810000
008200     COPY SURD165.                                                00820001
008300                                                                  00830000
008310******************************************************************00831001
008320*  DB2 FORMATTED MESSAGE AREA                                     00832001
008330******************************************************************00833001
008340     COPY DPWS004.                                                00834001
008350                                                                  00835001
008400******************************************************************00840000
008500*  COPY BOOK FOR THE PARAMETER TABLE                              00850000
008600******************************************************************00860000
008700     EXEC SQL                                                     00870000
008800          INCLUDE TKRPRPM                                         00880000
008900     END-EXEC.                                                    00890000
009000                                                                  00900000
009100******************************************************************00910000
009200*  SUT_PO_AUD_EXC                                                 00920001
009300******************************************************************00930000
009400     EXEC SQL                                                     00940000
009500          INCLUDE SUT00014                                        00950001
009600     END-EXEC.                                                    00960000
009700                                                                  00970000
009800******************************************************************00980000
009900*  TPURCHS                                                        00990001
010000******************************************************************01000000
010100     EXEC SQL                                                     01010000
010200          INCLUDE TPURCHS                                         01020001
010300     END-EXEC.                                                    01030000
010400                                                                  01040000
012600******************************************************************01260000
012700*  DB2 COMMUNICATION AREA                                         01270000
012800******************************************************************01280000
012900     EXEC SQL                                                     01290000
013000         INCLUDE SQLCA                                            01300000
013100     END-EXEC.                                                    01310000
013200                                                                  01320000
013300******************************************************************01330000
013400*  DB2 COMMUNICATION AREA2                                        01340000
013500******************************************************************01350000
013600     COPY SQLCA2.                                                 01360000
013700                                                                  01370000
013800                                                                  01380000
013900     EXEC SQL                                                     01390000
014000       DECLARE EXTRACT-CSR CURSOR FOR                             01400001
014100         SELECT 'A'                                               01410006
014110               ,A.PO_NBR                                          01411006
014200               ,A.PO_LNE_NBR                                      01420001
014210               ,A.PO_PREPK_ID                                     01421001
014220               ,A.OPER_UNT_ID                                     01422001
014230               ,A.AUD_TYP_CDE                                     01423001
014240               ,A.CRE_TMST                                        01424001
014250               ,A.LAST_UPD_TMST                                   01425001
014260               ,A.LAST_UPD_BY_USR_ID                              01426001
014300           FROM SUT_PO_AUD_EXC A                                  01430001
014310              , TPURCHS B                                         01431001
014320          WHERE A.PO_NBR          =  B.PO_NBR                     01432001
014330            AND A.CRE_TMST       <= :PV-COMPLETED-PURGE-TMST      01433001
014340            AND B.VER_STATUS_CDE  = 'A'                           01434001
014350            AND B.RMS_PO_UPD_TMST IN                              01435001
014360                (SELECT MAX(C.RMS_PO_UPD_TMST)                    01436001
014370                   FROM TPURCHS C                                 01437001
014380                  WHERE B.PO_NBR  =  C.PO_NBR)                    01438001
014390            AND B.STATUS_CDE      = 'CM'                          01439001
014391         UNION                                                    01439101
014392         SELECT 'B'                                               01439206
014393              , D.PO_NBR                                          01439306
014394               ,D.PO_LNE_NBR                                      01439406
014395               ,D.PO_PREPK_ID                                     01439506
014396               ,D.OPER_UNT_ID                                     01439606
014397               ,D.AUD_TYP_CDE                                     01439706
014398               ,D.CRE_TMST                                        01439806
014399               ,D.LAST_UPD_TMST                                   01439906
014400               ,D.LAST_UPD_BY_USR_ID                              01440006
014401           FROM SUT_PO_AUD_EXC D                                  01440106
014402               , TPURCHS E                                        01440206
014403          WHERE D.PO_NBR          =  E.PO_NBR                     01440306
014404            AND D.CRE_TMST       <= :PV-CANCELLED-PURGE-TMST      01440406
014405            AND E.VER_STATUS_CDE  = 'A'                           01440506
014406            AND E.RMS_PO_UPD_TMST IN                              01440606
014407                (SELECT MAX(F.RMS_PO_UPD_TMST)                    01440706
014408                   FROM TPURCHS F                                 01440806
014409                  WHERE E.PO_NBR  =  F.PO_NBR)                    01440906
014410            AND E.STATUS_CDE = 'CA'                               01441006
014411         UNION                                                    01441106
014412         SELECT 'C'                                               01441206
014413               ,G.PO_NBR                                          01441306
014414               ,G.PO_LNE_NBR                                      01441406
014415               ,G.PO_PREPK_ID                                     01441506
014416               ,G.OPER_UNT_ID                                     01441606
014417               ,G.AUD_TYP_CDE                                     01441706
014418               ,G.CRE_TMST                                        01441806
014419               ,G.LAST_UPD_TMST                                   01441906
014420               ,G.LAST_UPD_BY_USR_ID                              01442006
014421           FROM SUT_PO_AUD_EXC G                                  01442106
014422          WHERE NOT G.PO_NBR IN                                   01442206
014423               (SELECT DISTINCT H.PO_NBR                          01442306
014424                  FROM TPURCHS H                                  01442406
014425                 WHERE G.PO_NBR  =  H.PO_NBR)                     01442506
014426          ORDER BY 2,3,4,5                                        01442606
014427          WITH UR                                                 01442706
014600     END-EXEC.                                                    01460000
014700                                                                  01470000
015800                                                                  01580000
015900*                                                                 01590000
016000 PROCEDURE DIVISION.                                              01600000
016100                                                                  01610001
016110*----------------------------------------------------------------*01611001
016121*   THIS IS THE MAIN DRIVER FOR THE PROGRAM.                     *01612101
016140*----------------------------------------------------------------*01614001
016200 0000-MAINLINE-PROCESSING.                                        01620000
016600                                                                  01660000
016700     PERFORM 1000-INITIALIZATION.                                 01670000
016800                                                                  01680000
016900     PERFORM 2000-PROCESS-EXTRACT                                 01690001
017000       UNTIL PS-EOF-CSR.                                          01700004
017100                                                                  01710000
017200     PERFORM 2300-CLOSE-EXTRACT-CSR.                              01720001
017300                                                                  01730000
017700                                                                  01770000
017701     DISPLAY '                                 '.                 01770108
017702     DISPLAY 'CANCELLED   :  ' PV-CANCEL-CNT.                     01770208
017703     DISPLAY 'COMPLETE    :  ' PV-COMPLETE-CNT.                   01770308
017704     DISPLAY 'NO PO FOUND :  ' PV-NO-PO-CNT.                      01770408
017710     DISPLAY '                                 '.                 01771001
017800     DISPLAY 'FETCH COUNT :  ' PV-FETCH-CNT.                      01780003
017810     DISPLAY '                                 '.                 01781006
017900     DISPLAY 'OUTPUT COUNT:  ' PV-OUTPUT-CNT.                     01790003
018400     DISPLAY '                                 '.                 01840000
018700                                                                  01870000
018800     CLOSE SU-PO-AUD-EXTRACT-FILE.                                01880001
018900                                                                  01890000
019000     GOBACK.                                                      01900000
019100                                                                  01910000
019200                                                                  01920000
019210*----------------------------------------------------------------*01921001
019220*                                                                *01922001
019230*                                                                *01923001
019240*----------------------------------------------------------------*01924001
019300 1000-INITIALIZATION.                                             01930000
019700                                                                  01970000
019800     OPEN OUTPUT SU-PO-AUD-EXTRACT-FILE.                          01980001
019900                                                                  01990000
019910     DISPLAY '** SUKUT196 **'.                                    01991001
019920     DISPLAY '  '                                                 01992001
019930                                                                  01993001
020000     PERFORM 7000-GET-CANCEL-PURGE-DAYS.                          02000001
020010     PERFORM 7010-GET-COMPLETE-PURGE-DAYS.                        02001001
020100                                                                  02010000
020600     SET  PS-NOT-EOF-CSR  TO  TRUE.                               02060004
020800                                                                  02080000
020900     PERFORM 2100-OPEN-EXTRACT-CSR.                               02090001
021000     PERFORM 2200-FETCH-EXTRACT-CSR.                              02100001
021100                                                                  02110000
021200                                                                  02120000
021300*----------------------------------------------------------------*02130001
021310*                                                                *02131001
021320*                                                                *02132001
021330*----------------------------------------------------------------*02133001
021400 2000-PROCESS-EXTRACT.                                            02140001
021500                                                                  02150000
021700     INITIALIZE  SU165-EXTRACT-RECORD.                            02170001
021800                                                                  02180000
021810     MOVE SUT00014-PO-NBR             TO SU165-PO-NBR.            02181001
021820     MOVE SUT00014-PO-LNE-NBR         TO SU165-PO-LNE-NBR.        02182001
021830     MOVE SUT00014-PO-PREPK-ID        TO SU165-PO-PREPK-ID.       02183001
021840     MOVE SUT00014-OPER-UNT-ID        TO SU165-OPER-UNT-ID.       02184001
021850     MOVE SUT00014-AUD-TYP-CDE        TO SU165-AUD-TYP-CDE.       02185001
021860     MOVE SUT00014-CRE-TMST           TO SU165-CRE-TMST.          02186001
021870     MOVE SUT00014-LAST-UPD-TMST      TO SU165-LAST-UPD-TMST.     02187001
021880     MOVE SUT00014-LAST-UPD-BY-USR-ID TO SU165-LAST-UPD-BY-USR-ID.02188001
022300                                                                  02230000
022900     ADD  1  TO  PV-OUTPUT-CNT                                    02290001
022910     IF  PV-DELETE-TYPE  = 'A'                                    02291006
022920         ADD 1  TO  PV-COMPLETE-CNT                               02292006
023001     ELSE                                                         02300106
023002     IF  PV-DELETE-TYPE  = 'B'                                    02300206
023011         ADD  1  TO  PV-CANCEL-CNT                                02301106
023012     ELSE                                                         02301206
023013     IF  PV-DELETE-TYPE  = 'C'                                    02301306
023020         ADD  1  TO  PV-NO-PO-CNT                                 02302006
023030     END-IF                                                       02303006
023031     END-IF                                                       02303106
023032     END-IF.                                                      02303206
023040                                                                  02304006
023100     PERFORM 8000-WRITE-EXTRACT-RECORD.                           02310001
023800                                                                  02380000
023900     PERFORM 2200-FETCH-EXTRACT-CSR.                              02390001
024000                                                                  02400000
024100                                                                  02410000
024110*----------------------------------------------------------------*02411001
024120*                                                                *02412001
024130*                                                                *02413001
024140*----------------------------------------------------------------*02414001
024200 2100-OPEN-EXTRACT-CSR.                                           02420001
024300     MOVE '2100-OPEN-EXTRACT-CSR' TO PV-ABEND-PARAGRAPH.          02430001
024400                                                                  02440000
024500     EXEC SQL                                                     02450000
024600          OPEN EXTRACT-CSR                                        02460001
024700     END-EXEC.                                                    02470000
024800                                                                  02480000
024900     EVALUATE TRUE                                                02490000
025000         WHEN SQLCODE = 0                                         02500000
025100             CONTINUE                                             02510000
025200         WHEN SQLWARN0 NOT = SPACES                               02520000
025300         WHEN SQLCODE < ZERO                                      02530000
025400         WHEN SQLCODE > ZERO                                      02540000
025500             MOVE '2100-OPEN-EXTRACT-CSR'                         02550001
025600                             TO PV-PARAGRAPH-NAME                 02560000
025700             MOVE 'OPEN THE SML_CURSOR            '               02570000
025800                             TO PV-DB2-OPERATION-ATTEMPTED        02580000
025900             PERFORM 9100-SQL-ABEND                               02590000
026000     END-EVALUATE.                                                02600000
026100                                                                  02610000
026200                                                                  02620000
026210*----------------------------------------------------------------*02621001
026220*                                                                *02622001
026230*                                                                *02623001
026240*----------------------------------------------------------------*02624001
026300 2200-FETCH-EXTRACT-CSR.                                          02630001
026400     MOVE '2200-FETCH-EXTRACT-CSR' TO PV-ABEND-PARAGRAPH.         02640001
026500                                                                  02650000
026600     EXEC SQL                                                     02660000
026700          FETCH EXTRACT-CSR                                       02670001
026800          INTO  :PV-DELETE-TYPE                                   02680006
026810              , :SUT00014-PO-NBR                                  02681006
026900              , :SUT00014-PO-LNE-NBR                              02690001
026910              , :SUT00014-PO-PREPK-ID                             02691001
026920              , :SUT00014-OPER-UNT-ID                             02692001
026930              , :SUT00014-AUD-TYP-CDE                             02693001
026940              , :SUT00014-CRE-TMST                                02694001
026950              , :SUT00014-LAST-UPD-TMST                           02695001
026960              , :SUT00014-LAST-UPD-BY-USR-ID                      02696001
027000     END-EXEC.                                                    02700000
027100                                                                  02710000
027200     EVALUATE TRUE                                                02720000
027300       WHEN SQLCODE = ZEROS                                       02730000
027400            ADD  1  TO  PV-FETCH-CNT                              02740001
027410            ADD  1  TO  PV-PROCESS-CNT                            02741007
027420            IF  PV-PROCESS-CNT  >= 500                            02742007
027430                DISPLAY 'PROCESS CNT :  ' PV-FETCH-CNT            02743007
027440                MOVE ZEROES  TO  PV-PROCESS-CNT                   02744007
027450            END-IF                                                02745007
027500       WHEN SQLCODE = +100                                        02750000
027600            SET PS-EOF-CSR TO TRUE                                02760004
027700       WHEN SQLWARN0 NOT = SPACES                                 02770000
027800       WHEN SQLCODE < ZERO                                        02780000
027900       WHEN SQLCODE > ZERO                                        02790000
028000           MOVE '2200-FETCH-EXTRACT-CSR'                          02800001
028100                               TO PV-PARAGRAPH-NAME               02810000
028200           MOVE 'FETCH SML CURSOR '                               02820000
028300                               TO PV-DB2-OPERATION-ATTEMPTED      02830000
028400           PERFORM 9100-SQL-ABEND                                 02840000
028500     END-EVALUATE.                                                02850000
028600                                                                  02860000
028700                                                                  02870000
028710*----------------------------------------------------------------*02871001
028720*                                                                *02872001
028730*                                                                *02873001
028740*----------------------------------------------------------------*02874001
028800 2300-CLOSE-EXTRACT-CSR.                                          02880001
028900     MOVE '2300-CLOSE-EXTRACT-CSR' TO PV-ABEND-PARAGRAPH.         02890001
029000                                                                  02900000
029100     EXEC SQL                                                     02910000
029200         CLOSE EXTRACT-CSR                                        02920001
029300     END-EXEC.                                                    02930000
029400                                                                  02940000
029500     EVALUATE TRUE                                                02950000
029600         WHEN SQLCODE = ZERO                                      02960000
029700         WHEN SQLCODE = -904                                      02970000
029800         WHEN SQLCODE = -911                                      02980000
029900              CONTINUE                                            02990000
030000         WHEN SQLWARN0 NOT = SPACES                               03000000
030100         WHEN SQLCODE < ZERO                                      03010000
030200         WHEN SQLCODE > ZERO                                      03020000
030300              MOVE '2300-CLOSE-EXTRACT-CSR'                       03030001
030400                              TO PV-PARAGRAPH-NAME                03040000
030500              MOVE 'CLOSE THE EXTRACT-CSR              '          03050001
030600                              TO PV-DB2-OPERATION-ATTEMPTED       03060000
030700              PERFORM 9100-SQL-ABEND                              03070000
030800     END-EVALUATE.                                                03080000
046863                                                                  04686300
046864                                                                  04686400
046865*----------------------------------------------------------------*04686501
046866*                                                                *04686601
046867*                                                                *04686701
046868*----------------------------------------------------------------*04686801
046874 7000-GET-CANCEL-PURGE-DAYS.                                      04687401
046875                                                                  04687501
046876     EXEC SQL                                                     04687601
046877         SELECT  FUNC_QTY                                         04687701
046878              ,  CURRENT TIMESTAMP - FUNC_QTY DAYS                04687801
046879              ,  DATE(CURRENT TIMESTAMP) - FUNC_QTY DAYS          04687901
046880           INTO :DK-CANCEL-PURGE-DAYS                             04688001
046881              , :PV-CANCELLED-PURGE-TMST                          04688101
046882              , :PV-CANCELLED-PURGE-DATE                          04688201
046883           FROM TKRPRPM                                           04688301
046884          WHERE LOC_ID            =  90                           04688401
046885            AND INTFC_SYS_CDE     = 'KHL'                         04688501
046886            AND SYS_PRC_FUNC_CDE  = 'AUEXP1'                      04688601
046887            AND FUNC_PRC_STAT_CDE = 'AC'                          04688701
046888     END-EXEC.                                                    04688801
046889                                                                  04688901
046890     EVALUATE TRUE                                                04689001
046891         WHEN SQLCODE = ZEROS                                     04689101
046892              MOVE  DK-CANCEL-PURGE-DAYS TO                       04689204
046893                                      PV-DISP-CANCEL-PURGE-DAYS   04689304
046894              DISPLAY 'CANCEL PURGE DAYS  :  '                    04689404
046895                                      PV-DISP-CANCEL-PURGE-DAYS   04689504
046896              DISPLAY 'CANCEL PURGE DATE  :  '                    04689604
046897                                      PV-CANCELLED-PURGE-DATE     04689704
046898              DISPLAY 'CANCEL PURGE TMST  :  '                    04689804
046899                                      PV-CANCELLED-PURGE-TMST     04689904
046900              DISPLAY ' '                                         04690004
046901         WHEN SQLCODE = +100                                      04690104
046902              CONTINUE                                            04690204
046903         WHEN SQLWARN0 NOT = SPACES                               04690304
046904         WHEN SQLCODE < ZERO                                      04690404
046905         WHEN SQLCODE > ZERO                                      04690504
046906             MOVE '7000-GET-CANCEL-PURGE-DAYS'                    04690604
046907                             TO PV-PARAGRAPH-NAME                 04690704
046908             MOVE 'GET NUMBER OF DAYS FOR CANCELLED PO PURGE'     04690804
046909                             TO PV-DB2-OPERATION-ATTEMPTED        04690904
046910             PERFORM 9100-SQL-ABEND                               04691004
046911     END-EVALUATE.                                                04691104
046912                                                                  04691204
046913                                                                  04691304
046918                                                                  04691801
046919*----------------------------------------------------------------*04691901
046920*                                                                *04692001
046921*                                                                *04692101
046922*----------------------------------------------------------------*04692201
046923 7010-GET-COMPLETE-PURGE-DAYS.                                    04692301
046930                                                                  04693001
046940     EXEC SQL                                                     04694001
046950         SELECT  FUNC_QTY                                         04695001
046960              ,  CURRENT TIMESTAMP - FUNC_QTY DAYS                04696001
046970              ,  DATE(CURRENT TIMESTAMP) - FUNC_QTY DAYS          04697001
046980           INTO :DK-COMPLETE-PURGE-DAYS                           04698001
046990              , :PV-COMPLETED-PURGE-TMST                          04699001
047000              , :PV-COMPLETED-PURGE-DATE                          04700001
047001           FROM TKRPRPM                                           04700101
047002          WHERE LOC_ID            =  90                           04700201
047003            AND INTFC_SYS_CDE     = 'KHL'                         04700301
047004            AND SYS_PRC_FUNC_CDE  = 'AUEXP2'                      04700401
047005            AND FUNC_PRC_STAT_CDE = 'AC'                          04700501
047006     END-EXEC.                                                    04700601
047007                                                                  04700701
047008     EVALUATE TRUE                                                04700801
047009         WHEN SQLCODE = ZEROS                                     04700901
047010              MOVE  DK-COMPLETE-PURGE-DAYS TO                     04701004
047011                                      PV-DISP-COMPLETE-PURGE-DAYS 04701104
047012              DISPLAY 'COMPLETE PURGE DAYS:  '                    04701204
047013                                      PV-DISP-COMPLETE-PURGE-DAYS 04701304
047014              DISPLAY 'COMPLETE PURGE DATE:  '                    04701404
047015                                      PV-COMPLETED-PURGE-DATE     04701504
047016              DISPLAY 'COMPLETE PURGE TMST:  '                    04701604
047017                                      PV-COMPLETED-PURGE-TMST     04701704
047018              DISPLAY ' '                                         04701804
047019         WHEN SQLCODE = +100                                      04701904
047020              CONTINUE                                            04702004
047021         WHEN SQLWARN0 NOT = SPACES                               04702104
047022         WHEN SQLCODE < ZERO                                      04702204
047023         WHEN SQLCODE > ZERO                                      04702304
047024             MOVE '7010-GET-COMPLETE-PURGE-DAYS'                  04702404
047025                             TO PV-PARAGRAPH-NAME                 04702504
047026             MOVE 'GET NUMBER OF DAYS FOR COMPLETED PO PURGE'     04702604
047027                             TO PV-DB2-OPERATION-ATTEMPTED        04702704
047028             PERFORM 9100-SQL-ABEND                               04702804
047029     END-EVALUATE.                                                04702904
047030                                                                  04703001
047031                                                                  04703101
047032                                                                  04703201
047033*----------------------------------------------------------------*04703301
047034*                                                                *04703401
047035*                                                                *04703501
047036*----------------------------------------------------------------*04703601
047037 8000-WRITE-EXTRACT-RECORD.                                       04703701
047040     WRITE SU-EXTRACT-RECORD                                      04704005
047050       FROM SU165-EXTRACT-RECORD.                                 04705001
047060                                                                  04706001
047070                                                                  04707001
047071*----------------------------------------------------------------*04707101
047072*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL   *04707201
047073*  ERROR OR WARNING CODE OCCURS.                                 *04707301
047074*----------------------------------------------------------------*04707401
047080 9100-SQL-ABEND.                                                  04708001
047400     DISPLAY '9100-SQL-ABEND'.                                    04740001
047500     DISPLAY '** ABEND     **'.                                   04750001
047600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04760001
047700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04770001
047800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     04780001
047900                                                                  04790001
048000******************************************************************04800001
048100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04810001
048200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04820001
048300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04830001
048400* FORMAT.                                                         04840001
048500******************************************************************04850001
048600     COPY DPPD004.                                                04860001
048700                                                                  04870001
048800     MOVE +4013                  TO ABEND-CODE.                   04880001
048900     CALL 'ILBOABN0' USING ABEND-CODE.                            04890001
049000                                                                  04900001
