000100*----------------------------------------------------------       00010003
000200 IDENTIFICATION DIVISION.                                         00020003
000300*----------------------------------------------------------       00030003
000400 PROGRAM-ID.    XSKUP031.                                         00040003
000500 AUTHOR.        ALEXIS KEIKER.                                    00050003
000600 DATE-WRITTEN.  OCTOBER 1, 2002.                                  00060003
000700                                                                  00070003
000800*----------------------------------------------------------       00080003
000900*            PROMOTION BUSINESS EVENT LOADER                      00090003
001000*----------------------------------------------------------       00100003
001100* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00110007
001101* LOAD FOR THE PROMOTION BUSINESS EVENT.  THIS PROGRAM IS         00120007
001102* A MODULE AND WILL BE CALLED BY ANOTHER PROGRAM(XSKUT034).       00130014
001103* THERE ARE 5 PARAMETERS PASSED IN THIS PROGRAM.  ONE WILL        00140007
001104* BE THE ACTUAL PROMOTION BUSINESS EVENT RECORD, MAXIMUM FUTURE   00150007
001105* OFFSET DATE IN CCYYMMDD, A LOAD SQL RETURN CODE FIELD, A        00160007
001106* PROGRAM STATUS CODE, AND A LOAD SEVERITY LEVEL.  THIS PROGRAM   00170007
001107* WILL EITHER UPDATE OR INSERT A RECORD TO THE XST_PROMO          00180007
001108* (PROMOTION TABLE).  THIS PROGRAM WILL ALWAYS SEND               00190007
001109* BACK A LOAD SQL RETURN CODE, A PROGRAM STATUS CODE AND A        00200007
001110* LOAD SEVERITY CODE.  IF THE PROGRAM DOES NOT UPDATE OR          00210007
001111* INSERT THE RECORD CORRECTLY IT WILL SELECT THE CORRECT          00220007
001112* ERROR CODES, FIND THE LOAD SEVERITY LEVEL, AND EXIT OUT OF      00230007
001113* THE PROGRAM.                                                    00240007
001114*                                                                 00250007
001115*          SQL CODES - LOAD SQL RETURN CODE                       00260007
001116*             - THIS IS THE LAST SQL RETURN CODE RECEIVED         00270003
001117*               FROM A DATABASE ACTION.                           00280003
001118*                                                                 00290003
001119*          PROGRAM CODES - PROGRAM STATUS CODE                    00300007
001120*           - 00 - ALL DATABASE ACTION WAS SUCCESSFUL AND         00310003
001121*                  WORKED ACCORDING TO THE MESSAGE TYPE.          00320003
001122*           - 01 - AN 'ADD' RECORD WAS TURNED INTO AN             00330003
001123*                  UPDATE AND THE BUSINESS EVENT WAS FOUND        00340003
001124*                  TO BE THE ONE NEEDED ON THE DATABASE.          00350003
001125*           - 02 - AN 'ADD' RECORD WAS TURNED INTO AN UPDATE      00360003
001126*                  AND THE BUSINESS EVENT WAS FOUND TO BE         00370003
001127*                  THE ONE NOT NEEDED ON THE DATABASE.            00380003
001128*           - 03 - AN 'UPDATE' RECORD WAS TURNED INTO AN ADD.     00390003
001129*           - 04 - AN 'UPDATE' RECORD WAS BYPASSED BECAUSE THE    00400011
001130*                  RECORD CURRENTLY ON THE DATABASE WAS THE       00410011
001131*                  MOST RECENT DATA.                              00420011
001132*           - 05 - THE DATABASE ACTION WAS NOT SUCCESSFUL DUE     00430011
001133*                  TO THE RETURNED SQL CODE.                      00440003
001134*           - 06 - UNEXPECTED ACTION CODE RECEIVED.               00450011
001135*                                                                 00460003
001136*          ERROR CODES - LOAD SEVERITY LEVEL                      00470003
001137*            THIS CODE IS FOUND BY TAKING THE MAXIMUM OFFSET      00480007
001138*            DATE AND COMPARING IT TO THE PROMOTION START         00490007
001139*            DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN       00500007
001140*            THE PROMOTION START DATE THE LOAD IS NOT CRITICAL,   00510007
001141*            OTHERWISE IT IS CRITICAL TO THE SYSTEM.              00520007
001142*           - 00 - THE LOAD OF THE DATA WAS SUCCESSFUL AND        00530007
001143*                  THEREFORE THE SEVERITY OF THE LOAD DID         00540007
001144*                  NOT NEED TO BE DETERMINED.                     00550007
001145*           - 01 - THE LOAD IS CRITICAL TO A SYSTEM AND           00560003
001146*                  THEREFORE MUST BE RESOLVED ASAP.               00570003
001147*           - 02 - THE LOAD IS NOT CRITICAL AND THEREFORE CAN     00580003
001148*                  WAIT UNTIL A LATER TIME TO BE RESOLVED.        00590003
001149*                                                                 00600003
001150*----------------------------------------------------------       00610003
001151* HISTORY LOG:                                                    00620003
001152*                                                                 00630003
001153*----------------------------------------------------------       00640003
0410  * DATE:        04/10/2010                                         00650077
0410  * WR/IR#:      WR38306                                            00660077
0410  * PROGRAMMER:  JIM ARENDT                                         00670040
0410  * DESCRIPTION: AS PART OF THE E-SIGN CORPORATE PROJECT, CHANGED   00680077
0410  *              THE PROGRAM TO CALL NEW PROGRAM XSKUP133 IF INPUT  00690087
0410  *              PROMO-TYP-CDE = 'R'(REGULAR) AND STAT-CDE = 'S'    00700087
0410  *              (SCHEDULED).                                       00710082
001159*----------------------------------------------------------       00720038
W37916* DATE:        04/19/2011                                         00730098
W37916* WR/IR#:      WR37916                                            00740098
W37916* PROGRAMMER:  JIM HUNTER                                         00750098
W37916* DESCRIPTION: AS PART OF THE E-SIGN POST PILOT PROJECT, CHANGED  00760098
W37916*              THE PROGRAM TO IDENTIFY WHEN A PROMO NAME CHANGE   00770098
W37916*              IS MADE.  WHEN ONE IS AND THE NAME CHANGE RESULTS  00780098
W37916*              IN A PROMO TYPE ID CHANGE, ALL SIGNS AND TOPPERS   00790098
W37916*              FOR THE PROMO MUST BE UPDATED.                     00800098
W37916*              THESE CHANGES WILL NOT IMPACT THE 3 RETURN CODES   00810099
W37916*              PASSED BACK TO XSKUT034.  INSTEAD, DISPLAYS WILL   00820099
W37916*              INDICATE WHEN PROMO NAME CHANGES HAVE SUCCEEDED    00830099
W37916*              OR FAILED.                                         00840099
W37916*----------------------------------------------------------       00850098
001160 ENVIRONMENT DIVISION.                                            00860038
001161*----------------------------------------------------------       00870038
001162 CONFIGURATION SECTION.                                           00880038
001163 SOURCE-COMPUTER. IBM-3090.                                       00890038
001164 OBJECT-COMPUTER. IBM-3090.                                       00900038
001165                                                                  00910038
001166 INPUT-OUTPUT SECTION.                                            00920038
001167                                                                  00930038
001170 FILE-CONTROL.                                                    00940005
001180                                                                  00950005
001190*----------------------------------------------------------       00960005
001200 DATA DIVISION.                                                   00970005
001300*----------------------------------------------------------       00980005
001400 FILE SECTION.                                                    00990005
001500                                                                  01000005
001600                                                                  01010005
001700*---------------------------------------------------------        01020005
001800                                                                  01030005
001900 WORKING-STORAGE SECTION.                                         01040005
002000*---------------------------------------------------------        01050005
002100* PC- PROGRAM CONSTANTS                                           01060005
002200*----------------------------------------------------------       01070005
002300 01  PC-PROGRAM-CONSTANTS.                                        01080005
002400     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XSKUP031'. 01090005
0410       05  PC-CALLED-PROGRAM            PIC X(08) VALUE 'XSKUP133'. 01100055
002500     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   01110005
002600                                                                  01120005
002700*----------------------------------------------------------       01130005
002800* PS- PROGRAM SWITCHES                                            01140039
002900*----------------------------------------------------------       01150005
003000 01  PS-PROGRAM-SWITCHES.                                         01160005
003100     05  PS-PROCESS-CONTINUE-SW       PIC X(01)  VALUE 'Y'.       01170005
003200         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       01180005
003300         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       01190005
W37916     05  PS-TIMESTAMP-SW              PIC X(01)  VALUE 'N'.       01200099
W37916         88  PS-TIMESTAMP-FORMATTED              VALUE 'Y'.       01210099
W37916         88  PS-TIMESTAMP-FAILED                 VALUE 'N'.       01220099
W37916*    05  PS-PROMO-NAME-CHANGE-SW      PIC X(01)  VALUE 'N'.       01230099
W37916*        88  PS-PROMO-NAME-CHANGE-FOUND          VALUE 'Y'.       01240099
W37916*        88  PS-PROMO-NAME-CHANGE-NOT-FOUND      VALUE 'N'.       01250099
0410       05  PS-CALL-XSKUP133-SW          PIC X(01)  VALUE 'N'.       01260066
0410           88  PS-NO-CALL-XSKUP133                 VALUE 'N'.       01270066
0410           88  PS-CALL-XSKUP133                    VALUE 'Y'.       01280066
0410       05  PS-INSERT-SW                 PIC X(01)  VALUE 'N'.       01290067
0410           88  PS-INSERT-NO                        VALUE 'N'.       01300067
0410           88  PS-INSERT-OK                        VALUE 'Y'.       01310067
0410       05  PS-UPDATE-SW                 PIC X(01)  VALUE 'N'.       01320067
0410           88  PS-UPDATE-NO                        VALUE 'N'.       01330067
0410           88  PS-UPDATE-OK                        VALUE 'Y'.       01340067
W37916*    05  PS-END-OF-TSIESGN-CURSOR     PIC  X(01) VALUE 'N'.       01350099
W37916*        88  PS-EOF-TSIESGN-CSR                  VALUE 'Y'.       01360099
W37916*        88  PS-NOT-EOF-TSIESGN-CSR              VALUE 'N'.       01370099
W37916*    05  PS-SGN-PRECEDENCE-SW         PIC X(01)  VALUE 'N'.       01380099
W37916*        88  PS-SGN-PRECEDENCE-NOT-FOUND         VALUE 'N'.       01390099
W37916*        88  PS-SGN-PRECEDENCE-FOUND             VALUE 'Y'.       01400099
W37916*    05  PS-TOPR-ASGMT-ID-SW          PIC X(01)  VALUE 'N'.       01410099
W37916*        88  PS-TOPR-ASGMT-ID-NOT-FOUND          VALUE 'N'.       01420099
W37916*        88  PS-TOPR-ASGMT-ID-FOUND              VALUE 'Y'.       01430099
003400                                                                  01440005
003500*----------------------------------------------------------       01450005
003600* PV- PROGRAM VARIABLES                                           01460005
003700*----------------------------------------------------------       01470005
003800 01 PV-PROGRAM-VARIABLES.                                         01480005
003900    05  PV-SQL-SUB                    PIC S9(4)  VALUE +0 COMP.   01490005
003910    05  PV-SQL-CODE                   PIC S9(4)  VALUE +0.        01500025
004000    05  PV-MAX-OFFSET-DTE             PIC 9(08)  VALUE 0.         01510005
004100    05  PV-LAST-UPD-TMST              PIC X(26)  VALUE SPACES.    01520005
W37916    05  PV-CURRENT-TIMESTAMP          PIC X(26)  VALUE SPACES.    01530099
W37916    05  FILLER  REDEFINES PV-CURRENT-TIMESTAMP.                   01540099
W37916        10  PCT-DATE                  PIC X(10).                  01550099
W37916        10  PCT-TIME                  PIC X(10).                  01560099
W37916        10  PCT-MILLI-SECONDS         PIC X(6).                   01570099
W37916    05  PV-PROMO-NM                   PIC X(40)  VALUE SPACES.    01580099
W37916    05  PV-OLD-PROMO-NM               PIC X(40)  VALUE SPACES.    01590099
W37916    05  PV-OLD-PROMO-TYP-ID           PIC S9(10) COMP-3 VALUE 0.  01600099
W37916*   05  PV-NEW-PROMO-TYP-ID           PIC S9(10) COMP-3 VALUE 0.  01610099
W37916    05  PV-OLD-PROMO-LVL-CDE          PIC X(3)   VALUE SPACES.    01620099
W37916*   05  PV-NEW-PROMO-LVL-CDE          PIC X(3)   VALUE SPACES.    01630099
W37916    05  PV-TOTAL-SIGNS-READ           PIC 9(5)   VALUE ZEROES.    01640099
W37916    05  PV-TOTAL-SIGNS-UPDATED        PIC 9(5)   VALUE ZEROES.    01650099
W37916    05  PV-TOTAL-TOPPERS-UPDATED      PIC 9(5)   VALUE ZEROES.    01660099
W37916    05  PV-UPDATE-COUNT               PIC 9(5)   VALUE ZEROES.    01670099
004220    05  PV-ACTION-CODE                PIC X(01).                  01680005
004230        88  PV-INSERT-DATA                       VALUE 'I'.       01690005
004240        88  PV-UPDATE-DATA                       VALUE 'U'.       01700005
004250    05  PV-LD-STATUS-CDE              PIC X(02).                  01710005
004260        88  PV-NO-ERROR                          VALUE '00'.      01720006
004270        88  PV-CRITICAL-ERROR                    VALUE '01'.      01730005
004280        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      01740005
004290    05  PV-PGM-STATUS-CDE             PIC X(02).                  01750005
004300        88  PV-SUCCESS-CDE                       VALUE '00'.      01760005
004400        88  PV-UPDATE-NEED                       VALUE '01'.      01770005
004500        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      01780005
004600        88  PV-ADD-CDE                           VALUE '03'.      01790005
004610        88  PV-UPDATE-BYPASS                     VALUE '04'.      01800011
004700        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      01810011
004800        88  PV-UNEXPECT-CDE                      VALUE '06'.      01820011
0410      05  PV-MESSAGE-RECORD.                                        01830055
0410          10  PV-BUS-EVNT-ID            PIC  X(03)  VALUE SPACES.   01840055
0410          10  FILLER                    PIC  X(297) VALUE SPACES.   01850055
004900                                                                  01860005
004910    05  PV-NULLS-INDICATORS.                                      01870016
004920        10  PV-AD-EVNT-ID-IND         PIC S9(4) COMP VALUE +0.    01880016
004930        10  PV-ADV-CDE-IND            PIC S9(4) COMP VALUE +0.    01890016
004940        10  PV-TYP-CDE-IND            PIC S9(4) COMP VALUE +0.    01900016
004950        10  PV-PROMO-NM-IND           PIC S9(4) COMP VALUE +0.    01910016
004960        10  PV-ABBR-NM-IND            PIC S9(4) COMP VALUE +0.    01920016
004961        10  PV-ESL-TOPR-IND           PIC S9(4) COMP VALUE +0.    01930049
W37916        10  PV-PROMO-LVL-NULL-IND     PIC S9(4) COMP VALUE +0.    01940099
004970                                                                  01950016
005000    05  PV-PROMO-STRT-DTE-NBR.                                    01960005
005100        10  PV-PROMO-DTE-CCYY             PIC 9(04).              01970005
005200        10  PV-PROMO-DTE-MM               PIC 9(02).              01980005
005300        10  PV-PROMO-DTE-DD               PIC 9(02).              01990005
005400                                                                  02000005
005500    05  PV-PROMO-STRT-DTE-TM.                                     02010005
005600        10  PV-PROMO-STRT-DTE.                                    02020005
005700            15  PV-PROMO-DTE-TM-CCYY      PIC X(04).              02030005
005800            15  FILLER                    PIC X(01).              02040005
005900            15  PV-PROMO-DTE-TM-MM        PIC X(02).              02050005
006000            15  FILLER                    PIC X(01).              02060005
006100            15  PV-PROMO-DTE-TM-DD        PIC X(02).              02070005
006200        10  PV-PROMO-STRT-TM              PIC X(16).              02080005
006300                                                                  02090005
007300*----------------------------------------------------------       02100005
007400* PROMOTION BUSINESS EVENT RECORD LAYOUT                          02110005
007500*----------------------------------------------------------       02120005
007600     COPY XSRD016.                                                02130005
007700                                                                  02140005
007800*----------------------------------------------------------       02150005
007900* DATE ROUTINE COPY MEMBERS                                       02160005
008000*----------------------------------------------------------       02170005
008100     COPY DPWS500.                                                02180005
008200                                                                  02190005
008300*----------------------------------------------------------       02200005
008400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         02210005
008500*----------------------------------------------------------       02220005
008600     COPY DPWS004.                                                02230005
008700                                                                  02240005
008800*---------------------------------------------                    02250005
008900*  DB2 COMMUNICATION AREA.                                        02260005
009000*---------------------------------------------                    02270005
009100     EXEC SQL                                                     02280005
009200          INCLUDE SQLCA                                           02290005
009300     END-EXEC.                                                    02300005
009400                                                                  02310005
009500*---------------------------------------------                    02320005
009600*  DB2 TABLE XST_PROMO - PROMOTION TABLE                          02330099
009700*---------------------------------------------                    02340005
009800     EXEC SQL                                                     02350005
009900          INCLUDE XST00026                                        02360005
010000     END-EXEC.                                                    02370005
010000                                                                  02380045
W37916*---------------------------------------------                    02390098
W37916*  DB2 TABLE XST_PROMO_TYP - PROMOTION TYPE TABLE                 02400099
W37916*---------------------------------------------                    02410098
W37916*    EXEC SQL                                                     02420099
W37916*         INCLUDE XST00132                                        02430099
W37916*    END-EXEC.                                                    02440099
W37916                                                                  02450098
W37916*---------------------------------------------                    02460099
W37916* DB2 TABLE SIT_PROMO_LVL_SGN_PRCDNC - SIGN PRECEDENCE PROMO TABLE02470099
W37916*---------------------------------------------                    02480099
W37916*    EXEC SQL                                                     02490099
W37916*         INCLUDE SIT00073                                        02500099
W37916*    END-EXEC.                                                    02510099
W37916                                                                  02520099
W37916*---------------------------------------------                    02530099
W37916* DB2 TABLE SIT_TOPR_ASGMT - ESIGN TOPPER ASSIGNMENT TABLE        02540099
W37916*---------------------------------------------                    02550099
W37916*    EXEC SQL                                                     02560099
W37916*         INCLUDE SIT00055                                        02570099
W37916*    END-EXEC.                                                    02580099
W37916                                                                  02590099
W37916*---------------------------------------------                    02600099
W37916* DB2 TABLE TSIESGN - WINSIGN SIGN TABLE                          02610099
W37916*---------------------------------------------                    02620099
W37916*    EXEC SQL                                                     02630099
W37916*         INCLUDE TSIESGN                                         02640099
W37916*    END-EXEC.                                                    02650099
W37916                                                                  02660099
W37916*---------------------------------------------                    02670099
W37916* DB2 TABLE SIT_TOPR_SGN - ESIGN TOPPER SIGN TABLE                02680099
W37916*---------------------------------------------                    02690099
W37916*    EXEC SQL                                                     02700099
W37916*         INCLUDE SIT00057                                        02710099
W37916*    END-EXEC.                                                    02720099
W37916                                                                  02730099
W37916******************************************************************02740099
W37916* DECLARE TO SELECT THE SIGNS ATTACHED TO THE PROMO ID WHEN THE   02750099
W37916* PROMO NAME CHANGES AND THE STAUS IS EITHER IN-PROCESS,          02760099
W37916* SUBMITTED, APPROVED, REJECTED OR DELETED.                       02770099
W37916******************************************************************02780099
W37916                                                                  02790099
W37916*    EXEC SQL                                                     02800099
W37916*         DECLARE TSIESGN-CSR CURSOR WITH HOLD FOR                02810099
W37916*          SELECT S.SGN_NBR                                       02820099
W37916*               , S.SGN_PRCDNC_NBR                                02830099
W37916*               , S.DFLT_PRCDNC_IND                               02840099
W37916*               , T.TOPR_ASGMT_ID                                 02850099
W37916*               , T.SYS_ASGD_TOPR_IND                             02860099
W37916*            FROM TSIESGN          S                              02870099
W37916*               , SIT_TOPR_SGN     T                              02880099
W37916*           WHERE S.PROMO_ID       = :XST00026-PROMO-ID           02890099
W37916*             AND S.STAT_CDE      IN ('IP','SB','AP','RJ','DT')   02900099
W37916*             AND S.SGN_NBR        = T.SGN_NBR                    02910099
W37916*          WITH UR                                                02920099
W37916*    END-EXEC.                                                    02930099
W37916                                                                  02940099
010100                                                                  02950099
010200 LINKAGE SECTION.                                                 02960005
010300                                                                  02970005
010400*----------------------------------------------------------       02980005
010500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          02990005
010600*----------------------------------------------------------       03000005
010700 01 LV-LINKAGE-VARIABLES.                                         03010005
010800    05  LV-PROMOTION-BUS-REC       PIC X(300).                    03020005
010900    05  LV-MAX-OFFSET-DTE          PIC X(08).                     03030005
011000    05  LV-LD-SQL-RETURN-CDE       PIC S9(4).                     03040005
011100    05  LV-PGM-STATUS-CDE          PIC X(02).                     03050005
011200    05  LV-LD-SEVERITY-LVL         PIC X(02).                     03060005
011300                                                                  03070005
011400                                                                  03080005
011500*----------------------------------------------------------       03090005
011600 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   03100005
011700*----------------------------------------------------------       03110005
011800 0000-MAINLINE.                                                   03120005
011900                                                                  03130005
012000     PERFORM 1000-INITIALIZATION.                                 03140005
012100                                                                  03150005
W37916***  IF THE PROMO NAME ON THE INPUT FILE IS NOT SPACES PERFORM THE03160099
W37916***  PROMO NAME CHANGE LOGIC HERE BECAUSE 2000-PROCESS-MESSAGE    03170099
W37916***  CAN BE EXECUTED MULTIPLE TIMES. PROMO NAME CHANGE LOGIC IS   03180099
W37916***  ONLY REQUIRED ON UPDATES, BUT THIS PROGRAM WILL PERFORM AN   03190099
W37916***  UPDATE IF THE ACTION CODE = INSERT AND THE PROMO ID IS FOUND 03200099
W37916***  AND WILL PERFORM AN INSERT IF THE ACTION CODE = UPDATE AND   03210099
W37916***  THE PROMO ID IS NOT FOUND.  WE CAN NOT WAIT UNTIL AFTER THE  03220099
W37916***  UPDATE IS ACTUALLY PERFORMED SINCE WE NEED TO COMPARE THE    03230099
W37916***  BEFORE AND AFTER VALUES.                                     03240099
W37916***  USING A NEW TIMESTAMP SWITCH INSTEAD OF THE EXISTING         03250099
W37916***  PS-PROCESS-CONTINUE SWITCH FOR THE PROMO NAME CHANGE PROCESS.03260099
W37916***  THE MAIN MESSAGE PROCESSING WILL BE PERFORMED AS USUAL IF    03270099
W37916***  THE PROMO NAME CHANGE PROCESS CAN NOT BE COMPLETED.          03280099
W37916*    IF (XS016-CPLT-NM NOT = SPACES) AND PS-TIMESTAMP-FORMATTED   03290099
W37916*        SET PS-PROMO-NAME-CHANGE-NOT-FOUND TO TRUE               03300099
W37916*        PERFORM 4000-CHECK-FOR-PROMO-NAME-CHG                    03310099
W37916*        IF PS-PROMO-NAME-CHANGE-FOUND                            03320099
W37916*            PERFORM 4100-COMPARE-PROMO-TYPE-CODES                03330099
W37916*        END-IF                                                   03340099
W37916*    END-IF.                                                      03350099
012100                                                                  03360099
012200     PERFORM 2000-PROCESS-MESSAGE                                 03370005
012300             UNTIL PS-PROCESS-COMPLETE.                           03380005
012400                                                                  03390005
012500     PERFORM 9999-WRAPUP.                                         03400005
012600                                                                  03410005
012700     EXIT PROGRAM.                                                03420030
012800                                                                  03430005
012900*0000-EXIT.                                                       03440005
013000 EJECT.                                                           03450005
013100                                                                  03460005
013200*----------------------------------------------------------       03470005
013300* 1000-INITIALIZATION.                                            03480005
013400*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            03490005
013500*     UPDATE OR INSERT A RECORD.                                  03500005
013600*----------------------------------------------------------       03510005
013700 1000-INITIALIZATION.                                             03520005
013800                                                                  03530005
013900     INITIALIZE DCLXST00026                                       03540016
013901                PV-SQL-CODE                                       03550025
013910                PV-NULLS-INDICATORS.                              03560016
014000     MOVE LV-PROMOTION-BUS-REC       TO XS016-PROMOTION-RECORD.   03570099
014100     MOVE XS016-ACTION-CDE           TO PV-ACTION-CODE.           03580099
014200     MOVE XS016-STRT-TMST            TO PV-PROMO-STRT-DTE-TM.     03590099
014600     SET PV-NO-ERROR                 TO TRUE.                     03600099
014700     SET PV-SUCCESS-CDE              TO TRUE.                     03610099
014800     SET PS-PROCESS-CONTINUE         TO TRUE.                     03620099
W37916     SET PS-INSERT-NO                TO TRUE.                     03630099
W37916     SET PS-UPDATE-NO                TO TRUE.                     03640099
W37916*    SET PS-NOT-EOF-TSIESGN-CSR      TO TRUE.                     03650099
W37916*    SET PS-SGN-PRECEDENCE-NOT-FOUND TO TRUE.                     03660099
W37916*    SET PS-TOPR-ASGMT-ID-NOT-FOUND  TO TRUE.                     03670099
W37916     SET PS-TIMESTAMP-FAILED         TO TRUE.                     03680099
W37916*    SET PS-PROMO-NAME-CHANGE-NOT-FOUND TO TRUE.                  03690099
W37916     MOVE ZERO                       TO PV-UPDATE-COUNT           03700099
W37916                                        PV-TOTAL-SIGNS-READ       03710099
W37916                                        PV-TOTAL-SIGNS-UPDATED    03720099
W37916                                        PV-TOTAL-TOPPERS-UPDATED. 03730099
014900                                                                  03740005
014910     IF LV-MAX-OFFSET-DTE = SPACES                                03750005
014920        INITIALIZE PV-MAX-OFFSET-DTE                              03760005
014930     ELSE                                                         03770005
014940        MOVE LV-MAX-OFFSET-DTE       TO PV-MAX-OFFSET-DTE         03780099
014950     END-IF.                                                      03790005
014960                                                                  03800005
014980     PERFORM 1100-POPULATE-DCLGEN.                                03810005
014990                                                                  03820005
W37916*  RETRIEVE THE CURRENT TIMESTAMP TO BE USED WHEN UPDATING THE    03830099
W37916*  SIGN AND TOPPER TABLES.  THE 6 MILLISECONDS POSITIONS NEED     03840099
W37916*  TO BE ZEROES OR WINSIGN WILL NOT BE ABLE TO UPDATE THE SIGN.   03850099
W37916                                                                  03860099
W37916     EXEC SQL                                                     03870099
W37916         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            03880099
W37916     END-EXEC.                                                    03890099
W37916                                                                  03900099
W37916     EVALUATE TRUE                                                03910099
W37916         WHEN SQLCODE = +0                                        03920099
W37916             MOVE '000000'    TO     PCT-MILLI-SECONDS            03930099
W37916             SET PS-TIMESTAMP-FORMATTED TO TRUE                   03940099
W37916                                                                  03950099
W37916         WHEN OTHER                                               03960099
W37916             DISPLAY 'CALL FOR CURRENT TMST FAILED= ' PV-SQL-CODE 03970099
W37916             SET PS-TIMESTAMP-FAILED TO TRUE                      03980099
W37916             SET PV-NO-SUCCESS-CDE TO TRUE                        03990099
W37916             PERFORM 9000-LOAD-SEVERITY-ERROR                     04000099
W37916     END-EVALUATE.                                                04010099
                                                                        04020099
014990                                                                  04030099
015000*1000-EXIT.                                                       04040005
015100 EJECT.                                                           04050005
015200                                                                  04060005
015300*----------------------------------------------------------       04070005
015400* 1100-POPULATE-DCLGEN.                                           04080005
015500*     POPULATES THE PROMOTION TABLE VARIABLES.                    04090029
015700*----------------------------------------------------------       04100005
015800 1100-POPULATE-DCLGEN.                                            04110005
015900                                                                  04120005
016000     MOVE XS016-PROMO-ID        TO XST00026-PROMO-ID.             04130010
016200     MOVE XS016-PROMO-TYP-CDE   TO XST00026-PROMO-TYP-CDE.        04140005
0410       MOVE 1                     TO XST00026-PROMO-TYP-ID.         04150075
0410                                                                    04160084
0410****  ONLY PROCESS VALID 'R'EGULAR AND 'S'CHEDULED PROMOTIONS.      04170087
0410       IF  XS016-STAT-CDE      = 'S'                                04180082
0410       AND XS016-PROMO-TYP-CDE = 'R '                               04190085
0410          SET PS-CALL-XSKUP133    TO TRUE                           04200082
0410       ELSE                                                         04210082
0410          SET PS-NO-CALL-XSKUP133 TO TRUE                           04220082
0410       END-IF.                                                      04230082
016900                                                                  04240066
016900     MOVE XS016-STAT-CDE        TO XST00026-STAT-CDE.             04250005
017000     MOVE XS016-STRT-TMST       TO XST00026-DFLT-STRT-TMST.       04260015
017100     MOVE XS016-END-TMST        TO XST00026-DFLT-END-TMST.        04270015
017110     MOVE XS016-ACT-STRT-TMST   TO XST00026-ACTL-STRT-TMST.       04280033
017120     MOVE XS016-ACT-END-TMST    TO XST00026-ACTL-END-TMST.        04290011
017200     MOVE XS016-LAST-UPD-TMST   TO XST00026-SOR-LAST-UPD-TMST.    04300011
017300                                                                  04310005
017301     IF XS016-AD-EVNT-ID = ZEROES                                 04320017
017302        MOVE -1                 TO PV-AD-EVNT-ID-IND              04330017
017303     ELSE                                                         04340017
017310        MOVE XS016-AD-EVNT-ID   TO XST00026-AD-EVNT-ID            04350017
017311     END-IF.                                                      04360017
017312                                                                  04370017
017313     IF XS016-SPECIFIC-PROMO-TYP-CDE = SPACES                     04380017
017314        MOVE -1                 TO PV-ADV-CDE-IND                 04390017
017315     ELSE                                                         04400017
017316        MOVE XS016-SPECIFIC-PROMO-TYP-CDE                         04410017
017317                                TO XST00026-REG-PROMO-ADV-CDE     04420017
017318     END-IF.                                                      04430017
017319                                                                  04440017
017320     IF XS016-REG-PROMO-TYP-CDE = SPACES                          04450017
017330        MOVE -1                 TO PV-TYP-CDE-IND                 04460017
017331     ELSE                                                         04470017
017332        MOVE XS016-REG-PROMO-TYP-CDE                              04480017
017333                                   TO XST00026-REG-PROMO-TYP-CDE  04490017
017334     END-IF.                                                      04500017
017335                                                                  04510017
017336     IF XS016-CPLT-NM = SPACES                                    04520017
017337        MOVE -1                 TO PV-PROMO-NM-IND                04530017
017338     ELSE                                                         04540017
017339        MOVE XS016-CPLT-NM      TO XST00026-PROMO-NM              04550017
017340     END-IF.                                                      04560017
017350                                                                  04570017
017360     IF XS016-ABBR-NM = SPACES                                    04580017
017361        MOVE -1                 TO PV-ABBR-NM-IND                 04590017
017362     ELSE                                                         04600017
017363        MOVE XS016-ABBR-NM      TO XST00026-PROMO-ABBR-NM         04610017
017364     END-IF.                                                      04620017
017365                                                                  04630017
017366     IF XS016-ESL-TOPR-TYP = SPACES                               04640034
017367        MOVE -1                 TO PV-ESL-TOPR-IND                04650034
017368     ELSE                                                         04660034
017369        MOVE XS016-ESL-TOPR-TYP TO XST00026-ESL-TOPR-TYP-CDE      04670036
017370     END-IF.                                                      04680034
017380                                                                  04690042
017400*1100-EXIT.                                                       04700005
017500 EJECT.                                                           04710005
017600                                                                  04720005
017700*----------------------------------------------------------       04730005
017800* 2000-PROCESS-MESSAGE.                                           04740005
017900*     THIS CHECKS THE ACTION TO SEE WHETHER THE RECORD            04750005
018000*     SHOULD BE INSERTED INTO THE PROMOTION TABLE OR UPDATED.     04760005
018100*     IF SOMETHING IS WRONG WITH THE ACTION CODE IT WILL          04770005
018200*     PROCESS AN ERROR AND EXIT THE PROGRAM.                      04780005
018300*----------------------------------------------------------       04790005
018400 2000-PROCESS-MESSAGE.                                            04800005
018500                                                                  04810005
018600     EVALUATE TRUE                                                04820005
018700        WHEN PV-INSERT-DATA                                       04830005
018800             PERFORM 2100-INSERT-DATA                             04840099
018900        WHEN PV-UPDATE-DATA                                       04850005
019000             PERFORM 2200-UPDATE-DATA                             04860005
019100        WHEN OTHER                                                04870005
019200             SET PS-PROCESS-COMPLETE TO TRUE                      04880005
019300             SET PV-UNEXPECT-CDE     TO TRUE                      04890005
019400             PERFORM 9000-LOAD-SEVERITY-ERROR                     04900005
019500     END-EVALUATE.                                                04910005
019600                                                                  04920005
0410       IF (PS-CALL-XSKUP133                                         04930067
0410       AND (PS-INSERT-OK                                            04940067
0410        OR  PS-UPDATE-OK))                                          04950068
0410          PERFORM 3000-CALL-XSKUP133                                04960066
0410       END-IF.                                                      04970066
003300                                                                  04980066
019700*2000-EXIT.                                                       04990005
019800 EJECT.                                                           05000005
019900                                                                  05010005
020000*------------------------------------------------------           05020005
020100* 2100-INSERT-DATA.                                               05030005
020200*     INSERT THE PROMOTION RECORD.                                05040005
020300*------------------------------------------------------           05050005
020400 2100-INSERT-DATA.                                                05060005
020500                                                                  05070005
020600     PERFORM                                                      05080005
020700         WITH TEST AFTER                                          05090005
020800         VARYING PV-SQL-SUB                                       05100005
020900         FROM 1 BY 1                                              05110005
021000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05120005
021100                   OR  SQLCODE NOT = -904 AND -911 AND -913)      05130008
021400                                                                  05140005
021500         EXEC SQL                                                 05150005
021600             INSERT INTO XST_PROMO    (PROMO_ID                   05160005
021700                                      ,AD_EVNT_ID                 05170005
021800                                      ,PROMO_TYP_CDE              05180005
021900                                      ,REG_PROMO_ADV_CDE          05190005
022000                                      ,REG_PROMO_TYP_CDE          05200005
022100                                      ,PROMO_NM                   05210005
022200                                      ,PROMO_ABBR_NM              05220005
022300                                      ,STAT_CDE                   05230005
022400                                      ,DFLT_STRT_TMST             05240005
022500                                      ,DFLT_END_TMST              05250005
022510                                      ,ACTL_STRT_TMST             05260011
022520                                      ,ACTL_END_TMST              05270011
022530                                      ,ESL_TOPR_TYP_CDE           05280035
022600                                      ,LAST_UPD_TMST              05290011
022610                                      ,SOR_LAST_UPD_TMST          05300075
0410                                        ,PROMO_TYP_ID )             05310075
022700             VALUES                                               05320005
022800                (:XST00026-PROMO-ID                               05330005
022900                ,:XST00026-AD-EVNT-ID :PV-AD-EVNT-ID-IND          05340017
023000                ,:XST00026-PROMO-TYP-CDE                          05350005
023100                ,:XST00026-REG-PROMO-ADV-CDE :PV-ADV-CDE-IND      05360017
023200                ,:XST00026-REG-PROMO-TYP-CDE :PV-TYP-CDE-IND      05370017
023300                ,:XST00026-PROMO-NM :PV-PROMO-NM-IND              05380017
023400                ,:XST00026-PROMO-ABBR-NM :PV-ABBR-NM-IND          05390017
023410                ,:XST00026-STAT-CDE                               05400005
023420                ,:XST00026-DFLT-STRT-TMST                         05410005
023430                ,:XST00026-DFLT-END-TMST                          05420005
023431                ,:XST00026-ACTL-STRT-TMST                         05430011
023432                ,:XST00026-ACTL-END-TMST                          05440011
023433                ,:XST00026-ESL-TOPR-TYP-CDE :PV-ESL-TOPR-IND      05450036
023434                ,CURRENT TIMESTAMP                                05460013
023440                ,:XST00026-SOR-LAST-UPD-TMST                      05470075
0410                  ,:XST00026-PROMO-TYP-ID)                          05480075
023450         END-EXEC                                                 05490005
023460                                                                  05500005
023461         MOVE SQLCODE TO PV-SQL-CODE                              05510025
023462                                                                  05520025
023470         EVALUATE TRUE                                            05530005
023480             WHEN SQLCODE = -904                                  05540005
023490             WHEN SQLCODE = -911                                  05550005
023500             WHEN SQLCODE = -913                                  05560005
023600                  CONTINUE                                        05570005
023700             WHEN SQLCODE = 0                                     05580005
023800                  SET PS-PROCESS-COMPLETE TO TRUE                 05590005
0410                    SET PS-INSERT-OK        TO TRUE                 05600067
023900             WHEN SQLCODE = -803                                  05610005
024000                  PERFORM 2300-SELECT-DATA                        05620012
024010                  MOVE -803 TO SQLCODE                            05630025
024100             WHEN OTHER                                           05640005
024200                  SET PS-PROCESS-COMPLETE TO TRUE                 05650005
024300                  SET PV-NO-SUCCESS-CDE TO TRUE                   05660005
024400                  PERFORM 9000-LOAD-SEVERITY-ERROR                05670005
024500         END-EVALUATE                                             05680005
024600     END-PERFORM.                                                 05690005
024700                                                                  05700005
024800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05710005
024900        SET PS-PROCESS-COMPLETE TO TRUE                           05720005
025000        SET PV-NO-SUCCESS-CDE TO TRUE                             05730005
025100        PERFORM 9000-LOAD-SEVERITY-ERROR                          05740005
025200     END-IF.                                                      05750005
025300                                                                  05760005
025400*2100-EXIT.                                                       05770005
025500 EJECT.                                                           05780005
025600                                                                  05790005
032100*------------------------------------------------------           05800005
032200* 2200-UPDATE-DATA.                                               05810005
032300*     UPDATE THE PROMOTION RECORD.                                05820005
032400*------------------------------------------------------           05830005
032500 2200-UPDATE-DATA.                                                05840005
032600                                                                  05850005
032700     PERFORM                                                      05860005
032800         WITH TEST AFTER                                          05870005
032900         VARYING PV-SQL-SUB                                       05880005
033000         FROM 1 BY 1                                              05890005
033100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05900005
033200                   OR  SQLCODE NOT = -904 AND -911 AND -913)      05910008
033500                                                                  05920005
033600         EXEC SQL                                                 05930005
033700             UPDATE XST_PROMO                                     05940005
033800             SET  PROMO_ID          = :XST00026-PROMO-ID,         05950005
033900                  AD_EVNT_ID        = :XST00026-AD-EVNT-ID        05960017
033910                                        :PV-AD-EVNT-ID-IND,       05970017
034000                  PROMO_TYP_CDE     = :XST00026-PROMO-TYP-CDE,    05980005
034100                  REG_PROMO_ADV_CDE = :XST00026-REG-PROMO-ADV-CDE 05990017
034110                                        :PV-ADV-CDE-IND,          06000017
034200                  REG_PROMO_TYP_CDE = :XST00026-REG-PROMO-TYP-CDE 06010017
034210                                        :PV-TYP-CDE-IND,          06020017
034300                  PROMO_NM          = :XST00026-PROMO-NM          06030017
034310                                        :PV-PROMO-NM-IND,         06040017
034400                  PROMO_ABBR_NM     = :XST00026-PROMO-ABBR-NM     06050017
034410                                        :PV-ABBR-NM-IND,          06060017
034500                  STAT_CDE          = :XST00026-STAT-CDE,         06070005
034600                  DFLT_STRT_TMST    = :XST00026-DFLT-STRT-TMST,   06080005
034700                  DFLT_END_TMST     = :XST00026-DFLT-END-TMST,    06090005
034710                  ACTL_STRT_TMST    = :XST00026-ACTL-STRT-TMST,   06100012
034720                  ACTL_END_TMST     = :XST00026-ACTL-END-TMST,    06110012
034730                  ESL_TOPR_TYP_CDE  = :XST00026-ESL-TOPR-TYP-CDE  06120037
034740                                        :PV-ESL-TOPR-IND,         06130034
034800                  LAST_UPD_TMST     = CURRENT TIMESTAMP,          06140012
034801                  SOR_LAST_UPD_TMST = :XST00026-SOR-LAST-UPD-TMST 06150012
034810            WHERE PROMO_ID          = :XST00026-PROMO-ID          06160012
034821              AND SOR_LAST_UPD_TMST <= :XST00026-SOR-LAST-UPD-TMST06170021
034830         END-EXEC                                                 06180005
034840                                                                  06190005
034841         MOVE SQLCODE TO PV-SQL-CODE                              06200025
034842                                                                  06210025
034850         EVALUATE TRUE                                            06220005
034860             WHEN SQLCODE = -904                                  06230005
034870             WHEN SQLCODE = -911                                  06240005
034880             WHEN SQLCODE = -913                                  06250005
034890                  CONTINUE                                        06260005
034900             WHEN SQLCODE = 0                                     06270005
035000                  SET PS-PROCESS-COMPLETE TO TRUE                 06280005
0410                    SET PS-UPDATE-OK        TO TRUE                 06290067
035100             WHEN SQLCODE = +100                                  06300005
035200                  PERFORM 2300-SELECT-DATA                        06310012
035300                  MOVE +100 TO SQLCODE                            06320025
035400             WHEN OTHER                                           06330005
035500                  SET PS-PROCESS-COMPLETE TO TRUE                 06340005
035600                  SET PV-NO-SUCCESS-CDE   TO TRUE                 06350067
035700                  PERFORM 9000-LOAD-SEVERITY-ERROR                06360005
035800         END-EVALUATE                                             06370005
035900     END-PERFORM.                                                 06380005
036000                                                                  06390005
036100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06400005
036200        SET PS-PROCESS-COMPLETE TO TRUE                           06410005
036300        SET PV-NO-SUCCESS-CDE TO TRUE                             06420005
036400        PERFORM 9000-LOAD-SEVERITY-ERROR                          06430005
036500     END-IF.                                                      06440005
036600                                                                  06450005
036700*2200-EXIT.                                                       06460005
036800 EJECT.                                                           06470005
036900                                                                  06480005
036910*------------------------------------------------------           06490012
036920* 2300-SELECT-DATA.                                               06500012
036930*     SELECT THE TIMESTAMP IN THE PROMOTION RECORD.               06510012
036940*------------------------------------------------------           06520012
036950 2300-SELECT-DATA.                                                06530012
036960                                                                  06540012
036970     PERFORM                                                      06550012
036980         WITH TEST AFTER                                          06560012
036990         VARYING PV-SQL-SUB                                       06570012
036991         FROM 1 BY 1                                              06580012
036992         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 06590012
036993                   OR  SQLCODE NOT = -904 AND -911 AND -913)      06600012
036994                                                                  06610012
036995         EXEC SQL                                                 06620012
036996             SELECT  SOR_LAST_UPD_TMST                            06630012
036997               INTO :PV-LAST-UPD-TMST                             06640012
036998               FROM  XST_PROMO                                    06650012
036999              WHERE  PROMO_ID        = :XST00026-PROMO-ID         06660012
037001         END-EXEC                                                 06670012
037002                                                                  06680012
037003         MOVE SQLCODE TO PV-SQL-CODE                              06690025
037004                                                                  06700025
037005         EVALUATE TRUE                                            06710012
037006             WHEN SQLCODE = -904                                  06720012
037007             WHEN SQLCODE = -911                                  06730012
037008             WHEN SQLCODE = -913                                  06740012
037009                  CONTINUE                                        06750012
037010             WHEN SQLCODE = 0                                     06760012
037011                  IF PV-UPDATE-DATA                               06770012
037012                     SET PS-PROCESS-COMPLETE TO TRUE              06780012
037013                     SET PV-UPDATE-BYPASS TO TRUE                 06790012
037014                  ELSE                                            06800012
037015                     PERFORM 2350-TMST-COMPARE                    06810027
037016                  END-IF                                          06820012
037017             WHEN SQLCODE = +100                                  06830012
037018                  SET PV-INSERT-DATA TO TRUE                      06840012
037019                  SET PV-ADD-CDE TO TRUE                          06850012
037020             WHEN OTHER                                           06860012
037021                  SET PS-PROCESS-COMPLETE TO TRUE                 06870012
037022                  SET PV-NO-SUCCESS-CDE TO TRUE                   06880012
037023                  PERFORM 9000-LOAD-SEVERITY-ERROR                06890012
037024         END-EVALUATE                                             06900012
037025     END-PERFORM.                                                 06910012
037026                                                                  06920012
037027     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06930012
037028        SET PS-PROCESS-COMPLETE TO TRUE                           06940012
037029        SET PV-NO-SUCCESS-CDE TO TRUE                             06950012
037030        PERFORM 9000-LOAD-SEVERITY-ERROR                          06960012
037031     END-IF.                                                      06970012
037032                                                                  06980012
037033*2300-EXIT.                                                       06990012
037034 EJECT.                                                           07000012
037035                                                                  07010012
037036*--------------------------------------------------------         07020012
037037* 2350-TMST-COMPARE.                                              07030027
037038*     COMPARE TIMESTAMP OF EXISTING ROW TO MESSAGE RECORD         07040027
037039*     AND UPDATE IF MESSAGE HAS A NEWER TIMESTAMP.                07050027
037040*--------------------------------------------------------         07060012
037041 2350-TMST-COMPARE.                                               07070027
037042                                                                  07080012
037043     IF XS016-LAST-UPD-TMST >= PV-LAST-UPD-TMST                   07090012
037044        SET PV-UPDATE-DATA      TO TRUE                           07100012
037045        SET PV-UPDATE-NEED      TO TRUE                           07110012
037046     ELSE                                                         07120012
037047        SET PS-PROCESS-COMPLETE TO TRUE                           07130012
037048        SET PV-UPDATE-NOT-NEED  TO TRUE                           07140012
037049     END-IF.                                                      07150012
037050                                                                  07160012
037051*2350-EXIT.                                                       07170012
037052                                                                  07180055
0410  *----------------------------------------------------------       07190055
0410  * 2100-CALL-PROGRAM.                                              07200055
0410  *     CALL XSKUP133 TO SEE IF THE PROMO DATA EXISTS ON            07210071
0410  *     DB2 TABLE XST_PROMO_TYP.  IF NOT, IT WILL INSERT IT.        07220055
0410  *----------------------------------------------------------       07230055
0410   3000-CALL-XSKUP133.                                              07240055
0410                                                                    07250055
0410       CALL PC-CALLED-PROGRAM USING LV-LINKAGE-VARIABLES.           07260055
0410                                                                    07270055
0410       IF LV-PGM-STATUS-CDE = '00'                                  07280077
0410          CONTINUE                                                  07290077
0410       ELSE                                                         07300077
0410          MOVE LV-PGM-STATUS-CDE TO PV-PGM-STATUS-CDE               07310077
0410       END-IF.                                                      07320077
0410       SET PS-PROCESS-COMPLETE   TO TRUE.                           07330083
0410                                                                    07340055
0410  *3000-EXIT.                                                       07350055
037052 EJECT.                                                           07360077
037053                                                                  07370077
W37916*--------------------------------------------------------         07380099
W37916* 4000-CHECK-FOR-PROMO-NAME-CHG.                                  07390099
W37916*     SELECT THE PROMO ID TO BE INSERTED OR UPDATED.  IF IT       07400099
W37916*     EXISTS AND THE MESSAGE PROMO NAME IS DIFFERENT THAN         07410099
W37916*     THE EXISTING PROMO NAME, CONTINUE TO SEE IF MASS CHANGES    07420099
W37916*     ARE REQUIRED AGAINST THE PROMO'S SIGNS.                     07430099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          07440099
W37916*     UPDATES FROM BEING PERFORMED.                               07450099
W37916*--------------------------------------------------------         07460099
W37916*4000-CHECK-FOR-PROMO-NAME-CHG.                                   07470099
W37916*                                                                 07480099
W37916*    PERFORM                                                      07490099
W37916*        WITH TEST AFTER                                          07500099
W37916*        VARYING PV-SQL-SUB                                       07510099
W37916*        FROM 1 BY 1                                              07520099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07530099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      07540099
W37916*                                                                 07550099
W37916*        EXEC SQL                                                 07560099
W37916*            SELECT  PROMO_NM                                     07570099
W37916*              INTO :PV-OLD-PROMO-NM                              07580099
W37916*              FROM  XST_PROMO                                    07590099
W37916*             WHERE  PROMO_ID        = :XST00026-PROMO-ID         07600099
W37916*        END-EXEC                                                 07610099
W37916*                                                                 07620099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              07630099
W37916*                                                                 07640099
W37916*        EVALUATE TRUE                                            07650099
W37916*            WHEN SQLCODE = -904                                  07660099
W37916*            WHEN SQLCODE = -911                                  07670099
W37916*            WHEN SQLCODE = -913                                  07680099
W37916*                 CONTINUE                                        07690099
W37916*            WHEN SQLCODE = 0                                     07700099
W37916*                 IF XST00026-PROMO-NM NOT = PV-OLD-PROMO-NM      07710099
W37916*                    DISPLAY 'PROMO ID ' XST00026-PROMO-ID        07720099
W37916*                            ' NAME CHANGED FROM '                07730099
W37916*                             PV-OLD-PROMO-NM                     07740099
W37916*                    DISPLAY '                                  ' 07750099
W37916*                            ' TO ' XST00026-PROMO-NM             07760099
W37916*                    SET PS-PROMO-NAME-CHANGE-FOUND TO TRUE       07770099
W37916*                 END-IF                                          07780099
W37916*            WHEN SQLCODE = +100                                  07790099
W37916*                 CONTINUE                                        07800099
W37916*            WHEN OTHER                                           07810099
W37916*                 DISPLAY 'XSKUP031 XST_PROMO CALL FAILED FOR '   07820099
W37916*                         'PROMO ID ' XST00026-PROMO-ID           07830099
W37916*                         ' WITH SQL CDE ' PV-SQL-CODE            07840099
W37916*        END-EVALUATE                                             07850099
W37916*    END-PERFORM.                                                 07860099
W37916*                                                                 07870099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07880099
W37916*        DISPLAY 'XSKUP031 XST_PROMO CALL FAILED FOR '            07890099
W37916*                'PROMO ID ' XST00026-PROMO-ID                    07900099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     07910099
W37916*    END-IF.                                                      07920099
W37916                                                                  07930099
W37916*--------------------------------------------------------         07940099
W37916* 4100-COMPARE-PROMO-TYPE-CODES.                                  07950099
W37916*     AT THIS POINT, WE KNOW THAT THE PROMO NAME IS BEING         07960099
W37916*     UPDATED ON AN EXISTING PROMO ID.  TO VERIFY IF MASS         07970099
W37916*     CHANGES ARE REQUIRED AGAINST THE PROMO'S SIGNS, WE          07980099
W37916*     NEED TO GET THE PROMO-LVL-CDE AND PROMO-TYP-ID FOR          07990099
W37916*     THE BEFORE AND AFTER PROMO NAMES AND SEE IF EITHER          08000099
W37916*     IS DIFFERENT.  IF THEY ARE, WE NEED TO PROCEED TO THE       08010099
W37916*     MASS CHANGES.                                               08020099
W37916*     MASS CHANGES WILL BE PERFORMED FOR THE TOPPERS ONLY         08030099
W37916*     AND NOT THE SIGNS IF THE PROMO-LVL-CDE IS NULL, SINCE THE   08040099
W37916*     SIGN PRECEDENCE NUMBER CAN NOT BE DETERMINED.               08050099
W37916*     THIS SHOULD ONLY OCCUR WHEN MQPROMO PREVIOUSLY ADDED        08060099
W37916*     A "DEFAULT" XST_PROMO_TYP ROW AND NOTIFIED MIO VIA          08070099
W37916*     EMAIL, BUT THEY HAVE NOT SET THE PROMO-LVL-CDE YET.         08080099
W37916*--------------------------------------------------------         08090099
W37916*4100-COMPARE-PROMO-TYPE-CODES.                                   08100099
W37916*                                                                 08110099
W37916**   GET PROMO TYPE VALUES FOR OLD PROMO NAME                     08120099
W37916*    MOVE PV-OLD-PROMO-NM            TO PV-PROMO-NM.              08130099
W37916*    PERFORM 4150-SELECT-PROMO-TYPE-CODES.                        08140099
W37916*    IF SQLCODE = 0                                               08150099
W37916*        MOVE XST00132-PROMO-TYP-ID  TO PV-OLD-PROMO-TYP-ID       08160099
W37916*        MOVE XST00132-PROMO-LVL-CDE TO PV-OLD-PROMO-LVL-CDE      08170099
W37916**       GET PROMO TYPE VALUES FOR NEW PROMO NAME                 08180099
W37916*        MOVE XST00026-PROMO-NM          TO PV-PROMO-NM           08190099
W37916*        PERFORM 4150-SELECT-PROMO-TYPE-CODES                     08200099
W37916*        IF SQLCODE = 0                                           08210099
W37916*            MOVE XST00132-PROMO-TYP-ID  TO PV-NEW-PROMO-TYP-ID   08220099
W37916*            MOVE XST00132-PROMO-LVL-CDE TO PV-NEW-PROMO-LVL-CDE  08230099
W37916*            SET PS-SGN-PRECEDENCE-NOT-FOUND      TO TRUE         08240099
W37916*            SET PS-TOPR-ASGMT-ID-NOT-FOUND       TO TRUE         08250099
W37916**           COMPARE THE OLD PROMO TYPE VALUES TO THE NEW VALUES. 08260099
W37916**           SKIP PRECEDENCE NBR UPDATES IF NEW PROMO LVL NULL.   08270099
W37916*            IF PV-PROMO-LVL-NULL-IND NOT = -1                    08280099
W37916*              IF PV-NEW-PROMO-LVL-CDE NOT = PV-OLD-PROMO-LVL-CDE 08290099
W37916*                PERFORM 4200-SELECT-SGN-PRECEDENCE-NBR           08300099
W37916*              END-IF                                             08310099
W37916*            END-IF                                               08320099
W37916*            IF PV-NEW-PROMO-TYP-ID  NOT = PV-OLD-PROMO-TYP-ID    08330099
W37916*                PERFORM 4300-SELECT-TOPR-ASGMT-ID                08340099
W37916*            END-IF                                               08350099
W37916*            IF PS-SGN-PRECEDENCE-FOUND                           08360099
W37916*            OR PS-TOPR-ASGMT-ID-FOUND                            08370099
W37916*                PERFORM 4400-PROCESS-PROMO-SIGNS                 08380099
W37916*            END-IF                                               08390099
W37916*        END-IF                                                   08400099
W37916*    END-IF.                                                      08410099
W37916                                                                  08420099
W37916*--------------------------------------------------------         08430099
W37916* 4150-SELECT-PROMO-TYPE-CODES.                                   08440099
W37916*     THIS PARAGRAPH WILL BE CALLED BY PRAGRAPH                   08450099
W37916*     4100-COMPARE-PROMO-TYPE-CODES TWICE - ONCE WITH PV-PROMO-NM 08460099
W37916*     SET TO THE OLD PROMO NAME AND ONCE WITH IT SET TO THE NEW   08470099
W37916*     PROMO NAME.                                                 08480099
W37916*     IF THESE CALLS FAIL, THEY SHOULD NOT PREVENT THE MAIN       08490099
W37916*     UPDATES FROM BEING PERFORMED.                               08500099
W37916*--------------------------------------------------------         08510099
W37916*4150-SELECT-PROMO-TYPE-CODES.                                    08520099
W37916*                                                                 08530099
W37916*    PERFORM                                                      08540099
W37916*        WITH TEST AFTER                                          08550099
W37916*        VARYING PV-SQL-SUB                                       08560099
W37916*        FROM 1 BY 1                                              08570099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 08580099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      08590099
W37916*                                                                 08600099
W37916*        EXEC SQL                                                 08610099
W37916*            SELECT  PROMO_TYP_ID                                 08620099
W37916*                  , PROMO_LVL_CDE                                08630099
W37916*              INTO :XST00132-PROMO-TYP-ID                        08640099
W37916*                  ,:XST00132-PROMO-LVL-CDE                       08650099
W37916*                   :PV-PROMO-LVL-NULL-IND                        08660099
W37916*              FROM  XST_PROMO_TYP                                08670099
W37916*             WHERE  CPLT_NM         = :PV-PROMO-NM               08680099
W37916*        END-EXEC                                                 08690099
W37916*                                                                 08700099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              08710099
W37916*                                                                 08720099
W37916*        EVALUATE TRUE                                            08730099
W37916*            WHEN SQLCODE = -904                                  08740099
W37916*            WHEN SQLCODE = -911                                  08750099
W37916*            WHEN SQLCODE = -913                                  08760099
W37916*                 CONTINUE                                        08770099
W37916*            WHEN SQLCODE = 0                                     08780099
W37916*                 IF PV-PROMO-LVL-NULL-IND = -1                   08790099
W37916*                     MOVE SPACES TO XST00132-PROMO-LVL-CDE       08800099
W37916*                 END-IF                                          08810099
W37916*            WHEN OTHER                                           08820099
W37916*                DISPLAY 'XSKUP031 XST_PROMO_TYP CALL FAILED '    08830099
W37916*                        'FOR PROMO ID ' XST00026-PROMO-ID        08840099
W37916*                        ' PROMO NAME '  PV-PROMO-NM              08850099
W37916*                        ' WITH SQL CDE ' PV-SQL-CODE             08860099
W37916*        END-EVALUATE                                             08870099
W37916*    END-PERFORM.                                                 08880099
W37916*                                                                 08890099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         08900099
W37916*        DISPLAY 'XSKUP031 XST_PROMO_TYP CALL FAILED '            08910099
W37916*                'FOR PROMO ID ' XST00026-PROMO-ID                08920099
W37916*                ' PROMO NAME '  PV-PROMO-NM                      08930099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     08940099
W37916*    END-IF.                                                      08950099
W37916                                                                  08960099
W37916*--------------------------------------------------------         08970099
W37916* 4200-SELECT-SGN-PRECEDENCE-NBR.                                 08980099
W37916*     SELECT THE SIGN PRECEDENCE NUMBER, BASED ON THE NEW         08990099
W37916*     PROMO LEVEL CODE.  THIS NEW SIGN PRECEDENCE NUMBER WILL BE  09000099
W37916*     ASSIGNED TO ALL OF THE SIGNS ATTACHED TO THE PROMO ID       09010099
W37916*     BEING UPDATED THAT ARE SET TO THE DEFAULT PRECEDENCE NUMBER.09020099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          09030099
W37916*     UPDATES FROM BEING PERFORMED.                               09040099
W37916*--------------------------------------------------------         09050099
W37916*4200-SELECT-SGN-PRECEDENCE-NBR.                                  09060099
W37916*                                                                 09070099
W37916*    PERFORM                                                      09080099
W37916*        WITH TEST AFTER                                          09090099
W37916*        VARYING PV-SQL-SUB                                       09100099
W37916*        FROM 1 BY 1                                              09110099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 09120099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      09130099
W37916*                                                                 09140099
W37916*        EXEC SQL                                                 09150099
W37916*            SELECT  SGN_PRCDNC_NBR                               09160099
W37916*              INTO :SIT00073-SGN-PRCDNC-NBR                      09170099
W37916*              FROM  SIT_PROMO_LVL_SGN_PRCDNC                     09180099
W37916*             WHERE  PROMO_LVL_CDE   = :PV-NEW-PROMO-LVL-CDE      09190099
W37916*        END-EXEC                                                 09200099
W37916*                                                                 09210099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              09220099
W37916*                                                                 09230099
W37916*        EVALUATE TRUE                                            09240099
W37916*            WHEN SQLCODE = -904                                  09250099
W37916*            WHEN SQLCODE = -911                                  09260099
W37916*            WHEN SQLCODE = -913                                  09270099
W37916*                 CONTINUE                                        09280099
W37916*            WHEN SQLCODE = 0                                     09290099
W37916*                 SET PS-SGN-PRECEDENCE-FOUND  TO TRUE            09300099
W37916*            WHEN OTHER                                           09310099
W37916*                 DISPLAY 'XSKUP031 SIT_PROMO_LVL_SGN_PRCDNC '    09320099
W37916*                         'CALL FAILED FOR PROMO ID '             09330099
W37916*                          XST00026-PROMO-ID                      09340099
W37916*                         ' PROMO LVL CDE ' PV-NEW-PROMO-LVL-CDE  09350099
W37916*                         ' WITH SQL CDE ' PV-SQL-CODE            09360099
W37916*        END-EVALUATE                                             09370099
W37916*    END-PERFORM.                                                 09380099
W37916*                                                                 09390099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         09400099
W37916*        DISPLAY 'XSKUP031 SIT_PROMO_LVL_SGN_PRCDNC CALL FAILED ' 09410099
W37916*                'FOR PROMO ID ' XST00026-PROMO-ID                09420099
W37916*                ' PROMO LVL CDE ' PV-NEW-PROMO-LVL-CDE           09430099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     09440099
W37916*    END-IF.                                                      09450099
W37916                                                                  09460099
W37916*--------------------------------------------------------         09470099
W37916* 4300-SELECT-TOPR-ASGMT-ID.                                      09480099
W37916*     SELECT THE TOPPER ASSIGNMENT ID, BASED ON THE NEW           09490099
W37916*     PROMO TYPE ID.  THIS NEW TOPPER ASSIGNMENT ID WILL BE       09500099
W37916*     ASSIGNED TO ALL OF THE SIGN TOPPERS ATTACHED TO THE PROMO ID09510099
W37916*     BEING UPDATED THAT ARE SET TO THE DEFAULT TOPPER ASSIGNMENT 09520099
W37916*     ID.                                                         09530099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          09540099
W37916*     UPDATES FROM BEING PERFORMED.                               09550099
W37916*--------------------------------------------------------         09560099
W37916*4300-SELECT-TOPR-ASGMT-ID.                                       09570099
W37916*                                                                 09580099
W37916*    PERFORM                                                      09590099
W37916*        WITH TEST AFTER                                          09600099
W37916*        VARYING PV-SQL-SUB                                       09610099
W37916*        FROM 1 BY 1                                              09620099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 09630099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      09640099
W37916*                                                                 09650099
W37916*        EXEC SQL                                                 09660099
W37916*            SELECT  TOPR_ASGMT_ID                                09670099
W37916*              INTO :SIT00055-TOPR-ASGMT-ID                       09680099
W37916*              FROM  SIT_TOPR_ASGMT                               09690099
W37916*             WHERE  PROMO_TYP_ID    = :PV-NEW-PROMO-TYP-ID       09700099
W37916*               AND  DFLT_TOPR_IND   = 'Y'                        09710099
W37916*        END-EXEC                                                 09720099
W37916*                                                                 09730099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              09740099
W37916*                                                                 09750099
W37916*        EVALUATE TRUE                                            09760099
W37916*            WHEN SQLCODE = -904                                  09770099
W37916*            WHEN SQLCODE = -911                                  09780099
W37916*            WHEN SQLCODE = -913                                  09790099
W37916*                 CONTINUE                                        09800099
W37916*            WHEN SQLCODE = 0                                     09810099
W37916*                 SET PS-TOPR-ASGMT-ID-FOUND   TO TRUE            09820099
W37916*            WHEN OTHER                                           09830099
W37916*                 DISPLAY 'XSKUP031 SIT_TOPR_ASGMT CALL FAILED '  09840099
W37916*                         'FOR PROMO ID ' XST00026-PROMO-ID       09850099
W37916*                         ' PROMO TYP ID ' PV-NEW-PROMO-TYP-ID    09860099
W37916*                         ' WITH SQL CDE ' PV-SQL-CODE            09870099
W37916*        END-EVALUATE                                             09880099
W37916*    END-PERFORM.                                                 09890099
W37916*                                                                 09900099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         09910099
W37916*        DISPLAY 'XSKUP031 SIT_TOPR_ASGMT CALL FAILED '           09920099
W37916*                'FOR PROMO ID ' XST00026-PROMO-ID                09930099
W37916*                ' PROMO TYP ID ' PV-NEW-PROMO-TYP-ID             09940099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     09950099
W37916*    END-IF.                                                      09960099
W37916                                                                  09970099
W37916*--------------------------------------------------------         09980099
W37916* 4400-PROCESS-PROMO-SIGNS.                                       09990099
W37916*     EXECUTE A CURSOR TO RETURN ALL SIGNS AND TOPPERS ATTACHED   10000099
W37916*     TO THE PROMO ID BEING UPDATED.                              10010099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          10020099
W37916*     UPDATES FROM BEING PERFORMED.                               10030099
W37916*--------------------------------------------------------         10040099
W37916*4400-PROCESS-PROMO-SIGNS.                                        10050099
W37916*                                                                 10060099
W37916*    PERFORM 4500-OPEN-TSIESGN-CSR.                               10070099
W37916*                                                                 10080099
W37916*    IF SQLCODE = +0                                              10090099
W37916*        PERFORM 4600-FETCH-TSIESGN                               10100099
W37916*           UNTIL PS-EOF-TSIESGN-CSR                              10110099
W37916*        PERFORM 4700-CLOSE-TSIESGN-CSR                           10120099
W37916*        IF PV-TOTAL-SIGNS-READ > 0                               10130099
W37916*            DISPLAY 'XSKUP031 NAME CHANGE UPDATES FOR PROMO ID ' 10140099
W37916*                     XST00026-PROMO-ID                           10150099
W37916*            DISPLAY 'XSKUP031 SIGNS READ      = '                10160099
W37916*                                        PV-TOTAL-SIGNS-READ      10170099
W37916*            DISPLAY 'XSKUP031 SIGNS UPDATED   = '                10180099
W37916*                                        PV-TOTAL-SIGNS-UPDATED   10190099
W37916*            DISPLAY 'XSKUP031 TOPPERS UPDATED = '                10200099
W37916*                                        PV-TOTAL-TOPPERS-UPDATED 10210099
W37916*        END-IF                                                   10220099
W37916*    END-IF.                                                      10230099
W37916                                                                  10240099
W37916*--------------------------------------------------------         10250099
W37916* 4500-OPEN-TSIESGN-CSR.                                          10260099
W37916*     OPEN THE CURSOR TO RETURN ALL SIGNS AND TOPPERS ATTACHED    10270099
W37916*     TO THE PROMO ID BEING UPDATED.                              10280099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          10290099
W37916*     UPDATES FROM BEING PERFORMED.                               10300099
W37916*--------------------------------------------------------         10310099
W37916*4500-OPEN-TSIESGN-CSR.                                           10320099
W37916*                                                                 10330099
W37916*    EXEC SQL                                                     10340099
W37916*        OPEN TSIESGN-CSR                                         10350099
W37916*    END-EXEC.                                                    10360099
W37916*                                                                 10370099
W37916*    MOVE SQLCODE TO PV-SQL-CODE.                                 10380099
W37916*                                                                 10390099
W37916*    EVALUATE TRUE                                                10400099
W37916*        WHEN SQLCODE = +0                                        10410099
W37916*            CONTINUE                                             10420099
W37916*                                                                 10430099
W37916*        WHEN OTHER                                               10440099
W37916*            DISPLAY 'XSKUP031 TSIESGN CURSOR OPEN FAILED FOR '   10450099
W37916*                    'PROMO ID ' XST00026-PROMO-ID                10460099
W37916*                    ' WITH SQL CDE ' PV-SQL-CODE                 10470099
W37916*    END-EVALUATE.                                                10480099
W37916                                                                  10490099
W37916                                                                  10500099
W37916*--------------------------------------------------------         10510099
W37916* 4600-FETCH-TSIESGN.                                             10520099
W37916*     FETCH ALL SIGNS AND TOPPERS ATTACHED TO THE PROMO ID        10530099
W37916*     BEING UPDATED.  PERFORM PARAGRAPH 4610- WHICH WILL          10540099
W37916*     PERFORM THE UPDATES TO THE SIGN AND TOPPER TABLES ONLY      10550099
W37916*     WHEN THE VALUES WILL CHANGE (TO BE MORE EFFICIENT AND       10560099
W37916*     AVOID DUPLICATE UPDATES ON RESTARTS) AND WHEN THE ORIGINAL  10570099
W37916*     VALUE WAS SET TO THE DEFAULT.                               10580099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          10590099
W37916*     UPDATES FROM BEING PERFORMED.                               10600099
W37916*--------------------------------------------------------         10610099
W37916*4600-FETCH-TSIESGN.                                              10620099
W37916*                                                                 10630099
W37916*    EXEC SQL                                                     10640099
W37916*         FETCH TSIESGN-CSR                                       10650099
W37916*          INTO :SIESGN-SGN-NBR                                   10660099
W37916*              ,:SIESGN-SGN-PRCDNC-NBR                            10670099
W37916*              ,:SIESGN-DFLT-PRCDNC-IND                           10680099
W37916*              ,:SIT00057-TOPR-ASGMT-ID                           10690099
W37916*              ,:SIT00057-SYS-ASGD-TOPR-IND                       10700099
W37916*    END-EXEC.                                                    10710099
W37916*                                                                 10720099
W37916*    MOVE SQLCODE TO PV-SQL-CODE.                                 10730099
W37916*                                                                 10740099
W37916*    EVALUATE TRUE                                                10750099
W37916*        WHEN SQLCODE = +0                                        10760099
W37916*            CONTINUE                                             10770099
W37916*                                                                 10780099
W37916*        WHEN SQLCODE = +100                                      10790099
W37916*            SET PS-EOF-TSIESGN-CSR TO TRUE                       10800099
W37916*                                                                 10810099
W37916*        WHEN OTHER                                               10820099
W37916*            DISPLAY 'XSKUP031 TSIESGN CURSOR FETCH FAILED FOR '  10830099
W37916*                    'PROMO ID ' XST00026-PROMO-ID                10840099
W37916*                    ' WITH SQL CDE ' PV-SQL-CODE                 10850099
W37916*            SET PS-EOF-TSIESGN-CSR TO TRUE                       10860099
W37916*    END-EVALUATE.                                                10870099
W37916*                                                                 10880099
W37916*    IF PS-NOT-EOF-TSIESGN-CSR                                    10890099
W37916*        PERFORM 4610-PROCESS-FETCHED-TSIESGN                     10900099
W37916*    END-IF.                                                      10910099
W37916                                                                  10920099
W37916*--------------------------------------------------------         10930099
W37916* 4610-PROCESS-FETCHED-TSIESGN.                                   10940099
W37916*     A SIGN HAS BEEN FETCHED FOR THE PROMO NAME CHANGE PROCESS.  10950099
W37916*     UPDATE THE TSIESGN AND SIT_TOPR_SGN TABLES AS NECESSARY     10960099
W37916*     AND PERFORM COMMIT LOGIC.                                   10970099
W37916*--------------------------------------------------------         10980099
W37916*4610-PROCESS-FETCHED-TSIESGN.                                    10990099
W37916*                                                                 11000099
W37916*    ADD 1 TO PV-TOTAL-SIGNS-READ.                                11010099
W37916*                                                                 11020099
W37916*    IF PS-SGN-PRECEDENCE-FOUND                                   11030099
W37916*        IF (SIESGN-SGN-PRCDNC-NBR NOT = SIT00073-SGN-PRCDNC-NBR) 11040099
W37916*        AND SIESGN-DFLT-PRCDNC-IND    = 'Y'                      11050099
W37916*            PERFORM 5000-UPDATE-TSIESGN                          11060099
W37916*        END-IF                                                   11070099
W37916*    END-IF.                                                      11080099
W37916*                                                                 11090099
W37916*    IF PS-TOPR-ASGMT-ID-FOUND                                    11100099
W37916*        IF (SIT00057-TOPR-ASGMT-ID NOT = SIT00055-TOPR-ASGMT-ID) 11110099
W37916*        AND SIT00057-SYS-ASGD-TOPR-IND  = 'Y'                    11120099
W37916*            PERFORM 5100-UPDATE-SIT-TOPR-SGN                     11130099
W37916*        END-IF                                                   11140099
W37916*    END-IF.                                                      11150099
W37916*                                                                 11160099
W37916*    IF PV-UPDATE-COUNT > 999                                     11170099
W37916*        PERFORM 5500-COMMIT-DATA                                 11180099
W37916*        MOVE ZERO TO PV-UPDATE-COUNT                             11190099
W37916*    END-IF.                                                      11200099
W37916                                                                  11210099
W37916*--------------------------------------------------------         11220099
W37916* 4700-CLOSE-TSIESGN-CSR.                                         11230099
W37916*     CLOSE THE CURSOR TO RETURN ALL SIGNS AND TOPPERS ATTACHED   11240099
W37916*     TO THE PROMO ID BEING UPDATED.                              11250099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          11260099
W37916*     UPDATES FROM BEING PERFORMED.                               11270099
W37916*--------------------------------------------------------         11280099
W37916*4700-CLOSE-TSIESGN-CSR.                                          11290099
W37916*                                                                 11300099
W37916*    EXEC SQL                                                     11310099
W37916*        CLOSE TSIESGN-CSR                                        11320099
W37916*    END-EXEC.                                                    11330099
W37916*                                                                 11340099
W37916*    MOVE SQLCODE TO PV-SQL-CODE.                                 11350099
W37916*                                                                 11360099
W37916*    EVALUATE TRUE                                                11370099
W37916*        WHEN SQLCODE = +0                                        11380099
W37916*            CONTINUE                                             11390099
W37916*                                                                 11400099
W37916*        WHEN OTHER                                               11410099
W37916*            DISPLAY 'XSKUP031 TSIESGN CURSOR CLOSE FAILED FOR '  11420099
W37916*                    'PROMO ID ' XST00026-PROMO-ID                11430099
W37916*                    ' WITH SQL CDE ' PV-SQL-CODE                 11440099
W37916*    END-EVALUATE.                                                11450099
W37916                                                                  11460099
W37916*--------------------------------------------------------         11470099
W37916* 5000-UPDATE-TSIESGN.                                            11480099
W37916*     ALL PROCESSING TO DETERMINE THE SIGNS TO UPDATE AND         11490099
W37916*     THE NEW SIGN PRECEDENCE NUMBER HAS BEEN COMPLETED -         11500099
W37916*     PERFORM THE UPDATE.                                         11510099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          11520099
W37916*     UPDATES FROM BEING PERFORMED.                               11530099
W37916*--------------------------------------------------------         11540099
W37916*5000-UPDATE-TSIESGN.                                             11550099
W37916*                                                                 11560099
W37916*    PERFORM                                                      11570099
W37916*        WITH TEST AFTER                                          11580099
W37916*        VARYING PV-SQL-SUB                                       11590099
W37916*        FROM 1 BY 1                                              11600099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 11610099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      11620099
W37916*                                                                 11630099
W37916*        EXEC SQL                                                 11640099
W37916*            UPDATE TSIESGN                                       11650099
W37916*               SET SGN_PRCDNC_NBR    = :SIT00073-SGN-PRCDNC-NBR  11660099
W37916*                 , CHG_USR_ID        = :PC-PROGRAM-NAME          11670099
W37916*                 , CHG_TMST          = :PV-CURRENT-TIMESTAMP     11680099
W37916*             WHERE SGN_NBR           = :SIESGN-SGN-NBR           11690099
W37916*        END-EXEC                                                 11700099
W37916*                                                                 11710099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              11720099
W37916*                                                                 11730099
W37916*        EVALUATE TRUE                                            11740099
W37916*            WHEN SQLCODE = -904                                  11750099
W37916*            WHEN SQLCODE = -911                                  11760099
W37916*            WHEN SQLCODE = -913                                  11770099
W37916*                 CONTINUE                                        11780099
W37916*            WHEN SQLCODE = 0                                     11790099
W37916*                 ADD +1              TO PV-TOTAL-SIGNS-UPDATED   11800099
W37916*                                        PV-UPDATE-COUNT          11810099
W37916*            WHEN OTHER                                           11820099
W37916*                 DISPLAY 'XSKUP031 ERROR UPDATING SIGN '         11830099
W37916*                          SIESGN-SGN-NBR                         11840099
W37916*                         ' FOR PROMO ID ' XST00026-PROMO-ID      11850099
W37916*                         ' WITH SQL CDE ' PV-SQL-CODE            11860099
W37916*        END-EVALUATE                                             11870099
W37916*    END-PERFORM.                                                 11880099
W37916*                                                                 11890099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         11900099
W37916*        DISPLAY 'XSKUP031 ERROR UPDATING SIGN ' SIESGN-SGN-NBR   11910099
W37916*                ' FOR PROMO ID ' XST00026-PROMO-ID               11920099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     11930099
W37916*    END-IF.                                                      11940099
W37916                                                                  11950099
W37916*--------------------------------------------------------         11960099
W37916* 5100-UPDATE-SIT-TOPR-SGN.                                       11970099
W37916*     ALL PROCESSING TO DETERMINE THE TOPPERS TO UPDATE AND       11980099
W37916*     THE NEW TOPPER ASSIGNMENT ID HAS BEEN COMPLETED -           11990099
W37916*     PERFORM THE UPDATE.                                         12000099
W37916*     IF THIS CALL FAILS, IT SHOULD NOT PREVENT THE MAIN          12010099
W37916*     UPDATES FROM BEING PERFORMED.                               12020099
W37916*--------------------------------------------------------         12030099
W37916*5100-UPDATE-SIT-TOPR-SGN.                                        12040099
W37916*                                                                 12050099
W37916*    PERFORM                                                      12060099
W37916*        WITH TEST AFTER                                          12070099
W37916*        VARYING PV-SQL-SUB                                       12080099
W37916*        FROM 1 BY 1                                              12090099
W37916*        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 12100099
W37916*                  OR  SQLCODE NOT = -904 AND -911 AND -913)      12110099
W37916*                                                                 12120099
W37916*        EXEC SQL                                                 12130099
W37916*            UPDATE SIT_TOPR_SGN                                  12140099
W37916*               SET TOPR_ASGMT_ID     = :SIT00055-TOPR-ASGMT-ID   12150099
W37916*                 , LAST_UPD_USR_ID   = :PC-PROGRAM-NAME          12160099
W37916*                 , LAST_UPD_TMST     = :PV-CURRENT-TIMESTAMP     12170099
W37916*             WHERE SGN_NBR           = :SIESGN-SGN-NBR           12180099
W37916*        END-EXEC                                                 12190099
W37916*                                                                 12200099
W37916*        MOVE SQLCODE TO PV-SQL-CODE                              12210099
W37916*                                                                 12220099
W37916*        EVALUATE TRUE                                            12230099
W37916*            WHEN SQLCODE = -904                                  12240099
W37916*            WHEN SQLCODE = -911                                  12250099
W37916*            WHEN SQLCODE = -913                                  12260099
W37916*                 CONTINUE                                        12270099
W37916*            WHEN SQLCODE = 0                                     12280099
W37916*                 ADD +1              TO PV-TOTAL-TOPPERS-UPDATED 12290099
W37916*                                        PV-UPDATE-COUNT          12300099
W37916*            WHEN OTHER                                           12310099
W37916*                 DISPLAY 'XSKUP031 ERROR UPDATING TOPPER '       12320099
W37916*                          SIESGN-SGN-NBR                         12330099
W37916*                         ' FOR PROMO ID ' XST00026-PROMO-ID      12340099
W37916*                         ' WITH SQL CDE ' PV-SQL-CODE            12350099
W37916*        END-EVALUATE                                             12360099
W37916*    END-PERFORM.                                                 12370099
W37916*                                                                 12380099
W37916*    IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         12390099
W37916*        DISPLAY 'XSKUP031 ERROR UPDATING TOPPER ' SIESGN-SGN-NBR 12400099
W37916*                ' FOR PROMO ID ' XST00026-PROMO-ID               12410099
W37916*                ' WITH SQL CDE ' PV-SQL-CODE                     12420099
W37916*    END-IF.                                                      12430099
W37916                                                                  12440099
W37916*----------------------------------------------------------       12450099
W37916* 5500-COMMIT-DATA.                                               12460099
W37916*     COMMIT UPDATES TO THE DATABASE.                             12470099
W37916*----------------------------------------------------------       12480099
W37916 5500-COMMIT-DATA.                                                12490099
W37916                                                                  12500099
W37916     PERFORM                                                      12510099
W37916         WITH TEST AFTER                                          12520099
W37916         VARYING PV-SQL-SUB                                       12530099
W37916         FROM 1 BY 1                                              12540099
W37916         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 12550099
W37916                   OR  SQLCODE = 0)                               12560099
W37916                                                                  12570099
W37916         EXEC SQL                                                 12580099
W37916             COMMIT                                               12590099
W37916         END-EXEC                                                 12600099
W37916                                                                  12610099
W37916         EVALUATE TRUE                                            12620099
W37916             WHEN SQLCODE = -904                                  12630099
W37916             WHEN SQLCODE = -911                                  12640099
W37916             WHEN SQLCODE = -913                                  12650099
W37916                  CONTINUE                                        12660099
W37916             WHEN SQLCODE = 0                                     12670099
W37916                  DISPLAY 'XSKUP031 COMMIT PERFORMED'             12680099
W37916             WHEN OTHER                                           12690099
W37916                  DISPLAY 'XSKUP031 UNABLE TO COMMIT DATA FOR '   12700099
W37916                          ' PROMO ID ' XST00026-PROMO-ID          12710099
W37916                          ' WITH SQL CDE ' PV-SQL-CODE            12720099
W37916         END-EVALUATE                                             12730099
W37916     END-PERFORM.                                                 12740099
W37916                                                                  12750099
W37916     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        12760099
W37916         DISPLAY 'XSKUP031 UNABLE TO COMMIT DATA FOR PROMO ID '   12770099
W37916                  XST00026-PROMO-ID                               12780099
W37916                 ' WITH SQL CDE ' PV-SQL-CODE                     12790099
W37916     END-IF.                                                      12800099
W37916                                                                  12810099
W37916                                                                  12820099
037060*----------------------------------------------------------       12830005
037100* 9000-LOAD-SEVERITY-ERROR.                                       12840005
037200*     THIS PROCEDURE IS CALLED IF THE RECORD WAS NOT UPDATED      12850005
037300*     OR INSERTED INTO THE PROMOTION TABLE.  COMPARES THE         12860005
037400*     MAXIMUM OFFSET DATE TO THE PROMO BUSINESS EVENT START       12870005
037500*     DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN THE          12880005
037600*     PROMO START DATE THE ERROR IS UNCRITICAL, OTHERWISE         12890005
037700*     IT IS CRITICAL.                                             12900005
037800*----------------------------------------------------------       12910005
037900 9000-LOAD-SEVERITY-ERROR.                                        12920005
038000                                                                  12930005
038100     IF PV-PROMO-STRT-DTE = SPACES                                12940005
038200        MOVE ZEROES TO PV-PROMO-STRT-DTE-NBR                      12950005
038300     ELSE                                                         12960005
038400        PERFORM 9100-FORMAT-DATE-INFO                             12970005
038500     END-IF.                                                      12980005
038600                                                                  12990005
038700     IF (PV-MAX-OFFSET-DTE < PV-PROMO-STRT-DTE-NBR) AND           13000005
038800       (PV-MAX-OFFSET-DTE NOT = ZEROES) AND                       13010005
038900       (PV-PROMO-STRT-DTE-NBR NOT = ZEROES)                       13020005
039000        SET PV-NOT-CRITICAL-ERROR TO TRUE                         13030005
039100     ELSE                                                         13040005
039200        SET PV-CRITICAL-ERROR TO TRUE                             13050005
039300     END-IF.                                                      13060005
039400                                                                  13070005
039410     INITIALIZE PV-SQL-SUB.                                       13080009
039420                                                                  13090009
039500*9000-EXIT.                                                       13100005
039600 EJECT.                                                           13110005
039700                                                                  13120005
039800*----------------------------------------------------------       13130005
039900* 9100-FORMAT-DATE-INFO.                                          13140005
040000*     FORMATS THE DATE FOR COMPARING.                             13150005
040100*----------------------------------------------------------       13160005
040200 9100-FORMAT-DATE-INFO.                                           13170005
040300                                                                  13180005
040400     MOVE PV-PROMO-DTE-TM-CCYY TO PV-PROMO-DTE-CCYY.              13190005
040500     MOVE PV-PROMO-DTE-TM-MM   TO PV-PROMO-DTE-MM.                13200005
040600     MOVE PV-PROMO-DTE-TM-DD   TO PV-PROMO-DTE-DD.                13210005
040700                                                                  13220005
040800*9100-EXIT.                                                       13230005
040900 EJECT.                                                           13240005
041000                                                                  13250005
041100*----------------------------------------------------------       13260005
041200* 9999-WRAPUP.                                                    13270005
041300*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           13280005
041400*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           13290005
041500*     PROGRAM.                                                    13300005
041600*----------------------------------------------------------       13310005
041700 9999-WRAPUP.                                                     13320005
041900                                                                  13330071
041900     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 13340071
0410       IF LV-LD-SQL-RETURN-CDE = 4051                               13350081
0410          CONTINUE                                                  13360097
0410       ELSE                                                         13370060
042000        MOVE PV-SQL-CODE    TO LV-LD-SQL-RETURN-CDE               13380077
0410       END-IF.                                                      13390060
042100     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                13400005
042200                                                                  13410005
042300*9999-EXIT.                                                       13420005
042400 EJECT.                                                           13430005
042500                                                                  13440005
