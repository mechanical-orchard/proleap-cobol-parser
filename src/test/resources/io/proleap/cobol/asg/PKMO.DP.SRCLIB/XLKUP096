000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    XLKUP096.                                         00040021
000500 AUTHOR.        SIVARAMAKRISHNAN.                                 00050022
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   OCTOBER 2017.                                     00070022
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*  THIS BATCH DB2 PROGRAM PERFORMS INSERT/UPDATE/DELETE ON PACK   00100022
001100*  UPC (XLT_PK_UPC) TABLE BASED ON ERROR MESSAGE FROM INPUT FILE  00110022
001200***************************************************************** 00113000
001300 ENVIRONMENT DIVISION.                                            00114000
001400 INPUT-OUTPUT SECTION.                                            00115000
001500                                                                  00116000
001600 FILE-CONTROL.                                                    00117000
001700                                                                  00118000
001800     SELECT XLT-PK-UPC-IN                                         00119000
001900         ASSIGN TO INP01.                                         00120000
002000                                                                  00131015
002100     SELECT SUMMARY-FILE                                          00132015
002200         ASSIGN TO OUT01.                                         00133015
002300                                                                  00134015
002400***************************************************************** 00140000
002500 DATA DIVISION.                                                   00150000
002600***************************************************************** 00160000
002700 FILE SECTION.                                                    00170000
002800                                                                  00180000
002900 FD  XLT-PK-UPC-IN                                                00190000
003000     RECORDING MODE IS F                                          00200000
003100     BLOCK CONTAINS 0 RECORDS                                     00210000
003200     LABEL RECORDS ARE STANDARD.                                  00220000
003300                                                                  00230000
003400 01  XLT-PK-UPC-IN-RECORD             PIC X(144).                 00240000
003500                                                                  00250000
003600 FD  SUMMARY-FILE                                                 00251015
003700     RECORDING MODE IS F                                          00252015
003800     BLOCK CONTAINS 0 RECORDS                                     00253015
003900     LABEL RECORDS ARE STANDARD.                                  00254015
004000                                                                  00255015
004100 01  SUMMARY-FILE-RECORD              PIC X(24).                  00256019
004200                                                                  00260000
004300***************************************************************** 00270000
004400 WORKING-STORAGE SECTION.                                         00280000
004500                                                                  00290000
004600 01  PA-DB2-COMMIT-COUNT              PIC S9(09) VALUE +0         00300000
004700                                                    COMP-3.       00310000
004800 01  PS-PROGRAM-SWITCHES.                                         00320000
004900     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00330000
005000         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00340000
005100         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00350000
005200                                                                  00360000
005300 01  PC-PROGRAM-CONSTANTS.                                        00370000
005400     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XLKUP096'.00380021
005500                                                                  00390000
005600 01  PV-PROGRAM-VARIABLES.                                        00400000
005700     05  PV-RECORDS-READ              PIC  9(09) VALUE  0.        00410000
005800     05  PV-RECORDS-INSERTED          PIC  9(09) VALUE  0.        00420000
005900     05  PV-RECORDS-SKIP              PIC  9(09) VALUE  0.        00430000
006000     05  PV-RECORDS-UPDATED           PIC  9(09) VALUE  0.        00431004
006100     05  PV-UPDATE-NOT-FOUND          PIC  9(09) VALUE  0.        00432008
006200     05  PV-RECORDS-DELETED           PIC  9(09) VALUE  0.        00433008
006300     05  PV-DELETE-NOT-FOUND          PIC  9(09) VALUE  0.        00434008
006400     05  PV-DISP-UPC-ID               PIC  9(09) VALUE  0.        00440000
006500     05  PV-DISP-UPC-NBR              PIC  9(15) VALUE  0.        00450000
006600     05  PV-SQLCODE                   PIC  S9(9) VALUE +0.        00460000
006700     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00470000
006800     05  PV-ZERO-LINE                 PIC X(24)                   00471019
006900                                           VALUE 'XLT_PK_UPC'.    00471116
007000     05  PV-FIRST-LINE                PIC X(24)  VALUE SPACES.    00471219
007100     05  PV-SECOND-LINE               PIC X(24)  VALUE SPACES.    00472019
007200     05  PV-THIRD-LINE                PIC X(24)  VALUE SPACES.    00473019
007300                                                                  00480000
007400                                                                  00490000
007500 01  PV-ABEND-FIELDS.                                             00500000
007600     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00510000
007700                                                 COMP SYNC.       00520000
007800     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'XLKUP096'.00530021
007900     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00540000
008000     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00550000
008100     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00560000
008200     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00570000
008300     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00580000
008400     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00590000
008500                                                                  00600000
008600                                                                  00610000
008700***********************************************************       00620000
008800*  COPYBOOK USED FOR THE UPCEAN INPUT FILE              *         00630000
008900***********************************************************       00640000
009000     COPY XLRD031.                                                00650000
009100                                                                  00660000
009200***********************************************************       00670000
009300*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00680000
009400***********************************************************       00690000
009500     COPY DPWS004.                                                00700000
009600                                                                  00710000
009700***********************************************************       00720000
009800*  DB2 SQL COMMUNICATION AREA                             *       00730000
009900***********************************************************       00740000
010000     EXEC SQL                                                     00750000
010100          INCLUDE SQLCA                                           00760000
010200     END-EXEC.                                                    00770000
010300                                                                  00780000
010400***********************************************************       00790000
010500*  XLT_PK_UPC TABLE                                       *       00800000
010600***********************************************************       00810000
010700     EXEC SQL                                                     00820000
010800          INCLUDE XLT00009                                        00830000
010900     END-EXEC.                                                    00840000
011000                                                                  00850000
011100***************************************************************** 00860000
011200 PROCEDURE DIVISION.                                              00870000
011300***************************************************************** 00880000
011400     DISPLAY '**** BEGINNING XLKUP096 ****'.                      00890021
011500     DISPLAY ' '.                                                 00900000
011600                                                                  00910000
011700     OPEN INPUT  XLT-PK-UPC-IN.                                   00920000
011800     OPEN OUTPUT SUMMARY-FILE.                                    00921015
011900                                                                  00930000
012000     PERFORM 1000-READ-INPUT-FILE.                                00940000
012100                                                                  00950000
012200     PERFORM 2000-PROCESS-INPUT-FILE                              00960000
012300       UNTIL PS-EOF-INPUT-YES.                                    00970000
012400                                                                  00980000
012500     CLOSE XLT-PK-UPC-IN.                                         00990000
012600                                                                  01000000
012700     PERFORM 3000-TABLE-COMMIT.                                   01010000
012800     PERFORM 4000-WRITE-SUMMARY.                                  01011015
012900                                                                  01020000
013000     DISPLAY '  INPUT UPC RECS READ      = ' PV-RECORDS-READ.     01030000
013100     DISPLAY '  XLT_PK_UPC ROWS INSERTED = ' PV-RECORDS-INSERTED. 01040000
013200     DISPLAY '  XLT_PK_UPC INSERT SKIPPED = ' PV-RECORDS-SKIP.    01050020
013300     DISPLAY '  XLT_PK_UPC ROWS UPDATED  = ' PV-RECORDS-UPDATED.  01051004
013400     DISPLAY '  XLT_PK_UPC UPDATE SKIPPED= ' PV-UPDATE-NOT-FOUND. 01052009
013500     DISPLAY '  XLT_PK_UPC ROWS DELETED  = ' PV-RECORDS-DELETED.  01053014
013600     DISPLAY '  XLT_PK_UPC DELETE SKIPPED= ' PV-DELETE-NOT-FOUND. 01054009
013700     DISPLAY ' '.                                                 01060000
013800     DISPLAY '****  END OF  XLKUP096  ****'.                      01070021
013900                                                                  01080000
014000     CLOSE SUMMARY-FILE.                                          01081015
014100     STOP RUN.                                                    01090000
014200                                                                  01100000
014300                                                                  01110000
014400***************************************************************** 01120000
014500*  READ A PACKHEAD EXTRACT RECORD THAT WILL BE USED TO INSERT    *01130000
014600*  A ROW OF DATA INTO THE XLT_PK TABLE.                        *  01140000
014700***************************************************************** 01150000
014800 1000-READ-INPUT-FILE.                                            01160000
014900                                                                  01170000
015000     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       01180000
015100                                                                  01190000
015200     INITIALIZE PA-DB2-COMMIT-COUNT.                              01200000
015300                                                                  01210000
015400     READ XLT-PK-UPC-IN                                           01220000
015500          INTO XL031-PACK-UPC-DATA                                01230000
015600            AT END                                                01240000
015700               SET PS-EOF-INPUT-YES TO TRUE                       01250000
015800                                                                  01260000
015900            NOT AT END                                            01270000
016000               SET PS-EOF-INPUT-NO  TO TRUE                       01280000
016100               ADD +1 TO PV-RECORDS-READ                          01290000
016200     END-READ.                                                    01300000
016300                                                                  01310000
016400                                                                  01320000
016500***************************************************************** 01330000
016600*  LOAD THE INFORMATION FROM THE UPCEAN EXTRACT FILE INTO THE *   01340000
016700*  HOST VARIABLES AND PERFORM A PARAGRAPH TO INSERT THE NEW ROW * 01350000
016800*  INTO THE XLT_PK_UPC TABLE.                                   * 01360000
016900***************************************************************** 01370000
017000 2000-PROCESS-INPUT-FILE.                                         01380000
017100                                                                  01390000
017200     MOVE '2000-PROCESS-INPUT-FILE ' TO PV-ABEND-PARAGRAPH.       01400000
017300                                                                  01410000
017400     MOVE XL031-UPC-PK-SKU-NBR       TO XLT00009-PK-SKU-NBR       01420000
017500     MOVE XL031-UPC-UPC-NBR          TO XLT00009-UPC-NBR          01430000
017600     MOVE XL031-UPC-EDI-ORD-IND      TO XLT00009-EDI-ORD-IND      01440000
017700                                                                  01450000
017800     IF  XL031-UPC-ERROR-MESSAGE = 'NOT ON DOMAIN PACK UPC'       01460000
017900         PERFORM 2100-INSERT-XLT-PK-UPC                           01470000
018000     END-IF.                                                      01480000
018100                                                                  01490000
018200     IF  XL031-UPC-ERROR-MESSAGE = 'DATA MISMATCH - RMS'          01491004
018300         PERFORM 2200-UPDATE-XLT-PK-UPC                           01492004
018400     END-IF.                                                      01493003
018500                                                                  01493108
018600     IF  XL031-UPC-ERROR-MESSAGE = 'NOT ON RMS PACK UPC'          01493211
018700         PERFORM 2300-DELETE-XLT-PK-UPC                           01493308
018800     END-IF.                                                      01493408
018900                                                                  01494003
019000     PERFORM 1000-READ-INPUT-FILE.                                01500000
019100                                                                  01510000
019200                                                                  01520000
019300***************************************************************** 01530000
019400*  INSERT A ROW TO THE XLT_PK_UPC TABLE                        *  01540000
019500***************************************************************** 01550000
019600 2100-INSERT-XLT-PK-UPC.                                          01560000
019700                                                                  01570000
019800     EXEC SQL                                                     01580000
019900          INSERT                                                  01590000
020000          INTO  XLT_PK_UPC                                        01600000
020100              ( PK_SKU_NBR                                        01610000
020200               ,UPC_NBR                                           01620000
020300               ,EDI_ORD_IND                                       01630002
020400               ,LAST_UPD_TMST)                                    01631002
020500          VALUES                                                  01640000
020600             (  :XLT00009-PK-SKU-NBR                              01650000
020700               ,:XLT00009-UPC-NBR                                 01660000
020800               ,:XLT00009-EDI-ORD-IND                             01670002
020900               ,CURRENT TIMESTAMP)                                01671002
021000     END-EXEC.                                                    01680000
021100                                                                  01690000
021200     EVALUATE TRUE                                                01700000
021300         WHEN SQLCODE = ZERO                                      01710000
021400              ADD +1                 TO PV-RECORDS-INSERTED       01720000
021500              ADD +1                 TO PA-DB2-COMMIT-COUNT       01730000
021600              IF PA-DB2-COMMIT-COUNT > 4500                       01740000
021700                  PERFORM 3000-TABLE-COMMIT                       01750000
021800                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01760000
021900              END-IF                                              01770000
022000         WHEN SQLCODE = -803                                      01780000
022100         WHEN SQLCODE = -530                                      01790000
022200              ADD +1                 TO PV-RECORDS-SKIP           01800000
022300         WHEN SQLCODE NOT = +0                                    01810000
022400              MOVE '2100-INSERT-XLT-PK-UPC'                       01820000
022500                                     TO PV-ABEND-PARAGRAPH        01830000
022600              MOVE 'INSERT XLT_PK_UPC'                            01840000
022700                                     TO PV-ABEND-OPERATION        01850000
022800              STRING 'SKU NBR: '          DELIMITED BY SIZE       01860000
022900                     XL031-UPC-PK-SKU-NBR DELIMITED BY SIZE       01870000
023000                                   INTO PV-DB2-OPERATION-MESSAGE-101880000
023100                                                                  01890000
023200              MOVE 'XLT_PK_UPC'      TO PV-ABEND-TABLE            01900000
023300              PERFORM Z999-SQL-ABEND                              01910000
023400     END-EVALUATE.                                                01920000
023500                                                                  01930000
023600                                                                  01940000
023700***************************************************************** 01941004
023800*  UPDATE A ROW TO THE XLT_PK_UPC TABLE                        *  01942004
023900***************************************************************** 01943004
024000 2200-UPDATE-XLT-PK-UPC.                                          01944007
024100                                                                  01945004
024200     EXEC SQL                                                     01946004
024300          UPDATE                                                  01947005
024400            XLT_PK_UPC                                            01947105
024500          SET                                                     01948005
024600                 EDI_ORD_IND   = :XLT00009-EDI-ORD-IND            01948106
024700             ,   LAST_UPD_TMST = CURRENT TIMESTAMP                01948206
024800          WHERE                                                   01949005
024900                 PK_SKU_NBR    = :XLT00009-PK-SKU-NBR             01949406
025000             AND UPC_NBR       = :XLT00009-UPC-NBR                01949506
025100     END-EXEC.                                                    01949904
025200                                                                  01950004
025300     EVALUATE TRUE                                                01950104
025400         WHEN SQLCODE = ZERO                                      01950204
025500              ADD +1                 TO PV-RECORDS-UPDATED        01950304
025600              ADD +1                 TO PA-DB2-COMMIT-COUNT       01950404
025700              IF PA-DB2-COMMIT-COUNT > 4500                       01950504
025800                  PERFORM 3000-TABLE-COMMIT                       01950604
025900                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01950704
026000              END-IF                                              01950804
026100         WHEN SQLCODE = +100                                      01950904
026200              ADD +1                 TO PV-UPDATE-NOT-FOUND       01951108
026300         WHEN SQLCODE NOT = +0                                    01951204
026400              MOVE '2200-UPDATE-XLT-PK-UPC'                       01951304
026500                                     TO PV-ABEND-PARAGRAPH        01951404
026600              MOVE 'UPDATE XLT_PK_UPC'                            01951504
026700                                     TO PV-ABEND-OPERATION        01951604
026800              STRING 'SKU NBR: '          DELIMITED BY SIZE       01951704
026900                     XL031-UPC-PK-SKU-NBR DELIMITED BY SIZE       01951804
027000                                   INTO PV-DB2-OPERATION-MESSAGE-101951904
027100                                                                  01952004
027200              MOVE 'XLT_PK_UPC'      TO PV-ABEND-TABLE            01952104
027300              PERFORM Z999-SQL-ABEND                              01952204
027400     END-EVALUATE.                                                01952304
027500                                                                  01952404
027600                                                                  01952504
027700***************************************************************** 01952608
027800*  DELETE A ROW TO THE XLT_PK_UPC TABLE                        *  01952708
027900***************************************************************** 01952808
028000 2300-DELETE-XLT-PK-UPC.                                          01952908
028100                                                                  01953008
028200     EXEC SQL                                                     01953108
028300          DELETE                                                  01953208
028400            FROM XLT_PK_UPC                                       01953310
028500          WHERE                                                   01953708
028600                 PK_SKU_NBR    = :XLT00009-PK-SKU-NBR             01953808
028700             AND UPC_NBR       = :XLT00009-UPC-NBR                01953908
028800     END-EXEC.                                                    01954008
028900                                                                  01954108
029000     EVALUATE TRUE                                                01954208
029100         WHEN SQLCODE = ZERO                                      01954308
029200              ADD +1                 TO PV-RECORDS-DELETED        01954408
029300              ADD +1                 TO PA-DB2-COMMIT-COUNT       01954508
029400              IF PA-DB2-COMMIT-COUNT > 4500                       01954608
029500                  PERFORM 3000-TABLE-COMMIT                       01954708
029600                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01954808
029700              END-IF                                              01954908
029800         WHEN SQLCODE = +100                                      01955008
029900              ADD +1                 TO PV-DELETE-NOT-FOUND       01955108
030000         WHEN SQLCODE NOT = +0                                    01955208
030100              MOVE '2300-DELETE-XLT-PK-UPC'                       01955308
030200                                     TO PV-ABEND-PARAGRAPH        01955408
030300              MOVE 'DELETE XLT_PK_UPC'                            01955508
030400                                     TO PV-ABEND-OPERATION        01955608
030500              STRING 'SKU NBR: '          DELIMITED BY SIZE       01955708
030600                     XL031-UPC-PK-SKU-NBR DELIMITED BY SIZE       01955808
030700                                   INTO PV-DB2-OPERATION-MESSAGE-101955908
030800                                                                  01956008
030900              MOVE 'XLT_PK_UPC'      TO PV-ABEND-TABLE            01956108
031000              PERFORM Z999-SQL-ABEND                              01956208
031100     END-EVALUATE.                                                01956308
031200                                                                  01956408
031300                                                                  01956508
031400***************************************************************** 01957008
031500* COMMIT THE PENDING TABLE CHANGES.                             * 01960000
031600***************************************************************** 01970000
031700 3000-TABLE-COMMIT.                                               01980000
031800                                                                  01990000
031900     EXEC SQL                                                     02000000
032000          COMMIT                                                  02010000
032100     END-EXEC.                                                    02020000
032200                                                                  02030000
032300                                                                  02040000
032400***************************************************************** 02041015
032500* WRITE RECORDS PROCESSED COUNT TO COUNT FILE                 *   02042015
032600***************************************************************** 02043015
032700 4000-WRITE-SUMMARY.                                              02044015
032800                                                                  02045015
032900     STRING "NO. OF INSERTS:"     DELIMITED BY SIZE               02046015
033000             PV-RECORDS-INSERTED  DELIMITED BY SPACE              02047015
033100      INTO PV-FIRST-LINE                                          02048015
033200                                                                  02049015
033300     STRING "NO. OF UPDATES:"     DELIMITED BY SIZE               02049115
033400             PV-RECORDS-UPDATED   DELIMITED BY SPACE              02049215
033500      INTO PV-SECOND-LINE                                         02049315
033600                                                                  02049415
033700     STRING "NO. OF DELETES:"     DELIMITED BY SIZE               02049515
033800             PV-RECORDS-DELETED   DELIMITED BY SPACE              02049615
033900      INTO PV-THIRD-LINE                                          02049715
034000                                                                  02049815
034100     WRITE SUMMARY-FILE-RECORD FROM PV-ZERO-LINE.                 02049917
034200     WRITE SUMMARY-FILE-RECORD FROM PV-FIRST-LINE.                02050017
034300     WRITE SUMMARY-FILE-RECORD FROM PV-SECOND-LINE.               02050117
034400     WRITE SUMMARY-FILE-RECORD FROM PV-THIRD-LINE.                02050217
034500***************************************************************** 02051000
034600*  DISPLAY DB2 ERROR INFORMATION, ROLLBACK ANY PENDING CHANGES, * 02060000
034700*  AND ABEND THE PROGRAM.                                       * 02070000
034800***************************************************************** 02080000
034900 Z999-SQL-ABEND.                                                  02090000
035000                                                                  02100000
035100     MOVE SQLCODE            TO PV-SQLCODE.                       02110000
035200     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  02120000
035300     DISPLAY '*** DB2 ERROR '.                                    02130000
035400     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  02140000
035500     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02150000
035600     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02160000
035700     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02170000
035800     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02180000
035900     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02190000
036000     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02200000
036100     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE.                   02210000
036200                                                                  02220000
036300     COPY DPPD004.                                                02230000
036400                                                                  02240000
036500     MOVE +4013         TO PV-ABEND-CODE.                         02250000
036600     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02260000
