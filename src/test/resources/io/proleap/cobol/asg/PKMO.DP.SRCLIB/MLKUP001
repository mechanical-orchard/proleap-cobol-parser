       IDENTIFICATION DIVISION.                                                 
       PROGRAM-ID.    MLKUP001                                                  
       AUTHOR.        RYAN STAUFFACHER.                                         
       INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
       DATE-WRITTEN.  12/05/05.                                                 
       DATE-COMPILED.                                                           
                                                                                
      ******************************************************************        
      * THIS PROGRAM WILL POPULATE NEW ROWS ON THE 13 WEEK PERCENT     *        
      * TABLE.                                                         *        
      * ALL ACTIVE BRAND VENDOR DEPARTMENT COMBINATIONS ARE READ IN    *        
      * FROM THE BRAND VENDOR RELATIONSHIP TABLE.  FOR EACH BVD        *        
      * COMBINATION, THE MLT WEEKLY SUMMARY TABLE IS READ TO GET THE   *        
      * TOTAL FOR THE PREVIOUS THIRTEEN WEEKS FOR THE DA COST AMOUNT,  *        
      * DA RETAIL AMOUNT, MARKDOWN BUYER RETAIL AMOUNT, MARKDOWN STORE *        
      * RETAIL AMOUNT, RECEIPT GROSS COST AMOUNT, AND RTV COST AMOUNT. *        
      * TOTALS ARE KEPT FOR EACH VENDOR DEPARTMENT.  FOR EACH BVD      *        
      * COMBINATION A ROW IS INSERTED ONTO THE BRAND PRORATION PERCENT *        
      * TABLE.  EACH PERCENT ON THE PRORATION TABLE IS CALCULATED BY   *        
      * DETERMINING WHAT PERCENT OF THE VENDOR/DEPARTMENT TOTAL IS MADE*        
      * UP OF THE BRAND/VENDOR/DEPARTMENT.                             *        
      * THE PROGRAM WILL ONLY CALCULATE PERCENTS FOR DEPARTMENTS       *        
      * BETWEEN THE SPECIFIED START AND END DEPARTMENTS IN THE CONTROL *        
      * CARD.                                                          *        
      ******************************************************************        
W28582* W28582  09-14-2006 J SELWITSCHKA  ADD PRORATION AUDIT REPORT.           
      ******************************************************************        
      * INC1267353         COGNIZANT   INCREASED THE OCCURS AS 200              
      *                                FOR INTERNAL TABLE                       
      *                                PV-BRAND-TABLE.                          
      ******************************************************************        
      *  04/14/2020 JOB RENAMED FROM BVKUP001 TO MLKUP001                       
      ******************************************************************        
      * INC10971210        COGNIZANT   INCREASED THE OCCURS AS 999              
      *                                FOR INTERNAL TABLE                       
      *                                PV-BRAND-TABLE.                          
      ******************************************************************        
      * INC11319004        COGNIZANT   INCREASED THE OCCURS AS 9999             
      *                                FOR INTERNAL TABLE                       
      *                                PV-BRAND-TABLE.                          
      ******************************************************************        
       ENVIRONMENT DIVISION.                                                    
      ******************************************************************        
                                                                                
       CONFIGURATION SECTION.                                                   
                                                                                
       SOURCE-COMPUTER.        IBM-3090.                                        
       OBJECT-COMPUTER.        IMB-3090.                                        
                                                                                
       INPUT-OUTPUT SECTION.                                                    
                                                                                
       FILE-CONTROL.                                                            
           SELECT CNTL-DATE-FILE                                                
               ASSIGN TO INP01.                                                 
NKEEP      SELECT CNTL-DEPT-FILE                                                
NKEEP          ASSIGN TO INP02.                                                 
NKEEP      SELECT PRRTN-OUTPUT-FILE                                             
NKEEP          ASSIGN TO OUT01.                                                 
W28582     SELECT PRORATION-AUDIT-RPT                                           
W28582         ASSIGN TO OUT02.                                                 
      ******************************************************************        
       DATA DIVISION.                                                           
      ******************************************************************        
                                                                                
       FILE SECTION.                                                            
                                                                                
       FD  CNTL-DATE-FILE                                                       
           RECORDING  MODE IS F.                                                
       01  CNTL-DATE-REC                    PIC X(80).                          
                                                                                
NKEEP  FD  CNTL-DEPT-FILE                                                       
NKEEP      RECORDING  MODE IS F.                                                
NKEEP  01  CNTL-DEPT-REC                    PIC X(80).                          
                                                                                
NKEEP  FD  PRRTN-OUTPUT-FILE                                                    
NKEEP      RECORDING  MODE IS F.                                                
NKEEP  01  PRRTN-OUTPUT-REC                 PIC X(42).                          
W28582                                                                          
W28582 FD  PRORATION-AUDIT-RPT                                                  
W28582     RECORDING MODE IS F                                                  
W28582     LABEL RECORDS ARE STANDARD                                           
W28582     BLOCK CONTAINS 0 RECORDS.                                            
W28582 01  PRORATION-AUDIT-RECORD           PIC X(200).                         
W28582                                                                          
       WORKING-STORAGE SECTION.                                                 
                                                                                
       01  ABEND-CODE                        PIC S9(4) VALUE ZEROS              
                                                       COMP SYNC.               
           88  AC-OTHER-ERROR                          VALUE +4003.             
           88  AC-SQL-ERROR                            VALUE +4013.             
                                                                                
       01  PS-PROGRAM-SWITCHES.                                                 
           05  PS-MORE-BV-RECORDS-SW         PIC X(01) VALUE 'Y'.               
               88  PS-MORE-BV-RECORDS                  VALUE 'Y'.               
               88  PS-NO-MORE-BV-RECORDS               VALUE 'N'.               
           05  PS-CNTL-DATE-FILE-SW          PIC X     VALUE 'N'.               
               88  PS-END-OF-CNTL-DTE-FILE             VALUE 'Y'.               
NKEEP      05  PS-CNTL-DEPT-FILE-SW          PIC X     VALUE 'N'.               
NKEEP          88  PS-END-OF-CNTL-DPT-FILE             VALUE 'Y'.               
                                                                                
       01  ABEND-CODE-SQL              PIC S9(04)  VALUE ZERO COMP SYNC.        
                                                                                
       01  PC-PROGRAM-CONSTANTS.                                                
           05 PC-PGM-NAME                   PIC X(8)  VALUE 'MLKUP001'.         
           05 PC-MAX-RETRIES                PIC S9(03) VALUE 3 COMP-3.          
           05 PC-UNKNOWN-VENDOR             PIC  S9(9) VALUE +5161 COMP.        
           05 PC-UNKNOWN-BRAND              PIC  S9(4) VALUE +2230 COMP.        
W28582     05 PC-MAX-LINES-PER-PAGE         PIC  S9(4) COMP-3 VALUE +60.        
                                                                                
       01  PV-PROGRAM-VARIABLES.                                                
           05 PV-DATE-FIELDS.                                                   
              10 PV-PROCESS-DATE             PIC   X(10).                       
              10 PV-PROCESS-FSCL-YR          PIC   X(4).                        
              10 PV-PROCESS-FSCL-YR-9        REDEFINES                          
                 PV-PROCESS-FSCL-YR          PIC 9(04).                         
              10 PV-PROCESS-FSCL-WK          PIC   X(2).                        
              10 PV-PROCESS-FSCL-WK-9        REDEFINES                          
                 PV-PROCESS-FSCL-WK          PIC 9(02).                         
              10 PV-PROCESS-FSCL-WK-END-DTE  PIC X(10).                         
              10 PV-STRT-FSCL-WK             PIC X(02).                         
              10 PV-STRT-FSCL-WK-9           REDEFINES                          
                 PV-STRT-FSCL-WK             PIC 9(02).                         
              10 PV-STRT-FSCL-YR             PIC X(04).                         
              10 PV-STRT-FSCL-YR-9           REDEFINES                          
                 PV-STRT-FSCL-YR             PIC 9(04).                         
              10 PV-STRT-FSCL-WK-END-DTE     PIC X(10).                         
              10 PV-END-FSCL-WK              PIC X(02).                         
              10 PV-END-FSCL-WK-9            REDEFINES                          
                 PV-END-FSCL-WK              PIC 9(02).                         
              10 PV-END-FSCL-YR              PIC X(04).                         
              10 PV-END-FSCL-YR-9            REDEFINES                          
                 PV-END-FSCL-YR              PIC 9(04).                         
              10 PV-END-FSCL-WK-END-DTE      PIC X(10).                         
              10 PV-WORK-PROCESS-FSCL-WK     PIC S9(04) COMP.                   
              10 PV-WORK-PROCESS-FSCL-YR     PIC S9(04) COMP.                   
              10 PV-WORK-STRT-FSCL-WK        PIC S9(04) COMP.                   
              10 PV-WORK-STRT-FSCL-YR        PIC S9(04) COMP.                   
              10 PV-WORK-END-FSCL-WK         PIC S9(04) COMP.                   
              10 PV-WORK-END-FSCL-YR         PIC S9(04) COMP.                   
              10 PV-WORK-MAX-FSCL-WK         PIC X(02).                         
              10 PV-WORK-MAX-FSCL-WK-9       REDEFINES                          
                 PV-WORK-MAX-FSCL-WK         PIC 9(02).                         
              10 PV-WORK-MAX-FSCL-WK-COMP    PIC S9(04) COMP.                   
              10 PV-WORK-MAX-FSCL-YR         PIC X(04).                         
              10 PV-WORK-NEXT-FSCL-WK        PIC X(10).                         
W28582        10 PV-CURRENT-DATE.                                               
W28582           15  PV-CURRENT-DATE-YY      PIC X(02)  VALUE SPACES.           
W28582           15  PV-CURRENT-DATE-MM      PIC X(02)  VALUE SPACES.           
W28582           15  PV-CURRENT-DATE-DD      PIC X(02)  VALUE SPACES.           
W28582        10 PV-CURRENT-TIME.                                               
W28582           15  PV-CURRENT-TIME-HH      PIC X(02)  VALUE SPACES.           
W28582           15  PV-CURRENT-TIME-MM      PIC X(02)  VALUE SPACES.           
           05 PV-MISC.                                                          
              10 PV-RETRY-COUNTER            PIC S9(04) COMP.                   
              10 PV-PARAGRAPH-NAME           PIC X(30)  VALUE SPACES.           
              10 PV-DB2-OPERATION-ATTEMPTED  PIC X(30)  VALUE SPACES.           
              10 PV-DB2-DATE-EXISTS          PIC X(01).                         
NKEEP         10 PV-DB2-START-DEPT           PIC  S9(4)V COMP-3.                
NKEEP         10 PV-DB2-END-DEPT             PIC  S9(4)V COMP-3.                
           05 PV-BRND-VNDR-HOLD-FIELDS.                                         
              10 PV-HOLD-DEPT-NBR            PIC S9(4)V COMP-3                  
                                                        VALUE ZERO.             
              10 PV-HOLD-ENT-ID              PIC S9(9)  COMP                    
                                                        VALUE ZERO.             
              10 PV-HOLD-BRAND               PIC S9(4) COMP.                    
           05 PV-DB2-COUNT                   PIC S9(09) VALUE +0                
                                                         COMP-3.                
           05 PV-TOT-BRANDS                  PIC S9(09) VALUE +0                
                                                         COMP-3.                
           05 PV-BRAND-COUNT                 PIC S9(09) VALUE +0                
                                                         COMP-3.                
           05 PV-NULL                        PIC S9(04) VALUE +0 COMP.          
           05 PV-BRAND-VENDOR-TOTALS.                                           
              10  PV-TOT-PADJ-DA-COST-AMT   PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
              10  PV-TOT-MKDN-BYR-RTL-AMT   PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
              10  PV-TOT-MKDN-STR-RTL-AMT   PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
              10  PV-TOT-RCPT-GRO-COST-AMT  PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
              10  PV-TOT-PADJ-RTV-COST-AMT  PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
              10  PV-TOT-SLS-REG-RTL-AMT    PIC  S9(11)V9(2) COMP-3             
                                                             VALUE ZERO.        
           05 PV-LAST-BRND-WITH-DLRS.                                           
              10  PV-LB-PADJ-DA-COST        PIC S9(4) COMP VALUE ZERO.          
              10  PV-LB-MKDN-BYR-RTL        PIC S9(4) COMP VALUE ZERO.          
              10  PV-LB-MKDN-STR-RTL        PIC S9(4) COMP VALUE ZERO.          
              10  PV-LB-RCPT-GRO-COST       PIC S9(4) COMP VALUE ZERO.          
              10  PV-LB-PADJ-RTV-COST       PIC S9(4) COMP VALUE ZERO.          
              10  PV-LB-SLS-REG-RTL         PIC S9(4) COMP VALUE ZERO.          
                                                                                
              10  PV-TOT-PADJ-DA-COST-PCT   PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
              10  PV-TOT-MKDN-BYR-RTL-PCT   PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
              10  PV-TOT-MKDN-STR-RTL-PCT   PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
              10  PV-TOT-RCPT-GRO-COST-PCT  PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
              10  PV-TOT-PADJ-RTV-COST-PCT  PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
              10  PV-TOT-SLS-REG-RTL-PCT    PIC  S9(3)V9(2) COMP-3              
                                                            VALUE ZERO.         
W28582        10  PV-SUM-PADJ-DA-COST-PCT   PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
W28582        10  PV-SUM-MKDN-BYR-RTL-PCT   PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
W28582        10  PV-SUM-MKDN-STR-RTL-PCT   PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
W28582        10  PV-SUM-RCPT-GRO-COST-PCT  PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
W28582        10  PV-SUM-PADJ-RTV-COST-PCT  PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
W28582        10  PV-SUM-SLS-REG-RTL-PCT    PIC  S9(3)V9(2) COMP-3              
W28582                                                      VALUE ZERO.         
              10  PV-WORK-PADJ-DA-COST-PCT  PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
              10  PV-WORK-MKDN-BYR-RTL-PCT  PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
              10  PV-WORK-MKDN-STR-RTL-PCT  PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
              10  PV-WORK-RCPT-GRO-COST-PCT PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
              10  PV-WORK-PADJ-RTV-COST-PCT PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
              10  PV-WORK-SLS-REG-RTL-PCT   PIC  S9(3)V9(4) COMP-3              
                                                            VALUE ZERO.         
                                                                                
           05 PV-WORK-BRAND-VENDOR-FIELDS.                                      
              10  PV-WORK-PADJ-DA-COST-AMT   PIC  S9(11)V9(2) COMP-3.           
              10  PV-WORK-MKDN-BYR-RTL-AMT   PIC  S9(11)V9(2) COMP-3.           
              10  PV-WORK-MKDN-STR-RTL-AMT   PIC  S9(11)V9(2) COMP-3.           
              10  PV-WORK-RCPT-GRO-COST-AMT  PIC  S9(11)V9(2) COMP-3.           
              10  PV-WORK-PADJ-RTV-COST-AMT  PIC  S9(11)V9(2) COMP-3.           
              10  PV-WORK-SLS-REG-RTL-AMT    PIC  S9(11)V9(2) COMP-3.           
                                                                                
           05 PV-BRAND-TABLE-STRING          PIC X(100).                        
           05 PV-BRAND-TABLE-INFO.                                              
             10 PV-BRAND-TABLE OCCURS  9999 TIMES.                              
                15  PV-BT-LBL-SEQ-NBR        PIC  S9(4) COMP.                   
                15  PV-BT-PADJ-DA-COST-AMT   PIC  S9(11)V9(2) COMP-3.           
                15  PV-BT-MKDN-BYR-RTL-AMT   PIC  S9(11)V9(2) COMP-3.           
                15  PV-BT-MKDN-STR-RTL-AMT   PIC  S9(11)V9(2) COMP-3.           
                15  PV-BT-RCPT-GRO-COST-AMT  PIC  S9(11)V9(2) COMP-3.           
                15  PV-BT-PADJ-RTV-COST-AMT  PIC  S9(11)V9(2) COMP-3.           
                15  PV-BT-SLS-REG-RTL-AMT    PIC  S9(11)V9(2) COMP-3.           
W28582                                                                          
W28582     05 PV-DETAIL-PAGE-COUNT           PIC  S9(04)      VALUE +0          
W28582                                                        COMP-3.           
W28582     05 PV-DETAIL-LINE-COUNT           PIC  S9(04)      VALUE +0          
W28582                                                        COMP-3.           
W28582     05 PV-DETAIL-ADVANCE-LINE         PIC  S9(04)      VALUE +1          
W28582                                                        COMP-3.           
W28582                                                                          
W28582 01  HL1-HEADING-LINE-1.                                                  
W28582     05  FILLER                      PIC X(77)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(47)      VALUE                 
W28582         'BRAND VENDOR 13 WEEK PRORATION PERCENT ACTIVITY'.               
W28582     05  FILLER                      PIC X(76)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL2-HEADING-LINE-2.                                                  
W28582     05  FILLER                      PIC X(71)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(14)      VALUE                 
W28582         'PROCESS DATE: '.                                                
W28582     05  HL2-PROCESS-DTE             PIC X(10)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(25)      VALUE                 
W28582         '   FISCAL WEEK END DATE: '.                                     
W28582     05  HL2-FSCL-WK-END-DTE         PIC X(10)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(70)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL3-HEADING-LINE-3.                                                  
W28582     05  FILLER                      PIC X(87)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(13)      VALUE                 
W28582         'DEPARTMENTS: '.                                                 
W28582     05  HL3-DEPT-R1                 PIC 9(04)      VALUE ZEROES.         
W28582     05  FILLER                      PIC X(06)      VALUE                 
W28582         ' THRU '.                                                        
W28582     05  HL3-DEPT-R2                 PIC 9(04)      VALUE ZEROES.         
W28582     05  FILLER                      PIC X(86)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL4-HEADING-LINE-4.                                                  
W28582     05  FILLER                      PIC X(36)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(75)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(17)      VALUE                 
W28582         'PRORATION PERCENT'.                                             
W28582     05  FILLER                      PIC X(70)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(02)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL5-HEADING-LINE-5.                                                  
W28582     05  FILLER                      PIC X(41)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'MKDN BYR RTL'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'MKDN STR RTL'.                                                  
W28582     05  FILLER                      PIC X(16)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(13)      VALUE                 
W28582         'RCPT GRO COST'.                                                 
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'PADJ DA COST'.                                                  
W28582     05  FILLER                      PIC X(16)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(13)      VALUE                 
W28582         'PADJ RTV COST'.                                                 
W28582     05  FILLER                      PIC X(18)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(11)      VALUE                 
W28582         'SLS REG RTL'.                                                   
W28582     05  FILLER                      PIC X(02)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL6-HEADING-LINE-6.                                                  
W28582     05  FILLER                      PIC X(01)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(04)      VALUE                 
W28582         'DEPT'.                                                          
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(06)      VALUE                 
W28582         'ENT ID'.                                                        
W28582     05  FILLER                      PIC X(03)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(07)      VALUE                 
W28582         'LBL SEQ'.                                                       
W28582     05  FILLER                      PIC X(16)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(17)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(12)      VALUE                 
W28582         'AMT      PCT'.                                                  
W28582     05  FILLER                      PIC X(02)      VALUE SPACES.         
W28582                                                                          
W28582 01  HL7-HEADING-LINE-7.                                                  
W28582     05  FILLER                      PIC X(01)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(04)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(06)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(03)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(07)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(11)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(17)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(02)      VALUE SPACES.         
W28582                                                                          
W28582 01  DL1-DETAIL-LINE.                                                     
W28582     05  FILLER                      PIC X(01)       VALUE SPACES.        
W28582     05  DL1-DEPT-NBR                PIC 9(04)       VALUE ZEROES.        
W28582     05  FILLER                      PIC X(05)       VALUE SPACES.        
W28582     05  DL1-ENT-ID                  PIC 9(04)       VALUE ZEROES.        
W28582     05  FILLER                      PIC X(06)       VALUE SPACES.        
W28582     05  DL1-LBL-SEQ-NBR             PIC 9(04)       VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-PADJ-DA-COST-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-PADJ-DA-COST-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-MKDN-BYR-RTL-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-MKDN-BYR-RTL-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-MKDN-STR-RTL-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-MKDN-STR-RTL-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-RCPT-GRO-COST-AMT       PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-RCPT-GRO-COST-PCT       PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-PADJ-RTV-COST-AMT       PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-PADJ-RTV-COST-PCT       PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-SLS-REG-RTL-AMT         PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  DL1-SLS-REG-RTL-PCT         PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582                                                                          
W28582 01  TL1-TOTAL-LINE.                                                      
W28582     05  FILLER                      PIC X(36)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(12)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(08)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(04)      VALUE SPACES.         
W28582     05  FILLER                      PIC X(05)      VALUE ALL '-'.        
W28582     05  FILLER                      PIC X(02)      VALUE SPACES.         
W28582                                                                          
W28582 01  TL2-TOTAL-LINE.                                                      
W28582     05  FILLER                      PIC X(26)       VALUE SPACES.        
W28582     05  TL2-PADJ-DA-COST-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-PADJ-DA-COST-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-MKDN-BYR-RTL-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-MKDN-BYR-RTL-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-MKDN-STR-RTL-AMT        PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-MKDN-STR-RTL-PCT        PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-RCPT-GRO-COST-AMT       PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-RCPT-GRO-COST-PCT       PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-PADJ-RTV-COST-AMT       PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-PADJ-RTV-COST-PCT       PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-SLS-REG-RTL-AMT         PIC ---,---,---,--9.99               
W28582                                                     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582     05  TL2-SLS-REG-RTL-PCT         PIC ---9.99     VALUE ZEROES.        
W28582     05  FILLER                      PIC X(02)       VALUE SPACES.        
W28582                                                                          
W28582 01  TL-END-OF-REPORT-LINE.                                               
W28582     05  FILLER                      PIC X(78)       VALUE SPACES.        
W28582     05  FILLER                      PIC X(44)       VALUE                
W28582         '* * * *  E N D  O F  R E P O R T  * * * *'.                     
W28582     05  FILLER                      PIC X(78)       VALUE SPACES.        
W28582                                                                          
026900*****************************************************************         
027000*  CONTROL CARD DATE PROCESSING.                                          
027100*****************************************************************         
027200 01  CC-DATE-CNTL-CARD.                                                   
027500     05  CC-DT-PROC-DATE-ISO             PIC X(10).                       
027600     05  CC-DT-PROC-DATE-RDF REDEFINES                                    
027700         CC-DT-PROC-DATE-ISO.                                             
027800         10  CC-DT-PROC-CC               PIC X(02).                       
027900         10  CC-DT-PROC-YY               PIC X(02).                       
028000         10  FILLER                      PIC X(01).                       
028100         10  CC-DT-PROC-MM               PIC X(02).                       
028200         10  FILLER                      PIC X(01).                       
028300         10  CC-DT-PROC-DD               PIC X(02).                       
029600     05  FILLER                          PIC X(70).                       
026900*****************************************************************         
027000*  CONTROL CARD DEPT PROCESSING.                                          
027100*****************************************************************         
NKEEP  01  CC-DEPT-CNTL-CARD.                                                   
NKEEP      05  CC-DP-START-DEPT                PIC 9(4).                        
NKEEP      05  FILLER                          PIC X(1).                        
NKEEP      05  CC-DP-END-DEPT                  PIC 9(4).                        
NKEEP      05  FILLER                          PIC X(79).                       
W28582******************************************************************        
W28582* DEFAULT REPORT WORK RECORD                                              
W28582******************************************************************        
W28582 01  RP-REPORT-WORK-RECORD           PIC X(200)      VALUE SPACES.        
W28582                                                                          
W28582******************************************************************        
W28582* COPYBOOK FOR REPORT HEADING LINES, DETAIL LINE                          
W28582******************************************************************        
W28582     COPY DPWS200O.                                                       
W28582                                                                          
      ******************************************************************        
      *  DB2 SQL ERROR MESSAGE FORMAT AREA                                      
      ******************************************************************        
           COPY DPWS004.                                                        
                                                                                
                                                                                
      ******************************************************************        
      * BRAND PRORATION PERCENT TABLE                                           
      ******************************************************************        
           EXEC SQL                                                             
             INCLUDE BVT00003                                                   
           END-EXEC.                                                            
      ******************************************************************        
      * BRAND VENDOR RELATIONSHIP TABLE                                         
      ******************************************************************        
           EXEC SQL                                                             
             INCLUDE IMT00017                                                   
           END-EXEC.                                                            
      ******************************************************************        
      * MERCHANDISE LEDGER WEEKLY SUMMARY TABLE                                 
      ******************************************************************        
           EXEC SQL                                                             
             INCLUDE MLT00003                                                   
           END-EXEC.                                                            
      ******************************************************************        
      * MERCHANDISE LEDGER PARTITION CONTROL TABLE                              
      ******************************************************************        
           EXEC SQL                                                             
             INCLUDE MLT00005                                                   
           END-EXEC.                                                            
      ******************************************************************        
      * DATE ATTRIBUTE TABLE                                                    
      ******************************************************************        
           EXEC SQL                                                             
             INCLUDE TDTATTR                                                    
           END-EXEC.                                                            
      *****************************************************************         
      *    DB2 AREA FOR COMMUNICATIONS                                          
      *****************************************************************         
           EXEC SQL                                                             
                INCLUDE SQLCA                                                   
           END-EXEC.                                                            
      *****************************************************************         
      *    THIS CURSOR RETRIEVES CURRENT BRAND VENDOR RELATIONSHIPS   *         
      *****************************************************************         
                                                                                
           EXEC SQL                                                             
                DECLARE BRND-VNDR-CSR CURSOR WITH HOLD FOR                      
                SELECT DEPT_BRND_VND_ID                                         
                      ,DEPT_NBR                                                 
                      ,ENT_ID                                                   
                      ,LBL_SEQ_NBR                                              
                  FROM IMT_DEPT_BRND_VND BV1                                    
                 WHERE EFF_BEG_DTE <= :PV-PROCESS-DATE                          
                   AND (EFF_END_DTE >= :PV-PROCESS-DATE OR                      
                        EFF_END_DTE IS NULL)                                    
NKEEP              AND DEPT_NBR BETWEEN :PV-DB2-START-DEPT                      
NKEEP                               AND :PV-DB2-END-DEPT                        
                 ORDER BY DEPT_NBR, ENT_ID, LBL_SEQ_NBR                         
                   FOR FETCH ONLY                                               
           END-EXEC.                                                            
      ******************************************************************        
       PROCEDURE DIVISION.                                                      
      ******************************************************************        
                                                                                
       0000-MAINLINE.                                                           
                                                                                
           PERFORM 1000-INITIALIZE                                              
           PERFORM 2000-PROCESS-BRND-VNDR-CSR                                   
             UNTIL PS-NO-MORE-BV-RECORDS                                        
           IF PV-TOT-BRANDS > 0                                                 
             PERFORM 2100-VNDR-DEPT-CHGD                                        
           END-IF.                                                              
           PERFORM 4200-CLOSE-BRND-VNDR-CSR                                     
W28582** WRITE END OF REPORT LINE                                               
W28582     MOVE TL-END-OF-REPORT-LINE TO RP-REPORT-WORK-RECORD.                 
W28582     MOVE +3                    TO PV-DETAIL-ADVANCE-LINE.                
W28582     PERFORM 7200-WRITE-DETAIL-RECORD.                                    
           CLOSE CNTL-DATE-FILE                                                 
NKEEP            CNTL-DEPT-FILE                                                 
NKEEP            PRRTN-OUTPUT-FILE                                              
W28582           PRORATION-AUDIT-RPT                                            
                                                                                
           STOP RUN.                                                            
      ******************************************************************        
      *  PERFORM THE NECESSARY INITIALIZATION STEPS                             
      ******************************************************************        
       1000-INITIALIZE.                                                         
           OPEN INPUT CNTL-DATE-FILE                                            
                      CNTL-DEPT-FILE                                            
           OPEN OUTPUT PRRTN-OUTPUT-FILE                                        
W28582                 PRORATION-AUDIT-RPT                                      
                                                                                
           MOVE ZERO TO PV-TOT-BRANDS                                           
                        PV-BRAND-COUNT.                                         
                                                                                
           PERFORM 9000-READ-CNTL-DTE.                                          
NKEEP      PERFORM 9100-READ-DEPT-FILE.                                         
NKEEP      MOVE CC-DP-START-DEPT TO PV-DB2-START-DEPT                           
W28582                              HL3-DEPT-R1.                                
NKEEP      MOVE CC-DP-END-DEPT   TO PV-DB2-END-DEPT                             
W28582                              HL3-DEPT-R2.                                
                                                                                
W28582     ACCEPT PV-CURRENT-DATE   FROM DATE.                                  
W28582     ACCEPT PV-CURRENT-TIME   FROM TIME.                                  
W28582                                                                          
W28582     MOVE PV-CURRENT-DATE-MM  TO DP200O-RUN-MONTH.                        
W28582     MOVE PV-CURRENT-DATE-DD  TO DP200O-RUN-DAY.                          
W28582     MOVE PV-CURRENT-DATE-YY  TO DP200O-RUN-YEAR.                         
W28582     MOVE PV-CURRENT-TIME-HH  TO DP200O-RUN-HOUR.                         
W28582     MOVE PV-CURRENT-TIME-MM  TO DP200O-RUN-MINUTE.                       
W28582     MOVE PC-PGM-NAME         TO DP200O-PROGRAM-NAME.                     
W28582                                                                          
           PERFORM 3000-GET-PROCESS-DATE-INFO.                                  
W28582     MOVE PV-PROCESS-DATE            TO HL2-PROCESS-DTE.                  
W28582     MOVE PV-PROCESS-FSCL-WK-END-DTE TO HL2-FSCL-WK-END-DTE.              
           PERFORM 1100-CALC-END-DATE.                                          
           PERFORM 1200-CALC-BEGIN-DATE.                                        
                                                                                
           DISPLAY 'STARTING CALENDAR DATE: ' PV-STRT-FSCL-WK-END-DTE           
           DISPLAY 'ENDING   CALENDAR DATE: ' PV-END-FSCL-WK-END-DTE            
           PERFORM 4000-OPEN-BRND-VNDR-CSR.                                     
           PERFORM 4100-FETCH-BRND-VNDR-CSR.                                    
           IF PS-MORE-BV-RECORDS                                                
              MOVE IMT00017-DEPT-NBR TO PV-HOLD-DEPT-NBR                        
              MOVE IMT00017-ENT-ID   TO PV-HOLD-ENT-ID                          
           END-IF.                                                              
      ******************************************************************        
      *  CALCULATE THE BEGIN DATE                                               
      ******************************************************************        
       1200-CALC-BEGIN-DATE.                                                    
           MOVE PV-END-FSCL-WK-9 TO PV-WORK-PROCESS-FSCL-WK.                    
      * BECAUSE WE NEED TO GET THE FISCAL WEEK FROM 12 WEEKS PRIOR TO           
      * THE CURRENT DATE, IF THE FISCAL WEEK FROM THE CURRENT YEAR IS           
      * THE TWELFTH WEEK OR PRIOR, WE NEED TO GO BACK TO THE PREVIOUS           
      * FISCAL YEAR.                                                            
           IF PV-END-FSCL-WK-9 LESS THAN OR EQUAL TO 12                         
              MOVE PV-END-FSCL-YR-9 TO PV-WORK-PROCESS-FSCL-YR                  
              COMPUTE PV-WORK-STRT-FSCL-YR EQUAL                                
                      PV-WORK-PROCESS-FSCL-YR - 1                               
              MOVE PV-WORK-STRT-FSCL-YR TO PV-STRT-FSCL-YR-9                    
              MOVE PV-STRT-FSCL-YR-9 TO PV-WORK-MAX-FSCL-YR                     
              PERFORM 3100-GET-MAX-FISCAL-WK                                    
              MOVE PV-WORK-MAX-FSCL-WK-9 TO PV-WORK-MAX-FSCL-WK-COMP            
              COMPUTE PV-WORK-STRT-FSCL-WK EQUAL                                
                      PV-WORK-MAX-FSCL-WK-COMP +                                
                      PV-WORK-PROCESS-FSCL-WK - 12                              
              MOVE PV-WORK-STRT-FSCL-WK TO PV-STRT-FSCL-WK-9                    
           ELSE                                                                 
              MOVE PV-END-FSCL-YR-9   TO PV-STRT-FSCL-YR-9                      
              COMPUTE PV-WORK-STRT-FSCL-WK EQUAL                                
                      PV-WORK-PROCESS-FSCL-WK - 12                              
              MOVE PV-WORK-STRT-FSCL-WK TO PV-STRT-FSCL-WK-9                    
           END-IF.                                                              
           DISPLAY 'THE STARTING FISCAL WEEK WE ARE USING IS '                  
                    PV-STRT-FSCL-WK                                             
           DISPLAY 'THE STARTING FISCAL YEAR WE ARE USING IS '                  
                    PV-STRT-FSCL-YR                                             
           PERFORM 3200-GET-STRT-INFO.                                          
      ******************************************************************        
      *  CALCULATE THE END DATE                                                 
      ******************************************************************        
       1100-CALC-END-DATE.                                                      
           MOVE PV-PROCESS-FSCL-WK-9 TO PV-WORK-PROCESS-FSCL-WK.                
      * BECAUSE WE NEED TO GET THE FISCAL WEEK FROM 12 WEEKS PRIOR TO           
      * THE CURRENT DATE, IF THE FISCAL WEEK FROM THE CURRENT YEAR IS           
      * THE TWELFTH WEEK OR PRIOR, WE NEED TO GO BACK TO THE PREVIOUS           
      * FISCAL YEAR.                                                            
           IF PV-PROCESS-FSCL-WK-9 EQUAL 1                                      
              MOVE PV-PROCESS-FSCL-YR-9 TO PV-WORK-PROCESS-FSCL-YR              
              COMPUTE PV-WORK-END-FSCL-YR EQUAL                                 
                      PV-WORK-PROCESS-FSCL-YR - 1                               
              MOVE PV-WORK-END-FSCL-YR TO PV-END-FSCL-YR-9                      
              MOVE PV-END-FSCL-YR      TO PV-WORK-MAX-FSCL-YR                   
              PERFORM 3100-GET-MAX-FISCAL-WK                                    
              MOVE PV-WORK-MAX-FSCL-WK-9 TO PV-END-FSCL-WK-9                    
           ELSE                                                                 
              MOVE PV-PROCESS-FSCL-YR TO PV-END-FSCL-YR                         
              COMPUTE PV-WORK-END-FSCL-WK EQUAL                                 
                      PV-WORK-PROCESS-FSCL-WK - 1                               
              MOVE PV-WORK-END-FSCL-WK TO PV-END-FSCL-WK-9                      
           END-IF.                                                              
           DISPLAY 'THE ENDING FISCAL WEEK WE ARE USING IS '                    
                    PV-END-FSCL-WK                                              
           DISPLAY 'THE ENDING FISCAL YEAR WE ARE USING IS '                    
                    PV-END-FSCL-YR                                              
           PERFORM 3300-GET-END-INFO.                                           
      ******************************************************************        
      *  PROCESS ROWS FOUND ON THE BRAND VENDOR CURSOR                          
      ******************************************************************        
       2000-PROCESS-BRND-VNDR-CSR.                                              
           IF IMT00017-DEPT-NBR NOT EQUAL PV-HOLD-DEPT-NBR OR                   
              IMT00017-ENT-ID   NOT EQUAL PV-HOLD-ENT-ID                        
              PERFORM 2100-VNDR-DEPT-CHGD                                       
              MOVE IMT00017-DEPT-NBR     TO PV-HOLD-DEPT-NBR                    
              MOVE IMT00017-ENT-ID       TO PV-HOLD-ENT-ID                      
           END-IF.                                                              
                                                                                
           MOVE IMT00017-LBL-SEQ-NBR TO PV-HOLD-BRAND.                          
           PERFORM 2200-PROCESS-BRNDS.                                          
           PERFORM 4100-FETCH-BRND-VNDR-CSR.                                    
                                                                                
      ****************************************************************          
      * DO NECESSARY PROCESSING FOR A VENDOR/DEPARTMENT CHANGE.                 
      * IF A VENDOR DEPARTMENT HAS ONLY ONE BRAND, THEN 100 % IS                
      * PRORATED TO THE SINGLE BRAND FOR ALL FIELDS.                            
      * IF A VENDOR DEPARTMENT HAS ONLY MULTIPLE BRANDS, THEN THE               
      * PRORATION AMOUNT IS THE PERCENT OF THE VENDOR TOTAL THAT                
      * BELONGS TO A BRAND.  IF THERE IS NO AMOUNT FOR A FIELD AMONG            
      * ALL BRANDS FOR A VENDOR, THEN THE PRORATION IS SPLIT EQUALLY            
      * AMONG ALL BRANDS.                                                       
      ****************************************************************          
       2100-VNDR-DEPT-CHGD.                                                     
W28582     MOVE +2  TO PV-DETAIL-ADVANCE-LINE.                                  
           IF PV-TOT-BRANDS EQUAL 1                                             
              MOVE PV-BT-LBL-SEQ-NBR(1) TO BVT00003-LBL-SEQ-NBR                 
              MOVE 100 TO BVT00003-MKDN-BYR-RTL-PCT                             
                          BVT00003-MKDN-STR-RTL-PCT                             
                          BVT00003-RCPT-GRO-COST-PCT                            
                          BVT00003-PADJ-DA-COST-PCT                             
                          BVT00003-PADJ-RTV-COST-PCT                            
                          BVT00003-SLS-REG-RTL-PCT                              
OTEMP *       PERFORM 5100-INSERT-PCT-TABLE                                     
W28582        PERFORM 7100-FILL-DETAIL-LINE                                     
W28582        PERFORM 7200-WRITE-DETAIL-RECORD                                  
NKEEP         MOVE PV-PROCESS-FSCL-WK-END-DTE TO                                
NKEEP              BVT00003-FSCL-WK-END-DTE                                     
NKEEP         MOVE PV-HOLD-DEPT-NBR           TO BVT00003-DEPT-NBR              
NKEEP         MOVE PV-HOLD-ENT-ID             TO BVT00003-ENT-ID                
NKEEP         PERFORM 9200-WRITE-OUTPUT-REC                                     
           ELSE                                                                 
              PERFORM VARYING PV-BRAND-COUNT FROM 1 BY 1                        
                  UNTIL PV-BRAND-COUNT > PV-TOT-BRANDS                          
                MOVE PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT)                          
                                        TO BVT00003-LBL-SEQ-NBR                 
                IF PV-TOT-PADJ-DA-COST-AMT  NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-PADJ-DA-COST-PCT ROUNDED EQUAL               
                   (PV-BT-PADJ-DA-COST-AMT(PV-BRAND-COUNT) /                    
                    PV-TOT-PADJ-DA-COST-AMT)                                    
                   COMPUTE BVT00003-PADJ-DA-COST-PCT EQUAL                      
                   PV-WORK-PADJ-DA-COST-PCT * 100                               
                ELSE                                                            
                   COMPUTE BVT00003-PADJ-DA-COST-PCT ROUNDED EQUAL              
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-PADJ-DA-COST-PCT TO PV-TOT-PADJ-DA-COST-PCT        
                IF PV-TOT-MKDN-BYR-RTL-AMT  NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-MKDN-BYR-RTL-PCT ROUNDED EQUAL               
                   (PV-BT-MKDN-BYR-RTL-AMT(PV-BRAND-COUNT) /                    
                    PV-TOT-MKDN-BYR-RTL-AMT)                                    
                   COMPUTE BVT00003-MKDN-BYR-RTL-PCT EQUAL                      
                   PV-WORK-MKDN-BYR-RTL-PCT * 100                               
                ELSE                                                            
                   COMPUTE BVT00003-MKDN-BYR-RTL-PCT ROUNDED EQUAL              
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-MKDN-BYR-RTL-PCT TO PV-TOT-MKDN-BYR-RTL-PCT        
                                                                                
                IF PV-TOT-MKDN-STR-RTL-AMT  NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-MKDN-STR-RTL-PCT ROUNDED EQUAL               
                   (PV-BT-MKDN-STR-RTL-AMT(PV-BRAND-COUNT) /                    
                    PV-TOT-MKDN-STR-RTL-AMT)                                    
                   COMPUTE BVT00003-MKDN-STR-RTL-PCT EQUAL                      
                   PV-WORK-MKDN-STR-RTL-PCT * 100                               
                ELSE                                                            
                   COMPUTE BVT00003-MKDN-STR-RTL-PCT ROUNDED EQUAL              
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-MKDN-STR-RTL-PCT TO PV-TOT-MKDN-STR-RTL-PCT        
                IF PV-TOT-RCPT-GRO-COST-AMT NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-RCPT-GRO-COST-PCT ROUNDED EQUAL              
                   (PV-BT-RCPT-GRO-COST-AMT(PV-BRAND-COUNT) /                   
                    PV-TOT-RCPT-GRO-COST-AMT)                                   
                   COMPUTE BVT00003-RCPT-GRO-COST-PCT EQUAL                     
                   PV-WORK-RCPT-GRO-COST-PCT * 100                              
                ELSE                                                            
                   COMPUTE BVT00003-RCPT-GRO-COST-PCT ROUNDED EQUAL             
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-RCPT-GRO-COST-PCT TO                               
                    PV-TOT-RCPT-GRO-COST-PCT                                    
                IF PV-TOT-PADJ-RTV-COST-AMT NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-PADJ-RTV-COST-PCT ROUNDED EQUAL              
                   (PV-BT-PADJ-RTV-COST-AMT(PV-BRAND-COUNT) /                   
                    PV-TOT-PADJ-RTV-COST-AMT)                                   
                   COMPUTE BVT00003-PADJ-RTV-COST-PCT EQUAL                     
                   PV-WORK-PADJ-RTV-COST-PCT * 100                              
                ELSE                                                            
                   COMPUTE BVT00003-PADJ-RTV-COST-PCT ROUNDED EQUAL             
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-PADJ-RTV-COST-PCT TO                               
                    PV-TOT-PADJ-RTV-COST-PCT                                    
                IF PV-TOT-SLS-REG-RTL-AMT   NOT EQUAL ZERO                      
                   COMPUTE PV-WORK-SLS-REG-RTL-PCT ROUNDED EQUAL                
                   (PV-BT-SLS-REG-RTL-AMT(PV-BRAND-COUNT) /                     
                    PV-TOT-SLS-REG-RTL-AMT)                                     
                   COMPUTE BVT00003-SLS-REG-RTL-PCT EQUAL                       
                   PV-WORK-SLS-REG-RTL-PCT * 100                                
                ELSE                                                            
                   COMPUTE BVT00003-SLS-REG-RTL-PCT ROUNDED EQUAL               
                   100 / PV-TOT-BRANDS                                          
                END-IF                                                          
                ADD BVT00003-SLS-REG-RTL-PCT TO                                 
                    PV-TOT-SLS-REG-RTL-PCT                                      
                PERFORM 2400-GET-100-PCT                                        
OTEMP *         PERFORM 5100-INSERT-PCT-TABLE                                   
W28582          PERFORM 7100-FILL-DETAIL-LINE                                   
W28582          PERFORM 7200-WRITE-DETAIL-RECORD                                
NKEEP         MOVE PV-PROCESS-FSCL-WK-END-DTE TO                                
NKEEP              BVT00003-FSCL-WK-END-DTE                                     
NKEEP         MOVE PV-HOLD-DEPT-NBR           TO BVT00003-DEPT-NBR              
NKEEP         MOVE PV-HOLD-ENT-ID             TO BVT00003-ENT-ID                
NKEEP           PERFORM 9200-WRITE-OUTPUT-REC                                   
              END-PERFORM                                                       
           END-IF.                                                              
                                                                                
W28582     MOVE TL1-TOTAL-LINE TO RP-REPORT-WORK-RECORD.                        
W28582     PERFORM 7200-WRITE-DETAIL-RECORD.                                    
W28582                                                                          
W28582     MOVE PV-TOT-PADJ-DA-COST-AMT                                         
W28582       TO TL2-PADJ-DA-COST-AMT.                                           
W28582     MOVE PV-TOT-MKDN-BYR-RTL-AMT                                         
W28582       TO TL2-MKDN-BYR-RTL-AMT.                                           
W28582     MOVE PV-TOT-MKDN-STR-RTL-AMT                                         
W28582       TO TL2-MKDN-STR-RTL-AMT.                                           
W28582     MOVE PV-TOT-RCPT-GRO-COST-AMT                                        
W28582       TO TL2-RCPT-GRO-COST-AMT.                                          
W28582     MOVE PV-TOT-PADJ-RTV-COST-AMT                                        
W28582       TO TL2-PADJ-RTV-COST-AMT.                                          
W28582     MOVE PV-TOT-SLS-REG-RTL-AMT                                          
W28582       TO TL2-SLS-REG-RTL-AMT.                                            
W28582     IF PV-TOT-BRANDS EQUAL 1                                             
W28582         MOVE 100                                                         
W28582           TO TL2-PADJ-DA-COST-PCT                                        
W28582              TL2-MKDN-BYR-RTL-PCT                                        
W28582              TL2-MKDN-STR-RTL-PCT                                        
W28582              TL2-RCPT-GRO-COST-PCT                                       
W28582              TL2-PADJ-RTV-COST-PCT                                       
W28582              TL2-SLS-REG-RTL-PCT                                         
W28582     ELSE                                                                 
W28582         MOVE PV-SUM-PADJ-DA-COST-PCT                                     
W28582           TO TL2-PADJ-DA-COST-PCT                                        
W28582         MOVE PV-SUM-MKDN-BYR-RTL-PCT                                     
W28582           TO TL2-MKDN-BYR-RTL-PCT                                        
W28582         MOVE PV-SUM-MKDN-STR-RTL-PCT                                     
W28582           TO TL2-MKDN-STR-RTL-PCT                                        
W28582         MOVE PV-SUM-RCPT-GRO-COST-PCT                                    
W28582           TO TL2-RCPT-GRO-COST-PCT                                       
W28582         MOVE PV-SUM-PADJ-RTV-COST-PCT                                    
W28582           TO TL2-PADJ-RTV-COST-PCT                                       
W28582         MOVE PV-SUM-SLS-REG-RTL-PCT                                      
W28582           TO TL2-SLS-REG-RTL-PCT                                         
W28582     END-IF.                                                              
W28582     MOVE TL2-TOTAL-LINE TO RP-REPORT-WORK-RECORD.                        
W28582     PERFORM 7200-WRITE-DETAIL-RECORD.                                    
W28582                                                                          
           INITIALIZE PV-BRAND-TABLE-INFO                                       
                      PV-TOT-PADJ-DA-COST-PCT                                   
                      PV-TOT-MKDN-BYR-RTL-PCT                                   
                      PV-TOT-MKDN-STR-RTL-PCT                                   
                      PV-TOT-RCPT-GRO-COST-PCT                                  
                      PV-TOT-PADJ-RTV-COST-PCT                                  
                      PV-TOT-SLS-REG-RTL-PCT                                    
W28582                PV-SUM-PADJ-DA-COST-PCT                                   
W28582                PV-SUM-MKDN-BYR-RTL-PCT                                   
W28582                PV-SUM-MKDN-STR-RTL-PCT                                   
W28582                PV-SUM-RCPT-GRO-COST-PCT                                  
W28582                PV-SUM-PADJ-RTV-COST-PCT                                  
W28582                PV-SUM-SLS-REG-RTL-PCT                                    
                      PV-LB-PADJ-DA-COST                                        
                      PV-LB-MKDN-BYR-RTL                                        
                      PV-LB-MKDN-STR-RTL                                        
                      PV-LB-RCPT-GRO-COST                                       
                      PV-LB-PADJ-RTV-COST                                       
                      PV-LB-SLS-REG-RTL.                                        
                                                                                
           MOVE ZERO TO  PV-TOT-PADJ-DA-COST-AMT                                
                         PV-TOT-MKDN-BYR-RTL-AMT                                
                         PV-TOT-MKDN-STR-RTL-AMT                                
                         PV-TOT-RCPT-GRO-COST-AMT                               
                         PV-TOT-PADJ-RTV-COST-AMT                               
                         PV-TOT-SLS-REG-RTL-AMT                                 
                         PV-TOT-BRANDS                                          
                         PV-BRAND-COUNT.                                        
      ****************************************************************          
      * DO NECESSARY PROCESSING TO ADD BRAND INFORMATION FOR AN                 
      * EXISTING VENDOR/DEPARTMENT COMBINATION.                                 
      ****************************************************************          
       2200-PROCESS-BRNDS.                                                      
           PERFORM 5000-GET-ML-AMTS-FOR-BV.                                     
           ADD 1 TO PV-TOT-BRANDS                                               
                    PV-BRAND-COUNT.                                             
                                                                                
           ADD PV-WORK-PADJ-DA-COST-AMT  TO PV-TOT-PADJ-DA-COST-AMT.            
           ADD PV-WORK-MKDN-BYR-RTL-AMT  TO PV-TOT-MKDN-BYR-RTL-AMT.            
           ADD PV-WORK-MKDN-STR-RTL-AMT  TO PV-TOT-MKDN-STR-RTL-AMT.            
           ADD PV-WORK-RCPT-GRO-COST-AMT TO PV-TOT-RCPT-GRO-COST-AMT.           
           ADD PV-WORK-PADJ-RTV-COST-AMT TO PV-TOT-PADJ-RTV-COST-AMT.           
           ADD PV-WORK-SLS-REG-RTL-AMT   TO PV-TOT-SLS-REG-RTL-AMT.             
                                                                                
           MOVE IMT00017-LBL-SEQ-NBR      TO  PV-BT-LBL-SEQ-NBR                 
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-PADJ-DA-COST-AMT  TO  PV-BT-PADJ-DA-COST-AMT            
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-MKDN-BYR-RTL-AMT  TO  PV-BT-MKDN-BYR-RTL-AMT            
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-MKDN-STR-RTL-AMT  TO  PV-BT-MKDN-STR-RTL-AMT            
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-RCPT-GRO-COST-AMT TO  PV-BT-RCPT-GRO-COST-AMT           
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-PADJ-RTV-COST-AMT TO  PV-BT-PADJ-RTV-COST-AMT           
                                              (PV-BRAND-COUNT).                 
           MOVE PV-WORK-SLS-REG-RTL-AMT   TO  PV-BT-SLS-REG-RTL-AMT             
                                              (PV-BRAND-COUNT).                 
      ****************************************************************          
      * SET LAST BRAND VALUES FOR FIELDS THAT HAVE NON ZERO AMOUNTS             
      * ON THE MLT WEEKLY SUM TABLE                                             
      ****************************************************************          
       2300-POPULATE-LAST.                                                      
           IF PV-WORK-PADJ-DA-COST-AMT  NOT EQUAL ZERO                          
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-PADJ-DA-COST                     
           END-IF.                                                              
           IF PV-WORK-MKDN-BYR-RTL-AMT  NOT EQUAL ZERO                          
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-MKDN-BYR-RTL                     
           END-IF.                                                              
           IF PV-WORK-MKDN-STR-RTL-AMT  NOT EQUAL ZERO                          
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-MKDN-STR-RTL                     
           END-IF.                                                              
           IF PV-WORK-RCPT-GRO-COST-AMT NOT EQUAL ZERO                          
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-RCPT-GRO-COST                    
           END-IF.                                                              
           IF PV-WORK-PADJ-RTV-COST-AMT NOT EQUAL ZERO                          
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-PADJ-RTV-COST                    
           END-IF.                                                              
                                                                                
           IF PV-WORK-SLS-REG-RTL-AMT NOT EQUAL ZERO                            
            MOVE IMT00017-LBL-SEQ-NBR TO PV-LB-SLS-REG-RTL                      
           END-IF.                                                              
                                                                                
      ****************************************************************          
      * TO ENSURE THAT 100% IS PRORATED FOR EACH VENDOR DEPARTMENT,             
      * A CHECK IS DONE TO SEE IF BRAND BEING PROCESSED IS THE LAST             
      * ONE FOR A VENDOR DEPARTMENT THAT WILL GET A PRORATION PERCENT           
      * FOR A GIVEN TYPE.  IF IT IS, THEN WE TAKE THE TOTAL PERCENT             
      * PRORATED SO FAR AND RAISE OR LOWER THE LAST PERCENTAGE SO THAT          
      * WE HAVE ONE HUNDRED PERCENT.                                            
      ****************************************************************          
       2400-GET-100-PCT.                                                        
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL PV-LB-PADJ-DA-COST        
           OR (PV-BRAND-COUNT    EQUAL PV-TOT-BRANDS AND                        
               PV-LB-PADJ-DA-COST EQUAL ZERO)                                   
              COMPUTE BVT00003-PADJ-DA-COST-PCT EQUAL                           
                      BVT00003-PADJ-DA-COST-PCT +                               
                      (100 - PV-TOT-PADJ-DA-COST-PCT)                           
           END-IF.                                                              
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL PV-LB-MKDN-BYR-RTL        
           OR (PV-BRAND-COUNT     EQUAL PV-TOT-BRANDS AND                       
               PV-LB-MKDN-BYR-RTL EQUAL ZERO)                                   
              COMPUTE BVT00003-MKDN-BYR-RTL-PCT  EQUAL                          
                      BVT00003-MKDN-BYR-RTL-PCT +                               
                      (100 - PV-TOT-MKDN-BYR-RTL-PCT)                           
           END-IF.                                                              
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL PV-LB-MKDN-STR-RTL        
           OR (PV-BRAND-COUNT     EQUAL PV-TOT-BRANDS AND                       
               PV-LB-MKDN-STR-RTL EQUAL ZERO)                                   
              COMPUTE BVT00003-MKDN-STR-RTL-PCT EQUAL                           
                      BVT00003-MKDN-STR-RTL-PCT +                               
                      (100 - PV-TOT-MKDN-STR-RTL-PCT)                           
           END-IF.                                                              
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL                           
              PV-LB-RCPT-GRO-COST                                               
           OR (PV-BRAND-COUNT EQUAL PV-TOT-BRANDS AND                           
               PV-LB-RCPT-GRO-COST EQUAL ZERO)                                  
              COMPUTE BVT00003-RCPT-GRO-COST-PCT EQUAL                          
                      BVT00003-RCPT-GRO-COST-PCT +                              
                      (100 - PV-TOT-RCPT-GRO-COST-PCT)                          
           END-IF.                                                              
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL                           
              PV-LB-PADJ-RTV-COST                                               
           OR (PV-BRAND-COUNT EQUAL PV-TOT-BRANDS AND                           
               PV-LB-PADJ-RTV-COST EQUAL ZERO)                                  
              COMPUTE BVT00003-PADJ-RTV-COST-PCT EQUAL                          
                      BVT00003-PADJ-RTV-COST-PCT +                              
                      (100 - PV-TOT-PADJ-RTV-COST-PCT)                          
           IF PV-BT-LBL-SEQ-NBR(PV-BRAND-COUNT) EQUAL                           
              PV-LB-SLS-REG-RTL                                                 
           OR (PV-BRAND-COUNT EQUAL PV-TOT-BRANDS AND                           
               PV-LB-SLS-REG-RTL EQUAL ZERO)                                    
              COMPUTE BVT00003-SLS-REG-RTL-PCT EQUAL                            
                      BVT00003-SLS-REG-RTL-PCT +                                
                      (100 - PV-TOT-SLS-REG-RTL-PCT)                            
           END-IF.                                                              
      ****************************************************************          
      * GET THE CURRENT FISCAL PERIOD INFO.                                     
      ****************************************************************          
       3000-GET-PROCESS-DATE-INFO.                                              
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      SELECT FSCL_YR_NBR,                                       
                             FSCL_WK_NBR,                                       
                             FSCL_WK_END_DTE                                    
                        INTO :PV-PROCESS-FSCL-YR                                
                            ,:PV-PROCESS-FSCL-WK                                
                            ,:PV-PROCESS-FSCL-WK-END-DTE                        
                        FROM TDTATTR                                            
                       WHERE KY_DTE = :PV-PROCESS-DATE                          
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                           DISPLAY 'DATE SELECT: '                              
                                  PV-PROCESS-DATE                               
                                  ' SUCCESSFUL'                                 
                           CONTINUE                                             
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '3000-GET-PROCESS-DATE-INFO'                    
                                 TO PV-PARAGRAPH-NAME                           
                           DISPLAY 'PV-PROCESS-DATE : ' PV-PROCESS-DATE         
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR PROCESS DATE '                      
           END-IF.                                                              
                                                                                
      ****************************************************************          
      * 3100-GET-MAX-FISCAL-WK FOR SPECIFIED YEAR.                              
      ****************************************************************          
       3100-GET-MAX-FISCAL-WK.                                                  
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      SELECT MAX(FSCL_WK_NBR)                                   
                        INTO :PV-WORK-MAX-FSCL-WK                               
                        FROM TDTATTR                                            
                       WHERE FSCL_YR_NBR = :PV-WORK-MAX-FSCL-YR                 
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                           CONTINUE                                             
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '3000-GET-MAX-FISCAL-WK'                        
                                 TO PV-PARAGRAPH-NAME                           
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR GET MAX FISCAL WEEK'                
           END-IF.                                                              
                                                                                
      ****************************************************************          
      * GET FISCAL WEEK INFORMATION FOR THE STARTING WK                         
      ****************************************************************          
       3200-GET-STRT-INFO.                                                      
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      SELECT DISTINCT FSCL_WK_END_DTE                           
                        INTO :PV-STRT-FSCL-WK-END-DTE                           
                        FROM TDTATTR                                            
                       WHERE FSCL_YR_NBR = :PV-STRT-FSCL-YR                     
                         AND FSCL_WK_NBR = :PV-STRT-FSCL-WK                     
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                           DISPLAY 'START FISCAL WEEK '                         
                                  PV-STRT-FSCL-WK-END-DTE                       
                                  ' SUCCESSFUL'                                 
                           CONTINUE                                             
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '3200-GET-STRT-INFO'                            
                                 TO PV-PARAGRAPH-NAME                           
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR START FISCAL WEEK'                  
           END-IF.                                                              
      ****************************************************************          
      * GET FISCAL WEEK INFORMATION FOR THE ENDING WEEK                         
      ****************************************************************          
       3300-GET-END-INFO.                                                       
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      SELECT DISTINCT FSCL_WK_END_DTE                           
                        INTO :PV-END-FSCL-WK-END-DTE                            
                        FROM TDTATTR                                            
                       WHERE FSCL_YR_NBR = :PV-END-FSCL-YR                      
                         AND FSCL_WK_NBR = :PV-END-FSCL-WK                      
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                           DISPLAY 'END FISCAL WEEK '                           
                                  PV-END-FSCL-WK-END-DTE                        
                                  ' SUCCESSFUL'                                 
                           CONTINUE                                             
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '3300-GET-END-INFO'                             
                                 TO PV-PARAGRAPH-NAME                           
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR END FISCAL WEEK'                    
           END-IF.                                                              
                                                                                
      ******************************************************************        
      *  OPEN THE BRAND VENDOR CURSOR                                           
      ******************************************************************        
       4000-OPEN-BRND-VNDR-CSR.                                                 
            EXEC SQL                                                            
                OPEN BRND-VNDR-CSR                                              
            END-EXEC.                                                           
                                                                                
            EVALUATE TRUE                                                       
                WHEN SQLCODE = +0                                               
                    CONTINUE                                                    
                WHEN SQLWARN NOT = SPACE                                        
                WHEN SQLCODE NOT = +0                                           
                    MOVE '4000-OPEN-BRND-VNDR-CSR' TO PV-PARAGRAPH-NAME         
                    PERFORM 9999-SQL-ABEND                                      
            END-EVALUATE.                                                       
                                                                                
      ******************************************************************        
      *  FETCH A ROW FROM THE BRAND VENDOR CURSOR                               
      ******************************************************************        
       4100-FETCH-BRND-VNDR-CSR.                                                
           EXEC SQL                                                             
             FETCH BRND-VNDR-CSR                                                
               INTO :IMT00017-DEPT-BRND-VND-ID                                  
                   ,:IMT00017-DEPT-NBR                                          
                   ,:IMT00017-ENT-ID                                            
                   ,:IMT00017-LBL-SEQ-NBR                                       
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                    CONTINUE                                                    
                    DISPLAY 'VNDR: ' IMT00017-ENT-ID                            
                            ' DEPT: ' IMT00017-DEPT-NBR                         
                            ' BRND: ' IMT00017-LBL-SEQ-NBR                      
               WHEN SQLCODE = +100                                              
                   SET PS-NO-MORE-BV-RECORDS TO TRUE                            
               WHEN SQLWARN NOT = SPACE                                         
               WHEN SQLCODE NOT = +0                                            
                   MOVE '4100-FETCH-BRND-VNDR-CSR' TO PV-PARAGRAPH-NAME         
                   PERFORM 9999-SQL-ABEND                                       
           END-EVALUATE.                                                        
      ******************************************************************        
      *  CLOSE THE BRAND VENDOR CURSOR                                          
      ******************************************************************        
       4200-CLOSE-BRND-VNDR-CSR.                                                
           EXEC SQL                                                             
               CLOSE BRND-VNDR-CSR                                              
           END-EXEC.                                                            
                                                                                
           EVALUATE TRUE                                                        
               WHEN SQLCODE = +0                                                
                   CONTINUE                                                     
               WHEN SQLWARN NOT = SPACE                                         
               WHEN SQLCODE NOT = +0                                            
                   MOVE '4200-CLOSE-BRND-VNDR-CSR' TO PV-PARAGRAPH-NAME         
                   PERFORM 9999-SQL-ABEND                                       
           END-EVALUATE.                                                        
                                                                                
      ****************************************************************          
      * GET THE SUM OF THE MERCHANDISE LEDGER AMOUNTS FOR A BRAND               
      * VENDOR FOR THE LAST THIRTEEN WEEKS.                                     
      ****************************************************************          
       5000-GET-ML-AMTS-FOR-BV.                                                 
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      SELECT SUM(PADJ_DA_COST_AMT)                              
      *                     ,SUM(PADJ_DA_RTL_AMT)                               
                            ,SUM(MKDN_BYR_RTL_AMT)                              
                            ,SUM(MKDN_STR_RTL_AMT)                              
                            ,SUM(RCPT_GRO_COST_AMT)                             
                            ,SUM(PADJ_RTV_COST_AMT)                             
                            ,SUM(SLS_REG_RTL_AMT)                               
                        INTO :PV-WORK-PADJ-DA-COST-AMT:PV-NULL                  
                            ,:PV-WORK-MKDN-BYR-RTL-AMT:PV-NULL                  
                            ,:PV-WORK-MKDN-STR-RTL-AMT:PV-NULL                  
                            ,:PV-WORK-RCPT-GRO-COST-AMT:PV-NULL                 
                            ,:PV-WORK-PADJ-RTV-COST-AMT:PV-NULL                 
                            ,:PV-WORK-SLS-REG-RTL-AMT:PV-NULL                   
                        FROM MLT_WKLY_SUM WS,                                   
                             MLT_PARTN_CNTL PC                                  
                       WHERE ML_LO_MDSE_LVL_ID =                                
                            :IMT00017-DEPT-BRND-VND-ID                          
                         AND DEPT_NBR          = :IMT00017-DEPT-NBR             
                         AND FSCL_DTE BETWEEN                                   
                            :PV-STRT-FSCL-WK-END-DTE AND                        
                            :PV-END-FSCL-WK-END-DTE                             
                         AND TBL_TM_LVL_CDE = 'W'                               
                         AND PC.PARTN_NBR = WS.PARTN_NBR                        
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                           IF PV-NULL NOT EQUAL ZERO                            
                              MOVE ZERO TO PV-WORK-PADJ-DA-COST-AMT             
                                           PV-WORK-MKDN-BYR-RTL-AMT             
                                           PV-WORK-MKDN-STR-RTL-AMT             
                                           PV-WORK-RCPT-GRO-COST-AMT            
                                           PV-WORK-PADJ-RTV-COST-AMT            
                                           PV-WORK-SLS-REG-RTL-AMT              
                           ELSE                                                 
                              PERFORM 2300-POPULATE-LAST                        
                           END-IF                                               
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '5000-GET-ML-AMTS-FOR-BV'                       
                                 TO PV-PARAGRAPH-NAME                           
                           DISPLAY 'CHECKING FOR ENT ID '                       
                                    IMT00017-ENT-ID                             
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR ML SUMS '                           
           END-IF.                                                              
      ****************************************************************          
      * INSERT A NEW ROW ONTO THE BRAND PRORATION PERCENT TABLE                 
      ****************************************************************          
       5100-INSERT-PCT-TABLE.                                                   
           PERFORM                                                              
               WITH TEST AFTER                                                  
               VARYING PV-RETRY-COUNTER                                         
               FROM 1 BY 1                                                      
               UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
                         OR (SQLCODE = ZERO)                                    
                         OR (SQLCODE = 100))                                    
                  EXEC SQL                                                      
                      INSERT INTO BVT_BRND_PRRTN_PCT                            
                         ( FSCL_WK_END_DTE                                      
                          ,DEPT_NBR                                             
                          ,ENT_ID                                               
                          ,LBL_SEQ_NBR                                          
                          ,MKDN_BYR_RTL_PCT                                     
                          ,MKDN_STR_RTL_PCT                                     
                          ,RCPT_GRO_COST_PCT                                    
                          ,PADJ_DA_COST_PCT                                     
      *                   ,PADJ_DA_RTL_PCT                                      
                          ,PADJ_RTV_COST_PCT                                    
                          ,SLS_REG_RTL_PCT                                      
                         )                                                      
                         VALUES (                                               
                          :PV-PROCESS-FSCL-WK-END-DTE                           
                         ,:PV-HOLD-DEPT-NBR                                     
                         ,:PV-HOLD-ENT-ID                                       
                         ,:BVT00003-LBL-SEQ-NBR                                 
                         ,:BVT00003-MKDN-BYR-RTL-PCT                            
                         ,:BVT00003-MKDN-STR-RTL-PCT                            
                         ,:BVT00003-RCPT-GRO-COST-PCT                           
                         ,:BVT00003-PADJ-DA-COST-PCT                            
                         ,:BVT00003-PADJ-RTV-COST-PCT                           
                         ,:BVT00003-SLS-REG-RTL-PCT                             
                         )                                                      
                  END-EXEC                                                      
                                                                                
                  EVALUATE TRUE                                                 
                      WHEN SQLCODE = 0                                          
                      WHEN SQLCODE = -904                                       
                      WHEN SQLCODE = -913                                       
                           CONTINUE                                             
                      WHEN SQLWARN0 NOT = SPACES                                
                      WHEN SQLCODE < +0                                         
                      WHEN SQLCODE > +0                                         
                           MOVE '5100-INSERT-PCT-TABLE'                         
                                 TO PV-PARAGRAPH-NAME                           
                           DISPLAY 'INSERTING ONTO THE % TABLE'                 
                                   ' DEPT: '                                    
                                    PV-HOLD-DEPT-NBR                            
                                   ' VENDOR: '                                  
                                    PV-HOLD-ENT-ID                              
                                   ' BRAND: '                                   
                                    BVT00003-LBL-SEQ-NBR                        
                           PERFORM 9999-SQL-ABEND                               
                  END-EVALUATE                                                  
           END-PERFORM.                                                         
                                                                                
           IF PV-RETRY-COUNTER > PC-MAX-RETRIES                                 
              DISPLAY 'RETRIES EXCEEDED FOR % INSERT'                           
           END-IF.                                                              
W28582******************************************************************        
W28582*    FILL REPORT DETATIL LINE                                             
W28582******************************************************************        
W28582 7100-FILL-DETAIL-LINE.                                                   
W28582                                                                          
W28582     MOVE PV-BT-PADJ-DA-COST-AMT(PV-BRAND-COUNT)                          
W28582       TO DL1-PADJ-DA-COST-AMT.                                           
W28582     MOVE PV-BT-MKDN-BYR-RTL-AMT(PV-BRAND-COUNT)                          
W28582       TO DL1-MKDN-BYR-RTL-AMT.                                           
W28582     MOVE PV-BT-MKDN-STR-RTL-AMT(PV-BRAND-COUNT)                          
W28582       TO DL1-MKDN-STR-RTL-AMT.                                           
W28582     MOVE PV-BT-RCPT-GRO-COST-AMT(PV-BRAND-COUNT)                         
W28582       TO DL1-RCPT-GRO-COST-AMT.                                          
W28582     MOVE PV-BT-PADJ-RTV-COST-AMT(PV-BRAND-COUNT)                         
W28582       TO DL1-PADJ-RTV-COST-AMT.                                          
W28582     MOVE PV-BT-SLS-REG-RTL-AMT(PV-BRAND-COUNT)                           
W28582       TO DL1-SLS-REG-RTL-AMT.                                            
W28582     MOVE PV-HOLD-DEPT-NBR                                                
W28582       TO DL1-DEPT-NBR.                                                   
W28582     MOVE PV-HOLD-ENT-ID                                                  
W28582       TO DL1-ENT-ID.                                                     
W28582     MOVE BVT00003-LBL-SEQ-NBR                                            
W28582       TO DL1-LBL-SEQ-NBR.                                                
W28582     MOVE BVT00003-MKDN-BYR-RTL-PCT                                       
W28582       TO DL1-MKDN-BYR-RTL-PCT.                                           
W28582     MOVE BVT00003-MKDN-STR-RTL-PCT                                       
W28582       TO DL1-MKDN-STR-RTL-PCT.                                           
W28582     MOVE BVT00003-RCPT-GRO-COST-PCT                                      
W28582       TO DL1-RCPT-GRO-COST-PCT.                                          
W28582     MOVE BVT00003-PADJ-DA-COST-PCT                                       
W28582       TO DL1-PADJ-DA-COST-PCT.                                           
W28582     MOVE BVT00003-PADJ-RTV-COST-PCT                                      
W28582       TO DL1-PADJ-RTV-COST-PCT.                                          
W28582     MOVE BVT00003-SLS-REG-RTL-PCT                                        
W28582       TO DL1-SLS-REG-RTL-PCT.                                            
W28582     MOVE DL1-DETAIL-LINE          TO RP-REPORT-WORK-RECORD.              
W28582                                                                          
W28582     ADD BVT00003-PADJ-DA-COST-PCT                                        
W28582      TO PV-SUM-PADJ-DA-COST-PCT.                                         
W28582     ADD BVT00003-MKDN-BYR-RTL-PCT                                        
W28582      TO PV-SUM-MKDN-BYR-RTL-PCT.                                         
W28582     ADD BVT00003-MKDN-STR-RTL-PCT                                        
W28582      TO PV-SUM-MKDN-STR-RTL-PCT.                                         
W28582     ADD BVT00003-RCPT-GRO-COST-PCT                                       
W28582      TO PV-SUM-RCPT-GRO-COST-PCT.                                        
W28582     ADD BVT00003-PADJ-RTV-COST-PCT                                       
W28582      TO PV-SUM-PADJ-RTV-COST-PCT.                                        
W28582     ADD BVT00003-SLS-REG-RTL-PCT                                         
W28582      TO PV-SUM-SLS-REG-RTL-PCT.                                          
W28582                                                                          
W28582******************************************************************        
W28582*    WRITE DETAIL RECORD                                                  
W28582******************************************************************        
W28582 7200-WRITE-DETAIL-RECORD.                                                
W28582                                                                          
W28582     IF PV-DETAIL-LINE-COUNT IS EQUAL TO ZEROES                           
W28582         OR PV-DETAIL-LINE-COUNT + PV-DETAIL-ADVANCE-LINE >               
W28582             PC-MAX-LINES-PER-PAGE                                        
W28582         PERFORM 7400-PRINT-DTL-HEADING                                   
W28582         MOVE +2                TO PV-DETAIL-ADVANCE-LINE                 
W28582     END-IF.                                                              
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD     FROM RP-REPORT-WORK-RECORD          
W28582         AFTER ADVANCING PV-DETAIL-ADVANCE-LINE LINE.                     
W28582     ADD PV-DETAIL-ADVANCE-LINE TO PV-DETAIL-LINE-COUNT.                  
W28582     MOVE +1                    TO PV-DETAIL-ADVANCE-LINE.                
W28582     MOVE SPACES                TO RP-REPORT-WORK-RECORD.                 
W28582                                                                          
W28582******************************************************************        
W28582*    PRINT DETAIL HEADING                                                 
W28582******************************************************************        
W28582 7400-PRINT-DTL-HEADING.                                                  
W28582                                                                          
W28582     ADD 1                     TO PV-DETAIL-PAGE-COUNT.                   
W28582     MOVE PV-DETAIL-PAGE-COUNT TO DP200O-PAGE-NUMBER.                     
W28582     MOVE 1                    TO DP200O-REPORT-NUMBER.                   
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM DP200O-STANDRD-HEADER-200-COLS AFTER ADVANCING PAGE.          
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL1-HEADING-LINE-1 AFTER ADVANCING 2 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL2-HEADING-LINE-2 AFTER ADVANCING 1 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL3-HEADING-LINE-3 AFTER ADVANCING 1 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL4-HEADING-LINE-4 AFTER ADVANCING 2 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL5-HEADING-LINE-5 AFTER ADVANCING 1 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL6-HEADING-LINE-6 AFTER ADVANCING 1 LINE.                    
W28582                                                                          
W28582     WRITE PRORATION-AUDIT-RECORD                                         
W28582       FROM HL7-HEADING-LINE-7 AFTER ADVANCING 1 LINE.                    
W28582                                                                          
W28582     MOVE 10                  TO PV-DETAIL-LINE-COUNT.                    
W28582                                                                          
      ******************************************************************        
      * 9000-READ-CNTL-DTE.                                                     
      ******************************************************************        
       9000-READ-CNTL-DTE.                                                      
           READ CNTL-DATE-FILE INTO CC-DATE-CNTL-CARD                           
               AT END                                                           
                   DISPLAY '** PROGRAM ABEND **'                                
                   DISPLAY 'MLKUP001  - CONTROL DATE EMPTY'                     
                   SET AC-OTHER-ERROR TO TRUE                                   
                   CALL 'ILBOABN0' USING ABEND-CODE.                            
                                                                                
           DISPLAY '** MLKUP001 CONTROL CARD:' CNTL-DATE-REC.                   
                                                                                
           MOVE CC-DT-PROC-DATE-ISO TO PV-PROCESS-DATE.                         
      ******************************************************************        
      * 9100-READ-DEPT-FILE.                                                    
      ******************************************************************        
NKEEP  9100-READ-DEPT-FILE.                                                     
NKEEP      READ CNTL-DEPT-FILE INTO CC-DEPT-CNTL-CARD                           
NKEEP          AT END                                                           
NKEEP              DISPLAY '** PROGRAM ABEND **'                                
NKEEP              DISPLAY 'MLKUP001  - DEPT FILE EMPTY'                        
NKEEP              SET AC-OTHER-ERROR TO TRUE                                   
NKEEP              CALL 'ILBOABN0' USING ABEND-CODE.                            
NKEEP                                                                           
NKEEP      DISPLAY '** MLKUP001 CONTROL CARD:' CC-DEPT-CNTL-CARD.               
NKEEP                                                                           
      ******************************************************************        
      * 9200-WRITE-OUTPUT-REC.                                                  
      ******************************************************************        
NKEEP  9200-WRITE-OUTPUT-REC.                                                   
NKEEP      WRITE PRRTN-OUTPUT-REC                                               
NKEEP       FROM DCLBVT00003.                                                   
      ******************************************************************        
      *  STANDARD DB2 ERROR ABEND ROUTINE                                       
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.                     
      ******************************************************************        
       9999-SQL-ABEND.                                                          
                                                                                
           SET AC-SQL-ERROR           TO TRUE.                                  
           DISPLAY '**  ABEND     **'.                                          
           DISPLAY '**  PROGRAM   **  = ' PC-PGM-NAME.                          
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.                    
                                                                                
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE                 
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.                
                                                                                
           COPY DPPD004.                                                        
                                                                                
           CALL 'ILBOABN0'  USING ABEND-CODE.                                   
                                                                                
