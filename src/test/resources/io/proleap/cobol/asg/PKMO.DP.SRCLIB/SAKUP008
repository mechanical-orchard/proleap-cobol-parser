000100 IDENTIFICATION DIVISION.                                         00010002
000200                                                                  00020002
000300 PROGRAM-ID.      SAKUP008.                                       00030002
000400 AUTHOR.          STEVEN NOWAK.                                   00040002
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050002
000600 DATE-WRITTEN.    07/01/09.                                       00060005
000700 DATE-COMPILED.                                                   00070002
000800                                                                  00080002
000900******************************************************************00090002
001000*  MODULE TYPE:   COBOL2 DB2 BATCH.                               00100002
001100*                                                                 00110002
001200*  DESCRIPTION: PROGRAM UPDATES THE TSASUM TABLE WITH THE DATA    00120002
001300*               PULLED IN PROGRAM SAKUT060                        00130002
001400*                                                                 00140002
001500*========================== CHANGE LOG ===========================00150002
001600*  AUTH        BY           DATE    DESCRIPTION                   00160006
001700*=================================================================00170002
001800* WR36527     TKMA409     07-01-09  CREATE PROGRAM                00180006
001900*                                                                 00190002
260107* CHG0260107  JIM HUNTER  08-19-21  ADD COPYBOOK DPWS991 TO MAKE  00191006
260107*                                   THE CALL TO DPKUT901 DYNAMIC. 00192006
002000******************************************************************00200002
002100                                                                  00210002
002200 ENVIRONMENT DIVISION.                                            00220002
002300 CONFIGURATION SECTION.                                           00230002
002400                                                                  00240002
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250002
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260002
002700                                                                  00270002
002800 INPUT-OUTPUT SECTION.                                            00280002
002900 FILE-CONTROL.                                                    00290002
003000                                                                  00300002
003100 DATA DIVISION.                                                   00310002
003200 FILE SECTION.                                                    00320002
003300                                                                  00330002
003400                                                                  00340002
003500***************************************************************** 00350002
003600*                       WORKING STORAGE                           00360002
003700***************************************************************** 00370002
003800 WORKING-STORAGE SECTION.                                         00380002
003900                                                                  00390002
004000 01  W-START                          PIC  X(40)                  00400002
004100     VALUE 'SAKUP008 - WORKING STORAGE BEGINS HERE'.              00410002
004200                                                                  00420002
004300                                                                  00430002
004400***************************************************************** 00440002
004500*                         SWITCHES                                00450002
004600***************************************************************** 00460002
004700 01  PROGRAM-SWITCHES.                                            00470002
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00480002
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00490002
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00500002
005100                                                                  00510002
005200******************************************************************00520002
005300*                       ACCUMULATORS                              00530002
005400******************************************************************00540002
005500 01  PROGRAM-ACCUM.                                               00550002
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00560002
005600     05  PA-CKPT                      PIC  9(11) VALUE ZEROS.     00570002
005700                                                                  00580002
005800******************************************************************00590002
005900*                           CONSTANTS                             00600002
006000******************************************************************00610002
006100 01  PROGRAM-CONSTANTS.                                           00620002
006200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00630002
006300                                                 COMP SYNC.       00640002
006400     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00650002
006500                                                 COMP SYNC.       00660002
006600                                                                  00670002
006700     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'SAK051  '.00680002
006800     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'SAKUP008'.00690002
006900     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'SAKUP008'.00700002
007000                                                                  00710002
007100     05  PC-TRAN-PRES-FUNC-CODES.                                 00720002
007200         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00730002
007300         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00740002
007400         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00750002
007500         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00760002
007600                                                                  00770002
007700     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00780002
007800     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00790002
007900                                                                  00800002
008000******************************************************************00810002
008100*                          VARIABLES                              00820002
008200******************************************************************00830002
008300 01  PROGRAM-VARIABLES.                                           00840002
008400     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00850002
008500     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00860002
008600     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00870002
008700     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.     00880002
008800     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00890002
008900     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00900002
009000                                                                  00910002
009100******************************************************************00920002
009200*               SYSTEM TIME AND DATE VARIABLES                    00930002
009300******************************************************************00940002
009400 01  SYS-DATE-TIME.                                               00950002
009500     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00960002
009600     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00970002
009700                                                                  00980002
009800 01  ST-BEG-TIME.                                                 00990002
009900     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     01000002
010000     05  FILLER                       PIC  X(01) VALUE ':'.       01010002
010100     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01020002
010200                                                                  01030002
010300 01  ST-END-TIME.                                                 01040002
010400     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01050002
010500     05  FILLER                       PIC  X(01) VALUE ':'.       01060002
010600     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01070002
010700                                                                  01080002
010800 01  SD-EDIT-DATE.                                                01090002
010900     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01100002
011000     05  FILLER                       PIC  X(01) VALUE '-'.       01110002
011100     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01120002
011200     05  FILLER                       PIC  X(01) VALUE '-'.       01130002
011300     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01140002
011400     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01150002
011500                                                                  01160002
011600******************************************************************01170002
011700*                        ERROR HANDLING                           01180002
011800******************************************************************01190002
011900 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01200002
012000                                                 COMP SYNC.       01210002
012100     88  ABEND-4002-READ-ERROR                   VALUE +4002.     01220002
012200     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01230002
012300     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     01240002
012400                                                                  01250002
012500                                                                  01260002
012600******************************************************************01270002
012700*  TSASUM - TOTALS BY STORE REGISTER                              01280002
012800******************************************************************01290002
012900     COPY SARD009.                                                01300003
013000                                                                  01310002
013100******************************************************************01320002
013200*  DB2 FORMATTED ERROR MESSAGE                                    01330002
013300******************************************************************01340002
013400     COPY DPWS004.                                                01350002
013500                                                                  01360002
013600******************************************************************01370002
013700*  SQL COMMUNICATIONS WORK AREA                                   01380002
013800******************************************************************01390002
013900     COPY SQLCA2.                                                 01400002
014000                                                                  01410002
014100******************************************************************01420002
014200*  COMMUNICATIONS AREA FOR DB2                                    01430002
014300******************************************************************01440002
014400     EXEC SQL                                                     01450002
014500         INCLUDE SQLCA                                            01460002
014600     END-EXEC.                                                    01470002
014700                                                                  01480002
014800******************************************************************01490002
014900*  DB2 TABLE TSASUM - STORE TOTALS TABLE                          01500002
015000******************************************************************01510002
015100     EXEC SQL                                                     01520002
015200          INCLUDE TSASUM                                          01530002
015300     END-EXEC.                                                    01540002
015400                                                                  01550002
015500******************************************************************01560002
015600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             01570002
015700******************************************************************01580002
260107     COPY DPWS991.                                                01590006
015800                                                                  01591006
015800     COPY DPLS001.                                                01592006
015900     05  WORK-STORAGE-PASSED.                                     01600002
016000******************************************************************01610002
016100*PA - PROGRAM ACCUMULATORS                                        01620002
016200******************************************************************01630002
016300         10  PROGRAM-ACCUMULATORS.                                01640002
016400             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 01650002
016500                                                       COMP-3.    01660002
016600             15  PA-ROWS-UPDATED  PIC S9(11)           VALUE ZERO 01670002
016700                                                       COMP-3.    01680002
016800                                                                  01710002
016900 01  FILLER                          PIC X(4096)  VALUE SPACE.    01720002
017000                                                                  01730002
017100                                                                  01740002
017200                                                                  01750002
017300 PROCEDURE DIVISION.                                              01760002
017400******************************************************************01770002
017500* MAINLINE-PROCESSING                                             01780002
017600******************************************************************01790002
017700                                                                  01800002
017800     PERFORM A100-INITIALIZE.                                     01810002
017900                                                                  01820002
018000     PERFORM B100-PROCESS-UPDATE-RECORDS                          01830002
018100       UNTIL DP001-PREP-TRANS-EOF.                                01840002
018200                                                                  01850002
018300     PERFORM Z990-EOJ-ROUTINE.                                    01860002
018400                                                                  01870002
018500     GOBACK.                                                      01880002
018600                                                                  01890002
018700                                                                  01900002
018800******************************************************************01910002
018900* PREFORMS TASK INITIATION                                        01920002
019000******************************************************************01930002
019100 A100-INITIALIZE.                                                 01940002
019200                                                                  01950002
019300     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 01960002
019400                                                                  01970002
019500     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            01980002
019600     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            01990002
019700                                                                  02000002
019800     MOVE SYS-DATE (1:2) TO SD-CENT.                              02010002
019900     MOVE SYS-DATE (3:2) TO SD-YEAR.                              02020002
020000     MOVE SYS-DATE (5:2) TO SD-MONTH.                             02030002
020100     MOVE SYS-DATE (7:2) TO SD-DAY.                               02040002
020200                                                                  02050002
020300     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              02060002
020400                                                                  02070002
020500     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02080002
020600                                                                  02090002
020700                                                                  02100002
020800******************************************************************02110002
020900* PROCESS UPDATE RECORDS                                          02120002
021000******************************************************************02130002
021100 B100-PROCESS-UPDATE-RECORDS.                                     02140002
021200                                                                  02150002
021300     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02160002
021400                                                                  02170002
021500     PERFORM C100-UPDATE-FIELDS.                                  02180002
021600                                                                  02190002
021700*----------------------------------------------------------------*02200002
021800*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02210002
021900*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02220002
022000*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02230002
022100*----------------------------------------------------------------*02240002
022200     IF  PS-RESTART-REQUIRED                                      02250002
022300         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02260002
022400     ELSE                                                         02270002
022500         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02280002
022600     END-IF.                                                      02290002
022700                                                                  02300002
022800     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02310002
022900                                                                  02320002
023000     ADD 1 TO PA-READ.                                            02330002
023100                                                                  02340002
023100                                                                  02350002
023300******************************************************************02360002
023400* UPDATES THE TSASUM FIELDS                                       02370002
023500******************************************************************02380002
023600 C100-UPDATE-FIELDS.                                              02390002
023700                                                                  02400002
023800     MOVE SA009-PARTN-NBR      TO SASUM-PARTN-NBR.                02410003
023900     MOVE SA009-STR-NBR        TO SASUM-STR-NBR.                  02420003
024000     MOVE SA009-RGST-ID        TO SASUM-RGST-ID.                  02430003
024100     MOVE SA009-SUM-TYP-CDE    TO SASUM-SUM-TYP-CDE.              02440003
024200     MOVE SA009-SUM-CTG-CDE    TO SASUM-SUM-CTG-CDE.              02450003
024300     MOVE SA009-CTG-AMT        TO SASUM-CTG-AMT.                  02460003
024400     MOVE SA009-CTG-NBR-OF-ITM TO SASUM-CTG-NBR-OF-ITM.           02470003
024500     MOVE SA009-CTG-SRC-CDE    TO SASUM-CTG-SRC-CDE.              02480003
024600                                                                  02490002
024800     PERFORM C200-TSASUM-UPDATE.                                  02493003
025000                                                                  02494002
025900                                                                  02540002
035100******************************************************************03500002
035200* UPDATE THE TSASUM TABLE                                         03510002
035300******************************************************************03520002
035400 C200-TSASUM-UPDATE.                                              03530003
035500                                                                  03540002
035600     PERFORM WITH TEST AFTER                                      03550002
035700         VARYING PV-SQL-SUB                                       03560002
035800         FROM 1 BY 1                                              03570002
035900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03580002
036000                OR SQLCODE = -911                                 03590002
036000                OR SQLCODE = +100                                 03591004
036100                OR SQLCODE = 0)                                   03600002
036200                                                                  03610002
036300         EXEC SQL                                                 03620002
036400             UPDATE  TSASUM                                       03630002
239300              SET CTG_AMT        = CTG_AMT + :SASUM-CTG-AMT       03640003
239400                 ,CTG_NBR_OF_ITM = CTG_NBR_OF_ITM +               03650003
239500                                          :SASUM-CTG-NBR-OF-ITM   03660003
239600                                                                  03670003
239700              WHERE PARTN_NBR   = :SASUM-PARTN-NBR                03680003
239800                AND STR_NBR     = :SASUM-STR-NBR                  03690003
239900                AND RGST_ID     = :SASUM-RGST-ID                  03700003
240000                AND SUM_TYP_CDE = :SASUM-SUM-TYP-CDE              03710003
240100                AND SUM_CTG_CDE = :SASUM-SUM-CTG-CDE              03711003
037300         END-EXEC                                                 03720002
037400                                                                  03730002
037500         EVALUATE TRUE                                            03740002
037600             WHEN SQLCODE = 0                                     03750002
037700                 ADD +1 TO PA-ROWS-UPDATED                        03760002
037800                                                                  03770002
037900             WHEN SQLCODE = +100                                  03780002
038000                 PERFORM C300-TSASUM-INSERT                       03790003
038100                                                                  03800002
038200             WHEN SQLCODE = -911                                  03810002
038300                 ADD +1 TO PV-DEADLOCK-COUNTER                    03820002
038400                                                                  03830002
038500                 DISPLAY '                   '                    03840002
038600                 DISPLAY 'DEADLOCK INCOUNTERED -911'              03850002
038700                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER03860002
038800                                                                  03870002
038900                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03880002
039000                     MOVE 'C200-TSASUM-UPDATE'                    03890003
039100                                      TO PV-PARAGRAPH-NAME        03900002
039200                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03910002
039300                                      TO PV-DB2-OPER-ATTEMPTED    03920002
039400                     PERFORM Z200-SQL-ABEND                       03930002
039500                                                                  03940002
039600                 ELSE                                             03950002
039700                     SET PS-RESTART-REQUIRED TO TRUE              03960002
039800                 END-IF                                           03970002
039900                                                                  03980002
040000             WHEN OTHER                                           03990002
040100                 DISPLAY '                   '                    04000002
040200                 DISPLAY 'SQLCODE = ' SQLCODE                     04010002
040300                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     04020002
040400                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      04030002
040500                 DISPLAY '                   '                    04040002
040900                 DISPLAY 'UPDATE ABENDED ON: '                    04080002
041000                 DISPLAY 'PART-NBR = ' SASUM-PARTN-NBR            04090002
041100                 DISPLAY 'STR-NBR  = ' SASUM-STR-NBR              04100002
041200                 DISPLAY 'RGST-ID  = ' SASUM-RGST-ID              04110002
041300                 DISPLAY 'TYP-CDE  = ' SASUM-SUM-TYP-CDE          04120002
041400                 DISPLAY 'CTG-CDE  = ' SASUM-SUM-CTG-CDE          04130002
041500                 DISPLAY 'CTG-AMT  = ' SASUM-CTG-AMT              04140002
041600                 DISPLAY 'CTG-NBR  = ' SASUM-CTG-NBR-OF-ITM       04150002
041700                 DISPLAY 'CTG-SRC  = ' SASUM-CTG-SRC-CDE          04160002
041800                                                                  04170002
041900                 MOVE 'C200-TSASUM-UPDATE'                        04180003
042000                                        TO PV-PARAGRAPH-NAME      04190002
042100                 MOVE 'TSASUM INSERT'                             04200002
042200                                        TO PV-DB2-OPER-ATTEMPTED  04210002
042300                                                                  04220002
042400                 PERFORM Z200-SQL-ABEND                           04230002
042500         END-EVALUATE                                             04240002
042600     END-PERFORM.                                                 04250002
042700                                                                  04260002
042800                                                                  04270002
042900     IF PV-SQL-SUB > PC-MAX-RETRIES                               04280002
043000         MOVE 'C200-TSASUM-UPDATE'     TO PV-PARAGRAPH-NAME       04290003
043100         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  04300002
043200         PERFORM Z200-SQL-ABEND                                   04310002
043300     END-IF.                                                      04320002
043400                                                                  04330002
043500                                                                  04340002
026000******************************************************************04350003
026100* INSERT INTO THE TSASUM TABLE                                    04360003
026200******************************************************************04370003
026300 C300-TSASUM-INSERT.                                              04380003
026400                                                                  04390003
026500     PERFORM WITH TEST AFTER                                      04400003
026600         VARYING PV-SQL-SUB                                       04410003
026700         FROM 1 BY 1                                              04420003
026800         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       04430003
026900                OR SQLCODE = -911                                 04440003
027000                OR SQLCODE = 0)                                   04460003
027100                                                                  04470003
027200         EXEC SQL                                                 04480003
027300             INSERT  INTO TSASUM                                  04490003
027400                  (  PARTN_NBR                                    04500003
027500                  ,  STR_NBR                                      04510003
027600                  ,  RGST_ID                                      04520003
027700                  ,  SUM_TYP_CDE                                  04530003
027800                  ,  SUM_CTG_CDE                                  04540003
027900                  ,  CTG_AMT                                      04550003
028000                  ,  CTG_NBR_OF_ITM                               04560003
028100                  ,  CTG_SRC_CDE)                                 04570003
028200              VALUES                                              04580003
028300                  (  :SASUM-PARTN-NBR                             04590003
028400                  ,  :SASUM-STR-NBR                               04600003
028500                  ,  :SASUM-RGST-ID                               04610003
028600                  ,  :SASUM-SUM-TYP-CDE                           04620003
028700                  ,  :SASUM-SUM-CTG-CDE                           04630003
028800                  ,  :SASUM-CTG-AMT                               04640003
028900                  ,  :SASUM-CTG-NBR-OF-ITM                        04650003
029000                  ,  :SASUM-CTG-SRC-CDE)                          04660003
029100         END-EXEC                                                 04670003
029200                                                                  04680003
029300         EVALUATE TRUE                                            04690003
029400             WHEN SQLCODE = 0                                     04700003
029500                 ADD +1 TO PA-ROWS-INSERTED                       04710003
029600                                                                  04720003
029700             WHEN SQLCODE = -911                                  04760003
029800                 ADD +1 TO PV-DEADLOCK-COUNTER                    04770003
029900                                                                  04780003
030000                 DISPLAY '                   '                    04790003
030100                 DISPLAY 'DEADLOCK INCOUNTERED -911'              04800003
030200                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER04810003
030300                                                                  04820003
030400                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        04830003
030500                     MOVE 'C300-TSASUM-INSERT'                    04840003
030600                                      TO PV-PARAGRAPH-NAME        04850003
030700                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        04860003
030800                                      TO PV-DB2-OPER-ATTEMPTED    04870003
030900                     PERFORM Z200-SQL-ABEND                       04880003
031000                                                                  04890003
031100                 ELSE                                             04900003
031200                     SET PS-RESTART-REQUIRED TO TRUE              04910003
031300                 END-IF                                           04920003
031400                                                                  04930003
031500             WHEN OTHER                                           04940003
031600                 DISPLAY '                   '                    04950003
031700                 DISPLAY 'SQLCODE = ' SQLCODE                     04960003
031800                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     04970003
031900                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      04980003
032000                 DISPLAY '                   '                    04990003
032400                 DISPLAY 'INSERT ABENDED ON: '                    05030003
032500                 DISPLAY 'PART-NBR = ' SASUM-PARTN-NBR            05040003
032600                 DISPLAY 'STR-NBR  = ' SASUM-STR-NBR              05050003
032700                 DISPLAY 'RGST-ID  = ' SASUM-RGST-ID              05060003
032800                 DISPLAY 'TYP-CDE  = ' SASUM-SUM-TYP-CDE          05070003
032900                 DISPLAY 'CTG-CDE  = ' SASUM-SUM-CTG-CDE          05080003
033000                 DISPLAY 'CTG-AMT  = ' SASUM-CTG-AMT              05090003
033100                 DISPLAY 'CTG-NBR  = ' SASUM-CTG-NBR-OF-ITM       05100003
033200                 DISPLAY 'CTG-SRC  = ' SASUM-CTG-SRC-CDE          05110003
033300                                                                  05120003
033400                 MOVE 'C300-TSASUM-INSERT'                        05130003
033500                                        TO PV-PARAGRAPH-NAME      05140003
033600                 MOVE 'TSASUM INSERT'                             05150003
033700                                        TO PV-DB2-OPER-ATTEMPTED  05160003
033800                                                                  05170003
033900                 PERFORM Z200-SQL-ABEND                           05180003
034000         END-EVALUATE                                             05190003
034100     END-PERFORM.                                                 05191003
034200                                                                  05192003
034300                                                                  05193003
034400     IF PV-SQL-SUB > PC-MAX-RETRIES                               05194003
034500         MOVE 'C300-TSASUM-INSERT'      TO PV-PARAGRAPH-NAME      05195003
034600         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  05196003
034700         PERFORM Z200-SQL-ABEND                                   05197003
034800     END-IF.                                                      05198003
034900                                                                  05199003
035000                                                                  05199103
052100******************************************************************05200002
052200* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      05210002
052300* PRESENTATION MODULE                                             05220002
052400******************************************************************05230002
052500 X100-BUILD-COMM-AREA-TRAN-PRES.                                  05240002
052600                                                                  05250002
052700     MOVE LENGTH OF                                               05260002
052800          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          05270002
052900     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  05280002
053000     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 05290002
053100                                                                  05300002
053200     PERFORM X200-CALL-TRANS-PRES-MODULE.                         05310002
053300                                                                  05320002
053400     MOVE DP001-TRANS-RECORD  TO SA009-TSASUM-REC.                05330003
053500                                                                  05340002
053600     IF  DP001-CKPT-TAKEN                                         05350002
053700         ADD 1 TO PA-CKPT                                         05360002
054200                                                                  05370002
054300         INITIALIZE PV-DEADLOCK-COUNTER                           05380002
054400     END-IF.                                                      05390002
054500                                                                  05400002
054600                                                                  05410002
054700******************************************************************05420002
054800* VERIFY THE RETURN CODE ON THE CALLED MODULE                     05430002
054900******************************************************************05440002
055000 X200-CALL-TRANS-PRES-MODULE.                                     05450002
055100                                                                  05460002
055200     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         05470002
055300                                                                  05480002
055400     IF  DP001-GOOD-RET-CODE                                      05490002
055500     OR  DP001-CKPT-TAKEN                                         05500002
055600     OR  DP001-RESTART                                            05510002
055700         CONTINUE                                                 05520002
055800                                                                  05530002
055900     ELSE                                                         05540002
056000         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  05550002
056100         MOVE '** BAD CALL TO TRANS PREP MODULE **'               05560002
056200                                            TO PV-OPERATION-MSG   05570002
056300         MOVE DP001-RET-CODE                TO PV-RET-CODE        05580002
056400                                                                  05590002
056500         SET ABEND-4019-CAL-SUB-ERROR TO TRUE                     05600002
056600                                                                  05610002
056700         PERFORM Z100-ABEND                                       05620002
056800     END-IF.                                                      05630002
056900                                                                  05640002
057000                                                                  05650002
057100******************************************************************05660002
057200* NON-DB2 ABEND                                                   05670002
057300******************************************************************05680002
057400 Z100-ABEND.                                                      05690002
057500                                                                  05700002
057600     PERFORM Z999-CONTROLS.                                       05710002
057700                                                                  05720002
057800     DISPLAY '                     '.                             05730002
057900     DISPLAY '** ABEND           **'.                             05740002
058000     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          05750002
058100     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05760002
058200     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         05770002
058300     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              05780002
058400                                                                  05790002
058500     CALL 'ILBOABN0' USING ABEND-CODE.                            05800002
058600                                                                  05810002
058700                                                                  05820002
058800******************************************************************05830002
058900* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      05840002
059000* CODE OCCURS.                                                    05850002
059100******************************************************************05860002
059200 Z200-SQL-ABEND.                                                  05870002
059300                                                                  05880002
059400     PERFORM Z999-CONTROLS.                                       05890002
059500                                                                  05900002
059600     DISPLAY '** ABEND     **'.                                   05910002
059700     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                05920002
059800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05930002
059900     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          05940002
060000                                                                  05950002
060100******************************************************************05960002
060200* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    05970002
060300* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         05980002
060400* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05990002
060500* FORMAT.                                                         06000002
060600******************************************************************06010002
060700     COPY DPPD004.                                                06020002
060800                                                                  06030002
060900     SET ABEND-4013-DB2-ERROR TO TRUE.                            06040002
061000                                                                  06050002
061100     CALL 'ILBOABN0' USING ABEND-CODE.                            06060002
061200                                                                  06070002
061300                                                                  06080002
061400******************************************************************06090002
061500* PREFORMS TASK TERMINATION PROCESSING                            06100002
061600******************************************************************06110002
061700 Z990-EOJ-ROUTINE.                                                06120002
061800                                                                  06130002
061900     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             06140002
062000                                                                  06150002
062100     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      06160002
062200                                                                  06170002
062300     PERFORM Z999-CONTROLS.                                       06180002
062400                                                                  06190002
062500                                                                  06200002
062600******************************************************************06210002
062700* DISPLAY CONTROLS FROM THE PROGRAM                               06220002
062800******************************************************************06230002
062900 Z999-CONTROLS.                                                   06240002
063000                                                                  06250002
063100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 06260002
063200                                                                  06270002
063300     MOVE SYS-TIME (1:2) TO ST-END-HR.                            06280002
063400     MOVE SYS-TIME (3:2) TO ST-END-MN.                            06290002
063500                                                                  06300002
063600     DISPLAY '                    '.                              06310002
063700     DISPLAY '**********************'.                            06320002
063800     DISPLAY '   SAKUP008 CONTROLS  '.                            06330002
063900     DISPLAY '**********************'.                            06340002
064000     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         06350002
064100     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          06360002
064200     DISPLAY 'END TIME  = ' ST-END-TIME.                          06370002
064300     DISPLAY '======================'.                            06380002
064400     DISPLAY 'RECORDS READ   = ' PA-READ.                         06390002
064400     DISPLAY 'CHECKPOINTS    = ' PA-CKPT.                         06400002
064500     DISPLAY '                '.                                  06410002
064600     DISPLAY 'ROWS INSERTED  = ' PA-ROWS-INSERTED.                06420002
064700     DISPLAY 'ROWS UPDATED   = ' PA-ROWS-UPDATED.                 06430002
064800     DISPLAY '                '.                                  06440002
064900                                                                  06470002
065000                                                                  06480002
065100******************************************************************06490002
065200* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06500002
065300* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  06510002
065400* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         06520002
065500******************************************************************06530002
065600     COPY DPPD001.                                                06540002
065700                                                                  06550002
065800                                                                  06560002
