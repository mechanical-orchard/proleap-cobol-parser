000100* ------------------------------------------------------------- * 00010011
000200 IDENTIFICATION DIVISION.                                         00020011
000300* ------------------------------------------------------------- * 00030011
000400 PROGRAM-ID.      AUKUT008.                                       00040011
000500 AUTHOR.          BARB SCHULTZ.                                   00050011
000600 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00060011
000700 DATE-WRITTEN.    02-22-2008.                                     00070011
000800                                                                  00080011
000900***************************************************************** 00090011
001000*  THIS PROGRAM WILL PUT A MESSAGE ON TO THE                    * 00100011
001100*  EP.THIRDPARTYCARD.AUTH.Q IF THE AUTH FOR THE CARD HAS NOT    * 00110011
001100*  BEEN APPROVED AND IT'S BEEN LESS THEN 24 HOURS SINCE THE     * 00120011
001200*  CARD HAS BEEN PURCHASED.                                     * 00130011
001300*                                                               * 00140011
004900***************************************************************** 00150011
CH####******************************************************************00160011
CH####*  06/19/2014  CHANGES TO UPDATE THE CARDS THAT DO NOT GET       *00170011
CH####*              APPROVED AFTER SAF FOR 24 TIMES TO HARD DECLINE   *00180011
CH####*  MADE BY: COGNIZANT                        CHG0086147          *00190011
CH####***************************************************************** 00200011
CH7356******************************************************************00210011
CH7356*  10/28/2014  CHANGES TO SKIP THE INVALID CARD TESTED AT POS    *00220011
CH7356*              AND TO IGNORE THOSE CARDS THAT GOT ACTIVATED      *00230011
CH7356*              ALREADY FROM SAF PROCESS.                         *00240011
CH7356*  MADE BY: COGNIZANT                        CHG0097356          *00250011
CH7356***************************************************************** 00260011
CHGXXX******************************************************************00270011
CHGXXX*  01/21/2015:ADDED -305 SQLCODE CHECK IN 2250 PARA AND MOVED     00280011
CHGXXX*  05 AS AUTH CODE TO PROCESS THE CARDS IN SAF THOSE HAD AUTH CODE00290011
CHGXXX*  AS NULL.                                                       00300011
CHGXXX*  MADE BY: COGNIZANT                        CHG0097356          *00310011
CHGXXX***************************************************************** 00320011
C39248******************************************************************00321015
C39248*  02/05/2020:ADDED FETCH FIRST ROW ONLY IN 3100 PARA TO FIX      00322015
C39248*  -811 SQL CODE ISSUE. CODING TAG#C39248                         00323015
C39248*  MADE BY: SARVESWARAN KANNAN               CHG0239248          *00325015
C39248***************************************************************** 00326015
005000* ------------------------------------------------------------- * 00330011
005100 ENVIRONMENT DIVISION.                                            00340011
005200* ------------------------------------------------------------- * 00350011
005300                                                                  00360011
005400 CONFIGURATION SECTION.                                           00370011
005500                                                                  00380011
005600 SOURCE-COMPUTER.       IBM-3090.                                 00390011
005700 OBJECT-COMPUTER.       IBM-3090.                                 00400011
005800                                                                  00410011
005900 INPUT-OUTPUT SECTION.                                            00420011
006000                                                                  00430011
006100 FILE-CONTROL.                                                    00440011
006200                                                                  00450011
006300     SELECT CONTROL-CARD            ASSIGN TO INP01.              00460011
**CHG*     SELECT HARD-DECLINE-CARDS-FILE                               00470011
**CHG*                                    ASSIGN TO OUT01.              00480011
006400                                                                  00490011
006500* ------------------------------------------------------------- * 00500011
006600 DATA DIVISION.                                                   00510011
006700* ------------------------------------------------------------- * 00520011
006800 FILE SECTION.                                                    00530011
006900                                                                  00540011
007000 FD  CONTROL-CARD                                                 00550011
007100     RECORDING MODE F                                             00560011
007200     BLOCK CONTAINS 0 RECORDS                                     00570011
007300     LABEL RECORDS ARE OMITTED.                                   00580011
007400 01  CONTROL-CARD-LINE              PIC  X(80).                   00590011
007500                                                                  00600011
**CHG* FD  HARD-DECLINE-CARDS-FILE                                      00610011
**CHG*     RECORDING MODE F                                             00620011
**CHG*     BLOCK CONTAINS 0 RECORDS                                     00630011
**CHG*     LABEL RECORDS ARE OMITTED.                                   00640011
**CHG**                                                                 00650011
**CHG* 01  HARD-DECLINE-CARDS-RECORD      PIC X(100).                   00660011
007600* ------------------------------------------------------------- * 00670011
007700 WORKING-STORAGE SECTION.                                         00680011
007800* ------------------------------------------------------------- * 00690011
007900                                                                  00700011
008400* ------------------------------------------------------------- * 00710011
008500*   LAYOUT  VARIABLES                                             00720011
008600* ------------------------------------------------------------- * 00730011
008000 01  CC-CONTROL-CARD.                                             00740011
008100     05  CC-QMGR-NAME               PIC X(48).                    00750011
008200     05  FILLER                     PIC X(32).                    00760011
008300                                                                  00770011
**CHG* 01  PL-OUTPUT-LAYOUT.                                            00780011
**CHG*     05 PL-CRD-ACCT-NBR             PIC X(19).                    00790011
**CHG*     05 PL-VND-AUTH-RSPN-CDE        PIC X(03).                    00800011
**CHG*     05 PL-CRD-CRE-TRAN-TMST        PIC X(26).                    00810011
**CHG*     05 PL-CRD-UPC-NBR              PIC 9(15).                    00820011
**CHG*     05 PL-SKU-DESC                 PIC X(26).                    00830011
**CHG*     05 FILLER                      PIC X(11).                    00840011
008400* ------------------------------------------------------------- * 00850011
008500*   PROGRAM VARIABLES                                             00860011
008600* ------------------------------------------------------------- * 00870011
008700                                                                  00880011
008800 01  PV-PROGRAM-VARIABLES.                                        00890011
008900     05  PV-PARAGRAPH             PIC X(30)     VALUE SPACES.     00900011
009000     05  PV-QM-NAME               PIC X(48).                      00910011
009100     05  PV-MSGBUFFER             PIC X(100000) VALUE SPACES.     00920011
009200     05  PV-MSGLENGTH             PIC S9(9) BINARY VALUE +100000. 00930011
009200     05  PV-DATA-LENGTH           PIC S9(9) BINARY.               00940011
009400     05  PV-NUMPUTS               PIC S9(9) BINARY VALUE 0.       00950011
009500     05  PV-ERROR-MESSAGE         PIC X(48) VALUE SPACES.         00960011
009600     05  PV-HCONN                 PIC S9(9) BINARY VALUE 0.       00970011
009700     05  PV-GQ-HANDLE             PIC S9(9) BINARY VALUE 0.       00980011
009700     05  PV-PQ-HANDLE-BH          PIC S9(9) BINARY VALUE 0.       00990011
009800     05  PV-OPEN-OPTIONS          PIC S9(9) BINARY.               01000011
009900     05  PV-COMPLETION-CODE       PIC S9(9) BINARY.               01010011
009900     05  PV-SAVE-COMPLETION-CODE  PIC S9(9) BINARY.               01020011
010000     05  PV-REASON                PIC S9(9) BINARY.               01030011
010100     05  PV-CON-REASON            PIC S9(9) BINARY.               01040011
010100     05  PV-MQ-REASON-TEXT        PIC X(30)   VALUE SPACES.       01050011
010200     05  PV-QMGR-NAME           PIC X(48)    VALUE                01060011
010300              'EP.THIRDPARTYCARD.AUTH.Q                        '. 01070011
010400     05  PV-PARAGRAPH-NAME        PIC  X(30)  VALUE SPACE.        01080011
010500     05  PV-OPERATION-MSG-1       PIC  X(40)  VALUE SPACE.        01090011
010600     05  PV-DB2-OPERATION         PIC  X(40)  VALUE SPACES.       01100011
010700     05  PV-SAVE-CRD              PIC  X(19)  VALUE SPACES.       01110011
010800     05  PV-SAVE-AUTH-RSPN        PIC  X(03)  VALUE SPACES.       01120011
010800     05  PV-SAVE-REASON           PIC  S9(9)  BINARY.             01130011
010900     05  PV-PUT-MESSAGE-BUFFER    PIC  X(82)  VALUE SPACES.       01140011
011000     05  PV-PUT-MSG-BUFFER-LENGTH PIC  S9(9) BINARY VALUE 82.     01150011
CH7356     05  PV-AUTH-CODE             PIC  X(02)  VALUE ZEROES.       01160011
**CHG*     05  PV-SAF-LIMIT             PIC  9(02) VALUE  24.           01170011
**CHG*     05  PV-HRDDCL-COUNT          PIC  X(02) VALUE SPACES.        01180011
**CHG*     05  PV-SAF-CNT               PIC  9(02) VALUE ZEROES.        01190011
**CHG*     05  PV-UPC-START                 PIC S9(15) COMP-3 VALUE 0.  01200011
**CHG*     05  PV-UPC-END                   PIC S9(15) COMP-3 VALUE 0.  01210011
**CHG*     05  PV-UPC-START-SETUP           PIC  9(15).                 01220011
**CHG*     05  PV-UPC-START-SPLIT REDEFINES PV-UPC-START-SETUP.         01230011
**CHG*         10  PV-UPC-START-1           PIC  9(14).                 01240011
**CHG*         10  PV-UPC-START-2           PIC  9(01).                 01250011
**CHG*     05  PV-UPC-END-SETUP             PIC  9(15).                 01260011
**CHG*     05  PV-UPC-END-SPLIT REDEFINES PV-UPC-END-SETUP.             01270011
**CHG*         10  PV-UPC-END-1             PIC  9(14).                 01280011
**CHG*         10  PV-UPC-END-2             PIC  9(01).                 01290011
**CHG*     05  PV-SKU-DESC                  PIC X(26).                  01300011
CH7356     05  PV-INVALID-CARD              PIC X(19)                   01310011
CH7356                     VALUE '9999999999999999999'.                 01320011
011100     05  PV-CARD-NBR.                                             01330011
011200         10  PV-UPC-NUMBER        PIC  9(11).                     01340011
011300         10  PV-CRD-ACCT-NBR      PIC  9(19).                     01350011
011100     05  PV-CARD-NBR-R REDEFINES PV-CARD-NBR PIC X(30).           01360011
011300                                                                  01370011
011400******************************************************************01380011
011400* RECORD FOR PUT TO BLACK HAWK                                    01390011
011400******************************************************************01400011
011400 01  PV-BLKHAWK-FEED               PIC  X(1200000).               01410011
011400                                                                  01420011
011400 01  PV-BLKHAWK-INFO          REDEFINES PV-BLKHAWK-FEED.          01430011
011400     05  PV-BLKHAWK-DATA           PIC X(82).                     01440011
011400     05  FILLER                    PIC X(1199918).                01450011
011400                                                                  01460011
011400 01  PV-BLKHAWK-RECORD REDEFINES PV-BLKHAWK-FEED.                 01470011
011400     05  PV-BLKHAWK-TBL OCCURS 1200000 TIMES.                     01480011
011400         10  PV-BLKHAWK-REC PIC X(01).                            01490011
011400                                                                  01500011
011400 01  SUBSCRIPTS.                                                  01510011
011600     05  BLKHAWK-SUB               PIC S9(09)  COMP.              01520011
011600                                                                  01530011
011600                                                                  01540011
011500*    API control blocks                                           01550011
011600                                                                  01560011
011700 01  MQM-OBJECT-DESCRIPTOR.                                       01570011
011800     COPY CMQODV.                                                 01580011
011900 01  MQM-MESSAGE-DESCRIPTOR.                                      01590011
012000     COPY CMQMDV.                                                 01600011
012100 01  MQM-PUT-MESSAGE-OPTIONS.                                     01610011
012200     COPY CMQPMOV.                                                01620011
012300                                                                  01630011
012400*    MQV contains constants (for filling in the control blocks)   01640011
012500*    and return codes (for testing the result of a call)          01650011
012600                                                                  01660011
012700 01  MQM-CONSTANTS.                                               01670011
012800     COPY CMQV.                                                   01680011
012900                                                                  01690011
013000*----------------------------------------------------------------*01700011
013100*    PROGRAM CONSTANTS                                            01710011
013200*----------------------------------------------------------------*01720011
013300 01  PC-PROGRAM-CONSTANTS.                                        01730011
013400     05  PC-PGM-NAME               PIC X(09) VALUE 'AUKUT008 '.   01740011
013500     05  PC-FIFTY-STARS            PIC X(50) VALUE ALL '*'.       01750011
013600     05  PC-MSG-EXPIRY             PIC S9(9) VALUE 72000.         01760011
013700     05  PC-MSG-TEXT               PIC X(100)                     01770011
013800                                   VALUE 'END RUN OF PROGRAM'.    01780011
013900     05  PC-CORRELID-ASCII         PIC X(24)                      01790011
014000                            VALUE '&.¥Û                '.     01800011
014100*                   MQ SERIES CONSTANTS                           01810011
014200     05  PC-MQCONN               PIC X(8)    VALUE 'CSQBCONN'.    01820011
014300     05  PC-MQOPEN               PIC X(8)    VALUE 'CSQBOPEN'.    01830011
014400     05  PC-MQGET                PIC X(8)    VALUE 'CSQBGET'.     01840011
014500     05  PC-MQPUT                PIC X(8)    VALUE 'CSQBPUT'.     01850011
014500     05  PC-MQPUT1               PIC X(8)    VALUE 'CSQBPUT1'.    01860011
014600     05  PC-MQCLOSE              PIC X(8)    VALUE 'CSQBCLOS'.    01870011
014600     05  PC-MQCMIT               PIC X(8)    VALUE 'CSQBCOMM'.    01880011
014600     05  PC-MQBACK               PIC X(8)    VALUE 'CSQBBACK'.    01890011
014700     05  PC-MQDISC               PIC X(8)    VALUE 'CSQBDISC'.    01900011
014700     05  PC-MQCHECK              PIC X(8)    VALUE 'MQR2C'.       01910011
014800     05  PC-QMGR-NAME            PIC X(4)    VALUE SPACES.        01920011
014900         88  PC-PROD-QMGR-NAME               VALUE 'QKSP'.        01930011
015000         88  PC-TEST-QMGR-NAME               VALUE 'QKST'.        01940011
015100         88  PC-QA-QMGR-NAME                 VALUE 'QKSQ'.        01950011
015200     05  PC-THIRD-PY-AUTH-QNAME PIC X(48)    VALUE                01960011
015300           'EP.THIRDPARTYCARD.AUTH.Q                        '.    01970011
015400*----------------------------------------------------------------*01980011
015500*    PROGRAM SWITCHES                                            *01990011
015600*----------------------------------------------------------------*02000011
015700 01  PS-PROGRAM-SWITCHES.                                         02010011
015800     05  PS-END-OF-CURSOR-SW       PIC X(01) VALUE 'N'.           02020011
015900         88  PS-END-OF-CURSOR                VALUE 'Y'.           02030011
016000     05  PS-END-PROGRAM-SW         PIC X(01) VALUE 'N'.           02040011
016100         88  PS-END-PROGRAM                  VALUE 'Y'.           02050011
016200                                                                  02060011
016300 01  AC-ABEND-CODE           PIC S9(4) COMP SYNC VALUE ZERO.      02070011
016400     88  AC-WRITE-ERROR                         VALUE +4001.      02080011
016500     88  AC-READ-ERROR                          VALUE +4002.      02090011
016600     88  AC-CONTROL-CARD-ERROR                  VALUE +4003.      02100011
016700     88  AC-TABLE-ERROR                         VALUE +4004.      02110011
016800     88  AC-OPEN-ERROR                          VALUE +4005.      02120011
016900     88  AC-CLOSE-ERROR                         VALUE +4006.      02130011
017000     88  AC-SEQUENCE-ERROR                      VALUE +4007.      02140011
017100     88  AC-DATA-ERROR                          VALUE +4008.      02150011
017200     88  AC-KEY-DATA-ERROR                      VALUE +4009.      02160011
017300     88  AC-DB2-ERROR                           VALUE +4013.      02170011
017400     88  AC-CALENDAR-ROUTINE-ERROR              VALUE +4019.      02180011
017500     88  AC-MQ-ERROR                            VALUE +4020.      02190011
017600                                                                  02200011
017700******************************************************************02210011
017800*  THIRD PARTY AUTH QUEUE LAYOUT                                  02220011
017900******************************************************************02230011
018000     COPY SAWS051.                                                02240011
018100                                                                  02250011
018200******************************************************************02260011
018300* DATE ROUTINE COPY MEMBERS                                       02270011
018400******************************************************************02280011
018500     COPY DPWS500.                                                02290011
018600                                                                  02300011
018700******************************************************************02310011
018800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02320011
018900******************************************************************02330011
019000     COPY DPWS004.                                                02340011
019100                                                                  02350011
019200******************************************************************02360011
019300*  DB2 TABLE GCT_GFT_CRD_TRN                                      02370011
019400******************************************************************02380011
019500     EXEC SQL                                                     02390011
019600         INCLUDE GCT00002                                         02400011
019700     END-EXEC.                                                    02410011
019800                                                                  02420011
019900******************************************************************02430011
020000*  DB2 TABLE GCT_VND_AUTH                                         02440011
020100******************************************************************02450011
020200     EXEC SQL                                                     02460011
020300         INCLUDE GCT00004                                         02470011
020400     END-EXEC.                                                    02480011
020500                                                                  02490011
022400******************************************************************02500011
022500*    XS SKU TABLE                                                *02510011
022600******************************************************************02520011
022700     EXEC SQL                                                     02530011
022800         INCLUDE XST00010                                         02540011
022900     END-EXEC.                                                    02550011
023000                                                                  02560011
020600******************************************************************02570011
020700*  DB2 COMMUNICATION AREA.                                        02580011
020800******************************************************************02590011
020900     EXEC SQL                                                     02600011
021000           INCLUDE SQLCA                                          02610011
021100     END-EXEC.                                                    02620011
021200                                                                  02630011
021300***************************************************************** 02640011
021400*    CURSOR TO GET ALL CARDS THAT HAVE A NULL STATUS OR HAVE NOT  02650011
022300*    BEEN APPROVED OR DO NOT HAVE A '01', '02', '08', '12', '21'  02660011
022300*    AND WERE BOUGHT AT LEAST 55 MINUTES AGO AND NOT OLDER THAN   02670011
021400*    24 HOURS AND ARE NOT ON THE RECONCILIATION TABLE.            02680011
021500***************************************************************** 02690011
021600     EXEC SQL                                                     02700011
021700       DECLARE AUTH-CSR CURSOR FOR                                02710011
021800         SELECT CRD_ACCT_NBR                                      02720011
021900              , CRE_TMST                                          02730011
022000              , LAST_UPD_TMST                                     02740011
022100              , VND_AUTH_RSPN_CDE                                 02750011
022200         FROM GCT_VND_AUTH A                                      02760011
022300         WHERE (VND_AUTH_RSPN_CDE IS NULL                         02770011
022300           OR (VND_AUTH_RSPN_CDE ^= '00'                          02780011
022300           AND VND_AUTH_RSPN_CDE ^= '01'                          02790011
022300           AND VND_AUTH_RSPN_CDE ^= '02'                          02800011
022300           AND VND_AUTH_RSPN_CDE ^= '08'                          02810011
022300           AND VND_AUTH_RSPN_CDE ^= '12'                          02820011
022300           AND VND_AUTH_RSPN_CDE ^= '21'))                        02830011
022500           AND CRE_TMST =                                         02840011
**CHG*               (SELECT MIN(CRE_TMST)                              02850011
022600                FROM GCT_VND_AUTH B                               02860011
022700                WHERE A.CRD_ACCT_NBR = B.CRD_ACCT_NBR             02870011
022400                AND CURRENT TIMESTAMP > (CRE_TMST + 55 minutes)   02880011
022400                AND CURRENT TIMESTAMP < (CRE_TMST + 24 HOUR))     02890011
022500           AND NOT EXISTS                                         02900011
022600             (SELECT CRD_ACCT_NBR                                 02910011
022700                FROM GCT_GFT_CRD_RECNCL C                         02920011
022700               WHERE A.CRD_ACCT_NBR = C.CRD_ACCT_NBR)             02930011
022700         ORDER BY CRD_ACCT_NBR                                    02940011
022700                , CRE_TMST                                        02950011
022700         WITH UR                                                  02960011
022800      END-EXEC.                                                   02970011
022900                                                                  02980011
023000* ------------------------------------------------------------- * 02990011
023100 PROCEDURE DIVISION.                                              03000011
023200* ------------------------------------------------------------- * 03010011
023300 1000-MAIN SECTION.                                               03020011
023400                                                                  03030011
023500     PERFORM 1000-INITIALIZE.                                     03040011
023600                                                                  03050011
023700     PERFORM 2000-PROCESS-DATA                                    03060011
023800       UNTIL PS-END-OF-CURSOR OR PS-END-PROGRAM.                  03070011
023900                                                                  03080011
024000     PERFORM 4600-CLOSE-AUTH-CSR.                                 03090011
024100                                                                  03100011
024200     PERFORM 3000-CLOSE-QUEUE.                                    03110011
024300                                                                  03120011
024400     PERFORM 3500-DISCONNECT-QMGR.                                03130011
024500                                                                  03140011
024600     PERFORM 9500-END-PROGRAM.                                    03150011
024700                                                                  03160011
024800* ------------------------------------------------------------- * 03170011
024900*    INITIALIZATION                                               03180011
025000* ------------------------------------------------------------- * 03190011
025100 1000-INITIALIZE.                                                 03200011
025200                                                                  03210011
025300     PERFORM 1050-READ-CONTROL-CARD.                              03220011
**CHG*     OPEN OUTPUT HARD-DECLINE-CARDS-FILE.                         03230011
025400                                                                  03240011
025500     PERFORM 1100-OPEN-CURSOR.                                    03250011
025600     PERFORM 4000-FETCH-CURSOR.                                   03260011
026700                                                                  03270011
026400     PERFORM 1200-CONNECT-QUEUE-MANAGER.                          03280011
026700                                                                  03290011
026600     PERFORM 1500-OPEN-QUEUE.                                     03300011
026700                                                                  03310011
026800* ------------------------------------------------------------- * 03320011
026900*    OPEN CURSOR                                                  03330011
027000* ------------------------------------------------------------- * 03340011
027100 1050-READ-CONTROL-CARD.                                          03350011
027200                                                                  03360011
027300     OPEN INPUT CONTROL-CARD.                                     03370011
027400     READ CONTROL-CARD INTO CC-CONTROL-CARD.                      03380011
027500                                                                  03390011
027600     IF CC-QMGR-NAME = SPACES                                     03400011
027700         DISPLAY PC-PGM-NAME                                      03410011
027800             'CONTROL CARD MISSING - FOR QMGR NAME'               03420011
027900         SET AC-CONTROL-CARD-ERROR TO TRUE                        03430011
028000         CALL 'ILBOABN0' USING AC-ABEND-CODE                      03440011
028100     ELSE                                                         03450011
028200         DISPLAY PC-PGM-NAME                                      03460011
028300                 '- CONTROL CARD: '                               03470011
028400                 CC-CONTROL-CARD                                  03480011
028500     END-IF.                                                      03490011
028600                                                                  03500011
028700     CLOSE CONTROL-CARD.                                          03510011
028800                                                                  03520011
028900* ------------------------------------------------------------- * 03530011
029000*    OPEN CURSOR                                                  03540011
029100* ------------------------------------------------------------- * 03550011
029200 1100-OPEN-CURSOR.                                                03560011
029300                                                                  03570011
029400     EXEC SQL                                                     03580011
029500         OPEN AUTH-CSR                                            03590011
029600     END-EXEC.                                                    03600011
029700                                                                  03610011
029800     EVALUATE TRUE                                                03620011
029900         WHEN SQLCODE NOT = 0                                     03630011
030000             DISPLAY ' '                                          03640011
030100             DISPLAY '** ABEND     **' SQLCODE                    03650011
030200             DISPLAY '** PROGRAM   **  = ' PC-PGM-NAME            03660011
030300             DISPLAY '** PARAGRAPH **  = 4400-OPEN-CORP-CURSOR'   03670011
030400             DISPLAY '** OPEN CURSOR TO '                         03680011
030500             DISPLAY '** SVT_KOHLS_CRD_ACCT TABLE '               03690011
030600             DISPLAY '** TO FIND THE ISSUE DATE'                  03700011
030700             PERFORM 9100-SQL-ABEND                               03710011
030800     END-EVALUATE.                                                03720011
030900                                                                  03730011
031000                                                                  03740011
031100* ------------------------------------------------------------- * 03750011
031200*    Connect to the queue manager                                 03760011
031300* ------------------------------------------------------------- * 03770011
031400                                                                  03780011
031500 1200-CONNECT-QUEUE-MANAGER.                                      03790011
031600                                                                  03800011
031700     MOVE CC-QMGR-NAME TO PV-QM-NAME.                             03810011
031800                                                                  03820011
031900     CALL PC-MQCONN USING PV-QM-NAME                              03830011
032000                          PV-HCONN                                03840011
032100                          PV-COMPLETION-CODE                      03850011
032200                          PV-REASON.                              03860011
032300                                                                  03870011
032400*    If connection failed then display error message              03880011
032500*    and exit                                                     03890011
032600                                                                  03900011
032700     MOVE PV-REASON TO PV-CON-REASON.                             03910011
032800     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   03920011
032900        MOVE 'MQCONN ERROR'               TO PV-ERROR-MESSAGE     03930011
033000        MOVE '1000-CONNECT-QUEUE-MANAGER' TO PV-PARAGRAPH         03940011
033100        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03950011
033200        SET PS-END-PROGRAM TO TRUE                                03960011
033300     END-IF.                                                      03970011
033400     DISPLAY 'MQCONN SUCCESSFUL TO ', PV-QM-NAME.                 03980011
033500                                                                  03990011
033600* ------------------------------------------------------------- * 04000011
033700*    Open the queue for output                                    04010011
033800* ------------------------------------------------------------- * 04020011
033900                                                                  04030011
034000 1500-OPEN-QUEUE.                                                 04040011
034100                                                                  04050011
034200     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      04060011
034300                               MQOO-FAIL-IF-QUIESCING.            04070011
034600                                                                  04080011
034700     MOVE PV-QMGR-NAME     TO MQOD-OBJECTNAME.                    04090011
034800     MOVE PV-QM-NAME       TO MQOD-OBJECTQMGRNAME.                04100011
034900                                                                  04110011
035000     CALL PC-MQOPEN USING PV-HCONN                                04120011
035100                          MQM-OBJECT-DESCRIPTOR                   04130011
035200                          PV-OPEN-OPTIONS                         04140011
035300                          PV-GQ-HANDLE                            04150011
035400                          PV-COMPLETION-CODE                      04160011
035500                          PV-REASON.                              04170011
035600                                                                  04180011
035700*    If open failed then display error message                    04190011
035800*    and exit.                                                    04200011
035900                                                                  04210011
036000     IF (PV-COMPLETION-CODE NOT = MQCC-OK) THEN                   04220011
036100        MOVE 'MQOPEN ERROR'    TO PV-ERROR-MESSAGE                04230011
036200        MOVE '1000-OPEN-QUEUE' TO PV-PARAGRAPH                    04240011
036300        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        04250011
036400        PERFORM 3500-DISCONNECT-QMGR                              04260011
036500        SET PS-END-PROGRAM TO TRUE                                04270011
036600     END-IF.                                                      04280011
036700     DISPLAY 'MQOPEN SUCCESSFUL'.                                 04290011
036800                                                                  04300011
036900* ------------------------------------------------------------- * 04310011
037000* PROCESS THE DATA                                                04320011
037100* ------------------------------------------------------------- * 04330011
037200 2000-PROCESS-DATA.                                               04340011
037300                                                                  04350011
037400     IF (GCT00004-CRD-ACCT-NBR = PV-SAVE-CRD OR                   04360011
CH7356        GCT00004-CRD-ACCT-NBR EQUAL PV-INVALID-CARD)              04370011
037400        CONTINUE                                                  04380011
037900     ELSE                                                         04390011
038000        PERFORM 2200-SELECT-GCT00002                              04400011
038100        IF GCT00004-LAST-UPD-TMST > GCT00002-CRE-TMST             04410011
**CHG*           PERFORM 2100-GET-HRDDCL-CNT                            04420011
**CHG*           IF PV-SAF-CNT < PV-SAF-LIMIT                           04430011
CH7356              PERFORM 2250-GET-RECENT-AUTH-CODE                   04440011
CH7356              IF (PV-AUTH-CODE NOT EQUAL '00' AND                 04450011
CH7356                PV-AUTH-CODE NOT EQUAL '01' AND                   04460011
CH7356                PV-AUTH-CODE NOT EQUAL '02' AND                   04470011
CH7356                PV-AUTH-CODE NOT EQUAL '08' AND                   04480011
CH7356                PV-AUTH-CODE NOT EQUAL '12' AND                   04490011
CH7356                PV-AUTH-CODE NOT EQUAL '21')                      04500011
**CHG*                PERFORM 2300-MOVE-FIELDS-TO-QUEUE                 04510011
**CHG*                PERFORM 2500-MQPUT-MSG                            04520011
                    END-IF                                              04530011
**CHG*           ELSE                                                   04540011
**CHG*              PERFORM 2275-UPDATE-CARD-STAT                       04550011
**CHG*              PERFORM 2900-MOVE-CRD-DETLS                         04560011
**CHG*           END-IF                                                 04570011
**CHG*        END-IF                                                    04580011
**CHG*     END-IF.                                                      04590011
**CHG*                                                                  04600011
038600     MOVE GCT00004-CRD-ACCT-NBR      TO PV-SAVE-CRD.              04610011
038700     MOVE GCT00004-VND-AUTH-RSPN-CDE TO PV-SAVE-AUTH-RSPN.        04620011
038900                                                                  04630011
039000     PERFORM 4000-FETCH-CURSOR.                                   04640011
039100                                                                  04650011
**CHG**---------------------------------------------------------------* 04660011
**CHG**SELECT CARD NUMBER OCCURED LESS THAN 24 TIMES                    04670011
**CHG**---------------------------------------------------------------* 04680011
**CHG* 2100-GET-HRDDCL-CNT.                                             04690011
**CHG**                                                                 04700011
**CHG*     EXEC SQL                                                     04710011
**CHG*         SELECT COUNT(*)                                          04720011
**CHG*              INTO :PV-HRDDCL-COUNT                               04730011
**CHG*         FROM GCT_VND_AUTH                                        04740011
**CHG*         WHERE CRD_ACCT_NBR = :GCT00004-CRD-ACCT-NBR              04750011
**CHG*      END-EXEC.                                                   04760011
**CHG*                                                                  04770011
**CHG*     EVALUATE SQLCODE                                             04780011
**CHG*         WHEN 0                                                   04790011
**CHG*             COMPUTE PV-SAF-CNT = FUNCTION NUMVAL(PV-HRDDCL-COUNT)04800011
**CHG*         WHEN OTHER                                               04810011
**CHG*             MOVE '2100-GET-HRDDCL-CNT' TO PV-PARAGRAPH-NAME      04820011
**CHG*             MOVE GCT00004-CRD-ACCT-NBR TO PV-CARD-NBR            04830011
**CHG*             PERFORM 9100-SQL-ABEND                               04840011
**CHG*     END-EVALUATE.                                                04850011
022900                                                                  04860011
039200* ------------------------------------------------------------- * 04870011
039300* SELECT GCT00002 ROWS FROM TABLE                                 04880011
039400* ------------------------------------------------------------- * 04890011
039500 2200-SELECT-GCT00002.                                            04900011
039600                                                                  04910011
039700     EXEC SQL                                                     04920011
039800         SELECT CRD_ACCT_NBR                                      04930011
039900              , CRE_TMST                                          04940011
040000              , SLS_DTE                                           04950011
040100              , STR_NBR                                           04960011
040200              , RGST_ID                                           04970011
040300              , TRN_NBR                                           04980011
040400              , STRT_TM                                           04990011
040500              , LNE_ITM_SEQ_NBR                                   05000011
040600              , UPC_NUMBER                                        05010011
040700              , CUST_CHRGD_AMT                                    05020011
040800           INTO :GCT00002-CRD-ACCT-NBR                            05030011
040900              , :GCT00002-CRE-TMST                                05040011
041000              , :GCT00002-SLS-DTE                                 05050011
041100              , :GCT00002-STR-NBR                                 05060011
041200              , :GCT00002-RGST-ID                                 05070011
041300              , :GCT00002-TRN-NBR                                 05080011
041400              , :GCT00002-STRT-TM                                 05090011
041500              , :GCT00002-LNE-ITM-SEQ-NBR                         05100011
041600              , :GCT00002-UPC-NUMBER                              05110011
041700              , :GCT00002-CUST-CHRGD-AMT                          05120011
041800         FROM GCT_GFT_CRD_TRN                                     05130011
041900         WHERE CRD_ACCT_NBR = :GCT00004-CRD-ACCT-NBR              05140011
042000         WITH UR                                                  05150011
042100     END-EXEC.                                                    05160011
042200                                                                  05170011
042300     EVALUATE SQLCODE                                             05180011
042400         WHEN 0                                                   05190011
042500             CONTINUE                                             05200011
042600         WHEN OTHER                                               05210011
042700             MOVE '2200-SELECT-GCT00002'   TO PV-PARAGRAPH-NAME   05220011
042800             MOVE 'ERROR SELECTING GCT00002  '                    05230011
042900                                           TO PV-DB2-OPERATION    05240011
043000             PERFORM 9100-SQL-ABEND                               05250011
043100     END-EVALUATE.                                                05260011
CH7356   2250-GET-RECENT-AUTH-CODE.                                     05270011
CH7356                                                                  05280011
CH7356          MOVE SPACES TO PV-AUTH-CODE                             05290011
CH7356                                                                  05300011
CH7356     EXEC SQL                                                     05310011
CH7356          SELECT VND_AUTH_RSPN_CDE                                05320011
CH7356          INTO :PV-AUTH-CODE                                      05330011
CH7356           FROM GCT_VND_AUTH                                      05340011
CH7356               WHERE CRD_ACCT_NBR = :GCT00004-CRD-ACCT-NBR        05350011
CH7356                AND CRE_TMST =                                    05360011
CH7356                   (SELECT MAX(CRE_TMST)                          05370011
CH7356                    FROM GCT_VND_AUTH                             05380011
CH7356                    WHERE CRD_ACCT_NBR = :GCT00004-CRD-ACCT-NBR)  05390011
CH7356     END-EXEC.                                                    05400011
CH7356                                                                  05410011
CH7356      EVALUATE SQLCODE                                            05420011
CH7356      WHEN 0                                                      05430011
CH7356        CONTINUE                                                  05440011
CHGXXX      WHEN -305                                                   05450011
CHGXXX          MOVE '05' TO PV-AUTH-CODE                               05460011
CH7356      WHEN OTHER                                                  05470011
CH7356        MOVE '2250-GET-RECENT-AUTH-CODE' TO PV-PARAGRAPH-NAME     05480011
CH7356        MOVE 'ERROR SELECTING AUTH CODE '                         05490011
CH7356                                         TO PV-DB2-OPERATION      05500011
CH7356        PERFORM 9100-SQL-ABEND                                    05510011
CH7356      END-EVALUATE.                                               05520011
043200*---------------------------------------------------------------* 05530011
**CHG** UPDATE GIFT CARD TO HARD DECLINE - CARD IS SAF HOURLY           05540011
**CHG**---------------------------------------------------------------* 05550011
**CHG* 2275-UPDATE-CARD-STAT.                                           05560011
**CHG*                                                                  05570011
**CHG*     EXEC SQL                                                     05580011
**CHG*         UPDATE GCT_VND_AUTH                                      05590011
**CHG*          SET VND_AUTH_RSPN_CDE = '08'                            05600011
**CHG*            WHERE CRD_ACCT_NBR = :GCT00004-CRD-ACCT-NBR           05610011
**CHG*     END-EXEC.                                                    05620011
                                                                        05630011
**CHG*     EVALUATE SQLCODE                                             05640011
**CHG*         WHEN 0                                                   05650011
**CHG*             CONTINUE                                             05660011
**CHG*         WHEN OTHER                                               05670011
**CHG*             MOVE '2275-UPDATE-CARD-STAT'  TO PV-PARAGRAPH-NAME   05680011
**CHG*             MOVE 'ERROR UPDATING GCT00004   '                    05690011
**CHG*                                           TO PV-DB2-OPERATION    05700011
**CHG*             PERFORM 9100-SQL-ABEND                               05710011
**CHG*     END-EVALUATE.                                                05720011
**CHG**                                                                 05730011
043300* ------------------------------------------------------------- * 05740011
043400* MOVE THE FIELDS TO THE QUEUE                                    05750011
043500* ------------------------------------------------------------- * 05760011
043600 2300-MOVE-FIELDS-TO-QUEUE.                                       05770011
                                                                        05780011
043800      MOVE ZEROES                   TO SA051-PARTN-NBR.           05790011
041000      MOVE GCT00002-SLS-DTE         TO SA051-SLS-DTE.             05800011
043900      MOVE GCT00002-CRD-ACCT-NBR    TO PV-CRD-ACCT-NBR.           05810011
044000      MOVE GCT00002-UPC-NUMBER      TO PV-UPC-NUMBER.             05820011
044100      MOVE GCT00002-CRD-ACCT-NBR    TO SA051-CARD-NBR.            05830011
044200      MOVE GCT00002-STR-NBR         TO SA051-STR-NBR.             05840011
044300      MOVE GCT00002-RGST-ID         TO SA051-RGST-ID.             05850011
044400      MOVE GCT00002-TRN-NBR         TO SA051-TRN-NBR.             05860011
044500      MOVE GCT00002-STRT-TM         TO SA051-STRT-TM.             05870011
044600      MOVE ZEROES                   TO SA051-SLS-CORR-SEQ-NBR.    05880011
044700      MOVE GCT00002-LNE-ITM-SEQ-NBR TO SA051-LNE-ITM-SEQ-NBR.     05890011
044800      MOVE PV-CARD-NBR-R            TO SA051-CARD-NBR.            05900011
044900      MOVE GCT00002-CUST-CHRGD-AMT  TO SA051-CUST-CHRGD-AMT.      05910011
045000      MOVE 'S'                      TO SA051-SAF-CDE.             05920011
045100                                                                  05930011
045200      MOVE SA051-CARD-INFO    TO PV-PUT-MESSAGE-BUFFER.           05940011
045300                                                                  05950011
043700                                                                  05960011
045400* ------------------------------------------------------------- * 05970011
045500* PUT MESSAGE ON LOCAL QUEUE TO END THE DATA COLLECT PROCESS      05980011
045600* ------------------------------------------------------------- * 05990011
045700 2500-MQPUT-MSG.                                                  06000011
045800     DISPLAY 'BLKHAWK-FEED'.                                      06010011
045800     DISPLAY '  PARTN-NBR       = ' SA051-PARTN-NBR.              06020011
045800     DISPLAY '  SLS-DTE         = ' SA051-SLS-DTE.                06030011
045800     DISPLAY '  STR-NBR         = ' SA051-STR-NBR.                06040011
045800     DISPLAY '  RGST-ID         = ' SA051-RGST-ID.                06050011
045800     DISPLAY '  TRN-NBR         = ' SA051-TRN-NBR.                06060011
045800     DISPLAY '  STRT-TM         = ' SA051-STRT-TM.                06070011
045800     DISPLAY '  SLS-CORR-SEQ-NBR= ' SA051-SLS-CORR-SEQ-NBR.       06080011
045800     DISPLAY '  LNE-ITM-SEQ-NBR = ' SA051-LNE-ITM-SEQ-NBR.        06090011
045800     DISPLAY '  CARD-NBR        = ' SA051-CARD-NBR.               06100011
045800     DISPLAY '  CUST-CHRGD-AMT  = ' SA051-CUST-CHRGD-AMT.         06110011
045800     DISPLAY '  SA051-CARD-LENGTH = ' SA051-CARD-LENGTH.          06120011
045800                                                                  06130011
045800     MOVE SA051-BLKHAWK-FIELDS TO PV-BLKHAWK-DATA.                06140011
045800     MOVE SA051-CARD-LENGTH    TO PV-DATA-LENGTH.                 06150011
045800                                                                  06160011
045800     COMPUTE MQPMO-OPTIONS = MQPMO-SYNCPOINT.                     06170011
045800                                                                  06180011
045800     MOVE PV-QM-NAME          TO MQOD-OBJECTQMGRNAME.             06190011
045800     MOVE PV-QMGR-NAME        TO MQOD-OBJECTNAME.                 06200011
045800     MOVE PV-BLKHAWK-FEED     TO PV-MSGBUFFER.                    06210011
045800     MOVE MQPER-PERSISTENT    TO MQMD-PERSISTENCE.                06220011
045800                                                                  06230011
045800     IF (CC-QMGR-NAME NOT = 'QKSP')                               06240011
045800         DISPLAY ' '                                              06250011
045800         DISPLAY '2600-PUT BLKHAWK QUEUE = '                      06260011
045800         DISPLAY SA051-BLKHAWK-FIELDS                             06270011
045800     END-IF.                                                      06280011
045800                                                                  06290011
045800     CALL PC-MQPUT USING PV-HCONN                                 06300011
035300                         PV-GQ-HANDLE                             06310011
045800                         MQM-MESSAGE-DESCRIPTOR                   06320011
045800                         MQM-PUT-MESSAGE-OPTIONS                  06330011
045800                         PV-DATA-LENGTH                           06340011
045800                         PV-MSGBUFFER                             06350011
045800                         PV-COMPLETION-CODE                       06360011
045800                         PV-REASON.                               06370011
045800                                                                  06380011
045800     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        06390011
045800        DISPLAY '                            '                    06400011
045800        DISPLAY '2500-PUT-TO-MQ-BLKHAWK-FEED'                     06410011
045800        DISPLAY 'ERROR ON INITIAL PUT TO BLACK HAWK'              06420011
045800        DISPLAY 'PV-REASON         = ' PV-REASON                  06430011
045800        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         06440011
045800        DISPLAY 'PV-PQ-HANDLE-BH   = ' PV-PQ-HANDLE-BH            06450011
045800        DISPLAY 'PV-HCONN          = ' PV-HCONN                   06460011
045800        DISPLAY 'PV-QM-NAME        = ' PV-QM-NAME                 06470011
045800        DISPLAY 'CC-BLKHAWK-QNAME  = ' CC-QMGR-NAME               06480011
045800        DISPLAY '** WILL PERFORM RETRY LOGIC **'                  06490011
045800        PERFORM 2600-RETRY-PUT-TO-BLKHAWK                         06500011
045800     ELSE                                                         06510011
045800        PERFORM 9800-COMMIT-MQ                                    06520011
057800        ADD 1 TO PV-NUMPUTS                                       06530011
045800     END-IF.                                                      06540011
045800                                                                  06550011
045800     INITIALIZE PV-BLKHAWK-FEED.                                  06560011
045800     INITIALIZE SA051-BLKHAWK-FIELDS.                             06570011
045800                                                                  06580011
045400* ------------------------------------------------------------- * 06590011
045500* PUT MESSAGE ON QUEUE                                            06600011
045600* ------------------------------------------------------------- * 06610011
045700 2600-RETRY-PUT-TO-BLKHAWK.                                       06620011
046000                                                                  06630011
046000*** ATTEMPT TO CLOSE THE QUEUE, IF IT FAILS, GO AHEAD AND REOPEN  06640011
046000*** AT THAT POINT TO ESTABLISH A NEW HANDLE.                      06650011
046000                                                                  06660011
049300     PERFORM 3000-CLOSE-QUEUE.                                    06670011
046000     PERFORM 2700-REOPEN-BLKHAWK.                                 06680011
046000     PERFORM 2800-RETRY-PUT-TO-BLKHAWK.                           06690011
046000                                                                  06700011
046000******************************************************************06710011
046000* REOPEN BLACK HAWK                                               06720011
046000******************************************************************06730011
046000 2700-REOPEN-BLKHAWK.                                             06740011
046000                                                                  06750011
046000     INITIALIZE PV-PQ-HANDLE-BH.                                  06760011
046000                                                                  06770011
046000     COMPUTE PV-OPEN-OPTIONS = MQOO-OUTPUT +                      06780011
046000                               MQOO-FAIL-IF-QUIESCING.            06790011
046000                                                                  06800011
034700     MOVE PV-QMGR-NAME     TO MQOD-OBJECTNAME.                    06810011
034800     MOVE PV-QM-NAME       TO MQOD-OBJECTQMGRNAME.                06820011
046000                                                                  06830011
046000     CALL PC-MQOPEN USING PV-HCONN                                06840011
046000                          MQM-OBJECT-DESCRIPTOR                   06850011
046000                          PV-OPEN-OPTIONS                         06860011
046000                          PV-GQ-HANDLE                            06870011
046000                          PV-COMPLETION-CODE                      06880011
046000                          PV-REASON.                              06890011
046000                                                                  06900011
046000*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE                    06910011
046000*    AND EXIT.                                                    06920011
046000                                                                  06930011
046000     IF (PV-COMPLETION-CODE   NOT = MQCC-OK)                      06940011
046000        MOVE 'MQOPEN ERROR'   TO PV-ERROR-MESSAGE                 06950011
046000        MOVE '27200-REOPEN BLACK HAWK '                           06960011
046000                              TO PV-PARAGRAPH                     06970011
046000                                                                  06980011
046000        DISPLAY '                                        '        06990011
046000        DISPLAY 'ABENDING IN REPOPEN OF BLACK HAWK QUEUE'         07000011
046000        DISPLAY 'PV-REASON         = ' PV-REASON                  07010011
046000        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         07020011
046000        DISPLAY 'PV-HCONN          = ' PV-HCONN                   07030011
046000        DISPLAY 'PV-PQ-HANDLE-BH      = ' PV-PQ-HANDLE-BH         07040011
046000                                                                  07050011
046000        MOVE PV-REASON TO PV-SAVE-REASON                          07060011
046000                                                                  07070011
046000        PERFORM 9400-DISCONNECT-QMGR                              07080011
046000        PERFORM 9200-DISPLAY-MQ-ERROR                             07090011
046000     END-IF.                                                      07100011
046000                                                                  07110011
046000     DISPLAY 'REOPEN OF BLACK HAWK QUEUE SUCCESSFUL'.             07120011
046000                                                                  07130011
046000******************************************************************07140011
046000* RETRY PUT TO BLACK HAWK                                         07150011
046000******************************************************************07160011
046000 2800-RETRY-PUT-TO-BLKHAWK.                                       07170011
046000                                                                  07180011
045800     MOVE PV-QM-NAME             TO MQOD-OBJECTQMGRNAME.          07190011
045800     MOVE PV-QMGR-NAME           TO MQOD-OBJECTNAME.              07200011
046000     MOVE PV-BLKHAWK-FEED        TO PV-MSGBUFFER.                 07210011
046000     MOVE MQPER-PERSISTENT       TO MQMD-PERSISTENCE.             07220011
046000     MOVE MQFMT-STRING           TO MQMD-FORMAT.                  07230011
046000                                                                  07240011
046000     MOVE 0                      TO PV-DATA-LENGTH.               07250011
046000     MOVE SA051-CARD-LENGTH      TO PV-DATA-LENGTH.               07260011
046000                                                                  07270011
046000     CALL PC-MQPUT USING PV-HCONN                                 07280011
035300                         PV-GQ-HANDLE                             07290011
046000                         MQM-MESSAGE-DESCRIPTOR                   07300011
046000                         MQM-PUT-MESSAGE-OPTIONS                  07310011
046000                         PV-DATA-LENGTH                           07320011
046000                         PV-MSGBUFFER                             07330011
046000                         PV-COMPLETION-CODE                       07340011
046000                         PV-REASON.                               07350011
046000                                                                  07360011
046000*    DISPLAY ERROR MESSAGE IF PUT FAILED                          07370011
046000*       AND BREAK OUT OF LOOP                                     07380011
046000                                                                  07390011
046000     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        07400011
046000        DISPLAY '                             '                   07410011
046000        DISPLAY 'ERROR ON REPUT TO BLACK HAWK'                    07420011
046000        DISPLAY 'PV-REASON         = ' PV-REASON                  07430011
046000        DISPLAY 'PV-COMPLETION-CODE= ' PV-COMPLETION-CODE         07440011
046000        DISPLAY 'PV-PQ-HANDLE-BH   = ' PV-PQ-HANDLE-BH            07450011
046000        DISPLAY 'PV-HCONN          = ' PV-HCONN                   07460011
046000        DISPLAY 'PV-QM-NAME        = ' PV-QM-NAME                 07470011
046000        DISPLAY 'CC-QMGR-NAME      = ' CC-QMGR-NAME               07480011
046000                                                                  07490011
046000        MOVE PV-COMPLETION-CODE  TO PV-SAVE-COMPLETION-CODE       07500011
046000        MOVE PV-REASON           TO PV-SAVE-REASON                07510011
046000        MOVE '2800-RETRY-PUT-TO-BLKHAWK'                          07520011
046000                                 TO PV-PARAGRAPH                  07530011
046000        MOVE 'MQPUT ERROR'       TO PV-ERROR-MESSAGE              07540011
046000                                                                  07550011
046000        PERFORM 9700-BACK-OUT-MQ                                  07560011
046000        PERFORM 9200-DISPLAY-MQ-ERROR                             07570011
046000     ELSE                                                         07580011
046000        PERFORM 9800-COMMIT-MQ                                    07590011
057800        ADD 1 TO PV-NUMPUTS                                       07600011
046000     END-IF.                                                      07610011
048900                                                                  07620011
**CHG**---------------------------------------------------------------* 07630011
**CHG**FETCH THE HARD DECLINE CARDS DETAILS AND MOVE TO OUTPUT FILE     07640011
**CHG**---------------------------------------------------------------* 07650011
**CHG* 2900-MOVE-CRD-DETLS.                                             07660011
**CHG*                                                                  07670011
**CHG*     MOVE GCT00002-UPC-NUMBER        TO PV-UPC-START-1            07680011
**CHG*                                        PV-UPC-END-1              07690011
**CHG*     MOVE 0                          TO PV-UPC-START-2            07700011
**CHG*     MOVE 9                          TO PV-UPC-END-2              07710011
**CHG*     MOVE PV-UPC-START-SETUP         TO PV-UPC-START              07720011
**CHG*     MOVE PV-UPC-END-SETUP           TO PV-UPC-END                07730011
**CHG*     PERFORM 3100-GET-UPC-DESC.                                   07740011
**CHG*     MOVE GCT00004-CRD-ACCT-NBR      TO PL-CRD-ACCT-NBR.          07750011
**CHG*     MOVE GCT00004-VND-AUTH-RSPN-CDE TO PL-VND-AUTH-RSPN-CDE.     07760011
**CHG*     MOVE GCT00002-UPC-NUMBER        TO PL-CRD-UPC-NBR.           07770011
**CHG*     MOVE GCT00002-CRE-TMST          TO PL-CRD-CRE-TRAN-TMST.     07780011
**CHG*     MOVE PV-SKU-DESC                TO PL-SKU-DESC.              07790011
**CHG*     PERFORM 7000-WRITE-OUTPUT-FILE.                              07800011
**CHG**---------------------------------------------------------------* 07810011
**CHG**3100-GET-UPC-DESC - GET UPC DESCRIPTION FROM XST TABLES          07820011
**CHG**---------------------------------------------------------------* 07830011
        3100-GET-UPC-DESC.                                              07840011
                                                                        07850011
043000     EXEC SQL                                                     07860011
043100         SELECT SKU_DESC                                          07870011
043200               INTO :PV-SKU-DESC                                  07880011
043500           FROM XST_SKU A,                                        07890011
                      XST_UPC B,                                        07900011
                      GCT_VND_COMMS C                                   07910011
               WHERE  C.UPC_NBR BETWEEN :PV-UPC-START AND :PV-UPC-END   07920011
                  AND C.UPC_NBR = B.UPC_NBR                             07930011
043600            AND A.INTR_UPC_ID = B.INTR_UPC_ID                     07940011
C39248         FETCH FIRST 1 ROW ONLY                                   07941015
044100           WITH UR                                                07950011
044200     END-EXEC.                                                    07960011
                                                                        07970011
044400     EVALUATE TRUE                                                07980011
044500         WHEN SQLCODE = 0                                         07990011
044600             CONTINUE                                             08000011
044700         WHEN SQLCODE = +100                                      08010011
FIX                CONTINUE                                             08011012
C39248             DISPLAY 'UPC NOT FOUND FOR THE BELOW RANGE'          08020015
C39248             DISPLAY 'START UPC NUMBER -' PV-UPC-START            08020115
C39248             DISPLAY 'END   UPC NUMBER -' PV-UPC-END              08020215
C39248         WHEN OTHER                                               08021015
C39248             DISPLAY 'UPC ISSUE FOR THE BELOW RANGE'              08022015
C39248             DISPLAY 'START UPC NUMBER -' PV-UPC-START            08024015
C39248             DISPLAY 'END   UPC NUMBER -' PV-UPC-END              08025015
044900             MOVE '3100-GET-UPC-DESC' TO PV-PARAGRAPH-NAME        08030011
045200             PERFORM 9100-SQL-ABEND.                              08040011
049000* ------------------------------------------------------------- * 08050011
049100* CLOSE THE QUEUE                                                 08060011
049200* ------------------------------------------------------------- * 08070011
049300 3000-CLOSE-QUEUE.                                                08080011
049400     CALL PC-MQCLOSE USING PV-HCONN                               08090011
049500                           PV-GQ-HANDLE                           08100011
049600                           MQCO-NONE                              08110011
049700                           PV-COMPLETION-CODE                     08120011
049800                           PV-REASON.                             08130011
050600                                                                  08140011
049900     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        08150011
050000        MOVE 'MQCLOSE ERROR'     TO PV-ERROR-MESSAGE              08160011
050100        MOVE '3000-CLOSE-QUEUE ' TO PV-PARAGRAPH                  08170011
050200        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        08180011
050300     ELSE                                                         08190011
050400        DISPLAY 'MQCLOSE SUCCESSFUL'                              08200011
050500     END-IF.                                                      08210011
050600                                                                  08220011
050700* ------------------------------------------------------------- * 08230011
050800* DISCONNECT FROM THE MQ QUEUE MANAGER                            08240011
050900* ------------------------------------------------------------- * 08250011
051000 3500-DISCONNECT-QMGR.                                            08260011
051100                                                                  08270011
051200     IF PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED      08280011
051300        CALL PC-MQDISC USING PV-HCONN                             08290011
051400                             PV-COMPLETION-CODE                   08300011
051500                             PV-REASON                            08310011
051600        IF (PV-COMPLETION-CODE NOT = MQCC-OK)                     08320011
051700           MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE        08330011
051800           MOVE '3500-DISCONNECT-QMGR' TO PV-PARAGRAPH            08340011
051900           PERFORM 9000-DISPLAY-ERROR-MESSAGE                     08350011
052000        ELSE                                                      08360011
052100           DISPLAY 'MQDISC SUCCESSFUL'                            08370011
052200        END-IF                                                    08380011
052300     END-IF.                                                      08390011
052400                                                                  08400011
052500* ------------------------------------------------------------- * 08410011
052600*    FETCH THE AUTH CURSOR                                        08420011
052700* ------------------------------------------------------------- * 08430011
052800 4000-FETCH-CURSOR.                                               08440011
052900                                                                  08450011
053000     EXEC SQL                                                     08460011
053100         FETCH AUTH-CSR                                           08470011
053200           INTO :GCT00004-CRD-ACCT-NBR                            08480011
053300              , :GCT00004-CRE-TMST                                08490011
053400              , :GCT00004-LAST-UPD-TMST                           08500011
053500              , :GCT00004-VND-AUTH-RSPN-CDE                       08510011
053600     END-EXEC.                                                    08520011
053700                                                                  08530011
053800     EVALUATE TRUE                                                08540011
053900     WHEN SQLCODE = +0                                            08550011
054000         CONTINUE                                                 08560011
053900     WHEN SQLCODE = -305                                          08570011
054000         CONTINUE                                                 08580011
054100     WHEN SQLCODE = +100                                          08590011
054200         SET PS-END-OF-CURSOR TO TRUE                             08600011
054300     WHEN OTHER                                                   08610011
054400         DISPLAY '** ABEND     **'                                08620011
054500         DISPLAY '** PROGRAM   **  = ' PC-PGM-NAME                08630011
054600         DISPLAY '** PARAGRAPH **  = 4000-FETCH-CURSOR'           08640011
054700         DISPLAY '** FETCH RECORD FROM '                          08650011
054800         DISPLAY '** SVT_KOHLS_CRD_ACCT TABLE'                    08660011
042700         MOVE '4000-FETCH-CURSOR'       TO PV-PARAGRAPH-NAME      08670011
042800         MOVE 'ERROR FETCHING CURSOR  ' TO PV-DB2-OPERATION       08680011
054900         PERFORM 9100-SQL-ABEND                                   08690011
055000     END-EVALUATE.                                                08700011
055100                                                                  08710011
055200***************************************************************** 08720011
055300*    CLOSE AUTH CURSOR                                            08730011
055400***************************************************************** 08740011
055500 4600-CLOSE-AUTH-CSR.                                             08750011
055600                                                                  08760011
055700     EXEC SQL                                                     08770011
055800        CLOSE AUTH-CSR                                            08780011
055900     END-EXEC.                                                    08790011
056000                                                                  08800011
056100     EVALUATE TRUE                                                08810011
056200         WHEN SQLCODE NOT = 0                                     08820011
056300             DISPLAY '** ABEND     **'                            08830011
056400             DISPLAY '** PROGRAM   **  = ' PC-PGM-NAME            08840011
056500             DISPLAY '** CLOSE CURSOR FOR ISSUE DATE'             08850011
056600             DISPLAY '** PARAGRAPH **  = 4600-CLOSE-AUTH-CSR'     08860011
042700             MOVE '4600-CLOSE-AUTH-CSR'    TO PV-PARAGRAPH-NAME   08870011
042800             MOVE 'ERROR CLOSING CURSOR  ' TO PV-DB2-OPERATION    08880011
056700             PERFORM 9100-SQL-ABEND                               08890011
056800     END-EVALUATE.                                                08900011
056900                                                                  08910011
**CHG**---------------------------------------------------------------* 08920011
**CHG**WRITE THE OUTPUT FILE.                                           08930011
**CHG**---------------------------------------------------------------* 08940011
**CHG* 7000-WRITE-OUTPUT-FILE.                                          08950011
**CHG*                                                                  08960011
**CHG*     WRITE HARD-DECLINE-CARDS-RECORD FROM PL-OUTPUT-LAYOUT.       08970011
058200* ------------------------------------------------------------- * 08980011
058300* DISPLAY THE VALUES OF A FAILED MQ API COMMAND                   08990011
058400* ------------------------------------------------------------- * 09000011
058500 9000-DISPLAY-ERROR-MESSAGE.                                      09010011
058600                                                                  09020011
058700     DISPLAY '** ABEND ***************************************'.  09030011
058800     DISPLAY '** PROGRAM:   ', PC-PGM-NAME.                       09040011
058900     DISPLAY '** PARAGRAPH: ', PV-PARAGRAPH.                      09050011
059000     DISPLAY '** MESSAGE:   ', PV-ERROR-MESSAGE.                  09060011
059100     DISPLAY '** COMP CODE: ', PV-COMPLETION-CODE.                09070011
059200     DISPLAY '** RSN CODE:  ', PV-REASON.                         09080011
059201     DISPLAY '************************************************'.  09090011
059202     SET AC-MQ-ERROR TO TRUE.                                     09100011
059203     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09110011
059204                                                                  09120011
059205***************************************************************** 09130011
059206* PERFORMS ABEND PROCESSING FOR SQL ERRORS.                       09140011
059207***************************************************************** 09150011
059208 9100-SQL-ABEND.                                                  09160011
059209                                                                  09170011
059210     DISPLAY '9100-SQL-ABEND'.                                    09180011
059220     DISPLAY '**  ABEND     **'.                                  09190011
059230     DISPLAY '**  PROGRAM   ** = ' PC-PGM-NAME.                   09200011
059240     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             09210011
059250     DISPLAY '**  SQLCODE   ** = ' SQLCODE.                       09220011
059260                                                                  09230011
059270******************************************************************09240011
059280* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *09250011
059290* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *09260011
059300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *09270011
059400* FORMAT.                                                        *09280011
059500******************************************************************09290011
059600                                                                  09300011
059700     COPY DPPD004.                                                09310011
059800                                                                  09320011
059900     MOVE +4013 TO AC-ABEND-CODE.                                 09330011
060000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09340011
059600                                                                  09350011
059600******************************************************************09360011
059600* DISPLAY MQ ERROR                                                09370011
059600******************************************************************09380011
059600 9200-DISPLAY-MQ-ERROR.                                           09390011
059600                                                                  09400011
059600     CALL PC-MQCHECK USING PV-SAVE-REASON                         09410011
059600                           PV-MQ-REASON-TEXT.                     09420011
059600                                                                  09430011
059600     DISPLAY '                                                '.  09440011
059600     DISPLAY '**** ABEND *************************************'.  09450011
059600     DISPLAY '** MQSERIES ERROR **'.                              09460011
059600     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      09470011
059600     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     09480011
059600     DISPLAY '** MESSAGE:    ', PV-ERROR-MESSAGE.                 09490011
059600     DISPLAY '** COMP CODE:  ', PV-SAVE-COMPLETION-CODE.          09500011
059600     DISPLAY '** RSN CODE:   ', PV-SAVE-REASON.                   09510011
059600     DISPLAY '** RSN TEXT:   ', PV-MQ-REASON-TEXT.                09520011
059600     DISPLAY '************************************************'.  09530011
059600                                                                  09540011
059600     SET AC-MQ-ERROR TO TRUE.                                     09550011
059600                                                                  09560011
059600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         09570011
059600                                                                  09580011
059600***************************************************************** 09590011
059600* DISCONNECT FROM THE QUEUE MANAGER                               09600011
059600***************************************************************** 09610011
059600 9400-DISCONNECT-QMGR.                                            09620011
059600                                                                  09630011
059600     IF PV-CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED      09640011
059600        CALL PC-MQDISC USING PV-HCONN                             09650011
059600                            PV-COMPLETION-CODE                    09660011
059600                            PV-REASON                             09670011
059600                                                                  09680011
059600        IF (PV-COMPLETION-CODE NOT = MQCC-OK)                     09690011
059600           MOVE 'MQDISC ERROR'         TO PV-ERROR-MESSAGE        09700011
059600           MOVE '9400-DISCONNECT-QMGR' TO PV-PARAGRAPH            09710011
059600           PERFORM 9200-DISPLAY-MQ-ERROR                          09720011
059600        ELSE                                                      09730011
059600           DISPLAY 'MQDISC SUCCESSFUL'                            09740011
059600        END-IF                                                    09750011
059600     END-IF.                                                      09760011
059600                                                                  09770011
057000* ------------------------------------------------------------- * 09780011
057100* END THE PROGRAM                                                 09790011
057200* ------------------------------------------------------------- * 09800011
057300 9500-END-PROGRAM.                                                09810011
057400                                                                  09820011
057500*    Display the number of messages successfully put              09830011
057600*    to the queue                                                 09840011
**CHG*     CLOSE HARD-DECLINE-CARDS-FILE.                               09850011
057800     DISPLAY PV-NUMPUTS, ' MESSAGES PUT TO QUEUE'.                09860011
057900                                                                  09870011
058000     STOP RUN.                                                    09880011
058100                                                                  09890011
060100******************************************************************09900011
060100* BACK OUT MQ                                                     09910011
060100******************************************************************09920011
060100 9700-BACK-OUT-MQ.                                                09930011
060100                                                                  09940011
060100     CALL PC-MQBACK USING PV-HCONN                                09950011
060100                          PV-COMPLETION-CODE                      09960011
060100                          PV-REASON.                              09970011
060100                                                                  09980011
060100     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        09990011
060100        MOVE '9700-BACK-OUT-MQ'  TO PV-PARAGRAPH                  10000011
060100        MOVE 'MQBACK ERROR'    TO PV-ERROR-MESSAGE                10010011
060100        PERFORM 9200-DISPLAY-MQ-ERROR                             10020011
060100     END-IF.                                                      10030011
060100                                                                  10040011
060100******************************************************************10050011
060100* COMMIT MQ                                                       10060011
060100******************************************************************10070011
060100 9800-COMMIT-MQ.                                                  10080011
060100                                                                  10090011
060100     CALL PC-MQCMIT USING PV-HCONN                                10100011
060100                          PV-COMPLETION-CODE                      10110011
060100                          PV-REASON.                              10120011
060100                                                                  10130011
060100     IF (PV-COMPLETION-CODE NOT = MQCC-OK)                        10140011
060100        MOVE '9800-COMMIT-MQ'  TO PV-PARAGRAPH                    10150011
060100        MOVE 'MQCMIT ERROR'    TO PV-ERROR-MESSAGE                10160011
060100        PERFORM 9700-BACK-OUT-MQ                                  10170011
060100        PERFORM 9200-DISPLAY-MQ-ERROR                             10180011
060100     END-IF.                                                      10190011
060100                                                                  10200011
