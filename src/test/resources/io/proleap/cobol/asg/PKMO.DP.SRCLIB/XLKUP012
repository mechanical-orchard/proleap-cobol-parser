000100 TITLE 'MAINTAIN LEGACY TPOINST/TINSTCD TABLE FROM RMS PO SYSTEM'.        
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    XLKUP012.                                                 
000400 AUTHOR.        DEANNA BRANTNER.                                          
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
000600 DATE-WRITTEN.  MARCH, 2003.                                              
000700 DATE-COMPILED.                                                           
000800*                                                                         
000900* 1000-INITIALIZATION.                                                    
001000*    INITIALIZE RETURN AREA IN COPYBOOK AND EXSISTENCE SWITCH             
001100*                                                                         
001200*    IF XL011-IA-RECIPIENT-CODE = 'ED'                                    
001300*        CONTINUE                                                         
001400*    ELSE                                                                 
001500*                                                                         
001600* 2000-PROCESS-MESSAGE                                                    
001700*                                                                         
001800*    'SPECIAL_INSTR_ADD'                                                  
001900*        A) DOES PO EXIST ON TPURCHS?                                     
002000*            YES --                                                       
002100*            1 - FIND THE LOWEST INSTR-NBR ON AN                          
002200*                EXISTING TINSTCD ROW TO MATCH                            
002300*                XL011-IA-INSTRUCTION-DESC                                
002400*                                                                         
002500*                a) None found                                            
002600*                  * insert new TINSTCD and TPOINST                       
002700*                       (should insert TINSTCD before TPOINST)            
002800*                    The insert to TINSTCD will use a                     
002900*                    subselect in the values clause.                      
003000*                    This should eliminate the time gap                   
003100*                    between finding the max+1 and the actual             
003200*                    insert                                               
003300*                                                                         
003400*                b) Instr-nbr is found so just add TPOINST to             
003500*                    match                                                
003600*                                                                         
003700*                                                                         
003800*        A1)  Tpurchs does not exist -- ERROR                             
003900*                                                                         
004000*    'SPECIAL_INSTR_DELETE'                                               
004100*        Find INSTR_NBR that matches the given description                
004200*           This is a join between the master and the detail              
004300*            (PS-IND-VAR) is worthless here)                              
004400*        Delete TPOINST for the matching INSTR_NBR                        
004500*                                                                         
004600*    'HDR_DELETE'                                                         
004700*        Delete the TPOINST row for the PO                                
004800*                                                                         
004900* 9999-WRAPUP.                                                            
005000*        Move the SQLCA to the copybook SQLCA before                      
005100*        returning to XLKUT023 whence called.                             
005200/                                                                         
005300 ENVIRONMENT DIVISION.                                                    
005400 CONFIGURATION SECTION.                                                   
005500 SOURCE-COMPUTER.  IBM-3090.                                              
005600 OBJECT-COMPUTER.  IBM-3090.                                              
005700 DATA DIVISION.                                                           
005800                                                                          
005900 WORKING-STORAGE SECTION.                                                 
006000                                                                          
006100 01  PS-PROGRAM-STUFF.                                                    
006200     05  PS-EXISTENCE-PO              PIC S9 COMP-3 VALUE ZERO.           
006300         88  PS-PO-EXISTS-YES                       VALUE 1.              
006400         88  PS-PO-EXISTS-NO                        VALUE ZERO.           
006500     05  PS-COUNT                     PIC S9 COMP-3 VALUE ZERO.           
006600     05  PS-IND-VAR                   PIC S9(04)    VALUE +0              
006700                                                        COMP SYNC.        
006800     05  PV-DISP-NBR                  PIC -Z9(09).                        
006900     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO               
007000                                                 COMP SYNC.               
007100     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +04               
007200                                                 COMP.                    
007200     05  PC-SPACE                     PIC  X(01)  VALUE ' '.              
007300                                                                          
007400*    NUMERIC EDITING ROUTINE                                              
007500     COPY DPWS010I.                                                       
007600                                                                          
007700*    PO INSTRUCTIONS                                                      
007800     EXEC SQL                                                             
007900         INCLUDE TPOINST                                                  
008000     END-EXEC.                                                            
008100                                                                          
008200*    PO INSTRUCTION DESCRIPTIONS                                          
008300     EXEC SQL                                                             
008400         INCLUDE TINSTCD                                                  
008500     END-EXEC.                                                            
008600                                                                          
008700*    PO HEADERS                                                           
008800     EXEC SQL                                                             
008900         INCLUDE TPURCHS                                                  
009000     END-EXEC.                                                            
009100                                                                          
009200     EXEC SQL                                                             
009300          INCLUDE SQLCA                                                   
009400     END-EXEC.                                                            
009500                                                                          
009600     COPY SQLCA2.                                                         
009700                                                                          
009800*****************************************************************         
009900 LINKAGE SECTION.                                                         
010000 01  XLRD011-RECORD.                                                      
010100     COPY XLRD011.                                                        
010200*****************************************************************         
010300 PROCEDURE DIVISION USING XLRD011-RECORD.                                 
010400*****************************************************************         
010500                                                                          
010600     PERFORM 1000-INITIALIZATION.                                         
010700                                                                          
010800     IF XL011-IA-RECIPIENT-CODE = 'ED'                                    
010900         CONTINUE                                                         
011000     ELSE                                                                 
011100         PERFORM 2000-PROCESS-MESSAGE                                     
011200     END-IF.                                                              
011300                                                                          
011400     PERFORM 9999-WRAPUP.                                                 
011500                                                                          
011600     GOBACK.                                                              
011700                                                                          
011800*****************************************************************         
011900 1000-INITIALIZATION.                                                     
012000                                                                          
012100     IF XL011-DEBUG-YES                                           01840009
               DISPLAY SPACES                                                   
012200         DISPLAY 'XLKUP012 - 1000-INITIALIZATION'                 01850009
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
012500     END-IF                                                       01860009
012600                                                                  01870009
012700     INITIALIZE XL011-RETURN-AREA.                                        
012800     MOVE 0 TO PS-EXISTENCE-PO.                                           
012900     MOVE 'XLKUP012'   TO XL011-ERROR-PROGRAM.                            
013000                                                                          
013100                                                                          
013200*****************************************************************         
013300 2000-PROCESS-MESSAGE.                                                    
013400                                                                          
013500     IF XL011-DEBUG-YES                                           01840009
013600         DISPLAY 'XLKUP012 - 2000-PROCESS-MESSAGE'                01850009
013900                 ' / XL011-MSG-ID = ' XL011-MSG-ID                00930001
013700         DISPLAY 'XLKUP012 - XL011-RETURN-CODE='                  00930001
013800                             XL011-RETURN-CODE                            
014000     END-IF                                                       01860009
014100                                                                  01870009
014200     IF XL011-SUCCESSFUL                                                  
014300         EVALUATE XL011-MSG-ID                                            
014400           WHEN 'SPECIAL_INSTR_ADD'                                       
014400               PERFORM 2050-INSPECT-MESSAGE                               
014500               PERFORM 7000-SELECT-TPURCHS                                
014600               IF PS-PO-EXISTS-YES                                        
014700                   PERFORM 2100-INSERT-INSTR                              
014800               END-IF                                                     
014900           WHEN 'SPECIAL_INSTR_DELETE'                                    
015000               PERFORM 2200-DELETE-INSTRUC                                
015100           WHEN 'HDR_DELETE'                                              
015200               PERFORM 8300-HDRDEL-TPOINST                                
015300         END-EVALUATE                                                     
015400     END-IF.                                                              
015500                                                                          
015500                                                                          
521710*----------------------------------------------------------------*        
521720* INSPECT THE SPECIAL INSTRUCTION MESSAGE AND CONVERT INVALID    *        
521730* CHARACTERS TO SPACES.                                          *        
521740*----------------------------------------------------------------*        
521750 2050-INSPECT-MESSAGE.                                                    
521760                                                                          
521780     MOVE SPACE TO  PC-SPACE.                                             
521790     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521791         quote BY PC-SPACE.                                               
521792     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521793         '&'   BY PC-SPACE.                                               
521794     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521795         '"'   BY PC-SPACE.                                               
521796     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521797         '<'   BY PC-SPACE.                                               
521798     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521799         '>'   BY PC-SPACE.                                               
521807     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521808         ';'   BY PC-SPACE.                                               
521809     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521810         LOW-VALUES BY PC-SPACE.                                          
521801* HEX 05                                                                  
521803     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521804         '	'   BY PC-SPACE.                                               
521801* HEX 4A                                                                  
521805     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521806         '›'   BY PC-SPACE.                                               
521812* HEX 3F                                                                  
521814     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521815         ''   BY PC-SPACE.                                               
521817* HEX 71                                                                  
521819     INSPECT XL011-IA-INSTRUCTION-DESC  REPLACING ALL                     
521820         'ˆ'   BY PC-SPACE.                                               
521821                                                                          
521822                                                                          
015600*****************************************************************         
015700 2100-INSERT-INSTR.                                                       
015800     IF XL011-DEBUG-YES                                           01840009
015900         DISPLAY 'XLKUP012 - 2100-INSERT-INSTR'                   01850009
016000                 ' / XLKUP012 - INSTR-DESC = '                    00930001
016100                             INSTCD-INSTR-DESC (1:25)                     
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
016200     END-IF                                                       01860009
016300                                                                  01870009
016400     MOVE '2100-INSERT-INSTR'         TO XL011-ERROR-PARAGRAPH.           
016500                                                                          
016600     INITIALIZE DCLTINSTCD.                                               
016700*  SEARCH FOR AN EXISTING MATCH                                           
016800     MOVE XL011-IA-INSTRUCTION-DESC   TO INSTCD-INSTR-DESC.               
016900     EXEC SQL                                                             
017000         SELECT MIN(INSTR_NBR)                                            
017100         INTO :INSTCD-INSTR-NBR :PS-IND-VAR                               
017200         FROM TINSTCD                                                     
017300         WHERE INSTR_DESC = :INSTCD-INSTR-DESC                            
017400     END-EXEC.                                                            
017500                                                                          
017600     MOVE SQLCODE         TO XL011-SQLCODE.                               
017700     MOVE PS-IND-VAR      TO PV-DISP-NBR                                  
017800                                                                          
017900     IF XL011-DEBUG-YES                                           01840009
018000         DISPLAY 'XLKUP012 - 2100-INSERT-INSTR'                   01850009
018100                 ' / XL011-SQLCODE = '                            00930001
018200                             XL011-SQLCODE                                
018300                 ' / PS-IND-VAR = '                               00930001
018400                             PV-DISP-NBR                                  
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
018500     END-IF                                                       01860009
018600                                                                          
018700     EVALUATE TRUE                                                        
018800         WHEN SQLCODE = ZERO                                              
018900             IF PS-IND-VAR < 0                                            
019000*                NO MATCH IS FOUND                                        
019100*                SO INSERT NEW ROW WITH THE MAX + 1 VALUE                 
019200*                PERFORM 2300-SELECT-MAX-TINSTCD                          
019300                 PERFORM 8100-INSERT-TINSTCD                              
019400                 PERFORM 8000-INSERT-TPOINST                              
019500             ELSE                                                         
019600                 CONTINUE                                                 
019700*                INSERT TPOINST USING THE KEYS FOUND                      
019800                 PERFORM 8000-INSERT-TPOINST                              
019900             END-IF                                                       
020000         WHEN SQLCODE = +100                                              
020100*            INSERTS NEW ROW WITH THE MAX + 1 VALUE                       
020200*            PERFORM 2300-SELECT-MAX-TINSTCD                              
020300             PERFORM 8100-INSERT-TINSTCD                                  
020400             PERFORM 8000-INSERT-TPOINST                                  
020500         WHEN OTHER                                                       
020600             SET XL011-SQL-ERROR      TO TRUE                             
020700             MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
020800     END-EVALUATE.                                                        
020900                                                                          
021000*****************************************************************         
021100 2200-DELETE-INSTRUC.                                                     
021200                                                                          
021300     MOVE '2200-DELETE-INSTRUC'       TO XL011-ERROR-PARAGRAPH.           
021400     IF XL011-DEBUG-YES                                           01840009
021500         DISPLAY 'XLKUP012 - 2200-DELETE-INSTRUC'                 01850009
021600         DISPLAY ' - XL011-SQLCODE = '                            00930001
021700                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
021800         DISPLAY ' INSTCD-DESC = ' INSTCD-INSTR-DESC(1:25)                
021900                 ' / RECIP-CDE = ' POINST-RECIP-CDE                       
022000                 ' / PO-NBR = ' POINST-PO-NBR                             
022100     END-IF                                                       01860009
022200                                                                          
022300     INITIALIZE DCLTINSTCD.                                               
022400     MOVE XL011-ORDER-NBR             TO POINST-PO-NBR.                   
022500     MOVE XL011-IA-RECIPIENT-CODE     TO POINST-RECIP-CDE.                
022600     MOVE XL011-IA-INSTRUCTION-DESC   TO INSTCD-INSTR-DESC.               
022700                                                                          
022800     EXEC SQL                                                             
022900         SELECT A.INSTR_NBR                                               
023000         INTO :INSTCD-INSTR-NBR                                           
023100         FROM TINSTCD A,                                                  
023200              TPOINST B                                                   
023300         WHERE A.INSTR_DESC = :INSTCD-INSTR-DESC                          
023400           AND A.INSTR_NBR  = B.INSTR_NBR                                 
023500           AND B.RECIP_CDE  = :POINST-RECIP-CDE                           
023600           AND B.PO_NBR     = :POINST-PO-NBR                              
023700     END-EXEC.                                                            
023800                                                                          
023900     MOVE SQLCODE         TO XL011-SQLCODE.                               
024000     IF XL011-DEBUG-YES                                           01840009
024100         DISPLAY 'XLKUP012 - 2200-DELETE-INSTRUC'                 01850009
024200                 ' / XL011-SQLCODE = '                            00930001
024300                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
024400     END-IF                                                       01860009
024500                                                                          
024600     EVALUATE TRUE                                                        
024700         WHEN SQLCODE = ZERO                                              
024800*            IF PS-IND-VAR < 0                                            
024900*                PERFORM 2400-SELECT-TPOINST                              
025000*            ELSE                                                         
025100                 PERFORM 8200-DELETE-TPOINST                              
025200*            END-IF                                                       
025300         WHEN SQLCODE = +100                                              
025400             PERFORM 2400-SELECT-TPOINST                                  
025500         WHEN OTHER                                                       
025600             SET XL011-SQL-ERROR      TO TRUE                             
025700             MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
025800     END-EVALUATE.                                                        
025900                                                                          
026000*****************************************************************         
026100*2300-SELECT-MAX-TINSTCD.                                                 
026200*    MOVE '2300-SELECT-MAX-TINSTCD'   TO XL011-ERROR-PARAGRAPH.           
026300*    EXEC SQL                                                             
026400*        SELECT MAX(INSTR_NBR) + 1                                        
026500*        INTO :INSTCD-INSTR-NBR :PS-IND-VAR                               
026600*        FROM TINSTCD                                                     
026700*    END-EXEC.                                                            
026800*                                                                         
026900*    MOVE SQLCODE         TO XL011-SQLCODE.                               
027000*    EVALUATE TRUE                                                        
027100*        WHEN SQLCODE = ZERO                                              
027200*            IF PS-IND-VAR < 0                                            
027300*                MOVE +1  TO INSTCD-INSTR-NBR                             
027400*            END-IF                                                       
027500*            PERFORM 8100-INSERT-TINSTCD                                  
027600*            PERFORM 8000-INSERT-TPOINST                                  
027700*        WHEN SQLCODE = +100                                              
027800*            STRING 'NO TINSTCD FOR PO = ' XL011-ORDER-NBR                
027900*                    DELIMITED BY SIZE                                    
028000*                                     INTO XL011-ERROR-TEXT               
028100*            SET XL011-SYSTEM-ERROR   TO TRUE                             
028200*            MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
028300*        WHEN OTHER                                                       
028400*            SET XL011-SQL-ERROR      TO TRUE                             
028500*            MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
028600*    END-EVALUATE.                                                        
028700*                                                                         
028800*****************************************************************         
028900 2400-SELECT-TPOINST.                                                     
029000     IF XL011-DEBUG-YES                                           01840009
029100         DISPLAY 'XLKUP012 - 2400-SELECT-TPOINST'                 01850009
029200                 ' / XL011-SQLCODE = '                            00930001
029300                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
029400     END-IF                                                       01860009
029500                                                                          
029600     INITIALIZE DCLTPOINST.                                               
029700     MOVE '2400-SELECT-TPOINST'       TO XL011-ERROR-PARAGRAPH.           
029800     MOVE XL011-ORDER-NBR             TO POINST-PO-NBR.                   
029900     MOVE XL011-IA-RECIPIENT-CODE     TO POINST-RECIP-CDE.                
030000                                                                          
030100     EXEC SQL                                                             
030200         SELECT INSTR_NBR                                                 
030300          INTO :INSTCD-INSTR-NBR                                          
030400         FROM TPOINST                                                     
030500        WHERE PO_NBR     = :POINST-PO-NBR                                 
030600          AND RECIP_CDE  = :POINST-RECIP-CDE                              
030700     END-EXEC.                                                            
030800                                                                          
030900     MOVE SQLCODE         TO XL011-SQLCODE.                               
031000     IF XL011-DEBUG-YES                                           01840009
031100         DISPLAY 'XLKUP012 - 2400-SELECT-TPOINST'                 01850009
031200         DISPLAY 'XLKUP012 - XL011-SQLCODE = '                    00930001
031300                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
031400         ' /  PO-NBR = ' POINST-PO-NBR                                    
031500         ' /  RECIP-CDE = ' POINST-RECIP-CDE                              
031600     END-IF                                                       01860009
031700                                                                          
031800     EVALUATE TRUE                                                        
031900         WHEN SQLCODE = ZERO                                              
032000             PERFORM 8200-DELETE-TPOINST                                  
032100         WHEN SQLCODE = +100                                              
032200             STRING 'NO TPOINST FOR PO = ' XL011-ORDER-NBR                
032300                     DELIMITED BY SIZE                                    
032400                                      INTO XL011-ERROR-TEXT               
032500             SET XL011-SYSTEM-ERROR   TO TRUE                             
032600             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
032700         WHEN SQLCODE = -811                                              
032800             STRING 'MULTI INSTR FOR PO ' XL011-ORDER-NBR                 
032900                     DELIMITED BY SIZE                                    
033000                                      INTO XL011-ERROR-TEXT               
033100             SET XL011-SYSTEM-ERROR   TO TRUE                             
033200             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
033300         WHEN OTHER                                                       
033400             SET XL011-SQL-ERROR      TO TRUE                             
033500             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
033600     END-EVALUATE.                                                        
033700                                                                          
033800*****************************************************************         
033900 7000-SELECT-TPURCHS.                                                     
034000                                                                          
034100     IF XL011-DEBUG-YES                                           01840009
034200         DISPLAY 'XLKUP012 - 7000-SELECT-TPURCHS'                 01850009
034300                 ' / XL011-SQLCODE = '                            00930001
034400                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
034500     END-IF                                                       01860009
034600                                                                          
034700     MOVE '7000-SELECT-TPURCHS'       TO XL011-ERROR-PARAGRAPH.           
034800     MOVE XL011-ORDER-NBR             TO PURCHS-PO-NBR                    
034900     MOVE ZERO                        TO PS-EXISTENCE-PO                  
035000                                                                          
035100     EXEC SQL                                                             
035200         SELECT 1                                                         
035300         INTO                                                             
035400             :PS-EXISTENCE-PO                                             
035500         FROM                                                             
035600             TPURCHS                                                      
035700         WHERE                                                            
035800             PO_NBR                   = :PURCHS-PO-NBR                    
035900         AND VER_STATUS_CDE           = 'A'                               
036000         FETCH FIRST 1 ROWS ONLY                                          
036100     END-EXEC.                                                            
036200                                                                          
036300     MOVE SQLCODE                     TO XL011-SQLCODE                    
036400                                                                          
036500     MOVE PS-EXISTENCE-PO             TO PV-DISP-NBR                      
036600                                                                          
036700     IF XL011-DEBUG-YES                                           01840009
036800         DISPLAY 'XLKUP012 - 7000-SELECT-TPURCHS'                 01850009
036900                 ' /  XL011-SQLCODE = '                           00930001
037000                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
037100                 ' / PS-EXISTENCE-PO = '                          00930001
037200                             PV-DISP-NBR                                  
037300     END-IF                                                       01860009
037400                                                                          
037500     EVALUATE TRUE                                                        
037600         WHEN SQLCODE = ZERO                                              
037700             CONTINUE                                                     
037800         WHEN SQLCODE = +100                                              
037900             STRING 'NO TPURCHS FOR PO = ' XL011-ORDER-NBR                
038000                     DELIMITED BY SIZE                                    
038100                                      INTO XL011-ERROR-TEXT               
038200             SET XL011-SYSTEM-ERROR   TO TRUE                             
038300             MOVE 'TPURCHS'           TO XL011-DB2-TABLE-NAME(1)          
038400         WHEN OTHER                                                       
038500             SET XL011-SQL-ERROR      TO TRUE                             
038600             MOVE 'TPURCHS'           TO XL011-DB2-TABLE-NAME(1)          
038700     END-EVALUATE.                                                        
038800                                                                          
038900*****************************************************************         
039000 8000-INSERT-TPOINST.                                                     
039100                                                                          
039200     IF XL011-DEBUG-YES                                           01840009
039300         DISPLAY 'XLKUP012 - 8000-INSERT-TPOINST'                 01850009
039400                 ' / XL011-SQLCODE = '                            00930001
039500                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
039600     END-IF                                                       01860009
039700                                                                          
039800     MOVE XL011-ORDER-NBR             TO POINST-PO-NBR.                   
039900     MOVE XL011-IA-RECIPIENT-CODE     TO POINST-RECIP-CDE.                
040000     MOVE INSTCD-INSTR-NBR            TO POINST-INSTR-NBR.                
040100     MOVE 'XLKUP012'                  TO POINST-CRE-BY-UID.               
040200     MOVE '8000-INSERT-TPOINST'       TO XL011-ERROR-PARAGRAPH.           
040300                                                                          
040400     EXEC SQL                                                             
040500         INSERT INTO TPOINST                                              
040600             (                                                            
040700              PO_NBR                                                      
040800             ,RECIP_CDE                                                   
040900             ,INSTR_NBR                                                   
041000             ,CRE_BY_UID                                                  
041100             ,CRE_TMST                                                    
041200             )                                                            
041300         VALUES                                                           
041400             (                                                            
041500             :POINST-PO-NBR                                               
041600            ,:POINST-RECIP-CDE                                            
041700            ,:POINST-INSTR-NBR                                            
041800            ,:POINST-CRE-BY-UID                                           
041900*           ,:POINST-CRE-TMST                                             
042000            , CURRENT TIMESTAMP                                           
042100             )                                                            
042200        END-EXEC                                                          
042300                                                                          
042400     MOVE SQLCODE                     TO XL011-SQLCODE                    
042500                                                                          
042600     IF XL011-DEBUG-YES                                           01840009
042700         DISPLAY 'XLKUP012 - 8000-INSERT-TPOINST'                 01850009
042800                 ' / XL011-SQLCODE = '                            00930001
042900                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
043000         ' / PO-NBR = ' POINST-PO-NBR                                     
043100         ' / RECIP-CDE = ' POINST-RECIP-CDE                               
043200         ' / INSTR-NBR = ' POINST-INSTR-NBR                               
043300     END-IF                                                       01860009
043400                                                                          
043500     EVALUATE TRUE                                                        
043600         WHEN SQLCODE = ZERO                                              
043700         WHEN SQLCODE = -803                                              
043800             CONTINUE                                                     
043900         WHEN OTHER                                                       
044000             SET XL011-SQL-ERROR      TO TRUE                             
044100             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
044200     END-EVALUATE.                                                        
044300                                                                          
044400*****************************************************************         
044500 8100-INSERT-TINSTCD.                                                     
044600                                                                          
044700     MOVE XL011-IA-INSTRUCTION-DESC   TO INSTCD-INSTR-DESC.               
044800     MOVE 'XLKUP012'                  TO INSTCD-CRE-BY-UID.               
044900     MOVE '8100-INSERT-TINSTCD'       TO XL011-ERROR-PARAGRAPH.           
045000                                                                          
045100                                                                          
045200     IF XL011-DEBUG-YES                                           01840009
045300         DISPLAY 'XLKUP012 - 8100-INSERT-TINSTCD #1'              01850009
045400                 ' / XL011-SQLCODE = '                            00930001
045500                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
045600     END-IF                                                       01860009
045700                                                                          
045800     PERFORM                                                              
045900         WITH TEST AFTER                                                  
046000         VARYING PV-RETRY-COUNTER                                         
046100         FROM 1 BY 1                                                      
046200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
046300            OR  (SQLCODE = +0))                                           
046400            OR XL011-SQL-ERROR                                            
046500                                                                          
046600     EXEC SQL                                                             
046700         INSERT INTO TINSTCD                                              
046800             ( INSTR_NBR                                                  
046900              ,INSTR_DESC                                                 
047000              ,CRE_BY_UID                                                 
047100              ,CRE_DTE)                                                   
047200         VALUES                                                           
047300             (                                                            
047400                                                                          
047500             (SELECT MAX(INSTR_NBR) + 1                                   
047600              FROM TINSTCD)                                               
047700                                                                          
047800             ,:INSTCD-INSTR-DESC                                          
047900             ,:INSTCD-CRE-BY-UID                                          
048000             , CURRENT DATE)                                              
048100        END-EXEC                                                          
048200                                                                          
048300     MOVE SQLCODE                     TO XL011-SQLCODE                    
048400                                                                          
048500     IF XL011-DEBUG-YES                                           01840009
048600         DISPLAY 'XLKUP012 - 8100-INSERT-TINSTCD'                 01850009
048700                 ' / XL011-SQLCODE = '                            00930001
048800                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
048900         ' /   RETRY-COUNTER = ' PV-RETRY-COUNTER                         
049000         ' /   INSTR-DESC = ' INSTCD-INSTR-DESC(1:25)                     
049100     END-IF                                                       01860009
049200                                                                          
049300     EVALUATE TRUE                                                        
049400         WHEN SQLCODE = ZERO                                              
049500             PERFORM 8400-SELECT-MAX-TINSTCD                              
049600         WHEN SQLCODE = -803                                              
049700         WHEN SQLCODE = -904                                              
049800         WHEN SQLCODE = -911                                              
049900         WHEN SQLCODE = -913                                              
050000             CONTINUE                                                     
050100         WHEN OTHER                                                       
050200             SET XL011-SQL-ERROR      TO TRUE                             
050300             MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
050400     END-EVALUATE                                                         
050500                                                                          
050600     END-PERFORM.                                                         
050700                                                                          
050800     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
050900         SET XL011-SQL-ERROR          TO TRUE                             
051000     END-IF.                                                              
051100                                                                          
051200*****************************************************************         
051300 8200-DELETE-TPOINST.                                                     
051400                                                                          
051500     IF XL011-DEBUG-YES                                           01840009
051600         DISPLAY 'XLKUP012 - 8200-DELETE-TPOINST'                 01850009
051700         DISPLAY 'XLKUP012 - XL011-SQLCODE = '                    00930001
051800                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
051900     END-IF                                                       01860009
052000                                                                          
052100     MOVE '8200-DELETE-TPOINST'       TO XL011-ERROR-PARAGRAPH.           
052200     MOVE XL011-ORDER-NBR             TO POINST-PO-NBR.                   
052300     MOVE XL011-IA-RECIPIENT-CODE     TO POINST-RECIP-CDE.                
052400                                                                          
052500     EXEC SQL                                                             
052600         DELETE                                                           
052700         FROM                                                             
052800             TPOINST                                                      
052900         WHERE                                                            
053000             PO_NBR           = :POINST-PO-NBR                            
053100         AND RECIP_CDE        = :POINST-RECIP-CDE                         
053200         AND INSTR_NBR        = :INSTCD-INSTR-NBR                         
053300     END-EXEC.                                                            
053400                                                                          
053500     MOVE SQLCODE                     TO XL011-SQLCODE                    
053600                                                                          
053700     IF XL011-DEBUG-YES                                           01840009
053800         DISPLAY 'XLKUP012 - 8200-DELETE-TPOINST'                 01850009
053900                 ' / XL011-SQLCODE = '                            00930001
054000                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
054100         ' /   PO-NBR = ' POINST-PO-NBR                                   
054200         ' /   RECIP-CDE = ' POINST-RECIP-CDE                             
054300         ' /   INSTR-NBR = ' INSTCD-INSTR-NBR                             
054400     END-IF                                                       01860009
054500                                                                          
054600     EVALUATE TRUE                                                        
054700         WHEN SQLCODE = ZERO                                              
054800         WHEN SQLCODE = +100                                              
054900             CONTINUE                                                     
055000       WHEN OTHER                                                         
055100             SET XL011-SQL-ERROR      TO TRUE                             
055200             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
055300     END-EVALUATE.                                                        
055400                                                                          
055500*****************************************************************         
055600 8300-HDRDEL-TPOINST.                                                     
055700                                                                          
055800     IF XL011-DEBUG-YES                                           01840009
055900         DISPLAY 'XLKUP012 - 8300-HDRDEL-TPOINST'                 01850009
056000                 ' / XL011-SQLCODE = '                            00930001
056100                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
056200     END-IF                                                       01860009
056300                                                                          
056400     MOVE '8300-HDRDEL-TPOINST'       TO XL011-ERROR-PARAGRAPH.           
056500     MOVE XL011-ORDER-NBR             TO POINST-PO-NBR.                   
056600                                                                          
056700     EXEC SQL                                                             
056800         DELETE                                                           
056900         FROM                                                             
057000             TPOINST                                                      
057100         WHERE                                                            
057200             PO_NBR           = :POINST-PO-NBR                            
057300     END-EXEC.                                                            
057400                                                                          
057500     MOVE SQLCODE                     TO XL011-SQLCODE                    
057600                                                                          
057700     IF XL011-DEBUG-YES                                           01840009
057800         DISPLAY 'XLKUP012 - 8300-HDRDEL-TPOINST'                 01850009
057900                 ' / XL011-SQLCODE = '                            00930001
058000                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
058100         ' / PO-NBR = ' POINST-PO-NBR                                     
058200     END-IF                                                       01860009
058300                                                                          
058400     EVALUATE TRUE                                                        
058500         WHEN SQLCODE = ZERO                                              
058600         WHEN SQLCODE = +100                                              
058700             CONTINUE                                                     
058800       WHEN OTHER                                                         
058900             SET XL011-SQL-ERROR      TO TRUE                             
059000             MOVE 'TPOINST'           TO XL011-DB2-TABLE-NAME(1)          
059100     END-EVALUATE.                                                        
059200                                                                          
059300 8400-SELECT-MAX-TINSTCD.                                                 
059400                                                                          
059500     IF XL011-DEBUG-YES                                           01840009
059600         DISPLAY 'XLKUP012 - 8400-SELECT-MAX-TINSTCD'             01850009
059700                 ' / XL011-SQLCODE = '                            00930001
059800                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
059900     END-IF                                                       01860009
060000                                                                          
060100     MOVE '8400-SELECT-MAX-TINSTCD'   TO XL011-ERROR-PARAGRAPH.           
060200     EXEC SQL                                                             
060300         SELECT MAX(INSTR_NBR)                                            
060400             INTO :INSTCD-INSTR-NBR                                       
060500             FROM TINSTCD                                                 
060600         END-EXEC                                                         
060700                                                                          
060800     MOVE SQLCODE                     TO XL011-SQLCODE                    
060900                                                                          
061000                                                                          
061100     IF XL011-DEBUG-YES                                           01840009
061200         DISPLAY 'XLKUP012 - 8400-SELECT-MAX-TINSTCD'             01850009
061300                 ' / XL011-SQLCODE = '                            00930001
061400                             XL011-SQLCODE                                
012300                 '  XL011-RETURN-CODE='                           00930001
012400                             XL011-RETURN-CODE                            
061500         ' / MAX INSTCD NBR: ' INSTCD-INSTR-NBR                           
061600     END-IF                                                       01860009
061700                                                                          
061800     EVALUATE TRUE                                                        
061900         WHEN SQLCODE = ZERO                                              
062000             CONTINUE                                                     
062100         WHEN OTHER                                                       
062200             SET XL011-SQL-ERROR      TO TRUE                             
062300             MOVE 'TINSTCD'           TO XL011-DB2-TABLE-NAME(1)          
062400     END-EVALUATE.                                                        
062500                                                                          
062600*****************************************************************         
062700 9999-WRAPUP.                                                             
062800                                                                          
062900     IF XL011-DEBUG-YES                                           01840009
063000         DISPLAY 'XLKUP012 - 9999-WRAPUP'                         01850009
063100                 ' / XL011-SQLCODE = '                            00930001
063200                             XL011-SQLCODE                                
                       ' / XL011-RETURN-CODE = ' XL011-RETURN-CODE              
063300     END-IF                                                       01860009
063400                                                                          
063500     MOVE SQLCA                       TO XL011-SQLCA.                     
063600                                                                          
