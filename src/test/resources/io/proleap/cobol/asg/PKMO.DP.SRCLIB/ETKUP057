       IDENTIFICATION DIVISION.                                         00020000
       PROGRAM-ID.      ETKUP057.                                       00040000
       AUTHOR.          JON FIEDLER.                                    00050000
       DATE-WRITTEN.    08/29/2002.                                     00060000
                                                                        00070000
      ******************************************************************00080000
      * PURPOSE: INACTIVATE TEST 816 RELATIONSHIPS.                     00090003
      ******************************************************************00110000
      *      DB2 TABLES: TTRDTRN, TTRDPRT                               00120001
      *      DB2 CURSORS: TPDKEY_CUR                                    00130001
      **********************************************************        00140000
       ENVIRONMENT DIVISION.                                            00148000
                                                                        00149000
       CONFIGURATION SECTION.                                           00150000
       SOURCE-COMPUTER. IBM-3090.                                       00160000
       OBJECT-COMPUTER. IBM-3090.                                       00170000
                                                                        00180000
       INPUT-OUTPUT SECTION.                                            00190000
       FILE-CONTROL.                                                    00200000
                                                                        00210000
           SELECT INPUT-FILE              ASSIGN TO INP01.              00220000
                                                                        00240000
       DATA DIVISION.                                                   00250000
                                                                        00260000
       FILE SECTION.                                                    00270000
                                                                        00280000
       FD  INPUT-FILE                                                   00290000
           RECORDING MODE F                                             00300000
           BLOCK CONTAINS 0 RECORDS                                     00310000
           RECORD CONTAINS 18 CHARACTERS                                00320001
           LABEL RECORDS ARE STANDARD                                   00330000
           DATA RECORD IS INPUT-RECORD.                                 00340000
                                                                        00350000
       01  INPUT-RECORD                        PIC X(18).               00360001
                                                                        00370000
       WORKING-STORAGE SECTION.                                         00380000
                                                                        00390000
       01  INPUT-DTL-LINE.                                              00391001
           05  INPUT-QUALIFIER      PIC X(2)   VALUE SPACES.            00392001
           05  FILLER               PIC X(01)  VALUE SPACES.            00393001
           05  INPUT-PARTNER-ID     PIC X(15)  VALUE SPACES.            00394001
                                                                        00490000
       01  PA-PROGRAM-ACUMM.                                            00530000
           05  PA-ROWS-UPDATED              PIC 9(05) VALUE ZERO.       00540000
           05  PA-RECS-READ                 PIC 9(05) VALUE ZERO.       00550000
                                                                        00560000
       01  PC-PROGRAM-CONTROLS.                                         00570000
           05  PC-PROGRAM-NAME              PIC X(08) VALUE 'ETKUP057'. 00580000
                                                                        00590000
       01  PS-PROGRAM-SWITCHES.                                         00600000
           05  PS-EOF-SW                    PIC X(01)      VALUE 'N'.   00640001
               88  PS-NOT-EOF                              VALUE 'N'.   00650001
               88  PS-EOF                                  VALUE 'Y'.   00660001
           05  PS-ROWS-FOUND-SW             PIC X(01)      VALUE 'N'.   00670000
               88  PS-NO-ROWS-FOUND                        VALUE 'N'.   00680000
               88  PS-ROWS-FOUND                           VALUE 'Y'.   00690000
           05  PS-EMAIL-SW                  PIC X(01)      VALUE 'N'.   00700005
               88  PS-NO-EMAIL                             VALUE 'N'.   00710005
               88  PS-EMAIL                                VALUE 'Y'.   00720005
                                                                        00730000
       01  ABEND-CODE                       PIC S9(04)     VALUE +0     00760000
                                                           COMP SYNC.   00770000
           88  ABEND-4013-DB2-ERROR                        VALUE +4013. 00790000
                                                                        00800000
           EXEC SQL                                                     00840000
              INCLUDE TTRDTRN                                           00850000
           END-EXEC.                                                    00860000
                                                                        00870000
           EXEC SQL                                                     00880000
              INCLUDE TTRDPRT                                           00890000
           END-EXEC.                                                    00900000
                                                                        00910000
           EXEC SQL                                                     00920000
              INCLUDE SQLCA                                             00930000
           END-EXEC.                                                    00940000
                                                                        00950000
           EXEC SQL                                                     00980000
             DECLARE TPDKEY_CUR CURSOR FOR                              00990000
               SELECT TP_DKEY                                           01000000
               FROM TTRDPRT                                             01030000
               WHERE VEND_INCHG_ID_DESC = :INPUT-QUALIFIER              01040001
                     AND VEND_INCHG_ID = :INPUT-PARTNER-ID              01050001
                     AND INACTV_DTE = '9999-09-09'                      01060000
               FOR FETCH ONLY                                           01090000
           END-EXEC.                                                    01100000
                                                                        01110000
           COPY SQLCA2.                                                 01160000
                                                                        01170000
       PROCEDURE DIVISION.                                              01180000
                                                                        01200000
       0000-MAINLINE.                                                   01210000
                                                                        01220000
           OPEN INPUT INPUT-FILE.                                       01260000
                                                                        01270000
           PERFORM 4000-READ-FILE.                                      01280001
                                                                        01400000
           PERFORM 1000-PROCESS-FILE UNTIL PS-EOF.                      01410001
                                                                        01420000
           CLOSE INPUT-FILE.                                            01460000
                                                                        01500000
           IF PS-EMAIL                                                  01510005
              MOVE 4095 TO RETURN-CODE.                                 01511005
                                                                        01512005
      * END OF JOB SUMMARY                                              01520000
           DISPLAY ' '                                                  01521008
           DISPLAY 'INPUT RECS READ    = ' PA-RECS-READ.                01530013
           DISPLAY 'ROWS UPDATED       = ' PA-ROWS-UPDATED.             01540013
                                                                        01550000
           STOP RUN.                                                    01560000
                                                                        01570000
       1000-PROCESS-FILE.                                               01580000
                                                                        01590000
           PERFORM 2000-OPEN-CURSOR.                                    01670001
                                                                        01680000
           PERFORM 2100-FETCH-RECORD.                                   01690014
                                                                        01700000
           IF PS-NO-ROWS-FOUND                                          01710001
              DISPLAY ' '                                               01711015
              DISPLAY 'NO TP_DKEY FOUND FOR VENDOR ID AND QUALIFIER'    01712015
              DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID            01713015
              DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER           01713115
              MOVE 'Y' TO PS-EMAIL-SW                                   01714015
           ELSE                                                         01860001
              PERFORM 3000-INACTIVATE-RELATIONSHIP                      01900001
                  UNTIL PS-NO-ROWS-FOUND                                01910001
           END-IF.                                                      01920001
                                                                        01930001
           PERFORM 2200-CLOSE-CURSOR.                                   01970001
                                                                        02000000
           PERFORM 4000-READ-FILE.                                      02010001
                                                                        02010110
       2000-OPEN-CURSOR.                                                02100001
                                                                        02110000
            EXEC SQL                                                    02120000
              OPEN TPDKEY_CUR                                           02130001
            END-EXEC.                                                   02140000
                                                                        02150000
            EVALUATE TRUE                                               02160000
               WHEN SQLCODE = ZERO                                      02170000
                   CONTINUE                                             02171014
               WHEN OTHER                                               02230000
                   DISPLAY ' '                                          02231017
                   DISPLAY 'ERROR ON OPEN OF TPDKEY_CUR'                02240010
                   DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID       02241016
                   DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER      02242016
                   PERFORM 9999-SQL-ERROR                               02250010
            END-EVALUATE.                                               02260000
                                                                        02270000
       2100-FETCH-RECORD.                                               02280001
                                                                        02290000
            EXEC SQL                                                    02300000
               FETCH TPDKEY_CUR                                         02310001
               INTO :TRDPRT-TP-DKEY                                     02320001
            END-EXEC.                                                   02350000
                                                                        02360000
            EVALUATE TRUE                                               02370000
               WHEN SQLCODE = ZERO                                      02380000
                    MOVE 'Y' TO PS-ROWS-FOUND-SW                        02390000
               WHEN SQLCODE = +100                                      02400000
                    MOVE 'N' TO PS-ROWS-FOUND-SW                        02410000
               WHEN OTHER                                               02460000
                    DISPLAY ' '                                         02461017
                    DISPLAY 'ERROR ON FETCH OF TPDKEY_CUR'              02470001
                    DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID      02471016
                    DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER     02472016
                    PERFORM 9999-SQL-ERROR                              02480000
            END-EVALUATE.                                               02490000
                                                                        02500000
       2200-CLOSE-CURSOR.                                               02510001
                                                                        02520000
            EXEC SQL                                                    02530000
               CLOSE TPDKEY_CUR                                         02540001
            END-EXEC.                                                   02550000
                                                                        02560000
            EVALUATE TRUE                                               02570000
               WHEN SQLCODE = ZERO                                      02580000
                    CONTINUE                                            02590000
               WHEN OTHER                                               02640000
                    DISPLAY ' '                                         02641017
                    DISPLAY 'ERROR ON CLOSE OF TPDKEY_CUR'              02650001
                    DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID      02651016
                    DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER     02652016
                    PERFORM 9999-SQL-ERROR                              02660000
            END-EVALUATE.                                               02670000
                                                                        02680000
       3000-INACTIVATE-RELATIONSHIP.                                    02690001
                                                                        02700000
            EXEC SQL                                                    03080001
              UPDATE TTRDTRN                                            03090001
                SET INACTV_DTE   = CURRENT DATE                         03100003
                   ,LAST_CHG_UID = :PC-PROGRAM-NAME                     03110011
                WHERE TP_DKEY       = :TRDPRT-TP-DKEY                   03140003
                  AND TRAN_SET_CDE  = '816'                             03150003
                  AND PROD_TEST_IND = 'T'                               03151003
                  AND DIR_IND = 'S'                                     03152003
            END-EXEC                                                    03160001
                                                                        03170000
            EVALUATE TRUE                                               03180001
               WHEN SQLCODE = ZERO                                      03190001
                  ADD 1 TO PA-ROWS-UPDATED                              03210001
               WHEN SQLCODE = +100                                      03211004
                  DISPLAY ' '                                           03211105
                  DISPLAY 'UNABLE TO UPDATE TTRDTRN ' PC-PROGRAM-NAME   03211211
                  DISPLAY 'TRADING PARTNER TP_DKEY ' TRDPRT-TP-DKEY     03211307
                  DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID        03211416
                  DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER       03211516
                  MOVE 'Y' TO PS-EMAIL-SW                               03211605
               WHEN OTHER                                               03260001
                  DISPLAY ' '                                           03261017
                  DISPLAY 'ERROR ON UPDATE OF TTRDTRN'                  03270001
                  DISPLAY 'TRADING PARTNER TP_DKEY ' TRDPRT-TP-DKEY     03270117
                  DISPLAY 'TRADING PARTNER ID ' INPUT-PARTNER-ID        03271016
                  DISPLAY 'TRADING PARTNER QUAL ' INPUT-QUALIFIER       03272016
                  PERFORM 9999-SQL-ERROR                                03280001
            END-EVALUATE                                                03290001
                                                                        03300000
            PERFORM 2100-FETCH-RECORD.                                  03330001
                                                                        03340000
       4000-READ-FILE.                                                  03350001
                                                                        03360000
            READ INPUT-FILE                                             03370000
              INTO INPUT-DTL-LINE                                       03380001
              AT END MOVE 'Y' TO PS-EOF-SW.                             03390001
                                                                        03400000
            IF PS-NOT-EOF                                               03401018
              ADD 1 TO PA-RECS-READ.                                    03410018
                                                                        03420000
       9999-SQL-ERROR.                                                  03710000
                                                                        03711009
            MOVE SQLCODE               TO SQLCODE2.                     03720000
            MOVE SQLERRD(3)            TO SQLERRD3.                     03730000
                                                                        03740000
            DISPLAY '** ABEND **       ** = SQLERROR'.                  03750000
            DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.          03760011
            DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 03770000
            DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                 03780000
            DISPLAY '** SQLERRM        ** = ' SQLERRM.                  03790000
            DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                 03800000
                                                                        03810000
            SET ABEND-4013-DB2-ERROR   TO TRUE.                         03860000
            CALL 'ILBOABN0' USING ABEND-CODE.                           03870000
