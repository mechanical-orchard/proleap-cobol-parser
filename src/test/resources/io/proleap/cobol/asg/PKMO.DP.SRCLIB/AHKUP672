000100 IDENTIFICATION DIVISION.                                                 
000200 PROGRAM-ID.         AHKUP672.                                            
000300 AUTHOR.             BUDDY BARNES.                                        
000400 DATE-WRITTEN.       JUN 2011.                                            
000500 DATE-COMPILED.                                                           
000600*************************************************************             
000700*    COBOL 2 WITH SQL                                       *             
000800*                                                           *             
000900*   AHKUP672 - ARCHIVE HISTORY DATA INSERT - TRT_AUD_IMPRT_SEAL *         
001000*                                                           *             
001100*   PROGRAM OVERVIEW:                                       *             
001200*                                                           *             
001300*  THIS PROGRAM INSERTS "OLD" ROWS FROM DB2 TABLE           *             
001300*  TRT_AUD_IMPRT_SEAL.                                      *             
001400*  ROWS INSERTED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED*             
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *             
001600*                                                           *             
001700*  ****   THIS PROGRAM IS JUST TO BE USED FOR TESTING ****  *             
002000*                                                           *             
002100*   INPUT:                                                  *             
002200*                                                           *             
002300*     1. TRT_AUD_IMPRT_SEAL    DCL COPYBOOK TRT00007        *             
002400*                                                           *             
002500*   DB2 TABLES:                                             *             
002600*                                                           *             
002700*        TRT_AUD_IMPRT_SEAL - TR-IMPORT CARTON SEAL INFO    *             
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *             
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *             
003000*                                                           *             
003100*************************************************************             
003402*                                                           *             
003403*************************************************************             
003404 EJECT                                                                    
003500 ENVIRONMENT DIVISION.                                                    
003600 CONFIGURATION SECTION.                                                   
003700 SOURCE-COMPUTER.        IBM-370.                                         
003800 OBJECT-COMPUTER.        IBM-370.                                         
003900                                                                          
004000 INPUT-OUTPUT SECTION.                                                    
004100 FILE-CONTROL.                                                            
004200     SELECT TRT00007-EXTRACT-FILE ASSIGN TO INP01.                        
004300                                                                          
004400 DATA DIVISION.                                                           
004500 FILE SECTION.                                                            
004600 FD  TRT00007-EXTRACT-FILE                                                
004700     RECORDING MODE IS F                                                  
004800     LABEL RECORDS ARE STANDARD                                           
004900     BLOCK CONTAINS 0 RECORDS                                             
005000     RECORD CONTAINS 090 CHARACTERS                                       
005100     DATA RECORD IS TRT00007-EXTRACT-DATA.                                
005300 01  TRT00007-EXTRACT-DATA      PIC X(090).                               
005500                                                                          
005600 EJECT                                                                    
005700 WORKING-STORAGE SECTION.                                                 
005800                                                                          
005900 01  FILLER                       PIC X(58)     VALUE                     
006000     '************WORKING STORAGE STARTS HERE*******************'.        
006100                                                                          
006200 01  PV-PROGRAM-VARIABLES.                                                
006300     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP672'.         
006400     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.              
006500     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.             
006600     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.             
006700                                                                          
006800     05  PV-TRT00007-INPUT-COUNT  PIC 9(09)     VALUE ZERO                
006900                                                COMP-3.                   
007000     05  PV-TRT00007-INSERT-COUNT PIC 9(09)     VALUE ZERO                
007100                                                COMP-3.                   
007200     05  PV-SQL-INSERT-COUNT      PIC 9(09)     VALUE ZERO                
007300                                                COMP-3.                   
007400     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO                
007500                                                COMP-3.                   
007600     05  PV-DISP-CONTNR-ID        PIC X(12)    VALUE SPACES.              
007700     05  PV-DISP-CONTNR-SEQ-NBR   PIC 9(04)    VALUE ZERO.                
007700     05  PV-DISP-SEAL-NBR         PIC X(15)    VALUE SPACES.              
007710     05  PV-LENGTH-TRT00007       PIC 9(09)    VALUE ZERO.                
007800 01  PC-PROGRAM-CONSTANTS.                                                
007900     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3                  
008000                                                COMP SYNC.                
008100     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.              
008200     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.                
008300     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.                
008400                                                                          
008500 01  PS-PROGRAM-SWITCHES.                                                 
008600     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.                
008700         88  COMMITS-TAKEN                      VALUE 'T'.                
008800         88  NO-COMMITS-TAKEN                   VALUE 'N'.                
008900     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.                
009000         88  MORE-EXTRACT                       VALUE 'M'.                
009100         88  END-OF-EXTRACT                     VALUE 'E'.                
009200     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.                
009300         88  NORMAL-RUN                         VALUE '0'.                
009400         88  RESTART-RUN                        VALUE '9'.                
009500                                                                          
009600 01  WS-COUNTER.                                                          
009700     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.             
009800     05  WS-TMST                  PIC X(26)     VALUE SPACES.             
009900                                                                          
010000 01  CKPT-RESTART-INFO.                                                   
010100     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.               
010200                                                                          
010300*----------------------------------------------------------------*        
010400*  ABEND DATA AREAS                                              *        
010500*----------------------------------------------------------------*        
010600 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS                  
010700                                             COMP SYNC.                   
010800     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.                 
010900     88  AC-BAD-DATA                         VALUE +4008.                 
011000     88  AC-DB2-ERROR                        VALUE +4013.                 
011100     88  AC-DATE-ERROR                       VALUE +4019.                 
011200                                                                          
011300                                                                          
011400 01  ABEND-AREAS.                                                         
011500     05  AA-ABEND-LIT            PIC  X(40)  VALUE                        
011600             '*****       ABEND'.                                         
011700     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                        
011800             '*****   PROGRAM: AHKUP672'.                                 
011900     05  AA-PARAGRAPH-LIT.                                                
012000         10  FILLER              PIC  X(17)  VALUE                        
012100             '***** PARAGRAPH: '.                                         
012200         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.                
012300     05  AA-MESSAGE-LINE-1.                                               
012400         10  FILLER              PIC  X(06)  VALUE '*****'.               
012500         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.                
012600     05  AA-MESSAGE-LINE-2.                                               
012700         10  FILLER              PIC  X(06)  VALUE '*****'.               
012800         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.                
012900     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                        
013000             '*****    DB2 ERROR'.                                        
013100     05  AA-DB2-OPERATION-LIT.                                            
013200         10  FILLER              PIC  X(17)  VALUE                        
013300             '***** OPERATION: '.                                         
013400         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.                
013500     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.                
013600     EJECT                                                                
013700                                                                          
013800     COPY DPWS004.                                                        
013900                                                                          
013800     COPY AHRD011.                                                        
013900                                                                          
014200*----------------------------------------------------------------*        
014100*      TRT_AUD_IMPRT_SEAL TABLE LAYOUT                                    
014200*----------------------------------------------------------------*        
014300         EXEC SQL                                                         
014400             INCLUDE TRT00007                                             
014500         END-EXEC.                                                        
014600                                                                          
014700*----------------------------------------------------------------*        
014800*      TCKRSTCNTL TABLE LAYOUT                                            
014900*----------------------------------------------------------------*        
015000         EXEC SQL                                                         
015100             INCLUDE TCKRSTCN                                             
015200         END-EXEC.                                                        
015300                                                                          
015400*----------------------------------------------------------------*        
015500*      TCKRSTINF TABLE LAYOUT                                             
015600*----------------------------------------------------------------*        
015700         EXEC SQL                                                         
015800             INCLUDE TCKRSTIN                                             
015900         END-EXEC.                                                        
016000 EJECT                                                                    
016100*----------------------------------------------------------------*        
016200*  DB2 COMMUNICATION AREA                                                 
016300*----------------------------------------------------------------*        
016400*                                                                         
016500     EXEC SQL                                                             
016600         INCLUDE SQLCA                                                    
016700     END-EXEC.                                                            
016800                                                                          
016900*----------------------------------------------------------------*        
017000*  DB2 COMMUNICATION AREA2                                                
017100*----------------------------------------------------------------*        
017200*                                                                         
017300     COPY SQLCA2.                                                         
017400     EJECT                                                                
017500 PROCEDURE DIVISION.                                                      
017600 A100-MAINLINE-ROUTINE.                                                   
017700                                                                          
017800     PERFORM B100-INITIALIZATION.                                         
017900                                                                          
018000     PERFORM B200-TRT00007-EXTRACT-PROCESS                                
018100       UNTIL END-OF-EXTRACT.                                              
018200                                                                          
018300     PERFORM B300-EOJ-PROCESSING.                                         
018400                                                                          
018500     GOBACK.                                                              
018600 EJECT                                                                    
018700 B100-INITIALIZATION.                                                     
018800                                                                          
018900     EXEC SQL                                                             
019000         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                         
019100     END-EXEC.                                                            
019200                                                                          
019210     COMPUTE PV-LENGTH-TRT00007 = LENGTH OF DCLTRT00007.                  
019220                                                                          
019300     PERFORM X300-GET-CHECKPOINT-CNTL.                                    
019400     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                            
019500                                                                          
019600     OPEN INPUT TRT00007-EXTRACT-FILE.                                    
019700                                                                          
019800     IF RESTART-RUN                                                       
019900         PERFORM X200-CHECKPOINT-RESTART                                  
020000     ELSE                                                                 
020100         PERFORM R100-READ-EXTRACT-FILE                                   
020200     END-IF.                                                              
020300                                                                          
020400     PERFORM X500-SET-CHECKPOINT-TIME.                                    
020500                                                                          
020700     EJECT                                                                
020710                                                                          
020800 B200-TRT00007-EXTRACT-PROCESS.                                           
020900                                                                          
021000     MOVE TRT00007-CONTNR-ID        TO PV-DISP-CONTNR-ID.                 
021100     MOVE TRT00007-CONTNR-SEQ-NBR   TO PV-DISP-CONTNR-SEQ-NBR.            
021100     MOVE TRT00007-SEAL-NBR         TO PV-DISP-SEAL-NBR.                  
021200                                                                          
021300     PERFORM D100-INSERT-TRT00007.                                        
021400                                                                          
021500     PERFORM X100-CHECKPOINT-CHECK.                                       
021600                                                                          
021700     PERFORM R100-READ-EXTRACT-FILE.                                      
021710                                                                          
021800     EJECT                                                                
022000                                                                          
022100 B300-EOJ-PROCESSING.                                                     
022200                                                                          
022300     DISPLAY '** AHKUP672 SUMMARY **'.                                    
022400     DISPLAY '** TRT00007 INPUT COUNT = ' PV-TRT00007-INPUT-COUNT.        
022500     DISPLAY '* TRT00007 INSRT COUNT = ' PV-TRT00007-INSERT-COUNT. .      
022600     DISPLAY '** SQL INSERT COUNT = ' PV-SQL-INSERT-COUNT.                
022700                                                                          
022800     CLOSE  TRT00007-EXTRACT-FILE.                                        
022900                                                                          
023000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.                      
023100     PERFORM X600-UPDATE-TCKRSTCNTL.                                      
023200                                                                          
023300     EJECT                                                                
023400*----------------------------------------------------------------*        
023500*    INSERTS FROM TRT_AUD_IMPRT_SEAL. THERE ARE NO TABLES WITH   *        
023600*    CASCADE INSERT.                                             *        
023800*----------------------------------------------------------------*        
023900 D100-INSERT-TRT00007.                                                    
024000                                                                          
024100     MOVE 'D100-INSERT-TRT00007' TO PV-CURRENT-PARAGRAPH.                 
024200                                                                          
024300     PERFORM WITH TEST AFTER                                              
024400        VARYING PC-RETRY-COUNT FROM 1 BY 1                                
024500          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                             
024600             OR SQLCODE = ZERO                                            
022000                                                                          
022100     EXEC SQL                                                             
022200          INSERT                                                          
022300          INTO  TRT_AUD_IMPRT_SEAL                                        
024700             (                                                            
025200              CONTNR_ID                                                   
025300             ,CONTNR_SEQ_NBR                                              
025400             ,SEAL_NBR                                                    
025700             ,LAST_UPD_TMST                                               
025800             ,LAST_UPD_BY_USR_ID                                          
025500             ,AUD_FUNC_CDE                                                
025600             ,AUD_TMST)                                                   
025400                                                                          
023200          VALUES                                                          
023993             (                                                            
025200              :TRT00007-CONTNR-ID                                         
025300             ,:TRT00007-CONTNR-SEQ-NBR                                    
025400             ,:TRT00007-SEAL-NBR                                          
025700             ,:TRT00007-LAST-UPD-TMST                                     
025800             ,:TRT00007-LAST-UPD-BY-USR-ID                                
025500             ,:TRT00007-AUD-FUNC-CDE                                      
025600             ,:TRT00007-AUD-TMST)                                         
024010     END-EXEC                                                             
025400                                                                          
025500         EVALUATE TRUE                                                    
025600             WHEN SQLCODE = ZERO                                          
025700                 ADD 1 TO PV-TRT00007-INSERT-COUNT                        
025800                 MOVE SQLERRD(3) TO PV-SQLERRD3                           
025900                 ADD PV-SQLERRD3 TO PV-SQL-INSERT-COUNT                   
026000                                                                          
026100             WHEN SQLCODE = -904                                          
026200             WHEN SQLCODE = -913                                          
026500             WHEN SQLCODE = +100                                          
026501                  CONTINUE                                                
026502                                                                          
027900             WHEN SQLWARN0 NOT = SPACES                                   
028000             WHEN SQLCODE  NOT = ZERO                                     
028100                 MOVE PV-CURRENT-PARAGRAPH                                
028200                                     TO AA-PARAGRAPH-NAME                 
028300                 DISPLAY '******** CONTNR ID:'                            
028400                          PV-DISP-CONTNR-ID                               
028500                 DISPLAY '******** CONTNR SEQ NBR:'                       
028600                          PV-DISP-CONTNR-SEQ-NBR                          
028500                 DISPLAY '******** SEAL BBR:'                             
028600                          PV-DISP-SEAL-NBR                                
028700                 MOVE SPACES TO AA-MESSAGE-1                              
028800                                AA-MESSAGE-2                              
028900                 MOVE 'UNSUCCESSFUL INSERT'                               
029000                                     TO AA-DB2-OPERATION                  
029100                 MOVE 'TRT_AUD_IMPRT_SEAL' TO AA-DB2-TABLE                
029200                 PERFORM Z999-DB2-ABEND                                   
029300         END-EVALUATE                                                     
029400     END-PERFORM.                                                         
029500                                                                          
029600     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
029700         MOVE PV-CURRENT-PARAGRAPH                                        
029800                             TO AA-PARAGRAPH-NAME                         
028300         DISPLAY '******** CONTNR ID:'                                    
028400                  PV-DISP-CONTNR-ID                                       
028500         DISPLAY '******** CONTNR SEQ NBR:'                               
028600                  PV-DISP-CONTNR-SEQ-NBR                                  
028500         DISPLAY '******** SEAL NBR:'                                     
028600                  PV-DISP-SEAL-NBR                                        
030300         MOVE SPACES TO AA-MESSAGE-1                                      
030400                        AA-MESSAGE-2                                      
030500         MOVE 'MAX RETRIES EXCEEDED ON INSERT'                            
030600                             TO AA-DB2-OPERATION                          
030700         MOVE 'TRT_AUD_IMPRT_SEAL' TO AA-DB2-TABLE                        
030800         PERFORM Z999-DB2-ABEND                                           
030900     END-IF.                                                              
031000                                                                          
031100                                                                          
031200 R100-READ-EXTRACT-FILE.                                                  
031300                                                                          
031400     READ TRT00007-EXTRACT-FILE INTO AH011-ARCHIVE-RECORD-LAYOUT          
031600          AT END SET END-OF-EXTRACT TO TRUE.                              
031300                                                                          
031300     MOVE  AH011-ARCHIVE-RECORD-LAYOUT TO  DCLTRT00007.                   
031700                                                                          
031800     IF MORE-EXTRACT                                                      
031900         ADD 1 TO PV-TRT00007-INPUT-COUNT                                 
032000     END-IF.                                                              
032200                                                                          
032300     EJECT                                                                
032400*----------------------------------------------------------------*        
032500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *        
032600*----------------------------------------------------------------*        
032700 X100-CHECKPOINT-CHECK.                                                   
032800                                                                          
032900     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.                
033000                                                                          
033100     EXEC SQL                                                             
033200       SET :WS-TMST = CURRENT TIMESTAMP                                   
033300     END-EXEC.                                                            
033400                                                                          
033500     IF SQLCODE = +0                                                      
033600         CONTINUE                                                         
033700     ELSE                                                                 
033800         MOVE PV-CURRENT-PARAGRAPH                                        
033900                             TO AA-PARAGRAPH-NAME                         
034000         MOVE SPACES TO AA-MESSAGE-1                                      
034100                        AA-MESSAGE-2                                      
034200         MOVE 'BAD SET COMMAND'                                           
034300                             TO AA-DB2-OPERATION                          
034400         MOVE SPACES             TO AA-DB2-TABLE                          
034500         PERFORM Z999-DB2-ABEND                                           
034600     END-IF.                                                              
034700                                                                          
034800     IF WS-TMST > WS-HOLD-TMST                                            
034900         IF NO-COMMITS-TAKEN                                              
035000             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE                 
035100             PERFORM X600-UPDATE-TCKRSTCNTL                               
035200             SET COMMITS-TAKEN TO TRUE                                    
035300         END-IF                                                           
035400         PERFORM X700-UPDATE-TCKRSTINF                                    
035500         PERFORM Y100-COMMIT                                              
035600         PERFORM X500-SET-CHECKPOINT-TIME                                 
035700     END-IF.                                                              
035800                                                                          
035900 EJECT                                                                    
036000*----------------------------------------------------------------*        
036100*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *        
036200*----------------------------------------------------------------*        
036300 X200-CHECKPOINT-RESTART.                                                 
036400                                                                          
036500     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.              
036600                                                                          
036700     PERFORM X400-GET-CHECKPOINT-INFO.                                    
036800     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.             
036900                                                                          
037000     DISPLAY '** AHKUP672 CHECKPOINT RESTART **'                          
037100     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '                     
037200              CR-EXTRACT-RECS-WORKED.                                     
037300     DISPLAY '***********************************************'            
037400                                                                          
037500     PERFORM R100-READ-EXTRACT-FILE                                       
037600         CR-EXTRACT-RECS-WORKED TIMES.                                    
037700     PERFORM R100-READ-EXTRACT-FILE.                                      
037800 EJECT                                                                    
037900*----------------------------------------------------------------*        
038000*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *        
038100*----------------------------------------------------------------*        
038200 X300-GET-CHECKPOINT-CNTL.                                                
038300                                                                          
038400     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.             
038500                                                                          
038600     PERFORM WITH TEST AFTER                                              
038700             VARYING PC-RETRY-COUNT FROM 1 BY 1                           
038800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR                     
038900                     SQLCODE = ZERO                                       
039000                                                                          
039100             EXEC SQL                                                     
039200              SELECT CKPT_STAT_CODE                                       
039300               INTO :PV-CKPT-STAT-CODE                                    
039400               FROM TCKRSTCNTL                                            
039500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                         
039600             END-EXEC                                                     
039700                                                                          
039800             EVALUATE TRUE                                                
039900                 WHEN SQLCODE = ZERO                                      
040000                 WHEN SQLCODE = -904                                      
040100                 WHEN SQLCODE = -913                                      
040200                      CONTINUE                                            
040300                                                                          
040400                 WHEN SQLWARN0 NOT = SPACES                               
040500                 WHEN SQLCODE  NOT = ZERO                                 
040600                     MOVE PV-CURRENT-PARAGRAPH                            
040700                                         TO AA-PARAGRAPH-NAME             
040800                     DISPLAY '******** PLAN_NAME:'                        
040900                              PV-PROGRAM-NAME                             
041000                     MOVE SPACES TO AA-MESSAGE-1                          
041100                                    AA-MESSAGE-2                          
041200                     MOVE 'UNSUCCESSFUL SELECT'                           
041300                                         TO AA-DB2-OPERATION              
041400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                  
041500                     PERFORM Z999-DB2-ABEND                               
041600             END-EVALUATE                                                 
041700     END-PERFORM.                                                         
041800                                                                          
041900     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
042000         MOVE PV-CURRENT-PARAGRAPH                                        
042100                             TO AA-PARAGRAPH-NAME                         
042200         DISPLAY '******** PLAN_NAME:'                                    
042300                  PV-PROGRAM-NAME                                         
042400         MOVE SPACES TO AA-MESSAGE-1                                      
042500                        AA-MESSAGE-2                                      
042600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                            
042700                             TO AA-DB2-OPERATION                          
042800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                              
042900         PERFORM Z999-DB2-ABEND                                           
043000     END-IF.                                                              
043100                                                                          
043200 EJECT                                                                    
043300*----------------------------------------------------------------*        
043400*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *        
043500*----------------------------------------------------------------*        
043600 X400-GET-CHECKPOINT-INFO.                                                
043700                                                                          
043800     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.             
043900                                                                          
044000     PERFORM WITH TEST AFTER                                              
044100             VARYING PC-RETRY-COUNT FROM 1 BY 1                           
044200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR                     
044300                     SQLCODE = ZERO                                       
044400                                                                          
044500             EXEC SQL                                                     
044600              SELECT WORK_STRG_DESC                                       
044700               INTO :TCKRSTINF-WORK-STRG-DESC                             
044800               FROM TCKRSTINF                                             
044900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                         
045000             END-EXEC                                                     
045100                                                                          
045200             EVALUATE TRUE                                                
045300                 WHEN SQLCODE = ZERO                                      
045400                 WHEN SQLCODE = -904                                      
045500                 WHEN SQLCODE = -913                                      
045600                      CONTINUE                                            
045700                                                                          
045800                 WHEN SQLWARN0 NOT = SPACES                               
045900                 WHEN SQLCODE  NOT = ZERO                                 
046000                     MOVE PV-CURRENT-PARAGRAPH                            
046100                                         TO AA-PARAGRAPH-NAME             
046200                     DISPLAY '******** PLAN_NAME:'                        
046300                              PV-PROGRAM-NAME                             
046400                     MOVE SPACES TO AA-MESSAGE-1                          
046500                                    AA-MESSAGE-2                          
046600                     MOVE 'UNSUCCESSFUL SELECT'                           
046700                                         TO AA-DB2-OPERATION              
046800                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                  
046900                     PERFORM Z999-DB2-ABEND                               
047000             END-EVALUATE                                                 
047100     END-PERFORM.                                                         
047200                                                                          
047300     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
047400         MOVE PV-CURRENT-PARAGRAPH                                        
047500                             TO AA-PARAGRAPH-NAME                         
047600         DISPLAY '******** PLAN_NAME:'                                    
047700                  PV-PROGRAM-NAME                                         
047800         MOVE SPACES TO AA-MESSAGE-1                                      
047900                        AA-MESSAGE-2                                      
048000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                            
048100                             TO AA-DB2-OPERATION                          
048200         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                              
048300         PERFORM Z999-DB2-ABEND                                           
048400     END-IF.                                                              
048500                                                                          
048600 EJECT                                                                    
048700*----------------------------------------------------------------*        
048800*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *        
048900*----------------------------------------------------------------*        
049000 X500-SET-CHECKPOINT-TIME.                                                
049100                                                                          
049200     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.             
049300                                                                          
049400     PERFORM WITH TEST AFTER                                              
049500             VARYING PC-RETRY-COUNT FROM 1 BY 1                           
049600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR                     
049700                     SQLCODE = ZERO                                       
049800                                                                          
049900             EXEC SQL                                                     
050000              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)        
050100               INTO :WS-HOLD-TMST                                         
050200               FROM TCKRSTCNTL                                            
050300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                         
050400             END-EXEC                                                     
050500                                                                          
050600             EVALUATE TRUE                                                
050700                 WHEN SQLCODE = ZERO                                      
050800                 WHEN SQLCODE = -904                                      
050900                 WHEN SQLCODE = -913                                      
051000                      CONTINUE                                            
051100                                                                          
051200                 WHEN SQLWARN0 NOT = SPACES                               
051300                 WHEN SQLCODE  NOT = ZERO                                 
051400                     MOVE PV-CURRENT-PARAGRAPH                            
051500                                         TO AA-PARAGRAPH-NAME             
051600                     DISPLAY '******** PLAN_NAME:'                        
051700                              PV-PROGRAM-NAME                             
051800                     MOVE SPACES TO AA-MESSAGE-1                          
051900                                    AA-MESSAGE-2                          
052000                     MOVE 'UNSUCCESSFUL SELECT'                           
052100                                         TO AA-DB2-OPERATION              
052200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                  
052300                     PERFORM Z999-DB2-ABEND                               
052400             END-EVALUATE                                                 
052500     END-PERFORM.                                                         
052600                                                                          
052700     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
052800         MOVE PV-CURRENT-PARAGRAPH                                        
052900                             TO AA-PARAGRAPH-NAME                         
053000         DISPLAY '******** PLAN_NAME:'                                    
053100                  PV-PROGRAM-NAME                                         
053200         MOVE SPACES TO AA-MESSAGE-1                                      
053300                        AA-MESSAGE-2                                      
053400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                            
053500                             TO AA-DB2-OPERATION                          
053600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                              
053700         PERFORM Z999-DB2-ABEND                                           
053800     END-IF.                                                              
053900                                                                          
054000 EJECT                                                                    
054100*----------------------------------------------------------------*        
054200*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *        
054300*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *        
054400*----------------------------------------------------------------*        
054500 X600-UPDATE-TCKRSTCNTL.                                                  
054600                                                                          
054700     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.               
054800                                                                          
054900     PERFORM WITH TEST AFTER                                              
055000             VARYING PC-RETRY-COUNT FROM 1 BY 1                           
055100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR                     
055200                     SQLCODE = ZERO                                       
055300                                                                          
055400             EXEC SQL                                                     
055500                 UPDATE TCKRSTCNTL                                        
055600                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE                  
055700                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME                  
055800             END-EXEC                                                     
055900                                                                          
056000             EVALUATE TRUE                                                
056100                 WHEN SQLCODE = ZERO                                      
056200                 WHEN SQLCODE = -904                                      
056300                 WHEN SQLCODE = -913                                      
056400                      CONTINUE                                            
056500                                                                          
056600                 WHEN SQLWARN0 NOT = SPACES                               
056700                 WHEN SQLCODE  NOT = ZERO                                 
056800                     MOVE PV-CURRENT-PARAGRAPH                            
056900                                         TO AA-PARAGRAPH-NAME             
057000                     DISPLAY '******** PLAN_NAME:'                        
057100                              PV-PROGRAM-NAME                             
057200                     MOVE SPACES TO AA-MESSAGE-1                          
057300                                    AA-MESSAGE-2                          
057400                     MOVE 'UNSUCCESSFUL UPDATE'                           
057500                                         TO AA-DB2-OPERATION              
057600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                  
057700                     PERFORM Z999-DB2-ABEND                               
057800             END-EVALUATE                                                 
057900     END-PERFORM.                                                         
058000                                                                          
058100     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
058200         MOVE PV-CURRENT-PARAGRAPH                                        
058300                             TO AA-PARAGRAPH-NAME                         
058400         DISPLAY '******** PLAN_NAME:'                                    
058500                  PV-PROGRAM-NAME                                         
058600         MOVE SPACES TO AA-MESSAGE-1                                      
058700                        AA-MESSAGE-2                                      
058800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                            
058900                             TO AA-DB2-OPERATION                          
059000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                              
059100         PERFORM Z999-DB2-ABEND                                           
059200     END-IF.                                                              
059300                                                                          
059400     EJECT                                                                
059500*----------------------------------------------------------------*        
059600*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *        
059700*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *        
059800*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *        
059900*----------------------------------------------------------------*        
060000 X700-UPDATE-TCKRSTINF.                                                   
060100                                                                          
060200     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.                
060300                                                                          
060400     MOVE PV-TRT00007-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.              
060500     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.           
060600     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.            
060700                                                                          
060800     PERFORM WITH TEST AFTER                                              
060900             VARYING PC-RETRY-COUNT FROM 1 BY 1                           
061000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR                     
061100                     SQLCODE = ZERO                                       
061200                                                                          
061300             EXEC SQL                                                     
061400                 UPDATE TCKRSTINF                                         
061500                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC         
061600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME                  
061700             END-EXEC                                                     
061800                                                                          
061900             EVALUATE TRUE                                                
062000                 WHEN SQLCODE = ZERO                                      
062100                 WHEN SQLCODE = -904                                      
062200                 WHEN SQLCODE = -913                                      
062300                      CONTINUE                                            
062400                                                                          
062500                 WHEN SQLWARN0 NOT = SPACES                               
062600                 WHEN SQLCODE  NOT = ZERO                                 
062700                     MOVE PV-CURRENT-PARAGRAPH                            
062800                                         TO AA-PARAGRAPH-NAME             
062900                     DISPLAY '******** PLAN_NAME:'                        
063000                              PV-PROGRAM-NAME                             
063100                     MOVE SPACES TO AA-MESSAGE-1                          
063200                                    AA-MESSAGE-2                          
063300                     MOVE 'UNSUCCESSFUL UPDATE'                           
063400                                         TO AA-DB2-OPERATION              
063500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                  
063600                     PERFORM Z999-DB2-ABEND                               
063700             END-EVALUATE                                                 
063800     END-PERFORM.                                                         
063900                                                                          
064000     IF PC-RETRY-COUNT > PC-RETRY-MAX                                     
064100         MOVE PV-CURRENT-PARAGRAPH                                        
064200                             TO AA-PARAGRAPH-NAME                         
064300         DISPLAY '******** PLAN_NAME:'                                    
064400                  PV-PROGRAM-NAME                                         
064500         MOVE SPACES TO AA-MESSAGE-1                                      
064600                        AA-MESSAGE-2                                      
064700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                            
064800                             TO AA-DB2-OPERATION                          
064900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                              
065000         PERFORM Z999-DB2-ABEND                                           
065100     END-IF.                                                              
065200                                                                          
065300 EJECT                                                                    
065400                                                                          
065500*----------------------------------------------------------------*        
065600*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *        
065700*----------------------------------------------------------------*        
065800 Y100-COMMIT.                                                             
065900                                                                          
066000     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.                       
066100                                                                          
066200     EXEC SQL                                                             
066300         COMMIT                                                           
066400     END-EXEC.                                                            
066500                                                                          
066600     EVALUATE TRUE                                                        
066700         WHEN SQLCODE = ZEROS                                             
066800             CONTINUE                                                     
066900         WHEN OTHER                                                       
067000             MOVE PV-CURRENT-PARAGRAPH                                    
067100                                 TO AA-PARAGRAPH-NAME                     
067200             MOVE SPACES TO AA-MESSAGE-1                                  
067300                            AA-MESSAGE-2                                  
067400             MOVE 'UNSUCCESSFUL COMMIT'                                   
067500                                 TO AA-DB2-OPERATION                      
067600             MOVE SPACES         TO AA-DB2-TABLE                          
067700             PERFORM Z999-DB2-ABEND                                       
067800     END-EVALUATE.                                                        
067900 EJECT                                                                    
069100                                                                          
069200 Z999-DB2-ABEND.                                                          
069300                                                                          
069400     DISPLAY AA-ABEND-LIT.                                                
069500     DISPLAY AA-DB2-ERROR-LIT.                                            
069600     DISPLAY AA-PROGRAM-LIT.                                              
069700     DISPLAY AA-PARAGRAPH-LIT.                                            
069800     DISPLAY AA-DB2-OPERATION-LIT.                                        
069900     DISPLAY AA-DB2-TABLE.                                                
070000     SET AC-DB2-ERROR TO TRUE.                                            
070100                                                                          
070200     COPY DPPD004.                                                        
070300                                                                          
070400     CALL 'ILBOABN0' USING ABEND-CODE.                                    
