000100 IDENTIFICATION DIVISION.                                         00010011
000200 PROGRAM-ID.     APKUT209.                                        00020011
000300 AUTHOR.         CAROLYN GIFFORD.                                 00030011
000400*DATE-WRITTEN.   NOVEMBER 1999.                                   00040011
000500*DATE-COMPILED.                                                   00050011
000600****************************************************************  00060011
000700*  UPDATE ML FEED FILE DATES                                   *  00070011
000800*                                                              *  00080011
000900*    COBOL 2  WITH SQL                                         *  00090011
001000*                                                              *  00100011
001100*    POPULATE ML015-PURCH-INV-CUT-DTE & ML015-PURCH-DOC-DTE    *  00110011
001200*    IN ML FEED FILE WITH PREVIOUS WEEKS ENDING DATE FOR       *  00120011
001300*    MONTH END. THIS IS NEEDED TO PREVENT TRANSACTIONS         *  00130011
001400*    ENTERED FOR PREVIOUS MONTH FROM BEING REJECTED.           *  00140011
001500*                                                              *  00150011
001600****************************************************************  00160011
001700*                                                              *  00170011
001800*    TAPCNTL - AP BATCH CONTROL TABLE.                         *  00180011
001900*                                                              *  00190011
002000****************************************************************  00200011
002100* CHANGE LOG:                                                  *  00210011
002200*                                                              *  00220011
002300* 11/15/99     INITIAL VERSION.         WR#                    *  00230011
002400*                                                              *  00240011
002500* 02/02/2000 -                                                 *  00250011
002600*  ADDED LOGIC TO CHECK IF THE INV CUT DATE IS EQUAL TO THE    *  00260011
002700*  CURRENT BATCH PROCESS DATE.  IF NOT, WE WILL NOT OVERLAY    *  00270011
002800*  THE INV CUT DATE WITH THE LAST DAY OF THE FISCAL MONTH.     *  00280011
002900*  THIS CHANGE WAS NEEDED BECAUSE, DURING INVENTORY, THERE ARE *  00290011
003000*  ACTUAL CUT-OFF DATES IN THIS FIELD, AND THE ADJUSTMENTS WERE*  00300011
003100*  NOT BEING POSTED CORRECTLY IN MDSE LEDGER IF WE OVERLAID    *  00310011
003200*  THIS DATE WITH THE END OF MONTH DATE.                       *  00320011
003300*        BY: NANCY EILBES                           WR# 20704  *  00330011
003400*                                                              *  00340011
003500* 03/11/2004 -                                                 *  00350015
003600*  MODIFIED THE LOGIC THAT FORMATS THE APCNTL-BTCH-PRC-DTE     *  00360015
003700*  WHEN COMPARING IT TO THE ML015-PURCH-INV-CUT-DTE. THE       *  00370015
003800*  CENTURY IS INCLUDED AND HAS A NEW FORMAT OF CCYYMMDD.       *  00380015
003900*  MLRD015 WAS UPDATED TO INCLUDE LARGER DATE FORMATS. THE     *  00390015
004000*  FILE SIZE WAS INCREASED FROM 80 TO 150 FOR THE INPUT AND    *  00400015
004100*  OUTPUT FILES. THE ML015-PURCH-DOC-DTE NOW INCLUDES THE CCYY *  00410015
004200*  AND IS FORMATED AS CCYYMMDD. (PARAS B100- B200-)            *  00420015
004300*        BY: MIKE BESKE                             WR# 25805  *  00430015
004400*                                                              *  00440015
004500****************************************************************  00450011
004600                                                                  00460011
004700 ENVIRONMENT DIVISION.                                            00470011
004800                                                                  00480011
004900 INPUT-OUTPUT SECTION.                                            00490011
005000 FILE-CONTROL.                                                    00500011
005100                                                                  00510011
005200     SELECT MLFEED-FILE                                           00520011
005300         ASSIGN TO UT-S-INP01.                                    00530011
005400                                                                  00540011
005500     SELECT MLFEED-NEW-FILE                                       00550011
005600         ASSIGN TO UT-S-OUT01.                                    00560011
005700                                                                  00570011
005800 DATA DIVISION.                                                   00580011
005900                                                                  00590011
006000 FILE SECTION.                                                    00600011
006100 FD  MLFEED-FILE                                                  00610011
006200     RECORDING MODE IS F                                          00620011
006300     LABEL RECORDS ARE STANDARD                                   00630011
006400     DATA RECORD IS MLFEED-RECORD.                                00640011
006500 01  MLFEED-RECORD                     PIC X(150).                00650015
006600                                                                  00660011
006700 FD  MLFEED-NEW-FILE                                              00670011
006800     RECORDING MODE IS F                                          00680011
006900     LABEL RECORDS ARE STANDARD                                   00690011
007000     BLOCK CONTAINS 0 RECORDS                                     00700011
007100     DATA RECORD IS MLFEED-NEW-RECORD.                            00710011
007200  1  MLFEED-NEW-RECORD                  PIC X(150).               00720015
007300                                                                  00730011
007400 WORKING-STORAGE SECTION.                                         00740011
007500                                                                  00750011
007600 01  FILLER                        PIC X(25) VALUE                00760011
007700                             'WS FOR APKUT209 BEGINS==>'.         00770011
007800                                                                  00780011
007900****************************************************************  00790011
008000* INPUT & OUTPUT RECORD LAYOUT FOR MERCHANDISE FEED FILE       *  00800011
008100****************************************************************  00810011
008200     COPY MLRD015.                                                00820011
008300                                                                  00830011
008400 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00840011
008500                                             VALUE ZEROS.         00850011
008600     88 AP-DB2-ERROR               VALUE +4013.                   00860011
008700                                                                  00870011
008800 01  PV-ABEND-FILEDS.                                             00880011
008900     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUT209'. 00890011
009000     05  PV-ABEND-SQLCODE             PIC X(4)  VALUE SPACES.     00900011
009100     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00910011
009200     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00920011
009300     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00930011
009400     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     00940011
009500                                                                  00950011
009600 01  PS-PROGRAM-SWITCHES.                                         00960011
009700     05  PS-END-OF-MLFEED-FILE-SW     PIC X(01) VALUE 'N'.        00970011
009800         88  END-OF-MLFEED-FILE                 VALUE 'Y'.        00980011
009900         88  NOT-END-OF-MLFEED-FILE             VALUE 'N'.        00990011
010000                                                                  01000011
010100 01  PV-PROGRAM-VARIABLES.                                        01010011
010200     05  PV-ML-RECORD-COUNT           PIC 9(10) VALUE ZEROES.     01020011
010300     05  PV-ML-UPDATE-COUNT           PIC 9(10) VALUE ZEROES.     01030011
010400     05  PV-ML-NO-UPDATE-COUNT        PIC 9(10) VALUE ZEROES.     01040011
010500                                                                  01050011
010600 01  PV-WORK-AREA.                                                01060011
010700     05  PV-PROGRAM-NAME         PIC X(08)     VALUE 'APKUT209'.  01070011
010800                                                                  01080011
010900 01  PREVIOUS-WEEK-CCYYMMDD           PIC X(10) VALUE SPACES.     01090011
011000 01  PREV-WEEK-END-DATE REDEFINES PREVIOUS-WEEK-CCYYMMDD.         01100011
011100     05  PREV-WEEK-END-DATE-CC        PIC X(02).                  01110011
011200     05  PREV-WEEK-END-DATE-YY        PIC X(02).                  01120011
011300     05  FILLER                       PIC X(01).                  01130011
011400     05  PREV-WEEK-END-DATE-MM        PIC X(02).                  01140011
011500     05  FILLER                       PIC X(01).                  01150011
011600     05  PREV-WEEK-END-DATE-DD        PIC X(02).                  01160011
011700                                                                  01170011
011800 01  WS-BTCH-PRC-DTE.                                             01180011
011900     05  WS-BTCH-PRC-DTE-CC           PIC X(02).                  01190011
012000     05  WS-BTCH-PRC-DTE-YY           PIC X(02).                  01200011
012100     05  FILLER                       PIC X(01).                  01210011
012200     05  WS-BTCH-PRC-DTE-MM           PIC X(02).                  01220011
012300     05  FILLER                       PIC X(01).                  01230011
012400     05  WS-BTCH-PRC-DTE-DD           PIC X(02).                  01240011
012500                                                                  01250011
012600 01  WS-CURR-PRC-DTE.                                             01260011
012700     05  WS-CURR-PRC-CC               PIC X(02) VALUE SPACES.     01270013
012800     05  WS-CURR-PRC-YY               PIC X(02) VALUE SPACES.     01280013
012900     05  WS-CURR-PRC-MM               PIC X(02) VALUE SPACES.     01290013
013000     05  WS-CURR-PRC-DD               PIC X(02) VALUE SPACES.     01300013
013100 01  WS-CURR-PRC-DTE-X REDEFINES WS-CURR-PRC-DTE                  01310013
013200                                      PIC X(08).                  01320014
013300                                                                  01330015
013400 01  RUN-TIME.                                                    01340011
013500     05  R-HR                    PIC 99.                          01350011
013600     05  R-MIN                   PIC 99.                          01360011
013700     05  R-SEC                   PIC 99.                          01370011
013800     05  R-TH                    PIC 99.                          01380011
013900                                                                  01390011
014000 01  DATE-IN.                                                     01400011
014100     05 DATE-IN-YY               PIC XX.                          01410011
014200     05 DATE-IN-MM               PIC XX.                          01420011
014300     05 DATE-IN-DD               PIC XX.                          01430011
014400                                                                  01440011
014500 01  FILLER                      PIC X(35)  VALUE                 01450011
014600     'END OF AP WORK RECORD AREA       **'.                       01460011
014700                                                                  01470011
014800     COPY DPWS004.                                                01480011
014900                                                                  01490011
015000******************************************************************01500011
015100*  COMMUNICATIONS AREA2 FOR DB2                                   01510011
015200******************************************************************01520011
015300     COPY SQLCA2.                                                 01530011
015400                                                                  01540011
015500     EXEC SQL                                                     01550011
015600          INCLUDE SQLCA                                           01560011
015700     END-EXEC.                                                    01570011
015800                                                                  01580011
015900     EXEC SQL                                                     01590011
016000          INCLUDE TAPCNTL                                         01600011
016100     END-EXEC.                                                    01610011
016200                                                                  01620011
016300                                                                  01630011
016400 PROCEDURE DIVISION.                                              01640011
016500                                                                  01650011
016600 A100-MAINLINE.                                                   01660011
016700                                                                  01670011
016800     PERFORM B100-HOUSEKEEPING.                                   01680011
016900                                                                  01690011
017000     PERFORM B200-UPDATE-MLFEED-FILE                              01700011
017100            UNTIL END-OF-MLFEED-FILE.                             01710011
017200                                                                  01720011
017300     PERFORM B300-END-OF-JOB.                                     01730011
017400                                                                  01740011
017500     GOBACK.                                                      01750011
017600                                                                  01760011
017700 B100-HOUSEKEEPING.                                               01770011
017800     OPEN INPUT  MLFEED-FILE                                      01780011
017900          OUTPUT MLFEED-NEW-FILE.                                 01790011
018000                                                                  01800011
018100     ACCEPT RUN-TIME FROM TIME.                                   01810011
018200     ACCEPT DATE-IN  FROM DATE.                                   01820011
018300                                                                  01830011
018400     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    01840011
018500                                                                  01850011
018600     INITIALIZE DCLTAPCNTL.                                       01860011
018700     SET NOT-END-OF-MLFEED-FILE TO TRUE.                          01870011
018800     MOVE ZEROES TO PV-ML-RECORD-COUNT.                           01880011
018900                                                                  01890011
019000     PERFORM R100-READ-MLFEED-FILE.                               01900011
019100                                                                  01910011
019200     IF END-OF-MLFEED-FILE                                        01920011
019300       DISPLAY 'NO MLFEED RECORDS TO PROCESS'                     01930011
019400     ELSE                                                         01940011
019500       PERFORM S100-SELECT-TAPCNTL-ROW                            01950011
019600       MOVE APCNTL-BTCH-PRC-DTE TO WS-BTCH-PRC-DTE                01960011
019700       MOVE WS-BTCH-PRC-DTE-CC   TO WS-CURR-PRC-CC                01970013
019800       MOVE WS-BTCH-PRC-DTE-YY   TO WS-CURR-PRC-YY                01980013
019900       MOVE WS-BTCH-PRC-DTE-MM   TO WS-CURR-PRC-MM                01990011
020000       MOVE WS-BTCH-PRC-DTE-DD   TO WS-CURR-PRC-DD                02000011
020100       IF APCNTL-MULT-PSTG-PER-IND = 'N'                          02010011
020200         SET END-OF-MLFEED-FILE TO TRUE                           02020011
020300         DISPLAY 'THIS IS NOT A MULTI POSTING PERIOD '            02030011
020400       END-IF                                                     02040011
020500     END-IF.                                                      02050011
020600                                                                  02060011
020700 B200-UPDATE-MLFEED-FILE.                                         02070011
020800                                                                  02080011
020900     IF  WS-CURR-PRC-DTE-X = ML015-PURCH-INV-CUT-DTE-X            02090013
021000         MOVE PREV-WEEK-END-DATE-CC  TO ML015-PURCH-INV-DTE-CC    02100013
021100                                        ML015-PURCH-DOC-DTE-CC    02110013
021200         MOVE PREV-WEEK-END-DATE-YY  TO ML015-PURCH-INV-DTE-YY    02120013
021300                                        ML015-PURCH-DOC-DTE-YY    02130013
021400         MOVE PREV-WEEK-END-DATE-MM  TO ML015-PURCH-INV-DTE-MM    02140013
021500                                        ML015-PURCH-DOC-DTE-MM    02150013
021600         MOVE PREV-WEEK-END-DATE-DD  TO ML015-PURCH-INV-DTE-DD    02160013
021700                                        ML015-PURCH-DOC-DTE-DD    02170013
021800         ADD 1 TO PV-ML-UPDATE-COUNT                              02180011
021900     ELSE                                                         02190011
022000         DISPLAY 'INVENTORY CUTOFF DATE NOT OVERLAID '            02200011
022100                  ML015-PURCH-INV-CUT-DTE                         02210011
022200         ADD 1 TO PV-ML-NO-UPDATE-COUNT                           02220011
022300     END-IF.                                                      02230011
022400                                                                  02240011
022500     PERFORM W100-WRITE-MLFEED-NEW-RECORD.                        02250011
022600                                                                  02260011
022700     PERFORM R100-READ-MLFEED-FILE.                               02270011
022800                                                                  02280011
022900 B300-END-OF-JOB.                                                 02290011
023000     CLOSE  MLFEED-FILE                                           02300011
023100            MLFEED-NEW-FILE.                                      02310011
023200                                                                  02320011
023300     DISPLAY ' ML FEED RECORDS READ = ' PV-ML-RECORD-COUNT.       02330011
023400     DISPLAY ' ML FEED RECORDS UPDATED = '                        02340011
023500                                        PV-ML-UPDATE-COUNT.       02350011
023600     DISPLAY ' ML FEED RECORDS NOTUPDATED = '                     02360011
023700                                        PV-ML-NO-UPDATE-COUNT.    02370011
023800                                                                  02380011
023900     DISPLAY '** PROGRAM APKUT209 ENDS NORMALLY **'.              02390011
024000                                                                  02400011
024100****************************************************************  02410011
024200*     READ THE MLFEED TRANSACTION FILE                         *  02420011
024300****************************************************************  02430011
024400 R100-READ-MLFEED-FILE.                                           02440011
024500                                                                  02450011
024600     INITIALIZE ML015-PURCHASE-RECORD.                            02460011
024700                                                                  02470011
024800     READ MLFEED-FILE INTO ML015-PURCHASE-RECORD                  02480011
024900          AT END  SET END-OF-MLFEED-FILE TO TRUE.                 02490011
025000                                                                  02500011
025100     IF END-OF-MLFEED-FILE                                        02510011
025200        CONTINUE                                                  02520011
025300     ELSE                                                         02530011
025400         ADD 1 TO PV-ML-RECORD-COUNT                              02540011
025500     END-IF.                                                      02550011
025600                                                                  02560011
025700 S100-SELECT-TAPCNTL-ROW.                                         02570011
025800                                                                  02580011
025900     EXEC SQL                                                     02590011
026000        SELECT PREV_WK_END_DTE                                    02600011
026100              ,MULT_PSTG_PER_IND                                  02610011
026200              ,BTCH_PRC_DTE                                       02620011
026300         INTO :PREVIOUS-WEEK-CCYYMMDD                             02630011
026400             ,:APCNTL-MULT-PSTG-PER-IND                           02640011
026500             ,:APCNTL-BTCH-PRC-DTE                                02650011
026600        FROM TAPCNTL                                              02660011
026700     END-EXEC.                                                    02670011
026800                                                                  02680011
026900     EVALUATE TRUE                                                02690011
027000         WHEN SQLCODE = ZERO                                      02700011
027100              CONTINUE                                            02710011
027200                                                                  02720011
027300         WHEN SQLWARN0 NOT = SPACES                               02730011
027400         WHEN SQLCODE  NOT = ZERO                                 02740011
027500              MOVE 'S100-SELECT-TAPCNTL-ROW'                      02750011
027600                              TO PV-ABEND-PARAGRAPH               02760011
027700              MOVE 'UNSUCCESSFUL SELECT AP CONTROL TABLE '        02770011
027800                              TO PV-ABEND-OPERATION               02780011
027900              MOVE 'TAPCNTL ' TO PV-ABEND-STRUCTURE-1             02790011
028000              PERFORM Z999-SQL-ERROR                              02800011
028100     END-EVALUATE.                                                02810011
028200                                                                  02820011
028300     EVALUATE TRUE                                                02830011
028400        WHEN SQLCODE = ZEROS                                      02840011
028500             CONTINUE                                             02850011
028600        WHEN OTHER                                                02860011
028700             MOVE 'S100-SELECT-TAPCNTL-ROW       ' TO             02870011
028800                                       PV-ABEND-PARAGRAPH         02880011
028900             MOVE 'UNSUCCESSFUL SELECT AP CONTROL TABLE '         02890011
029000                             TO PV-ABEND-OPERATION                02900011
029100             MOVE 'TAPCNTL ' TO PV-ABEND-STRUCTURE-1              02910011
029200             PERFORM Z999-SQL-ERROR                               02920011
029300     END-EVALUATE.                                                02930011
029400                                                                  02940011
029500 W100-WRITE-MLFEED-NEW-RECORD.                                    02950011
029600                                                                  02960011
029700     WRITE MLFEED-NEW-RECORD FROM ML015-PURCHASE-RECORD.          02970011
029800                                                                  02980011
029900***************************************************************** 02990011
030000*     PROCESS DB2 ABENDS                                          03000011
030100***************************************************************** 03010011
030200 Z999-SQL-ERROR.                                                  03020011
030300     CLOSE  MLFEED-FILE                                           03030011
030400            MLFEED-NEW-FILE.                                      03040011
030500                                                                  03050011
030600     DISPLAY '*** DB2 ERROR '.                                    03060011
030700     DISPLAY '*** SQL CODE = '  PV-ABEND-SQLCODE.                 03070011
030800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 03080011
030900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               03090011
031000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               03100011
031100     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             03110011
031200                                                                  03120011
031300     COPY DPPD004.                                                03130011
031400                                                                  03140011
031500     MOVE +4013                    TO ABEND-CODE.                 03150011
031600                                                                  03160011
031700     CALL 'ILBOABN0' USING ABEND-CODE.                            03170011
