000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.   WSKUP017.                                          00040000
000500 AUTHOR.       JOE LAROSA.                                        00050000
000600 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060000
000700 DATE-WRITTEN. APRIL 2007.                                        00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*       WMOS PIX TRANSACTION REPOSITORY PURGE PROGRAM             00100000
001100*                                                                 00110000
001200* THIS PROGRAM READS A FILE OF THE "PIX" RECORDS FROM THE         00120000
001200* DB2 DOWNLOAD REPOSITORY TABLE (WST_PIX_TRAN_HIST) AND           00121000
001300* DELETES THE CORRESPONDING ROW FROM THE WST_PIX_TRAN_HIST        00130000
001400* TABLE.                                                          00140000
001500*                                                                 00150000
001600* NOTE: PURGE DAYS IS RETRIEVED FROM A PARM TABLE.                00160000
CHGFIX* 04/12/2016-ADDED K_DC_NBR IN THE DELETE STATEMENT.              00161002
CHGFIX*                                      -   COGNIZANT.             00162001
001700******************************************************************00170000
001800 ENVIRONMENT DIVISION.                                            00180000
001900******************************************************************00190000
002000 CONFIGURATION SECTION.                                           00200000
002100 SOURCE-COMPUTER.        IBM-3090.                                00210000
002200 OBJECT-COMPUTER.        IBM-3090.                                00220000
002300                                                                  00230000
002400 INPUT-OUTPUT SECTION.                                            00240000
002410                                                                  00241000
002500 FILE-CONTROL.                                                    00250000
002910                                                                  00251000
002920     SELECT INPUT-FILE ASSIGN TO INP01.                           00251100
002930                                                                  00251200
002520     SELECT OUTPUT-PIX-GDG-FILE                                   00252000
002530         ASSIGN                       TO OUT01.                   00253000
002600******************************************************************00260000
002700 DATA DIVISION.                                                   00270000
002800******************************************************************00280000
002900 FILE SECTION.                                                    00290000
003310                                                                  00290100
003320 FD  INPUT-FILE                                                   00290200
003330     RECORDING MODE F                                             00290300
003340     BLOCK CONTAINS 0 RECORDS                                     00290400
003350     LABEL RECORDS ARE OMITTED.                                   00290500
CHGFIX 01  INPUT-REC                        PIC X(675).                 00290601
002910                                                                  00291000
002920 FD  OUTPUT-PIX-GDG-FILE                                          00292000
002930     RECORDING MODE IS F                                          00293000
002940     LABEL RECORDS ARE STANDARD                                   00294000
002950     RECORD CONTAINS 700 CHARACTERS                               00295000
002960     BLOCK CONTAINS 0 RECORDS.                                    00296000
002970 01  OUTPUT-PIX-GDG-RECORD          PIC  X(700).                  00297000
002980                                                                  00298000
003100 WORKING-STORAGE SECTION.                                         00310000
003200 01  PS-PROGRAM-SWITCHES.                                         00320000
003300     05  PS-INPUT-FILE-EOF-SW        PIC X(01) VALUE 'N'.         00330000
003400         88  PS-INPUT-FILE-EOF-YES             VALUE 'Y'.         00340000
003500         88  PS-INPUT-FILE-EOF-NO              VALUE 'N'.         00350000
003600                                                                  00360000
003700 01  PC-PROGRAM-CONSTANTS.                                        00370000
003800     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'WSKUP017'.  00380000
004000                                                                  00400000
004100 01  PA-PROGRAM-ACCUMULATORS.                                     00410000
005800     05  PA-CNT-PIX-READ             PIC S9(09) COMP-3 VALUE 0.   00411000
006403     05  PA-CNT-TOTAL                PIC S9(09) COMP-3 VALUE 0.   00413000
006404     05  PA-CNT-PIX-ERROR            PIC S9(09) COMP-3 VALUE 0.   00414000
006406     05  PA-CNT-PIX-DELETED          PIC S9(09) COMP-3 VALUE 0.   00416000
004500                                                                  00450000
004600 01  PV-PROGRAM-VARIABLES.                                        00460000
004700     05  PV-DISPLAY-COUNT            PIC Z,ZZZ,ZZ9-.              00470000
007800                                                                  00780000
007900 01  PV-ABEND-VARIABLES.                                          00790000
008000     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.00800000
008200     05  PV-SQLCODE                  PIC S9(9).                   00820000
008300     05  PV-DISPLAY-SQLCODE          PIC -------999.              00830000
008400     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'WSKUP017'.  00840000
008500     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      00850000
008600     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      00860000
008700     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      00870000
008800     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      00880000
008900                                                                  00890000
012500******************************************************************00900000
012600*  INPUT RECORD LAYOUT                                            00910000
012700******************************************************************00920000
012800     COPY WSRD053.                                                00930000
012900                                                                  00940000
009500******************************************************************00950000
009600*  PIX OUTPUT FILE GDG FORMAT                                     00960000
009700******************************************************************00970000
009800     COPY WSRD049.                                                00980000
009900                                                                  00990000
009910******************************************************************00991000
009920*  DB2 FORMATTED MESSAGE AREA                                     00992000
009930******************************************************************00993000
009940     COPY DPWS004.                                                00994000
009950                                                                  00995000
010000******************************************************************01000000
010100*  COMMUNICATIONS AREA FOR DB2                                    01010000
010200******************************************************************01020000
010300     EXEC SQL                                                     01030000
010400         INCLUDE SQLCA                                            01040000
010500     END-EXEC.                                                    01050000
010600                                                                  01060000
010700******************************************************************01070000
010800*  DB2 TABLE DECLARATION - WMOS PIX REPOSITORY TABLE              01080000
010900*      TABLE (WST_PIX_TRAN_HIST)                                  01090000
011000******************************************************************01100000
011100     EXEC SQL                                                     01110000
011200         INCLUDE WST00000                                         01120000
011300     END-EXEC.                                                    01130000
011400                                                                  01140000
015200                                                                  01520000
015300******************************************************************01530000
015400 LINKAGE SECTION.                                                 01540000
015500******************************************************************01550000
015600                                                                  01560000
015700                                                                  01570000
015800/*****************************************************************01580000
015900 PROCEDURE DIVISION.                                              01590000
016000******************************************************************01600000
016100 0000-PROGRAM-MAINLINE.                                           01610000
016200     DISPLAY '************ START OF WSKUP017 ***************'     01620000
016300                                                                  01630000
016400     PERFORM 1000-INITIALIZE.                                     01640000
016500                                                                  01650000
016600*PROCESS PIX TRANSACTIONS.                                        01660000
016700     PERFORM 2000-PROCESS-PIX-RECORDS.                            01670000
016800                                                                  01680000
016900*EOJ ROUTINE.                                                     01690000
017000     PERFORM 9000-EOJ-ROUTINE.                                    01700000
017100                                                                  01710000
017200*STOP                                                             01720000
017300     DISPLAY ' '.                                                 01730000
017400     DISPLAY '************  END OF WSKUP017  ***************'     01740000
017500     STOP RUN.                                                    01750000
017600                                                                  01760000
017700******************************************************************01770000
017800*                                                                *01780000
017900*                I N I T I A L I Z A T I O N                     *01790000
018000*                                                                *01800000
018100******************************************************************01810000
018200 1000-INITIALIZE.                                                 01820000
018300                                                                  01830000
018310     OPEN OUTPUT OUTPUT-PIX-GDG-FILE                              01831100
018310          INPUT  INPUT-FILE.                                      01831200
018320                                                                  01832000
018400*INIT COUNTERS.                                                   01840000
005800     INITIALIZE PA-CNT-PIX-READ                                   01871000
006403                PA-CNT-TOTAL                                      01872000
006404                PA-CNT-PIX-ERROR                                  01873000
006406                PA-CNT-PIX-DELETED.                               01874000
018800                                                                  01880000
027200                                                                  02720000
027300******************************************************************02730000
027400*                                                                *02740000
027500*            P R O C E S S   P I X   R E C O R D S               *02750000
027600*                                                                *02760000
027700******************************************************************02770000
027800 2000-PROCESS-PIX-RECORDS.                                        02780000
028000                                                                  02800000
028100     READ INPUT-FILE INTO WS053-PIX-TRAN-HIST-REC                 02810000
028200        AT END                                                    02820000
028300           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    02830000
028400                                                                  02840000
028500     PERFORM 2100-DELETE-RECORDS                                  02850000
028600         UNTIL PS-INPUT-FILE-EOF-YES.                             02860000
029300                                                                  02930000
032200                                                                  03220000
032300******************************************************************03230000
032400 2100-DELETE-RECORDS.                                             03240000
032500                                                                  03250000
032500     ADD 1 TO PA-CNT-PIX-READ.                                    03260000
032500     ADD 1 TO PA-CNT-TOTAL.                                       03270000
032500                                                                  03280000
032500     PERFORM 3210-DELETE-PIX-REC.                                 03290000
042726                                                                  03300000
042727*COMMIT THE DATA.                                                 03310000
042728     IF PA-CNT-TOTAL = 1000                                       03320000
042729         PERFORM 2800-COMMIT                                      03330000
042732         MOVE 0                    TO PA-CNT-TOTAL                03340000
042733     END-IF.                                                      03350000
038900                                                                  03890000
028100     READ INPUT-FILE INTO WS053-PIX-TRAN-HIST-REC                 03891100
042736        AT END                                                    03892000
042737           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    03893000
042738                                                                  03894000
042739                                                                  03895000
039000******************************************************************03900000
039100 3210-DELETE-PIX-REC.                                             03910000
039200                                                                  03920000
055400     EXEC SQL                                                     03921000
055500         DELETE FROM WST_PIX_TRAN_HIST                            03922000
055600          WHERE TRAN_TYPE     = :WS053-TRAN-TYPE                  03923000
055700            AND TRAN_CODE     = :WS053-TRAN-CODE                  03924000
055700            AND TRAN_NBR      = :WS053-TRAN-NBR                   03924100
055700            AND PIX_SEQ_NBR   = :WS053-PIX-SEQ-NBR                03924200
CHGFIX            AND K_DC_NBR      = :WS053-K-DC-NBR                   03924301
056000     END-EXEC.                                                    03925000
056100                                                                  03926000
056200     EVALUATE TRUE                                                03927000
056300       WHEN SQLCODE = ZERO                                        03928000
056420           ADD 1                  TO PA-CNT-PIX-DELETED           03929100
056500                                                                  03929500
056510       WHEN SQLCODE = +100                                        03929700
056520           CONTINUE                                               03929800
056600       WHEN OTHER                                                 03929900
056610           ADD 1                      TO PA-CNT-PIX-ERROR         03930000
056700           MOVE '3210-DELETE-PIX-REC' TO PV-ABEND-PARAGRAPH       03940000
056800           MOVE 'DELETE WST_PIX_TRAN_HIST'                        03950000
056800                                      TO PV-ABEND-OPERATION       03960000
056900           MOVE DCLWST00000 TO PV-DB2-OPERATION-MESSAGE-1         03970000
057000           PERFORM 9900-DB2-ABEND                                 03980000
057100     END-EVALUATE.                                                03990000
056500                                                                  04000000
042400                                                                  04240000
061200******************************************************************04241000
061300 2800-COMMIT.                                                     04242000
061400                                                                  04243000
061500     EXEC SQL                                                     04244000
061600         COMMIT                                                   04245000
061700     END-EXEC.                                                    04246000
061800                                                                  04247000
061900     EVALUATE TRUE                                                04248000
062000       WHEN SQLCODE = ZERO                                        04249000
042730           MOVE PA-CNT-TOTAL          TO PV-DISPLAY-COUNT         04249100
042731           DISPLAY ' COMMIT COUNT = '    PV-DISPLAY-COUNT         04249200
062200                                                                  04249300
062300       WHEN OTHER                                                 04249400
062400           MOVE '2800-COMMIT'        TO PV-ABEND-PARAGRAPH        04249500
062500           MOVE 'COMMIT LOAD TABLES' TO PV-ABEND-OPERATION        04249600
062600           PERFORM 9900-DB2-ABEND                                 04249700
062700     END-EVALUATE.                                                04249800
062800                                                                  04249900
062900                                                                  04250000
042500******************************************************************04251000
042600*                   E O J   P R O C E S S I N G                  *04260000
042700******************************************************************04270000
042800 9000-EOJ-ROUTINE.                                                04280000
042801                                                                  04280100
042810     CLOSE OUTPUT-PIX-GDG-FILE                                    04282000
042810           INPUT-FILE.                                            04283000
042900                                                                  04290000
043000     DISPLAY ' '.                                                 04300000
043100     DISPLAY '*******************************************'.       04310000
043200     DISPLAY '      * WSKUP017 SUMMARY STATISTICS *      '.       04320000
043300     DISPLAY ' '.                                                 04330000
043400     DISPLAY '      -------------------------------      '.       04340000
043500     DISPLAY '       PIX TRANSACTION PURGE RESULTS       '.       04350000
043600     DISPLAY '      -------------------------------      '.       04360000
043700     MOVE PA-CNT-PIX-READ                TO PV-DISPLAY-COUNT.     04370000
043800     DISPLAY ' PIX TRANSACTIONS READ    = ' PV-DISPLAY-COUNT.     04380000
043900     MOVE PA-CNT-PIX-DELETED             TO PV-DISPLAY-COUNT.     04390000
044000     DISPLAY ' PIX TRANSACTIONS DELETED = ' PV-DISPLAY-COUNT.     04400000
043900     MOVE PA-CNT-PIX-ERROR               TO PV-DISPLAY-COUNT.     04401000
044000     DISPLAY ' PIX TRANSACTION ERRORS   = ' PV-DISPLAY-COUNT.     04402000
044100     DISPLAY '*******************************************'.       04410000
044200                                                                  04420000
044201                                                                  04421000
044300******************************************************************04430000
044400* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      04440000
044500* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 04450000
044600******************************************************************04460000
044700 9900-DB2-ABEND.                                                  04470000
044800                                                                  04480000
044900     MOVE SQLCODE    TO PV-SQLCODE.                               04490000
045000     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       04500000
045100     DISPLAY '*** DB2 ERROR ***'.                                 04510000
045200     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               04520000
045300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 04530000
045400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               04540000
045500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               04550000
045600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       04560000
045700     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             04570000
045800                                                                  04580000
045900******************************************************************04590000
046000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04600000
046100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04610000
046200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04620000
046300* FORMAT.                                                         04630000
046400******************************************************************04640000
046500     COPY DPPD004.                                                04650000
046600                                                                  04660000
046700     IF SQLCODE NOT = -911                                        04670000
046800         EXEC SQL                                                 04680000
046900             ROLLBACK                                             04690000
047000         END-EXEC                                                 04700000
047100     END-IF.                                                      04710000
047200                                                                  04720000
047300     MOVE +4013         TO PV-ABEND-CODE.                         04730000
047400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         04740000
047500******************************************************************04750000
047600******************************************************************04760000
