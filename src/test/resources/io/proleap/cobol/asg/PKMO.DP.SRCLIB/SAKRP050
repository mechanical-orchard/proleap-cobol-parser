000100***************************************************************** 00010003
000200 IDENTIFICATION DIVISION.                                         00020003
000300***************************************************************** 00030003
000400                                                                  00040003
000500 PROGRAM-ID.             SAKRP050.                                00050003
000600 AUTHOR.                 CHRIS CLARK.                             00060003
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070003
000800 DATE-WRITTEN            DEC 2001.                                00080003
000900 DATE-COMPILED.                                                   00090003
001000                                                                  00100003
001100***************************************************************** 00110003
001200* * * *>>>   THIS PROGRAM MUST BE COMPILED COBOL/390   <<<* * * * 00120003
001300***************************************************************** 00130003
001400*                                                                 00140003
001500*  THIS PROGRAM WILL CREATE A DAILY DEBIT CARD CORRECTIONS        00150003
001600*  AUDIT REPORT.                                                  00160003
001700*                                                                 00170003
001800*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00180003
001900*                  PROCESS DATE TO CREATE THE REPORT.             00190003
002000*  OUTPUT: RPT01 - REPORT SHOWING DEBIT CARD CORRECTIONS          00200003
002100*                  BY SALES DATE.                                 00210003
002200*                                                                 00220003
002300***************************************************************** 00230003
002400*                                                                 00240003
002500*  THIS PROGRAM USES THE TEPDKEY TABLE TO JOIN THE TEPTRN,        00250003
002600*  TEPTND, AND TEPCRD TABLES.  THE TEPDKEY TABLE CONTAINS ALL     00260003
002700*  KEY INFORMATION FOR TRANSACTIONS THAT HAVE BEEN PROCESSED FOR  00270003
002800*  A PROCESSING DAY THAT DO NOT HAVE SALES DATES FOR THAT         00280003
002900*  PROCESSING DAY.  THE MOST COMMON EXAMPLE OF THIS IS A SALES    00290003
003000*  CORRECTION.                                                    00300003
003100*                                                                 00310003
003200*  THE REPORT USES DATA FROM THE TEPTND, TEPCRD, AND TEPTRN       00320003
003300*  TABLES.  A DETAIL LINE IS WRITTEN FOR EACH ROW FETCHED.        00330003
003400*  THE REPORT BREAKS ON STORE NUMBER AND ALSO SALES DATE.  WHEN   00340003
003500*  A NEW SALES DATE IS ENCOUNTERED, THE DATE IS PASSED TO THE     00350003
003600*  CALENDAR TO BE CHANGED INTO GREGORIAN FORMAT.                  00360003
003700*                                                                 00370003
003800*  WHEN THE FETCH IS COMPLETE, A TOTAL LINE IS PRINTED AT THE     00380003
003900*  END OF THE REPORT.                                             00390003
004000*                                                                 00400003
004100***************************************************************** 00410003
004200*  CHANGED 09/20/04 BY THOMAS HANSON                              00420003
004300*   WR# 27107  XS DOMAIN CONSTRAINTS PROJECT CHANGES.             00430003
004400*              REMOVED ALL REFERENCES TO THE TSTR000 TABLE.       00440003
004500***************************************************************** 00450003
W37372* DATE: 09-29-2009                       WR37372                  00451061
W37372* WHO: LYNN MCADAMS                                               00452061
W37372* WHY: MASK DEBIT CARD NUMBERS BY ONLY SHOWING THE                00453061
W37372*      LAST FOUR POSITIONS.                                       00454061
004600***************************************************************** 00460003
004600***************************************************************** 00461005
004700 ENVIRONMENT DIVISION.                                            00470003
004800***************************************************************** 00480003
004900                                                                  00490003
005000 CONFIGURATION SECTION.                                           00500003
005100                                                                  00510003
005200 SOURCE-COMPUTER.        IBM-3090.                                00520003
005300                                                                  00530003
005400 OBJECT-COMPUTER.        IBM-3090.                                00540003
005500                                                                  00550003
005600 INPUT-OUTPUT SECTION.                                            00560003
005700                                                                  00570003
005800 FILE-CONTROL.                                                    00580003
005900                                                                  00590003
006000     SELECT POS-DATE-CARD-FILE                                    00600003
006100         ASSIGN TO INP01.                                         00610003
006200                                                                  00620003
006300     SELECT DEBIT-REPORT-FILE                                     00630003
006400         ASSIGN TO RPT01.                                         00640003
006500                                                                  00650003
006700******************************************************************00670003
006800 DATA DIVISION.                                                   00680003
006900******************************************************************00690003
007000                                                                  00700003
007100 FILE SECTION.                                                    00710003
007200                                                                  00720003
007300 FD  POS-DATE-CARD-FILE                                           00730003
007400     RECORDING MODE IS F                                          00740003
007500     BLOCK CONTAINS 0 RECORDS                                     00750003
007600     LABEL RECORDS ARE STANDARD.                                  00760003
007700                                                                  00770003
007800 01  POS-DATE-CARD-RECORD            PIC X(80).                   00780003
007900                                                                  00790003
008000 FD  DEBIT-REPORT-FILE                                            00800003
008100     RECORDING MODE IS F                                          00810003
008200     BLOCK CONTAINS 0  RECORDS.                                   00820003
008300                                                                  00830003
008400 01  DEBIT-REPORT-RECORD          PIC  X(132).                    00840003
008500                                                                  00850003
008700******************************************************************00870003
008800 WORKING-STORAGE SECTION.                                         00880003
008900******************************************************************00890003
009000 01  FILLER                            PIC X(50)  VALUE           00900003
009100     ' *** WORKING STORAGE STARTS HERE FOR SAKRP050 *** '.        00910003
009200                                                                  00920003
009300******************************************************************00930003
009400* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00940003
009500******************************************************************00950003
009600 01  CC-CONTROL-CARD.                                             00960003
009700     05  CC-CONTROL-CARD-DISPLAY.                                 00970003
009800         10  CC-CONTROL-NAME     PIC X(14)    VALUE SPACE.        00980003
009900             88  CC-VALID-CONTROL-NAME        VALUE               00990003
010000                 'P.O.S. DATE = '.                                01000003
010100         10  CC-POS-DATE-MMDDYY  PIC 9(6)     VALUE ZERO.         01010003
010200     05  FILLER                  PIC X(60)    VALUE SPACE.        01020003
010300                                                                  01030003
010400******************************************************************01040003
010500*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01050003
010600******************************************************************01060003
010700     COPY DPWS500.                                                01070003
010800                                                                  01080003
010900 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01090003
011000                                                  COMP SYNC.      01100003
011100     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01110003
011200     88  AC-DB2-ERROR                             VALUE +4013.    01120003
011300     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01130003
011400                                                                  01140003
011500                                                                  01150003
011700 01  PS-PROGRAM-SWITCHES.                                         01170003
011800     05  PS-END-OF-CURSOR-SW           PIC X(01)  VALUE 'N'.      01180003
011900         88  PS-END-OF-CURSOR                     VALUE 'Y'.      01190003
012000     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01200003
012100         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01210003
012200                                                                  01220003
012300 01  PC-CONSTANTS.                                                01230003
012400     05  PC-LINE-LIMIT               PIC S9(04)    VALUE +60.     01240003
012500     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     01250003
012600                                                   COMP SYNC.     01260003
012700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01270003
012800                                                   'SAKRP050'.    01280003
012900     05  PC-REPORT-NBR-1             PIC  9(01)    VALUE 1.       01290003
013000     05  PC-DEBIT-TENDER-TYPE        PIC  X(02)    VALUE '19'.    01300003
013100     05  PC-NEGATIVE-ONE             PIC S9(02)    VALUE -1       01310003
013200                                                   COMP.          01320003
013300     05  PC-SYSTEM-CORRECTION        PIC  X(01)    VALUE 'S'.     01330003
013400     05  PC-REVERSAL-CORRECTION      PIC  X(01)    VALUE 'R'.     01340003
013900                                                                  01390003
014100 01  PV-MISC-COUNT-FIELDS            COMP-3.                      01410003
014200     05  PV-PAGE-CNT                 PIC S9(05)    VALUE ZERO.    01420003
014300     05  PV-LINE-CNT                 PIC S9(03)    VALUE ZERO.    01430003
014400     05  PV-LINE-CNT-AHEAD           PIC S9(03)    VALUE ZERO.    01440003
014500     05  PV-CURSOR-CNT               PIC S9(07)    VALUE ZERO.    01450003
014600                                                                  01460003
014700******************************************************************01470003
014800*  ACCUMULATORS TO HOLD STORE AND COMPANY DOLLAR AMOUNTS.         01480003
014900******************************************************************01490003
015000 01  PA-PROGRAM-ACCUMULATORS.                                     01500003
015100     05  PA-STORE-SALES-AMOUNT       PIC S9(07)V99  VALUE ZERO    01510003
015200                                         COMP-3.                  01520003
015300     05  PA-STORE-RETURN-AMOUNT      PIC S9(07)V99  VALUE ZERO    01530003
015400                                         COMP-3.                  01540003
015500     05  PA-COMPANY-SALES-AMOUNT     PIC S9(07)V99  VALUE ZERO    01550003
015600                                         COMP-3.                  01560003
015700     05  PA-COMPANY-RETURN-AMOUNT    PIC S9(07)V99  VALUE ZERO    01570003
015800                                         COMP-3.                  01580003
015900                                                                  01590003
016000 01  PV-MISC-FIELDS.                                              01600003
016100     05  PV-PRINT-RECORD             PIC X(132)    VALUE SPACE.   01610003
016200     05  PV-LINE-SPACING             PIC S9(04)    VALUE ZERO     01620003
016300                                                   COMP SYNC.     01630003
016400     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01640003
016500     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01650003
016600     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01660003
016700     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01670003
016800     05  PV-EDIT-MASK                PIC  Z,ZZZ,ZZ9.              01680003
016900     05  PV-HOLD-STORE               PIC  S9(04)  COMP VALUE ZERO.01690003
017000     05  PV-HOLD-SALES-DATE          PIC   X(10)  VALUE SPACE.    01700003
017100     05  PV-AMOUNT                   PIC  S9(07)V99 COMP-3        01710003
017200                                          VALUE ZERO.             01720003
017300     05  PV-AMOUNT-FORMATTED         PIC   ZZ,ZZ9.99-.            01730003
017400                                                                  01912026
W37372 01  PV-CARD-NBR.                                                 01914061
W37372     05  PV-CARD-NBR-RJ              PIC X(19) JUST RIGHT.        01914461
019100                                                                  01915027
019200 01  PV-DATE-AND-TIME-FIELDS.                                     01920003
019300     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01930003
019400     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01940003
019500         10  PV-POS-CCYY             PIC X(04).                   01950003
019600         10  FILLER                  PIC X(01).                   01960003
019700         10  PV-POS-MM               PIC X(02).                   01970003
019800         10  FILLER                  PIC X(01).                   01980003
019900         10  PV-POS-DD               PIC X(02).                   01990003
020000     05  PV-CURR-DATE-CCYYMMDD.                                   02000003
020100         10  PV-CURR-DATE-CCYY       PIC  9(04).                  02010003
020200         10  PV-CURR-DATE-MM         PIC  9(02).                  02020003
020300         10  PV-CURR-DATE-DD         PIC  9(02).                  02030003
020400     05  PV-CURR-TIME.                                            02040003
020500         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    02050003
020600         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    02060003
020700         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    02070003
020800     05  PV-POS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02080003
020900     05  PV-SLS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02090003
021100******************************************************************02110003
021200*  TOP OF PAGE HEADING LINE FOR PRINTING A 132 CHARACTER REPORT.  02120003
021300******************************************************************02130003
021400     COPY DPWS132.                                                02140003
021500                                                                  02150003
021600******************************************************************02160003
021700*  HEADING LINES FOR THE DEBIT CORRECTIONS REPORT.                02170003
021800******************************************************************02180003
021900 01  HL2-HEADING-LINE-2.                                          02190003
022000     05  FILLER                      PIC  X(36)    VALUE SPACE.   02200003
022100     05  FILLER                      PIC  X(11)    VALUE          02210003
022200                                          'DEBIT CARD '.          02220003
022300     05  FILLER                      PIC  X(12)    VALUE          02230003
022400                                          'CORRECTIONS '.         02240003
022500     05  FILLER                      PIC  X(10)    VALUE          02250003
022600                                          'AUDIT FOR '.           02260003
022700     05  FILLER                      PIC  X(11)    VALUE          02270003
022800                                          'PROCESSING '.          02280003
022900     05  FILLER                      PIC  X(06)    VALUE          02290003
023000                                          'DATE: '.               02300003
023100     05  HL2-DATE                    PIC  X(10)    VALUE SPACE.   02310003
023200     05  FILLER                      PIC  X(36)    VALUE SPACE.   02320003
023300                                                                  02330003
023400 01  HL3-HEADING-LINE-3.                                          02340003
023500     05  FILLER                      PIC  X(60)    VALUE ALL '-'. 02350003
023600     05  FILLER                      PIC  X(09)    VALUE          02360003
023700                                          ' STORE # '.            02370003
023800     05  HL3-STORE                   PIC  Z999.                   02380003
023900     05  FILLER                      PIC  X(59)    VALUE ALL '-'. 02390003
024000                                                                  02400003
024100 01  HL4-HEADING-LINE-4.                                          02410003
024200     05  FILLER                      PIC  X(50)    VALUE SPACE.   02420003
024300     05  FILLER                      PIC  X(04)    VALUE 'AUTH'.  02430003
024400     05  FILLER                      PIC  X(78)    VALUE SPACE.   02440003
024500                                                                  02450003
024600 01  HL5-HEADING-LINE-5.                                          02460003
024700     05  FILLER                      PIC  X(08)    VALUE SPACE.   02470003
024800     05  FILLER                      PIC  X(10)    VALUE          02480003
024900                                                   'SALES DATE'.  02490003
025000     05  FILLER                      PIC  X(04)    VALUE SPACE.   02500003
025100     05  FILLER                      PIC  X(05)    VALUE 'REG #'. 02510003
025200     05  FILLER                      PIC  X(02)    VALUE SPACE.   02520003
025300     05  FILLER                      PIC  X(07)    VALUE          02530003
025400                                                   'TRANS #'.     02540003
025500     05  FILLER                      PIC  X(02)    VALUE SPACE.   02550003
025600     05  FILLER                      PIC  X(08)    VALUE          02560003
025700                                                   'ASSOC ID'.    02570003
025800     05  FILLER                      PIC  X(02)    VALUE SPACE.   02580003
025900     05  FILLER                      PIC  X(06)    VALUE          02590003
026000                                                   'NUMBER'.      02600003
026100     05  FILLER                      PIC  X(11)    VALUE SPACE.   02610003
026200     05  FILLER                      PIC  X(06)    VALUE          02620003
026300                                                   'ACCT #'.      02630003
026400     05  FILLER                      PIC  X(12)    VALUE SPACE.   02640003
026500     05  FILLER                      PIC  X(04)    VALUE          02650003
026600                                                   'CODE'.        02660003
026700     05  FILLER                      PIC  X(08)    VALUE SPACE.   02670003
026800     05  FILLER                      PIC  X(05)    VALUE          02680003
026900                                                   'SALES'.       02690003
027000     05  FILLER                      PIC  X(06)    VALUE SPACE.   02700003
027100     05  FILLER                      PIC  X(07)    VALUE          02710003
027200                                                   'RETURNS'.     02720003
027300     05  FILLER                      PIC  X(04)    VALUE SPACE.   02730003
027400     05  FILLER                      PIC  X(10)    VALUE          02740003
027500                                                   'NET AMOUNT'.  02750003
027600     05  FILLER                      PIC  X(03)    VALUE SPACE.   02760003
027700                                                                  02770003
027800 01  HL6-HEADING-LINE-6.                                          02780003
027900     05  FILLER                      PIC  X(04)    VALUE SPACE.   02790003
028000     05  FILLER                      PIC  X(08)    VALUE          02800003
028100                                          'STORE # '.             02810003
028200     05  HL6-STORE                   PIC  Z999.                   02820003
028300     05  FILLER                      PIC  X(11)    VALUE          02830003
028400                                          ' TOTAL FOR '.          02840003
028500     05  HL6-DATE                    PIC  X(10)    VALUE SPACE.   02850003
028600     05  FILLER                      PIC  X(54)    VALUE SPACE.   02860003
028700     05  HL6-SALES-TOTAL             PIC  X(10)    VALUE SPACE.   02870003
028800     05  FILLER                      PIC  X(03)    VALUE SPACE.   02880003
028900     05  HL6-RETURN-TOTAL            PIC  X(10)    VALUE SPACE.   02890003
029000     05  FILLER                      PIC  X(04)    VALUE SPACE.   02900003
029100     05  HL6-NET-AMOUNT              PIC  X(10)    VALUE SPACE.   02910003
029200     05  FILLER                      PIC  X(04)    VALUE SPACE.   02920003
029300                                                                  02930003
029400******************************************************************02940003
029500*  DETAIL LINE PRINTED ON THE REPORT.                             02950003
029600******************************************************************02960003
029700 01  DL1-DETAIL-LINE-1.                                           02970003
029800     05  FILLER                      PIC  X(08)    VALUE SPACE.   02980003
029900     05  DL1-SALES-DATE              PIC  X(10)    VALUE SPACE.   02990003
030000     05  FILLER                      PIC  X(04)    VALUE SPACE.   03000003
030100     05  DL1-REGISTER                PIC  9(04)    VALUE ZERO.    03010003
030200     05  FILLER                      PIC  X(04)    VALUE SPACE.   03020003
030300     05  DL1-TRANSACTION             PIC  9(04)    VALUE ZERO.    03030003
030400     05  FILLER                      PIC  X(04)    VALUE SPACE.   03040003
030500     05  DL1-ASSOC-ID                PIC  X(08)    VALUE SPACE.   03050003
030600     05  FILLER                      PIC  X(02)    VALUE SPACE.   03060003
030700     05  DL1-AUTH-NBR                PIC  X(06)    VALUE SPACE.   03070003
030800     05  FILLER                      PIC  X(04)    VALUE SPACE.   03080003
030900     05  DL1-CARD-NBR                PIC  X(19)    VALUE SPACE.   03090039
031000     05  FILLER                      PIC  X(07)    VALUE SPACE.   03100003
031100     05  DL1-CODE                    PIC  X(01)    VALUE SPACE.   03110003
031200     05  FILLER                      PIC  X(06)    VALUE SPACE.   03120003
031300     05  DL1-SALES-AMOUNT            PIC  X(10)    VALUE SPACE.   03130003
031400     05  FILLER                      PIC  X(03)    VALUE SPACE.   03140003
031500     05  DL1-RETURN-AMOUNT           PIC  X(10)    VALUE SPACE.   03150003
031600     05  FILLER                      PIC  X(18)    VALUE SPACE.   03160003
031700                                                                  03170003
031900******************************************************************03190003
032000*  TOTAL LINE PRINTED AT THE END OF THE REPORT                    03200003
032100******************************************************************03210003
032200 01 TL1-TOTAL-LINE-1.                                             03220003
032300    05  FILLER                       PIC X(01) VALUE SPACE.       03230003
032400    05  FILLER                       PIC X(08) VALUE              03240003
032500                                         'COMPANY '.              03250003
032600    05  FILLER                       PIC X(10) VALUE              03260003
032700                                         'TOTAL FOR '.            03270003
032800    05  FILLER                       PIC X(04) VALUE              03280003
032900                                         'ALL '.                  03290003
033000    05  FILLER                       PIC X(12) VALUE              03300003
033100                                         'CORRECTIONS '.          03310003
033200    05  FILLER                       PIC X(11) VALUE              03320003
033300                                         'ENTERED ON '.           03330003
033400    05  TL1-DATE                     PIC X(10) VALUE SPACE.       03340003
033500    05  FILLER                       PIC X(34) VALUE SPACE.       03350003
033600    05  TL1-SALES-AMOUNT             PIC ZZZ,ZZ9.99-.             03360003
033700    05  FILLER                       PIC X(02) VALUE SPACE.       03370003
033800    05  TL1-RETURN-AMOUNT            PIC ZZZ,ZZ9.99-.             03380003
033900    05  FILLER                       PIC X(03) VALUE SPACE.       03390003
034000    05  TL1-NET-AMOUNT               PIC ZZZ,ZZ9.99-.             03400003
034100    05  FILLER                       PIC X(04) VALUE SPACE.       03410003
034200                                                                  03420003
034300******************************************************************03430003
034400*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            03440003
034500******************************************************************03450003
034600     COPY DPWS004.                                                03460003
034800******************************************************************03480003
034900*  DB2 COMMUNICATION AREA.                                        03490003
035000******************************************************************03500003
035100     EXEC SQL                                                     03510003
035200          INCLUDE SQLCA                                           03520003
035300     END-EXEC.                                                    03530003
035500******************************************************************03550003
035600*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           03560003
035700******************************************************************03570003
035800     EXEC SQL                                                     03580003
035900          INCLUDE TEPTRN                                          03590003
036000     END-EXEC.                                                    03600003
036200******************************************************************03620003
036300*  DB2 TABLE TEPPART - PARTITION TABLE                            03630003
036400******************************************************************03640003
036500     EXEC SQL                                                     03650003
036600          INCLUDE TEPPART                                         03660003
036700     END-EXEC.                                                    03670003
036900******************************************************************03690003
037000*  DB2 TABLE TEPTND - TENDER TABLE                                03700003
037100******************************************************************03710003
037200     EXEC SQL                                                     03720003
037300          INCLUDE TEPTND                                          03730003
037400     END-EXEC.                                                    03740003
037600******************************************************************03760003
037700*  DB2 TABLE TEPCRD - CREDIT TENDER TABLE                         03770003
037800******************************************************************03780003
037900     EXEC SQL                                                     03790003
038000          INCLUDE TEPCRD                                          03800003
038100     END-EXEC.                                                    03810003
038300******************************************************************03830003
038400*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                03840003
038500******************************************************************03850003
038600     EXEC SQL                                                     03860003
038700          INCLUDE TEPDKEY                                         03870003
038800     END-EXEC.                                                    03880003
039000******************************************************************03900003
039100*  DB2 TABLE TEPSAT - SALES AUDIT USER ID TABLE                   03910003
039200******************************************************************03920003
039300     EXEC SQL                                                     03930003
039400          INCLUDE TEPSAT                                          03940003
039500     END-EXEC.                                                    03950003
039700******************************************************************03970003
039800*  CURSOR TO RETRIEVE DEBIT CORRECTION DATA                       03980003
039900******************************************************************03990003
040000     EXEC SQL                                                     04000003
040100       DECLARE DEBIT-CURSOR CURSOR FOR                            04010003
040200            SELECT  T.PARTN_NBR                                   04020003
040300                   ,T.STR_NBR                                     04030003
040400                   ,T.RGST_ID                                     04040003
040500                   ,T.TRN_NBR                                     04050003
040600                   ,T.STRT_TM                                     04060003
040700                   ,T.SLS_CORR_SEQ_NBR                            04070003
040800                   ,TRN_STAT_CDE                                  04080003
040900                   ,T.SLS_DTE                                     04090003
041000                   ,ASSOC_ID                                      04100003
041100                   ,TNDR_ID                                       04110003
041200                   ,TNDR_AMT                                      04120003
041300                   ,TNDR_ID_LEN_NBR                               04130003
041400                   ,AUTH_NBR                                      04140003
041500            FROM    TEPDKEY D                                     04150003
041600                   ,TEPTRN T                                      04160003
041700                   ,TEPTND N                                      04170003
041800                   ,TEPCRD C                                      04180003
041900                   ,TEPPART A                                     04190003
042000            WHERE   D.PRCG_DTE         = :EPDKEY-PRCG-DTE         04200003
042100              AND   D.SLS_DTE          = A.SLS_DTE                04210003
042200              AND   A.PARTN_NBR        = T.PARTN_NBR              04220003
042300              AND   D.STR_NBR          = T.STR_NBR                04230003
042400              AND   D.RGST_ID          = T.RGST_ID                04240003
042500              AND   D.TRN_NBR          = T.TRN_NBR                04250003
042600              AND   D.STRT_TM          = T.STRT_TM                04260003
042700              AND   D.SLS_CORR_SEQ_NBR = T.SLS_CORR_SEQ_NBR       04270003
042800              AND   T.PARTN_NBR        = N.PARTN_NBR              04280003
042900              AND   T.STR_NBR          = N.STR_NBR                04290003
043000              AND   T.RGST_ID          = N.RGST_ID                04300003
043100              AND   T.TRN_NBR          = N.TRN_NBR                04310003
043200              AND   T.STRT_TM          = N.STRT_TM                04320003
043300              AND   T.SLS_CORR_SEQ_NBR = N.SLS_CORR_SEQ_NBR       04330003
043400              AND   N.PARTN_NBR        = C.PARTN_NBR              04340003
043500              AND   N.STR_NBR          = C.STR_NBR                04350003
043600              AND   N.RGST_ID          = C.RGST_ID                04360003
043700              AND   N.TRN_NBR          = C.TRN_NBR                04370003
043800              AND   N.STRT_TM          = C.STRT_TM                04380003
043900              AND   N.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR       04390003
044000              AND   N.TNDR_SEQ_NBR     = C.TNDR_SEQ_NBR           04400003
044100              AND   D.SLS_CORR_SEQ_NBR <> 0                       04410003
044200              AND   VOID_ABRT_CDE      = 'N'                      04420003
044300              AND   TRN_STAT_CDE       IN ('V', 'R', 'L', 'Z')    04430003
044400              AND   TNDR_TYP_CDE       IN (:PC-DEBIT-TENDER-TYPE) 04440003
044500              AND   TNDR_VOID_IND      = 'N'                      04450003
044600           ORDER BY T.STR_NBR                                     04460003
044700                   ,T.SLS_DTE                                     04470003
044800                   ,T.RGST_ID                                     04480003
044900                   ,T.TRN_NBR                                     04490003
045000           WITH UR                                                04500003
045100     END-EXEC.                                                    04510003
045200                                                                  04520003
045300***************************************************************** 04530003
045400* PROCEDURE DIVISION.                                           * 04540003
045500***************************************************************** 04550003
045600 PROCEDURE DIVISION.                                              04560003
045700                                                                  04570003
045800******************************************************************04580003
045900* 0000-MAINLINE-PARAGRAPH                                         04590003
046000*      PRODUCE DEBIT CORRECTIONS REPORT                           04600003
046100******************************************************************04610003
046200 0000-MAINLINE-PARAGRAPH.                                         04620003
046300                                                                  04630003
046400     PERFORM 1000-INITIALIZE-PROGRAM.                             04640003
046500                                                                  04650003
046600     PERFORM 2000-PRODUCE-REPORT-LINES                            04660003
046700         UNTIL PS-END-OF-CURSOR.                                  04670003
046800                                                                  04680003
046900     IF PV-CURSOR-CNT           GREATER THAN ZERO                 04690003
047000         PERFORM 5200-PRINT-STORE-TOTAL-LINE                      04700003
047100     END-IF.                                                      04710003
047200                                                                  04720003
047300     PERFORM 4000-PRINT-REPORT-TOTALS.                            04730003
047400                                                                  04740003
047500     DISPLAY '****************************************'           04750003
047600     DISPLAY '*************** SAKRP050 ***************'           04760003
047700     DISPLAY '****************************************'           04770003
047800     MOVE PV-CURSOR-CNT          TO PV-EDIT-MASK                  04780003
047900     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04790003
048000     DISPLAY 'CORRECTION ROWS FETCHED........'                    04800003
048100         PV-EDIT-MASK                                             04810003
048200     DISPLAY '****************************************'           04820003
048300     DISPLAY '****************************************'           04830003
048400     DISPLAY '****************************************'           04840003
048500                                                                  04850003
048600     STOP RUN.                                                    04860003
048700                                                                  04870003
048900                                                                  04890003
049000******************************************************************04900003
049100* 1000-INITIALIZE-PROGRAM                                         04910003
049200*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   04920003
049300*     OPEN DEBIT-CUROSR, ATTEMPT FIRST FETCH OF CURSOR            04930003
049400******************************************************************04940003
049500 1000-INITIALIZE-PROGRAM.                                         04950003
049600                                                                  04960003
049700     OPEN INPUT  POS-DATE-CARD-FILE                               04970003
049800          OUTPUT DEBIT-REPORT-FILE.                               04980003
049900                                                                  04990003
050000     PERFORM 1100-PROCESS-CONTROL-CARD.                           05000003
050100                                                                  05010003
050200     PERFORM 1200-FORMAT-HEADINGS.                                05020003
050300                                                                  05030003
050400     PERFORM 1300-PREPARE-FOR-REPORT.                             05040003
050500                                                                  05050003
050600******************************************************************05060003
050700* 1100-PROCESS-CONTROL-CARD                                       05070003
050800*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   05080003
050900*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  05090003
051000******************************************************************05100003
051100 1100-PROCESS-CONTROL-CARD.                                       05110003
051200                                                                  05120003
051300     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        05130003
051400     CLOSE POS-DATE-CARD-FILE.                                    05140003
051500     IF PS-END-OF-CARD-FILE                                       05150003
051600         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   05160003
051700         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  05170003
051800         SET AC-CONTROL-CARD-ERROR TO TRUE                        05180003
051900         PERFORM 9999-ABEND                                       05190003
052000     END-IF.                                                      05200003
052100     DISPLAY PC-CURRENT-PROGRAM-NAME                              05210003
052200             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  05220003
052300     PERFORM 1115-CONVERT-INPUT-DATE.                             05230003
052500                                                                  05250003
052600******************************************************************05260003
052700* 1110-READ-POS-DATE-CARD-FILE                                    05270003
052800*     READ DATE CONTROL CARD.                                     05280003
052900******************************************************************05290003
053000 1110-READ-POS-DATE-CARD-FILE.                                    05300003
053100     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 05310003
053200        AT END                                                    05320003
053300           SET PS-END-OF-CARD-FILE TO TRUE.                       05330003
053400                                                                  05340003
053500******************************************************************05350003
053600* 1115-CONVERT-INPUT-DATE                                         05360003
053700*     CALL KOHLS CALENDAR ROUTINE:                                05370003
053800*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            05380003
053900*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 05390003
054000******************************************************************05400003
054100                                                                  05410003
054200 1115-CONVERT-INPUT-DATE.                                         05420003
054300                                                                  05430003
054400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05440003
054500                                                                  05450003
054600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05460003
054700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05470003
054800     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05480003
054900     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05490003
055000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05500003
055100                                             DPG54 DPG55 DPG56.   05510003
055200     EVALUATE TRUE                                                05520003
055300         WHEN DPG54-SEVERE-ERROR                                  05530003
055400         WHEN DPG54-DATE-INVALID                                  05540003
055500             MOVE '1115-CONVERT-INPUT-DATE'                       05550003
055600                                   TO PV-PARAGRAPH-NAME           05560003
055700             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05570003
055800                                   TO PV-OPERATION-MSG-1          05580003
055900             SET AC-CALENDAR-ROUTINE-ERROR                        05590003
056000                                   TO TRUE                        05600003
056100             MOVE DPG54-ERROR-MESSAGE                             05610003
056200                                   TO PV-OPERATION-MSG-2          05620003
056300             PERFORM 9999-ABEND                                   05630003
056400     END-EVALUATE.                                                05640003
056500                                                                  05650003
056600     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD           05660003
056700                                      EPDKEY-PRCG-DTE.            05670003
056800     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-POS-DATE-FORMATTED.      05680003
057000                                                                  05700003
057100******************************************************************05710003
057200* 1200-FORMAT-HEADINGS                                            05720003
057300*     GET CURRENT DATE AND TIME FROM SYSTEM.                      05730003
057400*     FORMAT REPORT FIELDS IN THE TOP PAGE HEADING LINE.          05740003
057500*     FORMAT HEADING LINE 2 WITH CONVERTED POS DATE.              05750003
057600******************************************************************05760003
057700 1200-FORMAT-HEADINGS.                                            05770003
057800                                                                  05780003
057900     MOVE FUNCTION CURRENT-DATE (1:8)                             05790003
058000                                   TO PV-CURR-DATE-CCYYMMDD.      05800003
058100     ACCEPT PV-CURR-TIME FROM TIME.                               05810003
058200                                                                  05820003
058300     MOVE PV-CURR-DATE-MM          TO DP132-RUN-MONTH.            05830003
058400     MOVE PV-CURR-DATE-DD          TO DP132-RUN-DAY.              05840003
058500     MOVE PV-CURR-DATE-CCYY        TO DP132-RUN-YEAR.             05850003
058600                                                                  05860003
058700     MOVE PV-CURR-TIME-HH          TO DP132-RUN-HOUR.             05870003
058800     MOVE PV-CURR-TIME-MM          TO DP132-RUN-MINUTE.           05880003
058900     MOVE PC-CURRENT-PROGRAM-NAME  TO DP132-PROGRAM-NAME.         05890003
059000     MOVE PC-REPORT-NBR-1          TO DP132-REPORT-NUMBER.        05900003
059100                                                                  05910003
059200     MOVE PV-POS-DATE-FORMATTED    TO HL2-DATE.                   05920003
059400                                                                  05940003
059500******************************************************************05950003
059600* 1300-PREPARE FOR REPORT                                         05960003
059700*     - OPEN THE CURSOR                                           05970003
059800*     - FETCH FIRST RECORD                                        05980003
059900*     - IF RECORD                                                 05990003
060000******************************************************************06000003
060100 1300-PREPARE-FOR-REPORT.                                         06010003
060200                                                                  06020003
060300     PERFORM 8000-PRINT-HEADINGS.                                 06030003
060400     PERFORM 2100-OPEN-DEBIT-CURSOR.                              06040003
060500     PERFORM 2200-FETCH-DEBIT-CURSOR.                             06050003
060600     IF PS-END-OF-CURSOR                                          06060003
060700         DISPLAY '*** NO DATA PRESENT FOR DEBIT CORR ***'         06070003
060800                 '*** ON SALES DATE '                             06080003
060900                 PV-POS-DATE-FORMATTED                            06090003
061000     ELSE                                                         06100003
061100         PERFORM 2500-PROCESS-FIRST-RECORD                        06110003
061200     END-IF.                                                      06120003
061300                                                                  06130003
061400******************************************************************06140003
061500* 2000-PRODUCE-REPORT-LINES                                       06150003
061600*  PRODUCE THE ACTUAL REPORT LINES                                06160003
061700******************************************************************06170003
061800 2000-PRODUCE-REPORT-LINES.                                       06180003
061900                                                                  06190003
062000     IF EPTRN-STR-NBR              = PV-HOLD-STORE                06200003
062100         CONTINUE                                                 06210003
062200     ELSE                                                         06220003
062300         PERFORM 3000-STORE-BREAK                                 06230003
062400     END-IF.                                                      06240003
062500                                                                  06250003
062600     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           06260003
062700         CONTINUE                                                 06270003
062800     ELSE                                                         06280003
062900         PERFORM 3500-SALES-DATE-BREAK                            06290003
063000     END-IF.                                                      06300003
063100                                                                  06310003
063200     PERFORM 5000-PRINT-DETAIL-LINE.                              06320003
063300     PERFORM 2200-FETCH-DEBIT-CURSOR.                             06330003
063400                                                                  06340003
063500******************************************************************06350003
063600* 2100-OPEN-DEBIT-CURSOR.                                         06360003
063700*     OPEN DEBIT CURSOR                                           06370003
063800******************************************************************06380003
063900 2100-OPEN-DEBIT-CURSOR.                                          06390003
064000                                                                  06400003
064100     EXEC SQL                                                     06410003
064200          OPEN DEBIT-CURSOR                                       06420003
064300     END-EXEC.                                                    06430003
064400                                                                  06440003
064500     EVALUATE TRUE                                                06450003
064600         WHEN SQLCODE = ZERO                                      06460003
064700              CONTINUE                                            06470003
064800         WHEN SQLWARN0 NOT EQUAL SPACE                            06480003
064900         WHEN SQLCODE NOT EQUAL ZERO                              06490003
065000             MOVE '2100-OPEN DEBIT CURSOR'                        06500003
065100                                   TO PV-PARAGRAPH-NAME           06510003
065200             MOVE 'ERROR ON OPEN OF DEBIT-CURSOR'                 06520003
065300                                   TO PV-DB2-OPERATION            06530003
065400             PERFORM 9100-SQL-ABEND                               06540003
065500     END-EVALUATE.                                                06550003
065700                                                                  06570003
065800******************************************************************06580003
065900* 2200-FETCH-SUMMARY-CURSOR                                       06590003
066000*   -FETCH ROWS THAT QUALIFY FOR THE REPORT                       06600003
066100******************************************************************06610003
066200 2200-FETCH-DEBIT-CURSOR.                                         06620003
066300                                                                  06630003
066400     EXEC SQL                                                     06640003
066500          FETCH DEBIT-CURSOR                                      06650003
066600           INTO :EPTRN-PARTN-NBR                                  06660003
066700               ,:EPTRN-STR-NBR                                    06670003
066800               ,:EPTRN-RGST-ID                                    06680003
066900               ,:EPTRN-TRN-NBR                                    06690003
067000               ,:EPTRN-STRT-TM                                    06700003
067100               ,:EPTRN-SLS-CORR-SEQ-NBR                           06710003
067200               ,:EPTRN-TRN-STAT-CDE                               06720003
067300               ,:EPTRN-SLS-DTE                                    06730003
067400               ,:EPTRN-ASSOC-ID                                   06740003
067500               ,:EPTND-TNDR-ID                                    06750003
067600               ,:EPTND-TNDR-AMT                                   06760003
067700               ,:EPTND-TNDR-ID-LEN-NBR                            06770003
067800               ,:EPCRD-AUTH-NBR                                   06780003
067900     END-EXEC.                                                    06790003
068000                                                                  06800003
068100     EVALUATE TRUE                                                06810003
068200         WHEN SQLCODE = ZERO                                      06820003
068300             ADD 1                 TO PV-CURSOR-CNT               06830003
068400         WHEN SQLCODE = PC-ROW-NOT-FOUND                          06840003
068500             SET PS-END-OF-CURSOR  TO TRUE                        06850003
068600         WHEN SQLWARN0 NOT EQUAL SPACE                            06860003
068700         WHEN SQLCODE NOT EQUAL ZERO                              06870003
068800             MOVE '2200-FETCH-DEBIT-CURSOR'                       06880003
068900                                   TO PV-PARAGRAPH-NAME           06890003
069000             MOVE 'ERROR ON FETCH OF SETTLEMENT-CURSOR'           06900003
069100                                   TO PV-DB2-OPERATION            06910003
069200             PERFORM 9100-SQL-ABEND                               06920003
069300     END-EVALUATE.                                                06930003
069500                                                                  06950003
069600******************************************************************06960003
069700* 2300-CLOSE-DEBIT-CURSOR                                         06970003
069800*   -CLOSE THE CURSOR                                             06980003
069900******************************************************************06990003
070000 2300-CLOSE-DEBIT-CURSOR.                                         07000003
070100                                                                  07010003
070200     EXEC SQL                                                     07020003
070300          CLOSE DEBIT-CURSOR                                      07030003
070400     END-EXEC.                                                    07040003
070500                                                                  07050003
070600     EVALUATE TRUE                                                07060003
070700         WHEN SQLCODE = ZERO                                      07070003
070800              CONTINUE                                            07080003
070900         WHEN SQLWARN0 NOT EQUAL SPACE                            07090003
071000         WHEN SQLCODE NOT EQUAL ZERO                              07100003
071100             MOVE '2300-CLOSE-DEBIT-CURSOR'                       07110003
071200                                   TO PV-PARAGRAPH-NAME           07120003
071300             MOVE 'ERROR ON CLOSE OF DEBIT-CURSOR'                07130003
071400                                   TO PV-DB2-OPERATION            07140003
071500             PERFORM 9100-SQL-ABEND                               07150003
071600     END-EVALUATE.                                                07160003
071800                                                                  07180003
071900******************************************************************07190003
072000*  FIRST RECORD PROCESSING.  WRITE THE HEADER RECORDS AND MOVE    07200003
072100*  THE DATA INTO THE APPROPRIATE FIELDS.                          07210003
072200******************************************************************07220003
072300 2500-PROCESS-FIRST-RECORD.                                       07230003
072400                                                                  07240003
072500     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07250003
072600     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         07260003
072700     PERFORM 5100-PRINT-STORE-LINE.                               07270003
072800     PERFORM 3510-FORMAT-SALES-DATE.                              07280003
072900                                                                  07290003
073000******************************************************************07300003
073100*  PRINT THE STORE TOTAL WHEN A BREAK ON THE STORE NUMBER OCCURS  07310003
073200******************************************************************07320003
073300 3000-STORE-BREAK.                                                07330003
073400                                                                  07340003
073500     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         07350003
073600     PERFORM 5100-PRINT-STORE-LINE.                               07360003
073700                                                                  07370003
073800*** THE SALES DATE SHOULD ALWAYS BE PRINTED UNDER THE NEW STORE   07380003
073900*** INFORMATION.  THIS CHECKS TO SEE IF WE HAVE A DIFFERENT SALES 07390003
074000*** DATE WITH THE NEW STORE.                                      07400003
074100                                                                  07410003
074200     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           07420003
074300         CONTINUE                                                 07430003
074400     ELSE                                                         07440003
074500         MOVE EPTRN-SLS-DTE        TO PV-HOLD-SALES-DATE          07450003
074600         PERFORM 3510-FORMAT-SALES-DATE                           07460003
074700     END-IF.                                                      07470003
074800                                                                  07480003
074900     MOVE ZERO TO                  PA-STORE-SALES-AMOUNT          07490003
075000                                   PA-STORE-RETURN-AMOUNT.        07500003
075100     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07510003
075200                                                                  07520003
075300***************************************************************** 07530003
075400*  PRINT THE REQUIRED DATA ON A BREAK IN SALES DATE               07540003
075500***************************************************************** 07550003
075600 3500-SALES-DATE-BREAK.                                           07560003
075700                                                                  07570003
075800     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         07580003
075900     MOVE ZERO                     TO PA-STORE-SALES-AMOUNT       07590003
076000                                      PA-STORE-RETURN-AMOUNT.     07600003
076100     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         07610003
076200     PERFORM 3510-FORMAT-SALES-DATE.                              07620003
076300                                                                  07630003
076400****************************************************************  07640003
076500*  CALL CALENDAR ROUTINE TO CONVERT THE SALES DATE FROM DB2       07650003
076600*  FORMAT INTO GREGORIAN FORMATTED FORMAT                         07660003
076700****************************************************************  07670003
076800 3510-FORMAT-SALES-DATE.                                          07680003
076900                                                                  07690003
077000     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              07700003
077100                                                                  07710003
077200     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   07720003
077300     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   07730003
077400     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   07740003
077500     MOVE EPTRN-SLS-DTE                TO DPG52-LK-DATE-INPUT.    07750003
077600     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    07760003
077700                                             DPG54 DPG55 DPG56.   07770003
077800     EVALUATE TRUE                                                07780003
077900         WHEN DPG54-SEVERE-ERROR                                  07790003
078000         WHEN DPG54-DATE-INVALID                                  07800003
078100             MOVE '3510-FORMAT-SALES-DATEE'                       07810003
078200                                   TO PV-PARAGRAPH-NAME           07820003
078300             MOVE 'ERROR CONVERTING SALES DATE'                   07830003
078400                                   TO PV-OPERATION-MSG-1          07840003
078500             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                07850003
078600             MOVE DPG54-ERROR-MESSAGE                             07860003
078700                                   TO PV-OPERATION-MSG-2          07870003
078800             PERFORM 9999-ABEND                                   07880003
078900     END-EVALUATE.                                                07890003
079000     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-SLS-DATE-FORMATTED.      07900003
079100                                                                  07910003
079200******************************************************************07920003
079300* 4000-PRINT-REPORT-TOTALS                                        07930003
079400*     PRINT REPORT TOTALS (IF DATA WAS PRESENT & REPORT CREATED), 07940003
079500*     CLOSE REPORT FILE.                                          07950003
079600******************************************************************07960003
079700 4000-PRINT-REPORT-TOTALS.                                        07970003
079800                                                                  07980003
079900     PERFORM 2300-CLOSE-DEBIT-CURSOR.                             07990003
080000     MOVE PV-POS-DATE-FORMATTED    TO TL1-DATE.                   08000003
080100     MOVE PA-COMPANY-SALES-AMOUNT                                 08010003
080200                                   TO TL1-SALES-AMOUNT.           08020003
080300     MOVE PA-COMPANY-RETURN-AMOUNT                                08030003
080400                                   TO TL1-RETURN-AMOUNT.          08040003
080500     COMPUTE PV-AMOUNT             = PA-COMPANY-RETURN-AMOUNT     08050003
080600                                   + PA-COMPANY-SALES-AMOUNT.     08060003
080700     MOVE PV-AMOUNT                TO TL1-NET-AMOUNT.             08070003
080800     MOVE +4                       TO PV-LINE-SPACING.            08080003
080900     MOVE TL1-TOTAL-LINE-1         TO PV-PRINT-RECORD.            08090003
081000     PERFORM 8200-WRITE-REPORT-LINE.                              08100003
081100     CLOSE DEBIT-REPORT-FILE.                                     08110003
081300                                                                  08130003
081400******************************************************************08140003
081500* 5000-PRINT-DETAIL-LINE                                          08150003
081600*     FORMAT AND PRINT REPORT DETAIL LINE.                        08160003
081700******************************************************************08170003
081800 5000-PRINT-DETAIL-LINE.                                          08180003
081900                                                                  08190003
082000     IF PV-LINE-CNT                > PC-LINE-LIMIT                08200003
082100         PERFORM 8000-PRINT-HEADINGS                              08210003
082200     END-IF.                                                      08220003
082300                                                                  08230003
082400     INITIALIZE                    DL1-SALES-AMOUNT               08240003
082500                                   DL1-RETURN-AMOUNT              08250003
082600                                   DL1-ASSOC-ID                   08260003
082700                                   DL1-CODE                       08270003
W37372                                   PV-CARD-NBR-RJ.                08290061
083600     MOVE PV-SLS-DATE-FORMATTED    TO DL1-SALES-DATE.             08360003
083700     MOVE EPTRN-RGST-ID            TO DL1-REGISTER.               08370003
083800     MOVE EPTRN-TRN-NBR            TO DL1-TRANSACTION.            08380003
083900     MOVE EPCRD-AUTH-NBR           TO DL1-AUTH-NBR.               08390003
084000                                                                  08400003
084000                                                                  08621058
086300     EVALUATE TRUE                                                08630003
086400         WHEN EPTND-TNDR-AMT       > ZERO                         08640003
086500             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         08650003
086600             MOVE PV-AMOUNT-FORMATTED                             08660003
086700                                   TO DL1-SALES-AMOUNT            08670003
086800             MOVE SPACE            TO DL1-RETURN-AMOUNT           08680003
086900             ADD EPTND-TNDR-AMT    TO PA-STORE-SALES-AMOUNT       08690003
087000                                                                  08700003
087100         WHEN EPTND-TNDR-AMT       < ZERO                         08710003
087200             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         08720003
087300             MOVE PV-AMOUNT-FORMATTED                             08730003
087400                                   TO DL1-RETURN-AMOUNT           08740003
087500             MOVE SPACE            TO DL1-SALES-AMOUNT            08750003
087600             ADD EPTND-TNDR-AMT    TO PA-STORE-RETURN-AMOUNT      08760003
087700                                                                  08770003
087800         WHEN OTHER                                               08780003
087900             MOVE ZERO             TO PV-AMOUNT-FORMATTED         08790003
088000             MOVE PV-AMOUNT-FORMATTED                             08800003
088100                                   TO DL1-RETURN-AMOUNT           08810003
088200                                      DL1-SALES-AMOUNT            08820003
088300     END-EVALUATE.                                                08830003
088400                                                                  08840003
088500**** A LATE TRANSACTION, INDICATED BY A -1 SEQUENCE NUMBER, WILL N08850003
088600**** HAVE A SALES AUDIT USER ID.  A REGULAR CORRECTION WILL HVAE A08860003
088700**** SALES AUDIT USER ID.                                         08870003
088800                                                                  08880003
088900     IF EPTRN-SLS-CORR-SEQ-NBR     < ZERO                         08890003
089000         MOVE PC-SYSTEM-CORRECTION TO DL1-CODE                    08900003
089100     ELSE                                                         08910003
089200         IF EPTRN-TRN-STAT-CDE     = PC-REVERSAL-CORRECTION       08920003
089300             MOVE PC-REVERSAL-CORRECTION                          08930003
089400                                   TO DL1-CODE                    08940003
089500         END-IF                                                   08950003
089600         PERFORM 5010-SELECT-SLS-AUD-USER-ID                      08960003
089700     END-IF.                                                      08970003
089800                                                                  08980003
W37372****  SINCE DEBIT CARDS HAVE VARIABLE LENGTHS, DEPENDING ON WHAT  08980161
W37372****  TYPE OF DEBIT CARD IT IS, IT IS NECESSARY TO RIGHT JUSTIFY  08980261
W37372****  THE ACCOUNT NUMBER.  THE SPACES WILL BE TO THE LEFT AND     08980361
W37372****  ALL NUMBERS EXCEPT THE LAST 4 WILL BE MASKED (*).           08980461
084400                                                                  08980560
W37372     MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)                  08980661
W37372                                   TO PV-CARD-NBR-RJ.             08980761
W37372                                                                  08980861
W37372     PERFORM 5005-MASK-CARD-NUMBER                                08981061
089900     MOVE DL1-DETAIL-LINE-1        TO PV-PRINT-RECORD.            08990003
090000                                                                  09000003
090100**** FOLLOWING CODE CHECKS IF THE LAST LINE PRINTED WAS SINGLE    09010003
090200**** SPACED (LIKE A DETAIL LINE) OR GREATER THAN SINGLE SPACED    09020003
090300**** (LIKE A HEADING LINE).  IF LAST LINE WAS NOT SINGLE SPACED,  09030003
090400**** PRINT THE DETAIL LINE DOUBLE SPACED.                         09040003
090500                                                                  09050003
090600     IF PV-LINE-SPACING            > +1                           09060003
090700         MOVE +2                   TO  PV-LINE-SPACING            09070003
090800     ELSE                                                         09080003
090900         MOVE +1                   TO  PV-LINE-SPACING            09090003
091000     END-IF.                                                      09100003
091100     PERFORM 8200-WRITE-REPORT-LINE.                              09110003
091200     MOVE +1                       TO  PV-LINE-SPACING.           09120003
091400                                                                  09140003
W37372******************************************************************09141061
W37372 5005-MASK-CARD-NUMBER.                                           09142061
W37372******************************************************************09143061
W37372         STRING '***************'                                 09149361
W37372                 PV-CARD-NBR-RJ (16:4)                            09149461
W37372                 DELIMITED BY SIZE                                09149561
W37372                 INTO DL1-CARD-NBR.                               09149661
W37372                                                                  09149761
091500***************************************************************** 09152018
091600* 5010-SELECT-SLS-AUD-USER-ID                                     09160003
091700*   - SELECT THE SALES AUDIT USER ID WHEN THE SALES CORRECTION    09170003
091800*     CORRECTION SEQUNCE NUMBER IS GREATER THAN ZERO              09180003
091900***************************************************************** 09190003
092000 5010-SELECT-SLS-AUD-USER-ID.                                     09200003
092100                                                                  09210003
092200     EXEC SQL                                                     09220003
092300         SELECT SLS_AUD_USR_ID                                    09230003
092400           INTO :EPSAT-SLS-AUD-USR-ID                             09240003
092500           FROM TEPSAT                                            09250003
092600          WHERE PARTN_NBR          = :EPTRN-PARTN-NBR             09260003
092700            AND STR_NBR            = :EPTRN-STR-NBR               09270003
092800            AND RGST_ID            = :EPTRN-RGST-ID               09280003
092900            AND TRN_NBR            = :EPTRN-TRN-NBR               09290003
093000            AND STRT_TM            = :EPTRN-STRT-TM               09300003
093100            AND SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      09310003
093200         WITH UR                                                  09320003
093300     END-EXEC.                                                    09330003
093400                                                                  09340003
093500     EVALUATE TRUE                                                09350003
093600         WHEN SQLCODE = ZERO                                      09360003
093700             MOVE EPSAT-SLS-AUD-USR-ID                            09370003
093800                                   TO DL1-ASSOC-ID                09380003
093900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          09390003
094000             MOVE 'UNKNOWN'        TO DL1-ASSOC-ID                09400003
094100         WHEN SQLWARN0 NOT EQUAL SPACE                            09410003
094200         WHEN SQLCODE NOT EQUAL ZERO                              09420003
094300             MOVE '5010-SELECT-SLS-AUD-USER-ID'                   09430003
094400                                   TO PV-PARAGRAPH-NAME           09440003
094500             MOVE 'ERROR ON SELECTING SLS AUD USER ID'            09450003
094600                                   TO PV-DB2-OPERATION            09460003
094700             PERFORM 9100-SQL-ABEND                               09470003
094800     END-EVALUATE.                                                09480003
094900                                                                  09490003
095000***************************************************************** 09500003
095100*  PRINT THE LINE CONTAINING THE STORE NUMBER                     09510003
095200***************************************************************** 09520003
095300 5100-PRINT-STORE-LINE.                                           09530003
095400                                                                  09540003
095500**** FOLLOWING CODE CHECKS FOR ENOUGH ROOM ON THE PAGE TO         09550003
095600**** PRINT THE STORE LINE, SALES DATE LINE,                       09560003
095700**** AND AT LEAST ONE DETAIL LINE.                                09570003
095800                                                                  09580003
095900     MOVE PV-LINE-CNT              TO  PV-LINE-CNT-AHEAD.         09590003
096000     ADD +8                        TO  PV-LINE-CNT-AHEAD.         09600003
096100     IF PV-LINE-CNT-AHEAD          > PC-LINE-LIMIT                09610003
096200         PERFORM 8000-PRINT-HEADINGS                              09620003
096300     END-IF.                                                      09630003
096400                                                                  09640003
096500     MOVE EPTRN-STR-NBR            TO HL3-STORE.                  09650003
096600     MOVE +4                       TO PV-LINE-SPACING.            09660003
096700     MOVE HL3-HEADING-LINE-3       TO PV-PRINT-RECORD.            09670003
096800     PERFORM 8200-WRITE-REPORT-LINE.                              09680003
096900                                                                  09690003
097000******************************************************************09700003
097100*  PRINT THE STORE TOTAL LINE INFORMATION                         09710003
097200******************************************************************09720003
097300 5200-PRINT-STORE-TOTAL-LINE.                                     09730003
097400                                                                  09740003
097500     IF PV-LINE-CNT                > PC-LINE-LIMIT                09750003
097600         PERFORM 8000-PRINT-HEADINGS                              09760003
097700     END-IF.                                                      09770003
097800                                                                  09780003
097900     MOVE PV-HOLD-STORE            TO HL6-STORE.                  09790003
098000     MOVE PV-SLS-DATE-FORMATTED    TO HL6-DATE.                   09800003
098100                                                                  09810003
098200     IF PA-STORE-SALES-AMOUNT      > ZERO                         09820003
098300         MOVE PA-STORE-SALES-AMOUNT                               09830003
098400                                   TO PV-AMOUNT-FORMATTED         09840003
098500         MOVE PV-AMOUNT-FORMATTED  TO HL6-SALES-TOTAL             09850003
098600     ELSE                                                         09860003
098700         MOVE SPACE                TO HL6-SALES-TOTAL             09870003
098800     END-IF.                                                      09880003
098900                                                                  09890003
099000     ADD  PA-STORE-SALES-AMOUNT    TO PA-COMPANY-SALES-AMOUNT.    09900003
099100                                                                  09910003
099200     IF PA-STORE-RETURN-AMOUNT     < ZERO                         09920003
099300         MOVE PA-STORE-RETURN-AMOUNT                              09930003
099400                                   TO PV-AMOUNT-FORMATTED         09940003
099500         MOVE PV-AMOUNT-FORMATTED  TO HL6-RETURN-TOTAL            09950003
099600     ELSE                                                         09960003
099700         MOVE SPACE                TO HL6-RETURN-TOTAL            09970003
099800     END-IF.                                                      09980003
099900                                                                  09990003
100000     ADD PA-STORE-RETURN-AMOUNT    TO PA-COMPANY-RETURN-AMOUNT.   10000003
100100     COMPUTE PV-AMOUNT             = PA-STORE-RETURN-AMOUNT       10010003
100200                                   + PA-STORE-SALES-AMOUNT.       10020003
100300     MOVE PV-AMOUNT                TO PV-AMOUNT-FORMATTED.        10030003
100400     MOVE PV-AMOUNT-FORMATTED      TO HL6-NET-AMOUNT.             10040003
100500     MOVE +2                       TO PV-LINE-SPACING.            10050003
100600     MOVE HL6-HEADING-LINE-6       TO PV-PRINT-RECORD.            10060003
100700     PERFORM 8200-WRITE-REPORT-LINE.                              10070003
100800                                                                  10080003
100900******************************************************************10090003
101000* 8000-PRINT-HEADINGS                                             10100003
101100*     PRINT THE HEADINGS FOR THE REPORT.                          10110003
101200******************************************************************10120003
101300 8000-PRINT-HEADINGS.                                             10130003
101400                                                                  10140003
101500     ADD +1                        TO PV-PAGE-CNT.                10150003
101600     MOVE PV-PAGE-CNT TO DP132-PAGE-NUMBER.                       10160003
101700     MOVE DP132-STANDRD-HEADER-132-COLS                           10170003
101800                                   TO PV-PRINT-RECORD.            10180003
101900     PERFORM 8100-WRITE-RPT-TOP-OF-PAGE.                          10190003
102000                                                                  10200003
102100     MOVE HL2-HEADING-LINE-2       TO PV-PRINT-RECORD.            10210003
102200     MOVE +1                       TO PV-LINE-SPACING.            10220003
102300     PERFORM 8200-WRITE-REPORT-LINE.                              10230003
102400                                                                  10240003
102500     MOVE +2                       TO PV-LINE-SPACING.            10250003
102600     MOVE HL4-HEADING-LINE-4       TO PV-PRINT-RECORD.            10260003
102700     PERFORM 8200-WRITE-REPORT-LINE.                              10270003
102800                                                                  10280003
102900     MOVE +1                       TO PV-LINE-SPACING.            10290003
103000     MOVE HL5-HEADING-LINE-5       TO PV-PRINT-RECORD.            10300003
103100     PERFORM 8200-WRITE-REPORT-LINE.                              10310003
103200     MOVE +2                       TO PV-LINE-SPACING.            10320003
103300                                                                  10330003
103500                                                                  10350003
103600******************************************************************10360003
103700* 8100-WRITE-RPT-TOP-OF-PAGE                                      10370003
103800*     WRITE FIRST REPORT LINE AFTER PAGE BREAK.                   10380003
103900******************************************************************10390003
104000 8100-WRITE-RPT-TOP-OF-PAGE.                                      10400003
104100                                                                  10410003
104200     WRITE DEBIT-REPORT-RECORD                                    10420003
104300       FROM PV-PRINT-RECORD                                       10430003
104400         AFTER ADVANCING PAGE.                                    10440003
104500     MOVE +1                       TO PV-LINE-CNT.                10450003
104700                                                                  10470003
104800******************************************************************10480003
104900* 8200-WRITE-REPORT-LINE                                          10490003
105000*     WRITE REPORT LINE AFTER ADVANCING LINE SPACING.             10500003
105100******************************************************************10510003
105200 8200-WRITE-REPORT-LINE.                                          10520003
105300                                                                  10530003
105400     WRITE DEBIT-REPORT-RECORD                                    10540003
105500       FROM PV-PRINT-RECORD                                       10550003
105600         AFTER ADVANCING PV-LINE-SPACING.                         10560003
105700                                                                  10570003
105800     ADD PV-LINE-SPACING TO PV-LINE-CNT.                          10580003
106000                                                                  10600003
106100******************************************************************10616003
106200* 9100-SQL-ABEND                                                  10620003
106300*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.10630003
106400******************************************************************10640003
106500 9100-SQL-ABEND.                                                  10650003
106600     DISPLAY '** ABEND     **'.                                   10660003
106700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        10670003
106800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              10680003
106900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               10690003
107000                                                                  10700003
107100******************************************************************10710003
107200* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     10720003
107300* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      10730003
107400******************************************************************10740003
107500     COPY DPPD004.                                                10750003
107600                                                                  10760003
107700     SET AC-DB2-ERROR TO TRUE.                                    10770003
107800     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         10780003
107900                                                                  10790003
108000******************************************************************10800003
108100* 9999-ABEND                                                      10810003
108200*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  10820003
108300******************************************************************10830003
108400 9999-ABEND.                                                      10840003
108500     DISPLAY '** ABEND           **'.                             10850003
108600     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  10860003
108700     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        10870003
108800     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       10880003
108900     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       10890003
109000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         10900003
