000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT003.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*   AHKUT003.  "ARCHIVE HISTORY" PROJECT. DATA OFFLOAD.          *00090000
001000*                                                                *00100000
001100*   PURPOSE:                                                     *00110000
001200*   THIS PROGRAM CONTINUES THE PROCESS OF DATA SELECTION TO      *00120000
001300*   CREATE A DRIVER FILE.                                        *00130000
001400*   ONCE COMPLETED, THE DRIVER FILE WILL BE USED BY SUBSEQUENT   *00140000
001500*   PROGRAMS TO IDENTIFY AND EXTRACT COMPLETED PO'S FROM         *00150000
001600*   SEVERAL INTERRELATED TABLES FOR ARCHIVING.                   *00160000
001700*                                                                *00170000
001800*   PROCESSING OVERVIEW:                                         *00180000
001900*   THIS PROGRAM APPLIES SELECTION CRITERIA FROM TABLE TRECEIV   *00190000
002000*   TO THE RECORDS IN THE DRIVER FILE, POTENTIALLY REDUCING THE  *00200000
002100*   NUMBER OF RECORDS IN THE DRIVER FILE.                        *00210000
002200*   ALL RECORDS/ROWS FOR THE PURCHASE ORDER (PO) MUST MEET THE   *00220000
002300*   SELECTION CRITERIA FOR THE PO TO REMAIN IN THE DRIVER FILE.  *00230000
002400*                                                                *00240000
002500*   PROCESSING DETAIL:                                           *00250000
002600*   THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,    *00260000
002700*   1) INCREMENT COUNT OF RECORDS READ.                          *00270000
002800*   2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE,              *00280000
002900*      WHICH *DO NOT* MEET THE ARCHIVE CRITERIA.                 *00290000
003000*      2.A) IF NO MATCH(ES):                                     *00300000
003100*           2.A.1) LOOP TO WRITE ALL RECORDS FOR THIS PO         *00310000
003200*                  TO THE DRIVER FILE.                           *00320000
003300*           2.A.2) INCREMENT COUNT OF RECORDS WRITTEN.           *00330000
003400*           2.A.3) DO NOT REMOVE THE ROW(S) FROM THE TABLE       *00340000
003500*                  AT THIS TIME.  THEY WILL BE REMOVED IN OTHER  *00350000
003600*                  PROCESSING, AFTER HAVING BEEN LOADED TO THE   *00360000
003700*                  ARCHIVE/HISTORY TABLE.                        *00370000
003800*      2.B) IF MATCH(ES):                                        *00380000
003900*           2.B.1) PROCESSING CONTINUES:                         *00390000
004000*                  LOOP TO READ ALL RECORDS FOR THIS PO.         *00400000
004100*           2.B.2) THESE RECORDS ARE SCREENED OUT OF THE         *00410000
004200*                  DRIVER FILE.                                  *00420000
004300*   3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *00430000
004400*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *00440000
004500*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *00450000
004510*----------------------------------------------------------------*00451000
004520*  CHANGE LOG:                                                   *00452000
004530* 06/04/07                                                       *00453001
004540*     INCREASED SIZE OF INPUT AND OUTPUT FILES FROM 186 TO 189.  *00454000
004550*     THIS WAS NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE       *00455000
004560*     AHRD001 COPYBOOK: DC-NBR AND MTCH-LVL-CDE.                 *00456000
004570* MADE BY: ROLF NOHE                           WR# 30241         *00457000
004580*----------------------------------------------------------------*00458000
004590******************************************************************00459000
004600 ENVIRONMENT DIVISION.                                            00460000
004700 CONFIGURATION SECTION.                                           00470000
004800 SOURCE-COMPUTER.        IBM-3090.                                00480000
004900 OBJECT-COMPUTER.        IBM-3090.                                00490000
005000                                                                  00500000
005100 INPUT-OUTPUT SECTION.                                            00510000
005200 FILE-CONTROL.                                                    00520000
005300                                                                  00530000
005400     SELECT  IN-DRIVER-FILE               ASSIGN TO IN01.         00540000
005500     SELECT  OUT-DRIVER-FILE              ASSIGN TO OUT01.        00550000
005600                                                                  00560000
005700******************************************************************00570000
005800 DATA DIVISION.                                                   00580000
005900 FILE SECTION.                                                    00590000
006000                                                                  00600000
006100 FD  IN-DRIVER-FILE                                               00610000
006200     RECORDING MODE IS F                                          00620000
006300     LABEL RECORDS ARE STANDARD                                   00630000
006400     BLOCK CONTAINS 0 RECORDS.                                    00640000
006500 01  IN-DRIVER-RECORD                PIC  X(189).                 00650000
006600                                                                  00660000
006700 FD  OUT-DRIVER-FILE                                              00670000
006800     RECORDING MODE IS F                                          00680000
006900     LABEL RECORDS ARE STANDARD                                   00690000
007000     BLOCK CONTAINS 0 RECORDS.                                    00700000
007100 01  OUT-DRIVER-RECORD               PIC  X(189).                 00710000
007200                                                                  00720000
007300 WORKING-STORAGE SECTION.                                         00730000
007400                                                                  00740000
007500 01  PC-PROGRAM-CONSTANTS.                                        00750000
007600     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT003'.  00760000
007700     05  PC-PGM-PROGRESS-DESC.                                    00770000
007800         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00780000
007900         10  PC-CONTINUING           PIC X(10) VALUE              00790000
008000                                               'CONTINUING'.      00800000
008100         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00810000
008200         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00820000
008300     05  PC-ABEND-INFO.                                           00830000
008400         10  PC-ABEND                PIC X(11) VALUE              00840000
008500                                               '** ABEND **'.     00850000
008600         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00860000
008700                                               '- PARA       : '. 00870000
008800         10  PC-ABEND-MSG-DISPLAY-PARA                            00880000
008900                                     PIC X(15) VALUE              00890000
009000                                               '  CALLED PARA: '. 00900000
009100         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00910000
009200                                               '  FOR ABEND# : '. 00920000
009300         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00930000
009400                                               '- ERROR IS   : '. 00940000
009500         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00950000
009600         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00960000
009700                                               '- ACTION     : '. 00970000
009800     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 100000.      00980000
009900     05  PC-1-SPACE                  PIC X(01) VALUE SPACE.       00990000
010000                                                                  01000000
010100 01  PS-PROGRAM-SWITCHES.                                         01010000
010200     05  PS-CONTROL-BREAK-SW         PIC X(01) VALUE 'N'.         01020000
010300         88  PS-CONTROL-BREAK                  VALUE 'Y'.         01030000
010400         88  PS-RESET-CONTROL-BREAK            VALUE 'N'.         01040000
010500     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         01050000
010600         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         01060000
010700         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01070000
010800     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01080000
010900         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01090000
011000         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01100000
011100                                                                  01110000
011200 01  PV-PROGRAM-VARIABLES.                                        01120000
011300     05  PV-DRIVER-READ-IN-CNT       PIC  9(9) VALUE 0.           01130000
011400     05  PV-DRIVER-READ-PO-CNT       PIC  9(9) VALUE 0.           01140000
011500     05  PV-CURSORS-TOTAL-CNT        PIC  9(9) VALUE 0.           01150000
011600     05  PV-CURSORS-NONSELECT-CNT    PIC  9(9) VALUE 0.           01160000
011700     05  PV-ROW-COUNT                PIC S9(9) VALUE 0 COMP.      01170000
011800     05  PV-CURSORS-PO-SELECT-CNT    PIC  9(9) VALUE 0.           01180000
011900     05  PV-DRIVER-WRITTEN-CNT       PIC  9(9) VALUE 0.           01190000
012000     05  PV-PO-NBR                   PIC S9(9) VALUE 0 COMP.      01200000
012100     05  PV-DISPLAY-PO-NBR           PIC 9(9).                    01210000
012200     05  PV-PREV-PO-NBR              PIC S9(9) VALUE 0 COMP.      01220000
012300     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01230000
012400     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01240000
012500     05  PV-DB2-TABLE-NAME-1         PIC X(18) VALUE SPACES.      01250000
012600     05  PV-DB2-TABLE-NAME-2         PIC X(18) VALUE SPACES.      01260000
012700     05  PV-DISPLAY-NTH-MULTIPLE     PIC  9(9) VALUE 0.           01270000
012800     05  PV-DISPLAY-NTH-REMAINDER    PIC  9(9) VALUE 0.           01280000
012900     05  PV-SQLCODE                  PIC  +999 VALUE ZERO.        01290000
013000                                                                  01300000
013100     05  PV-TMST                     PIC X(26) VALUE SPACES.      01310000
013200     05  PV-TIMESTAMP-DETAIL                                      01320000
013300         REDEFINES                                                01330000
013400         PV-TMST.                                                 01340000
013500         10  PV-TIMESTAMP-19.                                     01350000
013600             15  PV-TMS-DATE.                                     01360000
013700                 20  PV-TMS-YEAR.                                 01370000
013800                     25  PV-TMS-CC   PIC X(02).                   01380000
013900                     25  PV-TMS-YY   PIC X(02).                   01390000
014000                 20  FILLER          PIC X(01).                   01400000
014100                 20  PV-TMS-MONTH    PIC X(02).                   01410000
014200                 20  FILLER          PIC X(01).                   01420000
014300                 20  PV-TMS-DAY      PIC X(02).                   01430000
014400             15  FILLER              PIC X(01).                   01440000
014500             15  PV-TMS-HOUR         PIC X(02).                   01450000
014600             15  FILLER              PIC X(01).                   01460000
014700             15  PV-TMS-MINUTE       PIC X(02).                   01470000
014800             15  FILLER              PIC X(01).                   01480000
014900             15  PV-TMS-SECOND       PIC X(02).                   01490000
015000         10  FILLER                  PIC X(01).                   01500000
015100         10  PV-TMS-MSECOND          PIC X(06).                   01510000
015200                                                                  01520000
015300                                                                  01530000
015400*---------------------------------------------------------------* 01540000
015500*  RECORD LAYOUT FOR DRIVER FILE                                * 01550000
015600*---------------------------------------------------------------* 01560000
015700     COPY AHRD001.                                                01570000
015800                                                                  01580000
015900 01  DM-DISPLAY-MESSAGE.                                          01590000
016000     05  DM-01-10.                                                01600000
016100         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01610000
016200         10  FILLER                  PIC X(02) VALUE ': '.        01620000
016300     05  DM-11-80.                                                01630000
016400         10  FILLER                  PIC X(38) VALUE              01640000
016500                        'APPLY TRECEIV CRITERIA TO DRIVER FILE.'. 01650000
016600         10  FILLER                  PIC X(01) VALUE SPACE.       01660000
016700         10  FILLER                  PIC X(31) VALUE ALL '*'.     01670000
016800     05  DM-81-120.                                               01680000
016900         10  FILLER                  PIC X(40) VALUE ALL '*'.     01690000
017000                                                                  01700000
017100                                                                  01710000
017200 01  DP-DISPLAY-PROGRESS-MSG.                                     01720000
017300     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01730000
017400     05  FILLER                      PIC X(02) VALUE SPACE.       01740000
017500     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01750000
017600     05  FILLER                      PIC X(04) VALUE ' AT '.      01760000
017700     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01770000
017800     05  FILLER                      PIC X(03) VALUE '.  '.       01780000
017900     05  FILLER                      PIC X(03) VALUE 'IN:'.       01790000
018000     05  DP-DRIVER-READ-IN-CNT       PIC ZZZ,ZZZ,ZZ9              01800000
018100                                               VALUE ZERO.        01810000
018200     05  FILLER                      PIC X(02) VALUE ', '.        01820000
018300     05  FILLER                      PIC X(05) VALUE 'PO"S:'.     01830000
018400     05  DP-DRIVER-READ-PO-CNT       PIC ZZZ,ZZZ,ZZ9              01840000
018500                                               VALUE ZERO.        01850000
018600     05  FILLER                      PIC X(02) VALUE ', '.        01860000
018700*    05  FILLER                      PIC X(08) VALUE              01870000
018800*                                              'CURSORS:'.        01880000
018900*    05  DP-CURSORS-TOTAL-CNT        PIC ZZZ,ZZZ,ZZ9              01890000
019000*                                              VALUE ZERO.        01900000
019100*    05  FILLER                      PIC X(02) VALUE ', '.        01910000
019200*    05  FILLER                      PIC X(10) VALUE              01920000
019300*                                              'NONSELECT:'.      01930000
019400*    05  DP-CURSORS-NONSELECT-CNT    PIC ZZZ,ZZZ,ZZ9              01940000
019500*                                              VALUE ZERO.        01950000
019600*    05  FILLER                      PIC X(02) VALUE ', '.        01960000
019700     05  FILLER                      PIC X(10) VALUE              01970000
019800                                               'PO SELECT:'.      01980000
019900     05  DP-CURSORS-PO-SELECT-CNT    PIC ZZZ,ZZZ,ZZ9              01990000
020000                                               VALUE ZERO.        02000000
020100     05  FILLER                      PIC X(02) VALUE ', '.        02010000
020200     05  FILLER                      PIC X(04) VALUE 'OUT:'.      02020000
020300     05  DP-DRIVER-WRITTEN-CNT       PIC ZZZ,ZZZ,ZZ9              02030000
020400                                               VALUE ZERO.        02040000
020500     05  FILLER                      PIC X(01) VALUE '.'.         02050000
020600                                                                  02060000
020700 01  ABEND-CODE                      PIC S9(04)                   02070000
020800                                               VALUE ZEROES       02080000
020900                                               COMP SYNC.         02090000
021000                                                                  02100000
021100*---------------------------------------------------------------* 02110000
021200*  DB2 FORMATTED MESSAGE AREA                                     02120000
021300*---------------------------------------------------------------* 02130000
021400     COPY DPWS004.                                                02140000
021500                                                                  02150000
021600*---------------------------------------------------------------* 02160000
021700*    DB2 AREA FOR TRECEIV                                       * 02170000
021800*---------------------------------------------------------------* 02180000
021900     EXEC SQL                                                     02190000
022000          INCLUDE TRECEIV                                         02200000
022100     END-EXEC.                                                    02210000
022200                                                                  02220000
022300*---------------------------------------------------------------* 02230000
022400*    DB2 AREA FOR TRECDIS                                       * 02240000
022500*---------------------------------------------------------------* 02250000
022600     EXEC SQL                                                     02260000
022700          INCLUDE TRECDIS                                         02270000
022800     END-EXEC.                                                    02280000
022900                                                                  02290000
023000*---------------------------------------------------------------* 02300000
023100*    DB2 AREA FOR COMMUNICATIONS                                * 02310000
023200*---------------------------------------------------------------* 02320000
023300     EXEC SQL                                                     02330000
023400          INCLUDE SQLCA                                           02340000
023500     END-EXEC.                                                    02350000
023600                                                                  02360000
023700*---------------------------------------------------------------* 02370000
023800*    DEFINE CURSOR FOR PULLING ROW(S) FROM TRECEIV              * 02380000
023900*    WHICH DO *NOT* MEET THE SELECTION CRITERIA;                * 02390000
024000*    IF ANY ROW(S) ARE RETURNED, THIS PURCHASE ORDER (PO) WILL  * 02400000
024100*    *NOT* REMAIN IN THE DRIVER FILE.                           * 02410000
024200*---------------------------------------------------------------* 02420000
024300     EXEC SQL                                                     02430000
024400         DECLARE NONSELECT-CURSOR CURSOR FOR                      02440000
024500         SELECT COUNT(*)                                          02450000
024600           FROM TRECDIS                                           02460000
024700****       FROM TRECEIV                                           02470000
024800          WHERE ORD_NBR  = :PV-PO-NBR                             02480000
024900            AND AP_PRC_CDE = :PC-1-SPACE                          02490000
025000            AND AP_VERIFY_ITM_QTY > 0                             02500000
025100         FOR FETCH ONLY                                           02510000
025200         WITH UR                                                  02520000
025300     END-EXEC.                                                    02530000
025400                                                                  02540000
025500                                                                  02550000
025600 PROCEDURE DIVISION.                                              02560000
025700                                                                  02570000
025800 0000-PROGRAM-MAINLINE.                                           02580000
025900                                                                  02590000
026000     PERFORM 1000-INITIALIZE.                                     02600000
026100                                                                  02610000
026200     PERFORM 2000-PROCESS-ONE-PO                                  02620000
026300         UNTIL PS-IN-DRIVER-EOF.                                  02630000
026400                                                                  02640000
026500     PERFORM 6000-EOJ-ROUTINE.                                    02650000
026600     GOBACK.                                                      02660000
026700                                                                  02670000
026800                                                                  02680000
026900******************************************************************02690000
027000*   INITIALIZATIONS                                              *02700000
027100******************************************************************02710000
027200 1000-INITIALIZE.                                                 02720000
027300                                                                  02730000
027400     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02740000
027500     DISPLAY DM-DISPLAY-MESSAGE.                                  02750000
027600                                                                  02760000
027700     MOVE PC-BEGINNING  TO  DP-STATUS-DESCRIPTION.                02770000
027800     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02780000
027900                                                                  02790000
028000     OPEN  INPUT  IN-DRIVER-FILE                                  02800000
028100          OUTPUT OUT-DRIVER-FILE.                                 02810000
028200                                                                  02820000
028300     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02830000
028400     PERFORM 9050-READ-IN-DRIVER-FILE.                            02840000
028500                                                                  02850000
028600******************************************************************02860000
028700*   PROCESS EACH RECORD FROM THE SEQUENTIAL DRIVER FILE.         *02870000
028800*   - CONTROL BREAK ON PO.                                       *02880000
028900*     PROCESS THE FIRST RECORD IN THE DRIVER FILE FOR THIS PO.   *02890000
029000*   - THIS WILL DETERMINE ACTION TO BE TAKEN FOR EACH            *02900000
029100*     SUBSEQUENT RECORD FOR THIS PO.                             *02910000
029200******************************************************************02920000
029300 2000-PROCESS-ONE-PO.                                             02930000
029400                                                                  02940000
029500     MOVE AH001-B-PO-NBR        TO PV-PREV-PO-NBR                 02950000
029600                                   PV-PO-NBR                      02960000
029700                                   PV-DISPLAY-PO-NBR.             02970000
029800     SET PS-RESET-CONTROL-BREAK TO TRUE.                          02980000
029900                                                                  02990000
030000     ADD +1                     TO PV-CURSORS-TOTAL-CNT.          03000000
030100     SET PS-CURSOR-HAS-NO-DATA  TO TRUE.                          03010000
030200     PERFORM 9100-OPEN-NONSELECT-CURSOR.                          03020000
030300     PERFORM 9110-FETCH-NONSELECT-CURSOR.                         03030000
030400                                                                  03040000
030500     IF PS-CURSOR-HAS-DATA                                        03050000
030600         ADD +1 TO PV-CURSORS-NONSELECT-CNT                       03060000
030700         DISPLAY 'BYPASS THIS PO ' PV-DISPLAY-PO-NBR              03070000
030800         PERFORM 9050-READ-IN-DRIVER-FILE                         03080000
030900             UNTIL PS-IN-DRIVER-EOF                               03090000
031000                OR PS-CONTROL-BREAK                               03100000
031100     ELSE                                                         03110000
031200         ADD +1 TO PV-CURSORS-PO-SELECT-CNT                       03120000
031300         PERFORM 2020-LOOP-TIL-NEXT-PO                            03130000
031400             UNTIL PS-IN-DRIVER-EOF                               03140000
031500                OR PS-CONTROL-BREAK                               03150000
031600     END-IF.                                                      03160000
031700                                                                  03170000
031800     PERFORM 9190-CLOSE-NONSELECT-CURSOR.                         03180000
031900                                                                  03190000
032000                                                                  03200000
032100******************************************************************03210000
032200*   COPY EACH RECORD FOR THIS PO FROM THE INPUT DRIVER FILE      *03220000
032300*   TO THE OUTPUT DRIVER FILE.                                   *03230000
032400******************************************************************03240000
032500 2020-LOOP-TIL-NEXT-PO.                                           03250000
032600                                                                  03260000
032700     PERFORM 9650-WRITE-DRIVER-RECORD.                            03270000
032800                                                                  03280000
032900     PERFORM 9050-READ-IN-DRIVER-FILE.                            03290000
033000                                                                  03300000
033100                                                                  03310000
033200******************************************************************03320000
033300*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *03330000
033400*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *03340000
033500*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *03350000
033600******************************************************************03360000
033700 2100-CHECK-PGM-PROGRESS.                                         03370000
033800                                                                  03380000
033900     DIVIDE    PV-DRIVER-READ-IN-CNT                              03390000
034000         BY        PC-HOW-OFTEN-TO-DISPLAY                        03400000
034100         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03410000
034200         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03420000
034300                                                                  03430000
034400     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03440000
034500         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03450000
034600         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03460000
034700     END-IF.                                                      03470000
034800                                                                  03480000
034900                                                                  03490000
035000******************************************************************03500000
035100*   CLOSE FILES, CURSOR, AND DISPLAY END OF RUN MESSAGE.         *03510000
035200******************************************************************03520000
035300 6000-EOJ-ROUTINE.                                                03530000
035400                                                                  03540000
035500     MOVE PC-ENDING  TO  DP-STATUS-DESCRIPTION.                   03550000
035600                                                                  03560000
035700     CLOSE IN-DRIVER-FILE.                                        03570000
035800     CLOSE OUT-DRIVER-FILE.                                       03580000
035900                                                                  03590000
036000     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03600000
036100                                                                  03610000
036200                                                                  03620000
036300******************************************************************03630000
036400*   DISPLAY PROGRAM PROGRESS.                                    *03640000
036500******************************************************************03650000
036600 6200-DISPLAY-PGM-PROGRESS.                                       03660000
036700                                                                  03670000
036800     EXEC SQL                                                     03680000
036900          SET :PV-TMST = CURRENT TIMESTAMP                        03690000
037000     END-EXEC.                                                    03700000
037100                                                                  03710000
037200     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03720000
037300     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03730000
037400     MOVE PV-DRIVER-READ-IN-CNT     TO DP-DRIVER-READ-IN-CNT.     03740000
037500     MOVE PV-DRIVER-READ-PO-CNT     TO DP-DRIVER-READ-PO-CNT.     03750000
037600*    MOVE PV-CURSORS-TOTAL-CNT      TO DP-CURSORS-TOTAL-CNT.      03760000
037700*    MOVE PV-CURSORS-NONSELECT-CNT  TO DP-CURSORS-NONSELECT-CNT.  03770000
037800     MOVE PV-CURSORS-PO-SELECT-CNT  TO DP-CURSORS-PO-SELECT-CNT.  03780000
037900     MOVE PV-DRIVER-WRITTEN-CNT     TO DP-DRIVER-WRITTEN-CNT.     03790000
038000                                                                  03800000
038100     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03810000
038200                                                                  03820000
038300                                                                  03830000
038400                                                                  03840000
038500******************************************************************03850000
038600*   READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT          *03860000
038700******************************************************************03870000
038800 9050-READ-IN-DRIVER-FILE.                                        03880000
038900                                                                  03890000
039000     READ IN-DRIVER-FILE                                          03900000
039100          INTO AH001-DRIVER-RECORD-LAYOUT                         03910000
039200          AT END                                                  03920000
039300              SET PS-IN-DRIVER-EOF TO TRUE.                       03930000
039400                                                                  03940000
039500     IF PS-IN-DRIVER-EOF                                          03950000
039600         CONTINUE                                                 03960000
039700     ELSE                                                         03970000
039800         ADD +1                    TO PV-DRIVER-READ-IN-CNT       03980000
039900         IF AH001-B-PO-NBR = PV-PREV-PO-NBR                       03990000
040000             CONTINUE                                             04000000
040100         ELSE                                                     04010000
040200             SET PS-CONTROL-BREAK  TO TRUE                        04020000
040300             ADD +1                TO PV-DRIVER-READ-PO-CNT       04030000
040400         END-IF                                                   04040000
040500         PERFORM 2100-CHECK-PGM-PROGRESS                          04050000
040600     END-IF.                                                      04060000
040700                                                                  04070000
040800                                                                  04080000
040900                                                                  04090000
041000******************************************************************04100000
041100*   OPEN  TABLE CURSOR                                           *04110000
041200******************************************************************04120000
041300 9100-OPEN-NONSELECT-CURSOR.                                      04130000
041400     EXEC SQL                                                     04140000
041500          OPEN NONSELECT-CURSOR                                   04150000
041600     END-EXEC.                                                    04160000
041700                                                                  04170000
041800     EVALUATE TRUE                                                04180000
041900         WHEN SQLCODE = ZERO                                      04190000
042000              CONTINUE                                            04200000
042100         WHEN SQLWARN0 NOT EQUAL SPACE                            04210000
042200         WHEN SQLCODE  NOT EQUAL ZERO                             04220000
042300              MOVE '9100-OPEN-NONSELECT-CURSOR'                   04230000
042400                                 TO PV-PARAGRAPH-NAME             04240000
042500              MOVE 'OPEN TABLE CURSOR'                            04250000
042600                                 TO PV-DB2-OPERATION-MSG-1        04260000
042700              MOVE 'TRECEIV'     TO PV-DB2-TABLE-NAME-1           04270000
042800              PERFORM 9999-DB2-ABEND                              04280000
042900     END-EVALUATE.                                                04290000
043000                                                                  04300000
043100                                                                  04310000
043200******************************************************************04320000
043300*   FETCH TABLE CURSOR                                           *04330000
043400******************************************************************04340000
043500 9110-FETCH-NONSELECT-CURSOR.                                     04350000
043600     EXEC SQL                                                     04360000
043700         FETCH NONSELECT-CURSOR                                   04370000
043800          INTO  :PV-ROW-COUNT                                     04380000
043900     END-EXEC.                                                    04390000
044000                                                                  04400000
044100     EVALUATE TRUE                                                04410000
044200         WHEN SQLCODE = ZERO                                      04420000
044300              CONTINUE                                            04430000
044400         WHEN SQLWARN0 NOT EQUAL SPACE                            04440000
044500         WHEN SQLCODE NOT EQUAL ZERO                              04450000
044600              MOVE '9110-FETCH-NONSELECT-CURSOR'                  04460000
044700                                 TO PV-PARAGRAPH-NAME             04470000
044800              MOVE 'FETCH TABLE CURSOR'                           04480000
044900                                 TO PV-DB2-OPERATION-MSG-1        04490000
045000              MOVE 'TRECEIV'     TO PV-DB2-TABLE-NAME-1           04500000
045100              PERFORM 9999-DB2-ABEND                              04510000
045200     END-EVALUATE.                                                04520000
045300                                                                  04530000
045400     IF PV-ROW-COUNT > 0                                          04540000
045500          SET PS-CURSOR-HAS-DATA    TO TRUE                       04550000
045600     ELSE                                                         04560000
045700          SET PS-CURSOR-HAS-NO-DATA TO TRUE                       04570000
045800     END-IF.                                                      04580000
045900                                                                  04590000
046000******************************************************************04600000
046100*   CLOSE TABLE CURSOR                                           *04610000
046200******************************************************************04620000
046300 9190-CLOSE-NONSELECT-CURSOR.                                     04630000
046400     EXEC SQL                                                     04640000
046500          CLOSE NONSELECT-CURSOR                                  04650000
046600     END-EXEC.                                                    04660000
046700                                                                  04670000
046800     EVALUATE TRUE                                                04680000
046900         WHEN SQLCODE = ZERO                                      04690000
047000              CONTINUE                                            04700000
047100         WHEN SQLWARN0 NOT EQUAL SPACE                            04710000
047200         WHEN SQLCODE NOT EQUAL ZERO                              04720000
047300              MOVE '9190-CLOSE-NONSELECT-CURSOR'                  04730000
047400                                 TO PV-PARAGRAPH-NAME             04740000
047500              MOVE 'CLOSE TABLE CURSOR'                           04750000
047600                                 TO PV-DB2-OPERATION-MSG-1        04760000
047700              MOVE 'TRECEIV'     TO PV-DB2-TABLE-NAME-1           04770000
047800              PERFORM 9999-DB2-ABEND                              04780000
047900     END-EVALUATE.                                                04790000
048000                                                                  04800000
048100                                                                  04810000
048200                                                                  04820000
048300                                                                  04830000
048400******************************************************************04840000
048500*   WRITE A RECORD TO THE DRIVER FILE                            *04850000
048600******************************************************************04860000
048700 9650-WRITE-DRIVER-RECORD.                                        04870000
048800     WRITE  OUT-DRIVER-RECORD  FROM  AH001-DRIVER-RECORD-LAYOUT.  04880000
048900     ADD +1 TO PV-DRIVER-WRITTEN-CNT.                             04890000
049000                                                                  04900000
049100                                                                  04910000
049200                                                                  04920000
049300                                                                  04930000
049400******************************************************************04940000
049500*   DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *04950000
049600*   AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN            *04960000
049700*   SQL ERROR OR WARNING CODE OCCURS.                            *04970000
049800******************************************************************04980000
049900 9999-DB2-ABEND.                                                  04990000
050000     DISPLAY PC-CURRENT-PROGRAM-NAME                              05000000
050100             ' 9999-DB2-ABEND'.                                   05010000
050200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05020000
050300             ' ** ABEND           **'.                            05030000
050400     DISPLAY PC-CURRENT-PROGRAM-NAME                              05040000
050500             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       05050000
050600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05060000
050700             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME-1.     05070000
050800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05080000
050900             ' **                 ** = ' PV-DB2-TABLE-NAME-2.     05090000
051000     DISPLAY PC-CURRENT-PROGRAM-NAME                              05100000
051100             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05110000
051200                                                                  05120000
051300     DISPLAY PC-CURRENT-PROGRAM-NAME                              05130000
051400             ' ** SQLCODE         ** = ' SQLCODE.                 05140000
051500     MOVE SQLCODE TO PV-SQLCODE.                                  05150000
051600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05160000
051700             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05170000
051800                                                                  05180000
051900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05190000
052000             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05200000
052100                                                                  05210000
052200                                                                  05220000
052300*----------------------------------------------------------------*05230000
052400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05240000
052500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05250000
052600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05260000
052700* FORMAT.                                                        *05270000
052800*----------------------------------------------------------------*05280000
052900     COPY DPPD004.                                                05290000
053000                                                                  05300000
053100     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05310000
053200     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05320000
053300                                                                  05330000
053400                                                                  05340000
053500*----------------------------------------------------------------*05350000
053600* CALL ABEND                                                     *05360000
053700*----------------------------------------------------------------*05370000
053800     MOVE +4013                  TO ABEND-CODE.                   05380000
053900     CALL 'ILBOABN0' USING ABEND-CODE.                            05390000
054000*                                                                 05400000
