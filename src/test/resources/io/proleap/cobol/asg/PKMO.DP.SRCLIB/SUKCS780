000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400******************************************************************00040000
000500*  I M P O R T A N T --- WHEN COMPILING THIS PROGRAM THE SOCKET  *00050000
000600* SWITCH ON THE 2ND COMPILE SCREEN NEEDS TO BE SET TO 'Y'.  THIS  00060000
000700* PROGRAM IS USING "EZASOKET".                                    00070000
000800******************************************************************00080000
000900                                                                  00090000
001000 PROGRAM-ID.       SUKCS780.                                      00100000
001100 AUTHOR.           GERMAN BANDA.                                  00110000
001200 INSTALLATION.     KOHLS.                                         00120000
001300 DATE-WRITTEN      NOVEMBER 2004.                                 00130000
001400 DATE-COMPILED.                                                   00140000
001500                                                                  00150000
001600******************************************************************00160000
001700* THIS PROGRAM RECEIVES FROM AND SENDS DATA STREAMS TO ACCUSORT   00170000
001800* FAST LABEL SYSTEM. THE RECEIVED DATA REPRESENT CARTONS SCANNED  00180000
001900* THAT WILL BE PROCESSED THROUGH CHECK-IN. LABEL DATA WILL BE     00190000
002000* RETURNED TO THE ACCUSORT BOX TO PRODUCE A LABEL.                00200000
002100******************************************************************00210000
002000* change log:                                                     00211000
002000*                                                                 00211100
002000* 02/14/2023        Jean Kurk                   CHG0281369        00211200
002000*                   Remove copybook for UPC Check Digit routine   00211300
002100******************************************************************00212000
002200 ENVIRONMENT DIVISION.                                            00220000
002300 DATA DIVISION.                                                   00230000
002400 WORKING-STORAGE SECTION.                                         00240000
002500                                                                  00250000
002600*                                                                 00260000
002700*  SOCKET COMMANDS CODES NEED FOR THE TCP/IP SOCKET CALLS         00270000
002800*                                                                 00280000
002900     COPY DPWS081.                                                00290000
003000                                                                  00300000
003100*---------------------------------------------------------------* 00310000
003200*  RECORD LAYOUT FOR THE COMMAREA BEING USED TO PASS DATA TO    * 00320000
003300*  THE RDM ORACLE ROUTINE (WMKUT020).                             00330000
003400*---------------------------------------------------------------* 00340000
003500     COPY SURD017.                                                00350000
003600                                                                  00360000
003700     EJECT                                                        00370000
003800*                                                                 00380000
003900*  LAYOUT FOR THE ABEND MODULE COMMUNICATIONS AREA.               00390000
004000                                                                  00400000
004100 01  TASK-START.                                                  00410000
004200     05  FILLER                         PIC X(09)                 00420000
004300      VALUE IS 'CONFIRMS '.                                       00430000
004400     05  TASK-START-TRAN                PIC X(04).                00440000
004500     05  FILLER                         PIC X(18)                 00450000
004600      VALUE IS ' INTERFACE STARTED'.                              00460000
004700     05  TASK-START-CR                  PIC X(01).                00470000
004800*                                                                 00480000
004900*                                                                 00490000
005000 01  TCP-BUF2.                                                    00500000
005100     05 TCP-BUF                          PIC  X(64)  VALUE SPACE. 00510000
005200     05 TCP-BUF-DATA                     PIC  X(13)  VALUE SPACE. 00520000
005300*                                                                 00530000
005400 01  PC-PROGRAM-CONSTANTS.                                        00540000
005500     05  PC-MAX-RETRIES                  PIC S9(03)  VALUE +3     00550000
005600                                                     COMP-3.      00560000
005700     05  PC-CURRENT-PGM-NAME             PIC  X(08)  VALUE        00570000
005800         'SUKCS780'.                                              00580000
005900     05  PC-WMKUT020                PIC X(08) VALUE 'WMKUT020'.   00590000
006000     05  PC-CR                      PIC X(01) VALUE ';'.          00600000
006100     05  PC-DEFAULT-TMST            PIC X(26)                     00610000
006200                              VALUE '9999-09-09-09.09.09.999999'. 00620000
006300*                                                                 00630000
006400 01  DK-DB2-KEYS.                                                 00640000
006500     05  DK-BRCDE-NBR                    PIC  X(22) VALUE SPACES. 00650000
006600     05  DK-DATE                         PIC  X(10) VALUE SPACES. 00660000
006700     05  DK-TIME                         PIC  X(08) VALUE SPACES. 00670000
006800     05  DK-FUNC-CDE                     PIC  X(06) VALUE SPACES. 00680000
006900     05  DK-LOC-ID                       PIC S9(04)  COMP.        00690000
007000     05  DK-STR-NBR                      PIC S9(04)  COMP.        00700000
007100     05  DK-CTN                          PIC S9(18)V COMP-3.      00710000
007200     05  DK-SHIPT-UNT-ID                 PIC S9(18)V COMP-3       00720000
007300                                                    VALUE ZERO.   00730000
007400     05  DK-OPER-UNT-ID                  PIC S9(04)  COMP.        00740000
007500     05  DK-DIVERT-ID                    PIC S9(09)  COMP.        00750000
007600     05  DK-DOOR-ID                      PIC X(04)  VALUE SPACES. 00760000
007700     05  DK-ERROR-CODE                   PIC X(03)  VALUE ZERO.   00770000
007800     05  DK-PRC-TMST                     PIC X(26)  VALUE SPACES. 00780000
007900     05  DK-RECS-READ                    PIC S9(9)   COMP         00790000
008000                                                    VALUE ZERO.   00800000
008100                                                                  00810000
008200 01  PS-PROGRAM-SWITCHES.                                         00820000
008300     05  PS-CHILD-SW                     PIC X(01)   VALUE 'N'.   00830000
008400         88  PS-ALL-CHILD                            VALUE 'N'.   00840000
008500         88  PS-END-OF-CHILD                         VALUE 'Y'.   00850000
008600     05  PS-DEST-MATCH-FOUND-SW          PIC X(01)   VALUE 'N'.   00860000
008700         88  PS-NO-DEST-MATCH-FOUND                  VALUE 'N'.   00870000
008800         88  PS-DEST-MATCH-FOUND                     VALUE 'Y'.   00880000
008900     05  PS-CARTON-SW                    PIC X(01)   VALUE 'N'.   00890000
009000         88  PS-ALL-CARTON                           VALUE 'N'.   00900000
009100         88  PS-END-OF-CARTON                        VALUE 'Y'.   00910000
009200     05  PS-LOG-TO-ERR-FILE-SW           PIC X(01)   VALUE ' '.   00920000
009300         88  PS-LOG-TO-ERR-FILE                      VALUE 'Y'.   00930000
009400         88  PS-DO-NOT-LOG                           VALUE 'N'.   00940000
009500     05  PS-PARM-REC-FOUND-SW            PIC X(01)   VALUE ' '.   00950000
009600         88  PS-NO-PARM-REC-FOUND                    VALUE 'N'.   00960000
009700         88  PS-PARM-REC-FOUND                       VALUE 'Y'.   00970000
009800     05  PS-DUPLICATE-CARTON-SW          PIC X(01)   VALUE ' '.   00980000
009900         88  PS-NO-DUPLICATE-CARTON                  VALUE 'N'.   00990000
010000         88  PS-DUPLICATE-CARTON                     VALUE 'Y'.   01000000
010100     05  PS-RDM-FACILITY-SW              PIC X(01)   VALUE 'N'.   01010000
010200         88  PS-RDM-FACILITY-YES                     VALUE 'Y'.   01020000
010300         88  PS-RDM-FACILITY-NO                      VALUE 'N'.   01030000
010400     05  PS-RDM-RECORD-FOUND-SW          PIC X(01)   VALUE 'N'.   01040000
010500         88  PS-RDM-RECORD-FOUND                     VALUE 'Y'.   01050000
010600         88  PS-RDM-RECORD-NOT-FOUND                 VALUE 'N'.   01060000
010700     05  PS-OTBND-CART-FOUND-SW          PIC X(01)   VALUE 'N'.   01070000
010800         88  PS-OTBND-CART-FOUND-YES                 VALUE 'Y'.   01080000
010900         88  PS-OTBND-CART-FOUND-NO                  VALUE 'N'.   01090000
011000     05  PS-PART-RECEIVE-SW              PIC  X(01)  VALUE 'S'.   01100000
011100         88  PS-PART-RECEIVE                         VALUE 'P'.   01110000
011200         88  PS-COMP-RECEIVE                         VALUE 'C'.   01120000
011300         88  PS-ERROR-RECEIVE                        VALUE 'E'.   01130000
011400         88  PS-START-RECEIVE                        VALUE 'S'.   01140000
011500     05  PS-DOOR-CONVERT-NOT-FOUND-SW    PIC X(01)   VALUE 'N'.   01150000
011600         88  PS-DOOR-CONVERT-FOUND                   VALUE 'Y'.   01160000
011700         88  PS-DOOR-CONVERT-NOT-FOUND               VALUE 'N'.   01170000
011800     05  PS-STORE-NUMBER-NOT-FOUND-SW    PIC X(01)   VALUE 'N'.   01180000
011900         88  PS-STORE-NUMBER-FOUND                   VALUE 'Y'.   01190000
012000         88  PS-STORE-NUMBER-NOT-FOUND               VALUE 'N'.   01200000
012100     05  PS-SOCKET-CLOSE-SW              PIC X(01)   VALUE 'N'.   01210000
012200         88  PS-SOCKET-CLOSED                        VALUE 'Y'.   01220000
012300         88  PS-SOCKET-NOT-CLOSED                    VALUE 'N'.   01230000
012400                                                                  01240000
012500 01  PV-PROGRAM-VARIABLES.                                        01250000
012600     05  PV-OTBND-CART-SHIPT-UNT-ID      PIC S9(18)V COMP-3       01260000
012700                                                    VALUE ZERO.   01270000
012800     05  PV-SHIPT-UNIT-ID                PIC  9(18).              01280000
012900     05  PV-PRNT-CART-ID                 PIC S9(18)V COMP-3       01290000
013000                                                    VALUE ZERO.   01300000
013100     05  PV-DISP-SHIPT-UNT-ID            PIC S9(18).              01310000
013200     05  PV-DISP-TCP-COUNT               PIC  9(04).              01320000
013300     05  PV-SULBXF-BRCDE-NBR.                                     01330000
013400         10  FILLER                      PIC  X(06).              01340000
013500         10  PV-SULBXF-STORE-NBR         PIC  9(03).              01350000
013600         10  FILLER                      PIC  X(13).              01360000
013700     05  PV-DISPLAY-SQLCODE              PIC S9(09).              01370000
013800     05  PV-ACTV-IND                     PIC  X(01).              01380000
013900     05  PV-ENTRIES                      PIC S9(03)  VALUE ZEROS  01390000
014000                                                     COMP-3.      01400000
014100     05  PV-SQL-CODE                     PIC 9(09).               01410000
014200     05  PV-HOLD-TIMESTAMP               PIC X(26).               01420000
014300     05  PV-TIMESTAMP                    PIC X(26).               01430000
014400     05  PV-DB2-CURRENT-TMST             PIC  X(26).              01440000
014500     05  PV-CONTAINER-ID.                                         01450000
014600         10  PV-CONTAINER-00             PIC X(02).               01460000
014700         10  PV-SHIPT-UNT-ID             PIC 9(18).               01470000
014800         10  PV-CONTAINER-SPACES         PIC X(02).               01480000
014900     05  FILLER REDEFINES PV-CONTAINER-ID.                        01490000
015000         10  FILLER                      PIC X(06).               01500000
015100         10  PV-STORE-NBR                PIC 9(03).               01510000
015200         10  FILLER                      PIC X(13).               01520000
015300     05  PV-SHIPT-UNT-ID-REDEF           PIC 9(18).               01530000
015400     05  FILLER REDEFINES PV-SHIPT-UNT-ID-REDEF.                  01540000
015500         10  PV-SHIPT-UNT-ID-FIL-1       PIC 9(04).               01550000
015600         10  PV-STORE-NUMBER             PIC 9(03).               01560000
015700         10  PV-SHIPT-UNT-ID-FIL-2       PIC 9(11).               01570000
015800     05  PV-DATE.                                                 01580000
015900         10  PV-DATE-CCYY                PIC X(04).               01590000
016000         10  PV-DATE-DASH1               PIC X(01)  VALUE '-'.    01600000
016100         10  PV-DATE-MM                  PIC X(02).               01610000
016200         10  PV-DATE-DASH2               PIC X(01)  VALUE '-'.    01620000
016300         10  PV-DATE-DD                  PIC X(02).               01630000
016400     05  PV-TIME.                                                 01640000
016500         10  PV-TIME-HH                  PIC X(02).               01650000
016600         10  PV-TIME-DOT1                PIC X(01)  VALUE '.'.    01660000
016700         10  PV-TIME-MM                  PIC X(02).               01670000
016800         10  PV-TIME-DOT2                PIC X(01)  VALUE '.'.    01680000
016900         10  PV-TIME-SS                  PIC X(02).               01690000
017000     05  PV-IN-DATE                      PIC 9(08).               01700000
017100     05  FILLER REDEFINES PV-IN-DATE.                             01710000
017200         10  PV-IN-DATE-CCYY             PIC X(04).               01720000
017300         10  PV-IN-DATE-MM               PIC X(02).               01730000
017400         10  PV-IN-DATE-DD               PIC X(02).               01740000
017500     05  PV-IN-TIME                      PIC 9(06).               01750000
017600     05  FILLER REDEFINES PV-IN-TIME.                             01760000
017700         10  PV-IN-TIME-HH               PIC X(02).               01770000
017800         10  PV-IN-TIME-MM               PIC X(02).               01780000
017900         10  PV-IN-TIME-SS               PIC X(02).               01790000
018000     05  PV-CICS-RESPONSE                PIC S9(08)  VALUE ZEROS  01800000
018100                                                     COMP SYNC.   01810000
018110     05  PV-COMMAREA-LENGTH              PIC S9(04)  VALUE +0     01811000
018120                                                     COMP SYNC.   01812000
018130     05  PV-OTBND-CART-INSERT-COUNT      PIC S9(07) COMP-3        01813000
018140                                             VALUE ZERO.          01814000
018150     05  PV-OTBND-CART-DUP-COUNT         PIC S9(07) COMP-3        01815000
018160                                             VALUE ZERO.          01816000
018170     05  PV-SHUUPC-INSERT-COUNT          PIC S9(07) COMP-3        01817000
018180                                             VALUE ZERO.          01818000
018190     05  PV-SHUUPC-DUP-COUNT             PIC S9(07) COMP-3        01819000
018200                                             VALUE ZERO.          01820000
018300     05  PV-PARTIAL-TCP-COUNT            PIC S9(04)  VALUE ZEROS  01830000
018400                                                     COMP SYNC.   01840000
018500     05  PV-RETRY-COUNTER                PIC S9(04)  VALUE ZEROS  01850000
018600                                                     COMP SYNC.   01860000
018700     05  PV-TASK-X.                                               01870000
018800         10  PV-TASK                     PIC 9(07)   VALUE ZERO.  01880000
018900     05  PV-RECEIVE-LENGTH               PIC S9(04)  VALUE +0     01890000
019000                                                     COMP SYNC.   01900000
019100     05  PV-CICS-MSG-AREA                PIC  X(80)  VALUE SPACE. 01910000
019200     05  PV-CICS-MSG-HOLD.                                        01920000
019300         10  FILLER                      PIC  X(01)  VALUE SPACE. 01930000
019400         10  PV-CICS-MSG-DATA            PIC  X(79)  VALUE SPACE. 01940000
019500     05  PV-CICS-MSG-HOLD2.                                       01950000
019600         10  FILLER                      PIC  X(01)  VALUE SPACE. 01960000
019700         10  PV-CICS-MSG-DATA2           PIC  X(99)  VALUE SPACE. 01970000
019800                                                                  01980000
019900                                                                  01990000
020000     05  PV-RETCODE                      PIC  9(08)  VALUE ZEROS. 02000000
020100     05  PV-TCPLENG                      PIC  9(08)  VALUE ZEROS. 02010000
020200     05  PV-ERRNO                        PIC  9(08)  VALUE ZEROS. 02020000
020300     05  PV-TCP-BUF                      PIC  X(64)  VALUE SPACES.02030000
020400                                                                  02040000
020500     05  PV-TCP-EXP-LENGTH               PIC 9(08)   VALUE 64.    02050000
020600     05  PV-TCP-RET-LENGTH               PIC 9(08)   VALUE ZEROS. 02060000
020700     05  PV-TCP-REM-LENGTH               PIC 9(08)   VALUE ZEROS. 02070000
020800     05  PV-TCP-PRCSD-LENGTH             PIC 9(08)   VALUE ZEROS. 02080000
020900     05  PV-ABEND-CODE                   PIC S9(04)  COMP SYNC    02090000
021000                                                 VALUE ZERO.      02100000
021100     05  PV-ERROR-COUNT                  PIC 9(03)   VALUE ZERO.  02110000
021200     05  PV-SOCK-ID                      PIC 9(04).               02120000
021300     05  PV-CID-DOMAIN-LSTN              PIC 9(08).               02130000
021400     05  PV-NBR-BYTES                    PIC 9(08).               02140000
021500                                                                  02150000
021600*                                                                 02160000
021700*                                                                 02170000
021800 01  PT-MSG-TABLE.                                                02180000
021900     05  PT-MESSAGES OCCURS 40 TIMES INDEXED BY PT-MSG-IDX.       02190000
022000         10  PT-MSG.                                              02200000
022100             15 PT-MESSAGE               PIC X(52).               02210000
022200             15 FILLER                   PIC X(1).                02220000
022300             15 PT-TASK                  PIC 9(07).               02230000
022400             15 FILLER                   PIC X(1).                02240000
022500                                                                  02250000
022600                                                                  02260000
022700 01  PT-TCP-RECEIVE-TABLE.                                        02270000
022800     05  PT-TCP-RECEIVE OCCURS 50 TIMES                           02280000
022900                        INDEXED BY PT-RECEIVE-IDX.                02290000
023000         10  PT-TCP-RECEIVE-CHAR         PIC X(01).               02300000
023100                                                                  02310000
023200 01  PT-TCP-ASSEMBLE-TABLE.                                       02320000
023300     05  PT-TCP-DATA-ASSEMBLE OCCURS 50 TIMES                     02330000
023400                              INDEXED BY PT-ASSEMBLE-IDX.         02340000
023500         10  PT-TCP-DATA-CHAR            PIC X(01).               02350000
023510* add select parameter before recv socket command to determine if 02351000
023520* is still active                                                 02352000
023530*                                                                 02353000
023540 01  SELECT-PARMS.                                                02354000
023550     02  SELECT-NUMFDS          PIC 9(8) COMP VALUE 1.            02355000
023560     02  SELECT-TIMEOUT.                                          02356000
023570         03  SELECT-SECS        PIC 9(8) COMP VALUE 60.           02357000
023580         03  SELECT-MILLSECS    PIC 9(8) COMP VALUE 0.            02358000
023590     02  SELECT-RD-MASK         PIC X(16).                        02359000
023591     02  SELECT-WR-MASK         PIC X(16).                        02359100
023592     02  SELECT-EX-MASK         PIC X(16).                        02359200
023593     02  SELECT-RR-MASK         PIC X(16).                        02359300
023594     02  SELECT-RW-MASK         PIC X(16).                        02359400
023595     02  SELECT-RE-MASK         PIC X(16).                        02359500
023596                                                                  02359600
023597 01  CHAR-MASK.                                                   02359700
023598     02 CHAR-STRING             PIC  X(100).                      02359800
023599                                                                  02359900
023600 01  CHAR-ARRAY REDEFINES CHAR-MASK.                              02360000
023601     02  CHAR-ENTRY-TABLE OCCURS 100 TIMES.                       02360100
023602       03  CHAR-ENTRY         PIC  X.                             02360200
023603                                                                  02360300
023604 01  BIT-MASK.                                                    02360400
023605     02  BIT-ARRAY            PIC  X(16).                         02360500
023606                                                                  02360600
023607 01  BIT-FUNCTION-CODES.                                          02360700
023608     02  CTOB                 PIC  X(4) VALUE 'CTOB'.             02360800
023609     02  BTOC                 PIC  X(4) VALUE 'BTOC'.             02360900
023610                                                                  02361000
023611 01  BIT-MASK-LENGTH          PIC  9(8) COMP VALUE 100.           02361100
023612                                                                  02361200
023613 01  BITMASK-TOKEN            PIC X(16) VALUE 'TCPIPBITMASKCOBL'. 02361300
023614 01  SOCKETS                  PIC  9(8) COMP VALUE 100.           02361400
023615 01  SOCKNO                   PIC S9(8) BINARY.                   02361500
023616 01  EZRETC                   PIC S9(8) COMP.                     02361600
023617/                                                                 02361700
023618                                                                  02361800
023619*                                                                 02361900
023620*  LISTENER QUEUE NAMES                                           02362000
023630*                                                                 02363000
023640     COPY RFWS001.                                                02364000
023650                                                                  02365000
023660*                                                                 02366000
023670*  RECORD LAYOUT BEING TRANSMITTED FROM THE CONVEYOR SYSTEM       02367000
023680*                                                                 02368000
023690     COPY SUWS053.                                                02369000
023700                                                                  02370000
023800*                                                                 02380000
023900*  LAYOUT FOR THE ABEND MODULE COMMUNICATIONS AREA                02390000
024000*                                                                 02400000
024100     COPY DPWS013.                                                02410000
024200                                                                  02420000
024300*                                                                 02430000
024400*  RECORD LAYOUT FOR SYSTEM MESSAGES FILE USED FOR CICS MESSAGES  02440000
024500*                                                                 02450000
024600     COPY DPRD507I.                                               02460000
024700                                                                  02470000
024800*                                                                 02480000
024900*  FORMATS CICS SYSTEM MESSAGES FOR NON-ARCHITECTURE PROGRAMS     02490000
025000*                                                                 02500000
025100     COPY DPWS011.                                                02510000
025200                                                                  02520000
025300*                                                                 02530000
025400*  DATE VALIDATION CALLING PARAMETER LIST                        *02540000
025500*                                                                 02550000
025600     COPY DPWS500.                                                02560000
025700                                                                  02570000
026300*                                                                 02630000
026400*  DCLGEN LAYOUT AND COBOL DECLARATION FOR PARM TABLE             02640000
026500*  PARM TABLE                                                     02650000
026600     EXEC SQL                                                     02660000
026700          INCLUDE TKRPRPM                                         02670000
026800     END-EXEC.                                                    02680000
026900                                                                  02690000
027000*                                                                 02700000
027100*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE DIVERT REASON CODE 02710000
027200*  TABLE (SUT_ACM_DIVERT_RSN)                                     02720000
027300     EXEC SQL                                                     02730000
027400         INCLUDE SUT00047                                         02740000
027500     END-EXEC.                                                    02750000
027600                                                                  02760000
027700*                                                                 02770000
027800*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE CARTON PROCESSED   02780000
027900*  MESSAGE (SUT_CART_PRCD_MSG)                                    02790000
028000     EXEC SQL                                                     02800000
028100         INCLUDE SUT00044                                         02810000
028200     END-EXEC.                                                    02820000
028300                                                                  02830000
028400                                                                  02840000
028500                                                                  02850000
028600*                                                                 02860000
028700*  COMMUNICATIONS AREA FOR DB2                                    02870000
028800*                                                                 02880000
028900     EXEC SQL                                                     02890000
029000         INCLUDE SQLCA                                            02900000
029100     END-EXEC.                                                    02910000
029200     COPY SQLCA2.                                                 02920000
029300*                                                                 02930000
029400 01  PC-PROGRAM-CONSTANTS.                                        02940000
029500     05  PC-CURRENT-PROGRAM-NAME         PIC  X(08)  VALUE        02950000
029600         'SUKCS780'.                                              02960000
029700*    05  PC-CALENDAR-PGM                 PIC  X(08)  VALUE        02970000
029800*        'DPKUT500'.                                              02980000
029900*                                                                 02990000
030000 01  PS-PROGRAM-SWITCHES.                                         03000000
030100     05  PS-ACTIVE-XREF-ROW-FOUND-SW     PIC  X(01)  VALUE 'Y'.   03010000
030200         88  PS-ACTIVE-XREF-ROW-FOUND                VALUE 'Y'.   03020000
030300         88  PS-ACTIVE-XREF-ROW-NOT-FOUND            VALUE 'N'.   03030000
030400*                                                                 03040000
030500                                                                  03050000
030600**                                                                03060000
030700 PROCEDURE DIVISION.                                              03070000
030800                                                                  03080000
030900 0000-PROGRAM-MAINLINE.                                           03090000
031000                                                                  03100000
031100     MOVE ' 0000-PROGRAM-MAINLINE'                                03110000
031200                                 TO DP013-PARAGRAPH.              03120000
031300     MOVE EIBTASKN               TO PV-TASK                       03130000
031400     STRING ' SUKCS780 STARTED - TASK = ' PV-TASK-X               03140000
031500         DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                  03150000
031600     PERFORM 9990-WRITE-CICS                                      03160000
031700                                                                  03170000
031800     MOVE SPACES                 TO PT-MSG-TABLE.                 03180000
031900     SET PT-MSG-IDX              TO 1.                            03190000
032000     MOVE EIBTASKN               TO PT-TASK(PT-MSG-IDX)           03200000
032100     MOVE ' SUKCS780 - STARTED'  TO PT-MESSAGE(PT-MSG-IDX)        03210000
032200                                                                  03220000
032300     PERFORM 1000-GET-COMMAREA-FROM-LSTNR.                        03230000
032400                                                                  03240000
032500* JUST FOR TESTING - BEGIN                                        03250000
032600     STRING ' COMMAREA = ' DP081-LSTN-TCPSOCKET-PARM              03260000
032700         DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                  03270000
032800     PERFORM 9990-WRITE-CICS                                      03280000
032900* JUST FOR TESTING - END                                          03290000
033000                                                                  03300000
033100     PERFORM 1100-TAKE-SOCKET.                                    03310000
033200                                                                  03320000
033300     PERFORM 1200-CONFIRM-CONNECTION.                             03330000
033400     PERFORM 1300-SOCKET-TIMEOUT-PARM.                            03340000
033500                                                                  03350000
033600     MOVE PV-TIMESTAMP     TO PV-HOLD-TIMESTAMP.                  03360000
033700     IF PS-PARM-REC-FOUND                                         03370000
033800         IF KRPRPM-FUNC-TXT = 'Y'                                 03380000
033900             SET PS-LOG-TO-ERR-FILE  TO TRUE                      03390000
034000         ELSE                                                     03400000
034100             SET PS-DO-NOT-LOG      TO TRUE                       03410000
034200         END-IF                                                   03420000
034300     ELSE                                                         03430000
034400         SET PS-DO-NOT-LOG      TO TRUE                           03440000
034500     END-IF.                                                      03450000
034600     PERFORM 9000-SYNCPOINT.                                      03460000
034700                                                                  03470000
034800     PERFORM 2000-PROCESS-DIVERT-REQUEST                          03480000
034900         UNTIL PS-ERROR-RECEIVE.                                  03490000
035000* JUST FOR TESTING - BEGIN                                        03500000
035100*    INITIALIZE PV-CICS-MSG-AREA                                  03510000
035200*    STRING ' BEGIN OF GOOD CLOSE SOCKET '                        03520000
035300*                TCP-BUF                                          03530000
035400*    DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                     03540000
035500*    PERFORM 9990-WRITE-CICS.                                     03550000
035600* JUST FOR TESTING - END                                          03560000
035700                                                                  03570000
035800     PERFORM 1500-CLOSE-SOCKET.                                   03580000
035900                                                                  03590000
036000     SET PT-MSG-IDX              UP BY 1.                         03600000
036100     MOVE EIBTASKN               TO PT-TASK(PT-MSG-IDX)           03610000
036200     MOVE ' SUKCS780 - CLOSE SOCKET OK'                           03620000
036300                                 TO PT-MESSAGE(PT-MSG-IDX)        03630000
036400                                                                  03640000
036500     STRING ' SUKCS780 SUCCESSFUL - TASK = ' PV-TASK-X            03650000
036600         DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                  03660000
036700     PERFORM 9990-WRITE-CICS                                      03670000
036800                                                                  03680000
036900     GOBACK.                                                      03690000
037000/                                                                 03700000
037100************************************************************      03710000
037200* THE LISTENER HAS BEEN STARTED AND A SOCKET HAS BEEN      *      03720000
037300* ESTABLISHED WITHIN THE LISTENER PROGRAM.  THE LISTENER   *      03730000
037400* PROGRAM IN TURN WILL START THIS PROGRAM, SO WE MUST      *      03740000
037500* DO A RETREIVE TO GET THE COMMAREA WHICH WAS PASSED.      *      03750000
037600************************************************************      03760000
037700 1000-GET-COMMAREA-FROM-LSTNR.                                    03770000
037800     MOVE ' 1000-GET-COMMAREA-FROM-LSTNR'                         03780000
037900                                 TO DP013-PARAGRAPH.              03790000
038000     MOVE LENGTH OF DP081-LSTN-TCPSOCKET-PARM                     03800000
038100                                          TO  PV-RECEIVE-LENGTH.  03810000
038200                                                                  03820000
038300     EXEC CICS                                                    03830000
038400         RETRIEVE                                                 03840000
038500             INTO    (DP081-LSTN-TCPSOCKET-PARM)                  03850000
038600             LENGTH  (PV-RECEIVE-LENGTH)                          03860000
038700             RESP    (PV-CICS-RESPONSE)                           03870000
038800     END-EXEC.                                                    03880000
038900                                                                  03890000
039000     EVALUATE TRUE                                                03900000
039100         WHEN PV-CICS-RESPONSE = DFHRESP (NORMAL)                 03910000
039200             CONTINUE                                             03920000
039300         WHEN OTHER                                               03930000
039400             MOVE ' 1000-GET-COMMAREA-FROM-LSTNR'                 03940000
039500                 TO DP013-PARAGRAPH                               03950000
039600             MOVE 'UNABLE TO RETRIEVE COMMAREA FROM LISTENER'     03960000
039700                 TO DP013-MESSAGE-TEXT (1)                        03970000
039800             SET DP013-CICS-ABEND   TO  TRUE                      03980000
039900             SET DP013-NO-ROLLBACK  TO  TRUE                      03990000
040000             PERFORM 9999-WRITE-CICS-LOG-MSG                      04000000
040100     END-EVALUATE.                                                04010000
040200/                                                                 04020000
040300*----------------------------------------------------------------*04030000
040400*  ACQUIRE A SOCKET FROM ANOTHER PROGRAM AND CREATE A NEW SOCKET.*04040000
040500*----------------------------------------------------------------*04050000
040600 1100-TAKE-SOCKET.                                                04060000
040700                                                                  04070000
040800     MOVE ' 1100-TAKE-SOCKET'                                     04080000
040900                                 TO DP013-PARAGRAPH.              04090000
041000* JUST FOR TESTING - BEGIN                                        04100000
041100     STRING '1100-TAKE-SOCKET' DELIMITED BY SIZE                  04110000
041200     INTO PV-CICS-MSG-AREA                                        04120000
041300     PERFORM 9990-WRITE-CICS                                      04130000
041400* JUST FOR TESTING - END                                          04140000
041500                                                                  04150000
041600     MOVE DP081-AF-INET               TO DP081-CID-DOMAIN-LSTN.   04160000
041700     MOVE DP081-LSTN-NAME             TO DP081-CID-NAME-LSTN.     04170000
041800****TESTING - BEGIN                                               04180000
041900         SET PT-MSG-IDX              UP BY 1                      04190000
042000         MOVE DP081-CID-DOMAIN-LSTN   TO PV-CID-DOMAIN-LSTN       04200000
042100****TESTING - END                                                 04210000
042200     MOVE DP081-LSTN-SUBTASKNAME      TO                          04220000
042300                                       DP081-CID-SUBTASKNAME-LSTN.04230000
042400     MOVE DP081-LSTN-GIVE-TAKE-SOCKET TO DP081-SOCK-ID.           04240000
042500****TESTING - BEGIN                                               04250000
042600         SET PT-MSG-IDX              UP BY 1                      04260000
042700         STRING                                                   04270000
042800              '1100-TAKE-SOCKET-RES '     DELIMITED BY SIZE       04280000
042900              DP081-CID-RES-LSTN          DELIMITED BY SIZE       04290000
043000                              INTO PT-MESSAGE(PT-MSG-IDX)         04300000
043100****TESTING - END                                                 04310000
043200     CALL 'EZASOKET'                                              04320000
043300         USING                                                    04330000
043400                DP081-TAKESOCKET-CMD                              04340000
043500                DP081-SOCK-ID                                     04350000
043600                DP081-CLIENTID-LSTN                               04360000
043700                DP081-ERRNO                                       04370000
043800                DP081-RETCODE.                                    04380000
043900                                                                  04390000
044000* IF THE TAKESOCKET IS SUCCESSFUL, THE NEW SOCKET ID IS           04400000
044100*  CONTAINED IN THE RETCODE                                       04410000
044200                                                                  04420000
044300     IF DP081-RETCODE >= ZERO                                     04430000
044400         MOVE DP081-RETCODE           TO DP081-SOCK-ID            04440000
044500     ELSE                                                         04450000
044600         MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        04460000
044700         SET  DP081-TCP-IP-TAKE-ERR TO TRUE                       04470000
044800*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE04480000
044900*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  04490000
045000*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               04500000
045100*   DP013-MESSAGE-TEXT GROUP LEVEL.                               04510000
045200         COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          04520000
045300         SET  DP013-OTHER-ABEND   TO TRUE                         04530000
045400         SET  DP013-NO-ROLLBACK   TO TRUE                         04540000
045500         MOVE ' 1100-TAKE-SOCKET' TO DP013-PARAGRAPH              04550000
045600         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  04560000
045700         PERFORM 9999-WRITE-CICS-LOG-MSG                          04570000
045800     END-IF.                                                      04580000
045900/                                                                 04590000
046000*----------------------------------------------------------------*04600000
046100*    CONFIRM THE CONNECTION ON THE SOCKET THAT WE RECEIVED FROM  *04610000
046200*    THE PACK TO LIGHT SYSTEM.                                   *04620000
046300*----------------------------------------------------------------*04630000
046400 1200-CONFIRM-CONNECTION.                                         04640000
046500                                                                  04650000
046600     MOVE ' 1200-CONFIRM-CONNECTION'                              04660000
046700                                 TO DP013-PARAGRAPH.              04670000
046800* JUST FOR TESTING - BEGIN                                        04680000
046900     STRING '1200-CONFIRM-CONNECTION' DELIMITED BY SIZE           04690000
047000     INTO PV-CICS-MSG-AREA                                        04700000
047100     PERFORM 9990-WRITE-CICS                                      04710000
047200* JUST FOR TESTING - END                                          04720000
047300                                                                  04730000
047400     MOVE SPACES  TO  TCP-BUF2.                                   04740000
047500     MOVE PC-CR    TO TASK-START-CR.                              04750000
047600     MOVE EIBTRNID TO TASK-START-TRAN.                            04760000
047700     MOVE TASK-START TO TCP-BUF.                                  04770000
047800     MOVE 32      TO  DP081-NBR-BYTES                             04780000
047900                      DP081-TCPLENG.                              04790000
048000                                                                  04800000
048100* JUST FOR TESTING - BEGIN                                        04810000
048200     STRING TCP-BUF  DELIMITED BY SIZE                            04820000
048300     INTO PV-CICS-MSG-AREA                                        04830000
048400     PERFORM 9990-WRITE-CICS                                      04840000
048500* JUST FOR TESTING - END                                          04850000
048600                                                                  04860000
048700* TRANSLATE EBCDIC TO ASCII                                       04870000
048800     CALL 'EZACIC04'                                              04880000
048900         USING  DP081-TOASCII-TOKEN                               04890000
049000                TCP-BUF                                           04900000
049100                DP081-TCPLENG.                                    04910000
049200                                                                  04920000
049300* WRITE DATA ON A CONNECTED SOCKET                                04930000
049400     CALL 'EZASOKET'                                              04940000
049500         USING  DP081-WRITE-CMD                                   04950000
049600                DP081-SOCK-ID                                     04960000
049700                DP081-NBR-BYTES                                   04970000
049800                TCP-BUF                                           04980000
049900                DP081-ERRNO                                       04990000
050000                DP081-RETCODE.                                    05000000
050100*                                                                 05010000
050200     IF DP081-RETCODE < ZERO                                      05020000
050300         MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        05030000
050400         SET  DP081-TCP-IP-WRITE-ERR TO TRUE                      05040000
050500*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         05050000
050600*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE05060000
050700*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  05070000
050800*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               05080000
050900*   DP013-MESSAGE-TEXT GROUP LEVEL.                               05090000
051000         COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          05100000
051100         SET  DP013-OTHER-ABEND   TO TRUE                         05110000
051200         SET  DP013-NO-ROLLBACK   TO TRUE                         05120000
051300         MOVE ' 1200-CONFIRM-CONNECTION'                          05130000
051400             TO DP013-PARAGRAPH                                   05140000
051500         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  05150000
051600         PERFORM 9999-WRITE-CICS-LOG-MSG                          05160000
051700     END-IF.                                                      05170000
051800******************************************************************05180000
051900******************************************************************05190000
052000 1300-SOCKET-TIMEOUT-PARM.                                        05200000
052100                                                                  05210000
052200     EXEC SQL                                                     05220000
052300          SELECT  FUNC_QTY                                        05230000
052400            INTO :KRPRPM-FUNC-QTY                                 05240000
052500            FROM  TKRPRPM                                         05250000
052600           WHERE  LOC_ID            = 090                         05260000
052610             AND  SYS_PRC_FUNC_CDE  = 'SCKTM5'                    05261000
052620             AND  FUNC_PRC_STAT_CDE = 'AC'                        05262000
052630             AND  INTFC_SYS_CDE     = 'KHL'                       05263000
052640     END-EXEC.                                                    05264000
052650                                                                  05265000
052660     EVALUATE TRUE                                                05266000
052670                                                                  05267000
052680         WHEN SQLCODE = +0                                        05268000
052690              MOVE KRPRPM-FUNC-QTY  TO  SELECT-SECS               05269000
052700                                                                  05270000
052701         WHEN SQLCODE = +100                                      05270100
052702              CONTINUE                                            05270200
052703                                                                  05270300
052704       WHEN SQLWARN0 NOT = SPACES                                 05270400
052705       WHEN SQLCODE NOT EQUAL ZERO                                05270500
052706           MOVE '1300-SOCKET-TIMEOUT-PARM  '                      05270600
052707                           TO DP013-PARAGRAPH                     05270700
052708           MOVE 'CHECK SOCKET TIMEOUT '                           05270800
052709                           TO DP013-MESSAGE-TEXT(1)               05270900
052710           MOVE SQLCA      TO DP013-SQLCA                         05271000
052711           MOVE 'TKRPRPM'  TO DP013-DB2-TABLE-NAME(1)             05271100
052712           PERFORM 9999-WRITE-CICS-LOG-MSG                        05271200
052713     END-EVALUATE.                                                05271300
052714                                                                  05271400
052715*----------------------------------------------------------------*05271500
052716*    CLOSE THE SOCKET GIVEN TO US BY THE PACK TO LIGHT SYSTEM.   *05271600
052717*----------------------------------------------------------------*05271700
052718 1500-CLOSE-SOCKET.                                               05271800
052719                                                                  05271900
052720     MOVE ' 1500-CLOSE-SOCKET'                                    05272000
052730                                 TO DP013-PARAGRAPH.              05273000
052740* JUST FOR TESTING - BEGIN                                        05274000
052750*    STRING '1500-CLOSE-SOCKET' DELIMITED BY SIZE                 05275000
052760*    INTO PV-CICS-MSG-AREA                                        05276000
052770*    PERFORM 9990-WRITE-CICS                                      05277000
052780* JUST FOR TESTING - END                                          05278000
052790                                                                  05279000
052800* CLOSE THE CONNECTED SOCKET                                      05280000
052900     SET PS-SOCKET-CLOSED   TO TRUE.                              05290000
053000                                                                  05300000
053100     CALL 'EZASOKET'                                              05310000
053200         USING                                                    05320000
053300                DP081-CLOSE-CMD                                   05330000
053400                DP081-SOCK-ID                                     05340000
053500                DP081-ERRNO                                       05350000
053600                DP081-RETCODE.                                    05360000
053700                                                                  05370000
053800     IF DP081-RETCODE < ZERO                                      05380000
053900         MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        05390000
054000         SET  DP081-TCP-IP-CLOSE-ERR TO TRUE                      05400000
054100*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         05410000
054200*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE05420000
054300*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  05430000
054400*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               05440000
054500*   DP013-MESSAGE-TEXT GROUP LEVEL.                               05450000
054600         COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          05460000
054700         SET  DP013-OTHER-ABEND   TO TRUE                         05470000
054800         SET  DP013-NO-ROLLBACK   TO TRUE                         05480000
054900         MOVE ' 1500-CLOSE-SOCKET'                                05490000
055000             TO DP013-PARAGRAPH                                   05500000
055100         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  05510000
055200         PERFORM 9999-WRITE-CICS-LOG-MSG                          05520000
055300     END-IF.                                                      05530000
055400/                                                                 05540000
055500******************************************************************05550000
055600******************************************************************05560000
055700 2000-PROCESS-DIVERT-REQUEST.                                     05570000
055800                                                                  05580000
055900     MOVE ' 2000-PROCESS-DIVERT-REQUEST'                          05590000
056000                                 TO DP013-PARAGRAPH.              05600000
056100******************************************************************05610000
056200**CHECK SOCKET CONNECTION                                        *05620000
056300******************************************************************05630000
056400                                                                  05640000
056500                                                                  05650000
056600     PERFORM 2100-RECEIVE-DATA-FROM-QNX                           05660000
056700                                                                  05670000
056800     IF NOT PS-ERROR-RECEIVE                                      05680000
056900                                                                  05690000
057000       MOVE SU053-DC-NUMBER           TO SUT00044-DC-NBR          05700000
057100       MOVE SU053-KOHLS-SML           TO SUT00044-KOHLS-BRCDE-NBR 05710000
057200       MOVE SU053-MESSAGE-SEQ-NUMBER  TO SUT00044-ACM-MSG-SEQ-NBR 05720000
057300       MOVE SU053-CRTN-PROCESS-STATUS TO SUT00044-DIVERT-IND      05730000
057400       MOVE SU053-CRTN-REJECT-CAUSE                               05740000
057500                                    TO SUT00044-ACM-DIVERT-RSN-CDE05750000
057600       MOVE SU053-ACCM-LINE-NMBR      TO SUT00044-ACM-LBL-STA-NBR 05760000
057700       MOVE SU053-INDUCT-DATE (1:4)  TO  PV-DATE-CCYY             05770000
057800       MOVE SU053-INDUCT-DATE (5:2)  TO  PV-DATE-MM               05780000
057900       MOVE SU053-INDUCT-DATE (7:2)  TO  PV-DATE-DD               05790000
058000       MOVE PV-DATE                  TO  SUT00044-ACM-CART-RCV-DTE05800000
058100       MOVE SU053-INDUCT-TIME (1:2)  TO  PV-TIME-HH               05810000
058200       MOVE SU053-INDUCT-TIME (3:2)  TO  PV-TIME-MM               05820000
058300       MOVE SU053-INDUCT-TIME (5:2)  TO  PV-TIME-SS               05830000
058400       MOVE PV-TIME                  TO  SUT00044-ACM-CART-RCV-TM 05840000
058500       MOVE SU053-EXIT-DATE (1:4)    TO  PV-DATE-CCYY             05850000
058600       MOVE SU053-EXIT-DATE (5:2)    TO  PV-DATE-MM               05860000
058700       MOVE SU053-EXIT-DATE (7:2)    TO  PV-DATE-DD               05870000
058800       MOVE PV-DATE                TO  SUT00044-ACM-CART-SCND-DTE 05880000
058900       MOVE SU053-EXIT-TIME (1:2)    TO  PV-TIME-HH               05890000
059000       MOVE SU053-EXIT-TIME (3:2)    TO  PV-TIME-MM               05900000
059100       MOVE SU053-EXIT-TIME (5:2)    TO  PV-TIME-SS               05910000
059200       MOVE PV-TIME                  TO  SUT00044-ACM-CART-SCND-TM05920000
059300                                                                  05930000
059400       PERFORM 4000-INSERT-CRTN-PROC-REC                          05940000
059500*  IF ALL OPERATIONS WERE SUCCESSFUL UP TO THIS POINT, THIS       05950000
059600*  COMPLETES A LOGICAL UNIT OF WORK.  ABENDS WILL NOT INCLUDE     05960000
059700*  A ROLLBACK COMMAND BECAUSE ANY RETRANSMISSION WILL OVERLAY     05970000
059800*  THE PACK VALUES.                                               05980000
059900                                                                  05990000
060000       PERFORM 9000-SYNCPOINT                                     06000000
060100     END-IF.                                                      06010000
060200                                                                  06020000
060300*    PERFORM 2500-SEND-CONFIRMATION-QNX.                          06030000
060400*    MOVE PV-PARTIAL-TCP-COUNT TO PV-DISP-TCP-COUNT.              06040000
060500*    INITIALIZE PV-CICS-MSG-AREA.                                 06050000
060600*    STRING ' SUKCS780: 2000- COUNT = '                           06060000
060700*            PV-DISP-TCP-COUNT                                    06070000
060800*            ' CODE = '                                           06080000
060900*            DK-ERROR-CODE                                        06090000
061000*               DELIMITED BY SIZE                                 06100000
061100*                          INTO PV-CICS-MSG-AREA.                 06110000
061200*    PERFORM 9990-WRITE-CICS.                                     06120000
061300*    IF PV-PARTIAL-TCP-COUNT > 4 AND                              06130000
061400*       (DK-ERROR-CODE = '101' OR                                 06140000
061500*        DK-ERROR-CODE = '102')                                   06150000
061600*        SET PS-ERROR-RECEIVE TO TRUE                             06160000
061700*    END-IF.                                                      06170000
061800*                                                                 06180000
061900*                                                                 06190000
062000*----------------------------------------------------------------*06200000
062100*    RECEIVE THE DATA FROM THE PACK TO LIGHT SYSTEM.  THIS DATA  *06210000
062200*    WILL CONSIST OF A HEADER RECORD CONTAINING INFORMATION ON   *06220000
062300*    WHEN THE LINE WAS COMPLETED IN THE PACK TO LIGHT SYSTEM.    *06230000
062400*    DETAIL RECORDS ARE ALSO SENT FOR EACH STORE ON THE RECEIVER *06240000
062500*    LINE CONTAINING THE NUMBER OF PIECES PROCESSED.  A TRAILER  *06250000
062600*    RECORD IS SENT CONTAINING THE NUMBER OF STORE RECORDS THAT  *06260000
062700*    WERE SENT TO BE USED FOR CROSS-CHECK VALIDATION.            *06270000
062800*----------------------------------------------------------------*06280000
062900 2100-RECEIVE-DATA-FROM-QNX.                                      06290000
063000                                                                  06300000
063100     MOVE ' 2100-RECEIVE-DATA-FROM-QNX'                           06310000
063200                                 TO DP013-PARAGRAPH.              06320000
063300     SET PS-START-RECEIVE TO TRUE.                                06330000
063400     MOVE ZEROS   TO  PV-TCP-RET-LENGTH                           06340000
063500                      PV-TCP-REM-LENGTH                           06350000
063600                      PV-TCP-PRCSD-LENGTH.                        06360000
063700     MOVE SPACES  TO  TCP-BUF2                                    06370000
063800                      PT-TCP-RECEIVE-TABLE                        06380000
063900                      PT-TCP-ASSEMBLE-TABLE.                      06390000
064000     MOVE PV-TCP-EXP-LENGTH TO DP081-TCPLENG                      06400000
064100                               DP081-NBR-BYTES.                   06410000
064200                                                                  06420000
064300     PERFORM 2800-CHECK-SOCKET-CONNECTION                         06430000
064400                                                                  06440000
064500     IF NOT PS-ERROR-RECEIVE                                      06450000
064600        PERFORM 3000-RECEIVE-TCP                                  06460000
064700            UNTIL PS-COMP-RECEIVE                                 06470000
064800                                                                  06480000
064900        INITIALIZE SU053-CRTN-PROCESSED-RECORD                    06490000
065000                                                                  06500000
065100       MOVE TCP-BUF2               TO SU053-CRTN-PROCESSED-RECORD 06510000
065200     END-IF.                                                      06520000
065300                                                                  06530000
065400                                                                  06540000
065500* JUST FOR TESTING - BEGIN                                        06550000
065600*    INITIALIZE PV-CICS-MSG-AREA.                                 06560000
065700*    STRING ' SUKCS780:'                                          06570000
065800*         TCP-BUF2                                                06580000
065900*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                 06590000
066000*    PERFORM 9990-WRITE-CICS.                                     06600000
066100*                                                                 06610000
066200*    INITIALIZE PV-CICS-MSG-AREA.                                 06620000
066300*    MOVE DP081-RETCODE TO PV-RETCODE.                            06630000
066400*    MOVE DP081-TCPLENG TO PV-TCPLENG.                            06640000
066500*    MOVE DP081-ERRNO   TO PV-ERRNO.                              06650000
066600*                                                                 06660000
066700*    STRING ' SUKCS780:'                                          06670000
066800*         ' DC='                                                  06680000
066900*         SU014-DC-NUMBER                                         06690000
067000*         ' SEQ='                                                 06700000
067100*         SU014-MESSAGE-SEQ-NUMBER                                06710000
067200*         ' LIST='                                                06720000
067300*         SU014-LISTENER-CODE                                     06730000
067400*         ' BAR='                                                 06740000
067500*         SU014-BAR-CODE                                          06750000
067600*         ' DIV='                                                 06760000
067700*         SU014-DIVERT-NUMBER                                     06770000
067800*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                 06780000
067900*    PERFORM 9990-WRITE-CICS.                                     06790000
068000*    STRING ' SUKCS780:'                                          06800000
068100*         ' DAT='                                                 06810000
068200*         SU014-DATE                                              06820000
068300*         ' TIM='                                                 06830000
068400*         SU014-TIME                                              06840000
068500*         ' MSG='                                                 06850000
068600*         SU014-MESSAGE-NUMBER                                    06860000
068700*         ' RETCODE='                                             06870000
068800*         PV-RETCODE                                              06880000
068900*         ' TCPLENG='                                             06890000
069000*         PV-TCPLENG                                              06900000
069100*         ' ERRNO='                                               06910000
069200*         PV-ERRNO                                                06920000
069300*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                 06930000
069400*    PERFORM 9990-WRITE-CICS.                                     06940000
069500* JUST FOR TESTING - END                                          06950000
069600                                                                  06960000
069700*----------------------------------------------------------------*06970000
069800*    SEND A CONFIRMATION RECORD TO THE PACK TO LIGHT SYSTEM TO   *06980000
069900*    POSITIVELY ACKNOWLEDGE THE RECEIPT OF A RECORD FROM THEM.   *06990000
070000*----------------------------------------------------------------*07000000
070100*2500-SEND-CONFIRMATION-QNX.                                      07010000
070200*                                                                 07020000
070300*    MOVE ' 2500-SEND-CONFIRMATION-QNX'                           07030000
070400*                                TO DP013-PARAGRAPH.              07040000
070500* JUST FOR TESTING - BEGIN                                        07050000
070600*    STRING '2500-SEND-CONFIRMATION-QNX' DELIMITED BY SIZE        07060000
070700*    INTO PV-CICS-MSG-AREA.                                       07070000
070800*    PERFORM 9990-WRITE-CICS.                                     07080000
070900* JUST FOR TESTING - END                                          07090000
071000*                                                                 07100000
071100*    MOVE SPACES              TO TCP-BUF2.                        07110000
071200*    MOVE SU014-DC-NUMBER     TO SU015-DC-NUMBER.                 07120000
071300*    MOVE SU014-MESSAGE-SEQ-NUMBER                                07130000
071400*                             TO SU015-MESSAGE-SEQ-NUMBER.        07140000
071500*    SET SU015-ACKNOWLEDGE    TO TRUE                             07150000
071600*    MOVE PC-CR               TO SU015-CARRIAGE-RETURN.           07160000
071700*    MOVE SU015-CONV-DIVERT-RECORD TO TCP-BUF.                    07170000
071800*    MOVE 64                  TO                                  07180000
071900*                                DP081-NBR-BYTES                  07190000
072000*                                DP081-TCPLENG.                   07200000
072100*                                                                 07210000
072200* JUST FOR TESTING - BEGIN                                        07220000
072300*    INITIALIZE PV-CICS-MSG-AREA.                                 07230000
072400*    STRING ' SUKCS780:SEND GOOD CONFIRM '                        07240000
072500*                 TCP-BUF                                         07250000
072600*     DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                    07260000
072700*     PERFORM 9990-WRITE-CICS.                                    07270000
072800* JUST FOR TESTING - BEGIN                                        07280000
072900*                                                                 07290000
073000* TRANSLATE EBCDIC TO ASCII                                       07300000
073100*    CALL 'EZACIC04'                                              07310000
073200*        USING  DP081-TOASCII-TOKEN                               07320000
073300*               TCP-BUF                                           07330000
073400*               DP081-TCPLENG.                                    07340000
073500*                                                                 07350000
073600* WRITE DATA ON A CONNECTED SOCKET                                07360000
073700*    CALL 'EZASOKET'                                              07370000
073800*        USING                                                    07380000
073900*               DP081-WRITE-CMD                                   07390000
074000*               DP081-SOCK-ID                                     07400000
074100*               DP081-NBR-BYTES                                   07410000
074200*               TCP-BUF                                           07420000
074300*               DP081-ERRNO                                       07430000
074400*               DP081-RETCODE.                                    07440000
074500*                                                                 07450000
074600*                                                                 07460000
074700*    IF DP081-RETCODE < ZERO                                      07470000
074800*        INITIALIZE PV-CICS-MSG-AREA                              07480000
074900*        STRING ' SUKCS780 - '                                    07490000
075000*               '1400- BAD RETURN CODE      '                     07500000
075100*                    TCP-BUF                                      07510000
075200*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA                  07520000
075300*        PERFORM 9990-WRITE-CICS                                  07530000
075400*        MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        07540000
075500*        SET  DP081-TCP-IP-SEND-TO-ERR TO TRUE                    07550000
075600*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         07560000
075700*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE07570000
075800*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  07580000
075900*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               07590000
076000*   DP013-MESSAGE-TEXT GROUP LEVEL.                               07600000
076100*        COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          07610000
076200*        SET  DP013-OTHER-ABEND   TO TRUE                         07620000
076300*        SET  DP013-NO-ROLLBACK   TO TRUE                         07630000
076400*        MOVE ' 2500-SEND-CONFIRMATION-QNX'                       07640000
076500*            TO DP013-PARAGRAPH                                   07650000
076600*        MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  07660000
076700*        PERFORM 9999-WRITE-CICS-LOG-MSG                          07670000
076800*    END-IF.                                                      07680000
076900/                                                                 07690000
077000                                                                  07700000
077100*----------------------------------------------------------------*07710000
077200*    THIS PARAGRAPH WILL CONTROL THE RECEIVES TO CAPTURE ALL     *07720000
077300*    OF THE DATA BEING PASSED TO THE MAINFRAME FROM THE QNX      *07730000
077400*    SYSTEM.  THIS PARAGRAPH IS WRITTEN WITH THE UNDERSTANDING   *07740000
077500*    THAT A RECEIVE COMMAND MAY OR MAY NOT BRING BACK AN ENTIRE  *07750000
077600*    SOCKET PACKET OF DATA.  WE ARE EXPECTING A BLOCK OF 50      *07760000
077700*    CHARACTERS TO BE RECEIVED, HOWEVER, IF LESS THAN 50 ARE     *07770000
077800*    RECEIVED, THEN THIS PARAGRAPH WILL LOOP UNTIL THE ENTIRE    *07780000
077900*    FIFTY IS RECEIVED.                                          *07790000
078000*----------------------------------------------------------------*07800000
078100                                                                  07810000
078200 2800-CHECK-SOCKET-CONNECTION.                                    07820000
078300                                                                  07830000
078310     MOVE ' 2800-CHECK-SOCKET-CONNECTION '                        07831000
078320                                 TO DP013-PARAGRAPH.              07832000
078330                                                                  07833000
078340                                                                  07834000
078350* ZERO OUT ALL OUTPUT BIT MASKS FOR SELECT                        07835000
078360     PERFORM VARYING SOCKNO FROM 1 BY 1 UNTIL SOCKNO > SOCKETS    07836000
078370        MOVE '0' TO CHAR-ENTRY(SOCKNO)                            07837000
078380     END-PERFORM.                                                 07838000
078390     PERFORM 2900-CHAR-TO-BIT.                                    07839000
078391     MOVE BIT-MASK TO SELECT-RR-MASK.                             07839100
078392     MOVE BIT-MASK TO SELECT-RW-MASK.                             07839200
078393     MOVE BIT-MASK TO SELECT-RE-MASK.                             07839300
078394     MOVE BIT-MASK TO SELECT-EX-MASK.                             07839400
078395     MOVE BIT-MASK TO SELECT-WR-MASK.                             07839500
078396                                                                  07839600
078397* set all input bit masks for select to 1                         07839700
078398     PERFORM VARYING SOCKNO FROM 1 BY 1 UNTIL SOCKNO > SOCKETS    07839800
078399        MOVE '1' TO CHAR-ENTRY(SOCKNO)                            07839900
078400     END-PERFORM.                                                 07840000
078401     PERFORM 2900-CHAR-TO-BIT.                                    07840100
078402     MOVE BIT-MASK TO SELECT-RD-MASK.                             07840200
078403*                                                                 07840300
078404* ISSUE THE SELECT COMMAND ----------------------------           07840400
078405* SELECT WILL FLIP A BIT IN THE READ MASK TO '1' FOR ANY          07840500
078406* SOCKET THAT HAS DATA TO BE PROCESSED.                           07840600
078407*                                                                 07840700
078408                                                                  07840800
078409     MOVE 0 TO DP081-ERRNO.                                       07840900
078410     MOVE 0 TO DP081-RETCODE.                                     07841000
078411     CALL 'EZASOKET' USING DP081-SELECT-CMD                       07841100
078412         SELECT-NUMFDS SELECT-TIMEOUT                             07841200
078413         SELECT-RD-MASK SELECT-WR-MASK SELECT-EX-MASK             07841300
078414         SELECT-RR-MASK SELECT-RW-MASK SELECT-RE-MASK             07841400
078415         DP081-ERRNO DP081-RETCODE.                               07841500
078416                                                                  07841600
078417     IF DP081-RETCODE < 0                                         07841700
078418        INITIALIZE PV-CICS-MSG-AREA                               07841800
078419        SET PS-ERROR-RECEIVE TO TRUE                              07841900
078420        MOVE DP081-RETCODE TO PV-RETCODE                          07842000
078421        MOVE DP081-NBR-BYTES TO PV-TCPLENG                        07842100
078422        MOVE DP081-ERRNO   TO PV-ERRNO                            07842200
078423        STRING ' SUKCS791:'                                       07842300
078424             'SOCKET ERROR < 0'                                   07842400
078425             ' RETCODE='                                          07842500
078426             PV-RETCODE                                           07842600
078427             ' TCPLENG='                                          07842700
078428             PV-TCPLENG                                           07842800
078429             ' ERRNO='                                            07842900
078430             PV-ERRNO                                             07843000
078431            DELIMITED BY SIZE INTO PV-CICS-MSG-AREA               07843100
078432          PERFORM 9990-WRITE-CICS                                 07843200
078433        SET PS-ERROR-RECEIVE TO TRUE                              07843300
078434                                                                  07843400
078435        INITIALIZE PV-CICS-MSG-AREA                               07843500
078436                                                                  07843600
078437        MOVE PC-CURRENT-PROGRAM-NAME    TO DP081-TCP-IP-PGM-NAME  07843700
078438        SET  DP081-TCP-IP-READ-ERR      TO TRUE                   07843800
078439        MOVE DP081-ERRNO                TO DP081-TCP-IP-ERR-NBR   07843900
078440        MOVE DP081-TCP-IP-LOGGING-MSG   TO PV-CICS-MSG-DATA       07844000
078441        MOVE PV-CICS-MSG-HOLD           TO PV-CICS-MSG-AREA       07844100
078442        MOVE LENGTH OF PV-CICS-MSG-AREA TO PV-COMMAREA-LENGTH     07844200
078443                                                                  07844300
078444        EXEC CICS                                                 07844400
078445            WRITEQ TD                                             07844500
078446                QUEUE   ('CSSL')                                  07844600
078447                FROM    (PV-CICS-MSG-AREA)                        07844700
078448                LENGTH  (PV-COMMAREA-LENGTH)                      07844800
078449                RESP    (PV-CICS-RESPONSE)                        07844900
078450        END-EXEC                                                  07845000
078451                                                                  07845100
078452                                                                  07845200
078453     ELSE                                                         07845300
078454     IF DP081-RETCODE = 0                                         07845400
078455        INITIALIZE PV-CICS-MSG-AREA                               07845500
078456        SET PS-ERROR-RECEIVE TO TRUE                              07845600
078457        MOVE DP081-RETCODE TO PV-RETCODE                          07845700
078458        MOVE DP081-NBR-BYTES TO PV-TCPLENG                        07845800
078459        MOVE DP081-ERRNO   TO PV-ERRNO                            07845900
078460        STRING ' SUKCS791:'                                       07846000
078461             'SOCKET ERROR = 0'                                   07846100
078462             ' RETCODE='                                          07846200
078463             PV-RETCODE                                           07846300
078464             ' TCPLENG='                                          07846400
078465             PV-TCPLENG                                           07846500
078466             ' ERRNO='                                            07846600
078467             PV-ERRNO                                             07846700
078468            DELIMITED BY SIZE INTO PV-CICS-MSG-AREA               07846800
078469          PERFORM 9990-WRITE-CICS                                 07846900
078470        SET PS-ERROR-RECEIVE TO TRUE                              07847000
078471                                                                  07847100
078472        INITIALIZE PV-CICS-MSG-AREA                               07847200
078473                                                                  07847300
078474        MOVE PC-CURRENT-PROGRAM-NAME    TO DP081-TCP-IP-PGM-NAME  07847400
078475        SET  DP081-TCP-IP-READ-ERR      TO TRUE                   07847500
078476        MOVE DP081-ERRNO                TO DP081-TCP-IP-ERR-NBR   07847600
078477        MOVE DP081-TCP-IP-LOGGING-MSG   TO PV-CICS-MSG-DATA       07847700
078478        MOVE PV-CICS-MSG-HOLD           TO PV-CICS-MSG-AREA       07847800
078479        MOVE LENGTH OF PV-CICS-MSG-AREA TO PV-COMMAREA-LENGTH     07847900
078480                                                                  07848000
078481        EXEC CICS                                                 07848100
078482            WRITEQ TD                                             07848200
078483                QUEUE   ('CSSL')                                  07848300
078484                FROM    (PV-CICS-MSG-AREA)                        07848400
078485                LENGTH  (PV-COMMAREA-LENGTH)                      07848500
078486                RESP    (PV-CICS-RESPONSE)                        07848600
078487        END-EXEC                                                  07848700
078488                                                                  07848800
078489     END-IF.                                                      07848900
078490                                                                  07849000
078491***************************************************************   07849100
078492* CHAR-TO-BIT                                                 *   07849200
078493* CONVERT THE CHARACTER ARRAY TO A SELECT BIT MASK SO THAT THE*   07849300
078494* COBOL PROGRAM CAN WRITE IT.                                 *   07849400
078495***************************************************************   07849500
078496 2900-CHAR-TO-BIT.                                                07849600
078497                                                                  07849700
078498     MOVE ' 2900-CHAR-TO-BIT    '                                 07849800
078499                                 TO DP013-PARAGRAPH.              07849900
078500                                                                  07850000
078510*                                                                 07851000
078511* CHAR-TO-BIT                                                     07851100
078512* CONVERT THE CHARACTER ARRAY TO A SELECT BIT MASK SO THAT THE    07851200
078513* COBOL PROGRAM CAN WRITE IT.                                     07851300
078514*                                                                 07851400
078515     CALL 'EZACIC06' USING BITMASK-TOKEN CTOB                     07851500
078516          BIT-MASK CHAR-MASK BIT-MASK-LENGTH EZRETC               07851600
078517     IF  EZRETC < 0 THEN                                          07851700
078518         MOVE '!EZCIC06 - CTOB-EXCP ' TO PV-CICS-MSG-AREA         07851800
078519         MOVE LENGTH OF PV-CICS-MSG-AREA TO PV-COMMAREA-LENGTH    07851900
078520                                                                  07852000
078521         EXEC CICS                                                07852100
078522             WRITEQ TD                                            07852200
078523                 QUEUE   ('CSSL')                                 07852300
078524                 FROM    (PV-CICS-MSG-AREA)                       07852400
078525                 LENGTH  (PV-COMMAREA-LENGTH)                     07852500
078526                 RESP    (PV-CICS-RESPONSE)                       07852600
078527         END-EXEC                                                 07852700
078528                                                                  07852800
078529         SET PS-ERROR-RECEIVE TO TRUE                             07852900
078530     END-IF.                                                      07853000
078531                                                                  07853100
078532 3000-RECEIVE-TCP.                                                07853200
078533                                                                  07853300
078534     MOVE ' 3000-RECEIVE-TCP'                                     07853400
078535                                 TO DP013-PARAGRAPH.              07853500
078536* JUST FOR TESTING - BEGIN                                        07853600
078537*    STRING '3000-RECEIVE-TCP' DELIMITED BY SIZE                  07853700
078538*    INTO PV-CICS-MSG-AREA                                        07853800
078539*    PERFORM 9990-WRITE-CICS                                      07853900
078540* JUST FOR TESTING - END                                          07854000
078550                                                                  07855000
078560     CALL 'EZASOKET'                                              07856000
078570         USING                                                    07857000
078580                DP081-RECV-CMD                                    07858000
078590                DP081-SOCK-ID                                     07859000
078600                DP081-FLAG                                        07860000
078700                DP081-NBR-BYTES                                   07870000
078800                TCP-BUF                                           07880000
078900                DP081-ERRNO                                       07890000
079000                DP081-RETCODE.                                    07900000
079100                                                                  07910000
079200                                                                  07920000
079300     IF  DP081-RETCODE < ZERO                                     07930000
079400         SET PS-ERROR-RECEIVE TO TRUE                             07940000
079500*        PERFORM 3300-SEND-ERROR-CONFIRM-QNX                      07950000
079600*        PERFORM 1500-CLOSE-SOCKET                                07960000
079700         MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        07970000
079800         SET  DP081-TCP-IP-READ-ERR TO TRUE                       07980000
079900*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         07990000
080000*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE08000000
080100*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  08010000
080200*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               08020000
080300*   DP013-MESSAGE-TEXT GROUP LEVEL.                               08030000
080400         COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          08040000
080500         SET  DP013-OTHER-ABEND   TO TRUE                         08050000
080600         SET  DP013-NO-ROLLBACK   TO TRUE                         08060000
080700         MOVE ' 3000-RECEIVE-TCP'                                 08070000
080800             TO DP013-PARAGRAPH                                   08080000
080900         MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  08090000
081000         PERFORM 9999-WRITE-CICS-LOG-MSG                          08100000
081100     ELSE                                                         08110000
081200         IF  DP081-RETCODE = 0                                    08120000
081300             INITIALIZE PV-CICS-MSG-AREA                          08130000
081400             SET PS-ERROR-RECEIVE TO TRUE                         08140000
081500             MOVE DP081-RETCODE TO PV-RETCODE                     08150000
081600             MOVE DP081-NBR-BYTES TO PV-TCPLENG                   08160000
081700             MOVE DP081-ERRNO   TO PV-ERRNO                       08170000
081800             STRING ' SUKCS780:'                                  08180000
081900                  'SOCKET ERROR EQ 0'                             08190000
082000                  ' RETCODE='                                     08200000
082100                  PV-RETCODE                                      08210000
082200                  ' TCPLENG='                                     08220000
082300                  PV-TCPLENG                                      08230000
082400                  ' ERRNO='                                       08240000
082500                  PV-ERRNO                                        08250000
082600                 DELIMITED BY SIZE INTO PV-CICS-MSG-AREA          08260000
082700             PERFORM 9990-WRITE-CICS                              08270000
082800             MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME    08280000
082900             SET  DP081-TCP-IP-READ-ERR TO TRUE                   08290000
083000*            MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR     08300000
083100*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE08310000
083200*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  08320000
083300*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               08330000
083400*   DP013-MESSAGE-TEXT GROUP LEVEL.                               08340000
083500             COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10      08350000
083600             SET  DP013-OTHER-ABEND   TO TRUE                     08360000
083700             SET  DP013-NO-ROLLBACK   TO TRUE                     08370000
083800             MOVE ' 3000-RECEIVE-TCP'                             08380000
083900                 TO DP013-PARAGRAPH                               08390000
084000             MOVE DP081-TCP-IP-LOGGING-MSG                        08400000
084100                                      TO DP013-MESSAGE-TEXT (1)   08410000
084200             PERFORM 9999-WRITE-CICS-LOG-MSG                      08420000
084300         ELSE                                                     08430000
084400             MOVE DP081-RETCODE TO PV-TCP-RET-LENGTH              08440000
084500             IF  PV-TCP-RET-LENGTH = PV-TCP-EXP-LENGTH            08450000
084600                 SET PS-COMP-RECEIVE TO TRUE                      08460000
084700*                BEGIN OF TRANSLATE ASCII TO EBCDIC               08470000
084800                 CALL 'EZACIC05'                                  08480000
084900                     USING  DP081-TOEBCDIC-TOKEN                  08490000
085000                            TCP-BUF2                              08500000
085100                            DP081-NBR-BYTES                       08510000
085200*                END OF TRANSLATE ASCII TO EBCDIC                 08520000
085300                                                                  08530000
085400* JUST FOR TESTING - BEGIN                                        08540000
085500*                INITIALIZE PV-CICS-MSG-AREA                      08550000
085600*                STRING ' SUKCS780:GOOD RECEIVE '                 08560000
085700*                     TCP-BUF                                     08570000
085800*                    DELIMITED BY SIZE INTO PV-CICS-MSG-AREA      08580000
085900*                PERFORM 9990-WRITE-CICS                          08590000
086000*                MOVE DP081-NBR-BYTES   TO PV-NBR-BYTES           08600000
086100*                INITIALIZE PV-CICS-MSG-AREA                      08610000
086200*                STRING ' SUKCS780:NBR OF BYTES '                 08620000
086300*                     PV-NBR-BYTES                                08630000
086400*                    DELIMITED BY SIZE INTO PV-CICS-MSG-AREA      08640000
086500*                PERFORM 9990-WRITE-CICS                          08650000
086600* JUST FOR TESTING - BEGIN                                        08660000
086700                                                                  08670000
086800             ELSE                                                 08680000
086900                 IF  PV-TCP-RET-LENGTH > DP081-NBR-BYTES          08690000
087000*                    SET PS-ERROR-RECEIVE TO TRUE                 08700000
087100*                    PERFORM 1500-CLOSE-SOCKET                    08710000
087200                     INITIALIZE PV-CICS-MSG-AREA                  08720000
087300                     MOVE DP081-RETCODE TO PV-RETCODE             08730000
087400                     MOVE DP081-NBR-BYTES TO PV-TCPLENG           08740000
087500                     MOVE DP081-ERRNO   TO PV-ERRNO               08750000
087600                     STRING ' SUKCS780:'                          08760000
087700                          'SOCKET LENGTH ERROR #1'                08770000
087800                          ' RETCODE='                             08780000
087900                          PV-RETCODE                              08790000
088000                          ' DP081-NBR-BYTES='                     08800000
088100                          PV-TCPLENG                              08810000
088200                          ' ERRNO='                               08820000
088300                          PV-ERRNO                                08830000
088400                         DELIMITED BY SIZE INTO PV-CICS-MSG-AREA  08840000
088500                     PERFORM 9990-WRITE-CICS                      08850000
088600*                    BEGIN OF TRANSLATE ASCII TO EBCDIC           08860000
088700                     CALL 'EZACIC05'                              08870000
088800                         USING  DP081-TOEBCDIC-TOKEN              08880000
088900                                TCP-BUF2                          08890000
089000                                DP081-NBR-BYTES                   08900000
089100*                    END OF TRANSLATE ASCII TO EBCDIC             08910000
089200                                                                  08920000
089300* JUST FOR TESTING - BEGIN                                        08930000
089400*                    INITIALIZE PV-CICS-MSG-AREA                  08940000
089500*                    STRING ' SUKCS780:'                          08950000
089600*                         TCP-BUF2                                08960000
089700*                        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA  08970000
089800*                    PERFORM 9990-WRITE-CICS                      08980000
089900* JUST FOR TESTING - END                                          08990000
090000                                                                  09000000
090100                     MOVE PC-CURRENT-PGM-NAME TO                  09010000
090200                                            DP081-TCP-IP-PGM-NAME 09020000
090300                     SET  DP081-TCP-IP-READ-ERR TO TRUE           09030000
090400*                    MOVE DP081-ERRNO         TO                  09040000
090500*                                            DP081-TCP-IP-ERR-NBR 09050000
090600*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE09060000
090700*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  09070000
090800*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               09080000
090900*   DP013-MESSAGE-TEXT GROUP LEVEL.                               09090000
091000                     COMPUTE DP081-TCP-IP-ERR-NBR =               09100000
091100                                            DP081-ERRNO * 10      09110000
091200                     SET  DP013-OTHER-ABEND   TO TRUE             09120000
091300                     SET  DP013-NO-ROLLBACK   TO TRUE             09130000
091400                     MOVE ' 3000-RECEIVE-TCP'                     09140000
091500                         TO DP013-PARAGRAPH                       09150000
091600                     MOVE DP081-TCP-IP-LOGGING-MSG TO             09160000
091700                          DP013-MESSAGE-TEXT (1)                  09170000
091800                     PERFORM 9999-WRITE-CICS-LOG-MSG              09180000
091900                 ELSE                                             09190000
092000                     ADD 1 TO PV-PARTIAL-TCP-COUNT                09200000
092100                     PERFORM 3100-PROCESS-PARTIAL-TCP             09210000
092200                 END-IF                                           09220000
092300             END-IF                                               09230000
092400         END-IF                                                   09240000
092500     END-IF.                                                      09250000
092600                                                                  09260000
092700*----------------------------------------------------------------*09270000
092800*    THIS PARAGRAPH WILL BE USED WHEN WHAT IS RECEIVED VIA A     *09280000
092900*    SOCKET IS LESS THAN WHAT WAS EXPECTED TO BE RETURNED.       *09290000
093000*    THIS PARAGRAPH WILL DETERMINE IF THE PARTIAL IS A FIRST     *09300000
093100*    RECEIPT OF A NEW PACKET OR AN ADDITIONAL RECEIPT OF A       *09310000
093200*    PACKAGE AND THEN TAKE THE RECEIVED DATA AND CHARACTER BY    *09320000
093300*    CHARACTER MOVE FROM THE RECEIVED FIELD TO THE ASSEMBLE      *09330000
093400*    FIELD IN ORDER TO BUILD THE SOCKET PACKET OVER MULTIPLE     *09340000
093500*    RECEIVE COMMANDS.                                           *09350000
093600*----------------------------------------------------------------*09360000
093700                                                                  09370000
093800 3100-PROCESS-PARTIAL-TCP.                                        09380000
093900     MOVE ' 3100-PROCESS-PARTIAL-TCP'                             09390000
094000                                 TO DP013-PARAGRAPH.              09400000
094100     INITIALIZE PV-CICS-MSG-AREA.                                 09410000
094200     MOVE ' SUKCS780: 3100-PROCESS-PARTIAL-TCP'                   09420000
094300                             TO PV-CICS-MSG-AREA.                 09430000
094400     PERFORM 9990-WRITE-CICS.                                     09440000
094500     IF  PS-START-RECEIVE                                         09450000
094600         SET PS-PART-RECEIVE TO TRUE                              09460000
094700         SET PT-ASSEMBLE-IDX TO 1                                 09470000
094800         MOVE ZEROS TO PV-TCP-PRCSD-LENGTH                        09480000
094900     END-IF.                                                      09490000
095000                                                                  09500000
095100     ADD PV-TCP-RET-LENGTH TO PV-TCP-PRCSD-LENGTH.                09510000
095200                                                                  09520000
095300     IF  PV-TCP-PRCSD-LENGTH > PV-TCP-EXP-LENGTH                  09530000
095400*        PERFORM 1500-CLOSE-SOCKET                                09540000
095500         INITIALIZE PV-CICS-MSG-AREA                              09550000
095600         MOVE DP081-RETCODE TO PV-RETCODE                         09560000
095700         MOVE DP081-NBR-BYTES TO PV-TCPLENG                       09570000
095800         MOVE DP081-ERRNO   TO PV-ERRNO                           09580000
095900         STRING ' SUKCS780:'                                      09590000
096000              'SOCKET TOTAL LENGTH ERROR'                         09600000
096100              ' RETCODE='                                         09610000
096200              PV-RETCODE                                          09620000
096300              ' TOTLENG='                                         09630000
096400              PV-TCP-PRCSD-LENGTH                                 09640000
096500              ' ERRNO='                                           09650000
096600              PV-ERRNO                                            09660000
096700             DELIMITED BY SIZE INTO PV-CICS-MSG-AREA              09670000
096800         PERFORM 9990-WRITE-CICS                                  09680000
096900*        BEGIN OF TRANSLATE ASCII TO EBCDIC                       09690000
097000         CALL 'EZACIC05'                                          09700000
097100             USING  DP081-TOEBCDIC-TOKEN                          09710000
097200                    TCP-BUF2                                      09720000
097300                    DP081-NBR-BYTES                               09730000
097400*        END OF TRANSLATE ASCII TO EBCDIC                         09740000
097500                                                                  09750000
097600* JUST FOR TESTING - BEGIN                                        09760000
097700*        INITIALIZE PV-CICS-MSG-AREA                              09770000
097800*        STRING ' SUKCS780:'                                      09780000
097900*             TCP-BUF2                                            09790000
098000*            DELIMITED BY SIZE INTO PV-CICS-MSG-AREA              09800000
098100*        PERFORM 9990-WRITE-CICS                                  09810000
098200* JUST FOR TESTING - END                                          09820000
098300                                                                  09830000
098400         MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        09840000
098500         SET  DP081-TCP-IP-READ-ERR TO TRUE                       09850000
098600*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         09860000
098700*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE09870000
098800*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  09880000
098900*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               09890000
099000*   DP013-MESSAGE-TEXT GROUP LEVEL.                               09900000
099100         COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          09910000
099200         SET  DP013-OTHER-ABEND   TO TRUE                         09920000
099300         SET  DP013-NO-ROLLBACK   TO TRUE                         09930000
099400         MOVE ' 3100-PROCESS-PARTIAL-TCP'                         09940000
099500             TO DP013-PARAGRAPH                                   09950000
099600         MOVE DP081-TCP-IP-LOGGING-MSG TO                         09960000
099700              DP013-MESSAGE-TEXT (1)                              09970000
099800         PERFORM 9999-WRITE-CICS-LOG-MSG                          09980000
099900     END-IF.                                                      09990000
100000                                                                  10000000
100100*  DISPLAYS ADDED TO DISPLAY A PARTIAL SOCKET RECEIVE             10010000
100200*  \/                                                             10020000
100300                                                                  10030000
100400     INITIALIZE PV-CICS-MSG-AREA.                                 10040000
100500     MOVE DP081-RETCODE TO PV-RETCODE.                            10050000
100600     MOVE DP081-NBR-BYTES TO PV-TCPLENG.                          10060000
100700     MOVE DP081-ERRNO   TO PV-ERRNO.                              10070000
100800                                                                  10080000
100900* JUST FOR TESTING - BEGIN                                        10090000
101000*    STRING ' SUKCS780:'                                          10100000
101100*         'SOCKET PARTIAL RECEIVE'                                10110000
101200*         ' RETCODE='                                             10120000
101300*         PV-RETCODE                                              10130000
101400*         ' TCPLENG='                                             10140000
101500*         PV-TCPLENG                                              10150000
101600*         ' ERRNO='                                               10160000
101700*         PV-ERRNO                                                10170000
101800*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                 10180000
101900*    PERFORM 9990-WRITE-CICS.                                     10190000
102000* JUST FOR TESTING - END                                          10200000
102100                                                                  10210000
102200*        BEGIN OF TRANSLATE ASCII TO EBCDIC                       10220000
102300     MOVE TCP-BUF TO PV-TCP-BUF.                                  10230000
102400     CALL 'EZACIC05'                                              10240000
102500         USING  DP081-TOEBCDIC-TOKEN                              10250000
102600                PV-TCP-BUF                                        10260000
102700                DP081-NBR-BYTES.                                  10270000
102800*        END OF TRANSLATE ASCII TO EBCDIC                         10280000
102900                                                                  10290000
103000* JUST FOR TESTING - BEGIN                                        10300000
103100*    INITIALIZE PV-CICS-MSG-AREA.                                 10310000
103200*    STRING ' SUKCS780:'                                          10320000
103300*         PV-TCP-BUF                                              10330000
103400*        DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                 10340000
103500*    PERFORM 9990-WRITE-CICS.                                     10350000
103600* JUST FOR TESTING - END                                          10360000
103700                                                                  10370000
103800*  /\                                                             10380000
103900*  DISPLAYS ADDED TO DISPLAY A PARTIAL SOCKET RECEIVE             10390000
104000                                                                  10400000
104100     MOVE TCP-BUF TO PT-TCP-RECEIVE-TABLE.                        10410000
104200                                                                  10420000
104300     PERFORM 3200-ASSEMBLE-DATA                                   10430000
104400         VARYING PT-RECEIVE-IDX FROM 1 BY 1                       10440000
104500             UNTIL PT-RECEIVE-IDX > PV-TCP-RET-LENGTH.            10450000
104600                                                                  10460000
104700     IF  PV-TCP-PRCSD-LENGTH = PV-TCP-EXP-LENGTH                  10470000
104800         SET PS-COMP-RECEIVE TO TRUE                              10480000
104900         MOVE SPACES TO TCP-BUF2                                  10490000
105000         MOVE PT-TCP-ASSEMBLE-TABLE TO TCP-BUF                    10500000
105100         MOVE PV-TCP-EXP-LENGTH TO DP081-NBR-BYTES                10510000
105200*        BEGIN OF TRANSLATE ASCII TO EBCDIC                       10520000
105300         CALL 'EZACIC05'                                          10530000
105400             USING  DP081-TOEBCDIC-TOKEN                          10540000
105500                    TCP-BUF2                                      10550000
105600                    DP081-NBR-BYTES                               10560000
105700*        END OF TRANSLATE ASCII TO EBCDIC                         10570000
105800                                                                  10580000
105900* JUST FOR TESTING - BEGIN                                        10590000
106000*        INITIALIZE PV-CICS-MSG-AREA                              10600000
106100*        STRING ' SUKCS780:STRUNG DATA  '                         10610000
106200*             TCP-BUF2                                            10620000
106300*            DELIMITED BY SIZE INTO PV-CICS-MSG-AREA              10630000
106400*        PERFORM 9990-WRITE-CICS                                  10640000
106500* JUST FOR TESTING - END                                          10650000
106600                                                                  10660000
106700     ELSE                                                         10670000
106800         SUBTRACT PV-TCP-PRCSD-LENGTH FROM                        10680000
106900                  PV-TCP-EXP-LENGTH   GIVING                      10690000
107000                  PV-TCP-REM-LENGTH                               10700000
107100         MOVE PV-TCP-REM-LENGTH TO DP081-NBR-BYTES                10710000
107200                                                                  10720000
107300* JUST FOR TESTING - BEGIN                                        10730000
107400*        INITIALIZE PV-CICS-MSG-AREA                              10740000
107500*        STRING ' SUKCS780:'                                      10750000
107600*             'SOCKET GET MORE LENGTH'                            10760000
107700*             ' PRCSD='                                           10770000
107800*             PV-TCP-PRCSD-LENGTH                                 10780000
107900*             ' EXPECT='                                          10790000
108000*             PV-TCP-EXP-LENGTH                                   10800000
108100*             ' REMAIN='                                          10810000
108200*             PV-TCP-REM-LENGTH                                   10820000
108300*            DELIMITED BY SIZE INTO PV-CICS-MSG-AREA              10830000
108400*        PERFORM 9990-WRITE-CICS                                  10840000
108500* JUST FOR TESTING - END                                          10850000
108600                                                                  10860000
108700     END-IF.                                                      10870000
108800                                                                  10880000
108900                                                                  10890000
109000*----------------------------------------------------------------*10900000
109100*    THIS PARAGRAPH WILL ASSEMBLE THE DATA THAT WAS RECEIVED     *10910000
109200*    WITH THE DATA RECEIVED FROM PREVIOUS RECEIVES FOR THE       *10920000
109300*    SOCKET PACKET.                                              *10930000
109400*----------------------------------------------------------------*10940000
109500                                                                  10950000
109600 3200-ASSEMBLE-DATA.                                              10960000
109700                                                                  10970000
109800     MOVE ' 3200-ASSEMBLE-DATA'                                   10980000
109900                                 TO DP013-PARAGRAPH.              10990000
110000     MOVE PT-TCP-RECEIVE-CHAR (PT-RECEIVE-IDX) TO                 11000000
110100          PT-TCP-DATA-CHAR (PT-ASSEMBLE-IDX).                     11010000
110200     SET PT-ASSEMBLE-IDX UP BY 1.                                 11020000
110300                                                                  11030000
110400                                                                  11040000
110500*----------------------------------------------------------------*11050000
110600*    SEND AN ERROR CONFIRMATION RECORD TO THE PACK TO LIGHT      *11060000
110700*    SYSTEM, INDICATING THERE WAS AN ERROR WITH THE DATA WE      *11070000
110800*    RECEIVED FROM THEM.                                         *11080000
110900*----------------------------------------------------------------*11090000
111000*3300-SEND-ERROR-CONFIRM-QNX.                                     11100000
111100*                                                                 11110000
111200*    MOVE ' 3300-SEND-ERROR-CONFIRM-QNX'                          11120000
111300*                                TO DP013-PARAGRAPH.              11130000
111400* JUST FOR TESTING - BEGIN                                        11140000
111500*    STRING '3300-SEND-ERROR-CONFIRM-QNX' DELIMITED BY SIZE       11150000
111600*    INTO PV-CICS-MSG-AREA                                        11160000
111700*    PERFORM 9990-WRITE-CICS                                      11170000
111800* JUST FOR TESTING - END                                          11180000
111900*                                                                 11190000
112000*    MOVE SPACES              TO TCP-BUF2.                        11200000
112100*    MOVE SU053-DC-NUMBER     TO SU015-DC-NUMBER.                 11210000
112200*    MOVE SU053-MESSAGE-SEQ-NUMBER                                11220000
112300*                             TO SU015-MESSAGE-SEQ-NUMBER.        11230000
112400*    MOVE SU053-CRTN-PROCESSED-RECORD  TO TCP-BUF.                11240000
112500*    MOVE 64                  TO                                  11250000
112600*                                DP081-NBR-BYTES                  11260000
112700*                                DP081-TCPLENG.                   11270000
112800*                                                                 11280000
112900* TRANSLATE EBCDIC TO ASCII                                       11290000
113000*    CALL 'EZACIC04'                                              11300000
113100*        USING  DP081-TOASCII-TOKEN                               11310000
113200*               TCP-BUF                                           11320000
113300*               DP081-TCPLENG.                                    11330000
113400*                                                                 11340000
113500* WRITE DATA ON A CONNECTED SOCKET                                11350000
113600*    CALL 'EZASOKET'                                              11360000
113700*        USING                                                    11370000
113800*               DP081-WRITE-CMD                                   11380000
113900*               DP081-SOCK-ID                                     11390000
114000*               DP081-NBR-BYTES                                   11400000
114100*               TCP-BUF                                           11410000
114200*               DP081-ERRNO                                       11420000
114300*               DP081-RETCODE.                                    11430000
114400*                                                                 11440000
114500*    IF DP081-RETCODE < ZERO                                      11450000
114600*        MOVE PC-CURRENT-PGM-NAME TO DP081-TCP-IP-PGM-NAME        11460000
114700*        SET  DP081-TCP-IP-SEND-TO-ERR TO TRUE                    11470000
114800*        MOVE DP081-ERRNO         TO DP081-TCP-IP-ERR-NBR         11480000
114900*   THE DP081-TCP-IP-ERR-NBR FIELD IS MULTIPLIED BY 10 BECAUSE THE11490000
115000*   DP081-TCP-IP-LOGGING-MSG GROUP LEVEL IS 80 CHARACTERS.  THIS  11500000
115100*   IS TRUNCATED TO 79 CHARACTERS WHEN MOVED TO THE               11510000
115200*   DP013-MESSAGE-TEXT GROUP LEVEL.                               11520000
115300*        COMPUTE DP081-TCP-IP-ERR-NBR = DP081-ERRNO * 10          11530000
115400*        SET  DP013-OTHER-ABEND   TO TRUE                         11540000
115500*        SET  DP013-NO-ROLLBACK   TO TRUE                         11550000
115600*        MOVE ' 3300-SEND-ERROR-CONFIRM-QNX'                      11560000
115700*            TO DP013-PARAGRAPH                                   11570000
115800*        MOVE DP081-TCP-IP-LOGGING-MSG TO DP013-MESSAGE-TEXT (1)  11580000
115900*        PERFORM 9999-WRITE-CICS-LOG-MSG                          11590000
116000*    END-IF.                                                      11600000
116100*                                                                 11610000
116200*                                                                 11620000
116300*----------------------------------------------------------------*11630000
116400*    INSERT A ROW INTO THE CARTON PROCESSED TABLE                *11640000
116500*----------------------------------------------------------------*11650000
116600 4000-INSERT-CRTN-PROC-REC.                                       11660000
116700*                                                                 11670000
116800                                                                  11680000
116900         EXEC SQL                                                 11690000
117000              INSERT INTO SUT_CART_PRCD_MSG                       11700000
117100                     (DC_NBR                                      11710000
117200                   ,  ACM_LBL_STA_NBR                             11720000
117300                   ,  ACM_MSG_RCV_TMST                            11730000
117400                   ,  ACM_MSG_SEQ_NBR                             11740000
117500                   ,  KOHLS_BRCDE_NBR                             11750000
117600                   ,  DIVERT_IND                                  11760000
117700                   ,  ACM_CART_RCV_DTE                            11770000
117800                   ,  ACM_CART_RCV_TM                             11780000
117900                   ,  ACM_CART_SCND_DTE                           11790000
118000                   ,  ACM_CART_SCND_TM                            11800000
118100                   ,  ACM_DIVERT_RSN_CDE)                         11810000
118200              VALUES (                                            11820000
118300                      :SUT00044-DC-NBR                            11830000
118400                   ,  :SUT00044-ACM-LBL-STA-NBR                   11840000
118500                   ,   CURRENT TIMESTAMP                          11850000
118600                   ,  :SUT00044-ACM-MSG-SEQ-NBR                   11860000
118700                   ,  :SUT00044-KOHLS-BRCDE-NBR                   11870000
118800                   ,  :SUT00044-DIVERT-IND                        11880000
118900                   ,  :SUT00044-ACM-CART-RCV-DTE                  11890000
119000                   ,  :SUT00044-ACM-CART-RCV-TM                   11900000
119100                   ,  :SUT00044-ACM-CART-SCND-DTE                 11910000
119200                   ,  :SUT00044-ACM-CART-SCND-TM                  11920000
119300                   ,  :SUT00044-ACM-DIVERT-RSN-CDE )              11930000
119400         END-EXEC                                                 11940000
119500                                                                  11950000
119600         EVALUATE TRUE                                            11960000
119700             WHEN SQLCODE = +0                                    11970000
119800             WHEN SQLCODE = -904                                  11980000
119900             WHEN SQLCODE = -911                                  11990000
120000             WHEN SQLCODE = -913                                  12000000
120100                  CONTINUE                                        12010000
120200                                                                  12020000
120300             WHEN SQLWARN0 NOT = SPACES                           12030000
120400             WHEN SQLCODE < +0                                    12040000
120500             WHEN SQLCODE > +0                                    12050000
120600                 STRING ' SUKCS780:'                              12060000
120700                      ' DC='                                      12070000
120800                      SU053-DC-NUMBER                             12080000
120900                      ' LBL STA '                                 12090000
121000                      SU053-ACCM-LINE-NMBR                        12100000
121100                      ' MES SEQ '                                 12110000
121200                      SU053-MESSAGE-SEQ-NUMBER                    12120000
121300                      ' BAR='                                     12130000
121400                      SUT00044-KOHLS-BRCDE-NBR                    12140000
121500                      ' DIV IND '                                 12150000
121600                      SUT00044-DIVERT-IND                         12160000
121700                     DELIMITED BY SIZE INTO PV-CICS-MSG-AREA      12170000
121800                 PERFORM 9990-WRITE-CICS                          12180000
121900                 STRING ' SUKCS780:'                              12190000
122000                      ' DIV RSN CDE ='                            12200000
122100                      SU053-CRTN-REJECT-CAUSE                     12210000
122200                      ' DAT='                                     12220000
122300                      SUT00044-ACM-CART-RCV-DTE                   12230000
122400                      ' TIM='                                     12240000
122500                      SUT00044-ACM-CART-RCV-TM                    12250000
122600                      ' SCND DTE'                                 12260000
122700                      SUT00044-ACM-CART-SCND-DTE                  12270000
122800                      ' SCND TIME'                                12280000
122900                      SUT00044-ACM-CART-SCND-TM                   12290000
123000                     DELIMITED BY SIZE INTO PV-CICS-MSG-AREA      12300000
123100                  PERFORM 9990-WRITE-CICS                         12310000
123200                  MOVE ' 4000-INSERT-CRTN-PROC-REC'               12320000
123300                                  TO DP013-PARAGRAPH              12330000
123400                  MOVE 'UNSUCCESSFUL INSERT ON SUT_CART_PRCD_MSG' 12340000
123500                                  TO DP013-MESSAGE-TEXT (1)       12350000
123510                  MOVE SU053-DC-NUMBER                            12351000
123520                                  TO DP013-MESSAGE-TEXT (2)       12352000
123530                  MOVE SU053-KOHLS-SML                            12353000
123540                                  TO DP013-MESSAGE-TEXT (3)       12354000
123550                  MOVE SU053-MESSAGE-SEQ-NUMBER                   12355000
123560                                  TO DP013-MESSAGE-TEXT (4)       12356000
123570                  MOVE SQLCA      TO DP013-SQLCA                  12357000
123580                  MOVE 'SUT_CART_PRCD_MSG'                        12358000
123581                                      TO  DP013-DB2-TABLE-NAME (1)12358100
123582                  MOVE SQLCODE    TO PV-DISPLAY-SQLCODE           12358200
123583                  MOVE PV-DISPLAY-SQLCODE                         12358300
123584                                  TO DP013-DB2-TABLE-NAME (2)     12358400
123585                  SET DP013-DB2-ABEND                             12358500
123586                      DP013-ROLLBACK       TO TRUE                12358600
123587                  PERFORM 9999-WRITE-CICS-LOG-MSG                 12358700
123588         END-EVALUATE.                                            12358800
123589                                                                  12358900
123590 9000-SYNCPOINT.                                                  12359000
123591     EXEC CICS                                                    12359100
123592         SYNCPOINT                                                12359200
123593     END-EXEC.                                                    12359300
123594/                                                                 12359400
123595 9990-WRITE-CICS.                                                 12359500
123596     EXEC CICS                                                    12359600
123597         WRITEQ TD                                                12359700
123598         QUEUE('CSSL')                                            12359800
123599         FROM(PV-CICS-MSG-AREA)                                   12359900
123600         RESP(PV-CICS-RESPONSE)                                   12360000
123700     END-EXEC.                                                    12370000
123800                                                                  12380000
123900     MOVE SPACES TO PV-CICS-MSG-AREA.                             12390000
124000                                                                  12400000
124100 9800-SQL-WARNING.                                                12410000
124200                                                                  12420000
124300      MOVE SQLCODE               TO SQLCODE2.                     12430000
124400      MOVE SQLERRD(3)            TO SQLERRD3.                     12440000
124500      DISPLAY '** ABEND **       ** = SQLWARNING'.                12450000
124600      DISPLAY '** PROGRAM        ** = ' PC-CURRENT-PGM-NAME.      12460000
124700      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 12470000
124800      DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                 12480000
124900      DISPLAY '** SQLWARN0       ** = ' SQLWARN0.                 12490000
125000      DISPLAY '** SQLWARN1       ** = ' SQLWARN1.                 12500000
125100      DISPLAY '** SQLWARN2       ** = ' SQLWARN2.                 12510000
125200      DISPLAY '** SQLWARN3       ** = ' SQLWARN3.                 12520000
125300      DISPLAY '** SQLWARN4       ** = ' SQLWARN4.                 12530000
125400      DISPLAY '** SQLWARN5       ** = ' SQLWARN5.                 12540000
125500      DISPLAY '** SQLWARN6       ** = ' SQLWARN6.                 12550000
125600      DISPLAY '** SQLWARN7       ** = ' SQLWARN7.                 12560000
125700                                                                  12570000
125800      MOVE 4013                  TO PV-ABEND-CODE                 12580000
125900      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        12590000
126000                                                                  12600000
126100                                                                  12610000
126200 9900-SQL-ERROR.                                                  12620000
126300                                                                  12630000
126400      MOVE SQLCODE               TO SQLCODE2.                     12640000
126500      MOVE SQLERRD(3)            TO SQLERRD3.                     12650000
126600      DISPLAY '** ABEND **       ** = SQLERROR'.                  12660000
126700      DISPLAY '** PROGRAM        ** = ' PC-CURRENT-PGM-NAME.      12670000
126800      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 12680000
126900      DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                 12690000
127000      DISPLAY '** SQLERRM        ** = ' SQLERRM.                  12700000
127100      DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                 12710000
127200                                                                  12720000
127300      MOVE 4013                  TO PV-ABEND-CODE                 12730000
127400      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        12740000
127500*                                                                 12750000
127600 9999-WRITE-CICS-LOG-MSG.                                         12760000
127700                                                                  12770000
127800     MOVE PC-CURRENT-PGM-NAME    TO DP013-PROGRAM.                12780000
127900     MOVE DP013-LOCATION         TO PV-CICS-MSG-AREA.             12790000
128000     PERFORM 9990-WRITE-CICS.                                     12800000
128100     STRING ' DC = '                                              12810000
128200            SU053-DC-NUMBER    DELIMITED BY SIZE                  12820000
128300                               INTO PV-CICS-MSG-AREA.             12830000
128400     PERFORM 9990-WRITE-CICS.                                     12840000
128500     IF DP013-MESSAGE-TEXT(1) > SPACES                            12850000
128600         MOVE DP013-MESSAGE-TEXT(1)  TO PV-CICS-MSG-AREA          12860000
128700         PERFORM 9990-WRITE-CICS                                  12870000
128800     END-IF.                                                      12880000
128900     IF DP013-MESSAGE-TEXT(2) > SPACES                            12890000
129000         MOVE DP013-MESSAGE-TEXT(2)  TO PV-CICS-MSG-AREA          12900000
129100         PERFORM 9990-WRITE-CICS                                  12910000
129200     END-IF.                                                      12920000
129300     IF DP013-MESSAGE-TEXT(3) > SPACES                            12930000
129400         MOVE DP013-MESSAGE-TEXT(3)  TO PV-CICS-MSG-AREA          12940000
129500         PERFORM 9990-WRITE-CICS                                  12950000
129600     END-IF.                                                      12960000
129700     IF DP013-MESSAGE-TEXT(4) > SPACES                            12970000
129800         MOVE DP013-MESSAGE-TEXT(4)  TO PV-CICS-MSG-AREA          12980000
129900         PERFORM 9990-WRITE-CICS                                  12990000
130000     END-IF.                                                      13000000
130100     IF DP013-DB2-TABLE-NAME(1) > SPACES                          13010000
130200         MOVE DP013-DB2-TABLE-NAME(1)                             13020000
130300                                     TO PV-CICS-MSG-AREA          13030000
130400         PERFORM 9990-WRITE-CICS                                  13040000
130500     END-IF.                                                      13050000
130600     IF DP013-DB2-TABLE-NAME(2) > SPACES                          13060000
130700         MOVE DP013-DB2-TABLE-NAME(2)                             13070000
130800                                     TO PV-CICS-MSG-AREA          13080000
130900         PERFORM 9990-WRITE-CICS                                  13090000
131000     END-IF.                                                      13100000
131100     IF SQLCODE > +0                                              13110000
131200         MOVE SQLCODE                TO PV-SQL-CODE               13120000
131300         STRING 'SQL CODE = '     DELIMITED BY SIZE               13130000
131400                PV-SQL-CODE       DELIMITED BY SIZE               13140000
131500                                   INTO PV-CICS-MSG-AREA          13150000
131600         PERFORM 9990-WRITE-CICS                                  13160000
131700     END-IF.                                                      13170000
131800     PERFORM VARYING PT-MSG-IDX FROM 1 BY 1 UNTIL                 13180000
131900                     PT-MESSAGE(PT-MSG-IDX) = SPACES              13190000
132000                     OR PT-MSG-IDX > 40                           13200000
132100         MOVE PT-MSG(PT-MSG-IDX) TO PV-CICS-MSG-AREA              13210000
132200         PERFORM 9990-WRITE-CICS                                  13220000
132300     END-PERFORM.                                                 13230000
132400                                                                  13240000
132500*    IF PS-SOCKET-NOT-CLOSED                                      13250000
132600*        PERFORM 1500-CLOSE-SOCKET                                13260000
132700*    END-IF.                                                      13270000
132800                                                                  13280000
132900     EXEC CICS                                                    13290000
133000         RETURN                                                   13300000
133100     END-EXEC.                                                    13310000
133200*                                                                 13320000
133300*    NON-CICS ARCHITECTURE SYSTEM MESSAGE FORMAT MODULE           13330000
133400*                                                                 13340000
133500                                                                  13350000
133600     COPY DPPD011.                                                13360000
133700*                                                                 13370000
