000600******************************************************************00060001
000700 IDENTIFICATION DIVISION.                                         00070001
000800******************************************************************00080001
001000 PROGRAM-ID.    PCKUT015.                                         00100001
001100 AUTHOR.        DEANNA BRANTNER                                   00110001
001200 INSTALLATION.  KOHLS.                                            00120001
001300 DATE-WRITTEN   NOVEMBER, 2000.                                   00130001
001400 DATE-COMPILED.                                                   00140001
001500                                                                  00150001
001600******************************************************************00160001
001700*  THIS PROGRAM USES AN EXTRACT FILE CREATED IN PROGRAM PCRD008   00170001
001800*  TO CREATE AN OUTPUT FILE WHICH WILL BE USED TO DELETE ROWS     00180001
001900*  FROM THE TSHPSUM TABLE.                                        00190001
002200******************************************************************00220001
002500 ENVIRONMENT DIVISION.                                            00250001
002800 CONFIGURATION SECTION.                                           00280001
003000 SOURCE-COMPUTER.        IBM-3090.                                00300001
003100 OBJECT-COMPUTER.        IBM-3090.                                00310001
003200                                                                  00320001
003300 INPUT-OUTPUT SECTION.                                            00330001
003500 FILE-CONTROL.                                                    00350001
003600                                                                  00360001
003700     SELECT PCRD008-FILE                                          00370001
003800         ASSIGN TO INP01.                                         00380001
003900                                                                  00390001
004000     SELECT TSHPSUM-FILE                                          00400001
004100         ASSIGN TO OUT01.                                         00410001
004200                                                                  00420001
004600******************************************************************00460001
004700 DATA DIVISION.                                                   00470001
005000 FILE SECTION.                                                    00500001
005100                                                                  00510001
005200 FD  PCRD008-FILE                                                 00520001
005300     RECORDING MODE IS F                                          00530001
005400     LABEL RECORDS ARE STANDARD                                   00540001
005500     BLOCK CONTAINS 0 RECORDS.                                    00550001
005600                                                                  00560001
005700 01  PC008-CRTN-SUM-REC         PIC  X(025).                      00570008
005800                                                                  00580001
005900 FD  TSHPSUM-FILE                                                 00590001
006000     RECORDING MODE IS F                                          00600001
006100     LABEL RECORDS ARE STANDARD                                   00610001
006200     BLOCK CONTAINS 0 RECORDS.                                    00620001
006300                                                                  00630001
006400 01  TSHPSUM-RECORD            PIC  X(042).                       00640010
006500                                                                  00650001
007300                                                                  00730001
007400******************************************************************00740001
007500 WORKING-STORAGE SECTION.                                         00750001
007700                                                                  00770001
007900******************************************************************00790001
008000** DB2 FORMATTED MESSAGE AREA                                   **00800001
008100******************************************************************00810001
008200     COPY DPWS004.                                                00820001
008500                                                                  00850001
008600******************************************************************00860001
008700** COMMUNICATIONS AREA FOR DB2                                  **00870001
008800******************************************************************00880001
008900     EXEC SQL                                                     00890001
009000          INCLUDE SQLCA                                           00900001
009100     END-EXEC.                                                    00910001
009300                                                                  00930001
009400******************************************************************00940001
009500** COBOL DECLARATION AND DCLGEN MEMBER FOR THE TSHPLSUM TABLE     00950001
009700******************************************************************00970001
009800     EXEC SQL                                                     00980001
009900          INCLUDE TSHPSUM                                         00990001
010000     END-EXEC.                                                    01000001
010200                                                                  01020001
010201******************************************************************01020103
010210** COBOL INPUT FILE LAYOUT                                        01021003
010220******************************************************************01022003
010300     COPY PCRD008.                                                01030003
012000                                                                  01200001
012100 01  ABEND-CODE                      PIC S9(04)    VALUE +0       01210001
012200                                                   COMP SYNC.     01220001
012300                                                                  01230001
012400 01  PS-PROGRAM-SWITCHES.                                         01240001
012500     05  PS-EOF-PC008-FILE-SW        PIC  X(01)    VALUE 'N'.     01250001
012600         88  PS-EOF-PC008-FILE                     VALUE 'Y'.     01260001
012700         88  PS-NOT-EOF-PC008-FILE                 VALUE 'N'.     01270001
012800     05  PS-EOF-TSHPSUM-CSR-SW   PIC  X(01)        VALUE 'N'.     01280001
012900         88  PS-EOF-TSHPSUM-CSR                    VALUE 'Y'.     01290001
013000         88  PS-NOT-EOF-TSHPSUM-CSR                VALUE 'N'.     01300001
013400                                                                  01340001
013600 01  PC-PROGRAM-CONSTANTS.                                        01360001
013700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01370001
013800         'PCKUT015'.                                              01380001
013900     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01390001
013901                                                   COMP SYNC.     01390114
013910                                                                  01391014
013920 01  DK-DB2-KEYS.                                                 01392014
013930     05  DK-PO-NBR                   PIC S9(09)    COMP.          01393014
013940     05  DK-PKSLIP-SEQ               PIC S9(04)    COMP.          01394015
014100                                                                  01410001
014110 01  PV-INPUT-REC               PIC  X(025).                      01411017
014120                                                                  01412017
014200 01  PV-PROGRAM-VARIABLES.                                        01420001
014300     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01430001
014400     05  PV-DB2-TABLE-NAME           PIC  X(30)    VALUE SPACES.  01440001
014500     05  PV-DB2-OPERATION-MESSAGE    PIC  X(30)    VALUE SPACES.  01450001
014600     05  PV-OPEN-COUNTER             PIC S9(04)    VALUE ZERO     01460001
014700                                                   COMP SYNC.     01470001
014800     05  PV-CLOSE-COUNTER            PIC S9(04)    VALUE ZERO     01480001
014900                                                   COMP SYNC.     01490001
015000     05  PV-FETCH-COUNTER            PIC S9(04)    VALUE ZERO     01500001
015100                                                   COMP SYNC.     01510001
015200     05  PV-INPUT-READ-CNTR          PIC S9(07)    VALUE ZERO     01520001
015300                                                   COMP-3.        01530001
015400     05  PV-OUTPUT-WRITE-CNTR        PIC S9(07)    VALUE ZERO     01540001
015500                                                   COMP-3.        01550001
015800     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01580001
015900                                                                  01590001
016000     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01600001
016100                                                   COMP-3.        01610001
016600                                                                  01660001
016700*  CURSOR FOR TSHPSUM                                             01670001
017000                                                                  01700001
017100     EXEC SQL                                                     01710001
017200       DECLARE TSHPSUM_CSR  CURSOR FOR                            01720001
017300         SELECT                                                   01730001
017400               PO_NBR                                             01740001
017500              ,PKSL_SEQ_NBR                                       01750001
017600              ,CART_COMB_NBR                                      01760001
017700              ,PO_LNE_NBR                                         01770001
017800              ,TOT_CART_CNT                                       01780001
017900              ,OTPK_UNT_QTY                                       01790001
018000              ,CRE_TMST                                           01800001
020200          FROM TSHPSUM                                            02020001
020300         WHERE PO_NBR       = :DK-PO-NBR                          02030014
020400           AND PKSL_SEQ_NBR = :DK-PKSLIP-SEQ                      02040014
020500     END-EXEC.                                                    02050001
023200                                                                  02320001
023300******************************************************************02330001
023400 PROCEDURE DIVISION.                                              02340001
023500     DISPLAY '**** START OF PCKUT015 ****'.                       02350013
023600                                                                  02360001
023700******************************************************************02370001
023800* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     02380001
023900*      PROGRAM.                                                   02390001
024000******************************************************************02400001
024100 0000-PROGRAM-MAINLINE.                                           02410001
024200                                                                  02420001
024300     PERFORM 1000-INITIALIZE.                                     02430001
024500     PERFORM 7000-READ-PC008-FILE.                                02450001
024600                                                                  02460001
024700     PERFORM 2000-PROCESS-PC008-FILE                              02470001
024800         UNTIL PS-EOF-PC008-FILE.                                 02480001
024810                                                                  02481001
024900     CLOSE PCRD008-FILE                                           02490003
025000           TSHPSUM-FILE.                                          02500001
025200                                                                  02520001
025300     MOVE PV-INPUT-READ-CNTR TO PV-DISPLAY-COUNT.                 02530001
025400     DISPLAY 'TOTAL INPUT RECS READ.....: ' PV-DISPLAY-COUNT.     02540001
025500                                                                  02550001
025600     MOVE PV-OUTPUT-WRITE-CNTR TO PV-DISPLAY-COUNT.               02560001
025700     DISPLAY 'TOTAL TSHPSUM RECS WRITTEN: ' PV-DISPLAY-COUNT.     02570001
025800                                                                  02580001
026200     STOP RUN.                                                    02620001
026300                                                                  02630001
026400*0000-EXIT.                                                       02640001
026500                                                                  02650001
026700******************************************************************02670001
026800*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02680001
026900******************************************************************02690001
027000 1000-INITIALIZE.                                                 02700001
027100                                                                  02710001
027200     OPEN  INPUT PCRD008-FILE                                     02720003
027300          OUTPUT TSHPSUM-FILE.                                    02730001
027500                                                                  02750001
027600     INITIALIZE DCLTSHPSUM.                                       02760001
027700     SET PS-NOT-EOF-PC008-FILE  TO TRUE.                          02770001
027710     SET PS-NOT-EOF-TSHPSUM-CSR TO TRUE.                          02771001
027800                                                                  02780001
027900*1000-EXIT.                                                       02790001
028000                                                                  02800001
028200******************************************************************02820001
028300*  PROCESS THE INPUT EXTRACT FILE OF PC008.                       02830001
028400******************************************************************02840001
028500 2000-PROCESS-PC008-FILE.                                         02850001
028800                                                                  02880001
028900     PERFORM 7100-OPEN-TSHPSUM-CURSOR.                            02890001
029000                                                                  02900001
029100     SET PS-NOT-EOF-TSHPSUM-CSR TO TRUE                           02910001
029200     PERFORM 7200-FETCH-TSHPSUM-CURSOR.                           02920001
029300                                                                  02930001
029400     PERFORM 3000-PROCESS-TSHPSUM-CURSOR                          02940001
029500        UNTIL PS-EOF-TSHPSUM-CSR.                                 02950001
029600                                                                  02960001
029700     PERFORM 7300-CLOSE-TSHPSUM-CURSOR.                           02970001
029800                                                                  02980001
029900     PERFORM 7000-READ-PC008-FILE.                                02990001
030100                                                                  03010001
030200*2000-EXIT.                                                       03020001
030400                                                                  03040001
030500******************************************************************03050001
030600*  PROCESS THE ROWS THAT ARE FOUND ON THE PC008 EXTRACT FILE.     03060001
031000******************************************************************03100001
031100 3000-PROCESS-TSHPSUM-CURSOR.                                     03110001
031200                                                                  03120001
031300     PERFORM 8000-WRITE-TSHPSUM-RECORD.                           03130001
031400                                                                  03140001
031700     SET PS-NOT-EOF-TSHPSUM-CSR TO TRUE                           03170001
032400                                                                  03240001
032500     PERFORM 7200-FETCH-TSHPSUM-CURSOR.                           03250001
032600                                                                  03260001
032700*3000-EXIT.                                                       03270001
032800                                                                  03280001
034300******************************************************************03430001
034400*  READ A RECORD FROM THE EXTRACT FILE.                           03440001
034500******************************************************************03450001
034600 7000-READ-PC008-FILE.                                            03460001
034800     READ PCRD008-FILE                                            03480004
034900       INTO PV-INPUT-REC                                          03490017
035000           AT END                                                 03500001
035200              SET PS-EOF-PC008-FILE TO TRUE.                      03520001
035201                                                                  03520116
035202     IF   PS-EOF-PC008-FILE                                       03520216
035203          CONTINUE                                                03520316
035204     ELSE                                                         03520416
035210         ADD +1 TO PV-INPUT-READ-CNTR                             03521016
035300         MOVE PV-INPUT-REC       TO PC008-CRTN-SUM-RECORD         03530017
035310     END-IF.                                                      03531016
035400                                                                  03540017
035500                                                                  03550001
035700******************************************************************03570001
035800*  OPEN THE CURSOR.                                               03580001
035900******************************************************************03590001
036000 7100-OPEN-TSHPSUM-CURSOR.                                        03600001
036010                                                                  03601014
036020     MOVE  PC008-PO-NBR   TO  DK-PO-NBR.                          03602014
036030     MOVE  PC008-SEQ-NBR  TO  DK-PKSLIP-SEQ.                      03603014
036040                                                                  03604014
036100     PERFORM WITH TEST AFTER                                      03610001
036200       VARYING PV-OPEN-COUNTER FROM 1 BY 1                        03620001
036300         UNTIL (PV-OPEN-COUNTER > PC-MAX-RETRIES                  03630001
036400                OR                                                03640001
036500                SQLCODE = +0)                                     03650006
036600                                                                  03660001
036700         EXEC SQL                                                 03670001
036800              OPEN TSHPSUM_CSR                                    03680007
036900         END-EXEC                                                 03690001
037000                                                                  03700001
037100         EVALUATE TRUE                                            03710001
037110             WHEN SQLCODE = +0                                    03711006
037200             WHEN SQLCODE = -904                                  03720001
037300             WHEN SQLCODE = -911                                  03730001
037400                 CONTINUE                                         03740001
037500             WHEN SQLWARN0 NOT = SPACES                           03750001
037600             WHEN SQLCODE < +0                                    03760006
037700             WHEN SQLCODE > +0                                    03770006
037800                 MOVE '7100-OPEN-TSHPSUM-CURSOR    '              03780001
037900                                 TO PV-PARAGRAPH-NAME             03790001
038000                 MOVE 'OPEN THE TSHPSUM_CURSOR    '               03800001
038100                                 TO PV-DB2-OPERATION-MESSAGE      03810001
038200                 MOVE 'TSHPSUM'  TO PV-DB2-TABLE-NAME             03820001
038300                 PERFORM 9100-SQL-ABEND                           03830001
038600         END-EVALUATE                                             03860001
038700     END-PERFORM.                                                 03870001
038800                                                                  03880001
038900     IF PV-OPEN-COUNTER > PC-MAX-RETRIES                          03890001
039000         MOVE '7100-OPEN-TSHPSUM-CURSOR   '                       03900001
039100                                 TO PV-PARAGRAPH-NAME             03910001
039200         MOVE 'OPEN MAX RETRIES EXCEEDED     '                    03920001
039300                                 TO PV-DB2-OPERATION-MESSAGE      03930001
039400         MOVE 'TSHPSUM'          TO PV-DB2-TABLE-NAME             03940001
039500         PERFORM 9100-SQL-ABEND                                   03950001
039600     END-IF.                                                      03960001
039700*7100-EXIT.                                                       03970001
039800                                                                  03980001
040000******************************************************************04000001
040100*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.         04010001
040200******************************************************************04020001
040300 7200-FETCH-TSHPSUM-CURSOR.                                       04030001
040400                                                                  04040001
040500     INITIALIZE DCLTSHPSUM.                                       04050001
040600                                                                  04060001
040700     EXEC SQL                                                     04070001
040800          FETCH TSHPSUM_CSR                                       04080007
040900           INTO :SHPSUM-PO-NBR                                    04090001
041000               ,:SHPSUM-PKSL-SEQ-NBR                              04100001
041100               ,:SHPSUM-CART-COMB-NBR                             04110001
041200               ,:SHPSUM-PO-LNE-NBR                                04120001
041300               ,:SHPSUM-TOT-CART-CNT                              04130001
041400               ,:SHPSUM-OTPK-UNT-QTY                              04140001
041600               ,:SHPSUM-CRE-TMST                                  04160001
043700     END-EXEC.                                                    04370001
043800                                                                  04380001
043900     EVALUATE TRUE                                                04390001
044000         WHEN SQLCODE = +0                                        04400006
044100             CONTINUE                                             04410001
044200         WHEN SQLCODE = +100                                      04420001
044300             SET PS-EOF-TSHPSUM-CSR TO TRUE                       04430001
044500         WHEN SQLWARN0 NOT = SPACES                               04450001
044600         WHEN SQLCODE < +0                                        04460006
044700         WHEN SQLCODE > +0                                        04470006
044800             MOVE '7200-FETCH-TSHPSUM-CURSOR  '                   04480001
044900                                 TO PV-PARAGRAPH-NAME             04490001
045000             MOVE 'FETCH THE TSHPSUM_CURSOR   '                   04500001
045100                                 TO PV-DB2-OPERATION-MESSAGE      04510001
045200             MOVE 'TSHPSUM'      TO PV-DB2-TABLE-NAME             04520001
045300             PERFORM 9100-SQL-ABEND                               04530001
045400     END-EVALUATE.                                                04540001
045500                                                                  04550001
045600*7200-EXIT.                                                       04560001
045700                                                                  04570001
045900******************************************************************04590001
046000*  CLOSE THE CURSOR                                               04600001
046100******************************************************************04610001
046200 7300-CLOSE-TSHPSUM-CURSOR.                                       04620001
046300                                                                  04630001
046400     PERFORM WITH TEST AFTER                                      04640001
046500       VARYING PV-CLOSE-COUNTER FROM 1 BY 1                       04650001
046600         UNTIL (PV-CLOSE-COUNTER > PC-MAX-RETRIES                 04660001
046700                OR                                                04670001
046800                SQLCODE = ZERO)                                   04680001
046900                                                                  04690001
047000         EXEC SQL                                                 04700001
047100              CLOSE TSHPSUM_CSR                                   04710007
047200         END-EXEC                                                 04720001
047300                                                                  04730001
047400         EVALUATE TRUE                                            04740001
047410             WHEN SQLCODE = ZERO                                  04741009
047500             WHEN SQLCODE = -904                                  04750001
047600             WHEN SQLCODE = -911                                  04760001
047700                 CONTINUE                                         04770001
047800             WHEN SQLWARN0 NOT = SPACES                           04780001
047900             WHEN SQLCODE < ZERO                                  04790001
048000             WHEN SQLCODE > ZERO                                  04800001
048100                 MOVE '7300-CLOSE-TSHPSUM-CURSOR   '              04810001
048200                                 TO PV-PARAGRAPH-NAME             04820001
048300                 MOVE 'CLOSE THE TSHPSUM_CURSOR    '              04830001
048400                                 TO PV-DB2-OPERATION-MESSAGE      04840001
048500                 MOVE 'TSHPSUM'  TO PV-DB2-TABLE-NAME             04850001
048600                 PERFORM 9100-SQL-ABEND                           04860001
048900         END-EVALUATE                                             04890001
049000     END-PERFORM.                                                 04900001
049100                                                                  04910001
049200     IF PV-CLOSE-COUNTER > PC-MAX-RETRIES                         04920001
049300         MOVE '7300-CLOSE-TSHPSUM-CURSOR'                         04930001
049400                                 TO PV-PARAGRAPH-NAME             04940001
049500         MOVE 'CLOSE MAX RETRIES EXCEEDED     '                   04950001
049600                                 TO PV-DB2-OPERATION-MESSAGE      04960001
049700         MOVE 'TSHPSUM'          TO PV-DB2-TABLE-NAME             04970001
049800         PERFORM 9100-SQL-ABEND                                   04980001
049900     END-IF.                                                      04990001
050000                                                                  05000001
050100*7300-EXIT.                                                       05010001
050200                                                                  05020001
063400******************************************************************06340001
063500*  WRITE THE OUTPUT RECORD                                        06350001
063600******************************************************************06360001
063700 8000-WRITE-TSHPSUM-RECORD.                                       06370001
063800     WRITE TSHPSUM-RECORD                                         06380001
063900         FROM DCLTSHPSUM.                                         06390001
064000     ADD +1 TO PV-OUTPUT-WRITE-CNTR.                              06400001
064200*8000-EXIT.                                                       06420002
065500                                                                  06550001
065700******************************************************************06570001
065800*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    06580001
065900*  ERROR OR WARNING CODE OCCURS.                                  06590001
066000******************************************************************06600001
066010 9100-SQL-ABEND.                                                  06601001
066100     DISPLAY '9100-SQL-ABEND'.                                    06610001
066200     DISPLAY '** ABEND           **'.                             06620001
066300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  06630001
066400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06640001
066500     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        06650001
066600     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MESSAGE  06660001
066700     DISPLAY '**                 ** = '                           06670001
066800                                                                  06680001
066900******************************************************************06690001
067000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06700001
067100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06710001
067200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06720001
067300* FORMAT.                                                         06730001
067400******************************************************************06740001
067500     COPY DPPD004.                                                06750001
067600                                                                  06760001
067700     MOVE +4013                  TO ABEND-CODE.                   06770001
067800     CALL 'ILBOABN0' USING ABEND-CODE.                            06780001
067900*9100-EXIT.                                                       06790001
