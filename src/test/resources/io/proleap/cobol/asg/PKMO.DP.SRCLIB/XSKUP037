000100*----------------------------------------------------------       00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300*----------------------------------------------------------       00030002
000400 PROGRAM-ID.    XSKUP037.                                         00040002
000500 AUTHOR.        ALEXIS KEIKER.                                    00050002
000600 DATE-WRITTEN.  OCTOBER 1, 2002.                                  00060002
000700                                                                  00070002
000800*----------------------------------------------------------       00080002
000900*          PRICING EXCLUSION BUSINESS EVENT LOADER                00090002
001000*----------------------------------------------------------       00100002
001010* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00101006
001020* LOAD FOR THE PRICING EXCLUSION BUSINESS EVENT.  THIS PROGRAM    00102006
001030* IS A MODULE AND WILL BE CALLED BY ANOTHER PROGRAM(XSKUT034).    00103012
001040* THERE ARE 5 PARAMETERS PASSED IN THIS PROGRAM.  ONE WILL        00104006
001050* BE THE ACTUAL PRICING EXCLUSION BUSINESS EVENT RECORD, MAXIMUM  00105006
001060* FUTURE OFFSET DATE IN CCYYMMDD, A LOAD SQL RETURN CODE FIELD,   00106006
001070* A PROGRAM STATUS CODE, AND A LOAD SEVERITY LEVEL.  THIS PROGRAM 00107006
001080* WILL EITHER UPDATE OR INSERT A RECORD TO THE XST_EXCL_MDSE      00108006
001090* (PRICING EXCLUSION TABLE).  THIS PROGRAM WILL ALWAYS SEND       00109006
001091* BACK A LOAD SQL RETURN CODE, A PROGRAM STATUS CODE AND A        00109106
001092* LOAD SEVERITY CODE.  IF THE PROGRAM DOES NOT UPDATE OR          00109206
001093* INSERT THE RECORD CORRECTLY IT WILL SELECT THE CORRECT          00109306
001094* ERROR CODES, FIND THE LOAD SEVERITY LEVEL, AND EXIT OUT OF      00109406
001095* THE PROGRAM.                                                    00109506
001096*                                                                 00109606
001101*          SQL CODES - LOAD SQL RETURN CODE                       00110106
001102*             - THIS IS THE LAST SQL RETURN CODE RECEIVED         00110202
001103*               FROM A DATABASE ACTION.                           00110302
001104*                                                                 00110402
001105*          PROGRAM CODES - PROGRAM STATUS CODE                    00110506
001106*           - 00 - ALL DATABASE ACTION WAS SUCCESSFUL AND         00110602
001107*                  WORKED ACCORDING TO THE MESSAGE TYPE.          00110702
001108*           - 01 - AN 'ADD' RECORD WAS TURNED INTO AN             00110802
001109*                  UPDATE AND THE BUSINESS EVENT WAS FOUND        00110902
001110*                  TO BE THE ONE NEEDED ON THE DATABASE.          00111002
001111*           - 02 - AN 'ADD' RECORD WAS TURNED INTO AN UPDATE      00111102
001112*                  AND THE BUSINESS EVENT WAS FOUND TO BE         00111202
001113*                  THE ONE NOT NEEDED ON THE DATABASE.            00111302
001114*           - 03 - AN 'UPDATE' RECORD WAS TURNED INTO AN ADD.     00111402
001115*           - 04 - AN 'UPDATE' RECORD WAS BYPASSED BECAUSE THE    00111512
001116*                  RECORD CURRENTLY ON THE DATABASE WAS THE       00111612
001117*                  MOST RECENT DATA.                              00111712
001118*           - 05 - THE DATABASE ACTION WAS NOT SUCCESSFUL DUE     00111812
001119*                  TO THE RETURNED SQL CODE.                      00111902
001120*           - 06 - UNEXPECTED ACTION CODE RECEIVED.               00112012
001121*                                                                 00112102
001122*          ERROR CODES - LOAD SEVERITY LEVEL                      00112202
001123*            THIS CODE IS FOUND BY TAKING THE MAXIMUM OFFSET      00112306
001124*            DATE AND COMPARING IT TO THE PROMOTION START         00112406
001125*            DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN       00112506
001126*            THE PROMOTION START DATE THE LOAD IS NOT CRITICAL,   00112606
001127*            OTHERWISE IT IS CRITICAL TO THE SYSTEM.              00112706
001128*            THE PROMOTION START DATE IS FOUND BY JOINING THE     00112806
001129*            XST_MDSE_LNE_SELN (MERCHANDISE LINE TABLE) AND       00112912
001130*            THE XST_PROMO (PROMOTION TABLE) AND SELECTING THE    00113006
001131*            PROMOTION START DATE FROM THE XST_PROMO TABLE.       00113106
001132*           - 00 - THE LOAD OF THE DATA WAS SUCCESSFUL AND        00113206
001133*                  THEREFORE THE SEVERITY OF THE LOAD DID         00113306
001134*                  NOT NEED TO BE DETERMINED.                     00113406
001135*           - 01 - THE LOAD IS CRITICAL TO A SYSTEM AND           00113502
001136*                  THEREFORE MUST BE RESOLVED ASAP.               00113602
001137*           - 02 - THE LOAD IS NOT CRITICAL AND THEREFORE CAN     00113702
001138*                  WAIT UNTIL A LATER TIME TO BE RESOLVED.        00113802
001139*                                                                 00113902
001140*----------------------------------------------------------       00114002
001141* HISTORY LOG:                                                    00114102
001142*                                                                 00114202
001143*----------------------------------------------------------       00114302
001144* DATE:                                                           00114402
001145* WR/IR#:                                                         00114502
001146* PROGRAMMER:                                                     00114602
001147* DESCRIPTION:                                                    00114702
001148*                                                                 00114802
001149*----------------------------------------------------------       00114902
001150 ENVIRONMENT DIVISION.                                            00115002
001151*----------------------------------------------------------       00115102
001152 CONFIGURATION SECTION.                                           00115202
001153 SOURCE-COMPUTER. IBM-3090.                                       00115302
001154 OBJECT-COMPUTER. IBM-3090.                                       00115402
001155                                                                  00115502
001156 INPUT-OUTPUT SECTION.                                            00115602
001160                                                                  00116002
001170 FILE-CONTROL.                                                    00117002
001180                                                                  00118002
001190*----------------------------------------------------------       00119002
001200 DATA DIVISION.                                                   00120002
001300*----------------------------------------------------------       00130002
001400 FILE SECTION.                                                    00140002
001500                                                                  00150002
001600                                                                  00160002
001700*---------------------------------------------------------        00170002
001800                                                                  00180002
001900 WORKING-STORAGE SECTION.                                         00190002
002000*---------------------------------------------------------        00200002
002100* PC- PROGRAM CONSTANTS                                           00210002
002200*----------------------------------------------------------       00220002
002300 01  PC-PROGRAM-CONSTANTS.                                        00230002
002400     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XSKUP037'. 00240002
002500     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   00250002
002600                                                                  00260002
002700*----------------------------------------------------------       00270002
002800* PS- PROGRAM SWITCHES                                            00280002
002900*----------------------------------------------------------       00290002
003000 01  PS-PROGRAM-SWITCHES.                                         00300002
003100     05  PS-PROCESS-CONTINUE-SW       PIC X(01)  VALUE 'Y'.       00310002
003200         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       00320002
003300         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       00330002
003400                                                                  00340002
003500*----------------------------------------------------------       00350002
003600* PV- PROGRAM VARIABLES                                           00360002
003700*----------------------------------------------------------       00370002
003800 01 PV-PROGRAM-VARIABLES.                                         00380002
003900    05  PV-SQL-SUB                    PIC S9(4)  VALUE +0 COMP.   00390002
004000    05  PV-MAX-OFFSET-DTE             PIC 9(08)  VALUE 0.         00400002
004010    05  PV-SQL-CODE                   PIC S9(4)  VALUE +0.        00401002
004020    05  PV-ACT-STRT-TMST              PIC X(26)  VALUE SPACES.    00402014
004030    05  PV-LAST-UPD-TMST              PIC X(26)  VALUE SPACES.    00403002
004070    05  PV-ACTION-CODE                PIC X(01).                  00407002
004080        88  PV-INSERT-DATA                       VALUE 'I'.       00408002
004090        88  PV-UPDATE-DATA                       VALUE 'U'.       00409002
004100    05  PV-LD-STATUS-CDE              PIC X(02).                  00410002
004200        88  PV-NO-ERROR                          VALUE '00'.      00420002
004210        88  PV-CRITICAL-ERROR                    VALUE '01'.      00421002
004220        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      00422002
004230    05  PV-PGM-STATUS-CDE             PIC X(02).                  00423002
004240        88  PV-SUCCESS-CDE                       VALUE '00'.      00424002
004250        88  PV-UPDATE-NEED                       VALUE '01'.      00425002
004260        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      00426002
004270        88  PV-ADD-CDE                           VALUE '03'.      00427002
004271        88  PV-UPDATE-BYPASS                     VALUE '04'.      00427112
004280        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      00428012
004290        88  PV-UNEXPECT-CDE                      VALUE '06'.      00429012
004300                                                                  00430002
004310    05  PV-NULLS-INDICATORS.                                      00431012
004321        10  PV-DEPT-NBR-IND           PIC S9(4) COMP VALUE +0.    00432112
004322        10  PV-MAJ-CL-NBR-IND         PIC S9(4) COMP VALUE +0.    00432212
004323        10  PV-SUB-CL-NBR-IND         PIC S9(4) COMP VALUE +0.    00432312
004324        10  PV-STYL-ID-IND            PIC S9(4) COMP VALUE +0.    00432412
004325        10  PV-SKU-NBR-IND            PIC S9(4) COMP VALUE +0.    00432512
004330                                                                  00433012
004340    05  PV-PROMO-STRT-DTE-TM.                                     00434013
004350        10  PV-PROMO-STRT-DTE.                                    00435013
004360            15  PV-PROMO-DTE-TM-CCYY      PIC X(04).              00436013
004370            15  FILLER                    PIC X(01).              00437013
004380            15  PV-PROMO-DTE-TM-MM        PIC X(02).              00438013
004390            15  FILLER                    PIC X(01).              00439013
004391            15  PV-PROMO-DTE-TM-DD        PIC X(02).              00439113
004392        10  PV-PROMO-STRT-TM              PIC X(16).              00439213
004393                                                                  00439313
004400    05  PV-PRC-EXC-STRT-DTE-NBR.                                  00440002
004500        10  PV-PRC-EXC-DTE-CCYY           PIC 9(04).              00450002
004600        10  PV-PRC-EXC-DTE-MM             PIC 9(02).              00460002
004700        10  PV-PRC-EXC-DTE-DD             PIC 9(02).              00470002
004800                                                                  00480002
004900    05  PV-PRC-EXC-STRT-DTE.                                      00490002
005000        15  PV-PRC-EXC-DTE-CH-CCYY        PIC X(04).              00500002
005100        15  FILLER                        PIC X(01).              00510002
005200        15  PV-PRC-EXC-DTE-CH-MM          PIC X(02).              00520002
005300        15  FILLER                        PIC X(01).              00530002
005400        15  PV-PRC-EXC-DTE-CH-DD          PIC X(02).              00540002
005500                                                                  00550002
005600*----------------------------------------------------------       00560002
005700* PRICING EXCLUSIONS BUSINESS EVENT RECORD LAYOUT                 00570002
005800*----------------------------------------------------------       00580002
005900     COPY XSRD021.                                                00590002
006000                                                                  00600002
006600*----------------------------------------------------------       00660002
006700* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         00670002
006800*----------------------------------------------------------       00680002
006900     COPY DPWS004.                                                00690002
007000                                                                  00700002
007100*---------------------------------------------                    00710002
007200*  DB2 COMMUNICATION AREA.                                        00720002
007300*---------------------------------------------                    00730002
007400     EXEC SQL                                                     00740002
007500          INCLUDE SQLCA                                           00750002
007600     END-EXEC.                                                    00760002
007700                                                                  00770002
007800*---------------------------------------------                    00780002
007900*  DB2 TABLE XST00026(XST_PROMO) - PROMOTION TABLE                00790002
008000*---------------------------------------------                    00800002
008100     EXEC SQL                                                     00810002
008200          INCLUDE XST00026                                        00820002
008300     END-EXEC.                                                    00830002
008400                                                                  00840002
008410*---------------------------------------------                    00841004
008420*  DB2 TABLE XST00028(XST_MDSE_LNE_SELN)                          00842002
008430*---------------------------------------------                    00843002
008440     EXEC SQL                                                     00844002
008450          INCLUDE XST00028                                        00845002
008460     END-EXEC.                                                    00846002
008470                                                                  00847002
008500*---------------------------------------------                    00850002
008600*  DB2 TABLE XST00034(XST_EXCL_MDSE) - PRICING EXCLUSIONS TABLE   00860002
008700*---------------------------------------------                    00870002
008800     EXEC SQL                                                     00880002
008900          INCLUDE XST00034                                        00890002
009000     END-EXEC.                                                    00900002
009100                                                                  00910002
009200 LINKAGE SECTION.                                                 00920002
009300                                                                  00930002
009400*----------------------------------------------------------       00940002
009500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          00950002
009600*----------------------------------------------------------       00960002
009700 01 LV-LINKAGE-VARIABLES.                                         00970002
009800    05  LV-PRC-EXC-BUS-REC         PIC X(300).                    00980002
009900    05  LV-MAX-OFFSET-DTE          PIC X(08).                     00990002
010000    05  LV-LD-SQL-RETURN-CDE       PIC S9(4).                     01000002
010100    05  LV-PGM-STATUS-CDE          PIC X(02).                     01010002
010200    05  LV-LD-SEVERITY-LVL         PIC X(02).                     01020002
010300                                                                  01030002
010400                                                                  01040002
010500*----------------------------------------------------------       01050002
010600 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   01060002
010700*----------------------------------------------------------       01070002
010800 0000-MAINLINE.                                                   01080002
010900                                                                  01090002
011000     PERFORM 1000-INITIALIZATION.                                 01100002
011100                                                                  01110002
011200     PERFORM 2000-PROCESS-MESSAGE                                 01120002
011300             UNTIL PS-PROCESS-COMPLETE.                           01130002
011400                                                                  01140002
011500     PERFORM 9999-WRAPUP.                                         01150002
011600                                                                  01160002
011700     EXIT PROGRAM.                                                01170021
011800                                                                  01180002
011900*0000-EXIT.                                                       01190002
012000 EJECT.                                                           01200002
012100                                                                  01210002
012200*----------------------------------------------------------       01220002
012300* 1000-INITIALIZATION.                                            01230002
012400*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            01240002
012500*     UPDATE OR INSERT A RECORD.                                  01250002
012600*----------------------------------------------------------       01260002
012700 1000-INITIALIZATION.                                             01270002
012800                                                                  01280002
012900     INITIALIZE DCLXST00034.                                      01290002
013000     INITIALIZE PV-SQL-CODE                                       01300012
013010                PV-NULLS-INDICATORS.                              01301012
013100     MOVE LV-PRC-EXC-BUS-REC   TO XS021-PRICING-EXCLSNS-RECORD.   01310019
013200     MOVE XS021-ACTION-CDE     TO PV-ACTION-CODE.                 01320002
013700     SET PV-NO-ERROR           TO TRUE.                           01370002
013800     SET PV-SUCCESS-CDE        TO TRUE.                           01380002
013900     SET PS-PROCESS-CONTINUE   TO TRUE.                           01390002
014000                                                                  01400002
014100     IF LV-MAX-OFFSET-DTE = SPACES                                01410002
014200        INITIALIZE PV-MAX-OFFSET-DTE                              01420002
014300     ELSE                                                         01430002
014400        MOVE LV-MAX-OFFSET-DTE    TO PV-MAX-OFFSET-DTE            01440002
014500     END-IF.                                                      01450002
014600                                                                  01460002
014800     PERFORM 1100-POPULATE-DCLGEN.                                01480002
014900                                                                  01490002
015000*1000-EXIT.                                                       01500002
015100 EJECT.                                                           01510002
015200                                                                  01520002
015300*----------------------------------------------------------       01530002
015400* 1100-POPULATE-DCLGEN.                                           01540002
015500*     POPULATES THE EXCLUSION TABLE VARIABLES.                    01550020
015700*----------------------------------------------------------       01570002
015800 1100-POPULATE-DCLGEN.                                            01580002
015900                                                                  01590002
016000     MOVE XS021-PROMO-INTFC-ID  TO XST00034-PROMO-INTFC-ID.       01600010
016100     MOVE XS021-MDSE-LNE-ID     TO XST00034-MDSE-LNE-ID.          01610010
016405     MOVE XS021-PROMO-INTFC-SUB-ID                                01620022
016406                                TO XST00034-PROMO-INTFC-SUB-ID.   01621022
016300     MOVE XS021-MDSE-LNE-EXCLN-ID                                 01630010
016310                                TO XST00034-EXCL-MDSE-ID.         01631010
016360     MOVE XS021-MDSE-HIER-CDE   TO XST00034-MDSE-HIER-CDE.        01636003
016370     MOVE XS021-STAT-CDE        TO XST00034-STAT-CDE.             01637003
016400     MOVE XS021-LAST-UPD-TMST   TO XST00034-SOR-LAST-UPD-TMST.    01640012
016401                                                                  01640112
016409     IF XS021-DEPT-NBR = ZEROES                                   01640912
016410        MOVE -1                 TO PV-DEPT-NBR-IND                01641012
016411     ELSE                                                         01641112
016412        MOVE XS021-DEPT-NBR     TO XST00034-DEPT-NBR              01641212
016413     END-IF.                                                      01641312
016414                                                                  01641412
016415     IF XS021-MAJ-CL-NBR = ZEROES                                 01641512
016416        MOVE -1                 TO PV-MAJ-CL-NBR-IND              01641612
016417     ELSE                                                         01641712
016418        MOVE XS021-MAJ-CL-NBR   TO XST00034-MAJ-CL-NBR            01641812
016419     END-IF.                                                      01641912
016420                                                                  01642012
016421     IF XS021-SUB-CL-NBR = ZEROES                                 01642112
016422        MOVE -1                 TO PV-SUB-CL-NBR-IND              01642212
016423     ELSE                                                         01642312
016424        MOVE XS021-SUB-CL-NBR   TO XST00034-SUB-CL-NBR            01642412
016425     END-IF.                                                      01642512
016426                                                                  01642612
016427     IF XS021-STYL-ID = ZEROES                                    01642712
016428        MOVE -1                 TO PV-STYL-ID-IND                 01642812
016429     ELSE                                                         01642912
016430        MOVE XS021-STYL-ID      TO XST00034-STYL-ID               01643012
016431     END-IF.                                                      01643112
016432                                                                  01643212
016433     IF XS021-SKU-NBR = ZEROES                                    01643312
016434        MOVE -1                 TO PV-SKU-NBR-IND                 01643412
016435     ELSE                                                         01643512
016440        MOVE XS021-SKU-NBR      TO XST00034-SKU-NBR               01644012
016450     END-IF.                                                      01645012
016500                                                                  01650002
016600*1100-EXIT.                                                       01660002
016700 EJECT.                                                           01670002
016800                                                                  01680002
016900*----------------------------------------------------------       01690002
017000* 2000-PROCESS-MESSAGE.                                           01700002
017100*     THIS CHECKS THE ACTION TO SEE WHETHER THE RECORD            01710002
017200*     SHOULD BE INSERTED INTO THE PRICING EXCLUSION TABLE OR      01720003
017300*     UPDATED. IF SOMETHING IS WRONG WITH THE ACTION CODE IT      01730003
017400*     WILL PROCESS AN ERROR AND EXIT THE PROGRAM.                 01740003
017500*----------------------------------------------------------       01750002
017600 2000-PROCESS-MESSAGE.                                            01760002
017700                                                                  01770002
017800     EVALUATE TRUE                                                01780002
017900        WHEN PV-INSERT-DATA                                       01790002
018000             PERFORM 2100-INSERT-DATA                             01800002
018100        WHEN PV-UPDATE-DATA                                       01810002
018200             PERFORM 2200-UPDATE-DATA                             01820002
018300        WHEN OTHER                                                01830002
018400             SET PS-PROCESS-COMPLETE TO TRUE                      01840002
018500             SET PV-UNEXPECT-CDE     TO TRUE                      01850002
018600             PERFORM 9000-LOAD-SEVERITY-ERROR                     01860002
018700     END-EVALUATE.                                                01870002
018800                                                                  01880002
018900*2000-EXIT.                                                       01890002
019000 EJECT.                                                           01900002
019100                                                                  01910002
019200*------------------------------------------------------           01920002
019300* 2100-INSERT-DATA.                                               01930002
019400*     INSERT THE PRICING EXCLUSION RECORD.                        01940003
019500*------------------------------------------------------           01950002
019600 2100-INSERT-DATA.                                                01960002
019700                                                                  01970002
019800     PERFORM                                                      01980002
019900         WITH TEST AFTER                                          01990002
020000         VARYING PV-SQL-SUB                                       02000002
020100         FROM 1 BY 1                                              02010002
020200         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 02020002
020300                   OR  SQLCODE NOT = -904 AND -911 AND -913)      02030008
020600                                                                  02060002
020700         EXEC SQL                                                 02070002
020800             INSERT INTO XST_EXCL_MDSE                            02080003
020900                                      (PROMO_INTFC_ID             02090003
021000                                      ,MDSE_LNE_ID                02100004
021100                                      ,EXCL_MDSE_ID               02110004
021101                                      ,PROMO_INTFC_SUB_ID         02110112
021102                                      ,DEPT_NBR                   02110212
021110                                      ,MAJ_CL_NBR                 02111004
021120                                      ,SUB_CL_NBR                 02112004
021130                                      ,STYL_ID                    02113004
021140                                      ,SKU_NBR                    02114004
021150                                      ,MDSE_HIER_CDE              02115004
021160                                      ,STAT_CDE                   02116004
021200                                      ,LAST_UPD_TMST              02120012
021210                                      ,SOR_LAST_UPD_TMST)         02121012
021300             VALUES                                               02130002
021400                (:XST00034-PROMO-INTFC-ID                         02140004
021500                ,:XST00034-MDSE-LNE-ID                            02150004
021600                ,:XST00034-EXCL-MDSE-ID                           02160004
021601                ,:XST00034-PROMO-INTFC-SUB-ID                     02160122
021602                ,:XST00034-DEPT-NBR :PV-DEPT-NBR-IND              02160212
021610                ,:XST00034-MAJ-CL-NBR :PV-MAJ-CL-NBR-IND          02161012
021620                ,:XST00034-SUB-CL-NBR :PV-SUB-CL-NBR-IND          02162012
021630                ,:XST00034-STYL-ID :PV-STYL-ID-IND                02163012
021640                ,:XST00034-SKU-NBR :PV-SKU-NBR-IND                02164012
021650                ,:XST00034-MDSE-HIER-CDE                          02165004
021660                ,:XST00034-STAT-CDE                               02166004
021700                ,CURRENT TIMESTAMP                                02170012
021710                ,:XST00034-SOR-LAST-UPD-TMST)                     02171012
021800         END-EXEC                                                 02180002
021900                                                                  02190002
021910         MOVE SQLCODE TO PV-SQL-CODE                              02191008
021920                                                                  02192008
022000         EVALUATE TRUE                                            02200002
022100             WHEN SQLCODE = -904                                  02210002
022200             WHEN SQLCODE = -911                                  02220002
022300             WHEN SQLCODE = -913                                  02230002
022400                  CONTINUE                                        02240002
022500             WHEN SQLCODE = 0                                     02250002
022600                  SET PS-PROCESS-COMPLETE TO TRUE                 02260002
022700             WHEN SQLCODE = -803                                  02270002
022800                  PERFORM 2300-SELECT-DATA                        02280012
022810                  MOVE -803 TO SQLCODE                            02281016
022900             WHEN OTHER                                           02290002
023000                  SET PS-PROCESS-COMPLETE TO TRUE                 02300002
023100                  SET PV-NO-SUCCESS-CDE TO TRUE                   02310002
023200                  PERFORM 9000-LOAD-SEVERITY-ERROR                02320002
023210                  MOVE +0 TO SQLCODE                              02321016
023300         END-EVALUATE                                             02330002
023400     END-PERFORM.                                                 02340002
023500                                                                  02350002
023800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         02380002
023900        SET PS-PROCESS-COMPLETE TO TRUE                           02390002
024000        SET PV-NO-SUCCESS-CDE TO TRUE                             02400002
024100        PERFORM 9000-LOAD-SEVERITY-ERROR                          02410002
024200     END-IF.                                                      02420002
024300                                                                  02430002
024400*2100-EXIT.                                                       02440002
024500 EJECT.                                                           02450002
024600                                                                  02460002
031300*------------------------------------------------------           03130002
031400* 2200-UPDATE-DATA.                                               03140002
031500*     UPDATE THE PRICING EXCLUSION RECORD.                        03150004
031600*------------------------------------------------------           03160002
031700 2200-UPDATE-DATA.                                                03170002
031800                                                                  03180002
031900     PERFORM                                                      03190002
032000         WITH TEST AFTER                                          03200002
032100         VARYING PV-SQL-SUB                                       03210002
032200         FROM 1 BY 1                                              03220002
032300         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03230002
032400                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03240008
032700                                                                  03270002
032800         EXEC SQL                                                 03280002
032900             UPDATE XST_EXCL_MDSE                                 03290004
033000             SET  PROMO_INTFC_ID   = :XST00034-PROMO-INTFC-ID,    03300004
033100                  MDSE_LNE_ID      = :XST00034-MDSE-LNE-ID,       03310004
033200                  EXCL_MDSE_ID     = :XST00034-EXCL-MDSE-ID,      03320004
033210                  PROMO_INTFC_SUB_ID                              03321012
033220                                   = :XST00034-PROMO-INTFC-SUB-ID,03322022
033230                  DEPT_NBR         = :XST00034-DEPT-NBR           03323012
033240                                       :PV-DEPT-NBR-IND,          03324012
033300                  MAJ_CL_NBR       = :XST00034-MAJ-CL-NBR         03330012
033301                                       :PV-MAJ-CL-NBR-IND,        03330112
033310                  SUB_CL_NBR       = :XST00034-SUB-CL-NBR         03331012
033311                                       :PV-SUB-CL-NBR-IND,        03331112
033320                  STYL_ID          = :XST00034-STYL-ID            03332012
033321                                       :PV-STYL-ID-IND,           03332112
033330                  SKU_NBR          = :XST00034-SKU-NBR            03333012
033331                                       :PV-SKU-NBR-IND,           03333112
033340                  MDSE_HIER_CDE    = :XST00034-MDSE-HIER-CDE,     03334004
033350                  STAT_CDE         = :XST00034-STAT-CDE,          03335004
033400                  LAST_UPD_TMST    = CURRENT TIMESTAMP,           03340012
033410                  SOR_LAST_UPD_TMST                               03341012
033420                                   = :XST00034-SOR-LAST-UPD-TMST  03342012
033500            WHERE PROMO_INTFC_ID   = :XST00034-PROMO-INTFC-ID     03350012
033600              AND MDSE_LNE_ID      = :XST00034-MDSE-LNE-ID        03360012
033610              AND EXCL_MDSE_ID     = :XST00034-EXCL-MDSE-ID       03361012
                    AND PROMO_INTFC_SUB_ID                              03361122
                                         = :XST00034-PROMO-INTFC-SUB-ID 03361222
033620              AND SOR_LAST_UPD_TMST                               03362012
033630                                  <= :XST00034-SOR-LAST-UPD-TMST  03363015
033700         END-EXEC                                                 03370002
033800                                                                  03380002
033810         MOVE SQLCODE TO PV-SQL-CODE                              03381008
033820                                                                  03382008
033900         EVALUATE TRUE                                            03390002
034000             WHEN SQLCODE = -904                                  03400002
034100             WHEN SQLCODE = -911                                  03410002
034200             WHEN SQLCODE = -913                                  03420002
034300                  CONTINUE                                        03430002
034400             WHEN SQLCODE = 0                                     03440002
034500                  SET PS-PROCESS-COMPLETE TO TRUE                 03450002
034600             WHEN SQLCODE = +100                                  03460002
034700                  PERFORM 2300-SELECT-DATA                        03470012
034800                  MOVE +100 TO SQLCODE                            03480016
034900             WHEN OTHER                                           03490002
035000                  SET PS-PROCESS-COMPLETE TO TRUE                 03500002
035100                  SET PV-NO-SUCCESS-CDE TO TRUE                   03510002
035200                  PERFORM 9000-LOAD-SEVERITY-ERROR                03520002
035210                  MOVE +0 TO SQLCODE                              03521016
035300         END-EVALUATE                                             03530002
035400     END-PERFORM.                                                 03540002
035700                                                                  03570002
035800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03580002
035900        SET PS-PROCESS-COMPLETE TO TRUE                           03590002
036000        SET PV-NO-SUCCESS-CDE TO TRUE                             03600002
036100        PERFORM 9000-LOAD-SEVERITY-ERROR                          03610002
036200     END-IF.                                                      03620002
036300                                                                  03630002
036400*2200-EXIT.                                                       03640002
036500 EJECT.                                                           03650002
036600                                                                  03660002
036610*------------------------------------------------------           03661012
036620* 2300-SELECT-DATA.                                               03662012
036630*     SELECT THE TIMESTAMP IN THE PRICING EXCLUSION RECORD.       03663012
036640*------------------------------------------------------           03664012
036650 2300-SELECT-DATA.                                                03665012
036660                                                                  03666012
036670     PERFORM                                                      03667012
036680         WITH TEST AFTER                                          03668012
036690         VARYING PV-SQL-SUB                                       03669012
036691         FROM 1 BY 1                                              03669112
036692         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03669212
036693                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03669312
036694                                                                  03669412
036695         EXEC SQL                                                 03669512
036696             SELECT  SOR_LAST_UPD_TMST                            03669612
036697               INTO :PV-LAST-UPD-TMST                             03669712
036698               FROM  XST_EXCL_MDSE                                03669812
036699              WHERE  PROMO_INTFC_ID = :XST00034-PROMO-INTFC-ID    03669912
036700                AND  MDSE_LNE_ID    = :XST00034-MDSE-LNE-ID       03670012
036701                AND  EXCL_MDSE_ID   = :XST00034-EXCL-MDSE-ID      03670112
                      AND  PROMO_INTFC_SUB_ID                           03670222
                                          = :XST00034-PROMO-INTFC-SUB-ID03670322
036702         END-EXEC                                                 03670412
036703                                                                  03670512
036704         MOVE SQLCODE TO PV-SQL-CODE                              03670612
036705                                                                  03670712
036706         EVALUATE TRUE                                            03670812
036707             WHEN SQLCODE = -904                                  03670912
036708             WHEN SQLCODE = -911                                  03671012
036709             WHEN SQLCODE = -913                                  03671112
036710                  CONTINUE                                        03671212
036711             WHEN SQLCODE = 0                                     03671312
036713                  IF PV-UPDATE-DATA                               03671412
036714                     SET PS-PROCESS-COMPLETE TO TRUE              03671512
036715                     SET PV-UPDATE-BYPASS TO TRUE                 03671612
036716                  ELSE                                            03671712
036717                     PERFORM 2350-TMST-COMPARE                    03671820
036718                  END-IF                                          03671912
036719             WHEN SQLCODE = +100                                  03672012
036720                  SET PV-INSERT-DATA TO TRUE                      03672112
036721                  SET PV-ADD-CDE TO TRUE                          03672212
036722             WHEN OTHER                                           03672312
036723                  SET PS-PROCESS-COMPLETE TO TRUE                 03672412
036724                  SET PV-NO-SUCCESS-CDE TO TRUE                   03672512
036725                  PERFORM 9000-LOAD-SEVERITY-ERROR                03672612
036726                  MOVE +0 TO SQLCODE                              03672716
036727         END-EVALUATE                                             03672812
036728     END-PERFORM.                                                 03672912
036729                                                                  03673012
036730     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03673112
036731        SET PS-PROCESS-COMPLETE TO TRUE                           03673212
036732        SET PV-NO-SUCCESS-CDE TO TRUE                             03673312
036733        PERFORM 9000-LOAD-SEVERITY-ERROR                          03673412
036734     END-IF.                                                      03673512
036735                                                                  03673612
036736*2300-EXIT.                                                       03673712
036737 EJECT.                                                           03673812
036738                                                                  03673912
036739*--------------------------------------------------------         03674012
036740* 2350-TMST-COMPARE.                                              03674120
036741*     COMPARE TIMESTAMP OF EXISTING ROW TO MESSAGE RECORD         03674220
036742*     AND UPDATE IF MESSAGE HAS A NEWER TIMESTAMP.                03674320
036743*--------------------------------------------------------         03674412
036744 2350-TMST-COMPARE.                                               03674520
036745                                                                  03674612
036746     IF XS021-LAST-UPD-TMST >= PV-LAST-UPD-TMST                   03674712
036747        SET PV-UPDATE-DATA      TO TRUE                           03674812
036748        SET PV-UPDATE-NEED      TO TRUE                           03674912
036749     ELSE                                                         03675012
036750        SET PS-PROCESS-COMPLETE TO TRUE                           03675112
036751        SET PV-UPDATE-NOT-NEED  TO TRUE                           03675212
036752     END-IF.                                                      03675312
036753                                                                  03675412
036754*2350-EXIT.                                                       03675512
036755 EJECT.                                                           03675612
036756                                                                  03675712
036760*----------------------------------------------------------       03676002
036800* 9000-LOAD-SEVERITY-ERROR.                                       03680002
036900*     THIS PROCEDURE IS CALLED IF THE RECORD WAS NOT UPDATED      03690002
037000*     OR INSERTED INTO THE PRICING EXCLUSION TABLE.  COMPARES     03700004
037100*     THE MAXIMUM OFFSET DATE TO THE PRICING EXCLUSION BUSINESS   03710004
037200*     EVENT START DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN  03720004
037300*     THE PRICING EXCLUSION START DATE THE ERROR IS UNCRITICAL,   03730004
037400*     OTHERWISE IT IS CRITICAL.                                   03740002
037500*----------------------------------------------------------       03750002
037600 9000-LOAD-SEVERITY-ERROR.                                        03760002
037700                                                                  03770002
037800     INITIALIZE DCLXST00026.                                      03780002
037810     INITIALIZE DCLXST00028.                                      03781004
037900                                                                  03790002
038000     MOVE XS021-PROMO-INTFC-ID TO XST00028-PROMO-INTFC-ID.        03800010
038010     MOVE XS021-MDSE-LNE-ID    TO XST00028-MDSE-LNE-ID.           03801010
038020                                                                  03802002
038021     PERFORM 9010-SELECT-STRT-DATE.                               03802102
038022                                                                  03802202
038023     IF PV-PRC-EXC-STRT-DTE = SPACES                              03802304
038024        MOVE ZEROES TO PV-PRC-EXC-STRT-DTE-NBR                    03802404
038025     ELSE                                                         03802502
038026        PERFORM 9100-FORMAT-DATE-INFO                             03802602
038027     END-IF.                                                      03802702
038028                                                                  03802802
038029     IF (PV-MAX-OFFSET-DTE < PV-PRC-EXC-STRT-DTE-NBR) AND         03802904
038030       (PV-MAX-OFFSET-DTE NOT = ZEROES) AND                       03803002
038040       (PV-PRC-EXC-STRT-DTE-NBR NOT = ZEROES)                     03804004
038050        SET PV-NOT-CRITICAL-ERROR TO TRUE                         03805002
038060     ELSE                                                         03806002
038070        SET PV-CRITICAL-ERROR TO TRUE                             03807002
038080     END-IF.                                                      03808002
038090                                                                  03809002
038100*9000-EXIT.                                                       03810002
038200 EJECT.                                                           03820002
038300                                                                  03830002
038400*------------------------------------------------------           03840002
038500* 9010-SELECT-STRT-DATE.                                          03850002
038600*     SELECT THE START DATE OF THE PROMOTION.                     03860020
038700*------------------------------------------------------           03870002
038800 9010-SELECT-STRT-DATE.                                           03880002
038900                                                                  03890002
039000     PERFORM                                                      03900002
039100         WITH TEST AFTER                                          03910002
039200         VARYING PV-SQL-SUB                                       03920002
039300         FROM 1 BY 1                                              03930002
039400         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03940002
039500                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03950008
039710                                                                  03971002
039720         EXEC SQL                                                 03972002
039730             SELECT  A.ACTL_END_TMST                              03973013
039740               INTO :PV-ACT-STRT-TMST                             03974013
039750               FROM  XST_PROMO         A                          03975004
039751                    ,XST_MDSE_LNE_SELN B                          03975104
039760              WHERE  B.PROMO_INTFC_ID = :XST00028-PROMO-INTFC-ID  03976010
039770                AND  B.MDSE_LNE_ID    = :XST00028-MDSE-LNE-ID     03977004
039781                AND  A.PROMO_ID       = B.PROMO_ID                03978110
039782                WITH UR                                           03978211
039790         END-EXEC                                                 03979002
039800                                                                  03980002
039801         EVALUATE TRUE                                            03980102
039802             WHEN SQLCODE = -904                                  03980202
039803             WHEN SQLCODE = -911                                  03980302
039804             WHEN SQLCODE = -913                                  03980402
039805                  CONTINUE                                        03980502
039806             WHEN SQLCODE = 0                                     03980602
039807                  MOVE PV-ACT-STRT-TMST TO PV-PROMO-STRT-DTE-TM   03980713
039808                  MOVE PV-PROMO-STRT-DTE TO PV-PRC-EXC-STRT-DTE   03980813
039809             WHEN OTHER                                           03980902
039810                  MOVE SPACES TO PV-PRC-EXC-STRT-DTE              03981004
039811         END-EVALUATE                                             03981102
039812     END-PERFORM.                                                 03981202
039813                                                                  03981302
039814     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03981402
039815        MOVE SPACES TO PV-PRC-EXC-STRT-DTE                        03981504
039816     END-IF.                                                      03981602
039817                                                                  03981702
039818     INITIALIZE PV-SQL-SUB.                                       03981809
039819                                                                  03981909
039820*9010-EXIT.                                                       03982002
039821 EJECT.                                                           03982102
039822                                                                  03982202
039823*----------------------------------------------------------       03982302
039830* 9100-FORMAT-DATE-INFO.                                          03983002
039840*     FORMATS THE DATE FOR COMPARING.                             03984002
039850*----------------------------------------------------------       03985002
039860 9100-FORMAT-DATE-INFO.                                           03986002
039870                                                                  03987002
039880     MOVE PV-PRC-EXC-DTE-CH-CCYY TO PV-PRC-EXC-DTE-CCYY.          03988004
039890     MOVE PV-PRC-EXC-DTE-CH-MM   TO PV-PRC-EXC-DTE-MM.            03989004
039900     MOVE PV-PRC-EXC-DTE-CH-DD   TO PV-PRC-EXC-DTE-DD.            03990004
040000                                                                  04000002
040100*9100-EXIT.                                                       04010002
040200 EJECT.                                                           04020002
040300                                                                  04030002
040400*----------------------------------------------------------       04040002
040500* 9999-WRAPUP.                                                    04050002
040600*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           04060002
040700*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           04070002
040800*     PROGRAM.                                                    04080002
040900*----------------------------------------------------------       04090002
041000 9999-WRAPUP.                                                     04100002
041100                                                                  04110002
041200     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 04120002
041300     MOVE PV-SQL-CODE       TO LV-LD-SQL-RETURN-CDE.              04130002
041400     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                04140002
041500                                                                  04150002
041600*9999-EXIT.                                                       04160002
041700 EJECT.                                                           04170002
041800                                                                  04180002
