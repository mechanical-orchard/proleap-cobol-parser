000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.      APKUT123.                                       00020001
000300 AUTHOR.          NANCY EILBES.                                   00030001
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040001
000500 DATE-WRITTEN.    03/16/2004.                                     00050001
000600*----------------------------------------------------------------*00060001
000700*   CREATE VENDOR AGREEMENT EARNED ALLOWANCE ADJUSTMENTS         *00070016
000900*   COBOL390 WITH DB2 SQL                                        *00090001
001000*----------------------------------------------------------------*00100001
001200*   THIS PROGRAM WILL READ AN EXTRACT FILE OF VENDOR AGREEMENT   *00120001
001300*   PURCHASE ACTIVITY AND GENERATE ADJUSTMENTS TO ACCUMULATE     *00130016
001400*   THE EARNED ALLOWANCE AMOUNTS ON A MONTHLY BASIS.  THE INPUT  *00140016
001500*   FILE WILL CONTAIN THE VENDOR, DEPT AND TRANCODE NEEDED TO    *00150016
001510*   PROCESS THE ADJUSTMENT. OTHER NECESSARY FIELDS WILL BE       *00151016
001520*   OBTAINED FROM VARIOUS AP AND VN CONTROL TABLES.              *00152016
001530*----------------------------------------------------------------*00153001
001540*                                                                *00154001
001550* DB2 TABLES:                                                    *00155001
001560*  1. ACCOUNTS PAYABLE CONTROL TABLE  (TAPCNTL TABLE)            *00156001
001570*  2. AP TRANCODE MASTER TABLE        (TTRNCDE TABLE)            *00157001
001580*  3. DATE ATTRIBUTE TABLE            (TDTATTR TABLE)            *00158001
001590*                                                                *00159001
001600* INPUT FILE:                                                    *00160001
001700*  1. VENDOR AGREEMENT ACTIVITY FILE  (COPYBOOK APRD081)         *00170001
001800*                                                                *00180001
001900* OUTPUT FILE:                                                   *00190001
002000*  1. ADJUSTMENT DETAILS              (COPYBOOK APRD045)         *00200001
002100*                                                                *00210001
002200*----------------------------------------------------------------*00220001
002300* CHANGE LOG:                                                    *00230001
002310*   DATE  03/16/2004                                             *00231001
002320*       CHANGE MADE: INITIAL VERSION.                            *00232001
002330*       MADE BY: NANCY EILBES            WR/IR #: WR26677        *00233001
002400*                                                                *00240001
002310*   DATE  02/21/2023                                             *00241021
002320*       CHANGE MADE: CHANGE CALL TO DPKUP151 FROM STATIC TO      *00242021
002320*                    TO DYNAMIC                                  *00242121
002330*       MADE BY: JEAN KURK               WR/IR #: CHG0282641     *00243021
002400*                                                                *00244021
002500*----------------------------------------------------------------*00250001
002600                                                                  00260001
002700 ENVIRONMENT DIVISION.                                            00270001
002800                                                                  00280001
002900 CONFIGURATION SECTION.                                           00290001
003000 SOURCE-COMPUTER. IBM-3090.                                       00300001
003100 OBJECT-COMPUTER. IBM-3090.                                       00310001
003200                                                                  00320001
003300 INPUT-OUTPUT SECTION.                                            00330001
003400 FILE-CONTROL.                                                    00340001
003500     SELECT VNDAGR-ACTVTY-FILE ASSIGN TO INP01.                   00350003
003600     SELECT ADJUST-JRNL-FILE ASSIGN TO OUT01.                     00360001
003700                                                                  00370001
003800 DATA DIVISION.                                                   00380001
003900                                                                  00390001
004000 FILE SECTION.                                                    00400001
004100                                                                  00410001
004200 FD  VNDAGR-ACTVTY-FILE                                           00420003
004300     RECORDING MODE IS F                                          00430001
004400     LABEL RECORDS ARE STANDARD                                   00440001
004500     BLOCK CONTAINS 0 RECORDS                                     00450001
004600     DATA RECORD IS INPUT-EXP-INV-RECORD.                         00460001
004700                                                                  00470001
004800 01  VNDAGR-ACTVTY-RECORD       PIC X(250).                       00480019
004900                                                                  00490001
005000 FD  ADJUST-JRNL-FILE                                             00500001
005100     RECORDING MODE F                                             00510001
005200     LABEL RECORDS ARE STANDARD                                   00520001
005300     DATA RECORD IS ADJUST-JRNL-RECORD.                           00530001
005400 01  ADJUST-JRNL-RECORD         PIC X(500).                       00540001
005500                                                                  00550001
005600                                                                  00560001
005700 WORKING-STORAGE SECTION.                                         00570001
005800                                                                  00580001
005810 01  CONTROL-CARD.                                                00581010
005820     05  CC-BEGIN-DTE            PIC X(10).                       00582010
005830     05  FILLER                  PIC X.                           00583010
005840     05  CC-END-DTE              PIC X(10).                       00584010
005850     05  FILLER                  PIC X(59).                       00585010
005860                                                                  00586010
006500 01  PV-PROGRAM-VARIABLES.                                        00650001
006700     05  PV-CURR-TMST               PIC X(26) VALUE SPACES.       00670001
006800     05  PV-ENTR-DTE                PIC X(10) VALUE SPACES.       00680001
006900     05  SAVE-AP-TRN-CDE            PIC X(02) VALUE SPACES.       00690008
007000     05  PV-ACTVTY-AMT              PIC S9(7)V99 COMP-3 VALUE +0. 00700001
007100                                                                  00710001
007200 01  PROGRAM-COUNTERS.                                            00720001
007600     05  INPUT-COUNT                  PIC 9(09) VALUE 0.          00760001
007700     05  OUT-ADJUSTMENT-COUNT         PIC 9(09) VALUE 0.          00770001
007900                                                                  00790001
008000 01  PS-PROGRAM-SWITCHES.                                         00800001
008100     05  PS-ACTVTY-EOF                PIC X(01)      VALUE 'N'.   00810001
008200         88  ACTVTY-EOF                              VALUE 'Y'.   00820001
008300     05  PS-TRANCODE-CSR-SW           PIC X(01)      VALUE ' '.   00830007
008500         88  PS-END-OF-TRANCODES                     VALUE 'Y'.   00850007
008600                                                                  00860001
008700 01  WS-ABEND-FIELDS.                                             00870001
008800     05  WS-ABEND-LITERAL          PIC  X(40)   VALUE             00880001
008900             '*****       ABEND'.                                 00890001
009000     05  WS-ABEND-PROGRAM-MSG.                                    00900001
009100         10  FILLER                PIC X(17)    VALUE             00910001
009200             '*****   PROGRAM: '.                                 00920001
009300         10  WS-ABEND-PROGRAM      PIC X(8)   VALUE 'APKUT123'.   00930001
009400     05  WS-ABEND-PARAGRAPH-MSG.                                  00940001
009500         10  FILLER                PIC  X(17)   VALUE             00950001
009600             '***** PARAGRAPH: '.                                 00960001
009700         10  WS-ABEND-PARAGRAPH    PIC X(35)  VALUE SPACES.       00970001
009800     05  WS-ABEND-OPERATION-MSG.                                  00980001
009900         10  FILLER                PIC  X(17)   VALUE             00990001
010000             '***** OPERATION: '.                                 01000001
010100         10  WS-ABEND-OPERATION    PIC X(50)  VALUE SPACES.       01010001
010200     05  WS-ABEND-TABLE1-MSG.                                     01020001
010300         10  FILLER                PIC  X(15)   VALUE             01030001
010400             '***** TABLE 1: '.                                   01040001
010500         10  WS-ABEND-STRUCTURE-1  PIC X(8)   VALUE SPACES.       01050001
010600     05  WS-ABEND-TABLE2-MSG.                                     01060001
010700         10  FILLER                PIC  X(15)   VALUE             01070001
010800             '***** TABLE 2: '.                                   01080001
010900         10  WS-ABEND-STRUCTURE-2  PIC X(8)   VALUE SPACES.       01090001
011000     05  WS-ABEND-STATUS           PIC XX     VALUE SPACES.       01100001
011100     05  WS-MESSAGE-LINE-1.                                       01110001
011200         10  FILLER                PIC  X(06)   VALUE '*****'.    01120001
011300         10  WS-MESSAGE-1          PIC  X(80)   VALUE SPACES.     01130001
011400     05  WS-MESSAGE-LINE-2.                                       01140001
011500         10  FILLER                PIC  X(06)   VALUE '*****'.    01150001
011600         10  WS-MESSAGE-2          PIC  X(80)   VALUE SPACES.     01160001
011700                                                                  01170001
011800 01  ABEND-CODE                    PIC S9(4)  COMP SYNC           01180001
011900                                              VALUE ZEROS.        01190001
012000     88 AP-TABLE-FULL              VALUE +4004.                   01200001
012100     88 AP-EMPTY-FILE              VALUE +4005.                   01210001
012200     88 AP-TABLE-NOTFND            VALUE +4006.                   01220001
012300     88 AC-BAD-DATA                VALUE +4008.                   01230001
012400     88 AP-DB2-ERROR               VALUE +4013.                   01240001
012500                                                                  01250001
012501 01  AP-TRANCODES.                                                01250105
012502     05  AP-TRANCODE-TBL OCCURS 15 TIMES INDEXED BY TRN-INDEX.    01250207
012510         10  TBL-AP-TRN-CDE             PIC X(2).                 01251007
012520         10  TBL-PSTG-TYP-CDE           PIC X(2).                 01252007
012530         10  TBL-TRN-TYP-CDE            PIC X(3).                 01253007
012540         10  TBL-AUTO-OFFST-TRN-CDE     PIC X(2).                 01254007
012550         10  TBL-GL-ACCT-NBR            PIC X(6).                 01255007
012570         10  TBL-BTCH-SRC-CDE           PIC X(3).                 01257007
012600                                                                  01260001
012700*----------------------------------------------------------------*01270001
012800* DB2 SQL ERROR MESSAGE FORMAT AREA                               01280001
012900*----------------------------------------------------------------*01290001
013000                                                                  01300001
013100     COPY DPWS004.                                                01310001
013200                                                                  01320001
013300*----------------------------------------------------------------*01330001
013400* VENDOR AGREEMENT ACTIVITY EXTRACT FILE LAYOUT (INPUT)           01340001
013500*----------------------------------------------------------------*01350001
013600                                                                  01360001
013700     COPY APRD081.                                                01370001
013870                                                                  01387001
013880*----------------------------------------------------------------*01388001
013890* ADJUSTMENT JOURNAL DETAIL TRANSACTION RESULTS FILE LAYOUT       01389001
013900*----------------------------------------------------------------*01390001
014000                                                                  01400001
014100     COPY APRD045.                                                01410001
014200                                                                  01420001
014300*---------------------------------------------------------------- 01430001
014400*  WORKING STORAGE AREA FOR DPKUP151                              01440001
014500*---------------------------------------------------------------- 01450001
014600     COPY APWS151.                                                01460001
014600     COPY DPWS951.                                                01461022
014700                                                                  01470001
014800*----------------------------------------------------------------*01480001
014900* ACCOUNTS PAYABLE CONTROL TABLE                                  01490001
015000*----------------------------------------------------------------*01500001
015100                                                                  01510001
015200     EXEC SQL                                                     01520001
015300         INCLUDE TAPCNTL                                          01530001
015400     END-EXEC.                                                    01540001
015500                                                                  01550001
015600*----------------------------------------------------------------*01560001
015700* AP TRANCODE MASTER TABLE                                        01570001
015800*----------------------------------------------------------------*01580001
015900                                                                  01590001
016000     EXEC SQL                                                     01600001
016100         INCLUDE TTRNCDE                                          01610001
016200     END-EXEC.                                                    01620001
016300                                                                  01630001
016400*----------------------------------------------------------------*01640001
016500* DATE ATTRIBUTE TABLE                                            01650001
016600*----------------------------------------------------------------*01660001
016700                                                                  01670001
016800     EXEC SQL                                                     01680001
016900         INCLUDE TDTATTR                                          01690001
017000     END-EXEC.                                                    01700001
017100                                                                  01710001
017200*----------------------------------------------------------------*01720001
017300* DB2 COMMUNICATION AREA                                          01730001
017400*----------------------------------------------------------------*01740001
017500                                                                  01750001
017600     EXEC SQL                                                     01760001
017700         INCLUDE SQLCA                                            01770001
017800     END-EXEC.                                                    01780001
017900                                                                  01790001
018000*----------------------------------------------------------------*01800001
018100* DB2 COMMUNICATION AREA2                                         01810001
018200*----------------------------------------------------------------*01820001
018300                                                                  01830001
018400     COPY SQLCA2.                                                 01840001
018500                                                                  01850001
018501*----------------------------------------------------------------*01850107
018502* TRANCODE CURSOR RETURNS ALL VENDOR AGREEMENT TRANCODES         *01850207
018503*----------------------------------------------------------------*01850307
018504                                                                  01850407
018505     EXEC SQL                                                     01850507
018506       DECLARE TRANCODE_CSR CURSOR FOR                            01850607
018520         SELECT AP_TRN_CDE                                        01852007
018531              , PSTG_TYP_CDE                                      01853107
018532              , TRN_TYP_CDE                                       01853207
018533              , AUTO_OFFST_TRN_CDE                                01853307
018540              , GL_ACCT_NBR                                       01854007
018593           FROM TTRNCDE                                           01859307
018594          WHERE BTCH_SRC_CDE = 'VDA'                              01859407
018595            AND EFF_STRT_DTE <= :CC-BEGIN-DTE                     01859510
018597            AND EFF_END_DTE  >= :CC-END-DTE                       01859710
018598     END-EXEC.                                                    01859807
018599                                                                  01859907
018600 PROCEDURE DIVISION.                                              01860001
018700                                                                  01870001
018800 A100-PROGRAM-MAINLINE.                                           01880001
018900                                                                  01890001
019000     PERFORM B100-HOUSEKEEPING.                                   01900001
019100                                                                  01910001
019200     PERFORM B200-PROCESS-ACTVTY-REC                              01920001
019300         UNTIL ACTVTY-EOF.                                        01930001
019400                                                                  01940001
019500     PERFORM B300-END-OF-JOB.                                     01950001
019600                                                                  01960001
019700     GOBACK.                                                      01970001
019800                                                                  01980001
019900*----------------------------------------------------------------*01990001
020000*  B100-HOUSEKEEPING  OPEN FILES, INITIALIZE THE NECESSARY        02000001
020100*  FIELDS, PROCESS THE INVOICE FILE FOR THE FIRST RECORD, AND     02010001
020200*  OPENS THE CURSOR FOR THE FIRST RECORD.                         02020001
020300*----------------------------------------------------------------*02030001
020400                                                                  02040001
020500 B100-HOUSEKEEPING.                                               02050001
020600                                                                  02060001
020700     OPEN INPUT  VNDAGR-ACTVTY-FILE                               02070003
020800          OUTPUT ADJUST-JRNL-FILE.                                02080001
020900                                                                  02090001
021000     INITIALIZE AP045-TRANSACTION-FILE.                           02100001
021001                                                                  02100110
021010     ACCEPT CONTROL-CARD.                                         02101010
021100                                                                  02110001
021200     PERFORM S400-SELECT-DATES.                                   02120001
021300     PERFORM S500-SET-CURRENT-TMST.                               02130001
021310     PERFORM D100-LOAD-TRANCODES.                                 02131007
021400                                                                  02140001
021500     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02150003
021600                                                                  02160001
021900*---------------------------------------------------------------* 02190001
022000*  B200-PROCESS-ACTVTY-REC                                      * 02200001
022100*  PROCESSES RECORDS FROM THE EXTRACT FILE.                     * 02210002
022200*---------------------------------------------------------------* 02220001
022300                                                                  02230001
022400 B200-PROCESS-ACTVTY-REC.                                         02240001
022500                                                                  02250001
022700     IF AP081-AGR-AP-TRN-CDE = SAVE-AP-TRN-CDE                    02270008
022800        CONTINUE                                                  02280008
022900     ELSE                                                         02290008
023000         MOVE AP081-AGR-AP-TRN-CDE TO SAVE-AP-TRN-CDE             02300008
023010         PERFORM C200-FIND-TRANCODE-ENTRY                         02301008
023230     END-IF.                                                      02323008
023240                                                                  02324008
023250     IF  AP081-EST-EARNED-AMT > 0                                 02325020
023300         PERFORM C100-FORMAT-ADJ-DETAIL                           02330020
023310     END-IF.                                                      02331020
023400                                                                  02340001
023500     PERFORM R100-READ-VNDAGR-ACTVTY-FILE.                        02350003
023600                                                                  02360001
023700*---------------------------------------------------------------* 02370001
023800*  CLOSE FILES AND PERFORM FINAL DISPLAYS.                        02380008
024000*---------------------------------------------------------------* 02400001
024200 B300-END-OF-JOB.                                                 02420001
024300                                                                  02430001
024400     CLOSE VNDAGR-ACTVTY-FILE                                     02440003
024500           ADJUST-JRNL-FILE.                                      02450001
024600                                                                  02460001
024700     DISPLAY 'ACTIVITY RECORDS READ = ' INPUT-COUNT.              02470008
024800     DISPLAY 'ADJUSTMENT RECORDS WRITTEN = ' OUT-ADJUSTMENT-COUNT.02480001
024900                                                                  02490001
025000*----------------------------------------------------------------*02500001
025100*  FORMAT THE ADJUSTMENT DETAIL RECORD FROM THE DATA ON THE INPUT*02510014
025200*  RECORD.  SYSTEM GENERATED DOC NUMBERS ARE USED, MANY FIELDS   *02520014
025210*  ARE LOADED FROM TTRNCDE TABLE VALUES FOR THE TRANCODE BEING   *02521014
025220*  PROCESSED.                                                    *02522014
025300*----------------------------------------------------------------*02530001
025500 C100-FORMAT-ADJ-DETAIL.                                          02550001
025600                                                                  02560001
025700     INITIALIZE AP045-KEY-FIELDS                                  02570001
025800                AP045-COMMON-FIELDS                               02580001
025900                AP045-DETAIL-FIELDS.                              02590001
026000                                                                  02600001
026010     PERFORM S100-GET-NEXT-DOC-NBR.                               02601002
026030                                                                  02603008
026100     MOVE AP081-VENDOR-NBR              TO AP045-VND-NBR.         02610014
026200     MOVE WS151-NEXT-DOC-NBR            TO AP045-DOC-NBR.         02620014
026300     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-DOC-DTE.         02630014
026301     MOVE AP081-AGR-AP-TRN-CDE          TO AP045-AP-TRN-CDE.      02630114
026310     SET AP045-DETAIL-RECORD            TO TRUE.                  02631014
027801                                                                  02780103
027802     MOVE TBL-TRN-TYP-CDE(TRN-INDEX)    TO AP045-TRN-TYP-CDE.     02780214
027803     MOVE TBL-PSTG-TYP-CDE(TRN-INDEX)   TO AP045-PSTG-TYP-CDE.    02780314
027804                                                                  02780403
027805     IF AP045-MERCHANDISE                                         02780503
027810        MOVE 85                         TO AP045-STR-NBR          02781014
027820        MOVE AP081-DEPT-NBR             TO AP045-DEPT-NBR         02782014
027830     ELSE                                                         02783003
027831        MOVE 90                         TO AP045-STR-NBR          02783108
027832        MOVE TBL-GL-ACCT-NBR(TRN-INDEX) TO AP045-GL-ACCT-NBR      02783208
027833     END-IF.                                                      02783303
027840                                                                  02784003
027850     MOVE PV-CURR-TMST                  TO AP045-ENTR-TMST.       02785014
027860     MOVE PV-ENTR-DTE                   TO AP045-ENTR-DTE.        02786014
027870     MOVE 'APKUT123'                    TO AP045-ENTR-ID.         02787014
027880     SET  AP045-ORGN-ADJUST             TO TRUE.                  02788014
027890     MOVE APCNTL-BTCH-PRC-DTE           TO AP045-INV-CUTOFF-DTE   02789014
027891                                           AP045-PS-BTCH-DTE.     02789114
027892     MOVE 'ADJ'                         TO AP045-PS-BTCH-SRC-CDE. 02789214
027893     MOVE '00'                          TO AP045-PS-BTCH-SEQ-NBR. 02789314
027894                                                                  02789403
027895     MOVE AP081-ENT-ID                  TO AP045-ENT-ID.          02789514
027896     MOVE AP081-VENDOR-NAME             TO AP045-ENT-NME-DESC.    02789614
027900                                                                  02790001
027910     IF  APCNTL-MULT-PSTG-PER-IND = 'Y'                           02791003
028000         MOVE APCNTL-PREV-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02800003
028100         MOVE APCNTL-PREV-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02810003
028200         MOVE APCNTL-PREV-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02820003
028300     ELSE                                                         02830003
028400         MOVE APCNTL-CURR-PSTG-FYR-NBR  TO AP045-PSTG-FYR-NBR     02840003
028500         MOVE APCNTL-CURR-PSTG-FMN-NBR  TO AP045-PSTG-FMN-NBR     02850003
028600         MOVE APCNTL-CURR-PSTG-FWK-NBR  TO AP045-PSTG-FWK-NBR     02860003
028610     END-IF.                                                      02861003
028700                                                                  02870003
028893     MOVE AP081-EST-EARNED-AMT TO AP045-GRO-COST-AMT.             02889319
028897                                                                  02889703
028898     IF AP045-CREDIT                                              02889815
028899        COMPUTE AP045-GRO-COST-AMT = AP045-GRO-COST-AMT * -1      02889917
028900     END-IF.                                                      02890015
028910                                                                  02891015
029000     MOVE AP045-GRO-COST-AMT TO AP045-NET-COST-AMT.               02900010
029100                                                                  02910001
029200     PERFORM W200-WRITE-OUTPUT-JRNL-REC.                          02920001
029300                                                                  02930001
029301*----------------------------------------------------------------*02930108
029303*  SEARCHES TRANCODE TABLE FOR THE TRANCODE BEING PROCESSED.     *02930315
029305*----------------------------------------------------------------*02930508
029307 C200-FIND-TRANCODE-ENTRY.                                        02930708
029308                                                                  02930808
029310     PERFORM VARYING TRN-INDEX FROM 1 BY 1                        02931008
029320       UNTIL TBL-AP-TRN-CDE(TRN-INDEX) = SAVE-AP-TRN-CDE          02932008
029330          OR TRN-INDEX > 15                                       02933008
029340     END-PERFORM.                                                 02934008
029350                                                                  02935008
029360     IF  TRN-INDEX > 15                                           02936008
029380         MOVE 'C200-FIND-TRANCODE-ENTRY' TO WS-ABEND-PARAGRAPH    02938008
029390         SET AP-TABLE-NOTFND TO TRUE                              02939008
029391         DISPLAY 'SAVE-AP-TRN-CDE = ' SAVE-AP-TRN-CDE             02939108
029392         MOVE 'TRANCODE TABLE ENTRY NOT FOUND' TO WS-MESSAGE-1    02939208
029395         PERFORM Z998-ABEND                                       02939508
029396     END-IF.                                                      02939608
029400*----------------------------------------------------------------*02940001
029600*  OPENS THE TRANCODE CURSOR AND FETCHES UNTIL END, LOADING EACH *02960007
029610*  ENTRY INTO THE TRANCODE TABLE IN WORKING STORAGE.             *02961007
029700*----------------------------------------------------------------*02970001
029900 D100-LOAD-TRANCODES.                                             02990007
029910                                                                  02991007
029911     PERFORM X100-OPEN-TRANCODE-CSR.                              02991107
029912                                                                  02991207
029913     SET TRN-INDEX TO 1.                                          02991311
029914     PERFORM S300-FETCH-TRANCODE-CSR.                             02991407
029915                                                                  02991507
029916     PERFORM UNTIL PS-END-OF-TRANCODES OR TRN-INDEX > 15          02991607
029918        MOVE TRNCDE-AP-TRN-CDE   TO TBL-AP-TRN-CDE(TRN-INDEX)     02991807
029919        MOVE TRNCDE-PSTG-TYP-CDE TO TBL-PSTG-TYP-CDE(TRN-INDEX)   02991907
029920        MOVE TRNCDE-TRN-TYP-CDE  TO TBL-TRN-TYP-CDE(TRN-INDEX)    02992007
029921        MOVE TRNCDE-AUTO-OFFST-TRN-CDE                            02992107
029922                              TO TBL-AUTO-OFFST-TRN-CDE(TRN-INDEX)02992207
029923        MOVE TRNCDE-GL-ACCT-NBR  TO TBL-GL-ACCT-NBR(TRN-INDEX)    02992307
029924        SET TRN-INDEX UP BY 1                                     02992411
029925        PERFORM S300-FETCH-TRANCODE-CSR                           02992513
029926     END-PERFORM.                                                 02992607
029927                                                                  02992707
029928     PERFORM X200-CLOSE-TRANCODE-CSR.                             02992808
029929                                                                  02992907
029930     IF  TRN-INDEX > 15                                           02993007
029931     AND NOT PS-END-OF-TRANCODES                                  02993107
029932         MOVE 'D100-LOAD-TRANCODES' TO WS-ABEND-PARAGRAPH         02993207
029933         SET AP-TABLE-FULL TO TRUE                                02993307
029934         MOVE 'MAX NUMBER OF ENTRIES EXCEEDED ON TRANCODE TABLE'  02993407
029935                                    TO WS-MESSAGE-1               02993507
029936         MOVE 'QUERY TTRNCDE FOR BTCH SRC = VDA AND EXPAND LIMIT' 02993607
029937                                    TO WS-MESSAGE-2               02993707
029938         PERFORM Z998-ABEND                                       02993807
029939     END-IF.                                                      02993907
029940                                                                  02994007
029941*----------------------------------------------------------------*02994107
029942*  R100-READ-VNDAGR-ACTVTY-FILE                                  *02994207
029943*  READS THE INPUT FILE INTO THE APRD081 COPYBOOK.               *02994307
029950*----------------------------------------------------------------*02995007
029960                                                                  02996007
029970 R100-READ-VNDAGR-ACTVTY-FILE.                                    02997007
030000                                                                  03000001
030100     READ VNDAGR-ACTVTY-FILE INTO AP081-VNDAGR-EXTRACT            03010003
030200         AT END                                                   03020001
030300            SET ACTVTY-EOF TO TRUE.                               03030001
030400                                                                  03040001
030500     IF NOT ACTVTY-EOF                                            03050001
030600        ADD 1 TO INPUT-COUNT                                      03060001
030700     END-IF.                                                      03070001
030800                                                                  03080001
030900                                                                  03090001
031000*----------------------------------------------------------------*03100001
031100*  S100-GET-NEXT-DOC-NBR                                         *03110001
031200*  SELECT THE NEXT AVAILABLE DOC NUMBER FROM THE TAPCNTL TABLE.  *03120001
031300*----------------------------------------------------------------*03130001
031400                                                                  03140001
031500 S100-GET-NEXT-DOC-NBR.                                           03150001
031600                                                                  03160001
031700     CALL DP951-AJ-NEXT-DOC-NBR-ROUTINE                           03170022
031700                     USING WS151-DOC-NBR-PARAMETERS.              03171021
031800                                                                  03180001
031900     IF WS151-ERRORS-FOUND                                        03190001
032000        SET AC-BAD-DATA TO TRUE                                   03200001
032100        MOVE 'S100-GET-NEXT-DOC-NBR     '                         03210001
032200                                   TO WS-ABEND-PARAGRAPH          03220001
032300        MOVE WS151-ERROR-MESSAGE   TO WS-MESSAGE-1                03230007
032500        MOVE WS151-SQLCODE         TO WS-MESSAGE-2                03250001
032600        PERFORM Z998-ABEND                                        03260001
032700     END-IF.                                                      03270001
032800                                                                  03280001
032900*----------------------------------------------------------------*03290001
033000*  S300-FETCH-TRANCODE-CSR                                       *03300007
033300*----------------------------------------------------------------*03330001
033500 S300-FETCH-TRANCODE-CSR.                                         03350007
033600                                                                  03360001
034400     EXEC SQL                                                     03440007
034500          FETCH TRANCODE_CSR                                      03450007
034700           INTO :TRNCDE-AP-TRN-CDE                                03470012
034800              , :TRNCDE-PSTG-TYP-CDE                              03480007
034900              , :TRNCDE-TRN-TYP-CDE                               03490007
035000              , :TRNCDE-AUTO-OFFST-TRN-CDE                        03500007
035200              , :TRNCDE-GL-ACCT-NBR                               03520007
035400     END-EXEC.                                                    03540007
035500                                                                  03550001
035600     EVALUATE TRUE                                                03560007
035700         WHEN SQLCODE = +0                                        03570007
035800              CONTINUE                                            03580007
035900         WHEN SQLCODE = +100                                      03590007
036000              SET PS-END-OF-TRANCODES TO TRUE                     03600007
036500                                                                  03650007
036600         WHEN SQLWARN0 NOT = SPACES                               03660007
036700         WHEN SQLCODE < +0                                        03670007
036800         WHEN SQLCODE > +0                                        03680007
036900              MOVE 'S300-FETCH-TRANCODE-CSR'                      03690007
037000                                TO WS-ABEND-PARAGRAPH             03700007
037100              MOVE 'UNSUCCESSFUL FETCH ON TRANCODE CSR'           03710007
037200                                TO WS-ABEND-OPERATION             03720007
037300              MOVE 'TTRNCDE '   TO WS-ABEND-STRUCTURE-1           03730007
037400              MOVE SPACES       TO WS-ABEND-STRUCTURE-2           03740007
037500              PERFORM Z999-SQL-ERROR                              03750007
037600     END-EVALUATE.                                                03760007
037800                                                                  03780001
038900*----------------------------------------------------------------*03890001
039000*  S400-SELECT-DATES                                             *03900001
039100*  SELECT BATCH PROCESS DATE, CURRENT POSTING FISCAL YEAR,       *03910001
039200*  CURRENT POSTING FISCAL MONTH, AND CURRENT POSTING FISCAL WEEK *03920001
039300*  FROM THE TAPCNTL TABLE.                                       *03930001
039310*  NOTE THAT PREV_WK_END_DTE IS ALWAYS THE SATURDAY OF THE WEEK  *03931002
039320*  JUST ENDED AT THE TIME THIS JOB RUNS IN PRODUCTION, SO ADDING *03932002
039330*  2 DAYS GIVES THE MONDAY DATE, WHICH IS WHEN THE TRANSACTIONS  *03933002
039340*  BEING CREATED IN THIS PROGRAM WILL ACTUALLY POST.             *03934002
039400*----------------------------------------------------------------*03940001
039600 S400-SELECT-DATES.                                               03960001
039700                                                                  03970001
040500     EXEC SQL                                                     04050007
040600          SELECT BTCH_PRC_DTE                                     04060007
040700               , (PREV_WK_END_DTE + 2 DAYS)                       04070007
040800               , CURR_PSTG_FYR_NBR                                04080007
040900               , CURR_PSTG_FMN_NBR                                04090007
041000               , CURR_PSTG_FWK_NBR                                04100007
041010               , PREV_PSTG_FYR_NBR                                04101007
041020               , PREV_PSTG_FMN_NBR                                04102007
041030               , PREV_PSTG_FWK_NBR                                04103007
041040               , MULT_PSTG_PER_IND                                04104007
041100          INTO   :APCNTL-BTCH-PRC-DTE                             04110007
041200               , :PV-ENTR-DTE                                     04120007
041300               , :APCNTL-CURR-PSTG-FYR-NBR                        04130007
041400               , :APCNTL-CURR-PSTG-FMN-NBR                        04140007
041500               , :APCNTL-CURR-PSTG-FWK-NBR                        04150007
041510               , :APCNTL-PREV-PSTG-FYR-NBR                        04151007
041520               , :APCNTL-PREV-PSTG-FMN-NBR                        04152007
041530               , :APCNTL-PREV-PSTG-FWK-NBR                        04153007
041540               , :APCNTL-MULT-PSTG-PER-IND                        04154007
041600          FROM   TAPCNTL                                          04160007
041700     END-EXEC.                                                    04170007
041800                                                                  04180007
041900     EVALUATE TRUE                                                04190007
042000         WHEN SQLCODE = +0                                        04200007
042300              CONTINUE                                            04230007
042500         WHEN SQLWARN0 NOT = SPACES                               04250007
042600         WHEN SQLCODE < +0                                        04260007
042700         WHEN SQLCODE > +0                                        04270007
042800              MOVE 'S400-SELECT-DATES' TO WS-ABEND-PARAGRAPH      04280007
043000              MOVE 'UNSUCCESSFUL SELECT DATES'                    04300007
043100                                       TO WS-ABEND-OPERATION      04310007
043200              MOVE 'TAPCNTL '          TO WS-ABEND-STRUCTURE-1    04320007
043300              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    04330007
043400              PERFORM Z999-SQL-ERROR                              04340007
043500     END-EVALUATE.                                                04350007
043700                                                                  04370001
044800*----------------------------------------------------------------*04480001
044900*  S500-SET-CURENT-TMST  GETS THE CURRENT TIMESTAMP FROM DB2.    *04490001
045000*----------------------------------------------------------------*04500001
045100                                                                  04510001
045200 S500-SET-CURRENT-TMST.                                           04520001
045300                                                                  04530001
046000                                                                  04600001
046100     EXEC SQL                                                     04610008
046200          SET :PV-CURR-TMST = CURRENT TIMESTAMP                   04620008
046300     END-EXEC.                                                    04630008
046400                                                                  04640008
046500     EVALUATE TRUE                                                04650008
046600         WHEN SQLCODE = +0                                        04660008
046900              CONTINUE                                            04690008
047100         WHEN SQLWARN0 NOT = SPACES                               04710008
047200         WHEN SQLCODE < +0                                        04720008
047300         WHEN SQLCODE > +0                                        04730008
047400              MOVE 'S500-SET-CURRENT-TMST' TO WS-ABEND-PARAGRAPH  04740008
047600              MOVE 'UNSUCCESSFUL SET TMST' TO WS-ABEND-OPERATION  04760008
047800              MOVE SPACES TO WS-ABEND-STRUCTURE-1                 04780008
047900                             WS-ABEND-STRUCTURE-2                 04790008
048000              PERFORM Z999-SQL-ERROR                              04800008
048100     END-EVALUATE.                                                04810008
049600                                                                  04960001
049700*----------------------------------------------------------------*04970001
049800*  W200-WRITE-OUTPUT-JRNL-REC                                    *04980001
049900*  WRITES TO THE JOURNALIZED OUTPUT FILE.                        *04990001
050000*----------------------------------------------------------------*05000001
050100                                                                  05010001
050200 W200-WRITE-OUTPUT-JRNL-REC.                                      05020001
050300                                                                  05030001
050400     WRITE ADJUST-JRNL-RECORD FROM AP045-TRANSACTION-FILE.        05040001
050500                                                                  05050001
050600     ADD 1 TO OUT-ADJUSTMENT-COUNT.                               05060001
050700                                                                  05070001
050900*----------------------------------------------------------------*05090001
051100*  OPEN TRANCODE CURSOR.                                         *05110008
051200*----------------------------------------------------------------*05120001
051300 X100-OPEN-TRANCODE-CSR.                                          05130008
051310                                                                  05131008
051311     EXEC SQL                                                     05131108
051312         OPEN TRANCODE_CSR                                        05131208
051313     END-EXEC.                                                    05131308
051314                                                                  05131408
051315     EVALUATE TRUE                                                05131508
051316         WHEN SQLCODE = ZERO                                      05131608
051318              CONTINUE                                            05131808
051320         WHEN SQLWARN0 NOT = SPACES                               05132008
051321         WHEN SQLCODE  NOT = ZERO                                 05132108
051322              MOVE 'X100-OPEN-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH 05132208
051324              MOVE 'UNSUCCESSFUL OPEN ON TRANCODE_CSR'            05132408
051325                                       TO WS-ABEND-OPERATION      05132508
051326              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    05132608
051327              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    05132708
051328              PERFORM Z999-SQL-ERROR                              05132808
051334     END-EVALUATE.                                                05133408
051340                                                                  05134008
051353*----------------------------------------------------------------*05135308
051354*  CLOSE TRANCODE CURSOR.                                        *05135408
051355*----------------------------------------------------------------*05135508
051356 X200-CLOSE-TRANCODE-CSR.                                         05135608
051357                                                                  05135708
051358     EXEC SQL                                                     05135808
051359         CLOSE TRANCODE_CSR                                       05135908
051360     END-EXEC.                                                    05136008
051361                                                                  05136108
051362     EVALUATE TRUE                                                05136208
051363         WHEN SQLCODE = ZERO                                      05136308
051364              CONTINUE                                            05136408
051366         WHEN SQLWARN0 NOT = SPACES                               05136608
051367         WHEN SQLCODE  NOT = ZERO                                 05136708
051368              MOVE 'X200-CLOSE-TRANCODE-CSR' TO WS-ABEND-PARAGRAPH05136808
051369              MOVE 'UNSUCCESSFUL CLOSE ON TRANCODE_CSR'           05136908
051370                                       TO WS-ABEND-OPERATION      05137008
051371              MOVE 'TTRNCDE '          TO WS-ABEND-STRUCTURE-1    05137108
051372              MOVE SPACE               TO WS-ABEND-STRUCTURE-2    05137208
051373              PERFORM Z999-SQL-ERROR                              05137308
051380     END-EVALUATE.                                                05138008
051381                                                                  05138108
051382*----------------------------------------------------------------*05138208
051384*  GENERAL ABEND ROUTINE                                         *05138408
051385*----------------------------------------------------------------*05138508
051390 Z998-ABEND.                                                      05139008
051400                                                                  05140001
051500     DISPLAY WS-ABEND-LITERAL.                                    05150001
051600     DISPLAY WS-ABEND-PROGRAM-MSG.                                05160001
051700     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              05170001
051800     DISPLAY WS-MESSAGE-LINE-1.                                   05180001
051900     DISPLAY WS-MESSAGE-LINE-2.                                   05190001
052000                                                                  05200001
052100     CALL 'ILBOABN0' USING ABEND-CODE.                            05210001
052200                                                                  05220001
052300*----------------------------------------------------------------*05230001
052400*  PROCESS DB2 ABENDS.                                           *05240001
052500*----------------------------------------------------------------*05250001
052700 Z999-SQL-ERROR.                                                  05270001
052800                                                                  05280001
052900     DISPLAY '*** DB2 ERROR '.                                    05290001
053000     DISPLAY WS-ABEND-PROGRAM-MSG.                                05300001
053100     DISPLAY WS-ABEND-PARAGRAPH-MSG.                              05310001
053200     DISPLAY WS-ABEND-OPERATION-MSG.                              05320001
053300     DISPLAY WS-ABEND-TABLE1-MSG.                                 05330001
053400     IF WS-ABEND-STRUCTURE-2 > SPACES                             05340001
053500         DISPLAY WS-ABEND-TABLE2-MSG.                             05350001
053600                                                                  05360001
053700     SET AP-DB2-ERROR              TO TRUE.                       05370001
053800                                                                  05380001
053900     COPY DPPD004.                                                05390001
054000     CALL 'ILBOABN0' USING ABEND-CODE.                            05400001
