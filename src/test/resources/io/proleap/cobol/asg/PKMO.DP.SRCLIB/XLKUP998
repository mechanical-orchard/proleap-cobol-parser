000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    XLKUP998.                                         00040000
000500 AUTHOR.        DAN HINTZ.                                        00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   JUNE 2003.                                        00070003
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*  THIS BATCH DB2 PROGRAM LOADS XLT_PK_CPT_SKU FROM THE ERROR     00100000
001000*  FILE.  ONLY THOSE RECORDS THAT STATE 'NOT ON DOMAIN PACK SKU'  00110000
001000*  WILL BE INSERTED INTO THE TABLE.  THIS IS BEING DONE FOR DATA  00120000
001000*  CLEANUP PURPOSES THAT CAN BE DONE WHILE THE TABLES ARE ACTIVE. 00121000
001400***************************************************************** 00122000
001500 ENVIRONMENT DIVISION.                                            00123000
001600 INPUT-OUTPUT SECTION.                                            00124000
001700                                                                  00125000
001800 FILE-CONTROL.                                                    00126000
001900                                                                  00127000
002000     SELECT PACKSKU-IN                                            00128000
002010         ASSIGN TO INP01.                                         00129000
002100                                                                  00130000
002200***************************************************************** 00140000
002300 DATA DIVISION.                                                   00150000
002400***************************************************************** 00160000
002500 FILE SECTION.                                                    00170000
002600                                                                  00180000
002700 FD  PACKSKU-IN                                                   00190000
002800     RECORDING MODE IS F                                          00200000
002810     BLOCK CONTAINS 0 RECORDS                                     00210000
002900     LABEL RECORDS ARE STANDARD.                                  00220000
003000                                                                  00230000
003300 01  PACKSKU-IN-RECORD           PIC X(144).                      00240000
003700                                                                  00250000
003800                                                                  00260000
003900***************************************************************** 00270000
004000 WORKING-STORAGE SECTION.                                         00280000
004100                                                                  00281000
       01  PA-DB2-COMMIT-COUNT              PIC S9(09) VALUE +0         00282000
                                                          COMP-3.       00283000
004200 01  PS-PROGRAM-SWITCHES.                                         00284000
004300     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00285000
004400         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00286000
004500         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00287000
004600                                                                  00288000
004700 01  PC-PROGRAM-CONSTANTS.                                        00289000
004800     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XLKUP998'.00290000
005000                                                                  00300000
005100 01  PV-PROGRAM-VARIABLES.                                        00310000
005900     05  PV-RECORDS-READ              PIC  9(09) VALUE  0.        00320000
006000     05  PV-RECORDS-INSERTED          PIC  9(09) VALUE  0.        00330000
006000     05  PV-RECORDS-SKIP              PIC  9(09) VALUE  0.        00340000
006000     05  PV-RECORDS-UPDATED           PIC  9(09) VALUE  0.        00341002
006400     05  PV-DISP-PK-SKU               PIC  9(08) VALUE  0.        00350000
           05  PV-DISP-CPT-SKU              PIC  9(08) VALUE  0.        00360000
006700     05  PV-SQLCODE                   PIC  S9(9) VALUE +0.        00370000
006800     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00380000
006900                                                                  00390000
007000                                                                  00400000
007100 01  PV-ABEND-FIELDS.                                             00410000
007200     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00420000
007300                                                 COMP SYNC.       00430000
007400     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'XLKUP998'.00440000
007500     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00450000
007600     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00460000
007700     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00470000
007900     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00480000
008000     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00490000
008100     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00500000
008200                                                                  00510000
008300                                                                  00520000
008400***********************************************************       00530000
008500*  COPYBOOK USED FOR PACK DATA INPUT FILE                 *       00540002
008600***********************************************************       00550000
008700     COPY XLRD030.                                                00560000
008800                                                                  00570000
008900***********************************************************       00580000
009000*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00590000
009100***********************************************************       00600000
009200     COPY DPWS004.                                                00610000
009300                                                                  00620000
009400***********************************************************       00630000
009500*  DB2 SQL COMMUNICATION AREA                             *       00640000
009600***********************************************************       00650000
009700     EXEC SQL                                                     00660000
009800          INCLUDE SQLCA                                           00670000
009900     END-EXEC.                                                    00680000
010000                                                                  00690000
010100***********************************************************       00700000
010200*  XLT_PK_CPT_SKU                                         *       00710000
010300***********************************************************       00720000
010400     EXEC SQL                                                     00730000
010500          INCLUDE XLT00008                                        00740000
010600     END-EXEC.                                                    00750000
010700                                                                  00760000
010800***************************************************************** 00770000
010900 PROCEDURE DIVISION.                                              00780000
011000***************************************************************** 00790000
011100     DISPLAY '**** BEGINNING XLKUP998 ****'.                      00800000
011200     DISPLAY ' '.                                                 00810000
011300                                                                  00820000
011400     OPEN INPUT  PACKSKU-IN.                                      00830000
011500                                                                  00840000
011600     PERFORM 1000-READ-INPUT-FILE.                                00850000
011700                                                                  00860000
012100     PERFORM 2000-PROCESS-INPUT-FILE                              00870000
012200       UNTIL PS-EOF-INPUT-YES.                                    00880000
012300                                                                  00890000
012400     CLOSE PACKSKU-IN.                                            00900000
012500                                                                  00910000
012510     PERFORM 3000-TABLE-COMMIT.                                   00920000
012520                                                                  00930000
012600     DISPLAY 'INPUT PACKSKU RECS READ     = ' PV-RECORDS-READ.    00940000
012700     DISPLAY 'XKT_PK_CPT_SKU ROWS INSERT  = ' PV-RECORDS-INSERTED.00950000
012700     DISPLAY 'XLT_PK_CPT_SKU ROWS SKIPPED = ' PV-RECORDS-SKIP.    00960000
012700     DISPLAY 'XLT_PK_CPT_SKU ROWS UPDATED = ' PV-RECORDS-UPDATED. 00961002
012800     DISPLAY ' '.                                                 00970000
012900     DISPLAY '****  END OF  XLKUP998  ****'.                      00980000
013000                                                                  00990000
013100     GOBACK.                                                      01000000
013200                                                                  01010000
013300                                                                  01020000
013400***************************************************************** 01030000
013500*  READ A PACKSKU EXTRACT RECORD THAT WILL BE USED TO INSERT    * 01040000
013510*  A ROW OF DATA INTO THE XLT_PK_CPT_SKU TABLE.                 * 01050000
013600***************************************************************** 01060000
013700 1000-READ-INPUT-FILE.                                            01070000
013800                                                                  01080000
013900     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       01090000
014000                                                                  01100000
014010     INITIALIZE XL030-PACKSKU-PK-CPT-SKU                          01110000
                      PA-DB2-COMMIT-COUNT.                              01120000
014020                                                                  01130000
014100     READ PACKSKU-IN                                              01140000
014200          INTO XL030-PACKSKU-PK-CPT-SKU                           01150000
014300            AT END                                                01160000
014400               SET PS-EOF-INPUT-YES TO TRUE                       01170000
014500                                                                  01180000
014600            NOT AT END                                            01190000
014700               SET PS-EOF-INPUT-NO  TO TRUE                       01200000
014800               ADD +1 TO PV-RECORDS-READ                          01210000
014900     END-READ.                                                    01220000
015000                                                                  01230000
015100                                                                  01240000
015200***************************************************************** 01250000
015300*  LOAD THE INFORMATION FROM THE PACKSKU EXTRACT FILE INTO THE  * 01260000
015310*  HOST VARIABLES AND PERFORM A PARAGRAPH TO INSERT THE NEW ROW * 01270000
015320*  INTO THE XLT_PK_CPT_SKU TABLE FOR 'NOT ON DOMAIN PACK SKU'   * 01280002
015320*  MESSAGE.  WE WILL UPDATE THE XLT_PK_CPT_SKU WITH THE CORRECT * 01281002
015320*  RMS DATA FOR THE 'DATA MISMATCH - RMS' MESSAGE.              * 01282002
015400***************************************************************** 01290000
015500 2000-PROCESS-INPUT-FILE.                                         01300000
015600                                                                  01310000
015700     MOVE '2000-PROCESS-INPUT-FILE '   TO PV-ABEND-PARAGRAPH.     01320000
015800                                                                  01330000
016361     MOVE XL030-PKSKU-PK-SKU-NBR       TO XLT00008-PK-SKU-NBR.    01340000
016362     MOVE XL030-PKSKU-CPT-SKU-NBR      TO XLT00008-CPT-SKU-NBR.   01350000
           MOVE XL030-PKSKU-PK-RATO-UNT-QTY                             01360000
                               TO XLT00008-PK-RATIO-UNT-QTY             01370000
016380                                                                  01380000
016400     IF  XL030-PKSKU-ERROR-MESSAGE = 'NOT ON DOMAIN PACK SKU'     01390000
016400         PERFORM 2100-INSERT-XLT-PK-CPT-SKU                       01400000
016400     ELSE                                                         01401002
016400         IF  XL030-PKSKU-ERROR-MESSAGE = 'DATA MISMATCH - RMS'    01402002
016400             PERFORM 2200-UPDATE-XLT-PK-CPT-SKU                   01403002
016400         END-IF                                                   01410003
016400     END-IF.                                                      01411002
017700                                                                  01420000
017800     PERFORM 1000-READ-INPUT-FILE.                                01430000
018500                                                                  01440000
018600                                                                  01450000
021600***************************************************************** 01460000
021700*  INSERT A ROW TO THE XLT_PK_CPT_SKU TABLE                     * 01470000
021800***************************************************************** 01480000
021900 2100-INSERT-XLT-PK-CPT-SKU.                                      01490000
022000                                                                  01500000
022100     EXEC SQL                                                     01510000
022200          INSERT                                                  01520000
022300          INTO  XLT_PK_CPT_SKU                                    01530000
023093              ( PK_SKU_NBR                                        01540000
023094               ,CPT_SKU_NBR                                       01550000
023095               ,PK_RATIO_UNT_QTY                                  01560001
                     ,LAST_UPD_TMST)                                    01561001
023200          VALUES                                                  01570000
023993             (  :XLT00008-PK-SKU-NBR                              01580000
023994               ,:XLT00008-CPT-SKU-NBR                             01590000
023995               ,:XLT00008-PK-RATIO-UNT-QTY                        01600001
                     ,CURRENT TIMESTAMP)                                01601001
024010     END-EXEC.                                                    01610000
024100                                                                  01620000
024200     EVALUATE TRUE                                                01630000
024300         WHEN SQLCODE = ZERO                                      01640000
024400              ADD +1                 TO PV-RECORDS-INSERTED       01650000
                    ADD +1                 TO PA-DB2-COMMIT-COUNT       01660000
                    IF PA-DB2-COMMIT-COUNT > 4500                       01670000
                        PERFORM 3000-TABLE-COMMIT                       01680000
                        MOVE 0 TO PA-DB2-COMMIT-COUNT                   01690000
                    END-IF                                              01700000
               WHEN SQLCODE = -803                                      01710000
014800              ADD +1 TO PV-RECORDS-SKIP                           01720000
024500         WHEN SQLCODE NOT = +0                                    01730000
024600              MOVE '2100-INSERT-XLT-PK-CPT-SKU'                   01740000
024700                                     TO PV-ABEND-PARAGRAPH        01750000
024800              MOVE 'INSERT XLT_PK_CPT_SKU'                        01760000
024810                                     TO PV-ABEND-OPERATION        01770000
024821              MOVE XL030-PKSKU-PK-SKU-NBR                         01780000
024821                                     TO PV-DISP-PK-SKU            01790000
                    MOVE XL030-PKSKU-CPT-SKU-NBR                        01800000
                                           TO PV-DISP-CPT-SKU           01810000
025500              STRING 'PK SKU NBR: '           DELIMITED BY SIZE   01820000
025600                     PV-DISP-PK-SKU           DELIMITED BY SIZE   01830000
026100                     '  CPT SKU: '            DELIMITED BY SIZE   01840000
026200                     PV-DISP-CPT-SKU          DELIMITED BY SIZE   01850000
026700                                   INTO PV-DB2-OPERATION-MESSAGE-101860000
026800                                                                  01870000
026900              MOVE 'XLT_PK_CPT_SKU'  TO PV-ABEND-TABLE            01880000
027000              PERFORM Z999-SQL-ABEND                              01890000
027100     END-EVALUATE.                                                01900000
027200                                                                  01910000
027300                                                                  01920000
021600***************************************************************** 01921002
021700*  UPDATE A ROW ON THE XLT_PK_CPT_SKU TABLE                     * 01922002
021800***************************************************************** 01923002
021900 2200-UPDATE-XLT-PK-CPT-SKU.                                      01924002
022000                                                                  01925002
022100     EXEC SQL                                                     01926002
022300          UPDATE XLT_PK_CPT_SKU                                   01928002
                   SET PK_RATIO_UNT_QTY = :XLT00008-PK-RATIO-UNT-QTY    01929202
                      ,LAST_UPD_TMST    = CURRENT TIMESTAMP             01929302
023200           WHERE PK_SKU_NBR       = :XLT00008-PK-SKU-NBR          01929402
023200             AND CPT_SKU_NBR      = :XLT00008-CPT-SKU-NBR         01929502
024010     END-EXEC.                                                    01929902
024100                                                                  01930002
024200     EVALUATE TRUE                                                01930102
024300         WHEN SQLCODE = ZERO                                      01930202
024400              ADD +1                 TO PV-RECORDS-UPDATED        01930302
                    ADD +1                 TO PA-DB2-COMMIT-COUNT       01930402
                    IF PA-DB2-COMMIT-COUNT > 4500                       01930502
                        PERFORM 3000-TABLE-COMMIT                       01930602
                        MOVE 0 TO PA-DB2-COMMIT-COUNT                   01930702
                    END-IF                                              01930802
               WHEN SQLCODE = +100                                      01930902
014800              ADD +1 TO PV-RECORDS-SKIP                           01931002
024500         WHEN SQLCODE NOT = +0                                    01931102
024600              MOVE '2200-UPDATE-XLT-PK-CPT-SKU'                   01931202
024700                                     TO PV-ABEND-PARAGRAPH        01931302
024800              MOVE 'UPDATE XLT_PK_CPT_SKU'                        01931402
024810                                     TO PV-ABEND-OPERATION        01931502
024821              MOVE XL030-PKSKU-PK-SKU-NBR                         01931602
024821                                     TO PV-DISP-PK-SKU            01931702
                    MOVE XL030-PKSKU-CPT-SKU-NBR                        01931802
                                           TO PV-DISP-CPT-SKU           01931902
025500              STRING 'PK SKU NBR: '           DELIMITED BY SIZE   01932002
025600                     PV-DISP-PK-SKU           DELIMITED BY SIZE   01932102
026100                     '  CPT SKU: '            DELIMITED BY SIZE   01932202
026200                     PV-DISP-CPT-SKU          DELIMITED BY SIZE   01932302
026700                                   INTO PV-DB2-OPERATION-MESSAGE-101932402
026800                                                                  01932502
026900              MOVE 'XLT_PK_CPT_SKU'  TO PV-ABEND-TABLE            01932602
027000              PERFORM Z999-SQL-ABEND                              01932702
027100     END-EVALUATE.                                                01932802
027200                                                                  01932902
027300                                                                  01933002
027400***************************************************************** 01934002
027500* COMMIT THE PENDING TABLE CHANGES.                             * 01940000
027600***************************************************************** 01950000
027700 3000-TABLE-COMMIT.                                               01960000
027800                                                                  01970000
027900     EXEC SQL                                                     01980000
028000          COMMIT                                                  01990000
028100     END-EXEC.                                                    02000000
028200                                                                  02010000
028300                                                                  02020000
028400***************************************************************** 02030000
028500*  DISPLAY DB2 ERROR INFORMATION, ROLLBACK ANY PENDING CHANGES, * 02040000
028510*  AND ABEND THE PROGRAM.                                       * 02050000
028600***************************************************************** 02060000
028700 Z999-SQL-ABEND.                                                  02070000
028800                                                                  02080000
028900     MOVE SQLCODE            TO PV-SQLCODE.                       02090000
029000     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  02100000
029100     DISPLAY '*** DB2 ERROR '.                                    02110000
029200     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  02120000
029300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02130000
029400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02140000
029500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02150000
029600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02160000
029700     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02170000
029800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02180000
029900     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE.                   02190000
030000                                                                  02200000
030100     COPY DPPD004.                                                02210000
030200                                                                  02220000
030300     MOVE +4013         TO PV-ABEND-CODE.                         02230000
030400     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02240000
