000100 TITLE 'COPY PKMO.RC.DIRECT.SHIP.ERR.LOG.BKUP TO FLAT FILE'.      00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300* ------------------------------------------------------------- * 00030001
000400 PROGRAM-ID.      RCKUT080.                                       00040001
000500 AUTHOR.          LYNN MCADAMS.                                   00050001
000600 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00060001
000700 DATE-WRITTEN.    MAY, 2005.                                      00070001
000800                                                                  00080001
000900******************************************************************00090005
001000*  I M P O R T A N T --- WHEN COMPILING THIS PROGRAM THE MQ SERIES00100005
001100*  SWITCH ON THE 2ND COMPILE SCREEN NEEDS TO BE SET TO 'Y'.       00110005
001200*  THIS PROGRAM USES MQSERIES.                                    00120005
001300*                                                                 00130005
001400******************************************************************00140005
001500***************************************************************** 00150001
001600*******      COPY ITEM MSG ERROR QUEUE TO FILE         ********** 00160001
001700***************************************************************** 00170001
001800*                                                               * 00180001
001900*                       PROGRAM  LOGIC                          * 00190001
002000*                       --------------                          * 00200001
002100*  MAIN                                                         * 00210001
002200*  ----                                                         * 00220001
002300*                                                               * 00230001
002400*   OPEN THE MESSAGE OUTPUT SEQUENTIAL FILE.                    * 00240001
002500*                                                               * 00250001
002600*   CONNECT TO THE QUEUE MANAGER.                               * 00260001
002700*   IF CONNECTION FAILED THEN                                   * 00270001
002800*            CALL 9000-DISPLAY-ERROR-MESSAGE AND EXIT           * 00280001
002900*                                                               * 00290001
003000*   OPEN THE SPECIFIED MESSAGE QUEUE (MQOPEN).                  * 00300001
003100*   IF OPEN FAILED THEN                                         * 00310001
003200*            DISCONNECT FROM QUEUE MANAGER                      * 00320001
003300*            CALL 9000-DISPLAY-ERROR-MESSAGE AND EXIT           * 00330001
003400*   ENDIF.                                                      * 00340001
003500*                                                               * 00350001
003600*   SET THE GET MESSAGE OPTIONS.                                * 00360001
003700*            GET MESSAGES FROM QUEUE (MQGET)                    * 00370001
003800*            IF GET FAILED                                      * 00380001
003900*                     CALL 9000-DISPLAY-ERROR-MESSAGE           * 00390001
004000*            ENDIF                                              * 00400001
004100*                                                               * 00410001
004200*   WRITE MESSAGE TO OUTPUT SEQUENTIAL FILE                     * 00420001
004300*                                                               * 00430001
004400*   CLOSE THE MESSAGE QUEUE.                                    * 00440001
004500*   IF CLOSE FAILED THEN                                        * 00450001
004600*            CALL 9000-DISPLAY-ERROR-MESSAGE.                   * 00460001
004700*                                                               * 00470001
004800*   DISCONNECT FROM THE QUEUE MANAGER.                          * 00480001
004900*   IF DISCONNECT FAILED THEN                                   * 00490001
005000*            CALL 9000-DISPLAY-ERROR-MESSAGE.                   * 00500001
005100*                                                               * 00510001
005200*   CLOSE THE MESSAGE OUTPUT FILE.                              * 00520001
005300*                                                               * 00530001
005400*   EXIT PROGRAM.                                               * 00540001
005500*                                                               * 00550001
005600***************************************************************** 00560001
005700* ------------------------------------------------------------- * 00570001
005800 ENVIRONMENT DIVISION.                                            00580001
005900* ------------------------------------------------------------- * 00590001
006000                                                                  00600001
006100 CONFIGURATION SECTION.                                           00610001
006200                                                                  00620001
006300 SOURCE-COMPUTER.       IBM-3090.                                 00630001
006400 OBJECT-COMPUTER.       IBM-3090.                                 00640001
006500                                                                  00650001
006600 INPUT-OUTPUT SECTION.                                            00660001
006700                                                                  00670001
006800 FILE-CONTROL.                                                    00680001
006900     SELECT CONTROL-CARD-1                                        00690001
007000            ASSIGN TO INP01.                                      00700001
007100     SELECT CONTROL-CARD-2                                        00710001
007200            ASSIGN TO INP02.                                      00720001
007300     SELECT MSG-EXTRACT                                           00730001
007400            ASSIGN TO OUT01.                                      00740001
007410     SELECT RCV-OVER-ERRORS                                       00741015
007420            ASSIGN TO OUT02.                                      00742015
007430     SELECT ERROR-OUT-FILE                                        00743019
007440         ASSIGN TO OUT03.                                         00744019
007450                                                                  00745019
007500                                                                  00750001
007600* ------------------------------------------------------------- * 00760001
007700 DATA DIVISION.                                                   00770001
007800* ------------------------------------------------------------- * 00780001
007900 FILE SECTION.                                                    00790001
008000                                                                  00800001
008100 FD  CONTROL-CARD-1                                               00810001
008200     RECORDING MODE F                                             00820001
008300     BLOCK CONTAINS 0 RECORDS                                     00830001
008400     LABEL RECORDS ARE OMITTED.                                   00840001
008500 01  CONTROL-CARD-1-LINE              PIC  X(80).                 00850001
008600                                                                  00860001
008700 FD  CONTROL-CARD-2                                               00870001
008800     RECORDING MODE F                                             00880001
008900     BLOCK CONTAINS 0 RECORDS                                     00890001
009000     LABEL RECORDS ARE OMITTED.                                   00900001
009100 01  CONTROL-CARD-2-LINE              PIC  X(80).                 00910001
009200                                                                  00920001
009300 FD  MSG-EXTRACT                                                  00930001
009400     RECORDING MODE F                                             00940001
009500     BLOCK CONTAINS 0 RECORDS                                     00950001
009600     LABEL RECORDS ARE OMITTED.                                   00960001
009700 01  MSG-EXTRACT-RECORD               PIC X(100).                 00970004
009710                                                                  00971015
009720 FD  RCV-OVER-ERRORS                                              00972015
009730     RECORDING MODE F                                             00973015
009740     BLOCK CONTAINS 0 RECORDS                                     00974015
009750     LABEL RECORDS ARE OMITTED.                                   00975015
009760 01  RCV-OVER-RECORD                  PIC X(100).                 00976015
009800                                                                  00980001
009810 FD  ERROR-OUT-FILE                                               00981019
009820     RECORDING MODE F                                             00982019
009830     BLOCK CONTAINS 0 RECORDS                                     00983019
009840     LABEL RECORDS ARE OMITTED.                                   00984019
009850 01  ERROR-OUT-RECORD                 PIC X(80).                  00985019
009860                                                                  00986019
009900* ------------------------------------------------------------- * 00990001
010000 WORKING-STORAGE SECTION.                                         01000001
010100* ------------------------------------------------------------- * 01010001
010200*                                                                 01020001
010300                                                                  01030001
010400                                                                  01040001
010500 01  WS-MQCONN               PIC X(8)  VALUE 'CSQBCONN'.          01050001
010600 01  WS-MQOPEN               PIC X(8)  VALUE 'CSQBOPEN'.          01060001
010700 01  WS-MQGET                PIC X(8)  VALUE 'CSQBGET'.           01070001
010800 01  WS-MQCLOSE              PIC X(8)  VALUE 'CSQBCLOS'.          01080001
010900 01  WS-MQDISC               PIC X(8)  VALUE 'CSQBDISC'.          01090001
011000 01  WS-MQCMIT               PIC X(8)  VALUE 'CSQBCOMM'.          01100001
011100 01  WS-MQBACK               PIC X(8)  VALUE 'CSQBBACK'.          01110001
011200*                                                                 01120001
011300*    GENERAL WORK FIELDS                                          01130001
011400*                                                                 01140001
011500 01  NUMRECS                 PIC 9(9)  VALUE ZEROS.               01150001
011600 01  NUMGETS                 PIC 9(9)  VALUE ZEROS.               01160035
011700 01  NUMPUTS                 PIC 9(9)  VALUE ZEROS.               01170001
011800 01  NUMCMTS                 PIC 9(9)  VALUE ZEROS.               01180001
011900 01  ERROR-MESSAGE           PIC X(48) VALUE SPACES.              01190001
012000 01  PV-PARAGRAPH            PIC X(48) VALUE SPACES.              01200001
012100 01  PV-CURRENT-TMST         PIC X(26) VALUE SPACES.              01210007
012200 01  PV-DB2-ERROR-COUNT      PIC S9(09) VALUE ZERO                01220014
012300                                        COMP SYNC.                01230014
012310 01  PV-RCVR-OVER-COUNT      PIC 9(9)  VALUE ZEROS.               01231015
012320 01  PV-MSG-RECORD           PIC X(80) VALUE SPACES.              01232019
012330 01  PV-DISP-VALUE           PIC Z(8)9.                           01233023
012400*                                                                 01240001
012500*   PARAMETER VARIABLES                                           01250001
012600*                                                                 01260001
012700 01  QM-NAME               PIC X(48).                             01270001
012800 01  QNAME                 PIC X(48).                             01280001
012900 01  PADCHAR               PIC X(1) VALUE '*'.                    01290001
013000 01  MSGBUFFER             PIC X(1000000) VALUE SPACES.           01300001
013100 01  NUMMSGS               PIC S9(9) BINARY VALUE 1.              01310001
013200 01  MSGLENGTH             PIC S9(9) BINARY VALUE +1000000.       01320001
013300 01  DATA-LENGTH           PIC S9(9) BINARY.                      01330001
013400 01  MQCHECK               PIC X(8) VALUE 'MQR2C'.                01340001
013500 01  MQ-REASON-TEXT        PIC X(30) VALUE SPACES.                01350001
013600 01  HOLD-REASON           PIC S9(9) BINARY.                      01360001
013700 01  HOLD-COMPLETION-CODE  PIC S9(9) BINARY.                      01370001
013800*                                                                 01380001
013900*    API FIELDS                                                   01390001
014000*                                                                 01400001
014100 01  HCONN                   PIC S9(9) BINARY VALUE 0.            01410001
014200 01  GQ-HANDLE               PIC S9(9) BINARY VALUE 0.            01420001
014300 01  OPEN-OPTIONS            PIC S9(9) BINARY.                    01430001
014400 01  COMPLETION-CODE         PIC S9(9) BINARY.                    01440001
014500 01  REASON                  PIC S9(9) BINARY.                    01450001
014600 01  CON-REASON              PIC S9(9) BINARY.                    01460001
014700                                                                  01470001
014800 01  PV-ABEND-VARIABLES.                                          01480001
014900     05  PV-ABEND-CODE              PIC S9(04) VALUE +0 COMP SYNC.01490001
015000     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 01500001
015100     88  ABEND-4002-READ-ERROR                       VALUE +4002. 01510001
015200     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 01520001
015300     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 01530001
015400     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 01540001
015500     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 01550001
015600     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 01560001
015700     88  ABEND-4008-DATA-ERROR                       VALUE +4008. 01570001
015800     88  ABEND-4009-KEY-DATA-ERROR                   VALUE +4009. 01580001
015900     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01590001
016000     88  ABEND-4019-CAL-SUB-ERROR                    VALUE +4019. 01600001
016100     88  ABEND-4020-MQ-ERROR                         VALUE +4020. 01610001
016200     88  ABEND-4444-FORCED-ABEND                     VALUE +4444. 01620001
016300                                                                  01630001
016400                                                                  01640001
016500  1  PE-MQ-ABEND-VARIABLES.                                       01650001
016600     10  PE-MQ-QMANAGER           PIC X(05) VALUE SPACES.         01660001
016700     10  PE-MQ-QNAME              PIC X(30) VALUE SPACES.         01670001
016800     10  PE-MQ-COMPLETION-CODE    PIC 9(04) VALUE ZEROS.          01680001
016900     10  PE-MQ-REASON-CODE        PIC 9(04) VALUE ZEROS.          01690001
017000                                                                  01700001
017100*                                                                 01710001
017200*    API CONTROL BLOCKS                                           01720001
017300*                                                                 01730001
017400 01  MQM-OBJECT-DESCRIPTOR.                                       01740001
017500     COPY CMQODV.                                                 01750001
017600 01  MQM-MESSAGE-DESCRIPTOR.                                      01760001
017700     COPY CMQMDV.                                                 01770001
017800 01  MQM-GET-MESSAGE-OPTIONS.                                     01780001
017900     COPY CMQGMOV.                                                01790001
018000*                                                                 01800001
018100*    MQV CONTAINS CONSTANTS (FOR FILLING IN THE CONTROL BLOCKS)   01810001
018200*    AND RETURN CODES (FOR TESTING THE RESULT OF A CALL)          01820001
018300*                                                                 01830001
018400 01  MQM-CONSTANTS.                                               01840001
018500     COPY CMQV.                                                   01850001
018600*                                                                 01860001
018700******************************************************************01870009
018800*  USED FOR DB2 ERROR MESSAGE BUILDING                            01880009
018900******************************************************************01890009
019000     COPY DPWS004.                                                01900009
019100                                                                  01910009
019200*----------------------------------------------------------------*01920009
019300*    ABEND PROCESSING COPYBOOK.                                  *01930009
019400*----------------------------------------------------------------*01940009
019500                                                                  01950009
019600     COPY DPWS013.                                                01960009
019700******************************************************************01970009
019800*   DB2 SQL COMMUNICATION AREA                                    01980009
019900******************************************************************01990009
020000     EXEC SQL                                                     02000009
020100          INCLUDE SQLCA                                           02010009
020200     END-EXEC.                                                    02020009
020300                                                                  02030009
020400*DB2 AREA FOR COMMUNICATIONS AREA2                                02040009
020500     COPY SQLCA2.                                                 02050009
020600                                                                  02060009
020700***********************************************************       02070008
020800*  RECORD LAYOUT - DIRECT SHIP                                    02080008
020900***********************************************************       02090008
021000*OUTPUT FILE LAYOUT                                               02100008
021100     COPY RCRD074.                                                02110008
021200*                                                                 02120008
021300*----------------------------------------------------------------*02130001
021400*    CONTROL CARD                                                 02140001
021500*----------------------------------------------------------------*02150001
021600 01  CC-CONTROL-CARD-1.                                           02160001
021700     05  CC-QMGR-NAME              PIC X(48).                     02170001
021800     05  FILLER                    PIC X(32).                     02180001
021900                                                                  02190001
022000 01  CC-CONTROL-CARD-2.                                           02200001
022100     05  CC-STORE-EOD-MSG-QNAME    PIC X(48).                     02210001
022200     05  FILLER                    PIC X(32).                     02220001
022300                                                                  02230001
022400*----------------------------------------------------------------*02240001
022500*    PROGRAM CONSTANTS                                            02250001
022600*----------------------------------------------------------------*02260001
022700     05  PC-PGM-NAME               PIC X(09) VALUE 'RCKUT080 '.   02270001
022800     05  PC-FIFTY-STARS            PIC X(50) VALUE ALL '*'.       02280001
022900                                                                  02290001
023000*----------------------------------------------------------------*02300001
023100*    PROGRAM SWITCHES                                             02310001
023200*----------------------------------------------------------------*02320001
023300 01  PS-PROGRAM-SWITCHES.                                         02330001
023400     05  PS-CONTROL-CARD-1-SW      PIC X(01) VALUE 'N'.           02340001
023500         88  PS-CONTROL-CARD-1-END           VALUE 'Y'.           02350001
023600         88  PS-CONTROL-CARD-1-START         VALUE 'N'.           02360001
023700     05  PS-CONTROL-CARD-2-SW      PIC X(01) VALUE 'N'.           02370001
023800         88  PS-CONTROL-CARD-2-END           VALUE 'Y'.           02380001
023900         88  PS-CONTROL-CARD-2-START         VALUE 'N'.           02390001
024000                                                                  02400001
024100 LINKAGE SECTION.                                                 02410001
024200 01  RUN-PARMS.                                                   02420001
024300     05  PARM-LENGTH     PIC S9(04) COMP.                         02430001
024400     05  PARM-USERID     PIC X(07).                               02440001
024500* ------------------------------------------------------------- * 02450001
024600 PROCEDURE DIVISION USING RUN-PARMS.                              02460001
024700* ------------------------------------------------------------- * 02470001
024800 1000-MAIN SECTION.                                               02480001
024900                                                                  02490001
024910     OPEN OUTPUT ERROR-OUT-FILE.                                  02491024
024920                                                                  02492024
025000* ------------------------------------------------------------- * 02500001
025100*  READ CONTROL CARD TO GET QUEUE MANAGER NAME                  * 02510001
025200* ------------------------------------------------------------- * 02520001
025300      SET PS-CONTROL-CARD-1-START TO TRUE.                        02530001
025400      OPEN INPUT CONTROL-CARD-1.                                  02540001
025500      READ CONTROL-CARD-1 INTO CC-CONTROL-CARD-1                  02550001
025600          AT END                                                  02560001
025700              SET PS-CONTROL-CARD-1-END                           02570001
025800                                  TO TRUE.                        02580001
025900                                                                  02590001
026000      IF PS-CONTROL-CARD-1-END                                    02600001
026100          DISPLAY PC-PGM-NAME                                     02610001
026200              'CONTROL CARD MISSING - FOR QMGR NAME'              02620001
026300          GO TO 4000-END-PROGRAM                                  02630001
026400      ELSE                                                        02640001
026410          MOVE  SPACES                TO  PV-MSG-RECORD           02641026
026461          DISPLAY PV-MSG-RECORD                                   02646119
026462          WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD               02646219
026463                                                                  02646326
026467          MOVE  PC-FIFTY-STARS        TO  PV-MSG-RECORD           02646727
026468          DISPLAY PV-MSG-RECORD                                   02646826
026469          WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD               02646926
026470                                                                  02647026
026471          MOVE  SPACES TO  PV-MSG-RECORD                          02647126
026472          DISPLAY PV-MSG-RECORD                                   02647226
026473          WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD               02647326
026474                                                                  02647426
026476          STRING  '*** '                                          02647626
026477                  PC-PGM-NAME '-'                                 02647726
026478                  CC-CONTROL-CARD-1      DELIMITED BY SIZE        02647826
026479                                    INTO PV-MSG-RECORD            02647926
026480          DISPLAY PV-MSG-RECORD                                   02648026
026481          WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD               02648126
026482                                                                  02648226
027100      END-IF.                                                     02710001
027200                                                                  02720001
027300      CLOSE CONTROL-CARD-1.                                       02730001
027400                                                                  02740001
027500* ------------------------------------------------------------- * 02750001
027600*  READ CONTROL CARD TO GET STORE EOD MSG QUEUE NAME            * 02760001
027700* ------------------------------------------------------------- * 02770001
027800                                                                  02780001
027900      SET PS-CONTROL-CARD-2-START TO TRUE.                        02790001
028000      OPEN INPUT CONTROL-CARD-2.                                  02800001
028100      READ CONTROL-CARD-2 INTO CC-CONTROL-CARD-2                  02810001
028200          AT END                                                  02820001
028300              SET PS-CONTROL-CARD-2-END                           02830001
028400                                  TO TRUE.                        02840001
028500                                                                  02850001
028600      IF PS-CONTROL-CARD-2-END                                    02860001
028700          DISPLAY PC-PGM-NAME                                     02870001
028800             'CONTROL CARD MISSING - STORE EOD MSG QUEUE NAME'    02880001
028900          GO TO 4000-END-PROGRAM                                  02890001
029000      ELSE                                                        02900001
029010          MOVE  SPACES TO  PV-MSG-RECORD                          02901029
029020          STRING  '*** '                                          02902029
029030                  '         -'                                    02903029
029040                  CC-CONTROL-CARD-2      DELIMITED BY SIZE        02904029
029050                                    INTO PV-MSG-RECORD            02905029
029060          DISPLAY PV-MSG-RECORD                                   02906029
029070          WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD               02907029
029700      END-IF.                                                     02970001
029800                                                                  02980001
029820      MOVE  SPACES TO  PV-MSG-RECORD                              02982029
029830      DISPLAY PV-MSG-RECORD                                       02983029
029840      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   02984029
029850                                                                  02985029
029860      MOVE  SPACES TO  PV-MSG-RECORD                              02986029
029870      MOVE    PC-FIFTY-STARS      TO PV-MSG-RECORD                02987029
029880      DISPLAY PV-MSG-RECORD                                       02988029
029890      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   02989029
029891                                                                  02989129
029892      MOVE  SPACES TO  PV-MSG-RECORD                              02989229
029893      DISPLAY PV-MSG-RECORD                                       02989329
029894      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   02989429
029895                                                                  02989529
029900      CLOSE CONTROL-CARD-2.                                       02990001
030000                                                                  03000001
030100* ------------------------------------------------------------- * 03010001
030200*  OPEN OUTPUT MESSAGE SEQUENTIAL FILE                          * 03020001
030300* ------------------------------------------------------------- * 03030001
030400                                                                  03040001
030500     OPEN OUTPUT MSG-EXTRACT                                      03050015
030510                 RCV-OVER-ERRORS.                                 03051024
030520                                                                  03052024
030600     INITIALIZE MSG-EXTRACT-RECORD                                03060015
030610                 RCV-OVER-RECORD.                                 03061016
030700                                                                  03070001
030800* ------------------------------------------------------------- * 03080001
030900*                                                                 03090001
031000*    CONNECT TO THE QUEUE MANAGER                                 03100001
031100*                                                                 03110001
031200     MOVE CC-QMGR-NAME TO QM-NAME.                                03120001
031300     CALL WS-MQCONN USING QM-NAME                                 03130001
031400                         HCONN                                    03140001
031500                         COMPLETION-CODE                          03150001
031600                         REASON.                                  03160001
031700*                                                                 03170001
031800*    IF CONNECTION FAILED THEN DISPLAY ERROR MESSAGE              03180001
031900*    AND EXIT                                                     03190001
032000*                                                                 03200001
032100     MOVE REASON TO CON-REASON.                                   03210001
032200     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      03220001
032300        MOVE 'MQCONN'   TO ERROR-MESSAGE                          03230001
032400        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03240001
032500        GO TO 4000-END-PROGRAM                                    03250001
032600     END-IF.                                                      03260001
032700     DISPLAY 'MQCONN SUCCESSFUL TO ', QM-NAME.                    03270001
032800*                                                                 03280001
032900*    OPEN THE QUEUE FOR INPUT                                     03290001
033000*                                                                 03300001
033100     COMPUTE OPEN-OPTIONS = MQOO-INPUT-SHARED +                   03310001
033200                            MQOO-FAIL-IF-QUIESCING.               03320001
033300     MOVE CC-STORE-EOD-MSG-QNAME   TO MQOD-OBJECTNAME.            03330001
033400     MOVE QM-NAME TO MQOD-OBJECTQMGRNAME.                         03340001
033500*                                                                 03350001
033600     CALL WS-MQOPEN USING HCONN                                   03360001
033700                         MQM-OBJECT-DESCRIPTOR                    03370001
033800                         OPEN-OPTIONS                             03380001
033900                         GQ-HANDLE                                03390001
034000                         COMPLETION-CODE                          03400001
034100                         REASON.                                  03410001
034200*                                                                 03420001
034300*    IF OPEN FAILED THEN DISPLAY ERROR MESSAGE                    03430001
034400*    AND EXIT.                                                    03440001
034500*                                                                 03450001
034600     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      03460001
034700        MOVE 'MQOPEN'   TO ERROR-MESSAGE                          03470001
034800        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03480001
034900        GO TO 3000-DISCONNECT-QMGR                                03490001
035000     END-IF.                                                      03500001
035100     DISPLAY 'MQOPEN SUCCESSFUL'.                                 03510001
035200*                                                                 03520001
035300     PERFORM 2000-MQGET-EOD-MSG.                                  03530001
035400*                                                                 03540001
035500*    CLOSE THE QUEUE                                              03550001
035600*                                                                 03560001
035700     CALL WS-MQCLOSE USING HCONN                                  03570001
035800                          GQ-HANDLE                               03580001
035900                          MQCO-NONE                               03590001
036000                          COMPLETION-CODE                         03600001
036100                          REASON.                                 03610001
036200     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      03620001
036300        MOVE 'MQCLOSE'  TO ERROR-MESSAGE                          03630001
036400        PERFORM 9000-DISPLAY-ERROR-MESSAGE                        03640001
036500     ELSE                                                         03650001
036600        DISPLAY 'MQCLOSE SUCCESSFUL'                              03660001
036700     END-IF.                                                      03670001
036800*                                                                 03680001
036900     PERFORM 3000-DISCONNECT-QMGR.                                03690001
037000     GO TO 4000-END-PROGRAM.                                      03700001
037100*                                                                 03710001
037200* ------------------------------------------------------------- * 03720001
037300* PUT MESSAGE ON LOCAL QUEUE TO END THE DATA COLLECT PROCESS      03730001
037400* ------------------------------------------------------------- * 03740001
037500 2000-MQGET-EOD-MSG.                                              03750001
037600                                                                  03760001
037700     PERFORM                                                      03770001
037800       UNTIL (COMPLETION-CODE IS EQUAL TO MQCC-FAILED)            03780001
037900         MOVE MQMI-NONE TO MQMD-MSGID                             03790001
038000                                                                  03800001
038100         INITIALIZE MQMD-CORRELID                                 03810001
038200         IF PARM-LENGTH = ZERO                                    03820001
038300             MOVE MQCI-NONE TO MQMD-CORRELID                      03830001
038400         ELSE                                                     03840001
038500             MOVE PARM-USERID TO MQMD-CORRELID                    03850001
038600         END-IF                                                   03860001
038700                                                                  03870001
038800*        MOVE MQCI-NONE TO MQMD-CORRELID                          03880001
038900         MOVE +1000000 TO MSGLENGTH                               03890001
039000         COMPUTE MQGMO-OPTIONS  = MQGMO-SYNCPOINT +               03900001
039100                                  MQGMO-CONVERT   +               03910001
039200                                  MQGMO-WAIT                      03920001
039300                                                                  03930001
039400         CALL WS-MQGET USING HCONN                                03940001
039500                            GQ-HANDLE                             03950001
039600                            MQM-MESSAGE-DESCRIPTOR                03960001
039700                            MQM-GET-MESSAGE-OPTIONS               03970001
039800                            MSGLENGTH                             03980001
039900                            MSGBUFFER                             03990001
040000                            DATA-LENGTH                           04000001
040100                            COMPLETION-CODE                       04010001
040200                            REASON                                04020001
040300                                                                  04030001
040400*        IF PUT FAILED THEN DISPLAY ERROR MESSAGE                 04040001
040500*        AND BREAK OUT OF LOOP                                    04050001
040600                                                                  04060001
040700         IF (COMPLETION-CODE NOT = MQCC-OK) THEN                  04070001
040800            MOVE 'MQGET'     TO ERROR-MESSAGE                     04080001
040900            PERFORM 9000-DISPLAY-ERROR-MESSAGE                    04090001
041000         ELSE                                                     04100001
041100            ADD 1 TO NUMRECS                                      04110001
041200                IF NUMRECS > 1000                                 04120001
041300                    PERFORM 3600-MQ-COMMIT                        04130001
041400                    MOVE ZERO TO NUMRECS                          04140001
041500                END-IF                                            04150001
041700                                                                  04170012
041800            MOVE MSGBUFFER TO RC074-ITEM-REC                      04180012
041810                                                                  04181033
041850            ADD 1 TO NUMGETS                                      04185034
041900                                                                  04190012
042000            EXEC SQL                                              04200007
042100               SET :PV-CURRENT-TMST = CURRENT TIMESTAMP           04210007
042200            END-EXEC                                              04220010
042210**GB 4/12/22                                                      04221036
042300            IF RC074-DATE-ADD-WRAP > SPACES                       04230036
042310               CONTINUE                                           04231036
042320            ELSE                                                  04232036
042400               MOVE PV-CURRENT-TMST    TO RC074-DATE-ADD-WRAP     04240036
042500            END-IF                                                04250036
042510                                                                  04251036
042600            IF RC074-DB-ERROR                                     04260013
042700               ADD +1 TO PV-DB2-ERROR-COUNT                       04270014
042800            END-IF                                                04280015
042810                                                                  04281015
042820*DMH 8/23/11                                                      04282015
042900            IF  RC074-RCV-MORE-THAN-ORDERED                       04290015
042910                IF  RC074-ALLOW-RCV-MORE-NO                       04291015
042930                    PERFORM 8010-WRITE-RCV-OVER-RECORD            04293015
042940                END-IF                                            04294015
042950            ELSE                                                  04295015
043000                PERFORM 8000-WRITE-EXTRACT-RECORD                 04300015
043010            END-IF                                                04301015
043100         END-IF                                                   04310001
043200     END-PERFORM.                                                 04320001
043300*                                                                 04330001
043400* 2000-END-MQGET-EOD-MSG.                                         04340001
043500*                                                                 04350001
043600* ------------------------------------------------------------- * 04360001
043700* CLOSE AND DISCONNECT FROM THE MQ QUEUE MANAGER                  04370001
043800* ------------------------------------------------------------- * 04380001
043900 3000-DISCONNECT-QMGR.                                            04390001
044000*                                                                 04400001
044100*    DISCONNECT FROM THE QUEUE MANAGER                            04410001
044200*                                                                 04420001
044300     IF CON-REASON IS NOT EQUAL TO MQRC-ALREADY-CONNECTED         04430001
044400        CALL WS-MQDISC USING HCONN                                04440001
044500                            COMPLETION-CODE                       04450001
044600                            REASON                                04460001
044700        IF (COMPLETION-CODE NOT = MQCC-OK) THEN                   04470001
044800           MOVE 'MQDISC'   TO ERROR-MESSAGE                       04480001
044900           PERFORM 9000-DISPLAY-ERROR-MESSAGE                     04490001
045000        ELSE                                                      04500001
045100           DISPLAY 'MQDISC SUCCESSFUL'                            04510001
045200        END-IF                                                    04520001
045300     END-IF.                                                      04530001
045400                                                                  04540001
045500*    CLOSE THE MESSAGE EXTRACT OUTPUT FILE.                       04550001
045600                                                                  04560001
045700     CLOSE MSG-EXTRACT                                            04570015
045710           RCV-OVER-ERRORS.                                       04571025
045800*                                                                 04580001
045900* 3000-END-DISCONNECT.                                            04590001
046000******************************************************************04600001
046100*  COMMIT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT        04610001
046200******************************************************************04620001
046300 3600-MQ-COMMIT.                                                  04630001
046400                                                                  04640001
046500     CALL WS-MQCMIT USING HCONN                                   04650001
046600                          COMPLETION-CODE                         04660001
046700                          REASON.                                 04670001
046800                                                                  04680001
046900     IF (COMPLETION-CODE NOT = MQCC-OK)                           04690001
047000         CALL MQCHECK USING REASON                                04700001
047100                               MQ-REASON-TEXT                     04710001
047200        MOVE '3600-COMMIT-MQ'   TO PV-PARAGRAPH                   04720001
047300        MOVE 'MQCMIT ERROR'     TO ERROR-MESSAGE                  04730001
047400        MOVE COMPLETION-CODE    TO HOLD-COMPLETION-CODE           04740001
047500        MOVE REASON             TO HOLD-REASON                    04750001
047600        PERFORM 3700-BACK-OUT-MQ                                  04760001
047700        MOVE HOLD-COMPLETION-CODE TO COMPLETION-CODE              04770001
047800                                        PE-MQ-COMPLETION-CODE     04780001
047900        MOVE HOLD-REASON          TO REASON                       04790001
048000                                        PE-MQ-REASON-CODE         04800001
048100        PERFORM 9200-MQ-ABEND                                     04810001
048200     ELSE                                                         04820001
048300        ADD +1 TO NUMCMTS                                         04830001
048400     END-IF.                                                      04840001
048500                                                                  04850001
048600******************************************************************04860001
048700* BACK OUT MQ PROCESSING SINCE THE POINT OF THE LAST COMMIT       04870001
048800******************************************************************04880001
048900 3700-BACK-OUT-MQ.                                                04890001
049000                                                                  04900001
049100     CALL WS-MQBACK USING HCONN                                   04910001
049200                          COMPLETION-CODE                         04920001
049300                          REASON.                                 04930001
049400                                                                  04940001
049500     IF (COMPLETION-CODE NOT = MQCC-OK) THEN                      04950001
049600         CALL MQCHECK USING REASON                                04960001
049700                            MQ-REASON-TEXT                        04970001
049800        MOVE '3700-BACK-OUT-MQ'  TO PV-PARAGRAPH                  04980001
049900        MOVE 'MQBACK ERROR'      TO ERROR-MESSAGE                 04990001
050000        PERFORM 9200-MQ-ABEND                                     05000001
050100     END-IF.                                                      05010001
050200******************************************************************05020001
050300                                                                  05030001
050400* ------------------------------------------------------------- * 05040001
050500* END THE PROGRAM                                                 05050001
050600* ------------------------------------------------------------- * 05060001
050700 4000-END-PROGRAM.                                                05070001
050800*                                                                 05080001
050900*    DISPLAY THE NUMBER OF MESSAGES SUCCESSFULLY PUT              05090001
051000*    TO THE QUEUE                                                 05100001
051100*                                                                 05110001
051120      MOVE  SPACES   TO  PV-MSG-RECORD.                           05112022
051121      MOVE  NUMGETS  TO  PV-DISP-VALUE.                           05112122
051130      STRING PV-DISP-VALUE '  '                                   05113022
051140             ' MESSAGES READ FROM QUEUE'                          05114019
051141                                     DELIMITED BY SIZE            05114119
051150                                INTO PV-MSG-RECORD.               05115020
051160      DISPLAY PV-MSG-RECORD.                                      05116020
051170      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD.                  05117020
051180                                                                  05118019
051190      MOVE  SPACES TO  PV-MSG-RECORD.                             05119020
051191      MOVE  NUMPUTS  TO  PV-DISP-VALUE.                           05119122
051192      STRING PV-DISP-VALUE '  '                                   05119222
051210             ' ERROR MESSAGES WRITTEN         '                   05121033
051220                                     DELIMITED BY SIZE            05122019
051230                                INTO PV-MSG-RECORD.               05123020
051240      DISPLAY PV-MSG-RECORD.                                      05124020
051250      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD.                  05125020
051260                                                                  05126019
051270      MOVE  SPACES              TO  PV-MSG-RECORD.                05127022
051271      MOVE  PV-DB2-ERROR-COUNT  TO  PV-DISP-VALUE.                05127122
051272      STRING PV-DISP-VALUE '  '                                   05127222
051290             ' NUMBER OF DATABASE ERRORS'                         05129019
051300                                     DELIMITED BY SIZE            05130019
051301                                INTO PV-MSG-RECORD.               05130120
051302      DISPLAY PV-MSG-RECORD.                                      05130220
051303      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD.                  05130320
051304                                                                  05130419
051305      MOVE  SPACES TO  PV-MSG-RECORD.                             05130520
051306      MOVE  PV-RCVR-OVER-COUNT  TO  PV-DISP-VALUE.                05130622
051307      STRING PV-DISP-VALUE '  '                                   05130722
051309             ' MESSAGES RECEIVING MORE UNITS THAN ORDERED'        05130919
051310                                     DELIMITED BY SIZE            05131019
051311                                INTO PV-MSG-RECORD.               05131120
051312      DISPLAY PV-MSG-RECORD.                                      05131220
051313      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD.                  05131320
051314                                                                  05131419
051315      MOVE  SPACES TO  PV-MSG-RECORD.                             05131520
051316      MOVE  NUMCMTS             TO  PV-DISP-VALUE.                05131622
051317      STRING PV-DISP-VALUE '  '                                   05131722
051319             ' NUMBER OF COMMITS TAKEN'                           05131919
051320                                     DELIMITED BY SIZE            05132019
051321                                INTO PV-MSG-RECORD.               05132120
051322      DISPLAY PV-MSG-RECORD.                                      05132220
051323      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD.                  05132320
051330                                                                  05133019
051331      MOVE  SPACES TO  PV-MSG-RECORD                              05133126
051332      DISPLAY PV-MSG-RECORD                                       05133226
051333      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   05133326
051334                                                                  05133426
051335      MOVE  SPACES TO  PV-MSG-RECORD                              05133526
051336      MOVE    PC-FIFTY-STARS      TO PV-MSG-RECORD                05133626
051337      DISPLAY PV-MSG-RECORD                                       05133726
051338      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   05133826
051339                                                                  05133926
051340      MOVE  SPACES TO  PV-MSG-RECORD                              05134026
051341      DISPLAY PV-MSG-RECORD                                       05134126
051342      WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                   05134226
051343                                                                  05134326
051344     IF  PV-RCVR-OVER-COUNT  > 0                                  05134426
051345         MOVE  SPACES TO  PV-MSG-RECORD                           05134526
051346         MOVE  'DIRECT TO CONSUMER ISSUE'                         05134628
051347                                  TO PV-MSG-RECORD                05134728
051348         DISPLAY PV-MSG-RECORD                                    05134826
051349         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05134926
051350                                                                  05135026
051351         MOVE  SPACES TO  PV-MSG-RECORD                           05135126
051352         MOVE  'RECEIVING MORE UNITS THAN ORDERED'                05135228
051353                                  TO PV-MSG-RECORD                05135328
051354         DISPLAY PV-MSG-RECORD                                    05135426
051355         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05135526
051356                                                                  05135626
051357         MOVE  SPACES TO  PV-MSG-RECORD                           05135726
051358         STRING 'CHECK FILE OUT02 AND RDS REPORT FOR '            05135832
051359                'DETAIL INFORMATION' DELIMITED BY SIZE            05135932
051360                                INTO PV-MSG-RECORD                05136032
051361         DISPLAY PV-MSG-RECORD                                    05136126
051362         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05136226
051363                                                                  05136326
051364         MOVE  SPACES TO  PV-MSG-RECORD                           05136426
051365         DISPLAY PV-MSG-RECORD                                    05136526
051366         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05136626
051367                                                                  05136726
051368         MOVE  SPACES TO  PV-MSG-RECORD                           05136826
051369         MOVE    PC-FIFTY-STARS      TO PV-MSG-RECORD             05136926
051370         DISPLAY PV-MSG-RECORD                                    05137026
051371         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05137126
051372                                                                  05137226
051373         MOVE  SPACES TO  PV-MSG-RECORD                           05137326
051374         DISPLAY PV-MSG-RECORD                                    05137426
051375         WRITE ERROR-OUT-RECORD FROM PV-MSG-RECORD                05137526
051376     END-IF.                                                      05137626
051377                                                                  05137726
051378                                                                  05137826
051380     CLOSE ERROR-OUT-FILE.                                        05138025
051500*                                                                 05150001
051600*    IF NUMPUTS > 0                                               05160013
051700*       MOVE 4095 TO RETURN-CODE                                  05170013
051800*    END-IF.                                                      05180013
051900                                                                  05190014
052000     IF PV-DB2-ERROR-COUNT > 0  OR                                05200015
052010        PV-RCVR-OVER-COUNT > 0                                    05201015
052100        MOVE 1 TO RETURN-CODE                                     05210014
052200     END-IF.                                                      05220014
052300     STOP RUN.                                                    05230001
052400*                                                                 05240001
052500* ------------------------------------------------------------- * 05250001
052600* WRITE THE MESSAGE QUEUE TO A SEQUENTIAL FILE.                   05260001
052700* ------------------------------------------------------------- * 05270001
052800 8000-WRITE-EXTRACT-RECORD.                                       05280001
052900* ------------------------------------------------------------- * 05290001
053000*                                                                 05300001
053100     INITIALIZE MSG-EXTRACT-RECORD.                               05310001
053200*                                                                 05320012
053300*    MOVE MSGBUFFER TO MSG-EXTRACT-RECORD.                        05330012
053400*                                                                 05340012
053500     WRITE MSG-EXTRACT-RECORD                                     05350011
053600           FROM RC074-ITEM-REC.                                   05360011
053700                                                                  05370012
053800     ADD +1 TO NUMPUTS.                                           05380001
053900                                                                  05390015
053910                                                                  05391015
053920* ------------------------------------------------------------- * 05392015
053930* WRITE THE MESSAGE QUEUE RECEIVE MORE THAN ORDERED               05393015
053931* ADDED 8/23/11                                                   05393115
053940* ------------------------------------------------------------- * 05394015
053950 8010-WRITE-RCV-OVER-RECORD.                                      05395015
053960                                                                  05396015
053980     INITIALIZE RCV-OVER-RECORD.                                  05398015
053990                                                                  05399015
053993     WRITE RCV-OVER-RECORD                                        05399315
053994           FROM RC074-ITEM-REC.                                   05399415
053995                                                                  05399515
053996     IF  RC074-PO-NUMBER  =  HIGH-VALUES                          05399632
053997         CONTINUE                                                 05399731
053998     ELSE                                                         05399831
053999         ADD +1 TO PV-RCVR-OVER-COUNT                             05399931
054000     END-IF.                                                      05400031
054001                                                                  05400115
054002*                                                                 05400215
054010* ------------------------------------------------------------- * 05401001
054100* DISPLAY THE VALUES OF A FAILED MQ API COMMAND                   05410001
054200* ------------------------------------------------------------- * 05420001
054300 9000-DISPLAY-ERROR-MESSAGE.                                      05430001
054400* ------------------------------------------------------------- * 05440001
054500*                                                                 05450001
054600     DISPLAY '************************************************'.  05460001
054700     DISPLAY '* ', ERROR-MESSAGE.                                 05470001
054800     DISPLAY '* COMPLETION CODE : ', COMPLETION-CODE.             05480001
054900     DISPLAY '* REASON CODE     : ', REASON.                      05490001
055000     DISPLAY '************************************************'.  05500001
055100*                                                                 05510001
055200* 9000-DISPLAY-ERROR-MSG-END.                                     05520001
055300*                                                                 05530001
055400                                                                  05540001
055500****************************************************************  05550001
055600** PERFORM MQ-SERIES ABEND PROCESSING                             05560001
055700****************************************************************  05570001
055800 9200-MQ-ABEND.                                                   05580001
055900                                                                  05590001
056000     DISPLAY '**** ABEND *************************************'.  05600001
056100     DISPLAY '** MQSERIES ERROR **'.                              05610001
056200     DISPLAY '** PROGRAM:    ', PC-PGM-NAME.                      05620001
056300     DISPLAY '** ABEND CODE: ', PV-ABEND-CODE.                    05630001
056400     DISPLAY '** PARAGRAPH:  ', PV-PARAGRAPH.                     05640001
056500     DISPLAY '** MESSAGE:    ', ERROR-MESSAGE.                    05650001
056600     DISPLAY '** COMP CODE:  ', PE-MQ-COMPLETION-CODE.            05660001
056700     DISPLAY '** RSN CODE:   ', PE-MQ-REASON-CODE.                05670001
056800     DISPLAY '** RSN TEXT:   ', MQ-REASON-TEXT.                   05680001
056900                                                                  05690001
057000     MOVE +4013 TO PV-ABEND-CODE.                                 05700001
057100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05710001
057200                                                                  05720001
057300******************************************************************05730001
057400**                      END OF PROGRAM                            05740001
057500*                                                                 05750001
057600******************************************************************05760001
