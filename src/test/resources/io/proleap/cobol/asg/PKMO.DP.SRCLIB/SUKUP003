000100******************************************************************00010010
000200 IDENTIFICATION DIVISION.                                         00020010
000300******************************************************************00030010
000400                                                                  00040010
000500 PROGRAM-ID.    SUKUP003.                                         00050010
000600 AUTHOR.        STEPHANIE HERON.                                  00060010
000700 INSTALLATION.  KOHLS.                                            00070010
000800 DATE-WRITTEN   DECEMBER, 1997.                                   00080010
000900 DATE-COMPILED.                                                   00090010
001000                                                                  00100010
001100******************************************************************00110010
001200*  THIS PROGRAM USES THE AUDIT EXTRACT FILE TO PERFORM THE PHYSCIA00120010
001300*  DELETES ON THE AUDIT DATABASE.                                 00130010
001400******************************************************************00140010
001500                                                                  00150010
001600******************************************************************00160010
001700 ENVIRONMENT DIVISION.                                            00170010
001800******************************************************************00180010
001900                                                                  00190010
002000 CONFIGURATION SECTION.                                           00200010
002100                                                                  00210010
002200 SOURCE-COMPUTER.        IBM-3090.                                00220010
002300 OBJECT-COMPUTER.        IBM-3090.                                00230010
002400                                                                  00240010
002500 INPUT-OUTPUT SECTION.                                            00250010
002600                                                                  00260010
002700 FILE-CONTROL.                                                    00270010
002800                                                                  00280010
002900     SELECT SUNAUD-AUDIT-FILE                                     00290010
003000         ASSIGN TO IN01.                                          00300010
003100                                                                  00310010
003200******************************************************************00320010
003300 DATA DIVISION.                                                   00330010
003400******************************************************************00340010
003500                                                                  00350010
003600 FILE SECTION.                                                    00360010
003700                                                                  00370010
003800 FD  SUNAUD-AUDIT-FILE                                            00380010
003900     RECORDING MODE IS F                                          00390010
004000     LABEL RECORDS ARE STANDARD                                   00400010
004100     BLOCK CONTAINS 0 RECORDS.                                    00410010
004200                                                                  00420010
004300 01  SUNAUD-AUDIT-RECORD        PIC  X(088).                      00430012
004400*                                                                 00440010
004500*                                                                 00450010
004600*                                                                 00460010
004700******************************************************************00470010
004800 WORKING-STORAGE SECTION.                                         00480010
004900******************************************************************00490010
005000*  DB2 FORMATTED MESSAGE AREA                                     00500010
005100******************************************************************00510010
005200     COPY DPWS004.                                                00520012
005300*                                                                 00530010
005400******************************************************************00540010
005500*  COMMUNICATIONS AREA FOR DB2                                    00550010
005600******************************************************************00560010
005700     EXEC SQL                                                     00570010
005800          INCLUDE SQLCA                                           00580010
005900     END-EXEC.                                                    00590010
006000*                                                                 00600010
006100******************************************************************00610010
006200*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE SHIPMENT UNIT      00620010
006300*  AUDIT TABLE                                                    00630010
006400******************************************************************00640010
006500     EXEC SQL                                                     00650010
006600          INCLUDE TSUNAUD                                         00660010
006700     END-EXEC.                                                    00670010
006800                                                                  00680010
006900     EXEC SQL                                                     00690010
007000          INCLUDE SUT00004                                        00700010
007100     END-EXEC.                                                    00710010
007200                                                                  00720010
007300     EXEC SQL                                                     00730010
007400          INCLUDE TSUQADJ                                         00740010
007500     END-EXEC.                                                    00750010
007600                                                                  00760010
007700 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00770010
007800                                                   COMP SYNC.     00780010
007900                                                                  00790010
008000 01  PS-PROGRAM-SWITCHES.                                         00800010
008100     05  PS-EOF-AUDIT-FILE-SW        PIC  X(01)    VALUE 'N'.     00810010
008200         88  PS-EOF-AUDIT-FILE                     VALUE 'Y'.     00820010
008300         88  PS-MORE-AUDIT-FILE                    VALUE 'N'.     00830010
008400     05  PS-EOF-SUEXCP-CSR-SW        PIC  X(01)    VALUE 'N'.     00840010
008500         88  PS-EOF-SUEXCP-CSR                     VALUE 'Y'.     00850010
008600         88  PS-MORE-SUEXCP-CSR                    VALUE 'N'.     00860010
008700     05  PS-EOF-CTEXCP-CSR-SW        PIC  X(01)    VALUE 'N'.     00870010
008800         88  PS-EOF-CTEXCP-CSR                     VALUE 'Y'.     00880010
008900         88  PS-MORE-CTEXCP-CSR                    VALUE 'N'.     00890010
P47435     05  PS-DEL-AUD-NBR-SW           PIC  X(01)    VALUE 'N'.     00891013
P47435         88  PS-DEL-AUD-NBR-SW-Y                   VALUE 'Y'.     00892013
P47435         88  PS-DEL-AUD-NBR-SW-N                   VALUE 'N'.     00893013
009000                                                                  00900010
009100 01  PC-PROGRAM-CONSTANTS.                                        00910010
009200     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00920010
009300                                                   COMP SYNC.     00930010
009400     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00940010
009500         'SUKUP003'.                                              00950010
009600     05  PC-CURRENT-OPERATING-COMPANY                             00960010
009700                                     PIC  X(02)    VALUE '03'.    00970010
009800     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00980010
009900                                                   COMP SYNC.     00990010
010000     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  01000010
010100     05  PC-COMPLETE-TIMESTAMP       PIC  X(26)    VALUE SPACES.  01010010
010200     05  PC-INPROCESS-TIMESTAMP      PIC  X(26)    VALUE SPACES.  01020010
010300     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 020.     01030010
010400                                                                  01040010
010500 01  PV-PROGRAM-VARIABLES.                                        01050010
010600     05  PV-ITEM-NBR                 PIC  9(15)    VALUE ZERO.    01060010
010700     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01070010
010800     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01080010
010900     05  PV-OPEN-COUNTER             PIC S9(04)    VALUE ZERO     01090010
011000                                                   COMP SYNC.     01100010
011100     05  PV-WRITE-COUNTER            PIC S9(09)    VALUE ZERO     01110010
011200                                                   COMP SYNC.     01120010
011300     05  PV-DELETE-COUNTER           PIC S9(09)    VALUE ZERO     01130010
011400                                                   COMP SYNC.     01140010
011500     05  PV-RECORD-NOT-DLTD-CTR      PIC S9(09)    VALUE ZERO     01150010
011600                                                   COMP SYNC.     01160010
011700     05  PV-READ-COUNTER             PIC S9(09)    VALUE ZERO     01170010
011800                                                   COMP SYNC.     01180010
011900     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01190010
012000                                                                  01200010
012100     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01210010
012200                                                   COMP-3.        01220010
012300     05  PV-COMMIT-COUNT             PIC S9(09)    VALUE +0       01230010
012400                                                   COMP SYNC.     01240010
012500     05  PV-COMMIT-COUNTER           PIC 9(03)     VALUE ZERO.    01250010
012600     05  PV-STATUS-COUNTER           PIC S9(09)    VALUE ZERO     01260010
012700                                                   COMP SYNC.     01270010
012800                                                                  01280010
012900                                                                  01290010
013000                                                                  01300010
013100 01  SD-SYSTEM-DATE.                                              01310010
013200     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.  01320010
013300     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.  01330010
013400     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.  01340010
013500                                                                  01350010
013600                                                                  01360010
013700******************************************************************01370010
013800 PROCEDURE DIVISION.                                              01380010
013900******************************************************************01390010
014000                                                                  01400010
014100 0000-PROGRAM-MAINLINE.                                           01410010
014200******************************************************************01420010
014300* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01430010
014400*      PROGRAM.                                                   01440010
014500******************************************************************01450010
014600                                                                  01460010
014700     PERFORM 1000-INITIALIZE.                                     01470010
014800                                                                  01480010
014900     IF PS-MORE-AUDIT-FILE                                        01490010
015000         PERFORM 2000-PROCESS-AUDITS                              01500010
015100            UNTIL PS-EOF-AUDIT-FILE                               01510010
015200     END-IF.                                                      01520010
015300                                                                  01530010
015400     PERFORM 9000-EOJ-ROUTINE.                                    01540010
015500                                                                  01550010
015600     STOP RUN.                                                    01560010
015700                                                                  01570010
015800 1000-INITIALIZE.                                                 01580010
015900******************************************************************01590010
016000*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01600010
016100*    -- OPEN OUTPUT FILE                                          01610010
016200*    -- OPEN CURSOR                                               01620010
016300*    -- FETCH CURSOR                                              01630010
016400******************************************************************01640010
016500                                                                  01650010
016600     ACCEPT SD-SYSTEM-DATE FROM DATE.                             01660010
016700                                                                  01670010
016800     OPEN INPUT  SUNAUD-AUDIT-FILE.                               01680010
016900                                                                  01690010
017000     PERFORM 7000-READ-AUDIT-FILE.                                01700010
017100                                                                  01710010
017200                                                                  01720010
017300 2000-PROCESS-AUDITS.                                             01730010
017400******************************************************************01740010
017500*  DELETE THE AUDITS ON THE EXTRACT FILE                          01750010
017600******************************************************************01760010
017700                                                                  01770010
017800     PERFORM 7200-DELETE-AUD-TRLR-TRIP.                           01780010
017900     PERFORM 7250-UPDATE-SUQADJ.                                  01790010
017910     PERFORM 7300-UPDATE-FINCL-ADJ.                               01791011
P47435     SET PS-DEL-AUD-NBR-SW-N TO TRUE.                             01792018
P47435     PERFORM 7100-DELETE-AUDITS                                   01800014
P47435         UNTIL PS-DEL-AUD-NBR-SW-Y.                               01801018
018100                                                                  01810010
018200     ADD +1 TO PV-COMMIT-COUNTER.                                 01820010
018300                                                                  01830010
018400     IF PV-COMMIT-COUNTER > PC-COMMIT-HOLD                        01840010
018500         EXEC SQL                                                 01850010
018600            COMMIT                                                01860010
018700         END-EXEC                                                 01870010
018800                                                                  01880010
018900         IF  SQLCODE NOT = +0                                     01890010
019000             MOVE '2000-PROCESS-AUDITS           '                01900010
019100                             TO PV-PARAGRAPH-NAME                 01910010
019200             MOVE 'COMMIT FAILED            '                     01920010
019300                             TO PV-DB2-OPERATION-ATTEMPTED        01930010
019400             PERFORM 9100-SQL-ABEND                               01940010
019500         END-IF                                                   01950010
019600         ADD +1                          TO PV-COMMIT-COUNT       01960010
019700         MOVE +0 TO PV-COMMIT-COUNTER                             01970010
019800     END-IF.                                                      01980010
019900                                                                  01990010
020000     IF  PV-STATUS-COUNTER = 5000                                 02000010
020100         MOVE PV-DELETE-COUNTER TO PV-DISPLAY-COUNT               02010010
020200         DISPLAY 'TSUNAUD AUDIT RECORDS DELETED ' PV-DISPLAY-COUNT02020010
020300         MOVE +0 TO PV-STATUS-COUNTER                             02030010
020400     END-IF.                                                      02040010
020500                                                                  02050010
020600                                                                  02060010
020700     PERFORM 7000-READ-AUDIT-FILE.                                02070010
020800                                                                  02080010
020900 7000-READ-AUDIT-FILE.                                            02090010
021000******************************************************************02100010
021100*  READ THE INPUT FILE                                            02110010
021200******************************************************************02120010
021300                                                                  02130010
021400      READ SUNAUD-AUDIT-FILE INTO                                 02140010
021500           DCLTSUNAUD AT END SET                                  02150010
021600           PS-EOF-AUDIT-FILE TO TRUE.                             02160010
021700                                                                  02170010
021800      IF PS-EOF-AUDIT-FILE                                        02180010
021900         CONTINUE                                                 02190010
022000      ELSE                                                        02200010
022100         ADD +1 TO PV-READ-COUNTER                                02210010
022200      END-IF.                                                     02220010
022300                                                                  02230010
022400 7100-DELETE-AUDITS.                                              02240010
022500******************************************************************02250010
022600*  DELETE THE SELECTED AUDIT                                      02260010
022700******************************************************************02270010
022800     EXEC SQL                                                     02280010
022900          DELETE                                                  02290010
023000            FROM TSUNAUD                                          02300010
023100           WHERE AUD_CNTL_NBR = :SUNAUD-AUD-CNTL-NBR              02310010
023200     END-EXEC.                                                    02320010
023300                                                                  02330010
023400     EVALUATE TRUE                                                02340010
023500         WHEN SQLCODE = ZERO                                      02350010
023600             ADD +1 TO PV-DELETE-COUNTER                          02360010
023700                       PV-STATUS-COUNTER                          02370010
P47435             SET PS-DEL-AUD-NBR-SW-Y TO TRUE                      02371013
023800         WHEN SQLCODE = +100                                      02380010
023900             ADD +1 TO PV-RECORD-NOT-DLTD-CTR                     02390010
P47435             SET PS-DEL-AUD-NBR-SW-Y TO TRUE                      02391013
P47435         WHEN SQLCODE = -532                                      02392013
P47435             PERFORM 7400-UPDATE-REWORK-AUDITS                    02393013
024000         WHEN SQLWARN0 NOT = SPACES                               02400010
024100         WHEN SQLCODE < ZERO                                      02410010
024200         WHEN SQLCODE > ZERO                                      02420010
024300             MOVE '7100-DELETE-AUDITS            '                02430010
024400                             TO PV-PARAGRAPH-NAME                 02440010
024500             MOVE 'DELETE THE SELECTED AUDIT'                     02450010
024600                             TO PV-DB2-OPERATION-ATTEMPTED        02460010
024700             DISPLAY 'AUDIT CONTROL NUMBER IS '                   02470010
024800                     SUNAUD-AUD-CNTL-NBR                          02480010
024900             PERFORM 9100-SQL-ABEND                               02490010
025000     END-EVALUATE.                                                02500010
025100                                                                  02510010
025200                                                                  02520010
025300 7200-DELETE-AUD-TRLR-TRIP.                                       02530010
025400******************************************************************02540010
025500*  DELETE THE SELECTED AUDIT                                      02550010
025600******************************************************************02560010
025700     EXEC SQL                                                     02570010
025800          DELETE                                                  02580010
025900            FROM SUT_AUD_TRLR_TRIP                                02590010
026000           WHERE AUD_CNTL_NBR = :SUNAUD-AUD-CNTL-NBR              02600010
026100     END-EXEC.                                                    02610010
026200                                                                  02620010
026300     EVALUATE TRUE                                                02630010
026400         WHEN SQLCODE = ZERO                                      02640010
026500         WHEN SQLCODE = +100                                      02650010
026600             CONTINUE                                             02660010
026700         WHEN SQLWARN0 NOT = SPACES                               02670010
026800         WHEN SQLCODE < ZERO                                      02680010
026900         WHEN SQLCODE > ZERO                                      02690010
027000             MOVE '7200-DELETE-AUD-TRLR-TRIP     '                02700010
027100                             TO PV-PARAGRAPH-NAME                 02710010
027200             MOVE 'DELETE THE SELECTED TRIP '                     02720010
027300                             TO PV-DB2-OPERATION-ATTEMPTED        02730010
027400             DISPLAY 'AUDIT CONTROL NUMBER IS '                   02740010
027500                     SUNAUD-AUD-CNTL-NBR                          02750010
027600             PERFORM 9100-SQL-ABEND                               02760010
027700     END-EVALUATE.                                                02770010
027800                                                                  02780010
027900 7250-UPDATE-SUQADJ.                                              02790010
028000******************************************************************02800010
028100*  DELETE ANY AUDIT ADJUSTMENTS                                   02810010
028200******************************************************************02820010
028300     EXEC SQL                                                     02830010
028400          UPDATE                                                  02840010
028500            TSUQADJ                                               02850010
028600             SET AUD_CNTL_NBR = NULL                              02860010
028700           WHERE AUD_CNTL_NBR = :SUNAUD-AUD-CNTL-NBR              02870010
028800     END-EXEC.                                                    02880010
028900                                                                  02890010
029000     EVALUATE TRUE                                                02900010
029100         WHEN SQLCODE = ZERO                                      02910010
029200         WHEN SQLCODE = +100                                      02920010
029300             CONTINUE                                             02930010
029400         WHEN SQLWARN0 NOT = SPACES                               02940010
029500         WHEN SQLCODE < ZERO                                      02950010
029600         WHEN SQLCODE > ZERO                                      02960010
029700             MOVE '7250-UPDATE-SUQADJ            '                02970010
029800                             TO PV-PARAGRAPH-NAME                 02980010
029900             MOVE 'DELETE ADJUSTMENTS FOR THE TRIP'               02990010
030000                             TO PV-DB2-OPERATION-ATTEMPTED        03000010
030100             DISPLAY 'AUDIT CONTROL NUMBER IS '                   03010010
030200                     SUNAUD-AUD-CNTL-NBR                          03020010
030300             PERFORM 9100-SQL-ABEND                               03030010
030400     END-EVALUATE.                                                03040010
030500                                                                  03050010
030510 7300-UPDATE-FINCL-ADJ.                                           03051011
030520******************************************************************03052011
030530*  UPDATE AUDIT CONTROL NUMBER TO NULLS                           03053011
030540******************************************************************03054011
030550     EXEC SQL                                                     03055011
030560          UPDATE                                                  03056011
030570            SUT_FINCL_ADJ                                         03057011
030580             SET AUD_CNTL_NBR = NULL                              03058011
030590           WHERE AUD_CNTL_NBR = :SUNAUD-AUD-CNTL-NBR              03059011
030591     END-EXEC.                                                    03059111
030592                                                                  03059211
030593     EVALUATE TRUE                                                03059311
030594         WHEN SQLCODE = ZERO                                      03059411
030595         WHEN SQLCODE = +100                                      03059511
030596             CONTINUE                                             03059611
030597         WHEN SQLWARN0 NOT = SPACES                               03059711
030598         WHEN SQLCODE < ZERO                                      03059811
030599         WHEN SQLCODE > ZERO                                      03059911
030600             MOVE '7300-UPDATE-FINCL-ADJ         '                03060011
030601                             TO PV-PARAGRAPH-NAME                 03060111
030602             MOVE 'UPDATE AUDIT NUMBER TO NULL VALUE'             03060211
030603                             TO PV-DB2-OPERATION-ATTEMPTED        03060311
030604             DISPLAY 'AUDIT CONTROL NUMBER IS '                   03060411
030605                     SUNAUD-AUD-CNTL-NBR                          03060511
030606             PERFORM 9100-SQL-ABEND                               03060611
030607     END-EVALUATE.                                                03060711
030608                                                                  03060811
P47435 7400-UPDATE-REWORK-AUDITS.                                       03060913
P47435******************************************************************03061013
P47435*  UPDATE AUDIT CONTROL NUMBER TO NULL                            03061113
P47435******************************************************************03061213
P47435     EXEC SQL                                                     03061313
P47435          UPDATE                                                  03061413
P47435            SUT_PO_AUD_REQ                                        03061513
P47435             SET RWRK_AUD_CNTL_NBR = NULL                         03061613
P47435           WHERE RWRK_AUD_CNTL_NBR = :SUNAUD-AUD-CNTL-NBR         03061713
P47435     END-EXEC.                                                    03061813
P47435                                                                  03061913
P47435     EVALUATE TRUE                                                03062013
P47435         WHEN SQLCODE = ZERO                                      03062113
P47435         WHEN SQLCODE = +100                                      03062213
P47435             CONTINUE                                             03062313
P47435         WHEN SQLWARN0 NOT = SPACES                               03062413
P47435         WHEN SQLCODE < ZERO                                      03062513
P47435         WHEN SQLCODE > ZERO                                      03062613
P47435             MOVE '7400-UPDATE-REWORK-AUDITS     '                03062713
P47435                             TO PV-PARAGRAPH-NAME                 03062813
P47435             MOVE 'UPDATE REWORK AUD NUM TO NULL'                 03062913
P47435                             TO PV-DB2-OPERATION-ATTEMPTED        03063013
P47435             DISPLAY 'REWORK AUDIT CONTROL NUMBER IS'             03063113
P47435                     SUNAUD-AUD-CNTL-NBR                          03063213
P47435             PERFORM 9100-SQL-ABEND                               03063313
P47435     END-EVALUATE.                                                03063413
P47435                                                                  03063513
030610 9000-EOJ-ROUTINE.                                                03064011
030700******************************************************************03070010
030800*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          03080010
030900******************************************************************03090010
031000     CLOSE SUNAUD-AUDIT-FILE.                                     03100010
031100                                                                  03110010
031200     MOVE PV-READ-COUNTER TO PV-DISPLAY-COUNT.                    03120010
031300     DISPLAY 'TOTAL INPUT RECORDS READ '                          03130010
031400     PV-DISPLAY-COUNT.                                            03140010
031500     MOVE PV-DELETE-COUNTER TO PV-DISPLAY-COUNT.                  03150010
031600     DISPLAY 'TOTAL SUNAUD RECORDS DELETED ' PV-DISPLAY-COUNT.    03160010
031700     MOVE PV-COMMIT-COUNTER TO PV-DISPLAY-COUNT.                  03170010
031800     DISPLAY 'TOTAL NUMBER OF COMMITS      ' PV-DISPLAY-COUNT.    03180010
031900     MOVE PV-RECORD-NOT-DLTD-CTR  TO  PV-DISPLAY-COUNT.           03190010
032000     DISPLAY 'TOTAL RECORDS NOT DELETED    ' PV-DISPLAY-COUNT.    03200010
032100                                                                  03210010
032200                                                                  03220010
032300 9100-SQL-ABEND.                                                  03230010
032400******************************************************************03240010
032500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03250010
032600*  ERROR OR WARNING CODE OCCURS.                                  03260010
032700******************************************************************03270010
032800     DISPLAY '9100-SQL-ABEND'.                                    03280010
032900     DISPLAY '** ABEND     **'.                                   03290010
033000     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03300010
033100     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03310010
033200     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03320010
033300                                                                  03330010
033400******************************************************************03340010
033500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03350010
033600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03360010
033700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03370010
033800* FORMAT.                                                         03380010
033900******************************************************************03390010
034000     COPY DPPD004.                                                03400010
034100                                                                  03410010
034200     MOVE +4013                  TO ABEND-CODE.                   03420010
034300     CALL 'ILBOABN0' USING ABEND-CODE.                            03430010
