000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000500 PROGRAM-ID.      SAKUT053.                                       00030000
000600 AUTHOR.          STEVEN NOWAK.                                   00040000
000700 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000800 DATE-WRITTEN.    07/01/09.                                       00060000
000900 DATE-COMPILED.                                                   00070000
001000                                                                  00080000
001100******************************************************************00090000
001000*               PULL DATA FOR TSASUM UPDATE                       00100000
001300*=================================================================00110000
001600*  WRITES THE UPDATE TSASUM FILE FOR RETURNS MADE ON E-COM SALE   00120000
001700*  TRANSACTIONS REGARDLESS IF THE RETURN TRANS WAS MADE VIA       00130000
001800*  BLUE MARTINI OR AT A BRICK AND MORTAR STORE.                   00140000
001900*                                                                 00150000
002800*========================== CHANGE LOG ===========================00160000
002900*  AUTH      BY       DATE                 DESCRIPTION            00170000
003000*=================================================================00180000
003100* WR36527  TKMA409  07-01-09   CREATE PROGRAM                     00190000
003200*                                                                 00200000
003300******************************************************************00210000
003300* INCIDENT:2476460                                                00220000
003300* ----------------                                                00230000
003000* CHANGE: VOID_ABRT_CDE AND TRN_STAT_CDE CONDITION CHECKS ARE     00231000
003100* REMOVED FROM THE PARA 2100.                                     00232000
003200* VOID_ABRT_CDE STATUS WOULD CHANGE FROM N TO V IF A NORMAL       00233000
003200* TRANS VOIDED WITIN FEW MINS OF TIME BEFORE THE JOB COMPLETION   00233100
003200* AND THAT CAUSES FAILED IN THE PARA 2100.SINCE THE VOID CHECK    00233200
003200* ALREADY HANDLED IN MASTER CURSOR,IT IS NOT REQUIRED TO CHECK    00233300
003200* AGAIN.                                                          00233400
003200* WHO: COGNIZANT                                DATE:2012-12-20   00233500
003300******************************************************************00233600
003000* CHANGE: DO NOT WRITE OUT THE ECR IF IT'S A WAYFAIR RETURN       00233700
003100* TRANSACTION.                                                    00233800
003200* WHO: BARB SCHULTZ    CHG0092405               DATE:2014-12-15   00233900
003300******************************************************************00234000
267620* CHANGE: REPLACED THE EXCLUSION OF WAYFAIR (DEPT 70) WITH THE    00234102
267620* EXCLUSION OF MARKETPLACE (DEPT 985).                            00234202
267620* WHO: JIM HUNTER      CHG0267620               DATE:2022-03-04   00234302
267620******************************************************************00234402
003400                                                                  00235000
003500 ENVIRONMENT DIVISION.                                            00236000
003600 CONFIGURATION SECTION.                                           00237000
003700                                                                  00238000
003800 SOURCE-COMPUTER.        IBM-3090.                                00239000
003900 OBJECT-COMPUTER.        IBM-3090.                                00240000
004000                                                                  00250000
004100 INPUT-OUTPUT SECTION.                                            00260000
004200 FILE-CONTROL.                                                    00270000
004300                                                                  00280000
004400     SELECT POS-DATE-CARD-FILE ASSIGN TO INP01.                   00290000
004500                                                                  00300000
004600     SELECT TSASUM-FILE        ASSIGN TO OUT01.                   00310000
004700                                                                  00320000
004800 DATA DIVISION.                                                   00330000
004900 FILE SECTION.                                                    00340000
005000                                                                  00350000
005100 FD  POS-DATE-CARD-FILE                                           00360000
005200     RECORDING MODE IS F                                          00370000
005300     BLOCK CONTAINS 0 RECORDS                                     00380000
005400     LABEL RECORDS ARE STANDARD.                                  00390000
005500                                                                  00400000
005600 01  POS-DATE-CARD-RECORD            PIC X(80).                   00410000
005700                                                                  00420000
005800 FD  TSASUM-FILE                                                  00430000
005900     RECORDING MODE IS F                                          00440000
006000     BLOCK CONTAINS 0 RECORDS                                     00450000
006100     LABEL RECORDS ARE STANDARD.                                  00460000
006200                                                                  00470000
006300 01  TSASUM-REC                       PIC  X(21).                 00480000
006400                                                                  00490000
006500                                                                  00500000
006600******************************************************************00510000
006700*                       WORKING STORAGE                           00520000
006800******************************************************************00530000
006900 WORKING-STORAGE SECTION.                                         00540000
007000                                                                  00550000
007100 01  W-START                          PIC  X(50)    VALUE         00560000
007200     ' *** WORKING STORAGE STARTS HERE FOR SAKUT053 *** '.        00570000
007300                                                                  00580000
007400******************************************************************00590000
007500*                           SWITCHES                              00600000
007600******************************************************************00610000
007700 01  PS-PROGRAM-SWITCHES.                                         00620000
007800     05  PS-END-OF-MASTER-CURSOR-SW   PIC  X(01)    VALUE 'N'.    00630000
007900         88  PS-END-OF-MASTER-CURSOR                VALUE 'Y'.    00640000
008000     05  PS-END-OF-CARD-FILE-SW       PIC  X(01)    VALUE 'N'.    00650000
008100         88  PS-END-OF-CARD-FILE                    VALUE 'Y'.    00660000
008200                                                                  00670000
008300     05  PS-END-OF-RTRN-ITM-CSR-SW    PIC  X(01)    VALUE 'N'.    00680000
008400         88  PS-NOT-END-OF-RTRN-ITM-CSR             VALUE 'N'.    00690000
008500         88  PS-END-OF-RETRN-ITM-CSR                VALUE 'Y'.    00700000
008600     05  PS-ORIG-TRN-INFO-CHNGD-SW    PIC  X(01)    VALUE 'N'.    00710000
008700         88  PS-ORIG-TRAN-INFO-CHNGD                VALUE 'Y'.    00720000
008800         88  PS-ORIG-TRAN-HASNT-CHNGD               VALUE 'N'.    00730000
008900     05  PS-TRAN-FIRST-TIME-SW        PIC  X(01)    VALUE 'Y'.    00740000
009000         88  PS-TRAN-FIRST-TIME                     VALUE 'Y'.    00750000
009100         88  PS-TRAN-NOT-FIRST-TIME                 VALUE 'N'.    00760000
009200                                                                  00770000
009300******************************************************************00780000
009400*                          CONSTANTS                              00790000
009500******************************************************************00800000
009600 01  PC-CONSTANTS.                                                00810000
009700     05  PC-JOB-NAME                  PIC  X(08)    VALUE         00820000
009800                                                    'SAK051  '.   00830000
009900     05  PC-PGM-NAME                  PIC  X(08)    VALUE         00840000
010000                                                    'SAKUT053'.   00850000
010100                                                                  00860000
010200     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    00870000
010300                                                    COMP SYNC.    00880000
010400                                                                  00890000
010500******************************************************************00900000
010600*                        ACCUMULATORS                             00910000
010700******************************************************************00920000
010800 01  PV-MISC-COUNT-FIELDS.                                        00930000
010900                                                                  00940000
011000     05  PV-MASTER-CURSOR-CNT         PIC  9(07)    VALUE ZERO.   00950000
011100                                                                  00960000
011200     05  PA-TSASUM-WRITTEN            PIC  9(07)    VALUE ZEROS.  00970000
011300                                                                  00980000
011400******************************************************************00990000
011500*                         VARIABLES                               01000000
011600******************************************************************01010000
011700 01  PV-DB2-VARIABLES.                                            01020000
011800                                                                  01030000
011900     05  PV-SQL                       PIC S9(04)    VALUE ZEROS.  01040000
012000     05  PV-PARAGRAPH-NAME            PIC  X(30)    VALUE SPACES. 01050000
012100     05  PV-DB2-TABLE-NAME            PIC  X(12)    VALUE SPACES. 01060000
012200     05  PV-DB2-OPERATION-MSG         PIC  X(60)    VALUE SPACES. 01070000
012300     05  PV-OPERATION-MSG-1           PIC  X(40)    VALUE SPACE.  01080000
012400     05  PV-OPERATION-MSG-2           PIC  X(40)    VALUE SPACE.  01090000
012500                                                                  01100000
012600     05  PV-DB2-SLS-CORR-SEQ-NBR      PIC S9(04)    COMP          01110000
012700                                                    VALUE ZERO.   01120000
012800                                                                  01130000
012900******************************************************************01140000
013000*                          WORK AREA                              01150000
013100******************************************************************01160000
013200 01  PV-MISC-FIELDS.                                              01170000
013300                                                                  01180000
013400     05  PV-SVD-SLS-DTE               PIC  X(10)    VALUE SPACES. 01190000
013500     05  PV-SVD-PARTN-NBR             PIC S9(04)    COMP          01200000
013600                                                    VALUE ZEROS.  01210000
013700     05  PV-SVD-STR-NBR               PIC S9(04)    COMP          01220000
013800                                                    VALUE ZEROS.  01230000
013900     05  PV-SVD-RGST-ID               PIC S9(04)    COMP          01240000
014000                                                    VALUE ZEROS.  01250000
014100     05  PV-SVD-TRN-NBR               PIC S9(04)    COMP          01260000
014200                                                    VALUE ZEROS.  01270000
014300     05  PV-SVD-STRT-TM               PIC  X(08)    VALUE SPACES. 01280000
014400                                                                  01290000
014500     05  PV-CURRENT-DAY-PARTN         PIC S9(04)    COMP          01300000
014600                                                    VALUE ZERO.   01310000
014700                                                                  01320000
014800     05  PV-TRAN-NET-CHRGD-AMT        PIC S9(07)V99 COMP-3        01330000
014900                                                    VALUE ZEROS.  01340000
015000                                                                  01350000
015100     05  PV-ENTIRE-TRAN-NET-CHRGD-AMT PIC S9(07)V99 COMP-3        01360000
015200                                                    VALUE ZEROS.  01370000
015300                                                                  01380000
015400     05  PV-ORIG-TRN-PARTN            PIC S9(04)    COMP          01390000
015500                                                    VALUE ZEROS.  01400000
015600                                                                  01410000
015700     05  PV-ORIG-TRN-DB-STRUC-CDE     PIC  X(01)    VALUE SPACES. 01420000
015800                                                                  01430000
015900******************************************************************01440000
016000*                       DATE/TIME                                 01450000
016100******************************************************************01460000
016200 01  PV-DATE-AND-TIME-FIELDS.                                     01470000
016300                                                                  01480000
016400     05  PV-POS-CCYY-MM-DD            PIC  X(10)    VALUE SPACE.  01490000
016500     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01500000
016600         10  PV-POS-CCYY              PIC  X(04).                 01510000
016700         10  FILLER                   PIC  X(01).                 01520000
016800         10  PV-POS-MM                PIC  X(02).                 01530000
016900         10  FILLER                   PIC  X(01).                 01540000
017000         10  PV-POS-DD                PIC  X(02).                 01550000
017100                                                                  01560000
017200******************************************************************01570000
017300*               SYSTEM TIME AND DATE VARIABLES                    01580000
017400******************************************************************01590000
017500 01  SYS-DATE-TIME.                                               01600000
017600     05  SYS-DATE                     PIC  X(08)    VALUE SPACES. 01610000
017700     05  SYS-TIME                     PIC  X(08)    VALUE SPACES. 01620000
017800                                                                  01630000
017900 01  ST-BEG-TIME.                                                 01640000
018000     05  ST-BEG-HR                    PIC  9(02)    VALUE ZEROS.  01650000
018100     05  FILLER                       PIC  X(01)    VALUE ':'.    01660000
018200     05  ST-BEG-MN                    PIC  9(02)    VALUE ZEROS.  01670000
018300                                                                  01680000
018400 01  ST-END-TIME.                                                 01690000
018500     05  ST-END-HR                    PIC  9(02)    VALUE ZEROS.  01700000
018600     05  FILLER                       PIC  X(01)    VALUE ':'.    01710000
018700     05  ST-END-MN                    PIC  9(02)    VALUE ZEROS.  01720000
018800                                                                  01730000
018900 01  SD-EDIT-DATE.                                                01740000
019000     05  SD-MONTH                     PIC  9(02)    VALUE ZEROS.  01750000
019100     05  FILLER                       PIC  X(01)    VALUE '-'.    01760000
019200     05  SD-DAY                       PIC  9(02)    VALUE ZEROS.  01770000
019300     05  FILLER                       PIC  X(01)    VALUE '-'.    01780000
019400     05  SD-CENT                      PIC  9(02)    VALUE ZEROS.  01790000
019500     05  SD-YEAR                      PIC  9(02)    VALUE ZEROS.  01800000
019600                                                                  01810000
019700***************************************************************** 01820000
019800* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    01830000
019900***************************************************************** 01840000
020000 01  CC-CONTROL-CARD.                                             01850000
020100                                                                  01860000
020200     05  CC-CONTROL-CARD-DISPLAY.                                 01870000
020300         10  CC-CONTROL-NAME          PIC  X(14)    VALUE SPACE.  01880000
020400             88  CC-VALID-CONTROL-NAME              VALUE         01890000
020500                 'P.O.S. DATE = '.                                01900000
020600         10  CC-POS-DATE-MMDDYY       PIC  9(06)    VALUE ZERO.   01910000
020700     05  FILLER                       PIC  X(60)    VALUE SPACE.  01920000
020800                                                                  01930000
020900******************************************************************01940000
021000*                        ERROR HANDLING                           01950000
021100******************************************************************01960000
021200 01  ABEND-CODE                       PIC S9(04)    VALUE ZEROS   01970000
021300                                                    COMP SYNC.    01980000
021400     88  ABEND-4001-WRITE-ERROR                     VALUE +4001.  01990000
021500     88  ABEND-4002-READ-ERROR                      VALUE +4002.  02000000
021600     88  ABEND-4003-CTRL-CARD-ERROR                 VALUE +4003.  02010000
021700     88  ABEND-4004-TABLE-ERROR                     VALUE +4004.  02020000
021800     88  ABEND-4005-OPEN-ERROR                      VALUE +4005.  02030000
021900     88  ABEND-4006-CLOSE-ERROR                     VALUE +4006.  02040000
022000     88  ABEND-4007-SEQUENCE-ERROR                  VALUE +4007.  02050000
022100     88  ABEND-4008-DATA-ERROR                      VALUE +4008.  02060000
022200     88  ABEND-4009-KEY-DATA-ERROR                  VALUE +4009.  02070000
022300     88  ABEND-4013-DB2-ERROR                       VALUE +4013.  02080000
022400     88  ABEND-4019-CAL-SUB-ERROR                   VALUE +4019.  02090000
022500     88  ABEND-4020-MQ-ERROR                        VALUE +4020.  02100000
022600     88  ABEND-4444-FORCED-ABEND                    VALUE +4444.  02110000
022700                                                                  02120000
022800                                                                  02130000
022900******************************************************************02140000
023000*  TSASUM - TOTALS BY STORE REGISTER                              02150000
023100******************************************************************02160000
023200     COPY SARD009.                                                02170000
023300                                                                  02180000
023400******************************************************************02190000
023500*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             02200000
023600******************************************************************02210000
023700     COPY DPWS500.                                                02220000
023800                                                                  02230000
023900******************************************************************02240000
024000*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02250000
024100******************************************************************02260000
024200     COPY DPWS004.                                                02270000
024300                                                                  02280000
024400******************************************************************02290000
024500*  DB2 MESSAGE AREA                                               02300000
024600******************************************************************02310000
024700     COPY SQLCA2.                                                 02320000
024800                                                                  02330000
024900******************************************************************02340000
025000*  DB2 COMMUNICATION AREA.                                        02350000
025100******************************************************************02360000
025200     EXEC SQL                                                     02370000
025300          INCLUDE SQLCA                                           02380000
025400     END-EXEC.                                                    02390000
025500                                                                  02400000
025600******************************************************************02410000
025700*  DB2 TABLE XST_LOC - STORE LOCATION TABLE                       02420000
025800******************************************************************02430000
025900     EXEC SQL                                                     02440000
026000          INCLUDE XST00001                                        02450000
026100     END-EXEC.                                                    02460000
026200                                                                  02470000
026300******************************************************************02480000
026400*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           02490000
026500******************************************************************02500000
026600     EXEC SQL                                                     02510000
026700          INCLUDE TEPTRN                                          02520000
026800     END-EXEC.                                                    02530000
026900                                                                  02540000
027000******************************************************************02550000
027100*  DB2 TABLE TEPPART - PARTITION TABLE                            02560000
027200******************************************************************02570000
027300     EXEC SQL                                                     02580000
027400          INCLUDE TEPPART                                         02590000
027500     END-EXEC.                                                    02600000
027600                                                                  02610000
027700******************************************************************02620000
027800*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                02630000
027900******************************************************************02640000
028000     EXEC SQL                                                     02650000
028100          INCLUDE TEPDKEY                                         02660000
028200     END-EXEC.                                                    02670000
028300                                                                  02680000
028400******************************************************************02690000
028500*  DB2 TABLE TEPIRT - ITEM RETURN INFORMATION TABLE               02700000
028600******************************************************************02710000
028700     EXEC SQL                                                     02720000
028800          INCLUDE TEPIRT                                          02730000
028900     END-EXEC.                                                    02740000
029000                                                                  02750000
029100******************************************************************02760000
029200*  DB2 TABLE TEPITM - TRANSACTION ITEM TABLE                      02770000
029300******************************************************************02780000
029400     EXEC SQL                                                     02790000
029500          INCLUDE TEPITM                                          02800000
029600     END-EXEC.                                                    02810000
029700                                                                  02820000
029800******************************************************************02830000
029900*  CURSOR TO RETRIEVE KOHLS LATES/SALES CORRECTION TRANSACTIONS   02840000
030000*  AND CURRENT DAY TRANSACTIONS (UNION OF TWO "CURSORS" TO        02850000
030100*  PRODUCE ONE MASTER CURSOR) FOR RETURN TRANSACTIONS OF SALES    02860000
030200*  THAT ORIGINATED AT THE E-STORE.                                02870000
030300******************************************************************02880000
030400                                                                  02890000
030500     EXEC SQL                                                     02900000
030600       DECLARE MASTER-CURSOR CURSOR FOR                           02910000
030700*                                                                 02920000
030800**> LATE AND SALES CORRECTION TRANSACTIONS                        02930000
030900                                                                  02940000
031000          SELECT DISTINCT                                         02950000
031100                    TRN.PARTN_NBR                                 02960000
031200                   ,TRN.SLS_DTE                                   02970000
031300                   ,TRN.STR_NBR                                   02980000
031400                   ,TRN.RGST_ID                                   02990000
031500                   ,TRN.TRN_NBR                                   03000000
031600                   ,TRN.STRT_TM                                   03010000
031700                                                                  03020000
031800            FROM   TEPPART PRT                                    03030000
031900                  ,TEPTRN  TRN                                    03040000
032000                  ,TEPITM  ITM                                    03050000
032100                  ,TEPIRT  IRT                                    03060000
032200                  ,TEPDKEY KEE                                    03070000
032300                  ,XST_LOC LOC                                    03080000
032400                                                                  03090000
032500            WHERE  KEE.PRCG_DTE          = :PV-POS-CCYY-MM-DD     03100000
032600                                                                  03110000
032700              AND  KEE.SLS_DTE           = PRT.SLS_DTE            03120000
032800              AND  PRT.DB_STRUC_CDE      = 'O'                    03130000
032900              AND  PRT.STR_GP_CDE        = 'A'                    03140000
033000              AND  PRT.PARTN_NBR         = TRN.PARTN_NBR          03150000
033100                                                                  03160000
033200              AND  KEE.STR_NBR           = TRN.STR_NBR            03170000
033300              AND  KEE.RGST_ID           = TRN.RGST_ID            03180000
033400              AND  KEE.TRN_NBR           = TRN.TRN_NBR            03190000
033500              AND  KEE.STRT_TM           = TRN.STRT_TM            03200000
033600              AND  KEE.SLS_CORR_SEQ_NBR  = TRN.SLS_CORR_SEQ_NBR   03210000
033700                                                                  03220000
033800              AND  TRN.PARTN_NBR         = ITM.PARTN_NBR          03230000
033900              AND  TRN.STR_NBR           = ITM.STR_NBR            03240000
034000              AND  TRN.RGST_ID           = ITM.RGST_ID            03250000
034100              AND  TRN.TRN_NBR           = ITM.TRN_NBR            03260000
034200              AND  TRN.STRT_TM           = ITM.STRT_TM            03270000
034300              AND  TRN.SLS_CORR_SEQ_NBR  = ITM.SLS_CORR_SEQ_NBR   03280000
034400                                                                  03290000
034500              AND  ITM.PARTN_NBR         = IRT.PARTN_NBR          03300000
034600              AND  ITM.STR_NBR           = IRT.STR_NBR            03310000
034700              AND  ITM.RGST_ID           = IRT.RGST_ID            03320000
034800              AND  ITM.TRN_NBR           = IRT.TRN_NBR            03330000
034900              AND  ITM.STRT_TM           = IRT.STRT_TM            03340000
035000              AND  ITM.SLS_CORR_SEQ_NBR  = IRT.SLS_CORR_SEQ_NBR   03350000
035100              AND  ITM.LNE_ITM_SEQ_NBR   = IRT.LNE_ITM_SEQ_NBR    03360000
035200                                                                  03370000
035300              AND  ITM.LIV_RSLU_CDE      IN ('+', '-')            03380000
035400              AND  TRN.TRN_STAT_CDE      IN ('V', 'L')            03390000
035500              AND  TRN.VOID_ABRT_CDE     = 'N'                    03400000
035600                                                                  03410000
035700              AND  IRT.ORIG_STR_NBR      = LOC.LOC_NBR            03420000
035800              AND  LOC.LOC_TYP_CDE       = 'DS'                   03430000
035900              AND  LOC.E_BUS_IND         = 'Y'                    03440000
036000              AND  LOC.OPN_DTE          <= :PV-POS-CCYY-MM-DD     03450000
036100              AND  LOC.CLO_DTE          >= :PV-POS-CCYY-MM-DD     03460000
267620              AND  NOT ITM.DEPT_NBR      =  '985'                 03470002
036200                                                                  03490000
036300       UNION                                                      03500000
036400                                                                  03510000
036500**> CURRENT DAY TRANSACTIONS                                      03520000
036600                                                                  03530000
036700          SELECT DISTINCT                                         03540000
036800                    TRN.PARTN_NBR                                 03550000
036900                   ,TRN.SLS_DTE                                   03560000
037000                   ,TRN.STR_NBR                                   03570000
037100                   ,TRN.RGST_ID                                   03580000
037200                   ,TRN.TRN_NBR                                   03590000
037300                   ,TRN.STRT_TM                                   03600000
037400                                                                  03610000
037500            FROM    TEPPART PRT                                   03620000
037600                   ,TEPTRN  TRN                                   03630000
037700                   ,TEPITM  ITM                                   03640000
037800                   ,TEPIRT  IRT                                   03650000
037900                   ,XST_LOC LOC                                   03660000
038000                                                                  03670000
038100            WHERE   PRT.PARTN_NBR         = :PV-CURRENT-DAY-PARTN 03680000
038200              AND   PRT.DB_STRUC_CDE      = 'O'                   03690000
038300              AND   PRT.STR_GP_CDE        = 'A'                   03700000
038400              AND   PRT.PARTN_NBR         = TRN.PARTN_NBR         03710000
038500                                                                  03720000
038600              AND   TRN.PARTN_NBR         = ITM.PARTN_NBR         03730000
038700              AND   TRN.STR_NBR           = ITM.STR_NBR           03740000
038800              AND   TRN.RGST_ID           = ITM.RGST_ID           03750000
038900              AND   TRN.TRN_NBR           = ITM.TRN_NBR           03760000
039000              AND   TRN.STRT_TM           = ITM.STRT_TM           03770000
039100              AND   TRN.SLS_CORR_SEQ_NBR  = ITM.SLS_CORR_SEQ_NBR  03780000
039200                                                                  03790000
039300              AND   ITM.PARTN_NBR         = IRT.PARTN_NBR         03800000
039400              AND   ITM.STR_NBR           = IRT.STR_NBR           03810000
039500              AND   ITM.RGST_ID           = IRT.RGST_ID           03820000
039600              AND   ITM.TRN_NBR           = IRT.TRN_NBR           03830000
039700              AND   ITM.STRT_TM           = IRT.STRT_TM           03840000
039800              AND   ITM.SLS_CORR_SEQ_NBR  = IRT.SLS_CORR_SEQ_NBR  03850000
039900              AND   ITM.LNE_ITM_SEQ_NBR   = IRT.LNE_ITM_SEQ_NBR   03860000
040000                                                                  03870000
040100              AND   TRN.VOID_ABRT_CDE     = 'N'                   03880000
040200              AND   TRN.TRN_STAT_CDE      = 'Z'                   03890000
040300              AND   ITM.LIV_RSLU_CDE      IN ('+', '-')           03900000
040400              AND   IRT.ORIG_STR_NBR      = LOC.LOC_NBR           03910000
040500              AND   LOC.LOC_TYP_CDE       = 'DS'                  03920000
040600              AND   LOC.E_BUS_IND         = 'Y'                   03930000
040700              AND   LOC.OPN_DTE          <= :PV-POS-CCYY-MM-DD    03940000
040800              AND   LOC.CLO_DTE          >= :PV-POS-CCYY-MM-DD    03950000
267620              AND   NOT ITM.DEPT_NBR      = '985'                 03960002
040900                                                                  03980000
041000          ORDER BY 1, 2, 3, 4, 5                                  03990000
041100          WITH UR                                                 04000000
041200     END-EXEC.                                                    04010000
041300                                                                  04020000
041400******************************************************************04030000
041500*  CURSOR TO RETRIEVE ALL ITEMS RETURNED IN A TRANSACTION THAT    04040000
041600*  ORIGINATED FROM A SALE AT THE E-STORE.                         04050000
041700******************************************************************04060000
041800                                                                  04070000
041900     EXEC SQL                                                     04080000
042000       DECLARE RETRN-ITM-CURSOR CURSOR FOR                        04090000
042100                                                                  04100000
042200          SELECT  ITM.LNE_ITM_SEQ_NBR                             04110000
042300                 ,ITM.SLD_QTY                                     04120000
042400                 ,ITM.NET_CHRGD_AMT                               04130000
042500                 ,ITM.TXBL_IND                                    04140000
042600                 ,ITM.RCPT_TX_TOT_CDE                             04150000
042700                 ,ITM.TX_RT_PCT                                   04160000
042800                 ,ITM.TX_AMT                                      04170000
042900                 ,ITM.SKU_NBR                                     04180000
043000                 ,IRT.ORIG_SLS_DTE                                04190000
043100                 ,IRT.ORIG_STR_NBR                                04200000
043200                 ,IRT.ORIG_RGST_ID                                04210000
043300                 ,IRT.ORIG_TRN_NBR                                04220000
043400                 ,IRT.ORIG_STRT_TM                                04230000
043500                 ,IRT.ORIG_LNE_ITM_NBR                            04240000
043600                 ,PRT.PARTN_NBR                                   04250000
043700                 ,PRT.DB_STRUC_CDE                                04260000
043800                                                                  04270000
043900          FROM    TEPITM  ITM                                     04280000
044000                 ,TEPIRT  IRT                                     04290000
044100                 ,XST_LOC LOC                                     04300000
044200                 ,TEPPART PRT                                     04310000
044300                                                                  04320000
044400          WHERE   ITM.PARTN_NBR        = :EPTRN-PARTN-NBR         04330000
044500             AND  ITM.STR_NBR          = :EPTRN-STR-NBR           04340000
044600             AND  ITM.RGST_ID          = :EPTRN-RGST-ID           04350000
044700             AND  ITM.TRN_NBR          = :EPTRN-TRN-NBR           04360000
044800             AND  ITM.STRT_TM          = :EPTRN-STRT-TM           04370000
044900             AND  ITM.SLS_CORR_SEQ_NBR = :PV-DB2-SLS-CORR-SEQ-NBR 04380000
045000                                                                  04390000
045100             AND  ITM.PARTN_NBR        = IRT.PARTN_NBR            04400000
045200             AND  ITM.STR_NBR          = IRT.STR_NBR              04410000
045300             AND  ITM.RGST_ID          = IRT.RGST_ID              04420000
045400             AND  ITM.TRN_NBR          = IRT.TRN_NBR              04430000
045500             AND  ITM.STRT_TM          = IRT.STRT_TM              04440000
045600             AND  ITM.SLS_CORR_SEQ_NBR = IRT.SLS_CORR_SEQ_NBR     04450000
045700             AND  ITM.LNE_ITM_SEQ_NBR  = IRT.LNE_ITM_SEQ_NBR      04460000
045800                                                                  04470000
045900             AND  ITM.LIV_RSLU_CDE     IN ('+', '-')              04480000
046000             AND  IRT.ORIG_STR_NBR     = LOC.LOC_NBR              04490000
046100             AND  LOC.LOC_TYP_CDE      = 'DS'                     04500000
046200             AND  LOC.E_BUS_IND        = 'Y'                      04510000
046300             AND  LOC.OPN_DTE         <= :PV-POS-CCYY-MM-DD       04520000
046400             AND  LOC.CLO_DTE         >= :PV-POS-CCYY-MM-DD       04530000
046500                                                                  04540000
046600             AND  PRT.SLS_DTE = IRT.ORIG_SLS_DTE                  04550000
046700             AND  PRT.STR_GP_CDE = 'A'                            04560000
267620             AND  NOT ITM.DEPT_NBR = '985'                        04570002
046800                                                                  04572000
046900          ORDER BY IRT.ORIG_SLS_DTE                               04573000
047000                  ,IRT.ORIG_STR_NBR                               04574000
047100                  ,IRT.ORIG_RGST_ID                               04575000
047200                  ,IRT.ORIG_TRN_NBR                               04576000
047300                  ,IRT.ORIG_STRT_TM                               04577000
047400          WITH UR                                                 04578000
047500     END-EXEC.                                                    04579000
047600                                                                  04580000
047700                                                                  04590000
047800                                                                  04600000
047900 PROCEDURE DIVISION.                                              04610000
048000******************************************************************04620000
048100* MAINLINE                                                        04630000
048200******************************************************************04640000
048300 0000-MAINLINE.                                                   04650000
048400                                                                  04660000
048500     PERFORM 1000-INITIALIZE-PROGRAM.                             04670000
048600                                                                  04680000
048700     PERFORM 2000-PROCESS-MASTER-CURSOR                           04690000
048800       UNTIL PS-END-OF-MASTER-CURSOR.                             04700000
048900                                                                  04710000
049000     PERFORM 3200-CLOSE-MASTER-CURSOR.                            04720000
049100                                                                  04730000
049200     PERFORM 9900-END-OF-JOB-ROUTINE.                             04740000
049300                                                                  04750000
049400     STOP RUN.                                                    04760000
049500                                                                  04770000
049600                                                                  04780000
049700******************************************************************04790000
049800* OPEN FILES, PROCESS CONTROL CARD, CONNECTS TO QMGR              04800000
049900******************************************************************04810000
050000 1000-INITIALIZE-PROGRAM.                                         04820000
050100                                                                  04830000
050200     OPEN INPUT  POS-DATE-CARD-FILE.                              04840000
050300     OPEN OUTPUT TSASUM-FILE.                                     04850000
050400                                                                  04860000
050500     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 04870000
050600                                                                  04880000
050700     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            04890000
050800     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            04900000
050900                                                                  04910000
051000     MOVE SYS-DATE (1:2) TO SD-CENT.                              04920000
051100     MOVE SYS-DATE (3:2) TO SD-YEAR.                              04930000
051200     MOVE SYS-DATE (5:2) TO SD-MONTH.                             04940000
051300     MOVE SYS-DATE (7:2) TO SD-DAY.                               04950000
051400                                                                  04960000
051500     PERFORM 1100-PROCESS-CONTROL-CARD.                           04970000
051600     PERFORM 1200-SLCT-CUR-DAY-PARTN.                             04980000
051700                                                                  04990000
051800     PERFORM 3000-OPEN-MASTER-CURSOR.                             05000000
051900     PERFORM 3100-FETCH-MASTER-CURSOR.                            05010000
052000                                                                  05020000
052100                                                                  05030000
052200******************************************************************05040000
052300* READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL       05050000
052400* DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.      05060000
052500******************************************************************05070000
052600 1100-PROCESS-CONTROL-CARD.                                       05080000
052700                                                                  05090000
052800     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        05100000
052900                                                                  05110000
053000     CLOSE POS-DATE-CARD-FILE.                                    05120000
053100                                                                  05130000
053200     IF PS-END-OF-CARD-FILE                                       05140000
053300         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   05150000
053400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  05160000
053500         SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                   05170000
053600         PERFORM 9500-ABEND                                       05180000
053700     END-IF.                                                      05190000
053800                                                                  05200000
053900     DISPLAY '          '.                                        05210000
053900     DISPLAY PC-PGM-NAME                                          05220000
054000             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  05230000
054100                                                                  05240000
054200     PERFORM 1115-CONVERT-INPUT-DATE.                             05250000
054300                                                                  05260000
054400                                                                  05270000
054500******************************************************************05280000
054600* READ DATE CONTROL CARD                                          05290000
054700******************************************************************05300000
054800 1110-READ-POS-DATE-CARD-FILE.                                    05310000
054900                                                                  05320000
055000     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 05330000
055100        AT END                                                    05340000
055200           SET PS-END-OF-CARD-FILE TO TRUE.                       05350000
055300                                                                  05360000
055400                                                                  05370000
055500******************************************************************05380000
055600* CALL KOHLS CALENDAR ROUTINE:                                    05390000
055700*     PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).                05400000
055800*   RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT).     05410000
055900******************************************************************05420000
056000 1115-CONVERT-INPUT-DATE.                                         05430000
056100                                                                  05440000
056400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05450000
056500                                                                  05460000
056600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05470000
056700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05480000
056800     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05490000
056900                                                                  05500000
057000     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05510000
057100                                                                  05520000
057200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05530000
057300                                             DPG54 DPG55 DPG56.   05540000
057400     EVALUATE TRUE                                                05550000
057500         WHEN DPG54-SEVERE-ERROR                                  05560000
057600         WHEN DPG54-DATE-INVALID                                  05570000
057700             MOVE '1115-CONVERT-INPUT-DATE'                       05580000
057800                                   TO PV-PARAGRAPH-NAME           05590000
057900             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05600000
058000                                   TO PV-OPERATION-MSG-1          05610000
058100             SET ABEND-4019-CAL-SUB-ERROR                         05620000
058200                                   TO TRUE                        05630000
058300             MOVE DPG54-ERROR-MESSAGE                             05640000
058400                                   TO PV-OPERATION-MSG-2          05650000
058500             PERFORM 9500-ABEND                                   05660000
058600     END-EVALUATE.                                                05670000
058700                                                                  05680000
058800     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD.          05690000
058900                                                                  05700000
059200                                                                  05710000
059300******************************************************************05720000
059400* FIND PARTITION NUMBER THAT CORRESPONDS WITH CONTROL CARD DATE   05730000
059500******************************************************************05740000
059600 1200-SLCT-CUR-DAY-PARTN.                                         05750000
059700                                                                  05760000
060000     EXEC SQL                                                     05770000
060100          SELECT  PARTN_NBR                                       05780000
060200            INTO :PV-CURRENT-DAY-PARTN                            05790000
060300             FROM TEPPART                                         05800000
060400            WHERE SLS_DTE      = :PV-POS-CCYY-MM-DD               05810000
060500              AND DB_STRUC_CDE = 'O'                              05820000
060600              AND STR_GP_CDE   = 'A'                              05830000
060700            WITH UR                                               05840000
060800     END-EXEC.                                                    05850000
060900                                                                  05860000
061000     EVALUATE TRUE                                                05870000
061100         WHEN SQLCODE = ZERO                                      05880000
061400             CONTINUE                                             05890000
061500                                                                  05900000
061600         WHEN OTHER                                               05910000
061700             MOVE SQLCODE TO PV-SQL                               05920000
061800                                                                  05930000
061900             DISPLAY '             '                              05940000
062000             DISPLAY 'SALES DATE = ' PV-POS-CCYY-MM-DD            05950000
062100                                                                  05960000
062200             MOVE '1200-SLCT-CUR-DAY-PARTN' TO PV-PARAGRAPH-NAME  05970000
062300             MOVE 'TEPPART'                 TO PV-DB2-TABLE-NAME  05980000
062400                                                                  05990000
062500             STRING 'ERROR ON READ OF TEPPART - SQLCODE = '       06000000
062600                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG06010000
062700             END-STRING                                           06020000
062800                                                                  06030000
062900             SET ABEND-4002-READ-ERROR TO TRUE                    06040000
063000             PERFORM 9100-SQL-ABEND                               06050000
063100     END-EVALUATE.                                                06060000
063200                                                                  06070000
063300                                                                  06080000
063400******************************************************************06090000
063500* MASTER CURSOR PROCESSING                                        06100000
063600******************************************************************06110000
063700 2000-PROCESS-MASTER-CURSOR.                                      06120000
063800                                                                  06130000
064100     PERFORM 2100-FIND-SLS-CORR-SEQ-NBR.                          06140000
064200                                                                  06150000
064300     INITIALIZE EPIRT-ORIG-SLS-DTE                                06160000
064400                EPIRT-ORIG-STR-NBR                                06170000
064500                EPIRT-ORIG-RGST-ID                                06180000
064600                EPIRT-ORIG-TRN-NBR                                06190000
064700                EPIRT-ORIG-STRT-TM                                06200000
064800                PV-SVD-SLS-DTE                                    06210000
064900                PV-SVD-STR-NBR                                    06220000
065000                PV-SVD-PARTN-NBR                                  06230000
065100                PV-SVD-RGST-ID                                    06240000
065200                PV-SVD-TRN-NBR                                    06250000
065300                PV-SVD-STRT-TM.                                   06260000
065400                                                                  06270000
065500     SET PS-TRAN-FIRST-TIME TO TRUE.                              06280000
065600                                                                  06290000
065700     PERFORM 2200-OPEN-RET-ITM-CURSOR.                            06300000
065800     PERFORM 2300-FETCH-RTRN-ITM-CURSOR.                          06310000
065900                                                                  06320000
066000     MOVE ZEROS TO PV-ENTIRE-TRAN-NET-CHRGD-AMT.                  06330000
066100                                                                  06340000
066200     PERFORM 2400-PROCESS-RET-OF-ORIG-TRAN                        06350000
066300       UNTIL PS-END-OF-RETRN-ITM-CSR.                             06360000
066400                                                                  06370000
066500     PERFORM 2500-CLOSE-RET-ITM-CURSOR.                           06380000
066600                                                                  06390000
066700     PERFORM 4000-WRITE-TSASUM.                                   06400000
066800                                                                  06410000
066900     PERFORM 3100-FETCH-MASTER-CURSOR.                            06420000
067000                                                                  06430000
067100                                                                  06440000
067200***************************************************************** 06450000
067300* FINDS THE SALES CORRECTION SEQUENCE NUMBER.                     06460000
067400***************************************************************** 06470000
067500 2100-FIND-SLS-CORR-SEQ-NBR.                                      06480000
067600                                                                  06490000
067900     EXEC SQL                                                     06500000
068000       SELECT  MAX(SLS_CORR_SEQ_NBR)                              06510000
068100         INTO  :PV-DB2-SLS-CORR-SEQ-NBR                           06520000
068200         FROM  TEPTRN                                             06530000
068300        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              06540000
068400         AND   STR_NBR            = :EPTRN-STR-NBR                06550000
068500         AND   RGST_ID            = :EPTRN-RGST-ID                06560000
068600         AND   TRN_NBR            = :EPTRN-TRN-NBR                06570000
068700         AND   STRT_TM            = :EPTRN-STRT-TM                06580000
069000       WITH UR                                                    06590000
069100     END-EXEC.                                                    06600000
069200                                                                  06610000
069500     EVALUATE TRUE                                                06620000
069600         WHEN SQLCODE = ZERO                                      06630000
069700             CONTINUE                                             06640000
069800                                                                  06650000
069900         WHEN OTHER                                               06660000
070000             DISPLAY '            '                               06670000
070100             DISPLAY 'PARTN NBR = ' EPTRN-PARTN-NBR               06680000
070200             DISPLAY 'STR NBR   = ' EPTRN-STR-NBR                 06690000
070300             DISPLAY 'RGST ID   = ' EPTRN-RGST-ID                 06700000
070400             DISPLAY 'TRN NBR   = ' EPTRN-TRN-NBR                 06710000
070500             DISPLAY 'STRT-TM   = ' EPTRN-STRT-TM                 06720000
070600                                                                  06730000
070700             MOVE '2100-FIND-SLS-CORR-SEQ-NBR'                    06740000
070800                                  TO PV-PARAGRAPH-NAME            06750000
070900             MOVE 'ERROR SELECTING SLS CORR SEQ NBR'              06760000
071000                                  TO PV-DB2-OPERATION-MSG         06770000
071100                                                                  06780000
071200             PERFORM 9100-SQL-ABEND                               06790000
071300     END-EVALUATE.                                                06800000
071400                                                                  06810000
071500                                                                  06820000
071600***************************************************************** 06830000
071700* OPEN CURSOR                                                     06840000
071800***************************************************************** 06850000
071900 2200-OPEN-RET-ITM-CURSOR.                                        06860000
072000                                                                  06870000
072100     EXEC SQL                                                     06880000
072200          OPEN RETRN-ITM-CURSOR                                   06890000
072300     END-EXEC.                                                    06900000
072400                                                                  06910000
072500     EVALUATE TRUE                                                06920000
072600         WHEN SQLCODE = ZERO                                      06930000
072700              SET PS-NOT-END-OF-RTRN-ITM-CSR TO TRUE              06940000
072800                                                                  06950000
072900         WHEN SQLWARN0 NOT EQUAL SPACE                            06960000
073000         WHEN SQLCODE NOT EQUAL ZERO                              06970000
073100             MOVE '2200-OPEN-RET-ITM-CURSOR'                      06980000
073200                                   TO PV-PARAGRAPH-NAME           06990000
073300             MOVE 'ERROR ON OPEN OF RTRN ITM CSR'                 07000000
073400                                   TO PV-DB2-OPERATION-MSG        07010000
073500             PERFORM 9100-SQL-ABEND                               07020000
073600     END-EVALUATE.                                                07030000
073700                                                                  07040000
073800                                                                  07050000
073900***************************************************************** 07060000
074000* FETCH RTRN ITM CURSOR                                           07070000
074100***************************************************************** 07080000
074200 2300-FETCH-RTRN-ITM-CURSOR.                                      07090000
074300                                                                  07100000
074600     EXEC SQL                                                     07110000
074700          FETCH RETRN-ITM-CURSOR                                  07120000
074800           INTO :EPITM-LNE-ITM-SEQ-NBR                            07130000
074900               ,:EPITM-SLD-QTY                                    07140000
075000               ,:EPITM-NET-CHRGD-AMT                              07150000
075100               ,:EPITM-TXBL-IND                                   07160000
075200               ,:EPITM-RCPT-TX-TOT-CDE                            07170000
075300               ,:EPITM-TX-RT-PCT                                  07180000
075400               ,:EPITM-TX-AMT                                     07190000
075500               ,:EPITM-SKU-NBR                                    07200000
075600               ,:EPIRT-ORIG-SLS-DTE                               07210000
075700               ,:EPIRT-ORIG-STR-NBR                               07220000
075800               ,:EPIRT-ORIG-RGST-ID                               07230000
075900               ,:EPIRT-ORIG-TRN-NBR                               07240000
076000               ,:EPIRT-ORIG-STRT-TM                               07250000
076100               ,:EPIRT-ORIG-LNE-ITM-NBR                           07260000
076200               ,:PV-ORIG-TRN-PARTN                                07270000
076300               ,:PV-ORIG-TRN-DB-STRUC-CDE                         07280000
076400     END-EXEC.                                                    07290000
076500                                                                  07300000
076800     EVALUATE TRUE                                                07310000
076900         WHEN SQLCODE = ZERO                                      07320000
077000             IF EPIRT-ORIG-SLS-DTE NOT = PV-SVD-SLS-DTE           07330000
077100                OR  EPIRT-ORIG-STR-NBR NOT = PV-SVD-STR-NBR       07340000
077200                OR  EPIRT-ORIG-RGST-ID NOT = PV-SVD-RGST-ID       07350000
077300                OR  EPIRT-ORIG-TRN-NBR NOT = PV-SVD-TRN-NBR       07360000
077400                OR  EPIRT-ORIG-STRT-TM NOT = PV-SVD-STRT-TM       07370000
077500                                                                  07380000
077600               IF PS-TRAN-FIRST-TIME                              07390000
077700                  MOVE EPIRT-ORIG-SLS-DTE TO PV-SVD-SLS-DTE       07400000
077800                  MOVE EPIRT-ORIG-STR-NBR TO PV-SVD-STR-NBR       07410000
077900                  MOVE PV-ORIG-TRN-PARTN  TO PV-SVD-PARTN-NBR     07420000
078000                  MOVE EPIRT-ORIG-RGST-ID TO PV-SVD-RGST-ID       07430000
078100                  MOVE EPIRT-ORIG-TRN-NBR TO PV-SVD-TRN-NBR       07440000
078200                  MOVE EPIRT-ORIG-STRT-TM TO PV-SVD-STRT-TM       07450000
078300                  SET PS-TRAN-NOT-FIRST-TIME TO TRUE              07460000
078400               ELSE                                               07470000
078500                  SET PS-ORIG-TRAN-INFO-CHNGD TO TRUE             07480000
078600               END-IF                                             07490000
078700             END-IF                                               07500000
078800                                                                  07510000
078900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          07520000
079000             SET PS-END-OF-RETRN-ITM-CSR TO TRUE                  07530000
079100                                                                  07540000
079200         WHEN SQLWARN0 NOT EQUAL SPACE                            07550000
079300         WHEN SQLCODE NOT EQUAL ZERO                              07560000
079400             MOVE '2300-FETCH-RTRN-ITM-CURSOR'                    07570000
079500                                   TO PV-PARAGRAPH-NAME           07580000
079600             MOVE 'ERROR ON FETCH OF RTRN ITM CSR'                07590000
079700                                   TO PV-DB2-OPERATION-MSG        07600000
079800             PERFORM 9100-SQL-ABEND                               07610000
079900     END-EVALUATE.                                                07620000
080000                                                                  07630000
080100                                                                  07640000
080200***************************************************************** 07650000
080300* PROCESSES EACH ORIG SALE TRAN TIED TO THE RETRN TRANS RETRVD    07660000
080400* IN THE MASTER CURSOR.  WHEN NEW ORIG TRAN INFO IS DETECTED      07670000
080500* WITHIN THE RETURN, THE MESSAGE IS WRITTEN OUT AND THEN WE PROCES07680000
080600* THE NEXT ORIG SALE TRANS RETURNED.  WE DO THIS UNTIL ALL ORIG   07690000
080700* TRANSACTIONS WITHIN THE RETURN HAVE BEEN PROCESSED.  AT THAT    07700000
080800* POINT WE UPDATE TSASUM.                                         07710000
080900* WILL INITIALIZE FIELDS BEFORE EACH TRANSACTION, AND THEN BUILD  07720000
081000* A INTERNAL TABLE WITH ITEM INFORMATION FOR ALL ITEMS RETURNED   07730000
081100* IN THE TRANSACTION.                                             07740000
081200***************************************************************** 07750000
081300 2400-PROCESS-RET-OF-ORIG-TRAN.                                   07760000
081400                                                                  07770000
081700     MOVE ZEROS TO PV-TRAN-NET-CHRGD-AMT.                         07780000
081800                                                                  07790000
081900     PERFORM 2410-PROCESS-RET-ITMS                                07800000
082000       UNTIL PS-END-OF-RETRN-ITM-CSR                              07810000
082100          OR PS-ORIG-TRAN-INFO-CHNGD.                             07820000
082200                                                                  07830000
082300     SET PS-ORIG-TRAN-HASNT-CHNGD TO TRUE.                        07840000
082400                                                                  07850000
082500*** SAVE OFF THE FOLLOWING FIELDS, TO BE USED ON THE TSASUM       07860000
082600*** UPDATE/INSERT, ONCE THE ENTIRE RETURN TRANS IS COMPLETE       07870000
082700                                                                  07880000
082800     ADD PV-TRAN-NET-CHRGD-AMT TO                                 07890000
082900             PV-ENTIRE-TRAN-NET-CHRGD-AMT.                        07900000
083000                                                                  07910000
083100     MOVE EPIRT-ORIG-SLS-DTE TO PV-SVD-SLS-DTE.                   07920000
083200     MOVE EPIRT-ORIG-STR-NBR TO PV-SVD-STR-NBR.                   07930000
083300     MOVE EPIRT-ORIG-RGST-ID TO PV-SVD-RGST-ID.                   07940000
083400     MOVE EPIRT-ORIG-TRN-NBR TO PV-SVD-TRN-NBR.                   07950000
083500     MOVE EPIRT-ORIG-STRT-TM TO PV-SVD-STRT-TM.                   07960000
083600     MOVE PV-ORIG-TRN-PARTN  TO PV-SVD-PARTN-NBR.                 07970000
083700                                                                  07980000
083800                                                                  07990000
083900***************************************************************** 08000000
084000* PROCESSES EACH ITEM RETURNED IN THE TRANSACTION THAT ORIGINATE  08010000
084100* AT AN E-STORE.  STORES THE INFORMATION IN AN INTERNAL TABLE.    08020000
084200***************************************************************** 08030000
084300 2410-PROCESS-RET-ITMS.                                           08040000
084400                                                                  08050000
084700     COMPUTE EPITM-NET-CHRGD-AMT = (EPITM-NET-CHRGD-AMT * -1).    08060000
084800                                                                  08070000
084900     ADD  EPITM-NET-CHRGD-AMT TO   PV-TRAN-NET-CHRGD-AMT.         08080000
085000                                                                  08090000
085100                                                                  08100000
085200     PERFORM 2300-FETCH-RTRN-ITM-CURSOR.                          08110000
085300                                                                  08120000
085400                                                                  08130000
085500***************************************************************** 08140000
085600* CLOSE CURSOR                                                    08150000
085700***************************************************************** 08160000
085800 2500-CLOSE-RET-ITM-CURSOR.                                       08170000
085900                                                                  08180000
086000     EXEC SQL                                                     08190000
086100          CLOSE RETRN-ITM-CURSOR                                  08200000
086200     END-EXEC.                                                    08210000
086300                                                                  08220000
086400     EVALUATE TRUE                                                08230000
086500         WHEN SQLCODE = ZERO                                      08240000
086600              CONTINUE                                            08250000
086700                                                                  08260000
086800         WHEN SQLWARN0 NOT EQUAL SPACE                            08270000
086900         WHEN SQLCODE NOT EQUAL ZERO                              08280000
087000             MOVE '2500-CLOSE-RET-ITM-CSR'                        08290000
087100                                   TO PV-PARAGRAPH-NAME           08300000
087200             MOVE 'ERROR ON CLOSE OF RTRN ITM CSR'                08310000
087300                                   TO PV-DB2-OPERATION-MSG        08320000
087400             PERFORM 9100-SQL-ABEND                               08330000
087500     END-EVALUATE.                                                08340000
087600                                                                  08350000
087700                                                                  08360000
087800***************************************************************** 08370000
087900* OPEN MASTER-CURSOR                                              08380000
088000***************************************************************** 08390000
088100 3000-OPEN-MASTER-CURSOR.                                         08400000
088200                                                                  08410000
088300     EXEC SQL                                                     08420000
088400          OPEN MASTER-CURSOR                                      08430000
088500     END-EXEC.                                                    08440000
088600                                                                  08450000
088700     EVALUATE TRUE                                                08460000
088800         WHEN SQLCODE = ZERO                                      08470000
088900              CONTINUE                                            08480000
089000                                                                  08490000
089100         WHEN SQLWARN0 NOT EQUAL SPACE                            08500000
089200         WHEN SQLCODE NOT EQUAL ZERO                              08510000
089300             MOVE '3000-OPEN-MASTER-CURSOR'                       08520000
089400                                   TO PV-PARAGRAPH-NAME           08530000
089500             MOVE 'ERROR ON OPEN OF MASTER-CURSOR'                08540000
089600                                   TO PV-DB2-OPERATION-MSG        08550000
089700             PERFORM 9100-SQL-ABEND                               08560000
089800     END-EVALUATE.                                                08570000
089900                                                                  08580000
090000                                                                  08590000
090100***************************************************************** 08600000
090200* FETCH MASTER-CURSOR                                             08610000
090300***************************************************************** 08620000
090400 3100-FETCH-MASTER-CURSOR.                                        08630000
090500                                                                  08640000
090800     EXEC SQL                                                     08650000
090900          FETCH MASTER-CURSOR                                     08660000
091000           INTO :EPTRN-PARTN-NBR                                  08670000
091100               ,:EPTRN-SLS-DTE                                    08680000
091200               ,:EPTRN-STR-NBR                                    08690000
091300               ,:EPTRN-RGST-ID                                    08700000
091400               ,:EPTRN-TRN-NBR                                    08710000
091500               ,:EPTRN-STRT-TM                                    08720000
091600     END-EXEC.                                                    08730000
091700                                                                  08740000
092000     EVALUATE TRUE                                                08750000
092100         WHEN SQLCODE = ZERO                                      08760000
092200             ADD 1 TO PV-MASTER-CURSOR-CNT                        08770000
092300                                                                  08780000
092400         WHEN SQLCODE = PC-ROW-NOT-FOUND                          08790000
092500             SET PS-END-OF-MASTER-CURSOR TO TRUE                  08800000
092600                                                                  08810000
092700         WHEN SQLWARN0 NOT EQUAL SPACE                            08820000
092800         WHEN SQLCODE NOT EQUAL ZERO                              08830000
092900             MOVE '3100-FETCH-MASTER-CURSOR'                      08840000
093000                                   TO PV-PARAGRAPH-NAME           08850000
093100             MOVE 'ERROR ON FETCH OF MASTER-CURSOR'               08860000
093200                                   TO PV-DB2-OPERATION-MSG        08870000
093300             PERFORM 9100-SQL-ABEND                               08880000
093400     END-EVALUATE.                                                08890000
093500                                                                  08900000
093600                                                                  08910000
093700***************************************************************** 08920000
093800* CLOSE MASTER-CURSOR.                                            08930000
093900***************************************************************** 08940000
094000 3200-CLOSE-MASTER-CURSOR.                                        08950000
094100                                                                  08960000
094200     EXEC SQL                                                     08970000
094300          CLOSE MASTER-CURSOR                                     08980000
094400     END-EXEC.                                                    08990000
094500                                                                  09000000
094600     EVALUATE TRUE                                                09010000
094700         WHEN SQLCODE = ZERO                                      09020000
094800              CONTINUE                                            09030000
094900                                                                  09040000
095000         WHEN SQLWARN0 NOT EQUAL SPACE                            09050000
095100         WHEN SQLCODE NOT EQUAL ZERO                              09060000
095200             MOVE '3200-CLOSE-MASTER-CURSOR'                      09070000
095300                                   TO PV-PARAGRAPH-NAME           09080000
095400             MOVE 'ERROR ON CLOSE OF MASTER CURSOR'               09090000
095500                                   TO PV-DB2-OPERATION-MSG        09100000
095600             PERFORM 9100-SQL-ABEND                               09110000
095700     END-EVALUATE.                                                09120000
095800                                                                  09130000
095900                                                                  09140000
096000***************************************************************** 09150000
096100* WRITE THE TSASUM RECORDS                                        09160000
096200***************************************************************** 09170000
096300 4000-WRITE-TSASUM.                                               09180000
096400                                                                  09190000
096700     MOVE EPTRN-PARTN-NBR     TO SA009-PARTN-NBR.                 09200000
096800     MOVE EPTRN-STR-NBR       TO SA009-STR-NBR.                   09210000
096900     MOVE EPTRN-RGST-ID       TO SA009-RGST-ID.                   09220000
097000     MOVE 'D'                 TO SA009-SUM-TYP-CDE.               09230000
097100     MOVE 'ECR'               TO SA009-SUM-CTG-CDE.               09240000
097200     MOVE 1                   TO SA009-CTG-NBR-OF-ITM.            09250000
097400                                                                  09260000
097500     COMPUTE SA009-CTG-AMT = PV-ENTIRE-TRAN-NET-CHRGD-AMT * -1.   09270000
097600                                                                  09280000
097700     IF  SA009-CTG-AMT NOT = 0                                    09290000
097800         WRITE TSASUM-REC FROM SA009-TSASUM-REC                   09300000
097900         ADD 1 TO PA-TSASUM-WRITTEN                               09310000
098000     END-IF.                                                      09320000
098100                                                                  09330000
098200                                                                  09340000
098300***************************************************************** 09350000
098400* ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.    09360000
098500***************************************************************** 09370000
098600 9100-SQL-ABEND.                                                  09380000
098700                                                                  09390000
098800     PERFORM 9900-END-OF-JOB-ROUTINE.                             09400000
098900                                                                  09410000
099000     DISPLAY '** ABEND     **'.                                   09420000
099100     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    09430000
099200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              09440000
099300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-MSG.           09450000
099400     DISPLAY '** SQLCODE   ** = ' SQLCODE.                        09460000
099500                                                                  09470000
099600******************************************************************09480000
099700* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     09490000
099800* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      09500000
099900******************************************************************09510000
100000     COPY DPPD004.                                                09520000
100100                                                                  09530000
100200     SET ABEND-4013-DB2-ERROR TO TRUE.                            09540000
100300                                                                  09550000
100400     CALL 'ILBOABN0' USING ABEND-CODE.                            09560000
100500                                                                  09570000
100600                                                                  09580000
100700***************************************************************** 09590000
100800* ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                      09600000
100900***************************************************************** 09610000
101000 9500-ABEND.                                                      09620000
101100                                                                  09630000
101200     PERFORM 9900-END-OF-JOB-ROUTINE.                             09640000
101300                                                                  09650000
101400     DISPLAY '** ABEND           **'.                             09660000
101500     DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              09670000
101600     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        09680000
101700     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       09690000
101800     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       09700000
101900                                                                  09710000
102000     CALL 'ILBOABN0' USING ABEND-CODE.                            09720000
102100                                                                  09730000
102200                                                                  09740000
102300******************************************************************09750000
102400* PREFORMS TASK TERMINATION PROCESSING                            09760000
102500******************************************************************09770000
102600 9900-END-OF-JOB-ROUTINE.                                         09780000
102700                                                                  09790000
102800     CLOSE TSASUM-FILE.                                           09800000
102900                                                                  09810000
103000     PERFORM 9999-CONTROLS.                                       09820000
103100                                                                  09830000
103200                                                                  09840000
103300******************************************************************09850000
103400* DISPLAY CONTROLS FROM THE PROGRAM                               09860000
103500******************************************************************09870000
103600 9999-CONTROLS.                                                   09880000
103700                                                                  09890000
103800     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 09900000
103900                                                                  09910000
104000     MOVE SYS-TIME (1:2) TO ST-END-HR.                            09920000
104100     MOVE SYS-TIME (3:2) TO ST-END-MN.                            09930000
104200                                                                  09940000
104300     DISPLAY '                    '.                              09950000
104400     DISPLAY '**********************'.                            09960000
104500     DISPLAY '   SAKUT053 CONTROLS  '.                            09970000
104600     DISPLAY '**********************'.                            09980000
104700     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         09990000
104800     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          10000000
104900     DISPLAY 'END TIME  = ' ST-END-TIME.                          10010000
105000     DISPLAY '======================'.                            10020000
059000     DISPLAY 'POS-CCYY-MM-DD    = ' PV-POS-CCYY-MM-DD.            10030000
061200     DISPLAY 'CURRENT-DAY-PARTN = ' PV-CURRENT-DAY-PARTN.         10040000
105200     DISPLAY '                  '.                                10050000
105100     DISPLAY 'MSTR CURSOR CNT = ' PV-MASTER-CURSOR-CNT.           10060000
105200     DISPLAY '                  '.                                10070000
105300     DISPLAY 'TSASUM WRITTEN  = ' PA-TSASUM-WRITTEN.              10080000
105400     DISPLAY '                  '.                                10090000
105500                                                                  10100000
105600                                                                  10110000
