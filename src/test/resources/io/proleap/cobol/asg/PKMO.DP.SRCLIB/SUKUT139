000100******************************************************************00020001
000200 IDENTIFICATION DIVISION.                                         00030001
000300******************************************************************00040001
000400                                                                  00050001
000500 PROGRAM-ID.    SUKUT139.                                         00060001
000600 AUTHOR.        DAN HINTZ.                                        00070001
000700 INSTALLATION.  KOHLS.                                            00080001
000800 DATE-WRITTEN   FEBRUARY 2009.                                    00090001
000900 DATE-COMPILED.                                                   00100001
001000                                                                  00110001
001100******************************************************************00120001
001200*  THIS PROGRAM CREATES A CONTROL CARD THAT WILL BE USED BY      *00130001
001300*  SUKUT140 TO CHECK CONVEYOR DIVERTS.  THIS CONTROL CARD WILL   *00140001
001310*  CONTAIN THE CURRENT TIMESTAMP, A MINUTES PARAMETER, AND A     *00150001
001320*  CALCULATED TIMESTAMP THAT IS THE CURRENT TIMESTAMP MINUS THE  *00160001
001330*  MINUTES SPECIFIED IN THE MINUTES PARAMETER.                   *00170001
001400******************************************************************00180001
001500                                                                  00190001
001600******************************************************************00200001
001700 ENVIRONMENT DIVISION.                                            00210001
001800******************************************************************00220001
001900                                                                  00230001
002000 CONFIGURATION SECTION.                                           00240001
002100                                                                  00250001
002200 SOURCE-COMPUTER.        IBM-3090.                                00260001
002300 OBJECT-COMPUTER.        IBM-3090.                                00270001
002400                                                                  00280001
002500 INPUT-OUTPUT SECTION.                                            00290001
002600                                                                  00300001
002700 FILE-CONTROL.                                                    00310001
002800                                                                  00320001
003900     SELECT SU-CNVYR-CNTL-FILE                                    00330001
004000         ASSIGN TO OUT01.                                         00340001
004100                                                                  00350001
003500******************************************************************00420001
003600 DATA DIVISION.                                                   00430001
003700******************************************************************00440001
003800                                                                  00450001
003900 FILE SECTION.                                                    00460001
005000*                                                                 00470001
005100 FD  SU-CNVYR-CNTL-FILE                                           00480001
005200     RECORDING MODE IS F                                          00490001
005300     LABEL RECORDS ARE STANDARD                                   00500001
005400     BLOCK CONTAINS 0 RECORDS.                                    00510001
005500 01  SU-CNVYR-CNTL-FILE-RECORD        PIC  X(75).                 00520001
005400*                                                                 00680001
005500*                                                                 00690001
005600******************************************************************00700001
005700 WORKING-STORAGE SECTION.                                         00710001
005800******************************************************************00720001
005900*                                                                 00730001
006000*                                                                 00740001
007900******************************************************************00750001
008000** DIVERT MONITORING CONTROL CARD LAYOUT COPYBOOK               **00760001
008100******************************************************************00770001
008200     COPY SURD096.                                                00780001
008300*                                                                 00790001
008400*                                                                 00800001
007900******************************************************************00811001
008000** DB2 FORMATTED MESSAGE AREA                                   **00812001
008100******************************************************************00813001
008200     COPY DPWS004.                                                00814001
008300*                                                                 00815001
008400*                                                                 00816001
008600******************************************************************00820001
008700** COMMUNICATIONS AREA FOR DB2                                  **00830001
008800******************************************************************00840001
008900     EXEC SQL                                                     00850001
009000          INCLUDE SQLCA                                           00860001
009100     END-EXEC.                                                    00870001
009200*                                                                 00880001
009300*                                                                 00890001
009400******************************************************************00900001
009500** COBOL DECLARATION AND DCLGEN MEMBER FOR THE KOHLS PROCESSING **00910001
009600** PARAMETER TABLE                                              **00920001
009700******************************************************************00930001
009800     EXEC SQL                                                     00940001
009900          INCLUDE TKRPRPM                                         00950001
010000     END-EXEC.                                                    00960001
010010*                                                                 00970001
010020*                                                                 00980001
011200 01  ABEND-CODE                      PIC S9(04)    VALUE +0       01170001
011300                                                   COMP SYNC.     01180001
011400                                                                  01190001
012200 01  PC-PROGRAM-CONSTANTS.                                        01320001
012500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01330001
012600         'SUKUT139'.                                              01340001
012900     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01350001
013000                                                   COMP SYNC.     01360001
013200                                                                  01370001
013300 01  PV-PROGRAM-VARIABLES.                                        01380001
013500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01390001
013600     05  PV-DB2-TABLE-NAME           PIC  X(30)    VALUE SPACES.  01400001
013610     05  PV-DB2-OPERATION-MESSAGE    PIC  X(30)    VALUE SPACES.  01410001
013700     05  PV-COUNTER                  PIC S9(04)    VALUE ZERO     01420001
013800                                                   COMP SYNC.     01430001
014700     05  PV-PARM-MINUTES             PIC S9(09)    VALUE ZERO     01440001
014800                                                   COMP SYNC.     01450001
013610     05  PV-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  01460001
013610     05  PV-CALC-TIMESTAMP           PIC  X(26)    VALUE SPACES.  01470001
014500     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01540001
014600                                                                  01550001
014700     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01560001
014800                                                   COMP-3.        01570001
014900     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01580001
015100     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01590001
015300     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01600001
015500     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01610001
022510                                                                  02420001
022511                                                                  02430001
022520******************************************************************02440001
022600 PROCEDURE DIVISION.                                              02450001
022700******************************************************************02460001
022800                                                                  02470001
022810******************************************************************02480001
022820* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     02490001
022830*      PROGRAM.                                                   02500001
022840******************************************************************02510001
022900 0000-PROGRAM-MAINLINE.                                           02520001
023400                                                                  02530001
025322     OPEN OUTPUT SU-CNVYR-CNTL-FILE.                              02540001
023400                                                                  02550001
023504     PERFORM 2000-SET-UP-CNVYR-CNTL-REC.                          02580001
023400                                                                  02590101
023930     CLOSE SU-CNVYR-CNTL-FILE.                                    02600001
023950                                                                  02630001
023952     DISPLAY 'CURRENT TIMESTAMP.................: '               02650001
                    PV-CURRENT-TIMESTAMP.                               02651001
023953                                                                  02660001
000600     MOVE PV-PARM-MINUTES       TO PV-DISPLAY-COUNT.              02661001
023973     DISPLAY 'PARM MINUTES......................: '               02662001
                    PV-DISPLAY-COUNT.                                   02662101
023953                                                                  02663001
023970     DISPLAY 'CALCULATED TIMESTAMP..............: '               02680001
                    PV-CALC-TIMESTAMP.                                  02680102
023970     DISPLAY '(CURRENT TIMESTAMP - PARM MINUTES).'                02681001
023980                                                                  02720001
024000     STOP RUN.                                                    02730001
024010*                                                                 02740001
024100*0000-EXIT.                                                       02750001
024200*                                                                 02760001
024300*                                                                 02770001
026402******************************************************************02930001
026403*  SET UP THE CONVEYOR CONTROL RECORD.  THIS RECORD WILL CONTAIN  02940001
026403*  THE CURRENT TIMESTAMP, A CALCULATED TIMESTAMP (CURRENT TMST    02941001
026403*  MINUS SPECIFIED NUMBER OF MINUTES) AND THE PARM VALUE USED     02942001
026403*  FOR THE NUMBER OF MINUTES.                                     02943001
026404******************************************************************02950001
026405 2000-SET-UP-CNVYR-CNTL-REC.                                      02960001
026406                                                                  02970001
026406     INITIALIZE SU096-DATE-CONTROL-REC.                           02971003
026406                                                                  02972003
026407     PERFORM 2100-FETCH-TKRPRPM-DATA.                             02980001
026408                                                                  02990001
000200     MOVE PV-CURRENT-TIMESTAMP TO SU096-CURR-TMST                 02991001
000400     MOVE PV-CALC-TIMESTAMP    TO SU096-BACK-TMST                 02992001
000600     MOVE PV-PARM-MINUTES      TO SU096-MIN-TO-CHECK              02993001
026408                                                                  02994001
026409     PERFORM 8000-WRITE-CNVYR-CNTL-REC.                           03000001
026421*                                                                 03120001
026422*2000-EXIT.                                                       03130001
026423*                                                                 03140001
026430*                                                                 03150001
035610******************************************************************04110001
035620*  FETCH THE CURRENT TIMESTAMP, A CALCULATED TIMESTAMP, AND       04120004
035620*  AN MINUTES PARAMETER FROM THE TKRPRPM TABLE.                   04121004
035630******************************************************************04130001
035700 2100-FETCH-TKRPRPM-DATA.                                         04140001
035800                                                                  04150001
035900     INITIALIZE DCLTKRPRPM.                                       04160001
036000                                                                  04170001
043010     PERFORM WITH TEST AFTER                                      04171001
043020       VARYING PV-COUNTER FROM 1 BY 1                             04172001
043030         UNTIL (PV-COUNTER > PC-MAX-RETRIES                       04173001
043040                OR                                                04174001
043050                SQLCODE = ZERO)                                   04175001
043060                                                                  04176001
036100         EXEC SQL                                                 04180001
036200             SELECT CURRENT TIMESTAMP         AS CURRENT_TIMESTAMP04190001
036200                   ,(CURRENT TIMESTAMP - FUNC_QTY MINUTES)        04191001
036200                                              AS CALC_TMST        04192001
036200                   ,FUNC_QTY                  AS PARM_MINUTES     04193001
036301               INTO :PV-CURRENT-TIMESTAMP                         04200001
036302                   ,:PV-CALC-TIMESTAMP                            04210001
036303                   ,:PV-PARM-MINUTES                              04220001
036301               FROM TKRPRPM                                       04230001
036301              WHERE LOC_ID            = 90                        04240001
036301                AND SYS_PRC_FUNC_CDE  = 'CNVYTM'                  04250001
036301                AND INTFC_SYS_CDE     = 'KHL'                     04260001
036301                AND FUNC_PRC_STAT_CDE  = 'AC'                     04270001
036301                AND FUNC_BEG_TMST     <= CURRENT TIMESTAMP        04280001
036301                AND FUNC_END_TMST     >= CURRENT TIMESTAMP        04290001
040900         END-EXEC                                                 04610001
041000                                                                  04620001
043092         EVALUATE TRUE                                            04621001
043093             WHEN SQLCODE = -904                                  04622001
043094             WHEN SQLCODE = -911                                  04623001
043095                 CONTINUE                                         04624001
043096             WHEN SQLWARN0 NOT = SPACES                           04625001
043097             WHEN SQLCODE < ZERO                                  04626001
043098             WHEN SQLCODE > ZERO                                  04627001
043099                 MOVE '2100-FETCH-TKRPRPM-DATA        '           04628001
043100                                 TO PV-PARAGRAPH-NAME             04629001
043101                 MOVE 'FETCH DATA FROM TKRPRPM TABLE  '           04629101
043102                                 TO PV-DB2-OPERATION-MESSAGE      04629201
043103                 MOVE 'TKRPRPM'  TO PV-DB2-TABLE-NAME             04629301
043104                 PERFORM 9100-SQL-ABEND                           04629401
043105             WHEN SQLCODE = ZERO                                  04629501
043106                 CONTINUE                                         04629601
043107         END-EVALUATE                                             04629701
043108     END-PERFORM.                                                 04629801
043109                                                                  04629901
043110     IF PV-COUNTER > PC-MAX-RETRIES                               04630001
043111         MOVE '2100-FETCH-TKRPRPM-DATA     '                      04630101
043112                                 TO PV-PARAGRAPH-NAME             04630201
043113         MOVE 'MAX RETRIES EXCEEDED ON FETCH OF DATA FROM TKRPRPM'04630301
043114                                 TO PV-DB2-OPERATION-MESSAGE      04630401
043115         MOVE 'TKRPRPM'          TO PV-DB2-TABLE-NAME             04630501
043116         PERFORM 9100-SQL-ABEND                                   04630601
043117     END-IF.                                                      04630701
042510*                                                                 04790001
042600*2100-EXIT.                                                       04800001
042700*                                                                 04810001
042800*                                                                 04820001
043253******************************************************************06600001
043260*  WRITE THE DISTRIBUTION HEADER RECORD                           06610001
043300******************************************************************06620001
043400 8000-WRITE-CNVYR-CNTL-REC.                                       06630001
043500     WRITE SU-CNVYR-CNTL-FILE-RECORD                              06640001
043600         FROM SU096-DATE-CONTROL-REC.                             06650001
043710*                                                                 06670001
043800*8000-EXIT.                                                       06680001
042700*                                                                 06690001
042800*                                                                 06700001
049800 9100-SQL-ABEND.                                                  06820001
049900******************************************************************06830001
050000*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    06840001
050100*  ERROR OR WARNING CODE OCCURS.                                  06850001
050200******************************************************************06860001
050300     DISPLAY '9100-SQL-ABEND'.                                    06870001
050400     DISPLAY '** ABEND           **'.                             06880001
050500     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  06890001
050701     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06900001
050702     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        06910001
050705     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MESSAGE  06920001
050710     DISPLAY '**                 ** = '                           06930001
050800                                                                  06940001
050900******************************************************************06950001
051000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06960001
051100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06970001
051200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06980001
051300* FORMAT.                                                         06990001
051400******************************************************************07000001
051500     COPY DPPD004.                                                07010001
051600                                                                  07020001
051700     MOVE +4013                  TO ABEND-CODE.                   07030001
051800     CALL 'ILBOABN0' USING ABEND-CODE.                            07040001
051900*9100-EXIT.                                                       07050001
