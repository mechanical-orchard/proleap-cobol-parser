000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUP063.                                        00020000
000300 AUTHOR.         JERRY ZELLMER.                                   00030000
000400*DATE-WRITTEN.   AUG 25, 1997.                                    00040000
000500*DATE-COMPILED.                                                   00050000
000600******************************************************************00060000
000700*  UPDATE INVOICE STATUS FOR INVOICES PAID IN LATEST CHECK RUN   *00070000
000800******************************************************************00080000
000900*    COBOL 2  WITH SQL                                           *00090000
001000*                                                                *00100000
001100*    THIS PROGRAM WILL UPDATE THE TINVOIC TABLE WITH THE         *00110000
001200*    CORRECT STATUS CODE, DATE, AND TIMESTAMP FOR EACH           *00120000
001300*    INVOICE RECORD READ FROM THE TRANSACTION FILE.              *00130000
001400******************************************************************00140000
001500*                                                                *00150000
001600*    TINVOIC - INVOICE TABLE                                     *00160000
001700*    TAPCNTL - A/P CONTROL TABLE                                 *00170000
001800*                                                                *00180000
001900* INPUT:                                                         *00190000
002000* 1.  INVOICE UPDATE TRANSACTION FILE                            *00200000
002100*                                                                *00210000
002200* UPDATE                                                         *00220000
002300* TINVOIC -  INVOICE TABLE.                                      *00230000
002400*                                                                *00240000
002500******************************************************************00250000
002600* CHANGE LOG:                                                    *00260000
002700*   JAN 1999  JILL JUEL                                          *00270000
002800*             CHANGED THE LOGIC IN THE C100-CALC-DOC-NBR         *00280000
002900*             BECAUSE THE DOC-NBR IN APRD066 WAS INCREASED       *00290000
003000*             FROM 10 CHARACTERS TO 16.                          *00300000
003100*                                                                *00310000
003200*   NOV 1999  MIKE BESKE                                         *00320000
003300*             ADDED DISPLAYS IN R200-SELECT-INVOICE THAT WILL    *00330000
003400*             SHOW THE PO AND INVOICE ID IF THIS PARAGRAPH       *00340000
003500*             ABENDS.                                            *00350000
003600*                                                                *00360000
003700*   NOV 1999  MIKE BESKE                      IR#: 330957        *00370000
003800*             CORRECTED THE CHECKPOINT RESTART CODE SO THAT THE  *00380000
003900*             PO NUMBER IS MOVED OUT TO THE TCKRSTINF TABLE.     *00390000
004000*                                                                *00400000
004100*                                                                *00410000
004200*   JUNE 2002 NANCY EILBES                    WR#: 23500         *00420000
004210*             CHANGES FOR AP TABLE KEY CHANGES.                  *00421000
004220*             REMOVED TABLE TPAYREQ.  RESTRUCTURED LOGIC SO      *00422000
004230*             A SELECT IS NOT PERFORMED BEFORE THE UPDATE.       *00423000
004231*             WITH THE CHANGES TO THE KEY ON TINVOIC, A DIRECT   *00423100
004232*             UPDATE CAN BE PERFORMED WITH THE PO AND INVOICE    *00423200
004233*             ID.  IF IT FAILS, THE CURSOR PROCESSING IS DONE.   *00423300
004234*             THE CURSOR WAS MODIFIED TO ONLY RETURN THE         *00423400
004235*             INVOICE ID. UNRELATED CHANGE:  ADDED AN OUTPUT     *00423500
004236*             FILE OF ANY INVOICES NOT FOUND.                    *00423600
004237*                                                                *00423700
004238*   6/22/2002 KEVIN CATLIN                  PITS#: 476431        *00423800
004239*             ADDED CLOSE OF NOT-FOUND-FILE AT END OF PROGRAM    *00423900
004240*             PROCESSING.                                        *00424000
004250*                                                                *00425000
004260*  11/04/2002 NANCY EILBES                  WR#: 23750           *00426000
004270*             COLBY DATING PROJECT MODIFICATIONS:  ADDED A NEW   *00427000
004280*             UPDATE PARAGRAPH TO UPDATE ONLY THE PAYMENT DATE   *00428000
004290*             FOR INVOICES WHERE THE STATUS IS 'PJ'.  ALSO       *00429000
004291*             CHANGED THE EXISTING UPDATE TO ONLY AFFECT ROWS    *00429100
004292*             WHERE THE STATUS IS 'OP'.  THE CURSOR WAS CHANGED  *00429200
004293*             TO RETURN THE INVOICE STATUS SO THAT THE CORRECT   *00429300
004294*             UPDATE PARAGRAPH COULD BE PERFORMED ONCE THE       *00429400
004295*             MATCHING INVOICE ROW WAS FOUND.                    *00429500
004296*                                                                *00429600
004297*  03/11/2007 GREG WISIALOWSKI              WR#: 21578           *00429700
004298*             MBDC PROJECT. RECOMPILE                            *00429800
004299*                                                                *00429900
004300*  09/21/2009 ROLF NOHE                     WR#: 32642           *00430000
004310*             UPDATE STATUS_CDE ON TINVOIC FOR RECYCLED          *00431000
004311*             INVOICES THAT HAVE PAID THROUGH PEOPLESOFT.        *00431100
004312*                                                                *00431200
004313*  09/21/2009 ROLF NOHE                     WR#: 32642           *00431300
004314*             UPDATE STATUS_CDE ON TINVOIC FOR RECYCLED          *00431400
004315*             INVOICES THAT HAVE PAID THROUGH PEOPLESOFT.        *00431500
004316*                                                                *00431600
004317*  DATE  04/01/2019                                              *00431700
004318*      CHANGE MADE: ADDED THE CHECK NUMBER AP066-CHECK-NBR FIELD *00431800
004319*      AND MOVE THE CHECK NUMBER TO INVOICE BAR CODE FIELD.      *00431900
004320*      UPDATE BAR_CDE ON TINVOIC TABLE.                          *00432000
004321*      MADE BY:  SURIYA (COGNIZANT)     WR/IR #: CHG0221352      *00432100
004322*                                                                *00432202
004323*  DATE  10/22/2021                                              *00432302
004324*      CHANGE MADE: ALLOW INVOICES IN RC STATUS TO PROCESS THE   *00432402
004325*      SAME AS PJ STATUS.  THERE ARE SOME SEPHORA AT KOHLS       *00432502
004326*      VENDORS WITH NET30 PAYMENT TERMS THAT GO TO RC STATUS     *00432602
004327*      MADE BY:  JEAN KURK              WR/IR #: CHG0262250      *00432702
004328*                                                                *00432800
004329*  DATE  04/08/2022                                              *00432905
004330*      CHANGE MADE: REMOVED ALL RECYCLE LOGIC LEFTOVER FROM PS.  *00433006
004331*      NO LONGER NEEDED AND PREVENTING INVOICES WITH X IN THE    *00433106
004332*      POSITION OF THE INVOICE ID FROM BEING UPDATED.            *00433206
004334*      MADE BY: NANCY EILBES            WR/IR #: CHG0268885      *00433405
004335*                                                                *00433505
004336******************************************************************00433605
004337                                                                  00433705
004338 ENVIRONMENT DIVISION.                                            00433805
004339                                                                  00433905
004340 INPUT-OUTPUT SECTION.                                            00434005
004341                                                                  00434105
004342 FILE-CONTROL.                                                    00434205
004343                                                                  00434305
004344     SELECT INVOICE-FILE       ASSIGN    TO UT-S-INP01.           00434405
004345     SELECT NOT-FOUND-FILE     ASSIGN    TO UT-S-OUT01.           00434505
004346                                                                  00434605
004347 DATA DIVISION.                                                   00434705
004348                                                                  00434805
004349 FILE SECTION.                                                    00434905
004350                                                                  00435005
004351 FD  INVOICE-FILE                                                 00435105
004352         LABEL RECORDS  ARE STANDARD                              00435205
004353         RECORDING MODE IS  F                                     00435305
004354         DATA RECORD    IS  INVOICE-RECORD.                       00435405
004360                                                                  00436000
004370 01  INVOICE-RECORD                PIC X(75).                     00437000
004380                                                                  00438000
004390 FD  NOT-FOUND-FILE                                               00439000
004400         LABEL RECORDS  ARE STANDARD                              00440000
004500         RECORDING MODE IS  F                                     00450000
004600         DATA RECORD    IS  INVOICE-RECORD.                       00460000
004700                                                                  00470000
004800 01  NOT-FOUND-RECORD              PIC X(75).                     00480000
004900                                                                  00490000
005000/                                                                 00500000
005100 WORKING-STORAGE SECTION.                                         00510000
005200                                                                  00520000
005300 01  FILLER                        PIC X(25) VALUE                00530000
005400                             'WS FOR APKUP063 BEGINS==>'.         00540000
005500 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00550000
005600                                             VALUE ZEROS.         00560000
005700     88 AP-EMPTY-FILE              VALUE +4005.                   00570000
005800     88 AP-DB2-ERROR               VALUE +4013.                   00580000
005900                                                                  00590000
006000 01  PROGRAM-CONSTANTS.                                           00600000
006100     05  PC-RETRY-MAX            PIC S9(04)  VALUE +3  COMP.      00610000
006200     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00620000
006300     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00630000
006400                                                                  00640000
006500 01  PV-ABEND-FIELDS.                                             00650000
006600     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP063'. 00660000
006700     05  PV-ABEND-SQLCODE             PIC X(4)  VALUE SPACES.     00670000
006800     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00680000
006900     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00690000
007000     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00700000
007100     05  PV-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     00710000
007200     05  PV-ABEND-STRUCTURE-3         PIC X(8)  VALUE SPACES.     00720000
007300     05  PV-ABEND-STRUCTURE-4         PIC X(8)  VALUE SPACES.     00730000
007400     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     00740000
007500                                                                  00750000
007600 01  PV-RECORD-CNTS-PER-COMMIT.                                   00760000
007700     05  PV-INPUT-CNT-C               PIC S9(07) COMP-3 VALUE +0. 00770000
007800                                                                  00780000
007900 01  PV-RECORD-CNTS.                                              00790000
008000     05  PV-INPUT-CNT                 PIC 9(09) VALUE 0.          00800000
008010     05  PV-OP-UPDATE-CNT             PIC 9(09) VALUE 0.          00801000
008020     05  PV-PJ-UPDATE-CNT             PIC 9(09) VALUE 0.          00802000
008030     05  PV-NOT-FOUND-CNT             PIC 9(09) VALUE 0.          00803000
008100                                                                  00810000
008200 01  PV-WORK-AREA.                                                00820000
008300     05  PV-PROGRAM-NAME         PIC X(08)     VALUE 'APKUP063'.  00830000
008400                                                                  00840000
008500     05  PV-SAVED-PO                 PIC S9(09) COMP VALUE +0.    00850000
008600     05  PV-PO-BEING-PROCESSED       PIC S9(09) COMP VALUE +0.    00860000
008900     05  PV-CKPT-STAT-CODE           PIC X(01)     VALUE SPACE.   00890000
009000     05  PV-RETRY-COUNT              PIC S9(04) COMP VALUE ZEROS. 00900000
009100     05  PV-START                    PIC S9(04) COMP VALUE ZEROS. 00910000
009200     05  PV-DOC-NBR                  PIC X(16)  VALUE SPACES.     00920000
009300     05  PV-PO-NBR                   PIC X(09).                   00930000
009400     05  PV-PO-NBR-9 REDEFINES PV-PO-NBR                          00940000
009500                                     PIC 9(09).                   00950000
009600     05  PV-DOC-NUMBER               PIC X(16).                   00960000
010100                                                                  01010000
010200 01  PV-SWITCHES.                                                 01020000
010300     05  END-OF-INVOICE-IN-SW    PIC X(01) VALUE 'N'.             01030000
010400         88  NOT-END-OF-INVOICE-INPUT      VALUE 'N'.             01040000
010500         88  END-OF-INVOICE-INPUT          VALUE 'Y'.             01050000
010600     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        01060000
010700         88  NORMAL-RUN                         VALUE '0'.        01070000
010800         88  RESTART-RUN                        VALUE '9'.        01080000
010900     05  TINVOIC-FND-SW           PIC  X(01)    VALUE ' '.        01090000
011000         88  TINVOIC-FND                        VALUE 'Y'.        01100000
011100         88  TINVOIC-NOT-FND                    VALUE 'N'.        01110000
011200     05  END-OF-INVOICE-SW        PIC  X(01)    VALUE 'N'.        01120000
011300         88  END-OF-INVOICE                     VALUE 'Y'.        01130000
011400         88  NOT-END-OF-INVOICE                 VALUE 'N'.        01140000
011500     05  END-OF-RECYCLE-INVC-SW   PIC  X(01)    VALUE 'N'.        01150000
011600         88  END-OF-RECYCLE-INVC                VALUE 'Y'.        01160000
011700         88  NOT-END-OF-RECYCLE-INVC            VALUE 'N'.        01170000
011800                                                                  01180000
011900 01  CKPT-RESTART-INFO.                                           01190000
012000     05  CR-PO-NBR                PIC 9(09)     VALUE ZEROS.      01200000
012100     05  CR-INVOICE-IN-REC-CNT    PIC S9(09)        VALUE +0.     01210000
012110     05  CR-OP-UPDATE-REC-CNT     PIC S9(09)        VALUE +0.     01211000
012120     05  CR-PJ-UPDATE-REC-CNT     PIC S9(09)        VALUE +0.     01212000
012130     05  CR-NOT-FOUND-REC-CNT     PIC S9(09)        VALUE +0.     01213000
012200                                                                  01220000
012300 01  CKPT-RESTART-TMST.                                           01230000
012310     05  CR-CURR-TMST             PIC X(26)     VALUE SPACES.     01231000
012320     05  CR-NEXT-TMST             PIC X(26)     VALUE SPACES.     01232000
012330                                                                  01233000
012340 01  FILLER                      PIC X(35)  VALUE                 01234000
012350     'BEGINNING OF APRD066  INPUT FILE **'.                       01235000
012360     COPY APRD066.                                                01236000
012370                                                                  01237000
012380     COPY DPWS004.                                                01238000
012390                                                                  01239000
012400 01  FILLER                      PIC X(35)  VALUE                 01240000
012500     'END OF AP WORK RECORD AREA       **'.                       01250000
012600                                                                  01260000
012700******************************************************************01270000
012800*  COMMUNICATIONS AREA2 FOR DB2                                   01280000
012900******************************************************************01290000
013000     COPY SQLCA2.                                                 01300000
013100                                                                  01310000
013200     EXEC SQL                                                     01320000
013300          INCLUDE SQLCA                                           01330000
013400     END-EXEC.                                                    01340000
013500                                                                  01350000
013600     EXEC SQL                                                     01360000
013700          INCLUDE TINVOIC                                         01370000
013800     END-EXEC.                                                    01380000
013900                                                                  01390000
014000     EXEC SQL                                                     01400000
014100          INCLUDE TAPCNTL                                         01410000
014200     END-EXEC.                                                    01420000
014300                                                                  01430000
014400*                                                                 01440000
014500*      TCKRSTCNTL TABLE LAYOUT                                    01450000
014600*                                                                 01460000
014700         EXEC SQL                                                 01470000
014800             INCLUDE TCKRSTCN                                     01480000
014900         END-EXEC.                                                01490000
015000*                                                                 01500000
015100*      TCKRSTINF TABLE LAYOUT                                     01510000
015200*                                                                 01520000
015300         EXEC SQL                                                 01530000
015400             INCLUDE TCKRSTIN                                     01540000
015500         END-EXEC.                                                01550000
015600*----------------------------------------------------------------*01560000
015700* INVOICE_CSR  GETS ALL OPEN TO PAY INVOICES FOR THE PO BEING    *01570000
015800* PROCESSED.                                                     *01580000
015900*----------------------------------------------------------------*01590000
016000     EXEC SQL                                                     01600000
016100       DECLARE INVOICE_CSR  CURSOR FOR                            01610000
016200         SELECT INVC_ID                                           01620000
016300              , STATUS_CDE                                        01630000
016400           FROM TINVOIC                                           01640000
016500          WHERE PO_NBR           = :INVOIC-PO-NBR                 01650000
016600            AND STATUS_CDE      IN ('OP','PJ')                    01660000
016700     END-EXEC.                                                    01670000
016800                                                                  01680000
016900*----------------------------------------------------------------*01690000
017000 01  FILLER                        PIC X(25) VALUE                01700000
017100          '<====PV FOR APKUP063 ENDS'.                            01710000
017200                                                                  01720000
017300                                                                  01730000
017400 PROCEDURE DIVISION.                                              01740000
017500                                                                  01750000
017600 A100-MAINLINE.                                                   01760000
017700                                                                  01770000
017800     PERFORM B100-INITIALIZE.                                     01780000
017900                                                                  01790000
018000     PERFORM B200-PROCESSING                                      01800000
018100        UNTIL END-OF-INVOICE-INPUT.                               01810000
018200                                                                  01820000
018300     PERFORM B300-END-OF-JOB.                                     01830000
018400                                                                  01840000
018500     GOBACK.                                                      01850000
018600        EJECT                                                     01860000
018700                                                                  01870000
018800 B100-INITIALIZE.                                                 01880000
018900*                                                                 01890000
019000***************************************************************** 01900000
019100*    OPEN FILES                                                   01910000
019200***************************************************************** 01920000
019300*                                                                 01930000
019400     MOVE 'B100-INITIALIZE' TO PV-ABEND-PARAGRAPH.                01940000
019500                                                                  01950000
019600     OPEN  INPUT INVOICE-FILE                                     01960000
019700          OUTPUT NOT-FOUND-FILE.                                  01970000
019800                                                                  01980000
019900     SET NOT-END-OF-INVOICE-INPUT TO TRUE.                        01990000
020000                                                                  02000000
020100     INITIALIZE DCLTINVOIC.                                       02010000
020200     INITIALIZE DCLTAPCNTL.                                       02020000
020300                                                                  02030000
020400     PERFORM R300-SELECT-PRC-DTE.                                 02040000
020500                                                                  02050000
020600     PERFORM R700-GET-CHECKPOINT-CNTL.                            02060000
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070000
020800                                                                  02080000
020900     IF RESTART-RUN                                               02090000
021000        PERFORM Y400-CHECKPOINT-RESTART                           02100000
021100     ELSE                                                         02110000
021200        PERFORM R100-READ-INVOICE-TRAN.                           02120000
021300                                                                  02130000
021400 EJECT                                                            02140000
021500*----------------------------------------------------------------*02150000
021600*    THIS PARAGRAPH WILL PROCESS THROUGH ALL THE RECORDS ON      *02160000
021601*    THE TRANS FILE AND UPDATE THE TINVOIC TABLE WITH THE CORRECT*02160100
021602*    STATUS CODE, PROCESS DATE, AND TIMESTAMP.                   *02160200
021603*----------------------------------------------------------------*02160300
021604 B200-PROCESSING.                                                 02160400
021605                                                                  02160500
021606     MOVE 'B200-PROCESSING  ' TO PV-ABEND-PARAGRAPH.              02160600
021607                                                                  02160700
021608     SET NOT-END-OF-RECYCLE-INVC TO TRUE.                         02160800
021609*    MOVE AP066-DOC-NBR          TO PV-DOC-NUMBER.                02160904
021620*    MOVE PV-DOC-NUMBER-TABLE    TO AP066-DOC-NBR.                02162004
021630                                                                  02163000
021640     SET TINVOIC-NOT-FND      TO TRUE.                            02164000
021650     MOVE AP066-PO-NBR        TO INVOIC-PO-NBR.                   02165000
021660     MOVE AP066-DOC-NBR       TO INVOIC-INVC-ID.                  02166000
021670     MOVE 'PD'                TO INVOIC-STATUS-CDE.               02167000
021680     MOVE APCNTL-BTCH-PRC-DTE TO INVOIC-PAYT-DTE.                 02168000
021690     MOVE AP066-CHECK-NBR     TO INVOIC-BAR-CDE.                  02169000
021700     PERFORM U100-UPDATE-INVOICE.                                 02170000
021800                                                                  02180000
021900     IF TINVOIC-FND                                               02190000
022000         PERFORM Y300-CHECKPOINT-COMMIT                           02200000
022100     ELSE                                                         02210000
022200         PERFORM U150-UPDATE-PJ-INVOICE                           02220000
022300         IF TINVOIC-FND                                           02230000
022400            PERFORM Y300-CHECKPOINT-COMMIT                        02240000
022500         ELSE                                                     02250000
022600            SET NOT-END-OF-INVOICE   TO TRUE                      02260000
022700            PERFORM Y100-OPEN-INVOICE-CSR                         02270000
022800            PERFORM R400-FETCH-INVOICE-CSR                        02280000
022900            PERFORM C100-CALC-DOC-NBR                             02290000
023000              UNTIL AP066-DOC-NBR = PV-DOC-NBR                    02300000
023100                 OR END-OF-INVOICE                                02310000
023200            PERFORM Y200-CLOSE-INVOICE-CSR                        02320000
023300            IF TINVOIC-FND                                        02330000
023400                IF INVOIC-STATUS-CDE = 'PJ'                       02340000
023500                    MOVE APCNTL-BTCH-PRC-DTE TO INVOIC-PAYT-DTE   02350000
023600                    MOVE AP066-CHECK-NBR     TO INVOIC-BAR-CDE    02360000
023700                    PERFORM U150-UPDATE-PJ-INVOICE                02370000
023800                ELSE                                              02380000
023900                    MOVE 'PD' TO INVOIC-STATUS-CDE                02390000
024000                    MOVE APCNTL-BTCH-PRC-DTE TO INVOIC-PAYT-DTE   02400000
024100                    MOVE AP066-CHECK-NBR     TO INVOIC-BAR-CDE    02410000
024200                    PERFORM U100-UPDATE-INVOICE                   02420000
024201                END-IF                                            02420100
024202                PERFORM Y300-CHECKPOINT-COMMIT                    02420200
024203            ELSE                                                  02420300
024204                DISPLAY 'INVOICE NOT FOUND FOR: ' AP066-PO-NBR '-'02420400
024205                        AP066-DOC-NBR                             02420500
024206                ADD +1 TO PV-NOT-FOUND-CNT                        02420600
024207                PERFORM W100-WRITE-NOT-FOUND-RECD                 02420700
024208            END-IF                                                02420800
024209         END-IF                                                   02420900
024210     END-IF.                                                      02421000
024211                                                                  02421100
024212                                                                  02421200
024213     PERFORM R100-READ-INVOICE-TRAN.                              02421300
024214                                                                  02421400
024215     EJECT                                                        02421500
024216***************************************************************** 02421600
024217*     CLOSE ALL FILES, REPORT ON NECESSARY TOTALS                 02421700
024218***************************************************************** 02421800
024219*                                                                 02421900
024220 B300-END-OF-JOB.                                                 02422000
024221     MOVE 'B300-END-OF-JOB  ' TO PV-ABEND-PARAGRAPH.              02422100
024230                                                                  02423000
024231     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02423100
024232     PERFORM U200-UPDATE-TCKRSTCNTL.                              02423200
024233     PERFORM V100-COMPUTE-CNTS.                                   02423300
024234                                                                  02423400
024235     PERFORM U400-COMMIT.                                         02423500
024236                                                                  02423600
024237     DISPLAY '************************************************'.  02423700
024238     DISPLAY 'TOTAL RECORDS READ        = ' PV-INPUT-CNT.         02423800
024239     DISPLAY 'TOTAL OP INVOICES UPDATED = ' PV-OP-UPDATE-CNT.     02423900
024240     DISPLAY 'TOTAL PJ INVOICES UPDATED = ' PV-PJ-UPDATE-CNT.     02424000
024241     DISPLAY 'TOTAL NOT FOUND INVOICES  = ' PV-NOT-FOUND-CNT.     02424100
024242     DISPLAY '************************************************'.  02424200
024250                                                                  02425000
024260     CLOSE INVOICE-FILE                                           02426000
024270           NOT-FOUND-FILE.                                        02427000
024280                                                                  02428000
024290     IF   END-OF-INVOICE-INPUT                                    02429000
024300          DISPLAY ' PROGRAM APKUP063 ENDS NORMALLY '              02430000
024600     END-IF.                                                      02460000
024700                                                                  02470000
024800                                                                  02480000
024900*----------------------------------------------------------------*02490000
025000*    THIS PARAGRAPH WILL CALCULATE THE DOC NBR TO COMPARE AGAINST*02500000
025100*----------------------------------------------------------------*02510000
025200 C100-CALC-DOC-NBR.                                               02520000
025300     MOVE 'C100-CALC-DOC-NBR'    TO PV-ABEND-PARAGRAPH.           02530000
025400                                                                  02540000
025500     MOVE LENGTH OF INVOIC-INVC-ID   TO PV-START.                 02550000
025600                                                                  02560000
025700     PERFORM UNTIL INVOIC-INVC-ID (PV-START:1) > SPACES           02570000
025701                OR PV-START = +0                                  02570100
025702         COMPUTE PV-START = PV-START - 1                          02570200
025703     END-PERFORM.                                                 02570300
025704                                                                  02570400
025705     IF PV-START < 17                                             02570500
025706         MOVE +1 TO PV-START                                      02570600
025707     ELSE                                                         02570700
025708         SUBTRACT +15 FROM PV-START.                              02570800
025709                                                                  02570900
025710     MOVE INVOIC-INVC-ID (PV-START:16)  TO PV-DOC-NBR.            02571000
025720                                                                  02572000
025730     IF AP066-DOC-NBR = PV-DOC-NBR                                02573000
025740        SET TINVOIC-FND TO TRUE                                   02574000
025750     ELSE                                                         02575000
025760        PERFORM R400-FETCH-INVOICE-CSR.                           02576000
025770                                                                  02577000
028300***************************************************************** 02830000
028400*     READ THE SELECTED INVOICE FILE                              02840000
028500***************************************************************** 02850000
028600 R100-READ-INVOICE-TRAN.                                          02860000
028700                                                                  02870000
028800     MOVE 'R100-READ-INVOICE-TRAN  ' TO PV-ABEND-PARAGRAPH.       02880000
028900                                                                  02890000
029000     READ INVOICE-FILE INTO AP066-RECORD                          02900000
029100        AT END  SET END-OF-INVOICE-INPUT TO TRUE.                 02910000
029200                                                                  02920000
029300     IF NOT-END-OF-INVOICE-INPUT                                  02930000
029400        ADD 1 TO PV-INPUT-CNT-C.                                  02940000
029500                                                                  02950000
029600*----------------------------------------------------------------*02960000
029700*    RETRIEVES THE PROCESS DATE FROM THE TAPCNTL TABLE.          *02970000
029800*----------------------------------------------------------------*02980000
029900 R300-SELECT-PRC-DTE.                                             02990000
030000                                                                  03000000
030100     MOVE 'R300-SELECT-PRC-DTE' TO PV-ABEND-PARAGRAPH.            03010000
030200                                                                  03020000
030300     EXEC SQL                                                     03030000
030400         SELECT                                                   03040000
030500             BTCH_PRC_DTE                                         03050000
030600         INTO                                                     03060000
030700             :APCNTL-BTCH-PRC-DTE                                 03070000
030800         FROM TAPCNTL                                             03080000
030900     END-EXEC.                                                    03090000
031000                                                                  03100000
031100     EVALUATE TRUE                                                03110000
031200         WHEN SQLCODE = ZERO                                      03120000
031300              CONTINUE                                            03130000
031400                                                                  03140000
031500         WHEN SQLWARN0 = SPACES                                   03150000
031600         WHEN SQLCODE NOT = ZERO                                  03160000
031700           MOVE 'H100- '              TO PV-ABEND-PARAGRAPH       03170000
031800           MOVE 'UNSUCCESSFUL SELECT' TO PV-ABEND-OPERATION       03180000
031900           MOVE 'TAPCNTL'             TO PV-ABEND-STRUCTURE-1     03190000
032000           MOVE SPACES                TO PV-ABEND-STRUCTURE-2     03200000
032100           PERFORM Z999-DB2-ABEND                                 03210000
032200     END-EVALUATE.                                                03220000
032300                                                                  03230000
032400*----------------------------------------------------------------*03240000
032500*    FETCH NEXT RECORD FROM OPEN TO PAY CURSOR.                  *03250000
032600*----------------------------------------------------------------*03260000
032700 R400-FETCH-INVOICE-CSR.                                          03270000
032800                                                                  03280000
032900     MOVE 'R400-FETCH-INVOICE-CSR' TO PV-ABEND-PARAGRAPH.         03290000
033000                                                                  03300000
033100     EXEC SQL                                                     03310000
033200         FETCH INVOICE_CSR                                        03320000
033300          INTO :INVOIC-INVC-ID                                    03330000
033400             , :INVOIC-STATUS-CDE                                 03340000
033500     END-EXEC.                                                    03350000
033600                                                                  03360000
033700     EVALUATE TRUE                                                03370000
033800         WHEN SQLCODE = ZERO                                      03380000
033900              CONTINUE                                            03390000
034000                                                                  03400000
034100         WHEN SQLCODE = +100                                      03410000
034200              SET END-OF-INVOICE  TO TRUE                         03420000
034300                                                                  03430000
034400         WHEN SQLWARN0 NOT = SPACES                               03440000
034500         WHEN SQLCODE  NOT = ZERO                                 03450000
034600             MOVE 'UNSUCCESSFUL FETCH WITH INVOICE'               03460000
034700                                 TO PV-ABEND-OPERATION            03470000
034800             MOVE 'INVOICE'      TO PV-ABEND-STRUCTURE-1          03480000
034900             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          03490000
035000                                    PV-ABEND-STRUCTURE-3          03500000
035100                                    PV-ABEND-STRUCTURE-4          03510000
035200             PERFORM Z999-DB2-ABEND                               03520000
035300     END-EVALUATE.                                                03530000
035400                                                                  03540000
035500*----------------------------------------------------------------*03550000
035600*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03560000
035700*----------------------------------------------------------------*03570000
035800 R700-GET-CHECKPOINT-CNTL.                                        03580000
035900                                                                  03590000
036000     MOVE 'R700-GET-CHECKPOINT-CNTL' TO PV-ABEND-PARAGRAPH.       03600000
036100                                                                  03610000
036200     PERFORM WITH TEST AFTER                                      03620000
036300             VARYING PV-RETRY-COUNT FROM 1 BY 1                   03630000
036400             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             03640000
036500                     SQLCODE = ZERO                               03650000
036600                                                                  03660000
036700             EXEC SQL                                             03670000
036800              SELECT CKPT_STAT_CODE                               03680000
036900               INTO :PV-CKPT-STAT-CODE                            03690000
037000               FROM TCKRSTCNTL                                    03700000
037100               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 03710000
037200             END-EXEC                                             03720000
037300                                                                  03730000
037400             EVALUATE TRUE                                        03740000
037500                 WHEN SQLCODE = ZERO                              03750000
037600                 WHEN SQLCODE = -904                              03760000
037700                 WHEN SQLCODE = -913                              03770000
037800                      CONTINUE                                    03780000
037900                                                                  03790000
038000                 WHEN SQLWARN0 NOT = SPACES                       03800000
038100                 WHEN SQLCODE  NOT = ZERO                         03810000
038200                     MOVE 'UNSUCCESSFUL SELECT            '       03820000
038300                                         TO PV-ABEND-OPERATION    03830000
038400                     MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1  03840000
038500                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  03850000
038600                                            PV-ABEND-STRUCTURE-3  03860000
038700                                            PV-ABEND-STRUCTURE-4  03870000
038800                     PERFORM Z999-DB2-ABEND                       03880000
038900             END-EVALUATE                                         03890000
039000     END-PERFORM.                                                 03900000
039100                                                                  03910000
039200     IF PV-RETRY-COUNT > PC-RETRY-MAX                             03920000
039300        MOVE 'MAX RETRIES EXCEEDED ON SELECT '                    03930000
039400                            TO PV-ABEND-OPERATION                 03940000
039500        MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1               03950000
039600        MOVE SPACES         TO PV-ABEND-STRUCTURE-2               03960000
039700                               PV-ABEND-STRUCTURE-3               03970000
039800                               PV-ABEND-STRUCTURE-4               03980000
039900        PERFORM Z999-DB2-ABEND                                    03990000
040000     END-IF.                                                      04000000
040100                                                                  04010000
040200*----------------------------------------------------------------*04020000
040300*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04030000
040400*----------------------------------------------------------------*04040000
040500 R800-GET-CHECKPOINT-INFO.                                        04050000
040600                                                                  04060000
040700     MOVE 'R800-GET-CHECKPOINT-INFO' TO PV-ABEND-PARAGRAPH.       04070000
040800                                                                  04080000
040900     PERFORM WITH TEST AFTER                                      04090000
041000             VARYING PV-RETRY-COUNT FROM 1 BY 1                   04100000
041100             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             04110000
041200                     SQLCODE = ZERO                               04120000
041300                                                                  04130000
041400             EXEC SQL                                             04140000
041500              SELECT WORK_STRG_DESC                               04150000
041600               INTO :TCKRSTINF-WORK-STRG-DESC                     04160000
041700               FROM TCKRSTINF                                     04170000
041800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04180000
041900             END-EXEC                                             04190000
042000                                                                  04200000
042100             EVALUATE TRUE                                        04210000
042200                 WHEN SQLCODE = ZERO                              04220000
042300                 WHEN SQLCODE = -904                              04230000
042400                 WHEN SQLCODE = -913                              04240000
042500                      CONTINUE                                    04250000
042600                                                                  04260000
042700                 WHEN SQLWARN0 NOT = SPACES                       04270000
042800                 WHEN SQLCODE  NOT = ZERO                         04280000
042900                     MOVE 'UNSUCCESSFUL SELECT'                   04290000
043000                                         TO PV-ABEND-OPERATION    04300000
043100                     MOVE 'TCKRSTINF'    TO PV-ABEND-STRUCTURE-1  04310000
043200                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  04320000
043300                                            PV-ABEND-STRUCTURE-3  04330000
043400                                            PV-ABEND-STRUCTURE-4  04340000
043500                     PERFORM Z999-DB2-ABEND                       04350000
043600             END-EVALUATE                                         04360000
043700     END-PERFORM.                                                 04370000
043800                                                                  04380000
043900     IF PV-RETRY-COUNT > PC-RETRY-MAX                             04390000
044000        MOVE 'MAX RETRIES EXCEEDED ON SELECT '                    04400000
044100                            TO PV-ABEND-OPERATION                 04410000
044200        MOVE 'TCKRSTINF '   TO PV-ABEND-STRUCTURE-1               04420000
044300        MOVE SPACES         TO PV-ABEND-STRUCTURE-2               04430000
044400                               PV-ABEND-STRUCTURE-3               04440000
044500                               PV-ABEND-STRUCTURE-4               04450000
044600         PERFORM Z999-DB2-ABEND                                   04460000
044700     END-IF.                                                      04470000
044800                                                                  04480000
044900 EJECT                                                            04490000
045000*----------------------------------------------------------------*04500000
045100*    UPDATES THE INVOICE TABLE.  THE STATUS CODE IS SET 'PD',    *04510000
045200*    THE PAYMENT DATE IS SET TO THE BATCH PROCESS DATE AND THE   *04520000
045300*    STATUS UPDATE TIMESTAMP IS SET TO CURRENT TIMESTAMP.        *04530000
045400*----------------------------------------------------------------*04540000
045500 U100-UPDATE-INVOICE.                                             04550000
045600                                                                  04560000
045700     MOVE 'U100-UPDATE-INVOICE' TO PV-ABEND-PARAGRAPH.            04570000
045800                                                                  04580000
045900        EXEC SQL                                                  04590000
046000           UPDATE TINVOIC                                         04600000
046100              SET STATUS_CDE      = :INVOIC-STATUS-CDE            04610000
046200                , PAYT_DTE        = :INVOIC-PAYT-DTE              04620000
046300                , STATUS_CHG_TMST =  CURRENT TIMESTAMP            04630000
046400                , BAR_CDE         = :INVOIC-BAR-CDE               04640000
046500            WHERE PO_NBR  = :INVOIC-PO-NBR                        04650000
046600              AND INVC_ID = :INVOIC-INVC-ID                       04660000
046700              AND STATUS_CDE = 'OP'                               04670000
046800        END-EXEC.                                                 04680000
046900                                                                  04690000
047000        EVALUATE TRUE                                             04700000
047100           WHEN SQLCODE = ZERO                                    04710000
047200            SET TINVOIC-FND TO TRUE                               04720000
047300            ADD +1 TO PV-OP-UPDATE-CNT                            04730001
047400           WHEN SQLCODE = +100                                    04740000
047500            SET TINVOIC-NOT-FND TO TRUE                           04750000
047600                                                                  04760000
047700           WHEN OTHER                                             04770000
047800              MOVE 'UNSUCCESSFUL UPDATE            '              04780000
047900                                TO PV-ABEND-OPERATION             04790000
048000              MOVE 'TINVOIC   '   TO PV-ABEND-STRUCTURE-1         04800000
048100              MOVE SPACES         TO PV-ABEND-STRUCTURE-2         04810000
048200                                     PV-ABEND-STRUCTURE-3         04820000
048300                                     PV-ABEND-STRUCTURE-4         04830000
048400                     PERFORM Z999-DB2-ABEND                       04840000
048500        END-EVALUATE.                                             04850000
048600                                                                  04860000
048700     EJECT                                                        04870000
048800*----------------------------------------------------------------*04880000
048900*    UPDATES THE INVOICE TABLE FOR INVOICES WITH STATUS 'PJ'.    *04890000
049000*    FOR THESE INVOICES, ONLY THE PAYMENT DATE IS UPDATED.       *04900000
049010*    STATUS 'RC' INCLUDED FOR SEPHORA AT KOHLS                   *04901002
049100*----------------------------------------------------------------*04910000
049200 U150-UPDATE-PJ-INVOICE.                                          04920000
049300                                                                  04930000
049400     MOVE 'U150-UPDATE-PJ-INVOICE' TO PV-ABEND-PARAGRAPH.         04940000
049500                                                                  04950000
049600        EXEC SQL                                                  04960000
049700           UPDATE TINVOIC                                         04970000
049800              SET PAYT_DTE  = :INVOIC-PAYT-DTE                    04980000
049900                , BAR_CDE   = :INVOIC-BAR-CDE                     04990000
050000            WHERE PO_NBR  = :INVOIC-PO-NBR                        05000000
050100              AND INVC_ID = :INVOIC-INVC-ID                       05010000
050200              AND STATUS_CDE IN ('PJ', 'RC')                      05020002
050210*             AND STATUS_CDE = 'PJ'                               05021002
050300        END-EXEC.                                                 05030000
050400                                                                  05040000
050500        EVALUATE TRUE                                             05050000
050600           WHEN SQLCODE = ZERO                                    05060000
050700            SET TINVOIC-FND TO TRUE                               05070000
050800            ADD +1 TO PV-PJ-UPDATE-CNT                            05080000
050900           WHEN SQLCODE = +100                                    05090000
051000            SET TINVOIC-NOT-FND TO TRUE                           05100000
051100                                                                  05110000
051200           WHEN OTHER                                             05120000
051300              MOVE 'UNSUCCESSFUL UPDATE            '              05130000
051400                                TO PV-ABEND-OPERATION             05140000
051500              MOVE 'TINVOIC   '   TO PV-ABEND-STRUCTURE-1         05150000
051600              MOVE SPACES         TO PV-ABEND-STRUCTURE-2         05160000
051700                                     PV-ABEND-STRUCTURE-3         05170000
051800                                     PV-ABEND-STRUCTURE-4         05180000
051900                     PERFORM Z999-DB2-ABEND                       05190000
052000        END-EVALUATE.                                             05200000
052100                                                                  05210000
052200     EJECT                                                        05220000
052300*----------------------------------------------------------------*05230000
052400*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05240000
052500*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05250000
052600*----------------------------------------------------------------*05260000
052700 U200-UPDATE-TCKRSTCNTL.                                          05270000
052800                                                                  05280000
052900     MOVE 'U200-UPDATE-TCKRSTCNTL' TO PV-ABEND-PARAGRAPH.         05290000
053000                                                                  05300000
053100     PERFORM WITH TEST AFTER                                      05310000
053200             VARYING PV-RETRY-COUNT FROM 1 BY 1                   05320000
053300             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             05330000
053400                     SQLCODE = ZERO                               05340000
053500                                                                  05350000
053600             EXEC SQL                                             05360000
053700                 UPDATE TCKRSTCNTL                                05370000
053800                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05380000
053900                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05390000
054000             END-EXEC                                             05400000
054100                                                                  05410000
054200             EVALUATE TRUE                                        05420000
054300                 WHEN SQLCODE = ZERO                              05430000
054400                 WHEN SQLCODE = -904                              05440000
054500                 WHEN SQLCODE = -913                              05450000
054600                      CONTINUE                                    05460000
054700                                                                  05470000
054800                 WHEN SQLWARN0 NOT = SPACES                       05480000
054900                 WHEN SQLCODE  NOT = ZERO                         05490000
055000                     MOVE 'UNSUCCESSFUL UPDATE            '       05500000
055100                                         TO PV-ABEND-OPERATION    05510000
055200                     MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1  05520000
055300                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  05530000
055400                                            PV-ABEND-STRUCTURE-3  05540000
055500                                            PV-ABEND-STRUCTURE-4  05550000
055600                     PERFORM Z999-DB2-ABEND                       05560000
055700             END-EVALUATE                                         05570000
055800     END-PERFORM.                                                 05580000
055900                                                                  05590000
056000     IF PV-RETRY-COUNT > PC-RETRY-MAX                             05600000
056100        MOVE 'MAX RETRIES EXCEEDED ON UPDATE '                    05610000
056200                            TO PV-ABEND-OPERATION                 05620000
056300        MOVE 'TCKRSTCNTL'   TO PV-ABEND-STRUCTURE-1               05630000
056400        MOVE SPACES         TO PV-ABEND-STRUCTURE-2               05640000
056500                               PV-ABEND-STRUCTURE-3               05650000
056600                               PV-ABEND-STRUCTURE-4               05660000
056700         PERFORM Z999-DB2-ABEND                                   05670000
056800     END-IF.                                                      05680000
056900                                                                  05690000
057000*----------------------------------------------------------------*05700000
057100*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *05710000
057200*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE LAST COMMITED *05720000
057300*    PO STORE NUMBER COMBINATION.                                *05730000
057400*----------------------------------------------------------------*05740000
057500 U300-UPDATE-TCKRSTINF.                                           05750000
057600                                                                  05760000
057700     MOVE 'U300-UPDATE-TCKRSTINF' TO PV-ABEND-PARAGRAPH.          05770000
057800                                                                  05780000
057900     MOVE AP066-PO-NBR            TO CR-PO-NBR.                   05790000
058000                                                                  05800000
058100     PERFORM V100-COMPUTE-CNTS.                                   05810000
058200                                                                  05820000
058300     MOVE PV-INPUT-CNT            TO CR-INVOICE-IN-REC-CNT.       05830000
058310     MOVE PV-OP-UPDATE-CNT        TO CR-OP-UPDATE-REC-CNT.        05831000
058320     MOVE PV-PJ-UPDATE-CNT        TO CR-PJ-UPDATE-REC-CNT.        05832000
058330     MOVE PV-NOT-FOUND-CNT        TO CR-NOT-FOUND-REC-CNT.        05833000
058400                                                                  05840000
058500     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   05850000
058600     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    05860000
058700                                                                  05870000
058800     PERFORM WITH TEST AFTER                                      05880000
058900             VARYING PV-RETRY-COUNT FROM 1 BY 1                   05890000
059000             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             05900000
059100                     SQLCODE = ZERO                               05910000
059200                                                                  05920000
059300             EXEC SQL                                             05930000
059400                 UPDATE TCKRSTINF                                 05940000
059500                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 05950000
059600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05960000
059700             END-EXEC                                             05970000
059800                                                                  05980000
059900             EVALUATE TRUE                                        05990000
060000                 WHEN SQLCODE = ZERO                              06000000
060100                 WHEN SQLCODE = -904                              06010000
060200                 WHEN SQLCODE = -913                              06020000
060300                      CONTINUE                                    06030000
060400                                                                  06040000
060500                 WHEN SQLWARN0 NOT = SPACES                       06050000
060600                 WHEN SQLCODE  NOT = ZERO                         06060000
060700                     MOVE 'UNSUCCESSFUL UPDATE            '       06070000
060800                                         TO PV-ABEND-OPERATION    06080000
060900                     MOVE 'TCKRSTINF '   TO PV-ABEND-STRUCTURE-1  06090000
061000                     MOVE SPACES         TO PV-ABEND-STRUCTURE-2  06100000
061100                                            PV-ABEND-STRUCTURE-3  06110000
061200                                            PV-ABEND-STRUCTURE-4  06120000
061300                     PERFORM Z999-DB2-ABEND                       06130000
061400             END-EVALUATE                                         06140000
061500     END-PERFORM.                                                 06150000
061600                                                                  06160000
061700     IF PV-RETRY-COUNT > PC-RETRY-MAX                             06170000
061800        MOVE 'MAX RETRIES EXCEEDED ON UPDATE '                    06180000
061900                            TO PV-ABEND-OPERATION                 06190000
062000        MOVE 'TCKRSTINF '   TO PV-ABEND-STRUCTURE-1               06200000
062100        MOVE SPACES         TO PV-ABEND-STRUCTURE-2               06210000
062200                               PV-ABEND-STRUCTURE-3               06220000
062300                               PV-ABEND-STRUCTURE-4               06230000
062400         PERFORM Z999-DB2-ABEND                                   06240000
062500     END-IF.                                                      06250000
062600                                                                  06260000
062700     MOVE ZEROS               TO PV-INPUT-CNT-C.                  06270000
062800                                                                  06280000
062900*----------------------------------------------------------------*06290000
063000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06300000
063100*----------------------------------------------------------------*06310000
063200 U400-COMMIT.                                                     06320000
063300                                                                  06330000
063400     MOVE 'U400-COMMIT'    TO PV-ABEND-PARAGRAPH.                 06340000
063500                                                                  06350000
063600     EXEC SQL                                                     06360000
063700         COMMIT                                                   06370000
063800     END-EXEC.                                                    06380000
063900                                                                  06390000
064000     EVALUATE TRUE                                                06400000
064100         WHEN SQLCODE = ZEROS                                     06410000
064200             CONTINUE                                             06420000
064300         WHEN OTHER                                               06430000
064400             MOVE 'UNSUCCESSFUL COMMIT'                           06440000
064500                                 TO PV-ABEND-OPERATION            06450000
064600             MOVE SPACES         TO PV-ABEND-STRUCTURE-1          06460000
064700             PERFORM Z999-DB2-ABEND                               06470000
064800     END-EVALUATE.                                                06480000
064900                                                                  06490000
065000*----------------------------------------------------------------*06500000
065100*    CALCUATES THE INVOICE COUNT.                                *06510000
065200*----------------------------------------------------------------*06520000
065300 V100-COMPUTE-CNTS.                                               06530000
065400                                                                  06540000
065500     MOVE 'V100-COMPUTE-CNTS' TO PV-ABEND-PARAGRAPH.              06550000
065600                                                                  06560000
065700     COMPUTE PV-INPUT-CNT                                         06570000
065800        =    PV-INPUT-CNT                                         06580000
065900        +    PV-INPUT-CNT-C.                                      06590000
066000                                                                  06600000
066100*----------------------------------------------------------------*06610000
066200*    OPENS THE RECDIS   CURSOR.                                  *06620000
066300*----------------------------------------------------------------*06630000
066400                                                                  06640000
066500 W100-WRITE-NOT-FOUND-RECD.                                       06650000
066600                                                                  06660000
066700     WRITE NOT-FOUND-RECORD FROM AP066-RECORD.                    06670000
066800                                                                  06680000
066900                                                                  06690000
067000*----------------------------------------------------------------*06700000
067100*    OPENS THE RECDIS   CURSOR.                                  *06710000
067200*----------------------------------------------------------------*06720000
067300 Y100-OPEN-INVOICE-CSR.                                           06730000
067400                                                                  06740000
067500     MOVE 'Y100-OPEN-INVOICE-CSR' TO PV-ABEND-PARAGRAPH.          06750000
067600                                                                  06760000
067700     EXEC SQL                                                     06770000
067800         OPEN INVOICE_CSR                                         06780000
067900     END-EXEC.                                                    06790000
068000                                                                  06800000
068100     EVALUATE TRUE                                                06810000
068200         WHEN SQLCODE = ZERO                                      06820000
068300              CONTINUE                                            06830000
068400                                                                  06840000
068500         WHEN SQLWARN0 NOT = SPACES                               06850000
068600         WHEN SQLCODE  NOT = ZERO                                 06860000
068700             MOVE 'UNSUCCESSFUL OPEN ON INVOICE'                  06870000
068800                                 TO PV-ABEND-OPERATION            06880000
068900             MOVE 'INVOICE'      TO PV-ABEND-STRUCTURE-1          06890000
069000             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          06900000
069100                                    PV-ABEND-STRUCTURE-3          06910000
069200                                    PV-ABEND-STRUCTURE-4          06920000
069300             PERFORM Z999-DB2-ABEND                               06930000
069400     END-EVALUATE.                                                06940000
069500                                                                  06950000
069600*----------------------------------------------------------------*06960000
069700*    CLOSES THE RECDIS CURSOR.                                    06970000
069800*----------------------------------------------------------------*06980000
069900 Y200-CLOSE-INVOICE-CSR.                                          06990000
070000                                                                  07000000
070100     MOVE 'Y200-CLOSE-INVOICE_CSR' TO PV-ABEND-PARAGRAPH.         07010000
070200                                                                  07020000
070300     EXEC SQL                                                     07030000
070400         CLOSE INVOICE_CSR                                        07040000
070500     END-EXEC.                                                    07050000
070600                                                                  07060000
070700     EVALUATE TRUE                                                07070000
070800         WHEN SQLCODE = ZERO                                      07080000
070900              CONTINUE                                            07090000
071000                                                                  07100000
071100         WHEN SQLWARN0 NOT = SPACES                               07110000
071200         WHEN SQLCODE  NOT = ZERO                                 07120000
071300             MOVE 'UNSUCCESSFUL CLOSE ON INVOICE'                 07130000
071400                                 TO PV-ABEND-OPERATION            07140000
071500             MOVE 'TINVOIC'      TO PV-ABEND-STRUCTURE-1          07150000
071600             MOVE SPACES         TO PV-ABEND-STRUCTURE-2          07160000
071700                                    PV-ABEND-STRUCTURE-3          07170000
071800                                    PV-ABEND-STRUCTURE-4          07180000
071900             PERFORM Z999-DB2-ABEND                               07190000
072000     END-EVALUATE.                                                07200000
072100                                                                  07210000
072200*----------------------------------------------------------------*07220000
072300*    DO THE CHECKPOINT RESTART AND THE COMMIT.                   *07230000
072400*----------------------------------------------------------------*07240000
072500 Y300-CHECKPOINT-COMMIT.                                          07250000
072600                                                                  07260000
072700     MOVE 'Y300-CHECKPOINT-COMMIT' TO PV-ABEND-PARAGRAPH.         07270000
072800                                                                  07280000
072900     EXEC SQL                                                     07290000
073000       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      07300000
073100     END-EXEC.                                                    07310000
073200                                                                  07320000
073300     EVALUATE TRUE                                                07330000
073400         WHEN SQLCODE = ZERO                                      07340000
073500              CONTINUE                                            07350000
073600                                                                  07360000
073700        WHEN SQLWARN0 NOT = SPACES                                07370000
073800        WHEN SQLCODE  NOT = ZERO                                  07380000
073900            MOVE 'UNSUCCESSFUL SET TMST'                          07390000
074000                                TO PV-ABEND-OPERATION             07400000
074100            MOVE SPACES         TO PV-ABEND-STRUCTURE-1           07410000
074200            PERFORM Z999-DB2-ABEND                                07420000
074300     END-EVALUATE.                                                07430000
074400                                                                  07440000
074500     IF CR-CURR-TMST > CR-NEXT-TMST                               07450000
074600        MOVE PC-IN-PROCESS-CODE      TO PV-CKPT-STAT-CODE         07460000
074700        PERFORM U200-UPDATE-TCKRSTCNTL                            07470000
074800        PERFORM U300-UPDATE-TCKRSTINF                             07480000
074900        PERFORM U400-COMMIT                                       07490000
075000                                                                  07500000
075100        EXEC SQL                                                  07510000
075200         SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)     07520000
075300          INTO :CR-NEXT-TMST                                      07530000
075400          FROM TCKRSTCNTL                                         07540000
075500          WHERE PLAN_NAME = :PV-PROGRAM-NAME                      07550000
075600        END-EXEC                                                  07560000
075700                                                                  07570000
075800          EVALUATE TRUE                                           07580000
075900              WHEN SQLCODE = ZERO                                 07590000
076000                   CONTINUE                                       07600000
076100                                                                  07610000
076200          WHEN SQLWARN0 NOT = SPACES                              07620000
076300          WHEN SQLCODE  NOT = ZERO                                07630000
076400              MOVE 'UNSUCCESSFUL NEXT TMST'                       07640000
076500                                  TO PV-ABEND-OPERATION           07650000
076600              MOVE SPACES         TO PV-ABEND-STRUCTURE-1         07660000
076700              PERFORM Z999-DB2-ABEND                              07670000
076800       END-EVALUATE                                               07680000
076900     END-IF.                                                      07690000
077000                                                                  07700000
077100*----------------------------------------------------------------*07710000
077200*    GET THE RESTART INFO                                        *07720000
077300*----------------------------------------------------------------*07730000
077400 Y400-CHECKPOINT-RESTART.                                         07740000
077500                                                                  07750000
077600     MOVE 'Y400-CHECKPOINT-RESTART' TO PV-ABEND-PARAGRAPH.        07760000
077700                                                                  07770000
077800     PERFORM R800-GET-CHECKPOINT-INFO.                            07780000
077900     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     07790000
078000                                                                  07800000
078100     PERFORM R100-READ-INVOICE-TRAN                               07810000
078200        WITH TEST AFTER                                           07820000
078300             UNTIL   (END-OF-INVOICE-INPUT)     OR                07830000
078400             (AP066-PO-NBR    = CR-PO-NBR).                       07840000
078500                                                                  07850000
078600     DISPLAY '***********************************************'.   07860000
078700     DISPLAY '** APKUP063 CHECKPOINT RESTART **'                  07870000
078800     DISPLAY '** PO NUMBER ON RESTART = '  AP066-PO-NBR.          07880000
078900     DISPLAY '***********************************************'.   07890000
079000                                                                  07900000
079010     MOVE CR-INVOICE-IN-REC-CNT TO PV-INPUT-CNT.                  07901000
079020     MOVE CR-OP-UPDATE-REC-CNT  TO PV-OP-UPDATE-CNT.              07902000
079030     MOVE CR-PJ-UPDATE-REC-CNT  TO PV-PJ-UPDATE-CNT.              07903000
079040     MOVE CR-NOT-FOUND-REC-CNT  TO PV-NOT-FOUND-CNT.              07904000
079050                                                                  07905000
079100     MOVE ZEROS                   TO PV-INPUT-CNT-C.              07910000
079200                                                                  07920000
079300 Z999-DB2-ABEND.                                                  07930000
079400*                                                                 07940000
079500***************************************************************** 07950000
079600*     PROCESS DB2 ABENDS                                          07960000
079700***************************************************************** 07970000
079800*                                                                 07980000
079900                                                                  07990000
080000     DISPLAY '*** DB2 ERROR '.                                    08000000
080100     DISPLAY '*** SQL CODE = '  PV-ABEND-SQLCODE.                 08010000
080200     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 08020000
080300     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               08030000
080400     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               08040000
080500     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             08050000
080600     IF PV-ABEND-STRUCTURE-2 > SPACES                             08060000
080700         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2.         08070000
080800     IF PV-ABEND-STRUCTURE-3 > SPACES                             08080000
080900         DISPLAY '*** TABLE 3   = ' PV-ABEND-STRUCTURE-3.         08090000
081000     IF PV-ABEND-STRUCTURE-4 > SPACES                             08100000
081100         DISPLAY '*** TABLE 4   = ' PV-ABEND-STRUCTURE-4.         08110000
081200                                                                  08120000
081300     COPY DPPD004.                                                08130000
081400                                                                  08140000
081500     MOVE +4013                    TO ABEND-CODE.                 08150000
081600                                                                  08160000
081700     CALL 'ILBOABN0' USING ABEND-CODE.                            08170000
