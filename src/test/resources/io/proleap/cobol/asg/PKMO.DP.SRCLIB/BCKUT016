000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             BCKUT016.                                00050000
000600 AUTHOR.                 RICK TULLOCH.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           10-07-20.                                00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*       THIS PROGRAM READS THROUGH A BUSINESS CONTINUITY         *00120000
001210*  EMPLOYEE EXTRACT CSV FILE TO PREPARE A DETAIL FILE THAT WILL  *00121009
001211*  INCLUDE THE FUSION ID (DATALESS KEY TO FF__KEY_CONTACT__C).   *00121109
001212*  THE CSV FILE WILL BE VERIFIED TO CONTAIN THE HEADER, AND      *00121209
001213*  THE FIRST TWO FIELDS SHOULD BE THE FUSION ID AND EMPLOYEE ID. *00121309
001214*  EACH DETAIL RECORD WILL BE PARSED AND THE FUSION ID AND       *00121409
001215*  EMPLOYEE ID VALIDATED.  TEST IDS THAT HAVE NULL EMPLOYEE IDS  *00121509
001216*  WILL BE DISPLAYED AND DISCARDED.  EMPLOYEE IDS OF AN          *00121609
001217*  INCORRECT LENGTH WILL BE TREATED AS INVALID DATA AND ABEND    *00121709
001218*  THE PROGRAM.  FUSION IDS THAT ARE NOT OF THE EXPECTED LENGTH  *00121809
001219*  WILL BE DISPLAYED AND STILL INCLUDED ON THE FILE.             *00121909
001220******************************************************************00122009
001221                                                                  00122109
001222******************************************************************00122209
001230 ENVIRONMENT DIVISION.                                            00123000
001240******************************************************************00124000
001250                                                                  00125000
001260 CONFIGURATION SECTION.                                           00126000
001270                                                                  00127000
001280 SOURCE-COMPUTER.        IBM-3090.                                00128000
001290 OBJECT-COMPUTER.        IBM-3090.                                00129000
001300                                                                  00130000
001400 INPUT-OUTPUT SECTION.                                            00140000
001500                                                                  00150000
001600 FILE-CONTROL.                                                    00160000
001700                                                                  00170000
001800     SELECT EMPLOYEE-EXTRACT-FILE                                 00180000
001900         ASSIGN TO INP01.                                         00190000
002000                                                                  00200000
002100     SELECT EMPLOYEE-DETAIL-FILE                                  00210000
002200         ASSIGN TO OUT01.                                         00220000
002600                                                                  00260000
002700******************************************************************00270000
002800 DATA DIVISION.                                                   00280000
002900******************************************************************00290000
003000                                                                  00300000
003100 FILE SECTION.                                                    00310000
003200                                                                  00320000
003300 FD  EMPLOYEE-EXTRACT-FILE                                        00330000
003400     RECORDING MODE IS F                                          00340000
003500     LABEL RECORDS ARE STANDARD                                   00350000
003600     BLOCK CONTAINS 0 RECORDS                                     00360000
003700     RECORD CONTAINS 200 CHARACTERS                               00370000
003800     DATA RECORD IS EE-EMPLOYEE-EXTRACT-RECORD.                   00380000
003900                                                                  00390000
004000 01  EE-EMPLOYEE-EXTRACT-RECORD  PIC X(200).                      00400000
004200                                                                  00420000
004300 FD  EMPLOYEE-DETAIL-FILE                                         00430000
004400     RECORDING MODE IS F                                          00440000
004500     LABEL RECORDS ARE STANDARD                                   00450000
004600     BLOCK CONTAINS 0 RECORDS                                     00460000
004700     RECORD CONTAINS 37 CHARACTERS                                00470000
004800     DATA RECORD IS ED-EMPLOYEE-DETAIL-RECORD.                    00480000
004900                                                                  00490000
005000 01  ED-EMPLOYEE-DETAIL-RECORD   PIC X(37).                       00500000
005650                                                                  00565000
005660 WORKING-STORAGE SECTION.                                         00566000
005670                                                                  00567000
005680 01  ABEND-CODE                  PIC S9(04)   VALUE ZERO          00568000
005690                                              COMP SYNC.          00569000
005691     88  AC-INVLD-DATA-ON-DATASET-ERROR       VALUE +4008.        00569101
005700                                                                  00570000
005800 01  PS-PROGRAM-SWITCHES.                                         00580000
005900     05  PS-END-OF-EMPL-FILE-SW  PIC X(1)     VALUE 'N'.          00590000
006100         88  PS-END-OF-EMPL-FILE              VALUE 'Y'.          00610000
006200                                                                  00620000
006300 01  PC-PROGRAM-CONSTANTS.                                        00630000
006400     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'BCKUT016'.   00640000
006410     05  PC-COMMA                PIC X(1)     VALUE ','.          00641001
006420     05  PC-DOUBLE-QUOTE         PIC X(1)     VALUE '"'.          00642001
006500     05  PC-MAXIMUM-FUSION-ID-LENGTH                              00650001
006600                                 PIC S9(4)    VALUE +18           00660001
006700                                              COMP SYNC.          00670000
006810                                                                  00681000
006900 01  PV-PROGRAM-VARIABLES.                                        00690000
007000     05  PV-TALLY                PIC S9(4)    VALUE ZEROS         00700001
007100                                              COMP SYNC.          00710001
007202                                                                  00720201
007210 01  BE-BC-EMPLOYEE-DETAIL-RECORD.                                00721001
007220     05  BE-EMPLOYEE-ID          PIC X(7)     VALUE SPACES.       00722001
007230     05  BE-FUSION-ID            PIC X(30)    VALUE SPACES.       00723001
007300                                                                  00730001
007400 01  UA-UNSTRING-AREA.                                            00740001
007500     05  UA-WORD-1               PIC X(80)    VALUE SPACES.       00750001
007600         88  UA-WORD-1-CSV-HEADER             VALUE '"ID"'.       00760001
007700     05  UA-WORD-2               PIC X(80)    VALUE SPACES.       00770001
007800     05  UA-OVERFLOW-POINTER     PIC S9(4)    VALUE ZEROS         00780001
007900                                              COMP SYNC.          00790001
008000     05  UA-OVERFLOW             PIC X(80)    VALUE SPACES.       00800001
008100     05  UA-EMPLOYEE-ID          PIC X(30)    VALUE SPACES.       00810001
008300     05  UA-FUSION-ID            PIC X(30)    VALUE SPACES.       00830001
013698                                                                  01369800
013699 01  PT-PROGRAM-TOTALS.                                           01369900
013700     05  PT-EXTRACT-RCDS-READ    PIC S9(9)    VALUE ZEROS         01370000
013710                                              COMP-3.             01371000
013711     05  PT-DETAIL-RCDS-WRITTEN  PIC S9(9)    VALUE ZEROS         01371100
013712                                              COMP-3.             01371200
013713                                                                  01371300
013714 01  TD-TOTAL-DISPLAY-MESSAGE.                                    01371400
013715     05  TD-TOTAL-ID             PIC X(51)    VALUE SPACES.       01371500
013716         88  TD-EXTRACT-RCDS-READ-ID          VALUE               01371600
013717             'BC EMPLOYEE EXTRACT CSV RECORDS READ . . . . . . .'.01371700
013718         88  TD-DETAIL-RCDS-WRITTEN-ID        VALUE               01371800
013719             'EMPLOYEE DETAIL RECORDS WRITTEN  . . . . . . . . .'.01371900
013720     05  TD-TOTAL-AMOUNT         PIC ZZZ,ZZZ,ZZ9                  01372000
013730                                              VALUE ZEROS.        01373000
013731                                                                  01373100
013732******************************************************************01373200
013733 PROCEDURE DIVISION.                                              01373300
013734******************************************************************01373400
013735                                                                  01373500
013736 0000-MAINLINE.                                                   01373600
013737                                                                  01373700
013738     PERFORM 1000-INITIALIZE.                                     01373800
013739                                                                  01373900
013740     PERFORM 2000-PROCESS-EMPLOYEE                                01374000
013750         UNTIL PS-END-OF-EMPL-FILE.                               01375000
013760                                                                  01376000
013770     PERFORM 1500-DISPLAY-PROGRAM-TOTALS.                         01377000
013780                                                                  01378000
013790     PERFORM 9000-EOJ-ROUTINE.                                    01379000
013800                                                                  01380000
013900     GOBACK.                                                      01390000
014000                                                                  01400000
014100******************************************************************01410000
014200*  INITIALIZE FOR PROGRAM PROCESSING.  OPEN ALL FILES.  READ THE *01420000
014300*  THE FIRST EMPLOYEE EXTRACT CSV RECORD.  VERIFY THAT THE FIRST *01430001
014400*  RECORD IS THE CSV HEADER RECORD.  READ THE FIRST DATA RECORD  *01440001
014410*  ON THE EMPLOYEE EXTRACT CSV FILE.                             *01441001
014500******************************************************************01450000
014600                                                                  01460000
014700 1000-INITIALIZE.                                                 01470000
014800     OPEN INPUT  EMPLOYEE-EXTRACT-FILE                            01480000
014900          OUTPUT EMPLOYEE-DETAIL-FILE.                            01490000
015100                                                                  01510000
015200     PERFORM 7000-READ-EMPLOYEE-FILE.                             01520000
015300                                                                  01530001
015310     PERFORM 2100-UNSTRING-CSV-DETAIL.                            01531001
015320                                                                  01532001
015400     IF (NOT UA-WORD-1-CSV-HEADER)                                01540001
015401         DISPLAY '** ABEND **'                                    01540101
015402         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - FIRST RECORD ON '   01540201
015403                   'EMPLOYEE EXTRACT CSV FILE IS NOT THE HEADER ' 01540301
015404                   'RECORD'                                       01540401
015405         SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE               01540501
015406         CALL 'ILBOABN0' USING ABEND-CODE                         01540601
015410     END-IF.                                                      01541001
015420                                                                  01542001
015430     PERFORM 7000-READ-EMPLOYEE-FILE.                             01543001
015500*1000-EXIT.                                                       01550000
015600                                                                  01560000
015700******************************************************************01570000
015800*  DISPLAY SUMMARY TOTALS OF I/O ACTIVITY.                       *01580000
015900******************************************************************01590000
016000                                                                  01600000
016100 1500-DISPLAY-PROGRAM-TOTALS.                                     01610000
016200     SET TD-EXTRACT-RCDS-READ-ID TO TRUE.                         01620000
016300     MOVE PT-EXTRACT-RCDS-READ TO TD-TOTAL-AMOUNT.                01630000
016400     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       01640000
016500               TD-TOTAL-DISPLAY-MESSAGE.                          01650000
016600                                                                  01660000
016700     SET TD-DETAIL-RCDS-WRITTEN-ID TO TRUE.                       01670000
016800     MOVE PT-DETAIL-RCDS-WRITTEN TO TD-TOTAL-AMOUNT.              01680000
016900     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       01690000
017000               TD-TOTAL-DISPLAY-MESSAGE.                          01700000
017100*1500-EXIT.                                                       01710000
017200                                                                  01720000
017300******************************************************************01730000
017400*  PROCESS AN EMPLOYEE.  EACH DETAIL RECORD WILL BE PARSED AND   *01740009
017410*  THE FUSION ID AND EMPLOYEE ID VALIDATED.  TEST IDS THAT HAVE  *01741009
017420*  NULL EMPLOYEE IDS WILL BE DISPLAYED AND DISCARDED.  EMPLOYEE  *01742009
017430*  IDS OF AN INCORRECT LENGTH WILL BE TREATED AS INVALID DATA    *01743009
017440*  ABEND THE PROGRAM.  FUSION IDS THAT ARE NOT OF THE EXPECTED   *01744009
017460*  LENGTH WILL BE DISPLAYED AND STILL INCLUDED ON THE FILE.      *01746009
017500******************************************************************01750000
017600                                                                  01760000
017700 2000-PROCESS-EMPLOYEE.                                           01770000
017800     INITIALIZE BE-BC-EMPLOYEE-DETAIL-RECORD.                     01780002
017900                                                                  01790001
018200     PERFORM 2100-UNSTRING-CSV-DETAIL.                            01820001
018300                                                                  01830001
018301     INITIALIZE PV-TALLY.                                         01830101
018302     INSPECT UA-EMPLOYEE-ID                                       01830201
018303         TALLYING PV-TALLY                                        01830301
018304         FOR CHARACTERS BEFORE INITIAL SPACE.                     01830401
018306     IF (PV-TALLY NOT = LENGTH OF BE-EMPLOYEE-ID)                 01830601
018307*                                                                 01830707
018308* UNTIL TEST IDS CAN BE CONFIRMED IN FUSION, A NULL EMPLOYEE ID   01830807
018309* WILL BE DISPLAYED AND NOT BE TREATED AS INVALID DATA            01830907
018310*                                                                 01831007
018311         IF (UA-EMPLOYEE-ID = SPACES)                             01831107
018312             DISPLAY PC-CURRENT-PROGRAM-NAME  ' - EMPLOYEE ID '   01831207
018313                       'PARSED FROM EMPLOYEE EXTRACT CSV WAS NULL'01831307
018314             DISPLAY PC-CURRENT-PROGRAM-NAME  ' -   REVIEW THE '  01831407
018315                       'EXTRACT RECORD'                           01831507
018316             DISPLAY PC-CURRENT-PROGRAM-NAME  ' -   '             01831607
018317                       EE-EMPLOYEE-EXTRACT-RECORD                 01831707
018318         ELSE                                                     01831807
018319             DISPLAY '** ABEND **'                                01831907
018320             DISPLAY PC-CURRENT-PROGRAM-NAME  ' - EMPLOYEE ID '   01832007
018321                       'PARSED FROM EMPLOYEE EXTRACT CSV: '       01832107
018322                       UA-EMPLOYEE-ID                             01832207
018323             SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE           01832307
018324             CALL 'ILBOABN0' USING ABEND-CODE                     01832407
018325         END-IF                                                   01832507
018326     END-IF.                                                      01832607
018327                                                                  01832707
018328     INITIALIZE PV-TALLY.                                         01832807
018329     INSPECT UA-FUSION-ID                                         01832907
018330         TALLYING PV-TALLY                                        01833007
018331         FOR CHARACTERS BEFORE INITIAL SPACE.                     01833107
018332     IF (PV-TALLY NOT = PC-MAXIMUM-FUSION-ID-LENGTH)              01833207
018333         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - FUSION ID '         01833307
018334                   'PARSED FROM EMPLOYEE EXTRACT CSV IS '         01833407
018335                   'NOT THE EXPECTED LENGTH'                      01833507
018336         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - CHECK TO MAKE SURE '01833607
018337                   UA-FUSION-ID ' FOR EMPLOYEE ' UA-EMPLOYEE-ID   01833707
018338                   'IS CORRECT'                                   01833807
018339     END-IF.                                                      01833907
018340                                                                  01834007
018341     MOVE UA-EMPLOYEE-ID (1:LENGTH OF BE-EMPLOYEE-ID) TO          01834107
018342               BE-EMPLOYEE-ID.                                    01834207
018350     MOVE UA-FUSION-ID TO BE-FUSION-ID.                           01835007
018400                                                                  01840001
018500     IF ((BE-EMPLOYEE-ID NOT = SPACES) AND                        01850009
018600             (BE-FUSION-ID NOT = SPACES))                         01860009
018800         PERFORM 8000-WRITE-DETAIL-RECORD                         01880008
018801     END-IF.                                                      01880108
018802                                                                  01880200
018810     PERFORM 7000-READ-EMPLOYEE-FILE.                             01881001
018900*2000-EXIT.                                                       01890000
019000                                                                  01900001
019100******************************************************************01910001
019200*  UNSTRING CSV DETAILS.  THE FUSION ID AND EMPLOYEE ID WILL BE  *01920009
019210*  THE FIRST TWO FIELDS ON THE FILE, AND WILL BE STRINGS THAT    *01921009
019220*  ARE ENCLOSED IN QUOTES.                                       *01922009
019300******************************************************************01930001
019400                                                                  01940001
019500 2100-UNSTRING-CSV-DETAIL.                                        01950001
019600     INITIALIZE UA-UNSTRING-AREA.                                 01960001
019610     MOVE +1 TO UA-OVERFLOW-POINTER.                              01961001
019700                                                                  01970001
019800     UNSTRING EE-EMPLOYEE-EXTRACT-RECORD                          01980001
019900         DELIMITED BY PC-COMMA                                    01990001
020000         INTO UA-WORD-1                                           02000001
020010              UA-WORD-2                                           02001001
020020         WITH POINTER UA-OVERFLOW-POINTER                         02002001
020030         ON OVERFLOW                                              02003001
020040             CONTINUE                                             02004001
020090     END-UNSTRING.                                                02009001
020091                                                                  02009101
020092     IF (UA-WORD-1 (1:1) = PC-DOUBLE-QUOTE)                       02009204
020093         UNSTRING UA-WORD-1 (2:)                                  02009305
020094             DELIMITED BY PC-DOUBLE-QUOTE                         02009403
020095             INTO UA-FUSION-ID                                    02009503
020099         END-UNSTRING                                             02009903
020100     ELSE                                                         02010003
020101         DISPLAY '** ABEND **'                                    02010103
020102         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - FUSION ID '         02010203
020103                   'WAS NOT EXTRACTED AS A STRING IN QUOTES: '    02010303
020104                   UA-WORD-1                                      02010403
020105         SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE               02010503
020106         CALL 'ILBOABN0' USING ABEND-CODE                         02010603
020108     END-IF.                                                      02010803
020109                                                                  02010903
020110     IF (UA-WORD-2 (1:1) = PC-DOUBLE-QUOTE)                       02011004
020111         UNSTRING UA-WORD-2 (2:)                                  02011106
020112             DELIMITED BY PC-DOUBLE-QUOTE                         02011203
020113             INTO UA-EMPLOYEE-ID                                  02011303
020114         END-UNSTRING                                             02011403
020115     ELSE                                                         02011503
020116         DISPLAY '** ABEND **'                                    02011603
020117         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - EMPLOYEE ID '       02011703
020118                   'WAS NOT EXTRACTED AS A STRING IN QUOTES: '    02011803
020119                   UA-WORD-2                                      02011906
020120         SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE               02012003
020121         CALL 'ILBOABN0' USING ABEND-CODE                         02012103
020130     END-IF.                                                      02013003
020200*2100-EXIT.                                                       02020001
020990                                                                  02099000
021000******************************************************************02100000
021100*  READ AN EMPLOYEE EXTRACT CSV RECORD, AND ACCUMULATE I/O       *02110000
021200*  TOTALS.                                                       *02120000
021300******************************************************************02130000
021400                                                                  02140000
021500 7000-READ-EMPLOYEE-FILE.                                         02150000
021600     READ EMPLOYEE-EXTRACT-FILE                                   02160000
021800         AT END                                                   02180000
021900             SET PS-END-OF-EMPL-FILE TO TRUE                      02190000
022000             SUBTRACT +1 FROM PT-EXTRACT-RCDS-READ                02200000
022100     END-READ.                                                    02210000
022200                                                                  02220000
022300     ADD +1 TO PT-EXTRACT-RCDS-READ.                              02230000
022400*7000-EXIT.                                                       02240000
023700                                                                  02370000
023800******************************************************************02380000
023900*  WRITE AN EMPLOYEE DETAIL RECORD, AND ACCUMULATE I/O TOTALS.   *02390000
024100******************************************************************02410000
024200                                                                  02420000
024300 8000-WRITE-DETAIL-RECORD.                                        02430000
024400     WRITE ED-EMPLOYEE-DETAIL-RECORD                              02440002
024500         FROM BE-BC-EMPLOYEE-DETAIL-RECORD.                       02450000
024600                                                                  02460000
024700     ADD +1 TO PT-DETAIL-RCDS-WRITTEN.                            02470000
024800*8000-EXIT.                                                       02480000
025900                                                                  02590000
026000******************************************************************02600000
026100*  CLOSE ALL FILES.                                              *02610000
026200******************************************************************02620000
026300                                                                  02630000
026400 9000-EOJ-ROUTINE.                                                02640000
026500     CLOSE EMPLOYEE-EXTRACT-FILE                                  02650000
026600           EMPLOYEE-DETAIL-FILE.                                  02660000
026800*9000-EXIT.                                                       02680000
