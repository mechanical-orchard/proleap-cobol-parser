000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         APKRP243.                                    00020000
000300 AUTHOR.             CHRIS BOEHNLEIN.                             00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       04-21-98.                                    00050000
000600                                                                  00060000
000610******************************************************************00061000
000620* COBOL II WITH SQL                                              *00062000
000630*----------------------------------------------------------------*00063000
000640* CREATE MONTHLY SUMMARY IMPORT REPORTS                          *00064000
000650*----------------------------------------------------------------*00065000
000660* THIS PROGRAM PERFORMS DB2 CALLS AGAINST THE LEGACY SYSTEM TO   *00066000
000670* DETERMINE WHAT ENTRIES WERE MADE FOR THE IMPORT PURCHASE       *00067000
000680* ORDERS FROM THE ADJUSTMENT JOURNAL FOR THE PREVIOUS FISCAL     *00068000
000681* MONTH.  THIS PROGRAM FOCUSES SPECIFICALLY ON ACCOUNT 10303.    *00068100
000690*----------------------------------------------------------------*00069000
000691* DB2 TABLES:                                                    *00069100
000692*  1. INVOICE TABLE                          (TINVOIC)           *00069200
000693*  2. MERCHANDISE INVOICE TABLE              (TMDINVC)           *00069300
000694*  3. AP CHARGE TYPE TABLE                   (TACCTYP)           *00069400
000695*  4. VENDOR/DEPARTMENT TABLE                (TVNDDPT)           *00069500
000696*  5. PURCHASE ORDER HEADER TABLE            (TPURCHS)           *00069600
000697*  6. EXTERNAL ENTERPRISE TABLE              (TEXTENT)           *00069700
000698*  7. AP PAYMENT CONTROL TABLE               (TAPCNTL)           *00069800
000699*                                                                *00069900
000700* INPUT:                                                         *00070000
000701*  1. DETAIL IMPORT FILE                     (APRD047)           *00070100
000702*  2. DETAIL ACCOUNT IMPORT FILE             (APRD047)           *00070200
000703*                                                                *00070300
000704* OUTPUT:                                                        *00070400
000705*  1. IMPORT PURCHASE ORDERS FILE                                *00070500
000706*  2. MONTHLY SUMMARY IMPORT REPORT                              *00070600
000707*----------------------------------------------------------------*00070700
000708* PROGRAM CHANGES:                                               *00070800
000709*                                                                *00070900
000710* DATE 08/2005                                                   *00071000
000711*   CHANGE MADE: INITIAL IMPLEMENTATION                          *00071100
000716*   MADE BY: KRYSTEN LEARY                   WR/IR: WR24554      *00071600
000717*                                                                *00071700
000718* DATE 06/2011                                                   *00071800
000719*   CHANGE MADE: CHANGE ACCOUNT NUMBER HEADING TO USE VALUE      *00071900
000720*                READ FROM CONTROL CARD                          *00072000
000721*   MADE BY: KRYSTEN LEARY                   WR/IR: WR39735      *00072100
000722*                                                                *00072204
000723* DATE 11/2014                                                   *00072304
000724*   CHANGE MADE: CHANGE THE LENGTH OF WS-PO-HOLD VARIABLE TO 9   *00072404
000725*                FROM LENGTH 7.                                  *00072504
000726*   MADE BY: COGNIZANT                       WR/IR: CHG0094517   *00072604
000727*                                                                 00072708
000728* DATE 09/2018                                                   *00072806
000729*   CHANGE MADE: REMOVE COPYBOOK PJRNLEXT. REPLACE REFERENCE     *00072908
000730*                TO PJR-DETAIL-PONUM WITH PV-DISPLAY-PONUM IN    *00073008
000731*                PARAGRAPH S800-READ-DUNNS-NBR                   *00073108
000732*   MADE BY: GERMAN BANDA                    WR/IR: CHG0209715   *00073211
000733******************************************************************00073308
000734                                                                  00073408
000740 ENVIRONMENT DIVISION.                                            00074006
000800 CONFIGURATION SECTION.                                           00080000
000900 SOURCE-COMPUTER.    IBM-3090.                                    00090000
001000 OBJECT-COMPUTER.    IBM-3090.                                    00100000
001100                                                                  00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT DETAIL-IMPORT-FILE-PJ           ASSIGN TO INP01.      00150000
001700     SELECT DETAIL-ACCT-IMPORT-FILE-PJ      ASSIGN TO INP02.      00170000
001900     SELECT WORK-REPORT-FILE                ASSIGN TO OUT01.      00190000
002000     SELECT SUMMARY-REPORT-FILE             ASSIGN TO RPT01.      00200000
002100                                                                  00210000
002200 DATA DIVISION.                                                   00220000
002400 FILE SECTION.                                                    00240000
002500                                                                  00250000
002600 FD  DETAIL-IMPORT-FILE-PJ                                        00260000
002700     RECORDING MODE IS F                                          00270000
002800     LABEL RECORDS ARE STANDARD                                   00280000
002900     RECORD CONTAINS 170 CHARACTERS                               00290000
003000     BLOCK CONTAINS 0 RECORDS                                     00300000
003100     DATA RECORD IS DR-DETAIL-IMPORT-RECORD-PJ.                   00310000
003200 01  DR-IMPORT-RECORD-PJ           PIC X(170).                    00320000
003300                                                                  00330000
003400 FD  DETAIL-ACCT-IMPORT-FILE-PJ                                   00340000
003500     RECORDING MODE IS F                                          00350000
003600     LABEL RECORDS ARE STANDARD                                   00360000
003700     RECORD CONTAINS 170 CHARACTERS                               00370000
003800     BLOCK CONTAINS 0 RECORDS                                     00380000
003900     DATA RECORD IS DR-ACCT-IMPORT-RECORD-PJ.                     00390000
004000 01  DR-ACCT-IMPORT-RECORD-PJ      PIC X(170).                    00400000
004100                                                                  00410000
004200 FD  WORK-REPORT-FILE                                             00420000
004300     RECORDING MODE IS F                                          00430000
004400     LABEL RECORDS ARE STANDARD                                   00440000
004500     RECORD CONTAINS 168 CHARACTERS                               00450000
004600     BLOCK CONTAINS 0 RECORDS                                     00460000
004700     DATA RECORD IS WR-WORK-REPORT-RECORD.                        00470000
004800 01  WR-WORK-REPORT-RECORD         PIC X(168).                    00480000
004900                                                                  00490000
005000 FD  SUMMARY-REPORT-FILE                                          00500000
005020     LABEL RECORDS ARE STANDARD                                   00502000
005030     RECORDING MODE IS F                                          00503000
005040     BLOCK CONTAINS 0 RECORDS.                                    00504000
005060 01  SUMMARY-REPORT-RECORD         PIC X(132).                    00506000
005070                                                                  00507000
005100 WORKING-STORAGE SECTION.                                         00510000
005210*----------------------------------------------------------------*00521000
005220* GL EXTRACT FILE LAYOUT (INPUT)                                 *00522000
005230*----------------------------------------------------------------*00523000
005300     COPY APRD047.                                                00530000
005310                                                                  00531000
005420*----------------------------------------------------------------*00542000
005430* WORKING STORAGE FOR DATE ROUTINE                               *00543000
005440*----------------------------------------------------------------*00544000
005500     COPY DPWS500.                                                00550000
005510                                                                  00551000
005520*----------------------------------------------------------------*00552000
005530* SQLCA FORMATTED MESSAGE AREA                                   *00553000
005540*----------------------------------------------------------------*00554000
005600     COPY DPWS004.                                                00560000
005800                                                                  00580000
005810*----------------------------------------------------------------*00581000
005820* STANDARD HEADER LAYOUT                                         *00582000
005830*----------------------------------------------------------------*00583000
005840     COPY DPWS132O.                                               00584000
005850                                                                  00585000
005900*----------------------------------------------------------------*00590000
005910* DB2 COMMUNICATIONS AREA                                        *00591000
005920*----------------------------------------------------------------*00592000
005930     COPY SQLCA2.                                                 00593000
006000                                                                  00600000
016200 01  PROGRAM-CONSTANTS.                                           01620000
016300     05  PC-PROGRAM-NAME         PIC X(08)   VALUE 'APKRP243'.    01630000
016310     05  PC-MAX-RETRIES          PIC 9(02)   VALUE 3.             01631000
016400                                                                  01640000
016401 01  PROGRAM-COUNTERS.                                            01640100
016402     05  PV-ACCT-READ-CNT        PIC 9(08)   VALUE ZERO.          01640200
016403     05  PV-IMPORT-READ-CNT      PIC 9(08)   VALUE ZERO.          01640300
016404     05  PV-WRITTEN-CNT          PIC 9(08)   VALUE ZERO.          01640400
016405                                                                  01640500
016419 01  PROGRAM-SWITCHES.                                            01641900
016420     05  END-OF-FILE-IMPORT-PJ   PIC X(01)   VALUE 'N'.           01642000
016430         88 END-OF-FILE-IMPORT               VALUE 'Y'.           01643000
016440     05  PS-MORE-TINVOIC         PIC X(01)   VALUE 'N'.           01644000
016450         88 PS-NO-MORE-TINVOIC               VALUE 'Y'.           01645000
016460     05  END-OF-FILE-NO-ACCT     PIC X(01)   VALUE 'N'.           01646000
016470         88 END-OF-FILE-ACCT                 VALUE 'Y'.           01647000
016480                                                                  01648000
016490 01  PROGRAM-VARIABLES.                                           01649000
016491     05  PV-RETRY-COUNTER        PIC 9(02)   VALUE ZEROS.         01649100
016492     05  PV-FIRST-FISCAL-DATE    PIC X(10)   VALUE SPACES.        01649200
016493     05  PV-LAST-FISCAL-DATE     PIC X(10)   VALUE SPACES.        01649300
016494     05  PV-DISPLAY-PONUM        PIC X(09)   VALUE SPACES.        01649407
016495                                                                  01649507
016496 01  CONTROL-CARD.                                                01649607
016497     05  CC-ACCOUNT              PIC X(05)   VALUE SPACES.        01649707
016498                                                                  01649807
016499 01  DATE-WORK-AREA.                                              01649907
016500     05  SYSTEM-DATE             PIC 9(06)   VALUE ZERO.          01650007
016501     05  FILLER REDEFINES SYSTEM-DATE.                            01650107
016502         10  SYSTEM-YEAR         PIC 9(02).                       01650207
016503         10  SYSTEM-MONTH        PIC 9(02).                       01650307
016504         10  SYSTEM-DAY          PIC 9(02).                       01650407
016505     05  SYSTEM-TIME             PIC 9(08)   VALUE ZERO.          01650507
016506     05  FILLER REDEFINES SYSTEM-TIME.                            01650607
016507         10  SYSTEM-HOUR         PIC 9(02).                       01650707
016508         10  SYSTEM-MINUTE       PIC 9(02).                       01650807
016509         10  SYSTEM-SECOND       PIC 9(02).                       01650907
016510         10  FILLER              PIC 9(02).                       01651007
016511                                                                  01651107
016520 01  ACCOUNT-TABLE.                                               01652000
016600     05 ACCT-TABLE OCCURS 100000 TIMES INDEXED BY X1.             01660000
016700        10 ACCT-PO               PIC X(09)   VALUE SPACES.        01670000
016900        10 ACCT-DATE             PIC X(10)   VALUE SPACES.        01690000
017000                                                                  01700000
018000 01 WS-WORKING-STORAGE.                                           01800000
018100    05  WS-DB2-ACCOUNT.                                           01810000
018300        10  WS-DB2-ACCT          PIC X(05)   VALUE SPACES.        01830000
018400    05  WS-DB2-ACCOUNT2          PIC X(07)   VALUE SPACES.        01840000
018500    05  WS-DETAIL-PONUM          PIC 9(09)   VALUE ZERO.          01850000
018900    05  WS-DUNNS-NUMBER          PIC X(09)   VALUE SPACES.        01890000
019000    05  WS-DT-PONUM              PIC S9(09)  COMP.                01900000
019100    05  WS-DM-TOTAL              PIC S9(11)V99 COMP-3 VALUE ZERO. 01910000
019300    05  WS-CM-TOTAL              PIC S9(11)V99 VALUE ZERO COMP-3. 01930000
020000    05  WS-JN-DATE               PIC X(10)   VALUE SPACES.        02000000
020100    05  WS-HD-PO                 PIC 9(09)   VALUE ZEROS.         02010000
020700    05  WS-HD-DATE               PIC X(10)   VALUE SPACES.        02070000
021400    05  WS-INVOIC-PO-NBR         PIC S9(09)  COMP.                02140000
021500    05  WS-HOLD-ACCT             PIC X(07)   VALUE SPACES.        02150000
021600    05  WS-PO-HOLD               PIC 9(09)   VALUE ZEROS.         02160003
021700    05  WS-DEBIT-TOTAL           PIC S9(11)V99 COMP-3 VALUE ZERO. 02170000
021900    05  WS-CREDIT-TOTAL          PIC S9(11)V99 COMP-3 VALUE ZERO. 02190000
022100    05  WS-INV-TOTAL             PIC S9(11)V99 COMP-3 VALUE ZERO. 02210000
022410    05  WS-REQ-ENTR-TRMNL-ID     PIC X(04)   VALUE SPACES.        02241000
022500                                                                  02250000
022501 01 REPORT-CONTROLS.                                              02250100
022502    05  PAGE-COUNT               PIC S9(04)  COMP-3 VALUE ZERO.   02250200
022503    05  LINE-COUNT               PIC S9(04)  COMP-3 VALUE ZERO.   02250300
022504 01 BLANK-LINE                   PIC X(132)  VALUE SPACES.        02250400
022505                                                                  02250500
022510 01 HDR-LINE-1.                                                   02251000
022511    05  FILLER                   PIC X(43)   VALUE SPACES.        02251100
022512    05  FILLER                   PIC X(42)   VALUE                02251200
022513        'MONTHLY SUMMARY IMPORT REPORT FOR ACCOUNT '.             02251300
022514    05  HDR1-ACCOUNT             PIC X(05)   VALUE SPACES.        02251400
022515    05  FILLER                   PIC X(42)   VALUE SPACES.        02251500
022516                                                                  02251600
022520 01 HDR-LINE-2.                                                   02252000
022530    05  FILLER                   PIC X(45)   VALUE SPACES.        02253000
022540    05  FILLER                   PIC X(15)   VALUE                02254000
022550        'FOR THE PERIOD '.                                        02255000
022570    05  HDR2-START-MM            PIC X(02)   VALUE SPACES.        02257000
022571    05  FILLER                   PIC X(01)   VALUE '-'.           02257100
022572    05  HDR2-START-DD            PIC X(02)   VALUE SPACES.        02257200
022573    05  FILLER                   PIC X(01)   VALUE '-'.           02257300
022574    05  HDR2-START-YYYY          PIC X(04)   VALUE SPACES.        02257400
022580    05  FILLER                   PIC X(09)   VALUE ' THROUGH '.   02258000
022590    05  HDR2-END-MM              PIC X(02)   VALUE SPACES.        02259000
022591    05  FILLER                   PIC X(01)   VALUE '-'.           02259100
022592    05  HDR2-END-DD              PIC X(02)   VALUE SPACES.        02259200
022593    05  FILLER                   PIC X(01)   VALUE '-'.           02259300
022594    05  HDR2-END-YYYY            PIC X(04)   VALUE SPACES.        02259400
022595    05  FILLER                   PIC X(43)   VALUE SPACES.        02259500
022596                                                                  02259600
022600 01 HDR-LINE-3.                                                   02260000
022700    05  FILLER                   PIC X(01)   VALUE SPACES.        02270000
022800    05  FILLER                   PIC X(07)   VALUE 'ACCOUNT'.     02280000
022900    05  FILLER                   PIC X(02)   VALUE SPACES.        02290000
023000    05  FILLER                   PIC X(10)   VALUE 'VENDOR NBR'.  02300000
023100    05  FILLER                   PIC X(02)   VALUE SPACES.        02310000
023200    05  FILLER                   PIC X(06)   VALUE 'PO NBR'.      02320000
023300    05  FILLER                   PIC X(08)   VALUE SPACES.        02330000
023400    05  FILLER                   PIC X(09)   VALUE 'DEBIT AMT'.   02340000
023500    05  FILLER                   PIC X(05)   VALUE SPACES.        02350000
023600    05  FILLER                   PIC X(10)   VALUE 'DEBIT DATE'.  02360000
023700    05  FILLER                   PIC X(04)   VALUE SPACES.        02370000
023800    05  FILLER                   PIC X(10)   VALUE 'CREDIT AMT'.  02380000
023900    05  FILLER                   PIC X(03)   VALUE SPACES.        02390000
024000    05  FILLER                   PIC X(11)   VALUE 'CREDIT DATE'. 02400000
024100    05  FILLER                   PIC X(02)   VALUE SPACES.        02410000
024200    05  FILLER                   PIC X(09)   VALUE 'JRNL DATE'.   02420000
024210    05  FILLER                   PIC X(04)   VALUE SPACES.        02421000
024220    05  FILLER                   PIC X(11)   VALUE 'INVOICE AMT'. 02422000
024230    05  FILLER                   PIC X(04)   VALUE SPACES.        02423000
024240    05  FILLER                   PIC X(12)   VALUE 'REVERSAL AMT'.02424000
024241    05  FILLER                   PIC X(02)   VALUE SPACES.        02424100
024250                                                                  02425000
024310 01 DH-DETAIL-LINE1.                                              02431000
024400    05  FILLER                   PIC X(01)   VALUE SPACES.        02440000
024500    05  DH-ACCOUNT               PIC X(07)   VALUE SPACES.        02450000
024600    05  FILLER                   PIC X(02)   VALUE SPACES.        02460000
024700    05  DH-PO-DUNNS              PIC X(09)   VALUE SPACES.        02470000
024800    05  FILLER                   PIC X(03)   VALUE SPACES.        02480000
024900    05  DH-PO-NUMBER             PIC X(10)   VALUE SPACES.        02490000
025000    05  FILLER                   PIC X(02)   VALUE SPACES.        02500000
025100    05  DH-DEBIT-TOTAL           PIC ---,---,---.99.              02510000
025200    05  FILLER                   PIC X(02)   VALUE SPACES.        02520000
025300    05  DH-DM-MONTH              PIC 9(02)   VALUE ZEROS.         02530000
025400    05  FILLER                   PIC X(01)   VALUE '-'.           02540000
025500    05  DH-DM-DAY                PIC 9(02)   VALUE ZEROS.         02550000
025600    05  FILLER                   PIC X(01)   VALUE '-'.           02560000
025700    05  DH-DM-YEAR               PIC 9(02)   VALUE ZEROS.         02570000
025800    05  FILLER                   PIC X(04)   VALUE SPACES.        02580000
025900    05  DH-CREDIT-TOTAL          PIC ---,---,---.99.              02590000
026000    05  FILLER                   PIC X(02)   VALUE SPACES.        02600000
026100    05  DH-CM-MONTH              PIC 9(02)   VALUE ZEROS.         02610000
026200    05  FILLER                   PIC X(01)   VALUE '-'.           02620000
026300    05  DH-CM-DAY                PIC 9(02)   VALUE ZEROS.         02630000
026400    05  FILLER                   PIC X(01)   VALUE '-'.           02640000
026500    05  DH-CM-YEAR               PIC 9(02)   VALUE ZEROS.         02650000
026600    05  FILLER                   PIC X(04)   VALUE SPACES.        02660000
026700    05  DH-JN-MONTH              PIC 9(02)   VALUE ZEROS.         02670000
026800    05  FILLER                   PIC X(01)   VALUE '-'.           02680000
026900    05  DH-JN-DAY                PIC 9(02)   VALUE ZEROS.         02690000
027000    05  FILLER                   PIC X(01)   VALUE '-'.           02700000
027100    05  DH-JN-YEAR               PIC 9(02)   VALUE ZEROS.         02710000
027200    05  FILLER                   PIC X(03)   VALUE SPACES.        02720000
027300    05  DH-INV                   PIC ---,---,---.99.              02730000
027400    05  FILLER                   PIC X(02)   VALUE SPACES.        02740000
027500    05  DH-PPR                   PIC ---,---,---.99.              02750000
027501    05  FILLER                   PIC X(01)   VALUE SPACE.         02750100
027510                                                                  02751000
027600 01 EOR-END-OF-REPORT.                                            02760000
027610    05  FILLER                   PIC X(54)   VALUE SPACES.        02761000
027620    05  FILLER                   PIC X(25)   VALUE                02762000
027630        '***** END OF REPORT *****'.                              02763000
027640    05  FILLER                   PIC X(53)   VALUE SPACES.        02764000
027650                                                                  02765000
027700 01 DT-HOLD-TOTAL.                                                02770000
027800    05  DT-ACCOUNT               PIC X(07)   VALUE SPACES.        02780000
027900    05  DT-PO-DUNNS              PIC X(09)   VALUE SPACES.        02790000
028000    05  DT-PO-NUMBER             PIC 9(09)   VALUE ZEROS.         02800000
028100    05  DT-DEBIT-TOTAL           PIC S9(11)V99 VALUE ZEROS.       02810000
028200    05  DT-DM-MONTH              PIC 9(02)   VALUE ZEROS.         02820000
028300    05  DT-DM-DAY                PIC 9(02)   VALUE ZEROS.         02830000
028400    05  DT-DM-YEAR               PIC 9(02)   VALUE ZEROS.         02840000
028500    05  DT-CREDIT-TOTAL          PIC S9(11)V99 VALUE ZEROS.       02850000
028600    05  DT-CM-MONTH              PIC 9(02)   VALUE ZEROS.         02860000
028700    05  DT-CM-DAY                PIC 9(02)   VALUE ZEROS.         02870000
028800    05  DT-CM-YEAR               PIC 9(02)   VALUE ZEROS.         02880000
028900    05  DT-JN-MONTH              PIC 9(02)   VALUE ZEROS.         02890000
029000    05  DT-JN-DAY                PIC 9(02)   VALUE ZEROS.         02900000
029100    05  DT-JN-YEAR               PIC 9(02)   VALUE ZEROS.         02910000
029200    05  DT-INV                   PIC S9(11)V99 VALUE ZEROS.       02920000
029300    05  DT-PPR                   PIC S9(11)V99 VALUE ZEROS.       02930000
029400                                                                  02940000
029500 01 HH-HOLD-DATE.                                                 02950000
029600    05  HH-DM-MONTH              PIC 9(02)   VALUE ZEROS.         02960000
029700    05  HH-DM-DAY                PIC 9(02)   VALUE ZEROS.         02970000
029800    05  HH-DM-YEAR               PIC 9(02)   VALUE ZEROS.         02980000
029900    05  HH-CM-MONTH              PIC 9(02)   VALUE ZEROS.         02990000
030000    05  HH-CM-DAY                PIC 9(02)   VALUE ZEROS.         03000000
030100    05  HH-CM-YEAR               PIC 9(02)   VALUE ZEROS.         03010000
030200    05  HH-JN-MONTH              PIC 9(02)   VALUE ZEROS.         03020000
030300    05  HH-JN-DAY                PIC 9(02)   VALUE ZEROS.         03030000
030400    05  HH-JN-YEAR               PIC 9(02)   VALUE ZEROS.         03040000
030500                                                                  03050000
030510*----------------------------------------------------------------*03051000
030520* DB2 ABEND AREA                                                 *03052000
030530*----------------------------------------------------------------*03053000
030540 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO.          03054000
030550     88  AC-BAD-DATA                         VALUE +4003.         03055000
030560     88  AC-DB2-ERROR                        VALUE +4013.         03056000
030570                                                                  03057000
030580 01  ABEND-AREAS.                                                 03058000
030590     05  AA-ABEND-LIT            PIC X(40)   VALUE                03059000
030591           '*****       ABEND'.                                   03059100
030592     05  AA-PROGRAM-LIT          PIC X(40)   VALUE                03059200
030593             '*****   PROGRAM:         '.                         03059300
030594     05  AA-PARAGRAPH-LIT.                                        03059400
030595         10  FILLER              PIC X(17)   VALUE                03059500
030596             '***** PARAGRAPH: '.                                 03059600
030597         10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        03059700
030598     05  AA-MESSAGE-LINE.                                         03059800
030599         10  FILLER              PIC X(06)   VALUE '*****'.       03059900
030600         10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        03060000
030601     05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                03060100
030602             '*****    DB2 ERROR'.                                03060200
030603     05  AA-DB2-OPERATION-LIT.                                    03060300
030604         10  FILLER              PIC X(17)  VALUE                 03060400
030605             '***** OPERATION: '.                                 03060500
030606         10  AA-DB2-OPERATION.                                    03060600
030607             15  AA-DB2-OP-1     PIC X(25)  VALUE SPACES.         03060700
030608             15  AA-DB2-OP-2     PIC X(25)  VALUE SPACES.         03060800
030609     05  AA-DB2-TABLE-1          PIC X(08)  VALUE SPACES.         03060900
030610     05  AA-DB2-TABLE-2          PIC X(08)  VALUE SPACES.         03061000
030611     05  AA-DB2-TABLE-3          PIC X(08)  VALUE SPACES.         03061100
030612     05  AA-DB2-TABLE-4          PIC X(08)  VALUE SPACES.         03061200
030613                                                                  03061300
030614*----------------------------------------------------------------*03061400
030615* EXTERNAL ENTERPRISE TABLE                                      *03061500
030616*----------------------------------------------------------------*03061600
030617     EXEC SQL                                                     03061700
030618        INCLUDE TEXTENT                                           03061800
030619     END-EXEC.                                                    03061900
030620                                                                  03062000
030621*----------------------------------------------------------------*03062100
030622* AP PAYMENT CONTROL TABLE                                       *03062200
030623*----------------------------------------------------------------*03062300
030624     EXEC SQL                                                     03062400
030625        INCLUDE TAPCNTL                                           03062500
030626     END-EXEC.                                                    03062600
030627                                                                  03062700
030628*----------------------------------------------------------------*03062800
030629* PURCHASE ORDER HEADER TABLE                                    *03062900
030630*----------------------------------------------------------------*03063000
030631     EXEC SQL                                                     03063100
030632        INCLUDE TPURCHS                                           03063200
030633     END-EXEC.                                                    03063300
030634                                                                  03063400
030635*----------------------------------------------------------------*03063500
030636* INVOICE TABLE                                                  *03063600
030637*----------------------------------------------------------------*03063700
030638     EXEC SQL                                                     03063800
030639        INCLUDE TINVOIC                                           03063900
030640     END-EXEC.                                                    03064000
030641                                                                  03064100
030642*----------------------------------------------------------------*03064200
030643* AP CHARGE TYPE TABLE                                           *03064300
030644*----------------------------------------------------------------*03064400
030645     EXEC SQL                                                     03064500
030646        INCLUDE TACCTYP                                           03064600
030647     END-EXEC.                                                    03064700
030648                                                                  03064800
030649*----------------------------------------------------------------*03064900
030650* MERCHANDISE INVOICE TABLE                                      *03065000
030651*----------------------------------------------------------------*03065100
030652     EXEC SQL                                                     03065200
030653        INCLUDE TMDINVC                                           03065300
030654     END-EXEC.                                                    03065400
030655                                                                  03065500
030656*----------------------------------------------------------------*03065600
030657* VENDOR/DEPARTMENT TABLE                                        *03065700
030658*----------------------------------------------------------------*03065800
030659     EXEC SQL                                                     03065900
030660        INCLUDE TVNDDPT                                           03066000
030661     END-EXEC.                                                    03066100
030662                                                                  03066200
030663*----------------------------------------------------------------*03066300
030664* DB2 COMMUNCATIONS                                              *03066400
030665*----------------------------------------------------------------*03066500
030666     EXEC SQL                                                     03066600
030667        INCLUDE SQLCA                                             03066700
030668     END-EXEC.                                                    03066800
030669                                                                  03066900
030670*----------------------------------------------------------------*03067000
030700* CURSOR DECLARATIONS                                            *03070000
030800*----------------------------------------------------------------*03080000
030900     EXEC SQL                                                     03090000
031000         DECLARE INVOICE_CSR CURSOR FOR                           03100000
031100              SELECT                                              03110000
031200                   I.PO_NBR                                       03120000
031300                  ,I.GRO_COST_AMT                                 03130000
031400                  ,'     '                                        03140000
031500                  ,I.INVC_ID                                      03150000
031600                  ,I.PPD_RVRSL_IND                                03160000
031700              FROM TINVOIC I                                      03170000
031800                  ,TMDINVC A                                      03180000
031900                  ,TACCTYP T                                      03190000
032000              WHERE I.PO_NBR = A.PO_NBR                           03200000
032200                AND I.INVC_ID = A.INVC_ID                         03220000
032300                AND A.IMPRT_CHRG_PRC_CDE = T.ALW_CHRG_CDE         03230000
032400                AND I.INVC_TYP_CDE = 'MI'                         03240000
032500                AND I.STATUS_CDE ^= 'DE'                          03250000
032510                AND I.STATUS_CDE ^= 'PR'                          03251000
032600                AND I.CRE_DTE >= :PV-FIRST-FISCAL-DATE            03260000
032602                AND I.CRE_DTE <= :PV-LAST-FISCAL-DATE             03260200
032800                AND T.GL_ACCT_NBR = :WS-DB2-ACCOUNT2              03280000
032900                ORDER BY I.PO_NBR                                 03290000
033000     END-EXEC.                                                    03300000
033100                                                                  03310000
033200*-------------------------*                                       03320000
033300 PROCEDURE DIVISION.                                              03330000
033400*-------------------------*                                       03340000
033500 0000-MAINLINE-PROCESSING.                                        03350000
033600                                                                  03360000
033700     PERFORM B100-INITIALIZATION.                                 03370000
033800     PERFORM B200-PROCESS-EXTRACT                                 03380000
033900             UNTIL END-OF-FILE-IMPORT AND                         03390000
034000                   PS-NO-MORE-TINVOIC.                            03400000
034200     PERFORM W100-WRITE-WORK-REPORT-FILE.                         03420000
034201     PERFORM W400-WRITE-END-OF-REPORT.                            03420100
034210     PERFORM B300-TERMINATION.                                    03421000
034700     STOP RUN.                                                    03470000
034710                                                                  03471000
034800*----------------------------------------------------------------*03480000
034810* INITIALIZATION PROCESSING                                      *03481000
034820*----------------------------------------------------------------*03482000
034900 B100-INITIALIZATION.                                             03490000
035000                                                                  03500000
035100     ACCEPT CONTROL-CARD.                                         03510000
035101     MOVE CC-ACCOUNT               TO HDR1-ACCOUNT.               03510100
035102     ACCEPT SYSTEM-DATE FROM DATE.                                03510200
035103     MOVE SYSTEM-YEAR              TO DP132O-RUN-YEAR.            03510300
035104     MOVE SYSTEM-MONTH             TO DP132O-RUN-MONTH.           03510400
035105     MOVE SYSTEM-DAY               TO DP132O-RUN-DAY.             03510500
035106     ACCEPT SYSTEM-TIME FROM TIME.                                03510600
035107     MOVE SYSTEM-HOUR              TO DP132O-RUN-HOUR.            03510700
035108     MOVE SYSTEM-MINUTE            TO DP132O-RUN-MINUTE.          03510800
035109     MOVE PC-PROGRAM-NAME          TO DP132O-PROGRAM-NAME.        03510900
035110     IF HDR1-ACCOUNT = '10303'                                    03511000
035120         MOVE 1                    TO DP132O-REPORT-NUMBER        03512001
035121     ELSE                                                         03512100
035122         MOVE 2                    TO DP132O-REPORT-NUMBER        03512201
035123     END-IF.                                                      03512300
035124     DISPLAY 'RUN DATE = ' SYSTEM-DATE.                           03512400
035125     DISPLAY 'RUN TIME = ' SYSTEM-TIME.                           03512500
035126                                                                  03512600
035127     OPEN INPUT  DETAIL-IMPORT-FILE-PJ                            03512700
035200                 DETAIL-ACCT-IMPORT-FILE-PJ                       03520000
035300          OUTPUT WORK-REPORT-FILE                                 03530000
035301                 SUMMARY-REPORT-FILE.                             03530100
035310                                                                  03531000
035320     INITIALIZE DCLTINVOIC                                        03532000
035330                DCLTMDINVC                                        03533000
035340                DCLTACCTYP                                        03534000
035350                DCLTVNDDPT                                        03535000
035360                DCLTPURCHS                                        03536000
035400                DCLTEXTENT                                        03540000
035500                DCLTAPCNTL.                                       03550000
035510                                                                  03551000
035720     PERFORM S100-SELECT-PREV-FISCAL-DATA.                        03572000
035730     PERFORM S200-GET-FIRST-LAST-FISCAL-DT.                       03573000
035731                                                                  03573100
035733     MOVE PV-FIRST-FISCAL-DATE(1:4)           TO HDR2-START-YYYY. 03573300
035736     MOVE PV-FIRST-FISCAL-DATE(6:2)           TO HDR2-START-MM.   03573600
035739     MOVE PV-FIRST-FISCAL-DATE(9:2)           TO HDR2-START-DD.   03573900
035742     MOVE PV-LAST-FISCAL-DATE(1:4)            TO HDR2-END-YYYY.   03574200
035744     MOVE PV-LAST-FISCAL-DATE(6:2)            TO HDR2-END-MM.     03574400
035746     MOVE PV-LAST-FISCAL-DATE(9:2)            TO HDR2-END-DD.     03574600
035753     PERFORM W200-WRITE-REPORT-HEADERS.                           03575300
035754                                                                  03575400
035760     PERFORM S300-GET-ACCT-IMPORT-DATA.                           03576000
035800     PERFORM R100-READ-EXTRACT-FILE-PJ.                           03580000
036000     MOVE AP047-GL-ACCT-NBR    TO WS-HOLD-ACCT.                   03600000
036100     MOVE WS-HOLD-ACCT         TO WS-DB2-ACCT.                    03610000
037400     MOVE WS-DB2-ACCOUNT       TO WS-DB2-ACCOUNT2.                03740000
037500     PERFORM Y100-OPEN-INVOICE-CSR.                               03750000
037600     PERFORM S400-FETCH-INVOICE-CSR.                              03760000
037700                                                                  03770000
037800     IF INVOIC-PO-NBR > WS-DETAIL-PONUM                           03780000
037900        IF INVOIC-PO-NBR = ZEROS                                  03790000
038000           MOVE ZEROS            TO WS-PO-HOLD                    03800000
038100        ELSE                                                      03810000
038200           MOVE INVOIC-PO-NBR    TO WS-PO-HOLD                    03820000
038300        END-IF                                                    03830000
038400     ELSE                                                         03840000
038500        IF WS-DETAIL-PONUM = ZEROS                                03850000
038600           MOVE ZEROS            TO WS-PO-HOLD                    03860000
038700        ELSE                                                      03870000
038800           MOVE WS-DETAIL-PONUM  TO WS-PO-HOLD                    03880000
038900        END-IF                                                    03890000
039000     END-IF.                                                      03900000
039100                                                                  03910000
039110*----------------------------------------------------------------*03911000
039120* THIS ROUTINE HOLDS THE MAIN LOGIC FOR PROCESSING THE OUTPUT    *03912000
039130*----------------------------------------------------------------*03913000
039200 B200-PROCESS-EXTRACT.                                            03920000
039300                                                                  03930000
039400     EVALUATE TRUE                                                03940000
039500     WHEN INVOIC-PO-NBR = WS-DETAIL-PONUM                         03950000
039600        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            03960000
039700        PERFORM S800-READ-DUNNS-NBR                               03970000
039800        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            03980000
039900        MOVE INVOIC-GRO-COST-AMT        TO DT-INV                 03990000
040000        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04000000
040100        MOVE INVOIC-PO-NBR              TO DT-PO-NUMBER           04010000
040700        IF AP047-AP-TRN-CDE = '68' OR '73'                        04070000
040800           MOVE AP047-GRO-COST-AMT      TO DT-DEBIT-TOTAL         04080000
040900           ADD  AP047-GRO-COST-AMT      TO WS-DM-TOTAL            04090000
041000        ELSE                                                      04100000
041100           MOVE INVOIC-PO-NBR           TO WS-INVOIC-PO-NBR       04110000
041310           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04131000
041320              MOVE AP047-GRO-COST-AMT   TO DT-PPR                 04132000
041330           END-IF                                                 04133000
041600           MOVE AP047-GRO-COST-AMT      TO DT-CREDIT-TOTAL        04160000
041700           ADD  AP047-GRO-COST-AMT      TO WS-CM-TOTAL            04170000
041800        END-IF                                                    04180000
041900        PERFORM S500-GET-DATE-ACTUAL                              04190000
042100        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   04210000
042200           PERFORM S600-GET-JRNL-DATE                             04220000
042300        END-IF                                                    04230000
042400        MOVE HH-DM-MONTH                TO DT-DM-MONTH            04240000
042500        MOVE HH-DM-DAY                  TO DT-DM-DAY              04250000
042600        MOVE HH-DM-YEAR                 TO DT-DM-YEAR             04260000
042700        MOVE HH-CM-MONTH                TO DT-CM-MONTH            04270000
042800        MOVE HH-CM-DAY                  TO DT-CM-DAY              04280000
042900        MOVE HH-CM-YEAR                 TO DT-CM-YEAR             04290000
043000        MOVE HH-JN-MONTH                TO DT-JN-MONTH            04300000
043100        MOVE HH-JN-DAY                  TO DT-JN-DAY              04310000
043200        MOVE HH-JN-YEAR                 TO DT-JN-YEAR             04320000
043300        PERFORM W100-WRITE-WORK-REPORT-FILE                       04330000
043400        PERFORM R100-READ-EXTRACT-FILE-PJ                         04340000
043500        PERFORM S400-FETCH-INVOICE-CSR                            04350000
043600      WHEN INVOIC-PO-NBR > WS-DETAIL-PONUM                        04360000
043800        IF AP047-ENT-NME-DESC = SPACES                            04380000
043900           MOVE ZEROS                   TO DT-PO-NUMBER           04390000
044000        ELSE                                                      04400000
044100           MOVE WS-DETAIL-PONUM         TO DT-PO-NUMBER           04410000
044200        END-IF                                                    04420000
044400        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   04440000
044500           PERFORM S600-GET-JRNL-DATE                             04450000
044600        END-IF                                                    04460000
044700        PERFORM S500-GET-DATE-ACTUAL                              04470000
044800        MOVE HH-DM-MONTH                TO DT-DM-MONTH            04480000
044900        MOVE HH-DM-DAY                  TO DT-DM-DAY              04490000
045000        MOVE HH-DM-YEAR                 TO DT-DM-YEAR             04500000
045100        MOVE HH-CM-MONTH                TO DT-CM-MONTH            04510000
045200        MOVE HH-CM-DAY                  TO DT-CM-DAY              04520000
045300        MOVE HH-CM-YEAR                 TO DT-CM-YEAR             04530000
045400        MOVE HH-JN-MONTH                TO DT-JN-MONTH            04540000
045500        MOVE HH-JN-DAY                  TO DT-JN-DAY              04550000
045600        MOVE HH-JN-YEAR                 TO DT-JN-YEAR             04560000
045700        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04570000
046100        IF AP047-AP-TRN-CDE = '68' OR '73'                        04610000
046400           MOVE AP047-GRO-COST-AMT      TO DT-DEBIT-TOTAL         04640000
046500           ADD AP047-GRO-COST-AMT       TO WS-DM-TOTAL            04650000
046600        ELSE                                                      04660000
046700           MOVE WS-DETAIL-PONUM         TO WS-INVOIC-PO-NBR       04670000
046910           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04691000
046920              MOVE AP047-GRO-COST-AMT   TO DT-PPR                 04692000
046930           END-IF                                                 04693000
047200           MOVE AP047-GRO-COST-AMT      TO DT-CREDIT-TOTAL        04720000
047300           ADD AP047-GRO-COST-AMT       TO WS-CM-TOTAL            04730000
047400        END-IF                                                    04740000
047600        MOVE AP047-ENT-NME-DESC(1:9)    TO WS-DT-PONUM            04760000
047700        PERFORM S800-READ-DUNNS-NBR                               04770000
047800        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            04780000
047900        PERFORM W100-WRITE-WORK-REPORT-FILE                       04790000
048000        PERFORM R100-READ-EXTRACT-FILE-PJ                         04800000
048100      WHEN INVOIC-PO-NBR < WS-DETAIL-PONUM                        04810000
048200        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            04820000
048300        PERFORM S800-READ-DUNNS-NBR                               04830000
048400        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            04840000
048500        MOVE INVOIC-PO-NBR              TO DT-PO-NUMBER           04850000
048600        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04860000
048700        MOVE INVOIC-GRO-COST-AMT        TO DT-INV                 04870000
048800        MOVE INVOIC-PO-NBR              TO WS-INVOIC-PO-NBR       04880000
049010        IF INVOIC-PPD-RVRSL-IND = 'Y'                             04901000
049020           MOVE AP047-GRO-COST-AMT      TO DT-PPR                 04902000
049030        END-IF                                                    04903000
049100        PERFORM W100-WRITE-WORK-REPORT-FILE                       04910000
049200        PERFORM S400-FETCH-INVOICE-CSR                            04920000
049300      END-EVALUATE.                                               04930000
049400                                                                  04940000
049500*----------------------------------------------------------------*04950000
049600* END OF PROGRAM PROCESSING                                      *04960000
049700*----------------------------------------------------------------*04970000
049800 B300-TERMINATION.                                                04980000
049900                                                                  04990000
050000     DISPLAY '*************************************************'. 05000000
050100     DISPLAY '**            APKRP243 RECORD COUNTS           **'. 05010000
050200     DISPLAY '*************************************************'. 05020000
050300     DISPLAY 'TOTAL IMPORT RECORDS READ = ' PV-IMPORT-READ-CNT.   05030000
050400     DISPLAY 'TOTAL ACCT RECORDS READ   = ' PV-ACCT-READ-CNT.     05040000
050500     DISPLAY 'TOTAL RECORDS WRITTEN     = ' PV-WRITTEN-CNT.       05050000
050600     DISPLAY '*************************************************'. 05060000
050700     DISPLAY '*************************************************'. 05070000
050800                                                                  05080000
050900     PERFORM Y200-CLOSE-INVOICE-CSR.                              05090000
051000     CLOSE DETAIL-IMPORT-FILE-PJ                                  05100000
051100           DETAIL-ACCT-IMPORT-FILE-PJ                             05110000
051200           WORK-REPORT-FILE                                       05120000
051210           SUMMARY-REPORT-FILE.                                   05121000
051300                                                                  05130000
062401*----------------------------------------------------------------*06240100
062402* READS THE INPUT FILE                                           *06240200
062403*----------------------------------------------------------------*06240300
062404 R100-READ-EXTRACT-FILE-PJ.                                       06240400
062405                                                                  06240500
062406     READ DETAIL-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE        06240600
062407           AT END                                                 06240700
062408              SET END-OF-FILE-IMPORT TO TRUE                      06240800
062409              MOVE '9999999'         TO AP047-ENT-NME-DESC        06240900
062410           NOT AT END                                             06241000
062411              ADD 1                  TO PV-IMPORT-READ-CNT.       06241100
062412                                                                  06241200
062413     MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DETAIL-PONUM.          06241300
062414     IF END-OF-FILE-IMPORT                                        06241400
062415        MOVE 999999999               TO WS-DETAIL-PONUM           06241500
062416     END-IF.                                                      06241600
062417                                                                  06241700
062418*----------------------------------------------------------------*06241800
062420* READS THE INPUT FILE CONTAINING ACCOUNT DATA                   *06242000
062430*----------------------------------------------------------------*06243000
062500 R200-READ-ACCT-IMPORT.                                           06250000
062600                                                                  06260000
062700     READ DETAIL-ACCT-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE   06270000
062800          AT END                                                  06280000
062810             SET END-OF-FILE-ACCT     TO TRUE                     06281000
062900          NOT AT END                                              06290000
063000             ADD 1                    TO PV-ACCT-READ-CNT.        06300000
063100                                                                  06310000
063200     MOVE AP047-ENT-NME-DESC (1:9)    TO ACCT-PO (X1).            06320000
063400     MOVE AP047-ENT-NME-DESC (10:10)  TO ACCT-DATE (X1).          06340000
063500                                                                  06350000
063510*----------------------------------------------------------------*06351000
063520* SELECT THE PREVIOUS FISCAL PERIOD AND YEAR FROM THE TAPCNTL    *06352000
063521* TABLE                                                          *06352100
063530*----------------------------------------------------------------*06353000
063540 S100-SELECT-PREV-FISCAL-DATA.                                    06354000
063550                                                                  06355000
063560     EXEC SQL                                                     06356000
063561       SELECT PREV_PSTG_FYR_NBR                                   06356100
063562            , PREV_PSTG_FMN_NBR                                   06356200
063563         INTO :APCNTL-PREV-PSTG-FYR-NBR                           06356300
063564            , :APCNTL-PREV-PSTG-FMN-NBR                           06356400
063565         FROM TAPCNTL                                             06356500
063570     END-EXEC.                                                    06357000
063580                                                                  06358000
063590     EVALUATE TRUE                                                06359000
063591       WHEN SQLCODE = ZERO                                        06359100
063592         CONTINUE                                                 06359200
063593       WHEN SQLWARN0 NOT = SPACES                                 06359300
063594       WHEN SQLCODE NOT = ZERO                                    06359400
063595         MOVE 'S100-SELECT-PREV-FISCAL-DATA' TO AA-PARAGRAPH-NAME 06359500
063596         MOVE 'UNSUCCESSFUL SELECT'          TO AA-DB2-OPERATION  06359600
063597         MOVE 'TAPCNTL'                      TO AA-DB2-TABLE-1    06359700
063598         MOVE SPACES                         TO AA-DB2-TABLE-2    06359800
063599                                                AA-DB2-TABLE-3    06359900
063600                                                AA-DB2-TABLE-4    06360000
063601         PERFORM Z999-DB2-ABEND                                   06360100
063602     END-EVALUATE.                                                06360200
063603                                                                  06360300
063610*----------------------------------------------------------------*06361000
063620* USE THE KOHLS CALENDAR ROUTINE TO GET THE FIRST AND LAST       *06362000
063621* FISCAL DATE OF THE PREVIOUS PERIOD                             *06362100
063630*----------------------------------------------------------------*06363000
063631 S200-GET-FIRST-LAST-FISCAL-DT.                                   06363100
063632                                                                  06363200
063633     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         06363300
063634                                                                  06363400
063635     SET DPG51-FISCAL-454-CALENDAR    TO TRUE.                    06363500
063636     SET DPG52-LK-DTE-FISC-PRD-CC     TO TRUE.                    06363600
063638     MOVE APCNTL-PREV-PSTG-FYR-NBR    TO DPG52-FISCAL-CC-PRD-YR.  06363800
063639     MOVE APCNTL-PREV-PSTG-FMN-NBR    TO DPG52-FISCAL-CC-PRD-PP.  06363900
063640                                                                  06364000
063641     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06364100
063642                                             DPG54 DPG55 DPG56.   06364200
063643                                                                  06364300
063644     IF DPG54-NO-ERROR                                            06364400
063645        DISPLAY 'PERIOD START DATE: ' DPG56-FIRST-FP-DB2-ISO-FMT  06364500
063646        DISPLAY 'PERIOD END DATE: ' DPG56-LAST-FP-DB2-ISO-FMT     06364600
063647        MOVE DPG56-FIRST-FP-DB2-ISO-FMT  TO PV-FIRST-FISCAL-DATE  06364700
063649        MOVE DPG56-LAST-FP-DB2-ISO-FMT   TO PV-LAST-FISCAL-DATE   06364900
063652     ELSE                                                         06365200
063653        MOVE 'S200-GET-FIRST-LAST-FISCAL-DT'                      06365300
063654                                         TO AA-PARAGRAPH-NAME     06365400
063655        MOVE DPG54-ERROR-MESSAGE         TO AA-MESSAGE            06365500
063656        SET AC-BAD-DATA                  TO TRUE                  06365600
063657        PERFORM Z999-DB2-ABEND                                    06365700
063658     END-IF.                                                      06365800
063659                                                                  06365900
063660*----------------------------------------------------------------*06366000
063700* STORES THE ACCOUNT IMPORT DATA INTO INTERNAL TABLE             *06370000
063800*----------------------------------------------------------------*06380000
063900 S300-GET-ACCT-IMPORT-DATA.                                       06390000
064000                                                                  06400000
064100     SET X1 TO 1.                                                 06410000
064200     PERFORM R200-READ-ACCT-IMPORT                                06420000
064300             VARYING X1 FROM 1 BY 1                               06430000
064400             UNTIL END-OF-FILE-ACCT.                              06440000
064600     MOVE WS-HD-PO         TO ACCT-PO (X1).                       06460000
064700     MOVE WS-HD-DATE       TO ACCT-DATE (X1).                     06470000
064800     INITIALIZE AP047-GL-EXTRACT-FILE.                            06480000
064900                                                                  06490000
079310*----------------------------------------------------------------*07931000
079320* FETCH THE INVOICE_CSR CURSOR                                   *07932000
079330*----------------------------------------------------------------*07933000
079400 S400-FETCH-INVOICE-CSR.                                          07940000
079500                                                                  07950000
080100     PERFORM WITH TEST AFTER                                      08010000
080200        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      08020000
080300        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              08030000
080400                SQLCODE = ZERO OR                                 08040000
080500                SQLCODE = +100                                    08050000
080600        EXEC SQL                                                  08060000
080700           FETCH INVOICE_CSR                                      08070000
080800               INTO   :INVOIC-PO-NBR                              08080000
081000                    , :INVOIC-GRO-COST-AMT                        08100000
081100                    , :WS-REQ-ENTR-TRMNL-ID                       08110000
081200                    , :INVOIC-INVC-ID                             08120000
081210                    , :INVOIC-PPD-RVRSL-IND                       08121000
081300        END-EXEC                                                  08130000
081400                                                                  08140000
081500        EVALUATE TRUE                                             08150000
081600            WHEN SQLCODE = ZERO                                   08160000
081700            WHEN SQLCODE = -904                                   08170000
081800            WHEN SQLCODE = -913                                   08180000
081900                 CONTINUE                                         08190000
082000            WHEN SQLCODE = +100                                   08200000
082100                 SET PS-NO-MORE-TINVOIC  TO TRUE                  08210000
082200                 MOVE 999999999          TO INVOIC-PO-NBR         08220000
082300            WHEN SQLWARN0 NOT = SPACES                            08230000
082400            WHEN SQLCODE  NOT = ZERO                              08240000
082500                 MOVE 'S400-FETCH-INVOICE-CSR'                    08250000
082600                                            TO AA-PARAGRAPH-NAME  08260000
082700                 MOVE 'UNSUCCESSFUL FETCH'  TO AA-DB2-OPERATION   08270000
082900                 MOVE 'TINVOIC'             TO AA-DB2-TABLE-1     08290000
083000                 MOVE 'TMDINVC'             TO AA-DB2-TABLE-2     08300000
083010                 MOVE 'TACCTYP'             TO AA-DB2-TABLE-3     08301000
083020                 MOVE SPACES                TO AA-DB2-TABLE-4     08302000
083100                 PERFORM Z999-DB2-ABEND                           08310000
083200        END-EVALUATE                                              08320000
083300     END-PERFORM.                                                 08330000
083400                                                                  08340000
083500     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         08350000
083600         MOVE 'S400-FETCH-INVOICE-CSR'  TO AA-PARAGRAPH-NAME      08360000
083800         MOVE 'MAX RETRIES EXCEEDED ON FETCH TINVOIC'             08380000
083900                                        TO AA-DB2-OPERATION       08390000
084000         PERFORM Z999-DB2-ABEND                                   08400000
084100     END-IF.                                                      08410000
084200                                                                  08420000
084300     EVALUATE TRUE                                                08430000
084400        WHEN SQLCODE = ZEROS                                      08440000
084500        WHEN SQLCODE = +100                                       08450000
084600             CONTINUE                                             08460000
084700        WHEN OTHER                                                08470000
084800             MOVE 'S400-FETCH-INVOICE-CSR' TO AA-PARAGRAPH-NAME   08480000
085000             MOVE 'UNSUCCESSFUL FETCH'     TO AA-DB2-OPERATION    08500000
085200             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      08520000
085300             MOVE 'TMDINVC'                TO AA-DB2-TABLE-2      08530000
085310             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      08531000
085320             MOVE SPACES                   TO AA-DB2-TABLE-4      08532000
085400             PERFORM Z999-DB2-ABEND                               08540000
085500     END-EVALUATE.                                                08550000
085600                                                                  08560000
085601*----------------------------------------------------------------*08560100
085602* GET THE DEBIT, CREDIT, OR JOURNAL DATE                         *08560200
085603*----------------------------------------------------------------*08560300
085604 S500-GET-DATE-ACTUAL.                                            08560400
085605                                                                  08560500
085606     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55,  DPG56.        08560600
085607                                                                  08560700
085608     IF AP047-AP-TRN-CDE = '68' OR '73'                           08560800
085609        MOVE AP047-ENT-NME-DESC(15:2)    TO HH-DM-MONTH           08560900
085610        MOVE AP047-ENT-NME-DESC(18:2)    TO HH-DM-DAY             08561000
085611        MOVE AP047-ENT-NME-DESC(12:2)    TO HH-DM-YEAR            08561100
085612        MOVE ZEROS                       TO HH-CM-MONTH           08561200
085613        MOVE ZEROS                       TO HH-CM-DAY             08561300
085614        MOVE ZEROS                       TO HH-CM-YEAR            08561400
085615        IF AP047-GL-ACCT-NBR = '10301 '                           08561500
085616           MOVE AP047-ENT-NME-DESC(15:2) TO HH-JN-MONTH           08561600
085617           MOVE AP047-ENT-NME-DESC(18:2) TO HH-JN-DAY             08561700
085618           MOVE AP047-ENT-NME-DESC(12:2) TO HH-JN-YEAR            08561800
085619        END-IF                                                    08561900
085620     ELSE                                                         08562000
085621        MOVE AP047-ENT-NME-DESC(15:2)    TO HH-CM-MONTH           08562100
085622        MOVE AP047-ENT-NME-DESC(18:2)    TO HH-CM-DAY             08562200
085623        MOVE AP047-ENT-NME-DESC(12:2)    TO HH-CM-YEAR            08562300
085624        MOVE ZEROS                       TO HH-DM-MONTH           08562400
085625        MOVE ZEROS                       TO HH-DM-DAY             08562500
085626        MOVE ZEROS                       TO HH-DM-YEAR            08562600
085627     END-IF.                                                      08562700
085628                                                                  08562800
085629*----------------------------------------------------------------*08562900
085630* GET THE JOURNAL DATE                                           *08563000
085631*----------------------------------------------------------------*08563100
085632 S600-GET-JRNL-DATE.                                              08563200
085633                                                                  08563300
085634     PERFORM S700-SEARCH-ACCT-TABLE                               08563400
085635     MOVE WS-JN-DATE (6:2)        TO HH-JN-MONTH                  08563500
085636     MOVE WS-JN-DATE (9:2)        TO HH-JN-DAY                    08563600
085637     MOVE WS-JN-DATE (3:2)        TO HH-JN-YEAR.                  08563700
085638                                                                  08563800
085639*----------------------------------------------------------------*08563900
085640* SEARCHES THE INTERNAL ACCOUNT TABLE                            *08564000
085641*----------------------------------------------------------------*08564100
085642 S700-SEARCH-ACCT-TABLE.                                          08564200
085643                                                                  08564300
085644     SET X1 TO 1.                                                 08564400
085645     SEARCH ACCT-TABLE                                            08564500
085646         AT END                                                   08564600
085647            MOVE '0000-00-00'  TO WS-JN-DATE                      08564700
085648         WHEN AP047-ENT-NME-DESC (1:9) = ACCT-PO(X1)              08564800
085649            MOVE ACCT-DATE(X1) TO WS-JN-DATE                      08564900
085650     END-SEARCH.                                                  08565000
085651                                                                  08565100
085652*----------------------------------------------------------------*08565200
085653* GET THE DUNN NUMBER FROM THE TVNDDPT, TPURCHS, AND TEXTENT     *08565300
085654* TABLES                                                         *08565400
085655*----------------------------------------------------------------*08565500
085656 S800-READ-DUNNS-NBR.                                             08565600
085657                                                                  08565700
085662     EXEC SQL                                                     08566200
085663        SELECT C.DUN_NBR                                          08566300
085664        INTO :WS-DUNNS-NUMBER                                     08566400
085665        FROM TVNDDPT A                                            08566500
085666           , TPURCHS B                                            08566600
085667           , TEXTENT C                                            08566700
085668        WHERE A.ENT_ID = B.ENT_ID                                 08566800
085669          AND B.ENT_ID = C.ENT_ID                                 08566900
085670          AND B.PO_NBR = :WS-DT-PONUM                             08567000
085671          AND VER_STATUS_CDE = 'A'                                08567100
085672          AND A.DEPT_NBR = B.DEPT_NBR                             08567200
085673     END-EXEC.                                                    08567300
085674                                                                  08567400
085675     EVALUATE TRUE                                                08567500
085676         WHEN SQLCODE = ZERO                                      08567600
085679              CONTINUE                                            08567900
085680         WHEN SQLCODE = +100                                      08568000
085681              CONTINUE                                            08568100
085682         WHEN SQLWARN0 NOT = SPACES                               08568200
085683         WHEN SQLCODE  NOT = ZERO                                 08568300
085684             MOVE WS-DT-PONUM  TO PV-DISPLAY-PONUM                08568407
085685             DISPLAY 'WS-DT-PONUM ' PV-DISPLAY-PONUM              08568507
085686             MOVE 'S800-READ-DUNNS-NBR'   TO AA-PARAGRAPH-NAME    08568600
085687             MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION     08568700
085688             MOVE 'TVNDDPT'               TO AA-DB2-TABLE-1       08568800
085689             MOVE 'TEXTENT'               TO AA-DB2-TABLE-2       08568900
085690             MOVE 'TPURCHS'               TO AA-DB2-TABLE-3       08569000
085691             MOVE SPACES                  TO AA-DB2-TABLE-4       08569100
085692             PERFORM Z999-DB2-ABEND                               08569200
085693     END-EVALUATE.                                                08569300
085694                                                                  08569400
085695*----------------------------------------------------------------*08569500
085696* WRITE RECORD TO EXTRACT FILE                                   *08569600
085697*----------------------------------------------------------------*08569700
085698 W100-WRITE-WORK-REPORT-FILE.                                     08569800
085699                                                                  08569900
085700       IF DT-PO-NUMBER = WS-PO-HOLD                               08570000
085701          INITIALIZE DH-DETAIL-LINE1                              08570100
085702          MOVE  DT-ACCOUNT            TO DH-ACCOUNT               08570200
085703          MOVE  DT-PO-DUNNS           TO DH-PO-DUNNS              08570300
085704          MOVE  DT-PO-NUMBER          TO DH-PO-NUMBER             08570400
085705          ADD   DT-DEBIT-TOTAL        TO WS-DEBIT-TOTAL           08570500
085706          MOVE  WS-DEBIT-TOTAL        TO DH-DEBIT-TOTAL           08570600
085707          ADD   DT-CREDIT-TOTAL       TO WS-CREDIT-TOTAL          08570700
085708          MOVE  WS-CREDIT-TOTAL       TO DH-CREDIT-TOTAL          08570800
085709          MOVE  DT-PO-NUMBER          TO WS-INVOIC-PO-NBR         08570900
085710          ADD   DT-INV                TO WS-INV-TOTAL             08571000
085711          MOVE  WS-INV-TOTAL          TO DH-INV                   08571100
085712          IF INVOIC-PPD-RVRSL-IND = 'Y'                           08571200
085713             MOVE AP047-GRO-COST-AMT  TO DH-PPR                   08571300
085714          END-IF                                                  08571400
085715          IF  DT-DM-MONTH > 0 OR                                  08571500
085716              DT-DM-DAY   > 0 OR                                  08571600
085717              DT-DM-YEAR  > 0                                     08571700
085718               MOVE DT-DM-MONTH       TO DH-DM-MONTH              08571800
085719               MOVE DT-DM-DAY         TO DH-DM-DAY                08571900
085720               MOVE DT-DM-YEAR        TO DH-DM-YEAR               08572000
085721          END-IF                                                  08572100
085722          IF  DT-CM-MONTH > 0 OR                                  08572200
085723              DT-CM-DAY   > 0 OR                                  08572300
085724              DT-CM-YEAR  > 0                                     08572400
085725               MOVE DT-CM-MONTH       TO DH-CM-MONTH              08572500
085726               MOVE DT-CM-DAY         TO DH-CM-DAY                08572600
085727               MOVE DT-CM-YEAR        TO DH-CM-YEAR               08572700
085728          END-IF                                                  08572800
085729          IF  DT-JN-MONTH > 0 OR                                  08572900
085730              DT-JN-DAY   > 0 OR                                  08573000
085731              DT-JN-YEAR  > 0                                     08573100
085732               MOVE DT-JN-MONTH       TO DH-JN-MONTH              08573200
085733               MOVE DT-JN-DAY         TO DH-JN-DAY                08573300
085734               MOVE DT-JN-YEAR        TO DH-JN-YEAR               08573400
085735          END-IF                                                  08573500
085736          INITIALIZE DT-HOLD-TOTAL                                08573600
085737        ELSE                                                      08573700
085738          INITIALIZE WS-DEBIT-TOTAL                               08573800
085739          INITIALIZE WS-CREDIT-TOTAL                              08573900
085740          INITIALIZE WS-INV-TOTAL                                 08574000
085741                                                                  08574100
085742           IF DH-ACCOUNT   = SPACES  AND                          08574200
085743              DH-PO-DUNNS  = SPACES  AND                          08574300
085744              DH-PO-NUMBER = SPACES                               08574400
085745                 CONTINUE                                         08574500
085746           ELSE                                                   08574600
085747                 WRITE WR-WORK-REPORT-RECORD                      08574700
085748                 FROM DH-DETAIL-LINE1 AFTER 1                     08574800
085749                 PERFORM W300-WRITE-REPORT-DETAIL                 08574900
085750           END-IF                                                 08575000
085751                                                                  08575100
085752           MOVE DT-PO-NUMBER          TO WS-PO-HOLD               08575200
085753                                                                  08575300
085754           IF HH-DM-MONTH    =  DH-DM-MONTH AND                   08575400
085755              HH-DM-DAY      =  DH-DM-DAY   AND                   08575500
085756              HH-DM-YEAR     =  DH-DM-YEAR                        08575600
085757                 MOVE  0              TO HH-DM-MONTH              08575700
085758                 MOVE  0              TO HH-DM-DAY                08575800
085759                 MOVE  0              TO HH-DM-YEAR               08575900
085760           END-IF                                                 08576000
085761                                                                  08576100
085762           IF HH-CM-MONTH    =  DH-CM-MONTH AND                   08576200
085763              HH-CM-DAY      =  DH-CM-DAY   AND                   08576300
085764              HH-CM-YEAR     =  DH-CM-YEAR                        08576400
085765                 MOVE  0              TO HH-CM-MONTH              08576500
085766                 MOVE  0              TO HH-CM-DAY                08576600
085767                 MOVE  0              TO HH-CM-YEAR               08576700
085768           END-IF                                                 08576800
085769                                                                  08576900
085770           IF HH-JN-MONTH    =  DH-JN-MONTH AND                   08577000
085771              HH-JN-DAY      =  DH-JN-DAY   AND                   08577100
085772              HH-JN-YEAR     =  DH-JN-YEAR                        08577200
085773                 MOVE  0              TO HH-JN-MONTH              08577300
085774                 MOVE  0              TO HH-JN-DAY                08577400
085775                 MOVE  0              TO HH-JN-YEAR               08577500
085776           END-IF                                                 08577600
085777                                                                  08577700
085778           INITIALIZE DH-DETAIL-LINE1                             08577800
085779           MOVE  DT-ACCOUNT           TO DH-ACCOUNT               08577900
085780           MOVE  DT-PO-DUNNS          TO DH-PO-DUNNS              08578000
085781           MOVE  DT-PO-NUMBER         TO DH-PO-NUMBER             08578100
085782           ADD   DT-DEBIT-TOTAL       TO WS-DEBIT-TOTAL           08578200
085783           MOVE  WS-DEBIT-TOTAL       TO DH-DEBIT-TOTAL           08578300
085784           MOVE  DT-DM-MONTH          TO DH-DM-MONTH              08578400
085785           MOVE  DT-DM-DAY            TO DH-DM-DAY                08578500
085786           MOVE  DT-DM-YEAR           TO DH-DM-YEAR               08578600
085787           ADD   DT-CREDIT-TOTAL      TO WS-CREDIT-TOTAL          08578700
085788           MOVE  WS-CREDIT-TOTAL      TO DH-CREDIT-TOTAL          08578800
085789           MOVE  DT-CM-MONTH          TO DH-CM-MONTH              08578900
085790           MOVE  DT-CM-DAY            TO DH-CM-DAY                08579000
085791           MOVE  DT-CM-YEAR           TO DH-CM-YEAR               08579100
085792           MOVE  DT-JN-MONTH          TO DH-JN-MONTH              08579200
085793           MOVE  DT-JN-DAY            TO DH-JN-DAY                08579300
085794           MOVE  DT-JN-YEAR           TO DH-JN-YEAR               08579400
085795           MOVE  DT-PO-NUMBER         TO WS-INVOIC-PO-NBR         08579500
085796           ADD   DT-INV               TO WS-INV-TOTAL             08579600
085797           MOVE  WS-INV-TOTAL         TO DH-INV                   08579700
085798           IF INVOIC-PPD-RVRSL-IND = 'Y'                          08579800
085799              MOVE AP047-GRO-COST-AMT TO DH-PPR                   08579900
085800           END-IF                                                 08580000
085801           INITIALIZE DT-HOLD-TOTAL                               08580100
085802         END-IF.                                                  08580200
085803                                                                  08580300
085804         ADD 1                        TO PV-WRITTEN-CNT.          08580400
085805                                                                  08580500
085806*----------------------------------------------------------------*08580600
085807* WRITES REPORT HEADERS                                          *08580700
085808*----------------------------------------------------------------*08580800
085809 W200-WRITE-REPORT-HEADERS.                                       08580900
085810                                                                  08581000
085811     INITIALIZE LINE-COUNT.                                       08581100
085812     ADD 1                       TO PAGE-COUNT.                   08581200
085813     MOVE PAGE-COUNT             TO DP132O-PAGE-NUMBER.           08581300
085814     WRITE SUMMARY-REPORT-RECORD                                  08581400
085815           FROM DP132O-STANDRD-HEADER-132-COLS AFTER PAGE.        08581500
085816                                                                  08581600
085817     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-1 AFTER 1.         08581700
085818     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-2 AFTER 1.         08581800
085819     WRITE SUMMARY-REPORT-RECORD FROM BLANK-LINE AFTER 1.         08581900
085820     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-3 AFTER 1.         08582000
085821     ADD 5                       TO LINE-COUNT.                   08582100
085822                                                                  08582200
085823*----------------------------------------------------------------*08582300
085824* WRITES REPORT DETAILS                                          *08582400
085825*----------------------------------------------------------------*08582500
085826 W300-WRITE-REPORT-DETAIL.                                        08582600
085827                                                                  08582700
085828     IF LINE-COUNT > 59                                           08582800
085829        PERFORM W200-WRITE-REPORT-HEADERS                         08582900
085830     END-IF.                                                      08583000
085831                                                                  08583100
085832     WRITE SUMMARY-REPORT-RECORD FROM DH-DETAIL-LINE1 AFTER 1.    08583200
085833     ADD 1                       TO LINE-COUNT.                   08583300
085834                                                                  08583400
085835*----------------------------------------------------------------*08583500
085836* WRITES END OF REPORT LINE                                      *08583600
085837*----------------------------------------------------------------*08583700
085838 W400-WRITE-END-OF-REPORT.                                        08583800
085839                                                                  08583900
085840     WRITE SUMMARY-REPORT-RECORD FROM EOR-END-OF-REPORT AFTER 1.  08584000
085841                                                                  08584100
085842*----------------------------------------------------------------*08584200
085843* OPENS THE INVOICE_CSR CURSOR                                   *08584300
085844*----------------------------------------------------------------*08584400
085845 Y100-OPEN-INVOICE-CSR.                                           08584500
085850                                                                  08585000
085900     PERFORM WITH TEST AFTER                                      08590000
086000        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      08600000
086100        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              08610000
086200                SQLCODE = ZERO                                    08620000
086300        EXEC SQL                                                  08630000
086400            OPEN INVOICE_CSR                                      08640000
086500        END-EXEC                                                  08650000
086600                                                                  08660000
086700        EVALUATE TRUE                                             08670000
086800            WHEN SQLCODE = ZERO                                   08680000
086900            WHEN SQLCODE = -904                                   08690000
087000            WHEN SQLCODE = -913                                   08700000
087100                 CONTINUE                                         08710000
087200            WHEN SQLWARN0 NOT = SPACES                            08720000
087300            WHEN SQLCODE  NOT = ZERO                              08730000
087400                 MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME08740000
087600                 MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION 08760000
087800                 MOVE 'TINVOIC'               TO AA-DB2-TABLE-1   08780000
087900                 MOVE 'TMDINVC'               TO AA-DB2-TABLE-2   08790000
087910                 MOVE 'TACCTYP'               TO AA-DB2-TABLE-3   08791000
087920                 MOVE SPACES                  TO AA-DB2-TABLE-4   08792000
088000                 PERFORM Z999-DB2-ABEND                           08800000
088100        END-EVALUATE                                              08810000
088200     END-PERFORM.                                                 08820000
088300                                                                  08830000
088400     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         08840000
088500         MOVE 'Y100-OPEN-INVOICE-CSR'  TO AA-PARAGRAPH-NAME       08850000
088700         MOVE 'MAX RETRIES EXCEEDED ON OPEN TINVOIC'              08870000
088800                                       TO AA-DB2-OPERATION        08880000
088900         PERFORM Z999-DB2-ABEND                                   08890000
089000     END-IF.                                                      08900000
089100                                                                  08910000
089200     EVALUATE TRUE                                                08920000
089300        WHEN SQLCODE = ZEROS                                      08930000
089400             CONTINUE                                             08940000
089500        WHEN OTHER                                                08950000
089600             MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME    08960000
089800             MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION     08980000
090000             MOVE 'TINVOIC'               TO AA-DB2-TABLE-1       09000000
090100             MOVE 'TMDINVC'               TO AA-DB2-TABLE-2       09010000
090110             MOVE 'TACCTYP'               TO AA-DB2-TABLE-3       09011000
090120             MOVE SPACES                  TO AA-DB2-TABLE-4       09012000
090200             PERFORM Z999-DB2-ABEND                               09020000
090300     END-EVALUATE.                                                09030000
090400                                                                  09040000
090410*----------------------------------------------------------------*09041000
090420* CLOSES THE INVOICE_CSR CURSOR                                  *09042000
090430*----------------------------------------------------------------*09043000
090500 Y200-CLOSE-INVOICE-CSR.                                          09050000
090600                                                                  09060000
090700     PERFORM WITH TEST AFTER                                      09070000
090800        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      09080000
090900        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              09090000
091000                SQLCODE = ZERO                                    09100000
091100         EXEC SQL                                                 09110000
091200             CLOSE INVOICE_CSR                                    09120000
091300         END-EXEC                                                 09130000
091400                                                                  09140000
091500        EVALUATE TRUE                                             09150000
091600            WHEN SQLCODE = ZERO                                   09160000
091700            WHEN SQLCODE = -904                                   09170000
091800            WHEN SQLCODE = -913                                   09180000
091900                 CONTINUE                                         09190000
092000            WHEN SQLWARN0 NOT = SPACES                            09200000
092100            WHEN SQLCODE  NOT = ZERO                              09210000
092200                 MOVE 'Y200-CLOSE-INVOICE-CSR'                    09220000
092300                                           TO AA-PARAGRAPH-NAME   09230000
092400                 MOVE 'UNSUCCESSFUL CLOSE' TO AA-DB2-OPERATION    09240000
092600                 MOVE 'TINVOIC'            TO AA-DB2-TABLE-1      09260000
092700                 MOVE 'TMDINVC'            TO AA-DB2-TABLE-2      09270000
092710                 MOVE 'TACCTYP'            TO AA-DB2-TABLE-3      09271000
092720                 MOVE SPACES               TO AA-DB2-TABLE-4      09272000
092800                 PERFORM Z999-DB2-ABEND                           09280000
092900        END-EVALUATE                                              09290000
093000     END-PERFORM.                                                 09300000
093100                                                                  09310000
093200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         09320000
093300         MOVE 'Y200-CLOSE-INVOICE-CSR' TO AA-PARAGRAPH-NAME       09330000
093500         MOVE 'MAX RETRIES EXCEEDED ON CLOSE TINVOIC'             09350000
093600                                       TO AA-DB2-OPERATION        09360000
093700         PERFORM Z999-DB2-ABEND                                   09370000
093800     END-IF.                                                      09380000
093900                                                                  09390000
094000     EVALUATE TRUE                                                09400000
094100        WHEN SQLCODE = ZEROS                                      09410000
094200             CONTINUE                                             09420000
094300        WHEN OTHER                                                09430000
094400             MOVE 'Y200-CLOSE-INVOICE-CSR' TO AA-PARAGRAPH-NAME   09440000
094600             MOVE 'UNSUCCESSFUL CLOSE'     TO AA-DB2-OPERATION    09460000
094800             MOVE 'TINOIVC'                TO AA-DB2-TABLE-1      09480000
094900             MOVE 'TMDINVC'                TO AA-DB2-TABLE-2      09490000
094910             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      09491000
094920             MOVE SPACES                   TO AA-DB2-TABLE-4      09492000
095000             PERFORM Z999-DB2-ABEND                               09500000
095100     END-EVALUATE.                                                09510000
095110                                                                  09511000
095120*----------------------------------------------------------------*09512000
095130* DB2 ABEND ROUTINE                                              *09513000
095140*----------------------------------------------------------------*09514000
095200 Z999-DB2-ABEND.                                                  09520000
095300                                                                  09530000
095400     DISPLAY AA-ABEND-LIT.                                        09540000
095500     DISPLAY AA-DB2-ERROR-LIT.                                    09550000
095600     DISPLAY AA-PROGRAM-LIT.                                      09560000
095700     DISPLAY AA-PARAGRAPH-LIT.                                    09570000
095800     DISPLAY AA-DB2-OPERATION-LIT.                                09580000
095900     DISPLAY AA-DB2-TABLE-1.                                      09590000
096000     DISPLAY AA-DB2-TABLE-2.                                      09600000
096010     DISPLAY AA-DB2-TABLE-3.                                      09601000
096020     DISPLAY AA-DB2-TABLE-4.                                      09602000
096100     SET AC-DB2-ERROR TO TRUE.                                    09610000
096200                                                                  09620000
096300     COPY DPPD004.                                                09630000
096500     CALL 'ILBOABN0' USING ABEND-CODE.                            09650000
