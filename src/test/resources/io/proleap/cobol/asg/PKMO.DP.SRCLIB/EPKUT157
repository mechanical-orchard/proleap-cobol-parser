000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      EPKUT157.                                       00020000
000300 AUTHOR.          SANDY POTTER.                                   00030000
000400 DATE-WRITTEN.    MARCH 31, 2005.                                 00040000
000500                                                                  00050000
000600*-----------------------------------------------------------      00060000
000700*         EXTRACT PLU LOWEST 13 WEEK RETURN PRICE CHANGES         00070014
000800*-----------------------------------------------------------      00080000
000900*  THIS PROGRAM EXTRACTS CHANGE FILE OF PLU DATA FOR THINGS       00090000
001000*  THAT HAVE CHANGED SINCE THE LAST BATCH CYCLE. IT ENCOMPASSES   00100000
001100*  THE PORTION OF EPKUT107 THAT PERTAINED TO LOWEST 13-WEEK RETURN00110019
001200*  PRICE ONLY, AS THAT PROGRAM HAS BEEN BROKEN INTO SMALLER PIECES00120000
001300*  THAT CAN EXECUTE SIMULTANEOUSLY, THUS REDUCING THE CRITAL PATH 00130000
001400*  ON YELLOW AND RED TICKET EVENT DAYS.                           00140000
001500*                                                                 00150000
001600*  THIS PROGRAM REVIEWS INPUT FILES OF "LOWEST PRICE" CHANGES     00160002
001700*  (EITHER NEW OR DROPPED OFF) FOR LOWEST PRICE CHANGE.           00170002
001800*                                                                 00180002
001900*  THIS PROGRAM USES ONE CONTROL CARD FOR THE BATCH PROCESSING    00190002
002000*  DATE (GENERALLY TOMORROW'S DATE).                              00200002
002100*                                                                 00210000
002200*  THIS PROGRAM READS INPUT FILES FOR UPC FOR EITHER "ROLLED"     00220000
002300*  (OR DROPPED) OR NEW LOWEST 13-WEEK PRICE FOR POSSIBLE          00230014
002400*  CHANGES. IF THERE ARE CHANGES THE APPROPRIATE PLU RECORD       00240000
002500*  WILL BE WRITTEN OUT (AD VERSION) WITH                          00250000
002600*  AN APPROPRIATE RETURN VALUE.                                   00260000
002700*  A SKU PRICING RECORD FOR SQL SERVER WILL ALSO BE WRITTEN.      00270007
002800*-----------------------------------------------------------      00280000
002900*    THE FILES AND THEIR ASSOCIATED COPYBOOK/PURPOSE.             00290000
003000*    INP01- CC-TOMORROW                EPWS112                    00300000
003100*    INP02- LOWEST 13 WK PRICE CHANGE  EPRD119                    00310014
003200*    INP03- LOWEST 13 WK PRICE DELETE  EPRD120                    00320014
003300*    OUT01- CHG-SKU-PRICG-AD-VS-FILE   EPRD220                    00330020
003400*                                                                 00340000
003500*-----------------------------------------------------------      00350013
003600* HISTORY LOG:                                                    00360013
003700*-----------------------------------------------------------      00370013
003800* DATE:        12/05/11                                           00380013
003900* WR/IR#:      WR#25149                                           00390019
004000* PROGRAMMER:  ROB SWAGER                                         00400013
004100* DESCRIPTION: EXTEND LOWEST 6 WEEK RETURN PRICE PROCESSING       00410013
004200*              TO 13 WEEKS.                                       00420016
004300*                                                                 00430013
004400*----------------------------------------------------------       00440013
004500*----------------------------------------------------------       00450000
004600 ENVIRONMENT DIVISION.                                            00460000
004700*----------------------------------------------------------       00470000
004800 CONFIGURATION SECTION.                                           00480000
004900 SOURCE-COMPUTER.        IBM-3090.                                00490000
005000 OBJECT-COMPUTER.        IBM-3090.                                00500000
005100                                                                  00510000
005200 INPUT-OUTPUT SECTION.                                            00520000
005300                                                                  00530000
005400 FILE-CONTROL.                                                    00540000
005500                                                                  00550000
005600     SELECT CC-TOMORROW                                           00560000
005700            ASSIGN TO INP01.                                      00570000
005800     SELECT LOWEST-PRICE-CHG                                      00580000
005900            ASSIGN TO INP02.                                      00590000
006000     SELECT LOWEST-PRICE-DEL                                      00600000
006100            ASSIGN TO INP03.                                      00610000
006200     SELECT CHG-SKU-PRICG-AD-VS-FILE                              00620007
006300            ASSIGN TO OUT01.                                      00630020
006400                                                                  00640007
006500 DATA DIVISION.                                                   00650000
006600 FILE SECTION.                                                    00660000
006700                                                                  00670000
006800 FD  CC-TOMORROW                                                  00680000
006900     RECORDING MODE F                                             00690000
007000     BLOCK CONTAINS 0 RECORDS                                     00700000
007100     LABEL RECORDS ARE OMITTED                                    00710000
007200     DATA RECORD IS CC-TOMORROW-RECORD.                           00720000
007300 01  CC-TOMORROW-RECORD              PIC X(80).                   00730000
007400                                                                  00740000
007500 FD  LOWEST-PRICE-CHG                                             00750000
007600     RECORDING MODE F                                             00760000
007700     BLOCK CONTAINS 0 RECORDS                                     00770000
007800     LABEL RECORDS ARE OMITTED                                    00780000
007900     DATA RECORD IS LOWEST-PRICE-CHG-RECORD.                      00790000
008000 01  LOWEST-PRICE-CHG-RECORD        PIC X(23).                    00800000
008100                                                                  00810000
008200 FD  LOWEST-PRICE-DEL                                             00820000
008300     RECORDING MODE F                                             00830000
008400     BLOCK CONTAINS 0 RECORDS                                     00840000
008500     LABEL RECORDS ARE OMITTED                                    00850000
008600     DATA RECORD IS LOWEST-PRICE-DEL-RECORD.                      00860000
008700 01  LOWEST-PRICE-DEL-RECORD        PIC X(18).                    00870000
008800                                                                  00880000
008900 FD  CHG-SKU-PRICG-AD-VS-FILE                                     00890007
009000     RECORDING MODE F                                             00900007
009100     BLOCK CONTAINS 0 RECORDS                                     00910007
009200     LABEL RECORDS ARE OMITTED                                    00920007
009300     DATA RECORD IS CHG-SKU-PRICG-AD-VS-RECORD.                   00930007
009400 01  CHG-SKU-PRICG-AD-VS-RECORD      PIC X(260).                  00940007
009500                                                                  00950007
009600 WORKING-STORAGE SECTION.                                         00960000
009700*-----------------------------------------------------------      00970000
009800* PS- PROGRAM SWITCHES                                            00980000
009900*-----------------------------------------------------------      00990000
010000 01  PS-PROGRAM-SWITCHES.                                         01000000
010100     05  PS-END-OF-INPUT-FILE-SW        PIC X(01) VALUE 'Y'.      01010000
010200         88  PS-END-OF-INPUT-FILE                 VALUE 'N'.      01020000
010300         88  PS-MORE-INPUT-FILE                   VALUE 'Y'.      01030000
010400     05  PS-END-OF-LOWEST-CHG-SW        PIC X(01) VALUE 'N'.      01040000
010500         88  PS-END-OF-LOWEST-CHG                 VALUE 'Y'.      01050000
010600         88  PS-MORE-LOWEST-CHG                   VALUE 'N'.      01060000
010700     05  PS-END-OF-LOWEST-DEL-SW        PIC X(01) VALUE 'N'.      01070000
010800         88  PS-END-OF-LOWEST-DEL                 VALUE 'Y'.      01080000
010900         88  PS-MORE-LOWEST-DEL                   VALUE 'N'.      01090000
011000     05  PS-AD-VERS-PRICE-FOUND-SW      PIC X(01) VALUE 'N'.      01100000
011100         88  PS-AD-VERS-PRICE-FOUND               VALUE 'Y'.      01110000
011200         88  PS-AD-VERS-PRICE-NOT-FOUND           VALUE 'N'.      01120000
011300     05  PS-ACTIVE-SKU-SW               PIC X(01) VALUE 'N'.      01130000
011400         88  PS-ACTIVE-SKU                        VALUE 'Y'.      01140000
011500         88  PS-INACTIVE-SKU                      VALUE 'N'.      01150000
011600                                                                  01160000
011700*-----------------------------------------------------------      01170000
011800* PC- PROGRAM CONSTANTS                                           01180000
011900*-----------------------------------------------------------      01190000
012000 01  PC-PROGRAM-CONSTANTS.                                        01200000
012100     05  PC-CURRENT-PROGRAM-NAME   PIC X(08)  VALUE 'EPKUT157'.   01210003
012200     05  PC-MAX-RETRIES            PIC S9(04) VALUE +5 COMP.      01220000
012300                                                                  01230000
012400     05  PC-PRIC-EFF-TIME-STD      PIC X(08)  VALUE '03:00:00'.   01240007
012500     05  PC-MDSE-HIER-SKU          PIC X(03)  VALUE 'SKU'.        01250007
012600                                                                  01260007
012700*-----------------------------------------------------------      01270000
012800* PV- PROGRAM VARIABLES                                           01280000
012900*-----------------------------------------------------------      01290000
013000 01  PV-PROGRAM-VARAIBLES.                                        01300000
013100     05  PV-SQL-SUB                PIC S9(4)  VALUE +0 COMP.      01310003
013200     05  PV-STR-GP-TYP-CDE         PIC S9(4)  VALUE +0 COMP.      01320003
013300     05  PV-STR-GP-ID              PIC S9(4)  VALUE +0 COMP.      01330003
013400     05  PV-CONVERT-PRICE          PIC S9(07)V9(02) VALUE +0.     01340000
013500     05  PV-MIN-NULL-IND           PIC S9(4)  VALUE +0 COMP.      01350003
013600         88  PV-MIN-NULL                      VALUE -1.           01360003
013700     05  PV-SAVE-CORP-UNT-RTL      PIC S9(07)V9(02) VALUE +0.     01370000
013800                                                                  01380007
013900     05  PV-PRIC-EFF-TMST.                                        01390007
014000         10  PV-PRIC-EFF-DTE       PIC X(10).                     01400007
014100         10  FILLER                PIC X(01) VALUE SPACE.         01410007
014200         10  PV-PRIC-EFF-TIME      PIC X(08).                     01420007
014300                                                                  01430000
014400*----------------------------------------------------------       01440007
014500*  SKU PRICING FILE LAYOUT                                        01450007
014600*----------------------------------------------------------       01460007
014700     COPY EPRD220.                                                01470007
014800                                                                  01480007
014900*----------------------------------------------------------       01490000
015000*  LOWEST 13 WEEK PRICE REC -CHANGE                               01500014
015100*----------------------------------------------------------       01510000
015200     COPY EPRD119.                                                01520000
015300                                                                  01530000
015400*----------------------------------------------------------       01540000
015500*  LOWEST 13 WEEK PRICE REC -DELETE                               01550014
015600*----------------------------------------------------------       01560000
015700     COPY EPRD120.                                                01570000
015800                                                                  01580000
015900*----------------------------------------------------------       01590000
016000* CONTROL CARD LAYOUT FOR TOMORROW'S DATE                         01600000
016100*----------------------------------------------------------       01610000
016200     COPY EPWS112.                                                01620000
016300                                                                  01630000
016400*-----------------------------------------------------------      01640000
016500* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01650000
016600*-----------------------------------------------------------      01660000
016700     COPY DPWS004.                                                01670000
016800                                                                  01680000
016900*-----------------------------------------------------------      01690000
017000* PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)              01700000
017100*-----------------------------------------------------------      01710000
017200     COPY DPWS500.                                                01720000
017300                                                                  01730000
017400*-----------------------------------------------------------      01740000
017500* DB2 ABEND COPYBOOK                                              01750000
017600*-----------------------------------------------------------      01760000
017700     COPY DPWS900.                                                01770000
017800                                                                  01780000
017900*-----------------------------------------------------------      01790000
018000* DB2 MESSAGE AREA                                                01800000
018100*-----------------------------------------------------------      01810000
018200     COPY SQLCA2.                                                 01820000
018300                                                                  01830000
018400*-----------------------------------------------------------      01840000
018500* PROGRAM COUNTERS                                                01850000
018600*-----------------------------------------------------------      01860000
018700 01  PV-PROGRAM-COUNTERS.                                         01870000
018800     05  PV-CNT-CHG-RECS              PIC 9(09) VALUE 0.          01880000
018900     05  PV-CNT-CHG-INACTIVE          PIC 9(09) VALUE 0.          01890000
019000     05  PV-CNT-DEL-RECS              PIC 9(09) VALUE 0.          01900000
019100     05  PV-CNT-DEL-INACTIVE          PIC 9(09) VALUE 0.          01910000
019200     05  PV-CNT-SKU-PRICG-AD-VS       PIC 9(09) VALUE 0.          01920008
019300                                                                  01930000
019400*-----------------------------------------------------------      01940000
019500* ERROR HANDLING                                                  01950000
019600*-----------------------------------------------------------      01960000
019700 01  PV-MISC-ABEND-FIELDS.                                        01970000
019800     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACE.       01980002
019900     05  PV-OPERATION-MSG-1          PIC X(40) VALUE SPACE.       01990002
020000     05  PV-OPERATION-MSG-2          PIC X(40) VALUE SPACE.       02000002
020100     05  PV-DB2-OPERATION            PIC X(30) VALUE SPACE.       02010002
020200 01  ABEND-CODE                      PIC S9(4) VALUE +0 COMP SYNC.02020002
020300     88  ABEND-4003-CTRL-CARD-ERROR            VALUE +4003.       02030002
020400     88  ABEND-4013-DB2-ERROR                  VALUE +4013.       02040002
020500     88  ABEND-4019-CAL-SUB-ERROR              VALUE +4019.       02050002
020600     88  ABEND-4020-MQ-ERROR                   VALUE +4020.       02060002
020700     88  ABEND-4444-FORCED-ABEND               VALUE +4444.       02070002
020800                                                                  02080000
020900*-----------------------------------------------------------      02090000
021000* DB2 COMMUNICATIONS AREA                                         02100000
021100*-----------------------------------------------------------      02110000
021200     EXEC SQL                                                     02120000
021300          INCLUDE SQLCA                                           02130000
021400     END-EXEC.                                                    02140000
021500                                                                  02150000
021600*-----------------------------------------------------------      02160000
021700* DB2 TABLE XST00023(XST_STR_GP_MBSHP) - STORE GROUP MEMBERSHIP   02170000
021800*                                              TABLE              02180000
021900*-----------------------------------------------------------      02190000
022000     EXEC SQL                                                     02200000
022100          INCLUDE XST00023                                        02210000
022200     END-EXEC.                                                    02220000
022300                                                                  02230000
022400*-----------------------------------------------------------      02240000
022500* DB2 TABLE XST00010(XST_SKU) - SKU TABLE                         02250000
022600*-----------------------------------------------------------      02260000
022700     EXEC SQL                                                     02270000
022800          INCLUDE XST00010                                        02280000
022900     END-EXEC.                                                    02290000
023000                                                                  02300000
023100*-----------------------------------------------------------      02310000
023200* DB2 TABLE XST00008(XST_SKU_LOC) - SKU LOCATION TABLE            02320000
023300*-----------------------------------------------------------      02330000
023400     EXEC SQL                                                     02340000
023500          INCLUDE XST00008                                        02350000
023600     END-EXEC.                                                    02360000
023700                                                                  02370001
023800*-----------------------------------------------------------      02380001
023900* DB2 TABLE XST00011(XST_SKU_ATTR) - SKU ATTRIBUTE TABLE          02390001
024000*-----------------------------------------------------------      02400001
024100     EXEC SQL                                                     02410001
024200          INCLUDE XST00011                                        02420001
024300     END-EXEC.                                                    02430001
024400                                                                  02440000
024500 LINKAGE SECTION.                                                 02450000
024600                                                                  02460000
024700*----------------------------------------------------------       02470000
024800 PROCEDURE DIVISION.                                              02480000
024900*----------------------------------------------------------       02490000
025000 0000-MAINLINE.                                                   02500000
025100                                                                  02510000
025200     PERFORM 1000-INITIALIZATION.                                 02520000
025300                                                                  02530000
025400     DISPLAY '** STARTING PROCESS LOWEST PRICE CHANGE **'.        02540000
025500     PERFORM 4100-READ-LOWEST-PRICE                               02550000
025600     PERFORM 2500-PROCESS-LOWEST-PRICE                            02560000
025700       UNTIL PS-END-OF-LOWEST-CHG.                                02570000
025800                                                                  02580000
025900     DISPLAY '** STARTING PROCESS LOWEST PRICE ROLL OFF **'.      02590000
026000     PERFORM 4200-READ-LOWEST-PRICE-DEL                           02600000
026100     PERFORM 2600-PROCESS-LOW-PRICE-DEL                           02610000
026200       UNTIL PS-END-OF-LOWEST-DEL.                                02620000
026300                                                                  02630000
026400     PERFORM 9999-WRAPUP.                                         02640000
026500                                                                  02650000
026600     GOBACK.                                                      02660000
026700                                                                  02670000
026800*0000-EXIT.                                                       02680000
026900                                                                  02690000
027000*----------------------------------------------------------       02700000
027100* 1000-INITIALIZATION.                                            02710000
027200*     INITIALIZATION AREA - INITIALIZES ALL VARIABLES, OPENS      02720000
027300*     FILES AND READS CONTROL RECORDS                             02730000
027400*----------------------------------------------------------       02740000
027500 1000-INITIALIZATION.                                             02750000
027600                                                                  02760000
027700     DISPLAY '***EPKUT157 * 1000-INITIALIZATION'.                 02770000
027800     DISPLAY ' '.                                                 02780000
027900                                                                  02790002
028000     INITIALIZE CC-EPCC112-CONTROL-CARD.                          02800000
028100     SET PS-MORE-INPUT-FILE TO TRUE.                              02810000
028200                                                                  02820000
028300     OPEN INPUT  CC-TOMORROW                                      02830000
028400                 LOWEST-PRICE-CHG                                 02840000
028500                 LOWEST-PRICE-DEL                                 02850000
028600          OUTPUT CHG-SKU-PRICG-AD-VS-FILE.                        02860020
028700                                                                  02870000
028800     PERFORM 1200-READ-CC-TOMORROW.                               02880000
028900                                                                  02890000
029000     CLOSE CC-TOMORROW.                                           02900000
029100                                                                  02910000
029200*1000-EXIT.                                                       02920000
029300                                                                  02930000
029400*----------------------------------------------------------       02940000
029500* 1200-READ-CC-TOMORROW.                                          02950000
029600*     READ CONTROL CARD 1.  THIS GETS THE FUTURE DATE THAT        02960000
029700*     NEEDS TO BE PROCESSED.                                      02970000
029800*----------------------------------------------------------       02980000
029900 1200-READ-CC-TOMORROW.                                           02990000
030000                                                                  03000000
030100     READ CC-TOMORROW INTO CC-EPCC112-CONTROL-CARD                03010000
030200       AT END                                                     03020000
030300          SET PS-END-OF-INPUT-FILE TO TRUE.                       03030000
030400                                                                  03040002
030500     IF PS-END-OF-INPUT-FILE                                      03050002
030600        DISPLAY 'CONTROL CARD MISSING FOR EPCC112 '               03060002
030700        MOVE '1200-READ-CC-TOMORROW'     TO PV-PARAGRAPH-NAME     03070002
030800        MOVE 'CONTROL CARD 1 IS MISSING' TO PV-OPERATION-MSG-1    03080002
030900        SET ABEND-4003-CTRL-CARD-ERROR   TO TRUE                  03090002
031000        PERFORM 9800-ABEND                                        03100002
031100     END-IF.                                                      03110002
031200                                                                  03120002
031300     IF CC-EPCC112-TOMORROW-DATE =  SPACES                        03130002
031400        DISPLAY 'INVALID CONTROL CARD'                            03140002
031500        DISPLAY '  TOMMORROWS DATE: ' CC-EPCC112-TOMORROW-DATE    03150002
031600        MOVE '1200-READ-CC-TOMORROW'     TO PV-PARAGRAPH-NAME     03160002
031700        MOVE 'CONTROL CARD IS INVALID'   TO PV-OPERATION-MSG-1    03170002
031800        SET ABEND-4003-CTRL-CARD-ERROR   TO TRUE                  03180002
031900        PERFORM 9800-ABEND                                        03190002
032000     END-IF.                                                      03200002
032100                                                                  03210002
032200     DISPLAY '** TOMORROW DATE BASED ON CONTROL CARD **'.         03220002
032300     DISPLAY '   EPCC112 CONTROL CARD: ' CC-EPCC112-CONTROL-CARD. 03230002
032400     DISPLAY ' '.                                                 03240002
032500                                                                  03250002
032600     MOVE CC-EPCC112-TOMORROW-DATE  TO PV-PRIC-EFF-DTE.           03260007
032700     MOVE PC-PRIC-EFF-TIME-STD      TO PV-PRIC-EFF-TIME.          03270007
032800     DISPLAY 'PRIC EFF TMST TO SQLS: ' PV-PRIC-EFF-TMST.          03280007
032900                                                                  03290007
033000*1200-EXIT.                                                       03300000
033100                                                                  03310000
033200*----------------------------------------------------------       03320000
033300* 2500-PROCESS-LOWEST-PRICE.                                      03330000
033400*     READS THRU THE LOWEST 13 PRICE CHANGE FILE AND,             03340014
033500*     UNLESS THE SKU IS NOW INACTIVE,                             03350000
033600*     WRITES AD VERSION RECORDS FOR THE NEW RETURN PRICE.         03360000
033700*----------------------------------------------------------       03370000
033800 2500-PROCESS-LOWEST-PRICE.                                       03380000
033900                                                                  03390000
034000     MOVE EP119-INTR-UPC-ID  TO XST00010-INTR-UPC-ID.             03400000
034100     PERFORM 3110-SELECT-CORP-PRICE.                              03410020
034200                                                                  03420000
034300     IF PS-ACTIVE-SKU                                             03430000
034400        MOVE EP119-STR-GP-TYP-CDE TO PV-STR-GP-TYP-CDE            03440000
034500        MOVE EP119-STR-GP-ID      TO PV-STR-GP-ID                 03450000
034600        MOVE EP119-UNT-RTL-AMT    TO PV-CONVERT-PRICE             03460000
034700                                                                  03470000
034800        PERFORM 4000-CREATE-SKU-PRICG-REC                         03480007
034900     ELSE                                                         03490000
035000        ADD 1 TO PV-CNT-CHG-INACTIVE                              03500000
035100     END-IF.                                                      03510000
035200                                                                  03520000
035300     PERFORM 4100-READ-LOWEST-PRICE.                              03530000
035400                                                                  03540000
035500*2500-EXIT.                                                       03550000
035600                                                                  03560000
035700*----------------------------------------------------------       03570000
035800* 2600-PROCESS-LOW-PRICE-DEL.                                     03580000
035900*     READS THRU THE LOWEST 13 PRICE DELETE FILE AND              03590014
036000*     WRITES AD VERSION RECORDS.  THESE ARE SKU/AD VERSIONS       03600000
036100*     FOR WHICH THE LAST ROW IN THE EPT_LO_RTL TABLE HAS ROLLED   03610000
036200*     OFF, SO THE REGULAR PRICE MUST BE USED FOR THE RETURN PRICE.03620000
036300*----------------------------------------------------------       03630000
036400 2600-PROCESS-LOW-PRICE-DEL.                                      03640000
036500                                                                  03650000
036600     MOVE EP120-INTR-UPC-ID    TO XST00010-INTR-UPC-ID.           03660000
036700     MOVE EP120-STR-GP-TYP-CDE TO PV-STR-GP-TYP-CDE.              03670000
036800     MOVE EP120-STR-GP-ID      TO PV-STR-GP-ID.                   03680000
036900     PERFORM 3110-SELECT-CORP-PRICE.                              03690000
037000                                                                  03700000
037100     IF PS-ACTIVE-SKU                                             03710000
037200        IF XST00010-REGN-PRIC-IND = 'Y'                           03720000
037300           MOVE EP120-STR-GP-TYP-CDE TO XST00023-STR-GP-TYP-CDE   03730000
037400           MOVE EP120-STR-GP-ID      TO XST00023-STR-GP-ID        03740000
037500           PERFORM 3130-SELECT-AD-VERS-PRICE                      03750000
037600                                                                  03760000
037700        ELSE                                                      03770000
037800           SET PS-AD-VERS-PRICE-NOT-FOUND TO TRUE                 03780000
037900        END-IF                                                    03790000
038000                                                                  03800000
038100        IF PS-AD-VERS-PRICE-FOUND                                 03810000
038200           IF PV-SAVE-CORP-UNT-RTL <= XST00008-UNT-RTL-AMT        03820000
038300              MOVE PV-SAVE-CORP-UNT-RTL TO PV-CONVERT-PRICE       03830000
038400           ELSE                                                   03840000
038500              MOVE XST00008-UNT-RTL-AMT TO PV-CONVERT-PRICE       03850000
038600           END-IF                                                 03860000
038700        ELSE                                                      03870000
038800           MOVE PV-SAVE-CORP-UNT-RTL TO PV-CONVERT-PRICE          03880000
038900        END-IF                                                    03890000
039000                                                                  03900000
039100        PERFORM 4000-CREATE-SKU-PRICG-REC                         03910007
039200     ELSE                                                         03920000
039300        ADD 1 TO PV-CNT-DEL-INACTIVE                              03930000
039400     END-IF.                                                      03940000
039500                                                                  03950000
039600     PERFORM 4200-READ-LOWEST-PRICE-DEL.                          03960000
039700                                                                  03970000
039800*2600-EXIT.                                                       03980000
039900                                                                  03990000
040000*----------------------------------------------------------       04000000
040100* 3110-SELECT-CORP-PRICE.                                         04010000
040200*     SELECTS REGULAR CORPORATE PRICE FOR A SKU.                  04020000
040300*----------------------------------------------------------       04030000
040400 3110-SELECT-CORP-PRICE.                                          04040000
040500                                                                  04050000
040600     PERFORM                                                      04060000
040700        WITH TEST AFTER                                           04070000
040800        VARYING PV-SQL-SUB                                        04080000
040900        FROM 1 BY 1                                               04090000
041000        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                  04100000
041100           OR  SQLCODE = 0                                        04110000
041200           OR  SQLCODE = +100)                                    04120000
041300                                                                  04130000
041400        EXEC SQL                                                  04140000
041500           SELECT  A.SKU_NBR                                      04150000
041600                  ,A.REGN_PRIC_IND                                04160000
041700                  ,B.UNT_RTL_AMT                                  04170000
041800             INTO :XST00010-SKU-NBR                               04180000
041900                 ,:XST00010-REGN-PRIC-IND                         04190000
042000                 ,:XST00008-UNT-RTL-AMT                           04200000
042100             FROM  XST_SKU      A                                 04210006
042200                  ,XST_SKU_LOC  B                                 04220006
042300                  ,XST_SKU_ATTR C                                 04230000
042400            WHERE  A.INTR_UPC_ID         = :XST00010-INTR-UPC-ID  04240000
042500              AND  A.INTR_UPC_ID         = B.INTR_UPC_ID          04250000
042600              AND  A.INTR_UPC_ID         = C.INTR_UPC_ID          04260000
042700              AND  B.LOC_NBR             = 0                      04270000
042800              AND  B.END_TMST           IS NULL                   04280000
042900              AND  C.PLU_DWNLD_EXCL_IND  = 'N'                    04290000
043000            WITH UR                                               04300000
043100        END-EXEC                                                  04310000
043200                                                                  04320000
043300        EVALUATE TRUE                                             04330000
043400           WHEN SQLCODE = -904                                    04340000
043500           WHEN SQLCODE = -911                                    04350000
043600           WHEN SQLCODE = -913                                    04360000
043700              CONTINUE                                            04370000
043800           WHEN SQLCODE = ZERO                                    04380000
043900              MOVE XST00008-UNT-RTL-AMT TO PV-SAVE-CORP-UNT-RTL   04390000
044000              SET PS-ACTIVE-SKU TO TRUE                           04400000
044100           WHEN SQLCODE = +100                                    04410000
044200              SET PS-INACTIVE-SKU TO TRUE                         04420000
044300           WHEN OTHER                                             04430000
044400              MOVE '3110-SELECT-CORP-PRICE'                       04440000
044500                   TO PV-PARAGRAPH-NAME                           04450000
044600              MOVE 'SELECT AD VERSION'                            04460000
044700                   TO PV-DB2-OPERATION                            04470000
044800              PERFORM 9900-SQL-ABEND-ROUTINE                      04480000
044900        END-EVALUATE                                              04490000
045000     END-PERFORM.                                                 04500000
045100                                                                  04510000
045200     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         04520000
045300        MOVE '3110-SELECT-CORP-PRICE'                             04530000
045400                            TO PV-PARAGRAPH-NAME                  04540000
045500        MOVE 'SELECT RETRIES EXCEEDED'                            04550000
045600                            TO PV-DB2-OPERATION                   04560000
045700        PERFORM 9900-SQL-ABEND-ROUTINE                            04570000
045800     END-IF.                                                      04580000
045900                                                                  04590000
046000*3110-EXIT.                                                       04600000
046100                                                                  04610000
046200*----------------------------------------------------------       04620000
046300* 3130-SELECT-AD-VERS-PRICE.                                      04630000
046400*     SELECTS THE MINIMUM REGULAR PRICE ACROSS STORE SPECIFIC     04640000
046500*     PRICING FOR THE AD VERSION AND SKU.                         04650000
046600*----------------------------------------------------------       04660000
046700 3130-SELECT-AD-VERS-PRICE.                                       04670000
046800                                                                  04680000
046900     PERFORM                                                      04690000
047000         WITH TEST AFTER                                          04700000
047100         VARYING PV-SQL-SUB                                       04710000
047200         FROM 1 BY 1                                              04720000
047300         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04730000
047400                   OR  SQLCODE = 0                                04740000
047500                   OR  SQLCODE = +100)                            04750000
047600                                                                  04760000
047700          EXEC SQL                                                04770000
047800               SELECT  MIN(B.UNT_RTL_AMT)                         04780000
047900                 INTO :XST00008-UNT-RTL-AMT :PV-MIN-NULL-IND      04790000
048000                 FROM XST_SKU_LOC      B                          04800006
048100                     ,XST_STR_GP_MBSHP C                          04810000
048200                WHERE B.INTR_UPC_ID    = :XST00010-INTR-UPC-ID    04820000
048300                  AND B.END_TMST      IS NULL                     04830000
048400                  AND C.STR_NBR        = B.LOC_NBR                04840000
048500                  AND C.STR_GP_TYP_CDE = :XST00023-STR-GP-TYP-CDE 04850000
048600                  AND C.STR_GP_ID      = :XST00023-STR-GP-ID      04860000
048700                  AND C.STR_NBR        > 0                        04870000
048800                  AND C.EFF_BEG_DTE   <= :CC-EPCC112-TOMORROW-DATE04880006
048900                  AND (C.EFF_END_DTE   > :CC-EPCC112-TOMORROW-DATE04890000
049000                    OR C.EFF_END_DTE  IS NULL)                    04900000
049100                WITH UR                                           04910000
049200          END-EXEC                                                04920000
049300                                                                  04930000
049400          EVALUATE TRUE                                           04940000
049500              WHEN SQLCODE = -904                                 04950000
049600              WHEN SQLCODE = -911                                 04960000
049700              WHEN SQLCODE = -913                                 04970000
049800                  CONTINUE                                        04980000
049900              WHEN SQLCODE = ZERO                                 04990000
050000                   IF PV-MIN-NULL                                 05000000
050100                      SET PS-AD-VERS-PRICE-NOT-FOUND TO TRUE      05010000
050200                   ELSE                                           05020000
050300                      SET PS-AD-VERS-PRICE-FOUND TO TRUE          05030000
050400                   END-IF                                         05040000
050500              WHEN SQLCODE = +100                                 05050000
050600                   SET PS-AD-VERS-PRICE-NOT-FOUND TO TRUE         05060000
050700              WHEN OTHER                                          05070000
050800                   MOVE '3130-SELECT-AD-VERS-PRICE'               05080000
050900                                       TO PV-PARAGRAPH-NAME       05090000
051000                   MOVE 'SELECT MIN RTL AMT'                      05100000
051100                                       TO PV-DB2-OPERATION        05110000
051200                   PERFORM 9900-SQL-ABEND-ROUTINE                 05120000
051300          END-EVALUATE                                            05130000
051400     END-PERFORM.                                                 05140000
051500                                                                  05150000
051600     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05160000
051700        MOVE '3130-SELECT-AD-VERS-PRICE'                          05170000
051800                            TO PV-PARAGRAPH-NAME                  05180000
051900        MOVE 'SELECT RETRIES EXCEEDED'                            05190000
052000                            TO PV-DB2-OPERATION                   05200000
052100        PERFORM 9900-SQL-ABEND-ROUTINE                            05210000
052200     END-IF.                                                      05220000
052300                                                                  05230000
052400*3130-EXIT.                                                       05240000
052500                                                                  05250000
052600*----------------------------------------------------------       05260007
052700* 4000-CREATE-SKU-PRICG-REC.                                      05270007
052800*     BUILD AND OUTPUT THE SKU PRICING AD VERSION OUTPUT          05280007
052900*     RECORD.                                                     05290007
053000*----------------------------------------------------------       05300007
053100 4000-CREATE-SKU-PRICG-REC.                                       05310007
053200                                                                  05320007
053300     PERFORM 6000-FORMAT-SKU-PRICG-COMMON.                        05330007
053400     PERFORM 6100-FILL-SKU-PRICG-AD-VS-HDR.                       05340007
053500     PERFORM 6200-FILL-SKU-PRICG-AD-VS-REC.                       05350007
053600                                                                  05360007
053700     PERFORM 8000-WRITE-SKU-PRICG-AD-VS-REC.                      05370007
053800                                                                  05380007
053900*4000-EXIT.                                                       05390007
054000*----------------------------------------------------------       05400000
054100* 4100-READ-LOWEST-PRICE.                                         05410000
054200*     READ LOWEST PRICE FILE. THIS READS RECORDS THAT NEED        05420000
054300*     TO GET NEW VALUE FOR LOWEST PRICE DUE TO CHANGE.            05430000
054400*----------------------------------------------------------       05440000
054500 4100-READ-LOWEST-PRICE.                                          05450000
054600                                                                  05460000
054700     READ LOWEST-PRICE-CHG INTO EP119-LWST-W13-WK-CHG-RCD         05470011
054800       AT END                                                     05480000
054900          SET PS-END-OF-LOWEST-CHG TO TRUE                        05490000
055000     END-READ.                                                    05500000
055100                                                                  05510000
055200     IF PS-MORE-LOWEST-CHG                                        05520000
055300        ADD 1 TO PV-CNT-CHG-RECS                                  05530000
055400     END-IF.                                                      05540000
055500                                                                  05550000
055600*4100-EXIT.                                                       05560000
055700                                                                  05570000
055800*----------------------------------------------------------       05580000
055900* 4200-READ-LOWEST-PRICE-DEL                                      05590000
056000*     READ LOWEST PRICE FILE. THIS READS RECORDS THAT NEED        05600000
056100*     TO GET NEW VALUE FOR LOWEST PRICE DUE TO DELETION.          05610000
056200*----------------------------------------------------------       05620000
056300 4200-READ-LOWEST-PRICE-DEL.                                      05630000
056400                                                                  05640000
056500     READ LOWEST-PRICE-DEL INTO EP120-LWST-W13-WK-DEL-RCD         05650012
056600       AT END                                                     05660000
056700          SET PS-END-OF-LOWEST-DEL TO TRUE                        05670000
056800     END-READ.                                                    05680000
056900                                                                  05690000
057000     IF PS-MORE-LOWEST-DEL                                        05700000
057100        ADD 1 TO PV-CNT-DEL-RECS                                  05710000
057200     END-IF.                                                      05720000
057300                                                                  05730000
057400*4200-EXIT.                                                       05740000
057500                                                                  05750000
057600*--------------------------------------------------------------*  05760007
057700* 6000-FORMAT-SKU-PRICG-COMMON.                                *  05770007
057800*   INITIALIZE SKU PRICING RECORD LAYOUT AND DATA ITEM INCLUDE *  05780007
057900*   INDICATORS, AND POPULATE SKU PRICING RECORD COMMON FIELDS. *  05790007
058000*--------------------------------------------------------------*  05800007
058100 6000-FORMAT-SKU-PRICG-COMMON.                                    05810007
058200                                                                  05820007
058300     INITIALIZE EP220-XST-SKU-PRICG-RECORD.                       05830007
058400                                                                  05840007
058500     MOVE CC-EPCC112-TOMORROW-DATE TO EP220-PRICG-EFFECT-DTE.     05850007
058600                                                                  05860007
058700     SET EP220-FILE-CHANGE         TO TRUE.                       05870007
058800     SET EP220-APPLY-NIGHTLY       TO TRUE.                       05880007
058900                                                                  05890007
059000     SET EP220-PRIC-EFF-TMST-YES      TO TRUE.                    05900007
059100     MOVE PV-PRIC-EFF-TMST      TO EP220-PRIC-EFF-TMST.           05910007
059200                                                                  05920007
059300*    SET MDSE-HIER-CDE TO 'SKU' FOR ALL CURRENT PRICING RECORDS   05930007
059400     SET EP220-MDSE-HIER-CDE-YES      TO TRUE.                    05940007
059500     MOVE PC-MDSE-HIER-SKU      TO EP220-MDSE-HIER-CDE.           05950007
059600                                                                  05960007
059700*    CURRENT PRICING IS ALWAYS AT SKU LEVEL                       05970007
059800     SET EP220-SKU-NBR-YES            TO TRUE.                    05980007
059900     MOVE XST00010-SKU-NBR      TO EP220-SKU-NBR.                 05990007
060000                                                                  06000007
060100*    SET REST OF DATA ITEM INCLUSION INDICATORS TO NO             06010007
060200     SET EP220-SKU-PRICG-ID-NO        TO TRUE.                    06020007
060300     SET EP220-DEPT-NBR-NO            TO TRUE.                    06030007
060400     SET EP220-MAJ-CL-NBR-NO          TO TRUE.                    06040007
060500     SET EP220-SUB-CL-NBR-NO          TO TRUE.                    06050007
060600     SET EP220-STYL-ID-NO             TO TRUE.                    06060007
060700     SET EP220-EXCL-MDSE-IND-NO       TO TRUE.                    06070007
060800     SET EP220-UNT-RTL-AMT-NO         TO TRUE.                    06080007
060900     SET EP220-LAST-NCLR-RTL-AMT-NO   TO TRUE.                    06090007
061000     SET EP220-N-RCPT-RT-RTL-AMT-N    TO TRUE.                    06100007
061100     SET EP220-GP-RTL-AMT-NO          TO TRUE.                    06110007
061200     SET EP220-LO-UNT-RTL-AMT-NO      TO TRUE.                    06120007
061300     SET EP220-HGH-UNT-RTL-AMT-NO     TO TRUE.                    06130007
061400     SET EP220-GP-RTL-QTY-NO          TO TRUE.                    06140007
061500     SET EP220-GP-PRIC-ID-NO          TO TRUE.                    06150007
061600     SET EP220-LOC-SKU-STAT-CDE-NO    TO TRUE.                    06160007
061700     SET EP220-TKT-CLOR-CDE-NO        TO TRUE.                    06170007
061800     SET EP220-LAST-PRCHG-TMST-NO     TO TRUE.                    06180007
061900     SET EP220-PRMPT-FOR-PRIC-IND-NO  TO TRUE.                    06190007
062000     SET EP220-PERM-PRCHG-DIRN-CDE-NO TO TRUE.                    06200007
062100     SET EP220-MLT-PRPT-IND-NO        TO TRUE.                    06210007
062200     SET EP220-PRCHG-APL-TKT-CLR-CD-N TO TRUE.                    06220007
062300                                                                  06230007
062400*6000-EXIT.                                                       06240007
062500*----------------------------------------------------------       06250007
062600* 6100-FILL-SKU-PRICG-AD-VS-HDR.                                  06260007
062700*     POPULATES HEADER VALUES FOR AD VERSION SKU PRICING RECORD.  06270007
062800*----------------------------------------------------------       06280007
062900 6100-FILL-SKU-PRICG-AD-VS-HDR.                                   06290007
063000                                                                  06300007
063100     MOVE PV-STR-GP-TYP-CDE     TO EP220-STR-GRP-TYP-CDE.         06310007
063200     MOVE PV-STR-GP-ID          TO EP220-STR-GRP-ID.              06320007
063300                                                                  06330007
063400*6100-EXIT.                                                       06340007
063500*----------------------------------------------------------       06350007
063600* 6200-FILL-SKU-PRICG-AD-VS-REC.                                  06360007
063700*     POPULATES THE UPDATED FIELDS ON THE SKU PRICING             06370007
063800*     RECORD FOR RETURN PRICE CHANGES.                            06380007
063900*----------------------------------------------------------       06390007
064000 6200-FILL-SKU-PRICG-AD-VS-REC.                                   06400007
064100                                                                  06410007
064200     SET EP220-RECORD-UPDATE           TO TRUE.                   06420007
064300                                                                  06430007
064400     SET EP220-N-RCPT-RT-RTL-AMT-Y     TO TRUE.                   06440007
064500     MOVE PV-CONVERT-PRICE         TO EP220-N-RCPT-RT-UNT-RTL-AMT.06450007
064600                                                                  06460007
064700*6200-EXIT.                                                       06470007
064800*----------------------------------------------------------       06480007
064900* 8000-WRITE-SKU-PRICG-AD-VS-REC.                                 06490007
065000*     WRITES THE AD VERSION RECORD FOR LOWEST 13 WK PRICE,        06500015
065100*      FOR THE SKU PRICING FILE FOR SQLS SERVER.                  06510007
065200*----------------------------------------------------------       06520007
065300 8000-WRITE-SKU-PRICG-AD-VS-REC.                                  06530007
065400                                                                  06540007
065500     WRITE CHG-SKU-PRICG-AD-VS-RECORD                             06550007
065600         FROM EP220-XST-SKU-PRICG-RECORD.                         06560007
065700                                                                  06570007
065800     ADD 1 TO PV-CNT-SKU-PRICG-AD-VS.                             06580007
065900                                                                  06590007
066000*8000-EXIT.                                                       06600007
066100*----------------------------------------------------------       06610000
066200* 9800-ABEND.                                                     06620000
066300*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  06630000
066400*----------------------------------------------------------       06640000
066500 9800-ABEND.                                                      06650000
066600                                                                  06660000
066700     DISPLAY '** ABEND           **'.                             06670000
066800     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  06680000
066900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06690000
067000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       06700000
067100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       06710000
067200     CALL 'ILBOABN0' USING ABEND-CODE.                            06720000
067300                                                                  06730000
067400*9800-EXIT.                                                       06740000
067500                                                                  06750000
067600*----------------------------------------------------------       06760000
067700* 9900-SQL-ABEND-ROUTINE.                                         06770000
067800*     SQL ABEND ROUTINE.                                          06780000
067900*----------------------------------------------------------       06790000
068000 9900-SQL-ABEND-ROUTINE.                                          06800000
068100                                                                  06810000
068200     SET ABEND-4013-DB2-ERROR TO TRUE.                            06820000
068300     DISPLAY '** ABEND     **'.                                   06830000
068400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06840000
068500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06850000
068600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06860000
068700                                                                  06870000
068800     COPY DPPD004.                                                06880000
068900     CALL 'ILBOABN0' USING ABEND-CODE.                            06890000
069000                                                                  06900000
069100*9900-EXIT.                                                       06910000
069200                                                                  06920000
069300*----------------------------------------------------------       06930000
069400* 9999-WRAPUP.                                                    06940000
069500*     END OF PROGRAM ROUTINE.  CLOSES ALL FILES AND DISPLAYS      06950000
069600*     ANY DATA FROM THE PROGRAM.                                  06960000
069700*----------------------------------------------------------       06970000
069800 9999-WRAPUP.                                                     06980000
069900                                                                  06990000
070000     CLOSE LOWEST-PRICE-CHG                                       07000000
070100           LOWEST-PRICE-DEL                                       07010000
070200           CHG-SKU-PRICG-AD-VS-FILE.                              07020007
070300                                                                  07030000
070400     DISPLAY ' '.                                                 07040000
070500     DISPLAY '*********************************************'.     07050000
070600     DISPLAY 'PROGRAM NAME: ' PC-CURRENT-PROGRAM-NAME.            07060000
070700     DISPLAY '*********************************************'.     07070000
070800     DISPLAY '    # LOW 13 WK CHG READ: ' PV-CNT-CHG-RECS.        07080015
070900     DISPLAY '# LOW 13 WK CHG INACTIVE: ' PV-CNT-CHG-INACTIVE.    07090015
071000     DISPLAY '    # LOW 13 WK DEL READ: ' PV-CNT-DEL-RECS.        07100015
071100     DISPLAY '# LOW 13 WK DEL INACTIVE: ' PV-CNT-DEL-INACTIVE.    07110015
071200     DISPLAY ' '.                                                 07120000
071300     DISPLAY ' # SKU PRICG RECS WRITE: ' PV-CNT-SKU-PRICG-AD-VS.  07130007
071400     DISPLAY '*********************************************'.     07140000
071500                                                                  07150000
071600*9999-EXIT.                                                       07160000
071700*********************  END OF PROGRAM  ***************************07170007
