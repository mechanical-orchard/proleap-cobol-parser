       IDENTIFICATION DIVISION.                                         00010000
       PROGRAM-ID.    MLKRP059.                                         00020012
       AUTHOR.        TOM MEDREK.                                       00030000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040000
       DATE-WRITTEN.  FEB 1997.                                         00050000
       DATE-COMPILED.                                                   00060000
      ******************************************************************00070000
      *  THIS PROGRAM REPORTS EXTENDED RETAIL SALES TOTALS FOR STORES   00080041
      *  WITHIN DEPT/CLASSES SPECIFIED IN THE CONTROL CARD.  THE INPUT  00090041
      *  ARE THE REJECTED TRANSACTIONS FROM PGM=MLKUP020. THE REPORT    00100042
      *  NAME IS "SALES AUDIT REPORT" AND IS USED BY THE SALES AUDIT    00110042
      *  TEAM.                                                          00120042
      ******************************************************************00130000
      *  CHANGE MADE : 07/27/02                                         00140052
      *     INCLUDE DEPT-CLASS-SUBCLASS ATTRIBUTE FIELDS TO REPORT AND  00150053
      *     CHANGE SKU TO BE AN 8-BYTE NON-INTELLIGENT DISPLAY FIELD    00160053
      *                                                                 00170054
      *CHANGE HISTORY:                                                  00180054
      * WR/PROJ    DATE       PGMR        DESCRIPTION OF CHANGES        00190057
      * -------    ---------- ----------- ----------------------------- 00200057
W26603* W26603     03-08-2004 ROD JANSSEN MERCH LEDGER STORE EXPANSION  00210057
207210* CHG0207210 08-27-2018 JIM HUNTER  RENAME KDU1806 TO PSWS010     00220058
      ******************************************************************00230053
                                                                        00240054
       ENVIRONMENT DIVISION.                                            00250000
       CONFIGURATION SECTION.                                           00260000
       SOURCE-COMPUTER.  IBM-3090.                                      00270000
       OBJECT-COMPUTER.  IBM-3090.                                      00280000
                                                                        00290000
       INPUT-OUTPUT SECTION.                                            00300000
                                                                        00310000
       FILE-CONTROL.                                                    00320000
                                                                        00330000
           SELECT INPUT-REJECT-FILE                                     00340008
               ASSIGN TO INP01.                                         00350000
                                                                        00360000
           SELECT INPUT-CONTROL-CARD-FILE                               00370003
               ASSIGN TO INP02.                                         00380000
                                                                        00390000
           SELECT OUTPUT-SALES-REPORT                                   00400003
               ASSIGN TO RPT01.                                         00410000
                                                                        00420000
      ******************************************************************00430000
       DATA DIVISION.                                                   00440000
      ******************************************************************00450000
       FILE SECTION.                                                    00460000
                                                                        00470000
       FD  INPUT-REJECT-FILE                                            00480008
           RECORDING MODE IS V                                          00490000
W26603     RECORD CONTAINS 65 TO 150 CHARACTERS                         00500054
           BLOCK CONTAINS 0 RECORDS.                                    00510000
                                                                        00520000
       01  INPUT-REJECT-SALES-REC          PIC X(065).                  00530047
W26603 01  INPUT-REJECT-REC                PIC X(150).                  00540054
                                                                        00550000
       FD  INPUT-CONTROL-CARD-FILE                                      00560003
           RECORDING MODE IS F                                          00570000
           BLOCK CONTAINS 0 RECORDS.                                    00580000
                                                                        00590000
       01  INPUT-CONTROL-REC.                                           00600003
           05  FILLER                      PIC X(005).                  00610012
           05  INPUT-CONTROL-DATE-YY       PIC X(002).                  00620003
           05  FILLER-DASH1                PIC X(001).                  00630007
           05  INPUT-CONTROL-DATE-MM       PIC X(002).                  00640003
           05  FILLER-DASH2                PIC X(001).                  00650007
           05  INPUT-CONTROL-DATE-DD       PIC X(002).                  00660003
           05  FILLER                      PIC X(067).                  00670012
                                                                        00680000
       FD  OUTPUT-SALES-REPORT                                          00690003
           LABEL RECORDS ARE OMITTED                                    00700000
           RECORDING MODE IS F                                          00710000
           BLOCK CONTAINS 0 RECORDS.                                    00720000
                                                                        00730000
       01  OUTPUT-ERROR-REC                PIC X(133).                  00740000
                                                                        00750054
      ******************************************************************00760000
       WORKING-STORAGE SECTION.                                         00770000
      ******************************************************************00780000
       01  PV-PROGRAM-VARIABLES.                                        00790000
           05  ABEND-CODE                    PIC S9(4)  VALUE +0        00800000
                                                        COMP SYNC.      00810000
DB2        05  PV-PARAGRAPH-NAME             PIC X(30)  VALUE SPACE.    00820007
DB2        05  PV-DB2-OPERATION              PIC X(30)  VALUE SPACE.    00830007
           05  PV-SYSDATE-DATE.                                         00840000
               10  PV-SYSDATE-YY             PIC X(02)  VALUE SPACES.   00850000
               10  PV-SYSDATE-MM             PIC X(02)  VALUE SPACES.   00860000
               10  PV-SYSDATE-DD             PIC X(02)  VALUE SPACES.   00870000
           05  PV-SYSTIME-TIME.                                         00880000
               10  PV-SYSTIME-HH             PIC X(02)  VALUE SPACES.   00890000
               10  PV-SYSTIME-MM             PIC X(02)  VALUE SPACES.   00900000
               10  FILLER                    PIC X(02)  VALUE SPACES.   00910000
           05  PV-INPUT-REC-CNT              PIC S9(07) COMP-3          00920000
                                                        VALUE +0.       00930000
           05  PV-LINE-CNT                   PIC S9(03) COMP-3 VALUE +0.00940000
                                                                        00950000
           05  PV-PAGE-CNT                   PIC S9(05) COMP-3 VALUE +0.00960000
                                                                        00970000
           05  PV-ERROR-CNT                  PIC S9(07) COMP-3 VALUE +0.00980000
           05  PV-RETRY-CNT                  PIC S9(03) COMP-3 VALUE +0.00990002
W26603     05  PV-STORE-EXT-RETAIL           PIC S9(11)V99 COMP-3.      01000054
W26603     05  PV-DEPT-CLASS-RETAIL          PIC S9(11)V99 COMP-3.      01010054
W26603     05  PV-PREV-STORE-NBR             PIC 9(04).                 01020054
           05  PV-PREV-DEPT-CLASS.                                      01030003
               10  PV-PREV-DEPT-NBR          PIC X(03).                 01040054
               10  PV-PREV-CLASS-NBR         PIC X(02).                 01050054
W21731     05  PV-PREV-SKU                   PIC X(08).                 01060054
                                                                        01070003
       01  PS-PROGRAM-SWITCHES.                                         01080000
           05  PS-END-OF-SALES-SW            PIC X(01) VALUE 'N'.       01090000
               88  PS-END-OF-SALES                     VALUE 'Y'.       01100000
           05  PS-END-OF-CC-SW               PIC X(01) VALUE 'N'.       01110003
               88  PS-END-OF-CC                        VALUE 'Y'.       01120003
           05  PS-FIRST-DEPT-DETAIL-SW       PIC X(01) VALUE 'N'.       01130030
               88  PS-FIRST-DEPT-DETAIL                VALUE 'Y'.       01140030
               88  PS-NOT-FIRST-DEPT-DETAIL            VALUE 'N'.       01150030
           05  PS-FIRST-OUTPUT-SW            PIC X(01) VALUE 'N'.       01160030
               88  PS-FIRST-OUTPUT                     VALUE 'Y'.       01170030
               88  PS-NOT-FIRST-OUTPUT                 VALUE 'N'.       01180030
           05  PS-EMPTY-SALES-SW             PIC X(01) VALUE 'N'.       01190045
               88  PS-EMPTY-SALES                      VALUE 'Y'.       01200045
                                                                        01210045
       01  PC-PROGRAM-CONSTANTS.                                        01220045
           05  PC-END-OF-REPORT-LINE         PIC X(21)    VALUE         01230045
               '*** END OF REPORT ***'.                                 01240045
           05  PC-MAX-LINES-PER-PAGE         PIC S9(3) COMP-3 VALUE +66.01250045
           05  PC-MAX-RETRIES                PIC S9(3) COMP-3 VALUE +3. 01260045
      *                                                                 01270045
      ******************************************************************01280045
      * COPY FOR STANDARD HEADING                                       01290045
      ** ***************************************************************01300045
           COPY DPWS132O.                                               01310045
      *                                                                 01320045
      ******************************************************************01330045
      *  OUTPUT REPORT HEADING #2 (STANDARD HEADER #1)                  01340000
      ******************************************************************01350000
       01  R1-H2-REC.                                                   01360002
           05  FILLER                            PIC X(45) VALUE SPACES.01370000
           05  FILLER                            PIC X(35) VALUE        01380000
               'SALES AUDIT REPORT FOR WEEK ENDING '.                   01390000
           05  R1-H2-DATE-MM                     PIC X(02) VALUE SPACES.01400003
           05  FILLER                            PIC X(01) VALUE '/'.   01410007
           05  R1-H2-DATE-DD                     PIC X(02) VALUE SPACES.01420003
           05  FILLER                            PIC X(01) VALUE '/'.   01430007
           05  R1-H2-DATE-YY                     PIC X(02) VALUE SPACES.01440003
           05  FILLER                            PIC X(45) VALUE SPACES.01450003
      *                                                                 01460003
      ******************************************************************01470003
      *  OUTPUT REPORT HEADING #3                                       01480003
      ******************************************************************01490003
       01  R1-H3-REC.                                                   01500003
           05  FILLER                            PIC X(02) VALUE SPACES.01510003
           05  FILLER                            PIC X(04) VALUE        01520003
               'DEPT'.                                                  01530003
W21731*    05  FILLER                            PIC X(10) VALUE SPACES.01540048
W21731*    05  FILLER                            PIC X(05) VALUE        01550048
W21731*        'CLASS'.                                                 01560048
W21731*    05  FILLER                            PIC X(10) VALUE SPACES.01570048
W21731     05  FILLER                            PIC X(05) VALUE SPACES.01580048
W21731     05  FILLER                            PIC X(05) VALUE        01590048
W21731         'CLASS'.                                                 01600048
W21731     05  FILLER                            PIC X(05) VALUE SPACES.01610048
W21731     05  FILLER                            PIC X(03) VALUE        01620049
W21731         'SKU'.                                                   01630048
W21731     05  FILLER                            PIC X(07) VALUE SPACES.01640048
           05  FILLER                            PIC X(09) VALUE        01650048
               'STORE NBR'.                                             01660048
           05  FILLER                            PIC X(10) VALUE SPACES.01670048
           05  FILLER                            PIC X(10) VALUE        01680048
               'STORE NAME'.                                            01690048
W26603     05  FILLER                            PIC X(30) VALUE SPACES.01700056
           05  FILLER                            PIC X(06) VALUE        01710048
               'AMOUNT'.                                                01720048
W26603     05  FILLER                            PIC X(37) VALUE SPACES.01730056
      *                                                                 01740048
      ******************************************************************01750048
      *  OUTPUT REPORT HEADING #4                                       01760048
      ******************************************************************01770048
       01  R1-H4-REC.                                                   01780048
           05  FILLER                            PIC X(02) VALUE SPACES.01790048
           05  FILLER                            PIC X(04) VALUE        01800048
               '----'.                                                  01810048
W21731*    05  FILLER                            PIC X(10) VALUE SPACES.01820048
W21731*    05  FILLER                            PIC X(05) VALUE        01830048
W21731*        '-----'.                                                 01840048
W21731*    05  FILLER                            PIC X(10) VALUE SPACES.01850048
W21731     05  FILLER                            PIC X(05) VALUE SPACES.01860048
W21731     05  FILLER                            PIC X(05) VALUE        01870048
W21731         '-----'.                                                 01880048
W21731     05  FILLER                            PIC X(05) VALUE SPACES.01890048
W21731     05  FILLER                            PIC X(03) VALUE        01900049
W21731         '---'.                                                   01910048
W21731     05  FILLER                            PIC X(07) VALUE SPACES.01920048
           05  FILLER                            PIC X(09) VALUE        01930010
               '---------'.                                             01940010
           05  FILLER                            PIC X(10) VALUE SPACES.01950012
           05  FILLER                            PIC X(25) VALUE        01960010
               '-------------------------'.                             01970010
W26603     05  FILLER                            PIC X(15) VALUE SPACES.01980056
           05  FILLER                            PIC X(06) VALUE        01990010
               '------'.                                                02000010
W26603     05  FILLER                            PIC X(37) VALUE SPACES.02010056
      *                                                                 02020003
      ******************************************************************02030003
      *  OUTPUT REPORT DETAIL #1                                        02040003
      ******************************************************************02050003
       01  R1-D1-REC.                                                   02060003
           05  FILLER                            PIC X(03) VALUE SPACES.02070003
           05  R1-D1-DEPT-NBR                    PIC ZZ9.               02080003
W21731     05  FILLER                            PIC X(07) VALUE SPACES.02090048
W21731     05  R1-D1-CLASS-NBR                   PIC Z9.                02100048
W21731     05  FILLER                            PIC X(04) VALUE SPACES.02110051
W21731     05  R1-D1-SKU                         PIC 9(8).              02120048
W21731     05  FILLER                            PIC X(06) VALUE SPACES.02130054
W26603     05  R1-D1-STORE-NBR                   PIC ZZZ9.              02140054
           05  FILLER                            PIC X(13) VALUE SPACES.02150048
           05  R1-D1-STORE-NAME                  PIC X(25).             02160048
W26603     05  FILLER                            PIC X(04) VALUE SPACES.02170054
W26603     05  R1-D1-STORE-AMT                   PIC ZZ,ZZZ,ZZZ,ZZZ.99-.02180054
           05  FILLER                            PIC X(37).             02190048
      *                                                                 02200048
      ******************************************************************02210048
      *  OUTPUT REPORT TOTAL LINE #1                                    02220048
      ******************************************************************02230048
       01  R1-T1-REC.                                                   02240048
           05  FILLER                            PIC X(31) VALUE SPACES.02250048
           05  FILLER                            PIC X(10) VALUE        02260048
               'TOTAL FOR '.                                            02270048
           05  R1-T1-DEPT-NBR                    PIC ZZ9.               02280048
           05  FILLER                            PIC X     VALUE '/'.   02290048
           05  R1-T1-CLASS-NBR                   PIC Z9.                02300048
W26603     05  FILLER                            PIC X(35) VALUE SPACES.02310056
           05  R1-T1-DEPT-CLASS-AMT              PIC ZZZ,ZZZ,ZZZ.99-.   02320048
W26603     05  FILLER                            PIC X(36) VALUE SPACES.02330056
      *                                                                 02340048
      ***************************************************************** 02350048
      *  DATA ENTRY SALES                                               02360048
      ***************************************************************** 02370048
207210     COPY PSWS010.                                                02380058
           EJECT.                                                       02390000
      *                                                                 02400003
      ******************************************************************02410003
      *  STORE TABLE                                                    02420003
      ******************************************************************02430003
           EXEC SQL                                                     02440003
W26603         INCLUDE XMT00001                                         02450054
           END-EXEC.                                                    02460003
      *                                                                 02470004
DB2   ******************************************************************02480007
DB2   *  DB2 FORMATTED MESSAGES                                        *02490007
DB2   ******************************************************************02500007
DB2        COPY DPWS004.                                                02510007
DB2        EJECT                                                        02520007
DB2   *                                                                 02530007
DB2   ******************************************************************02540007
DB2   *  REQUIRED SQL COMMUNICATIONS AREA                               02550007
DB2   ******************************************************************02560007
DB2        EXEC SQL                                                     02570007
DB2            INCLUDE SQLCA                                            02580007
DB2        END-EXEC.                                                    02590007
DB2   *                                                                 02600007
DB2   ******************************************************************02610007
DB2   *  EXTENSION TO THE SQL COMMUNICATIONS AREA FOR EDITING           02620007
DB2   *  SQL CODES FOR DISPLAY                                          02630007
DB2   ******************************************************************02640007
DB2        COPY SQLCA2.                                                 02650007
      *                                                                 02660007
      *                                                                 02670000
      ******************************************************************02680000
       PROCEDURE DIVISION.                                              02690000
      ******************************************************************02700000
       0000-MAINLINE.                                                   02710000
           PERFORM 1000-INITIALIZE.                                     02720000
                                                                        02730000
           PERFORM 2000-PROCESS-REJECTS                                 02740003
               UNTIL (PS-END-OF-SALES)                                  02750003
                                                                        02760000
           PERFORM 9000-EOJ-ROUTINE.                                    02770045
                                                                        02780000
           GOBACK.                                                      02790000
                                                                        02800000
      ******************************************************************02810000
       1000-INITIALIZE.                                                 02820000
      ******************************************************************02830000
           OPEN INPUT  INPUT-REJECT-FILE                                02840008
                       INPUT-CONTROL-CARD-FILE                          02850003
           OPEN OUTPUT OUTPUT-SALES-REPORT.                             02860003
      *                                                                 02870000
           PERFORM 7010-READ-CONTROL-CARD-FILE.                         02880007
           IF  (PS-END-OF-CC)                                           02890009
               DISPLAY 'EMPTY CONTROL CARD FILE'                        02900009
               PERFORM 9999-ERROR-ROUTINE                               02910009
           ELSE                                                         02920003
               MOVE INPUT-CONTROL-DATE-YY TO R1-H2-DATE-YY              02930009
               MOVE INPUT-CONTROL-DATE-MM TO R1-H2-DATE-MM              02940009
               MOVE INPUT-CONTROL-DATE-DD TO R1-H2-DATE-DD              02950009
           END-IF                                                       02960003
                                                                        02970003
           PERFORM 7000-READ-REJECT-FILE                                02980008
           MOVE D040-DEPT-CLASS-X    TO PV-PREV-DEPT-CLASS              02990018
W21731     MOVE D040-SKU             TO PV-PREV-SKU                     03000051
           MOVE D040-STORENO         TO PV-PREV-STORE-NBR               03010003
                                                                        03020000
           MOVE +0                   TO PV-STORE-EXT-RETAIL             03030002
           MOVE +0                   TO PV-DEPT-CLASS-RETAIL            03040023
           SET PS-FIRST-OUTPUT       TO TRUE                            03050031
           SET PS-FIRST-DEPT-DETAIL  TO TRUE                            03060030
                                                                        03070002
           IF  PS-END-OF-SALES                                          03080000
               DISPLAY 'EMPTY INPUT SALES REGISTER REJECT FILE'         03090000
               SET PS-EMPTY-SALES TO TRUE                               03100045
           END-IF.                                                      03110000
                                                                        03120000
           PERFORM 1100-GET-DATE-TIME.                                  03130000
      *                                                                 03140000
           EXIT.                                                        03150000
      *                                                                 03160000
      *                                                                 03170000
      ******************************************************************03180000
      * ONE TIME ROUTINE TO FORMAT DATE AND TIME IN THE REPORT HEADINGS.03190000
      ******************************************************************03200000
       1100-GET-DATE-TIME.                                              03210000
      *                                                                 03220000
           ACCEPT PV-SYSDATE-DATE FROM DATE.                            03230000
           MOVE PV-SYSDATE-YY TO DP132O-RUN-YEAR.                       03240000
           MOVE PV-SYSDATE-MM TO DP132O-RUN-MONTH.                      03250000
           MOVE PV-SYSDATE-DD TO DP132O-RUN-DAY.                        03260000
                                                                        03270000
           ACCEPT PV-SYSTIME-TIME FROM TIME.                            03280000
           MOVE PV-SYSTIME-HH TO DP132O-RUN-HOUR.                       03290000
           MOVE PV-SYSTIME-MM TO DP132O-RUN-MINUTE.                     03300000
           MOVE 'MLKRP059'    TO DP132O-PROGRAM-NAME.                   03310012
      *                                                                 03320000
           EXIT.                                                        03330000
      *                                                                 03340000
      *                                                                 03350000
      ******************************************************************03360000
       2000-PROCESS-REJECTS.                                            03370007
      ******************************************************************03380025
           IF  D040-DEPT-CLASS-X = PV-PREV-DEPT-CLASS                   03390013
               PERFORM 2100-CHECK-STORE-BREAK                           03400022
           ELSE                                                         03410013
               COMPUTE PV-DEPT-CLASS-RETAIL = PV-DEPT-CLASS-RETAIL +    03420036
                 PV-STORE-EXT-RETAIL                                    03430036
               IF  PS-FIRST-DEPT-DETAIL                                 03440030
                   PERFORM 4000-DEPT-CLASS-LINE                         03450027
                   PERFORM 6000-DEPT-CLASS-TOTALS                       03460032
               ELSE                                                     03470018
                   PERFORM 4010-BUILD-STORE-LINE                        03480018
                   PERFORM 6000-DEPT-CLASS-TOTALS                       03490018
               END-IF                                                   03500015
               SET PS-FIRST-DEPT-DETAIL  TO TRUE                        03510034
               MOVE +0                   TO PV-STORE-EXT-RETAIL         03520042
           END-IF                                                       03530013
                                                                        03540000
           PERFORM 2200-STORE-ACCUMS                                    03550031
           MOVE D040-STORENO      TO PV-PREV-STORE-NBR                  03560002
           MOVE D040-DEPT-CLASS-X TO PV-PREV-DEPT-CLASS                 03570002
W21731     MOVE D040-SKU          TO PV-PREV-SKU                        03580051
           PERFORM 7000-READ-REJECT-FILE.                               03590008
      *                                                                 03600000
           EXIT.                                                        03610000
      *                                                                 03620000
      *                                                                 03630002
      ******************************************************************03640013
       2100-CHECK-STORE-BREAK.                                          03650022
      ******************************************************************03660013
           IF  D040-STORENO = PV-PREV-STORE-NBR                         03670013
               CONTINUE                                                 03680031
           ELSE                                                         03690013
               COMPUTE PV-DEPT-CLASS-RETAIL = PV-DEPT-CLASS-RETAIL +    03700036
                 PV-STORE-EXT-RETAIL                                    03710036
               IF  PS-FIRST-DEPT-DETAIL                                 03720030
                   PERFORM 4000-DEPT-CLASS-LINE                         03730027
                   SET PS-NOT-FIRST-DEPT-DETAIL TO TRUE                 03740042
               ELSE                                                     03750018
                   PERFORM 4010-BUILD-STORE-LINE                        03760018
               END-IF                                                   03770018
               MOVE +0                          TO PV-STORE-EXT-RETAIL  03780042
           END-IF.                                                      03790013
      *                                                                 03800014
           EXIT.                                                        03810013
      *                                                                 03820013
      *                                                                 03830013
      ******************************************************************03840025
       2200-STORE-ACCUMS.                                               03850025
      ******************************************************************03860025
           IF  D040-SALE-UNITS NUMERIC AND                              03870025
               D040-SALE-AMT   NUMERIC AND                              03880025
               D040-SALE-UNITS NOT = +0 AND                             03890025
               D040-SALE-AMT   NOT = +0                                 03900025
               COMPUTE PV-STORE-EXT-RETAIL = PV-STORE-EXT-RETAIL +      03910025
                 (D040-SALE-AMT * D040-SALE-UNITS)                      03920025
           ELSE                                                         03930025
               DISPLAY 'NON-NUMERIC DATA, D040-SALE-AMT = '             03940025
                       D040-SALE-AMT                                    03950025
                       ', D040-SALE-UNITS = '                           03960025
                       D040-SALE-UNITS                                  03970025
           END-IF.                                                      03980025
      *                                                                 03990025
           EXIT.                                                        04000025
      *                                                                 04010025
      *                                                                 04020025
      ******************************************************************04030003
       4000-DEPT-CLASS-LINE.                                            04040027
      ******************************************************************04050003
           MOVE SPACES                  TO R1-D1-REC                    04060011
W26603     MOVE PV-PREV-STORE-NBR       TO XMT00001-LOC-NBR             04070055
           PERFORM 5000-GET-STORE-NAME                                  04080016
               WITH TEST AFTER                                          04090010
               UNTIL (SQLCODE = +0) OR                                  04100003
                     (PV-RETRY-CNT > PC-MAX-RETRIES)                    04110003
                                                                        04120000
           IF  PS-FIRST-DEPT-DETAIL                                     04130030
               MOVE PV-PREV-DEPT-NBR        TO R1-D1-DEPT-NBR           04140022
               MOVE PV-PREV-CLASS-NBR       TO R1-D1-CLASS-NBR          04150022
W21731         MOVE PV-PREV-SKU             TO R1-D1-SKU                04160048
           ELSE                                                         04170048
               MOVE D040-DEPT               TO R1-D1-DEPT-NBR           04180048
               MOVE D040-CLASS              TO R1-D1-CLASS-NBR          04190048
W21731         MOVE D040-SKU                TO R1-D1-SKU                04200050
           END-IF                                                       04210048
                                                                        04220048
W26603     MOVE PV-PREV-STORE-NBR       TO R1-D1-STORE-NBR              04230054
W26603     MOVE XMT00001-LOC-NM         TO R1-D1-STORE-NAME             04240054
           MOVE PV-STORE-EXT-RETAIL     TO R1-D1-STORE-AMT              04250048
                                                                        04260048
           PERFORM 4040-CHECK-SALES-RPT-HEADING.                        04270048
           WRITE OUTPUT-ERROR-REC     FROM R1-D1-REC                    04280048
             AFTER ADVANCING +3 LINES                                   04290048
           ADD +3                       TO PV-LINE-CNT                  04300048
           MOVE +0                      TO PV-STORE-EXT-RETAIL.         04310048
      *                                                                 04320048
           EXIT.                                                        04330048
      *                                                                 04340048
      *                                                                 04350048
      ******************************************************************04360048
       4010-BUILD-STORE-LINE.                                           04370016
      ******************************************************************04380013
           MOVE SPACES                  TO R1-D1-REC                    04390017
W26603     MOVE PV-PREV-STORE-NBR       TO XMT00001-LOC-NBR             04400054
           PERFORM 5000-GET-STORE-NAME                                  04410017
               WITH TEST AFTER                                          04420017
               UNTIL (SQLCODE = +0) OR                                  04430017
                     (PV-RETRY-CNT > PC-MAX-RETRIES)                    04440017
                                                                        04450017
           MOVE PV-PREV-STORE-NBR       TO R1-D1-STORE-NBR              04460020
W26603     MOVE XMT00001-LOC-NM         TO R1-D1-STORE-NAME             04470054
           MOVE PV-STORE-EXT-RETAIL     TO R1-D1-STORE-AMT              04480021
                                                                        04490017
           PERFORM 4040-CHECK-SALES-RPT-HEADING                         04500017
           WRITE OUTPUT-ERROR-REC     FROM R1-D1-REC                    04510040
           ADD  +1                      TO PV-LINE-CNT.                 04520040
                                                                        04530017
      *                                                                 04540016
           EXIT.                                                        04550016
      *                                                                 04560016
      *                                                                 04570016
      ******************************************************************04580016
       4040-CHECK-SALES-RPT-HEADING.                                    04590016
      ******************************************************************04600016
           IF  PV-LINE-CNT > (PC-MAX-LINES-PER-PAGE - 3) OR             04610040
               PS-FIRST-OUTPUT                                          04620030
               ADD +1                     TO PV-PAGE-CNT                04630042
               MOVE PV-PAGE-CNT           TO DP132O-PAGE-NUMBER         04640042
               MOVE +1                    TO DP132O-REPORT-NUMBER       04650042
               MOVE DP132O-STANDRD-HEADER-132-COLS                      04660016
                                          TO OUTPUT-ERROR-REC           04670042
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING PAGE              04680016
                                                                        04690016
               MOVE R1-H2-REC             TO OUTPUT-ERROR-REC           04700042
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING 1 LINES           04710016
               MOVE PV-PREV-DEPT-NBR      TO R1-D1-DEPT-NBR             04720016
               MOVE PV-PREV-CLASS-NBR     TO R1-D1-CLASS-NBR            04730016
W21731         MOVE PV-PREV-SKU           TO R1-D1-SKU                  04740048
               MOVE R1-H3-REC             TO OUTPUT-ERROR-REC           04750048
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING 2 LINES           04760048
               MOVE R1-H4-REC             TO OUTPUT-ERROR-REC           04770048
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING 1 LINES           04780048
               MOVE +5                    TO PV-LINE-CNT                04790042
               SET PS-NOT-FIRST-OUTPUT    TO TRUE                       04800042
           END-IF                                                       04810016
      *                                                                 04820013
           EXIT.                                                        04830013
      *                                                                 04840013
      *                                                                 04850013
      ******************************************************************04860042
       5000-GET-STORE-NAME.                                             04870042
      ******************************************************************04880042
           EXEC SQL                                                     04890042
W26603         SELECT LOC_NBR                                           04900054
W26603               ,LOC_NM                                            04910054
W26603           INTO :XMT00001-LOC-NBR                                 04920054
W26603               ,:XMT00001-LOC-NM                                  04930054
W26603           FROM XMT_LOC                                           04940054
W26603          WHERE LOC_NBR = :XMT00001-LOC-NBR                       04950055
           END-EXEC.                                                    04960042
                                                                        04970042
           EVALUATE SQLCODE                                             04980042
               WHEN -913                                                04990042
               WHEN -911                                                05000042
               WHEN -904                                                05010042
               WHEN +0                                                  05020042
                 CONTINUE                                               05030042
               WHEN OTHER                                               05040042
                 COMPUTE PV-RETRY-CNT = PV-RETRY-CNT + 1                05050042
                 DISPLAY 'PGM MLKRP059 ABENDED - SELECT STORE NAME'     05060042
                 MOVE '5000-GET-STORE-NAME'     TO PV-PARAGRAPH-NAME    05070042
                 MOVE 'SELECT STORE NAME'       TO PV-DB2-OPERATION     05080042
                 PERFORM 9100-SQL-ERROR                                 05090042
           END-EVALUATE                                                 05100042
                                                                        05110042
           IF  PV-RETRY-CNT > PC-MAX-RETRIES                            05120042
               DISPLAY 'PGM MLKRP059 ABENDED - MAX SELECT STORE NAME'   05130042
               MOVE '5000-GET-STORE-NAME' TO PV-PARAGRAPH-NAME          05140042
               MOVE 'SELECT STORE NAME'   TO PV-DB2-OPERATION           05150042
               PERFORM 9100-SQL-ERROR                                   05160042
           EXIT.                                                        05170042
      *                                                                 05180042
      *                                                                 05190042
      ******************************************************************05200042
       6000-DEPT-CLASS-TOTALS.                                          05210042
      ******************************************************************05220042
           MOVE PV-DEPT-CLASS-RETAIL    TO R1-T1-DEPT-CLASS-AMT         05230042
                                                                        05240042
           MOVE PV-PREV-DEPT-NBR        TO R1-T1-DEPT-NBR               05250042
           MOVE PV-PREV-CLASS-NBR       TO R1-T1-CLASS-NBR              05260042
W21731*    MOVE PV-PREV-SKU             TO R1-T1-SKU                    05270048
           PERFORM 4040-CHECK-SALES-RPT-HEADING                         05280048
           WRITE OUTPUT-ERROR-REC     FROM R1-T1-REC                    05290048
             AFTER ADVANCING +2 LINES                                   05300048
           ADD  +2                      TO PV-LINE-CNT                  05310048
           MOVE +0                      TO PV-DEPT-CLASS-RETAIL.        05320048
      *                                                                 05330048
           EXIT.                                                        05340048
      *                                                                 05350048
      *                                                                 05360048
      ******************************************************************05370048
       7000-READ-REJECT-FILE.                                           05380048
      ******************************************************************05390048
           READ INPUT-REJECT-FILE INTO D040-RECORD                      05400048
              AT END                                                    05410048
                   SET PS-END-OF-SALES TO TRUE                          05420048
           END-READ.                                                    05430048
      *                                                                 05440048
           EXIT.                                                        05450048
      *                                                                 05460048
      *                                                                 05470048
      ******************************************************************05480048
       7010-READ-CONTROL-CARD-FILE.                                     05490048
      ******************************************************************05500048
           READ INPUT-CONTROL-CARD-FILE                                 05510048
              AT END                                                    05520048
                   SET PS-END-OF-CC TO TRUE                             05530048
           END-READ.                                                    05540048
      *                                                                 05550048
           EXIT.                                                        05560048
      *                                                                 05570048
           EXIT.                                                        05580048
      *                                                                 05590048
      *                                                                 05600048
      ******************************************************************05610048
       9000-EOJ-ROUTINE.                                                05620048
      ******************************************************************05630048
           IF  (PS-EMPTY-SALES)                                         05640048
               MOVE +1                    TO DP132O-PAGE-NUMBER         05650048
               MOVE +1                    TO DP132O-REPORT-NUMBER       05660048
               MOVE DP132O-STANDRD-HEADER-132-COLS                      05670048
                                          TO OUTPUT-ERROR-REC           05680048
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING PAGE              05690048
                                                                        05700048
               MOVE R1-H2-REC             TO OUTPUT-ERROR-REC           05710048
               WRITE OUTPUT-ERROR-REC AFTER ADVANCING 1 LINES           05720048
           ELSE                                                         05730048
               COMPUTE PV-DEPT-CLASS-RETAIL = PV-DEPT-CLASS-RETAIL +    05740048
                 PV-STORE-EXT-RETAIL                                    05750048
               IF  PS-FIRST-DEPT-DETAIL                                 05760048
                   PERFORM 4000-DEPT-CLASS-LINE                         05770048
                   PERFORM 6000-DEPT-CLASS-TOTALS                       05780048
               ELSE                                                     05790048
                   PERFORM 4010-BUILD-STORE-LINE                        05800048
                   PERFORM 6000-DEPT-CLASS-TOTALS                       05810048
               END-IF                                                   05820048
           END-IF                                                       05830048
                                                                        05840048
           WRITE OUTPUT-ERROR-REC     FROM PC-END-OF-REPORT-LINE        05850045
             AFTER ADVANCING +3 LINES                                   05860045
                                                                        05870045
           CLOSE INPUT-REJECT-FILE                                      05880008
                 INPUT-CONTROL-CARD-FILE                                05890003
                 OUTPUT-SALES-REPORT.                                   05900003
      *                                                                 05910000
           EXIT.                                                        05920000
      *                                                                 05930000
      ******************************************************************05940002
      *  FORMAT A DB2 ERROR MESSAGE, RELEASE ALL LOCKS, AND ABEND THE  *05950002
      *  PROGRAM.                                                      *05960002
      ******************************************************************05970002
       9100-SQL-ERROR.                                                  05980002
           MOVE SQLCODE                    TO SQLCODE2.                 05990007
           MOVE SQLERRD(3)                 TO SQLERRD3.                 06000007
           DISPLAY '** ABEND **          = SQL ERROR'.                  06010007
           DISPLAY '** PROGRAM **        = MLKRP059'                    06020041
           DISPLAY '** PARAGRAPH **      = ' PV-PARAGRAPH-NAME          06030007
           DISPLAY '** SQLCODE **        = ' SQLCODE2.                  06040007
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  06050007
           DISPLAY '** SQLERRM **        = ' SQLERRM.                   06060007
           DISPLAY '** SQLERRMC **       = ' SQLERRMC.                  06070007
                                                                        06080007
           DISPLAY '** SQLWARN0 **       = ' SQLWARN0.                  06090007
           DISPLAY '** SQLWARN1 **       = ' SQLWARN1.                  06100007
           DISPLAY '** SQLWARN2 **       = ' SQLWARN2.                  06110007
           DISPLAY '** SQLWARN3 **       = ' SQLWARN3.                  06120007
           DISPLAY '** SQLWARN4 **       = ' SQLWARN4.                  06130007
           DISPLAY '** SQLWARN5 **       = ' SQLWARN5.                  06140007
           DISPLAY '** SQLWARN6 **       = ' SQLWARN6.                  06150007
           DISPLAY '** SQLWARN7 **       = ' SQLWARN7.                  06160007
           DISPLAY '** ABEND     **'.                                   06170002
           DISPLAY '** PROGRAM   ** = MLKRP059'.                        06180041
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06190002
           DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06200002
                                                                        06210002
      ******************************************************************06220002
      * THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06230002
      * MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06240002
      * 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06250002
      * FORMAT.                                                         06260002
      ******************************************************************06270002
           COPY DPPD004.                                                06280002
                                                                        06290002
           MOVE +4013 TO ABEND-CODE.                                    06300002
           CALL 'ILBOABN0' USING ABEND-CODE.                            06310002
                                                                        06320002
      *                                                                 06330000
      ******************************************************************06340000
       9999-ERROR-ROUTINE.                                              06350000
      ******************************************************************06360000
           MOVE +4013 TO ABEND-CODE.                                    06370000
           CALL 'ILBOABN0' USING ABEND-CODE.                            06380000
      *                                                                 06390000
           EXIT.                                                        06400000
      *                                                                 06410000
      *                                                                 06420000
