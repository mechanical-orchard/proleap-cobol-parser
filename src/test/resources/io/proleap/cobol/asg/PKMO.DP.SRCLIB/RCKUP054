000100******************************************************************00010020
000200 IDENTIFICATION DIVISION.                                         00020020
000300******************************************************************00030020
000400                                                                  00040020
000500 PROGRAM-ID.    RCKUP054.                                         00050020
000600 AUTHOR.        DAN HINTZ.                                        00060020
000700 INSTALLATION.  KOHLS.                                            00070020
000800 DATE-WRITTEN   AUGUST, 1997.                                     00080020
000900 DATE-COMPILED.                                                   00090020
001000                                                                  00100020
001100******************************************************************00110020
001200*  THIS PROGRAM DELETES ALL TDISTHD AND TDISTDT ROWS FOR A       *00120020
001300*  ALL RECORDS FOUND ON THE TDISTHD EXTRACT FILE.  THIS EXTRACT  *00130020
001400*  FILE IS CREATED IN RCKUT054.  THIS FILE CONTAINS ALL OF THE   *00140020
001500*  TDISTHD ROWS WHERE THE RECEIVER HAS BEEN VERIFIED FOR A       *00150020
001600*  SPECIFIED NUMBER OF DAYS.                                     *00160020
001700******************************************************************00170020
001800                                                                  00180020
001900******************************************************************00190020
002000 ENVIRONMENT DIVISION.                                            00200020
002100******************************************************************00210020
002200                                                                  00220020
002300 CONFIGURATION SECTION.                                           00230020
002400                                                                  00240020
002500 SOURCE-COMPUTER.        IBM-3090.                                00250020
002600 OBJECT-COMPUTER.        IBM-3090.                                00260020
002700                                                                  00270020
002800 INPUT-OUTPUT SECTION.                                            00280020
002900                                                                  00290020
003000 FILE-CONTROL.                                                    00300020
003100                                                                  00310020
003200     SELECT DISTRB-HDR-FILE                                       00320020
003300         ASSIGN TO INP01.                                         00330020
003400                                                                  00340020
003500******************************************************************00350020
003600 DATA DIVISION.                                                   00360020
003700******************************************************************00370020
003800                                                                  00380020
003900 FILE SECTION.                                                    00390020
004000                                                                  00400020
004100 FD  DISTRB-HDR-FILE                                              00410020
004200     RECORDING MODE IS F                                          00420020
004300     LABEL RECORDS ARE STANDARD                                   00430020
004400     BLOCK CONTAINS 0 RECORDS.                                    00440020
004500                                                                  00450020
004600 01  DISTRB-HDR-FILE-RECORD     PIC  X(253).                      00460022
004700*                                                                 00470020
004800*                                                                 00480020
004900******************************************************************00490020
005000 WORKING-STORAGE SECTION.                                         00500020
005100******************************************************************00510020
005200*                                                                 00520020
005300*                                                                 00530020
005400******************************************************************00540020
005500** DB2 FORMATTED MESSAGE AREA                                   **00550020
005600******************************************************************00560020
005700     COPY DPWS004.                                                00570020
005800*                                                                 00580020
005900*                                                                 00590020
006000*                                                                 00600020
006100******************************************************************00610020
006200** COMMUNICATIONS AREA FOR DB2                                  **00620020
006300******************************************************************00630020
006400     EXEC SQL                                                     00640020
006500          INCLUDE SQLCA                                           00650020
006600     END-EXEC.                                                    00660020
006700*                                                                 00670020
006800*                                                                 00680020
006900******************************************************************00690020
007000** COBOL DECLARATION AND DCLGEN MEMBER FOR THE DISTRIBUTION     **00700020
007100** HEADER TABLE                                                 **00710020
007200******************************************************************00720020
007300     EXEC SQL                                                     00730020
007400          INCLUDE TDISTHD                                         00740020
007500     END-EXEC.                                                    00750020
007600*                                                                 00760020
007700*                                                                 00770020
007800******************************************************************00780020
007900*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE DISTRIBUTION     **00790020
008000*  DETAIL TABLE                                                 **00800020
008100******************************************************************00810020
008200     EXEC SQL                                                     00820020
008300          INCLUDE TDISTDT                                         00830020
008400     END-EXEC.                                                    00840020
008500*                                                                 00850020
008600*                                                                 00860020
009800*                                                                 00980020
009900 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00990020
010000                                                   COMP SYNC.     01000020
010100                                                                  01010020
010200 01  PS-PROGRAM-SWITCHES.                                         01020020
010300     05  PS-EOF-DISTRB-HDR-FILE-SW   PIC  X(01)    VALUE 'N'.     01030020
010400         88  PS-EOF-DISTRB-HDR-FILE                VALUE 'Y'.     01040020
010500         88  PS-NOT-EOF-DISTRB-HDR-FILE            VALUE 'N'.     01050020
010600     05  PS-EOF-DISTRB-DTL-CSR-SW    PIC  X(01)    VALUE 'N'.     01060020
010700         88  PS-EOF-DISTRB-DTL-CSR                 VALUE 'Y'.     01070020
010800         88  PS-NOT-EOF-DISTRB-DTL-CSR             VALUE 'N'.     01080020
010900                                                                  01090020
011000                                                                  01100020
011100 01  PC-PROGRAM-CONSTANTS.                                        01110020
011200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01120020
011300         'RCKUP054'.                                              01130020
011400     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01140020
011500                                                   COMP SYNC.     01150020
011600                                                                  01160020
011700 01  PV-PROGRAM-VARIABLES.                                        01170020
011800     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01180020
011900     05  PV-DB2-TABLE-NAME-1         PIC  X(30)    VALUE SPACES.  01190020
012000     05  PV-DB2-TABLE-NAME-2         PIC  X(30)    VALUE SPACES.  01200020
012100     05  PV-DB2-OPERATION-MESSAGE    PIC  X(50)    VALUE SPACES.  01210020
012200     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE ZERO     01220020
012300                                                   COMP SYNC.     01230020
012400     05  PV-TDISTHD-READ-CNTR        PIC S9(07)    VALUE ZERO     01240020
012500                                                   COMP-3.        01250020
012600     05  PV-TDISTHD-DELETE-CNTR      PIC S9(07)    VALUE ZERO     01260020
012700                                                   COMP-3.        01270020
012710     05  PV-TDISTHD-COMMIT-CNTR      PIC S9(07)    VALUE ZERO     01271021
012720                                                   COMP-3.        01272021
012800     05  PV-TDISTDT-DELETE-CNTR      PIC S9(07)    VALUE ZERO     01280020
012900                                                   COMP-3.        01290020
012910     05  PV-TDISTDT-COMMIT-CNTR      PIC S9(07)    VALUE ZERO     01291021
012920                                                   COMP-3.        01292021
012930     05  PV-COMMIT-COUNT             PIC S9(07)    VALUE ZERO     01293021
012940                                                   COMP-3.        01294021
013000     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01300020
013100                                                                  01310020
013200     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01320020
013300                                                   COMP-3.        01330020
013400     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01340020
013500     05  PV-RECV-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01350020
013600     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01360020
013700     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01370020
013800     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  01380020
014000     05  PV-COMMIT-TIME-AND-RCVR.                                 01400020
014100         10  FILLER                  PIC X(15)     VALUE          01410020
014200         'RECEIVER/LINE: '.                                       01420020
014300         10  PV-COMMIT-ORD-NBR       PIC 9(08)     VALUE ZEROS.   01430020
014400         10  FILLER                  PIC X(01)     VALUE '-'.     01440020
014500         10  PV-COMMIT-SEQ-NBR       PIC 9(04)     VALUE ZEROS.   01450020
014600         10  FILLER                  PIC X(01)     VALUE '-'.     01460020
014700         10  PV-COMMIT-LINE-NBR      PIC 9(04)     VALUE ZEROS.   01470020
014800         10  FILLER                  PIC X(20)     VALUE          01480020
014900         '  LAST COMMIT TIME: '.                                  01490020
015000         10  PV-LAST-COMMIT-TIMESTAMP                             01500020
015100                                     PIC X(26)     VALUE SPACES.  01510020
015200     05  PV-COMMIT-COUNTS.                                        01520020
015300         10  FILLER                  PIC X(22)     VALUE          01530020
015400         'TDISTHD ROWS DELETED: '.                                01540020
015500         10  PV-TDISTHD-ROWS-DELETED PIC ZZ,ZZZ,ZZ9.              01550020
015600         10  FILLER                  PIC X(23)     VALUE          01560020
015700         ' TDISTDT ROWS DELETED: '.                               01570020
015800         10  PV-TDISTDT-ROWS-DELETED PIC ZZ,ZZZ,ZZ9.              01580020
015900                                                                  01590020
016000*                                                                 01600020
016100*  CURSOR FOR ALL DISTRIBUTION DETAIL ROWS FOR A SPECIFIED LINE   01610020
016200*  OF A RECEIVER.                                                 01620020
016300*                                                                 01630020
016400                                                                  01640020
016500     EXEC SQL                                                     01650020
016600       DECLARE DISTRB_DTL_CURSOR CURSOR WITH HOLD FOR             01660020
016700         SELECT                                                   01670020
016800               ORD_NBR                                            01680020
016900              ,RCVR_SEQ_NBR                                       01690020
017000              ,ORD_LNE_NBR                                        01700020
017100              ,WRK_ORD_SEQ_NBR                                    01710020
017200              ,STR_NBR                                            01720020
017300          FROM TDISTDT                                            01730020
017400         WHERE ORD_NBR      = :DISTHD-ORD-NBR                     01740020
017500           AND RCVR_SEQ_NBR = :DISTHD-RCVR-SEQ-NBR                01750020
017600           AND ORD_LNE_NBR  = :DISTHD-ORD-LNE-NBR                 01760020
017700                                                                  01770020
017800     END-EXEC.                                                    01780020
017900                                                                  01790020
018000                                                                  01800020
018100******************************************************************01810020
018200 PROCEDURE DIVISION.                                              01820020
018300******************************************************************01830020
018400                                                                  01840020
018500******************************************************************01850020
018600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01860020
018700*      PROGRAM.                                                   01870020
018800******************************************************************01880020
018900 0000-PROGRAM-MAINLINE.                                           01890020
019000                                                                  01900020
019100     PERFORM 1000-INITIALIZE.                                     01910020
019200                                                                  01920020
019300     SET PS-NOT-EOF-DISTRB-HDR-FILE TO TRUE.                      01930020
019400     PERFORM 7000-READ-DISTRB-HDR-FILE.                           01940020
019500                                                                  01950020
019600     PERFORM 2000-PROCESS-TDISTHD-RECORDS                         01960020
019700        UNTIL PS-EOF-DISTRB-HDR-FILE.                             01970020
019800                                                                  01980020
019900     CLOSE DISTRB-HDR-FILE.                                       01990020
020000                                                                  02000020
020100     MOVE PV-TDISTHD-READ-CNTR TO PV-DISPLAY-COUNT.               02010020
020200     DISPLAY 'TOTAL DISTRB HDR ROWS READ...: ' PV-DISPLAY-COUNT.  02020020
020300                                                                  02030020
020400     MOVE PV-TDISTHD-DELETE-CNTR TO PV-DISPLAY-COUNT.             02040020
020500     DISPLAY 'TOTAL DISTRB HDR ROWS DELETED: ' PV-DISPLAY-COUNT.  02050020
020600                                                                  02060020
020700     MOVE PV-TDISTDT-DELETE-CNTR TO PV-DISPLAY-COUNT.             02070020
020800     DISPLAY 'TOTAL DISTRB DTL ROWS DELETED: ' PV-DISPLAY-COUNT.  02080020
020801     MOVE PV-COMMIT-COUNT        TO PV-DISPLAY-COUNT.             02080121
020802     DISPLAY 'TOTAL COMMITS TAKEN: ' PV-DISPLAY-COUNT.            02080221
020900                                                                  02090020
021000     STOP RUN.                                                    02100020
021100*                                                                 02110020
021200*0000-EXIT.                                                       02120020
021300*                                                                 02130020
021400*                                                                 02140020
021500******************************************************************02150020
021600*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02160020
021700******************************************************************02170020
021800 1000-INITIALIZE.                                                 02180020
021900*                                                                 02190020
022000     INITIALIZE PV-TDISTHD-READ-CNTR                              02200020
022100                PV-TDISTHD-DELETE-CNTR                            02210020
022200                PV-TDISTDT-DELETE-CNTR                            02220021
022210                PV-TDISTHD-COMMIT-CNTR                            02221021
022220                PV-TDISTDT-COMMIT-CNTR.                           02222021
022300*                                                                 02230020
022400     OPEN INPUT DISTRB-HDR-FILE.                                  02240020
022500*                                                                 02250020
022700*                                                                 02270020
022800*1000-EXIT.                                                       02280020
022900*                                                                 02290020
023000*                                                                 02300020
026100*                                                                 02610020
026200******************************************************************02620020
026300*  PROCESS THE DISTRIBUTION HEADER ROWS THAT ARE IN THE TDISTHD   02630020
026400*  EXTRACT FILE.  DELETE THE ROW FROM THE TDISTHD TABLE.  OPEN    02640020
026500*  OPEN ANOTHER CURSOR AND DELETE ALL OF THE DISTRIBUTION DETAIL  02650020
026600*  ROWS FOR THE SPECIFIED LINE.                                   02660020
026700******************************************************************02670020
026800 2000-PROCESS-TDISTHD-RECORDS.                                    02680020
026900*                                                                 02690020
027000     ADD +1 TO PV-TDISTHD-READ-CNTR.                              02700020
027100*                                                                 02710020
027200     PERFORM 2100-DELETE-TDISTHD-ROW.                             02720020
027300*                                                                 02730020
027400     PERFORM 7100-OPEN-DISTRB-DTL-CURSOR.                         02740020
027500*                                                                 02750020
027600     SET PS-NOT-EOF-DISTRB-DTL-CSR TO TRUE                        02760020
027700     PERFORM 7200-FETCH-DISTRB-DTL-CURSOR.                        02770020
027800*                                                                 02780020
027900     PERFORM 3000-PROCESS-TDISTDT-CURSOR                          02790020
028000         UNTIL PS-EOF-DISTRB-DTL-CSR.                             02800020
028100*                                                                 02810020
028200     PERFORM 7300-CLOSE-DISTRB-DTL-CURSOR.                        02820020
028300*                                                                 02830020
028310     IF PV-TDISTHD-COMMIT-CNTR > 1000 OR                          02831021
028320        PV-TDISTDT-COMMIT-CNTR > 1000                             02832021
029000         PERFORM 2200-COMMIT-CHANGES                              02900021
029200         MOVE 0     TO PV-TDISTHD-COMMIT-CNTR                     02920021
029300         MOVE 0     TO PV-TDISTDT-COMMIT-CNTR                     02930021
030000     END-IF.                                                      03000020
030100*                                                                 03010020
030200     PERFORM 7000-READ-DISTRB-HDR-FILE.                           03020020
030300*                                                                 03030020
030400*2000-EXIT.                                                       03040020
030500*                                                                 03050020
030600*                                                                 03060020
030700******************************************************************03070020
030800*  DELETE THE CURRENT ROW FROM THE TDISTHD TABLE.                 03080020
030900*  IF THE TDISTHD ROW IS NOT FOUND, THAT IS OK.  IF THIS          03090020
031000*  CONDITION HAPPENS, WE ARE IN A RESTART MODE AND THE            03100020
031100*  ROW WAS DELETED IN THE ORIGINAL RUN.                           03110020
031200******************************************************************03120020
031300 2100-DELETE-TDISTHD-ROW.                                         03130020
031400                                                                  03140020
031500     PERFORM WITH TEST AFTER                                      03150020
031600       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       03160020
031700         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES                 03170020
031800                OR                                                03180020
031900                SQLCODE = ZERO                                    03190020
032000                OR                                                03200020
032100                SQLCODE = +100)                                   03210020
032200                                                                  03220020
032300         EXEC SQL                                                 03230020
032400              DELETE FROM TDISTHD                                 03240020
032500                  WHERE ORD_NBR      = :DISTHD-ORD-NBR            03250020
032600                    AND RCVR_SEQ_NBR = :DISTHD-RCVR-SEQ-NBR       03260020
032700                    AND ORD_LNE_NBR  = :DISTHD-ORD-LNE-NBR        03270020
032800         END-EXEC                                                 03280020
032900                                                                  03290020
033000         EVALUATE TRUE                                            03300020
033100             WHEN SQLCODE = ZERO                                  03310020
033200                 ADD +1          TO PV-TDISTHD-DELETE-CNTR        03320020
033210                 ADD +1          TO PV-TDISTHD-COMMIT-CNTR        03321021
033300             WHEN SQLCODE = +100                                  03330020
033400             WHEN SQLCODE = -904                                  03340020
033500             WHEN SQLCODE = -911                                  03350020
033600                 CONTINUE                                         03360020
033700             WHEN SQLWARN0 NOT = SPACES                           03370020
033800             WHEN SQLCODE < ZERO                                  03380020
033900             WHEN SQLCODE > ZERO                                  03390020
034000                 MOVE '2100-DELETE-TDISTHD-ROW        '           03400020
034100                                 TO PV-PARAGRAPH-NAME             03410020
034200                 MOVE 'ERROR DELETING ROW FROM TDISTHD TABLE'     03420020
034300                                 TO PV-DB2-OPERATION-MESSAGE      03430020
034400                 MOVE 'TDISTHD'  TO PV-DB2-TABLE-NAME-1           03440020
034500                 PERFORM 9100-SQL-ABEND                           03450020
034600         END-EVALUATE                                             03460020
034700     END-PERFORM.                                                 03470020
034800                                                                  03480020
034900     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         03490020
035000         MOVE '2100-DELETE-TDISTHD-ROW       '                    03500020
035100                                 TO PV-PARAGRAPH-NAME             03510020
035200         MOVE '** DEADLOCK ENCOUNTERED ON THE DELETE **'          03520020
035300                                 TO PV-DB2-OPERATION-MESSAGE      03530020
035400         MOVE 'TDISTHD'          TO PV-DB2-TABLE-NAME-1           03540020
035500         PERFORM 9100-SQL-ABEND                                   03550020
035600     END-IF.                                                      03560020
035700*2100-EXIT.                                                       03570020
035800*                                                                 03580020
035900*                                                                 03590020
036000******************************************************************03600020
036100*  COMMIT THE CHANGES TO THE TDISTHD AND TDISTDT TABLES.          03610020
036200******************************************************************03620020
036300 2200-COMMIT-CHANGES.                                             03630020
036400                                                                  03640020
036500     EXEC SQL                                                     03650020
036600          COMMIT                                                  03660020
036700     END-EXEC.                                                    03670020
036800                                                                  03680020
036900     EVALUATE TRUE                                                03690020
037000         WHEN SQLCODE = ZERO                                      03700020
037010             ADD +1    TO PV-COMMIT-COUNT                         03701021
037100             MOVE DISTHD-ORD-NBR TO PV-COMMIT-ORD-NBR             03710020
037200             MOVE DISTHD-RCVR-SEQ-NBR                             03720020
037300                                 TO PV-COMMIT-SEQ-NBR             03730020
037400             MOVE DISTHD-ORD-LNE-NBR                              03740020
037500                                 TO PV-COMMIT-LINE-NBR            03750020
037600             MOVE PV-CURRENT-TIMESTAMP                            03760020
037700                                 TO PV-LAST-COMMIT-TIMESTAMP      03770020
037800             MOVE PV-TDISTHD-DELETE-CNTR                          03780020
037900                                 TO PV-TDISTHD-ROWS-DELETED       03790020
038000             MOVE PV-TDISTDT-DELETE-CNTR                          03800020
038100                                 TO PV-TDISTDT-ROWS-DELETED       03810020
038200         WHEN SQLWARN0 NOT = SPACES                               03820020
038300         WHEN SQLCODE < ZERO                                      03830020
038400         WHEN SQLCODE > ZERO                                      03840020
038500             MOVE '2200-COMMIT-CHANGES'                           03850020
038600                                 TO PV-PARAGRAPH-NAME             03860020
038700             MOVE 'ERROR ON COMMIT OF THE CHANGES'                03870020
038800                                 TO PV-DB2-OPERATION-MESSAGE      03880020
038900             MOVE 'TDISTHD'      TO PV-DB2-TABLE-NAME-1           03890020
039000             MOVE 'TDISTDT'      TO PV-DB2-TABLE-NAME-2           03900020
039100             PERFORM 9100-SQL-ABEND                               03910020
039200     END-EVALUATE.                                                03920020
039300*                                                                 03930020
039400*2200-EXIT.                                                       03940020
039500*                                                                 03950020
039600*                                                                 03960020
039700******************************************************************03970020
039800*  PROCESS THE DISTRIBUTION DETAIL ROWS FOR A SPECIFIED RECEIVER  03980020
039900*  LINE, WRITING EACH ROW TO AN ARCHIVE FILE.                     03990020
040000******************************************************************04000020
040100 3000-PROCESS-TDISTDT-CURSOR.                                     04010020
040200*                                                                 04020020
040300     PERFORM 3100-DELETE-TDISTDT-ROW.                             04030020
040400     ADD +1 TO PV-TDISTDT-DELETE-CNTR.                            04040020
040410     ADD +1 TO PV-TDISTDT-COMMIT-CNTR.                            04041021
040500*                                                                 04050020
040600     PERFORM 7200-FETCH-DISTRB-DTL-CURSOR.                        04060020
040700*                                                                 04070020
040800*3000-EXIT.                                                       04080020
040900*                                                                 04090020
041000*                                                                 04100020
041100******************************************************************04110020
041200*  DELETE THE CURRENT ROW FROM THE TDISTDT TABLE.                 04120020
041300******************************************************************04130020
041400 3100-DELETE-TDISTDT-ROW.                                         04140020
041500                                                                  04150020
041600     PERFORM WITH TEST AFTER                                      04160020
041700       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       04170020
041800         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES                 04180020
041900                OR                                                04190020
042000                SQLCODE = ZERO)                                   04200020
042100                                                                  04210020
042200         EXEC SQL                                                 04220020
042300              DELETE FROM TDISTDT                                 04230020
042400                  WHERE CURRENT OF DISTRB_DTL_CURSOR              04240020
042500         END-EXEC                                                 04250020
042600                                                                  04260020
042700         EVALUATE TRUE                                            04270020
042800             WHEN SQLCODE = -904                                  04280020
042900             WHEN SQLCODE = -911                                  04290020
043000                 CONTINUE                                         04300020
043100             WHEN SQLWARN0 NOT = SPACES                           04310020
043200             WHEN SQLCODE < ZERO                                  04320020
043300             WHEN SQLCODE > ZERO                                  04330020
043400                 MOVE '3100-DELETE-TDISTDT-ROW        '           04340020
043500                                 TO PV-PARAGRAPH-NAME             04350020
043600                 MOVE 'ERROR DELETING ROW FROM TDISTDT TABLE'     04360020
043700                                 TO PV-DB2-OPERATION-MESSAGE      04370020
043800                 MOVE 'TDISTDT'  TO PV-DB2-TABLE-NAME-1           04380020
043900                 PERFORM 9100-SQL-ABEND                           04390020
044000             WHEN SQLCODE = ZERO                                  04400020
044100                 CONTINUE                                         04410020
044200         END-EVALUATE                                             04420020
044300     END-PERFORM.                                                 04430020
044400                                                                  04440020
044500     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         04450020
044600         MOVE '3100-DELETE-TDISTDT-ROW       '                    04460020
044700                                 TO PV-PARAGRAPH-NAME             04470020
044800         MOVE '** DEADLOCK ENCOUNTERED ON THE DELETE **'          04480020
044900                                 TO PV-DB2-OPERATION-MESSAGE      04490020
045000         MOVE 'TDISTDT'          TO PV-DB2-TABLE-NAME-1           04500020
045100         PERFORM 9100-SQL-ABEND                                   04510020
045200     END-IF.                                                      04520020
045300*3100-EXIT.                                                       04530020
045400*                                                                 04540020
045500*                                                                 04550020
045600******************************************************************04560020
045700*  READ A RECORD FROM THE DISTRIBUTION HEADER FILE                04570020
045800******************************************************************04580020
045900 7000-READ-DISTRB-HDR-FILE.                                       04590020
046000                                                                  04600020
046100     READ DISTRB-HDR-FILE                                         04610020
046200       INTO DCLTDISTHD                                            04620020
046300           AT END                                                 04630020
046400               SET PS-EOF-DISTRB-HDR-FILE TO TRUE.                04640020
046500*                                                                 04650020
046600*7000-EXIT.                                                       04660020
046700*                                                                 04670020
046800*                                                                 04680020
046900******************************************************************04690020
047000*  OPEN THE DISTRIBUTION DETAIL CURSOR.                           04700020
047100******************************************************************04710020
047200 7100-OPEN-DISTRB-DTL-CURSOR.                                     04720020
047300                                                                  04730020
047400     PERFORM WITH TEST AFTER                                      04740020
047500       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       04750020
047600         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES                 04760020
047700                OR                                                04770020
047800                SQLCODE = ZERO)                                   04780020
047900                                                                  04790020
048000         EXEC SQL                                                 04800020
048100              OPEN DISTRB_DTL_CURSOR                              04810020
048200         END-EXEC                                                 04820020
048300                                                                  04830020
048400         EVALUATE TRUE                                            04840020
048500             WHEN SQLCODE = -904                                  04850020
048600             WHEN SQLCODE = -911                                  04860020
048700                 CONTINUE                                         04870020
048800             WHEN SQLWARN0 NOT = SPACES                           04880020
048900             WHEN SQLCODE < ZERO                                  04890020
049000             WHEN SQLCODE > ZERO                                  04900020
049100                 MOVE '7100-OPEN-DISTRB-DTL-CURSOR    '           04910020
049200                                 TO PV-PARAGRAPH-NAME             04920020
049300                 MOVE 'OPEN THE DISTRB_DTL_CURSOR    '            04930020
049400                                 TO PV-DB2-OPERATION-MESSAGE      04940020
049500                 MOVE 'TDISTDT'  TO PV-DB2-TABLE-NAME-1           04950020
049600                 PERFORM 9100-SQL-ABEND                           04960020
049700             WHEN SQLCODE = ZERO                                  04970020
049800                 CONTINUE                                         04980020
049900         END-EVALUATE                                             04990020
050000     END-PERFORM.                                                 05000020
050100                                                                  05010020
050200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05020020
050300         MOVE '7100-OPEN-DISTRB-DTL-CURSOR   '                    05030020
050400                                 TO PV-PARAGRAPH-NAME             05040020
050500         MOVE 'OPEN MAX RETRIES EXCEEDED     '                    05050020
050600                                 TO PV-DB2-OPERATION-MESSAGE      05060020
050700         MOVE 'TDISTDT'          TO PV-DB2-TABLE-NAME-1           05070020
050800         PERFORM 9100-SQL-ABEND                                   05080020
050900     END-IF.                                                      05090020
051000*7100-EXIT.                                                       05100020
051100*                                                                 05110020
051200*                                                                 05120020
051300******************************************************************05130020
051400*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.         05140020
051500******************************************************************05150020
051600 7200-FETCH-DISTRB-DTL-CURSOR.                                    05160020
051700                                                                  05170020
051800     INITIALIZE DCLTDISTDT.                                       05180020
051900                                                                  05190020
052000     EXEC SQL                                                     05200020
052100          FETCH DISTRB_DTL_CURSOR                                 05210020
052200           INTO :DISTDT-ORD-NBR                                   05220020
052300               ,:DISTDT-RCVR-SEQ-NBR                              05230020
052400               ,:DISTDT-ORD-LNE-NBR                               05240020
052500               ,:DISTDT-WRK-ORD-SEQ-NBR                           05250020
052600               ,:DISTDT-STR-NBR                                   05260020
052700     END-EXEC.                                                    05270020
052800                                                                  05280020
052900     EVALUATE TRUE                                                05290020
053000         WHEN SQLCODE = ZERO                                      05300020
053100             CONTINUE                                             05310020
053200         WHEN SQLCODE = +100                                      05320020
053300             SET PS-EOF-DISTRB-DTL-CSR                            05330020
053400                                 TO TRUE                          05340020
053500         WHEN SQLWARN0 NOT = SPACES                               05350020
053600         WHEN SQLCODE < ZERO                                      05360020
053700         WHEN SQLCODE > ZERO                                      05370020
053800             MOVE '7200-FETCH-DISTRB-DTL-CURSOR  '                05380020
053900                                 TO PV-PARAGRAPH-NAME             05390020
054000             MOVE 'FETCH THE DISTRB_DTL-CURSOR   '                05400020
054100                                 TO PV-DB2-OPERATION-MESSAGE      05410020
054200             MOVE 'TDISTDT'      TO PV-DB2-TABLE-NAME-1           05420020
054300             PERFORM 9100-SQL-ABEND                               05430020
054400     END-EVALUATE.                                                05440020
054500*7200-EXIT.                                                       05450020
054600*                                                                 05460020
054700*                                                                 05470020
054800******************************************************************05480020
054900*  CLOSE THE DISTRIBUTION DETAIL CURSOR                           05490020
055000******************************************************************05500020
055100 7300-CLOSE-DISTRB-DTL-CURSOR.                                    05510020
055200                                                                  05520020
055300     PERFORM WITH TEST AFTER                                      05530020
055400       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       05540020
055500         UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES                 05550020
055600                OR                                                05560020
055700                SQLCODE = ZERO)                                   05570020
055800                                                                  05580020
055900         EXEC SQL                                                 05590020
056000              CLOSE DISTRB_DTL_CURSOR                             05600020
056100         END-EXEC                                                 05610020
056200                                                                  05620020
056300         EVALUATE TRUE                                            05630020
056400             WHEN SQLCODE = -904                                  05640020
056500             WHEN SQLCODE = -911                                  05650020
056600                 CONTINUE                                         05660020
056700             WHEN SQLWARN0 NOT = SPACES                           05670020
056800             WHEN SQLCODE < ZERO                                  05680020
056900             WHEN SQLCODE > ZERO                                  05690020
057000                 MOVE '7300-CLOSE-DISTRB-DTL-CURSOR   '           05700020
057100                                 TO PV-PARAGRAPH-NAME             05710020
057200                 MOVE 'CLOSE THE DISTRB_DTL_CURSOR    '           05720020
057300                                 TO PV-DB2-OPERATION-MESSAGE      05730020
057400                 MOVE 'TDISTDT'  TO PV-DB2-TABLE-NAME-1           05740020
057500                 PERFORM 9100-SQL-ABEND                           05750020
057600             WHEN SQLCODE = ZERO                                  05760020
057700                 CONTINUE                                         05770020
057800         END-EVALUATE                                             05780020
057900     END-PERFORM.                                                 05790020
058000                                                                  05800020
058100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05810020
058200         MOVE '7300-CLOSE-DISTRB-DTL-CURSOR'                      05820020
058300                                 TO PV-PARAGRAPH-NAME             05830020
058400         MOVE 'CLOSE MAX RETRIES EXCEEDED     '                   05840020
058500                                 TO PV-DB2-OPERATION-MESSAGE      05850020
058600         MOVE 'TDISTDT'          TO PV-DB2-TABLE-NAME-1           05860020
058700         PERFORM 9100-SQL-ABEND                                   05870020
058800     END-IF.                                                      05880020
058900*                                                                 05890020
059000*7300-EXIT.                                                       05900020
059100*                                                                 05910020
059200*                                                                 05920020
059300 9100-SQL-ABEND.                                                  05930020
059400******************************************************************05940020
059500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05950020
059600*  ERROR OR WARNING CODE OCCURS.                                  05960020
059700******************************************************************05970020
059800     DISPLAY '9100-SQL-ABEND'.                                    05980020
059900     DISPLAY '** ABEND             **'.                           05990020
060000     DISPLAY '** PROGRAM           ** = '                         06000020
060100                                       PC-CURRENT-PROGRAM-NAME.   06010020
060200     DISPLAY '** PARAGRAPH         ** = '                         06020020
060300                                       PV-PARAGRAPH-NAME.         06030020
060400     DISPLAY '** TABLE(S) AFFECTED ** = '                         06040020
060500                                       PV-DB2-TABLE-NAME-1.       06050020
060600     DISPLAY '**                   ** = '                         06060020
060700                                       PV-DB2-TABLE-NAME-2.       06070020
060800     DISPLAY '** OPERATION         ** = '                         06080020
060900                                       PV-DB2-OPERATION-MESSAGE.  06090020
061000     DISPLAY '**                   ** = '                         06100020
061100     DISPLAY '** LAST COMMIT INFO  ** = '                         06110020
061200                                       PV-COMMIT-TIME-AND-RCVR.   06120020
061300     DISPLAY '**                   ** = '                         06130020
061400                                       PV-COMMIT-COUNTS.          06140020
061500                                                                  06150020
061600******************************************************************06160020
061700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06170020
061800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06180020
061900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06190020
062000* FORMAT.                                                         06200020
062100******************************************************************06210020
062200     COPY DPPD004.                                                06220020
062300                                                                  06230020
062400     EXEC SQL                                                     06240020
062500         ROLLBACK                                                 06250020
062600     END-EXEC.                                                    06260020
062700                                                                  06270020
062800     MOVE +4013                  TO ABEND-CODE.                   06280020
062900     CALL 'ILBOABN0' USING ABEND-CODE.                            06290020
063000*9100-EXIT.                                                       06300020
