000100 IDENTIFICATION DIVISION.                                         00010000
000110                                                                  00011099
000120 TITLE 'CHECK PACK BY STORE ALLOCATIONS'.                         00012099
000130* * THIS WAS COPIED FROM TMKCS508 FOR BATCH PURPOSES              00013099
000140                                                                  00014099
000150 PROGRAM-ID.    TMKUP508.                                         00015099
000160 AUTHOR.        DENNIS STEFFEN - OMNI RESOURCES.                  00016099
000170 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00017099
000180 DATE-WRITTEN.  DECEMBER 2004.                                    00018099
000190 DATE-COMPILED.                                                   00019099
000200***************************************************************** 00020099
000300* Change History                                                * 00030099
000400*    CHANGES                                                    * 00040099
000500*     MADE BY: PRITHIVIRAJ SUBRAMANIAN (COGNIZANT)              * 00050099
000600*     DATE:    10/15/2014                                       * 00060099
000700*                                                               * 00070099
000710*      CHANGES THRU OUT THE PROGRAM TO INCREASE THE SIZE OF PO# * 00071099
000720*      FROM 7 DIGITS TO 8 DIGITS. TAGGED WITH *PS 10/15/2014    * 00072099
000730***************************************************************** 00073099
000740 ENVIRONMENT DIVISION.                                            00074099
000750 CONFIGURATION SECTION.                                           00075099
000760 SOURCE-COMPUTER.        IBM-3090.                                00076099
000770 OBJECT-COMPUTER.        IBM-3090.                                00077099
000780 DATA DIVISION.                                                   00078099
000790 WORKING-STORAGE SECTION.                                         00079099
000800                                                                  00080099
000900 01  PROGRAM-SWITCHES.                                            00090099
001000     05  PS-DONE-SW                   PIC  X    VALUE 'N'.        00100099
001100         88  PS-NOT-DONE                        VALUE 'N'.        00110099
001200         88  PS-DONE                            VALUE 'Y'.        00120099
001300     05  PS-ERRORS-SW                 PIC  X    VALUE 'N'.        00130099
001400         88  PS-NO-ERRORS                       VALUE 'N'.        00140099
001500         88  PS-YES-ERRORS                      VALUE 'Y'.        00150099
001600     05  PS-EOF-RECITM-SW             PIC  X    VALUE 'N'.        00160099
001700         88  PS-EOF-RECITM                      VALUE 'Y'.        00170099
001800     05  PS-EOF-RECDIS-SW             PIC  X    VALUE 'N'.        00180099
001900         88  PS-START-RECDIS                    VALUE 'N'.        00190099
002000         88  PS-EOF-RECDIS                      VALUE 'Y'.        00200099
002100     05  PS-RECITM-CSR-SW             PIC  X    VALUE 'N'.        00210099
002200         88  PS-RECITM-CSR-CLOSED               VALUE 'N'.        00220099
002300         88  PS-RECITM-CSR-OPEN                 VALUE 'Y'.        00230099
002400     05  PS-RECDIS-CSR-SW             PIC  X    VALUE 'N'.        00240099
002500         88  PS-RECDIS-CSR-CLOSED               VALUE 'N'.        00250099
002600         88  PS-RECDIS-CSR-OPEN                 VALUE 'Y'.        00260099
002700     05  PS-DISCREPANCY-SW            PIC  X    VALUE 'N'.        00270099
002800         88  PS-NO-DISCREPANCY                  VALUE 'N'.        00280099
002900         88  PS-DISCREPANCY                     VALUE 'Y'.        00290099
003000     05  PS-CALL-API-SW               PIC  X    VALUE 'N'.        00300099
003100         88  PS-CALL-API-NO                     VALUE 'N'.        00310099
003200         88  PS-CALL-API-YES                    VALUE 'Y'.        00320099
003300                                                                  00330099
003400 01  PROGRAM-VARIABLES.                                           00340099
003500     05  PV-SQLCODE                   PIC S9(9) COMP-4.           00350099
003600     05  PV-DISPLAY-SQLCODE           PIC -Z(8)9.                 00360099
003700*PS 10/15/2014 CHANGE STARTS                                      00370099
003800     05  PV-DISP-PO-NBR               PIC 9(8).                   00380099
003900*PS 10/15/2014 CHANGE ENDS                                        00390099
004000     05  PV-DISP-REC-SEQ-NBR          PIC 9(4).                   00400099
004100     05  PV-DISP-PO-LNE-NBR           PIC 9(3).                   00410099
004200     05  PV-DISP-OPER-UNT-ID          PIC 9(4).                   00420099
004300     05  PV-DISP-FCLTY-ID             PIC 9(4).                   00430099
004400     05  PV-DISP-STR-NBR              PIC 9(4).                   00440099
004500     05  PV-RETURN-MSG                PIC X(40).                  00450099
004600     05  PV-MESSAGE-TEXT              PIC X(79).                  00460099
004700                                                                  00470099
004800     05  PV-TEMP-AMT                  PIC 9(7)V9(2).              00480099
004900     05  PV-TEMP-QTY                  PIC 9(4).                   00490099
005000     05  PV-OP.                                                   00500099
005100         10  PV-OP-N                  PIC 9999.                   00510099
005200     05  PV-FCLTY.                                                00520099
005300         10  PV-FCLTY-N               PIC 9.                      00530099
005400     05  PV-PO.                                                   00540099
005500         10  PV-PO-N                  PIC 9(8).                   00550099
005600     05  PV-LINE.                                                 00560099
005700         10  PV-LINE-N                PIC 999.                    00570099
005800     05  PV-REC-SEQ-NBR.                                          00580099
005900         10  PV-REC-SEQ-NBR-N         PIC 999.                    00590099
006000     05  DK-ITM-NBR                   PIC S9(15)V COMP-3.         00600099
006100     05  PV-UNT-RTL-AMT               PIC S9(7)V9(2).             00610099
006200     05  PV-GP-QTY                    PIC S9(9).                  00620099
006300     05  PV-GP-AMT                    PIC S9(7)V9(2).             00630099
006400                                                                  00640099
006500 01  PROGRAM-KEYS.                                                00650099
006600     05  DK-PO-NBR                    PIC S9(9) COMP VALUE ZERO.  00660099
006700     05  DK-LINE-NBR                  PIC S9(9) COMP VALUE ZERO.  00670099
006800                                                                  00680099
006900 01  PROGRAM-LITERALS.                                            00690099
007000     05  PC-CURRENT-PROGRAM-NAME      PIC X(8)  VALUE 'TMKUP508'. 00700099
007100     05  PC-TROUBLE-WTR               PIC X(8)  VALUE 'TMKUP521'. 00710099
007200     05  PC-TMKUT017                  PIC X(8)  VALUE 'TMKUT017'. 00720099
007300     05  PC-TROUBLE-LENGTH            PIC S9(4) VALUE +600        00730099
007400                                                COMP.             00740099
007500     05  PC-A                         PIC X     VALUE 'A'.        00750099
007600     05  PC-MAX-OCCURENCES            PIC S9(3) VALUE +999        00760099
007700                                                COMP-3.           00770099
007800     05  PC-MAX-RETRIES               PIC S9(4) VALUE +3          00780099
007900                                                COMP SYNC.        00790099
008000     05  PC-000                       PIC X(03) VALUE '000'.      00800099
008100     05  PC-999                       PIC X(03) VALUE '999'.      00810099
008200                                                                  00820099
008300     05  PC-532                       PIC S9(4) COMP VALUE +532.  00830099
008400*  STORE OVER-SHIPPED                                             00840099
008500     05  PC-533                       PIC S9(4) COMP VALUE +533.  00850099
008600     05  PC-600                       PIC S9(4) COMP VALUE +600.  00860099
008700                                                                  00870099
008800     05  PC-PRICE-DISC-TEXT.                                      00880099
008900         10  PC-PRICE-DISC-TEXT-1.                                00890099
009000             15  PC-PD-TEXT-1         PIC X(15) VALUE             00900099
009100             'PO UNIT RTL  : '.                                   00910099
009200             15  PC-PD-PO-UNT-RTL     PIC ZZZZZZ9.99.             00920099
009300             15  PC-PD-TEXT-2         PIC X(15) VALUE             00930099
009400             ' SKU UNIT RTL: '.                                   00940099
009500             15  PC-PD-SKU-UNT-RTL    PIC ZZZZZZ9.99.             00950099
009600         10  PC-PRICE-DISC-TEXT-2.                                00960099
009700             15  PC-PD-TEXT-5         PIC X(21) VALUE             00970099
009800             'PO GRP QTY   :       '.                             00980099
009900             15  PC-PD-PO-GP-QTY      PIC ZZZ9.                   00990099
010000             15  PC-PD-TEXT-6         PIC X(21) VALUE             01000099
010100             ' SKU GRP QTY :       '.                             01010099
010200             15  PC-PD-SKU-GP-QTY     PIC ZZZ9.                   01020099
010300         10  PC-PRICE-DISC-TEXT-3.                                01030099
010400             15  PC-PD-TEXT-3         PIC X(15) VALUE             01040099
010500             'PO GRP RTL   : '.                                   01050099
010600             15  PC-PD-PO-GP-RTL      PIC ZZZZZZ9.99.             01060099
010700             15  PC-PD-TEXT-4         PIC X(15) VALUE             01070099
010800             ' SKU GRP RTL : '.                                   01080099
010900             15  PC-PD-SKU-GP-RTL     PIC ZZZZZZ9.99.             01090099
011000                                                                  01100099
011100*  PACK BY STORE SYSTEM ERROR                                     01110099
011200                                                                  01120099
011300 01  PC-MESSAGE-NUMBERS.                                          01130099
011400     05  PC-TSYMSG-01527              PIC 9(5) VALUE 1527.        01140099
011500*TRANSCRIPTION COMPLETE - PACK-BY-STORE OTR FAILED, CHECK TROUBLE 01150099
011600     05  PC-TSYMSG-01528              PIC 9(5) VALUE 1528.        01160099
011700*TRANSCRIPTION COMPLETE - TROUBLE SYSTEM ERROR                    01170099
011800* - PBS OTR CHECK NOT DONE                                        01180099
011900                                                                  01190099
012000 01  PC-SYSTEM-ERROR-TEXT.                                        01200099
012100     05  FILLER                       PIC X(50) VALUE             01210099
012200         'THE PACKED-BY-STORE OPEN-TO-RECEIVE CHECK HAS     '.    01220099
012300     05  FILLER                       PIC X(50) VALUE             01230099
012400         'ENCOUNTERED A SYSTEM ERROR.  THE CHECK COULD NOT  '.    01240099
012500     05  FILLER                       PIC X(50) VALUE             01250099
012600         'BE COMPLETED.  THIS PO/RECEIVER NEEDS TO BE       '.    01260099
012700     05  FILLER                       PIC X(50) VALUE             01270099
012800         'CHECKED MANUALLY.  LINES PRIOR TO THE LINE WITH   '.    01280099
012900     05  FILLER                       PIC X(50) VALUE             01290099
013000         'THIS ERROR HAVE ALREADY BEEN CHECKED FOR OVERAGES.'.    01300099
013100                                                                  01310099
013200                                                                  01320099
013300 01  PT-STORE-TABLE.                                              01330099
013400     05  PT-STR-NBR                   PIC S9(4) COMP              01340099
013500             OCCURS 999 TIMES INDEXED BY PT-IDX, PT-END-IDX.      01350099
013600                                                                  01360099
013700 01  PRV-PROGRAM-RETURN-VARIABLES.                                01370099
013800     05  PRV-00                       PIC X(42) VALUE             01380099
013900         '00PROGRAM CALL WAS SUCCESSFUL             '.            01390099
014000     05  PRV-01                       PIC X(42) VALUE             01400099
014100         '01DIDNT ALLOCATE TO STORES DUE TO TROUBLE '.            01410099
014200     05  PRV-2A                       PIC X(42) VALUE             01420099
014300         '2ARECORD NOT FOUND - TALLPLN SELECT       '.            01430099
014400     05  PRV-2B                       PIC X(42) VALUE             01440099
014500         '2BDB2-ERROR - TALLPLN SELECT              '.            01450099
014600     05  PRV-2C                       PIC X(42) VALUE             01460099
014700         '2CDB2-ERROR - TRECEIV SELECT              '.            01470099
014800     05  PRV-2D                       PIC X(42) VALUE             01480099
014900         '2DDB2-ERROR - TPURITM SELECT              '.            01490099
015000     05  PRV-2E                       PIC X(42) VALUE             01500099
015100         '2EDB2-ERROR - XLV_SKU SELECT              '.            01510099
015200     05  PRV-2F                       PIC X(42) VALUE             01520099
015300         '2FDB2-ERROR - TCOCNTL SELECT              '.            01530099
015400     05  PRV-2G                       PIC X(42) VALUE             01540099
015500         '2GDB2-ERROR - PRICE-CHANGE-CSR OPEN       '.            01550099
015600     05  PRV-2H                       PIC X(42) VALUE             01560099
015700         '2HDB2-ERROR - PRICE-CHANGE-CSR FETCH      '.            01570099
015800     05  PRV-2I                       PIC X(42) VALUE             01580099
015900         '2IDB2-ERROR - PRICE-CHANGE-CSR CLOSE      '.            01590099
016000     05  PRV-2K                       PIC X(42) VALUE             01600099
016100         '2KDB2-ERROR - TMESTDS SELECT              '.            01610099
016200     05  PRV-2L                       PIC X(42) VALUE             01620099
016300         '2LDB2-ERROR - TVNDSTL SELECT              '.            01630099
016400     05  PRV-2M                       PIC X(42) VALUE             01640099
016500         '2MDB2-ERROR - TWEBITM SELECT              '.            01650099
016600     05  PRV-2N                       PIC X(42) VALUE             01660099
016700         '2EDB2-ERROR - XLV_SKU_STR SELECT          '.            01670099
016800     05  PRV-TM500-RETURN-MSG.                                    01680099
016900         10  PRV-PGM                  PIC X(3).                   01690099
017000         10  FILLER                   PIC X(1).                   01700099
017100         10  PRV-PARA                 PIC X(4).                   01710099
017200         10  FILLER                   PIC X(1).                   01720099
017300         10  PRV-TBL                  PIC X(12).                  01730099
017400         10  FILLER                   PIC X(1).                   01740099
017500         10  PRV-OP                   PIC X(4).                   01750099
017600         10  FILLER                   PIC X(1).                   01760099
017700         10  PRV-FCLTY                PIC X(1).                   01770099
017800         10  FILLER                   PIC X(1).                   01780099
017900         10  PRV-PO                   PIC X(8).                   01790099
018000         10  FILLER                   PIC X(1).                   01800099
018100         10  PRV-LINE                 PIC X(3).                   01810099
018200         10  FILLER                   PIC X(1).                   01820099
018300         10  PRV-REC-SEQ-NBR          PIC X(3).                   01830099
018400         10  FILLER                   PIC X(1).                   01840099
018500                                                                  01850099
018600/                                                                 01860099
018700     COPY TMWS500.                                                01870099
018800/                                                                 01880099
018900     COPY TMWS508.                                                01890099
019000/                                                                 01900099
019100     COPY DPWS276.                                                01910099
019200/                                                                 01920099
019300* ERROR DATA PASSED BACK UPSTREAM.                                01930099
019400     COPY TMRD007.                                                01940099
019500*----------------------------------------------------------------*01950099
019600*  COPYBOOK FOR LOGISTICS DOMAIN ITEM ACCESS MODULE               01960099
019700     COPY XLWS001.                                                01970099
019800*----------------------------------------------------------------*01980099
019900/                                                                 01990099
020000     EXEC SQL                                                     02000099
020100          INCLUDE TRECITM                                         02010099
020200     END-EXEC.                                                    02020099
020300/                                                                 02030099
020400     EXEC SQL                                                     02040099
020500          INCLUDE TRECDIS                                         02050099
020600     END-EXEC.                                                    02060099
020700/                                                                 02070099
020800     EXEC SQL                                                     02080099
020900          INCLUDE TPURITM                                         02090099
021000     END-EXEC.                                                    02100099
021100/                                                                 02110099
021200     EXEC SQL                                                     02120099
021300          INCLUDE TPURCHS                                         02130099
021400     END-EXEC.                                                    02140099
021500/                                                                 02150099
021600*----------------------------------------------------------------*02160099
021700     EXEC SQL                                                     02170099
021800          INCLUDE SQLCA                                           02180099
021900     END-EXEC.                                                    02190099
022000/                                                                 02200099
022100******************************************************************02210099
022200*    THIS IS A LIST OF LINE NUMBERS FOR THE PO, RCVR              02220099
022300******************************************************************02230099
022400     EXEC SQL                                                     02240099
022500          DECLARE RECITM-CSR CURSOR FOR                           02250099
022600          SELECT B.PO_LNE_NBR                                     02260099
022700               , B.APP_PO_LNE_NBR                                 02270099
022800               , B.SKU_SEQ_NBR                                    02280099
022900               , B.UNT_RTL_PR_AMT                                 02290099
023000               , B.ITM_NBR                                        02300099
023100               , B.GP_RTL_AMT                                     02310099
023200               , B.GP_QTY                                         02320099
023300           FROM  TRECITM A                                        02330099
023400               , TPURITM B                                        02340099
023500           WHERE A.ORD_NBR        = :TM508-PO-NBR                 02350099
023600             AND A.OPER_UNT_ID    = :TM508-OPER-UNT-ID            02360099
023700             AND A.REC_SEQ_NBR    = :TM508-REC-SEQ-NBR            02370099
023800                                                                  02380099
023900             AND A.VER_STATUS_CDE = :PC-A                         02390099
024000             AND B.VER_STATUS_CDE = :PC-A                         02400099
024100             AND A.ORD_NBR        =  B.PO_NBR                     02410099
024200             AND A.ORD_LNE_NBR    =  B.APP_PO_LNE_NBR             02420099
024300         ORDER BY B.PO_LNE_NBR                                    02430099
024400     END-EXEC.                                                    02440099
024500/                                                                 02450099
024600******************************************************************02460099
024700*    THIS IS A LIST OF STORES FOR THE PO, RCVR, LINE              02470099
024800******************************************************************02480099
024900     EXEC SQL                                                     02490099
025000          DECLARE RECDIS-CSR CURSOR FOR                           02500099
025100          SELECT STR_NBR                                          02510099
025200            FROM TRECDIS                                          02520099
025300           WHERE ORD_NBR         = :TM508-PO-NBR                  02530099
025400             AND ORD_LNE_NBR     = :PURITM-APP-PO-LNE-NBR         02540099
025500             AND REC_SEQ_NBR     = :TM508-REC-SEQ-NBR             02550099
025600             AND OPER_UNT_ID     = :TM508-OPER-UNT-ID             02560099
025700             AND FCLTY_ID        = :TM508-FCLTY-ID                02570099
025900         ORDER BY STR_NBR                                         02590099
026000     END-EXEC.                                                    02600099
026100/                                                                 02610099
026200 LINKAGE SECTION.                                                 02620099
026300                                                                  02630099
026400 01  LINK-COMMAREA                    PIC X(3200).                02640099
026500 01  LINK-TM007-COMMAREA              PIC X(800).                 02650099
026600                                                                  02660099
026700 PROCEDURE DIVISION USING LINK-COMMAREA                           02670099
026800                          LINK-TM007-COMMAREA.                    02680099
026900                                                                  02690099
027000     PERFORM 1000-HOUSEKEEPING.                                   02700099
027100                                                                  02710099
027200     PERFORM 4000-CHECK-DIRECT-STORE                              02720099
027300                                                                  02730099
027400     MOVE TM508-COMMAREA              TO LINK-COMMAREA.           02740099
027500     MOVE TM007-COMMUNICATIONS-AREA TO LINK-TM007-COMMAREA.       02750099
027600                                                                  02760099
027700     GOBACK.                                                      02770099
027800                                                                  02780099
027900 1000-HOUSEKEEPING.                                               02790099
028000     MOVE LINK-COMMAREA               TO TM508-COMMAREA.          02800099
028100     MOVE LINK-TM007-COMMAREA TO TM007-COMMUNICATIONS-AREA.       02810099
028200                                                                  02820099
028300     MOVE 'TMKUP508'   TO TM007-CALLED-MODULE.                    02830099
028400     INITIALIZE DP276-OTR-TABLE                                   02840099
028500                DP276-RETURN-DATA                                 02850099
028600                PT-STORE-TABLE.                                   02860099
028700                                                                  02870099
028800                                                                  02880099
028900     SET DP276-PACK-BY-STORE          TO TRUE.                    02890099
029000     SET DP276-PO-OTR                 TO TRUE.                    02900099
029100                                                                  02910099
029200     MOVE TM508-PO-NBR                TO DP276-PO-NBR             02920099
029300     MOVE TM508-REC-SEQ-NBR           TO DP276-REC-SEQ-NBR        02930099
029400     MOVE TM508-OPER-UNT-ID           TO DP276-OPER-UNT-ID        02940099
029500     MOVE TM508-FCLTY-ID              TO DP276-FCLTY-ID.          02950099
029600                                                                  02960099
029700******************************************************************02970099
029800 4000-CHECK-DIRECT-STORE.                                         02980099
029900******************************************************************02990099
030000                                                                  03000099
030100     PERFORM 7000-OPEN-RECITM-CSR.                                03010099
030200                                                                  03020099
030300     IF PS-RECITM-CSR-OPEN                                        03030099
030400         PERFORM 7100-FETCH-RECITM-CSR                            03040099
030500     END-IF.                                                      03050099
030600                                                                  03060099
030700     IF PS-NO-ERRORS                                              03070099
030800         PERFORM 4100-PROCESS-RECITMS UNTIL PS-EOF-RECITM         03080099
030900             OR PS-YES-ERRORS                                     03090099
031000     END-IF                                                       03100099
031100                                                                  03110099
031200     IF PS-RECITM-CSR-OPEN                                        03120099
031300         PERFORM 7200-CLOSE-RECITM-CSR                            03130099
031400     END-IF.                                                      03140099
031500/                                                                 03150099
031600 4100-PROCESS-RECITMS.                                            03160099
031700                                                                  03170099
031800     MOVE PURITM-PO-LNE-NBR           TO DP276-PO-LNE-NBR.        03180099
031900                                                                  03190099
032000     PERFORM 4110-CALC-OTR.                                       03200099
032100                                                                  03210099
032200* DPKCS276 WILL ALLOW A NEGATIVE OTR FOR A PACK-BY-STORE RECEIVER.03220099
032300* DPKCS276 DEALS WITH ALL STORES IN TMESTDS FOR THE PO.  WE ARE   03230099
032400* ONLY CONCERNED WITH THE STORES IN THE CURRENT RCVR AND LINE.    03240099
032500* THE TWO LISTS MAY NOT BE THE SAME.                              03250099
032600                                                                  03260099
032700     PERFORM 4200-TABLIZE-STORES                                  03270099
032800                                                                  03280099
032900     PERFORM 4300-CHECK-RCVR-STORES                               03290099
033000                                                                  03300099
033100     PERFORM 7100-FETCH-RECITM-CSR.                               03310099
033200*----------------------------------------------------------------*03320099
033300 4110-CALC-OTR.                                                   03330099
033400                                                                  03340099
033500     CALL PC-TMKUT017 USING DP276-COMMAREA                        03350099
033600                            TM007-COMMUNICATIONS-AREA.            03360099
033700                                                                  03370099
033800     MOVE 'TMKUT017'  TO TM007-CALLED-MODULE.                     03380099
033900                                                                  03390099
034000*  CHECK DP276-RETURN-CODE                                        03400099
034100     EVALUATE TRUE                                                03410099
034200     WHEN DP276-RETURN-CODE = ZERO                                03420099
034300         CONTINUE                                                 03430099
034400     WHEN OTHER                                                   03440099
034500         EVALUATE TRUE                                            03450099
034600         WHEN DP276-SOFT-ABORT                                    03460099
034700         WHEN DP276-NO-DISTRO                                     03470099
034800             MOVE 1                   TO TM508-RETURN-CODE        03480099
034900             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         03490099
035000             PERFORM 9900-SOFT-ABORT                              03500099
035100         WHEN OTHER                                               03510099
035200             MOVE 2                   TO TM508-RETURN-CODE        03520099
035300             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         03530099
035400             PERFORM 9800-CROAK                                   03540099
035500         END-EVALUATE                                             03550099
035600     END-EVALUATE.                                                03560099
035700/                                                                 03570099
035800 4200-TABLIZE-STORES.                                             03580099
035900                                                                  03590099
036000     SET PS-START-RECDIS TO TRUE.                                 03600099
036100     PERFORM 7300-OPEN-RECDIS-CSR.                                03610099
036200                                                                  03620099
036300     IF PS-RECDIS-CSR-OPEN                                        03630099
036400         PERFORM 7400-FETCH-RECDIS-CSR                            03640099
036500     END-IF                                                       03650099
036600                                                                  03660099
036700     IF PS-NO-ERRORS                                              03670099
036800         PERFORM VARYING PT-IDX FROM 1 BY 1                       03680099
036900                 UNTIL PS-EOF-RECDIS OR PT-IDX > 999              03690099
037000             MOVE RECDIS-STR-NBR      TO PT-STR-NBR (PT-IDX)      03700099
037100             SET PT-END-IDX           TO PT-IDX                   03710099
037200             PERFORM 7400-FETCH-RECDIS-CSR                        03720099
037300         END-PERFORM                                              03730099
037400     END-IF.                                                      03740099
037500                                                                  03750099
037600     IF PS-RECDIS-CSR-OPEN                                        03760099
037700         PERFORM 7500-CLOSE-RECDIS-CSR                            03770099
037800     END-IF.                                                      03780099
037900                                                                  03790099
038000/                                                                 03800099
038100 4300-CHECK-RCVR-STORES.                                          03810099
038200                                                                  03820099
038300* FOR EACH STORE ON THE GIVEN PO, RECEIVER, AND LINE, CHECK TO    03830099
038400* SEE IF IT HAS A NEGATIVE OTR.  THIS WOULD DENOTE AN             03840099
038500* OVER-SHIPMENT OF THE MDSE FOR THAT STORE.  THE PRESENCE OF THE  03850099
038600* FIRST ERROR PUTS THE LINE IN ERROR.  SO WRITE THE TROUBLE ROW   03860099
038700* AND CONTINUE WITH THE OTHER LINES IN THE RECEIVER.              03870099
038800* IF A STORE ISN'T FOUND IN THE OTR TABLE THEN IT HAS RECEIVED    03880099
038900* MERCHANDISE THAN IT WASN'T SUPPOSED TO HAVE.  THIS WOULD ALSO   03890099
039000* CAUSE THE LINE TO BE PUT INTO TROUBLE AS AN OVERAGE JUST LIKE   03900099
039100* A NEGATIVE OTR.                                                 03910099
039200*                                                                 03920099
039300     PERFORM 4310-STORE-SEARCH                                    03930099
039400         VARYING PT-IDX FROM 1 BY 1                               03940099
039500         UNTIL                                                    03950099
039600             PT-IDX > 999 OR                                      03960099
039700             PT-IDX > PT-END-IDX OR                               03970099
039800             PT-STR-NBR(PT-IDX) = ZERO.                           03980099
039900                                                                  03990099
040000 4310-STORE-SEARCH.                                               04000099
040100                                                                  04010099
040200     MOVE PT-STR-NBR(PT-IDX) TO DP276-SEARCH-NBR                  04020099
040300     SET DP276-IDX TO 1                                           04030099
040400     SEARCH DP276-WORK-AREA                                       04040099
040500         WHEN DP276-STORE-NBR (DP276-IDX) = ZERO                  04050099
040600             MOVE PC-532    TO TM500-TRBL-RSN-CDE                 04060099
040700             SET TM500-NO-DETAILS                                 04070099
040800                            TO TRUE                               04080099
040900             SET TM500-CREATE-AUTO TO TRUE                        04090099
041000             PERFORM 5000-MAKE-TROUBLE                            04100099
041100             SET PT-IDX TO 999                                    04110099
041200         WHEN DP276-STORE-NBR (DP276-IDX) = DP276-SEARCH-NBR      04120099
041300             IF DP276-OTR-QTY (DP276-IDX) < ZERO                  04130099
041400                 MOVE PC-532                                      04140099
041500                            TO TM500-TRBL-RSN-CDE                 04150099
041600                 SET TM500-NO-DETAILS                             04160099
041700                            TO TRUE                               04170099
041800                 SET TM500-CREATE-AUTO TO TRUE                    04180099
041900                 PERFORM 5000-MAKE-TROUBLE                        04190099
042000                 SET PT-IDX TO 999                                04200099
042100             END-IF                                               04210099
042200     END-SEARCH.                                                  04220099
042300/                                                                 04230099
042400 5000-MAKE-TROUBLE.                                               04240099
042500                                                                  04250099
042600     MOVE TM508-PO-NBR             TO TM500-PO-NBR.               04260099
042700     MOVE PURITM-APP-PO-LNE-NBR    TO TM500-PO-LNE-NBR.           04270099
042800     MOVE TM508-OPER-UNT-ID        TO TM500-OPER-UNT-ID.          04280099
042900     MOVE TM508-FCLTY-ID           TO TM500-FCLTY-ID.             04290099
043000     MOVE TM508-REC-SEQ-NBR        TO TM500-REC-SEQ-NBR.          04300099
043100     MOVE PC-CURRENT-PROGRAM-NAME  TO TM500-NOTIF-UID.            04310099
043200                                                                  04320099
043300     CALL PC-TROUBLE-WTR USING TM500-FIELDS                       04330099
043400                               TM007-COMMUNICATIONS-AREA.         04340099
043500                                                                  04350099
043600     MOVE 'TMKUP521'  TO TM007-CALLED-MODULE.                     04360099
043700                                                                  04370099
043800     EVALUATE TRUE                                                04380099
043900         WHEN TM500-CALL-SUCCESSFUL                               04390099
044000         WHEN TM500-DUPLICATE-TROUBLE                             04400099
044100         WHEN TM500-TTRBNTF-UPDATE-NOT-FND                        04410099
044200         WHEN TM500-DIDNT-ALLOC-DUE-TO-TRBL                       04420099
044300             CONTINUE                                             04430099
044400                                                                  04440099
044500         WHEN OTHER                                               04450099
044600             MOVE 999                 TO TM508-RETURN-CODE        04460099
044700             MOVE PC-TSYMSG-01528     TO TM508-MSG-NUMBER         04470099
044800             PERFORM 9800-CROAK                                   04480099
044900     END-EVALUATE.                                                04490099
045000                                                                  04500099
045100     ADD 1 TO TM508-TROUBLE-COUNT.                                04510099
045200/                                                                 04520099
045300 7000-OPEN-RECITM-CSR.                                            04530099
045400     MOVE '7000-OPEN-RECITM-CSR'    TO TM007-RETURNED-PARA.       04540099
045500                                                                  04550099
045600     EXEC SQL                                                     04560099
045700         OPEN RECITM-CSR                                          04570099
045800     END-EXEC.                                                    04580099
045900                                                                  04590099
046000     EVALUATE TRUE                                                04600099
046100         WHEN SQLCODE = ZERO                                      04610099
046200             SET PS-RECITM-CSR-OPEN   TO TRUE                     04620099
046300         WHEN SQLCODE = -904                                      04630099
046400         WHEN SQLCODE = -911                                      04640099
046500         WHEN SQLCODE = -913                                      04650099
046600             MOVE SQLCODE             TO TM007-SQLCODE            04660099
046700             MOVE SQLCA               TO TM007-SQLCA              04670099
046800             MOVE '03'                TO TM007-RETURN-CODE        04680099
046900             MOVE 3                   TO TM508-RETURN-CODE        04690099
047000             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         04700099
047100             PERFORM 9900-SOFT-ABORT                              04710099
047200         WHEN OTHER                                               04720099
047300             MOVE SQLCODE             TO TM007-SQLCODE            04730099
047400             MOVE SQLCA               TO TM007-SQLCA              04740099
047500             MOVE '04'                TO TM007-RETURN-CODE        04750099
047600             MOVE 4                   TO TM508-RETURN-CODE        04760099
047700             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         04770099
047800             PERFORM 9800-CROAK                                   04780099
047900     END-EVALUATE.                                                04790099
048000/                                                                 04800099
048100 7100-FETCH-RECITM-CSR.                                           04810099
048200     MOVE '7100-FETCH-RECITM-CSR'   TO TM007-RETURNED-PARA.       04820099
048300                                                                  04830099
048400     EXEC SQL                                                     04840099
048500         FETCH RECITM-CSR                                         04850099
048600         INTO   :PURITM-PO-LNE-NBR                                04860099
048700              , :PURITM-APP-PO-LNE-NBR                            04870099
048800              , :PURITM-SKU-SEQ-NBR                               04880099
048900              , :PURITM-UNT-RTL-PR-AMT                            04890099
049000              , :PURITM-ITM-NBR                                   04900099
049100              , :PURITM-GP-RTL-AMT                                04910099
049200              , :PURITM-GP-QTY                                    04920099
049300     END-EXEC.                                                    04930099
049400                                                                  04940099
049500     MOVE ZEROES TO DK-ITM-NBR                                    04950099
049600                                                                  04960099
049700     EVALUATE TRUE                                                04970099
049800         WHEN SQLCODE = ZERO                                      04980099
049900             SET PS-CALL-API-YES     TO TRUE                      04990099
050000             MOVE PURITM-ITM-NBR     TO DK-ITM-NBR                05000099
050100             CONTINUE                                             05010099
050200         WHEN SQLCODE = +100                                      05020099
050300             SET PS-EOF-RECITM     TO TRUE                        05030099
050400         WHEN OTHER                                               05040099
050500             MOVE SQLCODE          TO TM007-SQLCODE               05050099
050600             MOVE SQLCA            TO TM007-SQLCA                 05060099
050700             MOVE '05'                TO TM007-RETURN-CODE        05070099
050800             MOVE 5                   TO TM508-RETURN-CODE        05080099
050900             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05090099
051000             PERFORM 9800-CROAK                                   05100099
051100     END-EVALUATE.                                                05110099
051200/                                                                 05120099
051300 7200-CLOSE-RECITM-CSR.                                           05130099
051400     MOVE '7200-CLOSE-RECITM-CSR'   TO TM007-RETURNED-PARA.       05140099
051500                                                                  05150099
051600     EXEC SQL                                                     05160099
051700         CLOSE RECITM-CSR                                         05170099
051800     END-EXEC.                                                    05180099
051900                                                                  05190099
052000     EVALUATE TRUE                                                05200099
052100         WHEN SQLCODE = ZERO                                      05210099
052200             SET PS-RECITM-CSR-CLOSED TO TRUE                     05220099
052300         WHEN OTHER                                               05230099
052400             MOVE SQLCODE             TO TM007-SQLCODE            05240099
052500             MOVE SQLCA               TO TM007-SQLCA              05250099
052600             MOVE '06'                TO TM007-RETURN-CODE        05260099
052700             MOVE 6                   TO TM508-RETURN-CODE        05270099
052800             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05280099
052900             PERFORM 9800-CROAK                                   05290099
053000     END-EVALUATE.                                                05300099
053100/                                                                 05310099
053200 7300-OPEN-RECDIS-CSR.                                            05320099
053300                                                                  05330099
053400     MOVE '7300-OPEN-RECDIS-CSR'    TO TM007-RETURNED-PARA.       05340099
053500                                                                  05350099
053600     SET PS-RECDIS-CSR-CLOSED TO TRUE                             05360099
053700                                                                  05370099
053800     EXEC SQL                                                     05380099
053900         OPEN RECDIS-CSR                                          05390099
054000     END-EXEC.                                                    05400099
054100                                                                  05410099
054200     EVALUATE TRUE                                                05420099
054300         WHEN SQLCODE = ZERO                                      05430099
054400             SET PS-RECDIS-CSR-OPEN TO TRUE                       05440099
054500         WHEN SQLCODE = -904                                      05450099
054600         WHEN SQLCODE = -911                                      05460099
054700         WHEN SQLCODE = -913                                      05470099
054800             MOVE SQLCODE             TO TM007-SQLCODE            05480099
054900             MOVE SQLCA               TO TM007-SQLCA              05490099
055000             MOVE '07'                TO TM007-RETURN-CODE        05500099
055100             MOVE 7                   TO TM508-RETURN-CODE        05510099
055200             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05520099
055300             PERFORM 9900-SOFT-ABORT                              05530099
055400         WHEN OTHER                                               05540099
055500             MOVE SQLCODE             TO TM007-SQLCODE            05550099
055600             MOVE SQLCA               TO TM007-SQLCA              05560099
055700             MOVE '08'                TO TM007-RETURN-CODE        05570099
055800             MOVE 8                   TO TM508-RETURN-CODE        05580099
055900             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05590099
056000             PERFORM 9800-CROAK                                   05600099
056100     END-EVALUATE.                                                05610099
056200/                                                                 05620099
056300 7400-FETCH-RECDIS-CSR.                                           05630099
056400     MOVE '7400-FETCH-RECDIS-CSR'   TO TM007-RETURNED-PARA.       05640099
056500                                                                  05650099
056600     EXEC SQL                                                     05660099
056700         FETCH RECDIS-CSR                                         05670099
056800         INTO   :RECDIS-STR-NBR                                   05680099
056900     END-EXEC.                                                    05690099
057000                                                                  05700099
057100     EVALUATE TRUE                                                05710099
057200         WHEN SQLCODE = ZERO                                      05720099
057300             CONTINUE                                             05730099
057400         WHEN SQLCODE = +100                                      05740099
057500             SET PS-EOF-RECDIS        TO TRUE                     05750099
057600         WHEN OTHER                                               05760099
057700             MOVE SQLCODE             TO TM007-SQLCODE            05770099
057800             MOVE SQLCA               TO TM007-SQLCA              05780099
057900             MOVE '09'                TO TM007-RETURN-CODE        05790099
058000             MOVE 9                   TO TM508-RETURN-CODE        05800099
058100             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05810099
058200             PERFORM 9800-CROAK                                   05820099
058300     END-EVALUATE.                                                05830099
058400/                                                                 05840099
058500 7500-CLOSE-RECDIS-CSR.                                           05850099
058600     MOVE '7500-CLOSE-RECDIS-CSR'   TO TM007-RETURNED-PARA.       05860099
058700                                                                  05870099
058800     EXEC SQL                                                     05880099
058900         CLOSE RECDIS-CSR                                         05890099
059000     END-EXEC.                                                    05900099
059100                                                                  05910099
059200     EVALUATE TRUE                                                05920099
059300         WHEN SQLCODE = ZERO                                      05930099
059400             CONTINUE                                             05940099
059500         WHEN OTHER                                               05950099
059600             MOVE SQLCODE             TO TM007-SQLCODE            05960099
059700             MOVE SQLCA               TO TM007-SQLCA              05970099
059800             MOVE '10'                TO TM007-RETURN-CODE        05980099
059900             MOVE 10                  TO TM508-RETURN-CODE        05990099
060000             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         06000099
060100             PERFORM 9800-CROAK                                   06010099
060200     END-EVALUATE.                                                06020099
060300/                                                                 06030099
060400*----------------------------------------------------------------*06040099
060500*    WHEN A FATAL ERROR OCCURS PASS THE ERROR SWITCHES BACK TO    06050099
060600*    THE HOST PROGRAM AND DISPLAY MESSAGES.                      *06060099
060700*----------------------------------------------------------------*06070099
060800 9800-CROAK.                                                      06080099
060900                                                                  06090099
061000     SET PS-YES-ERRORS                TO TRUE                     06100099
061100     SET TM508-FATAL-ERROR                                        06110099
061200         TM508-CROAK                  TO TRUE                     06120099
061300     MOVE SQLCODE                     TO PV-SQLCODE               06130099
061400     MOVE '01'                        TO TM007-RETURN-CODE        06140099
061500                                                                  06150099
061600* IF AN ERROR OCCURRED BEFORE A LINE NUMBER IS AVAILABLE, MOVE 99906160099
061700* TO MAKE THE ROW ACCESSABLE TO THE TROUBLE RESOLUTION SCREENS.   06170099
061800                                                                  06180099
061900     IF PURITM-APP-PO-LNE-NBR         = ZERO                      06190099
062000         MOVE 1                       TO PURITM-APP-PO-LNE-NBR    06200099
062100                                         DP276-PO-LNE-NBR         06210099
062200     END-IF                                                       06220099
062300                                                                  06230099
062400     PERFORM 9950-FORMAT-ERROR-MSG.                               06240099
062500                                                                  06250099
062600* IF TROUBLE ITSELF HAS ABENDED WE CAN'T INVOKE IT AGAIN.         06260099
062700     IF TM508-RETURN-CODE = 999                                   06270099
062800         CONTINUE                                                 06280099
062900     ELSE                                                         06290099
063000         PERFORM 9810-WRITE-ABEND-TRBL                            06300099
063100     END-IF.                                                      06310099
063200                                                                  06320099
063300 9810-WRITE-ABEND-TRBL.                                           06330099
063400                                                                  06340099
063500     MOVE PC-533            TO TM500-TRBL-RSN-CDE                 06350099
063600     SET TM500-ADD-DETAILS  TO TRUE                               06360099
063700     SET TM500-CREATE-AUTO  TO TRUE                               06370099
063800     MOVE PC-SYSTEM-ERROR-TEXT TO TM500-FREEFORM-TEXT.            06380099
063900     PERFORM 5000-MAKE-TROUBLE.                                   06390099
064000                                                                  06400099
064100*----------------------------------------------------------------*06410099
064200*    THE DB2 RESOURCE IS NOT AVAILABLE, PASS THE ERROR SWITCHES  *06420099
064300*    BACK TO THE HOST PROGRAM AND DISPLAY MESSAGES.              *06430099
064400*----------------------------------------------------------------*06440099
064500 9900-SOFT-ABORT.                                                 06450099
064600                                                                  06460099
064700                                                                  06470099
064800* IF AN ERROR OCCURRED BEFORE A LINE NUMBER IS AVAILABLE, MOVE 99906480099
064900* TO MAKE THE ROW ACCESSABLE TO THE TROUBLE RESOLUTION SCREENS.   06490099
065000                                                                  06500099
065100     IF PURITM-APP-PO-LNE-NBR         = ZERO                      06510099
065200         MOVE 1                       TO PURITM-APP-PO-LNE-NBR    06520099
065300                                         DP276-PO-LNE-NBR         06530099
065400     END-IF                                                       06540099
065500                                                                  06550099
065600     PERFORM 9810-WRITE-ABEND-TRBL                                06560099
065700                                                                  06570099
065800     SET PS-YES-ERRORS                                            06580099
065900         TM508-FATAL-ERROR                                        06590099
066000         TM508-SOFT-ABORT             TO TRUE.                    06600099
066100     MOVE '01' TO TM007-RETURN-CODE.                              06610099
066200                                                                  06620099
066300     PERFORM 9950-FORMAT-ERROR-MSG.                               06630099
066400                                                                  06640099
066500 9950-FORMAT-ERROR-MSG.                                           06650099
066600                                                                  06660099
066700     MOVE SQLCODE                     TO PV-SQLCODE               06670099
066800                                         PV-DISPLAY-SQLCODE       06680099
066900                                         TM007-SQLCODE.           06690099
067000                                                                  06700099
067100     MOVE DP276-PO-NBR                TO PV-DISP-PO-NBR           06710099
067200                                         TM007-PO-NBR.            06720099
067300     IF DP276-PO-LNE-NBR = ZERO                                   06730099
067400         MOVE DK-LINE-NBR             TO PV-DISP-PO-LNE-NBR       06740099
067500     ELSE                                                         06750099
067600         MOVE DP276-PO-LNE-NBR        TO PV-DISP-PO-LNE-NBR       06760099
067700     END-IF                                                       06770099
067800     MOVE DP276-REC-SEQ-NBR           TO PV-DISP-REC-SEQ-NBR      06780099
067900                                         TM007-REC-SEQ-NBR.       06790099
068000     MOVE DP276-OPER-UNT-ID           TO PV-DISP-OPER-UNT-ID      06800099
068100                                         TM007-OPER-UNT-ID.       06810099
068200     MOVE DP276-FCLTY-ID              TO PV-DISP-FCLTY-ID.        06820099
068300     MOVE DP276-STR-NBR               TO PV-DISP-STR-NBR.         06830099
068400                                                                  06840099
068500     STRING '** TMKUP508 ** ERROR; '                              06850099
068600         PV-RETURN-MSG DELIMITED BY SIZE                          06860099
068700                                 INTO PV-MESSAGE-TEXT             06870099
068800     STRING '** TMKUP508 ** ERROR; '                              06880099
068900         PV-RETURN-MSG DELIMITED BY SIZE                          06890099
069000                                 INTO TM007-RETURN-MSG            06900099
069100     DISPLAY PV-MESSAGE-TEXT                                      06910099
069200                                                                  06920099
069300     STRING  ' DP276-RC = ' DP276-RETURN-CODE                     06930099
069400             '; SQLCODE = ' PV-DISPLAY-SQLCODE                    06940099
069500                                  DELIMITED BY SIZE               06950099
069600                                 INTO PV-MESSAGE-TEXT             06960099
069700     DISPLAY PV-MESSAGE-TEXT                                      06970099
069800                                                                  06980099
069900     MOVE '  PO    REC  LNE OPER FCLTY STR'                       06990099
070000                                   TO PV-MESSAGE-TEXT             07000099
070100     DISPLAY PV-MESSAGE-TEXT                                      07010099
070200                                                                  07020099
070300     STRING                                                       07030099
070400         PV-DISP-PO-NBR '-'                                       07040099
070500         PV-DISP-REC-SEQ-NBR '-'                                  07050099
070600         PV-DISP-PO-LNE-NBR '-'                                   07060099
070700         PV-DISP-OPER-UNT-ID '-'                                  07070099
070800         PV-DISP-FCLTY-ID '-'                                     07080099
070900         PV-DISP-STR-NBR                                          07090099
071000         DELIMITED BY SIZE INTO PV-MESSAGE-TEXT                   07100099
071100     DISPLAY PV-MESSAGE-TEXT.                                     07110099
071200                                                                  07120099
071300******************************************************************07130099
071400 9999-RETURN-MSG.                                                 07140099
071500******************************************************************07150099
071600                                                                  07160099
071700     COMPUTE PV-OP-N = TM500-OPER-UNT-ID * 1.                     07170099
071800     COMPUTE PV-FCLTY-N = TM500-FCLTY-ID * 1.                     07180099
071900     COMPUTE PV-PO-N = TM500-PO-NBR      * 1.                     07190099
072000     COMPUTE PV-LINE-N = TM500-PO-LNE-NBR * 1.                    07200099
072100     COMPUTE PV-REC-SEQ-NBR-N = TM500-REC-SEQ-NBR * 1.            07210099
072200                                                                  07220099
072300     MOVE '018'                 TO PRV-PGM.                       07230099
072400     MOVE PV-OP                 TO PRV-OP.                        07240099
072500     MOVE PV-FCLTY              TO PRV-FCLTY.                     07250099
072600     MOVE PV-PO                 TO PRV-PO.                        07260099
072700     MOVE PV-LINE               TO PRV-LINE.                      07270099
072800     MOVE PV-REC-SEQ-NBR        TO PRV-REC-SEQ-NBR.               07280099
072900                                                                  07290099
073000     MOVE PRV-TM500-RETURN-MSG  TO TM500-RETURN-MSG.              07300099
073100     MOVE TM500-RETURN-MSG      TO TM007-RETURN-MSG.              07310099
