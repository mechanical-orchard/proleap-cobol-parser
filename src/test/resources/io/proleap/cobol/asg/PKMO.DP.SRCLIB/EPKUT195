000100*------------------------------------------------------------     00002000
000200 IDENTIFICATION DIVISION.                                         00003000
000300*------------------------------------------------------------     00004000
000400 PROGRAM-ID.    EPKUT195.                                         00005000
000500 AUTHOR.        CHERI PARMLEY.                                    00006000
000510 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00007000
000600 DATE-WRITTEN.  MARCH 19, 2010.                                   00008000
000700                                                                  00009000
000800*-------------------------------------------------------------*   00010000
000900*              REBATE DATA DUPLICATE ELIMINATOR               *   00020000
001000*-------------------------------------------------------------*   00030000
001100*    THIS PROGRAM WILL READ IN THE NEW REBATE EXTRACT RECORDS *   00040000
001200*    FROM MULTIPLE PROCESSES.  FILES WILL BE CONCATENATED     *   00050000
001300*    TOGETHER AND SORTED VARIOUS TIMES BEFORE THIS PROGRAM    *   00060000
001300*    CAN BE RUN.                                             *    00070000
001300*    FIRST SORT WILL GET THE SOR-DATE IN THE DESCENDING       *   00080000
001300*    SEQUENCE (GREATER DATE/TIME FIRST) - IT IS UNDER THE     *   00090000
001300*    ASSUMPTION THAT THE SOR-DATE ALSO IS THE SAME FOR EACH   *   00100000
001300*    ROW WITHIN THE REBT-FM-ID, MERCH-LNE-ID AND PROMO-INTFC- *   00110000
001300*    ID (FOR EACH LINE#)                                      *   00120000
001300*    SECOND SORT WILL SORT THE PROMO-INTFC-ID, MERCH-LNE-ID   *   00130000
001300*    AND REBT-FM-ID. THIS WILL PLACE THE ENTIRE FORM (ALL     *   00140000
001300*    LINES WITHIN) RIGHT NEXT TO EACH OTHER IN SEQUENCE.      *   00150000
001300*                                                             *   00160000
001300*    THEN THE FILE CAN BE READ WRITTING OUT THE MOST NEWEST   *   00170000
001300*    DATE/TIME FORMS FIRST AND BYPASSING ALL THE REMAINING    *   00180000
001300*    FOR THAT PARTICULAR PROMO-INFC-ID, MERCH-LNE-ID,         *   00181000
001300*    REBT-FM-ID COMBINATION.                                  *   00181100
001060*------------------------------------------------------------ *   00181200
003800*  INPUT:                                                     *   00181300
003900*        REBATE-FORM-FILE                 EPRD231             *   00181400
004400*                                                             *   00181500
004500*  OUTPUT:                                                    *   00181600
004600*        MERGED-FORM-FILE                 EPRD231             *   00181700
004700*                                                             *   00181800
004800*-------------------------------------------------------------*   00181900
004900* HISTORY LOG:                                                *   00182000
005000*                                                             *   00183000
005100*-------------------------------------------------------------*   00184000
005200* DATE: MARCH 19, 2010                                        *   00185000
005300* WR/IR#: WR #38172                                           *   00186000
005400* PROGRAMMER: CHERI PARMLEY                                   *   00187000
005500* DESCRIPTION: INITIAL PROGRAM CREATION                       *   00188000
005600*-------------------------------------------------------------*   00189000
005610* DATE:   JULY 30, 2010                                       *   00190002
005620* WR/IR#: WR #38172                                           *   00200002
005630* PROGRAMMER: CHERI PARMLEY                                   *   00210002
005640* DESCRIPTION: SERVICE DELIVERY CHANGE RECOMMENDATIONS        *   00220002
005650*                                                             *   00230000
005700*-------------------------------------------------------------*   00240000
005800 ENVIRONMENT DIVISION.                                            00250000
005900*-------------------------------------------------------------*   00260000
006000 CONFIGURATION SECTION.                                           00270000
006100 SOURCE-COMPUTER. IBM-3090.                                       00280000
006200 OBJECT-COMPUTER. IBM-3090.                                       00290000
006300                                                                  00300000
006400 INPUT-OUTPUT SECTION.                                            00310000
006500                                                                  00320000
006600 FILE-CONTROL.                                                    00330000
006700                                                                  00340000
006800*  INPUT:                                                     *   00350000
006900           SELECT REBATE-FORM-FILE                                00360000
007000             ASSIGN TO INP01.                                     00370000
008300                                                                  00380000
008400*  OUTPUT:                                                    *   00390000
008500           SELECT MERGED-FORM-FILE                                00400000
008600             ASSIGN TO OUT01.                                     00410000
008700                                                                  00420000
008800*-------------------------------------------------------------*   00430000
008900 DATA DIVISION.                                                   00440000
009000*----------------------------------------------------------       00450000
009100 FILE SECTION.                                                    00460000
009200                                                                  00470000
009300 FD  REBATE-FORM-FILE                                             00480000
009400     RECORDING MODE IS F                                          00490000
009500     LABEL RECORDS ARE STANDARD                                   00500000
009600     RECORD CONTAINS 300 CHARACTERS                               00510000
009700     BLOCK CONTAINS 0 RECORDS                                     00520000
009800     DATA RECORD IS REBATE-FORM-RECORD.                           00530000
009900                                                                  00540000
010000 01  REBATE-FORM-RECORD           PIC X(300).                     00550000
010100                                                                  00560000
013800 FD  MERGED-FORM-FILE                                             00570000
009400     RECORDING MODE IS F                                          00580000
009500     LABEL RECORDS ARE STANDARD                                   00590000
009600     RECORD CONTAINS 300 CHARACTERS                               00600000
009700     BLOCK CONTAINS 0 RECORDS                                     00610000
009800     DATA RECORD IS MERGED-FORM-RECORD.                           00620000
009900                                                                  00630000
010000 01  MERGED-FORM-RECORD           PIC X(300).                     00640000
015100                                                                  00650000
015200*----------------------------------------------------------       00660000
015300 WORKING-STORAGE SECTION.                                         00670000
015400                                                                  00680000
015500 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00690000
015600                                                  COMP SYNC.      00700000
015700     88  AC-INPUT-CONTROL-CARD-ERROR              VALUE +4003.    00710000
016100                                                                  00720000
016200*----------------------------------------------------------       00730000
016300* PC- PROGRAM CONSTANTS                                           00740000
016400*----------------------------------------------------------       00750000
016500 01  PC-PROGRAM-CONSTANTS.                                        00760000
016600     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'EPKUT195'. 00770000
018100                                                                  00780000
018110*----------------------------------------------------------       00790000
018120* TIME                                                            00800000
018130*----------------------------------------------------------       00810000
018140 01  PC-TIME.                                                     00820000
018150     05  PC-TIME-HHMM                 PIC X(04).                  00830000
018160     05  PC-TIME-SS                   PIC X(02).                  00840000
018200*----------------------------------------------------------       00850000
018300* PV- PROGRAM VARIABLES                                           00860000
018400*----------------------------------------------------------       00870000
018500 01  PV-PROGRAM-STATUS.                                           00880000
018600     05  PV-PARAGRAPH-NAME            PIC X(30) VALUE SPACES.     00890000
018700     05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACES.     00900000
018800     05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACES.     00910000
019100*                                                                 00920000
019200 01  PV-PROGRAM-VARIABLES.                                        00930000
           05  PV-SOR-LAST-UPD-TMST         PIC X(26) VALUE SPACE.      00940000
           05  PV-PROMO-INTFC-ID            PIC 9(10) VALUE 0.          00950000
           05  PV-MERCH-LNE-ID              PIC 9(10) VALUE 0.          00960000
           05  PV-REBT-FM-ID                PIC 9(10) VALUE 0.          00970000
019900                                                                  00980000
028000*----------------------------------------------------------       00990000
028100* PV- PROGRAM COUNT VARIABLES                                     01000000
028200*----------------------------------------------------------       01010000
028300 01  PV-PROGRAM-COUNTERS.                                         01020000
028400     05  PV-DATA-REC-BYPASS           PIC 9(09) VALUE 0.          01030000
028410     05  PV-REC-WRITTEN               PIC 9(09) VALUE 0.          01040000
028500     05  PV-RECORDS-READ              PIC 9(09) VALUE 0.          01050000
029100                                                                  01060000
031300*----------------------------------------------------------------*01070000
031400* PS- PROGRAM SWITCHES                                           *01080000
031500*----------------------------------------------------------------*01090000
031600 01  PS-PROGRAM-SWITCHES.                                         01100000
031700     05  PS-END-OF-RBT-SW             PIC  X(01) VALUE 'N'.       01110000
031800         88  PS-END-OF-RBT-FILE                  VALUE 'Y'.       01120000
031900         88  PS-NOT-END-RBT-FILE                 VALUE 'N'.       01130000
033200     05  PS-END-OF-PROCES-SW          PIC  X(01) VALUE 'N'.       01140000
033300         88  PS-END-OF-PROCESSING                VALUE 'Y'.       01150000
033400         88  PS-NOT-END-OF-PROCESSING            VALUE 'N'.       01160000
033200     05  PS-IS-FIRST-REC-READ         PIC  X(01) VALUE 'N'.       01170000
033300         88  PS-FIRST-REC-READ                   VALUE 'Y'.       01180000
033400         88  PS-NOT-FIRST-REC-READ               VALUE 'N'.       01190000
033800                                                                  01200000
037900*----------------------------------------------------------       01210000
038000* COPYBOOK  EPRD231 LAYOUT (USED TO READ THE INPUT FILE)          01220000
038000*                           AND WRITE OUT THE NEW FILE )          01230000
038100*----------------------------------------------------------       01240000
038200     COPY EPRD231.                                                01250000
038300                                                                  01260000
042200*----------------------------------------------------------       01270000
042300 PROCEDURE DIVISION.                                              01280000
042400*----------------------------------------------------------       01290000
042500 0000-MAINLINE.                                                   01300000
042600                                                                  01310000
042700     PERFORM 1000-INITIALIZATION.                                 01320000
042800                                                                  01330000
042900     PERFORM 2000-PROCESS-REBATE                                  01340000
043000             UNTIL PS-END-OF-PROCESSING.                          01350000
043100                                                                  01360000
043200     PERFORM 9200-WRAPUP.                                         01370000
043300                                                                  01380000
043400     GOBACK.                                                      01390000
043500                                                                  01400000
043600*0000-EXIT.                                                       01410000
043800                                                                  01420000
043900*----------------------------------------------------------       01430000
044000* 1000-INITIALIZATION.                                            01440000
044100*     INITIALIZES VARIABLES, OPENS ANY FILES, AND READS           01450000
044200*     THE INPUT FILES.                                            01460000
044400*----------------------------------------------------------       01470000
044500 1000-INITIALIZATION.                                             01480000
044600                                                                  01490000
044700     DISPLAY '****************************************'.          01500000
044800     DISPLAY '**          EPKUT195 STARTED          **'.          01510000
044900     DISPLAY '****************************************'.          01520000
045000                                                                  01530000
045100     INITIALIZE PV-PROGRAM-VARIABLES.                             01540000
045200                                                                  01550000
045700     SET PS-NOT-END-RBT-FILE      TO TRUE.                        01560000
033300     SET PS-FIRST-REC-READ        TO TRUE.                        01570000
046200                                                                  01580000
046300     PERFORM 1100-OPEN-FILES.                                     01590000
046400                                                                  01600000
046700     PERFORM 6000-READ-REBATE-FILE.                               01610000
046800                                                                  01620000
047800     IF PS-END-OF-RBT-FILE                                        01630000
047900        DISPLAY '***  REBATE EXTRACT FILE IS EMPTY    ****'       01640000
047910        SET PS-END-OF-PROCESSING TO TRUE                          01650000
048200     END-IF.                                                      01660000
050900                                                                  01670000
051000*1000-EXIT.                                                       01680000
051200                                                                  01690000
051300*----------------------------------------------------------       01700000
051400* 1100-OPEN-FILES.                                                01710000
051500*     THIS PARAGRAPH OPENS ALL THE FILES IN MODE REQUIRED         01720000
051600*----------------------------------------------------------       01730000
051700 1100-OPEN-FILES.                                                 01740000
051800                                                                  01750000
051900     OPEN INPUT REBATE-FORM-FILE.                                 01760000
052500                                                                  01770000
052600     OPEN OUTPUT MERGED-FORM-FILE.                                01780000
052700                                                                  01790000
052800*1100-EXIT.                                                       01800000
063100                                                                  01810000
063200*----------------------------------------------------------       01820000
063300* 2000-PROCESS-REBATE.                                            01830000
063400* ----------------------------                                    01840000
063500* THE PARAGRAPH WILL PERFORM THE FOLLOWING                        01850000
063800*                                                                 01860000
063900* (1) WRITE OUT MOST CURRENT REBATE FORM                          01870000
064000*     BYPASSING ANY OLDER DUPLICATES                              01880000
064200*                                                                 01890000
065900*----------------------------------------------------------       01900000
066000 2000-PROCESS-REBATE.                                             01910000
066110**--                                                              01920000
066120     IF PS-FIRST-REC-READ                                         01930000
033300         SET PS-NOT-FIRST-REC-READ TO TRUE                        01940000
               PERFORM 2200-HOLD-VARIABLES                              01950000
070218         PERFORM 2100-WRITE-DATA-RECORD                           01960000
TEST       ELSE                                                         01970000
               IF EP231-SOR-LAST-UPD-TMST = PV-SOR-LAST-UPD-TMST        01980000
                  IF EP231-PROMO-INTFC-ID = PV-PROMO-INTFC-ID           01990000
                     IF EP231-MERCH-LNE-ID = PV-MERCH-LNE-ID            02000000
                        IF EP231-REBT-FM-ID = PV-REBT-FM-ID             02010000
070218                      PERFORM 2100-WRITE-DATA-RECORD              02020000
                        ELSE                                            02030000
070218                      PERFORM 2100-WRITE-DATA-RECORD              02040000
                        END-IF                                          02050000
                     ELSE                                               02060000
070218                  PERFORM 2100-WRITE-DATA-RECORD                  02070000
                     END-IF                                             02080000
                  ELSE                                                  02090000
070218               PERFORM 2100-WRITE-DATA-RECORD                     02100000
                  END-IF                                                02110000
               ELSE                                                     02120000
                  IF EP231-PROMO-INTFC-ID = PV-PROMO-INTFC-ID           02130000
                     IF EP231-MERCH-LNE-ID = PV-MERCH-LNE-ID            02140000
                        IF EP231-REBT-FM-ID = PV-REBT-FM-ID             02150000
      ***                  BYPASS RECORD - SAME FORM LESS DAY-TIME      02160000
028400                     CONTINUE                                     02170000
                        ELSE                                            02180000
070218                     PERFORM 2100-WRITE-DATA-RECORD               02190000
                        END-IF                                          02200000
                     ELSE                                               02210000
070218                  PERFORM 2100-WRITE-DATA-RECORD                  02220000
                     END-IF                                             02230000
                  ELSE                                                  02240000
070218               PERFORM 2100-WRITE-DATA-RECORD                     02250000
                  END-IF                                                02260000
               END-IF                                                   02270000
070219     END-IF.                                                      02280000
                                                                        02290000
070220     PERFORM 6000-READ-REBATE-FILE.                               02300000
070221                                                                  02310000
070222     IF PS-END-OF-RBT-FILE                                        02320000
070223        SET PS-END-OF-PROCESSING TO TRUE                          02330000
070224     END-IF.                                                      02340000
                                                                        02350000
070230*2000-EXIT.                                                       02360000
094500                                                                  02370000
094600*-----------------------------------------------------------------02380000
094700* 2100-WRITE-DATA-RECORD                                          02390000
094800*  THIS PARAGRAPH MOVES INPUT TO OUTPUT EPRD231 COPYBOOK          02400000
095000*----------------------------------------------------------------*02410000
095100 2100-WRITE-DATA-RECORD.                                          02420000
097100                                                                  02430000
098500     WRITE MERGED-FORM-RECORD                                     02440000
098600       FROM EP231-REBATE-INTFC-RECORD.                            02450000
           PERFORM 2200-HOLD-VARIABLES.                                 02460000
098700                                                                  02470000
098710     ADD 1 TO PV-REC-WRITTEN.                                     02480000
098720                                                                  02490000
098800*2100-EXIT.                                                       02500000
099000                                                                  02510000
094600*-----------------------------------------------------------------02520000
094700* 2200-HOLD-VARIABLES                                             02530000
094800*  THIS PARAGRAPH WILL RESET THE HELD VARIABLES                   02540000
095000*----------------------------------------------------------------*02550000
       2200-HOLD-VARIABLES.                                             02560000
066130     MOVE EP231-SOR-LAST-UPD-TMST TO PV-SOR-LAST-UPD-TMST.        02570000
           MOVE EP231-PROMO-INTFC-ID    TO PV-PROMO-INTFC-ID.           02580000
           MOVE EP231-MERCH-LNE-ID      TO PV-MERCH-LNE-ID.             02590000
           MOVE EP231-REBT-FM-ID        TO PV-REBT-FM-ID.               02600000
098800*2200-EXIT.                                                       02610000
                                                                        02620000
212720*----------------------------------------------------------       02630000
212800* 6000-READ-REBATE-FILE                                           02640000
212900*     THIS PARAGRAPH READS DATA FROM REBATE-FORM-FILE INTO        02650000
213000*     COPYBOOK EPRD231                                            02660000
213100*----------------------------------------------------------       02670000
213200 6000-READ-REBATE-FILE.                                           02680000
213300                                                                  02690000
213400     READ REBATE-FORM-FILE                                        02700000
213500         INTO EP231-REBATE-INTFC-RECORD                           02710000
213600     AT END                                                       02720000
               DISPLAY 'REBATE-FORM-FILE AT END'                        02730000
213700         SET PS-END-OF-RBT-FILE TO TRUE                           02740000
213800     END-READ.                                                    02750000
213810                                                                  02990000
213820     IF PS-NOT-END-RBT-FILE                                       03000000
213900        ADD +1 TO PV-RECORDS-READ                                 03010000
213901     END-IF.                                                      03020000
213910                                                                  03030000
214000*6000-EXIT.                                                       03040000
214200                                                                  03050000
253400******************************************************************03060000
253500*     CLOSES ALL FILES AND DISPLAYS ANY NEEDED INFORMATION.      *03070000
253600******************************************************************03080000
253700 9200-WRAPUP.                                                     03090000
253800     MOVE '9200-WRAPUP                     ' TO PV-PARAGRAPH-NAME.03100000
253900                                                                  03110000
254000     PERFORM 9920-DISPLAY-TOTALS.                                 03120000
254100                                                                  03130000
254200     DISPLAY '****************************************'.          03140000
254300     DISPLAY '**          EPKUT195 END              **'.          03150000
254400     DISPLAY '****************************************'.          03160000
254500                                                                  03170000
254600     CLOSE REBATE-FORM-FILE.                                      03180000
255100                                                                  03190000
255200     CLOSE MERGED-FORM-FILE.                                      03200000
255300                                                                  03210000
255400*9200-EXIT.  EXIT.                                                03220000
257400******************************************************************03230000
257500*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.              *   03240000
257600******************************************************************03250000
257700 9910-ABEND.                                                      03260000
257800                                                                  03270000
258100     DISPLAY '** ABEND           **'.                             03280000
258200     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          03290000
258300     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        03300000
258400     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       03310000
258500     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       03320000
258600                                                                  03330000
258610     PERFORM 9920-DISPLAY-TOTALS.                                 03340000
258620                                                                  03350000
258700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         03360000
258800                                                                  03370000
258900*9910-EXIT.  EXIT.                                                03380000
259000******************************************************************03390000
259100*     DISPLAY END OF JOB TOTALS                                  *03400000
259200******************************************************************03410000
259300 9920-DISPLAY-TOTALS.                                             03420000
259400                                                                  03430000
259500     DISPLAY '****************************************'.          03440000
259600     DISPLAY '**     STATISTICS FOR REBATE FILE     **'.          03450000
259800     DISPLAY '****************************************'.          03460000
259900     COMPUTE PV-DATA-REC-BYPASS = PV-RECORDS-READ -               03470000
259900        PV-REC-WRITTEN.                                           03480000
260000     DISPLAY '** REBATE EXTRACT RECORDS READ  ====> '             03490000
260100             PV-RECORDS-READ                                      03500000
260200             ' **'.                                               03510000
260210     DISPLAY '**       REBATE RECORDS WRITTEN ====> '             03520000
260220             PV-REC-WRITTEN                                       03530000
260230             ' **'.                                               03540000
260300     DISPLAY '**      REBATE RECORDS BYPASSED ====> '             03550000
260400             PV-DATA-REC-BYPASS                                   03560000
260500             ' **'.                                               03570000
261200     DISPLAY '****************************************'.          03580000
261300                                                                  03590000
261400*9920-EXIT.  EXIT.                                                03600000
261500                                                                  03610000
