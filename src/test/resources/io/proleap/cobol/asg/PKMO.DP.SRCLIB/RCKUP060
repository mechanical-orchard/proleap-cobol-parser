000100 IDENTIFICATION DIVISION.                                         00010099
000200 TITLE 'UPDATE VERIFIED RETAIL INTO RCT_PRC_RCPT'                 00020099
000300                                                                  00030099
000400 PROGRAM-ID.             RCKUP060.                                00040099
000500 AUTHOR.                 VISWA KARUTURI.                          00050099
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060099
000700 DATE-WRITTEN            JULY 2004.                               00070099
000800 DATE-COMPILED.                                                   00080099
000900******************************************************************00090099
001000**VERIFIED RETAIL UPDATE FOR RCT_PRC_RCPT                         00100099
001100******************************************************************00110099
001200*                                                                 00120099
001300******************************************************************00130099
001400 ENVIRONMENT DIVISION.                                            00140099
001500 CONFIGURATION SECTION.                                           00150099
001600 SOURCE-COMPUTER.        IBM-3090.                                00160099
001700 OBJECT-COMPUTER.        IBM-3090.                                00170099
001800 INPUT-OUTPUT SECTION.                                            00180099
001900                                                                  00190099
002000 FILE-CONTROL.                                                    00200099
002100                                                                  00210099
002200     SELECT VRFD-RETAIL-FILE                                      00220099
002300         ASSIGN TO INP01.                                         00230099
002400                                                                  00240099
002500 DATA DIVISION.                                                   00250099
002600 FILE SECTION.                                                    00260099
002700                                                                  00270099
002800                                                                  00280099
002900 FD  VRFD-RETAIL-FILE                                             00290099
003000     RECORDING MODE IS F                                          00300099
003100     LABEL RECORDS ARE STANDARD                                   00310099
003200     RECORD CONTAINS 100 CHARACTERS                               00320099
003300     BLOCK CONTAINS 0  RECORDS.                                   00330099
003400 01  VRFD-RETAIL-REC                  PIC X(100).                 00340099
003500                                                                  00350099
003600 WORKING-STORAGE SECTION.                                         00360099
003700 01  PS-SWITCHES.                                                 00370099
003800     05  PS-EOF-TRANS-SW              PIC X(01) VALUE 'N'.        00380099
003900         88  PS-EOF-TRANS                       VALUE 'Y'.        00390099
004000                                                                  00400099
004100 01  DN-NULL-INDICATORS.                                          00410099
004200     05  DN-VRFD-ID                   PIC S9(04) COMP VALUE +0.   00420099
004300                                                                  00430099
004400 01  PV-COUNTERS COMP-3.                                          00440099
004500     05  PV-RETRY-COUNTER             PIC S9(03) VALUE ZERO.      00450099
004600     05  PV-COMMIT-COUNT              PIC S9(07) VALUE ZERO.      00460099
004700     05  PV-TRANS-COUNT               PIC S9(07) VALUE ZERO.      00470099
004800     05  PV-INSERT-COUNT              PIC S9(07) VALUE ZERO.      00480099
004900     05  PV-DUP-COUNT                 PIC S9(07) VALUE ZERO.      00490099
005000     05  PV-UPD-COUNT                 PIC S9(07) VALUE ZERO.      00500099
005100     05  PV-PROCESS-COUNT             PIC S9(07) VALUE ZERO.      00510099
005200                                                                  00520099
005300 01  PV-OTHER-STUFF.                                              00530099
005400     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'RCKUP060'.00540099
005500     05  PV-TMST                      PIC X(26)  VALUE SPACES.    00550099
005600     05  PV-HOLD-TMST                 PIC X(26)  VALUE SPACES.    00560099
005700     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +3        00570099
005800                                                 COMP.            00580099
005900     05  PV-ABEND-CODE                PIC S9(04) COMP SYNC        00590099
006000                                                 VALUE ZERO.      00600099
006100     05  PV-CURRENT-TMST              PIC X(26)  VALUE SPACES.    00610099
006200     05  PV-DISP-NBR                  PIC Z,ZZZ,ZZ9.              00620099
006300                                                                  00630099
006400 01  PV-ABEND-FIELDS.                                             00640099
006500     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'RCKUP060'.00650099
006600     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00660099
006700     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00670099
006800     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    00680099
006900     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    00690099
007000     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    00700099
007100     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00710099
007200     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00720099
007300     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00730099
007400     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00740099
007500     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00750099
007600     05  PV-SQLCODE                   PIC 9(9)   VALUE ZERO.      00760099
007700/                                                                 00770099
007800*    TRANSACTION RECORD                                           00780099
007900     COPY RCRD073.                                                00790099
008000/                                                                 00800099
008100*  USED FOR DB2 ERROR MESSAGE BUILDING                            00810099
008200     COPY DPWS004.                                                00820099
008300                                                                  00830099
008400*   DB2 SQL COMMUNICATION AREA                                    00840099
008500     EXEC SQL                                                     00850099
008600          INCLUDE SQLCA                                           00860099
008700     END-EXEC.                                                    00870099
008800     COPY SQLCA2.                                                 00880099
008900/                                                                 00890099
009000*    SEASET                                                       00900099
009100     EXEC SQL                                                     00910099
009200          INCLUDE RCT00019                                        00920099
009300     END-EXEC.                                                    00930099
009400/                                                                 00940099
009500 PROCEDURE DIVISION.                                              00950099
009600                                                                  00960099
009700     PERFORM 1000-INITIALIZE.                                     00970099
009800     PERFORM 2000-PROCESS UNTIL PS-EOF-TRANS.                     00980099
009900     PERFORM 9000-EOJ.                                            00990099
010000     GOBACK.                                                      01000099
010100                                                                  01010099
010200 1000-INITIALIZE.                                                 01020099
010300                                                                  01030099
010400     OPEN INPUT VRFD-RETAIL-FILE                                  01040099
010500     PERFORM 8000-READ-TRANS-FILE.                                01050099
010600     IF PS-EOF-TRANS                                              01060099
010700         DISPLAY ALL '*'                                          01070099
010800         DISPLAY '**  INP01 TRANS FILE IS EMPTY **'               01080099
010900         DISPLAY ALL '*'                                          01090099
011000     END-IF.                                                      01100099
011100                                                                  01110099
011200 2000-PROCESS.                                                    01120099
011300                                                                  01130099
011400      MOVE RC073-ORD-NBR          TO RCT00019-ORD-NBR.            01140099
011500      MOVE RC073-ORD-LNE-NBR      TO RCT00019-ORD-LNE-NBR.        01150099
011600      MOVE RC073-REC-SEQ-NBR      TO RCT00019-REC-SEQ-NBR.        01160099
011700      MOVE RC073-OPER-UNT-ID      TO RCT00019-OPER-UNT-ID.        01170099
011800      MOVE RC073-FCLTY-ID         TO RCT00019-FCLTY-ID.           01180099
011900      MOVE 'VE'                   TO RCT00019-PRC-RCPT-TYP-CDE.   01190099
012000      MOVE 'R'                    TO RCT00019-AMT-TYP-CDE.        01200099
012100      MOVE RC073-VRFD-UNT-RTL-AMT TO RCT00019-UNT-AMT.            01210099
012200      MOVE RC073-VRFD-GP-QTY      TO RCT00019-GP-QTY.             01220099
012300      MOVE RC073-VRFD-GP-AMT      TO RCT00019-GP-AMT.             01230099
012400                                                                  01240099
012500      PERFORM 7000-INSERT-PRC-RCPT                                01250099
012600                                                                  01260099
012700*COMMIT DB2 DATA TO TABLES.                                       01270099
012800      IF PV-PROCESS-COUNT > 10                                    01280099
012900          PERFORM 6000-DB2-COMMIT                                 01290099
013000          INITIALIZE PV-PROCESS-COUNT                             01300099
013100      END-IF.                                                     01310099
013200                                                                  01320099
013300      PERFORM 8000-READ-TRANS-FILE.                               01330099
013400                                                                  01340099
013500******************************************************************01350000
013600* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     01360000
013700******************************************************************01370000
013800 6000-DB2-COMMIT.                                                 01380000
013900                                                                  01390000
014000     EXEC SQL                                                     01400000
014100         COMMIT                                                   01410000
014200     END-EXEC.                                                    01420000
014300                                                                  01430000
014400     EVALUATE TRUE                                                01440000
014500         WHEN SQLCODE = +0                                        01450000
014600              ADD +1  TO PV-COMMIT-COUNT                          01460000
014700         WHEN SQLWARN0 NOT = SPACES                               01470011
014800         WHEN SQLCODE  NOT = ZERO                                 01480011
014900         DISPLAY '****************************'                   01490000
015000         DISPLAY '** ABEND                  **'                   01500000
015100         DISPLAY '** PROGRAM = RCKUP060     **'                   01510099
015200         DISPLAY '** PARAGRAPH = 6000-COMMIT**'                   01520000
015300         DISPLAY '** UNSUCCESSFUL COMMIT    **'                   01530000
015400         DISPLAY '****************************'                   01540000
015500         PERFORM 9900-SQL-ERROR                                   01550000
015600     END-EVALUATE.                                                01560000
015700                                                                  01570000
015800****************************************************************  01580099
015900****** INSERT RCT_PRC_RCPT   *******                              01590099
016000****************************************************************  01600099
016100                                                                  01610099
016200 7000-INSERT-PRC-RCPT.                                            01620099
016300     MOVE '7000-INSERT-PRC-RCPT'      TO PV-ABEND-PARAGRAPH.      01630099
016400                                                                  01640099
016500     PERFORM                                                      01650099
016600         WITH TEST AFTER                                          01660099
016700         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     01670099
016800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES) OR            01680099
016900                (SQLCODE = ZERO) OR (SQLCODE = -803))             01690099
017000                                                                  01700099
017100     EXEC SQL                                                     01710099
017200         INSERT INTO RCT_PRC_RCPT                                 01720099
017300             (UNT_AMT                                             01730099
017400             ,GP_AMT                                              01740099
017500             ,GP_QTY                                              01750099
017600             ,ORD_NBR                                             01760099
017700             ,ORD_LNE_NBR                                         01770099
017800             ,REC_SEQ_NBR                                         01780099
017900             ,OPER_UNT_ID                                         01790099
018000             ,FCLTY_ID                                            01800099
018100             ,PRC_RCPT_TYP_CDE                                    01810099
018200             ,AMT_TYP_CDE                                         01820099
018300             )                                                    01830099
018400             VALUES                                               01840099
018500             (:RCT00019-UNT-AMT                                   01850099
018600             ,:RCT00019-GP-AMT                                    01860099
018700             ,:RCT00019-GP-QTY                                    01870099
018800             ,:RCT00019-ORD-NBR                                   01880099
018900             ,:RCT00019-ORD-LNE-NBR                               01890099
019000             ,:RCT00019-REC-SEQ-NBR                               01900099
019100             ,:RCT00019-OPER-UNT-ID                               01910099
019200             ,:RCT00019-FCLTY-ID                                  01920099
019300             ,:RCT00019-PRC-RCPT-TYP-CDE                          01930099
019400             ,:RCT00019-AMT-TYP-CDE                               01940099
019500             )                                                    01950099
019600         END-EXEC                                                 01960099
019700                                                                  01970099
019800         EVALUATE TRUE                                            01980099
019900             WHEN SQLCODE = ZERO                                  01990099
020000                 ADD 1                TO PV-INSERT-COUNT          02000099
020100                 ADD 1                TO PV-PROCESS-COUNT         02010099
020200             WHEN SQLCODE = -803                                  02020099
020300                 PERFORM 7100-UPDATE-PRC-RCPT                     02030099
020400             WHEN SQLCODE = -904                                  02040099
020500             WHEN SQLCODE = -911                                  02050099
020600             WHEN SQLCODE = -913                                  02060099
020700                 CONTINUE                                         02070099
020800                                                                  02080099
020900             WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')              02090099
021000                 DISPLAY '**************************************' 02100099
021100                 DISPLAY 'WARNING ISSUED ON INSERT OF           ' 02110099
021200                 DISPLAY 'RCT_PRC_RCPT                          ' 02120099
021300                 DISPLAY '**************************************' 02130099
021400                 PERFORM 9800-SQL-WARNING                         02140099
021500                                                                  02150099
021600             WHEN SQLCODE < ZERO                                  02160099
021700                 DISPLAY '**************************************' 02170099
021800                 DISPLAY 'ERROR ISSUED ON INSERT OF             ' 02180099
021900                 DISPLAY 'RCT_PRC_RCPT                          ' 02190099
022000                 DISPLAY 'SQLCODE =' SQLCODE                      02200099
022100                 PERFORM 9900-SQL-ERROR                           02210099
022200                                                                  02220099
022300         END-EVALUATE                                             02230099
022400     END-PERFORM                                                  02240099
022500                                                                  02250099
022600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    02260099
022700         SQLCODE NOT = ZERO AND                                   02270099
022800         SQLCODE NOT = -803                                       02280099
022900         DISPLAY '**************************************'         02290099
023000         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         02300099
023100         DISPLAY 'INSERT TO RCT_PRC_RCPT                '         02310099
023200         DISPLAY '**************************************'         02320099
023300         PERFORM 9900-SQL-ERROR                                   02330099
023400     END-IF.                                                      02340099
023500                                                                  02350099
023600****************************************************************  02360099
023700****** UPDATE RCT_PRC_RCPT ******                                 02370099
023800****************************************************************  02380099
023900                                                                  02390099
024000 7100-UPDATE-PRC-RCPT.                                            02400099
024100     MOVE '7100-UPDATE-PRC-RCPT'      TO PV-ABEND-PARAGRAPH.      02410099
024200     PERFORM                                                      02420099
024300         WITH TEST AFTER                                          02430099
024400         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     02440099
024500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES) OR            02450099
024600                (SQLCODE = ZERO) OR (SQLCODE = +100))             02460099
024700                                                                  02470099
024800     EXEC SQL                                                     02480099
024900         UPDATE RCT_PRC_RCPT                                      02490099
025000         SET                                                      02500099
025100              UNT_AMT          = :RCT00019-UNT-AMT                02510099
025200             ,GP_AMT           = :RCT00019-GP-AMT                 02520099
025300             ,GP_QTY           = :RCT00019-GP-QTY                 02530099
025400         WHERE                                                    02540099
025500              ORD_NBR          = :RCT00019-ORD-NBR                02550099
025600         AND  ORD_LNE_NBR      = :RCT00019-ORD-LNE-NBR            02560099
025700         AND  REC_SEQ_NBR      = :RCT00019-REC-SEQ-NBR            02570099
025800         AND  OPER_UNT_ID      = :RCT00019-OPER-UNT-ID            02580099
025900         AND  FCLTY_ID         = :RCT00019-FCLTY-ID               02590099
026000         AND  PRC_RCPT_TYP_CDE = :RCT00019-PRC-RCPT-TYP-CDE       02600099
026100         AND  AMT_TYP_CDE      = :RCT00019-AMT-TYP-CDE            02610099
026200         END-EXEC                                                 02620099
026300                                                                  02630099
026400         EVALUATE TRUE                                            02640099
026500             WHEN SQLCODE = ZERO                                  02650099
026600                 ADD 1                TO PV-UPD-COUNT             02660099
026700                 ADD 1                TO PV-PROCESS-COUNT         02670099
026800             WHEN SQLCODE = -904                                  02680099
026900             WHEN SQLCODE = -911                                  02690099
027000             WHEN SQLCODE = -913                                  02700099
027100                 CONTINUE                                         02710099
027200                                                                  02720099
027300             WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')              02730099
027400                 DISPLAY '**************************************' 02740099
027500                 DISPLAY 'WARNING ISSUED ON UPDATE OF '           02750099
027600                 DISPLAY 'RCT_PRC_RCPT                          ' 02760099
027700                 DISPLAY '**********************************'     02770099
027800                 PERFORM 9800-SQL-WARNING                         02780099
027900                                                                  02790099
028000             WHEN SQLCODE < ZERO                                  02800099
028100                 DISPLAY '**************************************' 02810099
028200                 DISPLAY 'ERROR ISSUED ON UPDATE OF             ' 02820099
028300                 DISPLAY 'RCT_PRC_RCPT                          ' 02830099
028400                 DISPLAY '**************************************' 02840099
028500                 PERFORM 9900-SQL-ERROR                           02850099
028600                                                                  02860099
028700         END-EVALUATE                                             02870099
028800     END-PERFORM                                                  02880099
028900                                                                  02890099
029000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    02900099
029100         SQLCODE NOT = ZERO AND                                   02910099
029200         SQLCODE NOT = +100                                       02920099
029300         DISPLAY '**************************************'         02930099
029400         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         02940099
029500         DISPLAY 'UPDATE TO RCT_PRC_RCPT'                         02950099
029600         DISPLAY '**************************************'         02960099
029700         PERFORM 9900-SQL-ERROR                                   02970099
029800     END-IF.                                                      02980099
029900                                                                  02990099
030000 8000-READ-TRANS-FILE.                                            03000099
030100                                                                  03010099
030200     READ VRFD-RETAIL-FILE                                        03020099
030300         INTO RC073-VRFD-REC                                      03030099
030400     AT END                                                       03040099
030500         SET PS-EOF-TRANS             TO TRUE                     03050099
030600     NOT AT END                                                   03060099
030700         ADD 1                        TO PV-TRANS-COUNT           03070099
030800     END-READ.                                                    03080099
030900/                                                                 03090099
031000 9000-EOJ.                                                        03100099
031100                                                                  03110099
031200     PERFORM 6000-DB2-COMMIT.                                     03120099
031300     CLOSE VRFD-RETAIL-FILE.                                      03130099
031400                                                                  03140099
031500     DISPLAY '**************************'.                        03150099
031600     DISPLAY '** PROGRAM: ' PC-PROGRAM-NAME.                      03160099
031700     DISPLAY '**************************'.                        03170099
031800                                                                  03180099
031900     DISPLAY SPACES.                                              03190099
032000     MOVE PV-TRANS-COUNT              TO PV-DISP-NBR              03200099
032100     DISPLAY 'TRANSACTIONS READ                  = ' PV-DISP-NBR  03210099
032200                                                                  03220099
032300     DISPLAY SPACES.                                              03230099
032400*  INSERT COUNTERS                                                03240099
032500     MOVE PV-INSERT-COUNT             TO PV-DISP-NBR              03250099
032600     DISPLAY 'VRFD RETAIL ROWS INSERTED          = ' PV-DISP-NBR. 03260099
032700                                                                  03270099
032800     DISPLAY SPACES.                                              03280099
032900*  UPDATE COUNTERS                                                03290099
033000     MOVE PV-UPD-COUNT                TO PV-DISP-NBR              03300099
033100     DISPLAY 'VRFD RETAIL ROWS UPDATED           = ' PV-DISP-NBR. 03310099
033200                                                                  03320099
033300     DISPLAY SPACES                                               03330099
033400*  COMMIT COUNTER                                                 03340099
033500     MOVE PV-COMMIT-COUNT             TO PV-DISP-NBR              03350099
033600     DISPLAY 'COMMITS TAKEN                      = ' PV-DISP-NBR. 03360099
033700                                                                  03370099
033800 9800-SQL-WARNING.                                                03380099
033900                                                                  03390099
034000      MOVE PV-TRANS-COUNT        TO PV-DISP-NBR.                  03400099
034100      MOVE SQLCODE               TO SQLCODE2.                     03410099
034200      MOVE SQLERRD(3)            TO SQLERRD3.                     03420099
034300      DISPLAY '** ABEND **       ** = SQLWARNING'.                03430099
034400      DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.          03440099
034500      DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.       03450099
034600      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 03460099
034700      DISPLAY '** RECORDS READ   ** = ' PV-DISP-NBR.              03470099
034800      DISPLAY '** SQLWARN0       ** = ' SQLWARN0.                 03480099
034900      DISPLAY '** SQLWARN1       ** = ' SQLWARN1.                 03490099
035000      DISPLAY '** SQLWARN2       ** = ' SQLWARN2.                 03500099
035100      DISPLAY '** SQLWARN3       ** = ' SQLWARN3.                 03510099
035200      DISPLAY '** SQLWARN4       ** = ' SQLWARN4.                 03520099
035300      DISPLAY '** SQLWARN5       ** = ' SQLWARN5.                 03530099
035400      DISPLAY '** SQLWARN6       ** = ' SQLWARN6.                 03540099
035500      DISPLAY '** SQLWARN7       ** = ' SQLWARN7.                 03550099
035600                                                                  03560099
035700      MOVE 4013                  TO PV-ABEND-CODE                 03570099
035800      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        03580099
035900                                                                  03590099
036000 9900-SQL-ERROR.                                                  03600099
036100                                                                  03610099
036200      MOVE PV-TRANS-COUNT        TO PV-DISP-NBR.                  03620099
036300      MOVE SQLCODE               TO SQLCODE2.                     03630099
036400      MOVE SQLERRD(3)            TO SQLERRD3.                     03640099
036500      DISPLAY '** ABEND **       ** = SQLERROR'.                  03650099
036600      DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.          03660099
036700      DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.       03670099
036800      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 03680099
036900      DISPLAY '** RECORDS READ   ** = ' PV-DISP-NBR.              03690099
037000      DISPLAY '** SQLERRM        ** = ' SQLERRM.                  03700099
037100      DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                 03710099
037200                                                                  03720099
037300      MOVE 4013                  TO PV-ABEND-CODE                 03730099
037400      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        03740099
