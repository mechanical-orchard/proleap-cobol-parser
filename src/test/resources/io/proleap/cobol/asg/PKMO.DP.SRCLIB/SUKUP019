000200***************************************************************** 00020001
000300 IDENTIFICATION DIVISION.                                         00030001
000400***************************************************************** 00040001
000500*                                                                 00050001
000600 PROGRAM-ID.             SUKUP019.                                00060001
000700 AUTHOR.                 PATRICK BURKE.                           00070001
000800 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00080001
000900 DATE-WRITTEN.           JANUARY 2005.                            00090001
001000 DATE-COMPILED.                                                   00100001
001100*                                                                 00110001
001200***************************************************************** 00120001
001300* THIS PROGRAM WILL BE USED TO PURGE CARTON PROCESSED TABLE       00130001
001400*  (SUT_CART_PRCD_MSG) OF OLD DATA DETERMINED BY PARM VALUE.      00140001
001500***************************************************************** 00150001
001600 ENVIRONMENT DIVISION.                                            00160001
001700***************************************************************** 00170001
001800 CONFIGURATION SECTION.                                           00180001
001900 SOURCE-COMPUTER.                        IBM-3090.                00190001
002000 OBJECT-COMPUTER.                        IBM-3090.                00200001
002100 INPUT-OUTPUT SECTION.                                            00210001
002200 FILE-CONTROL.                                                    00220001
002300                                                                  00230001
002400     SELECT EXTRACT-FILE                                          00240001
002500         ASSIGN TO INP01.                                         00250001
002600/                                                                 00260001
002700***************************************************************** 00270001
002800 DATA DIVISION.                                                   00280001
002900***************************************************************** 00290001
003000 FILE SECTION.                                                    00300001
003100                                                                  00310001
003200 FD  EXTRACT-FILE                                                 00320001
003300     RECORDING MODE IS F                                          00330001
003400     LABEL RECORDS ARE STANDARD                                   00340001
003500     BLOCK CONTAINS 0 RECORDS.                                    00350001
003600 01  EXTRACT-RECORD                   PIC X(50).                  00360004
003700/                                                                 00370001
003800***************************************************************** 00380001
003900 WORKING-STORAGE SECTION.                                         00390001
004000***************************************************************** 00400001
004100                                                                  00410001
004200 01  PS-SWITCHES.                                                 00420001
004300     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00430001
004400         88  PS-END-OF-INPUT                    VALUE 'Y'.        00440001
004500         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00450001
004600                                                                  00460001
004700 01  PV-VARIABLES.                                                00470001
004800     05  PV-COUNT                     PIC  9(09) VALUE ZERO.      00480001
004900     05  PV-READ-COUNT                PIC  9(09) VALUE ZERO.      00490001
005000     05  PV-DELETE-COUNT              PIC  9(09) VALUE ZERO.      00500001
005100     05  PV-DUPLICATE-CNT             PIC  9(09) VALUE ZERO.      00510001
005200     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00520001
005300     05  PV-NOT-FOUND-COUNT           PIC  9(09) VALUE ZERO.      00530001
005400     05  PV-COMMIT-COUNT              PIC  9(09) VALUE ZERO.      00540001
005500     05  PV-SKIP-CNT                  PIC  9(09) VALUE ZERO.      00550001
005600     05  PV-PREVIOUS-SML              PIC  9(18) VALUE ZERO.      00560001
005700                                                                  00570001
005800******************************************************************00580001
005900 01  PV-ABEND-FIELDS.                                             00590001
006000     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00600001
006100                                                 COMP SYNC.       00610001
006200     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP019'.00620001
006300     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00630001
006400     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    00640001
006500     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    00650001
006600     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    00660001
006700     05  PV-ABEND-STRUCTURE-3         PIC  X(08) VALUE SPACES.    00670001
006800     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00680001
006900     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00690001
007000     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00700001
007100     05  PV-DB2-FUNCTION              PIC  X(50) VALUE SPACES.    00710001
007200/                                                                 00720001
007300 01  PC-CONSTANTS.                                                00730001
007400     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP019'. 00740001
007500     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    00750001
007600                                                   COMP SYNC.     00760001
007700     05  PC-COMMIT-HOLD               PIC 9(3)  VALUE 100.        00770001
007800     05  PC-COUNT-HOLD                PIC 9(9)  VALUE 100000.     00780001
007900/                                                                 00790001
008000******************************************************************00800001
008100*  EXTRACT LAYOUT FOR THE LABEL REQUEST PURGE.                    00810001
008200******************************************************************00820001
008300     COPY SURD053.                                                00830002
008400*                                                                 00840001
008500******************************************************************00850001
008600*   DB2 SQL COMMUNICATION AREA                                    00860001
008700******************************************************************00870001
008800     EXEC SQL                                                     00880001
008900         INCLUDE SQLCA                                            00890001
009000     END-EXEC.                                                    00900001
009100*                                                                 00910001
009200     COPY SQLCA2.                                                 00920001
009300*                                                                 00930001
009400******************************************************************00940001
009500*   LABEL REQUEST TABLE                                           00950001
009600******************************************************************00960001
009700     EXEC SQL                                                     00970001
009800          INCLUDE SUT00044                                        00980001
009900     END-EXEC.                                                    00990001
010000                                                                  01000001
010100******************************************************************01010001
010200*   UPLOAD ERROR TABLE                                            01020001
010300******************************************************************01030001
010400*                                                                 01040001
010500     EXEC SQL                                                     01050001
010600         INCLUDE TSUCRDV                                          01060001
010700     END-EXEC.                                                    01070001
010800*                                                                 01080001
010900******************************************************************01090001
011000 PROCEDURE DIVISION.                                              01100001
011100******************************************************************01110001
011200 0000-MAINLINE.                                                   01120001
011300                                                                  01130001
011400     PERFORM 1000-INITIALIZE.                                     01140001
011500                                                                  01150001
011600     PERFORM 2000-PROCESS-EXTRACT                                 01160001
011700         UNTIL PS-END-OF-INPUT.                                   01170001
011800                                                                  01180001
011900     PERFORM 9000-EOJ.                                            01190001
012000                                                                  01200001
012100      GOBACK.                                                     01210001
012200                                                                  01220001
012300******************************************************************01230001
012400*  INITIALIZATION TASKS.                                          01240001
012500*    -- OPEN INPUT FILE                                           01250001
012600*    -- READ FILE                                                 01260001
012700******************************************************************01270001
012800 1000-INITIALIZE.                                                 01280001
012900                                                                  01290001
013000     OPEN INPUT  EXTRACT-FILE.                                    01300001
013100                                                                  01310001
013200     PERFORM 2100-READ-EXTRACT.                                   01320001
013300/                                                                 01330001
013400******************************************************************01340001
013500 2000-PROCESS-EXTRACT.                                            01350001
013600******************************************************************01360001
013700*                                                                 01370001
013800     IF  PV-COUNT  <  PC-COUNT-HOLD                               01380001
013900         CONTINUE                                                 01390001
014000     ELSE                                                         01400001
014100         MOVE PV-READ-COUNT  TO  PV-DISPLAY-COUNT                 01410001
014200         DISPLAY 'READ:  '       PV-DISPLAY-COUNT                 01420001
014300         MOVE  ZEROES  TO        PV-COUNT                         01430001
014400     END-IF.                                                      01440001
014500                                                                  01450001
014600     PERFORM 8000-DELETE-CARTON-RECS.                             01460002
014700     ADD +1 TO PV-COMMIT-COUNT.                                   01470001
014800                                                                  01480001
014900     IF PV-COMMIT-COUNT > PC-COMMIT-HOLD                          01490001
015000         PERFORM 2200-COMMIT-DELETE                               01500001
015100     END-IF.                                                      01510001
015200                                                                  01520001
015300     PERFORM 2100-READ-EXTRACT.                                   01530001
015400*                                                                 01540001
015500******************************************************************01550001
015600*  READ NEXT INPUT FILE RECORD.                                   01560001
015700******************************************************************01570001
015800 2100-READ-EXTRACT.                                               01580001
015900                                                                  01590001
016000     READ EXTRACT-FILE INTO SU053-EXTRACT-RECORD                  01600001
016100        AT END                                                    01610001
016200           SET PS-END-OF-INPUT TO TRUE                            01620001
016300        NOT AT END                                                01630001
016400           ADD +1                   TO PV-READ-COUNT              01640001
016500                                       PV-COUNT                   01650001
016600     END-READ.                                                    01660001
016700*                                                                 01670001
016800******************************************************************01680001
016900* COMMIT THE DELETE FROM ERROR TABLE                              01690001
017000******************************************************************01700001
017100 2200-COMMIT-DELETE.                                              01710001
017200                                                                  01720001
017300      EXEC SQL                                                    01730001
017400          COMMIT                                                  01740001
017500      END-EXEC.                                                   01750001
017600                                                                  01760001
017700      MOVE +0 TO PV-COMMIT-COUNT.                                 01770001
017800                                                                  01780001
017900*                                                                 01790001
018000******************************************************************01800001
018100* DELETE THE ROW FROM THE CARTON PROCESSED TABLE (SUT00044).      01810002
018200******************************************************************01820001
018300 8000-DELETE-CARTON-RECS.                                         01830002
018400                                                                  01840001
018500     EXEC SQL                                                     01850001
018600          DELETE                                                  01860001
018700            FROM  SUT_CART_PRCD_MSG                               01870001
018800           WHERE  DC_NBR           = :SU053-DC-NBR                01880001
018900            AND   ACM_LBL_STA_NBR  = :SU053-ACM-LBL-STA-NBR       01890003
019000            AND   ACM_MSG_RCV_TMST = :SU053-ACM-MSG-RCV-TMST      01900003
019100     END-EXEC.                                                    01910001
019200                                                                  01920001
019300     EVALUATE TRUE                                                01930001
019400         WHEN SQLCODE = 0                                         01940001
019500             ADD +1           TO PV-DELETE-COUNT                  01950001
019600         WHEN SQLCODE = +100                                      01960001
019700             ADD +1           TO PV-NOT-FOUND-COUNT               01970001
019800         WHEN SQLCODE < 0                                         01980001
019900         WHEN SQLCODE > 0                                         01990001
020000         WHEN SQLWARN0 = 'W'                                      02000001
020100             MOVE '8000-DELETE-CARTON-RECS'                       02010002
020200                         TO PV-ABEND-PARAGRAPH                    02020001
020300             MOVE 'DELETE OF SUT_LBL_REQ_MSG'                     02030001
020400                         TO PV-DB2-FUNCTION                       02040001
020500             PERFORM 9200-SQL-ABEND                               02050001
020600     END-EVALUATE.                                                02060001
020700/                                                                 02070001
020800******************************************************************02080001
020900*CLOSE INPUT FILE.                                                02090001
021000******************************************************************02100001
021100 9000-EOJ.                                                        02110001
021200*                                                                 02120001
021300     CLOSE EXTRACT-FILE.                                          02130001
021400                                                                  02140001
021500     MOVE PV-READ-COUNT      TO PV-DISPLAY-COUNT.                 02150001
021600     DISPLAY 'READ:         '   PV-DISPLAY-COUNT.                 02160001
021700     MOVE PV-DELETE-COUNT    TO PV-DISPLAY-COUNT.                 02170001
021800     DISPLAY 'DELETE:       '   PV-DISPLAY-COUNT.                 02180001
021900     MOVE PV-NOT-FOUND-COUNT TO PV-DISPLAY-COUNT.                 02190001
022000     DISPLAY 'NOT FOUND     '   PV-DISPLAY-COUNT.                 02200001
022500                                                                  02250001
022600/                                                                 02260001
022700******************************************************************02270001
022800 9200-SQL-ABEND.                                                  02280001
022900******************************************************************02290001
023000                                                                  02300001
023100     MOVE SQLCODE                     TO SQLCODE2.                02310001
023200     MOVE SQLERRD(3)                  TO SQLERRD3.                02320001
023300                                                                  02330001
023400     DISPLAY '** ABEND **         ** = SQLERROR'.                 02340001
023500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02350001
023600     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02360001
023700     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02370001
023800     DISPLAY '*** MESSAGE     = ' PV-DB2-OPERATION-MESSAGE-1.     02380001
023900     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-2.     02390001
024000     DISPLAY '***             = ' PV-DB2-OPERATION-MESSAGE-3.     02400001
024100                                                                  02410001
024200     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02420001
024300     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02430001
024400     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02440001
024500     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02450001
024600                                                                  02460001
024700                                                                  02470001
024800     MOVE +4013                       TO PV-ABEND-CODE.           02480001
024900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02490001
025000                                                                  02500001
