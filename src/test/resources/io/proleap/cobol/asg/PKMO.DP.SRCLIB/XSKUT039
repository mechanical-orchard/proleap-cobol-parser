000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.      XSKUT039.                                       00020000
000300 AUTHOR.          BARB ERTL.                                      00030001
000400 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040000
000500 DATE-WRITTEN.    12/04/2002.                                     00050001
000600 DATE-COMPILED.                                                   00060000
000700******************************************************************00070000
000800**                XS DOMAIN ERROR QUEUE PROCESSOR                 00080000
000900**                     FOR THE LOCATION TABLES                    00090001
001000******************************************************************00100000
001100**THIS PROGRAM MOVES MESSAGES FROM THE ERROR QUEUE TO EITHER THE  00110000
001200**  XS DOMAIN LOCATION QUEUE FOR REPROCESSING OR TO A FLAT FILE   00120001
001300**     FOR MANUAL MANIPULATION.                                   00130000
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600 CONFIGURATION SECTION.                                           00160000
001700 SOURCE-COMPUTER.        IBM-3090.                                00170000
001800 OBJECT-COMPUTER.        IBM-3090.                                00180000
001900 INPUT-OUTPUT SECTION.                                            00190000
002000 FILE-CONTROL.                                                    00200000
002100                                                                  00210000
002200     SELECT CONTROL-CARD-1                                        00220000
002300            ASSIGN TO INP01.                                      00230000
002400     SELECT CONTROL-CARD-2                                        00240000
002500            ASSIGN TO INP02.                                      00250000
002600     SELECT CONTROL-CARD-3                                        00260000
002700            ASSIGN TO INP03.                                      00270000
002800     SELECT CONTROL-CARD-4                                        00280000
002900            ASSIGN TO INP04.                                      00290000
003000     SELECT MESSAGE-LOG                                           00300000
003100            ASSIGN TO OUT01.                                      00310000
003200                                                                  00320000
003300 DATA DIVISION.                                                   00330000
003400 FILE SECTION.                                                    00340000
003500                                                                  00350000
003600 FD  CONTROL-CARD-1                                               00360000
003700     RECORDING MODE F                                             00370000
003800     BLOCK CONTAINS 0 RECORDS                                     00380000
003900     LABEL RECORDS ARE OMITTED                                    00390000
004000     DATA RECORD IS CONTROL-CARD-1-RECORD.                        00400000
004100 01  CONTROL-CARD-1-RECORD           PIC X(080).                  00410000
004200                                                                  00420000
004300 FD  CONTROL-CARD-2                                               00430000
004400     RECORDING MODE F                                             00440000
004500     BLOCK CONTAINS 0 RECORDS                                     00450000
004600     LABEL RECORDS ARE OMITTED                                    00460000
004700     DATA RECORD IS CONTROL-CARD-2-RECORD.                        00470000
004800 01  CONTROL-CARD-2-RECORD           PIC X(080).                  00480000
004900                                                                  00490000
005000 FD  CONTROL-CARD-3                                               00500000
005100     RECORDING MODE F                                             00510000
005200     BLOCK CONTAINS 0 RECORDS                                     00520000
005300     LABEL RECORDS ARE OMITTED                                    00530000
005400     DATA RECORD IS CONTROL-CARD-3-RECORD.                        00540000
005500 01  CONTROL-CARD-3-RECORD           PIC X(080).                  00550000
005600                                                                  00560000
005700 FD  CONTROL-CARD-4                                               00570000
005800     RECORDING MODE F                                             00580000
005900     BLOCK CONTAINS 0 RECORDS                                     00590000
006000     LABEL RECORDS ARE OMITTED                                    00600000
006100     DATA RECORD IS CONTROL-CARD-4-RECORD.                        00610000
006200 01  CONTROL-CARD-4-RECORD           PIC X(080).                  00620000
006300                                                                  00630000
006400 FD  MESSAGE-LOG                                                  00640000
006500     RECORDING MODE F                                             00650000
006600     BLOCK CONTAINS 0 RECORDS                                     00660000
006700     LABEL RECORDS ARE OMITTED                                    00670000
006800     DATA RECORD IS MESSAGE-LOG-RECORD.                           00680000
006900 01  MESSAGE-LOG-RECORD              PIC X(500).                  00690003
007000                                                                  00700000
007100 WORKING-STORAGE SECTION.                                         00710000
007200******************************************************************00720000
007300**PROGRAM SWITCHES                                                00730000
007400******************************************************************00740000
007500 01  PS-PROGRAM-SWITCHES.                                         00750000
007600     05  PS-PROCESS-INDICATOR-SW   PIC X(01)   VALUE 'Y'.         00760000
007700         88  PS-PROCESS-COMPLETE               VALUE 'N'.         00770000
007800         88  PS-PROCESS-CONTINUE               VALUE 'Y'.         00780000
007900******************************************************************00790000
008000**CONTROL CARD 1 RECORD LAYOUT - QUEUE MANAGER NAME               00800000
008100******************************************************************00810000
008200 01  CC-CONTROL-CARD-1-LAYOUT.                                    00820000
008300     05  CC-QUEUE-MANAGER-NAME      PIC X(48)   VALUE SPACES.     00830000
008400     05  FILLER                     PIC X(32)   VALUE SPACES.     00840000
008500******************************************************************00850000
008600**CONTROL CARD 2 RECORD LAYOUT - QUEUE NAME                       00860000
008700******************************************************************00870000
008800 01  CC-CONTROL-CARD-2-LAYOUT.                                    00880000
008900     05  CC-LOCATION-QUEUE-NAME     PIC X(48)   VALUE SPACES.     00890001
009000     05  FILLER                     PIC X(32)   VALUE SPACES.     00900000
009100******************************************************************00910000
009200**CONTROL CARD 3 RECORD LAYOUT - ERROR QUEUE NAME                 00920000
009300******************************************************************00930000
009400 01  CC-CONTROL-CARD-3-LAYOUT.                                    00940000
009500     05  CC-LOCATION-ERROR-QUEUE-NAME PIC X(48) VALUE SPACES.     00950001
009600     05  FILLER                     PIC X(32)   VALUE SPACES.     00960000
009700******************************************************************00970000
009800**CONTROL CARD 4 RECORD LAYOUT - WRITE MESSAGES TO FILE OR ITEM Q 00980000
009900******************************************************************00990000
010000 01  CC-CONTROL-CARD-4-LAYOUT.                                    01000000
010100     05  CC-MESSAGE-PLACEMENT-IND   PIC X(10).                    01010000
010200         88  CC-WRITE-TO-LOCATION-QUEUE       VALUE 'LOCQUEUE  '. 01020001
010300         88  CC-WRITE-TO-FLAT-FILE            VALUE 'FLATFILE  '. 01030001
010400     05  FILLER                     PIC X(70)   VALUE SPACES.     01040000
010500******************************************************************01050000
010600**PROGRAM CONSTANTS                                               01060000
010700******************************************************************01070000
010800 01  PC-PROGRAM-CONSTANTS.                                        01080000
010900     05  PC-CURRENT-PROGRAM-NAME    PIC X(08)   VALUE 'XSKUT039'. 01090000
011000******************************************************************01100000
011100**MQ WORKING STORAGE                                              01110000
011200******************************************************************01120000
011300 01  MQV-WORKING-STORAGE.                                         01130000
011400     05  MQV-MQCONN                 PIC  X(08) VALUE 'CSQBCONN'.  01140000
011500     05  MQV-MQOPEN                 PIC  X(08) VALUE 'CSQBOPEN'.  01150000
011600     05  MQV-MQPUT                  PIC  X(08) VALUE 'CSQBPUT'.   01160000
011700     05  MQV-MQGET                  PIC  X(08) VALUE 'CSQBGET'.   01170000
011800     05  MQV-MQCMIT                 PIC  X(08) VALUE 'CSQBCOMM'.  01180000
011900     05  MQV-MQBACK                 PIC  X(08) VALUE 'CSQBBACK'.  01190000
012000     05  MQV-MQCLOSE                PIC  X(08) VALUE 'CSQBCLOS'.  01200000
012100     05  MQV-MQDISC                 PIC  X(08) VALUE 'CSQBDISC'.  01210000
012200     05  MQV-MQCHECK                PIC  X(08) VALUE 'MQR2C'.     01220000
012300     05  MQV-HCONN                  PIC S9(09) BINARY VALUE 0.    01230000
012400     05  MQV-COMPLETION-CODE        PIC S9(09) BINARY.            01240000
012500     05  MQV-REASON                 PIC S9(09) BINARY.            01250000
012600     05  MQV-OPEN-OPTIONS           PIC S9(09) BINARY.            01260000
012700     05  MQV-ITEM-HANDLE            PIC S9(09) BINARY VALUE 0.    01270000
012800     05  MQV-ERROR-HANDLE           PIC S9(09) BINARY VALUE 0.    01280000
012900     05  MQV-REASON-TEXT            PIC X(30)  VALUE SPACES.      01290000
013000     05  MQV-MSGBUFFER              PIC X(450) VALUE SPACES.      01300000
013100     05  MQV-MSG                    PIC X(450) VALUE SPACES.      01310000
013200     05  MQV-ERRMSGBUF              PIC X(500) VALUE SPACES.      01320000
013300     05  MQV-MSG-LENGTH             PIC S9(09) BINARY VALUE 500.  01330004
013400     05  MQV-DATA-LENGTH            PIC S9(09) BINARY.            01340000
013500******************************************************************01350000
013600**COPYBOOKS                                                       01360000
013700******************************************************************01370000
013800***INPUT FILE LAYOUT - RMS LOCATION MESSAGE COPYBOOK              01380001
013900     COPY HORD100.                                                01390001
014000***OBJECT-DESCRIPTOR.                                             01400000
014100 01  MQM-OBJECT-DESCRIPTOR.                                       01410000
014200     COPY CMQODV.                                                 01420000
014300***MESSAGE-DESCRIPTOR.                                            01430000
014400 01  MQM-MESSAGE-DESCRIPTOR.                                      01440000
014500     COPY CMQMDV.                                                 01450000
014600***GET-MESSAGE-OPTIONS.                                           01460000
014700 01  MQM-GET-MESSAGE-OPTIONS.                                     01470000
014800     COPY CMQGMOV.                                                01480000
014900***PUT-MESSAGE-OPTIONS.                                           01490000
015000 01  MQM-PUT-MESSAGE-OPTIONS.                                     01500000
015100     COPY CMQPMOV.                                                01510000
015200***CONSTANTS.                                                     01520000
015300 01  MQM-CONSTANTS.                                               01530000
015400     COPY CMQV.                                                   01540000
015500******************************************************************01550000
015600**PROGRAM COUNTERS                                                01560000
015700******************************************************************01570000
015800 01  PC-PROGRAM-COUNTERS.                                         01580000
015900     05  PC-MESSAGE-FROM-QUEUE        PIC 9(06) VALUE ZEROS.      01590000
016000     05  PC-MESSAGES-WRITTEN-TO-FILE  PIC 9(06) VALUE ZEROS.      01600000
016100     05  PC-MESSAGES-TO-QUEUE         PIC 9(06) VALUE ZEROS.      01610000
016200******************************************************************01620000
016300**ERROR HANDLING                                                  01630000
016400******************************************************************01640000
016500 01  PV-MISC-ABEND-FIELDS.                                        01650000
016600     05  PV-PARAGRAPH-NAME            PIC X(30) VALUE SPACE.      01660000
016700     05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACE.      01670000
016800     05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACE.      01680000
016900 01  ABEND-CODE                  PIC S9(4) VALUE ZEROS COMP SYNC. 01690000
017000     88  ABEND-4013-DB2-ERROR              VALUE +4013.           01700000
017100 PROCEDURE DIVISION.                                              01710000
017200***************************************************************** 01720000
017300                                                                  01730000
017400     PERFORM 1000-INITIALIZATION.                                 01740000
017500     PERFORM 2000-PROCESS-RECORDS                                 01750000
017600             UNTIL PS-PROCESS-COMPLETE.                           01760000
017700     PERFORM 9000-WRAPUP.                                         01770001
017800     GOBACK.                                                      01780000
017900                                                                  01790000
018000******************************************************************01800000
018100**INITIALIZATION AREA - SETUP QUEUES FOR PROCESSING               01810000
018200******************************************************************01820000
018300 1000-INITIALIZATION.                                             01830000
018400                                                                  01840000
018500     MOVE '1000-INITIALIZATION' TO PV-PARAGRAPH-NAME.             01850000
018600                                                                  01860000
018700     OPEN INPUT  CONTROL-CARD-1                                   01870000
018800                 CONTROL-CARD-2                                   01880000
018900                 CONTROL-CARD-3                                   01890000
019000                 CONTROL-CARD-4                                   01900000
019100          OUTPUT MESSAGE-LOG.                                     01910000
019200                                                                  01920000
019300     PERFORM 7000-READ-CONTROL-CARD-1.                            01930001
019400     PERFORM 7100-READ-CONTROL-CARD-2.                            01940001
019500     PERFORM 7200-READ-CONTROL-CARD-3.                            01950001
019600     PERFORM 7300-READ-CONTROL-CARD-4.                            01960001
019700                                                                  01970000
019800     IF  CC-QUEUE-MANAGER-NAME    =  SPACES                       01980000
019900      OR CC-LOCATION-QUEUE-NAME   =  SPACES                       01990001
020000      OR CC-LOCATION-ERROR-QUEUE-NAME = SPACES                    02000001
020100         DISPLAY 'EMPTY CONTROL CARD'                             02010000
020200         DISPLAY 'QUEUE MANAGER NAME    ' CC-QUEUE-MANAGER-NAME   02020000
020300         DISPLAY 'LOCATION QUEUE NAME   ' CC-LOCATION-QUEUE-NAME  02030002
020400         DISPLAY 'LOCATION ERROR QUEUE  '                         02040002
020500          CC-LOCATION-ERROR-QUEUE-NAME                            02050002
020600         PERFORM 9999-ABEND                                       02060001
020700     END-IF.                                                      02070000
020800                                                                  02080000
020900     PERFORM 1200-CONNECT-TO-QMGR.                                02090000
021000     PERFORM 1300-OPEN-LOCATION-QUEUE.                            02100001
021100     PERFORM 1400-OPEN-LOCATION-ERROR-QUEUE.                      02110001
021200                                                                  02120000
021300     PERFORM 7400-RETRIEVE-MESSAGE.                               02130003
021400                                                                  02140000
021500******************************************************************02150000
021600**CONNECT TO THE QUEUE MANAGER                                    02160000
021700******************************************************************02170000
021800 1200-CONNECT-TO-QMGR.                                            02180000
021900                                                                  02190000
022000     MOVE '1200-CONNECT-TO-QMGR'       TO PV-PARAGRAPH-NAME.      02200000
022100                                                                  02210000
022200     CALL MQV-MQCONN USING CC-QUEUE-MANAGER-NAME                  02220000
022300                           MQV-HCONN                              02230000
022400                           MQV-COMPLETION-CODE                    02240000
022500                           MQV-REASON.                            02250000
022600                                                                  02260000
022700     EVALUATE TRUE                                                02270000
022800        WHEN MQV-COMPLETION-CODE = MQCC-OK                        02280000
022900             DISPLAY 'SUCCESSFULLY CONNECTED TO: '                02290000
023000                                            CC-QUEUE-MANAGER-NAME 02300000
023100        WHEN OTHER                                                02310000
023200             CALL MQV-MQCHECK USING MQV-REASON                    02320000
023300                                    MQV-REASON-TEXT               02330000
023400             DISPLAY 'QUEUE CONNECTING TO ' CC-QUEUE-MANAGER-NAME 02340000
023500             MOVE 'UNABLE TO CONNECT'  TO PV-OPERATION-MSG-1      02350000
023600             PERFORM 9999-ABEND                                   02360001
023700     END-EVALUATE.                                                02370000
023800                                                                  02380000
023900******************************************************************02390000
024000**OPEN THE ITEM QUEUE                                             02400000
024100******************************************************************02410000
024200 1300-OPEN-LOCATION-QUEUE.                                        02420001
024300                                                                  02430000
024400     MOVE '1300-OPEN-LOCATION-QUEUE' TO PV-PARAGRAPH-NAME.        02440001
024500                                                                  02450000
024600     MOVE CC-LOCATION-QUEUE-NAME   TO MQOD-OBJECTNAME             02460001
024700     MOVE CC-QUEUE-MANAGER-NAME    TO MQOD-OBJECTQMGRNAME.        02470000
024800                                                                  02480000
024900     COMPUTE MQV-OPEN-OPTIONS      = MQOO-INPUT-SHARED            02490000
025000                                   + MQOO-OUTPUT                  02500000
025100                                   + MQOO-SET-IDENTITY-CONTEXT    02510000
025200                                   + MQOO-FAIL-IF-QUIESCING.      02520000
025300                                                                  02530000
025400     CALL MQV-MQOPEN USING MQV-HCONN                              02540000
025500                           MQM-OBJECT-DESCRIPTOR                  02550000
025600                           MQV-OPEN-OPTIONS                       02560000
025700                           MQV-ITEM-HANDLE                        02570000
025800                           MQV-COMPLETION-CODE                    02580000
025900                           MQV-REASON.                            02590000
026000                                                                  02600000
026100     EVALUATE TRUE                                                02610000
026200        WHEN MQV-COMPLETION-CODE = MQCC-OK                        02620000
026300             DISPLAY 'SUCCESSFULLY OPENED QUEUE: '                02630000
026400                                        CC-LOCATION-QUEUE-NAME    02640002
026500        WHEN OTHER                                                02650000
026600             CALL MQV-MQCHECK USING MQV-REASON                    02660000
026700                                   MQV-REASON-TEXT                02670000
026800             DISPLAY 'CANNOT OPEN QUEUE ' CC-QUEUE-MANAGER-NAME   02680000
026900             MOVE 'CANNOT OPEN QUEUE'  TO PV-OPERATION-MSG-1      02690000
027000             PERFORM 9100-DISCONNECT-QMGR                         02700001
027100             PERFORM 9999-ABEND                                   02710001
027200     END-EVALUATE.                                                02720000
027300                                                                  02730000
027400******************************************************************02740000
027500**OPEN THE ITEM ERROR QUEUE                                       02750000
027600******************************************************************02760000
027700 1400-OPEN-LOCATION-ERROR-QUEUE.                                  02770001
027800                                                                  02780000
027900     MOVE '1400-OPEN-LOCATION-ERROR-QUEUE' TO PV-PARAGRAPH-NAME.  02790001
028000                                                                  02800000
028100     MOVE CC-LOCATION-ERROR-QUEUE-NAME TO MQOD-OBJECTNAME         02810001
028200     MOVE CC-QUEUE-MANAGER-NAME        TO MQOD-OBJECTQMGRNAME.    02820000
028300                                                                  02830000
028400     COMPUTE MQV-OPEN-OPTIONS      = MQOO-INPUT-SHARED            02840000
028500                                   + MQOO-OUTPUT                  02850000
028600                                   + MQOO-SET-IDENTITY-CONTEXT    02860000
028700                                   + MQOO-FAIL-IF-QUIESCING.      02870000
028800                                                                  02880000
028900     CALL MQV-MQOPEN USING MQV-HCONN                              02890000
029000                           MQM-OBJECT-DESCRIPTOR                  02900000
029100                           MQV-OPEN-OPTIONS                       02910000
029200                           MQV-ERROR-HANDLE                       02920000
029300                           MQV-COMPLETION-CODE                    02930000
029400                           MQV-REASON.                            02940000
029500                                                                  02950000
029600     EVALUATE TRUE                                                02960000
029700        WHEN MQV-COMPLETION-CODE = MQCC-OK                        02970000
029800             DISPLAY 'SUCCESSFULLY OPENED QUEUE: '                02980000
029900                                   CC-LOCATION-ERROR-QUEUE-NAME   02990002
030000        WHEN OTHER                                                03000000
030100             CALL MQV-MQCHECK USING MQV-REASON                    03010000
030200                                    MQV-REASON-TEXT               03020000
030300             MOVE 'CANNOT OPEN QUEUE'  TO PV-OPERATION-MSG-1      03030000
030400             PERFORM 9100-DISCONNECT-QMGR                         03040001
030500             PERFORM 9999-ABEND                                   03050001
030600     END-EVALUATE.                                                03060000
030700                                                                  03070000
030800******************************************************************03080000
030900**READ ITEM MESSAGE FROM ERROR QUEUE AND PLACE ON ITEM QUEUE OR   03090000
031000**     WRITE TO A FLAT FILE.                                      03100000
031100******************************************************************03110000
031200 2000-PROCESS-RECORDS.                                            03120000
031300                                                                  03130000
031400     MOVE '2000-PROCESS-RECORDS'         TO PV-PARAGRAPH-NAME.    03140000
031500                                                                  03150000
031600*INITIALIZE VARIABLES FOR EACH MESSAGE RETRIEVED                  03160000
031700     INITIALIZE MESSAGE-LOG-RECORD.                               03170000
031800                                                                  03180000
031900     EVALUATE TRUE                                                03190000
032000        WHEN CC-WRITE-TO-FLAT-FILE                                03200000
032100             PERFORM 2300-COMMIT-MESSAGE                          03210000
032200             PERFORM 2400-BACKUP-MESSAGE                          03220000
032300        WHEN CC-WRITE-TO-LOCATION-QUEUE                           03230001
032400             PERFORM 2400-BACKUP-MESSAGE                          03240000
032500             PERFORM 2500-PUT-ON-LOCATION-QUEUE                   03250001
032600             PERFORM 2300-COMMIT-MESSAGE                          03260000
032700        WHEN OTHER                                                03270000
032800             DISPLAY 'INVALID CONTROL CARD #4'                    03280000
032900             DISPLAY 'CONTROL CARD CONTENTS: '                    03290000
033000                                        CC-CONTROL-CARD-4-LAYOUT  03300000
033100             PERFORM 9999-ABEND                                   03310001
033200     END-EVALUATE.                                                03320000
033300                                                                  03330000
033400     IF  PS-PROCESS-CONTINUE                                      03340000
033500         PERFORM 7400-RETRIEVE-MESSAGE                            03350003
033600     END-IF.                                                      03360000
033700                                                                  03370000
033800******************************************************************03380000
033900**REMOVES MESSAGE FROM QUEUE                                      03390000
034000******************************************************************03400000
034100 2300-COMMIT-MESSAGE.                                             03410000
034200                                                                  03420000
034300     MOVE '2300-COMMIT-MESSAGE'          TO PV-PARAGRAPH-NAME.    03430000
034400                                                                  03440000
034500     CALL MQV-MQCMIT USING MQV-HCONN                              03450000
034600                           MQV-COMPLETION-CODE                    03460000
034700                           MQV-REASON.                            03470000
034800                                                                  03480000
034900     EVALUATE TRUE                                                03490000
035000        WHEN MQV-COMPLETION-CODE = MQCC-OK                        03500000
035100             CONTINUE                                             03510000
035200        WHEN OTHER                                                03520000
035300             CALL MQV-MQCHECK USING MQV-REASON                    03530000
035400                                    MQV-REASON-TEXT               03540000
035500             MOVE 'ERROR COMMITING DATA' TO PV-OPERATION-MSG-1    03550000
035600             PERFORM 9200-BACK-OUT-MQV-CHANGES                    03560001
035700             PERFORM 9100-DISCONNECT-QMGR                         03570001
035800             PERFORM 9999-ABEND                                   03580001
035900     END-EVALUATE.                                                03590000
036000                                                                  03600000
036100******************************************************************03610000
036200**WRITES MESSAGE TO A LOG IN CASE RECOVERY IS NEEDED              03620000
036300******************************************************************03630000
036400 2400-BACKUP-MESSAGE.                                             03640000
036500                                                                  03650000
036600     MOVE '2400-BACKUP-MESSAGE' TO PV-PARAGRAPH-NAME.             03660000
036700                                                                  03670000
036800     MOVE MQV-MSGBUFFER TO MESSAGE-LOG-RECORD.                    03680000
036900     WRITE MESSAGE-LOG-RECORD.                                    03690000
037000                                                                  03700000
037100     ADD +1                     TO PC-MESSAGES-WRITTEN-TO-FILE.   03710000
037200                                                                  03720000
037300******************************************************************03730000
037400**PUTS MESSAGE THAT HAD ERROR ON ERROR QUEUE                      03740000
037500******************************************************************03750000
037600 2500-PUT-ON-LOCATION-QUEUE.                                      03760001
037700                                                                  03770000
037800     MOVE '2500-PUT-ON-LOCATION-QUEUE' TO PV-PARAGRAPH-NAME.      03780001
037900                                                                  03790000
038000     MOVE CC-LOCATION-QUEUE-NAME   TO MQOD-OBJECTNAME             03800001
038100     MOVE CC-QUEUE-MANAGER-NAME    TO MQOD-OBJECTQMGRNAME.        03810000
038200                                                                  03820000
038300     MOVE HORD100-RECORD           TO MQV-ERRMSGBUF.              03830001
038400                                                                  03840000
038500     MOVE MQMI-NONE                TO MQMD-MSGID.                 03850000
038600     MOVE MQCI-NONE                TO MQMD-CORRELID.              03860000
038700     MOVE MQFMT-STRING             TO MQMD-FORMAT.                03870000
038800     COMPUTE MQPMO-OPTIONS  =  MQPMO-SYNCPOINT.                   03880000
038900                                                                  03890000
039000                                                                  03900000
039100     CALL MQV-MQPUT USING MQV-HCONN                               03910000
039200                          MQV-ITEM-HANDLE                         03920000
039300                          MQM-MESSAGE-DESCRIPTOR                  03930000
039400                          MQM-PUT-MESSAGE-OPTIONS                 03940000
039500                          MQV-MSG-LENGTH                          03950000
039600                          MQV-ERRMSGBUF                           03960000
039700                          MQV-COMPLETION-CODE                     03970000
039800                          MQV-REASON.                             03980000
039900                                                                  03990000
040000     EVALUATE TRUE                                                04000000
040100        WHEN MQV-COMPLETION-CODE = MQCC-OK                        04010000
040200             ADD +1                 TO PC-MESSAGES-TO-QUEUE       04020000
040300        WHEN OTHER                                                04030000
040400             DISPLAY 'UNABLE TO WRITE TO ITEM ERROR QUEUE'        04040000
040500             CALL MQV-MQCHECK USING MQV-REASON                    04050000
040600                                    MQV-REASON-TEXT               04060000
040700             MOVE 'MQBACK ERROR'      TO PV-OPERATION-MSG-1       04070000
040800             PERFORM 9100-DISCONNECT-QMGR                         04080001
040900             PERFORM 9999-ABEND                                   04090001
041000     END-EVALUATE.                                                04100000
041100                                                                  04110000
041200***************************************************************** 04120001
041300**READ CONTROL CARD 1 - MQ CONNECTION MANAGER                     04130001
041400***************************************************************** 04140001
041500 7000-READ-CONTROL-CARD-1.                                        04150001
041600                                                                  04160001
041700     READ CONTROL-CARD-1 INTO CC-CONTROL-CARD-1-LAYOUT.           04170001
041800                                                                  04180001
041900***************************************************************** 04190001
042000**READ CONTROL CARD 2 - ITEM QUEUE NAME                           04200001
042100***************************************************************** 04210001
042200 7100-READ-CONTROL-CARD-2.                                        04220001
042300                                                                  04230001
042400     READ CONTROL-CARD-2 INTO CC-CONTROL-CARD-2-LAYOUT.           04240001
042500                                                                  04250001
042600***************************************************************** 04260001
042700**READ CONTROL CARD 3 - ERROR QUEUE NAME                          04270001
042800***************************************************************** 04280001
042900 7200-READ-CONTROL-CARD-3.                                        04290001
043000                                                                  04300001
043100     READ CONTROL-CARD-3 INTO CC-CONTROL-CARD-3-LAYOUT.           04310001
043200                                                                  04320001
043300***************************************************************** 04330001
043400**READ CONTROL CARD 4 - INDICATES SEND MESSAGES TO FILE OR QUEUE  04340001
043500***************************************************************** 04350001
043600 7300-READ-CONTROL-CARD-4.                                        04360001
043700                                                                  04370001
043800     READ CONTROL-CARD-4 INTO CC-CONTROL-CARD-4-LAYOUT.           04380001
043900                                                                  04390001
044000******************************************************************04400000
044100**RETRIEVES NEXT MESSAGE FROM THE ERROR QUEUE                     04410000
044200******************************************************************04420000
044300 7400-RETRIEVE-MESSAGE.                                           04430003
044400                                                                  04440000
044500     MOVE '7400-RETRIEVE-MESSAGE' TO PV-PARAGRAPH-NAME.           04450003
044600                                                                  04460000
044700     INITIALIZE MQV-MSGBUFFER                                     04470000
044800                MQV-ERRMSGBUF                                     04480000
044900                MQV-MSG.                                          04490000
045000                                                                  04500000
045100     MOVE MQMI-NONE            TO MQMD-MSGID.                     04510000
045200     MOVE MQFMT-STRING         TO MQMD-FORMAT.                    04520000
045300     MOVE 60                   TO MQGMO-WAITINTERVAL.             04530000
045400                                                                  04540000
045500     COMPUTE MQGMO-OPTIONS  = MQGMO-SYNCPOINT +                   04550000
045600                              MQGMO-WAIT.                         04560000
045700                                                                  04570000
045800     COMPUTE MQGMO-OPTIONS  =  MQGMO-SYNCPOINT +                  04580000
045900                               MQGMO-CONVERT   +                  04590000
046000                               MQGMO-ACCEPT-TRUNCATED-MSG +       04600000
046100                               MQGMO-WAIT.                        04610000
046200                                                                  04620000
046300     CALL MQV-MQGET USING MQV-HCONN                               04630000
046400                          MQV-ERROR-HANDLE                        04640000
046500                          MQM-MESSAGE-DESCRIPTOR                  04650000
046600                          MQM-GET-MESSAGE-OPTIONS                 04660000
046700                          MQV-MSG-LENGTH                          04670000
046800                          MQV-MSGBUFFER                           04680000
046900                          MQV-DATA-LENGTH                         04690000
047000                          MQV-COMPLETION-CODE                     04700000
047100                          MQV-REASON.                             04710000
047200                                                                  04720000
047300     IF  MQV-COMPLETION-CODE = MQCC-OK                            04730000
047400         ADD +1             TO PC-MESSAGE-FROM-QUEUE              04740000
047500         INITIALIZE HORD100-RECORD                                04750001
047600         MOVE MQV-MSGBUFFER TO HORD100-RECORD                     04760001
047700     ELSE                                                         04770000
047800         EVALUATE TRUE                                            04780000
047900            WHEN MQV-REASON = MQRC-NO-MSG-AVAILABLE               04790000
048000                 SET PS-PROCESS-COMPLETE  TO TRUE                 04800000
048100            WHEN OTHER                                            04810000
048200                 CALL MQV-MQCHECK USING MQV-REASON                04820000
048300                                        MQV-REASON-TEXT           04830000
048400                 MOVE 'ERROR RETRIEVING MESSAGE'                  04840000
048500                                       TO PV-OPERATION-MSG-1      04850000
048600                 PERFORM 9200-BACK-OUT-MQV-CHANGES                04860001
048700                 PERFORM 9100-DISCONNECT-QMGR                     04870001
048800                 PERFORM 9999-ABEND                               04880001
048900         END-EVALUATE                                             04890000
049000     END-IF.                                                      04900000
049100                                                                  04910000
049200****************************************************************  04920001
049300*END OF PROGRAM ROUTINE                                           04930001
049400****************************************************************  04940001
049500 9000-WRAPUP.                                                     04950001
049600                                                                  04960001
049700     PERFORM 9300-CLOSE-QUEUES.                                   04970001
049800     PERFORM 9100-DISCONNECT-QMGR.                                04980001
049900                                                                  04990001
050000     CLOSE CONTROL-CARD-1                                         05000001
050100           CONTROL-CARD-2                                         05010001
050200           CONTROL-CARD-3                                         05020001
050300           CONTROL-CARD-4                                         05030001
050400           MESSAGE-LOG.                                           05040001
050500                                                                  05050001
050600     PERFORM 9400-DISPLAY-STATISTICS.                             05060001
050700                                                                  05070001
050800***************************************************************** 05080000
050900**DISCONNECT FROM THE QUEUE MANAGER                               05090000
051000***************************************************************** 05100000
051100 9100-DISCONNECT-QMGR.                                            05110001
051200                                                                  05120000
051300     CALL MQV-MQDISC USING MQV-HCONN                              05130000
051400                           MQV-COMPLETION-CODE                    05140000
051500                           MQV-REASON.                            05150000
051600                                                                  05160000
051700     EVALUATE TRUE                                                05170000
051800        WHEN MQV-COMPLETION-CODE = MQCC-OK                        05180000
051900             CONTINUE                                             05190000
052000        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                05200000
052100             CALL MQV-MQCHECK USING MQV-REASON                    05210000
052200                                    MQV-REASON-TEXT               05220000
052300             MOVE 'MQDISC ERROR'       TO PV-OPERATION-MSG-1      05230000
052400             PERFORM 9999-ABEND                                   05240001
052500     END-EVALUATE.                                                05250000
052600                                                                  05260000
052700***************************************************************** 05270001
052800**ROLLBACK MQ CHANGES                                             05280001
052900***************************************************************** 05290001
053000 9200-BACK-OUT-MQV-CHANGES.                                       05300001
053100                                                                  05310001
053200     CALL MQV-MQBACK USING MQV-HCONN                              05320001
053300                           MQV-COMPLETION-CODE                    05330001
053400                           MQV-REASON.                            05340001
053500                                                                  05350001
053600     EVALUATE TRUE                                                05360001
053700        WHEN MQV-COMPLETION-CODE = MQCC-OK                        05370001
053800             CONTINUE                                             05380001
053900        WHEN OTHER                                                05390001
054000             CALL MQV-MQCHECK USING MQV-REASON                    05400001
054100                                    MQV-REASON-TEXT               05410001
054200             MOVE 'MQBACK ERROR'  TO PV-OPERATION-MSG-1           05420001
054300             PERFORM 9100-DISCONNECT-QMGR                         05430001
054400             PERFORM 9999-ABEND                                   05440001
054500     END-EVALUATE.                                                05450001
054600                                                                  05460001
054700***************************************************************** 05470000
054800**CLOSE XS ITEM AND XS ITEM ERROR QUEUE                           05480000
054900***************************************************************** 05490000
055000 9300-CLOSE-QUEUES.                                               05500001
055100                                                                  05510000
055200     CALL MQV-MQCLOSE USING MQV-HCONN                             05520000
055300                            MQV-ITEM-HANDLE                       05530000
055400                            MQCO-NONE                             05540000
055500                            MQV-COMPLETION-CODE                   05550000
055600                            MQV-REASON.                           05560000
055700                                                                  05570000
055800     EVALUATE TRUE                                                05580000
055900        WHEN MQV-COMPLETION-CODE = MQCC-OK                        05590000
056000             CONTINUE                                             05600000
056100        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                05610000
056200             CALL MQV-MQCHECK USING MQV-REASON                    05620000
056300                                    MQV-REASON-TEXT               05630000
056400             MOVE 'CANNOT CLOSE ITEM QUEUE' TO PV-OPERATION-MSG-1 05640000
056500             PERFORM 9999-ABEND                                   05650001
056600     END-EVALUATE.                                                05660000
056700                                                                  05670000
056800     CALL MQV-MQCLOSE USING MQV-HCONN                             05680000
056900                            MQV-ERROR-HANDLE                      05690000
057000                            MQCO-NONE                             05700000
057100                            MQV-COMPLETION-CODE                   05710000
057200                            MQV-REASON.                           05720000
057300                                                                  05730000
057400     EVALUATE TRUE                                                05740000
057500        WHEN MQV-COMPLETION-CODE = MQCC-OK                        05750000
057600             CONTINUE                                             05760000
057700        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                05770000
057800             CALL MQV-MQCHECK USING MQV-REASON                    05780000
057900                                    MQV-REASON-TEXT               05790000
058000             MOVE 'CANNOT CLOSE ERROR QUEUE' TO PV-OPERATION-MSG-105800000
058100             PERFORM 9999-ABEND                                   05810001
058200     END-EVALUATE.                                                05820000
058300                                                                  05830000
058400****************************************************************  05840000
058500*DISPLAY PROGRAM STATISTICS FOR THIS RUN                          05850000
058600****************************************************************  05860000
058700 9400-DISPLAY-STATISTICS.                                         05870001
058800                                                                  05880000
058900     DISPLAY '*********************************************'.     05890000
059000     DISPLAY 'PROGRAM NAME  : ' PC-CURRENT-PROGRAM-NAME.          05900000
059100     DISPLAY '*********************************************'.     05910000
059200     DISPLAY 'MESSAGES FROM ITEM ERROR QUEUE: '                   05920000
059300                                      PC-MESSAGE-FROM-QUEUE.      05930000
059400     DISPLAY 'MESSAGES WRITTEN TO FLAT FILE: '                    05940000
059500                                      PC-MESSAGES-WRITTEN-TO-FILE.05950000
059600     DISPLAY 'MESSAGES WRITTEN TO ITEM QUEUE: '                   05960000
059700                                      PC-MESSAGES-TO-QUEUE.       05970000
059800     DISPLAY '*********************************************'.     05980000
059900                                                                  05990000
060000******************************************************************06000000
060100**MQ ABEND ROUTINE                                                06010000
060200******************************************************************06020000
060300 9999-ABEND.                                                      06030001
060400                                                                  06040000
060500     DISPLAY '**** ABEND *************************************'.  06050000
060600     DISPLAY '** MQSERIES ERROR **'.                              06060000
060700     DISPLAY '** PROGRAM:    ' PC-CURRENT-PROGRAM-NAME.           06070000
060800     DISPLAY '** ABEND CODE: ' ABEND-CODE.                        06080000
060900     DISPLAY '** PARAGRAPH:  ' PV-PARAGRAPH-NAME.                 06090000
061000     DISPLAY '** MESSAGE:    ' PV-OPERATION-MSG-1.                06100000
061100     DISPLAY '** COMP CODE:  ' MQV-COMPLETION-CODE.               06110000
061200     DISPLAY '** RSN CODE:   ' MQV-REASON.                        06120000
061300     DISPLAY '** RSN TEXT:   ' MQV-REASON-TEXT.                   06130000
061400     DISPLAY '************************************************'.  06140000
061500     MOVE +4013 TO ABEND-CODE.                                    06150000
061600     CALL 'ILBOABN0' USING ABEND-CODE.                            06160000
