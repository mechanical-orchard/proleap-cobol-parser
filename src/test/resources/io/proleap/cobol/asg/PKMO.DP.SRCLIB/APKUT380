000100*------------------------*                                        00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300*------------------------*                                        00030000
000400 PROGRAM-ID.     APKUT380.                                        00040001
000500 AUTHOR.         BARB SCHULTZ.                                    00050000
000600 DATE-WRITTEN.   MARCH 2020.                                      00060000
000700*---------------------------------------------------------------* 00070000
000800*         CREATE LOAD FILE FOR THE ASP FREIGHT CLAIMS SYSTEM    * 00080000
000900*         BY TRANSSOLUTIONS.                                    * 00090000
001000*---------------------------------------------------------------* 00100000
001100*                      COBOL 2 WITH SQL                         * 00110000
001200*---------------------------------------------------------------* 00120000
001300* THIS PROGRAM CREATES A LOAD FILE OF NEW SHIPPER INFORMATION   * 00130000
001400* THAT WILL BE LOADED INTO THE ASP FREIGHT CLAIMS SYSTEM BY     * 00140000
001500* TRANSSOLUTIONS. COPIED FROM FRKUT002.                         * 00150000
001600*---------------------------------------------------------------* 00160000
001700*  DB2 TABLES:                                                  * 00170000
001800*   1. EXTERNAL ENTERPRISE TABLE                (TEXTENT)       * 00180000
001900*   2. EXTERNAL ENTERPRISE NAME TABLE           (TENTNME)       * 00190000
002000*   3. EXTERNAL ENTERPRISE REPRESENTATIVE TABLE (TENTREP)       * 00200000
002100*   4. BUSINESS LOCATION TABLE                  (TBUSLOC)       * 00210000
002200*   5. BUSINESS FUNCTION TABLE                  (TBUSFNC)       * 00220000
002300*                                                               * 00230000
002400*  OUTPUT:                                                      * 00240000
002500*   1. AP-LOAD-FILE                             (APRD380)       * 00250001
002600*                                                               * 00260000
002700*---------------------------------------------------------------* 00270000
002800* CHANGE LOG:                                                   * 00280000
002900*   03/31/2020                                                  * 00290000
003000*      CHANGE MADE: INITIAL IMPLEMENTATION.                     * 00300000
003100*   MADE BY: BARB SCHULTZ                WR#: CHG0??????        * 00310000
003200*                                                               * 00320000
003700*---------------------------------------------------------------* 00330000
003800                                                                  00340000
003900*---------------------*                                           00350000
004000 ENVIRONMENT DIVISION.                                            00360000
004100*---------------------*                                           00361000
004200 CONFIGURATION SECTION.                                           00362000
004300 SOURCE-COMPUTER.    IBM-3090.                                    00363000
004400 OBJECT-COMPUTER.    IBM-3090.                                    00364000
004500                                                                  00365000
004600 INPUT-OUTPUT SECTION.                                            00366000
004700 FILE-CONTROL.                                                    00367000
004800                                                                  00368000
004900     SELECT AP-LOAD-FILE          ASSIGN TO OUT01.                00369000
005000                                                                  00370000
005100 DATA DIVISION.                                                   00380000
005200 FILE SECTION.                                                    00390000
005300                                                                  00400000
005400 FD  AP-LOAD-FILE                                                 00410000
005500     RECORDING MODE IS F                                          00420000
005600     LABEL RECORDS ARE STANDARD                                   00430000
005700     BLOCK CONTAINS 0 RECORDS                                     00440000
005800     DATA RECORD IS AP-LOAD-RECORD.                               00450000
005900 01  AP-LOAD-RECORD              PIC  X(411).                     00460000
006000                                                                  00470000
006100 WORKING-STORAGE SECTION.                                         00480000
006200*--------------------------------------------------------------*  00490000
006300* OUTPUT LAYOUT FOR LOAD FILE                                  *  00500000
006400*--------------------------------------------------------------*  00510000
006500     COPY APRD380.                                                00520001
006600                                                                  00530000
006700*--------------------------------------------------------------*  00540000
006800* SQLCA FORMATTED MESSAGE AREA                                 *  00550000
006900*--------------------------------------------------------------*  00560000
007000     COPY DPWS004.                                                00570000
007100                                                                  00580000
007200*--------------------------------------------------------------*  00590000
007300* COMMUNICATIONS AREA FOR DB2                                  *  00600000
007400*--------------------------------------------------------------*  00610000
007500     COPY SQLCA2.                                                 00620000
007600                                                                  00630000
007700 01  PROGRAM-CONSTANTS.                                           00640000
007800     05  PC-PROGRAM-NAME             PIC X(08)  VALUE 'APKUT380'. 00650001
007900     05  PC-MAX-RETRIES              PIC 9(02)  VALUE 3.          00660000
008000     05  PC-FUNCTION-ID              PIC S9(04) VALUE +9  COMP.   00670000
008100     05  PC-STATUS-CDE               PIC X(01)  VALUE 'A'.        00680000
008200     05  PC-PRIM-TYP-CDE             PIC X(01)  VALUE 'M'.        00690000
008300     05  PC-PRTNR-TYP-CDE            PIC X(02)  VALUE 'CR'.       00700000
008400     05  PC-TYPE-CDE                 PIC X(02)  VALUE '01'.       00710000
008500                                                                  00720000
008600 01  PROGRAM-VARIABLES.                                           00730000
008700     05  PV-RETRY-COUNTER            PIC 9(02)  VALUE ZERO.       00740000
009000     05  PV-SHIPPERS-CNT             PIC 9(08)  VALUE ZEROS.      00750000
009100     05  PV-PREV-DUN-NBR             PIC X(09)  VALUE SPACES.     00760000
009200     05  PV-SAVED-ENT-ID             PIC S9(09) COMP.             00770000
009300                                                                  00780000
009400 01  PROGRAM-SWITCHES.                                            00790000
009500     05  PS-END-SHIPPER-CSR-SW       PIC X(01)  VALUE 'N'.        00800000
009600         88  PS-NOT-END-OF-SHIPPER-CSR          VALUE 'N'.        00810000
009700         88  PS-END-OF-SHIPPER-CSR              VALUE 'Y'.        00820000
009800                                                                  00830000
009900*----------------------------------------------------------------*00840000
010000* DB2 ABEND AREA                                                 *00850000
010100*----------------------------------------------------------------*00860000
010200 01  ABEND-CODE                 PIC S9(4) VALUE ZEROES COMP SYNC. 00870000
010300     88  AC-ANY-ERROR                     VALUE +4001 THRU +4019. 00880000
010400     88  AC-OPEN-ERROR                    VALUE +4005.            00890000
010500     88  AC-CLOSE-ERROR                   VALUE +4006.            00900000
010600     88  AC-INVALID-DATA                  VALUE +4008.            00910000
010700     88  AC-DB2-ERROR                     VALUE +4013.            00920000
010800     88  AC-UNSUCCESSFUL-SELECT           VALUE +4015.            00930000
010900     88  AC-MAX-RETRIES-EXCEEDED          VALUE +4016.            00940000
011000                                                                  00950000
011100 01  ABEND-AREAS.                                                 00960000
011200     05  AA-ABEND-LIT                     PIC X(40) VALUE         00970000
011300             '*****       ABEND'.                                 00980000
011400     05  AA-PROGRAM-LIT                   PIC X(40) VALUE         00990000
011500             '*****   PROGRAM: APKUT380'.                         01000001
011600     05  AA-PARAGRAPH-LIT.                                        01010000
011700         10  FILLER                       PIC X(17) VALUE         01020000
011800             '***** PARAGRAPH: '.                                 01030000
011900         10  AA-PARAGRAPH-NAME            PIC X(35) VALUE SPACES. 01040000
012000     05  AA-MESSAGE-LINE-1.                                       01050000
012100         10  FILLER                       PIC X(06) VALUE '*****'.01060000
012200         10  AA-MESSAGE-1                 PIC X(80) VALUE SPACES. 01070000
012300     05  AA-MESSAGE-LINE-2.                                       01080000
012400         10  FILLER                       PIC X(06) VALUE '*****'.01090000
012500         10  AA-MESSAGE-2                 PIC X(80) VALUE SPACES. 01100000
012600     05  AA-DB2-ERROR-LIT                 PIC X(40) VALUE         01110000
012700             '*****    DB2 ERROR'.                                01120000
012800     05  AA-DB2-OPERATION-LIT.                                    01130000
012900         10  FILLER                       PIC X(17) VALUE         01140000
013000             '***** OPERATION: '.                                 01150000
013100         10  AA-DB2-OPERATION.                                    01160000
013200             15  AA-DB2-OP-1              PIC X(25) VALUE SPACES. 01170000
013300             15  AA-DB2-OP-2              PIC X(25) VALUE SPACES. 01180000
013400     05  AA-DB2-TABLE-1                   PIC X(08) VALUE SPACES. 01190000
013500     05  AA-DB2-TABLE-2                   PIC X(08) VALUE SPACES. 01200000
013600     05  AA-DB2-TABLE-3                   PIC X(08) VALUE SPACES. 01210000
013700     05  AA-DB2-TABLE-4                   PIC X(08) VALUE SPACES. 01220000
013800     05  AA-DB2-TABLE-5                   PIC X(08) VALUE SPACES. 01230000
013900                                                                  01240000
014000*--------------------------------------------------------------*  01250000
014100*    SQL COMMUNICATIONS AREA DCLGEN                            *  01260000
014200*--------------------------------------------------------------*  01270000
014300     EXEC SQL                                                     01280000
014400         INCLUDE SQLCA                                            01290000
014500     END-EXEC.                                                    01300000
014600                                                                  01310000
014700*--------------------------------------------------------------*  01320000
014800*    EXTERNAL ENTERPRISE TABLE                                 *  01330000
014900*--------------------------------------------------------------*  01340000
015000     EXEC SQL                                                     01350000
015100         INCLUDE TEXTENT                                          01360000
015200     END-EXEC.                                                    01370000
015300                                                                  01380000
015400*--------------------------------------------------------------*  01390000
015500*    EXTERNAL ENTERPRISE NAME TABLE                            *  01400000
015600*--------------------------------------------------------------*  01410000
015700     EXEC SQL                                                     01420000
015800         INCLUDE TENTNME                                          01430000
015900     END-EXEC.                                                    01440000
016000                                                                  01450000
016100*--------------------------------------------------------------*  01460000
016200*    BUSINESS LOCATION TABLE                                   *  01470000
016300*--------------------------------------------------------------*  01480000
016400     EXEC SQL                                                     01490000
016500         INCLUDE TBUSLOC                                          01500000
016600     END-EXEC.                                                    01510000
016700                                                                  01520000
016800*--------------------------------------------------------------*  01530000
016900*    EXTERNAL ENTERPRISE REPRESENTATIVE TABLE                  *  01540000
017000*--------------------------------------------------------------*  01550000
017100     EXEC SQL                                                     01560000
017200         INCLUDE TENTREP                                          01570000
017300     END-EXEC.                                                    01580000
017400                                                                  01590000
017500*--------------------------------------------------------------*  01600000
017600*    BUSINESS FUNCTION TABLE                                   *  01610000
017700*--------------------------------------------------------------*  01620000
017800     EXEC SQL                                                     01630000
017900         INCLUDE TBUSFNC                                          01640000
018000     END-EXEC.                                                    01650000
018100                                                                  01660000
018200*--------------------------------------------------------------*  01670000
018300*  SHIPPER CURSOR -- SELECTS ALL VENDORS WHO ARE ACTIVE,       *  01680000
018400*                   (STATUS_CDE = 'A') AND WHO ARE SHIPPERS,   *  01690000
018500*                   (PRIM_TYP_CDE = 'E' AND PRTNR_TYP_CDE =    *  01700000
018600*                   'CR').                                     *  01710000
018700*--------------------------------------------------------------*  01720000
018800     EXEC SQL                                                     01730000
018900       DECLARE SHIPPER_CSR CURSOR FOR                             01740000
019000         SELECT C.SEQ_NBR                                         01750000
019100              , C.ENT_ID                                          01760000
019200              , A.DUN_NBR                                         01770000
019300              , B.ENT_NAME_DESC                                   01780000
019400              , C.FIRST_NAME                                      01790000
019500              , C.LAST_NAME                                       01800000
019600              , C.TEL1_NBR                                        01810000
019700              , C.TEL1_EXT_NBR                                    01820000
019800              , C.FAX_NBR                                         01830000
019900              , C.EMAIL_ADDR_ID                                   01840000
020100           FROM TEXTENT A                                         01850000
020200              , TENTNME B                                         01860000
020300              , TENTREP C                                         01870000
020400          WHERE A.ENT_ID = B.ENT_ID                               01880000
020500            AND B.ENT_ID = C.ENT_ID                               01890000
020600            AND A.STATUS_CDE = :PC-STATUS-CDE                     01900000
020700            AND A.PRIM_TYP_CDE = :PC-PRIM-TYP-CDE                 01910000
020800            AND B.TYPE_CDE = :PC-TYPE-CDE                         01920000
020900            AND C.SEQ_NBR =                                       01930000
021000                (SELECT MAX(D.SEQ_NBR)                            01940000
021100                   FROM TBUSLOC D                                 01950000
021200                  WHERE D.ENT_ID = C.ENT_ID)                      01960000
021300     END-EXEC.                                                    01970000
021400                                                                  01980000
021500*-------------------*                                             01990000
021600 PROCEDURE DIVISION.                                              02000000
021700*-------------------*                                             02010000
021800 A100-MAINLINE.                                                   02020000
021900                                                                  02030000
022000     PERFORM B100-INITIALIZE.                                     02040000
022100     PERFORM B200-EXTRACT-SHIPPER-DATA                            02050000
022200         UNTIL PS-END-OF-SHIPPER-CSR.                             02060000
022300     PERFORM B300-END-OF-PROGRAM.                                 02070000
022400     GOBACK.                                                      02080000
022500                                                                  02090000
022600*--------------------------------------------------------------*  02100000
022700*    INITIALIZATION PROCESSING                                 *  02110000
022800*                                                              *  02120000
022900*    - INTIALIZE LAYOUTS.                                      *  02130000
023000*    - OPEN FILES.                                             *  02140000
023100*    - OPEN CURSOR.                                            *  02150000
023200*--------------------------------------------------------------*  02160000
023300 B100-INITIALIZE.                                                 02170000
023400                                                                  02180000
023500     OPEN OUTPUT AP-LOAD-FILE.                                    02190000
023600                                                                  02200000
023700     INITIALIZE  DCLTEXTENT                                       02210000
023800                 DCLTENTNME                                       02220000
023900                 DCLTBUSLOC                                       02230000
024000                 DCLTENTREP                                       02240000
024100                 DCLTBUSFNC                                       02250000
024200                 PV-SHIPPERS-CNT                                  02260000
024300                 PV-PREV-DUN-NBR.                                 02270000
024400                                                                  02280000
024500     SET PS-NOT-END-OF-SHIPPER-CSR       TO TRUE.                 02290000
024600     PERFORM Y100-OPEN-SHIPPER-CSR.                               02300000
024700                                                                  02310000
024800*--------------------------------------------------------------*  02320000
024900*  EXTRACT SHIPPER DATA                                        *  02330000
025000*                                                              *  02340000
025100*    - INITIALIZE OUTPUT FILE.                                 *  02350000
025200*    - FETCH SHIPPER CURSOR.                                   *  02360000
025300*--------------------------------------------------------------*  02370000
025400 B200-EXTRACT-SHIPPER-DATA.                                       02380000
025500                                                                  02390000
025600     INITIALIZE AP380-NEW-SHIPPER-EXTRACT.                        02400001
025700     PERFORM S100-FETCH-SHIPPER-CSR.                              02410000
025800                                                                  02420000
026300*--------------------------------------------------------------*  02470000
026400*  END OF PROGRAM PROCESSING                                   *  02480000
026500*                                                              *  02490000
026600*    - DISPLAY END OF PROGRAM MESSAGES                         *  02500000
026700*    - CLOSE THE CURSOR.                                       *  02510000
026800*    - CLOSE THE OUTPUT FILE.                                  *  02520000
026900*--------------------------------------------------------------*  02530000
027000 B300-END-OF-PROGRAM.                                             02540000
027100                                                                  02550000
027200     DISPLAY 'B300-END-OF-PROGRAM'.                               02560000
027300     DISPLAY ' '.                                                 02570000
027400     DISPLAY '************************************************'.  02580000
027500     DISPLAY '** TOTAL SHIPPERS WRITTEN = ' PV-SHIPPERS-CNT.      02590000
027600     DISPLAY '************************************************'.  02600000
027700     DISPLAY ' '.                                                 02610000
027800                                                                  02620000
027900     PERFORM Y200-CLOSE-SHIPPER-CSR.                              02630000
028000     CLOSE AP-LOAD-FILE.                                          02640000
028100                                                                  02650000
028200*--------------------------------------------------------------*  02660000
028300*  FORMAT SHIPPER INFORMATION                                  *  02670000
028400*                                                              *  02680000
028500*    - FORMAT DATA FROM DB2 TABLES INTO OUTPUT FILE.           *  02690000
028600*    - WRITE TO OUTPUT FILE.                                   *  02700000
028700*--------------------------------------------------------------*  02710000
028800 C100-FORMAT-SHIPPER-DATA.                                        02720000
028900                                                                  02730000
029000     MOVE EXTENT-DUN-NBR                 TO AP380-CDE             02740001
029100                                            AP380-VENDOR-NBR.     02750001
029200     MOVE ENTNME-ENT-NAME-DESC           TO AP380-FULL-NAME.      02760001
029300     INSPECT AP380-FULL-NAME REPLACING ALL ',' BY ' '.            02770001
029510     MOVE SPACES                         TO AP380-LOCATION.       02780001
029600     MOVE ENTREP-FIRST-NAME              TO                       02790000
029700                                     AP380-CONTACT-NAME-FIRST.    02800001
029800     MOVE ENTREP-LAST-NAME               TO                       02810000
029900                                     AP380-CONTACT-NAME-LAST.     02820001
030000     MOVE ENTREP-EMAIL-ADDR-ID           TO AP380-CONTACT-EMAIL.  02830001
030100*    MOVE BUSLOC-ADDRESS-LINE1-DESC      TO AP380-ADDRESS-LINE1.  02840001
030200*    MOVE BUSLOC-ADDRESS-LINE2-DESC      TO AP380-ADDRESS-LINE2.  02850001
030300     MOVE BUSLOC-ADDRESS-LINE1-DESC      TO AP380-ADDRESS-LINE2.  02860001
030310     INSPECT AP380-ADDRESS-LINE2 REPLACING ALL ',' BY ' '.        02870001
030400     MOVE BUSLOC-CITY-NAME               TO AP380-CITY.           02880001
030410     INSPECT AP380-CITY REPLACING ALL ',' BY ' '.                 02890001
030500     MOVE BUSLOC-STATE-CDE               TO AP380-STATE.          02900001
030600     MOVE BUSLOC-ZIP-CDE                 TO AP380-ZIP-CDE.        02910001
030700     MOVE ENTREP-TEL1-NBR                TO AP380-OFFICE1-NBR.    02920001
030800     MOVE ENTREP-TEL1-EXT-NBR            TO AP380-OFFICE1-EXT-NBR.02930001
030900     MOVE ENTREP-FAX-NBR                 TO AP380-FAX-NBR.        02940001
031000                                                                  02950000
031100     MOVE ','                            TO AP380-COMMA1          02960001
031200                                            AP380-COMMA2          02970001
031300                                            AP380-COMMA3          02980001
031400                                            AP380-COMMA4          02990001
031500                                            AP380-COMMA5          03000001
031600                                            AP380-COMMA6          03010001
031700                                            AP380-COMMA7          03020001
031800                                            AP380-COMMA8          03030001
031900                                            AP380-COMMA9          03040001
032000                                            AP380-COMMA10         03050001
032100                                            AP380-COMMA11         03060001
032200                                            AP380-COMMA12         03070001
032300                                            AP380-COMMA13.        03080001
032400     MOVE 'V#'                           TO AP380-VENDOR-FILLER.  03090001
032500                                                                  03100000
032600     PERFORM W100-WRITE-LOAD-FILE.                                03110000
032700                                                                  03120000
032800*--------------------------------------------------------------*  03130000
032900*  FETCH SHIPPER-CSR CURSOR                                    *  03140000
033000*--------------------------------------------------------------*  03150000
033100 S100-FETCH-SHIPPER-CSR.                                          03160000
033200                                                                  03170000
033600     SET PS-NOT-END-OF-SHIPPER-CSR         TO TRUE.               03210000
033700                                                                  03220000
033800     PERFORM WITH TEST AFTER                                      03230000
033900       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       03240000
034000         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03250000
034100            OR SQLCODE = ZERO                                     03260000
034200            OR SQLCODE = +100                                     03270000
034300                                                                  03280000
034400        EXEC SQL                                                  03290000
034500          FETCH SHIPPER_CSR                                       03300000
034600           INTO :ENTREP-SEQ-NBR                                   03310000
034700              , :ENTREP-ENT-ID                                    03320000
034800              , :EXTENT-DUN-NBR                                   03330000
034900              , :ENTNME-ENT-NAME-DESC                             03340000
035000              , :ENTREP-FIRST-NAME                                03350000
035100              , :ENTREP-LAST-NAME                                 03360000
035200              , :ENTREP-TEL1-NBR                                  03370000
035300              , :ENTREP-TEL1-EXT-NBR                              03380000
035400              , :ENTREP-FAX-NBR                                   03390000
035500              , :ENTREP-EMAIL-ADDR-ID                             03400000
035700        END-EXEC                                                  03410000
035800                                                                  03420000
036300        EVALUATE TRUE                                             03470000
036400           WHEN SQLCODE = ZERO                                    03480000
036500             MOVE ENTREP-ENT-ID            TO PV-SAVED-ENT-ID     03490000
036600             PERFORM S200-GET-TBUSLOC-DATA                        03500000
036700           WHEN SQLCODE = +100                                    03510000
036800             SET PS-END-OF-SHIPPER-CSR     TO TRUE                03520000
037100           WHEN SQLCODE = -904                                    03550000
037200           WHEN SQLCODE = -913                                    03560000
037300             CONTINUE                                             03570000
037400           WHEN SQLWARN0 NOT = SPACES                             03580000
037500           WHEN SQLCODE  NOT = ZERO                               03590000
037600             MOVE 'S100-FETCH-SHIPPER-CSR'  TO AA-PARAGRAPH-NAME  03600000
037700             MOVE 'UNSUCCESSFUL FETCH FROM SHIPPER_CSR'           03610000
037800                                           TO AA-DB2-OPERATION    03620000
037900             MOVE 'TEXTENT'                TO AA-DB2-TABLE-1      03630000
038000             MOVE 'TENTNME'                TO AA-DB2-TABLE-2      03640000
038100             MOVE 'TENTREP'                TO AA-DB2-TABLE-3      03650000
038200             PERFORM Z999-DB2-ABEND                               03660000
038300        END-EVALUATE                                              03670000
038400     END-PERFORM.                                                 03680000
038500                                                                  03690000
038600     IF PV-RETRY-COUNTER > 3                                      03700000
038700        MOVE 'S100-FETCH-SHIPPER-CSR'     TO AA-PARAGRAPH-NAME    03710000
038800        MOVE 'MAX RETRIES EXCEEDED ON FETCH TEXTENT'              03720000
038900                                         TO AA-DB2-OPERATION      03730000
039000        MOVE 'TEXTENT'                   TO AA-DB2-TABLE-1        03740000
039100        MOVE 'TENTNME'                   TO AA-DB2-TABLE-2        03750000
039200        MOVE 'TENTREP'                   TO AA-DB2-TABLE-3        03760000
039300        PERFORM Z999-DB2-ABEND                                    03770000
039400     END-IF.                                                      03780000
039500                                                                  03790000
039600*--------------------------------------------------------------*  03800000
039700*  GET-TBUSLOC-DATA.                                           *  03810000
039800*--------------------------------------------------------------*  03820000
039900 S200-GET-TBUSLOC-DATA.                                           03830000
040000                                                                  03840000
040500     INITIALIZE  DCLTBUSLOC.                                      03910000
040600                                                                  03920000
040700     PERFORM WITH TEST AFTER                                      03930000
040800       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       03940000
040900         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03950000
041000            OR SQLCODE = ZERO                                     03960000
041100            OR SQLCODE = +100                                     03970000
041200                                                                  03980000
041300        EXEC SQL                                                  03990000
041400            SELECT E.ENT_ID                                       04000000
041500                 , E.ADDRESS_LINE1_DESC                           04010000
041600                 , E.ADDRESS_LINE2_DESC                           04020000
041700                 , E.CITY_NAME                                    04030000
041800                 , E.STATE_CDE                                    04040000
041900                 , E.ZIP_CDE                                      04050000
042000              INTO :BUSLOC-ENT-ID                                 04060000
042100                 , :BUSLOC-ADDRESS-LINE1-DESC                     04070000
042200                 , :BUSLOC-ADDRESS-LINE2-DESC                     04080000
042300                 , :BUSLOC-CITY-NAME                              04090000
042400                 , :BUSLOC-STATE-CDE                              04100000
042500                 , :BUSLOC-ZIP-CDE                                04110000
042600              FROM TBUSLOC E                                      04120000
042700                 , TBUSFNC F                                      04130000
042800             WHERE F.FUNCTION_ID = :PC-FUNCTION-ID                04140000
042900               AND E.FUNCTION_ID = F.FUNCTION_ID                  04150000
043000               AND E.ENT_ID = :PV-SAVED-ENT-ID                    04160000
043100               AND E.SEQ_NBR =                                    04170000
043200                   (SELECT MAX(E1.SEQ_NBR)                        04180000
043300                      FROM TBUSLOC E1                             04190000
043400                     WHERE E1.ENT_ID = :PV-SAVED-ENT-ID           04200000
043410                       AND E1.FUNCTION_ID = :PC-FUNCTION-ID)      04210000
043500        END-EXEC                                                  04220000
043600                                                                  04230000
044000        EVALUATE TRUE                                             04270000
044100           WHEN SQLCODE = ZERO                                    04280000
044200              PERFORM C100-FORMAT-SHIPPER-DATA                    04290000
044300           WHEN SQLCODE = +100                                    04300000
044400              PERFORM C100-FORMAT-SHIPPER-DATA                    04310000
044500              SET PS-END-OF-SHIPPER-CSR     TO TRUE               04320001
044600           WHEN SQLCODE = -904                                    04330000
044700           WHEN SQLCODE = -913                                    04340000
044800             CONTINUE                                             04350000
044900           WHEN SQLWARN0 NOT = SPACES                             04360000
045000           WHEN SQLCODE  NOT = ZERO                               04370000
045100             MOVE 'S200-GET-TBUSLOC-DATA'  TO AA-PARAGRAPH-NAME   04380000
045200             MOVE 'UNSUCCESSFUL GET FROM TBUSLOC'                 04390000
045300                                           TO AA-DB2-OPERATION    04400000
045400             MOVE 'TBUSLOC'                TO AA-DB2-TABLE-1      04410000
045500             MOVE 'TBUSFNC'                TO AA-DB2-TABLE-2      04420000
045600             PERFORM Z999-DB2-ABEND                               04430000
045700        END-EVALUATE                                              04440000
045800     END-PERFORM.                                                 04450000
045900                                                                  04460000
046000     IF PV-RETRY-COUNTER > 3                                      04470000
046100        MOVE 'S200-GET-TBUSLOC-DATA'     TO AA-PARAGRAPH-NAME     04480000
046200        MOVE 'MAX RETRIES EXCEEDED ON FETCH TBUSLOC'              04490000
046300                                         TO AA-DB2-OPERATION      04500000
046400        MOVE 'TBUSLOC'                   TO AA-DB2-TABLE-1        04510000
046500        MOVE 'TBUSFNC'                   TO AA-DB2-TABLE-2        04520000
046600        PERFORM Z999-DB2-ABEND                                    04530000
046700     END-IF.                                                      04540000
046800                                                                  04550000
046900*--------------------------------------------------------------*  04560000
047000*  WRITE EXTRACT FILE                                          *  04570000
047100*--------------------------------------------------------------*  04580000
047200 W100-WRITE-LOAD-FILE.                                            04590000
047300                                                                  04600000
047400     WRITE AP-LOAD-RECORD FROM AP380-NEW-SHIPPER-EXTRACT.         04610001
047500     ADD +1 TO PV-SHIPPERS-CNT.                                   04620000
048100                                                                  04680000
048200*--------------------------------------------------------------*  04690000
048300*  OPEN SHIPPER-CSR CURSOR                                     *  04700000
048400*--------------------------------------------------------------*  04710000
048500 Y100-OPEN-SHIPPER-CSR.                                           04720000
048600                                                                  04730000
048700     PERFORM WITH TEST AFTER                                      04740000
048800        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      04750000
048900          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 04760000
049000             OR SQLCODE = ZERO                                    04770000
049100             OR SQLCODE = +100                                    04780000
049200                                                                  04790000
049300        EXEC SQL                                                  04800000
049400           OPEN SHIPPER_CSR                                       04810000
049500        END-EXEC                                                  04820000
049600                                                                  04830000
049700        EVALUATE TRUE                                             04840000
049800           WHEN SQLCODE = ZERO                                    04850000
049900             CONTINUE                                             04860000
050000           WHEN SQLWARN0 NOT = SPACES                             04870000
050100           WHEN SQLCODE  NOT = ZERO                               04880000
050200             MOVE 'Y100-OPEN-SHIPPER-CSR' TO AA-PARAGRAPH-NAME    04890000
050300             MOVE 'UNSUCCESSFUL OPEN ON SHIPPER_CSR'              04900000
050400                                         TO AA-DB2-OPERATION      04910000
050500             MOVE 'TEXTENT'              TO AA-DB2-TABLE-1        04920000
050600             MOVE 'TENTNME'              TO AA-DB2-TABLE-2        04930000
050700             MOVE 'TENTREP'              TO AA-DB2-TABLE-3        04940000
050800             PERFORM Z999-DB2-ABEND                               04950000
050900        END-EVALUATE                                              04960000
051000     END-PERFORM.                                                 04970000
051100                                                                  04980000
051200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         04990000
051300        MOVE 'Y100-OPEN-SHIPPER-CSR'      TO AA-PARAGRAPH-NAME    05000000
051400        MOVE 'MAX RETRIES EXCEEDED ON TEXTENT SELECT'             05010000
051500                                         TO AA-DB2-OPERATION      05020000
051600        MOVE 'TEXTENT'                   TO AA-DB2-TABLE-1        05030000
051700        MOVE 'TENTNME'                   TO AA-DB2-TABLE-2        05040000
051800        MOVE 'TENTREP'                   TO AA-DB2-TABLE-3        05050000
051900        PERFORM Z999-DB2-ABEND                                    05060000
052000     END-IF.                                                      05070000
052100                                                                  05080000
052200*--------------------------------------------------------------*  05090000
052300*   CLOSE SHIPPER-CSR CURSOR                                   *  05100000
052400*--------------------------------------------------------------*  05110000
052500 Y200-CLOSE-SHIPPER-CSR.                                          05120000
052600                                                                  05130000
052700     PERFORM WITH TEST AFTER                                      05140000
052800        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      05150000
052900          UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                 05160000
053000             OR SQLCODE = ZERO                                    05170000
053100             OR SQLCODE = +100                                    05180000
053200                                                                  05190000
053300        EXEC SQL                                                  05200000
053400           CLOSE SHIPPER_CSR                                      05210000
053500        END-EXEC                                                  05220000
053600                                                                  05230000
053700        EVALUATE TRUE                                             05240000
053800           WHEN SQLCODE = ZERO                                    05250000
053900             CONTINUE                                             05260000
054000           WHEN SQLWARN0 NOT = SPACES                             05270000
054100           WHEN SQLCODE  NOT = ZERO                               05280000
054200             MOVE 'Y200-CLOSE-SHIPPER-CSR' TO AA-PARAGRAPH-NAME   05290000
054300             MOVE 'UNSUCCESSFUL CLOSE ON SHIPPER_CSR'             05300000
054400                                          TO AA-DB2-OPERATION     05310000
054500             MOVE 'TEXTENT'               TO AA-DB2-TABLE-1       05320000
054600             MOVE 'TENTNME'               TO AA-DB2-TABLE-2       05330000
054700             MOVE 'TENTREP'               TO AA-DB2-TABLE-3       05340000
054800             PERFORM Z999-DB2-ABEND                               05350000
054900         END-EVALUATE                                             05360000
055000      END-PERFORM.                                                05370000
055100                                                                  05380000
055200      IF PV-RETRY-COUNTER > PC-MAX-RETRIES                        05390000
055300         MOVE 'Y200-CLOSE-SHIPPER-CSR'     TO AA-PARAGRAPH-NAME   05400000
055400         MOVE 'MAX RETRIES EXCEEDED ON TEXTENT SELECT'            05410000
055500                                          TO AA-DB2-OPERATION     05420000
055600         MOVE 'TEXTENT'                   TO AA-DB2-TABLE-1       05430000
055700         MOVE 'TENTNME'                   TO AA-DB2-TABLE-2       05440000
055800         MOVE 'TENTREP'                   TO AA-DB2-TABLE-3       05450000
055900         PERFORM Z999-DB2-ABEND                                   05460000
056000      END-IF.                                                     05470000
056100                                                                  05480000
056200*--------------------------------------------------------------*  05490000
056300*    DB2 ABEND ROUTINE                                         *  05500000
056400*--------------------------------------------------------------*  05510000
056500 Z999-DB2-ABEND.                                                  05520000
056600                                                                  05530000
056700     DISPLAY AA-ABEND-LIT.                                        05540000
056800     DISPLAY AA-MESSAGE-LINE-1.                                   05550000
056900     DISPLAY AA-MESSAGE-LINE-2.                                   05560000
057000     DISPLAY AA-DB2-ERROR-LIT.                                    05570000
057100     DISPLAY AA-PROGRAM-LIT.                                      05580000
057200     DISPLAY AA-PARAGRAPH-LIT.                                    05590000
057300     DISPLAY AA-DB2-OPERATION-LIT.                                05600000
057400     DISPLAY AA-DB2-TABLE-1.                                      05610000
057500     DISPLAY AA-DB2-TABLE-2.                                      05620000
057600     DISPLAY AA-DB2-TABLE-3.                                      05630000
057700     DISPLAY AA-DB2-TABLE-4.                                      05640000
057800     DISPLAY AA-DB2-TABLE-5.                                      05650000
057900     SET AC-DB2-ERROR TO TRUE.                                    05660000
058000                                                                  05670000
058100     COPY DPPD004.                                                05680000
058200     CALL 'ILBOABN0' USING ABEND-CODE.                            05690000
058300                                                                  05700000
