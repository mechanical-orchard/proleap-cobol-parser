000100 TITLE 'APPLY UNLOAD TRANSACTIONS TO IN-TRANSIT'.                 00010004
000200 IDENTIFICATION DIVISION.                                         00020004
000300 PROGRAM-ID.    SUKUT098.                                         00030004
000400 AUTHOR.        DENNIS STEFFEN.                                   00040004
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050004
000600 DATE-WRITTEN   JUNE, 2004.                                       00060004
000700 DATE-COMPILED.                                                   00070004
000800******************************************************************00080004
000900*  CHANGE LOG                                                     00090004
001000*  DATE       CHANGED BY    DESC                                  00100004
001100*  ---------- ------------- --------------------------------------00110004
001800*  09-22-2011 CHRISTINE TWIEHAUS                                  00180004
001900*                         WR38972 MLOF REVERSE OUT TRANSLATION    00190004
002000*                         OF EFC2                                 00200004
002100******************************************************************00210004
002200 ENVIRONMENT DIVISION.                                            00220004
002300 CONFIGURATION SECTION.                                           00230004
002400                                                                  00240004
002500 SOURCE-COMPUTER.        IBM-3090.                                00250004
002600 OBJECT-COMPUTER.        IBM-3090.                                00260004
002700                                                                  00270004
002800 INPUT-OUTPUT SECTION.                                            00280004
002900 FILE-CONTROL.                                                    00290004
003000                                                                  00300004
003100     SELECT TSUOBTS-UNLOAD-FILE                                   00310004
003200         ASSIGN TO INP01.                                         00320004
003300                                                                  00330004
003400     SELECT CARTON-DETAIL-FILE                                    00340004
003500         ASSIGN TO OUT01.                                         00350004
003600                                                                  00360004
003700******************************************************************00370004
003800 DATA DIVISION.                                                   00380004
003900 FILE SECTION.                                                    00390004
004000                                                                  00400004
004100 FD  TSUOBTS-UNLOAD-FILE                                          00410004
004200     RECORDING MODE IS F                                          00420004
004300     LABEL RECORDS ARE STANDARD                                   00430004
004400     BLOCK CONTAINS 0 RECORDS.                                    00440004
004500                                                                  00450004
004600 01  TSUOBTS-UNLOAD-RECORD   PIC  X(13).                          00460004
004700*                                                                 00470004
004800 FD  CARTON-DETAIL-FILE                                           00480004
004900     RECORDING MODE IS F                                          00490004
005000     LABEL RECORDS ARE STANDARD                                   00500004
005100     BLOCK CONTAINS 0 RECORDS.                                    00510004
005200                                                                  00520004
005300 01  CARTON-DETAIL-RECORD   PIC  X(100).                          00530004
005400*                                                                 00540004
005500 WORKING-STORAGE SECTION.                                         00550004
005600                                                                  00560004
005700*  INPUT FILE LAYOUT                                              00570004
005800     COPY SURD012.                                                00580004
005900*                                                                 00590004
006000*  CARTON OUTPUT FILE LAYOUT                                      00600004
006100     COPY PCRD010.                                                00610004
006200*                                                                 00620004
006300     COPY DPWS004.                                                00630004
006400*                                                                 00640004
006500     EXEC SQL                                                     00650004
006600          INCLUDE TSUOBTR                                         00660004
006700     END-EXEC.                                                    00670004
006800                                                                  00680004
006900     EXEC SQL                                                     00690004
007000          INCLUDE TSUOBTS                                         00700004
007100     END-EXEC.                                                    00710004
007200                                                                  00720004
007300     EXEC SQL                                                     00730004
007400          INCLUDE SQLCA                                           00740004
007500     END-EXEC.                                                    00750004
007600* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 00760004
007700*    IN-TRANSIT DETAILS - PCT_TRN_CLSN_DTL                        00770004
007800* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 00780004
007900     EXEC SQL                                                     00790004
008000          INCLUDE PCT00015                                        00800004
008100     END-EXEC.                                                    00810004
008200                                                                  00820004
008300 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00830004
008400                                                   COMP SYNC.     00840004
008500                                                                  00850004
008600 01  PS-PROGRAM-SWITCHES.                                         00860004
008700     05  PS-END-OF-FILE-SW            PIC  X(01) VALUE 'N'.       00870004
008800         88  PS-END-FILE-YES                     VALUE 'Y'.       00880004
008900         88  PS-END-FILE-NO                      VALUE 'N'.       00890004
009000     05  PS-END-OF-CSR-SW             PIC  X(01) VALUE 'N'.       00900004
009100         88  PS-END-CSR-YES                      VALUE 'Y'.       00910004
009200         88  PS-END-CSR-NO                       VALUE 'N'.       00920004
009300                                                                  00930004
009400 01  PC-PROGRAM-CONSTANTS.                                        00940004
009500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08) VALUE 'SUKUT098'. 00950004
009600                                                                  00960004
009700 01  PV-PROGRAM-VARIABLES.                                        00970004
009800                                                                  00980004
009900     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00990004
010000     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01000004
010100     05  PV-READ-COUNTER             PIC  S9(9) COMP.             01010004
010200     05  PV-NOT-SHIPPED-COUNTER      PIC  S9(9) COMP.             01020004
010300     05  PV-WRITE-COUNTER            PIC  S9(9) COMP.             01030004
010400     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01040004
010500     05  PV-DISPLAY-TRIP             PIC Z(9)9.                   01050004
010600     05  PV-TRIP-ID                  PIC  S9(9) COMP.             01060004
010700     05  PV-OTBND-STAT-TMST          PIC   X(26).                 01070004
010800     05  PV-TIME                     PIC X(08) VALUE SPACES.      01080004
010900                                                                  01090004
011000     EXEC SQL                                                     01100004
011100         DECLARE SHIPPED-CSR CURSOR FOR                           01110004
011200         SELECT  INTR_UPC_ID                                      01120004
011300             ,   LOC_NBR                                          01130004
011400             ,   TRN_CLSN_CDE                                     01140004
011500             ,   TRN_CLSN_PRCG_QTY                                01150004
011600             ,   TRN_CLSN_BAL_QTY                                 01160004
011700             ,   PO_NBR                                           01170004
011800             ,   RCVR_SEQ_NBR                                     01180004
011900          FROM  PCT_TRN_CLSN_DTL                                  01190004
012000         WHERE  OTBND_TRIP_ID       =  :PCT00015-OTBND-TRIP-ID    01200004
012100             AND TRN_CLSN_CDE = 'IT'                              01210004
012200             AND TRN_TYP_CDE  = 'SH'                              01220004
012300          ORDER BY                                                01230004
012400             INTR_UPC_ID                                          01240004
012500         ,   LOC_NBR                                              01250004
012600         ,   TRN_CLSN_CDE                                         01260004
012700                                                                  01270004
012800     END-EXEC.                                                    01280004
012900/                                                                 01290004
013000 PROCEDURE DIVISION.                                              01300004
013100 0000-PROGRAM-MAINLINE.                                           01310004
013200                                                                  01320004
013300     PERFORM 1000-INITIALIZE.                                     01330004
013400                                                                  01340004
013500     PERFORM 2000-PROCESS-TSUOBTS-FILE                            01350004
013600         UNTIL PS-END-FILE-YES                                    01360004
013700                                                                  01370004
013800     PERFORM 9000-EOJ-ROUTINE.                                    01380004
013900                                                                  01390004
014000     GOBACK.                                                      01400004
014100                                                                  01410004
014200 1000-INITIALIZE.                                                 01420004
014300                                                                  01430004
014400     OPEN INPUT  TSUOBTS-UNLOAD-FILE.                             01440004
014500     OPEN OUTPUT CARTON-DETAIL-FILE                               01450004
014600                                                                  01460004
014700     DISPLAY '* * * * * * * * * * * '.                            01470004
014800     DISPLAY 'CURRENT PROGRAM ' PC-CURRENT-PROGRAM-NAME.          01480004
014900                                                                  01490004
015000     PERFORM 8000-READ-FILE.                                      01500004
015100                                                                  01510004
015200 2000-PROCESS-TSUOBTS-FILE.                                       01520004
015300                                                                  01530004
015400     INITIALIZE PC010-PCT-INTRANSIT-REC                           01540004
015500     MOVE SU012-TRIP-ID           TO  PCT00015-OTBND-TRIP-ID      01550004
015600     PERFORM 7000-OPEN-TRIP-CSR                                   01560004
015700                                                                  01570004
015800     PERFORM 7010-FETCH-TRIP-CSR                                  01580004
015900     IF PS-END-CSR-YES                                            01590004
016000         DISPLAY ' TRIP NOT FOUND TO UNLOAD ' SU012-TRIP-ID       01600004
016100         ADD 1                        TO PV-NOT-SHIPPED-COUNTER   01610004
016200     END-IF.                                                      01620004
016300                                                                  01630004
016400     PERFORM 3000-CREATE-UNLOADS                                  01640004
016500             UNTIL PS-END-CSR-YES                                 01650004
016600                                                                  01660004
016700     PERFORM 7030-CLOSE-TRIP-CSR                                  01670004
016800                                                                  01680004
016900     PERFORM 8000-READ-FILE.                                      01690004
017000/                                                                 01700004
017100 3000-CREATE-UNLOADS.                                             01710004
017200                                                                  01720004
017300     MOVE PCT00015-INTR-UPC-ID        TO PC010-INTR-UPC-ID.       01730004
017400     MOVE PCT00015-LOC-NBR            TO PC010-STR-NBR.           01740004
017500     MOVE 'UN'                        TO PC010-TRN-TYP-CDE.       01750004
017600     MOVE PCT00015-TRN-CLSN-PRCG-QTY  TO PC010-IN-TRNST-QTY.      01760004
017700                                                                  01770004
017800*** DMH - 08-27-2004 - BEGIN                                      01780004
017900     MULTIPLY  PC010-IN-TRNST-QTY   BY -1                         01790004
018000       GIVING  PC010-IN-TRNST-QTY.                                01800004
018100*** DMH - 08-27-2004 - END                                        01810004
018200                                                                  01820004
018300     PERFORM 3020-RETREIVE-TRIP-INFO.                             01830004
018400                                                                  01840004
018500     MOVE 'SUKUT098'                  TO PC010-UPD-USR-ID.        01850004
018600     MOVE PCT00015-PO-NBR             TO PC010-PO-NBR.            01860004
018700     MOVE PCT00015-RCVR-SEQ-NBR       TO PC010-RCVR-SEQ-NBR.      01870004
018800     MOVE PCT00015-OTBND-TRIP-ID      TO PC010-TRIP-ID.           01880004
018900     MOVE ZERO                        TO PC010-STAT-CDE-DS.       01890004
019000     MOVE 1                           TO PC010-STAT-CDE-SU.       01900004
019100     MOVE 'IT'                        TO PC010-TRN-CLSN-CDE.      01910004
019200     MOVE PV-OTBND-STAT-TMST          TO PC010-EVENT-TMST.        01920004
019300                                                                  01930004
019400     PERFORM 8100-WRITE-OUTPUT.                                   01940004
019500                                                                  01950004
019600     PERFORM 7010-FETCH-TRIP-CSR.                                 01960004
019700                                                                  01970004
019800                                                                  01980004
019900******************************************************************01990004
020000*  GET UNLOADED TIMESTAMP WHEN TRIP IS SHIPPED AND UNLOADED ON    02000004
020100*  THE SAME DAY                                                   02010004
020200******************************************************************02020004
020300 3020-RETREIVE-TRIP-INFO.                                         02030004
020400                                                                  02040004
020500     MOVE PCT00015-OTBND-TRIP-ID TO PV-TRIP-ID                    02050004
020600                                                                  02060004
020700     EXEC SQL                                                     02070004
020800         SELECT  B.OTBND_STAT_TMST                                02080004
020900          INTO  :PV-OTBND-STAT-TMST                               02090004
021000          FROM  TSUOBTR A                                         02100004
021100               ,TSUOBTS B                                         02110004
021200         WHERE  A.OTBND_TRIP_ID     = :PV-TRIP-ID                 02120004
021300           AND  A.OTBND_TRIP_ID     = B.OTBND_TRIP_ID             02130004
021400           AND  B.TRIP_STAT_CDE     = 'SU'                        02140004
021500              AND B.OTBND_STAT_TMST IN                            02150004
021600                  (SELECT MAX(C.OTBND_STAT_TMST)                  02160004
021700                    FROM TSUOBTS C                                02170004
021800               WHERE B.OTBND_TRIP_ID  =  C.OTBND_TRIP_ID          02180004
021900                  AND  C.TRIP_STAT_CDE = 'SU')                    02190004
022000           WITH UR                                                02200004
022100     END-EXEC.                                                    02210004
022200                                                                  02220004
022300     EVALUATE TRUE                                                02230004
022400         WHEN SQLCODE = ZERO                                      02240004
022500             CONTINUE                                             02250004
022600         WHEN SQLWARN0 NOT = SPACES                               02260004
022700         WHEN SQLCODE < ZERO                                      02270004
022800         WHEN SQLCODE > ZERO                                      02280004
022900             MOVE '3020-RETRIEVE-TRIP-INFO '                      02290004
023000                                        TO PV-PARAGRAPH-NAME      02300004
023100             MOVE 'SELECT TSUOBTS ' TO PV-DB2-OPERATION-ATTEMPTED 02310004
023200             DISPLAY 'TRIP ID BEING PROCESSED IS ' SU012-TRIP-ID  02320004
023300             PERFORM 9100-SQL-ABEND                               02330004
023400     END-EVALUATE.                                                02340004
023500                                                                  02350004
023600 7000-OPEN-TRIP-CSR.                                              02360004
023700                                                                  02370004
023800     EXEC SQL                                                     02380004
023900         OPEN SHIPPED-CSR                                         02390004
024000     END-EXEC.                                                    02400004
024100                                                                  02410004
024200     EVALUATE TRUE                                                02420004
024300         WHEN SQLCODE = ZERO                                      02430004
024400             SET PS-END-CSR-NO        TO TRUE                     02440004
024500         WHEN SQLWARN0 NOT = SPACES                               02450004
024600         WHEN SQLCODE < ZERO                                      02460004
024700         WHEN SQLCODE > ZERO                                      02470004
024800             MOVE '7000-OPEN-TRIP-CSR' TO PV-PARAGRAPH-NAME       02480004
024900             MOVE 'OPEN CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED    02490004
025000             PERFORM 9100-SQL-ABEND                               02500004
025100     END-EVALUATE.                                                02510004
025200                                                                  02520004
025300 7010-FETCH-TRIP-CSR.                                             02530004
025400     EXEC SQL                                                     02540004
025500         FETCH SHIPPED-CSR                                        02550004
025600         INTO                                                     02560004
025700             :PCT00015-INTR-UPC-ID                                02570004
025800         ,   :PCT00015-LOC-NBR                                    02580004
025900         ,   :PCT00015-TRN-CLSN-CDE                               02590004
026000         ,   :PCT00015-TRN-CLSN-PRCG-QTY                          02600004
026100         ,   :PCT00015-TRN-CLSN-BAL-QTY                           02610004
026200         ,   :PCT00015-PO-NBR                                     02620004
026300         ,   :PCT00015-RCVR-SEQ-NBR                               02630004
026400     END-EXEC.                                                    02640004
026500                                                                  02650004
026600     EVALUATE TRUE                                                02660004
026700         WHEN SQLCODE = ZERO                                      02670004
026800             CONTINUE                                             02680004
026900         WHEN SQLCODE = +100                                      02690004
027000             SET PS-END-CSR-YES       TO TRUE                     02700004
027100         WHEN SQLWARN0 NOT = SPACES                               02710004
027200         WHEN SQLCODE < ZERO                                      02720004
027300         WHEN SQLCODE > ZERO                                      02730004
027400             MOVE '7010-FETCH-TRIP-CSR' TO PV-PARAGRAPH-NAME      02740004
027500             MOVE 'FETCH CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED   02750004
027600             PERFORM 9100-SQL-ABEND                               02760004
027700     END-EVALUATE.                                                02770004
027800                                                                  02780004
027900                                                                  02790004
028000 7030-CLOSE-TRIP-CSR.                                             02800004
028100     EXEC SQL                                                     02810004
028200         CLOSE SHIPPED-CSR                                        02820004
028300     END-EXEC                                                     02830004
028400                                                                  02840004
028500     EVALUATE TRUE                                                02850004
028600         WHEN SQLCODE = ZERO                                      02860004
028700             CONTINUE                                             02870004
028800         WHEN SQLWARN0 NOT = SPACES                               02880004
028900         WHEN SQLCODE < ZERO                                      02890004
029000         WHEN SQLCODE > ZERO                                      02900004
029100             MOVE '7030-CLOSE-TRIP-CSR' TO PV-PARAGRAPH-NAME      02910004
029200             MOVE 'CLOSE CURRSOR ' TO PV-DB2-OPERATION-ATTEMPTED  02920004
029300             PERFORM 9100-SQL-ABEND                               02930004
029400     END-EVALUATE.                                                02940004
029500                                                                  02950004
029600 8000-READ-FILE.                                                  02960004
029700      INITIALIZE SU012-EXTRACT-RECORD.                            02970004
029800                                                                  02980004
029900     READ TSUOBTS-UNLOAD-FILE INTO                                02990004
030000          SU012-EXTRACT-RECORD                                    03000004
030100             AT END                                               03010004
030200                 SET PS-END-FILE-YES  TO TRUE                     03020004
030300             NOT AT END                                           03030004
030400                 ADD +1 TO PV-READ-COUNTER                        03040004
030500                 EXEC SQL                                         03050004
030600                     SELECT CURRENT TIME                          03060004
030700                     INTO :PV-TIME                                03070004
030800                     FROM SYSIBM.SYSDUMMY1                        03080004
030900                 END-EXEC                                         03090004
031000                 MOVE SU012-TRIP-ID   TO PV-DISPLAY-TRIP          03100004
031100                 MOVE PV-READ-COUNTER TO PV-DISPLAY-COUNT         03110004
031200                 DISPLAY PV-TIME                                  03120004
031300                 '  PROCESSING TRIP = ' PV-DISPLAY-TRIP           03130004
031400                      ' / RECORD NBR: ' PV-DISPLAY-COUNT          03140004
031500     END-READ.                                                    03150004
031600                                                                  03160004
031700 8100-WRITE-OUTPUT.                                               03170004
031800                                                                  03180004
031900     WRITE CARTON-DETAIL-RECORD FROM                              03190004
032000                PC010-PCT-INTRANSIT-REC.                          03200004
032100                                                                  03210004
032200     ADD +1 TO PV-WRITE-COUNTER.                                  03220004
032300/                                                                 03230004
032400 9000-EOJ-ROUTINE.                                                03240004
032500     CLOSE TSUOBTS-UNLOAD-FILE                                    03250004
032600           CARTON-DETAIL-FILE                                     03260004
032700                                                                  03270004
032800     MOVE PV-READ-COUNTER                TO PV-DISPLAY-COUNT.     03280004
032900     DISPLAY 'TOTAL RECORDS READ        = ' PV-DISPLAY-COUNT.     03290004
033000                                                                  03300004
033100     MOVE PV-NOT-SHIPPED-COUNTER         TO PV-DISPLAY-COUNT.     03310004
033200     DISPLAY 'TOTAL NOT FOUND TO UNLOAD = ' PV-DISPLAY-COUNT.     03320004
033300                                                                  03330004
033400     MOVE PV-WRITE-COUNTER               TO PV-DISPLAY-COUNT.     03340004
033500     DISPLAY 'TOTAL RECORDS WRITTEN     = ' PV-DISPLAY-COUNT.     03350004
033600     DISPLAY '* * * * * * * * * * * '.                            03360004
033700                                                                  03370004
033800 9100-SQL-ABEND.                                                  03380004
033900     DISPLAY '9100-SQL-ABEND'.                                    03390004
034000     DISPLAY '** ABEND     **'.                                   03400004
034100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03410004
034200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03420004
034300     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03430004
034400     DISPLAY '** TRIP ID   ** = ' SU012-TRIP-ID.                  03440004
034500                                                                  03450004
034600     COPY DPPD004.                                                03460004
034700                                                                  03470004
034800     MOVE +4013                  TO ABEND-CODE.                   03480004
034900     CALL 'ILBOABN0' USING ABEND-CODE.                            03490004
035000                                                                  03500004
