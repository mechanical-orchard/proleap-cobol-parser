000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    XLKUP095.                                         00040015
000500 AUTHOR.        SIVARAMAKRISHNAN.                                 00050016
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   OCTOBER 2017.                                     00070016
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*  THIS BATCH DB2 PROGRAM PERFORMS INSERT/UPDATE/DELETE ON PACK   00100016
001100*  COMPONENT SKU TABLE (XLT_PK_CPT_SKU) BASED ON ERROR MESSAGE    00110016
001200*  IN INPUT FILE                                                  00120016
001300***************************************************************** 00122000
001400 ENVIRONMENT DIVISION.                                            00123000
001500 INPUT-OUTPUT SECTION.                                            00124000
001600                                                                  00125000
001700 FILE-CONTROL.                                                    00126000
001800                                                                  00127000
001900     SELECT PACKSKU-IN                                            00128000
002000         ASSIGN TO INP01.                                         00129000
002100                                                                  00129109
002200     SELECT SUMMARY-FILE                                          00129209
002300         ASSIGN TO OUT01.                                         00129309
002400                                                                  00130000
002500***************************************************************** 00140000
002600 DATA DIVISION.                                                   00150000
002700***************************************************************** 00160000
002800 FILE SECTION.                                                    00170000
002900                                                                  00180000
003000 FD  PACKSKU-IN                                                   00190000
003100     RECORDING MODE IS F                                          00200000
003200     BLOCK CONTAINS 0 RECORDS                                     00210000
003300     LABEL RECORDS ARE STANDARD.                                  00220000
003400                                                                  00230000
003500 01  PACKSKU-IN-RECORD           PIC X(144).                      00240000
003600                                                                  00250000
003700 FD  SUMMARY-FILE                                                 00251009
003800     RECORDING MODE IS F                                          00252009
003900     BLOCK CONTAINS 0 RECORDS                                     00253009
004000     LABEL RECORDS ARE STANDARD.                                  00254009
004100                                                                  00255009
004200 01  SUMMARY-FILE-RECORD              PIC X(24).                  00256013
004300                                                                  00260000
004400***************************************************************** 00270000
004500 WORKING-STORAGE SECTION.                                         00280000
004600                                                                  00281000
004700 01  PA-DB2-COMMIT-COUNT              PIC S9(09) VALUE +0         00282000
004800                                                    COMP-3.       00283000
004900 01  PS-PROGRAM-SWITCHES.                                         00284000
005000     05  PS-EOF-INPUT-SW              PIC X(01)  VALUE 'N'.       00285000
005100         88  PS-EOF-INPUT-YES                    VALUE 'Y'.       00286000
005200         88  PS-EOF-INPUT-NO                     VALUE 'N'.       00287000
005300                                                                  00288000
005400 01  PC-PROGRAM-CONSTANTS.                                        00289000
005500     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'XLKUP095'.00290015
005600                                                                  00300000
005700 01  PV-PROGRAM-VARIABLES.                                        00310000
005800     05  PV-RECORDS-READ              PIC  9(09) VALUE  0.        00320000
005900     05  PV-RECORDS-INSERTED          PIC  9(09) VALUE  0.        00330000
006000     05  PV-RECORDS-SKIP              PIC  9(09) VALUE  0.        00340000
006100     05  PV-RECORDS-UPDATED           PIC  9(09) VALUE  0.        00341002
006200     05  PV-RECORDS-DELETED           PIC  9(09) VALUE  0.        00342006
006300     05  PV-DISP-PK-SKU               PIC  9(08) VALUE  0.        00350000
006400     05  PV-DISP-CPT-SKU              PIC  9(08) VALUE  0.        00360000
006500     05  PV-SQLCODE                   PIC  S9(9) VALUE +0.        00370000
006600     05  PV-DISP-SQLCODE              PIC ZZZZZZ9-.               00380000
006700     05  PV-ZERO-LINE                 PIC X(24)                   00380213
006800                                           VALUE 'XLT_PK_CPT_SKU'.00380311
006900     05  PV-FIRST-LINE                PIC X(24)  VALUE SPACES.    00381013
007000     05  PV-SECOND-LINE               PIC X(24)  VALUE SPACES.    00382013
007100     05  PV-THIRD-LINE                PIC X(24)  VALUE SPACES.    00383013
007200                                                                  00390000
007300                                                                  00400000
007400 01  PV-ABEND-FIELDS.                                             00410000
007500     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         00420000
007600                                                 COMP SYNC.       00430000
007700     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'XLKUP095'.00440015
007800     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00450000
007900     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    00460000
008000     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00470000
008100     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00480000
008200     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00490000
008300     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00500000
008400                                                                  00510000
008500                                                                  00520000
008600***********************************************************       00530000
008700*  COPYBOOK USED FOR PACK DATA INPUT FILE                 *       00540002
008800***********************************************************       00550000
008900     COPY XLRD030.                                                00560000
009000                                                                  00570000
009100***********************************************************       00580000
009200*  USED FOR DB2 ERROR MESSAGE BUILDING                    *       00590000
009300***********************************************************       00600000
009400     COPY DPWS004.                                                00610000
009500                                                                  00620000
009600***********************************************************       00630000
009700*  DB2 SQL COMMUNICATION AREA                             *       00640000
009800***********************************************************       00650000
009900     EXEC SQL                                                     00660000
010000          INCLUDE SQLCA                                           00670000
010100     END-EXEC.                                                    00680000
010200                                                                  00690000
010300***********************************************************       00700000
010400*  XLT_PK_CPT_SKU                                         *       00710000
010500***********************************************************       00720000
010600     EXEC SQL                                                     00730000
010700          INCLUDE XLT00008                                        00740000
010800     END-EXEC.                                                    00750000
010900                                                                  00760000
011000***************************************************************** 00770000
011100 PROCEDURE DIVISION.                                              00780000
011200***************************************************************** 00790000
011300     DISPLAY '**** BEGINNING XLKUP095 ****'.                      00800015
011400     DISPLAY ' '.                                                 00810000
011500                                                                  00820000
011600     OPEN INPUT  PACKSKU-IN.                                      00830000
011700     OPEN OUTPUT SUMMARY-FILE.                                    00831009
011800                                                                  00840000
011900     PERFORM 1000-READ-INPUT-FILE.                                00850000
012000                                                                  00860000
012100     PERFORM 2000-PROCESS-INPUT-FILE                              00870000
012200       UNTIL PS-EOF-INPUT-YES.                                    00880000
012300                                                                  00890000
012400     CLOSE PACKSKU-IN.                                            00900000
012500                                                                  00910000
012600     PERFORM 3000-TABLE-COMMIT.                                   00920000
012700                                                                  00930000
012800     PERFORM 4000-WRITE-SUMMARY.                                  00931009
012900     DISPLAY 'INPUT PACKSKU RECS READ     = ' PV-RECORDS-READ.    00940000
013000     DISPLAY 'XKT_PK_CPT_SKU ROWS INSERT  = ' PV-RECORDS-INSERTED.00950000
013100     DISPLAY 'XLT_PK_CPT_SKU ROWS UPDATED = ' PV-RECORDS-UPDATED. 00961002
013200     DISPLAY 'XLT_PK_CPT_SKU ROWS DELETED = ' PV-RECORDS-DELETED. 00962005
013300     DISPLAY 'XLT_PK_CPT_SKU ROWS SKIPPED = ' PV-RECORDS-SKIP.    00964014
013400     DISPLAY ' '.                                                 00970000
013500     DISPLAY '****  END OF  XLKUP095  ****'.                      00980015
013600                                                                  00990000
013700     CLOSE SUMMARY-FILE.                                          00991009
013800     GOBACK.                                                      01000000
013900                                                                  01010000
014000                                                                  01020000
014100***************************************************************** 01030000
014200*  READ A PACKSKU EXTRACT RECORD THAT WILL BE USED TO INSERT    * 01040000
014300*  A ROW OF DATA INTO THE XLT_PK_CPT_SKU TABLE.                 * 01050000
014400***************************************************************** 01060000
014500 1000-READ-INPUT-FILE.                                            01070000
014600                                                                  01080000
014700     MOVE '1000-READ-INPUT-FILE    ' TO PV-ABEND-PARAGRAPH.       01090000
014800                                                                  01100000
014900     INITIALIZE XL030-PACKSKU-PK-CPT-SKU                          01110000
015000                PA-DB2-COMMIT-COUNT.                              01120000
015100                                                                  01130000
015200     READ PACKSKU-IN                                              01140000
015300          INTO XL030-PACKSKU-PK-CPT-SKU                           01150000
015400            AT END                                                01160000
015500               SET PS-EOF-INPUT-YES TO TRUE                       01170000
015600                                                                  01180000
015700            NOT AT END                                            01190000
015800               SET PS-EOF-INPUT-NO  TO TRUE                       01200000
015900               ADD +1 TO PV-RECORDS-READ                          01210000
016000     END-READ.                                                    01220000
016100                                                                  01230000
016200                                                                  01240000
016300***************************************************************** 01250000
016400*  LOAD THE INFORMATION FROM THE PACKSKU EXTRACT FILE INTO THE  * 01260000
016500*  HOST VARIABLES AND PERFORM A PARAGRAPH TO INSERT THE NEW ROW * 01270000
016600*  INTO THE XLT_PK_CPT_SKU TABLE FOR 'NOT ON DOMAIN PACK SKU'   * 01280002
016700*  MESSAGE.  WE WILL UPDATE THE XLT_PK_CPT_SKU WITH THE CORRECT * 01281002
016800*  RMS DATA FOR THE 'DATA MISMATCH - RMS' MESSAGE.              * 01282002
016900***************************************************************** 01290000
017000 2000-PROCESS-INPUT-FILE.                                         01300000
017100                                                                  01310000
017200     MOVE '2000-PROCESS-INPUT-FILE '   TO PV-ABEND-PARAGRAPH.     01320000
017300                                                                  01330000
017400     MOVE XL030-PKSKU-PK-SKU-NBR       TO XLT00008-PK-SKU-NBR.    01340000
017500     MOVE XL030-PKSKU-CPT-SKU-NBR      TO XLT00008-CPT-SKU-NBR.   01350000
017600     MOVE XL030-PKSKU-PK-RATO-UNT-QTY                             01360000
017700                         TO XLT00008-PK-RATIO-UNT-QTY             01370000
017800                                                                  01380000
017900     IF  XL030-PKSKU-ERROR-MESSAGE = 'NOT ON DOMAIN PACK SKU'     01390000
018000         PERFORM 2100-INSERT-XLT-PK-CPT-SKU                       01400000
018100     ELSE                                                         01401002
018200         IF  XL030-PKSKU-ERROR-MESSAGE = 'DATA MISMATCH - RMS'    01402002
018300             PERFORM 2200-UPDATE-XLT-PK-CPT-SKU                   01403002
018400         END-IF                                                   01410003
018500     END-IF.                                                      01411002
018600                                                                  01420000
018700     IF  XL030-PKSKU-ERROR-MESSAGE = 'NOT ON RMS PACK SKU'        01421005
018800         PERFORM 2300-DELETE-XLT-PK-CPT-SKU                       01422005
018900     END-IF.                                                      01422105
019000                                                                  01423005
019100     PERFORM 1000-READ-INPUT-FILE.                                01430000
019200                                                                  01440000
019300                                                                  01450000
019400***************************************************************** 01460000
019500*  INSERT A ROW TO THE XLT_PK_CPT_SKU TABLE                     * 01470000
019600***************************************************************** 01480000
019700 2100-INSERT-XLT-PK-CPT-SKU.                                      01490000
019800                                                                  01500000
019900     EXEC SQL                                                     01510000
020000          INSERT                                                  01520000
020100          INTO  XLT_PK_CPT_SKU                                    01530000
020200              ( PK_SKU_NBR                                        01540000
020300               ,CPT_SKU_NBR                                       01550000
020400               ,PK_RATIO_UNT_QTY                                  01560001
020500               ,LAST_UPD_TMST)                                    01561001
020600          VALUES                                                  01570000
020700             (  :XLT00008-PK-SKU-NBR                              01580000
020800               ,:XLT00008-CPT-SKU-NBR                             01590000
020900               ,:XLT00008-PK-RATIO-UNT-QTY                        01600001
021000               ,CURRENT TIMESTAMP)                                01601001
021100     END-EXEC.                                                    01610000
021200                                                                  01620000
021300     EVALUATE TRUE                                                01630000
021400         WHEN SQLCODE = ZERO                                      01640000
021500              ADD +1                 TO PV-RECORDS-INSERTED       01650000
021600              ADD +1                 TO PA-DB2-COMMIT-COUNT       01660000
021700              IF PA-DB2-COMMIT-COUNT > 4500                       01670000
021800                  PERFORM 3000-TABLE-COMMIT                       01680000
021900                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01690000
022000              END-IF                                              01700000
022100         WHEN SQLCODE = -803                                      01710000
022200              ADD +1 TO PV-RECORDS-SKIP                           01720000
022300         WHEN SQLCODE NOT = +0                                    01730000
022400              MOVE '2100-INSERT-XLT-PK-CPT-SKU'                   01740000
022500                                     TO PV-ABEND-PARAGRAPH        01750000
022600              MOVE 'INSERT XLT_PK_CPT_SKU'                        01760000
022700                                     TO PV-ABEND-OPERATION        01770000
022800              MOVE XL030-PKSKU-PK-SKU-NBR                         01780000
022900                                     TO PV-DISP-PK-SKU            01790000
023000              MOVE XL030-PKSKU-CPT-SKU-NBR                        01800000
023100                                     TO PV-DISP-CPT-SKU           01810000
023200              STRING 'PK SKU NBR: '           DELIMITED BY SIZE   01820000
023300                     PV-DISP-PK-SKU           DELIMITED BY SIZE   01830000
023400                     '  CPT SKU: '            DELIMITED BY SIZE   01840000
023500                     PV-DISP-CPT-SKU          DELIMITED BY SIZE   01850000
023600                                   INTO PV-DB2-OPERATION-MESSAGE-101860000
023700                                                                  01870000
023800              MOVE 'XLT_PK_CPT_SKU'  TO PV-ABEND-TABLE            01880000
023900              PERFORM Z999-SQL-ABEND                              01890000
024000     END-EVALUATE.                                                01900000
024100                                                                  01910000
024200                                                                  01920000
024300***************************************************************** 01921002
024400*  UPDATE A ROW ON THE XLT_PK_CPT_SKU TABLE                     * 01922002
024500***************************************************************** 01923002
024600 2200-UPDATE-XLT-PK-CPT-SKU.                                      01924002
024700                                                                  01925002
024800     EXEC SQL                                                     01926002
024900          UPDATE XLT_PK_CPT_SKU                                   01928002
025000             SET PK_RATIO_UNT_QTY = :XLT00008-PK-RATIO-UNT-QTY    01929202
025100                ,LAST_UPD_TMST    = CURRENT TIMESTAMP             01929302
025200           WHERE PK_SKU_NBR       = :XLT00008-PK-SKU-NBR          01929402
025300             AND CPT_SKU_NBR      = :XLT00008-CPT-SKU-NBR         01929502
025400     END-EXEC.                                                    01929902
025500                                                                  01930002
025600     EVALUATE TRUE                                                01930102
025700         WHEN SQLCODE = ZERO                                      01930202
025800              ADD +1                 TO PV-RECORDS-UPDATED        01930302
025900              ADD +1                 TO PA-DB2-COMMIT-COUNT       01930402
026000              IF PA-DB2-COMMIT-COUNT > 4500                       01930502
026100                  PERFORM 3000-TABLE-COMMIT                       01930602
026200                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01930702
026300              END-IF                                              01930802
026400         WHEN SQLCODE = +100                                      01930902
026500              ADD +1 TO PV-RECORDS-SKIP                           01931002
026600         WHEN SQLCODE NOT = +0                                    01931102
026700              MOVE '2200-UPDATE-XLT-PK-CPT-SKU'                   01931202
026800                                     TO PV-ABEND-PARAGRAPH        01931302
026900              MOVE 'UPDATE XLT_PK_CPT_SKU'                        01931402
027000                                     TO PV-ABEND-OPERATION        01931502
027100              MOVE XL030-PKSKU-PK-SKU-NBR                         01931602
027200                                     TO PV-DISP-PK-SKU            01931702
027300              MOVE XL030-PKSKU-CPT-SKU-NBR                        01931802
027400                                     TO PV-DISP-CPT-SKU           01931902
027500              STRING 'PK SKU NBR: '           DELIMITED BY SIZE   01932002
027600                     PV-DISP-PK-SKU           DELIMITED BY SIZE   01932102
027700                     '  CPT SKU: '            DELIMITED BY SIZE   01932202
027800                     PV-DISP-CPT-SKU          DELIMITED BY SIZE   01932302
027900                                   INTO PV-DB2-OPERATION-MESSAGE-101932402
028000                                                                  01932502
028100              MOVE 'XLT_PK_CPT_SKU'  TO PV-ABEND-TABLE            01932602
028200              PERFORM Z999-SQL-ABEND                              01932702
028300     END-EVALUATE.                                                01932802
028400                                                                  01932902
028500                                                                  01933002
028600***************************************************************** 01933205
028700*  DELETE A ROW ON THE XLT_PK_CPT_SKU TABLE                     * 01933305
028800***************************************************************** 01933405
028900 2300-DELETE-XLT-PK-CPT-SKU.                                      01933505
029000                                                                  01933605
029100     EXEC SQL                                                     01933705
029200          DELETE                                                  01933805
029300             FROM XLT_PK_CPT_SKU                                  01933905
029400           WHERE PK_SKU_NBR       = :XLT00008-PK-SKU-NBR          01934105
029500             AND CPT_SKU_NBR      = :XLT00008-CPT-SKU-NBR         01934205
029600     END-EXEC.                                                    01934305
029700                                                                  01934405
029800     EVALUATE TRUE                                                01934505
029900         WHEN SQLCODE = ZERO                                      01934605
030000              ADD +1                 TO PV-RECORDS-DELETED        01934708
030100              ADD +1                 TO PA-DB2-COMMIT-COUNT       01934805
030200              IF PA-DB2-COMMIT-COUNT > 4500                       01934905
030300                  PERFORM 3000-TABLE-COMMIT                       01935005
030400                  MOVE 0 TO PA-DB2-COMMIT-COUNT                   01935105
030500              END-IF                                              01935205
030600         WHEN SQLCODE = +100                                      01935305
030700              ADD +1 TO PV-RECORDS-SKIP                           01935405
030800         WHEN SQLCODE NOT = +0                                    01935505
030900              MOVE '2300-DELETE-XLT-PK-CPT-SKU'                   01935605
031000                                     TO PV-ABEND-PARAGRAPH        01935705
031100              MOVE 'DELETE XLT_PK_CPT_SKU'                        01935805
031200                                     TO PV-ABEND-OPERATION        01935905
031300              MOVE XL030-PKSKU-PK-SKU-NBR                         01936005
031400                                     TO PV-DISP-PK-SKU            01936105
031500              MOVE XL030-PKSKU-CPT-SKU-NBR                        01936205
031600                                     TO PV-DISP-CPT-SKU           01936305
031700              STRING 'PK SKU NBR: '           DELIMITED BY SIZE   01936405
031800                     PV-DISP-PK-SKU           DELIMITED BY SIZE   01936505
031900                     '  CPT SKU: '            DELIMITED BY SIZE   01936605
032000                     PV-DISP-CPT-SKU          DELIMITED BY SIZE   01936705
032100                                   INTO PV-DB2-OPERATION-MESSAGE-101936805
032200                                                                  01936905
032300              MOVE 'XLT_PK_CPT_SKU'  TO PV-ABEND-TABLE            01937005
032400              PERFORM Z999-SQL-ABEND                              01937105
032500     END-EVALUATE.                                                01937205
032600                                                                  01937305
032700                                                                  01937405
032800***************************************************************** 01938005
032900* COMMIT THE PENDING TABLE CHANGES.                             * 01940000
033000***************************************************************** 01950000
033100 3000-TABLE-COMMIT.                                               01960000
033200                                                                  01970000
033300     EXEC SQL                                                     01980000
033400          COMMIT                                                  01990000
033500     END-EXEC.                                                    02000000
033600                                                                  02010000
033700                                                                  02020000
033800***************************************************************** 02020209
033900* WRITE RECORDS PROCESSED COUNT TO COUNT FILE                 *   02020309
034000***************************************************************** 02020409
034100 4000-WRITE-SUMMARY.                                              02021009
034200                                                                  02022009
034300     STRING "NO. OF INSERTS:"     DELIMITED BY SIZE               02023009
034400             PV-RECORDS-INSERTED  DELIMITED BY SPACE              02024009
034500      INTO PV-FIRST-LINE                                          02025009
034600                                                                  02026009
034700     STRING "NO. OF UPDATES:"     DELIMITED BY SIZE               02027009
034800             PV-RECORDS-UPDATED   DELIMITED BY SPACE              02028009
034900      INTO PV-SECOND-LINE                                         02029009
035000                                                                  02029109
035100     STRING "NO. OF DELETES:"     DELIMITED BY SIZE               02029209
035200             PV-RECORDS-DELETED   DELIMITED BY SPACE              02029309
035300      INTO PV-THIRD-LINE                                          02029409
035400                                                                  02029509
035500     WRITE SUMMARY-FILE-RECORD FROM PV-ZERO-LINE.                 02029610
035600     WRITE SUMMARY-FILE-RECORD FROM PV-FIRST-LINE.                02029710
035700     WRITE SUMMARY-FILE-RECORD FROM PV-SECOND-LINE.               02029810
035800     WRITE SUMMARY-FILE-RECORD FROM PV-THIRD-LINE.                02029910
035900                                                                  02030110
036000***************************************************************** 02031010
036100*  DISPLAY DB2 ERROR INFORMATION, ROLLBACK ANY PENDING CHANGES, * 02040000
036200*  AND ABEND THE PROGRAM.                                       * 02050000
036300***************************************************************** 02060000
036400 Z999-SQL-ABEND.                                                  02070000
036500                                                                  02080000
036600     MOVE SQLCODE            TO PV-SQLCODE.                       02090000
036700     MOVE PV-SQLCODE         TO PV-DISP-SQLCODE.                  02100000
036800     DISPLAY '*** DB2 ERROR '.                                    02110000
036900     DISPLAY '*** SQLCODE   = ' PV-DISP-SQLCODE.                  02120000
037000     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02130000
037100     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02140000
037200     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02150000
037300     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02160000
037400     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02170000
037500     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02180000
037600     DISPLAY '*** TABLE 1   = ' PV-ABEND-TABLE.                   02190000
037700                                                                  02200000
037800     COPY DPPD004.                                                02210000
037900                                                                  02220000
038000     MOVE +4013         TO PV-ABEND-CODE.                         02230000
038100     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02240000
