000100 IDENTIFICATION DIVISION.                                         11/02/93
000200 PROGRAM-ID.    CNKCS209.                                         CNKCS209
000300 AUTHOR.        TOM RUSKA. G&R.                                      LV001
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          CNKCS209
000500 DATE-WRITTEN.  05-11-93.                                         CNKCS209
000600 DATE-COMPILED.                                                   CNKCS209
000700                                                                  CNKCS209
000800*---------------------------------------------------------------* CNKCS209
000900*    TRANID      - Y209                                         * CNKCS209
001000*    TYPE        - CICS ARCHITECTURE MAINTENANCE - DB2          * CNKCS209
001100*    DESCRIPTION - ASSIGN DEPT/CLASS TICKET FORMAT              * CNKCS209
001200*    MAPSET      - CNKM209                                      * CNKCS209
001300*                                                               * CNKCS209
001400*    THIS PROGRAM WILL ADD, UPDATE OR DELETE A PREVIOUSLY       * CNKCS209
001500*    DEFINED TICKET FORMAT FOR A DEPARTMENT/CLASS.              * CNKCS209
001600*                                                               * CNKCS209
001700*---------------------------------------------------------------* CNKCS209
263455* CHANGED 11/02/2021    BY JIM HUNTER      WR: CHG0263455                 
263455* CHANGE CALL OF DPKUT100 TO CALL DP010I-NUMERIC-EDIT-ROUTINE             
263455* MAKING THE CALL DYNAMIC VS STATIC.                                      
263455*----------------------------------------------------------------*        
CICS  * CHANGED 10/25/2022    BY JIM HUNTER      WR: CHG0276961                 
CICS  * ADD COPYBOOK DPWS930 AND MAKE THE CICS ARCHITECTURE CALL                
CICS  * DYNAMIC INSTEAD OF STATIC BY CALLING DP930-CICS-ARCH-API.               
CICS  *-----------------------------------------------------------------        
001800                                                                  CNKCS209
001900 ENVIRONMENT DIVISION.                                            CNKCS209
002000 DATA DIVISION.                                                   CNKCS209
002100                                                                  CNKCS209
002200/                                                                 CNKCS209
002300 WORKING-STORAGE SECTION.                                         CNKCS209
002400                                                                  CNKCS209
002500 01  DK-DB2-KEYS.                                                 CNKCS209
002600     05  DK-OPER-UNT-ID                 PIC S9(04) COMP.             CL**3
002700     05  DK-FCLTY-ID                    PIC S9(04) COMP.             CL**3
002800     05  DK-TKT-FMT-ID                  PIC  X(06).                  CL**3
002900     05  DK-DEPT-NBR                    PIC  X(03).                  CL**3
003000     05  DK-CL-NBR                      PIC  X(02).                  CL**3
003100     05  DK-RANK                        PIC  S9(04) COMP.         CNKCS209
003200                                                                  CNKCS209
003300 01  DN-DB2-NULL-INDICATORS.                                      CNKCS209
003400     05  DN-TKT-FMT-ID                  PIC S9(04) VALUE +0          CL**3
003500                                                    COMP.         CNKCS209
003600                                                                  CNKCS209
003700 01  PC-PROGRAM-CONSTANTS.                                        CNKCS209
003800     05  PC-CURRENT-MAP-NAME            PIC  X(08)  VALUE         CNKCS209
003900                                                    'CN209A  '.   CNKCS209
004000     05  PC-CURRENT-MAPSET-NAME         PIC  X(08)  VALUE         CNKCS209
004100                                                    'CNKM209 '.   CNKCS209
004200     05  PC-APPL-MAP                    PIC S9(04)  VALUE  +1     CNKCS209
004300                                                    COMP.         CNKCS209
004400     05  PC-CURRENT-PROGRAM-NAME        PIC  X(08)  VALUE         CNKCS209
004500                                                    'CNKCS209'.   CNKCS209
004600     05  PC-INTER-APPL-CODES.                                     CNKCS209
004700         10  PC-INTER-APPL-CRIT-SPEC    PIC  X(01)  VALUE '1'.    CNKCS209
004800         10  PC-INTER-APPL-ADD          PIC  X(01)  VALUE '2'.    CNKCS209
004900         10  PC-INTER-APPL-UPDATE       PIC  X(01)  VALUE '3'.    CNKCS209
005000         10  PC-INTER-APPL-DELETE       PIC  X(01)  VALUE '4'.    CNKCS209
005100     05  PC-MAX-RETRIES                 PIC S9(03)  VALUE +3      CNKCS209
005200                                                    COMP-3.       CNKCS209
005300                                                                  CNKCS209
005400     05  PC-TSYMSG-NUMBERS.                                       CNKCS209
005500         10  PC-TSYMSG-00004            PIC  9(05)  VALUE  00004. CNKCS209
005600         10  PC-TSYMSG-00005            PIC  9(05)  VALUE  00005. CNKCS209
005700         10  PC-TSYMSG-00007            PIC  9(05)  VALUE  00007. CNKCS209
005800         10  PC-TSYMSG-00008            PIC  9(05)  VALUE  00008. CNKCS209
005900         10  PC-TSYMSG-00016            PIC  9(05)  VALUE  00016. CNKCS209
006000         10  PC-TSYMSG-00034            PIC  9(05)  VALUE  00034. CNKCS209
006100         10  PC-TSYMSG-00045            PIC  9(05)  VALUE  00045. CNKCS209
006200         10  PC-TSYMSG-00047            PIC  9(05)  VALUE  00047. CNKCS209
006300         10  PC-TSYMSG-00057            PIC  9(05)  VALUE  00057. CNKCS209
006400         10  PC-TSYMSG-00059            PIC  9(05)  VALUE  00059. CNKCS209
006500         10  PC-TSYMSG-00069            PIC  9(05)  VALUE  00069. CNKCS209
006600         10  PC-TSYMSG-00070            PIC  9(05)  VALUE  00070. CNKCS209
006700         10  PC-TSYMSG-00112            PIC  9(05)  VALUE  00112. CNKCS209
006800         10  PC-TSYMSG-00110            PIC  9(05)  VALUE  00110. CNKCS209
006900         10  PC-TSYMSG-00115            PIC  9(05)  VALUE  00115. CNKCS209
007000         10  PC-TSYMSG-00116            PIC  9(05)  VALUE  00116. CNKCS209
007100         10  PC-TSYMSG-00117            PIC  9(05)  VALUE  00117. CNKCS209
007200         10  PC-TSYMSG-00148            PIC  9(05)  VALUE  00148. CNKCS209
007300         10  PC-TSYMSG-00158            PIC  9(05)  VALUE  00158. CNKCS209
007400         10  PC-TSYMSG-00477            PIC  9(05)  VALUE  00477. CNKCS209
007500                                                                  CNKCS209
007600 01  PS-PROGRAM-SWITCHES.                                         CNKCS209
007700     05  PS-ERROR-SW                    PIC  X(01)  VALUE 'Y'.    CNKCS209
007800         88  PS-NO-ERROR                            VALUE 'Y'.    CNKCS209
007900         88  PS-ERROR                               VALUE 'N'.    CNKCS209
008000     05  PS-COMMAREA-SW                 PIC  X(01)  VALUE 'N'.    CNKCS209
008100         88  PS-COMMAREA-VALID                      VALUE 'Y'.    CNKCS209
008200         88  PS-COMMAREA-NOT-VALID                  VALUE 'N'.    CNKCS209
008300     05  PS-DONE-SW                     PIC  X(01)  VALUE 'N'.    CNKCS209
008400         88  PS-DONE                                VALUE 'Y'.    CNKCS209
008500         88  PS-NOT-DONE                            VALUE 'N'.    CNKCS209
008600     05  PS-EOF-TDCTFAS-CSR-SW          PIC  X(01)  VALUE 'N'.       CL**5
008700         88  PS-EOF-TDCTFAS-CSR                     VALUE 'Y'.       CL**5
008800                                                                  CNKCS209
008900 01  PV-PROGRAM-VARIABLES.                                        CNKCS209
009000     05  PV-CICS-RESPONSE               PIC S9(04)  VALUE +0      CNKCS209
009100                                                    COMP SYNC.    CNKCS209
009200     05  PV-RETRY-COUNTER               PIC S9(04)  VALUE +0      CNKCS209
009300                                                    COMP SYNC.    CNKCS209
009400     05  PV-DB2-COUNT                   PIC S9(09)  VALUE +0      CNKCS209
009500                                                    COMP-3.       CNKCS209
009600     05  PV-UPD-COUNTER                 PIC S9(09)  VALUE +0      CNKCS209
009700                                                    COMP-3.       CNKCS209
009800     05  PV-RANK-NBR                    PIC S9(04)  VALUE +0      CNKCS209
009900                                                    COMP-3.       CNKCS209
010000     05  PV-HOLD-TDCTFAS                PIC X(25)   VALUE SPACES.    CL**5
010100                                                                  CNKCS209
010200*---------------------------------------------------------------* CNKCS209
010300*  RECORD LAYOUT FOR THE LIST SELECTION TEMP STORAGE QUEUE.     * CNKCS209
010400*---------------------------------------------------------------* CNKCS209
010500                                                                  CNKCS209
010600     COPY CNWS006.                                                   CL**6
010700                                                                  CNKCS209
010800/                                                                 CNKCS209
010900*---------------------------------------------------------------* CNKCS209
011000*    MAP LAYOUT                                                 * CNKCS209
011100*---------------------------------------------------------------* CNKCS209
011200                                                                  CNKCS209
011300     COPY CNKM209.                                                CNKCS209
011400                                                                  CNKCS209
011500/                                                                 CNKCS209
011600*---------------------------------------------------------------* CNKCS209
011700*    ATTRIBUTE SETTINGS COPYBOOK.                               * CNKCS209
011800*---------------------------------------------------------------* CNKCS209
011900                                                                  CNKCS209
012000     COPY DPWS015.                                                CNKCS209
012100                                                                  CNKCS209
012200*---------------------------------------------------------------* CNKCS209
012300*    FUNCTION KEYS COPYBOOK.                                    * CNKCS209
012400*---------------------------------------------------------------* CNKCS209
012500                                                                  CNKCS209
012600     COPY DPWS016.                                                CNKCS209
012700                                                                  CNKCS209
012800*---------------------------------------------------------------* CNKCS209
012900*    NUMERIC EDIT LAYOUT.                                       * CNKCS209
013000*---------------------------------------------------------------* CNKCS209
013100                                                                  CNKCS209
013200     COPY DPWS010I.                                               CNKCS209
013300                                                                  CNKCS209
013400/                                                                 CNKCS209
013500*---------------------------------------------------------------* CNKCS209
CICS  *    PARAMETERS FOR CALLING THE CICS ARCHITECTURE API.          * CNKCS209
013700*---------------------------------------------------------------* CNKCS209
013800                                                                  CNKCS209
013900     COPY DPWS030.                                                CNKCS209
CICS       COPY DPWS930.                                                CNKCS209
014100/                                                                 CNKCS209
014200*---------------------------------------------------------------* CNKCS209
014300*    STANDARD COMMAREA.                                         * CNKCS209
014400*---------------------------------------------------------------* CNKCS209
014500                                                                  CNKCS209
014600     COPY DPWS020.                                                CNKCS209
014700     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                CNKCS209
014800                                                                  CNKCS209
014900*---------------------------------------------------------------* CNKCS209
015000* INTER-APPLICATION COMMAREA.                                   * CNKCS209
015100*   CNWS001 - IS THE INPUT LAYOUT WHEN COMING FROM THE CRIT.    * CNKCS209
015200*             SPEC SCREEN.                                      * CNKCS209
015300*   CNWS003 - IS THE OUTPUT LAYOUT THAT WILL BE PASSED FROM     * CNKCS209
015400*             THIS LIST PROGRAM FOR A LOCAL-GO FUNCTION.        * CNKCS209
015500*---------------------------------------------------------------* CNKCS209
015600                                                                  CNKCS209
015700         10  INTER-APPL-COMM-AREA       PIC X(200).               CNKCS209
015800     COPY CNWS001.                                                   CL**6
015900     COPY CNWS003.                                                   CL**6
016000*---------------------------------------------------------------* CNKCS209
016100*  THIS IS THE APPLICATION-SPECIFIC COMMAREA.                   * CNKCS209
016200*---------------------------------------------------------------* CNKCS209
016300         10  ASC-SPECIFIC-COMMAREA.                               CNKCS209
016400             15  ASC-INT-APPL-FORMAT-IND PIC X(01).               CNKCS209
016500             15  ASC-ACTION-SW          PIC X(03).                CNKCS209
016600                 88  ASC-ADD-PENDING    VALUE 'ADD'.              CNKCS209
016700                 88  ASC-DELETE-PENDING VALUE 'DEL'.              CNKCS209
016800                 88  ASC-UPDATE-PENDING VALUE 'UPD'.              CNKCS209
016900                 88  ASC-ASSIGN-ALL     VALUE 'ALL'.              CNKCS209
017000             15  ASC-DELETE-SUCCESSFUL-SW  PIC X(01).             CNKCS209
017100                 88  ASC-DELETE-SUCCESSFUL VALUE 'Y'.             CNKCS209
017200             15  ASC-ADD-SUCCESSFUL-SW      PIC X(01).            CNKCS209
017300                 88  ASC-ADD-NOT-SUCCESSFUL VALUE ' '.            CNKCS209
017400                 88  ASC-ADD-SUCCESSFUL     VALUE 'Y'.            CNKCS209
017500             15  ASC-OPER-UNT-ID        PIC 9(04).                   CL**3
017600             15  ASC-FCLTY-ID           PIC 9(04).                   CL**3
017700             15  ASC-FCLTY-NME          PIC X(25).                   CL**3
017800             15  ASC-DEPT-NBR           PIC X(03).                   CL**3
017900             15  ASC-CL-NBR             PIC X(02).                   CL**3
018000             15  ASC-FMT-ID             PIC X(06).                   CL**3
018100             15  ASC-RANK               PIC X(01).                CNKCS209
018200             15  ASC-RANK-N REDEFINES ASC-RANK                    CNKCS209
018300                                        PIC 9(01).                CNKCS209
018400             15  ASC-DESC               PIC X(30).                CNKCS209
018500             15  ASC-USE-SELECTION-QUEUE-IND                      CNKCS209
018600                                        PIC  X(01).               CNKCS209
018700                 88  ASC-USE-SELECTION-QUEUE        VALUE 'Y'.    CNKCS209
018800             15  ASC-SEL-QUEUE-NAME     PIC  X(08).               CNKCS209
018900             15  ASC-NUMBER-OF-TS-ITEMS PIC S9(05)  COMP-3.       CNKCS209
019000             15  ASC-NUMBER-OF-SELECTED-ITEMS                     CNKCS209
019100                                        PIC S9(09)  COMP-3.       CNKCS209
019200             15  ASC-SEL-SUB            PIC S9(04)  COMP.         CNKCS209
019300             15  ASC-SEL-ITEM           PIC S9(04)  COMP.         CNKCS209
019400                                                                  CNKCS209
019500/                                                                 CNKCS209
019600*---------------------------------------------------------------* CNKCS209
019700*    ABEND PROCESSING COPYBOOK.                                 * CNKCS209
019800*---------------------------------------------------------------* CNKCS209
019900                                                                  CNKCS209
020000     COPY DPWS013.                                                CNKCS209
020100                                                                  CNKCS209
020200/                                                                 CNKCS209
020300*---------------------------------------------------------------* CNKCS209
020400*    DB2 AREA FOR THE TICKET FORMAT TABLE                       * CNKCS209
020500*---------------------------------------------------------------* CNKCS209
020600     EXEC SQL                                                     CNKCS209
020700          INCLUDE TTKTFMT                                            CL**5
020800     END-EXEC.                                                    CNKCS209
020900                                                                  CNKCS209
021000/                                                                 CNKCS209
021100*---------------------------------------------------------------* CNKCS209
021200*    COPYBOOK USED WHEN CALLING XLKUT071                        * CNKCS209
021300*---------------------------------------------------------------* CNKCS209
021400     COPY XLWS071.                                                CNKCS209
021500                                                                  CNKCS209
021600/                                                                 CNKCS209
021700*---------------------------------------------------------------* CNKCS209
021800*    DB2 AREA FOR THE DEPARTMENT/CLASS TICKET FORMAT TABLE      * CNKCS209
021900*---------------------------------------------------------------* CNKCS209
022000     EXEC SQL                                                     CNKCS209
022100          INCLUDE TDCTFAS                                            CL**5
022200     END-EXEC.                                                    CNKCS209
022300                                                                  CNKCS209
022400/                                                                 CNKCS209
022500*---------------------------------------------------------------* CNKCS209
022600*    DB2 AREA FOR COMMUNICATIONS                                * CNKCS209
022700*---------------------------------------------------------------* CNKCS209
022800     EXEC SQL                                                     CNKCS209
022900          INCLUDE SQLCA                                           CNKCS209
023000     END-EXEC.                                                    CNKCS209
023100                                                                  CNKCS209
023200/                                                                 CNKCS209
023300*---------------------------------------------------------------* CNKCS209
023400*    CURSOR TO SELECT ALL ROWS ON DEPT-CL-NBR TICKET FORMAT TBL *    CL**3
023500*---------------------------------------------------------------* CNKCS209
023600                                                                  CNKCS209
023700     EXEC SQL                                                     CNKCS209
023800          DECLARE TDCTFAS-CSR CURSOR FOR                             CL**5
023900           SELECT OPER_UNT_ID                                        CL**3
024000                 ,FCLTY_ID                                           CL**3
024100                 ,DEPT_NBR                                        CNKCS209
024200                 ,CL_NBR                                             CL**3
024300                 ,RANK_NBR                                        CNKCS209
024400                 ,TKT_FMT_ID                                         CL**3
024500             FROM TDCTFAS                                            CL**5
024600            WHERE  OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
024700              AND  FCLTY_ID    = :DK-FCLTY-ID                        CL**3
024800              AND  DEPT_NBR    = :DK-DEPT-NBR                        CL**3
024900              AND  CL_NBR      = :DK-CL-NBR                          CL**3
025000         ORDER BY RANK_NBR                                        CNKCS209
025100     END-EXEC.                                                    CNKCS209
025200                                                                  CNKCS209
025300/                                                                 CNKCS209
025400 LINKAGE SECTION.                                                 CNKCS209
025500                                                                  CNKCS209
025600 01  DFHCOMMAREA.                                                 CNKCS209
025700     05  FILLER                         OCCURS  1 TO 4072 TIMES   CNKCS209
025800                                        DEPENDING ON EIBCALEN.    CNKCS209
025900         10  FILLER                     PIC X.                    CNKCS209
026000                                                                  CNKCS209
026100/                                                                 CNKCS209
026200 PROCEDURE DIVISION.                                              CNKCS209
026300*---------------------------------------------------------------* CNKCS209
026400*   THIS MODULE IS THE HIGHEST PROCESSING LEVEL IN THE PROGRAM. * CNKCS209
026500*   FIRST, CALL THE CICS ARCHITECTURE API, PERFORM THE PROGRAM  * CNKCS209
026600*   PROCESSING AND THEN CALL THE CICS ARCHITECTURE API TO EXIT. * CNKCS209
026700*---------------------------------------------------------------* CNKCS209
026800 0000-MAIN-MODULE.                                                CNKCS209
026900                                                                  CNKCS209
027000     INITIALIZE DP030-CICS-API-FIELDS.                            CNKCS209
027100                                                                  CNKCS209
027200     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       CNKCS209
027300     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          CNKCS209
027400     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         CNKCS209
027500                                                                  CNKCS209
027600     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       CNKCS209
027700                                                                  CNKCS209
027800     MOVE LENGTH OF CN209AI        TO DP030-MAP-LENGTH (1).       CNKCS209
027900     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     CNKCS209
028000                                                                  CNKCS209
028100     PERFORM 0001-CALL-CICS-ARCH-API.                             CNKCS209
028200     PERFORM 1000-CONTROL-PROCESSING                              CNKCS209
028300                                                                  CNKCS209
028400     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     CNKCS209
028500     PERFORM 0001-CALL-CICS-ARCH-API.                             CNKCS209
028600                                                                  CNKCS209
028700*---------------------------------------------------------------* CNKCS209
028800*   THIS PARAGRAPH CALLS THE CICS ARCHITECTURE API SUBROUTINE   * CNKCS209
028900*   AND WILL ABEND IF ANY ERRORS OCCURRED IN THAT CALL.         * CNKCS209
029000*---------------------------------------------------------------* CNKCS209
029100 0001-CALL-CICS-ARCH-API.                                         CNKCS209
CICS       CALL DP930-CICS-ARCH-API USING DFHEIBLK                              
029300                                    DFHCOMMAREA                           
029400                                    DP030-CICS-API-FIELDS                 
029500                                    DP020-STANDARD-COMMAREA               
029600                                    CN209AI.                              
029700                                                                  CNKCS209
029800     IF  DP030-RC-CALL-SUCCESSFUL                                 CNKCS209
029900         CONTINUE                                                 CNKCS209
030000     ELSE                                                         CNKCS209
030100         SET DP013-NO-ROLLBACK                                    CNKCS209
030200             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
030300             DP013-CICS-ABEND      TO TRUE                        CNKCS209
030400         MOVE '0001-CALL-CICS-ARCH-API'                           CNKCS209
030500                                   TO DP013-PARAGRAPH             CNKCS209
CICS           MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O        
CICS  -             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)              
030800         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)      CNKCS209
030900         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
031000     END-IF.                                                      CNKCS209
031100                                                                  CNKCS209
031200*----------------------------------------------------------------*CNKCS209
031300* PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT      *CNKCS209
031400* COURSE OF ACTION IS FOR THIS TRANSACTION.                      *CNKCS209
031500*----------------------------------------------------------------*CNKCS209
031600                                                                  CNKCS209
031700 1000-CONTROL-PROCESSING.                                         CNKCS209
031800                                                                  CNKCS209
031900     EVALUATE TRUE                                                CNKCS209
032000         WHEN DP020-NEXT-ACT-INITIAL                              CNKCS209
032100              PERFORM 1100-FIND-OBJECT-KEYS                       CNKCS209
032200              IF  PS-ERROR                                        CNKCS209
032300                  CONTINUE                                        CNKCS209
032400              ELSE                                                CNKCS209
032500                  IF  ASC-ADD-PENDING                             CNKCS209
032600                      PERFORM 1200-INIT-ADD-SCREEN                CNKCS209
032700                      PERFORM 4400-MOVE-COMMAREA-TO-SCREEN        CNKCS209
032800                      PERFORM 3200-RESET-ATTRIBUTES               CNKCS209
032900                  ELSE                                            CNKCS209
033000                      PERFORM 4000-BUILD-INITIAL-PANEL            CNKCS209
033100                      PERFORM 3200-RESET-ATTRIBUTES               CNKCS209
033200                      IF  SQLCODE = +100                          CNKCS209
033300                          SET DP020-NEXT-ACT-APPL-ERROR           CNKCS209
033400                                         TO TRUE                  CNKCS209
033500                          MOVE PC-TSYMSG-00148                    CNKCS209
033600                                         TO DP020-MSG-NUMBER      CNKCS209
033700                          SET DP020-MSG-INFORMATIONAL             CNKCS209
033800                                         TO TRUE                  CNKCS209
033900                      ELSE                                        CNKCS209
034000                          IF  ASC-DELETE-PENDING                  CNKCS209
034100                              MOVE PC-TSYMSG-00004                CNKCS209
034200                                         TO DP020-MSG-NUMBER      CNKCS209
034300                              SET DP020-MSG-INFORMATIONAL         CNKCS209
034400                                         TO TRUE                  CNKCS209
034500                          END-IF                                  CNKCS209
034600                      END-IF                                      CNKCS209
034700                  END-IF                                          CNKCS209
034800              END-IF                                              CNKCS209
034900                                                                  CNKCS209
035000         WHEN DP020-NEXT-ACT-READ-MAP                             CNKCS209
035100             PERFORM 2000-PROCESS-PANEL                           CNKCS209
035200                                                                  CNKCS209
035300         WHEN DP020-NEXT-ACT-RETURN                               CNKCS209
035400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 CNKCS209
035500             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   CNKCS209
035600                                                                  CNKCS209
035700         WHEN OTHER                                               CNKCS209
035800             SET DP013-LOGIC-ABEND TO TRUE                        CNKCS209
035900             SET DP013-NO-ROLLBACK TO TRUE                        CNKCS209
036000             MOVE '1000-CONTROL-PROCESSING'                       CNKCS209
036100                                   TO DP013-PARAGRAPH             CNKCS209
036200             MOVE 'INVALID NEXT ACTIVITY RETURNED TO APPL PGM:'   CNKCS209
036300                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
036400             MOVE DP020-NEXT-APPL-ACTIVITY                        CNKCS209
036500                                   TO DP013-MESSAGE-TEXT(2)       CNKCS209
036600             PERFORM DP013-0000-PROCESS-ABEND                     CNKCS209
036700     END-EVALUATE.                                                CNKCS209
036800                                                                  CNKCS209
036900/                                                                 CNKCS209
037000*----------------------------------------------------------------*CNKCS209
037100*  DETERMINE THE KEY OF THE OBJECT TO BE UPDATED BASED ON THE    *CNKCS209
037200*  INTER-APPLICATION FORMAT CODE.                                *CNKCS209
037300*----------------------------------------------------------------*CNKCS209
037400 1100-FIND-OBJECT-KEYS.                                           CNKCS209
037500                                                                  CNKCS209
037600     INITIALIZE ASC-SPECIFIC-COMMAREA.                            CNKCS209
037700                                                                  CNKCS209
037800     MOVE DP020-INT-APPL-FORMAT-IND                               CNKCS209
037900                                   TO ASC-INT-APPL-FORMAT-IND.    CNKCS209
038000                                                                  CNKCS209
038100     EVALUATE DP020-INT-APPL-FORMAT-IND                           CNKCS209
038200         WHEN PC-INTER-APPL-CRIT-SPEC                             CNKCS209
038300             MOVE CN001-OPER-UNT-ID TO ASC-OPER-UNT-ID               CL**3
038400             MOVE CN001-FCLTY-ID    TO ASC-FCLTY-ID                  CL**3
038500             SET ASC-ADD-PENDING   TO TRUE                        CNKCS209
038600                                                                  CNKCS209
038700         WHEN PC-INTER-APPL-ADD                                   CNKCS209
038800             IF  CN003-NUMBER-OF-SELECTED-ITEMS > ZERO            CNKCS209
038900                 MOVE PC-TSYMSG-00112                             CNKCS209
039000                                   TO DP020-MSG-NUMBER            CNKCS209
039100                 SET DP020-MSG-WARNING                            CNKCS209
039200                     DP020-NEXT-ACT-APPL-ERROR                    CNKCS209
039300                     PS-ERROR      TO TRUE                        CNKCS209
039400             ELSE                                                 CNKCS209
039500                 SET ASC-ADD-PENDING                              CNKCS209
039600                                   TO TRUE                        CNKCS209
039700                 MOVE CN003-OPER-UNT-ID                              CL**3
039800                                   TO ASC-OPER-UNT-ID                CL**3
039900                 MOVE CN003-FCLTY-ID                                 CL**3
040000                                   TO ASC-FCLTY-ID                   CL**3
040100             END-IF                                               CNKCS209
040200                                                                  CNKCS209
040300         WHEN PC-INTER-APPL-UPDATE                                CNKCS209
040400             IF  CN003-NUMBER-OF-SELECTED-ITEMS = ZERO            CNKCS209
040500                 MOVE PC-TSYMSG-00057                             CNKCS209
040600                                   TO DP020-MSG-NUMBER            CNKCS209
040700                 SET DP020-MSG-WARNING                            CNKCS209
040800                     DP020-NEXT-ACT-APPL-ERROR                    CNKCS209
040900                     PS-ERROR      TO TRUE                        CNKCS209
041000             ELSE                                                 CNKCS209
041100                 SET ASC-UPDATE-PENDING                           CNKCS209
041200                                       TO TRUE                    CNKCS209
041300                 SET ASC-USE-SELECTION-QUEUE                      CNKCS209
041400                                       TO TRUE                    CNKCS209
041500                 MOVE CN003-NUMBER-OF-SELECTED-ITEMS              CNKCS209
041600                                   TO ASC-NUMBER-OF-SELECTED-ITEMSCNKCS209
041700                 MOVE CN003-NUMBER-OF-TS-ITEMS                    CNKCS209
041800                                       TO ASC-NUMBER-OF-TS-ITEMS  CNKCS209
041900                 MOVE CN003-SEL-QUEUE-NAME                        CNKCS209
042000                                       TO ASC-SEL-QUEUE-NAME      CNKCS209
042100                 PERFORM 1120-PREPARE-LIST-ENTRY                  CNKCS209
042200             END-IF                                               CNKCS209
042300                                                                  CNKCS209
042400         WHEN PC-INTER-APPL-DELETE                                CNKCS209
042500             IF  CN003-NUMBER-OF-SELECTED-ITEMS = ZERO            CNKCS209
042600                 MOVE PC-TSYMSG-00057                             CNKCS209
042700                                   TO DP020-MSG-NUMBER            CNKCS209
042800                 SET DP020-MSG-WARNING                            CNKCS209
042900                     DP020-NEXT-ACT-APPL-ERROR                    CNKCS209
043000                     PS-ERROR      TO TRUE                        CNKCS209
043100             ELSE                                                 CNKCS209
043200             IF  CN003-NUMBER-OF-SELECTED-ITEMS > 1               CNKCS209
043300                 MOVE PC-TSYMSG-00047                             CNKCS209
043400                                   TO DP020-MSG-NUMBER            CNKCS209
043500                 SET DP020-MSG-WARNING                            CNKCS209
043600                     DP020-NEXT-ACT-APPL-ERROR                    CNKCS209
043700                     PS-ERROR      TO TRUE                        CNKCS209
043800             ELSE                                                 CNKCS209
043900                 SET ASC-DELETE-PENDING                           CNKCS209
044000                                       TO TRUE                    CNKCS209
044100                 SET ASC-USE-SELECTION-QUEUE                      CNKCS209
044200                                       TO TRUE                    CNKCS209
044300                 MOVE CN003-NUMBER-OF-SELECTED-ITEMS              CNKCS209
044400                                   TO ASC-NUMBER-OF-SELECTED-ITEMSCNKCS209
044500                 MOVE CN003-NUMBER-OF-TS-ITEMS                    CNKCS209
044600                                       TO ASC-NUMBER-OF-TS-ITEMS  CNKCS209
044700                 MOVE CN003-SEL-QUEUE-NAME                        CNKCS209
044800                                       TO ASC-SEL-QUEUE-NAME      CNKCS209
044900                 PERFORM 1120-PREPARE-LIST-ENTRY                  CNKCS209
045000             END-IF                                               CNKCS209
045100             END-IF                                               CNKCS209
045200                                                                  CNKCS209
045300         WHEN OTHER                                               CNKCS209
045400             MOVE PC-TSYMSG-00148  TO DP020-MSG-NUMBER            CNKCS209
045500             SET DP020-MSG-FATAL                                  CNKCS209
045600                 DP020-NEXT-ACT-APPL-ERROR                        CNKCS209
045700                 PS-ERROR          TO TRUE                        CNKCS209
045800     END-EVALUATE.                                                CNKCS209
045900                                                                  CNKCS209
046000/                                                                 CNKCS209
046100*----------------------------------------------------------------*CNKCS209
046200* ENTRY IS FROM A LIST.  GET THE FORMAT NUMBER FROM THE TEMP     *CNKCS209
046300* STORAGE QUEUE PASSED FROM THE LIST.                            *CNKCS209
046400*----------------------------------------------------------------*CNKCS209
046500 1120-PREPARE-LIST-ENTRY.                                         CNKCS209
046600                                                                  CNKCS209
046700     MOVE CN006-MAX-ITEMS          TO ASC-SEL-SUB.                CNKCS209
046800     MOVE ZERO                     TO ASC-SEL-ITEM.               CNKCS209
046900     PERFORM 2110-GET-NEXT-RECORD.                                CNKCS209
047000                                                                  CNKCS209
047100/                                                                 CNKCS209
047200*----------------------------------------------------------------*CNKCS209
047300* INITIALIZE SCREEN FIELDS FOR AN ADD                            *CNKCS209
047400*----------------------------------------------------------------*CNKCS209
047500 1200-INIT-ADD-SCREEN.                                            CNKCS209
047600                                                                  CNKCS209
047700     SET DP030-SET-CURSOR-APPL-1   TO TRUE.                       CNKCS209
047800                                                                  CNKCS209
047900     MOVE -1                       TO ADEPTL.                     CNKCS209
048000                                                                  CNKCS209
048100     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
048200     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
048300     PERFORM 4200-GET-STORE-INFORMATION.                             CL**3
048400                                                                  CNKCS209
048500     INITIALIZE ASC-DEPT-NBR                                         CL**3
048600                ASC-CL-NBR                                           CL**3
048700                ASC-FMT-ID                                           CL**3
048800                ASC-RANK.                                         CNKCS209
048900                                                                  CNKCS209
049000     MOVE 1                        TO ASC-RANK-N.                 CNKCS209
049100     MOVE +1                       TO ARANKL.                     CNKCS209
049200                                                                  CNKCS209
049300/                                                                 CNKCS209
049400*----------------------------------------------------------------*CNKCS209
049500* DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA   *CNKCS209
049600* ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT   *CNKCS209
049700* USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE REST  *CNKCS209
049800* OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO INVALID      *CNKCS209
049900* FUNCTION KEYS CAN GET THIS FAR.                                *CNKCS209
050000*----------------------------------------------------------------*CNKCS209
050100                                                                  CNKCS209
050200 2000-PROCESS-PANEL.                                              CNKCS209
050300                                                                  CNKCS209
050400     EVALUATE TRUE                                                CNKCS209
050500         WHEN DP020-SRC-AID = DP016-CLEAR                         CNKCS209
050600             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   CNKCS209
050700             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 CNKCS209
050800                                                                  CNKCS209
050900         WHEN DP020-SRC-AID = DP016-ENTER                         CNKCS209
051000* IF TICKET FORMAT CHANGES, REFRESH FORMAT DESCRIPTION            CNKCS209
051100             IF  AFMTL > ZERO                                     CNKCS209
051200             AND AFMTI NOT = ASC-FMT-ID                              CL**3
051300                 MOVE ASC-OPER-UNT-ID TO DK-OPER-UNT-ID              CL**3
051400                 MOVE ASC-FCLTY-ID    TO DK-FCLTY-ID                 CL**3
051500                 MOVE AFMTI        TO ASC-FMT-ID                     CL**3
051600                                      DK-TKT-FMT-ID                  CL**3
051700                 PERFORM 4300-SELECT-TTKTFMT                         CL**5
051800                 MOVE TKTFMT-TKT-FMT-DESC                            CL**5
051900                                   TO ASC-DESC                    CNKCS209
052000                                      ADESCO                      CNKCS209
052100             END-IF                                               CNKCS209
052200             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 CNKCS209
052300             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   CNKCS209
052400                                                                  CNKCS209
052500         WHEN DP020-FK-REFRESH (DP020-SRC-AID)                    CNKCS209
052600             IF (ASC-ADD-PENDING                                  CNKCS209
052700             AND ASC-ADD-NOT-SUCCESSFUL)                          CNKCS209
052800                 PERFORM 1200-INIT-ADD-SCREEN                     CNKCS209
052900                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN             CNKCS209
053000                 PERFORM 3200-RESET-ATTRIBUTES                    CNKCS209
053100             ELSE                                                 CNKCS209
053200                 SET DP030-DONT-ERASE                             CNKCS209
053300                     DP030-SEND-DATAONLY (PC-APPL-MAP)            CNKCS209
053400                                   TO TRUE                        CNKCS209
053500                 PERFORM 4000-BUILD-INITIAL-PANEL                 CNKCS209
053600                 PERFORM 3200-RESET-ATTRIBUTES                    CNKCS209
053700             END-IF                                               CNKCS209
053800                                                                  CNKCS209
053900         WHEN DP020-FK-NEXT-SELECTION (DP020-SRC-AID)             CNKCS209
054000             IF  ASC-USE-SELECTION-QUEUE                          CNKCS209
054100                 PERFORM 2110-GET-NEXT-RECORD                     CNKCS209
054200                 PERFORM 4000-BUILD-INITIAL-PANEL                 CNKCS209
054300                 PERFORM 3200-RESET-ATTRIBUTES                    CNKCS209
054400             ELSE                                                 CNKCS209
054500*                --- BOTTOM OF LIST ---                           CNKCS209
054600                 MOVE PC-TSYMSG-00070                             CNKCS209
054700                                   TO DP020-MSG-NUMBER            CNKCS209
054800                 SET DP020-MSG-INFORMATIONAL                      CNKCS209
054900                                   TO TRUE                        CNKCS209
055000             END-IF                                               CNKCS209
055100                                                                  CNKCS209
055200         WHEN DP020-FK-PREV-SELECTION (DP020-SRC-AID)             CNKCS209
055300             IF  ASC-USE-SELECTION-QUEUE                          CNKCS209
055400                 PERFORM 2120-GET-PREV-RECORD                     CNKCS209
055500                 PERFORM 4000-BUILD-INITIAL-PANEL                 CNKCS209
055600                 PERFORM 3200-RESET-ATTRIBUTES                    CNKCS209
055700             ELSE                                                 CNKCS209
055800*                --- TOP OF LIST ---                              CNKCS209
055900                 MOVE PC-TSYMSG-00069                             CNKCS209
056000                                   TO DP020-MSG-NUMBER            CNKCS209
056100                 SET DP020-MSG-INFORMATIONAL                      CNKCS209
056200                                   TO TRUE                        CNKCS209
056300             END-IF                                               CNKCS209
056400                                                                  CNKCS209
056500         WHEN OTHER                                               CNKCS209
056600             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                 CNKCS209
056700             PERFORM 3000-EDIT-DATA-IN-COMMAREA                   CNKCS209
056800             IF  PS-NO-ERROR                                      CNKCS209
056900                 SET DP030-CONTINUE-GO                            CNKCS209
057000                                   TO TRUE                        CNKCS209
057100                 PERFORM 2100-CHECK-FUNCTION-KEY                  CNKCS209
057200             ELSE                                                 CNKCS209
057300                 SET DP030-OVERRIDE-GO                            CNKCS209
057400                                   TO TRUE                        CNKCS209
057500             END-IF                                               CNKCS209
057600     END-EVALUATE.                                                CNKCS209
057700                                                                  CNKCS209
057800/                                                                 CNKCS209
057900*----------------------------------------------------------------*CNKCS209
058000* ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED FIRST.*CNKCS209
058100* NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED FROM THE  *CNKCS209
058200* CICS ARCHITECTURE API.                                         *CNKCS209
058300*----------------------------------------------------------------*CNKCS209
058400 2100-CHECK-FUNCTION-KEY.                                         CNKCS209
058500                                                                  CNKCS209
058600     EVALUATE TRUE                                                CNKCS209
058700         WHEN DP020-SRC-AID = DP016-ENTER                         CNKCS209
058800             CONTINUE                                             CNKCS209
058900                                                                  CNKCS209
059000         WHEN DP020-FK-CONFIRM (DP020-SRC-AID)                    CNKCS209
059100             IF  ASC-DELETE-PENDING                               CNKCS209
059200             AND ASC-DELETE-SUCCESSFUL                            CNKCS209
059300                 MOVE PC-TSYMSG-00116                             CNKCS209
059400                                   TO DP020-MSG-NUMBER            CNKCS209
059500                 SET DP020-MSG-FATAL                              CNKCS209
059600                     PS-ERROR      TO TRUE                        CNKCS209
059700                 PERFORM 3200-RESET-ATTRIBUTES                    CNKCS209
059800             ELSE                                                 CNKCS209
059900                 IF  ASC-DELETE-PENDING                           CNKCS209
060000                     SET DP030-CONTINUE-GO                        CNKCS209
060100                                   TO TRUE                        CNKCS209
060200                     PERFORM 7000-DELETE-ASSIGNMENT               CNKCS209
060300                 ELSE                                             CNKCS209
060400                     IF  ASC-ASSIGN-ALL                           CNKCS209
060500                         SET DP030-CONTINUE-GO                    CNKCS209
060600                                   TO TRUE                        CNKCS209
060700                         PERFORM 8000-ASSIGN-ALL                  CNKCS209
060800                     END-IF                                       CNKCS209
060900                 END-IF                                           CNKCS209
061000             END-IF                                               CNKCS209
061100                                                                  CNKCS209
061200         WHEN DP020-FK-LOCAL-FUNC-01 (DP020-SRC-AID)              CNKCS209
061300             SET DP030-CONTINUE-GO TO TRUE                        CNKCS209
061400             PERFORM 5000-ADD-ASSIGNMENT                          CNKCS209
061500                                                                  CNKCS209
061600         WHEN DP020-FK-LOCAL-FUNC-02 (DP020-SRC-AID)              CNKCS209
061700             SET DP030-CONTINUE-GO TO TRUE                        CNKCS209
061800             PERFORM 6000-UPDATE-ASSIGNMENT                       CNKCS209
061900                                                                  CNKCS209
062000         WHEN DP020-FK-LOCAL-FUNC-04 (DP020-SRC-AID)              CNKCS209
062100             MOVE PC-TSYMSG-00004  TO DP020-MSG-NUMBER            CNKCS209
062200             SET DP020-MSG-INFORMATIONAL                          CNKCS209
062300                 ASC-ASSIGN-ALL    TO TRUE                        CNKCS209
062400             PERFORM 3200-RESET-ATTRIBUTES                        CNKCS209
062500                                                                  CNKCS209
062600         WHEN OTHER                                               CNKCS209
062700             SET DP013-NO-ROLLBACK                                CNKCS209
062800                 DP013-XCTL-DISPLAY-RESTART                       CNKCS209
062900                 DP013-CICS-ABEND  TO TRUE                        CNKCS209
063000             MOVE '2100-CHECK-FUNCTION-KEY'                       CNKCS209
063100                                   TO DP013-PARAGRAPH             CNKCS209
063200             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      CNKCS209
063300                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
063400             PERFORM DP013-0000-PROCESS-ABEND                     CNKCS209
063500     END-EVALUATE.                                                CNKCS209
063600                                                                  CNKCS209
063700/                                                                 CNKCS209
063800 2110-GET-NEXT-RECORD.                                            CNKCS209
063900                                                                  CNKCS209
064000     ADD +1                        TO ASC-SEL-SUB.                CNKCS209
064100     IF  ASC-SEL-SUB > CN006-MAX-ITEMS                            CNKCS209
064200         ADD +1                    TO ASC-SEL-ITEM                CNKCS209
064300         MOVE +1                   TO ASC-SEL-SUB                 CNKCS209
064400     END-IF.                                                      CNKCS209
064500                                                                  CNKCS209
064600     IF  ASC-SEL-ITEM NOT > ASC-NUMBER-OF-TS-ITEMS                CNKCS209
064700         PERFORM 9100-READ-SEL-QUEUE                              CNKCS209
064800         IF  CN006-ITEM (ASC-SEL-SUB) > ZERO                      CNKCS209
064900             MOVE CN006-OPER-UNT-ID (ASC-SEL-SUB)                    CL**3
065000                                   TO ASC-OPER-UNT-ID                CL**3
065100             MOVE CN006-FCLTY-ID (ASC-SEL-SUB)                       CL**3
065200                                   TO ASC-FCLTY-ID                   CL**3
065300             MOVE CN006-DEPT-NBR (ASC-SEL-SUB)                       CL**3
065400                                   TO ASC-DEPT-NBR                   CL**3
065500             MOVE CN006-CL-NBR (ASC-SEL-SUB)                         CL**3
065600                                   TO ASC-CL-NBR                     CL**3
065700             MOVE CN006-RANK (ASC-SEL-SUB)                        CNKCS209
065800                                   TO ASC-RANK-N                  CNKCS209
065900             SET CN006-INQ (ASC-SEL-SUB)                          CNKCS209
066000                                   TO TRUE                        CNKCS209
066100             PERFORM 9200-REWRITE-LIST-QUEUE                      CNKCS209
066200         ELSE                                                     CNKCS209
066300             SUBTRACT +1 FROM ASC-SEL-SUB                         CNKCS209
066400*            --- BOTTOM OF LIST ---                               CNKCS209
066500             MOVE PC-TSYMSG-00070  TO DP020-MSG-NUMBER            CNKCS209
066600             SET DP020-MSG-INFORMATIONAL                          CNKCS209
066700                                   TO TRUE                        CNKCS209
066800         END-IF                                                   CNKCS209
066900     ELSE                                                         CNKCS209
067000         SUBTRACT +1 FROM ASC-SEL-ITEM                            CNKCS209
067100         MOVE CN006-MAX-ITEMS      TO ASC-SEL-SUB                 CNKCS209
067200         MOVE PC-TSYMSG-00070      TO DP020-MSG-NUMBER            CNKCS209
067300         SET DP020-MSG-INFORMATIONAL                              CNKCS209
067400                                   TO TRUE                        CNKCS209
067500     END-IF.                                                      CNKCS209
067600                                                                  CNKCS209
067700/                                                                 CNKCS209
067800 2120-GET-PREV-RECORD.                                            CNKCS209
067900                                                                  CNKCS209
068000     SUBTRACT +1 FROM ASC-SEL-SUB.                                CNKCS209
068100     IF  ASC-SEL-SUB < +1                                         CNKCS209
068200         SUBTRACT +1 FROM ASC-SEL-ITEM                            CNKCS209
068300         MOVE CN006-MAX-ITEMS      TO ASC-SEL-SUB                 CNKCS209
068400     END-IF.                                                      CNKCS209
068500                                                                  CNKCS209
068600     IF  ASC-SEL-ITEM > ZERO                                      CNKCS209
068700         PERFORM 9100-READ-SEL-QUEUE                              CNKCS209
068800         MOVE CN006-OPER-UNT-ID (ASC-SEL-SUB)                        CL**3
068900                                   TO ASC-OPER-UNT-ID                CL**3
069000         MOVE CN006-FCLTY-ID (ASC-SEL-SUB)                           CL**3
069100                                   TO ASC-FCLTY-ID                   CL**3
069200         MOVE CN006-DEPT-NBR (ASC-SEL-SUB)                           CL**3
069300                                   TO ASC-DEPT-NBR                   CL**3
069400         MOVE CN006-CL-NBR (ASC-SEL-SUB)                             CL**3
069500                                   TO ASC-CL-NBR                     CL**3
069600         MOVE CN006-RANK (ASC-SEL-SUB)                            CNKCS209
069700                                   TO ASC-RANK-N                  CNKCS209
069800     ELSE                                                         CNKCS209
069900         MOVE +1                   TO ASC-SEL-ITEM                CNKCS209
070000                                      ASC-SEL-SUB                 CNKCS209
070100*        --- TOP OF LIST ---                                      CNKCS209
070200         MOVE PC-TSYMSG-00069      TO DP020-MSG-NUMBER            CNKCS209
070300         SET DP020-MSG-INFORMATIONAL                              CNKCS209
070400                                   TO TRUE                        CNKCS209
070500     END-IF.                                                      CNKCS209
070600                                                                  CNKCS209
070700/                                                                 CNKCS209
070800*----------------------------------------------------------------*CNKCS209
070900*  MOVE ALL OF THE FIELDS THAT WERE ENTERED / CHANGED ON THE     *CNKCS209
071000*  SCREEN INTO THE COMMAREA.  ALL EDITTING IS DONE IN THE COMM.  *CNKCS209
071100*----------------------------------------------------------------*CNKCS209
071200 2200-MOVE-SCREEN-TO-COMMAREA.                                    CNKCS209
071300                                                                  CNKCS209
071400     IF  ADEPTL > ZERO                                            CNKCS209
071500         MOVE ADEPTI               TO ASC-DEPT-NBR                   CL**3
071600     ELSE                                                         CNKCS209
071700         IF  ADEPTF = DP015-ERASE-EOF                             CNKCS209
071800             MOVE SPACES           TO ASC-DEPT-NBR                   CL**3
071900         END-IF                                                   CNKCS209
072000     END-IF.                                                      CNKCS209
072100                                                                  CNKCS209
072200     IF  ACLASL > ZERO                                            CNKCS209
072300         MOVE ACLASI               TO ASC-CL-NBR                     CL**3
072400     ELSE                                                         CNKCS209
072500         IF  ACLASF = DP015-ERASE-EOF                             CNKCS209
072600             MOVE SPACES           TO ASC-CL-NBR                     CL**3
072700         END-IF                                                   CNKCS209
072800     END-IF.                                                      CNKCS209
072900                                                                  CNKCS209
073000     IF  AFMTL > ZERO                                             CNKCS209
073100         MOVE AFMTI                TO ASC-FMT-ID                     CL**3
073200     ELSE                                                         CNKCS209
073300         IF  AFMTF = DP015-ERASE-EOF                              CNKCS209
073400             MOVE SPACES           TO ASC-FMT-ID                     CL**3
073500         END-IF                                                   CNKCS209
073600     END-IF.                                                      CNKCS209
073700                                                                  CNKCS209
073800     IF  ARANKL > ZERO                                            CNKCS209
073900         MOVE ARANKI               TO ASC-RANK                    CNKCS209
074000     ELSE                                                         CNKCS209
074100         IF  ARANKF = DP015-ERASE-EOF                             CNKCS209
074200             MOVE SPACES           TO ASC-RANK                    CNKCS209
074300         END-IF                                                   CNKCS209
074400     END-IF.                                                      CNKCS209
074500                                                                  CNKCS209
074600/                                                                 CNKCS209
074700*----------------------------------------------------------------*CNKCS209
074800*  EDIT ALL OF THE DATA ON THE SCREEN AS IT RESIDES IN THE       *CNKCS209
074900*  COMMAREA (EDITTING IS NOT DONE AGAINST THE SCREEN DIRECTLY).  *CNKCS209
075000*----------------------------------------------------------------*CNKCS209
075100 3000-EDIT-DATA-IN-COMMAREA.                                      CNKCS209
075200                                                                  CNKCS209
075300     PERFORM 3200-RESET-ATTRIBUTES.                               CNKCS209
075400                                                                  CNKCS209
075500     IF  ASC-RANK = SPACES                                        CNKCS209
075600         SET PS-ERROR              TO TRUE                        CNKCS209
075700         SET DP020-MSG-FATAL       TO TRUE                        CNKCS209
075800         MOVE PC-TSYMSG-00007      TO DP020-MSG-NUMBER            CNKCS209
075900         MOVE DP015-UNP-ALP-BRT-OFF                               CNKCS209
076000                                   TO ARANKA                      CNKCS209
076100         MOVE DP015-RED            TO ARANKC                      CNKCS209
076200         MOVE DP015-REVERSE        TO ARANKH                      CNKCS209
076300         MOVE -1                   TO ARANKL                      CNKCS209
076400         SET DP030-SET-CURSOR-APPL-1                              CNKCS209
076500                                   TO TRUE                        CNKCS209
076600     END-IF.                                                      CNKCS209
076700                                                                  CNKCS209
076800     IF  ASC-ADD-PENDING                                          CNKCS209
076900         IF  ASC-FMT-ID = SPACES                                     CL**3
077000             SET PS-ERROR              TO TRUE                    CNKCS209
077100             SET DP020-MSG-FATAL       TO TRUE                    CNKCS209
077200             MOVE PC-TSYMSG-00007      TO DP020-MSG-NUMBER        CNKCS209
077300             MOVE DP015-UNP-ALP-BRT-OFF                           CNKCS209
077400                                       TO AFMTA                   CNKCS209
077500             MOVE DP015-RED            TO AFMTC                   CNKCS209
077600             MOVE DP015-REVERSE        TO AFMTH                   CNKCS209
077700             MOVE -1                   TO AFMTL                   CNKCS209
077800             SET DP030-SET-CURSOR-APPL-1                          CNKCS209
077900                                       TO TRUE                    CNKCS209
078000         END-IF                                                   CNKCS209
078100     END-IF.                                                      CNKCS209
078200                                                                  CNKCS209
078300     IF  ASC-CL-NBR = SPACES                                         CL**3
078400         SET PS-ERROR              TO TRUE                        CNKCS209
078500         SET DP020-MSG-FATAL       TO TRUE                        CNKCS209
078600         MOVE PC-TSYMSG-00007      TO DP020-MSG-NUMBER            CNKCS209
078700         MOVE DP015-UNP-ALP-BRT-OFF                               CNKCS209
078800                                   TO ACLASA                      CNKCS209
078900         MOVE DP015-RED            TO ACLASC                      CNKCS209
079000         MOVE DP015-REVERSE        TO ACLASH                      CNKCS209
079100         MOVE -1                   TO ACLASL                      CNKCS209
079200         SET DP030-SET-CURSOR-APPL-1                              CNKCS209
079300                                   TO TRUE                        CNKCS209
079400     END-IF.                                                      CNKCS209
079500                                                                  CNKCS209
079600     IF  ASC-DEPT-NBR = SPACES                                       CL**3
079700         SET PS-ERROR              TO TRUE                        CNKCS209
079800         SET DP020-MSG-FATAL       TO TRUE                        CNKCS209
079900         MOVE PC-TSYMSG-00007      TO DP020-MSG-NUMBER            CNKCS209
080000         MOVE DP015-UNP-ALP-BRT-OFF                               CNKCS209
080100                                   TO ADEPTA                      CNKCS209
080200         MOVE DP015-RED            TO ADEPTC                      CNKCS209
080300         MOVE DP015-REVERSE        TO ADEPTH                      CNKCS209
080400         MOVE -1                   TO ADEPTL                      CNKCS209
080500         SET DP030-SET-CURSOR-APPL-1                              CNKCS209
080600                                   TO TRUE                        CNKCS209
080700     END-IF.                                                      CNKCS209
080800                                                                  CNKCS209
080900     IF  ASC-RANK > SPACES                                        CNKCS209
081000         MOVE ASC-RANK             TO DP010I-UNEDITED-FIELD       CNKCS209
081100         MOVE LENGTH OF ASC-RANK   TO DP010I-MAXIMUM-DIGITS       CNKCS209
081200         MOVE ZERO                 TO DP010I-MAXIMUM-DECIMALS     CNKCS209
081300         SET DP010I-NEGATIVE-NOT-ALLOWED                          CNKCS209
081400                                   TO TRUE                        CNKCS209
263455         CALL DP010I-NUMERIC-EDIT-ROUTINE                                 
263455              USING DP010I-NUMERIC-EDIT-AREA                              
081600         IF  DP010I-ERROR-DETECTED                                CNKCS209
081700             SET PS-ERROR                                         CNKCS209
081800                 DP020-MSG-FATAL   TO TRUE                        CNKCS209
081900             MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER            CNKCS209
082000             MOVE DP015-UNP-NUM-BRT-OFF                           CNKCS209
082100                                   TO ARANKA                      CNKCS209
082200             MOVE DP015-RED        TO ARANKC                      CNKCS209
082300             MOVE DP015-REVERSE    TO ARANKH                      CNKCS209
082400             MOVE -1               TO ARANKL                      CNKCS209
082500             SET DP030-SET-CURSOR-APPL-1                          CNKCS209
082600                                   TO TRUE                        CNKCS209
082700         ELSE                                                     CNKCS209
082800             MOVE DP010I-NUMERIC-FIELD                            CNKCS209
082900                                   TO ASC-RANK-N                  CNKCS209
083000             MOVE ASC-RANK         TO ARANKO                      CNKCS209
083100         END-IF                                                   CNKCS209
083200     END-IF.                                                      CNKCS209
083300                                                                  CNKCS209
083400     IF  ASC-FMT-ID > SPACES                                         CL**3
083500         INITIALIZE PV-DB2-COUNT                                  CNKCS209
083600         MOVE ASC-OPER-UNT-ID      TO DK-OPER-UNT-ID                 CL**3
083700         MOVE ASC-FCLTY-ID         TO DK-FCLTY-ID                    CL**3
083800         MOVE ASC-FMT-ID           TO DK-TKT-FMT-ID                  CL**3
083900         PERFORM 3010-COUNT-TTKTFMT                                  CL**5
084000         IF  PV-DB2-COUNT = +0                                    CNKCS209
084100             SET PS-ERROR          TO TRUE                        CNKCS209
084200             SET DP020-MSG-FATAL   TO TRUE                        CNKCS209
084300             MOVE PC-TSYMSG-00005  TO DP020-MSG-NUMBER            CNKCS209
084400             MOVE DP015-UNP-ALP-BRT-OFF                           CNKCS209
084500                                   TO AFMTA                       CNKCS209
084600             MOVE DP015-RED        TO AFMTC                       CNKCS209
084700             MOVE DP015-REVERSE    TO AFMTH                       CNKCS209
084800             MOVE -1               TO AFMTL                       CNKCS209
084900             SET DP030-SET-CURSOR-APPL-1                          CNKCS209
085000                                   TO TRUE                        CNKCS209
085100         END-IF                                                   CNKCS209
085200     END-IF.                                                      CNKCS209
085300                                                                  CNKCS209
085400*  CHECK TO SEE IF THIS FORMAT IS ALREADY ASSIGNED TO THE         CNKCS209
085500*  SAME DEPT/CLASS WITH A DIFFERENT RANKING                       CNKCS209
085600                                                                  CNKCS209
085700     IF  ASC-DELETE-PENDING                                       CNKCS209
085800         CONTINUE                                                 CNKCS209
085900     ELSE                                                         CNKCS209
086000         IF  PS-NO-ERROR AND ASC-FMT-ID > SPACES                     CL**3
086100             INITIALIZE PV-DB2-COUNT                              CNKCS209
086200             MOVE ASC-OPER-UNT-ID  TO DK-OPER-UNT-ID                 CL**3
086300             MOVE ASC-FCLTY-ID     TO DK-FCLTY-ID                    CL**3
086400             MOVE ASC-DEPT-NBR     TO DK-DEPT-NBR                    CL**3
086500             MOVE ASC-CL-NBR       TO DK-CL-NBR                      CL**3
086600             MOVE ASC-FMT-ID       TO DK-TKT-FMT-ID                  CL**3
086700             PERFORM 3020-COUNT-TDCTFAS                              CL**5
086800             IF  PV-DB2-COUNT > +0                                CNKCS209
086900                 SET PS-ERROR         TO TRUE                     CNKCS209
087000                 SET DP020-MSG-FATAL  TO TRUE                     CNKCS209
087100                 MOVE PC-TSYMSG-00477 TO DP020-MSG-NUMBER         CNKCS209
087200                 MOVE DP015-UNP-ALP-BRT-OFF                       CNKCS209
087300                                      TO AFMTA                    CNKCS209
087400                 MOVE DP015-RED       TO AFMTC                    CNKCS209
087500                 MOVE DP015-REVERSE   TO AFMTH                    CNKCS209
087600                 MOVE -1              TO AFMTL                    CNKCS209
087700                 SET DP030-SET-CURSOR-APPL-1                      CNKCS209
087800                                      TO TRUE                     CNKCS209
087900             END-IF                                               CNKCS209
088000         END-IF                                                   CNKCS209
088100     END-IF.                                                      CNKCS209
088200                                                                  CNKCS209
088300     IF  ASC-ADD-PENDING                                          CNKCS209
088400         INITIALIZE PV-DB2-COUNT                                  CNKCS209
088500         MOVE ASC-OPER-UNT-ID      TO DK-OPER-UNT-ID                 CL**3
088600         MOVE ASC-FCLTY-ID         TO DK-FCLTY-ID                    CL**3
088700         MOVE ASC-DEPT-NBR         TO DK-DEPT-NBR                    CL**3
088800         MOVE ASC-CL-NBR           TO DK-CL-NBR                      CL**3
088900         PERFORM 7100-COUNT-TDCTFAS                                  CL**5
089000         IF  PV-DB2-COUNT = +0                                    CNKCS209
089100             SET PS-ERROR          TO TRUE                        CNKCS209
089200             SET DP020-MSG-FATAL   TO TRUE                        CNKCS209
089300             MOVE PC-TSYMSG-00110  TO DP020-MSG-NUMBER            CNKCS209
089400             MOVE DP015-UNP-ALP-BRT-OFF                           CNKCS209
089500                                   TO ADEPTA                      CNKCS209
089600                                      ACLASA                      CNKCS209
089700             MOVE DP015-RED        TO ADEPTC                      CNKCS209
089800                                      ACLASC                      CNKCS209
089900             MOVE DP015-REVERSE    TO ADEPTH                      CNKCS209
090000                                      ACLASH                      CNKCS209
090100             MOVE -1               TO ADEPTL                      CNKCS209
090200             SET DP030-SET-CURSOR-APPL-1                          CNKCS209
090300                                   TO TRUE                        CNKCS209
090400         END-IF                                                   CNKCS209
090500     END-IF.                                                      CNKCS209
090600                                                                  CNKCS209
090700     IF  PS-NO-ERROR                                              CNKCS209
090800         EVALUATE TRUE                                            CNKCS209
090900             WHEN ASC-ADD-PENDING                                 CNKCS209
091000                 MOVE -1           TO ADEPTL                      CNKCS209
091100                 SET DP030-SET-CURSOR-APPL-1                      CNKCS209
091200                                   TO TRUE                        CNKCS209
091300             WHEN ASC-UPDATE-PENDING                              CNKCS209
091400                 MOVE -1           TO AFMTL                       CNKCS209
091500                 SET DP030-SET-CURSOR-APPL-1                      CNKCS209
091600                                   TO TRUE                        CNKCS209
091700             WHEN ASC-DELETE-PENDING                              CNKCS209
091800                 SET DP030-SET-CURSOR-TRAILER                     CNKCS209
091900                                   TO TRUE                        CNKCS209
092000         END-EVALUATE                                             CNKCS209
092100     END-IF.                                                      CNKCS209
092200                                                                  CNKCS209
092300/                                                                 CNKCS209
092400*----------------------------------------------------------------*CNKCS209
092500*    VALIDATE THE TICKET FORMAT ENTERED                          *CNKCS209
092600*----------------------------------------------------------------*CNKCS209
092700                                                                  CNKCS209
092800 3010-COUNT-TTKTFMT.                                                 CL**5
092900                                                                  CNKCS209
093000     PERFORM                                                      CNKCS209
093100         WITH TEST AFTER                                          CNKCS209
093200         VARYING PV-RETRY-COUNTER                                 CNKCS209
093300         FROM 1 BY 1                                              CNKCS209
093400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
093500            OR  (SQLCODE = +0)                                    CNKCS209
093600            OR  (SQLCODE = +100))                                 CNKCS209
093700                                                                  CNKCS209
093800         EXEC SQL                                                 CNKCS209
093900             SELECT COUNT(*)                                      CNKCS209
094000              INTO :PV-DB2-COUNT                                  CNKCS209
094100              FROM TTKTFMT                                           CL**5
094200             WHERE OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
094300               AND FCLTY_ID    = :DK-FCLTY-ID                        CL**3
094400               AND TKT_FMT_ID  = :DK-TKT-FMT-ID                      CL**3
094500         END-EXEC                                                 CNKCS209
094600                                                                  CNKCS209
094700         EVALUATE TRUE                                            CNKCS209
094800             WHEN SQLCODE = +0                                    CNKCS209
094900             WHEN SQLCODE = +100                                  CNKCS209
095000             WHEN SQLCODE = -904                                  CNKCS209
095100             WHEN SQLCODE = -913                                  CNKCS209
095200                  CONTINUE                                        CNKCS209
095300             WHEN SQLWARN0 NOT = SPACE                            CNKCS209
095400             WHEN SQLCODE < +0                                    CNKCS209
095500             WHEN SQLCODE > +0                                    CNKCS209
095600                  MOVE '3010-COUNT-TTKTFMT'                          CL**5
095700                                   TO DP013-PARAGRAPH             CNKCS209
095800                  MOVE 'COUNT ON TTKTFMT'                            CL**5
095900                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
096000                  MOVE SQLCA       TO DP013-SQLCA                 CNKCS209
096100                  MOVE 'TTKTFMT'   TO DP013-DB2-TABLE-NAME (1)       CL**5
096200                  SET DP013-DB2-ABEND                             CNKCS209
096300                      DP013-XCTL-DISPLAY-RESTART                  CNKCS209
096400                                   TO TRUE                        CNKCS209
096500                  PERFORM DP013-0000-PROCESS-ABEND                CNKCS209
096600         END-EVALUATE                                             CNKCS209
096700     END-PERFORM.                                                 CNKCS209
096800                                                                  CNKCS209
096900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
097000         MOVE '3010-COUNT-TTKTFMT'                                   CL**5
097100                                   TO DP013-PARAGRAPH             CNKCS209
097200         MOVE 'MAX RETRIES EXCEEDED FOR COUNT'                    CNKCS209
097300                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
097400         MOVE 'ON TABLE TTKTFMT '  TO DP013-MESSAGE-TEXT (2)         CL**5
097500         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
097600         SET DP013-DB2-ABEND                                      CNKCS209
097700             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
097800                                   TO TRUE                        CNKCS209
097900         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
098000     END-IF.                                                      CNKCS209
098100                                                                  CNKCS209
098200/                                                                 CNKCS209
098300*----------------------------------------------------------------*CNKCS209
098400*    CHECK TO SEE IF THIS FORMAT IS ALREADY EXISTS FOR THIS      *CNKCS209
098500*    DEPT/CLASS.                                                 *CNKCS209
098600*----------------------------------------------------------------*CNKCS209
098700                                                                  CNKCS209
098800 3020-COUNT-TDCTFAS.                                                 CL**5
098900                                                                  CNKCS209
099000     PERFORM                                                      CNKCS209
099100         WITH TEST AFTER                                          CNKCS209
099200         VARYING PV-RETRY-COUNTER                                 CNKCS209
099300         FROM 1 BY 1                                              CNKCS209
099400         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
099500            OR  (SQLCODE = +0)                                    CNKCS209
099600            OR  (SQLCODE = +100))                                 CNKCS209
099700                                                                  CNKCS209
099800         EXEC SQL                                                 CNKCS209
099900             SELECT COUNT(*)                                      CNKCS209
100000              INTO :PV-DB2-COUNT                                  CNKCS209
100100              FROM TDCTFAS                                           CL**5
100200             WHERE OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
100300               AND FCLTY_ID    = :DK-FCLTY-ID                        CL**3
100400               AND DEPT_NBR    = :DK-DEPT-NBR                        CL**3
100500               AND CL_NBR      = :DK-CL-NBR                          CL**3
100600               AND TKT_FMT_ID  = :DK-TKT-FMT-ID                      CL**3
100700         END-EXEC                                                 CNKCS209
100800                                                                  CNKCS209
100900         EVALUATE TRUE                                            CNKCS209
101000             WHEN SQLCODE = +0                                    CNKCS209
101100             WHEN SQLCODE = +100                                  CNKCS209
101200             WHEN SQLCODE = -904                                  CNKCS209
101300             WHEN SQLCODE = -913                                  CNKCS209
101400                  CONTINUE                                        CNKCS209
101500             WHEN SQLWARN0 NOT = SPACE                            CNKCS209
101600             WHEN SQLCODE < +0                                    CNKCS209
101700             WHEN SQLCODE > +0                                    CNKCS209
101800                  MOVE '3020-COUNT-TDCTFAS'                          CL**5
101900                                   TO DP013-PARAGRAPH             CNKCS209
102000                  MOVE 'COUNT ON TDCTFAS'                            CL**5
102100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
102200                  MOVE SQLCA       TO DP013-SQLCA                 CNKCS209
102300                  MOVE 'TDCTFAS'   TO DP013-DB2-TABLE-NAME (1)       CL**5
102400                  SET DP013-DB2-ABEND                             CNKCS209
102500                      DP013-XCTL-DISPLAY-RESTART                  CNKCS209
102600                                   TO TRUE                        CNKCS209
102700                  PERFORM DP013-0000-PROCESS-ABEND                CNKCS209
102800         END-EVALUATE                                             CNKCS209
102900     END-PERFORM.                                                 CNKCS209
103000                                                                  CNKCS209
103100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
103200         MOVE '3020-COUNT-TDCTFAS'                                   CL**5
103300                                   TO DP013-PARAGRAPH             CNKCS209
103400         MOVE 'MAX RETRIES EXCEEDED FOR COUNT'                    CNKCS209
103500                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
103600         MOVE 'ON TABLE TDCTFAS '  TO DP013-MESSAGE-TEXT (2)         CL**5
103700         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
103800         SET DP013-DB2-ABEND                                      CNKCS209
103900             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
104000                                   TO TRUE                        CNKCS209
104100         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
104200     END-IF.                                                      CNKCS209
104300                                                                  CNKCS209
104400/                                                                 CNKCS209
104500*----------------------------------------------------------------*CNKCS209
104600*  RESET THE ATTRIBUTES OF ALL ENTERABLE FIELDS ON THE MAP.      *CNKCS209
104700*----------------------------------------------------------------*CNKCS209
104800                                                                  CNKCS209
104900 3200-RESET-ATTRIBUTES.                                           CNKCS209
105000                                                                  CNKCS209
105100     IF  ASC-ADD-PENDING                                          CNKCS209
105200         MOVE DP015-UNP-ALP-NOR-OFF TO ADEPTA                     CNKCS209
105300                                       ACLASA                     CNKCS209
105400                                       AFMTA                      CNKCS209
105500                                       ARANKA                     CNKCS209
105600         MOVE DP015-GREEN           TO ADEPTC                     CNKCS209
105700                                       ACLASC                     CNKCS209
105800                                       AFMTC                      CNKCS209
105900                                       ARANKC                     CNKCS209
106000         MOVE DP015-UNDERLINE       TO ADEPTH                     CNKCS209
106100                                       ACLASH                     CNKCS209
106200                                       AFMTH                      CNKCS209
106300                                       ARANKH                     CNKCS209
106400     ELSE                                                         CNKCS209
106500     IF  ASC-UPDATE-PENDING                                       CNKCS209
106600         MOVE DP015-PRO-NOR-OFF     TO ADEPTA                     CNKCS209
106700                                       ACLASA                     CNKCS209
106800                                       ARANKA                     CNKCS209
106900         MOVE DP015-UNP-ALP-NOR-OFF TO AFMTA                      CNKCS209
107000         MOVE DP015-BLUE            TO ADEPTC                     CNKCS209
107100                                       ACLASC                     CNKCS209
107200                                       ARANKC                     CNKCS209
107300         MOVE DP015-GREEN           TO AFMTC                      CNKCS209
107400         MOVE DP015-HL-OFF          TO ADEPTH                     CNKCS209
107500                                       ACLASH                     CNKCS209
107600                                       ARANKH                     CNKCS209
107700         MOVE DP015-UNDERLINE       TO AFMTH                      CNKCS209
107800     ELSE                                                         CNKCS209
107900     IF  ASC-DELETE-PENDING                                       CNKCS209
108000         MOVE DP015-PRO-NOR-OFF     TO ADEPTA                     CNKCS209
108100                                       ACLASA                     CNKCS209
108200                                       AFMTA                      CNKCS209
108300                                       ARANKA                     CNKCS209
108400         MOVE DP015-BLUE            TO ADEPTC                     CNKCS209
108500                                       ACLASC                     CNKCS209
108600                                       AFMTC                      CNKCS209
108700                                       ARANKC                     CNKCS209
108800         MOVE DP015-HL-OFF          TO ADEPTH                     CNKCS209
108900                                       ACLASH                     CNKCS209
109000                                       AFMTH                      CNKCS209
109100                                       ARANKH.                    CNKCS209
109200                                                                  CNKCS209
109300/                                                                 CNKCS209
109400*----------------------------------------------------------------*CNKCS209
109500*    VALIDATE THE QUEUE WAS PASSED AND DISPLAY FOR THE FIRST     *CNKCS209
109600*    ENTRY.                                                      *CNKCS209
109700*----------------------------------------------------------------*CNKCS209
109800                                                                  CNKCS209
109900 4000-BUILD-INITIAL-PANEL.                                        CNKCS209
110000                                                                  CNKCS209
110100     INITIALIZE DCLTDCTFAS                                           CL**5
110200                DCLTTKTFMT.                                          CL**5
110300                                                                  CNKCS209
110400     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
110500     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
110600     PERFORM 4200-GET-STORE-INFORMATION.                             CL**3
110700                                                                  CNKCS209
110800     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
110900     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
111000     MOVE ASC-DEPT-NBR             TO DK-DEPT-NBR.                   CL**3
111100     MOVE ASC-CL-NBR               TO DK-CL-NBR.                     CL**3
111200     MOVE ASC-RANK                 TO DK-RANK.                    CNKCS209
111300     PERFORM 4100-SELECT-TDCTFAS.                                    CL**5
111400                                                                  CNKCS209
111500     IF  DN-TKT-FMT-ID = -1                                          CL**3
111600         MOVE SPACES               TO ASC-FMT-ID                     CL**3
111700                                      ASC-DESC                    CNKCS209
111800     ELSE                                                         CNKCS209
111900         MOVE DCTFAS-TKT-FMT-ID TO ASC-FMT-ID                        CL**5
112000         MOVE ASC-FMT-ID           TO DK-TKT-FMT-ID                  CL**3
112100         PERFORM 4300-SELECT-TTKTFMT                                 CL**5
112200         MOVE TKTFMT-TKT-FMT-DESC                                    CL**5
112300                                   TO ASC-DESC                    CNKCS209
112400     END-IF.                                                      CNKCS209
112500                                                                  CNKCS209
112600     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN.                        CNKCS209
112700                                                                  CNKCS209
112800/                                                                 CNKCS209
112900*----------------------------------------------------------------*CNKCS209
113000* SELECT A ROW FROM THE DEPARTMENT/CLASS TICKET FORMAT TABLE     *CNKCS209
113100*----------------------------------------------------------------*CNKCS209
113200 4100-SELECT-TDCTFAS.                                                CL**5
113300                                                                  CNKCS209
113400     PERFORM                                                      CNKCS209
113500         WITH TEST AFTER                                          CNKCS209
113600         VARYING PV-RETRY-COUNTER                                 CNKCS209
113700         FROM 1 BY 1                                              CNKCS209
113800         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
113900            OR (SQLCODE = +0)                                     CNKCS209
114000            OR (SQLCODE = +100))                                  CNKCS209
114100                                                                  CNKCS209
114200         EXEC SQL                                                 CNKCS209
114300           SELECT  TKT_FMT_ID                                        CL**3
114400             INTO :DCTFAS-TKT-FMT-ID                                 CL**5
114500                    :DN-TKT-FMT-ID                                   CL**3
114600             FROM  TDCTFAS                                           CL**5
114700            WHERE  OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
114800              AND  FCLTY_ID    = :DK-FCLTY-ID                        CL**3
114900              AND  DEPT_NBR    = :DK-DEPT-NBR                        CL**3
115000              AND  CL_NBR      = :DK-CL-NBR                          CL**3
115100              AND  RANK_NBR    = :DK-RANK                            CL**3
115200         END-EXEC                                                 CNKCS209
115300                                                                  CNKCS209
115400         EVALUATE TRUE                                            CNKCS209
115500             WHEN SQLCODE = +0                                    CNKCS209
115600             WHEN SQLCODE = +100                                  CNKCS209
115700                 CONTINUE                                         CNKCS209
115800             WHEN SQLCODE = -904                                  CNKCS209
115900             WHEN SQLCODE = -913                                  CNKCS209
116000                 CONTINUE                                         CNKCS209
116100             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
116200             WHEN SQLCODE < ZERO                                  CNKCS209
116300             WHEN SQLCODE > ZERO                                  CNKCS209
116400                 MOVE '4100-SELECT-TDCTFAS'                          CL**5
116500                                   TO DP013-PARAGRAPH             CNKCS209
116600                 MOVE 'SELECT DEPT/CLASS TICKET FORMAT'           CNKCS209
116700                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
116800                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
116900                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
117000                 SET DP013-DB2-ABEND                              CNKCS209
117100                     DP013-XCTL-DISPLAY-RESTART                   CNKCS209
117200                                   TO TRUE                        CNKCS209
117300                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
117400         END-EVALUATE                                             CNKCS209
117500     END-PERFORM.                                                 CNKCS209
117600                                                                  CNKCS209
117700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
117800         MOVE '4100-SELECT-TDCTFAS'                                  CL**5
117900                                   TO DP013-PARAGRAPH             CNKCS209
118000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT'     CNKCS209
118100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
118200         MOVE 'ON TABLE TDCTFAS'   TO DP013-MESSAGE-TEXT (2)         CL**5
118300         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
118400         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
118500         SET DP013-DB2-ABEND                                      CNKCS209
118600             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
118700                                   TO TRUE                        CNKCS209
118800         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
118900     END-IF.                                                      CNKCS209
119000                                                                  CNKCS209
119100/                                                                 CNKCS209
190810                                                                  18470003
190820****************************************************************  18480003
190830*    THIS PARAGRAPH RETRIEVES THE STORE INFORMATION.           *  18490003
190840*                                                              *  18500003
190850****************************************************************  18510003
190860                                                                  18520003
190861 4200-GET-STORE-INFORMATION.                                      18530003
190880                                                                  18540003
190890     INITIALIZE XL071-COMMAREA.                                   18550003
190891     MOVE DK-OPER-UNT-ID TO XL071-LOCATION-NUMBER.                18560003
190892                                                                  18570003
190893     CALL XL071-LOCATION-MODULE USING                             18580003
190894                                DFHEIBLK                          18590003
190895                                XL071-COMMAREA                    18600003
190896                                XL071-COMMAREA-REC.               18610003
190897                                                                  18620003
190898     EVALUATE TRUE                                                18630003
190899         WHEN XL071-NO-ERRORS                                     18640003
190900         WHEN XL071-DC-ASGMT-NOT-FND                              18650003
190901              MOVE XL071-LOC-NM TO ASC-FCLTY-NME                  18660003
190903                                                                  18670003
190904         WHEN XL071-LOC-NOT-FOUND                                 18680003
190905              MOVE SPACES       TO ASC-FCLTY-NME                  18690003
190906                                                                  18700003
190907         WHEN OTHER                                               18710003
190908              MOVE '4200-GET-STORE-INFORMATION'                   18720003
190909                                  TO DP013-PARAGRAPH              18730003
190910              STRING 'SELECT STORE NUMBER - '                             
190911                      XL071-LOCATION-NUMBER                               
190912                     ' - BAD RETURN CODE FROM XLKUT071 - '                
190913                      XL071-RETURN-CODE                                   
190914                      DELIMITED BY SIZE                                   
190915                      INTO DP013-MESSAGE-TEXT (1)                         
190916              STRING 'BAD SQLCODE - '                                     
190917                      XL071-SQLCODE                                       
190918                     ' - '                                                
190919                      XL071-DB2-TABLE                                     
190920                      DELIMITED BY SIZE                                   
190921                      INTO DP013-MESSAGE-TEXT (2)                         
190922              MOVE XL071-SQLCA     TO DP013-SQLCA                         
190923              MOVE XL071-DB2-TABLE TO DP013-DB2-TABLE-NAME (1)            
190930              MOVE XL071-SQLCODE TO SQLCODE                       18800003
190933              SET DP013-DB2-ABEND                                 18830003
190934                  DP013-XCTL-DISPLAY-RESTART TO TRUE              18840003
190935              PERFORM DP013-0000-PROCESS-ABEND                    18850003
190936                                                                  18860003
190937     END-EVALUATE.                                                18870003
190938                                                                  CNKCS209
190939/                                                                 CNKCS209
190940*----------------------------------------------------------------*CNKCS209
190941*    READ TICKET FORMAT TABLE                                    *CNKCS209
190942*----------------------------------------------------------------*CNKCS209
190943 4300-SELECT-TTKTFMT.                                                CL**5
190944                                                                  CNKCS209
190945     PERFORM                                                      CNKCS209
190950         WITH TEST AFTER                                          CNKCS209
190960         VARYING PV-RETRY-COUNTER                                 CNKCS209
190970         FROM 1 BY 1                                              CNKCS209
190980         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
190990            OR  (SQLCODE = +0)                                    CNKCS209
191000            OR  (SQLCODE = +100))                                 CNKCS209
191100                                                                  CNKCS209
191200         EXEC SQL                                                 CNKCS209
191300             SELECT TKT_FMT_DESC                                     CL**3
191400              INTO :TKTFMT-TKT-FMT-DESC                              CL**5
191500              FROM TTKTFMT                                           CL**5
191600             WHERE  OPER_UNT_ID = :DK-OPER-UNT-ID                    CL**3
191700               AND  FCLTY_ID    = :DK-FCLTY-ID                       CL**3
191800               AND  TKT_FMT_ID  = :DK-TKT-FMT-ID                     CL**3
191900         END-EXEC                                                 CNKCS209
192000                                                                  CNKCS209
192100         EVALUATE TRUE                                            CNKCS209
192200             WHEN SQLCODE = +0                                    CNKCS209
192300             WHEN SQLCODE = +100                                  CNKCS209
192400             WHEN SQLCODE = -904                                  CNKCS209
192500             WHEN SQLCODE = -913                                  CNKCS209
192600                  CONTINUE                                        CNKCS209
192700             WHEN SQLWARN0 NOT = SPACE                            CNKCS209
192800             WHEN SQLCODE < +0                                    CNKCS209
192900             WHEN SQLCODE > +0                                    CNKCS209
193000                  MOVE '4300-SELECT-TTKTFMT'                         CL**5
193100                                   TO DP013-PARAGRAPH             CNKCS209
193200                  MOVE 'SELECT ON TTKTFMT'                           CL**5
193300                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
193400                  MOVE SQLCA       TO DP013-SQLCA                 CNKCS209
193500                  MOVE 'TTKTFMT'   TO DP013-DB2-TABLE-NAME (1)       CL**5
193600                  SET DP013-DB2-ABEND                             CNKCS209
193700                      DP013-XCTL-DISPLAY-RESTART                  CNKCS209
193800                                   TO TRUE                        CNKCS209
193900                  PERFORM DP013-0000-PROCESS-ABEND                CNKCS209
194000         END-EVALUATE                                             CNKCS209
194100     END-PERFORM.                                                 CNKCS209
194200                                                                  CNKCS209
194300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
194400         MOVE '4300-SELECT-TTKTFMT'                                  CL**5
194500                                   TO DP013-PARAGRAPH             CNKCS209
194600         MOVE 'MAX RETRIES EXCEEDED FOR SELECT'                   CNKCS209
194700                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
194800         MOVE 'ON TABLE TTKTFMT '  TO DP013-MESSAGE-TEXT (2)         CL**5
194900         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
195000         SET DP013-DB2-ABEND                                      CNKCS209
195100             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
195200                                   TO TRUE                        CNKCS209
195300         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
195400     END-IF.                                                      CNKCS209
195500                                                                  CNKCS209
195600/                                                                 CNKCS209
195700*----------------------------------------------------------------*CNKCS209
195800* MOVE THE DISPLAYED FIELDS FROM THE COMMAREA TO THE SCREEN.     *CNKCS209
195900*----------------------------------------------------------------*CNKCS209
196000                                                                  CNKCS209
196100 4400-MOVE-COMMAREA-TO-SCREEN.                                    CNKCS209
196200                                                                  CNKCS209
196300     MOVE ASC-OPER-UNT-ID          TO AOPERO.                        CL**3
196400     MOVE ASC-FCLTY-ID             TO AFCLTYO.                       CL**3
196500     MOVE ASC-FCLTY-NME            TO AFDESCO.                       CL**3
196600     MOVE ASC-DEPT-NBR             TO ADEPTO.                        CL**3
196700     MOVE ASC-CL-NBR               TO ACLASO.                        CL**3
196800     MOVE ASC-FMT-ID               TO AFMTO.                         CL**3
196900     MOVE ASC-RANK                 TO ARANKO.                     CNKCS209
197000     MOVE ASC-DESC                 TO ADESCO.                     CNKCS209
197100                                                                  CNKCS209
197200     IF ASC-UPDATE-PENDING                                        CNKCS209
197300        MOVE -1                    TO AFMTL                       CNKCS209
197400        SET DP030-SET-CURSOR-APPL-1                               CNKCS209
197500                                   TO TRUE                        CNKCS209
197600     END-IF.                                                      CNKCS209
197700                                                                  CNKCS209
197800/                                                                 CNKCS209
197900*----------------------------------------------------------------*CNKCS209
198000* ADD A ROW TO THE DEPARTMENT/CLASS TICKET FORMAT TABLE          *CNKCS209
198100*----------------------------------------------------------------*CNKCS209
198200 5000-ADD-ASSIGNMENT.                                             CNKCS209
198300                                                                  CNKCS209
198400     INITIALIZE DCLTDCTFAS.                                          CL**5
198500                                                                  CNKCS209
198600     IF  ASC-FMT-ID = SPACES                                         CL**3
198700         MOVE -1                   TO DN-TKT-FMT-ID                  CL**3
198800     ELSE                                                         CNKCS209
198900         MOVE +1                   TO DN-TKT-FMT-ID                  CL**3
199000     END-IF.                                                      CNKCS209
199100                                                                  CNKCS209
199200     MOVE ASC-RANK-N               TO DK-RANK.                    CNKCS209
199300                                                                  CNKCS209
199400     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
199500     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
199600                                                                     CL**3
199700     PERFORM 5100-INSERT-TDCTFAS.                                    CL**5
199800                                                                  CNKCS209
199900     IF  SQLCODE = +0                                             CNKCS209
200000         MOVE PC-TSYMSG-00034      TO DP020-MSG-NUMBER            CNKCS209
200100         SET DP020-MSG-INFORMATIONAL                              CNKCS209
200200             ASC-ADD-SUCCESSFUL    TO TRUE                        CNKCS209
200300         IF  ASC-USE-SELECTION-QUEUE                              CNKCS209
200400             PERFORM 5200-UPDATE-SELECTION-QUEUE                  CNKCS209
200500         END-IF                                                   CNKCS209
200600     ELSE                                                         CNKCS209
200700         IF  SQLCODE = -803                                       CNKCS209
200800             SET PS-ERROR          TO TRUE                        CNKCS209
200900             SET DP020-MSG-FATAL   TO TRUE                        CNKCS209
201000             MOVE PC-TSYMSG-00117  TO DP020-MSG-NUMBER            CNKCS209
201100             MOVE DP015-UNP-ALP-BRT-OFF                           CNKCS209
201200                                   TO ADEPTA                      CNKCS209
201300                                      ACLASA                      CNKCS209
201400                                      ARANKA                      CNKCS209
201500             MOVE DP015-RED        TO ADEPTC                      CNKCS209
201600                                      ACLASC                      CNKCS209
201700                                      ARANKC                      CNKCS209
201800             MOVE DP015-REVERSE    TO ADEPTH                      CNKCS209
201900                                      ACLASH                      CNKCS209
202000                                      ARANKH                      CNKCS209
202100             MOVE -1               TO ARANKL                      CNKCS209
202200             SET DP030-SET-CURSOR-APPL-1                          CNKCS209
202300                                   TO TRUE                        CNKCS209
202400         END-IF                                                   CNKCS209
202500     END-IF.                                                      CNKCS209
202600                                                                  CNKCS209
202700/                                                                 CNKCS209
202800*----------------------------------------------------------------*CNKCS209
202900*  INSERT A ROW ON THE DEPARTMENT/CLASS TICKET FORMAT TABLE.     *CNKCS209
203000*----------------------------------------------------------------*CNKCS209
203100 5100-INSERT-TDCTFAS.                                                CL**5
203200                                                                  CNKCS209
203300     PERFORM                                                      CNKCS209
203400         WITH TEST AFTER                                          CNKCS209
203500         VARYING PV-RETRY-COUNTER                                 CNKCS209
203600         FROM 1 BY 1                                              CNKCS209
203700         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
203800             OR (SQLCODE = +0)                                    CNKCS209
203900             OR (SQLCODE = -803))                                 CNKCS209
204000                                                                  CNKCS209
204100         EXEC SQL                                                 CNKCS209
204200             INSERT  INTO TDCTFAS                                    CL**5
204300                    (OPER_UNT_ID                                     CL**3
204400                    ,FCLTY_ID                                        CL**3
204500                    ,DEPT_NBR                                     CNKCS209
204600                    ,CL_NBR                                          CL**3
204700                    ,RANK_NBR                                     CNKCS209
204800                    ,TKT_FMT_ID)                                     CL**3
204900            VALUES  (:DK-OPER-UNT-ID                                 CL**3
205000                    ,:DK-FCLTY-ID                                    CL**3
205100                    ,:ASC-DEPT-NBR                                   CL**3
205200                    ,:ASC-CL-NBR                                     CL**3
205300                    ,:DK-RANK                                     CNKCS209
205400                    ,:ASC-FMT-ID                                     CL**3
205500                       :DN-TKT-FMT-ID)                               CL**3
205600         END-EXEC                                                 CNKCS209
205700                                                                  CNKCS209
205800         EVALUATE TRUE                                            CNKCS209
205900             WHEN SQLCODE = +0                                    CNKCS209
206000             WHEN SQLCODE = -803                                  CNKCS209
206100             WHEN SQLCODE = -904                                  CNKCS209
206200             WHEN SQLCODE = -913                                  CNKCS209
206300                 CONTINUE                                         CNKCS209
206400             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
206500             WHEN SQLCODE < +0                                    CNKCS209
206600             WHEN SQLCODE > +0                                    CNKCS209
206700                 MOVE '5100-INSERT-TDCTFAS'                          CL**5
206800                                   TO DP013-PARAGRAPH             CNKCS209
206900                 MOVE 'INSERT A ROW ON TDCTFAS'                      CL**5
207000                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
207100                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
207200                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
207300                 SET DP013-DB2-ABEND                              CNKCS209
207400                     DP013-XCTL-DISPLAY-RESTART TO TRUE           CNKCS209
207500                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
207600         END-EVALUATE                                             CNKCS209
207700     END-PERFORM.                                                 CNKCS209
207800                                                                  CNKCS209
207900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
208000         MOVE '5100-INSERT-TDCTFAS'                                  CL**5
208100                                   TO DP013-PARAGRAPH             CNKCS209
208200         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              CNKCS209
208300                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
208400         MOVE 'TO INSERT A TDCTFAS ROW'                              CL**5
208500                                   TO DP013-MESSAGE-TEXT (2)      CNKCS209
208600         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
208700         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
208800         SET DP013-DB2-ABEND                                      CNKCS209
208900             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
209000                                   TO TRUE                        CNKCS209
209100         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
209200     END-IF.                                                      CNKCS209
209300                                                                  CNKCS209
209400/                                                                 CNKCS209
209500*----------------------------------------------------------------*CNKCS209
209600* RECORD IN THE SELECTION TEMP STORAGE QUEUE THE FACT THAT THIS  *CNKCS209
209700* OBJECT WAS UDPATED.                                            *CNKCS209
209800*----------------------------------------------------------------*CNKCS209
209900                                                                  CNKCS209
210000 5200-UPDATE-SELECTION-QUEUE.                                     CNKCS209
210100                                                                  CNKCS209
210200     PERFORM 9100-READ-SEL-QUEUE.                                 CNKCS209
210300                                                                  CNKCS209
210400     IF  ASC-DELETE-SUCCESSFUL                                    CNKCS209
210500         SET CN006-DEL (ASC-SEL-SUB)                              CNKCS209
210600                                   TO TRUE                        CNKCS209
210700     ELSE                                                         CNKCS209
210800         SET CN006-UPD (ASC-SEL-SUB)                              CNKCS209
210900                                   TO TRUE                        CNKCS209
211000     END-IF.                                                      CNKCS209
211100                                                                  CNKCS209
211200     PERFORM 9200-REWRITE-LIST-QUEUE.                             CNKCS209
211300                                                                  CNKCS209
211400/                                                                 CNKCS209
211500*----------------------------------------------------------------*CNKCS209
211600* ASSIGN THE FORMAT TO THE SELECTED ROW.                         *CNKCS209
211700*----------------------------------------------------------------*CNKCS209
211800 6000-UPDATE-ASSIGNMENT.                                          CNKCS209
211900                                                                  CNKCS209
212000     IF  ASC-FMT-ID = SPACES                                         CL**3
212100         MOVE -1                   TO DN-TKT-FMT-ID                  CL**3
212200     ELSE                                                         CNKCS209
212300         MOVE +1                   TO DN-TKT-FMT-ID                  CL**3
212400     END-IF.                                                      CNKCS209
212500                                                                  CNKCS209
212600     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
212700     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
212800     MOVE ASC-DEPT-NBR             TO DK-DEPT-NBR.                   CL**3
212900     MOVE ASC-CL-NBR               TO DK-CL-NBR.                     CL**3
213000     MOVE ASC-RANK                 TO DK-RANK.                    CNKCS209
213100                                                                  CNKCS209
213200     PERFORM 6100-UPDATE-TDCTFAS.                                    CL**5
213300                                                                  CNKCS209
213400     MOVE PC-TSYMSG-00059          TO DP020-MSG-NUMBER.           CNKCS209
213500     SET DP020-MSG-INFORMATIONAL   TO TRUE.                       CNKCS209
213600                                                                  CNKCS209
213700     IF  ASC-USE-SELECTION-QUEUE                                  CNKCS209
213800         PERFORM 5200-UPDATE-SELECTION-QUEUE                      CNKCS209
213900     END-IF.                                                      CNKCS209
214000                                                                  CNKCS209
214100/                                                                 CNKCS209
214200*----------------------------------------------------------------*CNKCS209
214300*  UPDATE THE ROW ON THE DEPT/CLASS TICKET FORMAT TABLE.         *CNKCS209
214400*----------------------------------------------------------------*CNKCS209
214500 6100-UPDATE-TDCTFAS.                                                CL**5
214600                                                                  CNKCS209
214700     PERFORM                                                      CNKCS209
214800         WITH TEST AFTER                                          CNKCS209
214900         VARYING PV-RETRY-COUNTER                                 CNKCS209
215000         FROM 1 BY 1                                              CNKCS209
215100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
215200             OR (SQLCODE = +0))                                   CNKCS209
215300                                                                  CNKCS209
215400         EXEC SQL                                                 CNKCS209
215500             UPDATE TDCTFAS                                          CL**5
215600               SET  TKT_FMT_ID = :ASC-FMT-ID                         CL**3
215700                                   :DN-TKT-FMT-ID                    CL**3
215800              WHERE  OPER_UNT_ID = :DK-OPER-UNT-ID                   CL**3
215900                AND  FCLTY_ID    = :DK-FCLTY-ID                      CL**3
216000                AND  DEPT_NBR    = :DK-DEPT-NBR                      CL**3
216100                AND  CL_NBR      = :DK-CL-NBR                        CL**3
216200                AND  RANK_NBR    = :DK-RANK                          CL**3
216300         END-EXEC                                                 CNKCS209
216400                                                                  CNKCS209
216500         EVALUATE TRUE                                            CNKCS209
216600             WHEN SQLCODE = +0                                    CNKCS209
216700             WHEN SQLCODE = -904                                  CNKCS209
216800             WHEN SQLCODE = -913                                  CNKCS209
216900                 CONTINUE                                         CNKCS209
217000             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
217100             WHEN SQLCODE < +0                                    CNKCS209
217200             WHEN SQLCODE > +0                                    CNKCS209
217300                 MOVE '6100-UPDATE-TDCTFAS'                          CL**5
217400                                   TO DP013-PARAGRAPH             CNKCS209
217500                 MOVE 'UPDATE A ROW ON TDCTFAS'                      CL**5
217600                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
217700                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
217800                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
217900                 SET DP013-DB2-ABEND                              CNKCS209
218000                     DP013-XCTL-DISPLAY-RESTART TO TRUE           CNKCS209
218100                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
218200         END-EVALUATE                                             CNKCS209
218300     END-PERFORM.                                                 CNKCS209
218400                                                                  CNKCS209
218500     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
218600         MOVE '6100-UPDATE-TDCTFAS'                                  CL**5
218700                                   TO DP013-PARAGRAPH             CNKCS209
218800         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              CNKCS209
218900                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
219000         MOVE 'TO UPDATE A TDCTFAS ROW'                              CL**5
219100                                   TO DP013-MESSAGE-TEXT (2)      CNKCS209
219200         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
219300         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
219400         SET DP013-DB2-ABEND                                      CNKCS209
219500             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
219600                                   TO TRUE                        CNKCS209
219700         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
219800     END-IF.                                                      CNKCS209
219900                                                                  CNKCS209
220000/                                                                 CNKCS209
220100*----------------------------------------------------------------*CNKCS209
220200*    CHECK TO SEE IF THERE ARE ANY OTHER ASSIGNMENTS ASSIGNED    *CNKCS209
220300*    FOR A GIVEN DEPT/CLASS WITHIN A FACILITY. IF SO, THE ROW    *CNKCS209
220400*    MAY BE DELETED. OTHERWISE, SET THE FORMAT ID TO NULL AND    *CNKCS209
220500*    UPDATE.                                                     *CNKCS209
220600*    IF THE ROW WAS DELETED, THE REMAINING ROWS MUST BE RE-RANKED*CNKCS209
220700*    IN ASCENDING RANK SEQEUNCE.                                 *CNKCS209
220800*----------------------------------------------------------------*CNKCS209
220900                                                                  CNKCS209
221000 7000-DELETE-ASSIGNMENT.                                          CNKCS209
221100                                                                  CNKCS209
221200     MOVE ASC-OPER-UNT-ID          TO DK-OPER-UNT-ID.                CL**3
221300     MOVE ASC-FCLTY-ID             TO DK-FCLTY-ID.                   CL**3
221400     MOVE ASC-DEPT-NBR             TO DK-DEPT-NBR.                   CL**3
221500     MOVE ASC-CL-NBR               TO DK-CL-NBR.                     CL**3
221600     MOVE ASC-RANK                 TO DK-RANK.                    CNKCS209
221700                                                                  CNKCS209
221800     INITIALIZE PV-DB2-COUNT.                                     CNKCS209
221900     PERFORM 7100-COUNT-TDCTFAS.                                     CL**5
222000                                                                  CNKCS209
222100     IF PV-DB2-COUNT > +1                                         CNKCS209
222200        PERFORM 7200-DELETE-TDCTFAS                                  CL**5
222300        MOVE 1                     TO PV-RANK-NBR                 CNKCS209
222400        MOVE SPACES                TO PV-HOLD-TDCTFAS                CL**5
222500        MOVE 'N'                   TO PS-EOF-TDCTFAS-CSR-SW          CL**5
222600        PERFORM 7400-OPEN-TDCTFAS                                    CL**5
222700        PERFORM 7500-FETCH-TDCTFAS                                   CL**5
222800        PERFORM UNTIL PS-EOF-TDCTFAS-CSR                             CL**5
222900           IF DCTFAS-RANK-NBR = PV-RANK-NBR                          CL**5
223000              CONTINUE                                            CNKCS209
223100           ELSE                                                   CNKCS209
223200              MOVE DCTFAS-FCLTY-ID                                   CL**5
223300                                   TO DK-FCLTY-ID                    CL**3
223400              MOVE DCTFAS-DEPT-NBR TO DK-DEPT-NBR                    CL**5
223500              MOVE DCTFAS-CL-NBR                                     CL**5
223600                                   TO DK-CL-NBR                      CL**3
223700              MOVE DCTFAS-RANK-NBR TO DK-RANK                        CL**5
223800              PERFORM 7200-DELETE-TDCTFAS                            CL**5
223900              MOVE PV-HOLD-TDCTFAS TO DCLTDCTFAS                     CL**5
224000              MOVE PV-RANK-NBR     TO DCTFAS-RANK-NBR                CL**5
224100              IF  DCTFAS-TKT-FMT-ID = SPACES                         CL**5
224200                  MOVE -1          TO DN-TKT-FMT-ID                  CL**3
224300              ELSE                                                CNKCS209
224400                  MOVE +1          TO DN-TKT-FMT-ID                  CL**3
224500              END-IF                                              CNKCS209
224600              PERFORM 7600-INSERT-TDCTFAS                            CL**5
224700           END-IF                                                 CNKCS209
224800           PERFORM 7500-FETCH-TDCTFAS                                CL**5
224900           ADD  1                  TO PV-RANK-NBR                 CNKCS209
225000        END-PERFORM                                               CNKCS209
225100        PERFORM 7700-CLOSE-TDCTFAS                                   CL**5
225200     ELSE                                                         CNKCS209
225300        MOVE -1                    TO DN-TKT-FMT-ID                  CL**3
225400        PERFORM 7300-UPDATE-TDCTFAS                                  CL**5
225500     END-IF.                                                      CNKCS209
225600                                                                  CNKCS209
225700     MOVE PC-TSYMSG-00115          TO DP020-MSG-NUMBER.           CNKCS209
225800     SET DP020-MSG-INFORMATIONAL                                  CNKCS209
225900         ASC-DELETE-SUCCESSFUL     TO TRUE.                       CNKCS209
226000                                                                  CNKCS209
226100     IF  ASC-USE-SELECTION-QUEUE                                  CNKCS209
226200         PERFORM 5200-UPDATE-SELECTION-QUEUE                      CNKCS209
226300     END-IF.                                                      CNKCS209
226400                                                                  CNKCS209
226500/                                                                 CNKCS209
226600*----------------------------------------------------------------*CNKCS209
226700*    CHECK TO SEE IF HOW MANY ROWS ARE ASSIGNED TO THIS          *CNKCS209
226800*    DEPT/CLASS FOR THIS TICKET FORMAT                           *CNKCS209
226900*----------------------------------------------------------------*CNKCS209
227000                                                                  CNKCS209
227100 7100-COUNT-TDCTFAS.                                                 CL**5
227200                                                                  CNKCS209
227300     PERFORM                                                      CNKCS209
227400         WITH TEST AFTER                                          CNKCS209
227500         VARYING PV-RETRY-COUNTER                                 CNKCS209
227600         FROM 1 BY 1                                              CNKCS209
227700         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
227800            OR  (SQLCODE = +0)                                    CNKCS209
227900            OR  (SQLCODE = +100))                                 CNKCS209
228000                                                                  CNKCS209
228100         EXEC SQL                                                 CNKCS209
228200             SELECT COUNT(*)                                      CNKCS209
228300              INTO :PV-DB2-COUNT                                  CNKCS209
228400              FROM TDCTFAS                                           CL**5
228500             WHERE OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
228600               AND FCLTY_ID    = :DK-FCLTY-ID                        CL**3
228700               AND DEPT_NBR    = :DK-DEPT-NBR                        CL**3
228800               AND CL_NBR      = :DK-CL-NBR                          CL**3
228900         END-EXEC                                                 CNKCS209
229000                                                                  CNKCS209
229100         EVALUATE TRUE                                            CNKCS209
229200             WHEN SQLCODE = +0                                    CNKCS209
229300             WHEN SQLCODE = +100                                  CNKCS209
229400             WHEN SQLCODE = -904                                  CNKCS209
229500             WHEN SQLCODE = -913                                  CNKCS209
229600                  CONTINUE                                        CNKCS209
229700             WHEN SQLWARN0 NOT = SPACE                            CNKCS209
229800             WHEN SQLCODE < +0                                    CNKCS209
229900             WHEN SQLCODE > +0                                    CNKCS209
230000                  MOVE '7100-COUNT-TDCTFAS'                          CL**5
230100                                   TO DP013-PARAGRAPH             CNKCS209
230200                  MOVE 'COUNT ON TDCTFAS'                            CL**5
230300                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
230400                  MOVE SQLCA       TO DP013-SQLCA                 CNKCS209
230500                  MOVE 'TDCTFAS'   TO DP013-DB2-TABLE-NAME (1)       CL**5
230600                  SET DP013-DB2-ABEND                             CNKCS209
230700                      DP013-XCTL-DISPLAY-RESTART                  CNKCS209
230800                                   TO TRUE                        CNKCS209
230900                  PERFORM DP013-0000-PROCESS-ABEND                CNKCS209
231000         END-EVALUATE                                             CNKCS209
231100     END-PERFORM.                                                 CNKCS209
231200                                                                  CNKCS209
231300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
231400         MOVE '7100-COUNT-TDCTFAS'                                   CL**5
231500                                   TO DP013-PARAGRAPH             CNKCS209
231600         MOVE 'MAX RETRIES EXCEEDED FOR COUNT'                    CNKCS209
231700                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
231800         MOVE 'ON TABLE TDCTFAS '  TO DP013-MESSAGE-TEXT (2)         CL**5
231900         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
232000         SET DP013-DB2-ABEND                                      CNKCS209
232100             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
232200                                   TO TRUE                        CNKCS209
232300         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
232400     END-IF.                                                      CNKCS209
232500                                                                  CNKCS209
232600/                                                                 CNKCS209
232700*----------------------------------------------------------------*CNKCS209
232800*  DELETE THE ROW ON THE DEPARTMENT/CLASS TICKET FORMAT TABLE    *CNKCS209
232900*----------------------------------------------------------------*CNKCS209
233000 7200-DELETE-TDCTFAS.                                                CL**5
233100                                                                  CNKCS209
233200     PERFORM                                                      CNKCS209
233300         WITH TEST AFTER                                          CNKCS209
233400         VARYING PV-RETRY-COUNTER                                 CNKCS209
233500         FROM 1 BY 1                                              CNKCS209
233600         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
233700             OR (SQLCODE = +0))                                   CNKCS209
233800                                                                  CNKCS209
233900         EXEC SQL                                                 CNKCS209
234000             DELETE FROM TDCTFAS                                     CL**5
234100             WHERE OPER_UNT_ID = :DK-OPER-UNT-ID                     CL**3
234200               AND FCLTY_ID    = :DK-FCLTY-ID                        CL**3
234300               AND DEPT_NBR    = :DK-DEPT-NBR                        CL**3
234400               AND CL_NBR      = :DK-CL-NBR                          CL**3
234500               AND RANK_NBR    = :DK-RANK                            CL**3
234600         END-EXEC                                                 CNKCS209
234700                                                                  CNKCS209
234800         EVALUATE TRUE                                            CNKCS209
234900             WHEN SQLCODE = +0                                    CNKCS209
235000             WHEN SQLCODE = -904                                  CNKCS209
235100             WHEN SQLCODE = -913                                  CNKCS209
235200                 CONTINUE                                         CNKCS209
235300             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
235400             WHEN SQLCODE < +0                                    CNKCS209
235500             WHEN SQLCODE > +0                                    CNKCS209
235600                 MOVE '7200-DELETE-TDCTFAS'                          CL**5
235700                                   TO DP013-PARAGRAPH             CNKCS209
235800                 MOVE 'DELETE ROW ON TDCTFAS'                        CL**5
235900                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
236000                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
236100                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
236200                 SET DP013-DB2-ABEND                              CNKCS209
236300                     DP013-XCTL-DISPLAY-RESTART TO TRUE           CNKCS209
236400                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
236500         END-EVALUATE                                             CNKCS209
236600     END-PERFORM.                                                 CNKCS209
236700                                                                  CNKCS209
236800     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
236900         MOVE '7200-DELETE-TDCTFAS'                                  CL**5
237000                                   TO DP013-PARAGRAPH             CNKCS209
237100         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              CNKCS209
237200                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
237300         MOVE 'TO DELETE TDCTFAS ROW'                                CL**5
237400                                   TO DP013-MESSAGE-TEXT (2)      CNKCS209
237500         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
237600         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
237700         SET DP013-DB2-ABEND                                      CNKCS209
237800             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
237900                                   TO TRUE                        CNKCS209
238000         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
238100     END-IF.                                                      CNKCS209
238200                                                                  CNKCS209
238300/                                                                 CNKCS209
238400*----------------------------------------------------------------*CNKCS209
238500*  UPDATE THE ROW ON THE DEPARTMENT/CLASS TICKET FORMAT TABLE    *CNKCS209
238600*----------------------------------------------------------------*CNKCS209
238700 7300-UPDATE-TDCTFAS.                                                CL**5
238800                                                                  CNKCS209
238900     PERFORM                                                      CNKCS209
239000         WITH TEST AFTER                                          CNKCS209
239100         VARYING PV-RETRY-COUNTER                                 CNKCS209
239200         FROM 1 BY 1                                              CNKCS209
239300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
239400             OR (SQLCODE = +0))                                   CNKCS209
239500                                                                  CNKCS209
239600         EXEC SQL                                                 CNKCS209
239700             UPDATE TDCTFAS                                          CL**5
239800               SET  TKT_FMT_ID = :DCTFAS-TKT-FMT-ID                  CL**5
239900                                   :DN-TKT-FMT-ID                    CL**3
240000               WHERE OPER_UNT_ID = :DK-OPER-UNT-ID                   CL**3
240100                 AND FCLTY_ID    = :DK-FCLTY-ID                      CL**3
240200                 AND DEPT_NBR    = :DK-DEPT-NBR                      CL**3
240300                 AND CL_NBR      = :DK-CL-NBR                        CL**3
240400                 AND RANK_NBR    = :DK-RANK                          CL**3
240500         END-EXEC                                                 CNKCS209
240600                                                                  CNKCS209
240700         EVALUATE TRUE                                            CNKCS209
240800             WHEN SQLCODE = +0                                    CNKCS209
240900             WHEN SQLCODE = -904                                  CNKCS209
241000             WHEN SQLCODE = -913                                  CNKCS209
241100                 CONTINUE                                         CNKCS209
241200             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
241300             WHEN SQLCODE < +0                                    CNKCS209
241400             WHEN SQLCODE > +0                                    CNKCS209
241500                 MOVE '7300-UPDATE-TDCTFAS'                          CL**5
241600                                   TO DP013-PARAGRAPH             CNKCS209
241700                 MOVE 'UPDATE ROW ON TDCTFAS'                        CL**5
241800                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
241900                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
242000                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
242100                 SET DP013-DB2-ABEND                              CNKCS209
242200                     DP013-XCTL-DISPLAY-RESTART TO TRUE           CNKCS209
242300                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
242400         END-EVALUATE                                             CNKCS209
242500     END-PERFORM.                                                 CNKCS209
242600                                                                  CNKCS209
242700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
242800         MOVE '7300-UPDATE-TDCTFAS'                                  CL**5
242900                                   TO DP013-PARAGRAPH             CNKCS209
243000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              CNKCS209
243100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
243200         MOVE 'TO UPDATE TDCTFAS ROW'                                CL**5
243300                                   TO DP013-MESSAGE-TEXT (2)      CNKCS209
243400         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
243500         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
243600         SET DP013-DB2-ABEND                                      CNKCS209
243700             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
243800                                   TO TRUE                        CNKCS209
243900         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
244000     END-IF.                                                      CNKCS209
244100                                                                  CNKCS209
244200/                                                                 CNKCS209
244300*----------------------------------------------------------------*CNKCS209
244400*  OPEN CURSOR ON TABLE TDCTFAS TO SELECT ALL COLUMNS            *   CL**5
244500*----------------------------------------------------------------*CNKCS209
244600 7400-OPEN-TDCTFAS.                                                  CL**5
244700                                                                  CNKCS209
244800     PERFORM                                                      CNKCS209
244900         WITH TEST AFTER                                          CNKCS209
245000         VARYING PV-RETRY-COUNTER                                 CNKCS209
245100         FROM 1 BY 1                                              CNKCS209
245200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
245300            OR (SQLCODE = +0))                                    CNKCS209
245400                                                                  CNKCS209
245500         EXEC SQL                                                 CNKCS209
245600             OPEN TDCTFAS-CSR                                        CL**5
245700         END-EXEC                                                 CNKCS209
245800                                                                  CNKCS209
245900         EVALUATE TRUE                                            CNKCS209
246000             WHEN SQLCODE = +0                                    CNKCS209
246100                  CONTINUE                                        CNKCS209
246200             WHEN SQLCODE = -904                                  CNKCS209
246300             WHEN SQLCODE = -913                                  CNKCS209
246400                  CONTINUE                                        CNKCS209
246500             WHEN SQLWARN0 NOT = SPACE                            CNKCS209
246600             WHEN SQLCODE  NOT = +0                               CNKCS209
246700                  MOVE '7400-OPEN-TDCTFAS'                           CL**5
246800                                   TO DP013-PARAGRAPH             CNKCS209
246900                  MOVE 'OPEN TDCTFAS-CSR CURSOR'                     CL**5
247000                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
247100                  MOVE SQLCA       TO DP013-SQLCA                 CNKCS209
247200                  MOVE 'TDCTFAS'   TO DP013-DB2-TABLE-NAME (1)       CL**5
247300                  SET DP013-DB2-ABEND                             CNKCS209
247400                                   TO TRUE                        CNKCS209
247500                  PERFORM DP013-0000-PROCESS-ABEND                CNKCS209
247600         END-EVALUATE                                             CNKCS209
247700     END-PERFORM.                                                 CNKCS209
247800                                                                  CNKCS209
247900     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
248000         MOVE '7400-OPEN-TDCTFAS'  TO DP013-PARAGRAPH                CL**5
248100         MOVE 'MAX RETRIES EXCEEDED FOR OPEN CURSOR'              CNKCS209
248200                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
248300         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
248400         SET DP013-DB2-ABEND       TO TRUE                        CNKCS209
248500         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
248600     END-IF.                                                      CNKCS209
248700                                                                  CNKCS209
248800/                                                                 CNKCS209
248900*----------------------------------------------------------------*CNKCS209
249000*    FETCH A ROW                                                 *CNKCS209
249100*----------------------------------------------------------------*CNKCS209
249200                                                                  CNKCS209
249300 7500-FETCH-TDCTFAS.                                                 CL**5
249400                                                                  CNKCS209
249500     EXEC SQL                                                     CNKCS209
249600         FETCH TDCTFAS-CSR                                           CL**5
249700          INTO :DCTFAS-OPER-UNT-ID                                   CL**5
249800              ,:DCTFAS-FCLTY-ID                                      CL**5
249900              ,:DCTFAS-DEPT-NBR                                      CL**5
250000              ,:DCTFAS-CL-NBR                                        CL**5
250100              ,:DCTFAS-RANK-NBR                                      CL**5
250200              ,:DCTFAS-TKT-FMT-ID                                    CL**5
250300                 :DN-TKT-FMT-ID                                      CL**3
250400     END-EXEC.                                                    CNKCS209
250500                                                                  CNKCS209
250600     EVALUATE TRUE                                                CNKCS209
250700         WHEN SQLCODE = +0                                        CNKCS209
250800              MOVE DCLTDCTFAS      TO PV-HOLD-TDCTFAS                CL**5
250900         WHEN SQLCODE = +100                                      CNKCS209
251000              SET PS-EOF-TDCTFAS-CSR                                 CL**5
251100                                   TO TRUE                        CNKCS209
251200         WHEN SQLWARN0 NOT = SPACE                                CNKCS209
251300         WHEN SQLCODE < +0                                        CNKCS209
251400         WHEN SQLCODE > +0                                        CNKCS209
251500              MOVE '7700-FETCH-TDCTFAS'                              CL**5
251600                                   TO DP013-PARAGRAPH             CNKCS209
251700              MOVE 'FETCH TDCTFAS CURSOR'                            CL**5
251800                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
251900              MOVE SQLCA           TO DP013-SQLCA                 CNKCS209
252000              MOVE 'TDCTFAS'       TO DP013-DB2-TABLE-NAME (1)       CL**5
252100              SET DP013-DB2-ABEND  TO TRUE                        CNKCS209
252200              PERFORM DP013-0000-PROCESS-ABEND                    CNKCS209
252300     END-EVALUATE.                                                CNKCS209
252400                                                                  CNKCS209
252500/                                                                 CNKCS209
252600*----------------------------------------------------------------*CNKCS209
252700*  INSERT A ROW ON THE DEPARTMENT/CLASS TICKET FORMTAT TABLE     *CNKCS209
252800*----------------------------------------------------------------*CNKCS209
252900 7600-INSERT-TDCTFAS.                                                CL**5
253000                                                                  CNKCS209
253100     PERFORM                                                      CNKCS209
253200         WITH TEST AFTER                                          CNKCS209
253300         VARYING PV-RETRY-COUNTER                                 CNKCS209
253400         FROM 1 BY 1                                              CNKCS209
253500         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               CNKCS209
253600             OR (SQLCODE = +0)                                    CNKCS209
253700             OR (SQLCODE = -803))                                 CNKCS209
253800                                                                  CNKCS209
253900         EXEC SQL                                                 CNKCS209
254000             INSERT  INTO TDCTFAS                                    CL**5
254100                    (OPER_UNT_ID                                     CL**3
254200                    ,FCLTY_ID                                        CL**3
254300                    ,DEPT_NBR                                     CNKCS209
254400                    ,CL_NBR                                          CL**3
254500                    ,RANK_NBR                                     CNKCS209
254600                    ,TKT_FMT_ID)                                     CL**3
254700            VALUES  (:DCTFAS-OPER-UNT-ID                             CL**5
254800                    ,:DCTFAS-FCLTY-ID                                CL**5
254900                    ,:DCTFAS-DEPT-NBR                                CL**5
255000                    ,:DCTFAS-CL-NBR                                  CL**5
255100                    ,:DCTFAS-RANK-NBR                                CL**5
255200                    ,:DCTFAS-TKT-FMT-ID                              CL**5
255300                       :DN-TKT-FMT-ID)                               CL**3
255400         END-EXEC                                                 CNKCS209
255500                                                                  CNKCS209
255600         EVALUATE TRUE                                            CNKCS209
255700             WHEN SQLCODE = +0                                    CNKCS209
255800             WHEN SQLCODE = -803                                  CNKCS209
255900             WHEN SQLCODE = -904                                  CNKCS209
256000             WHEN SQLCODE = -913                                  CNKCS209
256100                 CONTINUE                                         CNKCS209
256200             WHEN SQLWARN0 NOT = SPACES                           CNKCS209
256300             WHEN SQLCODE < +0                                    CNKCS209
256400             WHEN SQLCODE > +0                                    CNKCS209
256500                 MOVE '7600-INSERT-TDCTFAS'                          CL**5
256600                                   TO DP013-PARAGRAPH             CNKCS209
256700                 MOVE 'INSERT A ROW ON TDCTFAS'                      CL**5
256800                                   TO DP013-MESSAGE-TEXT(1)       CNKCS209
256900                 MOVE SQLCA        TO DP013-SQLCA                 CNKCS209
257000                 MOVE 'TDCTFAS'    TO DP013-DB2-TABLE-NAME (1)       CL**5
257100                 SET DP013-DB2-ABEND                              CNKCS209
257200                     DP013-XCTL-DISPLAY-RESTART TO TRUE           CNKCS209
257300                 PERFORM DP013-0000-PROCESS-ABEND                 CNKCS209
257400         END-EVALUATE                                             CNKCS209
257500     END-PERFORM.                                                 CNKCS209
257600                                                                  CNKCS209
257700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        CNKCS209
257800         MOVE '7600-INSERT-TDCTFAS'                                  CL**5
257900                                   TO DP013-PARAGRAPH             CNKCS209
258000         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING '              CNKCS209
258100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
258200         MOVE 'TO INSERT A TDCTFAS ROW'                              CL**5
258300                                   TO DP013-MESSAGE-TEXT (2)      CNKCS209
258400         MOVE SQLCA                TO DP013-SQLCA                 CNKCS209
258500         MOVE 'TDCTFAS'            TO DP013-DB2-TABLE-NAME (1)       CL**5
258600         SET DP013-DB2-ABEND                                      CNKCS209
258700             DP013-XCTL-DISPLAY-RESTART                           CNKCS209
258800                                   TO TRUE                        CNKCS209
258900         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
259000     END-IF.                                                      CNKCS209
259100                                                                  CNKCS209
259200/                                                                 CNKCS209
259300*----------------------------------------------------------------*CNKCS209
259400* CLOSE THE TDCTFAS CURSOR.                                      *   CL**5
259500*----------------------------------------------------------------*CNKCS209
259600                                                                  CNKCS209
259700 7700-CLOSE-TDCTFAS.                                                 CL**5
259800                                                                  CNKCS209
259900     EXEC SQL                                                     CNKCS209
260000         CLOSE TDCTFAS-CSR                                           CL**5
260100     END-EXEC.                                                    CNKCS209
260200                                                                  CNKCS209
260300     EVALUATE TRUE                                                CNKCS209
260400         WHEN SQLCODE = +0                                        CNKCS209
260500              CONTINUE                                            CNKCS209
260600         WHEN SQLWARN0 NOT = SPACE                                CNKCS209
260700         WHEN SQLCODE  NOT = +0                                   CNKCS209
260800              MOVE '7700-CLOSE-TDCTFAS'                              CL**5
260900                                   TO DP013-PARAGRAPH             CNKCS209
261000              MOVE 'CLOSE TDCTFAS-CSR CURSOR'                        CL**5
261100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
261200              MOVE SQLCA           TO DP013-SQLCA                 CNKCS209
261300              MOVE 'TDCTFAS'       TO DP013-DB2-TABLE-NAME (1)       CL**5
261400              SET DP013-DB2-ABEND  TO TRUE                        CNKCS209
261500              PERFORM DP013-0000-PROCESS-ABEND                    CNKCS209
261600     END-EVALUATE.                                                CNKCS209
261700                                                                  CNKCS209
261800/                                                                 CNKCS209
261900*----------------------------------------------------------------*CNKCS209
262000* APPLY THE ASSIGNMENT TO ALL SELECTED ROWS ON THE DEPARTMENT/   *CNKCS209
262100* CLASS TICKET FORMAT TABLE                                      *CNKCS209
262200*----------------------------------------------------------------*CNKCS209
262300 8000-ASSIGN-ALL.                                                 CNKCS209
262400                                                                  CNKCS209
262500     PERFORM VARYING PV-UPD-COUNTER FROM 1 BY 1                   CNKCS209
262600               UNTIL PV-UPD-COUNTER > ASC-NUMBER-OF-SELECTED-ITEMSCNKCS209
262700         PERFORM 6000-UPDATE-ASSIGNMENT                           CNKCS209
262800         PERFORM 2110-GET-NEXT-RECORD                             CNKCS209
262900     END-PERFORM.                                                 CNKCS209
263000                                                                  CNKCS209
263100     MOVE PC-TSYMSG-00059          TO DP020-MSG-NUMBER.           CNKCS209
263200     SET DP020-MSG-INFORMATIONAL   TO TRUE.                       CNKCS209
263300                                                                  CNKCS209
263400/                                                                 CNKCS209
263500*----------------------------------------------------------------*CNKCS209
263600* READ AN ITEM FROM THE SELECTED ITEMS TEMP STORAGE QUEUE.       *CNKCS209
263700*----------------------------------------------------------------*CNKCS209
263800                                                                  CNKCS209
263900 9100-READ-SEL-QUEUE.                                             CNKCS209
264000     EXEC CICS                                                    CNKCS209
264100         READQ TS                                                 CNKCS209
264200             QUEUE (ASC-SEL-QUEUE-NAME)                           CNKCS209
264300             INTO  (CN006-TS-SEL-REC)                             CNKCS209
264400             ITEM  (ASC-SEL-ITEM)                                 CNKCS209
264500             RESP  (PV-CICS-RESPONSE)                             CNKCS209
264600     END-EXEC.                                                    CNKCS209
264700                                                                  CNKCS209
264800     IF  PV-CICS-RESPONSE EQUAL DFHRESP(NORMAL)                   CNKCS209
264900         CONTINUE                                                 CNKCS209
265000     ELSE                                                         CNKCS209
265100         SET DP013-LOGIC-ABEND                                    CNKCS209
265200             DP013-NO-ROLLBACK     TO TRUE                        CNKCS209
265300         MOVE '9100-READ-SEL-QUEUE'                               CNKCS209
265400                                   TO DP013-PARAGRAPH             CNKCS209
265500         MOVE 'ATTEMPTING TO READ THE LIST SELECTIONS TS QUEUE'   CNKCS209
265600                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
265700         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
265800     END-IF.                                                      CNKCS209
265900                                                                  CNKCS209
266000/                                                                 CNKCS209
266100*----------------------------------------------------------------*CNKCS209
266200* UPDATE AN ITEM IN THE SELECTED ITEMS TEMP STORAGE QUEUE.       *CNKCS209
266300*----------------------------------------------------------------*CNKCS209
266400 9200-REWRITE-LIST-QUEUE.                                         CNKCS209
266500                                                                  CNKCS209
266600     EXEC CICS                                                    CNKCS209
266700          WRITEQ TS                                               CNKCS209
266800              QUEUE  (ASC-SEL-QUEUE-NAME)                         CNKCS209
266900              FROM   (CN006-TS-SEL-REC)                           CNKCS209
267000              ITEM   (ASC-SEL-ITEM)                               CNKCS209
267100              RESP   (PV-CICS-RESPONSE)                           CNKCS209
267200              REWRITE                                             CNKCS209
267300     END-EXEC.                                                    CNKCS209
267400                                                                  CNKCS209
267500     IF  PV-CICS-RESPONSE NOT EQUAL DFHRESP(NORMAL)               CNKCS209
267600         SET DP013-CICS-ABEND                                     CNKCS209
267700             DP013-NO-ROLLBACK     TO TRUE                        CNKCS209
267800         MOVE '9200-REWRITE-LIST-QUEUE'                           CNKCS209
267900                                   TO DP013-PARAGRAPH             CNKCS209
268000         MOVE 'ATTEMPTING TO REWRITE THE LIST SELECTIONS QUEUE'   CNKCS209
268100                                   TO DP013-MESSAGE-TEXT (1)      CNKCS209
268200         PERFORM DP013-0000-PROCESS-ABEND                         CNKCS209
268300     END-IF.                                                      CNKCS209
268400                                                                  CNKCS209
268500/                                                                 CNKCS209
268600*----------------------------------------------------------------*CNKCS209
268700*    ABEND PROCESSOR MODULE                                      *CNKCS209
268800*----------------------------------------------------------------*CNKCS209
268900                                                                  CNKCS209
269000     COPY DPPD013.                                                CNKCS209
