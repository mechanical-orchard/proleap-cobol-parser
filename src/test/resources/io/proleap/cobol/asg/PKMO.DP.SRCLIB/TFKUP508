000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             TFKUP508.                                00050030
000600 AUTHOR.                 RAY GRAF.                                00060030
000700 INSTALLATION.           KOHL'S DEPARTMENT STORES.                00070000
000800 DATE-WRITTEN            APRIL, 2000.                             00080030
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  PURPOSE: THIS PROGRAM RETRIEVES ALL INCOMPLETE TRANSFERS. ALL  00120030
001300*  ITEM AND CUSTOMER RECORDS WITHOUT A CORRESPONDING MASTER       00130030
001300*  RECORD WILL BE DELETED.  THIS LOGIC USED TO BE IN PROGRAM      00140030
001300*  TFKUP478, BUT WAS REMOVED TO INCREASE PROCESSING SPEED.        00150030
001300*  THIS JOB RUNS MONTHLY.                                         00160030
001500******************************************************************00170000
033111***************************************************************** 00171033
022712* PR 3403 -  CHERI PARMLEY - 02/27/2012                           00172033
022712*            COMPILE FOR TTFITEM TABLE CHANGES                    00173033
022712***************************************************************** 00175033
001900                                                                  00180000
002000******************************************************************00190000
002100 ENVIRONMENT DIVISION.                                            00200000
002200******************************************************************00210000
002300                                                                  00220000
002400 CONFIGURATION SECTION.                                           00230000
002500                                                                  00240000
002600 SOURCE-COMPUTER.        IBM-3090.                                00250000
002700 OBJECT-COMPUTER.        IBM-3090.                                00260000
002800                                                                  00270000
002900 INPUT-OUTPUT SECTION.                                            00280000
003000                                                                  00290000
003100 FILE-CONTROL.                                                    00300000
003200                                                                  00310000
003300******************************************************************00320000
003400 DATA DIVISION.                                                   00330000
003500******************************************************************00340000
003600                                                                  00350000
003700 FILE SECTION.                                                    00360000
003800                                                                  00370000
003900******************************************************************00380000
004000 WORKING-STORAGE SECTION.                                         00390000
004100******************************************************************00400000
004200*                                                                 00410000
004300*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM TABLE00420000
004400*                                                                 00430000
004500     EXEC SQL                                                     00440000
004600         INCLUDE TTFITEM                                          00450000
004700     END-EXEC.                                                    00460000
004800                                                                  00470000
005700*                                                                 00480000
005800*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER CUSTOMER  00490000
005900*  TABLE                                                          00500000
006000*                                                                 00510000
006100     EXEC SQL                                                     00520000
006200         INCLUDE TTFCUST                                          00530000
006300     END-EXEC.                                                    00540000
006400                                                                  00550000
006500*                                                                 00560000
006600*  COMMUNICATIONS AREA FOR DB2                                    00570000
006700*                                                                 00580000
006800     EXEC SQL                                                     00590000
006900         INCLUDE SQLCA                                            00600000
007000     END-EXEC.                                                    00610000
007100                                                                  00620000
007200*                                                                 00630000
007300*  DB2 FORMATTED ERROR MESSAGE                                    00640000
007400*                                                                 00650000
007500     COPY DPWS004.                                                00660000
007600                                                                  00670000
007700 01  ABEND-CODE                          PIC S9(04)  VALUE +0     00680000
007800                                                     COMP SYNC.   00690000
007900                                                                  00700000
008000 01  PC-PROGRAM-CONSTANTS.                                        00710004
008100     05  PC-MAX-DELETES-B4-A-COMMIT      PIC  9(04)  VALUE 1000.  00720027
008200     05  PC-PROGRAM-NAME                 PIC  X(08)  VALUE        00730010
008300                                                     'TFKUP478'.  00740010
008400     05  PC-ZERO                         PIC S9(09)  VALUE ZEROS  00750003
008500                                                     COMP SYNC.   00760003
008600 01  PS-PROGRAM-SWITCHES.                                         00770000
008700     05  PS-END-OF-DELETES-IND           PIC  X(01)  VALUE 'N'.   00780009
008800         88  PS-MORE-DELETES                         VALUE 'N'.   00790009
008900         88  PS-END-OF-DELETES                       VALUE 'Y'.   00800009
009000                                                                  00810000
009100 01  PV-PROGRAM-VARIABLES.                                        00820000
009200     05  PV-PARAGRAPH-NAME               PIC  X(30)  VALUE SPACE. 00830000
009300     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE. 00840000
009400     05  PV-COMMIT-CNT                   PIC  9(04)  VALUE ZEROS. 00850027
009500     05  PV-DISPLAY-XFER-DKEY-ID         PIC  9(09)  VALUE ZEROS. 00860009
009600     05  PV-DEL-ITEM-CNT                 PIC  9(06)  VALUE ZEROS. 00870009
009700     05  PV-DEL-CUST-CNT                 PIC  9(06)  VALUE ZEROS. 00880009
009900                                                                  00890000
010000*                                                                 00900000
010100* CURSOR TO RETRIEVE ALL TRANSFERS THAT WILL BE DELETED, BECAUSE  00910009
010200* THEY ARE INCOMPLETE.                                            00920009
010300*                                                                 00930000
010400     EXEC SQL                                                     00940000
010500        DECLARE  DELETE_CSR CURSOR WITH HOLD FOR                  00950028
011200         SELECT DISTINCT I.XFER_DKEY_ID                           00960020
011300           FROM  TTFITEM I                                        00970020
011400          WHERE  I.XFER_DKEY_ID  NOT IN                           00980020
011500                (SELECT M.XFER_DKEY_ID                            00990020
011600                 FROM TTFMSTR M)                                  01000020
011700       ORDER BY  XFER_DKEY_ID                                     01010001
011800     END-EXEC.                                                    01020000
011900                                                                  01030000
012000***************************************************************** 01040000
012100 PROCEDURE DIVISION.                                              01050000
012200***************************************************************** 01060000
012300                                                                  01070000
012400***************************************************************** 01080000
012500*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM    01090000
012600***************************************************************** 01100000
012700 0000-PROGRAM-MAINLINE.                                           01110000
012800     PERFORM 1000-INITIALIZE.                                     01120000
012900     PERFORM 2000-PROCESS-DELETES                                 01130009
013000         UNTIL PS-END-OF-DELETES.                                 01140009
013100     PERFORM 9000-EOJ-ROUTINE.                                    01150000
013200     STOP RUN.                                                    01160000
013300*                                                                 01170000
013400***************************************************************** 01180000
013500* 1000-INITIALIZE - OPEN DELETE-CSR. LOCK TABLES TTFITEM AND      01190030
013600*      TTFCUST. FETCH DELETE-CSR.                                 01200009
013700***************************************************************** 01210000
013800 1000-INITIALIZE.                                                 01220005
014000     PERFORM 7000-LOCK-TABLE-TTFITEM.                             01230026
014200     PERFORM 7200-LOCK-TABLE-TTFCUST.                             01240026
014210     PERFORM 2010-OPEN-DELETE-CSR.                                01250026
014300     PERFORM 7300-FETCH-DELETE-CSR.                               01260009
014400*                                                                 01270000
014500***************************************************************** 01280000
014600* 2000-PROCESS-DELETES - RETRIEVE RECORDS FOR PROCESSING          01290009
014700***************************************************************** 01300000
014800 2000-PROCESS-DELETES.                                            01310009
014900                                                                  01320000
015000     IF PS-MORE-DELETES                                           01330009
015200         PERFORM 7500-DELETE-XFER-ITEM                            01340009
015300         PERFORM 7600-DELETE-XFER-CUST                            01350009
015400                                                                  01360000
015500         IF PV-COMMIT-CNT  >  PC-MAX-DELETES-B4-A-COMMIT          01370010
015600            PERFORM 7700-COMMIT                                   01380009
015700            PERFORM 7000-LOCK-TABLE-TTFITEM                       01390026
015900            PERFORM 7200-LOCK-TABLE-TTFCUST                       01400026
016000            INITIALIZE PV-COMMIT-CNT                              01410009
016200         END-IF                                                   01420009
016300                                                                  01430009
016400         PERFORM 7300-FETCH-DELETE-CSR                            01440009
016500     ELSE                                                         01450009
016600         PERFORM 2020-CLOSE-DELETE-CSR                            01460012
016700     END-IF.                                                      01470009
016800*                                                                 01480012
016900 2010-OPEN-DELETE-CSR.                                            01490012
017000     EXEC SQL                                                     01500012
017100         OPEN DELETE_CSR                                          01510012
017200     END-EXEC.                                                    01520012
017300                                                                  01530012
017400     EVALUATE TRUE                                                01540012
017500         WHEN SQLWARN0 NOT = SPACES                               01550012
017600         WHEN SQLCODE < ZERO                                      01560012
017700         WHEN SQLCODE > ZERO                                      01570012
017800             MOVE '2010-OPEN-DELETE-CSR'                          01580012
017900                 TO PV-PARAGRAPH-NAME                             01590012
018000             MOVE 'OPEN THE DELETE_CSR'                           01600012
018100                 TO PV-DB2-OPERATION-ATTEMPTED                    01610012
018200             PERFORM 9100-SQL-ABEND                               01620012
018300         WHEN SQLCODE = ZERO                                      01630012
018400             CONTINUE                                             01640012
018500     END-EVALUATE.                                                01650012
018600*                                                                 01660009
018700 2020-CLOSE-DELETE-CSR.                                           01670012
018800     EXEC SQL                                                     01680009
018900         CLOSE DELETE_CSR                                         01690009
019000     END-EXEC.                                                    01700009
019100                                                                  01710009
019200     EVALUATE TRUE                                                01720009
019300         WHEN SQLWARN0 NOT = SPACES                               01730009
019400         WHEN SQLCODE < ZERO                                      01740009
019500         WHEN SQLCODE > ZERO                                      01750009
019600             MOVE '2020-CLOSE-DELETE-CSR'                         01760012
019700                 TO PV-PARAGRAPH-NAME                             01770009
019800             MOVE 'CLOSE THE DELETE_CSR'                          01780009
019900                 TO PV-DB2-OPERATION-ATTEMPTED                    01790009
020000             PERFORM 9100-SQL-ABEND                               01800009
020100         WHEN SQLCODE = ZERO                                      01810009
020200             CONTINUE                                             01820009
020300     END-EVALUATE.                                                01830009
020400*                                                                 01840008
020500 7000-LOCK-TABLE-TTFITEM.                                         01850006
020600                                                                  01860000
020700     EXEC SQL                                                     01870000
020800         LOCK TABLE TTFITEM IN EXCLUSIVE MODE                     01880000
020900     END-EXEC.                                                    01890000
021000                                                                  01900006
021100     EVALUATE TRUE                                                01910006
021200         WHEN SQLWARN0 NOT = SPACES                               01920006
021300         WHEN SQLCODE < ZERO                                      01930006
021400         WHEN SQLCODE > ZERO                                      01940006
021500             MOVE '7000-LOCK-TABLE-TTFITEM'                       01950006
021600                 TO PV-PARAGRAPH-NAME                             01960006
021700             MOVE 'LOCK TABLE TTFITEM'                            01970006
021800                 TO PV-DB2-OPERATION-ATTEMPTED                    01980006
021900             PERFORM 9100-SQL-ABEND                               01990006
022000         WHEN SQLCODE = ZERO                                      02000006
022100             CONTINUE                                             02010006
022200     END-EVALUATE.                                                02020006
024200*                                                                 02030006
024300 7200-LOCK-TABLE-TTFCUST.                                         02040006
024400                                                                  02050006
024500     EXEC SQL                                                     02060006
024600         LOCK TABLE TTFCUST IN EXCLUSIVE MODE                     02070006
024700     END-EXEC.                                                    02080006
024800                                                                  02090006
024900     EVALUATE TRUE                                                02100006
025000         WHEN SQLWARN0 NOT = SPACES                               02110006
025100         WHEN SQLCODE < ZERO                                      02120006
025200         WHEN SQLCODE > ZERO                                      02130006
025300             MOVE '7200-LOCK-TABLE-TTFCUST'                       02140006
025400                 TO PV-PARAGRAPH-NAME                             02150006
025500             MOVE 'LOCK TABLE TTFCUST'                            02160006
025600                 TO PV-DB2-OPERATION-ATTEMPTED                    02170006
025700             PERFORM 9100-SQL-ABEND                               02180006
025800         WHEN SQLCODE = ZERO                                      02190006
025900             CONTINUE                                             02200006
026000     END-EVALUATE.                                                02210006
026100*                                                                 02220006
026200 7300-FETCH-DELETE-CSR.                                           02230009
026300     INITIALIZE DCLTTFITEM.                                       02240030
026400                                                                  02250006
026500     EXEC SQL                                                     02260006
026600         FETCH  DELETE_CSR                                        02270009
026700          INTO  :TFITEM-XFER-DKEY-ID                              02280030
026800     END-EXEC.                                                    02290006
026900                                                                  02300006
027000     EVALUATE TRUE                                                02310006
027100         WHEN SQLCODE = +100                                      02320006
027200             SET PS-END-OF-DELETES  TO  TRUE                      02330010
027300         WHEN SQLWARN0 NOT = SPACES                               02340006
027400         WHEN SQLCODE < ZERO                                      02350006
027500         WHEN SQLCODE > ZERO                                      02360006
027600             MOVE '7300-FETCH-DELETE-CSR'                         02370009
027700                 TO PV-PARAGRAPH-NAME                             02380006
027800             MOVE 'FETCH THE DELETE_CSR'                          02390009
027900                 TO PV-DB2-OPERATION-ATTEMPTED                    02400006
028000             PERFORM 9100-SQL-ABEND                               02410006
028100         WHEN SQLCODE = ZERO                                      02420006
028200             CONTINUE                                             02430006
028300     END-EVALUATE.                                                02440006
030700*                                                                 02450009
030800 7500-DELETE-XFER-ITEM.                                           02460009
                                                                        02470031
030900     EXEC SQL                                                     02480009
031000         DELETE  FROM TTFITEM                                     02490009
031100          WHERE  (XFER_DKEY_ID  =  :TFITEM-XFER-DKEY-ID)          02500030
031200     END-EXEC.                                                    02510009
031300                                                                  02520009
031400     EVALUATE TRUE                                                02530009
031500         WHEN SQLCODE = +100                                      02540009
031600             CONTINUE                                             02550009
031700         WHEN SQLWARN0 NOT = SPACES                               02560009
031800         WHEN SQLCODE < ZERO                                      02570009
031900         WHEN SQLCODE > ZERO                                      02580009
032000             MOVE '7500-DELETE-XFER-ITEM'                         02590009
032100                 TO PV-PARAGRAPH-NAME                             02600009
032200             MOVE 'DELETE ROW FROM TTFITEM'                       02610009
032300                 TO PV-DB2-OPERATION-ATTEMPTED                    02620009
032400             MOVE TFITEM-XFER-DKEY-ID  TO  PV-DISPLAY-XFER-DKEY-ID02630030
032500             DISPLAY 'DELETING TFITEM-XFER-DKEY-ID:  '            02640030
032600                 PV-DISPLAY-XFER-DKEY-ID                          02650009
032700             PERFORM 9100-SQL-ABEND                               02660009
032800         WHEN SQLCODE = ZERO                                      02670009
032900             ADD 1 TO PV-DEL-ITEM-CNT                             02680014
033000     END-EVALUATE.                                                02690009
033100*                                                                 02700009
                                                                        02710031
033200 7600-DELETE-XFER-CUST.                                           02720009
                                                                        02730032
033300     EXEC SQL                                                     02740009
033400         DELETE  FROM TTFCUST                                     02750009
033500          WHERE  (XFER_DKEY_ID  =  :TFITEM-XFER-DKEY-ID)          02760030
033600     END-EXEC.                                                    02770009
033700                                                                  02780009
033800     EVALUATE TRUE                                                02790009
033900         WHEN SQLCODE = +100                                      02800009
034000             CONTINUE                                             02810009
034100         WHEN SQLWARN0 NOT = SPACES                               02820009
034200         WHEN SQLCODE < ZERO                                      02830009
034300         WHEN SQLCODE > ZERO                                      02840009
034400             MOVE '7600-DELETE-XFER-CUST'                         02850009
034500                 TO PV-PARAGRAPH-NAME                             02860009
034600             MOVE 'DELETE ROW FROM TTFCUST'                       02870009
034700                 TO PV-DB2-OPERATION-ATTEMPTED                    02880009
034800             MOVE TFITEM-XFER-DKEY-ID  TO  PV-DISPLAY-XFER-DKEY-ID02890030
034900             DISPLAY 'DELETING TFITEM-XFER-DKEY-ID:  '            02900030
035000                 PV-DISPLAY-XFER-DKEY-ID                          02910009
035100             PERFORM 9100-SQL-ABEND                               02920009
035200         WHEN SQLCODE = ZERO                                      02930009
035300             ADD 1 TO PV-DEL-CUST-CNT                             02940014
035400     END-EVALUATE.                                                02950009
035500*                                                                 02960009
                                                                        02970031
035600 7700-COMMIT.                                                     02980009
035700     EXEC SQL                                                     02990009
035800         COMMIT                                                   03000009
035900     END-EXEC.                                                    03010009
036000*                                                                 03020006
036100 9000-EOJ-ROUTINE.                                                03030006
036300     DISPLAY '*** TTFITEM ROWS DELETED = '  PV-DEL-ITEM-CNT.      03040009
036400     DISPLAY '*** TTFCUST ROWS DELETED = '  PV-DEL-CUST-CNT.      03050009
036500*                                                                 03060000
036600******************************************************************03070000
036700*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03080000
036800*  ERROR OR WARNING CODE OCCURS.                                  03090000
036900******************************************************************03100000
037000 9100-SQL-ABEND.                                                  03110000
037100     DISPLAY '** ABEND     **'.                                   03120000
037200     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                03130000
037300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03140000
037400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03150000
037600     DISPLAY '** TTFITEM ROWS DELETED = '  PV-DEL-ITEM-CNT.       03160013
037700     DISPLAY '** TTFCUST ROWS DELETED = '  PV-DEL-CUST-CNT.       03170013
037800                                                                  03180000
037900******************************************************************03190017
038000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03200017
038100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03210017
038200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03220017
038300* FORMAT.                                                         03230017
038400******************************************************************03240017
038500     COPY DPPD004.                                                03250017
038600                                                                  03260017
038700     MOVE +4013  TO  ABEND-CODE.                                  03270017
038800     CALL 'ILBOABN0' USING ABEND-CODE.                            03280000
