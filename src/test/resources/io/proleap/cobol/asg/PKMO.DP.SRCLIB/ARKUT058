000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             ARKUT058.                                00050000
000600 AUTHOR.                 KATHY PRIESTER.                          00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           SEPTEMBER 2003.                          00080000
000900 DATE-COMPILED.                                                   00090000
001000******************************************************************00100000
001100*                                                                 00110000
001200*  PROGRAM ARKUT059 IS BEING SPLIT INTO TWO SEPARARTE PROGRAMS.   00120000
001300*  --  ARKUT058 WILL EXTRACT THE DATA REQUIRED FROM COSA.         00130000
001400*  --  ARKUT059 WILL CREATE THE REPORTS.                          00140000
001500*                                                                 00150000
001600*---------------------------------------------------------------- 00160000
001700* CHANGES:                                                        00170000
001800* 5/3/2010 JILL ZIMBAL                                            00180000
001900*     INCREASED THE SIZE OF TI-TAX-INFO-TABLE FROM 4000 TO 9000   00190000
002000* 3/22/2011 ELENA MOZNAIM                                         00200000
002100*     ADDED CODE TO RECOGNIZE 'LATE VOID' FOR PAYMENT TRANS.      00210000
002200*     CHANGES ARE MARKED BY EVM001.                               00220000
002300* 3/22/2011 ELENA MOZNAIM                                         00230000
002400*     ADDED CODE FOR DATA TYPE '21', CHANGES ARE MARKED EVM002.   00240000
002500* 6/14/2011 ELENA MOZNAIM                                         00250000
002600*     CORRECTED 'LATE VOIDS' CURSOR TO NOT PULL DUPLICATE INFO.   00260000
002700*     CHANGES ARE MARKED EVM003.                                  00270000
002800* 4/26/2012 TY HOPP                                               00280000
002900*     BACKED OUT ASSOCIATE DISCOUNT CHANGES TO CORRECT OOB REPORT 00290000
003000*     BECAUSE TRANSACTIONS BEING SENT TO FD NOW IN ERROR. FIX     00300000
003100*     FD ISSUE NOW BY REMOVING CODE, FIX OOB REPORT LATER.        00310000
003200* 11/15/2012 COGNIZANT                                            00320000
003300*     POPULATED ARRD001 COPYBOOK VARIABLE AR001-TRN-DTE WITH      00330000
003400*     EPTRN-TRN-DTE VALUE IN MMDDYY FORMAT.                       00340000
003500* 06/24/2013 BARB SCHULTZ                                         00350000
003600*     CHANGES RELATED TO SFS CHANGE TO TEPTRN.                    00360000
003700*     CHANGE MARKED AS C53632                                     00370000
003800*                                                                 00380000
003900*---------------------------------------------------------------- 00390000
004000* 06/20/2013 JOE GARDETTO                                         00400000
004100*    -ADDED LID TYPE 'L' FOR GIFT RECEIPT RETURNS TO THE          00410000
004200*     EVALUATE FOR EPLID-LID-TYP-CDE IN PARAGRAPH                 00420000
004300*     4830-PROCESS-TEPLID-CSR. (JPGFX2)                           00430000
004400*    -CHANGED LOGIC FOR SUBJECT TO TAX AMOUNT TO USE IT           00440000
004500*     WHEN ITS NOT ZERO IN PARAGRAPH 4200-PROCESS-SALE-RETURN.    00450000
004600*     (JPGFX1)                                                    00460000
004700*    -ADDED LOGIC TO GET THE EMPLOYEE DISCOUNT SOURCE FROM        00470000
004800*     TEPEID AND ADD IT TO AR TRAN FILE. ALSO ADDED LOGIC TO      00480000
004900*     USE TAX RATE INFORMATION FROM THE TRANSACTION WHEN THE      00490000
005000*     EMPLOYEE DISCOUNT SOURCE IS P FOR POS. (JPGFX1)             00500000
005100******************************************************************00510000
005200*  THIS PROGRAM PROCESSES THE DAILY KOHLS CHARGE TRANSACTIONS.  IT00520000
005300*  IS A REWRITE OF ARKUT001 THAT USED TO USE THE DAILY SALES FILE.00530000
005400*  THE PROGRAM WAS REWRITTEN TO SUPPORT THE TAX PROJECT.          00540000
005500*                                                                 00550000
005600*  IT NOW USES THE POS TRANSACTION DATABASE AS ITS SOURCE.  A     00560000
005700*  SALES DATE IS SUPPLIED VIA A CONTROL CARD.  THIS SALES DATE IS 00570000
005800*  THEN USED TO GET THE PARTITION NUMBER FOR THE SALES DATE.      00580000
005900*                                                                 00590000
006000*  THREE CURSORS CONTROL THE MAIN PROCESSING OF THE PROGRAM.  THE 00600000
006100*  FIRST CURSOR USES THE TEPDKEY TABLE TO DETERMINE KOHLS CHARGE  00610000
006200*  TRANSACTIONS.  THE TEPDKEY TABLE HOLDS THE KEY INFORMATION     00620000
006300*  FOR LATE AND SALES CORRECTION TRANSACTIONS.  THE SECOND CURSOR 00630000
006400*  USES THE PARTITION OBTAINED BY INTERPRETING THE SALES DATE     00640000
006500*  SUPPLIED IN THE CONTROL CARD.  REGARDLESS OF THE CURSOR BEING  00650000
006600*  USED, THE PROCESSING IS THE SAME.  THE THIRD CURSOR SEARCHES   00660000
006700*  FOR LATE VOID TRANSACTIONS.  REVERSALS MUST BE SENT TO KOHLS   00670000
006800*  CHARGE WHEN THE ORIGINAL TRANSACTION IS PROCESSED AND THE VOID 00680000
006900*  IS LATE.                                                       00690000
007000*                                                                 00700000
007100*  IF THE TRANSACTION IS NOT A PAYMENT, THEN THE ITEMS IN THAT    00710000
007200*  TRANSACTION ARE PROCESSED.  EACH ITEM IS CHECKED TO SEE IF IT  00720000
007300*  HAD ANY KIND OF TRANSACTION LEVEL DISCOUNT PRORATED AGAINST IT.00730000
007400*  THESE DISCOUNTS ARE ADDED BACK IN TO THE ITEM ITSELF BECAUSE   00740000
007500*  THE TLD IS TAKEN OFF AS A WHOLE IN THE TRANSACTION.            00750000
007600*  THE TAX INFORMATION FOR EACH ITEM THEN HAS TO BE APPLIED.      00760000
007700*  IF THE TRANSACTION IS A LATE OR A SALES CORRECTION, A SELECT   00770000
007800*  IS PERFORMED AGAINST THE TAX TABLE TO GET THE INFORMATION.     00780000
007900*  IF THE TRANSACTION IS CURRENT DAY, THE WORKING STORAGE TABLE   00790000
008000*  IS READ.  THE REASON FOR THIS TYPE OF PROCESSING IS THAT LATES 00800000
008100*  AND CORRECTIONS CAN HAVE DATES THAT VARY GREATLY WHERE AS      00810000
008200*  REGULAR TRANSACTIONS WILL ALL HAVE THE SAME DATE AND THERE     00820000
008300*  ARE PERFORMANCE GAINS IN USING A WORKING STORAGE TABLE.  AFTER 00830000
008400*  THE ITEMS ARE PROCESSED, THE TLDS ARE PROCESSED, THEN TAX, AND 00840000
008500*  FINALLY SPLIT TENDER INFORMATION IF THE KOHLS CHARGE AMOUNT    00850000
008600*  DOES NOT MATCH THE TRANSACTION TOTAL AMOUNT.                   00860000
008700*                                                                 00870000
008800*  IF THE TRANSACTION IS A PAYMENT, THE PAYMENT IS PROCESSED BY   00880000
008900*  USING THE INFORMATION LOCATED IN THE TEPPAY TABLE.             00890000
009000*                                                                 00900000
009100*  IN EITHER CASE, THE PROCESSING OF THE OUTPUT RECORDS AND       00910000
009200*  REPORT LINES IS SHARED BETWEEN PAYMENT AND NON-PAYMENT         00920000
009300*  TRANSACTIONS SO AS TO SIMPLIFY AND CREATE RE-USABLE CODE.      00930000
009400******************************************************************00940000
009500* DATE: 09/24/2013                                                00950000
009600* WHO: COGNIZANT    (CHG0062728 - FSH 2013)                       00960000
009700* DESCRIPTION: REMOVED LOGIC THAT REFERENCING THE FOLLOWING COSA  00970000
009800*              TABLES.                                            00980000
009900*               TEPIPSH                                           00990000
010000*               TEPITMH                                           01000000
010100*               TEPSHPH                                           01010000
010200*               TEPTRNH                                           01020000
010300*---------------------------------------------------------------- 01030000
010400* 10/15/2013 JOE GARDETTO                                         01040000
010500*     CHG0066455 - CHANGES RELATED TO SFS CHANGE TO TEPTRN.       01050000
010600*     CHANGE MARKED AS JPGFX4                                     01060000
010700*---------------------------------------------------------------- 01070000
010800* 11/11/2013 JOE GARDETTO                                         01080000
010900*     CHG0070860 - REPLACED ART_EMP_DISC WITH TEPEID TO FOR       01090000
011000*     EMPLOYEE DISCOUNT LOGIC. (JPGFX5)                           01100000
011100******************************************************************01110000
011200*---------------------------------------------------------------- 01120000
011300* 05/09/2014 COGNIZANT                                            01130000
011400*     CHG0072838 - AJB SETTLEMENT PROJECT                         01140000
011500*     - COPYBOOK ARRD001 IS ADDED WITH FOUR NEW FIELDS            01150000
011600*       AR001-ORG-STR-NBR, AR001-OMNI-CHL-FLMT-IND AND            01160000
011700*       AR001-AUTH-REF-NBR, AR001-TRN-GP-CDE.                     01170000
011800*     - MODIFIED PROGRAM TO POPULATE NEWLY ADDED FIELDS.          01180000
011900*     - INCREASED RECORD LENGTH OF OUTPUT FILE TO 311.            01190000
012000*     - MODIFIED POS-TRN-CSR, LATE-COR-CSR,  LATE-VOID-CSR AND    01200000
012100*       TENDER-CSR TO EXCULDE TRANSACTIONS WITH ZERO DOLLAR AMOUNT01210000
012200******************************************************************01220000
012300*---------------------------------------------------------------- 01230000
012400* 10/16/2014 COGNIZANT                                            01240000
012500*     CHG0096079 - CHANGED THE LATE CORRECTION QUERY              01250000
012600*     - THE CURSOR OF LATE AND CORRECTION IS CHANGED TO IGNORE THE01260000
012700*       TRANSACTION IF THE REVERSAL AND CORRECTION HAS HAPPENED   01270000
012800*       ON THE SAME DAY                                           01280000
012900*     - ALSO ADDED THE COMPUTE STATEMENT TO REVERSE THE EMPLOYEE  01290000
013000*       DISCOUNT FOR THE REVERSALS.                               01300000
013100******************************************************************01310000
013200* 10/23/2014 JOE GARDETTO                                         01320000
013300*     CHG0086844                                                  01330000
013400*    -CHANGE LOGIC PASS THE TAX RATE AND PERCENT FOR NON-ECOM     01340000
013500*     TRANSACTIONS.  THIS IS NEEDED IN ARKUT090 AND ARKUT093      01350000
013600*     TO PROPERLY CALCULATE THE TAX ADJUSTMENT FOR THE EMPLOYEE   01360000
013700*     DISCOUNT.                                                   01370000
013800*----------------------------------------------------------------*01380000
013900* DATE:        01/29/2015                                        *01390000
014000* WR/IR#:      CHG0103489                                        *01400000
014100* PROGRAMMER:  COGNIZANT                                         *01410000
014200* DESCRIPTION: FIX FOR SALES CORRECTION SEQUENCE NUMBER ISSUE    *01420000
014300*              IN TEPCRR TABLE.                                  *01430000
014400*----------------------------------------------------------------*01440000
014410* DATE:        02/10/2015                                        *01450000
014420* WR/IR#:      CHG0104373                                        *01460000
014430* PROGRAMMER:  COGNIZANT                                         *01470000
014440* DESCRIPTION: FIX FOR TENDER SEQUENCE NUMBER ISSUE IN TEPCRR    *01480000
014450*              TABLE.                                            *01490000
014460******************************************************************01500000
014470* 06/15/2015 ACCENTURE                                           *01510000
014480*     CHG0118696                                                 *01520000
014490*    -ADDED AR001-BIN-NUMBER FIELD IN ARRD001 COPYBOOK.          *01530000
014500*     LOGIC HAS BEEN ADDED TO HANDLE 12 AS WELL AS 18 DIGIT      *01540000
014501*     ACCOUNT NUMBER.                                            *01550000
014502******************************************************************01560000
014503* DATE:        06/03/2015                                        *01570000
014504* WR/IR#:      CHG0104429                                        *01580000
014505* PROGRAMMER:  COGNIZANT                                         *01590000
014506* DESCRIPTION: CHANGES TO DETOKENIZE THE CARD NUMBER FOR INTERNAL*01600000
014507*              VALIDATION CHECK AGAINST ART EMP TABLE AND CONVERT*01610000
014508*              THE ZIP CODE FROM COSA TABLES TO BINARY FORMAT,   *01620000
014509*              THEN DECRYPT THIS BINARY VALUE USING PROTEGRITY   *01630000
014510*              MODULE AND THEN CONVERT THE DECRYPTED ZIP CODE    *01640000
014520*              TO EBCIDIC FORMAT AND REMOVED THE DISPLAY OF CARD#*01650000
014530******************************************************************01660000
014540* DATE:        08/06/2015                                        *01670000
014550* WR/IR#:      CHG0125054                                        *01680000
014560* PROGRAMMER:  COGNIZANT                                         *01690000
014570* DESCRIPTION: CHANGES TO REMOVE THE DETOKENIZE LOGIC OF CARD    *01700000
014580*              NUMBER AND TO TOKENIZE TEST CARD NUMBER           *01710000
014590*              '9999999304'.                                     *01720000
014600******************************************************************01730000
014601* DATE:        09/30/2016                                        *01740000
014602* WR/IR#:      CHG0152592                                        *01750000
014603* PROGRAMMER:  COGNIZANT                                         *01760000
014604* DESCRIPTION: CHANGES TO REMOVE THE DETOKENIZE LOGIC OF CARD    *01770000
014605*              NUMBER AND TO TOKENIZE TEST CARD NUMBER        *   01780000
014606*              '9999999304'.                                     *01790000
014607******************************************************************01800000
014608* DATE:        11/04/2016                                        *01810000
014609* WR/IR#:      CHG0160001                                        *01820000
014610* PROGRAMMER:  BARB SCHULTZ                                      *01830000
014611* DESCRIPTION: INCREASED THE SIZE OF INPUT FILE - ARRD001 TO 385 *01840000
014612*   FROM 311. THIS WAS DONE TO ADD FEE LOGIC TO THE PROGRAM.     *01850000
SHIP  ******************************************************************01860000
SHIP  * DATE:        03/20/2019                                        *01870000
SHIP  * WR/IR#:      CHG0220426                                        *01880000
SHIP  * PROGRAMMER:  BARB SCHULTZ                                      *01890000
SHIP  * DESCRIPTION: CHANGES RELATED TO SETTLE BY SHIP.  ADDING KC MULT*01900000
SHIP  *     CLEARING INDICATOR TO THE EXTRACT BY ADDING THE NEW COLUMN *01910000
SHIP  *     TO THE POS-TRN-CSR, LATE-COR-CSR, AND LATE-VOID-CSR.        01920000
SHIP  *                                                                 01930000
SHIP2 ******************************************************************01940000
SHIP2 * DATE:        01/21/2020                                        *01950000
SHIP2 * WR/IR#:      CHG0233046                                        *01960000
SHIP2 * PROGRAMMER:  BARB SCHULTZ                                      *01970000
SHIP2 * DESCRIPTION: DELETED KC-MULT-CLR-IND AND ADDED VISA-MULT-CLR-  *01980000
SHIP2 *     SEQ-NBR, VISA-TOT-SHP-NBR AND PAR-SHP-IND.                 *01990000
SHIP2 *                                                                 02000000
111121******************************************************************02010000
111121* DATE:        11/11/2021                                        *02012000
111121* WR/IR#:      CHG0263879                                        *02013000
111121* PROGRAMMER:  DAN PAYNTER                                       *02014000
111121* DESCRIPTION: RESTORE PRIOR PRODUCTION VERSION AFTER            *02015000
111121*     INADVERTANT CODE MOVE BY ANOTHER TEAM.                     *02016000
111121*                                                                 02017000
122921******************************************************************02018000
122921* DATE:        12/20/2021                                        *02019100
122921* WR/IR#:      CHG0265153                                        *02019200
122921* PROGRAMMER:  DAN PAYNTER                                       *02019300
122921* DESCRIPTION: FLIP NEGATIVE SALES TO RETURNS.                   *02019400
122921*                                                                 02019600
014614******************************************************************02019700
050222*  03/01/2022 DAN PAYNTER                                        *02019800
050222*  CHG0268732                                                    *02019900
050222*  ADD SEPHORA GIFT CARDS                                        *02020000
050222******************************************************************02020100
061322*  06/14/2022 DAN PAYNTER                                        *02020200
061322*  CHG0271029                                                    *02020300
061322*  FIX ISSUE WITH LATE-VOIDS OF LATE TRANSACTIONS                *02020400
040723******************************************************************02020500
040723*  04/07/2023 AKALYA SANTHYAVAGE                                 *02021000
040723*  CHG0286822                                                    *02021100
040723*  FIX FOR TTXRTLO TO SELECT ONE ROW                             *02021200
061322******************************************************************02021300
040723*  04/07/2023 DAN PAYNTER                                        *02021500
040723*  CHG0286833                                                    *02021600
040723*  FIX FOR TEPPAY DB2 TABLE LENGTH IN LLE VS PROD (18 VS 12)     *02021700
052223***************************************************************** 02021801
052223*  CHANGE MADE: ADD CHANGES TO AVOID NEW COBRAND PAYMENTS         02021901
052223*  AS WELL AS AVOID TRAILING TRANSACTIONS.                        02022001
052223*  DATE: 05/22/2023                                               02022101
052223*  MADE BY: DAN PAYNTER              WR/IR #: CHG0288838          02022201
061322******************************************************************02022400
014615 ENVIRONMENT DIVISION.                                            02023000
014616******************************************************************02030000
014617                                                                  02040000
014618 CONFIGURATION SECTION.                                           02050000
014619                                                                  02060000
014620 SOURCE-COMPUTER.    IBM-3090.                                    02070000
014630 OBJECT-COMPUTER.    IBM-3090.                                    02080000
014640                                                                  02090000
014650 INPUT-OUTPUT SECTION.                                            02100000
014660                                                                  02110000
014670 FILE-CONTROL.                                                    02120000
014680                                                                  02130000
014690     SELECT POS-DATE-CARD-FILE                                    02140000
014700         ASSIGN TO INP01.                                         02150000
014800                                                                  02160000
014900     SELECT ACCOUNTS-RECEIVABLE-FILE                              02170000
015000         ASSIGN TO OUT01.                                         02180000
015100                                                                  02190000
015200******************************************************************02200000
015300 DATA DIVISION.                                                   02210000
015400******************************************************************02220000
015500                                                                  02230000
015600 FILE SECTION.                                                    02240000
015700                                                                  02250000
015800 FD  POS-DATE-CARD-FILE                                           02260000
015900     RECORDING MODE IS F                                          02270000
016000     BLOCK CONTAINS 0 RECORDS                                     02280000
016100     LABEL RECORDS ARE STANDARD.                                  02290000
016200                                                                  02300000
016300 01  POS-DATE-CARD-RECORD            PIC X(80).                   02310000
016400                                                                  02320000
016500 FD  ACCOUNTS-RECEIVABLE-FILE                                     02330000
016600     RECORDING MODE IS F                                          02340000
016700     LABEL RECORDS ARE STANDARD                                   02350000
016800     BLOCK CONTAINS 0 RECORDS                                     02360000
016900     RECORD CONTAINS 385 CHARACTERS                               02370000
017000     DATA RECORD IS AR-ACCOUNTS-RECEIVABLE-RECORD.                02380000
017100                                                                  02390000
017200 01  AR-ACCOUNTS-RECEIVABLE-RECORD                                02400000
017300                                 PIC X(385).                      02410000
017400                                                                  02420000
017500 WORKING-STORAGE SECTION.                                         02430000
017600                                                                  02440000
017700******************************************************************02450000
017800* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    02460000
017900******************************************************************02470000
018000 01  CC-CONTROL-CARD.                                             02480000
018100     05  CC-CONTROL-CARD-DISPLAY.                                 02490000
018200         10  CC-CONTROL-NAME     PIC X(14)    VALUE               02500000
018300                                              'P.O.S. DATE = '.   02510000
018400         10  CC-POS-DATE-MMDDYY.                                  02520000
018500             15  CC-POS-DATE-MM  PIC 9(2)     VALUE ZERO.         02530000
018600             15  CC-POS-DATE-DD  PIC 9(2)     VALUE ZERO.         02540000
018700             15  CC-POS-DATE-YY  PIC 9(2)     VALUE ZERO.         02550000
018800     05  FILLER                  PIC X(60)    VALUE SPACE.        02560000
018900                                                                  02570000
019000 01  PV-POS-CCYY-MM-DD.                                           02580000
019100     05  PV-POS-CC               PIC X(02).                       02590000
019200     05  PV-POS-YY               PIC X(02).                       02600000
019300     05  FILLER                  PIC X(01).                       02610000
019400     05  PV-POS-MM               PIC X(02).                       02620000
019500     05  FILLER                  PIC X(01).                       02630000
019600     05  PV-POS-DD               PIC X(02).                       02640000
019700                                                                  02650000
019800 01  PV-TRN-CCYY-MM-DD.                                           02660000
019900     05  PV-TRN-CC               PIC X(02).                       02670000
020000     05  PV-TRN-YY               PIC X(02).                       02680000
020100     05  FILLER                  PIC X(01).                       02690000
020200     05  PV-TRN-MM               PIC X(02).                       02700000
020300     05  FILLER                  PIC X(01).                       02710000
020400     05  PV-TRN-DD               PIC X(02).                       02720000
020500                                                                  02730000
020600 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      02740000
020700                                                  COMP SYNC.      02750000
020800     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    02760000
020900     88  AC-TABLE-OVERFLOW                        VALUE +4004.    02770000
021000     88  AC-INVALID-DATA-ERROR                    VALUE +4008.    02780000
021100     88  AC-DB2-ERROR                             VALUE +4013.    02790000
021200                                                                  02800000
021300 01  ABEND-CODE                        PIC S9(04) VALUE ZERO      02810000
021400                                                  COMP SYNC.      02820000
021500     88  AC-CONVERSION-ERROR                      VALUE +4008.    02830000
021600                                                                  02840000
021700 01  PS-PROGRAM-SWITCHES.                                         02850000
021800     05  PS-END-OF-ECOM-TABLE-SWITCH                              02860000
021900                                 PIC X(1)     VALUE 'N'.          02870000
022000         88  PS-NOT-END-OF-ECOM-TABLE         VALUE 'N'.          02880000
022100         88  PS-END-OF-ECOM-TABLE             VALUE 'Y'.          02890000
022200     05  PS-END-OF-ZIP-TABLE-SWITCH                               02900000
022300                                 PIC X(1)     VALUE 'N'.          02910000
022400         88  PS-NOT-END-OF-ZIP-TABLE          VALUE 'N'.          02920000
022500         88  PS-END-OF-ZIP-TABLE              VALUE 'Y'.          02930000
022600     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      02940000
022700         88  PS-END-OF-CARD-FILE-YES              VALUE 'Y'.      02950000
022800     05  PS-LINE-ITEM-TYPE-SW    PIC X(1)     VALUE SPACE.        02960000
022900         88  PS-ITEM-LINE-ITEM                VALUE 'I'.          02970000
023000         88  PS-TLCD-LINE-ITEM                VALUE 'T'.          02980000
023100         88  PS-TAX-LINE-ITEM                 VALUE 'X'.          02990000
023200         88  PS-TENDER-LINE-ITEM              VALUE 'E'.          03000000
023300         88  PS-PAYMENT-LINE-ITEM             VALUE 'P'.          03010000
023400         88  PS-WRAP-LINE-ITEM                VALUE 'W'.          03020000
023500         88  PS-SHIP-LINE-ITEM                VALUE 'S'.          03030000
023600         88  PS-FEE-LINE-ITEM                 VALUE 'F'.          03040000
023700     05  PS-TENDER-GIFT-CARD-SW  PIC X(1)     VALUE 'N'.          03050000
023800         88  PS-TENDER-IS-NOT-GIFT-CARD       VALUE 'N'.          03060000
023900         88  PS-TENDER-IS-GIFT-CARD           VALUE 'Y'.          03070000
024000     05  PS-END-OF-TENDER-CURSOR-SW                               03080000
024100                                 PIC X(1)     VALUE SPACE.        03090000
024200         88  PS-END-OF-TENDER-CURSOR          VALUE 'Y'.          03100000
024300     05  PS-END-OF-LATE-COR-CURSOR-SW                             03110000
024400                                 PIC X(1)     VALUE SPACE.        03120000
024500         88  PS-END-OF-LATE-COR-CURSOR        VALUE 'Y'.          03130000
024600     05  PS-END-OF-LATE-VOID-CURSOR-SW                            03140000
024700                                 PIC X(1)     VALUE SPACE.        03150000
024800         88  PS-END-OF-LATE-VOID-CURSOR       VALUE 'Y'.          03160000
024900     05  PS-END-OF-LINE-ITEM-CURSOR-SW                            03170000
025000                                 PIC X(1)     VALUE SPACE.        03180000
025100         88  PS-END-OF-LINE-ITEM-CURSOR       VALUE 'Y'.          03190000
025200     05  PS-END-OF-TLCD-CURSOR-SW                                 03200000
025300                                 PIC X(1)     VALUE SPACE.        03210000
025400         88  PS-END-OF-TLCD-CURSOR            VALUE 'Y'.          03220000
025500     05  PS-END-OF-POS-TRAN-CURSOR-SW                             03230000
025600                                 PIC X(1)     VALUE SPACE.        03240000
025700         88  PS-END-OF-POS-TRAN-CURSOR        VALUE 'Y'.          03250000
025800     05  PS-END-OF-TAX-CURSOR-SW PIC X(1)     VALUE SPACE.        03260000
025900         88  PS-END-OF-TAX-CURSOR             VALUE 'Y'.          03270000
026000     05  PS-FOUND-TAX-INFO-SW    PIC X(1)     VALUE 'N'.          03280000
026100         88  PS-TAX-INFO-FOUND                VALUE 'Y'.          03290000
026200         88  PS-TAX-INFO-NOT-FOUND            VALUE 'N'.          03300000
026300     05  PS-END-OF-SSFEES-CURSOR-SW                               03310000
026400                                 PIC X(1)     VALUE SPACE.        03320000
026500         88  PS-END-OF-SSFEES-CURSOR          VALUE 'Y'.          03330000
026600         88  PS-NOT-END-OF-SSFEES-CURSOR      VALUE 'N'.          03340000
026700     05  PS-END-OF-SHIP-CURSOR-SW                                 03350000
026800                                  PIC X(1)     VALUE SPACE.       03360000
026900         88  PS-END-OF-SHIP-CURSOR             VALUE 'Y'.         03370000
027000         88  PS-NOT-END-OF-SHIP-CURSOR         VALUE 'N'.         03380000
027100     05  PS-ECOMMERCE-STORE-SW                                    03390000
027200                                  PIC X(1)     VALUE SPACE.       03400000
027300         88  PS-ECOMMERCE-STORE                VALUE 'Y'.         03410000
027400         88  PS-NOT-ECOMMERCE-STORE            VALUE 'N'.         03420000
027500     05  PS-ECOMMERCE-RETURN-SW                                   03430000
027600                                  PIC X(1)     VALUE SPACE.       03440000
027700         88  PS-ECOMMERCE-RETURN               VALUE 'Y'.         03450000
027800         88  PS-NOT-ECOMMERCE-RETURN           VALUE 'N'.         03460000
027900     05  PS-RECEIPTED-RETURN-SW                                   03470000
028000                                  PIC X(1)     VALUE SPACE.       03480000
028100         88  PS-RECEIPTED-RETURN               VALUE 'Y'.         03490000
028200         88  PS-NON-RECEIPTED-RETURN           VALUE 'N'.         03500000
028300     05  PS-END-OF-TEPITM-CSR-SW  PIC X(01)    VALUE 'N'.         03510000
028400         88  PS-END-OF-TEPITM-CSR              VALUE 'Y'.         03520000
028500         88  PS-NOT-END-OF-TEPITM-CSR          VALUE 'N'.         03530000
028600     05  PS-END-OF-TEPLID-CSR-SW  PIC X(01)    VALUE 'N'.         03540000
028700         88  PS-END-OF-TEPLID-CSR              VALUE 'Y'.         03550000
028800         88  PS-NOT-END-OF-TEPLID-CSR          VALUE 'N'.         03560000
028900     05  PS-END-OF-SHP-RTN-CSR-SW PIC X(01)    VALUE 'N'.         03570000
029000         88  PS-END-OF-SHP-RTN-CSR             VALUE 'Y'.         03580000
029100         88  PS-NOT-END-OF-SHP-RTN-CSR         VALUE 'N'.         03590000
029200     05  PS-EBOGO-ITEM-SW         PIC X(01)    VALUE 'Y'.         03600000
029300         88  PS-EBOGO-ITEM-YES                 VALUE 'Y'.         03610000
029400         88  PS-EBOGO-ITEM-NO                  VALUE 'N'.         03620000
029500     05  PS-EBOGO-GETONE-ITEM-SW  PIC X(01)    VALUE 'Y'.         03630000
029600         88  PS-EBOGO-GETONE-ITEM-YES          VALUE 'Y'.         03640000
029700         88  PS-EBOGO-GETONE-ITEM-NO           VALUE 'N'.         03650000
029800     05  PS-NULL-IND1            PIC S9(4)     COMP VALUE ZERO.   03660000
029900     05  PS-NULL-IND2            PIC S9(4)     COMP VALUE ZERO.   03670000
030000         88  PS-IND2-IS-NULL                   VALUE -1.          03680000
030100     05  PS-NULL-IND3            PIC S9(4)     COMP VALUE ZERO.   03690000
030200     05  PS-NULL-IND4            PIC S9(4)     COMP VALUE ZERO.   03700000
030300     05  PS-ASSOC-CASH-SW        PIC  X(01)    VALUE 'N'.         03710000
030400         88  PS-ASSOC-CASH                     VALUE 'Y'.         03720000
030500         88  PS-NOT-ASSOC-CASH                 VALUE 'N'.         03730000
030510     05  PS-AUTH-NBR-SW          PIC  X(01)    VALUE 'N'.         03740000
030520         88  PS-AUTH-NBR                       VALUE 'Y'.         03750000
030530         88  PS-NOT-AUTH-NBR                   VALUE 'N'.         03760000
030600     05  PS-TEPECX-EXISTS-SW     PIC  X(01)    VALUE 'N'.         03770000
030700         88  PS-TEPECX-EXISTS-YES              VALUE 'Y'.         03780000
030800         88  PS-TEPECX-EXISTS-NO               VALUE 'N'.         03790000
030900     05  PS-OMNI-CHNL-NULL-SW    PIC  X(01)    VALUE 'Y'.         03800000
031000         88  PS-OMNI-CHNL-IS-NULL              VALUE 'Y'.         03810000
031100         88  PS-OMNI-CHNL-IS-NOT-NULL          VALUE 'N'.         03820000
031200                                                                  03830000
031300 01  PC-PROGRAM-CONSTANTS.                                        03840000
031400     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'ARKUT058'.   03850000
031500     05  PC-GIFT-CERT-DEPT       PIC X(03)    VALUE '981'.        03860000
031600     05  PC-GIFT-CARD-DEPT       PIC X(03)    VALUE '983'.        03870000
050222     05  PC-SPHRA-GIFT-CARD-DEPT PIC X(03)    VALUE '712'.        03871000
031700     05  PC-PAYMENT-TRAN-TYPE-CDE                                 03880000
031800                                 PIC X(02)    VALUE '30'.         03890000
031900     05  PC-KEYED-SRC-CDE        PIC X(02)    VALUE '00'.         03900000
032000     05  PC-POS-USERID           PIC X(7)     VALUE 'P.O.S. '.    03910000
032100     05  PC-MAINT-USERID         PIC X(7)     VALUE 'S.A.   '.    03920000
032200     05  PC-PROMOTION-CODE       PIC X(1)     VALUE 'P'.          03930000
032300     05  PC-NINES                PIC S9(4)    COMP                03940000
032400                                              VALUE +9999.        03950000
032500     05  PC-STORE-MAX            PIC S9(4)    COMP                03960000
032600                                              VALUE +5000.        03970000
032700     05  PC-ZIP-MAX              PIC S9(5)    COMP                03980000
032710                                              VALUE +99999.       03990000
032720     05  PC-SCANNING-PENALTY     PIC S9(8)V   COMP-3              04000000
032730                                              VALUE +80011000.    04010000
032740     05  PC-SPACES               PIC X(10)    VALUE SPACES.       04020000
032750                                                                  04030000
032760 01  PV-PROGRAM-VARIABLES.                                        04040000
032770     05  PV-PARAGRAPH-NAME       PIC  X(30)    VALUE SPACE.       04050000
032780     05  PV-OPERATION-MSG-1      PIC  X(40)    VALUE SPACE.       04060000
032790     05  PV-OPERATION-MSG-2      PIC  X(40)    VALUE SPACE.       04070000
032800     05  PV-STORE-SUB            PIC S9(04)   VALUE ZERO COMP.    04080000
032900     05  PV-STORE-SUB2           PIC S9(04)   VALUE ZERO COMP.    04090000
033000     05  PV-LINE-ITEM-NBR        PIC S9(04)   VALUE ZERO COMP.    04100000
033100     05  PV-GIFT-RECPT-CDE       PIC  X(01)   VALUE SPACE.        04110000
033200     05  PV-PARTN-NBR            PIC S9(04)   VALUE ZERO COMP.    04120000
033300     05  PV-STRT-TM              PIC  X(08)   VALUE SPACE.        04130000
033400     05  PV-SEQ-NBR              PIC S9(04)   VALUE ZERO COMP.    04140000
033500     05  PV-NET-CHRGD-AMT        PIC S9(7)V99 VALUE ZERO          04150000
033600                                 COMP-3.                          04160000
033700     05  PV-SBJCT-TO-TX-AMT      PIC S9(7)V99 VALUE ZERO          04170000
033800                                 COMP-3.                          04180000
033900     05  PV-EMPL-DISC-TRN-AMT    PIC S9(7)V99 VALUE ZERO          04190000
034000                                 COMP-3.                          04200000
034100     05  PV-CUST-CHRGD-AMT       PIC S9(7)V99 VALUE ZERO          04210000
034200                                 COMP-3.                          04220000
034300     05  PV-EMPLOYEE-CDE         PIC X(1)     VALUE SPACES.       04230000
034400     05  PV-ASSOC-ID             PIC X(11)    VALUE SPACES.       04240000
034500     05  PV-ACCOUNT-NBR          PIC 9(10)    VALUE ZERO.         04250000
034600     05  PV-ACCOUNT-NBR-X REDEFINES PV-ACCOUNT-NBR                04260000
034700                                 PIC X(10).                       04270000
034800     05  PV-UPC                  PIC 9(13).                       04280000
034900     05  PV-TIME-HHMM            PIC 9(04)    VALUE ZERO.         04290000
035000     05  FILLER  REDEFINES  PV-TIME-HHMM.                         04300000
035100         10  PV-TIME-HH          PIC  9(02).                      04310000
035200         10  PV-TIME-MM          PIC  9(02).                      04320000
035300     05  PV-STR-NBR-9            PIC  9(04)   VALUE ZERO.         04330000
035400     05  PV-RGST-ID-9            PIC  9(04)   VALUE ZERO.         04340000
035500     05  PV-TRN-NBR-9            PIC  9(04)   VALUE ZERO.         04350000
035600     05  PV-SAVE-STR-NBR         PIC S9(04)   COMP VALUE ZERO.    04360000
035700     05  PV-WORK-STR-NBR         PIC S9(04)   COMP VALUE ZERO.    04370000
035800     05  PV-WORK-STR-NBR-TEST    PIC  9(04)        VALUE ZERO.    04380000
035900     05  PV-WORK-STR-NBR-PACK    PIC S9(04)   COMP-3 VALUE ZERO.  04390000
036000     05  PV-SAVE-TX-STR-NBR      PIC S9(4)    COMP VALUE ZERO.    04400000
036100     05  PV-SAVE-TXBL-IND        PIC  X(01)   VALUE SPACE.        04410000
036200     05  PV-SAVE-ITM-ASG-TX-ID   PIC  X(1)    VALUE SPACES.       04420000
036300     05  PV-SAVE-RCPT-TX-TOT-CDE PIC  X(02)   VALUE SPACES.       04430000
036400     05  PV-SHIP-ZIP-CODE        PIC  X(05)   VALUE SPACES.       04440000
036500     05  PV-ZIP-CODE-ENCRYPT     PIC  X(24)   VALUE SPACES.       04450000
036600     05  PV-ZIP-LENGTH           PIC  9(09)   VALUE ZEROES.       04460000
036700     05  PV-SHIP-GEO-CODE        PIC  X(02)   VALUE SPACES.       04470000
036800     05  PV-STR-ZIP-CODE         PIC  X(05)   VALUE SPACES.       04480000
036900     05  PV-STR-GEO-CODE         PIC  X(02)   VALUE SPACES.       04490000
037000     05  PV-BUS-LOC-IND          PIC  X(01)   VALUE SPACE.        04500000
037100     05  PV-BOGO-ACTIVE          PIC  X(01)   VALUE SPACE.        04510000
037200     05  PV-TNDR-TYP-CDE         PIC  X(02)     VALUE SPACE.      04520000
037300     05  PV-TNDR-AMT             PIC S9(7)V9(2) COMP-3 VALUE ZERO.04530000
037400     05  PV-TNDR-ID              PIC  X(33)     VALUE ZERO.       04540000
037500     05  PV-DB2-OPERATION        PIC  X(40)     VALUE SPACE.      04550000
037600     05  PV-SKU-NBR              PIC  X(08)     VALUE SPACE.      04560000
037700     05  PV-HOLD-TEPECX          PIC S9(04) COMP VALUE ZERO.      04570000
037800     05  PV-DEPT-CL-SKU.                                          04580000
037900         10  PV-DEPT-NBR         PIC  X(03)     VALUE SPACE.      04590000
038000         10  PV-SUB-CL-NBR       PIC  X(02)     VALUE SPACE.      04600000
038100     05  PV-TNDR-ID-LEN-NBR      PIC  S9(2)V    COMP-3            04610000
038200                                                VALUE ZERO.       04620000
038300     05  PV-SAVE-FULL-TAX-RT     PIC S9(1)V9(5) COMP-3 VALUE ZERO.04630000
038400     05  PV-TAX-INFO.                                             04640000
038500         10  PV-TX-RT-PCT        PIC S9(1)V9(5) COMP-3 VALUE ZERO.04650000
038600         10  PV-TX-AMT           PIC S9(5)V9(2) COMP-3 VALUE ZERO.04660000
038700         10  PV-TAX-IND          PIC X(1)       VALUE SPACE.      04670000
038800         10  PV-TAX-THRESH-AMOUNT                                 04680000
038900                                 PIC S9(5)V9(2) COMP-3 VALUE ZERO.04690000
039000         10  PV-TAX-RATE-BELOW-THRESH                             04700000
039100                                 PIC S9(1)V9(5) COMP-3 VALUE ZERO.04710000
039200         10  PV-ABV-THRS-FTX-IND PIC X(1)            VALUE SPACES.04720000
039300         10  PV-BLW-THRS-FTX-IND PIC X(1)            VALUE SPACES.04730000
039400     05  PV-ORIG-PARTN-NBR        PIC S9(04)    COMP.             04740000
039500     05  PV-ORIG-SLS-CORR-SEQ-NBR PIC S9(04)     COMP.            04750000
039600     05  PV-ORIG-TX-RT-PCT        PIC S9V9(04)   COMP-3.          04760000
039700     05  PV-ORIG-ZIP-5-CDE        PIC X(24).                      04770000
039800     05  PV-ORIG-GEOG-CDE         PIC X(02).                      04780000
039900     05  PV-ORIG-TRN-DTE          PIC X(10).                      04790000
040000     05  PV-SRVC-TYP-CDE          PIC X(01).                      04800000
040100     05  PV-ORD-DTE               PIC X(10).                      04810000
040200     05  PV-LNE-ITM-SEQ-NBR       PIC S9(4) COMP.                 04820000
040300     05  PV-DISPLAY-PARTN         PIC  9(4).                      04830000
040400     05  PV-DISPLAY-STR           PIC  9(4).                      04840000
040500     05  PV-DISPLAY-RGST          PIC  9(4).                      04850000
040600     05  PV-DISPLAY-TRN           PIC  9(4).                      04860000
040700     05  PV-SHP-CSR-SETUP-FIELDS.                                 04870000
040800         10 PV-SHP-PARTN-NBR      PIC  S9(4) COMP.                04880000
040900         10 PV-SHP-STR-NBR        PIC  S9(4) COMP.                04890000
041000         10 PV-SHP-RGST-ID        PIC  S9(4) COMP.                04900000
041100         10 PV-SHP-TRN-NBR        PIC  S9(4) COMP.                04910000
041200         10 PV-SHP-STRT-TM        PIC   X(8).                     04920000
041300         10 PV-SHP-SLS-CORR-SEQ-NBR PIC S9(4) COMP.               04930000
041400     05  PV-EMP-DISC-COUNT          PIC S9(9) COMP-3.             04940000
041500     05  PV-OMNI-CHNL-FFLMT-TYP-CDE PIC  X(3).                    04950000
SHIP2      05  PV-MULT-CLR-SEQ-NBR        PIC  9(4).                    04960000
SHIP2      05  PV-TOT-SHP-NBR             PIC  9(4).                    04970000
041600     05  PV-INPUT-TEXT              PIC X(24).                    04980000
041700     05  PV-OUTPUT-TEXT             PIC X(18)      VALUE SPACES.  04990000
041800     05  PV-TEST-ACCOUNT-NBR        PIC X(10)      VALUE          05000000
041900                                              '9031619304'.       05010000
SHIP       05  PV-FULFILLMENT-TYPE        PIC X(01)      VALUE SPACES.  05020000
SHIP           88  PV-OMNI-BPS-BOS                       VALUE 'O'.     05030000
SHIP           88  PV-SHIP-TO-HOME                       VALUE 'S'.     05040000
042000                                                                  05050000
042100 01  PA-PROGRAM-ACCUMULATORS COMP-3.                              05060000
042200     05  PA-TRANSACTIONS-FETCHED         PIC S9(9) VALUE ZERO.    05070000
042300     05  PA-LATE-COR-ROWS-FETCHED        PIC S9(9) VALUE ZERO.    05080000
042400     05  PA-LATE-VOID-ROWS-FETCHED       PIC S9(9) VALUE ZERO.    05090000
042500     05  PA-RECORDS-WRITTEN              PIC S9(9) VALUE ZERO.    05100000
042600                                                                  05110000
042700 01  TH-TRANSACTION-HOLD-AREA.                                    05120000
042800     05  TH-LINE-NUMBER          PIC 9(3)     VALUE ZERO.         05130000
042900     05  TH-TRANSACTION-CODE     PIC 9(3)     VALUE ZERO.         05140000
043000         88  TH-SALE-TRANSACTION              VALUE 110.          05150000
043100         88  TH-DEBIT-ADJ-TRANSACTION         VALUE 120.          05160000
043200         88  TH-RETURN-TRANSACTION            VALUE 210.          05170000
043300         88  TH-ADJUSTMENT-TRANSACTION        VALUE 230.          05180000
043400         88  TH-PAYMENT-TRANSACTION           VALUE 310.          05190000
043500                                                                  05200000
043600 01  TI-TAX-INFO-TABLE.                                           05210000
043700     05  TI-TAX-INFO-TABLE-ENTRIES OCCURS 9000 TIMES              05220000
043800                                   INDEXED BY TI-IDX.             05230000
043900         10  TI-STR-NBR          PIC S9(4)    COMP.               05240000
044000         10  TI-ASSIGNED-TAX-ID  PIC  X(1).                       05250000
044100         10  TI-TAX-RATE-PCT     PIC S9(1)V9(5) COMP-3.           05260000
044200         10  TI-TAX-THRESH-AMOUNT                                 05270000
044300                                 PIC S9(5)V9(2) COMP-3.           05280000
044400         10  TI-TAX-RATE-BELOW-THRESH                             05290000
044500                                 PIC S9(1)V9(5) COMP-3.           05300000
044600                                                                  05310000
044700 01  EC-ECOM-STORE-TABLE.                                         05320000
044800     05  EC-ECOM-STORE-TABLE-ENTRIES OCCURS 5000 TIMES.           05330000
044900         10  EC-STR-NBR          PIC  9(4).                       05340000
045000         10  EC-BUS-LOC-IND      PIC  X(1).                       05350000
045100         10  EC-ZIP-CODE         PIC  X(10).                      05360000
045200         10  EC-GEO-CODE         PIC  9(2).                       05370000
045300                                                                  05380000
045310******************************************************************05390000
045311*  ZIP-CODE-TABLE - TO STORE THE ENCRYPTED AND ITS CORRESPONDING  05400000
045312*                   DECRYPTED CLEAR ZIP-CODE.                     05410000
045313******************************************************************05420000
045314 01  ZIP-CODE-TABLE.                                              05430000
045315     05  ZIP-CODE-TABLE-ENTRIES OCCURS 99999 TIMES                05440000
045316                               INDEXED BY ZIP-IDX, ZIP-IDX2.      05450000
045317         10  ZIP-ENCRYPT         PIC  X(24).                      05460000
045318         10  ZIP-CLEAR           PIC  X(05).                      05470000
045319                                                                  05480000
045320***************************************************************** 05490000
045330*  ACCOUNTS RECEIVABLE TRANSACTION FILE RECORD LAYOUT             05500000
045340***************************************************************** 05510000
045350     COPY ARRD001.                                                05520000
045360                                                                  05530000
045370***************************************************************** 05540000
045380*  INCLUDE FOR DEPT AND CLASS TABLE                               05550000
045390***************************************************************** 05560000
045400     COPY ARWS012.                                                05570000
045500                                                                  05580000
045600***************************************************************** 05590000
045700*  INCLUDE FOR POS CONSTANT VALUES                                05600000
045800***************************************************************** 05610000
045900     COPY PSWS110.                                                05620000
046000                                                                  05630000
046100******************************************************************05640000
046200*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA        05650000
046300******************************************************************05660000
046400     COPY DPWS022.                                                05670000
046500                                                                  05680000
046600******************************************************************05690000
046700*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             05700000
046800******************************************************************05710000
046900     COPY DPWS500.                                                05720000
047000                                                                  05730000
047100******************************************************************05740000
047200* LAYOUT FOR THE PARAMETERS NEEDED TO INVOKE PROTEGRITY MODULE   *05750000
047300******************************************************************05760000
047310     COPY PTYCCSIP.                                               05770000
047320                                                                  05780000
047330******************************************************************05790000
047340* LAYOUT FOR THE WORKING VARIABLES TO INVOKE PROTEGRITY MODULE   *05800000
047350******************************************************************05810000
047360     COPY DPWS031.                                                05820000
047370                                                                  05830000
047380******************************************************************05840000
047390* LAYOUT FOR THE WORKING VARIABLES TO INVOKE DPKUT052 MODULE     *05850000
047391******************************************************************05860000
047392     COPY DPWS053.                                                05870000
047393                                                                  05880000
047394******************************************************************05890000
047395*  DB2 ERROR COPYBOOK                                             05900000
047396******************************************************************05910000
047397     COPY DPWS004.                                                05920000
047398                                                                  05930000
047399******************************************************************05940000
047400*  POS TRANSACTION TABLE LAYOUT                                   05950000
047500******************************************************************05960000
047600     EXEC SQL                                                     05970000
047700         INCLUDE TEPTRN                                           05980000
047800     END-EXEC.                                                    05990000
047900                                                                  06000000
048000******************************************************************06010000
048100*  TAX RECEIPT TOTAL TABLE                                        06020000
048200******************************************************************06030000
048300     EXEC SQL                                                     06040000
048400         INCLUDE TEPRTX                                           06050000
048500     END-EXEC.                                                    06060000
048600                                                                  06070000
048700******************************************************************06080000
048800*  ITEM PLANNED SHIPMENT TABLE                                    06090000
048900******************************************************************06100000
049000     EXEC SQL                                                     06110000
049100         INCLUDE TEPIPS                                           06120000
049200     END-EXEC.                                                    06130000
049300                                                                  06140000
049400******************************************************************06150000
049500*  POS TENDER TABLE LAYOUT                                        06160000
049600******************************************************************06170000
049700     EXEC SQL                                                     06180000
049800         INCLUDE TEPTND                                           06190000
049900     END-EXEC.                                                    06200000
050000                                                                  06210000
050100******************************************************************06220000
050200*  POS CREDIT TENDER TABLE LAYOUT                                 06230000
050300******************************************************************06240000
050400     EXEC SQL                                                     06250000
050500         INCLUDE TEPCRD                                           06260000
050600     END-EXEC.                                                    06270000
050700                                                                  06280000
050800******************************************************************06290000
050900*  POS ITEM TABLE LAYOUT                                          06300000
051000******************************************************************06310000
051100     EXEC SQL                                                     06320000
051200         INCLUDE TEPITM                                           06330000
051300     END-EXEC.                                                    06340000
051400                                                                  06350000
051500******************************************************************06360000
051600*  POS PROCESSING KEY TABLE LAYOUT (FOR LATE AND SALES CORRECTION 06370000
051700*  TRANSACTIONS)                                                  06380000
051800******************************************************************06390000
051900     EXEC SQL                                                     06400000
052000         INCLUDE TEPDKEY                                          06410000
052100     END-EXEC.                                                    06420000
052200                                                                  06430000
052300******************************************************************06440000
052400*  POS KOHLS PAYMENT TABLE                                        06450000
052500******************************************************************06460000
052600     EXEC SQL                                                     06470000
052700         INCLUDE TEPPAY                                           06480000
052800     END-EXEC.                                                    06490000
052900                                                                  06500000
053000******************************************************************06510000
053100*  POS PARTITION TABLE                                            06520000
053200******************************************************************06530000
053300     EXEC SQL                                                     06540000
053400         INCLUDE TEPPART                                          06550000
053500     END-EXEC.                                                    06560000
053600                                                                  06570000
053700******************************************************************06580000
053800*  POS ITEM RETURN TABLE                                          06590000
053900******************************************************************06600000
054000     EXEC SQL                                                     06610000
054100         INCLUDE TEPIRT                                           06620000
054200     END-EXEC.                                                    06630000
054300                                                                  06640000
054400******************************************************************06650000
054500*  POS LINE ITEM DISCOUNT TABLE                                   06660000
054600******************************************************************06670000
054700     EXEC SQL                                                     06680000
054800         INCLUDE TEPLID                                           06690000
054900     END-EXEC.                                                    06700000
055000                                                                  06710000
055100******************************************************************06720000
055200*  POS TRANSACTION LEVEL DISCOUNT TABLE                           06730000
055300******************************************************************06740000
055400     EXEC SQL                                                     06750000
055500         INCLUDE TEPTLD                                           06760000
055600     END-EXEC.                                                    06770000
055700                                                                  06780000
055800******************************************************************06790000
055900*  TAX RATE BY LOCATION TABLE                                     06800000
056000******************************************************************06810000
056100     EXEC SQL                                                     06820000
056200         INCLUDE TTXRTLO                                          06830000
056300     END-EXEC.                                                    06840000
056400                                                                  06850000
056500******************************************************************06860000
056600*  LINE ITEM SERVICE FEES TABLE                                   06870000
056700******************************************************************06880000
056800     EXEC SQL                                                     06890000
056900         INCLUDE TEPLIS                                           06900000
057000     END-EXEC.                                                    06910000
057100                                                                  06920000
057200******************************************************************06930000
057300*   SHIPPING INFORMATION TABLE                                    06940000
057400******************************************************************06950000
057500     EXEC SQL                                                     06960000
057600         INCLUDE TEPSHP                                           06970000
057700     END-EXEC.                                                    06980000
057800                                                                  06990000
057900******************************************************************07000000
058000*   ORDER NUMBER INFORMATION                                      07010000
058100******************************************************************07020000
058200     EXEC SQL                                                     07030000
058300         INCLUDE TEPORD                                           07040000
058400     END-EXEC.                                                    07050000
058500                                                                  07060000
058600******************************************************************07070000
058700*   CREDIT RETURN AUTHORIZATION TABLE                             07080000
058800******************************************************************07090000
058900     EXEC SQL                                                     07100000
059000         INCLUDE TEPCRR                                           07110000
059100     END-EXEC.                                                    07120000
059200                                                                  07130000
059300******************************************************************07140000
059400*   RETURN TRANSACTION AUTHORIZATION TABLE                        07150000
059500******************************************************************07160000
059600     EXEC SQL                                                     07170000
059700         INCLUDE TEPTRT                                           07180000
059800     END-EXEC.                                                    07190000
059900                                                                  07200000
060000******************************************************************07210000
060100* XS DOMAIN LOCATION TABLE.  XST_LOC                              07220000
060200******************************************************************07230000
060300     EXEC SQL                                                     07240000
060400         INCLUDE XST00001                                         07250000
060500     END-EXEC.                                                    07260000
060600                                                                  07270000
060700******************************************************************07280000
060800* XS LOCATION ATTRIBUTE TABLE   XST_LOC_ATTR                      07290000
060900******************************************************************07300000
061000     EXEC SQL                                                     07310000
061100         INCLUDE XST00025                                         07320000
061200     END-EXEC.                                                    07330000
061300                                                                  07340000
061400******************************************************************07350000
061500* EMPLOYEE DISCOUNT TABLE.   ART_EMP_DISC                         07360000
061600******************************************************************07370000
061700     EXEC SQL                                                     07380000
061800         INCLUDE ART00001                                         07390000
061900     END-EXEC.                                                    07400000
062000                                                                  07410000
062100******************************************************************07420000
062200*  EMPLOYEE DISCOUNT TABLE.                                       07430000
062300******************************************************************07440000
062400     EXEC SQL                                                     07450000
062500         INCLUDE TEPEID                                           07460000
062600     END-EXEC.                                                    07470000
062700                                                                  07480000
062800******************************************************************07490000
062900*  VOID TRANSACTION TABLE.                                        07500000
063000******************************************************************07510000
063100     EXEC SQL                                                     07520000
063200         INCLUDE TEPVDA                                           07530000
063300     END-EXEC.                                                    07540000
063400                                                                  07550000
063500******************************************************************07560000
063600*  ECOMMERCE ORDER CROSS REFERENCE TABLE                          07570000
063700******************************************************************07580000
063800     EXEC SQL                                                     07590000
063900         INCLUDE TEPECX                                           07600000
064000     END-EXEC.                                                    07610000
064100                                                                  07620000
064200******************************************************************07630000
064300*  DB2 AREA FOR COMMUNICATIONS                                    07640000
064400******************************************************************07650000
064500     EXEC SQL                                                     07660000
064600         INCLUDE SQLCA                                            07670000
064700     END-EXEC.                                                    07680000
064800                                                                  07690000
064900******************************************************************07700000
065000*  CURSOR TO CONTROL THE MAIN PROCESSING OF THE PROGRAM           07710000
065100******************************************************************07720000
065200     EXEC SQL                                                     07730000
065300         DECLARE POS-TRN-CSR CURSOR FOR                           07740000
065400             SELECT A.PARTN_NBR                                   07750000
065500                   ,A.STR_NBR                                     07760000
065600                   ,A.RGST_ID                                     07770000
065700                   ,A.TRN_NBR                                     07780000
065800                   ,A.SLS_CORR_SEQ_NBR                            07790000
065900                   ,A.STRT_TM                                     07800000
066000                   ,A.TRN_STAT_CDE                                07810000
066100                   ,A.VOID_ABRT_CDE                               07820000
066200                   ,TRN_TYP_CDE                                   07830000
066300                   ,A.SLS_DTE                                     07840000
066400                   ,TRN_DTE                                       07850000
066500                   ,TRN_TOT_AMT                                   07860000
066600                   ,SLS_TX_AMT                                    07870000
066700                   ,ASSOC_ID                                      07880000
066800                   ,TNDR_ID                                       07890000
066900                   ,TNDR_AMT                                      07900000
067000                   ,B.TNDR_SEQ_NBR                                07910000
067100                   ,AUTH_APVL_CDE                                 07920000
067200                   ,AUTH_NBR                                      07930000
067300                   ,'A'                                           07940000
067400                   ,1                                             07950000
067500                   ,TNDR_ID_SRC_CDE                               07960000
067600                   ,POS_CPBL_LVL_NBR                              07970000
067700                   ,A.OMNI_CHNL_FFLMT_TYP_CDE                     07980000
067800                   ,B.TNDR_ID_LEN_NBR                             07990000
SHIP2                    ,A.VISA_MULT_CLR_SEQ_NBR                       08000000
SHIP2                    ,A.VISA_TOT_SHP_NBR                            08010000
067900             FROM TEPTRN A                                        08020000
068000                 ,TEPTND B                                        08030000
068100                 ,TEPCRD D                                        08040000
068200                 ,TEPPART E                                       08050000
068300             WHERE A.PARTN_NBR     = E.PARTN_NBR                  08060000
068400               AND A.PARTN_NBR     = B.PARTN_NBR                  08070000
068500               AND A.STR_NBR       = B.STR_NBR                    08080000
068600               AND A.RGST_ID       = B.RGST_ID                    08090000
068700               AND A.TRN_NBR       = B.TRN_NBR                    08100000
068800               AND A.STRT_TM       = B.STRT_TM                    08110000
068900               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        08120000
069000               AND B.PARTN_NBR     = D.PARTN_NBR                  08130000
069100               AND B.STR_NBR       = D.STR_NBR                    08140000
069200               AND B.RGST_ID       = D.RGST_ID                    08150000
069300               AND B.TRN_NBR       = D.TRN_NBR                    08160000
069400               AND B.STRT_TM       = D.STRT_TM                    08170000
069500               AND B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        08180000
069600               AND B.TNDR_SEQ_NBR  = D.TNDR_SEQ_NBR               08190000
069700               AND E.SLS_DTE       = :EPPART-SLS-DTE              08200000
069800               AND E.STR_GP_CDE    = 'A'                          08210000
069900               AND VOID_ABRT_CDE   = 'N'                          08220000
070000               AND TRN_STAT_CDE    = 'Z'                          08230000
070100               AND TNDR_TYP_CDE    = '04'                         08240000
070200               AND TNDR_VOID_IND   = 'N'                          08250000
070300               AND TNDR_AMT        <> 0                           08260000
052223               AND D.TRLING_TRN_IND <> 'Y'                        08261001
070400             UNION ALL                                            08270000
070500             SELECT A.PARTN_NBR                                   08280000
070600                   ,A.STR_NBR                                     08290000
070700                   ,A.RGST_ID                                     08300000
070800                   ,A.TRN_NBR                                     08310000
070900                   ,A.SLS_CORR_SEQ_NBR                            08320000
071000                   ,A.STRT_TM                                     08330000
071100                   ,A.TRN_STAT_CDE                                08340000
071200                   ,A.VOID_ABRT_CDE                               08350000
071300                   ,A.TRN_TYP_CDE                                 08360000
071400                   ,A.SLS_DTE                                     08370000
071500                   ,A.TRN_DTE                                     08380000
071600                   ,1                                             08390000
071700                   ,1                                             08400000
071800                   ,ASSOC_ID                                      08410000
071900                   ,'A'                                           08420000
072000                   ,1                                             08430000
072100                   ,1                                             08440000
072200                   ,AUTH_APVL_CDE                                 08450000
072300                   ,AUTH_NBR                                      08460000
072400                   ,KC_ACCT_NBR                                   08470000
072500                   ,PAYT_AMT                                      08480000
072600                   ,KC_ACCT_SRC_CDE                               08490000
072700                   ,POS_CPBL_LVL_NBR                              08500000
072800                   ,A.OMNI_CHNL_FFLMT_TYP_CDE                     08510000
072900                   ,1                                             08520000
SHIP2                    ,A.VISA_MULT_CLR_SEQ_NBR                       08530000
SHIP2                    ,A.VISA_TOT_SHP_NBR                            08540000
073000             FROM   TEPTRN A                                      08550000
073100                   ,TEPPAY C                                      08560000
073200                   ,TEPPART E                                     08570000
073300             WHERE A.PARTN_NBR     = E.PARTN_NBR                  08580000
073400               AND A.PARTN_NBR     = C.PARTN_NBR                  08590000
073500               AND A.STR_NBR       = C.STR_NBR                    08600000
073600               AND A.RGST_ID       = C.RGST_ID                    08610000
073700               AND A.TRN_NBR       = C.TRN_NBR                    08620000
073800               AND A.STRT_TM       = C.STRT_TM                    08630000
073900               AND A.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR        08640000
074000               AND E.SLS_DTE       = :EPPART-SLS-DTE              08650000
074100               AND E.STR_GP_CDE    = 'A'                          08660000
074200               AND VOID_ABRT_CDE   = 'N'                          08670000
074300               AND TRN_STAT_CDE    = 'Z'                          08680000
052223               AND C.TRLING_TRN_IND <> 'Y'                        08681001
052223               AND C.COBRND_IND     <> 'Y'                        08682001
074400             ORDER BY 2                                           08690000
074500                     ,3                                           08700000
074600                     ,4                                           08710000
074700             WITH UR                                              08720000
074800     END-EXEC.                                                    08730000
074900                                                                  08740000
075000******************************************************************08750000
075100*  CURSOR TO CONTROL THE RETRIEVAL OF THE LATE AND CORRECTION     08760000
075200*  TRANSACTIONS                                                   08770000
075300******************************************************************08780000
075400     EXEC SQL                                                     08790000
075500      DECLARE LATE-COR-CSR CURSOR FOR                             08800000
075600       SELECT A.PARTN_NBR                                         08810000
075700             ,A.STR_NBR                                           08820000
075800             ,A.RGST_ID                                           08830000
075900             ,A.TRN_NBR                                           08840000
076000             ,A.SLS_CORR_SEQ_NBR                                  08850000
076100             ,A.STRT_TM                                           08860000
076200             ,A.TRN_STAT_CDE                                      08870000
076300             ,A.VOID_ABRT_CDE                                     08880000
076400             ,TRN_TYP_CDE                                         08890000
076500             ,A.SLS_DTE                                           08900000
076600             ,TRN_DTE                                             08910000
076700             ,TRN_TOT_AMT                                         08920000
076800             ,SLS_TX_AMT                                          08930000
076900             ,ASSOC_ID                                            08940000
077000             ,TNDR_ID                                             08950000
077100             ,TNDR_AMT                                            08960000
077200             ,B.TNDR_SEQ_NBR                                      08970000
077300             ,AUTH_APVL_CDE                                       08980000
077400             ,AUTH_NBR                                            08990000
077500             ,'A'                                                 09000000
077600             ,1                                                   09010000
077700             ,TNDR_ID_SRC_CDE                                     09020000
077800             ,POS_CPBL_LVL_NBR                                    09030000
077900             ,A.OMNI_CHNL_FFLMT_TYP_CDE                           09040000
078000             ,B.TNDR_ID_LEN_NBR                                   09050000
SHIP2              ,A.VISA_MULT_CLR_SEQ_NBR                             09060000
SHIP2              ,A.VISA_TOT_SHP_NBR                                  09070000
078100      FROM TEPTRN A                                               09080000
078200          ,TEPTND B                                               09090000
078300          ,TEPDKEY D                                              09100000
078400          ,TEPCRD E                                               09110000
078500          ,TEPPART F                                              09120000
078600      WHERE A.PARTN_NBR     = B.PARTN_NBR                         09130000
078700       AND A.STR_NBR       = B.STR_NBR                            09140000
078800       AND A.RGST_ID       = B.RGST_ID                            09150000
078900       AND A.TRN_NBR       = B.TRN_NBR                            09160000
079000       AND A.STRT_TM       = B.STRT_TM                            09170000
079100       AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR                09180000
079200       AND A.PARTN_NBR     = F.PARTN_NBR                          09190000
079300       AND D.SLS_DTE       = F.SLS_DTE                            09200000
079400       AND A.STR_NBR       = D.STR_NBR                            09210000
079500       AND A.RGST_ID       = D.RGST_ID                            09220000
079600       AND A.TRN_NBR       = D.TRN_NBR                            09230000
079700       AND A.STRT_TM       = D.STRT_TM                            09240000
079800       AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR                09250000
079900       AND B.PARTN_NBR     = E.PARTN_NBR                          09260000
080000       AND B.STR_NBR       = E.STR_NBR                            09270000
080100       AND B.RGST_ID       = E.RGST_ID                            09280000
080200       AND B.TRN_NBR       = E.TRN_NBR                            09290000
080300       AND B.STRT_TM       = E.STRT_TM                            09300000
080400       AND B.SLS_CORR_SEQ_NBR = E.SLS_CORR_SEQ_NBR                09310000
080500       AND B.TNDR_SEQ_NBR  = E.TNDR_SEQ_NBR                       09320000
080600       AND D.PRCG_DTE      = :EPDKEY-PRCG-DTE                     09330000
080700       AND VOID_ABRT_CDE   = 'N'                                  09340000
080800       AND TRN_STAT_CDE    IN ('V', 'L')                          09350000
080900       AND TNDR_TYP_CDE    = '04'                                 09360000
081000       AND TNDR_VOID_IND   = 'N'                                  09370000
081100       AND TNDR_AMT       <> 0                                    09380000
052223       AND E.TRLING_TRN_IND <> 'Y'                                09381001
081200   UNION ALL                                                      09390000
081300     SELECT   A.PARTN_NBR                                         09400000
081400             ,A.STR_NBR                                           09410000
081500             ,A.RGST_ID                                           09420000
081600             ,A.TRN_NBR                                           09430000
081700             ,A.SLS_CORR_SEQ_NBR                                  09440000
081800             ,A.STRT_TM                                           09450000
081900             ,A.TRN_STAT_CDE                                      09460000
082000             ,A.VOID_ABRT_CDE                                     09470000
082100             ,TRN_TYP_CDE                                         09480000
082200             ,A.SLS_DTE                                           09490000
082300             ,TRN_DTE                                             09500000
082400             ,TRN_TOT_AMT                                         09510000
082500             ,SLS_TX_AMT                                          09520000
082600             ,ASSOC_ID                                            09530000
082700             ,TNDR_ID                                             09540000
082800             ,TNDR_AMT                                            09550000
082900             ,B.TNDR_SEQ_NBR                                      09560000
083000             ,AUTH_APVL_CDE                                       09570000
083100             ,AUTH_NBR                                            09580000
083200             ,'A'                                                 09590000
083300             ,1                                                   09600000
083400             ,TNDR_ID_SRC_CDE                                     09610000
083500             ,POS_CPBL_LVL_NBR                                    09620000
083600             ,A.OMNI_CHNL_FFLMT_TYP_CDE                           09630000
083700             ,B.TNDR_ID_LEN_NBR                                   09640000
SHIP2              ,A.VISA_MULT_CLR_SEQ_NBR                             09650000
SHIP2              ,A.VISA_TOT_SHP_NBR                                  09660000
083800          FROM TEPTRN A                                           09670000
083900              ,TEPTND B                                           09680000
084000              ,TEPDKEY D                                          09690000
084100              ,TEPCRD E                                           09700000
084200              ,TEPPART F                                          09710000
084300      WHERE A.PARTN_NBR     = B.PARTN_NBR                         09720000
084400        AND A.STR_NBR       = B.STR_NBR                           09730000
084500        AND A.RGST_ID       = B.RGST_ID                           09740000
084600        AND A.TRN_NBR       = B.TRN_NBR                           09750000
084700        AND A.STRT_TM       = B.STRT_TM                           09760000
084800        AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR               09770000
084900        AND A.PARTN_NBR     = F.PARTN_NBR                         09780000
085000        AND D.SLS_DTE       = F.SLS_DTE                           09790000
085100        AND A.STR_NBR       = D.STR_NBR                           09800000
085200        AND A.RGST_ID       = D.RGST_ID                           09810000
085300        AND A.TRN_NBR       = D.TRN_NBR                           09820000
085400        AND A.STRT_TM       = D.STRT_TM                           09830000
085500        AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR               09840000
085600        AND B.PARTN_NBR     = E.PARTN_NBR                         09850000
085700        AND B.STR_NBR       = E.STR_NBR                           09860000
085800        AND B.RGST_ID       = E.RGST_ID                           09870000
085900        AND B.TRN_NBR       = E.TRN_NBR                           09880000
086000        AND B.STRT_TM       = E.STRT_TM                           09890000
086100        AND B.SLS_CORR_SEQ_NBR = E.SLS_CORR_SEQ_NBR               09900000
086200        AND B.TNDR_SEQ_NBR  = E.TNDR_SEQ_NBR                      09910000
086300        AND D.PRCG_DTE      = :EPDKEY-PRCG-DTE                    09920000
086400        AND VOID_ABRT_CDE   = 'N'                                 09930000
086500        AND TRN_STAT_CDE    = 'R'                                 09940000
086600        AND TNDR_TYP_CDE    = '04'                                09950000
086700        AND TNDR_VOID_IND   = 'N'                                 09960000
086800        AND TNDR_AMT       <> 0                                   09970000
052223        AND E.TRLING_TRN_IND <> 'Y'                               09971001
086900        AND NOT EXISTS                                            09980000
087000           (SELECT 1 FROM TEPTRN T1                               09990000
087100            WHERE  T1.PARTN_NBR        = A.PARTN_NBR              10000000
087200            AND T1.SLS_DTE             = A.SLS_DTE                10010000
087300            AND T1.PRCG_DTE            = A.PRCG_DTE               10020000
087400            AND T1.STR_NBR             = A.STR_NBR                10030000
087500            AND T1.RGST_ID             = A.RGST_ID                10040000
087600            AND B.TRN_NBR              = A.TRN_NBR                10050000
087700            AND B.STRT_TM              = A.STRT_TM                10060000
087800            AND VOID_ABRT_CDE          = 'R'                      10070000
087900            AND TRN_STAT_CDE           = 'V'                      10080000
088000           )                                                      10090000
088100             UNION ALL                                            10100000
088200              SELECT A.PARTN_NBR                                  10110000
088300                 ,A.STR_NBR                                       10120000
088400                 ,A.RGST_ID                                       10130000
088500                 ,A.TRN_NBR                                       10140000
088600                 ,A.SLS_CORR_SEQ_NBR                              10150000
088700                 ,A.STRT_TM                                       10160000
088800                 ,A.TRN_STAT_CDE                                  10170000
088900                 ,A.VOID_ABRT_CDE                                 10180000
089000                 ,A.TRN_TYP_CDE                                   10190000
089100                 ,A.SLS_DTE                                       10200000
089200                 ,A.TRN_DTE                                       10210000
089300                 ,1                                               10220000
089400                 ,1                                               10230000
089500                 ,ASSOC_ID                                        10240000
089600                 ,'A'                                             10250000
089700                 ,1                                               10260000
089800                 ,1                                               10270000
089900                 ,AUTH_APVL_CDE                                   10280000
090000                 ,AUTH_NBR                                        10290000
090100                 ,KC_ACCT_NBR                                     10300000
090200                 ,PAYT_AMT                                        10310000
090300                 ,KC_ACCT_SRC_CDE                                 10320000
090400                 ,POS_CPBL_LVL_NBR                                10330000
090500                 ,A.OMNI_CHNL_FFLMT_TYP_CDE                       10340000
090600                 ,1                                               10350000
SHIP2                  ,A.VISA_MULT_CLR_SEQ_NBR                         10360000
SHIP2                  ,A.VISA_TOT_SHP_NBR                              10370000
090700         FROM   TEPTRN A                                          10380000
090800               ,TEPPAY C                                          10390000
090900               ,TEPDKEY D                                         10400000
091000               ,TEPPART F                                         10410000
091100       WHERE A.PARTN_NBR     = C.PARTN_NBR                        10420000
091200         AND A.STR_NBR       = C.STR_NBR                          10430000
091300         AND A.RGST_ID       = C.RGST_ID                          10440000
091400         AND A.TRN_NBR       = C.TRN_NBR                          10450000
091500         AND A.STRT_TM       = C.STRT_TM                          10460000
091600         AND A.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR              10470000
091700         AND A.STR_NBR       = D.STR_NBR                          10480000
091800         AND A.RGST_ID       = D.RGST_ID                          10490000
091900         AND A.TRN_NBR       = D.TRN_NBR                          10500000
092000         AND A.STRT_TM       = D.STRT_TM                          10510000
092100         AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR              10520000
092200         AND A.PARTN_NBR     = F.PARTN_NBR                        10530000
092300         AND D.PRCG_DTE      = :EPDKEY-PRCG-DTE                   10540000
092400         AND D.SLS_DTE       = F.SLS_DTE                          10550000
092500        AND VOID_ABRT_CDE   = 'N'                                 10560000
092600        AND TRN_STAT_CDE    IN ('V', 'L')                         10570000
052223        AND C.TRLING_TRN_IND <> 'Y'                               10571001
052223        AND C.COBRND_IND     <> 'Y'                               10572001
092700        UNION ALL                                                 10580000
092800              SELECT A.PARTN_NBR                                  10590000
092900                 ,A.STR_NBR                                       10600000
093000                 ,A.RGST_ID                                       10610000
093100                 ,A.TRN_NBR                                       10620000
093200                 ,A.SLS_CORR_SEQ_NBR                              10630000
093300                 ,A.STRT_TM                                       10640000
093400                 ,A.TRN_STAT_CDE                                  10650000
093500                 ,A.VOID_ABRT_CDE                                 10660000
093600                 ,A.TRN_TYP_CDE                                   10670000
093700                 ,A.SLS_DTE                                       10680000
093800                 ,A.TRN_DTE                                       10690000
093900                 ,1                                               10700000
094000                 ,1                                               10710000
094100                 ,ASSOC_ID                                        10720000
094200                 ,'A'                                             10730000
094300                 ,1                                               10740000
094400                 ,1                                               10750000
094500                 ,AUTH_APVL_CDE                                   10760000
094600                 ,AUTH_NBR                                        10770000
094700                 ,KC_ACCT_NBR                                     10780000
094800                 ,PAYT_AMT                                        10790000
094900                 ,KC_ACCT_SRC_CDE                                 10800000
095000                 ,POS_CPBL_LVL_NBR                                10810000
095100                 ,A.OMNI_CHNL_FFLMT_TYP_CDE                       10820000
095200                 ,1                                               10830000
SHIP2                  ,A.VISA_MULT_CLR_SEQ_NBR                         10840000
SHIP2                  ,A.VISA_TOT_SHP_NBR                              10850000
095300       FROM   TEPTRN A                                            10860000
095400             ,TEPPAY C                                            10870000
095500             ,TEPDKEY D                                           10880000
095600             ,TEPPART F                                           10890000
095700       WHERE A.PARTN_NBR     = C.PARTN_NBR                        10900000
095800         AND A.STR_NBR       = C.STR_NBR                          10910000
095900         AND A.RGST_ID       = C.RGST_ID                          10920000
096000         AND A.TRN_NBR       = C.TRN_NBR                          10930000
096100         AND A.STRT_TM       = C.STRT_TM                          10940000
096200         AND A.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR              10950000
096300         AND A.STR_NBR       = D.STR_NBR                          10960000
096400         AND A.RGST_ID       = D.RGST_ID                          10970000
096500         AND A.TRN_NBR       = D.TRN_NBR                          10980000
096600         AND A.STRT_TM       = D.STRT_TM                          10990000
096700         AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR              11000000
096800         AND A.PARTN_NBR     = F.PARTN_NBR                        11010000
096900         AND D.PRCG_DTE      = :EPDKEY-PRCG-DTE                   11020000
097000         AND D.SLS_DTE       = F.SLS_DTE                          11030000
097100         AND VOID_ABRT_CDE   = 'N'                                11040000
097200         AND TRN_STAT_CDE    ='R'                                 11050000
052223         AND C.TRLING_TRN_IND <> 'Y'                              11051001
052223         AND C.COBRND_IND     <> 'Y'                              11052001
097300         AND NOT EXISTS                                           11060000
097400            (SELECT 1 FROM TEPTRN T1                              11070000
097500             WHERE  T1.PARTN_NBR        = A.PARTN_NBR             11080000
097600              AND T1.SLS_DTE          = A.SLS_DTE                 11090000
097700              AND T1.PRCG_DTE          = A.PRCG_DTE               11100000
097800              AND T1.STR_NBR          = A.STR_NBR                 11110000
097900              AND T1.RGST_ID          = A.RGST_ID                 11120000
098000              AND D.TRN_NBR          = A.TRN_NBR                  11130000
098100              AND D.STRT_TM          = A.STRT_TM                  11140000
098200              AND VOID_ABRT_CDE      = 'R'                        11150000
098300              AND TRN_STAT_CDE      =  'V'                        11160000
098400            )                                                     11170000
098500      ORDER BY 2                                                  11180000
098600              ,3                                                  11190000
098700              ,4                                                  11200000
098800      WITH UR                                                     11210000
098900     END-EXEC.                                                    11220000
099000                                                                  11230000
099100******************************************************************11240000
099200*  CURSOR TO RETRIEVE LATE VOID TRANSACTIONS                     *11250000
099300*                                                                *11260000
099400* TEPDKEY - IDENTIFIES LATE TRANSACTIONS PROCESSED TODAY.        *11270000
099500*                                                                *11280000
099600* TEPPART - PROVIDES THE PARTITION NUMBER FOR THE LATE           *11290000
099700*           TRANSACTION.                                         *11300000
099800*                                                                *11310000
099900* TEPVDA  - PROVIDES THE TRANSACTION NUMBER THAT WAS VOIDED.     *11320000
100000*                                                                *11330000
100100* TEPTRN  - TRANSACTION INFORMATION.                             *11340000
100200*                                                                *11350000
100300* TEPTND  - TENDER INFORMATION FOR SALES AND RETURNS             *11360000
100400*                                                                *11370000
100500* TEPPAY  - ACCOUNT PAYMENT INFORMATION.                         *11380000
100600*                                                                *11390000
100700******************************************************************11400000
100800     EXEC SQL                                                     11410000
100900         DECLARE LATE-VOID-CSR CURSOR FOR                         11420000
101000         SELECT D.PARTN_NBR                                       11430000
101100               ,D.STR_NBR                                         11440000
101200               ,D.RGST_ID                                         11450000
101300               ,D.TRN_NBR                                         11460000
101400               ,D.SLS_CORR_SEQ_NBR                                11470000
101500               ,D.STRT_TM                                         11480000
101600               ,D.TRN_STAT_CDE                                    11490000
101700               ,D.VOID_ABRT_CDE                                   11500000
101800               ,D.TRN_TYP_CDE                                     11510000
101900               ,D.SLS_DTE                                         11520000
102000               ,D.TRN_DTE                                         11530000
102100               ,D.TRN_TOT_AMT                                     11540000
102200               ,D.SLS_TX_AMT                                      11550000
102300               ,D.ASSOC_ID                                        11560000
102400               ,E.TNDR_ID                                         11570000
102500               ,E.TNDR_AMT                                        11580000
102600               ,E.TNDR_SEQ_NBR                                    11590000
102700               ,F.AUTH_APVL_CDE                                   11600000
102800               ,F.AUTH_NBR                                        11610000
102900               ,'A'                                               11620000
103000               ,1                                                 11630000
103100               ,E.TNDR_ID_SRC_CDE                                 11640000
103200               ,POS_CPBL_LVL_NBR                                  11650000
103300               ,D.OMNI_CHNL_FFLMT_TYP_CDE                         11660000
103310               ,E.TNDR_ID_LEN_NBR                                 11670000
SHIP2                ,D.VISA_MULT_CLR_SEQ_NBR                           11680000
SHIP2                ,D.VISA_TOT_SHP_NBR                                11690000
103320           FROM TEPDKEY A                                         11700000
103330               ,TEPPART B                                         11710000
103340               ,TEPVDA  C                                         11720000
103350               ,TEPTRN  D                                         11730000
103360               ,TEPTND  E                                         11740000
103370               ,TEPCRD  F                                         11750000
103380           WHERE B.SLS_DTE       = A.SLS_DTE                      11760000
103390             AND C.PARTN_NBR     = B.PARTN_NBR                    11770000
103400             AND C.STR_NBR       = A.STR_NBR                      11780000
103500             AND C.RGST_ID       = A.RGST_ID                      11790000
103600             AND C.TRN_NBR       = A.TRN_NBR                      11800000
103700             AND C.STRT_TM       = A.STRT_TM                      11810000
103800             AND C.SLS_CORR_SEQ_NBR                               11820000
103900                                 = A.SLS_CORR_SEQ_NBR             11830000
104000             AND D.PARTN_NBR     = C.PARTN_NBR                    11840000
104100             AND D.STR_NBR       = C.STR_NBR                      11850000
104200             AND D.RGST_ID       = C.RGST_ID                      11860000
104300             AND D.TRN_NBR       = C.VOID_TRN_NBR                 11870000
104400             AND E.PARTN_NBR     = D.PARTN_NBR                    11880000
104500             AND E.STR_NBR       = D.STR_NBR                      11890000
104600             AND E.RGST_ID       = D.RGST_ID                      11900000
104700             AND E.TRN_NBR       = D.TRN_NBR                      11910000
104800             AND E.STRT_TM       = D.STRT_TM                      11920000
104900             AND E.SLS_CORR_SEQ_NBR                               11930000
105000                                 = D.SLS_CORR_SEQ_NBR             11940000
105100             AND F.PARTN_NBR     = D.PARTN_NBR                    11950000
105200             AND F.STR_NBR       = D.STR_NBR                      11960000
105300             AND F.RGST_ID       = D.RGST_ID                      11970000
105400             AND F.TRN_NBR       = D.TRN_NBR                      11980000
105500             AND F.STRT_TM       = D.STRT_TM                      11990000
105600             AND F.SLS_CORR_SEQ_NBR                               12000000
105700                                 = D.SLS_CORR_SEQ_NBR             12010000
105800             AND F.TNDR_SEQ_NBR  = E.TNDR_SEQ_NBR                 12020000
105900             AND A.PRCG_DTE      = :EPDKEY-PRCG-DTE               12030000
106100             AND D.TRN_STAT_CDE  = 'Z'                            12050000
106300             AND E.TNDR_TYP_CDE  = '04'                           12070000
106400             AND E.TNDR_VOID_IND ='N'                             12080000
106500             AND E.TNDR_AMT      <> 0                             12090000
052223             AND F.TRLING_TRN_IND <> 'Y'                          12091001
106600       UNION                                                      12100000
106700           SELECT D.PARTN_NBR                                     12110000
106800                 ,D.STR_NBR                                       12120000
106900                 ,D.RGST_ID                                       12130000
107000                 ,D.TRN_NBR                                       12140000
107100                 ,D.SLS_CORR_SEQ_NBR                              12150000
107200                 ,D.STRT_TM                                       12160000
107300                 ,D.TRN_STAT_CDE                                  12170000
107400                 ,D.VOID_ABRT_CDE                                 12180000
107500                 ,D.TRN_TYP_CDE                                   12190000
107600                 ,D.SLS_DTE                                       12200000
107700                 ,D.TRN_DTE                                       12210000
107800                 ,1                                               12220000
107900                 ,1                                               12230000
108000                 ,D.ASSOC_ID                                      12240000
108100                 ,'A'                                             12250000
108200                 ,1                                               12260000
108300                 ,1                                               12270000
108400                 ,E.AUTH_APVL_CDE                                 12280000
108500                 ,E.AUTH_NBR                                      12290000
108600                 ,E.KC_ACCT_NBR                                   12300000
108700                 ,E.PAYT_AMT                                      12310000
108800                 ,E.KC_ACCT_SRC_CDE                               12320000
108900                 ,POS_CPBL_LVL_NBR                                12330000
109000                 ,D.OMNI_CHNL_FFLMT_TYP_CDE                       12340000
109100                 ,1                                               12350000
SHIP2                  ,D.VISA_MULT_CLR_SEQ_NBR                         12360000
SHIP2                  ,D.VISA_TOT_SHP_NBR                              12370000
109200             FROM TEPDKEY A                                       12380000
109300                 ,TEPPART B                                       12390000
109400                 ,TEPVDA C                                        12400000
109500                 ,TEPTRN D                                        12410000
109600                 ,TEPPAY E                                        12420000
109700           WHERE B.SLS_DTE       = A.SLS_DTE                      12430000
109800             AND C.PARTN_NBR     = B.PARTN_NBR                    12440000
109900             AND C.STR_NBR       = A.STR_NBR                      12450000
110000             AND C.RGST_ID       = A.RGST_ID                      12460000
110100             AND C.TRN_NBR       = A.TRN_NBR                      12470000
110200             AND D.PARTN_NBR     = C.PARTN_NBR                    12480000
110300             AND D.STR_NBR       = C.STR_NBR                      12490000
110400             AND D.RGST_ID       = C.RGST_ID                      12500000
110500             AND D.TRN_NBR       = C.VOID_TRN_NBR                 12510000
110600             AND E.PARTN_NBR     = D.PARTN_NBR                    12520000
110700             AND E.STR_NBR       = D.STR_NBR                      12530000
110800             AND E.RGST_ID       = D.RGST_ID                      12540000
110900             AND E.TRN_NBR       = D.TRN_NBR                      12550000
111000             AND E.STRT_TM       = D.STRT_TM                      12560000
111100             AND E.SLS_CORR_SEQ_NBR                               12570000
111200                                 = D.SLS_CORR_SEQ_NBR             12580000
111300             AND A.PRCG_DTE      = :EPDKEY-PRCG-DTE               12590000
111500             AND D.TRN_STAT_CDE  = 'Z'                            12610000
052223             AND E.TRLING_TRN_IND <> 'Y'                          12620001
052223             AND E.COBRND_IND     <> 'Y'                          12630001
061322       UNION                                                      12650100
061322         SELECT D.PARTN_NBR                                       12651000
061322               ,D.STR_NBR                                         12652000
061322               ,D.RGST_ID                                         12653000
061322               ,D.TRN_NBR                                         12654000
061322               ,D.SLS_CORR_SEQ_NBR                                12655000
061322               ,D.STRT_TM                                         12656000
061322               ,D.TRN_STAT_CDE                                    12657000
061322               ,D.VOID_ABRT_CDE                                   12658000
061322               ,D.TRN_TYP_CDE                                     12659000
061322               ,D.SLS_DTE                                         12659100
061322               ,D.TRN_DTE                                         12659200
061322               ,D.TRN_TOT_AMT                                     12659300
061322               ,D.SLS_TX_AMT                                      12659400
061322               ,D.ASSOC_ID                                        12659500
061322               ,E.TNDR_ID                                         12659600
061322               ,E.TNDR_AMT                                        12659700
061322               ,E.TNDR_SEQ_NBR                                    12659800
061322               ,F.AUTH_APVL_CDE                                   12659900
061322               ,F.AUTH_NBR                                        12660000
061322               ,'A'                                               12660100
061322               ,1                                                 12660200
061322               ,E.TNDR_ID_SRC_CDE                                 12660300
061322               ,POS_CPBL_LVL_NBR                                  12660400
061322               ,D.OMNI_CHNL_FFLMT_TYP_CDE                         12660500
061322               ,E.TNDR_ID_LEN_NBR                                 12660600
061322               ,D.VISA_MULT_CLR_SEQ_NBR                           12660700
061322               ,D.VISA_TOT_SHP_NBR                                12660800
061322           FROM TEPDKEY A                                         12660900
061322               ,TEPPART B                                         12661000
061322               ,TEPVDA  C                                         12661100
061322               ,TEPTRN  D                                         12661200
061322               ,TEPTND  E                                         12661300
061322               ,TEPCRD  F                                         12661400
061322           WHERE B.SLS_DTE       = A.SLS_DTE                      12661500
061322             AND C.PARTN_NBR     = B.PARTN_NBR                    12661600
061322             AND C.STR_NBR       = A.STR_NBR                      12661700
061322             AND C.RGST_ID       = A.RGST_ID                      12661800
061322             AND C.TRN_NBR       = A.TRN_NBR                      12661900
061322             AND C.STRT_TM       = A.STRT_TM                      12662000
061322             AND C.SLS_CORR_SEQ_NBR                               12662100
061322                                 = A.SLS_CORR_SEQ_NBR             12662200
061322             AND D.PARTN_NBR     = C.PARTN_NBR                    12662300
061322             AND D.STR_NBR       = C.STR_NBR                      12662400
061322             AND D.RGST_ID       = C.RGST_ID                      12662500
061322             AND D.TRN_NBR       = C.VOID_TRN_NBR                 12662600
061322             AND E.PARTN_NBR     = D.PARTN_NBR                    12662700
061322             AND E.STR_NBR       = D.STR_NBR                      12662800
061322             AND E.RGST_ID       = D.RGST_ID                      12662900
061322             AND E.TRN_NBR       = D.TRN_NBR                      12663000
061322             AND E.STRT_TM       = D.STRT_TM                      12663100
061322             AND E.SLS_CORR_SEQ_NBR                               12663200
061322                                 = D.SLS_CORR_SEQ_NBR             12663300
061322             AND F.PARTN_NBR     = D.PARTN_NBR                    12663400
061322             AND F.STR_NBR       = D.STR_NBR                      12663500
061322             AND F.RGST_ID       = D.RGST_ID                      12663600
061322             AND F.TRN_NBR       = D.TRN_NBR                      12663700
061322             AND F.STRT_TM       = D.STRT_TM                      12663800
061322             AND F.SLS_CORR_SEQ_NBR                               12663900
061322                                 = D.SLS_CORR_SEQ_NBR             12664000
061322             AND F.TNDR_SEQ_NBR  = E.TNDR_SEQ_NBR                 12664100
061322             AND A.PRCG_DTE      = :EPDKEY-PRCG-DTE               12664200
061322             AND D.PRCG_DTE     <> A.PRCG_DTE                     12664500
061322             AND D.TRN_STAT_CDE  = 'L'                            12664600
061322             AND E.TNDR_TYP_CDE  = '04'                           12664700
061322             AND E.TNDR_VOID_IND ='N'                             12664800
061322             AND E.TNDR_AMT      <> 0                             12664900
052223             AND F.TRLING_TRN_IND <> 'Y'                          12665001
061322       UNION                                                      12665200
061322           SELECT D.PARTN_NBR                                     12665300
061322                 ,D.STR_NBR                                       12665400
061322                 ,D.RGST_ID                                       12665500
061322                 ,D.TRN_NBR                                       12665600
061322                 ,D.SLS_CORR_SEQ_NBR                              12665700
061322                 ,D.STRT_TM                                       12665800
061322                 ,D.TRN_STAT_CDE                                  12665900
061322                 ,D.VOID_ABRT_CDE                                 12666000
061322                 ,D.TRN_TYP_CDE                                   12666100
061322                 ,D.SLS_DTE                                       12666200
061322                 ,D.TRN_DTE                                       12666300
061322                 ,1                                               12666400
061322                 ,1                                               12666500
061322                 ,D.ASSOC_ID                                      12666600
061322                 ,'A'                                             12666700
061322                 ,1                                               12666800
061322                 ,1                                               12666900
061322                 ,E.AUTH_APVL_CDE                                 12667000
061322                 ,E.AUTH_NBR                                      12667100
061322                 ,E.KC_ACCT_NBR                                   12667200
061322                 ,E.PAYT_AMT                                      12667300
061322                 ,E.KC_ACCT_SRC_CDE                               12667400
061322                 ,POS_CPBL_LVL_NBR                                12667500
061322                 ,D.OMNI_CHNL_FFLMT_TYP_CDE                       12667600
061322                 ,1                                               12667700
061322                 ,D.VISA_MULT_CLR_SEQ_NBR                         12667800
061322                 ,D.VISA_TOT_SHP_NBR                              12667900
061322             FROM TEPDKEY A                                       12668000
061322                 ,TEPPART B                                       12668100
061322                 ,TEPVDA C                                        12668200
061322                 ,TEPTRN D                                        12668300
061322                 ,TEPPAY E                                        12668400
061322           WHERE B.SLS_DTE       = A.SLS_DTE                      12668500
061322             AND C.PARTN_NBR     = B.PARTN_NBR                    12668600
061322             AND C.STR_NBR       = A.STR_NBR                      12668700
061322             AND C.RGST_ID       = A.RGST_ID                      12668800
061322             AND C.TRN_NBR       = A.TRN_NBR                      12668900
061322             AND D.PARTN_NBR     = C.PARTN_NBR                    12669000
061322             AND D.STR_NBR       = C.STR_NBR                      12669100
061322             AND D.RGST_ID       = C.RGST_ID                      12669200
061322             AND D.TRN_NBR       = C.VOID_TRN_NBR                 12669300
061322             AND E.PARTN_NBR     = D.PARTN_NBR                    12669400
061322             AND E.STR_NBR       = D.STR_NBR                      12669500
061322             AND E.RGST_ID       = D.RGST_ID                      12669600
061322             AND E.TRN_NBR       = D.TRN_NBR                      12669700
061322             AND E.STRT_TM       = D.STRT_TM                      12669800
061322             AND E.SLS_CORR_SEQ_NBR                               12669900
061322                                 = D.SLS_CORR_SEQ_NBR             12670000
061322             AND A.PRCG_DTE      = :EPDKEY-PRCG-DTE               12670100
061322             AND D.TRN_STAT_CDE  = 'L'                            12670200
061322             AND D.PRCG_DTE     <> A.PRCG_DTE                     12670300
052223             AND E.TRLING_TRN_IND <> 'Y'                          12670401
052223             AND E.COBRND_IND     <> 'Y'                          12670501
111700           ORDER BY 2                                             12670600
111800                   ,3                                             12670700
111900                   ,4                                             12670800
112000           WITH UR                                                12670900
112100     END-EXEC.                                                    12671000
112200                                                                  12680000
112300******************************************************************12690000
112400*  CURSOR TO RETRIEVE ITEMS FOR THE TRANSACTION                   12700000
112500******************************************************************12710000
112600     EXEC SQL                                                     12720000
112700         DECLARE ITEMS-CSR CURSOR FOR                             12730000
112800             SELECT A.LNE_ITM_SEQ_NBR                             12740000
112900                   ,A.DEPT_NBR                                    12750000
113000                   ,A.SUB_CL_NBR                                  12760000
113100                   ,A.SLD_QTY                                     12770000
113200                   ,A.NET_CHRGD_AMT                               12780000
113300                   ,A.UPC_NBR                                     12790000
113400                   ,A.SAL_RET_CDE                                 12800000
113500                   ,A.TXBL_IND                                    12810000
113600                   ,A.SRVR_ONLN_IND                               12820000
113700                   ,A.CUST_CHRGD_AMT                              12830000
113800                   ,A.ITM_ASG_TX_ID                               12840000
113900                   ,A.RCPT_TX_TOT_CDE                             12850000
114000                   ,A.GFT_RCPT_CDE                                12860000
114100                   ,A.TX_RT_PCT                                   12870000
114200                   ,A.TX_AMT                                      12880000
114300                   ,A.SKU_NBR                                     12890000
114400                   ,A.RCPT_SEQ_NBR                                12900000
114500                   ,A.RET_AMT                                     12910000
114600                   ,A.SBJCT_TO_TX_AMT                             12920000
114700                   ,B.TX_RT_PCT                                   12930000
114800                   ,A.TX_PRD_CDE_DESC                             12940000
114900             FROM TEPITM A                                        12950000
115000             LEFT OUTER JOIN                                      12960000
115100                  TEPRTX B                                        12970000
115200               ON  A.PARTN_NBR        = B.PARTN_NBR               12980000
115300              AND  A.STR_NBR          = B.STR_NBR                 12990000
115400              AND  A.RGST_ID          = B.RGST_ID                 13000000
115500              AND  A.TRN_NBR          = B.TRN_NBR                 13010000
115600              AND  A.STRT_TM          = B.STRT_TM                 13020000
115700              AND  A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        13030000
115800              AND  A.RCPT_TX_TOT_CDE  = B.RCPT_TX_TOT_CDE         13040000
115900             WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR          13050000
116000               AND A.STR_NBR          = :EPTRN-STR-NBR            13060000
116100               AND A.RGST_ID          = :EPTRN-RGST-ID            13070000
116200               AND A.TRN_NBR          = :EPTRN-TRN-NBR            13080000
116300               AND A.STRT_TM          = :EPTRN-STRT-TM            13090000
116400               AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR   13100000
116500               AND A.LIV_RSLU_CDE    IN ('+', '-')                13110000
116600             ORDER BY A.RCPT_SEQ_NBR                              13120000
116700                     ,A.LNE_ITM_SEQ_NBR                           13130000
116800             WITH UR                                              13140000
116900     END-EXEC.                                                    13150000
117000                                                                  13160000
117100******************************************************************13170000
117200*  CURSOR TO RETRIEVE LINE ITEM DISCOUNTS FOR THE ITEM.          *13180000
117300******************************************************************13190000
117400     EXEC SQL                                                     13200000
117500         DECLARE TEPLID-CSR CURSOR FOR                            13210000
117600             SELECT LID_TYP_CDE                                   13220000
117700                   ,LID_AMT                                       13230000
117800                   ,LID_RSN_CDE                                   13240000
117900             FROM TEPLID                                          13250000
118000             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            13260000
118100               AND STR_NBR          = :EPTRN-STR-NBR              13270000
118200               AND RGST_ID          = :EPTRN-RGST-ID              13280000
118300               AND TRN_NBR          = :EPTRN-TRN-NBR              13290000
118400               AND STRT_TM          = :EPTRN-STRT-TM              13300000
118500               AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR     13310000
118600               AND LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR      13320000
118700               AND LID_TYP_CDE NOT IN ('E','F','G','H')           13330000
118800             WITH UR                                              13340000
118900     END-EXEC.                                                    13350000
119000                                                                  13360000
119100******************************************************************13370000
119200* CURSOR TO RETREIVE ZIP CODE AND GEO CODE FOR A LINE ITEM       *13380000
119300* USING THE ITEM NUMBER ON A RETURNED ITEM.  THIS IS REQUIRED    *13390000
119400* FOR EMPLOYEE RETURN TRANSACTIONS.                              *13400000
119500******************************************************************13410000
119600     EXEC SQL                                                     13420000
119700         DECLARE TEPITM-CSR CURSOR FOR                            13430000
119800             SELECT A.TRN_DTE                                     13440000
119900                   ,B.TX_RT_PCT                                   13450000
120000                   ,D.ZIP_5_CDE                                   13460000
120100                   ,D.TX_GEOG_CDE                                 13470000
120200             FROM TEPTRN  A                                       13480000
120300                 ,TEPITM  B                                       13490000
120400                 ,TEPIPS  C                                       13500000
120500                 ,TEPSHP  D                                       13510000
120600             WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR        13520000
120700               AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR       13530000
120800               AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID       13540000
120900               AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR       13550000
121000               AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM       13560000
121100               AND A.SLS_CORR_SEQ_NBR = :PV-ORIG-SLS-CORR-SEQ-NBR 13570000
121200               AND B.UPC_NBR          = :EPITM-UPC-NBR            13580000
121300               AND B.LIV_RSLU_CDE    IN ('+', '-')                13590000
121400               AND A.PARTN_NBR        = B.PARTN_NBR               13600000
121500               AND A.STR_NBR          = B.STR_NBR                 13610000
121600               AND A.RGST_ID          = B.RGST_ID                 13620000
121700               AND A.TRN_NBR          = B.TRN_NBR                 13630000
121800               AND A.STRT_TM          = B.STRT_TM                 13640000
121900               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        13650000
122000               AND B.PARTN_NBR        = C.PARTN_NBR               13660000
122100               AND B.STR_NBR          = C.STR_NBR                 13670000
122200               AND B.RGST_ID          = C.RGST_ID                 13680000
122300               AND B.TRN_NBR          = C.TRN_NBR                 13690000
122400               AND B.STRT_TM          = C.STRT_TM                 13700000
122500               AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR        13710000
122600               AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR         13720000
122700               AND C.PARTN_NBR        = D.PARTN_NBR               13730000
122800               AND C.STR_NBR          = D.STR_NBR                 13740000
122900               AND C.RGST_ID          = D.RGST_ID                 13750000
123000               AND C.TRN_NBR          = D.TRN_NBR                 13760000
123100               AND C.STRT_TM          = D.STRT_TM                 13770000
123200               AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        13780000
123300               AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR          13790000
123400             WITH UR                                              13800000
123500     END-EXEC.                                                    13810000
123600                                                                  13820000
123700******************************************************************13830000
123800*  CURSOR TO RETRIEVE TRANSACTION LEVEL CASH DISCOUNTS FOR A      13840000
123900*  TRANSACTION                                                    13850000
124000******************************************************************13860000
124100     EXEC SQL                                                     13870000
124200         DECLARE TLCD-CSR CURSOR FOR                              13880000
124300             SELECT TLD_TYP_CDE                                   13890000
124400                   ,TLD_AMT                                       13900000
124500                   ,TLD_PCT                                       13910000
124600                   ,TLD_SEQ_NBR                                   13920000
124700               FROM TEPTLD                                        13930000
124800             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            13940000
124900               AND STR_NBR          = :EPTRN-STR-NBR              13950000
125000               AND RGST_ID          = :EPTRN-RGST-ID              13960000
125100               AND TRN_NBR          = :EPTRN-TRN-NBR              13970000
125200               AND STRT_TM          = :EPTRN-STRT-TM              13980000
125300               AND SLS_CORR_SEQ_NBR = : EPTRN-SLS-CORR-SEQ-NBR    13990000
125400             WITH UR                                              14000000
125500     END-EXEC.                                                    14010000
125600                                                                  14020000
125700******************************************************************14030000
125800* CURSOR TO RETRIEVE TENDER INFORMATION IN SPLIT TENDER SITUATIONS14040000
125900******************************************************************14050000
126000     EXEC SQL                                                     14060000
126100         DECLARE TENDER-CSR CURSOR FOR                            14070000
126200             SELECT TNDR_TYP_CDE                                  14080000
126300                   ,TNDR_ID                                       14090000
126400                   ,TNDR_AMT                                      14100000
126500                   ,TNDR_ID_LEN_NBR                               14110000
126600             FROM   TEPTND                                        14120000
126700             WHERE  PARTN_NBR      = :EPTRN-PARTN-NBR             14130000
126800               AND  STR_NBR        = :EPTRN-STR-NBR               14140000
126900               AND  RGST_ID        = :EPTRN-RGST-ID               14150000
127000               AND  TRN_NBR        = :EPTRN-TRN-NBR               14160000
127100               AND  STRT_TM        = :EPTRN-STRT-TM               14170000
127200               AND  SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR    14180000
127300               AND  TNDR_VOID_IND  = 'N'                          14190000
127400               AND  TNDR_SEQ_NBR   <> :EPTND-TNDR-SEQ-NBR         14200000
127500               AND  TNDR_AMT       <> 0                           14210000
127600             WITH UR                                              14220000
127700     END-EXEC.                                                    14230000
127800                                                                  14240000
127900******************************************************************14250000
128000*  CURSOR TO RETRIEVE THE TAX INFORMATION                         14260000
128100******************************************************************14270000
128200                                                                  14280000
128300     EXEC SQL                                                     14290000
128400         DECLARE TAX-CSR CURSOR FOR                               14300000
128500             SELECT A.STR_NBR                                     14310000
128600                   ,A.TX_TYP_CDE                                  14320000
128700                   ,A.TX_RT_PCT                                   14330000
128800                   ,A.ABV_THRS_FTX_IND                            14340000
128900                   ,A.THRS_DOL_AMT                                14350000
129000                   ,A.BLW_THRS_TX_RT_PCT                          14360000
129100                   ,A.BLW_THRS_FTX_IND                            14370000
129200                   ,A.POS_ASG_TX_ID                               14380000
129300             FROM   TTXRTLO A                                     14390000
129400             WHERE  A.EFF_BEG_DTE = (SELECT MAX(B.EFF_BEG_DTE)    14400000
129500                                       FROM TTXRTLO B             14410000
129600                                      WHERE A.STR_NBR = B.STR_NBR 14420000
129700                                        AND A.TX_GP_ITM_ID =      14430000
129800                                            B.TX_GP_ITM_ID        14440000
129900                                        AND B.EFF_BEG_DTE <=      14450000
130000                                              :EPPART-SLS-DTE)    14460000
130100             ORDER BY STR_NBR, TX_GP_ITM_ID                       14470000
130200         WITH UR                                                  14480000
130300     END-EXEC.                                                    14490000
130400                                                                  14500000
130500******************************************************************14510000
130600*  CURSOR TO RETRIEVE SPECIAL SERVICE FEES FOR THE TRANSACTION.   14520000
130700******************************************************************14530000
130800     EXEC SQL                                                     14540000
130900         DECLARE SSFEES-CSR CURSOR FOR                            14550000
131000             SELECT A.LNE_ITM_SEQ_NBR                             14560000
131100                   ,A.SRVC_SEQ_NBR                                14570000
131200                   ,A.SRVC_TYP_CDE                                14580000
131300                   ,A.SRVC_AMT                                    14590000
131400                   ,A.TX_RT_PCT                                   14600000
131500                   ,A.TX_AMT                                      14610000
131600                   ,B.RCPT_TX_TOT_CDE                             14620000
131700                   ,A.FEE_DESC                                    14630000
131800             FROM TEPLIS A                                        14640000
131900                 ,TEPITM B                                        14650000
132000             WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR          14660000
132100               AND A.STR_NBR          = :EPTRN-STR-NBR            14670000
132200               AND A.RGST_ID          = :EPTRN-RGST-ID            14680000
132300               AND A.TRN_NBR          = :EPTRN-TRN-NBR            14690000
132400               AND A.STRT_TM          = :EPTRN-STRT-TM            14700000
132500               AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR   14710000
132600               AND B.LIV_RSLU_CDE    IN ('+', '-')                14720000
132700               AND A.PARTN_NBR        = B.PARTN_NBR               14730000
132800               AND A.STR_NBR          = B.STR_NBR                 14740000
132900               AND A.RGST_ID          = B.RGST_ID                 14750000
133000               AND A.TRN_NBR          = B.TRN_NBR                 14760000
133100               AND A.STRT_TM          = B.STRT_TM                 14770000
133200               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        14780000
133300               AND A.LNE_ITM_SEQ_NBR  = B.LNE_ITM_SEQ_NBR         14790000
133400             ORDER BY A.LNE_ITM_SEQ_NBR                           14800000
133500         WITH UR                                                  14810000
133600     END-EXEC.                                                    14820000
133700                                                                  14830000
133800******************************************************************14840000
133900*  CURSOR TO RETRIEVE SHIPPING INFORMATION TRANSACTION.           14850000
134000******************************************************************14860000
134100     EXEC SQL                                                     14870000
134200         DECLARE SHIP-CSR CURSOR FOR                              14880000
134300             SELECT PLND_SHIPT_NBR                                14890000
134400                   ,SHIP_TYP_CDE                                  14900000
134500                   ,SHIP_CHRG_AMT                                 14910000
134600                   ,ZIP_5_CDE                                     14920000
134700                   ,TX_RT_PCT                                     14930000
134800                   ,TX_AMT                                        14940000
134900                   ,TX_GEOG_CDE                                   14950000
135000             FROM TEPSHP                                          14960000
135100             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            14970000
135200               AND STR_NBR          = :EPTRN-STR-NBR              14980000
135300               AND RGST_ID          = :EPTRN-RGST-ID              14990000
135400               AND TRN_NBR          = :EPTRN-TRN-NBR              15000000
135500               AND STRT_TM          = :EPTRN-STRT-TM              15010000
135600               AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR     15020000
135700             ORDER BY PLND_SHIPT_NBR                              15030000
135800         WITH UR                                                  15040000
135900     END-EXEC.                                                    15050000
136000******************************************************************15060000
136100*  CURSOR TO RETRIEVE SHIPPING INFORMATION TRANSACTION FROM TEPECX15070000
136200******************************************************************15080000
136300     EXEC SQL                                                     15090000
136400         DECLARE SHIPE-CSR CURSOR FOR                             15100000
136500             SELECT PLND_SHIPT_NBR                                15110000
136600                   ,SHIP_TYP_CDE                                  15120000
136700                   ,SHIP_CHRG_AMT                                 15130000
136800                   ,ZIP_5_CDE                                     15140000
136900                   ,TX_RT_PCT                                     15150000
137000                   ,TX_AMT                                        15160000
137100                   ,TX_GEOG_CDE                                   15170000
137200             FROM TEPSHP   A                                      15180000
137300                , TEPPART  B                                      15190000
137400                , TEPECX   C                                      15200000
137500             WHERE C.ORD_PARTN_NBR  = :PV-SHP-PARTN-NBR           15210000
137600               AND C.SLS_DTE        = B.SLS_DTE                   15220000
137700               AND A.PARTN_NBR      = B.PARTN_NBR                 15230000
137800               AND C.STR_NBR        = :PV-SHP-STR-NBR             15240000
137900               AND C.STR_NBR        = A.STR_NBR                   15250000
138000               AND C.RGST_ID        = :PV-SHP-RGST-ID             15260000
138100               AND C.RGST_ID        = A.RGST_ID                   15270000
138200               AND C.TRN_NBR        = :PV-SHP-TRN-NBR             15280000
138300               AND C.TRN_NBR        = A.TRN_NBR                   15290000
138400               AND C.STRT_TM        = :PV-SHP-STRT-TM             15300000
138500               AND C.STRT_TM        = A.STRT_TM                   15310000
138600               AND A.SLS_CORR_SEQ_NBR = :PV-SHP-SLS-CORR-SEQ-NBR  15320000
138700             ORDER BY PLND_SHIPT_NBR                              15330000
138800         WITH UR                                                  15340000
138900     END-EXEC.                                                    15350000
139000                                                                  15360000
139100******************************************************************15370000
139200*  CURSOR TO RETRIEVE SHIPPING INFORMATION FOR A CREDIT OF        15380000
139300*  SHIPPING FEES OR GIFT WRAP FEE.                                15390000
139400******************************************************************15400000
139500     EXEC SQL                                                     15410000
139600         DECLARE SHIP-RTN-CSR CURSOR FOR                          15420000
139700             SELECT ZIP_5_CDE                                     15430000
139800                   ,TX_RT_PCT                                     15440000
139900                   ,TX_GEOG_CDE                                   15450000
140000             FROM TEPSHP                                          15460000
140100             WHERE PARTN_NBR        = :PV-ORIG-PARTN-NBR          15470000
140200               AND STR_NBR          = :EPIRT-ORIG-STR-NBR         15480000
140300               AND RGST_ID          = :EPIRT-ORIG-RGST-ID         15490000
140400               AND TRN_NBR          = :EPIRT-ORIG-TRN-NBR         15500000
140500               AND STRT_TM          = :EPIRT-ORIG-STRT-TM         15510000
140600         WITH UR                                                  15520000
140700     END-EXEC.                                                    15530000
140800                                                                  15540000
140900******************************************************************15550000
141000 PROCEDURE DIVISION.                                              15560000
141100******************************************************************15570000
141200 0000-MAINLINE.                                                   15580000
141300                                                                  15590000
141400     PERFORM 1000-INITIALIZE.                                     15600000
141500                                                                  15610000
141600     PERFORM 2000-PROCESS-DATA.                                   15620000
141700                                                                  15630000
141800     PERFORM 9000-EOJ-ROUTINE.                                    15640000
141900                                                                  15650000
142000     GOBACK.                                                      15660000
142100                                                                  15670000
142200******************************************************************15680000
142300*  SET UP FOR PROGRAM PROCESSING BY OPENING ALL FILES,           *15690000
142400*                                 FILLING THE FIELDS OF THE      *15700000
142500*  STANDARD REPORT HEADER, INITIALIZING NECESSARY VARIABLES, AND *15710000
142600*  READING THE FIRST PROCESSABLE RECORD FROM THE P.O.S. KOHL'S   *15720000
142700*  CHARGE FILE.                                                  *15730000
142800******************************************************************15740000
142900 1000-INITIALIZE.                                                 15750000
143000                                                                  15760000
143100     OPEN INPUT  POS-DATE-CARD-FILE.                              15770000
143200     OPEN OUTPUT ACCOUNTS-RECEIVABLE-FILE.                        15780000
143300                                                                  15790000
143400     INITIALIZE TH-TRANSACTION-HOLD-AREA                          15800000
143500                AR001-AR-TRANSACTION-RECORD                       15810000
143600                EC-ECOM-STORE-TABLE                               15820000
143700                TI-TAX-INFO-TABLE                                 15830000
143800                ZIP-CODE-TABLE.                                   15840000
143900                                                                  15850000
144000     MOVE PC-CURRENT-PROGRAM-NAME TO DP031-PROGRAM-NAME.          15860000
144100     MOVE 1 TO PV-STORE-SUB2.                                     15870000
144200     SET ZIP-IDX2 TO 1.                                           15880000
144300                                                                  15890000
144400     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 15900000
144500        AT END                                                    15910000
144600           SET PS-END-OF-CARD-FILE-YES TO TRUE.                   15920000
144700                                                                  15930000
144800     DISPLAY 'ARKUT058 CONTROL CARD: ' CC-CONTROL-CARD.           15940000
144900                                                                  15950000
145000     CLOSE POS-DATE-CARD-FILE.                                    15960000
145100                                                                  15970000
145200     IF PS-END-OF-CARD-FILE-YES                                   15980000
145300        DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME            15990000
145400        DISPLAY 'DATE CONTROL CARD EMPTY'                         16000000
145500        SET AC-CONTROL-CARD-ERROR TO TRUE                         16010000
145600        CALL 'ILBOABN0' USING AC-ABEND-CODE                       16020000
145700     END-IF.                                                      16030000
145800                                                                  16040000
145900     PERFORM 1115-CONVERT-INPUT-DATE.                             16050000
146000                                                                  16060000
146100     PERFORM 1200-OPEN-TAX-CURSOR.                                16070000
146200     PERFORM 1210-FETCH-TAX-CURSOR.                               16080000
146300     PERFORM UNTIL PS-END-OF-TAX-CURSOR                           16090000
146400         PERFORM 1220-PROCESS-TAX-CURSOR                          16100000
146500         PERFORM 1210-FETCH-TAX-CURSOR                            16110000
146600     END-PERFORM.                                                 16120000
146700     PERFORM 1230-CLOSE-TAX-CURSOR.                               16130000
146800                                                                  16140000
146900******************************************************************16150000
147000*     CALL KOHLS CALENDAR ROUTINE:                                16160000
147100*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            16170000
147200*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 16180000
147300******************************************************************16190000
147400 1115-CONVERT-INPUT-DATE.                                         16200000
147500                                                                  16210000
147600     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              16220000
147700                                                                  16230000
147800     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   16240000
147900     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   16250000
148000     SET  DPG52-LK-DTE-GREG            TO TRUE.                   16260000
148100     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    16270000
148200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    16280000
148300                                             DPG54 DPG55 DPG56.   16290000
148400     EVALUATE TRUE                                                16300000
148500         WHEN DPG54-SEVERE-ERROR                                  16310000
148600            DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME        16320000
148700            DISPLAY 'DATE CONTROL CARD INVALID'                   16330000
148800            SET AC-CONTROL-CARD-ERROR TO TRUE                     16340000
148900            CALL 'ILBOABN0' USING AC-ABEND-CODE                   16350000
149000     END-EVALUATE.                                                16360000
149100                                                                  16370000
149200     DISPLAY 'EXECUTION DATE USED = ' DPG55-DB2-ISO-DATE-FMT.     16380000
149300                                                                  16390000
149400     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-POS-CCYY-MM-DD       16400000
149500                                          EPPART-SLS-DTE          16410000
149600                                          EPDKEY-PRCG-DTE.        16420000
149700                                                                  16430000
149800***************************************************************** 16440000
149900*  OPEN THE TAX CURSOR                                            16450000
150000***************************************************************** 16460000
150100 1200-OPEN-TAX-CURSOR.                                            16470000
150200                                                                  16480000
150300     EXEC SQL                                                     16490000
150400         OPEN TAX-CSR                                             16500000
150500     END-EXEC.                                                    16510000
150600                                                                  16520000
150700     EVALUATE TRUE                                                16530000
150800         WHEN SQLCODE = ZERO                                      16540000
150900             CONTINUE                                             16550000
151000         WHEN SQLWARN0 NOT EQUAL SPACE                            16560000
151100         WHEN SQLCODE NOT EQUAL ZERO                              16570000
151200             MOVE '1200-OPEN-TAX-CURSOR'                          16580000
151300                                   TO PV-PARAGRAPH-NAME           16590000
151400             MOVE 'ERROR ON OPENING TAX CURSOR '                  16600000
151500                                   TO PV-DB2-OPERATION            16610000
151600             PERFORM 9200-SQL-ABEND                               16620000
151700     END-EVALUATE.                                                16630000
151800                                                                  16640000
151900     SET TI-IDX                    TO 1.                          16650000
152000                                                                  16660000
152100***************************************************************** 16670000
152200*  FETCH THE TAX CURSOR                                           16680000
152300***************************************************************** 16690000
152400 1210-FETCH-TAX-CURSOR.                                           16700000
152500                                                                  16710000
152600     EXEC SQL                                                     16720000
152700         FETCH TAX-CSR                                            16730000
152800         INTO :TXRTLO-STR-NBR                                     16740000
152900             ,:TXRTLO-TX-TYP-CDE                                  16750000
153000             ,:TXRTLO-TX-RT-PCT                                   16760000
153100             ,:TXRTLO-ABV-THRS-FTX-IND                            16770000
153200             ,:TXRTLO-THRS-DOL-AMT                                16780000
153300             ,:TXRTLO-BLW-THRS-TX-RT-PCT                          16790000
153400             ,:TXRTLO-BLW-THRS-FTX-IND                            16800000
153500             ,:TXRTLO-POS-ASG-TX-ID                               16810000
153600     END-EXEC.                                                    16820000
153700                                                                  16830000
153800     EVALUATE TRUE                                                16840000
153900         WHEN SQLCODE = ZERO                                      16850000
154000             CONTINUE                                             16860000
154100         WHEN SQLCODE = +100                                      16870000
154200             SET PS-END-OF-TAX-CURSOR                             16880000
154300                                   TO TRUE                        16890000
154400         WHEN SQLWARN0 NOT EQUAL SPACE                            16900000
154500         WHEN SQLCODE NOT EQUAL ZERO                              16910000
154600             MOVE '1210-FETCH-TAX-CURSOR'                         16920000
154700                                   TO PV-PARAGRAPH-NAME           16930000
154800             MOVE 'ERROR ON FETCHING TAX CURSOR '                 16940000
154900                                   TO PV-DB2-OPERATION            16950000
155000             PERFORM 9200-SQL-ABEND                               16960000
155100     END-EVALUATE.                                                16970000
155200                                                                  16980000
155300***************************************************************** 16990000
155400*  MOVE THE CURSOR INFORMATION INTO THE WORKING STORAGE TABLE     17000000
155500******************************************************************17010000
155600 1220-PROCESS-TAX-CURSOR.                                         17020000
155700                                                                  17030000
155800* -- THE FIRST TAX RATE FOR A STORE IS IS THE FULL TAX RATE. -- * 17040000
155900* -- SAVE THE FULL TAX RATE FOR STORE.                       -- * 17050000
156000     IF PV-SAVE-TX-STR-NBR NOT = TXRTLO-STR-NBR                   17060000
156100        MOVE TXRTLO-STR-NBR   TO PV-SAVE-TX-STR-NBR               17070000
156200        MOVE TXRTLO-TX-RT-PCT TO PV-SAVE-FULL-TAX-RT              17080000
156300     END-IF.                                                      17090000
156400                                                                  17100000
156500* -- IF THRESHOLD RATE AND USES 'F'ULL TAX RATE, INSERT      -- * 17110000
156600* -- THE FULL TAX IN THAT TABLE POSITION.                    -- * 17120000
156700     IF TXRTLO-TX-TYP-CDE = 'TH'                                  17130000
156800        AND ((TXRTLO-ABV-THRS-FTX-IND = 'F')                      17140000
156900              OR (TXRTLO-BLW-THRS-FTX-IND = 'F'))                 17150000
157000        IF TXRTLO-ABV-THRS-FTX-IND = 'F'                          17160000
157100           MOVE PV-SAVE-FULL-TAX-RT TO TI-TAX-RATE-PCT (TI-IDX)   17170000
157200           MOVE TXRTLO-BLW-THRS-TX-RT-PCT                         17180000
157300                           TO TI-TAX-RATE-BELOW-THRESH (TI-IDX)   17190000
157400        END-IF                                                    17200000
157500        IF TXRTLO-BLW-THRS-FTX-IND = 'F'                          17210000
157600           MOVE PV-SAVE-FULL-TAX-RT                               17220000
157700                           TO TI-TAX-RATE-BELOW-THRESH (TI-IDX)   17230000
157800           MOVE TXRTLO-TX-RT-PCT TO TI-TAX-RATE-PCT (TI-IDX)      17240000
157900        END-IF                                                    17250000
158000     ELSE                                                         17260000
158100* -- OTHERWISE, STORE THE NORMAL RATES IN THE TABLE.         -- * 17270000
158200        MOVE TXRTLO-TX-RT-PCT TO TI-TAX-RATE-PCT (TI-IDX)         17280000
158300        MOVE TXRTLO-BLW-THRS-TX-RT-PCT                            17290000
158400                           TO TI-TAX-RATE-BELOW-THRESH (TI-IDX)   17300000
158500     END-IF.                                                      17310000
158600                                                                  17320000
158700     MOVE TXRTLO-STR-NBR      TO TI-STR-NBR (TI-IDX).             17330000
158800     MOVE TXRTLO-THRS-DOL-AMT TO TI-TAX-THRESH-AMOUNT (TI-IDX).   17340000
158900     MOVE TXRTLO-POS-ASG-TX-ID    TO TI-ASSIGNED-TAX-ID (TI-IDX). 17350000
159000     SET TI-IDX                   UP BY 1.                        17360000
159100                                                                  17370000
159200***************************************************************** 17380000
159300*  CLOSE THE TAX CURSOR                                           17390000
159400***************************************************************** 17400000
159500 1230-CLOSE-TAX-CURSOR.                                           17410000
159600                                                                  17420000
159700     EXEC SQL                                                     17430000
159800         CLOSE TAX-CSR                                            17440000
159900     END-EXEC.                                                    17450000
160000                                                                  17460000
160100     EVALUATE TRUE                                                17470000
160200         WHEN SQLCODE = ZERO                                      17480000
160300             CONTINUE                                             17490000
160400         WHEN SQLWARN0 NOT EQUAL SPACE                            17500000
160500         WHEN SQLCODE NOT EQUAL ZERO                              17510000
160600             MOVE '1200-CLOSE-TAX-CURSOR'                         17520000
160700                                   TO PV-PARAGRAPH-NAME           17530000
160800             MOVE 'ERROR ON CLOSING TAX CURSOR '                  17540000
160900                                   TO PV-DB2-OPERATION            17550000
161000             PERFORM 9200-SQL-ABEND                               17560000
161100     END-EVALUATE.                                                17570000
161200                                                                  17580000
161300******************************************************************17590000
161400*  PERFORMS THE PARAGRAPHS THAT CONTROL THE CURSORS THAT DRIVE   *17600000
161500*  THE PROGRAM.                                                  *17610000
161600******************************************************************17620000
161700 2000-PROCESS-DATA.                                               17630000
161800                                                                  17640000
161900     PERFORM 2100-PROCESS-LATE-VOIDS.                             17650000
162000                                                                  17660000
162100     PERFORM 2200-PROCESS-LATES-AND-CORRS.                        17670000
162200                                                                  17680000
162300     PERFORM 2300-PROCESS-TODAYS-TRNS.                            17690000
162400                                                                  17700000
162500******************************************************************17710000
162600*  PROCESS LATE VOID TRANSACTIONS.                               *17720000
162700******************************************************************17730000
162800 2100-PROCESS-LATE-VOIDS.                                         17740000
162900                                                                  17750000
163000     PERFORM 7800-OPEN-LATE-VOID-CURSOR.                          17760000
163100     PERFORM 7810-FETCH-LATE-VOID-CURSOR.                         17770000
163200                                                                  17780000
163300     IF PS-IND2-IS-NULL                                           17790000
163400         SET PS-OMNI-CHNL-IS-NULL TO TRUE                         17800000
163500     ELSE                                                         17810000
163600         SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                     17820000
163700     END-IF.                                                      17830000
163800                                                                  17840000
163900                                                                  17850000
164000     PERFORM UNTIL PS-END-OF-LATE-VOID-CURSOR                     17860000
164100         PERFORM 3000-PROCESS-TRANSACTION                         17870000
164200         PERFORM 7810-FETCH-LATE-VOID-CURSOR                      17880000
164300         IF PS-IND2-IS-NULL                                       17890000
164400             SET PS-OMNI-CHNL-IS-NULL TO TRUE                     17900000
164500         ELSE                                                     17910000
164600             SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                 17920000
164700         END-IF                                                   17930000
164800     END-PERFORM.                                                 17940000
164900     PERFORM 7820-CLOSE-LATE-VOID-CURSOR.                         17950000
165000                                                                  17960000
165100******************************************************************17970000
165200*  PROCESS LATE TRANSACTIONS AND CORRECTIONS.                    *17980000
165300******************************************************************17990000
165400 2200-PROCESS-LATES-AND-CORRS.                                    18000000
165500                                                                  18010000
165600     PERFORM 7100-OPEN-LATE-COR-CURSOR.                           18020000
165700     PERFORM 7110-FETCH-LATE-COR-CURSOR.                          18030000
165800     IF PS-IND2-IS-NULL                                           18040000
165900         SET PS-OMNI-CHNL-IS-NULL TO TRUE                         18050000
166000     ELSE                                                         18060000
166100         SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                     18070000
166200     END-IF.                                                      18080000
166300                                                                  18090000
166400                                                                  18100000
166500     PERFORM UNTIL PS-END-OF-LATE-COR-CURSOR                      18110000
166600         PERFORM 3000-PROCESS-TRANSACTION                         18120000
166700         PERFORM 7110-FETCH-LATE-COR-CURSOR                       18130000
166800         IF PS-IND2-IS-NULL                                       18140000
166900             SET PS-OMNI-CHNL-IS-NULL TO TRUE                     18150000
167000         ELSE                                                     18160000
167100             SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                 18170000
167200         END-IF                                                   18180000
167300     END-PERFORM.                                                 18190000
167400     PERFORM 7120-CLOSE-LATE-COR-CURSOR.                          18200000
167500                                                                  18210000
167600******************************************************************18220000
167700*  PROCESS THE CURRENT DAYS TRANSACTIONS                         *18230000
167800******************************************************************18240000
167900 2300-PROCESS-TODAYS-TRNS.                                        18250000
168000                                                                  18260000
168100     PERFORM 7000-OPEN-POS-TRAN-CURSOR.                           18270000
168200     PERFORM 7010-FETCH-POS-TRANS-CURSOR.                         18280000
168300     IF PS-IND2-IS-NULL                                           18290000
168400        SET PS-OMNI-CHNL-IS-NULL TO TRUE                          18300000
168500     ELSE                                                         18310000
168600        SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                      18320000
168700     END-IF.                                                      18330000
168800                                                                  18340000
168900     PERFORM UNTIL PS-END-OF-POS-TRAN-CURSOR                      18350000
169000         PERFORM 3000-PROCESS-TRANSACTION                         18360000
169100         PERFORM 7010-FETCH-POS-TRANS-CURSOR                      18370000
169200         IF PS-IND2-IS-NULL                                       18380000
169300            SET PS-OMNI-CHNL-IS-NULL TO TRUE                      18390000
169400         ELSE                                                     18400000
169500            SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                  18410000
169600         END-IF                                                   18420000
169700     END-PERFORM.                                                 18430000
169800                                                                  18440000
169900     PERFORM 7020-CLOSE-POS-TRAN-CURSOR.                          18450000
170000                                                                  18460000
170100******************************************************************18470000
170200*  PROCESS A TRANSACTION AFTER IT HAS BEEN FETCHED               *18480000
170300******************************************************************18490000
170400 3000-PROCESS-TRANSACTION.                                        18500000
170500                                                                  18510000
170600     SET PS-NOT-ECOMMERCE-RETURN TO TRUE.                         18520000
170700     SET PS-TEPECX-EXISTS-NO TO TRUE.                             18530000
170800     MOVE EPTRN-STR-NBR TO PV-SAVE-STR-NBR                        18540000
170900                           PV-WORK-STR-NBR                        18550000
171000                           PV-WORK-STR-NBR-TEST.                  18560000
171100     PERFORM 6220-READ-ECOMMERCE-TABLE.                           18570000
171200     IF PS-END-OF-ECOM-TABLE                                      18580000
171300         PERFORM 6230-GET-STORE-INFO                              18590000
171400         PERFORM 6220-READ-ECOMMERCE-TABLE                        18600000
171500     END-IF.                                                      18610000
171600     MOVE PV-SHIP-ZIP-CODE TO PV-STR-ZIP-CODE.                    18620000
171700     MOVE PV-SHIP-GEO-CODE TO PV-STR-GEO-CODE.                    18630000
171800     IF PV-BUS-LOC-IND = 'Y'                                      18640000
171900     OR (PV-BUS-LOC-IND = 'N'                                     18650000
172000         AND PS-OMNI-CHNL-IS-NOT-NULL)                            18660000
172100         SET PS-ECOMMERCE-STORE TO TRUE                           18670000
172200     ELSE                                                         18680000
172300         SET PS-NOT-ECOMMERCE-STORE TO TRUE                       18690000
172400     END-IF.                                                      18700000
172500                                                                  18710000
172600     IF PS-IND2-IS-NULL                                           18720000
172700        MOVE SPACES              TO PV-OMNI-CHNL-FFLMT-TYP-CDE    18730000
172800     ELSE                                                         18740000
172900        MOVE EPTRN-OMNI-CHNL-FFLMT-TYP-CDE  TO                    18750000
173000                                    PV-OMNI-CHNL-FFLMT-TYP-CDE    18760000
173100     END-IF.                                                      18770000
173200                                                                  18780000
SHIP2      MOVE EPTRN-VISA-MULT-CLR-SEQ-NBR TO                          18790000
SHIP2           PV-MULT-CLR-SEQ-NBR.                                    18800000
SHIP2      MOVE EPTRN-VISA-TOT-SHP-NBR TO                               18810000
SHIP2           PV-TOT-SHP-NBR.                                         18820000
173200                                                                  18830000
173300     MOVE PV-STR-ZIP-CODE          TO PV-SHIP-ZIP-CODE.           18840000
173400     MOVE PV-STR-GEO-CODE          TO PV-SHIP-GEO-CODE.           18850000
173500     MOVE EPTRN-SLS-DTE            TO PV-POS-CCYY-MM-DD.          18860000
173600     MOVE EPTRN-STR-NBR            TO PV-STR-NBR-9.               18870000
173700     MOVE EPTRN-RGST-ID            TO PV-RGST-ID-9.               18880000
173800     MOVE EPTRN-TRN-NBR            TO PV-TRN-NBR-9.               18890000
173900                                                                  18900000
174000     SET PS-NOT-ASSOC-CASH  TO TRUE.                              18910000
174100     MOVE SPACES TO PV-EMPLOYEE-CDE                               18920000
174200                    PV-ASSOC-ID.                                  18930000
174300                                                                  18940000
174400     IF EPTRN-TRN-TYP-CDE          = PC-PAYMENT-TRAN-TYPE-CDE     18950000
174500         MOVE SPACES TO PV-EMPLOYEE-CDE                           18960000
174600         PERFORM 5000-PROCESS-PAYMENT                             18970000
174700     ELSE                                                         18980000
174800***  CHECK FOR AN EMPLOYEE ACCOUNT                                18990000
174900       IF EPTND-TNDR-ID-LEN-NBR = 18                              19000000
175000          MOVE ZERO TO PV-EMP-DISC-COUNT                          19010000
175010          PERFORM 7310-SELECT-FROM-TEPEID                         19020000
175020          IF PV-EMP-DISC-COUNT > ZERO                             19030000
175030             MOVE '5'       TO PV-EMPLOYEE-CDE                    19040000
175040             MOVE SPACES    TO PV-ASSOC-ID                        19050000
175050          END-IF                                                  19060000
175060       ELSE                                                       19070000
175070          MOVE EPTND-TNDR-ID (1:10) TO PV-ACCOUNT-NBR-X           19080000
175080          IF PV-ACCOUNT-NBR-X = PV-TEST-ACCOUNT-NBR               19090000
175090             MOVE '1234555' TO PV-ASSOC-ID                        19100000
175100             MOVE '5'       TO PV-EMPLOYEE-CDE                    19110000
175200          ELSE                                                    19120000
175300             PERFORM 7300-CHECK-IF-EMPL-ACCT                      19130000
175400          END-IF                                                  19140000
175500       END-IF                                                     19150000
175600       IF PS-ECOMMERCE-STORE                                      19160000
175700          PERFORM 3100-GET-ECOMMERCE-ORDER-NBR                    19170000
175800             IF SQLCODE = 0                                       19180000
175900                 PERFORM 3200-GET-AUTH-REF-NBR                    19190000
176000             END-IF                                               19200000
176100       END-IF                                                     19210000
176200                                                                  19220000
176300       PERFORM 4000-PROCESS-LINE-ITEMS                            19230000
176400     END-IF.                                                      19240000
176500                                                                  19250000
176600***************************************************************** 19260000
176700*  GET THE ECOMMERCE ORDER NUMBER                                 19270000
176800***************************************************************** 19280000
176900 3100-GET-ECOMMERCE-ORDER-NBR.                                    19290000
177000                                                                  19300000
177100     MOVE SPACES TO EPORD-ORD-NBR-TEXT.                           19310000
177200                                                                  19320000
177300     EXEC SQL                                                     19330000
177400           SELECT ORD_NBR                                         19340000
177500           INTO :EPORD-ORD-NBR                                    19350000
177600           FROM TEPORD                                            19360000
177700           WHERE PARTN_NBR        = :EPTRN-PARTN-NBR              19370000
177800             AND STR_NBR          = :EPTRN-STR-NBR                19380000
177900             AND RGST_ID          = :EPTRN-RGST-ID                19390000
178000             AND TRN_NBR          = :EPTRN-TRN-NBR                19400000
178100             AND STRT_TM          = :EPTRN-STRT-TM                19410000
178200             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       19420000
178300           WITH UR                                                19430000
178400     END-EXEC.                                                    19440000
178500                                                                  19450000
178600     EVALUATE TRUE                                                19460000
178700         WHEN SQLCODE = ZERO                                      19470000
178800             CONTINUE                                             19480000
178900         WHEN SQLCODE = +100                                      19490000
179000             MOVE SPACES TO EPORD-ORD-NBR                         19500000
179100         WHEN SQLWARN0 NOT EQUAL SPACE                            19510000
179200         WHEN SQLCODE NOT EQUAL ZERO                              19520000
179300             MOVE '3100-GET-ECOMMERCE-ORDER-NBR'                  19530000
179400                                            TO PV-PARAGRAPH-NAME  19540000
179500             MOVE 'ERROR GETTING ECOMMERCE ORDER #'               19550000
179600                                            TO PV-DB2-OPERATION   19560000
179700             PERFORM 9200-SQL-ABEND                               19570000
179800     END-EVALUATE.                                                19580000
179900                                                                  19590000
180000***************************************************************** 19600000
180100*  GET THE AUTH REFERENCE NUMBER                                  19610000
180200***************************************************************** 19620000
180300 3200-GET-AUTH-REF-NBR.                                           19630000
180400                                                                  19640000
180500     MOVE SPACES TO EPCRR-AUTH-REF-NBR-TEXT.                      19650000
180600                                                                  19660000
180700     EXEC SQL                                                     19670000
180800          SELECT AUTH_REF_NBR                                     19680000
180900          INTO :EPCRR-AUTH-REF-NBR                                19690000
181000          FROM  TEPCRR A                                          19700000
181100          WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR             19710000
181200            AND A.STR_NBR          = :EPTRN-STR-NBR               19720000
181300            AND A.RGST_ID          = :EPTRN-RGST-ID               19730000
181400            AND A.TRN_NBR          = :EPTRN-TRN-NBR               19740000
181500            AND A.STRT_TM          = :EPTRN-STRT-TM               19750000
181600            AND A.TNDR_SEQ_NBR     = :EPTND-TNDR-SEQ-NBR          19760000
181700            AND A.SLS_CORR_SEQ_NBR =                              19770000
181800                  (SELECT MAX(B.SLS_CORR_SEQ_NBR)                 19780000
181900                  FROM TEPCRR B                                   19790000
182000                  WHERE A.PARTN_NBR = B.PARTN_NBR                 19800000
182100                    AND A.STR_NBR   = B.STR_NBR                   19810000
182200                    AND A.RGST_ID   = B.RGST_ID                   19820000
182300                    AND A.TRN_NBR   = B.TRN_NBR                   19830000
182400                    AND A.STRT_TM   = B.STRT_TM                   19840000
182500                    AND A.TNDR_SEQ_NBR = B.TNDR_SEQ_NBR)          19850000
182600          WITH UR                                                 19860000
182700     END-EXEC.                                                    19870000
182800                                                                  19880000
182900     EVALUATE TRUE                                                19890000
183000         WHEN SQLCODE = ZERO                                      19900000
183100         WHEN SQLCODE = +100                                      19910000
183200             CONTINUE                                             19920000
183300         WHEN SQLWARN0 NOT EQUAL SPACE                            19930000
183400         WHEN SQLCODE NOT EQUAL ZERO                              19940000
183500             MOVE '3200-GET-AUTH-REF-NBR'                         19950000
183600                                            TO PV-PARAGRAPH-NAME  19960000
183700             MOVE 'TO SELECT FROM TEPCRR  '                       19970000
183800                                            TO PV-DB2-OPERATION   19980000
183900             DISPLAY 'PARTITION NBR : ' EPTRN-PARTN-NBR           19990000
184000             DISPLAY 'STORE NBR  :  '    EPTRN-STR-NBR            20000000
184100             DISPLAY 'REGISTER ID:  '    EPTRN-RGST-ID            20010000
184200             DISPLAY 'TRANS NBR  :  '    EPTRN-TRN-NBR            20020000
184300             DISPLAY 'START TIME :  '    EPTRN-STRT-TM            20030000
184400             DISPLAY 'SALES CORR SEQ NBR: ' EPTRN-SLS-CORR-SEQ-NBR20040000
184500             DISPLAY 'TNDR SEQ NBR : ' EPTND-TNDR-SEQ-NBR         20050000
184600             PERFORM 9200-SQL-ABEND                               20060000
184700     END-EVALUATE.                                                20070000
184800                                                                  20080000
184900******************************************************************20090000
185000* TOKENIZE THE TNDR_ID FIELD.                                     20100000
185100******************************************************************20110000
185200***************************************************************** 20120000
185300*  PROCESS THE LINE ITEMS FOR THE TRANSACTION                     20130000
185400***************************************************************** 20140000
185500 4000-PROCESS-LINE-ITEMS.                                         20150000
185600                                                                  20160000
122921     IF EPTND-TNDR-AMT < 0 AND                                    20162000
122921        (EPTRN-TRN-TYP-CDE = '02' OR                              20162100
122921         EPTRN-TRN-TYP-CDE = '01')                                20162200
122921        MOVE '12' TO EPTRN-TRN-TYP-CDE                            20162300
122921     END-IF.                                                      20163000
185700     EVALUATE EPTRN-TRN-TYP-CDE                                   20170000
185800         WHEN '01'                                                20180000
185900             SET TH-SALE-TRANSACTION                              20190000
186000                                   TO TRUE                        20200000
186100*   THIS WAS ADDED 3/17/06 WHEN A SALES CORRECTION CAME THROUGH   20210000
186200*   AS AN ASSOCIATE CASH SALE WITH A KOHL'S CHARGE TENDER.        20220000
186300         WHEN '02'                                                20230000
186400             SET TH-SALE-TRANSACTION                              20240000
186500                 PS-ASSOC-CASH TO TRUE                            20250000
186600         WHEN '11'                                                20260000
186700             SET TH-RETURN-TRANSACTION                            20270000
186800                                   TO TRUE                        20280000
186900         WHEN '12'                                                20290000
187000             SET TH-RETURN-TRANSACTION                            20300000
187100                 PS-ASSOC-CASH TO TRUE                            20310000
187200         WHEN '23'                                                20320000
187300         WHEN '21'                                                20330000
187400             IF EPTRN-TRN-TOT-AMT > 0                             20340000
187500                SET TH-SALE-TRANSACTION                           20350000
187600                                  TO TRUE                         20360000
187700             ELSE                                                 20370000
187800                IF EPTRN-TRN-TOT-AMT < 0                          20380000
187900                   SET TH-RETURN-TRANSACTION                      20390000
188000                                  TO TRUE                         20400000
188100                END-IF                                            20410000
188200             END-IF                                               20420000
188300         WHEN '24'                                                20430000
188400             SET TH-ADJUSTMENT-TRANSACTION                        20440000
188500                                   TO TRUE                        20450000
188600         WHEN '25'                                                20460000
188700             SET TH-ADJUSTMENT-TRANSACTION                        20470000
188800                 PS-ASSOC-CASH TO TRUE                            20480000
188900         WHEN OTHER                                               20490000
189000             DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME       20500000
189100             DISPLAY 'TRAN TYPE INVALID'                          20510000
189200             DISPLAY 'PARTITION ' EPTRN-PARTN-NBR                 20520000
189300             DISPLAY ' STORE ' EPTRN-STR-NBR                      20530000
189400             DISPLAY ' RGST ' EPTRN-RGST-ID                       20540000
189500             DISPLAY ' TRN ' EPTRN-TRN-NBR                        20550000
189600             DISPLAY ' TRN-TYPE ' EPTRN-TRN-TYP-CDE               20560000
189700             DISPLAY ' SALES DATE ' EPTRN-SLS-DTE                 20570000
189800             SET AC-INVALID-DATA-ERROR TO TRUE                    20580000
189900             CALL 'ILBOABN0' USING AC-ABEND-CODE                  20590000
190000     END-EVALUATE.                                                20600000
190100                                                                  20610000
190200     MOVE SPACES TO EPTRT-TRN-GP-CDE.                             20620000
190300                                                                  20630000
190400     IF TH-RETURN-TRANSACTION                                     20640000
190500        PERFORM 4050-GET-TRN-GRP-CDE                              20650000
190600     END-IF.                                                      20660000
190700                                                                  20670000
190800     MOVE ZERO                     TO TH-LINE-NUMBER.             20680000
190900                                                                  20690000
191000*** PROCESS THE ITEMS FOR THE TRANSACTION                         20700000
191100                                                                  20710000
191200     MOVE SPACE               TO PS-END-OF-LINE-ITEM-CURSOR-SW.   20720000
191300     PERFORM 4100-OPEN-LINE-ITEM-CURSOR.                          20730000
191400     PERFORM 4110-FETCH-LINE-ITEM-CURSOR.                         20740000
191500     PERFORM UNTIL PS-END-OF-LINE-ITEM-CURSOR                     20750000
191600         MOVE EPTRN-STR-NBR TO PV-WORK-STR-NBR                    20760000
191700                               PV-WORK-STR-NBR-TEST               20770000
191800****** SKIP ALL ITEMS WITH DEPT 099 SUB CL 10 AND ZERO.           20780000
191900****** THIS IS USED TO STORE GIFT WRAP AND SHIPPING REFUNDS.      20790000
192000         IF EPITM-DEPT-NBR = '099' AND                            20800000
192100            EPITM-SUB-CL-NBR = '10' AND                           20810000
192200            EPITM-CUST-CHRGD-AMT = ZERO                           20820000
192300              MOVE EPTRN-TRN-DTE TO PV-ORD-DTE                    20830000
192400         ELSE                                                     20840000
192500             PERFORM 4200-PROCESS-SALE-RETURN                     20850000
192600         END-IF                                                   20860000
192700         PERFORM 4110-FETCH-LINE-ITEM-CURSOR                      20870000
192800     END-PERFORM.                                                 20880000
192900     PERFORM 4120-CLOSE-LINE-ITEM-CURSOR.                         20890000
193000                                                                  20900000
193100*** PROCESS TRANSACTION LEVEL DISCOUNTS                           20910000
193200                                                                  20920000
193300     MOVE SPACE                TO PS-END-OF-TLCD-CURSOR-SW        20930000
193400     PERFORM 4400-OPEN-TLCD-CURSOR                                20940000
193500     PERFORM 4410-FETCH-TLCD-CURSOR                               20950000
193600     PERFORM UNTIL PS-END-OF-TLCD-CURSOR                          20960000
193700         IF EPTLD-TLD-TYP-CDE NOT = 'T'                           20970000
193800             PERFORM 4420-PROCESS-TLCD-CURSOR                     20980000
193900         END-IF                                                   20990000
194000         PERFORM 4410-FETCH-TLCD-CURSOR                           21000000
194100     END-PERFORM.                                                 21010000
194200     PERFORM 4430-CLOSE-TLCD-CURSOR.                              21020000
194300                                                                  21030000
194400**PROCESS ALL SPECIAL SERVICE FEES AND SHIPPING CHARGES.          21040000
194500                                                                  21050000
194600     SET PS-NOT-END-OF-SSFEES-CURSOR TO TRUE.                     21060000
194700     PERFORM 4450-OPEN-SSFEES-CURSOR                              21070000
194800     PERFORM 4460-FETCH-SSFEES-CURSOR                             21080000
194900     PERFORM UNTIL PS-END-OF-SSFEES-CURSOR                        21090000
195000         EVALUATE EPLIS-SRVC-TYP-CDE                              21100000
195100             WHEN 'W'                                             21110000
195200                 SET PS-WRAP-LINE-ITEM       TO TRUE              21120000
195300             WHEN 'S'                                             21130000
195400                 SET PS-SHIP-LINE-ITEM       TO TRUE              21140000
195410             WHEN 'F'                                             21150000
195420                 SET PS-FEE-LINE-ITEM        TO TRUE              21160000
195430         END-EVALUATE                                             21170000
195440*ALWAYS PROCESS WRAP ITEMS FOUND.  FOR E-COMMERCE STORES ONLY     21180000
195450*PROCESS SHIPPING ITEMS WHEN THE TRANSACTION IS A RETURN.         21190000
195460         IF PS-NOT-ECOMMERCE-STORE                                21200000
195470             PERFORM 4470-PROCESS-SSFEES-CURSOR                   21210000
195480         ELSE                                                     21220000
195490             IF (TH-RETURN-TRANSACTION                            21230000
195500                AND EPTRN-TRN-STAT-CDE NOT = 'R')                 21240000
195600                OR PS-WRAP-LINE-ITEM                              21250000
195700                OR PS-FEE-LINE-ITEM                               21260000
195800                 PERFORM 4470-PROCESS-SSFEES-CURSOR               21270000
195900             END-IF                                               21280000
196000         END-IF                                                   21290000
196100         PERFORM 4460-FETCH-SSFEES-CURSOR                         21300000
196200     END-PERFORM                                                  21310000
196300     PERFORM 4480-CLOSE-SSFEES-CURSOR                             21320000
196400                                                                  21330000
196500     IF PS-ECOMMERCE-RETURN AND PS-TEPECX-EXISTS-YES              21340000
196600         AND PS-OMNI-CHNL-IS-NOT-NULL                             21350000
196700         MOVE PV-ORIG-PARTN-NBR                                   21360000
196800             TO PV-SHP-PARTN-NBR                                  21370000
196900         MOVE EPIRT-ORIG-STR-NBR                                  21380000
197000             TO PV-SHP-STR-NBR                                    21390000
197100         MOVE EPIRT-ORIG-RGST-ID                                  21400000
197200             TO PV-SHP-RGST-ID                                    21410000
197300         MOVE EPIRT-ORIG-TRN-NBR                                  21420000
197400             TO PV-SHP-TRN-NBR                                    21430000
197500         MOVE EPIRT-ORIG-STRT-TM                                  21440000
197600             TO PV-SHP-STRT-TM                                    21450000
197700         SET PS-NOT-END-OF-SHIP-CURSOR TO TRUE                    21460000
197800         PERFORM 4481-OPEN-SHIPE-CURSOR                           21470000
197900         PERFORM 4482-FETCH-SHIPE-CURSOR                          21480000
198000         PERFORM UNTIL PS-END-OF-SHIP-CURSOR                      21490000
198100             PERFORM 4483-PROCESS-SHIPE-CURSOR                    21500000
198200             PERFORM 4482-FETCH-SHIPE-CURSOR                      21510000
198300         END-PERFORM                                              21520000
198400         PERFORM 4484-CLOSE-SHIPE-CURSOR                          21530000
198500     ELSE                                                         21540000
198600         MOVE EPTRN-PARTN-NBR                                     21550000
198700             TO PV-SHP-PARTN-NBR                                  21560000
198800         MOVE EPTRN-STR-NBR                                       21570000
198900             TO PV-SHP-STR-NBR                                    21580000
199000         MOVE EPTRN-RGST-ID                                       21590000
199100             TO PV-SHP-RGST-ID                                    21600000
199200         MOVE EPTRN-TRN-NBR                                       21610000
199300             TO PV-SHP-TRN-NBR                                    21620000
199400         MOVE EPTRN-STRT-TM                                       21630000
199500             TO PV-SHP-STRT-TM                                    21640000
199600         SET PS-NOT-END-OF-SHIP-CURSOR TO TRUE                    21650000
199700         PERFORM 4485-OPEN-SHIP-CURSOR                            21660000
199800         PERFORM 4490-FETCH-SHIP-CURSOR                           21670000
199900         PERFORM UNTIL PS-END-OF-SHIP-CURSOR                      21680000
200000             PERFORM 4495-PROCESS-SHIP-CURSOR                     21690000
200100             PERFORM 4490-FETCH-SHIP-CURSOR                       21700000
200200         END-PERFORM                                              21710000
200300         PERFORM 4496-CLOSE-SHIP-CURSOR                           21720000
200400     END-IF.                                                      21730000
200500                                                                  21740000
200600                                                                  21750000
200700******************************************************************21760000
200800*** IF THE KOHLS TENDER AMOUNT DOES NOT EQUAL THE TRANSACTION  ***21770000
200900*** AMOUNT, THEN OTHER TENDERS HAVE TO BE ACCOUNTED FOR.       ***21780000
201000******************************************************************21790000
201100                                                                  21800000
201200     IF EPTRN-TRN-TOT-AMT          NOT EQUAL EPTND-TNDR-AMT       21810000
201300         PERFORM 4600-PROCESS-SPLIT-TENDER                        21820000
201400     END-IF.                                                      21830000
201500                                                                  21840000
201600*** IF PRESENT, PROCESS THE SALES TAX                             21850000
201700                                                                  21860000
201800     IF EPTRN-SLS-TX-AMT           NOT EQUAL ZERO                 21870000
201900         PERFORM 4500-PROCESS-SALES-TAX                           21880000
202000     END-IF.                                                      21890000
202100                                                                  21900000
202200***************************************************************** 21910000
202300*  GET THE TRN GROUP CODE                                         21920000
202400***************************************************************** 21930000
202500 4050-GET-TRN-GRP-CDE.                                            21940000
202600                                                                  21950000
202700                                                                  21960000
202800     EXEC SQL                                                     21970000
202900          SELECT TRN_GP_CDE                                       21980000
203000          INTO :EPTRT-TRN-GP-CDE                                  21990000
203100          FROM  TEPTRT                                            22000000
203200          WHERE   PARTN_NBR        = :EPTRN-PARTN-NBR             22010000
203300            AND   STR_NBR          = :EPTRN-STR-NBR               22020000
203400            AND   RGST_ID          = :EPTRN-RGST-ID               22030000
203500            AND   TRN_NBR          = :EPTRN-TRN-NBR               22040000
203600            AND   STRT_TM          = :EPTRN-STRT-TM               22050000
203700            AND   SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR      22060000
203800          WITH UR                                                 22070000
203900     END-EXEC.                                                    22080000
204000                                                                  22090000
204100     EVALUATE TRUE                                                22100000
204200         WHEN SQLCODE = ZERO                                      22110000
204300         WHEN SQLCODE = -811                                      22120000
204400             CONTINUE                                             22130000
204500         WHEN SQLCODE = +100                                      22140000
204600             MOVE SPACES TO EPTRT-TRN-GP-CDE                      22150000
204700         WHEN SQLWARN0 NOT EQUAL SPACE                            22160000
204800         WHEN SQLCODE NOT EQUAL ZERO                              22170000
204900             MOVE '4050-GET-TRN-GRP-CDE'                          22180000
205000                                            TO PV-PARAGRAPH-NAME  22190000
205100             MOVE 'TO SELECT FROM TEPTRT  '                       22200000
205200                                            TO PV-DB2-OPERATION   22210000
205300             DISPLAY 'PARTITION NBR : ' EPTRN-PARTN-NBR           22220000
205400             DISPLAY 'STORE NBR  :  '    EPTRN-STR-NBR            22230000
205500             DISPLAY 'REGISTER ID:  '    EPTRN-RGST-ID            22240000
205600             DISPLAY 'TRANS NBR  :  '    EPTRN-TRN-NBR            22250000
205700             DISPLAY 'START TIME :  '    EPTRN-STRT-TM            22260000
205800             DISPLAY 'SALES CORR SEQ NBR: ' EPTRN-SLS-CORR-SEQ-NBR22270000
205900             PERFORM 9200-SQL-ABEND                               22280000
206000     END-EVALUATE.                                                22290000
206100                                                                  22300000
206200***************************************************************** 22310000
206300*  OPEN THE ITEMS CURSOR                                          22320000
206400***************************************************************** 22330000
206500 4100-OPEN-LINE-ITEM-CURSOR.                                      22340000
206600                                                                  22350000
206700     EXEC SQL                                                     22360000
206800         OPEN ITEMS-CSR                                           22370000
206900     END-EXEC.                                                    22380000
207000                                                                  22390000
207100     EVALUATE TRUE                                                22400000
207200         WHEN SQLCODE = ZERO                                      22410000
207300             CONTINUE                                             22420000
207400         WHEN SQLWARN0 NOT EQUAL SPACE                            22430000
207500         WHEN SQLCODE NOT EQUAL ZERO                              22440000
207600             MOVE '4100-OPEN-LINE-ITEM-CURSOR'                    22450000
207700                                            TO PV-PARAGRAPH-NAME  22460000
207800             MOVE 'ERROR ON OPENING LINE ITEM CURSOR '            22470000
207900                                            TO PV-DB2-OPERATION   22480000
208000             PERFORM 9200-SQL-ABEND                               22490000
208100     END-EVALUATE.                                                22500000
208200                                                                  22510000
208300****************************************************************  22520000
208400*  FETCH THE ITEMS CURSOR                                         22530000
208500****************************************************************  22540000
208600 4110-FETCH-LINE-ITEM-CURSOR.                                     22550000
208700                                                                  22560000
208800     MOVE ZERO TO PS-NULL-IND1                                    22570000
208900                  PS-NULL-IND3.                                   22580000
209000     MOVE ZERO TO EPRTX-TX-RT-PCT.                                22590000
209100     MOVE SPACES TO EPITM-TX-PRD-CDE-DESC-TEXT.                   22600000
209200                                                                  22610000
209300     EXEC SQL                                                     22620000
209400     FETCH ITEMS-CSR                                              22630000
209500         INTO  :EPITM-LNE-ITM-SEQ-NBR                             22640000
209600              ,:EPITM-DEPT-NBR                                    22650000
209700              ,:EPITM-SUB-CL-NBR                                  22660000
209800              ,:EPITM-SLD-QTY                                     22670000
209900              ,:EPITM-NET-CHRGD-AMT                               22680000
210000              ,:EPITM-UPC-NBR                                     22690000
210100              ,:EPITM-SAL-RET-CDE                                 22700000
210200              ,:EPITM-TXBL-IND                                    22710000
210300              ,:EPITM-SRVR-ONLN-IND                               22720000
210400              ,:EPITM-CUST-CHRGD-AMT                              22730000
210500              ,:EPITM-ITM-ASG-TX-ID                               22740000
210600              ,:EPITM-RCPT-TX-TOT-CDE                             22750000
210700              ,:EPITM-GFT-RCPT-CDE                                22760000
210800              ,:EPITM-TX-RT-PCT                                   22770000
210900              ,:EPITM-TX-AMT                                      22780000
211000              ,:EPITM-SKU-NBR                                     22790000
211100              ,:EPITM-RCPT-SEQ-NBR                                22800000
211200              ,:EPITM-RET-AMT                                     22810000
211300              ,:EPITM-SBJCT-TO-TX-AMT                             22820000
211400              ,:EPRTX-TX-RT-PCT:PS-NULL-IND1                      22830000
211500              ,:EPITM-TX-PRD-CDE-DESC:PS-NULL-IND3                22840000
211600     END-EXEC.                                                    22850000
211700                                                                  22860000
211800     EVALUATE TRUE                                                22870000
211900         WHEN SQLCODE = ZERO                                      22880000
212000             MOVE EPITM-LNE-ITM-SEQ-NBR TO PV-LINE-ITEM-NBR       22890000
212100             MOVE EPITM-GFT-RCPT-CDE    TO PV-GIFT-RECPT-CDE      22900000
212200             IF EPITM-RCPT-SEQ-NBR = ZERO                         22910000
212300                 MOVE EPITM-LNE-ITM-SEQ-NBR TO                    22920000
212400                      EPITM-RCPT-SEQ-NBR                          22930000
212500             END-IF                                               22940000
212600         WHEN SQLCODE = +100                                      22950000
212700             SET PS-END-OF-LINE-ITEM-CURSOR                       22960000
212800                                   TO TRUE                        22970000
212900         WHEN SQLWARN0 NOT EQUAL SPACE                            22980000
213000         WHEN SQLCODE NOT EQUAL ZERO                              22990000
213100             MOVE '4110-FETCH-LINE-ITEM-CURSOR'                   23000000
213200                                            TO PV-PARAGRAPH-NAME  23010000
213300             MOVE 'ERROR ON FETCHING LINE ITEM CURSOR '           23020000
213400                                            TO PV-DB2-OPERATION   23030000
213500             PERFORM 9200-SQL-ABEND                               23040000
213600     END-EVALUATE.                                                23050000
213700                                                                  23060000
213800***************************************************************** 23070000
213900*  CLOSE THE ITEMS CURSOR                                         23080000
214000***************************************************************** 23090000
214100 4120-CLOSE-LINE-ITEM-CURSOR.                                     23100000
214200                                                                  23110000
214300     EXEC SQL                                                     23120000
214400         CLOSE ITEMS-CSR                                          23130000
214500     END-EXEC.                                                    23140000
214600                                                                  23150000
214700     EVALUATE TRUE                                                23160000
214800         WHEN SQLCODE = ZERO                                      23170000
214900             CONTINUE                                             23180000
215000         WHEN SQLWARN0 NOT EQUAL SPACE                            23190000
215100         WHEN SQLCODE NOT EQUAL ZERO                              23200000
215200             MOVE '4120-CLOSE-LINE-ITEM-CURSOR'                   23210000
215300                                            TO PV-PARAGRAPH-NAME  23220000
215400             MOVE 'ERROR ON CLOSING LINE ITEM CURSOR '            23230000
215500                                            TO PV-DB2-OPERATION   23240000
215600             PERFORM 9200-SQL-ABEND                               23250000
215700     END-EVALUATE.                                                23260000
215800                                                                  23270000
215900***************************************************************** 23280000
216000*  PROCESS A LINE ITEM AS A SALE OR RETURN                        23290000
216100***************************************************************** 23300000
216200 4200-PROCESS-SALE-RETURN.                                        23310000
216300                                                                  23320000
216400     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      23330000
216500                                                                  23340000
216600     ADD +1                       TO TH-LINE-NUMBER.              23350000
216700     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR.       23360000
216800     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         23370000
216900     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      23380000
217000     MOVE PV-STRT-TM              TO AR001-START-TIME.            23390000
217100     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      23400000
217200                                                                  23410000
217300     IF EPITM-SBJCT-TO-TX-AMT = 0                                 23420000
217400         MOVE EPITM-NET-CHRGD-AMT   TO PV-SBJCT-TO-TX-AMT         23430000
217500     ELSE                                                         23440000
217600         MOVE EPITM-SBJCT-TO-TX-AMT TO PV-SBJCT-TO-TX-AMT         23450000
217700     END-IF.                                                      23460000
217800     MOVE EPITM-NET-CHRGD-AMT   TO PV-NET-CHRGD-AMT.              23470000
217900                                                                  23480000
218000     MOVE EPITM-CUST-CHRGD-AMT  TO PV-CUST-CHRGD-AMT.             23490000
218100                                                                  23500000
218200**** IF THE REGISTER WAS OFFLINE TO THE SERVER WHEN THE           23510000
218300**** TRANSACTION WAS PROCESSED, THEN THE PLU CODE (ITM ASG TX ID) 23520000
218400**** IS PROBABLY INVALID.                                         23530000
218500                                                                  23540000
218600     IF EPITM-SRVR-ONLN-IND = 'N'                                 23550000
218700         MOVE SPACES TO EPITM-ITM-ASG-TX-ID                       23560000
218800     END-IF.                                                      23570000
218900                                                                  23580000
219000     PERFORM 4800-APPLY-LINE-ITEM-DISCOUNTS.                      23590000
219100                                                                  23600000
219200***** IF THE ITEM IS AN EBOGO GET ONE ITEM, IT USES THE TAXIBLITY 23610000
219300***** OF THE PURCHASED ITEM.  WHEN A PURCHASED ITEM IS PROCESSED, 23620000
219400***** SAVE THE TAXABILITY OF THE PURCHASED ITEM FOR THE FREE ITEM.23630000
219500                                                                  23640000
219600     IF PS-EBOGO-GETONE-ITEM-NO                                   23650000
219700         MOVE EPITM-TXBL-IND      TO PV-SAVE-TXBL-IND             23660000
219800         MOVE EPITM-ITM-ASG-TX-ID TO PV-SAVE-ITM-ASG-TX-ID        23670000
219900         MOVE EPITM-RCPT-TX-TOT-CDE                               23680000
220000                                  TO PV-SAVE-RCPT-TX-TOT-CDE      23690000
220100     END-IF.                                                      23700000
220200     MOVE PV-SAVE-RCPT-TX-TOT-CDE TO AR001-RCPT-TX-TOT-CDE.       23710000
220300                                                                  23720000
220400     MOVE EPITM-UPC-NBR            TO PV-UPC.                     23730000
220500     SET PS-ITEM-LINE-ITEM         TO TRUE.                       23740000
220600                                                                  23750000
220700******************************************************************23760000
220800* GET THE EMPLOYEE DISCOUNT AMOUNT FOR EMPLOYEE DISCOUNT RETURNS *23770000
220900* WITH A GIFT RECEIPT.  ALSO GET THE EMPLOYEE DISCOUNT AMOUNT    *23780000
221000* FOR EMPLOYEE DISCOUNT RETURN REVERSALS.                        *23790000
221100******************************************************************23800000
221200                                                                  23810000
221300     MOVE SPACE                       TO EPEID-EMP-DISC-CTG-CDE.  23820000
221400     MOVE ZERO                        TO EPEID-EMP-DISC-AMT.      23830000
221500     MOVE SPACE                       TO EPEID-EMP-DISC-SRC-CDE.  23840000
221600     PERFORM 4440-CHECK-FOR-EID.                                  23850000
221610     IF EPEID-EMP-DISC-CTG-CDE = 'K'                              23860000
221700         MOVE EPEID-EMP-DISC-AMT          TO AR001-EMP-DISC-AMT   23870000
221710     END-IF.                                                      23880000
221800     MOVE EPEID-EMP-DISC-SRC-CDE      TO AR001-EMP-DISC-SRC-CDE.  23890000
221900                                                                  23900000
222000     MOVE PV-NET-CHRGD-AMT      TO PV-EMPL-DISC-TRN-AMT.          23910000
222010     IF EPEID-EMP-DISC-CTG-CDE = 'C'                              23920000
222020             COMPUTE PV-CUST-CHRGD-AMT =                          23930000
222030                     PV-CUST-CHRGD-AMT + EPEID-EMP-DISC-AMT       23940000
222040     END-IF.                                                      23950000
222100                                                                  23960000
222200     IF EPITM-SAL-RET-CDE = 'R'  OR                               23970000
222300        EPITM-SAL-RET-CDE = 'B'  OR                               23980000
222400       (EPITM-SAL-RET-CDE = 'S' AND EPTRN-TRN-STAT-CDE = 'R')     23990000
222900         PERFORM 7600-GET-ORIG-TRANS-INFO                         24000000
223000     END-IF.                                                      24010000
223100                                                                  24020000
223200     MOVE EPTRN-TRN-DTE TO PV-ORD-DTE.                            24030000
223300                                                                  24040000
223400******************************************************************24050000
223500* GET TAX RATE INFORMATION AND GEOGRAPHIC INFORMATION FOR        *24060000
223600* ECOMMERCE TRANSACTIONS.  FOR RETURN TRANSACTIONS GET THE       *24070000
223700* INFORMATION FROM THE ORIGINAL TRANSACTION.                     *24080000
223800******************************************************************24090000
223900     EVALUATE TRUE                                                24100000
224000         WHEN EPTRN-SLS-CORR-SEQ-NBR > 0 AND PS-ECOMMERCE-STORE   24110000
224100             IF PV-SAVE-TXBL-IND = 'Y'                            24120000
224200                 IF PS-NULL-IND1 = 0                              24130000
224300                     MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT         24140000
224400                 ELSE                                             24150000
224500                     MOVE EPITM-TX-RT-PCT TO PV-TX-RT-PCT         24160000
224600                 END-IF                                           24170000
224700             ELSE                                                 24180000
224800                 MOVE ZERO         TO PV-TX-RT-PCT                24190000
224900             END-IF                                               24200000
225000             MOVE ZERO             TO PV-TX-AMT                   24210000
225100                                                                  24220000
225200         WHEN TH-SALE-TRANSACTION AND PS-ECOMMERCE-STORE          24230000
225300             MOVE EPTRN-TRN-DTE         TO PV-ORD-DTE             24240000
225400             MOVE EPITM-TX-RT-PCT       TO PV-TX-RT-PCT           24250000
225500             MOVE EPITM-LNE-ITM-SEQ-NBR TO PV-LNE-ITM-SEQ-NBR     24260000
225600             PERFORM 7750-GET-GEO-INFO                            24270000
225700             MOVE EPITM-TX-AMT          TO PV-TX-AMT              24280000
225800                                                                  24290000
225900         WHEN TH-RETURN-TRANSACTION AND PS-ECOMMERCE-RETURN       24300000
226000             IF PV-SAVE-TXBL-IND = 'Y'                            24310000
226100                 IF PS-ECOMMERCE-STORE                            24320000
226200                     MOVE EPITM-TX-RT-PCT  TO PV-TX-RT-PCT        24330000
226300                     MOVE EPITM-TX-AMT     TO PV-TX-AMT           24340000
226400                 ELSE                                             24350000
226500                     MOVE EPRTX-TX-RT-PCT  TO PV-TX-RT-PCT        24360000
226600                     MOVE ZERO             TO PV-TX-AMT           24370000
226700                 END-IF                                           24380000
226800             ELSE                                                 24390000
226900                 MOVE ZERO             TO PV-TX-RT-PCT            24400000
227000                                          PV-TX-AMT               24410000
227100             END-IF                                               24420000
227200             IF PS-RECEIPTED-RETURN                               24430000
227300                  IF PS-ECOMMERCE-STORE                           24440000
227400                      PERFORM 4260-GET-RETURN-INFO                24450000
227500                  ELSE                                            24460000
227600                      PERFORM 4322-GET-OPERATING-TRN-DTE          24470000
227700                  END-IF                                          24480000
227800             END-IF                                               24490000
227900                                                                  24500000
228000         WHEN TH-RETURN-TRANSACTION AND PS-NOT-ECOMMERCE-RETURN   24510000
228100             IF PS-RECEIPTED-RETURN                               24520000
228200                 MOVE EPIRT-ORIG-SLS-DTE TO PV-ORD-DTE            24530000
228300             ELSE                                                 24540000
228400                 MOVE EPTRN-TRN-DTE      TO PV-ORD-DTE            24550000
228500             END-IF                                               24560000
228600             IF EPRTX-TX-RT-PCT > 0                               24570000
228700                 IF PV-SAVE-TXBL-IND = 'Y'                        24580000
228800                    EVALUATE PV-SAVE-ITM-ASG-TX-ID                24590000
228900                        WHEN SPACES                               24600000
229000                            MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT  24610000
229100                        WHEN '0'                                  24620000
229200                            MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT  24630000
229300                        WHEN OTHER                                24640000
229400                            IF EPTRN-SLS-CORR-SEQ-NBR = ZERO      24650000
229500                                PERFORM 4210-SEARCH-TAX-TABLE     24660000
229600                            ELSE                                  24670000
229700                                PERFORM 4220-SELECT-TAX-INFO      24680000
229800                            END-IF                                24690000
229900                    END-EVALUATE                                  24700000
230000                    MOVE EPITM-TX-AMT TO PV-TX-AMT                24710000
230100                 END-IF                                           24720000
230200             END-IF                                               24730000
230300                                                                  24740000
230400         WHEN OTHER                                               24750000
230500             IF TH-ADJUSTMENT-TRANSACTION                         24760000
230600                 IF PS-RECEIPTED-RETURN                           24770000
230700                     IF EPITM-SAL-RET-CDE = 'B'                   24780000
230800                         MOVE EPIRT-ORIG-SLS-DTE TO PV-ORD-DTE    24790000
230900                     ELSE                                         24800000
231000                         MOVE EPTRN-TRN-DTE    TO PV-ORD-DTE      24810000
231100                     END-IF                                       24820000
231200                 ELSE                                             24830000
231300                     MOVE EPTRN-TRN-DTE    TO PV-ORD-DTE          24840000
231400                 END-IF                                           24850000
231500             ELSE                                                 24860000
231600                 MOVE EPTRN-TRN-DTE    TO PV-ORD-DTE              24870000
231700             END-IF                                               24880000
231800             IF EPRTX-TX-RT-PCT > ZERO                            24890000
231900                 IF PV-SAVE-TXBL-IND = 'Y'                        24900000
232000                    EVALUATE PV-SAVE-ITM-ASG-TX-ID                24910000
232100                        WHEN SPACES                               24920000
232200                            MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT  24930000
232300                        WHEN '0'                                  24940000
232400                            MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT  24950000
232500                        WHEN OTHER                                24960000
232600                            IF EPTRN-SLS-CORR-SEQ-NBR = ZERO      24970000
232700                                PERFORM 4210-SEARCH-TAX-TABLE     24980000
232800                            ELSE                                  24990000
232900                                PERFORM 4220-SELECT-TAX-INFO      25000000
233000                            END-IF                                25010000
233100                    END-EVALUATE                                  25020000
233200                    MOVE EPITM-TX-AMT TO PV-TX-AMT                25030000
233300                 END-IF                                           25040000
233400             END-IF                                               25050000
233500     END-EVALUATE.                                                25060000
233600                                                                  25070000
233700     IF PV-SAVE-TXBL-IND       = 'N'                              25080000
233800         MOVE 'N' TO PV-TAX-IND                                   25090000
233900     ELSE                                                         25100000
234000         MOVE SPACES TO PV-TAX-IND                                25110000
234100     END-IF.                                                      25120000
234200                                                                  25130000
234300     IF EPEID-EMP-DISC-SRC-CDE = 'P' OR 'H'                       25140000
234400         MOVE EPITM-TX-AMT    TO PV-TX-AMT                        25150000
234500     END-IF.                                                      25160000
234600                                                                  25170000
234700****IF THE LINE ITEM IS A BOGO ITEM, SET THE PROMOTION CODE TO P  25180000
234800****AND MOVE THE RETURN AMOUNT TO BE WRITTEN TO THE OUTPUT RECORD 25190000
234900****ALSO MOVE NINES TO NON-BOGO ITEMS.                            25200000
235000                                                                  25210000
235100     IF PS-EBOGO-ITEM-YES                                         25220000
235200         MOVE EPITM-RET-AMT          TO AR001-RET-AMT             25230000
235300         MOVE PC-PROMOTION-CODE      TO AR001-BOGO-PROMO-CDE      25240000
235400     ELSE                                                         25250000
235500         MOVE ZEROES             TO AR001-RET-AMT                 25260000
235600         MOVE SPACE              TO AR001-BOGO-PROMO-CDE          25270000
235700     END-IF.                                                      25280000
235800                                                                  25290000
235900     IF PS-EBOGO-GETONE-ITEM-YES                                  25300000
236000         MOVE PC-NINES           TO AR001-RCPT-SEQ-NBR            25310000
236100     ELSE                                                         25320000
236200         MOVE EPITM-RCPT-SEQ-NBR TO AR001-RCPT-SEQ-NBR            25330000
236300     END-IF.                                                      25340000
236400                                                                  25350000
236500     MOVE EPITM-TX-PRD-CDE-DESC-TEXT TO AR001-PRD-CDE.            25360000
236600                                                                  25370000
236700     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          25380000
236800                                                                  25390000
236900******************************************************************25400000
237000*  FOR CURRENT TRANSACTIONS, SEARCH THE WORKING STORAGE TABLE     25410000
237100*  FOR THE LINE ITEM TAX INFORMATION                              25420000
237200******************************************************************25430000
237300 4210-SEARCH-TAX-TABLE.                                           25440000
237400                                                                  25450000
237500     SET TI-IDX                    TO 1.                          25460000
237600     SEARCH TI-TAX-INFO-TABLE-ENTRIES VARYING TI-IDX              25470000
237700           AT END                                                 25480000
237800                 MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT             25490000
237900         WHEN ((PV-WORK-STR-NBR = TI-STR-NBR (TI-IDX))            25500000
238000           AND (PV-SAVE-ITM-ASG-TX-ID                             25510000
238100                                   = TI-ASSIGNED-TAX-ID (TI-IDX)))25520000
238200             MOVE TI-TAX-RATE-PCT (TI-IDX)                        25530000
238300                                   TO PV-TX-RT-PCT                25540000
238400             MOVE TI-TAX-THRESH-AMOUNT (TI-IDX)                   25550000
238500                                   TO PV-TAX-THRESH-AMOUNT        25560000
238600             MOVE TI-TAX-RATE-BELOW-THRESH (TI-IDX)               25570000
238700                                   TO PV-TAX-RATE-BELOW-THRESH    25580000
238800     END-SEARCH.                                                  25590000
238900                                                                  25600000
239000******************************************************************25610000
239100*  GET THE TAX INFORMATION DIRECTLY FROM THE TTXRTLO TABLE FOR    25620000
239200*  LATES AND SALES CORRECTIONS                                    25630000
239300******************************************************************25640000
239400 4220-SELECT-TAX-INFO.                                            25650000
239500                                                                  25660000
239600     SET PS-TAX-INFO-NOT-FOUND TO TRUE.                           25670000
239700                                                                  25680000
239800     PERFORM 4230-READ-TAX-GROUP-LOC.                             25690000
239900                                                                  25700000
240000     IF PS-TAX-INFO-NOT-FOUND                                     25710000
240100       OR PV-ABV-THRS-FTX-IND = 'F'                               25720000
240200       OR PV-BLW-THRS-FTX-IND = 'F'                               25730000
240300        PERFORM 4250-READ-FULL-TAX-RATE                           25740000
240400     END-IF.                                                      25750000
240500                                                                  25760000
240600******************************************************************25770000
240700* READ TAX GROUP LOCATION TABLE FOR CURRENT STORE                 25780000
240800******************************************************************25790000
240900 4230-READ-TAX-GROUP-LOC.                                         25800000
241000                                                                  25810000
241100     EXEC SQL                                                     25820000
241200         SELECT TX_RT_PCT                                         25830000
241300               ,ABV_THRS_FTX_IND                                  25840000
241400               ,THRS_DOL_AMT                                      25850000
241500               ,BLW_THRS_TX_RT_PCT                                25860000
241600               ,BLW_THRS_FTX_IND                                  25870000
241700               ,POS_ASG_TX_ID                                     25880000
241800         INTO  :TXRTLO-TX-RT-PCT                                  25890000
241900              ,:TXRTLO-ABV-THRS-FTX-IND                           25900000
242000              ,:TXRTLO-THRS-DOL-AMT                               25910000
242100              ,:TXRTLO-BLW-THRS-TX-RT-PCT                         25920000
242200              ,:TXRTLO-BLW-THRS-FTX-IND                           25930000
242300              ,:TXRTLO-POS-ASG-TX-ID                              25940000
242400          FROM TTXRTLO                                            25950000
242500         WHERE STR_NBR = :PV-WORK-STR-NBR                         25960000
242600           AND POS_ASG_TX_ID =:PV-SAVE-ITM-ASG-TX-ID              25970000
242700           AND EFF_BEG_DTE = (SELECT MAX(EFF_BEG_DTE)             25980000
242800                                FROM TTXRTLO                      25990000
242900                               WHERE EFF_BEG_DTE <= :EPTRN-SLS-DTE26000000
243000                                 AND STR_NBR = :PV-WORK-STR-NBR   26010000
243100                                 AND POS_ASG_TX_ID =              26020000
243200                                      :PV-SAVE-ITM-ASG-TX-ID)     26030000
040723         FETCH FIRST 1 ROW ONLY                                   26031000
243300         WITH UR                                                  26040000
243400     END-EXEC.                                                    26050000
243500                                                                  26060000
243600     EVALUATE SQLCODE                                             26070000
243700         WHEN ZERO                                                26080000
243800               SET PS-TAX-INFO-FOUND    TO TRUE                   26090000
243900               MOVE TXRTLO-TX-RT-PCT    TO PV-TX-RT-PCT           26100000
244000               MOVE TXRTLO-THRS-DOL-AMT TO PV-TAX-THRESH-AMOUNT   26110000
244100               MOVE TXRTLO-BLW-THRS-TX-RT-PCT                     26120000
244200                                     TO PV-TAX-RATE-BELOW-THRESH  26130000
244300               MOVE TXRTLO-ABV-THRS-FTX-IND                       26140000
244400                                     TO PV-ABV-THRS-FTX-IND       26150000
244500               MOVE TXRTLO-BLW-THRS-FTX-IND                       26160000
244600                                     TO PV-BLW-THRS-FTX-IND       26170000
244700         WHEN +100                                                26180000
244800            CONTINUE                                              26190000
244900         WHEN OTHER                                               26200000
245000             MOVE '4230-READ-TAX-GROUP-LOC'                       26210000
245100                                            TO PV-PARAGRAPH-NAME  26220000
245200             MOVE 'ERROR ON GETTING TAX TTXRTLO INFO '            26230000
245300                                            TO PV-DB2-OPERATION   26240000
245400             PERFORM 9200-SQL-ABEND                               26250000
245500     END-EVALUATE.                                                26260000
245600                                                                  26270000
245700***************************************************************   26280000
245800*   READ FULL-TAX RATE FOR CURRENT ITEM                       *   26290000
245900***************************************************************   26300000
246000 4250-READ-FULL-TAX-RATE.                                         26310000
246100     EXEC SQL                                                     26320000
246200         SELECT TX_RT_PCT                                         26330000
246300               ,THRS_DOL_AMT                                      26340000
246400               ,BLW_THRS_TX_RT_PCT                                26350000
246500         INTO  :TXRTLO-TX-RT-PCT                                  26360000
246600              ,:TXRTLO-THRS-DOL-AMT                               26370000
246700              ,:TXRTLO-BLW-THRS-TX-RT-PCT                         26380000
246800         FROM   TTXRTLO                                           26390000
246900         WHERE  STR_NBR            = :PV-WORK-STR-NBR             26400000
247000           AND  TX_TYP_CDE = 'FT'                                 26410000
247100           AND  EFF_BEG_DTE = (SELECT MAX(EFF_BEG_DTE)            26420000
247200                                 FROM TTXRTLO                     26430000
247300                                WHERE STR_NBR = :PV-WORK-STR-NBR  26440000
247400                                  AND TX_TYP_CDE = 'FT'           26450000
247500                                  AND EFF_BEG_DTE <=              26460000
247600                                               :EPPART-SLS-DTE)   26470000
247700         WITH UR                                                  26480000
247800     END-EXEC.                                                    26490000
247900                                                                  26500000
248000     EVALUATE TRUE                                                26510000
248100         WHEN SQLCODE = ZERO                                      26520000
248200             CONTINUE                                             26530000
248300         WHEN SQLCODE = +100                                      26540000
248400         WHEN SQLCODE = -811                                      26550000
248500             MOVE EPRTX-TX-RT-PCT TO PV-TX-RT-PCT                 26560000
248600         WHEN SQLWARN0 NOT EQUAL SPACE                            26570000
248700         WHEN SQLCODE NOT EQUAL ZERO                              26580000
248800             MOVE '4250-READ-FULL-TAX-RATE'                       26590000
248900                                            TO PV-PARAGRAPH-NAME  26600000
249000             MOVE 'ERROR ON GETTING FULL TAX RATE INFO'           26610000
249100                                            TO PV-DB2-OPERATION   26620000
249200             PERFORM 9200-SQL-ABEND                               26630000
249300     END-EVALUATE.                                                26640000
249400                                                                  26650000
249500     IF SQLCODE = ZERO AND PS-TAX-INFO-FOUND                      26660000
249600       IF PV-ABV-THRS-FTX-IND = 'F'                               26670000
249700          MOVE TXRTLO-TX-RT-PCT TO PV-TX-RT-PCT                   26680000
249800       END-IF                                                     26690000
249900       IF PV-BLW-THRS-FTX-IND = 'F'                               26700000
250000          MOVE TXRTLO-TX-RT-PCT TO PV-TAX-RATE-BELOW-THRESH       26710000
250100       END-IF                                                     26720000
250200     END-IF.                                                      26730000
250300     IF SQLCODE = ZERO AND PS-TAX-INFO-NOT-FOUND                  26740000
250400         MOVE TXRTLO-TX-RT-PCT     TO PV-TX-RT-PCT                26750000
250500         MOVE TXRTLO-THRS-DOL-AMT  TO PV-TAX-THRESH-AMOUNT        26760000
250600         MOVE TXRTLO-BLW-THRS-TX-RT-PCT                           26770000
250700                                   TO PV-TAX-RATE-BELOW-THRESH    26780000
250800     END-IF.                                                      26790000
250900                                                                  26800000
251000***************************************************************** 26810000
251100* NOTE:  THE ORIG-LNE-ITM-SEQ-NBR ON TEPIRT IS ONLY SET WHEN    * 26820000
251200* A GIFT RECEIPT WAS GENERATED WITH THE TRANSACTION.  IF        * 26830000
251300* ORIG-LNE-ITN-SEQ-NBR IS ZERO, GET THE ITEM FROM TEPITM.       * 26840000
251400***************************************************************** 26850000
251500 4260-GET-RETURN-INFO.                                            26860000
251600                                                                  26870000
251700     IF EPIRT-ORIG-LNE-ITM-NBR > ZERO                             26880000
251800          PERFORM 4262-GET-OPERATING-SHIP-INFO                    26890000
251900     ELSE                                                         26900000
252000          SET PS-NOT-END-OF-TEPITM-CSR TO TRUE                    26910000
252100          PERFORM 4281-OPEN-TEPITM-CSR                            26920000
252200          PERFORM 4282-FETCH-TEPITM-CSR                           26930000
252300          PERFORM 4280-PROCESS-TEPITM-CSR                         26940000
252400              UNTIL PS-END-OF-TEPITM-CSR                          26950000
252500          PERFORM 4283-CLOSE-TEPITM-CSR                           26960000
252600     END-IF.                                                      26970000
252700     MOVE PV-ORIG-TRN-DTE  TO PV-ORD-DTE.                         26980000
252800                                                                  26990000
252900***************************************************************   27000000
253000* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   27010000
253100***************************************************************   27020000
253200 4262-GET-OPERATING-SHIP-INFO.                                    27030000
253300                                                                  27040000
253400     EXEC SQL                                                     27050000
253500       SELECT  A.TRN_DTE                                          27060000
253600              ,B.TX_RT_PCT                                        27070000
253700              ,D.ZIP_5_CDE                                        27080000
253800              ,D.TX_GEOG_CDE                                      27090000
253900        INTO  :PV-ORIG-TRN-DTE                                    27100000
254000             ,:PV-ORIG-TX-RT-PCT                                  27110000
254100             ,:EPSHP-ZIP-5-CDE                                    27120000
254200             ,:EPSHP-TX-GEOG-CDE                                  27130000
254300        FROM TEPTRN  A                                            27140000
254400            ,TEPITM  B                                            27150000
254500            ,TEPIPS  C                                            27160000
254600            ,TEPSHP  D                                            27170000
254700            ,TEPPART P                                            27180000
254800            ,TEPECX  E                                            27190000
254900        WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR             27200000
255000          AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR            27210000
255100          AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID            27220000
255200          AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR            27230000
255300          AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM            27240000
255400          AND B.LNE_ITM_SEQ_NBR  = :EPIRT-ORIG-LNE-ITM-NBR        27250000
255500          AND A.PARTN_NBR        = B.PARTN_NBR                    27260000
255600          AND A.STR_NBR          = B.STR_NBR                      27270000
255700          AND A.RGST_ID          = B.RGST_ID                      27280000
255800          AND A.TRN_NBR          = B.TRN_NBR                      27290000
255900          AND A.STRT_TM          = B.STRT_TM                      27300000
256000          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             27310000
256100          AND A.PARTN_NBR        = E.ORD_PARTN_NBR                27320000
256200          AND A.STR_NBR          = E.STR_NBR                      27330000
256300          AND A.RGST_ID          = E.RGST_ID                      27340000
256400          AND A.TRN_NBR          = E.TRN_NBR                      27350000
256500          AND A.STRT_TM          = E.STRT_TM                      27360000
256600          AND B.PARTN_NBR        = C.PARTN_NBR                    27370000
256700          AND B.STR_NBR          = C.STR_NBR                      27380000
256800          AND B.RGST_ID          = C.RGST_ID                      27390000
256900          AND B.TRN_NBR          = C.TRN_NBR                      27400000
257000          AND B.STRT_TM          = C.STRT_TM                      27410000
257100          AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR             27420000
257200          AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR              27430000
257300          AND C.PARTN_NBR        = D.PARTN_NBR                    27440000
257400          AND C.STR_NBR          = D.STR_NBR                      27450000
257500          AND C.RGST_ID          = D.RGST_ID                      27460000
257600          AND C.TRN_NBR          = D.TRN_NBR                      27470000
257700          AND C.STRT_TM          = D.STRT_TM                      27480000
257800          AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR             27490000
257900          AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR               27500000
258000          AND E.ORD_PARTN_NBR    = :PV-ORIG-PARTN-NBR             27510000
258100          AND P.SLS_DTE          = E.SLS_DTE                      27520000
258200          WITH UR                                                 27530000
258300     END-EXEC.                                                    27540000
258400                                                                  27550000
258500     EVALUATE TRUE                                                27560000
258600         WHEN SQLCODE = ZERO                                      27570000
258700             MOVE EPSHP-ZIP-5-CDE    TO PV-ZIP-CODE-ENCRYPT       27580000
258710             PERFORM 8100-PROCESS-ZIPCODE                         27590000
258720             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          27600000
258730             MOVE PV-ORIG-TRN-DTE    TO PV-ORD-DTE                27610000
258740         WHEN SQLCODE = +100                                      27620000
258750             CONTINUE                                             27630000
258760         WHEN SQLWARN0 NOT EQUAL SPACE                            27640000
258770         WHEN SQLCODE NOT EQUAL ZERO                              27650000
258780             MOVE '4262-GET-OPERATING-SHIP-INFO'                  27660000
258790                                            TO PV-PARAGRAPH-NAME  27670000
258800             MOVE 'ERROR SELECTING FROM TEPSHP'                   27680000
258900                                            TO PV-DB2-OPERATION   27690000
259000             PERFORM 9200-SQL-ABEND                               27700000
259100     END-EVALUATE.                                                27710000
259200                                                                  27720000
259300                                                                  27730000
259400***************************************************************   27740000
259500*  THE TEPITM CURSOR FETCHES ALL LINE ITEMS ON THE ORIGINAL   *   27750000
259600*  TRANSACTION THAT ARE THE SAME ITEM THAT WAS RETURNED.      *   27760000
259700*  USE THE ZIP CODE AND GEO CODE ON THE FIRST ITEM FOUND THAT *   27770000
259800*  HAS THE SAME TAX RATE.  IF THERE IS NO MATCHING TAX RATE   *   27780000
259900*  USE ZIP CODE AND GEO CODE ON THE FIRST LINE ITEM.          *   27790000
260000***************************************************************   27800000
260100 4280-PROCESS-TEPITM-CSR.                                         27810000
260200                                                                  27820000
260300     IF PV-ORIG-TX-RT-PCT = PV-TX-RT-PCT                          27830000
260400         MOVE PV-ORIG-ZIP-5-CDE TO PV-ZIP-CODE-ENCRYPT            27840000
260500         PERFORM 8100-PROCESS-ZIPCODE                             27850000
260600         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               27860000
260700         SET PS-END-OF-TEPITM-CSR TO TRUE                         27870000
260800     ELSE                                                         27880000
260900         PERFORM 4282-FETCH-TEPITM-CSR                            27890000
261000     END-IF.                                                      27900000
261100                                                                  27910000
261200***************************************************************   27920000
261300*  OPEN TEPITM CURSOR.                                        *   27930000
261400***************************************************************   27940000
261500 4281-OPEN-TEPITM-CSR.                                            27950000
261600                                                                  27960000
261700     EXEC SQL                                                     27970000
261800         OPEN TEPITM-CSR                                          27980000
261900     END-EXEC.                                                    27990000
262000                                                                  28000000
262100     EVALUATE SQLCODE                                             28010000
262200         WHEN ZERO                                                28020000
262300             CONTINUE                                             28030000
262400         WHEN OTHER                                               28040000
262500             MOVE '4281-OPEN-TEPITM-CSR'                          28050000
262600                                            TO PV-PARAGRAPH-NAME  28060000
262700             MOVE 'ERROR OPENING TEPITM CURSOR '                  28070000
262800                                            TO PV-DB2-OPERATION   28080000
262900             PERFORM 9200-SQL-ABEND                               28090000
263000     END-EVALUATE.                                                28100000
263100                                                                  28110000
263200***************************************************************   28120000
263300*  FETCH TEPITM CURSOR.                                       *   28130000
263400***************************************************************   28140000
263500 4282-FETCH-TEPITM-CSR.                                           28150000
263600                                                                  28160000
263700     EXEC SQL                                                     28170000
263800         FETCH TEPITM-CSR                                         28180000
263900          INTO :PV-ORIG-TRN-DTE                                   28190000
264000              ,:PV-ORIG-TX-RT-PCT                                 28200000
264100              ,:PV-ORIG-ZIP-5-CDE                                 28210000
264200              ,:PV-ORIG-GEOG-CDE                                  28220000
264300     END-EXEC.                                                    28230000
264400                                                                  28240000
264500     EVALUATE SQLCODE                                             28250000
264600         WHEN ZERO                                                28260000
264700             CONTINUE                                             28270000
264800         WHEN +100                                                28280000
264900             SET PS-END-OF-TEPITM-CSR TO TRUE                     28290000
265000             MOVE PV-ORD-DTE TO PV-ORIG-TRN-DTE                   28300000
265100         WHEN OTHER                                               28310000
265200             MOVE '4282-FETCH-TEPITM-CSR'                         28320000
265300                                            TO PV-PARAGRAPH-NAME  28330000
265400             MOVE 'ERROR FETCHING TEPITM CURSOR '                 28340000
265500                                            TO PV-DB2-OPERATION   28350000
265600             PERFORM 9200-SQL-ABEND                               28360000
265700     END-EVALUATE.                                                28370000
265800                                                                  28380000
265900***************************************************************   28390000
266000*  CLOSE TEPITM CURSOR.                                       *   28400000
266100***************************************************************   28410000
266200 4283-CLOSE-TEPITM-CSR.                                           28420000
266300                                                                  28430000
266400     EXEC SQL                                                     28440000
266500         CLOSE TEPITM-CSR                                         28450000
266600     END-EXEC.                                                    28460000
266700                                                                  28470000
266800     EVALUATE SQLCODE                                             28480000
266900         WHEN ZERO                                                28490000
267000             CONTINUE                                             28500000
267100         WHEN OTHER                                               28510000
267200             MOVE '4283-CLOSE-TEPITM-CSR'                         28520000
267300                                            TO PV-PARAGRAPH-NAME  28530000
267400             MOVE 'ERROR CLOSING TEPITM CURSOR '                  28540000
267500                                            TO PV-DB2-OPERATION   28550000
267600             PERFORM 9200-SQL-ABEND                               28560000
267700     END-EVALUATE.                                                28570000
267800                                                                  28580000
267900***************************************************************   28590000
268000* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   28600000
268100***************************************************************   28610000
268200 4322-GET-OPERATING-TRN-DTE.                                      28620000
268300                                                                  28630000
268400     EXEC SQL                                                     28640000
268500       SELECT  TRN_DTE                                            28650000
268600        INTO  :PV-ORIG-TRN-DTE                                    28660000
268700        FROM   TEPTRN A                                           28670000
268800        WHERE PARTN_NBR        = :PV-ORIG-PARTN-NBR               28680000
268900          AND STR_NBR          = :EPIRT-ORIG-STR-NBR              28690000
269000          AND RGST_ID          = :EPIRT-ORIG-RGST-ID              28700000
269100          AND TRN_NBR          = :EPIRT-ORIG-TRN-NBR              28710000
269200          AND STRT_TM          = :EPIRT-ORIG-STRT-TM              28720000
269300          AND SLS_CORR_SEQ_NBR = (SELECT MAX(B.SLS_CORR_SEQ_NBR)  28730000
269400                                    FROM TEPTRN B                 28740000
269500                                   WHERE A.PARTN_NBR = B.PARTN_NBR28750000
269600                                     AND A.STR_NBR = B.STR_NBR    28760000
269700                                     AND A.RGST_ID = B.RGST_ID    28770000
269800                                     AND A.TRN_NBR = B.TRN_NBR    28780000
269900                                     AND A.STRT_TM = B.STRT_TM)   28790000
270000        WITH UR                                                   28800000
270100     END-EXEC.                                                    28810000
270200                                                                  28820000
270300     EVALUATE TRUE                                                28830000
270400         WHEN SQLCODE = ZERO                                      28840000
270500             MOVE PV-ORIG-TRN-DTE TO PV-ORD-DTE                   28850000
270600         WHEN SQLCODE = -811                                      28860000
270700             DISPLAY PV-ORIG-PARTN-NBR ' '                        28870000
270800                     EPIRT-ORIG-STR-NBR ' '                       28880000
270900                     EPIRT-ORIG-RGST-ID ' '                       28890000
271000                     EPIRT-ORIG-TRN-NBR ' '                       28900000
271100                     EPIRT-ORIG-STRT-TM ' '                       28910000
271200                     ' DUPLICATE ON TEPTRN TABLE.'                28920000
271300         WHEN SQLCODE = +100                                      28930000
271400             CONTINUE                                             28940000
271500         WHEN SQLWARN0 NOT EQUAL SPACE                            28950000
271600         WHEN SQLCODE NOT EQUAL ZERO                              28960000
271700             DISPLAY PV-ORIG-PARTN-NBR ' '                        28970000
271800                     EPIRT-ORIG-STR-NBR ' '                       28980000
271900                     EPIRT-ORIG-RGST-ID ' '                       28990000
272000                     EPIRT-ORIG-TRN-NBR ' '                       29000000
272100                     EPIRT-ORIG-STRT-TM ' '                       29010000
272200             MOVE '4322-GET-OPERATING-TRN-DTE'                    29020000
272300                                            TO PV-PARAGRAPH-NAME  29030000
272400             MOVE 'ERROR SELECTING FROM TEPTRN'                   29040000
272500                                            TO PV-DB2-OPERATION   29050000
272600             PERFORM 9200-SQL-ABEND                               29060000
272700     END-EVALUATE.                                                29070000
272800                                                                  29080000
272900                                                                  29090000
273000***************************************************************** 29100000
273100*  OPEN THE TRANSACTION LEVEL CASH DISCOUNT CURSOR                29110000
273200***************************************************************** 29120000
273300 4400-OPEN-TLCD-CURSOR.                                           29130000
273400                                                                  29140000
273500     EXEC SQL                                                     29150000
273600         OPEN TLCD-CSR                                            29160000
273700     END-EXEC.                                                    29170000
273800                                                                  29180000
273900     EVALUATE TRUE                                                29190000
274000         WHEN SQLCODE = ZERO                                      29200000
274100             CONTINUE                                             29210000
274200         WHEN SQLWARN0 NOT EQUAL SPACE                            29220000
274300         WHEN SQLCODE NOT EQUAL ZERO                              29230000
274400             MOVE '4400-OPEN-TLCD-CURSOR'                         29240000
274500                                            TO PV-PARAGRAPH-NAME  29250000
274600             MOVE 'ERROR ON OPENING TLCD CURSOR '                 29260000
274700                                            TO PV-DB2-OPERATION   29270000
274800             PERFORM 9200-SQL-ABEND                               29280000
274900     END-EVALUATE.                                                29290000
275000                                                                  29300000
275100***************************************************************** 29310000
275200*  FETCH THE TRANSACTION LEVEL CASH DISCOUNT INFORMATION          29320000
275300***************************************************************** 29330000
275400 4410-FETCH-TLCD-CURSOR.                                          29340000
275500                                                                  29350000
275600     EXEC SQL                                                     29360000
275700         FETCH TLCD-CSR                                           29370000
275800           INTO :EPTLD-TLD-TYP-CDE                                29380000
275900               ,:EPTLD-TLD-AMT                                    29390000
276000               ,:EPTLD-TLD-PCT                                    29400000
276100               ,:EPTLD-TLD-SEQ-NBR                                29410000
276200     END-EXEC.                                                    29420000
276300                                                                  29430000
276400     EVALUATE TRUE                                                29440000
276500         WHEN SQLCODE = ZERO                                      29450000
276600             CONTINUE                                             29460000
276700         WHEN SQLCODE = +100                                      29470000
276800             SET PS-END-OF-TLCD-CURSOR                            29480000
276900                                   TO TRUE                        29490000
277000         WHEN SQLWARN0 NOT EQUAL SPACE                            29500000
277100         WHEN SQLCODE NOT EQUAL ZERO                              29510000
277200             MOVE '4410-FETCH-TLCD-CURSOR'                        29520000
277300                                            TO PV-PARAGRAPH-NAME  29530000
277400             MOVE 'ERROR ON FETCHING TLCD CURSOR '                29540000
277500                                            TO PV-DB2-OPERATION   29550000
277600             PERFORM 9200-SQL-ABEND                               29560000
277700     END-EVALUATE.                                                29570000
277800                                                                  29580000
277900***************************************************************** 29590000
278000*  PROCESS AN OCCURANCE OF A TRANSACTION LEVEL CASH DISCOUNT      29600000
278100***************************************************************** 29610000
278200 4420-PROCESS-TLCD-CURSOR.                                        29620000
278300                                                                  29630000
278400     ADD +1                        TO TH-LINE-NUMBER.             29640000
278500     SET PS-TLCD-LINE-ITEM         TO TRUE.                       29650000
278600     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      29660000
278700                                                                  29670000
278800     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR.       29680000
278900     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         29690000
279000     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      29700000
279100     MOVE PV-STRT-TM              TO AR001-START-TIME.            29710000
279200     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      29720000
279300                                                                  29730000
279400     EVALUATE EPTLD-TLD-TYP-CDE                                   29740000
279500         WHEN 'D'                                                 29750000
279600             MOVE PS110-SN-TLCD-SKU-DOLLAR                        29760000
279700                                   TO PV-SKU-NBR                  29770000
279800                                      PV-DEPT-CL-SKU              29780000
279900         WHEN 'P'                                                 29790000
280000             MOVE PS110-SN-TLCD-SKU-PERCENT                       29800000
280100                                   TO PV-SKU-NBR                  29810000
280200                                      PV-DEPT-CL-SKU              29820000
280300         WHEN 'S'                                                 29830000
280400             MOVE PS110-SN-SENIOR-DISC-SKU                        29840000
280500                                   TO PV-SKU-NBR                  29850000
280600                                      PV-DEPT-CL-SKU              29860000
280610         WHEN 'K'                                                 29870000
280620             MOVE PS110-SN-TLCD-SKU-DOLLAR                        29880000
280630                                   TO PV-SKU-NBR                  29890000
280640                                      PV-DEPT-CL-SKU              29900000
280700     END-EVALUATE.                                                29910000
280800                                                                  29920000
280900     MOVE EPTLD-TLD-AMT            TO PV-NET-CHRGD-AMT.           29930000
281000     MOVE 'N'                      TO PV-TAX-IND.                 29940000
281100                                                                  29950000
281200     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          29960000
281300                                                                  29970000
281400                                                                  29980000
281500***************************************************************** 29990000
281600*  CLOSE THE TRANSACTION LEVEL CASH DISCOUNT CURSOR               30000000
281700***************************************************************** 30010000
281800 4430-CLOSE-TLCD-CURSOR.                                          30020000
281900                                                                  30030000
282000     EXEC SQL                                                     30040000
282100         CLOSE TLCD-CSR                                           30050000
282200     END-EXEC.                                                    30060000
282300                                                                  30070000
282400     EVALUATE TRUE                                                30080000
282500         WHEN SQLCODE = ZERO                                      30090000
282600             CONTINUE                                             30100000
282700         WHEN SQLWARN0 NOT EQUAL SPACE                            30110000
282800         WHEN SQLCODE NOT EQUAL ZERO                              30120000
282900             MOVE '4430-CLOSE-TLCD-CURSOR'                        30130000
283000                                            TO PV-PARAGRAPH-NAME  30140000
283100             MOVE 'ERROR ON CLOSING TLCD CURSOR '                 30150000
283200                                            TO PV-DB2-OPERATION   30160000
283300             PERFORM 9200-SQL-ABEND                               30170000
283400     END-EVALUATE.                                                30180000
283500                                                                  30190000
283600***************************************************************** 30200000
283700*  DETERMINE IF THERE IS AN EMPLOYEE DISCOUNT FOR GIFT RECEIPTED  30210000
283800*  ITEM.  ADJUST CUST-CHRGD-AMT FOR THE DISCOUNT.                 30220000
283900***************************************************************** 30230000
284000 4440-CHECK-FOR-EID.                                              30240000
284100                                                                  30250000
284200     EXEC SQL                                                     30260000
284300         SELECT EMP_DISC_AMT                                      30270000
284400               ,EMP_DISC_CTG_CDE                                  30280000
284500               ,EMP_DISC_SRC_CDE                                  30290000
284600           INTO :EPEID-EMP-DISC-AMT                               30300000
284700               ,:EPEID-EMP-DISC-CTG-CDE                           30310000
284800               ,:EPEID-EMP-DISC-SRC-CDE                           30320000
284900           FROM TEPEID                                            30330000
285000         WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR             30340000
285100           AND  STR_NBR            = :EPTRN-STR-NBR               30350000
285200           AND  RGST_ID            = :EPTRN-RGST-ID               30360000
285300           AND  TRN_NBR            = :EPTRN-TRN-NBR               30370000
285400           AND  STRT_TM            = :EPTRN-STRT-TM               30380000
285500           AND  SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      30390000
285600           AND  LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR       30400000
285700         WITH UR                                                  30410000
285800     END-EXEC.                                                    30420000
285900                                                                  30430000
286000     EVALUATE SQLCODE                                             30440000
286100         WHEN ZERO                                                30450000
286200         WHEN +100                                                30460000
286300             CONTINUE                                             30470000
286400         WHEN OTHER                                               30480000
286500             MOVE '4440-CHECK-FOR-EID'                            30490000
286600                                            TO PV-PARAGRAPH-NAME  30500000
286700             MOVE 'ERROR SELECTING FROM TEPEID   '                30510000
286800                                            TO PV-DB2-OPERATION   30520000
286900             PERFORM 9200-SQL-ABEND                               30530000
287000     END-EVALUATE.                                                30540000
287100                                                                  30550000
287200                                                                  30560000
287300***************************************************************** 30570000
287400*  OPEN THE SPECIAL SERVICE FEES CURSOR                           30580000
287500***************************************************************** 30590000
287600 4450-OPEN-SSFEES-CURSOR.                                         30600000
287700                                                                  30610000
287800     EXEC SQL                                                     30620000
287900         OPEN SSFEES-CSR                                          30630000
288000     END-EXEC.                                                    30640000
288100                                                                  30650000
288200     EVALUATE TRUE                                                30660000
288300         WHEN SQLCODE = ZERO                                      30670000
288400             CONTINUE                                             30680000
288500         WHEN SQLWARN0 NOT EQUAL SPACE                            30690000
288600         WHEN SQLCODE NOT EQUAL ZERO                              30700000
288700             MOVE '4450-OPEN-SSFEES-CURSOR'                       30710000
288800                                            TO PV-PARAGRAPH-NAME  30720000
288900             MOVE 'ERROR ON OPENING SSFEES CURSOR '               30730000
289000                                            TO PV-DB2-OPERATION   30740000
289100             PERFORM 9200-SQL-ABEND                               30750000
289200     END-EVALUATE.                                                30760000
289300                                                                  30770000
289400***************************************************************** 30780000
289500*  FETCH THE SPECIAL SERVICE FEE INFORMATION                      30790000
289600***************************************************************** 30800000
289700 4460-FETCH-SSFEES-CURSOR.                                        30810000
289800                                                                  30820000
289900     MOVE ZERO TO PS-NULL-IND4.                                   30830000
290000     MOVE SPACES TO EPLIS-FEE-DESC-TEXT.                          30840000
290100                                                                  30850000
290200     EXEC SQL                                                     30860000
290300         FETCH SSFEES-CSR                                         30870000
290400           INTO :EPLIS-LNE-ITM-SEQ-NBR                            30880000
290500               ,:EPLIS-SRVC-SEQ-NBR                               30890000
290600               ,:EPLIS-SRVC-TYP-CDE                               30900000
290700               ,:EPLIS-SRVC-AMT                                   30910000
290800               ,:EPLIS-TX-RT-PCT                                  30920000
290900               ,:EPLIS-TX-AMT                                     30930000
291000               ,:EPITM-RCPT-TX-TOT-CDE                            30940000
291100               ,:EPLIS-FEE-DESC:PS-NULL-IND4                      30950000
291200     END-EXEC.                                                    30960000
291300                                                                  30970000
291400     EVALUATE TRUE                                                30980000
291500         WHEN SQLCODE = ZERO                                      30990000
291600             CONTINUE                                             31000000
291700         WHEN SQLCODE = +100                                      31010000
291800             SET PS-END-OF-SSFEES-CURSOR                          31020000
291900                                   TO TRUE                        31030000
292000         WHEN SQLWARN0 NOT EQUAL SPACE                            31040000
292100         WHEN SQLCODE NOT EQUAL ZERO                              31050000
292200             MOVE '4460-FETCH-SSFEES-CURSOR'                      31060000
292300                                            TO PV-PARAGRAPH-NAME  31070000
292400             MOVE 'ERROR ON FETCHING SSFEES CURSOR '              31080000
292500                                            TO PV-DB2-OPERATION   31090000
292600             PERFORM 9200-SQL-ABEND                               31100000
292700     END-EVALUATE.                                                31110000
292800                                                                  31120000
292900***************************************************************** 31130000
293000*  PROCESS AN OCCURANCE OF A SPECIAL SERVICE FEE                  31140000
293100***************************************************************** 31150000
293200 4470-PROCESS-SSFEES-CURSOR.                                      31160000
293300                                                                  31170000
293400     ADD +1                        TO TH-LINE-NUMBER.             31180000
293500     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      31190000
293600                                                                  31200000
293700     MOVE EPLIS-LNE-ITM-SEQ-NBR   TO AR001-LNE-ITM-SEQ-NBR        31210000
293800                                     EPITM-LNE-ITM-SEQ-NBR.       31220000
293900     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         31230000
294000     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      31240000
294100     MOVE PV-STRT-TM              TO AR001-START-TIME.            31250000
294200     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      31260000
294300                                                                  31270000
294400     MOVE EPLIS-SRVC-AMT          TO PV-NET-CHRGD-AMT.            31280000
294500     MOVE EPLIS-TX-RT-PCT         TO PV-TX-RT-PCT.                31290000
294600     MOVE ZERO                    TO PV-TAX-THRESH-AMOUNT         31300000
294700                                     PV-TAX-RATE-BELOW-THRESH.    31310000
294800     MOVE EPLIS-SRVC-TYP-CDE      TO PV-SRVC-TYP-CDE.             31320000
294900     MOVE EPLIS-TX-AMT            TO PV-TX-AMT.                   31330000
295000     MOVE EPITM-RCPT-TX-TOT-CDE   TO AR001-RCPT-TX-TOT-CDE.       31340000
295100                                                                  31350000
295200     IF EPLIS-TX-AMT = ZERO                                       31360000
295300        MOVE 'N' TO PV-TAX-IND                                    31370000
295400     ELSE                                                         31380000
295500        MOVE SPACE TO PV-TAX-IND                                  31390000
295600     END-IF.                                                      31400000
295700                                                                  31410000
295800     IF EPLIS-SRVC-TYP-CDE     = 'F'                              31420000
295900        MOVE EPLIS-FEE-DESC-TEXT TO AR001-FEE-DESC                31430000
296000        MOVE ZEROES         TO PV-UPC                             31440000
296010        MOVE SPACES         TO PV-SUB-CL-NBR                      31450000
296020        MOVE SPACES         TO PV-SKU-NBR                         31460000
296030        MOVE 'FEE'          TO PV-DEPT-NBR                        31470000
296031     ELSE                                                         31480000
296032        PERFORM 7400-READ-DEPT-CLASS-TABLE                        31490000
296033     END-IF.                                                      31500000
296034                                                                  31510000
296037     IF TH-RETURN-TRANSACTION                                     31520000
296038         PERFORM 7600-GET-ORIG-TRANS-INFO                         31530000
296039         IF PS-NON-RECEIPTED-RETURN                               31540000
296040             CONTINUE                                             31550000
296050         ELSE                                                     31560000
296060             PERFORM 4322-GET-OPERATING-TRN-DTE                   31570000
296070             IF PS-ECOMMERCE-STORE                                31580000
296080                 PERFORM 5500-GET-SSFEE-RETURN-INFO               31590000
296090             END-IF                                               31600000
296100         END-IF                                                   31610000
296200     ELSE                                                         31620000
296300         IF PS-ECOMMERCE-STORE                                    31630000
296400             MOVE EPITM-LNE-ITM-SEQ-NBR TO PV-LNE-ITM-SEQ-NBR     31640000
296500             PERFORM 7750-GET-GEO-INFO                            31650000
296600         END-IF                                                   31660000
296700     END-IF.                                                      31670000
296800                                                                  31680000
296900     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          31690000
297000                                                                  31700000
297100***************************************************************** 31710000
297200*  CLOSE THE SPECIAL SERVICES FEES CURSOR                         31720000
297300***************************************************************** 31730000
297400 4480-CLOSE-SSFEES-CURSOR.                                        31740000
297500                                                                  31750000
297600     EXEC SQL                                                     31760000
297700         CLOSE SSFEES-CSR                                         31770000
297800     END-EXEC.                                                    31780000
297900                                                                  31790000
298000     EVALUATE TRUE                                                31800000
298100         WHEN SQLCODE = ZERO                                      31810000
298200             CONTINUE                                             31820000
298300         WHEN SQLWARN0 NOT EQUAL SPACE                            31830000
298400         WHEN SQLCODE NOT EQUAL ZERO                              31840000
298500             MOVE '4480-CLOSE-SSFEES-CURSOR'                      31850000
298600                                            TO PV-PARAGRAPH-NAME  31860000
298700             MOVE 'ERROR ON CLOSING SSFEES CURSOR '               31870000
298800                                            TO PV-DB2-OPERATION   31880000
298900             PERFORM 9200-SQL-ABEND                               31890000
299000     END-EVALUATE.                                                31900000
299100                                                                  31910000
299200                                                                  31920000
299300***************************************************************** 31930000
299400*  OPEN THE SHIPPING CHARGES CURSOR                               31940000
299500***************************************************************** 31950000
299600 4481-OPEN-SHIPE-CURSOR.                                          31960000
299700                                                                  31970000
299800     EXEC SQL                                                     31980000
299900         OPEN SHIPE-CSR                                           31990000
300000     END-EXEC.                                                    32000000
300100                                                                  32010000
300200     EVALUATE TRUE                                                32020000
300300         WHEN SQLCODE = ZERO                                      32030000
300400             CONTINUE                                             32040000
300500         WHEN SQLWARN0 NOT EQUAL SPACE                            32050000
300600         WHEN SQLCODE NOT EQUAL ZERO                              32060000
300700             MOVE '4481-OPEN-SHIPE-CURSOR'                        32070000
300800                                            TO PV-PARAGRAPH-NAME  32080000
300900             MOVE 'ERROR ON OPENING SHIP CURSOR '                 32090000
301000                                            TO PV-DB2-OPERATION   32100000
301100             PERFORM 9200-SQL-ABEND                               32110000
301200     END-EVALUATE.                                                32120000
301300                                                                  32130000
301400***************************************************************** 32140000
301500*  FETCH THE SHIPPING CHARGES INFORMATION                         32150000
301600***************************************************************** 32160000
301700 4482-FETCH-SHIPE-CURSOR.                                         32170000
301800                                                                  32180000
301900     EXEC SQL                                                     32190000
302000         FETCH SHIPE-CSR                                          32200000
302100          INTO :EPSHP-PLND-SHIPT-NBR                              32210000
302200              ,:EPSHP-SHIP-TYP-CDE                                32220000
302300              ,:EPSHP-SHIP-CHRG-AMT                               32230000
302400              ,:EPSHP-ZIP-5-CDE                                   32240000
302500              ,:EPSHP-TX-RT-PCT                                   32250000
302600              ,:EPSHP-TX-AMT                                      32260000
302700              ,:EPSHP-TX-GEOG-CDE                                 32270000
302800     END-EXEC.                                                    32280000
302900                                                                  32290000
303000     EVALUATE TRUE                                                32300000
303100         WHEN SQLCODE = ZERO                                      32310000
303200             CONTINUE                                             32320000
303300         WHEN SQLCODE = +100                                      32330000
303400             SET PS-END-OF-SHIP-CURSOR                            32340000
303500                                   TO TRUE                        32350000
303600         WHEN SQLWARN0 NOT EQUAL SPACE                            32360000
303700         WHEN SQLCODE NOT EQUAL ZERO                              32370000
303800             MOVE '4482-FETCH-SHIPE-CURSOR'                       32380000
303900                                            TO PV-PARAGRAPH-NAME  32390000
304000             MOVE 'ERROR ON FETCHING SHIP CURSOR '                32400000
304100                                            TO PV-DB2-OPERATION   32410000
304200             PERFORM 9200-SQL-ABEND                               32420000
304300     END-EVALUATE.                                                32430000
304400                                                                  32440000
304500***************************************************************** 32450000
304600*  PROCESS AN OCCURANCE OF A SHIPPING CHARGE FEE                  32460000
304700***************************************************************** 32470000
304800 4483-PROCESS-SHIPE-CURSOR.                                       32480000
304900                                                                  32490000
305000     SET PS-SHIP-LINE-ITEM         TO TRUE                        32500000
305100     ADD +1                        TO TH-LINE-NUMBER.             32510000
305200     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      32520000
305300                                                                  32530000
305400     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR        32540000
305500     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         32550000
305600     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      32560000
305700     MOVE PV-STRT-TM              TO AR001-START-TIME.            32570000
305800     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      32580000
305900                                                                  32590000
306000     MOVE EPSHP-SHIP-CHRG-AMT     TO PV-NET-CHRGD-AMT.            32600000
306100     MOVE EPSHP-TX-RT-PCT         TO PV-TX-RT-PCT.                32610000
306200     MOVE ZERO                    TO PV-TAX-THRESH-AMOUNT         32620000
306300                                     PV-TAX-RATE-BELOW-THRESH.    32630000
306400     MOVE 'S'                     TO PV-SRVC-TYP-CDE.             32640000
306500     IF EPSHP-ZIP-5-CDE > SPACES                                  32650000
306600         MOVE EPSHP-ZIP-5-CDE     TO PV-ZIP-CODE-ENCRYPT          32660000
306700         PERFORM 8100-PROCESS-ZIPCODE                             32670000
306800     END-IF.                                                      32680000
306900     IF EPSHP-TX-GEOG-CDE > SPACES                                32690000
307000         MOVE EPSHP-TX-GEOG-CDE   TO PV-SHIP-GEO-CODE             32700000
307100     END-IF.                                                      32710000
307200     MOVE EPSHP-TX-AMT TO PV-TX-AMT.                              32720000
307300                                                                  32730000
307400     IF EPSHP-TX-AMT = ZERO                                       32740000
307500        MOVE 'N' TO PV-TAX-IND                                    32750000
307600     ELSE                                                         32760000
307700        MOVE SPACE TO PV-TAX-IND                                  32770000
307800     END-IF.                                                      32780000
307900                                                                  32790000
308000     IF EPSHP-SHIP-CHRG-AMT = 0                                   32800000
308100         CONTINUE                                                 32810000
308200     ELSE                                                         32820000
308300         PERFORM 7400-READ-DEPT-CLASS-TABLE                       32830000
308400         PERFORM 4700-PROCESS-OUTPUT-RECORD                       32840000
308500     END-IF.                                                      32850000
308600                                                                  32860000
308700***************************************************************** 32870000
308800*  CLOSE THE SHIPPING CHARGES CURSOR                              32880000
308900***************************************************************** 32890000
309000 4484-CLOSE-SHIPE-CURSOR.                                         32900000
309100                                                                  32910000
309200     EXEC SQL                                                     32920000
309300         CLOSE SHIPE-CSR                                          32930000
309400     END-EXEC.                                                    32940000
309500                                                                  32950000
309600     EVALUATE TRUE                                                32960000
309700         WHEN SQLCODE = ZERO                                      32970000
309800             CONTINUE                                             32980000
309900         WHEN SQLWARN0 NOT EQUAL SPACE                            32990000
310000         WHEN SQLCODE NOT EQUAL ZERO                              33000000
310100             MOVE '4484-CLOSE-SHIPE-CURSOR'                       33010000
310200                                            TO PV-PARAGRAPH-NAME  33020000
310300             MOVE 'ERROR ON CLOSING SHIPE CURSOR '                33030000
310400                                            TO PV-DB2-OPERATION   33040000
310500             PERFORM 9200-SQL-ABEND                               33050000
310600     END-EVALUATE.                                                33060000
310700                                                                  33070000
310800                                                                  33080000
310900***************************************************************** 33090000
311000*  OPEN THE SHIPPING CHARGES CURSOR                               33100000
311100***************************************************************** 33110000
311200 4485-OPEN-SHIP-CURSOR.                                           33120000
311300                                                                  33130000
311400     EXEC SQL                                                     33140000
311500         OPEN SHIP-CSR                                            33150000
311600     END-EXEC.                                                    33160000
311700                                                                  33170000
311800     EVALUATE TRUE                                                33180000
311900         WHEN SQLCODE = ZERO                                      33190000
312000             CONTINUE                                             33200000
312100         WHEN SQLWARN0 NOT EQUAL SPACE                            33210000
312200         WHEN SQLCODE NOT EQUAL ZERO                              33220000
312300             MOVE '4485-OPEN-SHIP-CURSOR'                         33230000
312400                                            TO PV-PARAGRAPH-NAME  33240000
312500             MOVE 'ERROR ON OPENING SHIP CURSOR '                 33250000
312600                                            TO PV-DB2-OPERATION   33260000
312700             PERFORM 9200-SQL-ABEND                               33270000
312800     END-EVALUATE.                                                33280000
312900                                                                  33290000
313000***************************************************************** 33300000
313100*  FETCH THE SHIPPING CHARGES INFORMATION                         33310000
313200***************************************************************** 33320000
313300 4490-FETCH-SHIP-CURSOR.                                          33330000
313400                                                                  33340000
313500     EXEC SQL                                                     33350000
313600         FETCH SHIP-CSR                                           33360000
313700          INTO :EPSHP-PLND-SHIPT-NBR                              33370000
313800              ,:EPSHP-SHIP-TYP-CDE                                33380000
313900              ,:EPSHP-SHIP-CHRG-AMT                               33390000
314000              ,:EPSHP-ZIP-5-CDE                                   33400000
314100              ,:EPSHP-TX-RT-PCT                                   33410000
314200              ,:EPSHP-TX-AMT                                      33420000
314300              ,:EPSHP-TX-GEOG-CDE                                 33430000
314400     END-EXEC.                                                    33440000
314500                                                                  33450000
314600     EVALUATE TRUE                                                33460000
314700         WHEN SQLCODE = ZERO                                      33470000
314800             CONTINUE                                             33480000
314900         WHEN SQLCODE = +100                                      33490000
315000             SET PS-END-OF-SHIP-CURSOR                            33500000
315100                                   TO TRUE                        33510000
315200         WHEN SQLWARN0 NOT EQUAL SPACE                            33520000
315300         WHEN SQLCODE NOT EQUAL ZERO                              33530000
315400             MOVE '4490-FETCH-SHIP-CURSOR'                        33540000
315500                                            TO PV-PARAGRAPH-NAME  33550000
315600             MOVE 'ERROR ON FETCHING SHIP CURSOR '                33560000
315700                                            TO PV-DB2-OPERATION   33570000
315800             PERFORM 9200-SQL-ABEND                               33580000
315900     END-EVALUATE.                                                33590000
316000                                                                  33600000
316100***************************************************************** 33610000
316200*  PROCESS AN OCCURANCE OF A SHIPPING CHARGE FEE                  33620000
316300***************************************************************** 33630000
316400 4495-PROCESS-SHIP-CURSOR.                                        33640000
316500                                                                  33650000
316600     SET PS-SHIP-LINE-ITEM         TO TRUE                        33660000
316700     ADD +1                        TO TH-LINE-NUMBER.             33670000
316800     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      33680000
316900                                                                  33690000
317000     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR        33700000
317100     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         33710000
317200     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      33720000
317300     MOVE PV-STRT-TM              TO AR001-START-TIME.            33730000
317400     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      33740000
317500                                                                  33750000
317600     MOVE EPSHP-SHIP-CHRG-AMT     TO PV-NET-CHRGD-AMT.            33760000
317700     MOVE EPSHP-TX-RT-PCT         TO PV-TX-RT-PCT.                33770000
317800     MOVE ZERO                    TO PV-TAX-THRESH-AMOUNT         33780000
317900                                     PV-TAX-RATE-BELOW-THRESH.    33790000
318000     MOVE 'S'                     TO PV-SRVC-TYP-CDE.             33800000
318100     IF EPSHP-ZIP-5-CDE > SPACES                                  33810000
318200         MOVE EPSHP-ZIP-5-CDE     TO PV-ZIP-CODE-ENCRYPT          33820000
318300         PERFORM 8100-PROCESS-ZIPCODE                             33830000
318400     END-IF.                                                      33840000
318500     IF EPSHP-TX-GEOG-CDE > SPACES                                33850000
318600         MOVE EPSHP-TX-GEOG-CDE   TO PV-SHIP-GEO-CODE             33860000
318700     END-IF.                                                      33870000
318800     MOVE EPSHP-TX-AMT TO PV-TX-AMT.                              33880000
318900                                                                  33890000
319000     IF EPSHP-TX-AMT = ZERO                                       33900000
319100        MOVE 'N' TO PV-TAX-IND                                    33910000
319200     ELSE                                                         33920000
319300        MOVE SPACE TO PV-TAX-IND                                  33930000
319400     END-IF.                                                      33940000
319500                                                                  33950000
319600     IF EPSHP-SHIP-CHRG-AMT = 0                                   33960000
319700         CONTINUE                                                 33970000
319800     ELSE                                                         33980000
319900         PERFORM 7400-READ-DEPT-CLASS-TABLE                       33990000
320000         PERFORM 4700-PROCESS-OUTPUT-RECORD                       34000000
320100     END-IF.                                                      34010000
320200                                                                  34020000
320300***************************************************************** 34030000
320400*  CLOSE THE SHIPPING CHARGES CURSOR                              34040000
320500***************************************************************** 34050000
320600 4496-CLOSE-SHIP-CURSOR.                                          34060000
320700                                                                  34070000
320800     EXEC SQL                                                     34080000
320900         CLOSE SHIP-CSR                                           34090000
321000     END-EXEC.                                                    34100000
321100                                                                  34110000
321200     EVALUATE TRUE                                                34120000
321300         WHEN SQLCODE = ZERO                                      34130000
321400             CONTINUE                                             34140000
321500         WHEN SQLWARN0 NOT EQUAL SPACE                            34150000
321600         WHEN SQLCODE NOT EQUAL ZERO                              34160000
321700             MOVE '4496-CLOSE-SHIP-CURSOR'                        34170000
321800                                            TO PV-PARAGRAPH-NAME  34180000
321900             MOVE 'ERROR ON CLOSING SHIP CURSOR '                 34190000
322000                                            TO PV-DB2-OPERATION   34200000
322100             PERFORM 9200-SQL-ABEND                               34210000
322200     END-EVALUATE.                                                34220000
322300                                                                  34230000
322400                                                                  34240000
322500***************************************************************** 34250000
322600*  PROCESS A SALES TAX ITEM                                       34260000
322700***************************************************************** 34270000
322800 4500-PROCESS-SALES-TAX.                                          34280000
322900                                                                  34290000
323000     SET PS-TAX-LINE-ITEM          TO TRUE.                       34300000
323100     ADD +1                        TO TH-LINE-NUMBER.             34310000
323200     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      34320000
323300                                                                  34330000
323400     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR.       34340000
323500     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         34350000
323600     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      34360000
323700     MOVE PV-STRT-TM              TO AR001-START-TIME.            34370000
323800     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      34380000
323900                                                                  34390000
324000     MOVE EPTRN-SLS-TX-AMT         TO PV-NET-CHRGD-AMT.           34400000
324100     MOVE 'TAX'                    TO PV-DEPT-NBR.                34410000
324200     MOVE SPACES                   TO PV-SUB-CL-NBR               34420000
324300                                      PV-SKU-NBR.                 34430000
324400     MOVE 'N'                      TO PV-TAX-IND.                 34440000
324500                                                                  34450000
324600     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          34460000
324700                                                                  34470000
324800***************************************************************** 34480000
324900*  PROCESS THE TENDERS THAT ARE NOT KOHL'S CHARGE                 34490000
325000***************************************************************** 34500000
325100 4600-PROCESS-SPLIT-TENDER.                                       34510000
325200                                                                  34520000
325300     MOVE SPACE                    TO PS-END-OF-TENDER-CURSOR-SW. 34530000
325400     PERFORM 4610-OPEN-TENDER-CURSOR.                             34540000
325500     PERFORM 4620-FETCH-TENDER-CURSOR.                            34550000
325600     PERFORM UNTIL PS-END-OF-TENDER-CURSOR                        34560000
325700         PERFORM 4630-PROCESS-TENDER-CURSOR                       34570000
325800         PERFORM 4620-FETCH-TENDER-CURSOR                         34580000
325900     END-PERFORM.                                                 34590000
326000     PERFORM 4640-CLOSE-TENDER-CURSOR.                            34600000
326100                                                                  34610000
326200****************************************************************  34620000
326300* OPEN THE TENDER CURSOR                                          34630000
326400****************************************************************  34640000
326500 4610-OPEN-TENDER-CURSOR.                                         34650000
326600                                                                  34660000
326700     EXEC SQL                                                     34670000
326800         OPEN TENDER-CSR                                          34680000
326900     END-EXEC.                                                    34690000
327000                                                                  34700000
327100     EVALUATE TRUE                                                34710000
327200         WHEN SQLCODE = ZERO                                      34720000
327300             CONTINUE                                             34730000
327400         WHEN SQLWARN0 NOT EQUAL SPACE                            34740000
327500         WHEN SQLCODE NOT EQUAL ZERO                              34750000
327600             MOVE '4610-OPEN-TENDER-CURSOR'                       34760000
327700                                            TO PV-PARAGRAPH-NAME  34770000
327800             MOVE 'ERROR ON OPENING TENDER CURSOR '               34780000
327900                                            TO PV-DB2-OPERATION   34790000
328000             PERFORM 9200-SQL-ABEND                               34800000
328100     END-EVALUATE.                                                34810000
328200                                                                  34820000
328300****************************************************************  34830000
328400*  FETCH A TENDER ITEM                                            34840000
328500****************************************************************  34850000
328600 4620-FETCH-TENDER-CURSOR.                                        34860000
328700                                                                  34870000
328800     EXEC SQL                                                     34880000
328900         FETCH TENDER-CSR                                         34890000
329000         INTO  :PV-TNDR-TYP-CDE                                   34900000
329100              ,:PV-TNDR-ID                                        34910000
329200              ,:PV-TNDR-AMT                                       34920000
329300              ,:PV-TNDR-ID-LEN-NBR                                34930000
329400     END-EXEC.                                                    34940000
329500                                                                  34950000
329600     EVALUATE TRUE                                                34960000
329700         WHEN SQLCODE = ZERO                                      34970000
329800             CONTINUE                                             34980000
329900         WHEN SQLCODE = +100                                      34990000
330000             SET PS-END-OF-TENDER-CURSOR                          35000000
330100                                   TO TRUE                        35010000
330200         WHEN SQLWARN0 NOT EQUAL SPACE                            35020000
330300         WHEN SQLCODE NOT EQUAL ZERO                              35030000
330400             MOVE '4620-FETCH-TENDER-CURSOR'                      35040000
330500                                            TO PV-PARAGRAPH-NAME  35050000
330600             MOVE 'ERROR ON FETCHING TENDER CURSOR '              35060000
330700                                            TO PV-DB2-OPERATION   35070000
330800             PERFORM 9200-SQL-ABEND                               35080000
330900     END-EVALUATE.                                                35090000
331000                                                                  35100000
331100***************************************************************** 35110000
331200*  PROCESS THE TENDER ITEM                                        35120000
331300***************************************************************** 35130000
331400 4630-PROCESS-TENDER-CURSOR.                                      35140000
331500                                                                  35150000
331600     ADD +1                        TO TH-LINE-NUMBER.             35160000
331700     SET PS-TENDER-LINE-ITEM                                      35170000
331800         PS-TENDER-IS-NOT-GIFT-CARD                               35180000
331900                                   TO TRUE.                       35190000
332000     INITIALIZE AR001-AR-TRANSACTION-RECORD.                      35200000
332100                                                                  35210000
332200     MOVE PV-LINE-ITEM-NBR        TO AR001-LNE-ITM-SEQ-NBR.       35220000
332300     MOVE PV-GIFT-RECPT-CDE       TO AR001-GIFT-RCPT-CDE.         35230000
332400     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      35240000
332500     MOVE PV-STRT-TM              TO AR001-START-TIME.            35250000
332600     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      35260000
332700***  TENDER TYPE CODE IS ONLY REQUIRED ON SPLIT TENDER RECORDS.   35270000
332800***  IT SHOULD BE SPACES ON ALL OTHER RECORDS.  ARKUT090          35280000
332900***  INDENTIFIES SPLIT TENDERS BASED ON THE EXISTANCE OF A TENDER 35290000
333000***  TYPE CODE.                                                   35300000
333100     MOVE PV-TNDR-TYP-CDE         TO AR001-TNDR-TYP-CDE.          35310000
333200                                                                  35320000
333300*** TENDER AMOUNTS NEED TO BE MULTIPLIED BY NEGATIVE SO AS        35330000
333400*** TO MAKE THE DIFFERENCE BETWEEN THE KOHLS CHARGE AMOUNT        35340000
333500*** AND THE TRANSACTION TOTAL AMOUNT.                             35350000
333600                                                                  35360000
333700     COMPUTE PV-TNDR-AMT           = PV-TNDR-AMT                  35370000
333800                                   * -1.                          35380000
333900     MOVE PV-TNDR-AMT              TO PV-NET-CHRGD-AMT.           35390000
334000     MOVE 'TND'                    TO PV-DEPT-NBR.                35400000
334100     MOVE SPACES                   TO PV-SKU-NBR                  35410000
334200                                      PV-SUB-CL-NBR.              35420000
334300                                                                  35430000
334400     IF PV-TNDR-TYP-CDE            = '13'                         35440000
334500       AND PV-TNDR-ID-LEN-NBR      > 5                            35450000
334600         SET PS-TENDER-IS-GIFT-CARD                               35460000
334700                                   TO TRUE                        35470000
334800     END-IF.                                                      35480000
334900                                                                  35490000
335000     MOVE 'N'                      TO PV-TAX-IND.                 35500000
335100                                                                  35510000
335200     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          35520000
335300                                                                  35530000
335400****************************************************************  35540000
335500* CLOSE THE TENDER CURSOR                                         35550000
335600****************************************************************  35560000
335700 4640-CLOSE-TENDER-CURSOR.                                        35570000
335800                                                                  35580000
335900     EXEC SQL                                                     35590000
336000         CLOSE TENDER-CSR                                         35600000
336100     END-EXEC.                                                    35610000
336200                                                                  35620000
336300     EVALUATE TRUE                                                35630000
336400         WHEN SQLCODE = ZERO                                      35640000
336500             CONTINUE                                             35650000
336600         WHEN SQLWARN0 NOT EQUAL SPACE                            35660000
336700         WHEN SQLCODE NOT EQUAL ZERO                              35670000
336800             MOVE '4640-CLOSE-TENDER-CURSOR'                      35680000
336900                                            TO PV-PARAGRAPH-NAME  35690000
337000             MOVE 'ERROR ON CLOSING TENDER CURSOR '               35700000
337100                                            TO PV-DB2-OPERATION   35710000
337200             PERFORM 9200-SQL-ABEND                               35720000
337300     END-EVALUATE.                                                35730000
337400                                                                  35740000
337500******************************************************************35750000
337600*  PROCESS THE OUTPUT RECORD                                      35760000
337700******************************************************************35770000
337800 4700-PROCESS-OUTPUT-RECORD.                                      35780000
337900                                                                  35790000
338000     IF EPTRN-SLS-CORR-SEQ-NBR     > 0                            35800000
338100         SET AR001-MAINTENANCE-TRANSACTION                        35810000
338200                                   TO TRUE                        35820000
338300     ELSE                                                         35830000
338400         SET AR001-POS-TRANSACTION                                35840000
338500                                   TO TRUE                        35850000
338600     END-IF.                                                      35860000
338700                                                                  35870000
338800     MOVE PV-EMPLOYEE-CDE          TO AR001-CRS-EMPLOYEE-CODE.    35880000
338900     MOVE PV-ASSOC-ID              TO AR001-ASSOC-ID              35890000
339000                                                                  35900000
339100     IF PS-ASSOC-CASH                                             35910000
339200         MOVE 'Y'                 TO AR001-ASSOC-CASH             35920000
339300     END-IF.                                                      35930000
339400                                                                  35940000
339500     MOVE TH-TRANSACTION-CODE      TO AR001-TRANSACTION-CODE.     35950000
339600     MOVE PV-POS-YY                TO AR001-TRANSACTION-YEAR.     35960000
339700     MOVE PV-POS-MM                TO AR001-TRANSACTION-MONTH.    35970000
339800     MOVE PV-POS-DD                TO AR001-TRANSACTION-DAY.      35980000
339900     MOVE PV-STR-NBR-9             TO AR001-STORE-NUMBER          35990000
340000                                      AR001-ORG-STR-NBR.          36000000
340100     MOVE PV-RGST-ID-9             TO AR001-TERMINAL-NUMBER.      36010000
340200     MOVE PV-TRN-NBR-9             TO AR001-TRANSACTION-NUMBER.   36020000
340300     MOVE TH-LINE-NUMBER           TO AR001-LINE-NUMBER.          36030000
340400     MOVE EPTRN-TRN-STAT-CDE       TO AR001-TRN-STAT-CDE.         36040000
340500     MOVE EPTRN-ASSOC-ID           TO AR001-REG-OPERATOR-ID.      36050000
340600     MOVE EPTRN-STRT-TM (1:2)      TO PV-TIME-HH.                 36060000
340700     MOVE EPTRN-STRT-TM (4:2)      TO PV-TIME-MM.                 36070000
340800     MOVE PV-ORD-DTE               TO AR001-ORD-DTE.              36080000
340900     MOVE PV-TIME-HHMM             TO AR001-TRANSACTION-TIME.     36090000
341000     MOVE PV-TX-RT-PCT             TO AR001-TAX-RATE-PCT.         36100000
341100     MOVE PV-TX-AMT                TO AR001-TAX-AMOUNT.           36110000
341200     MOVE PV-TAX-THRESH-AMOUNT     TO AR001-TAX-THRESH-AMOUNT.    36120000
341300     MOVE PV-TAX-RATE-BELOW-THRESH                                36130000
341400                               TO AR001-TAX-RATE-BELOW-THRESH.    36140000
341500     MOVE PV-TAX-IND               TO  AR001-TAXABLE-IND.         36150000
341600                                                                  36160000
341700     MOVE PV-SHIP-ZIP-CODE         TO AR001-SHIP-ADDR-ZIP.        36170000
341800     MOVE PV-SHIP-GEO-CODE         TO AR001-SHIP-GEO-CODE.        36180000
341900     MOVE EPTRN-POS-CPBL-LVL-NBR   TO AR001-POS-CPBL-LVL-NBR.     36190000
342000     MOVE EPTND-TNDR-SEQ-NBR       TO AR001-TNDR-SEQ-NBR.         36200000
342100                                                                  36210000
342200     INITIALIZE PV-TAX-INFO.                                      36220000
342300                                                                  36230000
342400     IF PS-ECOMMERCE-STORE                                        36240000
342500         MOVE EPORD-ORD-NBR-TEXT   TO AR001-ORD-NBR               36250000
342600         MOVE EPCRR-AUTH-REF-NBR-TEXT                             36260000
342700                                   TO AR001-AUTH-REF-NBR          36270000
342800     ELSE                                                         36280000
342900         MOVE SPACES               TO AR001-ORD-NBR               36290000
343000         MOVE SPACES               TO AR001-AUTH-REF-NBR          36300000
343100     END-IF.                                                      36310000
343200                                                                  36320000
343300     MOVE EPTRT-TRN-GP-CDE         TO AR001-TRN-GP-CDE.           36330000
343400                                                                  36340000
343500*** THE AUTH INFORMATION FOR BOTH PAYMENTS AND SALES/RETURNS      36350000
343600*** ARE BEING PUT INTO THE EPCRD VARIABLES. THIS ALLOWS           36360000
343700*** THE INFORMATION TO RETURNED VIA CURSOR AND SAVE ON THE        36370000
343800*** NUMBER OF SELECTS                                             36380000
343810     IF AR001-ORD-NBR NOT EQUAL SPACE                             36390000
343820                                AND EPCRD-AUTH-NBR = '000000'     36400000
343830        PERFORM 4705-UPDATE-AUTH                                  36410000
343831        IF PS-AUTH-NBR                                            36420000
343833           MOVE EPCRD-AUTH-NBR TO AR001-AUTH-NUMBER               36430000
343834        ELSE                                                      36440000
343836           MOVE ZERO           TO AR001-AUTH-NUMBER               36450000
343837        END-IF                                                    36460000
343840     ELSE                                                         36470000
344000        MOVE EPCRD-AUTH-NBR    TO AR001-AUTH-NUMBER               36480000
344100     END-IF.                                                      36490000
344200     MOVE EPCRD-AUTH-APVL-CDE (2:1)                               36500000
344300                                   TO AR001-REFERRAL-TYPE.        36510000
344400                                                                  36520000
344500     IF PS-PAYMENT-LINE-ITEM                                      36530000
344600       MOVE SPACES               TO AR001-BIN-NUMBER              36540000
040723       MOVE EPPAY-KC-ACCT-NBR(1:12) TO AR001-ACCOUNT-NUMBER       36550000
344800       MOVE 'Y'                  TO AR001-PAYMENT-IND             36560000
344900     ELSE                                                         36570000
345000       IF EPTND-TNDR-ID-LEN-NBR = 18                              36580000
345100          MOVE EPTND-TNDR-ID (1:6)  TO AR001-BIN-NUMBER           36590000
345200          MOVE EPTND-TNDR-ID (7:12) TO AR001-ACCOUNT-NUMBER       36600000
345300       ELSE                                                       36610000
345400          MOVE SPACES              TO AR001-BIN-NUMBER            36620000
345500          MOVE EPTND-TNDR-ID(1:12) TO AR001-ACCOUNT-NUMBER        36630000
345600       END-IF                                                     36640000
345700     END-IF.                                                      36650000
345800                                                                  36660000
345900     IF PS-ITEM-LINE-ITEM                                         36670000
346000         MOVE EPITM-DEPT-NBR       TO PV-DEPT-NBR                 36680000
346100         MOVE EPITM-SUB-CL-NBR     TO PV-SUB-CL-NBR               36690000
346200         MOVE EPITM-SKU-NBR        TO PV-SKU-NBR                  36700000
346300                                                                  36710000
346400         IF TH-ADJUSTMENT-TRANSACTION                             36720000
346500           OR TH-RETURN-TRANSACTION                               36730000
346600             COMPUTE PV-NET-CHRGD-AMT =                           36740000
346700                     PV-NET-CHRGD-AMT * -1                        36750000
346800             END-COMPUTE                                          36760000
346900             COMPUTE PV-CUST-CHRGD-AMT =                          36770000
347000                     PV-CUST-CHRGD-AMT * -1                       36780000
347100             END-COMPUTE                                          36790000
347200             COMPUTE PV-EMPL-DISC-TRN-AMT =                       36800000
347300                     PV-EMPL-DISC-TRN-AMT * -1                    36810000
347400             END-COMPUTE                                          36820000
347500             COMPUTE PV-SBJCT-TO-TX-AMT =                         36830000
347600                     PV-SBJCT-TO-TX-AMT * -1                      36840000
347610             END-COMPUTE                                          36850000
347620         END-IF                                                   36860000
347630         MOVE PV-SBJCT-TO-TX-AMT   TO AR001-SBJCT-TO-TX-AMT       36870000
347640         MOVE PV-NET-CHRGD-AMT     TO AR001-NET-CHARGED-AMOUNT    36880000
347650         MOVE PV-EMPL-DISC-TRN-AMT TO AR001-EMPL-DISC-TRN-AMT     36890000
347700         MOVE PV-CUST-CHRGD-AMT    TO AR001-TRANSACTION-AMOUNT    36900000
347900     END-IF.                                                      36910000
348000                                                                  36920000
348100     MOVE PV-DEPT-NBR          TO AR001-ITEM-DEPARTMENT.          36930000
348200     MOVE PV-SUB-CL-NBR        TO AR001-ITEM-CLASS.               36940000
348300     MOVE PV-SKU-NBR           TO AR001-SKU-NBR.                  36950000
348400                                                                  36960000
348500     EVALUATE TRUE                                                36970000
348600         WHEN PS-ITEM-LINE-ITEM                                   36980000
348700             MOVE EPITM-SLD-QTY    TO AR001-UNITS-SOLD            36990000
348800             MOVE PV-UPC           TO AR001-MERCHANDISE-ID        37000000
348900                                                                  37010000
349000         WHEN PS-WRAP-LINE-ITEM                                   37020000
349100             MOVE +1               TO AR001-UNITS-SOLD            37030000
349200             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37040000
349300                 COMPUTE PV-NET-CHRGD-AMT =                       37050000
349400                         PV-NET-CHRGD-AMT * -1                    37060000
349500                 END-COMPUTE                                      37070000
349600             END-IF                                               37080000
349700             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37090000
349800                                      AR001-NET-CHARGED-AMOUNT    37100000
349900             MOVE PV-UPC           TO AR001-MERCHANDISE-ID        37110000
350000                                                                  37120000
350100         WHEN PS-FEE-LINE-ITEM                                    37130000
350200             MOVE ZERO             TO AR001-UNITS-SOLD            37140000
350300             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37150000
350301                 COMPUTE PV-NET-CHRGD-AMT =                       37160000
350302                         PV-NET-CHRGD-AMT * -1                    37170000
350303                 END-COMPUTE                                      37180000
350304             END-IF                                               37190000
350305             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37200000
350306                                      AR001-NET-CHARGED-AMOUNT    37210000
350307             MOVE SPACES           TO AR001-MERCHANDISE-ID        37220000
350308                                      AR001-ITEM-CLASS            37230000
350309                                                                  37240000
350310         WHEN PS-SHIP-LINE-ITEM                                   37250000
350320             MOVE ZERO             TO AR001-UNITS-SOLD            37260000
350330             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37270000
350340                 COMPUTE PV-NET-CHRGD-AMT =                       37280000
350350                         PV-NET-CHRGD-AMT * -1                    37290000
350360                 END-COMPUTE                                      37300000
350370             END-IF                                               37310000
350380             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37320000
350390                                      AR001-NET-CHARGED-AMOUNT    37330000
350400             MOVE PV-UPC           TO AR001-MERCHANDISE-ID        37340000
350500                                                                  37350000
350600         WHEN PS-TAX-LINE-ITEM                                    37360000
350700             MOVE ZERO             TO AR001-UNITS-SOLD            37370000
350800             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37380000
350900                 COMPUTE PV-NET-CHRGD-AMT =                       37390000
351000                         PV-NET-CHRGD-AMT * -1                    37400000
351100                 END-COMPUTE                                      37410000
351200             END-IF                                               37420000
351300             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37430000
351400                                      AR001-NET-CHARGED-AMOUNT    37440000
351500             MOVE ZERO             TO AR001-EMPL-DISC-TRN-AMT     37450000
351600                                                                  37460000
351700         WHEN PS-TENDER-LINE-ITEM                                 37470000
351800             MOVE 1                TO AR001-UNITS-SOLD            37480000
351900             IF PS-TENDER-IS-GIFT-CARD                            37490000
352000                 MOVE PV-TNDR-ID (1:13)                           37500000
352100                                   TO AR001-MERCHANDISE-ID        37510000
352200             ELSE                                                 37520000
352300                 MOVE PV-SKU-NBR                                  37530000
352400                                   TO AR001-MERCHANDISE-ID        37540000
352500             END-IF                                               37550000
352600                                                                  37560000
352700             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37570000
352800                 COMPUTE PV-NET-CHRGD-AMT =                       37580000
352900                         PV-NET-CHRGD-AMT * -1                    37590000
353000                 END-COMPUTE                                      37600000
353100             END-IF                                               37610000
353200             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37620000
353300                                      AR001-NET-CHARGED-AMOUNT    37630000
353400                                                                  37640000
353500         WHEN PS-TLCD-LINE-ITEM                                   37650000
353600             MOVE ZERO             TO AR001-UNITS-SOLD            37660000
353700             MOVE PV-SKU-NBR       TO AR001-MERCHANDISE-ID        37670000
353800             MOVE EPTLD-TLD-PCT    TO AR001-TLD-PCT               37680000
353900             MOVE EPTLD-TLD-TYP-CDE                               37690000
354000                                   TO AR001-TLD-TYPE              37700000
354100             IF TH-ADJUSTMENT-TRANSACTION OR TH-RETURN-TRANSACTION37710000
354200                 COMPUTE PV-NET-CHRGD-AMT =                       37720000
354300                         PV-NET-CHRGD-AMT * -1                    37730000
354400                 END-COMPUTE                                      37740000
354500             END-IF                                               37750000
354600             MOVE PV-NET-CHRGD-AMT TO AR001-TRANSACTION-AMOUNT    37760000
354700                                      AR001-NET-CHARGED-AMOUNT    37770000
354800     END-EVALUATE.                                                37780000
354900                                                                  37790000
355000*** GIFT CARDS WILL BE GROUPED INTO THE GIFT CERTIFICATE          37800000
355100*** DEPARTMENT.                                                   37810000
355200                                                                  37820000
355300     IF PS-ITEM-LINE-ITEM                                         37830000
355400         IF EPITM-DEPT-NBR         = PC-GIFT-CARD-DEPT            37840000
050222         OR EPITM-DEPT-NBR         = PC-SPHRA-GIFT-CARD-DEPT      37841000
355500            MOVE PC-GIFT-CERT-DEPT TO AR001-ITEM-DEPARTMENT       37850000
355600         END-IF                                                   37860000
355700     END-IF.                                                      37870000
355800                                                                  37880000
355900     IF AR001-MAINTENANCE-TRANSACTION                             37890000
356000         MOVE PC-MAINT-USERID      TO AR001-SUBMITTED-BY-USERID   37900000
356100     ELSE                                                         37910000
356200         MOVE PC-POS-USERID        TO AR001-SUBMITTED-BY-USERID   37920000
356300     END-IF.                                                      37930000
356400                                                                  37940000
356500     IF PS-PAYMENT-LINE-ITEM                                      37950000
356600         MOVE PV-NET-CHRGD-AMT     TO AR001-TRANSACTION-AMOUNT    37960000
356700                                      AR001-NET-CHARGED-AMOUNT    37970000
356800     END-IF.                                                      37980000
356900                                                                  37990000
357000     IF PS-ITEM-LINE-ITEM                                         38000000
357100         PERFORM 4710-CHECK-FOR-TIER-MARKDOWN                     38010000
357200     END-IF.                                                      38020000
357300                                                                  38030000
357400     IF EPTND-TNDR-ID-SRC-CDE      = PC-KEYED-SRC-CDE             38040000
357500         SET AR001-KEYED-CARD      TO TRUE                        38050000
357600     ELSE                                                         38060000
357700         SET AR001-SCANNED-CARD    TO TRUE                        38070000
357800     END-IF.                                                      38080000
357900                                                                  38090000
358000***** REVERSE ALL AMOUNTS IF THE TRANSACTION IS WAS A LATE VOIDED 38100000
358100***** TRANSACTION.                                                38110000
358200                                                                  38120000
358300     IF EPTRN-VOID-ABRT-CDE = 'V'                                 38130000
358400         SET AR001-LATE-VOID-TRANSACTION TO TRUE                  38140000
358500         COMPUTE AR001-NET-CHARGED-AMOUNT =                       38150000
358600                 AR001-NET-CHARGED-AMOUNT * -1                    38160000
358700         END-COMPUTE                                              38170000
358800         COMPUTE AR001-TRANSACTION-AMOUNT =                       38180000
358900                 AR001-TRANSACTION-AMOUNT * -1                    38190000
359000         END-COMPUTE                                              38200000
359100         COMPUTE AR001-TAX-AMOUNT =                               38210000
359200                 AR001-TAX-AMOUNT * -1                            38220000
359300         END-COMPUTE                                              38230000
359400         COMPUTE AR001-RET-AMT =                                  38240000
359500                 AR001-RET-AMT * -1                               38250000
359600         END-COMPUTE                                              38260000
359700         COMPUTE AR001-EMPL-DISC-TRN-AMT =                        38270000
359800                 AR001-EMPL-DISC-TRN-AMT * -1                     38280000
359900         END-COMPUTE                                              38290000
360000         COMPUTE AR001-EMP-DISC-AMT =                             38300000
360100                 AR001-EMP-DISC-AMT * -1                          38310000
360200         END-COMPUTE                                              38320000
360300     END-IF.                                                      38330000
360400                                                                  38340000
360500     MOVE EPTRN-TRN-DTE TO PV-TRN-CCYY-MM-DD.                     38350000
360600     MOVE PV-TRN-MM     TO AR001-TRN-DTE(1:2).                    38360000
360700     MOVE PV-TRN-DD     TO AR001-TRN-DTE(3:2).                    38370000
360800     MOVE PV-TRN-YY     TO AR001-TRN-DTE(5:2).                    38380000
360900*                                                                 38390000
361000     MOVE PV-OMNI-CHNL-FFLMT-TYP-CDE                              38400000
361100                        TO AR001-OMNI-CHL-FLMT-IND.               38410000
SHIP2      MOVE PV-MULT-CLR-SEQ-NBR TO AR001-MULT-CLR-SEQ-NBR.          38420000
SHIP2      MOVE PV-TOT-SHP-NBR      TO AR001-TOT-SHP-NBR.               38430000
SHIP2      MOVE SPACES              TO AR001-PAR-SHP-IND.               38440000
                                                                        38450000
SHIP  * SET A SWITCH TO INDICATE OMNI TYPE ORDERS                       38460000
SHIP       IF PV-OMNI-CHNL-FFLMT-TYP-CDE = SPACES OR                    38470000
SHIP          PV-OMNI-CHNL-FFLMT-TYP-CDE = 'SFS' OR                     38480000
SHIP          PV-OMNI-CHNL-FFLMT-TYP-CDE = 'SDD'                        38490000
SHIP             SET PV-SHIP-TO-HOME TO TRUE                            38500000
SHIP       ELSE                                                         38510000
SHIP             SET PV-OMNI-BPS-BOS TO TRUE                            38520000
SHIP       END-IF.                                                      38530000
SHIP       MOVE PV-FULFILLMENT-TYPE    TO AR001-FULFILLMENT-TYPE.       38540000
361200                                                                  38550000
361300     PERFORM 8000-WRITE-AR-RECORD.                                38560000
361400                                                                  38570000
361500                                                                  38580000
361510***************************************************************** 38590000
361520*  CHECK AND UPDATE THE AUTH_NBR                                  38600000
361530***************************************************************** 38610000
361540 4705-UPDATE-AUTH.                                                38620000
361550                                                                  38630000
361560     EXEC SQL                                                     38640000
361570         SELECT   MAX(AUTH_NBR)                                   38650000
361580                  INTO :EPCRD-AUTH-NBR                            38660000
361590            FROM TEPORD ORD,TEPCRD CRD,TEPTND TND                 38670000
361600          WHERE  ORD.PARTN_NBR = CRD.PARTN_NBR                    38680000
361610            AND  ORD.TRN_NBR   = CRD.TRN_NBR                      38690000
361611            AND  ORD.RGST_ID   = CRD.RGST_ID                      38700000
361612            AND  ORD.STR_NBR   = CRD.STR_NBR                      38710000
361613            AND  ORD.STRT_TM   = CRD.STRT_TM                      38720000
361614            AND  ORD.SLS_CORR_SEQ_NBR   = CRD.SLS_CORR_SEQ_NBR    38730000
361615            AND  ORD.ORD_NBR   = :AR001-ORD-NBR                   38740000
361616            AND  CRD.AUTH_NBR  <> '000000'                        38750000
361617            AND  ORD.PARTN_NBR = TND.PARTN_NBR                    38760000
361618            AND  ORD.TRN_NBR   = TND.TRN_NBR                      38770000
361619            AND  ORD.RGST_ID   = TND.RGST_ID                      38780000
361620            AND  ORD.STR_NBR   = TND.STR_NBR                      38790000
361621            AND  ORD.STRT_TM   = TND.STRT_TM                      38800000
361622            AND  ORD.SLS_CORR_SEQ_NBR   = TND.SLS_CORR_SEQ_NBR    38810000
361623            AND  CRD.TNDR_SEQ_NBR  = TND.TNDR_SEQ_NBR             38820000
361624            AND  TND.TNDR_TYP_CDE ='04'                           38830000
361625         WITH UR                                                  38840000
361626     END-EXEC.                                                    38850000
361627                                                                  38860000
361628     EVALUATE SQLCODE                                             38870000
361629         WHEN ZERO                                                38880000
361630         SET PS-AUTH-NBR TO TRUE                                  38890000
361631         WHEN OTHER                                               38900000
361632         SET PS-NOT-AUTH-NBR TO TRUE                              38910000
361633     END-EVALUATE.                                                38920000
361634                                                                  38930000
361640***************************************************************** 38940000
361700*  DETERMINE IF THERE IS A TIER MARKDOWN ON THE ITEM              38950000
361800***************************************************************** 38960000
361900 4710-CHECK-FOR-TIER-MARKDOWN.                                    38970000
362000                                                                  38980000
362100     MOVE ZERO TO EPLID-LID-AMT.                                  38990000
362200                                                                  39000000
362300     EXEC SQL                                                     39010000
362400         SELECT 'Y'                                               39020000
362500           INTO :PV-BOGO-ACTIVE                                   39030000
362600           FROM TEPLID                                            39040000
362700         WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR             39050000
362800           AND  STR_NBR            = :EPTRN-STR-NBR               39060000
362900           AND  RGST_ID            = :EPTRN-RGST-ID               39070000
363000           AND  TRN_NBR            = :EPTRN-TRN-NBR               39080000
363100           AND  STRT_TM            = :EPTRN-STRT-TM               39090000
363200           AND  SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      39100000
363300           AND  LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR       39110000
363400           AND  LID_TYP_CDE       IN ('T','I')                    39120000
363500         WITH UR                                                  39130000
363600     END-EXEC.                                                    39140000
363700                                                                  39150000
363800     EVALUATE SQLCODE                                             39160000
363900         WHEN ZERO                                                39170000
364000         WHEN -811                                                39180000
364100             SET AR001-TIER-MKDN   TO TRUE                        39190000
364200         WHEN +100                                                39200000
364300             CONTINUE                                             39210000
364400         WHEN OTHER                                               39220000
364500             MOVE '4710-CHECK-FOR-TIER-MARKDOWN'                  39230000
364600                                            TO PV-PARAGRAPH-NAME  39240000
364700             MOVE 'ERROR ON GETTING TIER INFO '                   39250000
364800                                            TO PV-DB2-OPERATION   39260000
364900             PERFORM 9200-SQL-ABEND                               39270000
365000     END-EVALUATE.                                                39280000
365100                                                                  39290000
365200***************************************************************** 39300000
365300*  APPLY ALL LINE ITEM DISCOUNTS IN TEPLID TO THE ITEM.         * 39310000
365400*                                                               * 39320000
365500*  EBOGO PRORATED MARKDOWNS AND EBOGO RECEIPT MARKDOWNS ARE     * 39330000
365600*  HANDLED AS SPECIAL CASES.                                    * 39340000
365700*                                                               * 39350000
365800*  OPEN A CURSOR THAT PROCESSES ALL LINE ITEM DISCOUNTS FOR THE * 39360000
365900*  CURRENT LINE.  CUSTOMER CHARGED AMOUNT AND NET CHARGED       * 39370000
366000*  AMOUNT ARE CALCULATED BY APPLYING CERTAIN DISCOUNTS TO THE   * 39380000
366100*  CUSTOMER CHARGED AMOUNT.                                     * 39390000
366200*                                                               * 39400000
366300*  IF THE ITEM IS THE PURCHASED ITEM IN AN EBOGO PAIR THE       * 39410000
366400*  TRANSACTION LEVEL DISCOUNTS PRORATED TO THE FREE ITEM MUST   * 39420000
366500*  BE APPLIED TO THE PURCHASED ITEM TO CALCULATE NET CHARGED    * 39430000
366600*  AMOUNT.                                                      * 39440000
366700*                                                               * 39450000
366800*  THIS PARAGRAPH WAS ADDED FOR THE EBOGO PROJECT.              * 39460000
366900***************************************************************** 39470000
367000 4800-APPLY-LINE-ITEM-DISCOUNTS.                                  39480000
367100                                                                  39490000
367200     SET PS-EBOGO-ITEM-NO                                         39500000
367300         PS-EBOGO-GETONE-ITEM-NO                                  39510000
367400         PS-NOT-END-OF-TEPLID-CSR TO TRUE.                        39520000
367500                                                                  39530000
367600     PERFORM 4850-GET-EBOGO-PRORATED-MKDWN.                       39540000
367700                                                                  39550000
367800     IF PS-EBOGO-ITEM-YES                                         39560000
367900         PERFORM 4860-GET-EBOGO-RECEIPT-MKDWN                     39570000
368000     END-IF.                                                      39580000
368100                                                                  39590000
368200***** IF THE ITEM IS THE FREE ITEM IN THE EBOGO PAIR, APPLY THE   39600000
368300***** RECEIPT MARKDOWN AMOUNT TO THE CUSTOMER CHARGED AMOUNT.     39610000
368400                                                                  39620000
368500     IF PS-EBOGO-GETONE-ITEM-YES                                  39630000
368600         COMPUTE PV-CUST-CHRGD-AMT =                              39640000
368700                 PV-CUST-CHRGD-AMT + EPLID-LID-AMT                39650000
368800         END-COMPUTE                                              39660000
368900     END-IF.                                                      39670000
369000                                                                  39680000
369100     PERFORM 4810-OPEN-TEPLID-CSR.                                39690000
369200                                                                  39700000
369300     PERFORM 4820-FETCH-TEPLID-CSR.                               39710000
369400                                                                  39720000
369500     PERFORM UNTIL PS-END-OF-TEPLID-CSR                           39730000
369600         PERFORM 4830-PROCESS-TEPLID-CSR                          39740000
369700         PERFORM 4820-FETCH-TEPLID-CSR                            39750000
369800     END-PERFORM.                                                 39760000
369900                                                                  39770000
370000     PERFORM 4840-CLOSE-TEPLID-CSR.                               39780000
370100                                                                  39790000
370200***************************************************************** 39800000
370300*  OPEN THE TEPLID-CSR FOR THE CURRENT LINE ITEM.               * 39810000
370400***************************************************************** 39820000
370500 4810-OPEN-TEPLID-CSR.                                            39830000
370600                                                                  39840000
370700     EXEC SQL                                                     39850000
370800         OPEN TEPLID-CSR                                          39860000
370900     END-EXEC.                                                    39870000
371000                                                                  39880000
371100     EVALUATE SQLCODE                                             39890000
371200         WHEN ZERO                                                39900000
371300             CONTINUE                                             39910000
371400         WHEN OTHER                                               39920000
371500             MOVE '4810-OPEN-TEPLID-CSR'                          39930000
371600                                            TO PV-PARAGRAPH-NAME  39940000
371700             MOVE 'ERROR OPENING TEPLID CURSOR '                  39950000
371800                                            TO PV-DB2-OPERATION   39960000
371900             PERFORM 9200-SQL-ABEND                               39970000
372000     END-EVALUATE.                                                39980000
372100                                                                  39990000
372200***************************************************************** 40000000
372300*  FETCH A ROW FROM THE TEPLID CSR                              * 40010000
372400***************************************************************** 40020000
372500 4820-FETCH-TEPLID-CSR.                                           40030000
372600                                                                  40040000
372700     EXEC SQL                                                     40050000
372800         FETCH TEPLID-CSR                                         40060000
372900          INTO :EPLID-LID-TYP-CDE                                 40070000
373000              ,:EPLID-LID-AMT                                     40080000
373100              ,:EPLID-LID-RSN-CDE                                 40090000
373200     END-EXEC.                                                    40100000
373300                                                                  40110000
373400     EVALUATE SQLCODE                                             40120000
373500         WHEN ZERO                                                40130000
373600             CONTINUE                                             40140000
373700         WHEN +100                                                40150000
373800             SET PS-END-OF-TEPLID-CSR TO TRUE                     40160000
373900         WHEN OTHER                                               40170000
374000             MOVE '4820-FETCH-TEPLID-CSR'                         40180000
374100                                            TO PV-PARAGRAPH-NAME  40190000
374200             MOVE 'ERROR FETCHING FROM TEPLID CURSOR '            40200000
374300                                            TO PV-DB2-OPERATION   40210000
374400             PERFORM 9200-SQL-ABEND                               40220000
374500     END-EVALUATE.                                                40230000
374600                                                                  40240000
374700******************************************************************40250000
374800* CALCULATE CUSTOMER CHARGED AMOUNT PASSED TO KOHLS CHARGE BY    *40260000
374900* APPLYING DISCOUNTS FROM TEPLID TO THE CUSTOMER CHARGED AMOUNT. *40270000
375000*                                                                *40280000
375100* FOR RETURNS, THE MARKDOWN CANCEL FOR KOHL'S CASH DEACTIVATION  *40290000
375200* MUST BE ADDED BACK TO THE NET CHARGED AMOUNT SO THAT THE       *40300000
375300* ASSOCIATE DISCOUNT WILL GET APPLIED PROPERLY.  ASSOCIATE       *40310000
375400* DISCOUNT IS APPLIED BEFORE THIS DISCOUNT IS TAKEN.  THIS IS    *40320000
375500* LID TYPE 'R' AND LID REASON CODE '780'.                        *40330000
375600*                                                                *40340000
375700* AR001-TRANSACTION-AMOUNT                                       *40350000
375800* - TRANSACTION AMOUNT IS CALCULATED BY ADDING ALL LINE ITEM     *40360000
375900*   DISCOUNTS.                                                   *40370000
376000*                                                                *40380000
376100* LINE ITEM DISCOUNT TYPES ARE: P, D, C, AND T.                  *40390000
376200*                                                                *40400000
376300* PRORATED TRANSACTION LEVEL DISCOUNT TYPES ARE: S, Q, AND R.    *40410000
376400*                                                                *40420000
376500******************************************************************40430000
376600 4830-PROCESS-TEPLID-CSR.                                         40440000
376700                                                                  40450000
376800     EVALUATE EPLID-LID-TYP-CDE                                   40460000
376900         WHEN 'P'                                                 40470000
377000         WHEN 'D'                                                 40480000
377100         WHEN 'C'                                                 40490000
377200         WHEN 'I'                                                 40500000
377300         WHEN 'J'                                                 40510000
377400         WHEN 'T'                                                 40520000
377500         WHEN 'L'                                                 40530000
377600             COMPUTE PV-CUST-CHRGD-AMT =                          40540000
377700                     PV-CUST-CHRGD-AMT + EPLID-LID-AMT            40550000
377800             END-COMPUTE                                          40560000
377900         WHEN 'R'                                                 40570000
378000             IF EPLID-LID-RSN-CDE = '780'                         40580000
378100                 IF TH-RETURN-TRANSACTION OR                      40590000
378200                    EPITM-SAL-RET-CDE = 'B' OR                    40600000
378300                    EPITM-SAL-RET-CDE = 'R'                       40610000
378400                     COMPUTE PV-EMPL-DISC-TRN-AMT =               40620000
378500                             PV-NET-CHRGD-AMT +                   40630000
378600                             (EPLID-LID-AMT * -1)                 40640000
378700                     END-COMPUTE                                  40650000
378800                 END-IF                                           40660000
378900             END-IF                                               40670000
379000         WHEN OTHER                                               40680000
379100             CONTINUE                                             40690000
379200     END-EVALUATE.                                                40700000
379300                                                                  40710000
379400***************************************************************** 40720000
379500*  CLOSE THE TEPLID CURSOR                                      * 40730000
379600***************************************************************** 40740000
379700 4840-CLOSE-TEPLID-CSR.                                           40750000
379800                                                                  40760000
379900     EXEC SQL                                                     40770000
380000         CLOSE TEPLID-CSR                                         40780000
380100     END-EXEC.                                                    40790000
380200                                                                  40800000
380300     EVALUATE SQLCODE                                             40810000
380400         WHEN ZERO                                                40820000
380500             CONTINUE                                             40830000
380600         WHEN OTHER                                               40840000
380700             MOVE '4840-OPEN-TEPLID-CSR'                          40850000
380800                                            TO PV-PARAGRAPH-NAME  40860000
380900             MOVE 'ERROR CLOSING TEPLID CURSOR '                  40870000
381000                                            TO PV-DB2-OPERATION   40880000
381100             PERFORM 9200-SQL-ABEND                               40890000
381200     END-EVALUATE.                                                40900000
381300                                                                  40910000
381400******************************************************************40920000
381500* IF THERE IS AN E-BOGO PRORATED MARKDOWN AMOUNT ASSOCIATED WITH *40930000
381600* THE ITEM, SET THE SWITCH TO INDICATE THAT THE ITEM IS AN EBOGO *40940000
381700* ITEM.                                                          *40950000
381800******************************************************************40960000
381900 4850-GET-EBOGO-PRORATED-MKDWN.                                   40970000
382000                                                                  40980000
382100     EXEC SQL                                                     40990000
382200         SELECT 'Y'                                               41000000
382300             INTO :PV-BOGO-ACTIVE                                 41010000
382400             FROM TEPLID                                          41020000
382500             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            41030000
382600               AND STR_NBR          = :EPTRN-STR-NBR              41040000
382700               AND RGST_ID          = :EPTRN-RGST-ID              41050000
382800               AND TRN_NBR          = :EPTRN-TRN-NBR              41060000
382900               AND STRT_TM          = :EPTRN-STRT-TM              41070000
383000               AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR     41080000
383100               AND LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR      41090000
383200               AND LID_TYP_CDE      IN ('F', 'H')                 41100000
383300             WITH UR                                              41110000
383400     END-EXEC.                                                    41120000
383500                                                                  41130000
383600     EVALUATE SQLCODE                                             41140000
383700         WHEN +0                                                  41150000
383800         WHEN -811                                                41160000
383900             SET PS-EBOGO-ITEM-YES TO TRUE                        41170000
384000         WHEN +100                                                41180000
384100             CONTINUE                                             41190000
384200         WHEN OTHER                                               41200000
384300             MOVE '4850-GET-EBOGO-PRORATED-MKDWN'                 41210000
384400                                            TO PV-PARAGRAPH-NAME  41220000
384500             MOVE 'ERROR SELECTING FROM TEPLID '                  41230000
384600                                            TO PV-DB2-OPERATION   41240000
384700             PERFORM 9200-SQL-ABEND                               41250000
384800      END-EVALUATE.                                               41260000
384900                                                                  41270000
385000******************************************************************41280000
385100* GET THE RECEIPT MARKDOWN AMOUNT FOR THE ITEM.  IF THERE IS NOT *41290000
385200* A RECEIPT MARKDOWN, THE ITEM IS THE PURCHASED ITEM IN THE PAIR.*41300000
385300* THE PRESENCE OF RECEIPT MARKDOWN INDICATES THE ITEM IS THE     *41310000
385400* FREE ITEM IN THE PAIR.                                         *41320000
385500******************************************************************41330000
385600 4860-GET-EBOGO-RECEIPT-MKDWN.                                    41340000
385700                                                                  41350000
385800     EXEC SQL                                                     41360000
385900         SELECT SUM(LID_AMT)                                      41370000
386000             INTO :EPLID-LID-AMT                                  41380000
386100             FROM TEPLID                                          41390000
386200             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            41400000
386300               AND STR_NBR          = :EPTRN-STR-NBR              41410000
386400               AND RGST_ID          = :EPTRN-RGST-ID              41420000
386500               AND TRN_NBR          = :EPTRN-TRN-NBR              41430000
386600               AND STRT_TM          = :EPTRN-STRT-TM              41440000
386700               AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR     41450000
386800               AND LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR      41460000
386900               AND LID_TYP_CDE      IN ('E', 'G')                 41470000
387000             WITH UR                                              41480000
387100     END-EXEC.                                                    41490000
387200                                                                  41500000
387300     EVALUATE SQLCODE                                             41510000
387400         WHEN +0                                                  41520000
387500             SET PS-EBOGO-GETONE-ITEM-YES TO TRUE                 41530000
387600         WHEN +100                                                41540000
387700             CONTINUE                                             41550000
387800         WHEN -305                                                41560000
387900             CONTINUE                                             41570000
388000         WHEN OTHER                                               41580000
388100             MOVE '4860-GET-EBOGO-RECEIPT-MKDWN'                  41590000
388200                                            TO PV-PARAGRAPH-NAME  41600000
388300             MOVE 'ERROR SELECTING FROM TEPLID '                  41610000
388400                                            TO PV-DB2-OPERATION   41620000
388500             PERFORM 9200-SQL-ABEND                               41630000
388600      END-EVALUATE.                                               41640000
388700                                                                  41650000
388800***************************************************************** 41660000
388900*  PROCESS A KOHLS PAYMENT                                        41670000
389000******************************************************************41680000
389100 5000-PROCESS-PAYMENT.                                            41690000
389200                                                                  41700000
389300     IF EPPAY-PAYT-AMT             > 0                            41710000
389400         SET TH-PAYMENT-TRANSACTION                               41720000
389500                                   TO TRUE                        41730000
389600     ELSE                                                         41740000
389700                                                                  41750000
389800*** A NEGATIVE PAYMENT AMOUNT IS A SALES AUDIT PAYMENT REVERSAL   41760000
389900                                                                  41770000
390000         COMPUTE EPPAY-PAYT-AMT    = EPPAY-PAYT-AMT               41780000
390100                                   * -1                           41790000
390200         SET TH-DEBIT-ADJ-TRANSACTION                             41800000
390300                                   TO TRUE                        41810000
390400     END-IF.                                                      41820000
390500                                                                  41830000
390600     MOVE EPPAY-PAYT-AMT           TO PV-NET-CHRGD-AMT.           41840000
390700     INITIALIZE AR001-AR-TRANSACTION-RECORD                       41850000
390800                PV-SKU-NBR                                        41860000
390900                PV-DEPT-NBR                                       41870000
391000                PV-SUB-CL-NBR.                                    41880000
391100                                                                  41890000
391200     MOVE ZERO                    TO AR001-LNE-ITM-SEQ-NBR.       41900000
391300     MOVE SPACES                  TO AR001-GIFT-RCPT-CDE.         41910000
391400     MOVE PV-PARTN-NBR            TO AR001-PARTITION-NUMBER.      41920000
391500     MOVE PV-STRT-TM              TO AR001-START-TIME.            41930000
391600     MOVE PV-SEQ-NBR              TO AR001-SLS-CORR-SEQ-NBR.      41940000
391700                                                                  41950000
391800     SET PS-PAYMENT-LINE-ITEM      TO TRUE.                       41960000
391900     MOVE 1                        TO TH-LINE-NUMBER.             41970000
392000     MOVE 'N'                      TO PV-TAX-IND.                 41980000
392100     MOVE EPTRN-SLS-DTE            TO PV-ORD-DTE.                 41990000
392200                                                                  42000000
392300     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          42010000
392400                                                                  42020000
392500***************************************************************   42030000
392600*  GET THE ZIP CODE AND GEO CODE FOR THE ORIGINAL TRANSACTION.*   42040000
392700*  SELECT THE FIRST PLANNED SHIPMENT THAT HAS THE SAME TAX    *   42050000
392800*  RATE AS FOUND ON THE CREDITED ITEM.  IF THERE IS NO        *   42060000
392900*  MATCHING TAX RATE, USE THE ZIP CODE AND GEO CODE ON THE    *   42070000
393000*  FIRST LINE ITEM.                                           *   42080000
393100*                                                             *   42090000
393200***************************************************************   42100000
393300 5500-GET-SSFEE-RETURN-INFO.                                      42110000
393400                                                                  42120000
393500      SET PS-NOT-END-OF-SHP-RTN-CSR TO TRUE.                      42130000
393600                                                                  42140000
393700      PERFORM 4322-GET-OPERATING-TRN-DTE.                         42150000
393800      PERFORM 5521-OPEN-OPR-SHP-CSR.                              42160000
393900      PERFORM 5522-FETCH-OPR-SHP-CSR.                             42170000
394000      IF PS-NOT-END-OF-SHP-RTN-CSR                                42180000
394100          MOVE PV-ORIG-ZIP-5-CDE TO PV-ZIP-CODE-ENCRYPT           42190000
394200          PERFORM 8100-PROCESS-ZIPCODE                            42200000
394300          MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE              42210000
394400      END-IF.                                                     42220000
394500      PERFORM 5520-PROCESS-OPR-SHP-CSR                            42230000
394600          UNTIL PS-END-OF-SHP-RTN-CSR.                            42240000
394700      PERFORM 5523-CLOSE-OPR-SHP-CSR.                             42250000
394800                                                                  42260000
394900 5520-PROCESS-OPR-SHP-CSR.                                        42270000
395000                                                                  42280000
395100     IF PV-ORIG-TX-RT-PCT = PV-TX-RT-PCT                          42290000
395200         MOVE PV-ORIG-ZIP-5-CDE TO PV-ZIP-CODE-ENCRYPT            42300000
395300         PERFORM 8100-PROCESS-ZIPCODE                             42310000
395400         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               42320000
395500         SET PS-END-OF-SHP-RTN-CSR TO TRUE                        42330000
395600     ELSE                                                         42340000
395700         PERFORM 5522-FETCH-OPR-SHP-CSR                           42350000
395800     END-IF.                                                      42360000
395900                                                                  42370000
396000***************************************************************   42380000
396100*  OPEN TEPSHP  CURSOR.                                       *   42390000
396200***************************************************************   42400000
396300 5521-OPEN-OPR-SHP-CSR.                                           42410000
396400                                                                  42420000
396500     EXEC SQL                                                     42430000
396600         OPEN SHIP-RTN-CSR                                        42440000
396700     END-EXEC.                                                    42450000
396800                                                                  42460000
396900     EVALUATE SQLCODE                                             42470000
397000         WHEN ZERO                                                42480000
397100             CONTINUE                                             42490000
397200         WHEN OTHER                                               42500000
397300             MOVE '5521-OPEN-OPR-SHP-CSR'                         42510000
397400                                            TO PV-PARAGRAPH-NAME  42520000
397500             MOVE 'ERROR OPENING TEPSHP CURSOR '                  42530000
397600                                            TO PV-DB2-OPERATION   42540000
397700             PERFORM 9200-SQL-ABEND                               42550000
397800     END-EVALUATE.                                                42560000
397900                                                                  42570000
398000***************************************************************   42580000
398100*  FETCH TEPSHP  CURSOR.                                      *   42590000
398200***************************************************************   42600000
398300 5522-FETCH-OPR-SHP-CSR.                                          42610000
398400                                                                  42620000
398500     EXEC SQL                                                     42630000
398600         FETCH SHIP-RTN-CSR                                       42640000
398700          INTO :PV-ORIG-ZIP-5-CDE                                 42650000
398800              ,:PV-ORIG-TX-RT-PCT                                 42660000
398900              ,:PV-ORIG-GEOG-CDE                                  42670000
399000     END-EXEC.                                                    42680000
399100                                                                  42690000
399200     EVALUATE SQLCODE                                             42700000
399300         WHEN ZERO                                                42710000
399400             CONTINUE                                             42720000
399500         WHEN +100                                                42730000
399600             SET PS-END-OF-SHP-RTN-CSR TO TRUE                    42740000
399700         WHEN OTHER                                               42750000
399800             MOVE '5522-FETCH-OPR-SHP-CSR'  TO PV-PARAGRAPH-NAME  42760000
399900             MOVE 'ERROR FETCHING TEPSHP CURSOR '                 42770000
400000                                            TO PV-DB2-OPERATION   42780000
400100             PERFORM 9200-SQL-ABEND                               42790000
400200     END-EVALUATE.                                                42800000
400300                                                                  42810000
400400***************************************************************   42820000
400500*  CLOSE TEPSHP  CURSOR.                                      *   42830000
400600***************************************************************   42840000
400700 5523-CLOSE-OPR-SHP-CSR.                                          42850000
400800                                                                  42860000
400900     EXEC SQL                                                     42870000
401000         CLOSE SHIP-RTN-CSR                                       42880000
401100     END-EXEC.                                                    42890000
401200                                                                  42900000
401300     EVALUATE SQLCODE                                             42910000
401400         WHEN ZERO                                                42920000
401500             CONTINUE                                             42930000
401600         WHEN OTHER                                               42940000
401700             MOVE '5523-CLOSE-OPR-SHP-CSR'                        42950000
401800                                            TO PV-PARAGRAPH-NAME  42960000
401900             MOVE 'ERROR CLOSING TEPSHP CURSOR '                  42970000
402000                                            TO PV-DB2-OPERATION   42980000
402100             PERFORM 9200-SQL-ABEND                               42990000
402200     END-EVALUATE.                                                43000000
402300                                                                  43010000
402400******************************************************************43020000
402500*  CHECK TABLE WHEN CHANGE IN STORE NUMBER TO SEE IF ECOMMERCE    43030000
402600*  STORE BEFORE GETTING INFORMATION FROM XST_LOC.                 43040000
402700******************************************************************43050000
402800 6220-READ-ECOMMERCE-TABLE.                                       43060000
402900                                                                  43070000
403000     SET PS-NOT-END-OF-ECOM-TABLE  TO TRUE.                       43080000
403100     PERFORM WITH TEST AFTER                                      43090000
403200             VARYING PV-STORE-SUB FROM 1 BY 1                     43100000
403300         UNTIL PV-STORE-SUB GREATER THAN PC-STORE-MAX             43110000
403400           OR PV-WORK-STR-NBR-TEST = EC-STR-NBR(PV-STORE-SUB)     43120000
403500           IF EC-STR-NBR (PV-STORE-SUB) = ZERO                    43130000
403600               SET PS-END-OF-ECOM-TABLE TO TRUE                   43140000
403700           ELSE                                                   43150000
403800               IF PV-WORK-STR-NBR-TEST = EC-STR-NBR(PV-STORE-SUB) 43160000
403900                   MOVE EC-BUS-LOC-IND(PV-STORE-SUB)              43170000
404000                                       TO PV-BUS-LOC-IND          43180000
404100                   MOVE EC-ZIP-CODE(PV-STORE-SUB)                 43190000
404200                                       TO PV-SHIP-ZIP-CODE        43200000
404300                   MOVE EC-GEO-CODE(PV-STORE-SUB)                 43210000
404400                                       TO PV-SHIP-GEO-CODE        43220000
404500               END-IF                                             43230000
404600           END-IF                                                 43240000
404700     END-PERFORM.                                                 43250000
404800                                                                  43260000
404900     IF PV-STORE-SUB GREATER THAN PC-STORE-MAX                    43270000
405000         SET PS-END-OF-ECOM-TABLE TO TRUE                         43280000
405100     END-IF.                                                      43290000
405200                                                                  43300000
405300******************************************************************43310000
405400*  CHECK TABLE TO GET BUSINESS LOCATION INDICATOR ON RETURN       43320000
405500*  TRANSACTION.                                                   43330000
405600******************************************************************43340000
405700 6221-READ-ECOMMERCE-TABLE.                                       43350000
405800                                                                  43360000
405900     SET PS-NOT-END-OF-ECOM-TABLE  TO TRUE.                       43370000
406000     PERFORM WITH TEST AFTER                                      43380000
406100             VARYING PV-STORE-SUB FROM 1 BY 1                     43390000
406200         UNTIL PV-STORE-SUB GREATER THAN PC-STORE-MAX             43400000
406300            OR PV-WORK-STR-NBR-TEST = EC-STR-NBR(PV-STORE-SUB)    43410000
406400           IF EC-STR-NBR (PV-STORE-SUB) = ZERO                    43420000
406500               SET PS-END-OF-ECOM-TABLE TO TRUE                   43430000
406600           ELSE                                                   43440000
406700               IF PV-WORK-STR-NBR-TEST = EC-STR-NBR (PV-STORE-SUB)43450000
406800                   MOVE EC-BUS-LOC-IND(PV-STORE-SUB)              43460000
406900                                   TO PV-BUS-LOC-IND              43470000
407000               END-IF                                             43480000
407100           END-IF                                                 43490000
407200     END-PERFORM.                                                 43500000
407300                                                                  43510000
407400     IF PV-STORE-SUB GREATER THAN PC-STORE-MAX                    43520000
407500         SET PS-END-OF-ECOM-TABLE TO TRUE                         43530000
407600     END-IF.                                                      43540000
407700                                                                  43550000
407800****************************************************************  43560000
407900*  OPEN THE ECOMMERCE INDICATOR CURSOR                            43570000
408000****************************************************************  43580000
408100 6230-GET-STORE-INFO.                                             43590000
408200                                                                  43600000
408300     EXEC SQL                                                     43610000
408400       SELECT A.ZIP_10_CDE                                        43620000
408500             ,A.E_BUS_IND                                         43630000
408600             ,COALESCE(B.GEO_CDE, '00')                           43640000
408700             ,COALESCE(B.TX_ALT_ZIP_10_CDE, :PC-SPACES)           43650000
408800             ,B.LOC_NBR                                           43660000
408900        INTO :XST00001-ZIP-10-CDE                                 43670000
409000            ,:XST00001-E-BUS-IND                                  43680000
409100            ,:XST00025-GEO-CDE                                    43690000
409200            ,:XST00025-TX-ALT-ZIP-10-CDE                          43700000
409300            ,:XST00025-LOC-NBR                                    43710000
409400       FROM XST_LOC       A                                       43720000
409500          , XST_LOC_ATTR  B                                       43730000
409600       WHERE A.LOC_NBR       = B.LOC_NBR                          43740000
409700         AND A.LOC_NBR       = :PV-WORK-STR-NBR                   43750000
409800       WITH UR                                                    43760000
409900     END-EXEC.                                                    43770000
410000                                                                  43780000
410100     EVALUATE TRUE                                                43790000
410200         WHEN SQLCODE = ZERO                                      43800000
410300             MOVE PV-WORK-STR-NBR  TO PV-WORK-STR-NBR-PACK        43810000
410400             MOVE PV-WORK-STR-NBR-PACK TO PV-WORK-STR-NBR-TEST    43820000
410500             MOVE PV-WORK-STR-NBR-TEST                            43830000
410600                                TO EC-STR-NBR (PV-STORE-SUB2)     43840000
410700             MOVE XST00001-ZIP-10-CDE                             43850000
410800                                   TO EC-ZIP-CODE (PV-STORE-SUB2) 43860000
410900             MOVE XST00001-E-BUS-IND                              43870000
411000                            TO EC-BUS-LOC-IND (PV-STORE-SUB2)     43880000
411100             MOVE XST00025-GEO-CDE TO EC-GEO-CODE (PV-STORE-SUB2) 43890000
411200             IF XST00025-TX-ALT-ZIP-10-CDE = SPACES               43900000
411300                 CONTINUE                                         43910000
411400             ELSE                                                 43920000
411500                 MOVE XST00025-TX-ALT-ZIP-10-CDE                  43930000
411600                                   TO EC-ZIP-CODE (PV-STORE-SUB2) 43940000
411700             END-IF                                               43950000
411800             ADD +1 TO PV-STORE-SUB2                              43960000
411900             IF PV-STORE-SUB2 > PC-STORE-MAX                      43970000
412000                 DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME   43980000
412100                 DISPLAY 'TOO MANY STORES FOR EC TABLE'           43990000
412200                 SET AC-TABLE-OVERFLOW TO TRUE                    44000000
412300                 CALL 'ILBOABN0' USING AC-ABEND-CODE              44010000
412400             END-IF                                               44020000
412500         WHEN SQLCODE = +100                                      44030000
412600             DISPLAY 'STORE NOT FOUND ON XST-LOC-ATTR TABLE'      44040000
412700             DISPLAY 'STORE NUMBER IS ' PV-WORK-STR-NBR           44050000
412800             PERFORM 9200-SQL-ABEND                               44060000
412900         WHEN SQLWARN0 NOT EQUAL SPACE                            44070000
413000         WHEN SQLCODE NOT EQUAL ZERO                              44080000
413100             MOVE '6230-GET-STORE-INFO'                           44090000
413200                                            TO PV-PARAGRAPH-NAME  44100000
413300             MOVE 'ERROR ON GETTING STORE INFO FROM XST_LOC'      44110000
413400                                            TO PV-DB2-OPERATION   44120000
413500             PERFORM 9200-SQL-ABEND                               44130000
413600     END-EVALUATE.                                                44140000
413700                                                                  44150000
413800                                                                  44160000
413900***************************************************************** 44170000
414000*  OPEN THE POS TRANSACTION CURSOR                                44180000
414100***************************************************************** 44190000
414200 7000-OPEN-POS-TRAN-CURSOR.                                       44200000
414300                                                                  44210000
414400     EXEC SQL                                                     44220000
414500         OPEN POS-TRN-CSR                                         44230000
414600     END-EXEC.                                                    44240000
414700                                                                  44250000
414800     EVALUATE TRUE                                                44260000
414900         WHEN SQLCODE = ZERO                                      44270000
415000             CONTINUE                                             44280000
415100         WHEN SQLWARN0 NOT EQUAL SPACE                            44290000
415200         WHEN SQLCODE NOT EQUAL ZERO                              44300000
415300             MOVE '7000-OPEN-POS-TRAN-CURSOR'                     44310000
415400                                            TO PV-PARAGRAPH-NAME  44320000
415500             MOVE 'ERROR ON OPENING POS TRANS CURSOR '            44330000
415600                                            TO PV-DB2-OPERATION   44340000
415700             PERFORM 9200-SQL-ABEND                               44350000
415800     END-EVALUATE.                                                44360000
415900                                                                  44370000
416000******************************************************************44380000
416100*  FETCH THE ORIGINAL POS CURSOR                                 *44390000
416200******************************************************************44400000
416300 7010-FETCH-POS-TRANS-CURSOR.                                     44410000
416400                                                                  44420000
416500     MOVE 0 TO PS-NULL-IND2.                                      44430000
416600     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                44440000
416700                                                                  44450000
416800     EXEC SQL                                                     44460000
416900         FETCH POS-TRN-CSR                                        44470000
417000         INTO  :EPTRN-PARTN-NBR                                   44480000
417100              ,:EPTRN-STR-NBR                                     44490000
417200              ,:EPTRN-RGST-ID                                     44500000
417300              ,:EPTRN-TRN-NBR                                     44510000
417400              ,:EPTRN-SLS-CORR-SEQ-NBR                            44520000
417500              ,:EPTRN-STRT-TM                                     44530000
417600              ,:EPTRN-TRN-STAT-CDE                                44540000
417700              ,:EPTRN-VOID-ABRT-CDE                               44550000
417800              ,:EPTRN-TRN-TYP-CDE                                 44560000
417900              ,:EPTRN-SLS-DTE                                     44570000
418000              ,:EPTRN-TRN-DTE                                     44580000
418100              ,:EPTRN-TRN-TOT-AMT                                 44590000
418200              ,:EPTRN-SLS-TX-AMT                                  44600000
418300              ,:EPTRN-ASSOC-ID                                    44610000
418400              ,:EPTND-TNDR-ID                                     44620000
418500              ,:EPTND-TNDR-AMT                                    44630000
418600              ,:EPTND-TNDR-SEQ-NBR                                44640000
418700              ,:EPCRD-AUTH-APVL-CDE                               44650000
418800              ,:EPCRD-AUTH-NBR                                    44660000
418900              ,:EPPAY-KC-ACCT-NBR                                 44670000
419000              ,:EPPAY-PAYT-AMT                                    44680000
419100              ,:EPTND-TNDR-ID-SRC-CDE                             44690000
419200              ,:EPTRN-POS-CPBL-LVL-NBR                            44700000
419300              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND2       44710000
419400              ,:EPTND-TNDR-ID-LEN-NBR                             44720000
SHIP2               ,:EPTRN-VISA-MULT-CLR-SEQ-NBR                       44730000
SHIP2               ,:EPTRN-VISA-TOT-SHP-NBR                            44740000
419500     END-EXEC.                                                    44750000
419600                                                                  44760000
419700     EVALUATE TRUE                                                44770000
419800         WHEN SQLCODE = ZERO                                      44780000
419900             MOVE EPTRN-PARTN-NBR        TO PV-PARTN-NBR          44790000
420000             MOVE EPTRN-STRT-TM          TO PV-STRT-TM            44800000
420100             MOVE EPTRN-SLS-CORR-SEQ-NBR TO PV-SEQ-NBR            44810000
420200             ADD +1 TO PA-TRANSACTIONS-FETCHED                    44820000
420300         WHEN SQLCODE = +100                                      44830000
420400             SET PS-END-OF-POS-TRAN-CURSOR                        44840000
420500                                   TO TRUE                        44850000
420600             MOVE ZERO             TO PV-PARTN-NBR                44860000
420700             MOVE SPACE            TO PV-STRT-TM                  44870000
420800             MOVE ZERO             TO PV-SEQ-NBR                  44880000
420900         WHEN SQLWARN0 NOT EQUAL SPACE                            44890000
421000         WHEN SQLCODE NOT EQUAL ZERO                              44900000
421100             MOVE '7000-FETCH-POS-TRANS-CURSOR'                   44910000
421200                                            TO PV-PARAGRAPH-NAME  44920000
421300             MOVE 'ERROR ON FETCHING POS TRANS INFO '             44930000
421400                                            TO PV-DB2-OPERATION   44940000
421500             PERFORM 9200-SQL-ABEND                               44950000
421600     END-EVALUATE.                                                44960000
421700                                                                  44970000
421800***************************************************************** 44980000
421900*  CLOSE THE POS TRANSACTION CURSOR                               44990000
422000***************************************************************** 45000000
422100 7020-CLOSE-POS-TRAN-CURSOR.                                      45010000
422200                                                                  45020000
422300     EXEC SQL                                                     45030000
422400         CLOSE POS-TRN-CSR                                        45040000
422500     END-EXEC.                                                    45050000
422600                                                                  45060000
422700     EVALUATE TRUE                                                45070000
422800         WHEN SQLCODE = ZERO                                      45080000
422900             CONTINUE                                             45090000
423000         WHEN SQLWARN0 NOT EQUAL SPACE                            45100000
423100         WHEN SQLCODE NOT EQUAL ZERO                              45110000
423200             MOVE '7020-CLOSE-POS-TRAN-CURSOR'                    45120000
423300                                            TO PV-PARAGRAPH-NAME  45130000
423400             MOVE 'ERROR ON CLOSING POS TRANS CURSOR '            45140000
423500                                            TO PV-DB2-OPERATION   45150000
423600             PERFORM 9200-SQL-ABEND                               45160000
423700     END-EVALUATE.                                                45170000
423800                                                                  45180000
423900***************************************************************** 45190000
424000*  OPEN THE LATE / CORRECTIONS CURSOR                             45200000
424100***************************************************************** 45210000
424200 7100-OPEN-LATE-COR-CURSOR.                                       45220000
424300                                                                  45230000
424400     EXEC SQL                                                     45240000
424500         OPEN LATE-COR-CSR                                        45250000
424600     END-EXEC.                                                    45260000
424700                                                                  45270000
424800     EVALUATE TRUE                                                45280000
424900         WHEN SQLCODE = ZERO                                      45290000
425000             CONTINUE                                             45300000
425100         WHEN SQLWARN0 NOT EQUAL SPACE                            45310000
425200         WHEN SQLCODE NOT EQUAL ZERO                              45320000
425300             MOVE '7100-OPEN-LATE-COR-CURSOR'                     45330000
425400                                            TO PV-PARAGRAPH-NAME  45340000
425500             MOVE 'ERROR ON OPENING LATE COR CURSOR '             45350000
425600                                            TO PV-DB2-OPERATION   45360000
425700             PERFORM 9200-SQL-ABEND                               45370000
425800     END-EVALUATE.                                                45380000
425900                                                                  45390000
426000******************************************************************45400000
426100*  FETCH THE LATE AND SALES CORRECTION CURSOR                     45410000
426200******************************************************************45420000
426300 7110-FETCH-LATE-COR-CURSOR.                                      45430000
426400     MOVE 0 TO PS-NULL-IND2.                                      45440000
426500     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                45450000
426600                                                                  45460000
426700     EXEC SQL                                                     45470000
426800         FETCH LATE-COR-CSR                                       45480000
426900         INTO  :EPTRN-PARTN-NBR                                   45490000
427000              ,:EPTRN-STR-NBR                                     45500000
427100              ,:EPTRN-RGST-ID                                     45510000
427200              ,:EPTRN-TRN-NBR                                     45520000
427300              ,:EPTRN-SLS-CORR-SEQ-NBR                            45530000
427400              ,:EPTRN-STRT-TM                                     45540000
427500              ,:EPTRN-TRN-STAT-CDE                                45550000
427600              ,:EPTRN-VOID-ABRT-CDE                               45560000
427700              ,:EPTRN-TRN-TYP-CDE                                 45570000
427800              ,:EPTRN-SLS-DTE                                     45580000
427900              ,:EPTRN-TRN-DTE                                     45590000
428000              ,:EPTRN-TRN-TOT-AMT                                 45600000
428100              ,:EPTRN-SLS-TX-AMT                                  45610000
428200              ,:EPTRN-ASSOC-ID                                    45620000
428300              ,:EPTND-TNDR-ID                                     45630000
428400              ,:EPTND-TNDR-AMT                                    45640000
428500              ,:EPTND-TNDR-SEQ-NBR                                45650000
428600              ,:EPCRD-AUTH-APVL-CDE                               45660000
428700              ,:EPCRD-AUTH-NBR                                    45670000
428800              ,:EPPAY-KC-ACCT-NBR                                 45680000
428900              ,:EPPAY-PAYT-AMT                                    45690000
429000              ,:EPTND-TNDR-ID-SRC-CDE                             45700000
429100              ,:EPTRN-POS-CPBL-LVL-NBR                            45710000
429200              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND2       45720000
429300              ,:EPTND-TNDR-ID-LEN-NBR                             45730000
SHIP2               ,:EPTRN-VISA-MULT-CLR-SEQ-NBR                       45740000
SHIP2               ,:EPTRN-VISA-TOT-SHP-NBR                            45750000
429400     END-EXEC.                                                    45760000
429500                                                                  45770000
429600     EVALUATE TRUE                                                45780000
429700         WHEN SQLCODE = ZERO                                      45790000
429800             ADD +1 TO PA-LATE-COR-ROWS-FETCHED                   45800000
429900             MOVE EPTRN-PARTN-NBR TO PV-PARTN-NBR                 45810000
430000             MOVE EPTRN-STRT-TM    TO PV-STRT-TM                  45820000
430100             MOVE EPTRN-SLS-CORR-SEQ-NBR                          45830000
430200                                   TO PV-SEQ-NBR                  45840000
430300         WHEN SQLCODE = +100                                      45850000
430400             SET PS-END-OF-LATE-COR-CURSOR                        45860000
430500                                   TO TRUE                        45870000
430600         WHEN SQLWARN0 NOT EQUAL SPACE                            45880000
430700         WHEN SQLCODE NOT EQUAL ZERO                              45890000
430800             MOVE '7110-FETCH-LATE-COR-CURSOR'                    45900000
430900                                            TO PV-PARAGRAPH-NAME  45910000
431000             MOVE 'ERROR ON FETCHING LATE COR CURSOR '            45920000
431100                                            TO PV-DB2-OPERATION   45930000
431200             PERFORM 9200-SQL-ABEND                               45940000
431300     END-EVALUATE.                                                45950000
431400                                                                  45960000
431500***************************************************************** 45970000
431600*  CLOSE THE LATE COR CURSOR                                      45980000
431700***************************************************************** 45990000
431800 7120-CLOSE-LATE-COR-CURSOR.                                      46000000
431900                                                                  46010000
432000     EXEC SQL                                                     46020000
432100         CLOSE LATE-COR-CSR                                       46030000
432200     END-EXEC.                                                    46040000
432300                                                                  46050000
432400     EVALUATE TRUE                                                46060000
432500         WHEN SQLCODE = ZERO                                      46070000
432600             CONTINUE                                             46080000
432700         WHEN SQLWARN0 NOT EQUAL SPACE                            46090000
432800         WHEN SQLCODE NOT EQUAL ZERO                              46100000
432900             MOVE '7120-CLOSE-LATE-COR-CURSOR'                    46110000
433000                                            TO PV-PARAGRAPH-NAME  46120000
433100             MOVE 'ERROR ON CLOSING LATE COR CURSOR '             46130000
433200                                            TO PV-DB2-OPERATION   46140000
433300             PERFORM 9200-SQL-ABEND                               46150000
433400     END-EVALUATE.                                                46160000
433500                                                                  46170000
433600******************************************************************46180000
433700* CHECK TO SEE IF THE ACCOUNT EXISTS ON THE ACTIVE EMPLOYEE TABLE 46190000
433800* FIRST CHECK TO SEE IF THE ACCOUNT EXISTS ON THE ACTIVE EMPLOYEE 46200000
433900* TABLE.  IF NOT FOUND CHECK IF IT IS ON THE NON EMPLOYEE TABLE.  46210000
434000******************************************************************46220000
434100 7300-CHECK-IF-EMPL-ACCT.                                         46230000
434200                                                                  46240000
434300     MOVE ZERO TO PV-EMP-DISC-COUNT.                              46250000
434400     PERFORM 7310-SELECT-FROM-TEPEID.                             46260000
434500                                                                  46270000
434600     IF PV-EMP-DISC-COUNT > ZERO                                  46280000
434700         MOVE '5'             TO PV-EMPLOYEE-CDE                  46290000
434800         MOVE PV-ACCOUNT-NBR  TO ART00001-ACCT-NBR                46300000
434900         MOVE SPACES          TO ART00001-EMP-ID                  46310000
435000         PERFORM 7320-GET-EMPLID-FROM-EMP-DISC                    46320000
435100         MOVE ART00001-EMP-ID TO PV-ASSOC-ID                      46330000
435200     END-IF.                                                      46340000
435300                                                                  46350000
435400******************************************************************46360000
435500* CHECK FOR EMPLOYEE DISCOUNT FOR THIS TRANSACTION ON TEPEID     *46370000
435600******************************************************************46380000
435700 7310-SELECT-FROM-TEPEID.                                         46390000
435800                                                                  46400000
435900     EXEC SQL                                                     46410000
436000         SELECT COUNT(*)                                          46420000
436100           INTO :PV-EMP-DISC-COUNT                                46430000
436200           FROM TEPEID                                            46440000
436300         WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR             46450000
436400           AND  STR_NBR            = :EPTRN-STR-NBR               46460000
436500           AND  RGST_ID            = :EPTRN-RGST-ID               46470000
436600           AND  TRN_NBR            = :EPTRN-TRN-NBR               46480000
436700           AND  STRT_TM            = :EPTRN-STRT-TM               46490000
436800           AND  SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      46500000
436810           AND  EMP_DISC_CTG_CDE   = 'K'                          46510000
436900         WITH UR                                                  46520000
437000     END-EXEC.                                                    46530000
437100                                                                  46540000
437200     EVALUATE SQLCODE                                             46550000
437300         WHEN ZERO                                                46560000
437400         WHEN +100                                                46570000
437500             CONTINUE                                             46580000
437600         WHEN OTHER                                               46590000
437700             MOVE '7310-SELECT-FROM-TEPEID'                       46600000
437800                                            TO PV-PARAGRAPH-NAME  46610000
437900             MOVE 'ERROR SELECTING FROM TEPEID   '                46620000
438000                                            TO PV-DB2-OPERATION   46630000
438100             PERFORM 9200-SQL-ABEND                               46640000
438200     END-EVALUATE.                                                46650000
438300                                                                  46660000
438400******************************************************************46670000
438500* GET EMPLOYEE ID FOR THIS ACCOUNT FROM EMPLOYEE DISCOUNT TABLE  *46680000
438600******************************************************************46690000
438700 7320-GET-EMPLID-FROM-EMP-DISC.                                   46700000
438800     EXEC SQL                                                     46710000
438900         SELECT EMP_ID                                            46720000
439000           INTO :ART00001-EMP-ID                                  46730000
439100           FROM ART_EMP_DISC                                      46740000
439200          WHERE ACCT_NBR = :ART00001-ACCT-NBR                     46750000
439300            AND DISC_STAT_CDE <> 'N'                              46760000
439400          WITH UR                                                 46770000
439500     END-EXEC.                                                    46780000
439600                                                                  46790000
439700     EVALUATE SQLCODE                                             46800000
439800         WHEN ZERO                                                46810000
439900         WHEN +100                                                46820000
440000             CONTINUE                                             46830000
440100         WHEN -811                                                46840000
440200             MOVE SPACES TO ART00001-EMP-ID                       46850000
440300         WHEN OTHER                                               46860000
440400             MOVE '7320-GET-EMPLID-FROM-EMP-DISC'                 46870000
440500                                        TO PV-PARAGRAPH-NAME      46880000
440600             MOVE 'ERROR SELECTING FROM ART_EMP_DISC'             46890000
440700                                        TO PV-DB2-OPERATION       46900000
440800             PERFORM 9200-SQL-ABEND                               46910000
440900     END-EVALUATE.                                                46920000
441000                                                                  46930000
441100******************************************************************46940000
441200*  FOR SHIPPING AND GIFT WRAP - SEARCH THE WORKING STORAGE TABLE  46950000
441300*  FOR THE DEPT SUBCLASS AND SKU SEQUENCE NUMBER.                 46960000
441400******************************************************************46970000
441500 7400-READ-DEPT-CLASS-TABLE.                                      46980000
441600                                                                  46990000
441700     SET AR012-INDX                TO 1.                          47000000
441800     SEARCH AR012-SPECIAL-SERVICE-TABLE VARYING AR012-INDX        47010000
441900         AT END PERFORM 9150-DEPT-CLASS-ERROR                     47020000
442000       WHEN PV-SRVC-TYP-CDE = AR012-SRVC-TYP-CDE (AR012-INDX)     47030000
442100             MOVE AR012-DEPT-NBR  (AR012-INDX)                    47040000
442200                                   TO PV-DEPT-NBR                 47050000
442300             MOVE AR012-SUB-CL-NBR (AR012-INDX)                   47060000
442400                                   TO PV-SUB-CL-NBR               47070000
442500             MOVE AR012-UPC-NBR     (AR012-INDX)                  47080000
442600                                   TO PV-UPC                      47090000
442700             MOVE AR012-SKU-NBR     (AR012-INDX)                  47100000
442800                                   TO PV-SKU-NBR                  47110000
442900     END-SEARCH.                                                  47120000
443000                                                                  47130000
443100******************************************************************47140000
443200*  GET THE ORIGINAL TRANSACTION FOR THE RETURN.  GET THE STORE   *47150000
443300*  INFORMATION FOR THE ORIGINAL TRANSACTION.  IF THE RETURN       47160000
443400*  IS FROM THE ECOMMERCE STORE, GET THE PARTITION CONTAINING     *47170000
443500*  THE ORIGINAL TRANSACTION.  THE SALES DATE IN THE TABLE TEPIRT *47180000
443600*  IS THE ORDER DATE IF THE RETURN WAS PROCESSED AT THE           47190000
443700*  ECOMMERCE STORE.  IT IS THE PROCESS DATE IF THE RETURN WAS    *47200000
443800*  PROCESSED AT A BRICK & MORTAR STORE.                           47210000
443900******************************************************************47220000
444000 7600-GET-ORIG-TRANS-INFO.                                        47230000
444100                                                                  47240000
444200     PERFORM 7650-GET-ORIG-TRANSACTION.                           47250000
444300                                                                  47260000
444400     IF PS-NON-RECEIPTED-RETURN                                   47270000
444500         MOVE EPTRN-STR-NBR TO PV-WORK-STR-NBR                    47280000
444600                               PV-WORK-STR-NBR-TEST               47290000
444700         PERFORM 6221-READ-ECOMMERCE-TABLE                        47300000
444800         IF PS-ECOMMERCE-STORE                                    47310000
444900             SET PS-ECOMMERCE-RETURN TO TRUE                      47320000
445000         ELSE                                                     47330000
445100             SET PS-NOT-ECOMMERCE-RETURN TO TRUE                  47340000
445200         END-IF                                                   47350000
445300     ELSE                                                         47360000
445400         IF EPIRT-ORIG-STR-NBR NOT EQUAL PV-WORK-STR-NBR          47370000
445500             MOVE EPIRT-ORIG-STR-NBR TO PV-WORK-STR-NBR           47380000
445600                                        PV-WORK-STR-NBR-TEST      47390000
445700             PERFORM 6221-READ-ECOMMERCE-TABLE                    47400000
445800             IF PS-END-OF-ECOM-TABLE                              47410000
445900                 PERFORM 6230-GET-STORE-INFO                      47420000
446000                 PERFORM 6221-READ-ECOMMERCE-TABLE                47430000
446100             END-IF                                               47440000
446200         END-IF                                                   47450000
446300         IF PV-BUS-LOC-IND = 'Y'                                  47460000
446400             SET PS-ECOMMERCE-RETURN TO TRUE                      47470000
446500         ELSE                                                     47480000
446600             SET PS-NOT-ECOMMERCE-RETURN TO TRUE                  47490000
446700         END-IF                                                   47500000
446800         PERFORM 7656-GET-ORIG-PARTN-NBR                          47510000
446900         SET PS-TEPECX-EXISTS-NO TO TRUE                          47520000
447000         PERFORM 7640-CHECK-FOR-TEPECX                            47530000
447100         IF PS-TEPECX-EXISTS-YES                                  47540000
447200             SET PS-ECOMMERCE-RETURN TO TRUE                      47550000
447300         ELSE                                                     47560000
447400             SET PS-NOT-ECOMMERCE-RETURN TO TRUE                  47570000
447500         END-IF                                                   47580000
447600     END-IF.                                                      47590000
447700                                                                  47600000
447800***************************************************************** 47610000
447900*  GET THE ORIGINAL TRANSACTION INFORMATION FROM TEPIRT         * 47620000
448000***************************************************************** 47630000
448100 7650-GET-ORIG-TRANSACTION.                                       47640000
448200                                                                  47650000
448300     EXEC SQL                                                     47660000
448400             SELECT ORIG_SLS_DTE                                  47670000
448500                   ,ORIG_STR_NBR                                  47680000
448600                   ,ORIG_RGST_ID                                  47690000
448700                   ,ORIG_TRN_NBR                                  47700000
448800                   ,ORIG_STRT_TM                                  47710000
448900                   ,SLS_CORR_SEQ_NBR                              47720000
449000                   ,ORIG_LNE_ITM_NBR                              47730000
449100             INTO  :EPIRT-ORIG-SLS-DTE                            47740000
449200                  ,:EPIRT-ORIG-STR-NBR                            47750000
449300                  ,:EPIRT-ORIG-RGST-ID                            47760000
449400                  ,:EPIRT-ORIG-TRN-NBR                            47770000
449500                  ,:EPIRT-ORIG-STRT-TM                            47780000
449600                  ,:EPIRT-SLS-CORR-SEQ-NBR                        47790000
449700                  ,:EPIRT-ORIG-LNE-ITM-NBR                        47800000
449800             FROM TEPIRT A                                        47810000
449900             WHERE PARTN_NBR          = :EPTRN-PARTN-NBR          47820000
450000               AND STR_NBR            = :EPTRN-STR-NBR            47830000
450100               AND RGST_ID            = :EPTRN-RGST-ID            47840000
450200               AND TRN_NBR            = :EPTRN-TRN-NBR            47850000
450300               AND A.STRT_TM          = :EPTRN-STRT-TM            47860000
450400               AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR   47870000
450500               AND A.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR    47880000
450600         WITH UR                                                  47890000
450700     END-EXEC.                                                    47900000
450800                                                                  47910000
450900     EVALUATE TRUE                                                47920000
451000         WHEN SQLCODE = ZERO                                      47930000
451100             SET PS-RECEIPTED-RETURN     TO TRUE                  47940000
451200         WHEN SQLCODE = +100                                      47950000
451300             SET PS-NON-RECEIPTED-RETURN TO TRUE                  47960000
451400             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       47970000
451500                                            PV-WORK-STR-NBR-TEST  47980000
451600         WHEN SQLWARN0 NOT EQUAL SPACE                            47990000
451700         WHEN SQLCODE NOT EQUAL ZERO                              48000000
451800             MOVE '7650-GET-ORIG-TRANSACTION'                     48010000
451900                                            TO PV-PARAGRAPH-NAME  48020000
452000             MOVE 'ERROR SELECTING FROM TEPIRT '                  48030000
452100                                            TO PV-DB2-OPERATION   48040000
452200             PERFORM 9200-SQL-ABEND                               48050000
452300     END-EVALUATE.                                                48060000
452400                                                                  48070000
452500***************************************************************** 48080000
452600*  GET THE ORIGINAL PARTITION NUMBER FOR A RETURN PROCESSED AT  * 48090000
452700*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 48100000
452800*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              48110000
452900***************************************************************** 48120000
453000 7656-GET-ORIG-PARTN-NBR.                                         48130000
453100                                                                  48140000
453200     EXEC SQL                                                     48150000
453300          SELECT  PARTN_NBR                                       48160000
453400          INTO    :PV-ORIG-PARTN-NBR                              48170000
453500          FROM TEPPART                                            48180000
453600         WHERE SLS_DTE = :EPIRT-ORIG-SLS-DTE                      48190000
453700           AND STR_GP_CDE   = 'A'                                 48200000
453800         WITH UR                                                  48210000
453900     END-EXEC.                                                    48220000
454000                                                                  48230000
454100     EVALUATE SQLCODE                                             48240000
454200         WHEN ZERO                                                48250000
454300             CONTINUE                                             48260000
454400         WHEN +100                                                48270000
454500             SET PS-NON-RECEIPTED-RETURN TO TRUE                  48280000
454600             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       48290000
454700                                            PV-WORK-STR-NBR-TEST  48300000
454800         WHEN -811                                                48310000
454900             DISPLAY 'INVALID ORIGINAL SALES DATE'                48320000
455000             DISPLAY EPTRN-STR-NBR ' '                            48330000
455100                     EPTRN-RGST-ID ' '                            48340000
455200                     EPTRN-TRN-NBR ' '                            48350000
455300                     EPIRT-ORIG-SLS-DTE                           48360000
455400             SET PS-NON-RECEIPTED-RETURN TO TRUE                  48370000
455500             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       48380000
455600                                            PV-WORK-STR-NBR-TEST  48390000
455700         WHEN OTHER                                               48400000
455800             MOVE '7656-GET-ORIG-PARTN-NBR'                       48410000
455900                                         TO PV-PARAGRAPH-NAME     48420000
456000             PERFORM 9200-SQL-ABEND                               48430000
456100     END-EVALUATE.                                                48440000
456200                                                                  48450000
456300***************************************************************** 48460000
456400*  LOOK FOR A TEPECX ROW FOR THE ORIGINAL TRANSACTION.          * 48470000
456500*  IF A ROW IS FOUND, THEN THE ORIGINAL TRANSACTION WAS AN ECOM * 48480000
456600*  TRANSACTION, ELSE, IT WAS NOT.                               * 48490000
456700***************************************************************** 48500000
456800 7640-CHECK-FOR-TEPECX.                                           48510000
456900                                                                  48520000
457000     EXEC SQL                                                     48530000
457100          SELECT  1                                               48540000
457200          INTO    :PV-HOLD-TEPECX                                 48550000
457300          FROM TEPECX                                             48560000
457400          WHERE ORD_PARTN_NBR =  :PV-ORIG-PARTN-NBR               48570000
457500            AND STR_NBR       =  :EPIRT-ORIG-STR-NBR              48580000
457600            AND RGST_ID       =  :EPIRT-ORIG-RGST-ID              48590000
457700            AND TRN_NBR       =  :EPIRT-ORIG-TRN-NBR              48600000
457800            AND STRT_TM       =  :EPIRT-ORIG-STRT-TM              48610000
457900          WITH UR                                                 48620000
458000     END-EXEC.                                                    48630000
458100                                                                  48640000
458200     EVALUATE SQLCODE                                             48650000
458300         WHEN ZERO                                                48660000
458400              SET PS-TEPECX-EXISTS-YES TO TRUE                    48670000
458500         WHEN +100                                                48680000
458600              CONTINUE                                            48690000
458700         WHEN OTHER                                               48700000
458800              MOVE 'PARAGRAPH 7640-CHECK-FOR-TEPECX'              48710000
458900                                    TO PV-PARAGRAPH-NAME          48720000
459000              PERFORM 9200-SQL-ABEND                              48730000
459100     END-EVALUATE.                                                48740000
459200                                                                  48750000
459300***************************************************************** 48760000
459400*  GET THE GEO INFORMATION                                        48770000
459500***************************************************************** 48780000
459600 7750-GET-GEO-INFO.                                               48790000
459700                                                                  48800000
459800     EXEC SQL                                                     48810000
459900       SELECT  A.PLND_SHIPT_NBR                                   48820000
460000              ,B.ZIP_5_CDE                                        48830000
460100              ,B.TX_GEOG_CDE                                      48840000
460200        INTO  :EPSHP-PLND-SHIPT-NBR                               48850000
460300             ,:EPSHP-ZIP-5-CDE                                    48860000
460400             ,:EPSHP-TX-GEOG-CDE                                  48870000
460500        FROM TEPIPS  A                                            48880000
460600            ,TEPSHP  B                                            48890000
460700        WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR               48900000
460800          AND A.STR_NBR          = :EPTRN-STR-NBR                 48910000
460900          AND A.RGST_ID          = :EPTRN-RGST-ID                 48920000
461000          AND A.TRN_NBR          = :EPTRN-TRN-NBR                 48930000
461100          AND A.STRT_TM          = :EPTRN-STRT-TM                 48940000
461200          AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR        48950000
461300          AND A.LNE_ITM_SEQ_NBR  = :PV-LNE-ITM-SEQ-NBR            48960000
461400          AND A.PARTN_NBR        = B.PARTN_NBR                    48970000
461500          AND A.STR_NBR          = B.STR_NBR                      48980000
461600          AND A.RGST_ID          = B.RGST_ID                      48990000
461700          AND A.TRN_NBR          = B.TRN_NBR                      49000000
461800          AND A.STRT_TM          = B.STRT_TM                      49010000
461900          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             49020000
462000          AND A.PLND_SHIPT_NBR   = B.PLND_SHIPT_NBR               49030000
462100        WITH UR                                                   49040000
462200     END-EXEC.                                                    49050000
462300                                                                  49060000
462400     EVALUATE TRUE                                                49070000
462500         WHEN SQLCODE = ZERO                                      49080000
462600             MOVE EPSHP-ZIP-5-CDE    TO PV-ZIP-CODE-ENCRYPT       49090000
462700             PERFORM 8100-PROCESS-ZIPCODE                         49100000
462800             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          49110000
462900***** IF SHIPMENT INFORMATION IS NOT FOUND, USE THE DEFAULT INFO  49120000
463000***** FOR THE STORE.                                              49130000
463100         WHEN SQLCODE = +100                                      49140000
463200             MOVE PV-ORD-DTE          TO PV-ORIG-TRN-DTE          49150000
463300             MOVE PV-ZIP-CODE-ENCRYPT TO EPSHP-ZIP-5-CDE          49160000
463400             MOVE PV-SHIP-GEO-CODE    TO EPSHP-TX-GEOG-CDE        49170000
463500         WHEN SQLWARN0 NOT EQUAL SPACE                            49180000
463600         WHEN SQLCODE NOT EQUAL ZERO                              49190000
463700             MOVE '7750-GET-GEO-CURSOR'                           49200000
463800                                            TO PV-PARAGRAPH-NAME  49210000
463900             MOVE 'ERROR ON GETTING GEO CURSOR '                  49220000
464000                                            TO PV-DB2-OPERATION   49230000
464100             PERFORM 9200-SQL-ABEND                               49240000
464200     END-EVALUATE.                                                49250000
464300                                                                  49260000
464400***************************************************************** 49270000
464500*  OPEN THE LATE VOID CURSOR.                                     49280000
464600***************************************************************** 49290000
464700 7800-OPEN-LATE-VOID-CURSOR.                                      49300000
464800                                                                  49310000
464900     EXEC SQL                                                     49320000
465000         OPEN LATE-VOID-CSR                                       49330000
465100     END-EXEC.                                                    49340000
465200                                                                  49350000
465300     EVALUATE TRUE                                                49360000
465400         WHEN SQLCODE = ZERO                                      49370000
465500             CONTINUE                                             49380000
465600         WHEN SQLWARN0 NOT EQUAL SPACE                            49390000
465700         WHEN SQLCODE NOT EQUAL ZERO                              49400000
465800             MOVE '7800-OPEN-LATE-VOID-CURSOR'                    49410000
465900                                            TO PV-PARAGRAPH-NAME  49420000
466000             MOVE 'ERROR ON OPENING LATE VOID CURSOR '            49430000
466100                                            TO PV-DB2-OPERATION   49440000
466200             PERFORM 9200-SQL-ABEND                               49450000
466300     END-EVALUATE.                                                49460000
466400                                                                  49470000
466500******************************************************************49480000
466600*  FETCH THE LATE VOID TRANSACTIONS                               49490000
466700******************************************************************49500000
466800 7810-FETCH-LATE-VOID-CURSOR.                                     49510000
466900                                                                  49520000
467000     MOVE 0 TO PS-NULL-IND2.                                      49530000
467100     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                49540000
467200                                                                  49550000
467300     EXEC SQL                                                     49560000
467400         FETCH LATE-VOID-CSR                                      49570000
467500         INTO  :EPTRN-PARTN-NBR                                   49580000
467600              ,:EPTRN-STR-NBR                                     49590000
467700              ,:EPTRN-RGST-ID                                     49600000
467800              ,:EPTRN-TRN-NBR                                     49610000
467900              ,:EPTRN-SLS-CORR-SEQ-NBR                            49620000
468000              ,:EPTRN-STRT-TM                                     49630000
468100              ,:EPTRN-TRN-STAT-CDE                                49640000
468200              ,:EPTRN-VOID-ABRT-CDE                               49650000
468300              ,:EPTRN-TRN-TYP-CDE                                 49660000
468400              ,:EPTRN-SLS-DTE                                     49670000
468500              ,:EPTRN-TRN-DTE                                     49680000
468600              ,:EPTRN-TRN-TOT-AMT                                 49690000
468700              ,:EPTRN-SLS-TX-AMT                                  49700000
468800              ,:EPTRN-ASSOC-ID                                    49710000
468900              ,:EPTND-TNDR-ID                                     49720000
469000              ,:EPTND-TNDR-AMT                                    49730000
469100              ,:EPTND-TNDR-SEQ-NBR                                49740000
469200              ,:EPCRD-AUTH-APVL-CDE                               49750000
469300              ,:EPCRD-AUTH-NBR                                    49760000
469400              ,:EPPAY-KC-ACCT-NBR                                 49770000
469500              ,:EPPAY-PAYT-AMT                                    49780000
469600              ,:EPTND-TNDR-ID-SRC-CDE                             49790000
469700              ,:EPTRN-POS-CPBL-LVL-NBR                            49800000
469800              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND2       49810000
469900              ,:EPTND-TNDR-ID-LEN-NBR                             49820000
SHIP2               ,:EPTRN-VISA-MULT-CLR-SEQ-NBR                       49830000
SHIP2               ,:EPTRN-VISA-TOT-SHP-NBR                            49840000
470000     END-EXEC.                                                    49850000
470100                                                                  49860000
470200     EVALUATE TRUE                                                49870000
470300         WHEN SQLCODE = ZERO                                      49880000
470400             ADD +1               TO PA-LATE-VOID-ROWS-FETCHED    49890000
470500             MOVE EPTRN-PARTN-NBR TO PV-PARTN-NBR                 49900000
470600             MOVE EPTRN-STRT-TM   TO PV-STRT-TM                   49910000
470700             MOVE EPTRN-SLS-CORR-SEQ-NBR                          49920000
470800                                  TO PV-SEQ-NBR                   49930000
470900*  MOVING 'V' HERE BECAUSE ABENDS AND TRANSACTIONS THAT COME      49940000
471000*  THROUGH DATA COLLECT IN THE WRONG ORDER WILL NOT HAVE THE      49950000
471100*  VOID ABORT CODE SET.                                           49960000
471200             MOVE 'V'             TO EPTRN-VOID-ABRT-CDE          49970000
471300         WHEN SQLCODE = +100                                      49980000
471400             SET PS-END-OF-LATE-VOID-CURSOR                       49990000
471500                                  TO TRUE                         50000000
471600         WHEN SQLWARN0 NOT EQUAL SPACE                            50010000
471700         WHEN SQLCODE NOT EQUAL ZERO                              50020000
471800             MOVE '7810-FETCH-LATE-VOID-CURSOR'                   50030000
471900                                            TO PV-PARAGRAPH-NAME  50040000
472000             MOVE 'ERROR ON FETCHING LATE VOID CURSOR '           50050000
472100                                            TO PV-DB2-OPERATION   50060000
472200             PERFORM 9200-SQL-ABEND                               50070000
472300     END-EVALUATE.                                                50080000
472400                                                                  50090000
472500***************************************************************** 50100000
472600*  CLOSE THE LATE VOID CURSOR                                     50110000
472700***************************************************************** 50120000
472800 7820-CLOSE-LATE-VOID-CURSOR.                                     50130000
472900                                                                  50140000
473000     EXEC SQL                                                     50150000
473100         CLOSE LATE-VOID-CSR                                      50160000
473200     END-EXEC.                                                    50170000
473300                                                                  50180000
473400     EVALUATE TRUE                                                50190000
473500         WHEN SQLCODE = ZERO                                      50200000
473600             CONTINUE                                             50210000
473700         WHEN SQLWARN0 NOT EQUAL SPACE                            50220000
473800         WHEN SQLCODE NOT EQUAL ZERO                              50230000
473900             MOVE '7820-CLOSE-LATE-VOID-CURSOR'                   50240000
474000                                            TO PV-PARAGRAPH-NAME  50250000
474100             MOVE 'ERROR ON CLOSING LATE VOID CURSOR '            50260000
474200                                            TO PV-DB2-OPERATION   50270000
474300             PERFORM 9200-SQL-ABEND                               50280000
474400     END-EVALUATE.                                                50290000
474500                                                                  50300000
474600******************************************************************50310000
474700*  WRITE A REFORMATTED ACCOUNTS RECEIVABLE TRANSACTION RECORD.   *50320000
474800******************************************************************50330000
474900 8000-WRITE-AR-RECORD.                                            50340000
475000                                                                  50350000
475100     WRITE AR-ACCOUNTS-RECEIVABLE-RECORD                          50360000
475200         FROM AR001-AR-TRANSACTION-RECORD.                        50370000
475300                                                                  50380000
475400     ADD +1 TO PA-RECORDS-WRITTEN.                                50390000
475500                                                                  50400000
475600                                                                  50410000
475700******************************************************************50420000
475800* PROCESS THE ZIP-CODE.                                           50430000
475900******************************************************************50440000
476000 8100-PROCESS-ZIPCODE.                                            50450000
476010                                                                  50460000
476020     IF PV-ZIP-CODE-ENCRYPT = SPACES                              50470000
476030        MOVE SPACES TO PV-SHIP-ZIP-CODE                           50480000
476040     ELSE                                                         50490000
476050        PERFORM 8110-SEARCH-ZIPCODE                               50500000
476060     END-IF.                                                      50510000
476070                                                                  50520000
476080******************************************************************50530000
476090* SEARCH THE MATCHING ZIP-CODE.                                   50540000
476100******************************************************************50550000
476101 8110-SEARCH-ZIPCODE.                                             50560000
476102                                                                  50570000
476103     SET ZIP-IDX                  TO 1.                           50580000
476104     SET PS-NOT-END-OF-ZIP-TABLE  TO TRUE.                        50590000
476105                                                                  50600000
476106     SEARCH ZIP-CODE-TABLE-ENTRIES VARYING ZIP-IDX                50610000
476107         AT END                                                   50620000
476108             SET PS-END-OF-ZIP-TABLE      TO TRUE                 50630000
476109             PERFORM 8120-BASE64-BINARY                           50640000
476110             PERFORM 8130-DECRYPT-ZIPCDE                          50650000
476111             PERFORM 8140-ASCII-EBCDIC                            50660000
476112         WHEN PV-ZIP-CODE-ENCRYPT = ZIP-ENCRYPT(ZIP-IDX)          50670000
476113             MOVE ZIP-CLEAR(ZIP-IDX) TO PV-SHIP-ZIP-CODE          50680000
476114     END-SEARCH.                                                  50690000
476115                                                                  50700000
476116******************************************************************50710000
476117* CONVERTS THE DATA FROM BASE64 TO BINARY FORMAT.                 50720000
476118******************************************************************50730000
476119 8120-BASE64-BINARY.                                              50740000
476120                                                                  50750000
476130     INITIALIZE PV-INPUT-TEXT                                     50760000
476131                PV-OUTPUT-TEXT                                    50770000
476132                PV-ZIP-LENGTH.                                    50780000
476133                                                                  50790000
476134     MOVE PV-ZIP-CODE-ENCRYPT TO PV-INPUT-TEXT.                   50800000
476135     INSPECT PV-ZIP-CODE-ENCRYPT  TALLYING PV-ZIP-LENGTH          50810000
476136                FOR CHARACTERS BEFORE INITIAL SPACE.              50820000
476137                                                                  50830000
476138     MOVE PV-ZIP-LENGTH       TO DP022-INLEN.                     50840000
476139     MOVE 18                  TO DP022-OUTLEN-IN.                 50850000
476140     CALL  DP022-MGCXR2B  USING DP022-PARMS,                      50860000
476141                                PV-INPUT-TEXT,                    50870000
476142                                PV-OUTPUT-TEXT.                   50880000
476143     IF RETURN-CODE NOT EQUAL 0                                   50890000
476144        DISPLAY 'ERROR WHILE CONVERTING BASE64 TO BINARY'         50900000
476145        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  50910000
476146        DISPLAY 'ENCRYPTED ZIP-CODE - ' PV-ZIP-CODE-ENCRYPT       50920000
476147        SET AC-CONVERSION-ERROR TO TRUE                           50930000
476148        CALL 'ILBOABN0' USING ABEND-CODE                          50940000
476149     END-IF.                                                      50950000
476150                                                                  50960000
476151******************************************************************50970000
476152* CALLS THE PROTEGRITY MODULE TO DECRYPT THE ZIP-CODE.            50980000
476153* RETURNED ZIP CODE VALUE WILL BE IN ASCII FORMAT.                50990000
476154******************************************************************51000000
476155 8130-DECRYPT-ZIPCDE.                                             51010000
476156                                                                  51020000
476157     INITIALIZE CSI-PARAMETERS                                    51030000
476158                DP031-PROTEG-PGM-PARAMETERS.                      51040000
476159     MOVE 'ZIP-CODE'              TO DP031-FIELD.                 51050000
476160     SET CSI-DECRYPT-FUNCTION     TO TRUE.                        51060000
476161     SET DP031-CUST-INFO          TO TRUE.                        51070000
476162     MOVE DP022-OUTLEN-OUT        TO CSI-CIPHER-TEXT-LENGTH.      51080000
476163     MOVE 5                       TO CSI-CLEAR-TEXT-LENGTH.       51090000
476164     MOVE PV-OUTPUT-TEXT          TO DP031-CIPHER-TEXT.           51100000
476165     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      51110000
476166     IF CSI-RETURN-CODE NOT = ZERO                                51120000
476167        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   51130000
476168        DISPLAY 'ENCRYPTED ZIP-CODE - ' PV-ZIP-CODE-ENCRYPT       51140000
476169        DISPLAY 'INPUT ZIP LENGTH   - ' PV-ZIP-LENGTH             51150000
476170        PERFORM DP031-9999-ABEND                                  51160000
476171     END-IF.                                                      51170000
476172                                                                  51180000
476173******************************************************************51190000
476174* CONVERTS THE DATA FROM ASCII TO EBCDIC FORMAT                   51200000
476175******************************************************************51210000
476176 8140-ASCII-EBCDIC.                                               51220000
476177                                                                  51230000
476178     INITIALIZE DP053-EBCDIC-ASCII-PARMS.                         51240000
476179                                                                  51250000
476180     SET  DP053-CT-ASCII-TO-EBCDIC TO TRUE.                       51260000
476181     MOVE DP031-CLEAR-TEXT      TO DP053-INPUT-FIELD.             51270000
476182     MOVE CSI-CLEAR-TEXT-LENGTH TO DP053-FIELD-LENGTH.            51280000
476183                                                                  51290000
476184     CALL DP053-EBCDIC-ASCII-ROUTINE USING DP053-CONVERSION-TYPE  51300000
476185                                           DP053-FIELD-LENGTH     51310000
476186                                           DP053-INPUT-FIELD      51320000
476187                                           DP053-OUTPUT-FIELD     51330000
476188                                           DP053-RETURN-CODE.     51340000
476189     IF DP053-RC-SUCCESSFUL                                       51350000
476190        MOVE PV-ZIP-CODE-ENCRYPT TO ZIP-ENCRYPT(ZIP-IDX2)         51360000
476191        MOVE DP053-OUTPUT-FIELD  TO ZIP-CLEAR(ZIP-IDX2)           51370000
476192                                    PV-SHIP-ZIP-CODE              51380000
476193        SET ZIP-IDX2 UP BY 1                                      51390000
476194     ELSE                                                         51400000
476195        DISPLAY 'ERROR WHILE CONVERTING ASCII TO EBCDIC'          51410000
476196        DISPLAY 'RETURN CODE     - ' DP053-RETURN-CODE            51420000
476197        DISPLAY 'ENCRYPTED ZIP-CODE - ' PV-ZIP-CODE-ENCRYPT       51430000
476198        SET AC-CONVERSION-ERROR TO TRUE                           51440000
476199        CALL 'ILBOABN0' USING ABEND-CODE                          51450000
476200     END-IF.                                                      51460000
476201                                                                  51470000
476202     IF ZIP-IDX2 > PC-ZIP-MAX                                     51480000
476203         DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME           51490000
476204         DISPLAY 'INTERNAL ZIP TABLE OVERFLOW'                    51500000
476205         DISPLAY 'INCREASE THE ZIP TABLE SIZE MORE THAN 99999'    51510000
476206         SET AC-TABLE-OVERFLOW TO TRUE                            51520000
476207         CALL 'ILBOABN0' USING AC-ABEND-CODE                      51530000
476208     END-IF.                                                      51540000
476209                                                                  51550000
476210******************************************************************51560000
476220*  CLOSE ALL FILES.                                              *51570000
476230******************************************************************51580000
476240 9000-EOJ-ROUTINE.                                                51590000
476250                                                                  51600000
476260     DISPLAY ' '.                                                 51610000
476270     DISPLAY '************** CONTROL TOTALS ***************'.     51620000
476280     DISPLAY ' '.                                                 51630000
476290     DISPLAY 'LATE VOID TRANSACTIONS============ '                51640000
476300              PA-LATE-VOID-ROWS-FETCHED.                          51650000
476400     DISPLAY 'LATE AND CORRECTION TRANSACTIONS== '                51660000
476500              PA-LATE-COR-ROWS-FETCHED.                           51670000
476600     DISPLAY 'CURRENT TRANSACTIONS============== '                51680000
476700              PA-TRANSACTIONS-FETCHED.                            51690000
476800     DISPLAY 'DETAIL RECORDS WRITTEN TO AR FILE= '                51700000
476900              PA-RECORDS-WRITTEN.                                 51710000
477000                                                                  51720000
477100     CLOSE ACCOUNTS-RECEIVABLE-FILE.                              51730000
477200                                                                  51740000
477300***************************************************************** 51750000
477400*  DISPLAY ERROR MESSAGE WHEN A DEPT CLASS ERROR IS ENCOUNTERED.  51760000
477500***************************************************************** 51770000
477600 9150-DEPT-CLASS-ERROR.                                           51780000
477700                                                                  51790000
477800     DISPLAY PC-CURRENT-PROGRAM-NAME                              51800000
477900               ' - DEPT CLASS NOT FOUND FOR SPECIAL SERVICE'.     51810000
478000     DISPLAY '7400-READ-DEPT-CLASS-TABLE'.                        51820000
478100     DISPLAY 'STORE # ' PV-STR-NBR-9.                             51830000
478200     DISPLAY 'REGISTER # ' PV-RGST-ID-9.                          51840000
478300     DISPLAY 'TRAN # ' PV-TRN-NBR-9.                              51850000
478400     DISPLAY 'SPECIAL SERVICE CODE ' PV-SRVC-TYP-CDE.             51860000
478500                                                                  51870000
478600******************************************************************51880000
478700* 9200-SQL-ABEND                                                  51890000
478800*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.51900000
478900******************************************************************51910000
479000 9200-SQL-ABEND.                                                  51920000
479100                                                                  51930000
479200     DISPLAY '** ABEND        **'.                                51940000
479300     DISPLAY '** PROGRAM      ** = ' PC-CURRENT-PROGRAM-NAME.     51950000
479400     DISPLAY '** PARAGRAPH    ** = ' PV-PARAGRAPH-NAME.           51960000
479500     DISPLAY '** OPERATION    ** = ' PV-DB2-OPERATION.            51970000
479600                                                                  51980000
479700******************************************************************51990000
479800* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     52000000
479900* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      52010000
480000******************************************************************52020000
480100     COPY DPPD004.                                                52030000
480200                                                                  52040000
480300     SET AC-DB2-ERROR TO TRUE.                                    52050000
480400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         52060000
480500                                                                  52070000
480600******************************************************************52080000
480700* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE      * 52090000
480800* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION               * 52100000
480900******************************************************************52110000
481000     COPY DPPD031.                                                52120000
481100                                                                  52130000
