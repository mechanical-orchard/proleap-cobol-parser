         PRINT ON                                                       00010000
*****************************************************************       00020000
**                                                             **       00030000
**  THIS IS THE TCPIP TO LU QUERY FUNCION CALLED BY CICS       **       00040000
**                                                             **       00060000
**  THIS DATA CAN THEN BE USED BY CICS TO FIGURE OUT THE       **       00090000
**  LOCATION OF PC'S DOING CICS TRANSACTIONS.                  **       00100000
**                                                             **       00110000
**   CHANGES TO THIS PROGRAM MUST BE MADE IN SYNC WITH:        **       00111001
**     "SYS2.MACLIB($USERCVT)"                                 **       00120003
**     "PKMO.DP.SRCLIB(DPKCS199)"                              **       00120103
**     "TKMS.LINKLIB.ASM(MPFUSR10)"                            **       00120203
**     "TKMS.LINKLIB.ASM(TCPU83)"                              **       00120303
**     "TKMS.LINKLIB.ASM(TCPU84)"                              **       00120403
**     "TKMS.LINKLIB.ASM(TCPU85)"                              **       00120503
**     "SYS2.VTAMLST(APPLTCPA)"                                **       00120603
**     "TCPIP.PROFILE.TCPIP"                                   **       00120703
**                                                             **       00121001
**                                                             **       00130000
**   LINK ATTRIBUTES: RENT,REUS                                **       00140000
**                    AMODE 31     RMODE ANY                   **       00150000
**   LINK LIBRARY:    PKMO.CICS.LOADLIB                        **       00160000
**                                                             **       00170000
**                                                             **       00180000
**   USAGE:  CALL 'TCPQUERY' USING VTAM-LU IP-ADDR LU-TO-IP-RC.**       00190000
**                                                             **       00191000
**                 WHERE  VTAM-LU IS CHAR 8  (TCP0U###)        **       00191100
**                 WHERE  IP-ADDR IS CHAR 12  ############     **       00191200
**                          (NO DOTS IN DOTTED DECIMAL IP ADDR)**       00191300
**                 WHERE  LU-TO-IP-RC CHAR 4  (0,1,2,3 OR 4)   **       00191400
**                                                             **       00192000
**   REGISTER USAGE FOLLOWS:                                   **       00193000
**                                                             **       00200000
**       R0  = NOT USED                                        **       00210000
**       R1  = POINTER TO THE PARM LIST , WORK                 **       00220000
**       R2  = WORK                                            **       00230000
**       R3  = WORK                                            **       00240000
**       R4  = INDEX POINTER FOR HEX CONVERT , WORK            **       00250000
**       R5  = WORK                                            **       00260000
**       R6  = ADDR OF VTAM-LU                                 **       00271000
**       R7  = ADDR OF IP-ADDR                                 **       00280000
**       R8  = ADDR OF RETURN CODE                             **       00290000
**       R9  = USING FOR CVTPTR                                **       00291000
**       R10 = USING FOR CVTUSER                               **       00292000
**       R11 = POINTER TO TCP-LU TABLE IN CSA                  **       00293000
**       R12 = BASE                                            **       00294000
**       R13 = SAME AS WHEN SVC WAS ISSUED (AT ENTRY TO EXIT)  **       00295000
**       R14 = RETURN REGISTER                                 **       00296000
**       R15 = ENTRY POINT ADDRESS                             **       00297000
**                                                             **       00298000
*****************************************************************       00299000
DPKCS199 CSECT                                                          00300000
DPKCS199 AMODE 31                                                       00310000
DPKCS199 RMODE ANY                                                      00320000
R0       EQU   0                                                        00330000
R1       EQU   1                                                        00340000
R2       EQU   2                                                        00350000
R3       EQU   3                                                        00360000
R4       EQU   4                                                        00370000
R5       EQU   5                                                        00380000
R6       EQU   6                                                        00390000
R7       EQU   7                                                        00400000
R8       EQU   8                                                        00410000
R9       EQU   9                                                        00420000
R10      EQU   10                                                       00430000
R11      EQU   11                                                       00440000
R12      EQU   12                                                       00450000
R13      EQU   13                                                       00460000
R14      EQU   14                                                       00470000
R15      EQU   15                                                       00480000
*                                                                       00490000
*                                                                       00500000
         STM   R14,R12,12(R13)       SAVE CALLER REGS                   00510000
         BALR  R12,R0                ESTABLISH BASE -                   00520000
         USING *,R12                   REGISTER                         00530000
*                                                                       00540000
         USING @VTAMLU,R6                                               00540100
         USING @IPADDR,R7                                               00540200
         USING @RC,R8                                                   00540300
         LM    R6,R8,0(R1)           LOAD ADDRESS OF CALLING PGM FIELD  00541000
*                                                                       00542000
*********************************************************************** 00643500
**       GET THE USERCVT ADDRESS AND THEN THE TCPIP-LU TABLE ADDRESS ** 00643600
*********************************************************************** 00643700
*                                                                       00643800
         USING CVTMAP,R9                                                00643900
         USING USERCVT,R10                                              00644000
*                                                                       00645000
         L     R9,CVTPTR         GET ADDRESS OF CVT                     00646000
         ICM   R10,15,CVTUSER    LOAD THE CVT USER WORD                 00647000
         BZ    RETURN1           NO CVTUSER AREA                        00648000
*                                                                       00649000
         ICM   R11,15,UCVTTCP    LOAD THE TCP-LU TABLE ADDRESS          00650000
         BZ    RETURN2           NO AREA FOR TCP TO LU TRANSLATION      00660000
*                                                                       00670000
*********************************************************************** 00680000
*        NOW CHECK FOR VALID TCPIP/VTAM LU BEING USED                 * 00690000
*        THERE ARE 4096 TN3270 CONNECTION FOR EACH DIFFERENT          * 00691003
*        DIGIT IN THE 5TH POSITION TCP0X###                           * 00692003
*********************************************************************** 00700000
*                                                                       00760000
         MVC   INDEX,=X'0000'         SET INDEX - TN3270 0-4095         00772001
         CLC   VTAMLU(5),=CL5'TCP0U'    KOHLS CONVENTION                00773001
         BE    CHKLAST3               YES - CONTINUE                    00774001
         MVC   INDEX,=X'1000'         SET INDEX - TN3270 4096-8191      00775001
         CLC   VTAMLU(5),=CL5'TCP0D'    KOHLS CONVENTION                00776003
         BE    CHKLAST3               YES - CONTINUE                    00777001
         MVC   INDEX,=X'2000'         SET INDEX - TN3270 8192-12287     00778001
         CLC   VTAMLU(5),=CL5'TCP0F'    KOHLS CONVENTION                00779003
         BE    CHKLAST3               YES - CONTINUE                    00779101
         MVC   INDEX,=X'3000'         SET INDEX - TN3270 12288-16383    00779201
         CLC   VTAMLU(5),=CL5'TCP0K'    KOHLS CONVENTION                00779303
         BE    CHKLAST3               YES - CONTINUE                    00779401
         MVC   INDEX,=X'4000'         SET INDEX - TN3270 16384-20479    00779501
         CLC   VTAMLU(5),=CL5'TCP0O'    KOHLS CONVENTION                00779603
         BE    CHKLAST3               YES - CONTINUE                    00779701
         MVC   INDEX,=X'5000'         SET INDEX - TN3270 20480-24575    00779801
         CLC   VTAMLU(5),=CL5'TCP0V'    KOHLS CONVENTION                00779903
         BE    CHKLAST3               YES - CONTINUE                    00780001
         MVC   INDEX,=X'6000'         SET INDEX - TN3270 24576-28671    00780101
         CLC   VTAMLU(5),=CL5'TCP0Z'    KOHLS CONVENTION                00780203
         BE    CHKLAST3               YES - CONTINUE                    00780301
* ******************************************************************    00780401
*        REPEAT THE ABOVE 3 LINES AS NEEDED TO ADD MORE CONNECTIONS     00780501
*        - CHANGE INDEX X'#000" AND TCP0X FOR NEW LU'S                  00780603
* ******************************************************************    00780801
         B     RETURN3                NO - MUST BE ERROR                00780901
CHKLAST3 TRT   VTAMLU+5(3),VALIDLU    ARE THEY HEX CHARACTERS           00781301
         BNZ   RETURN4                NO - MUST BE ERROR                00781401
*                                                                       00782000
         MVC   TEMPFLD,VTAMLU+5     MOVE IN BYTE 6                      00790000
         TR    TEMPFLD,TRANTABN     TRANSLATE DISPLAY CHARACTER TO HEX  00800000
         MVN   INDEX(1),TEMPFLD     MOVE IN THE NUMERIC PORTION         00810000
*                                                                       00820000
         MVC   TEMPFLD,VTAMLU+6     MOVE IN BYTE 7                      00830000
         TR    TEMPFLD,TRANTABZ     TRANSLATE DISPLAY CHARACTER TO HEX  00840000
         MVZ   INDEX+1(1),TEMPFLD   MOVE IN THE ZONE PORTION            00841000
*                                                                       00842000
         MVC   TEMPFLD,VTAMLU+7     MOVE IN BYTE 8                      00843000
         TR    TEMPFLD,TRANTABN     TRANSLATE DISPLAY CHARACTER TO HEX  00844000
         MVN   INDEX+1(1),TEMPFLD   MOVE IN THE NUMERIC PORTION         00845000
*                                                                       00846000
         XR    R4,R4                CLEAR R4                            00847000
         LH    R4,INDEX             MOVE IN THE INDEX                   00848001
         SLA   R4,2                 MULTIPLY BY 4                       00849000
         AR    R11,R4               ADD TO TCPLU AREA ADDRESS           00849100
*                                                                       00849200
         XR    R5,R5                CREAR R5                            00849300
         ICM   R5,B'0001',0(R11)    MOVE IN 1ST BYTE OF IP ADDR         00849400
         CVD   R5,DWORD             CONVERT TO DECIMAL                  00849500
         OI    DWORD+7,X'0F'        MAKE LAST CHAR POSITIVE             00849600
         UNPK  FWORD,DWORD+6(2)     UNPACK IT                           00849700
         L     R1,FWORD             SAVE INTO R1                        00849800
*                                                                       00849900
         XR    R5,R5                CREAR R5                            00850000
         ICM   R5,B'0001',1(R11)    MOVE IN 2ND BYTE OF IP ADDR         00850100
         CVD   R5,DWORD             CONVERT TO DECIMAL                  00850200
         OI    DWORD+7,X'0F'        MAKE LAST CHAR POSITIVE             00850300
         UNPK  FWORD,DWORD+6(2)     UNPACK IT                           00850400
         L     R2,FWORD             SAVE INTO R2                        00850500
*                                                                       00850600
         XR    R5,R5                CREAR R5                            00850700
         ICM   R5,B'0001',2(R11)    MOVE IN 3RD BYTE OF IP ADDR         00850800
         CVD   R5,DWORD             CONVERT TO DECIMAL                  00850900
         OI    DWORD+7,X'0F'        MAKE LAST CHAR POSITIVE             00851000
         UNPK  FWORD,DWORD+6(2)     UNPACK IT                           00851100
         L     R3,FWORD             SAVE INTO R3                        00851200
*                                                                       00851300
         XR    R5,R5                CREAR R5                            00851400
         ICM   R5,B'0001',3(R11)    MOVE IN 4TH BYTE OF IP ADDR         00851500
         CVD   R5,DWORD             CONVERT TO DECIMAL                  00851600
         OI    DWORD+7,X'0F'        MAKE LAST CHAR POSITIVE             00851700
         UNPK  FWORD,DWORD+6(2)     UNPACK IT                           00851800
         L     R4,FWORD             SAVE INTO R4                        00851900
*                                                                       00852000
         STCM  R1,B'0111',IPADDR    MOVE                                00852100
         STCM  R2,B'0111',IPADDR+3    INTO                              00852200
         STCM  R3,B'0111',IPADDR+6     CALLERS                          00852300
         STCM  R4,B'0111',IPADDR+9       IP-ADDR FIELD                  00852400
*                                                                       00853000
         B     RETURN0              NOW GET OUT                         00858000
*                                                                       00859000
         EJECT                                                          00960000
**********************************************************************  00970000
*        RESTORE REGS AND RETURN TO CALLER                              00980000
**********************************************************************  00990000
*                                                                       01000000
RETURN0  MVC   LUTOIPRC,=C'0000'                                        01010000
         B     EOJ                                                      01011000
RETURN1  MVC   LUTOIPRC,=C'0001'                                        01012000
         B     EOJ                                                      01012100
RETURN2  MVC   LUTOIPRC,=C'0002'                                        01012200
         B     EOJ                                                      01012300
RETURN3  MVC   LUTOIPRC,=C'0003'                                        01012400
         B     EOJ                                                      01012500
RETURN4  MVC   LUTOIPRC,=C'0004'                                        01012600
         B     EOJ                                                      01013000
EOJ      EQU   *                                                        01020000
         DROP  R6,R7,R8,R9,R10                                          01030000
         LM    R14,R12,12(R13)       RESTORE CALLERS REGS               01040000
         XR    R15,R15               CLEAR R15                          01050000
         BR    R14                   RETURN TO CALLER                   01060000
*                                                                       01070000
VALIDLU  DS    0CL256                                                   01220000
         DC    192X'FF'                                00 - BF          01230000
         DC    XL16'FF000000000000FFFFFFFFFFFFFFFFFF'  C0 - CF          01240000
         DC    32X'FF'                                 D0 - EF          01250000
         DC    XL16'00000000000000000000FFFFFFFFFFFF'  F0 - FF          01260000
*                                                                       01270000
TRANTABN DS    0CL256                                                   01280000
         DC    192X'00'                                00 - BF          01290000
         DC    XL16'000A0B0C0D0E0F000000000000000000'  C0 - CF          01300000
         DC    32X'00'                                 D0 - EF          01310000
         DC    XL16'00010203040506070809000000000000'  F0 - FF          01320000
*                                                                       01330000
TRANTABZ DS    0CL256                                                   01340000
         DC    192X'00'                                00 - BF          01350000
         DC    XL16'00A0B0C0D0E0F0000000000000000000'  C0 - CF          01360000
         DC    32X'00'                                 D0 - EF          01370000
         DC    XL16'00102030405060708090000000000000'  F0 - FF          01380000
*                                                                       01390000
         EJECT                                                          01400000
         LTORG                                                          01410000
*                                                                       01420000
         DS    0F                                                       01430000
@VTAMLU  DSECT                                                          01440000
VTAMLU   DS    CL8                                                      01450000
         DS    0F                                                       01460000
@IPADDR  DSECT                                                          01461000
IPADDR   DS    0CL12                                                    01462000
DWORD    DS    D                                                        01462100
FWORD    DS    F                                                        01462200
         DS    0F                                                       01463000
@RC      DSECT                                                          01464000
LUTOIPRC DS    0CL4                                                     01465000
INDEX    DS    CL2                                                      01466001
TEMPFLD  DS    CL1                                                      01467000
FILLER   DS    CL1                                                      01468000
*                                                                       01470000
         DS    0F                                                       01480000
         $USERCVT                                                       01490000
*                                                                       01740000
         DS    0F                                                       01750000
         CVT   DSECT=YES,LIST=YES                                       01760000
*                                                                       01770000
         END   DPKCS199                                                 01780000
