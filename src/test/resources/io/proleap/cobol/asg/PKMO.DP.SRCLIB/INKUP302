       IDENTIFICATION DIVISION.                                         00010000
                                                                        00020000
       PROGRAM-ID.    INKUP302.                                         00030000
       AUTHOR.        JULIE SEIDLER.                                    00040000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
       DATE-WRITTEN.  1999-09-24.                                       00060000
       DATE-COMPILED.                                                   00070000
                                                                        00080000
W34517******************************************************************00090000
W34517*                                                                 00100000
W34517*               !!!  I M P O R T A N T  !!!                       00110000
W34517*                                                                 00120000
W34517*                                                                 00130000
W34517*    !!!  THIS PROGRAM MUST BE KEPT IN SYNC WITH VAKUP302  !!!    00140000
W34517*                                                                 00150000
W34517*                                                                 00160000
W34517*                                                                 00170000
      ******************************************************************00180000
W34517* INKUP302 - WEEKLY SUB-CLASS STORE SHRINK TABLE UPDATE (TINSHNK) 00190000
W34517* THIS PROGRAM PERFORMS UPDATES FOR THE BRAND VENDOR INVENTORY    00200000
W34517* LEDGER FINANCIALS. ANY CHANGES MADE TO THIS PROGRAM MUST ALSO   00210000
W34517* BE MADE TO THE VA VERSION OF THIS PROGRAM (VAKUP302 - TINSHNK). 00220000
W34517*                                                                 00230000
W34517* CHANGE MADE: SPLIT BV AND VA. INSTALL VA VERSION OF INV LEDGER  00240000
W34517*              WR34517 PATTY JAEGER - OCT. 14, 2008 INSTALL       00250000
      *                                                                 00260000
      *CHANGE HISTORY:                                                  00270000
      * WR/PROJ DATE       PGMR        DESCRIPTION OF CHANGES           00280000
      * ------- ---------- ----------- -------------------------------- 00290000
W20445* W20445  09-01-2004 ROD JANSSEN DETAILED INVNENTORY ADJUSTMENT   00300000
W34517* W34517  07-18-2008 P. JAEGER   BRAND VENDOR CHANGES             00310000
W33304* W33304  07-18-2008 INFOSYS/    HILO CHANGES.                    00311002
W33304*                     JIMMY                                       00312002
W34517******************************************************************00320000
W34517******************************************************************00330000
      ******************************************************************00340000
      ******************************************************************00350000
                                                                        00360000
       ENVIRONMENT DIVISION.                                            00370000
       CONFIGURATION SECTION.                                           00380000
       SOURCE-COMPUTER.        IBM-3090.                                00390000
       OBJECT-COMPUTER.        IBM-3090.                                00400000
       INPUT-OUTPUT SECTION.                                            00410000
       FILE-CONTROL.                                                    00420000
                                                                        00430000
           SELECT CONDENSED-FILE                                        00440000
               ASSIGN TO INP01.                                         00450000
                                                                        00460000
       DATA DIVISION.                                                   00470000
       FILE SECTION.                                                    00480000
                                                                        00490000
       FD  CONDENSED-FILE                                               00500000
           LABEL RECORDS ARE STANDARD                                   00510000
           RECORDING MODE IS F                                          00520000
           BLOCK CONTAINS 0 RECORDS.                                    00530000
W20445 01  CONDENSED-RECORD            PIC X(80).                       00540000
                                                                        00550000
       WORKING-STORAGE SECTION.                                         00560000
                                                                        00570000
       01  FILLER                      PIC X(28)   VALUE                00580000
                'BEGINNING OF WORKING STORAGE'.                         00590000
       01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00600000
                                                                        00610000
       01  PC-PROGRAM-CONSTANTS.                                        00620000
           05  PC-JOB-NAME             PIC  X(06)    VALUE 'INK217'.    00630000
           05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'INKUP302'.  00640000
           05  PC-MAX-DEADLOCKS        PIC S9(03) VALUE +3.             00650000
                                                                        00660000
       01  PE-PROGRAM-ERROR-MESSAGES.                                   00670000
           05  PE-MSG-01                       PIC X(50) VALUE          00680000
                'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00690000
           05  PE-MSG-02                       PIC X(50) VALUE          00700000
W34517***       'ATTEMPT TO UPDATE ROW ON TABLE TINSHNK FAILED    '.    00710000
W34517          'ATTEMPT TO UPDATE ROW ON TABLE INV_SHRK FAILED   '.    00720000
           05  PE-MSG-03                       PIC X(50) VALUE          00730000
W34517****      'ATTEMPT TO INSERT ROW ON TABLE TINSHNK FAILED    '.    00740000
W34517          'ATTEMPT TO INSERT ROW ON TABLE SHNK-INT00006 FAIL'.    00750000
           05  PE-MSG-04                       PIC X(50) VALUE          00760000
                'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00770000
           05  PE-MSG-05                       PIC X(50) VALUE          00780000
                'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00790000
           05  PE-MSG-06                       PIC X(50) VALUE          00800000
                'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00810000
           05  PE-MSG-07                       PIC X(50) VALUE          00820000
                'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00830000
W33304     05  PE-MSG-08                       PIC X(50) VALUE          00831002
W33304          'SELECT ON JOIN OF TINVPAR AND TINCNTL FAILED'.         00832002
W33304     05  PE-MSG-09                       PIC X(50) VALUE          00833002
W33304          'SELECT ON TDTATTR FAILED'.                             00834002
                                                                        00840000
       01  PS-PROGRAM-SWITCHES.                                         00850000
           05  PS-EOF-CONDENSED-FILE-SW     PIC X(01)     VALUE 'N'.    00860000
               88  PS-EOF-CONDENSED-FILE                  VALUE 'Y'.    00870000
           05  PS-INSHNK-CURSOR-EOF-SW      PIC X(01)     VALUE 'N'.    00880000
               88  PS-END-OF-TABLE-RECS                   VALUE 'Y'.    00890000
           05  PS-FIRST-COMMIT-SW           PIC X(01)     VALUE 'N'.    00900000
               88  PS-FIRST-COMMIT                        VALUE 'Y'.    00910000
           05  PS-DEADLOCK-RESTART-SW       PIC X(01)     VALUE 'N'.    00920000
               88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00930000
W33304     05  PS-SKIP-RECORD-SW            PIC X(01)     VALUE 'N'.    00931002
W33304         88  PS-SKIP-RECORD-YES                     VALUE 'Y'.    00932002
W33304         88  PS-SKIP-RECORD-NO                      VALUE 'N'.    00933002
                                                                        00940000
       01  PI-PROGRAM-INDICATORS.                                       00950000
           05  PI-PROCESSING-OPTIONS-IND    PIC X(01)     VALUE 'P'.    00960000
               88  PI-UPDATE-INSHNK-ROW                   VALUE 'U'.    00970000
               88  PI-INSERT-INSHNK-ROW                   VALUE 'I'.    00980000
                                                                        00990000
       01  PROGRAM-VARIABLES.                                           01000000
           05  PV-RETRY-COUNT                  PIC S9(04) VALUE +0.     01010000
           05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0.     01020000
                                                                        01030000
           05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01040000
           05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01050000
           05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01060000
           05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01070000
           05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01080000
W20445     05  PV-EDIT-SUB-CLASS               PIC 9(03) VALUE ZEROS.   01090000
W20445     05  PV-EDIT-SUB-CLASS-RED REDEFINES                          01100000
W20445         PV-EDIT-SUB-CLASS.                                       01110000
W20445         10  PV-EDIT-CLASS-P1            PIC X(01).               01120000
W20445         10  PV-EDIT-CLASS-P2            PIC X(02).               01130000
W20445     05  PV-EDIT-DEPT-NBR                PIC 9(03) VALUE ZEROS.   01140000
W20445     05  PV-EDIT-DEPT-NBR-RED REDEFINES                           01150000
W20445         PV-EDIT-DEPT-NBR                PIC X(03).               01160000
                                                                        01170000
       01  PA-PROGRAM-ACCUMULATORS.                                     01180000
           05  PA-RECORD-COUNTS.                                        01190000
               10  PA-INPUT-COUNT        PIC  9(09)  VALUE ZEROES.      01200000
               10  PA-UPDATE-COUNT       PIC  9(09)  VALUE ZEROES.      01210000
               10  PA-INSERT-COUNT       PIC  9(09)  VALUE ZEROES.      01220000
W33304         10  PA-SKIP-COUNT         PIC  9(09)  VALUE ZEROES.      01221004
           05  PA-ACCUMULATORS.                                         01230000
               10 PA-SLS-RTL-AMT-IN      PIC S9(13)V99 VALUE 0.         01240000
               10 PA-SLS-RTL-AMT-TOT     PIC S9(13)V99 VALUE 0.         01250000
                                                                        01260000
       01  PD-PROGRAM-DISPLAYS.                                         01270000
           05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01280000
           05  PD-DISPLAY-TOTAL          PIC  Z,ZZZ,ZZZ,ZZZ,ZZ9.99-.    01290000
                                                                        01300000
       01  SAVE-AREA.                                                   01310000
           05  SV-PRIMARY-KEY.                                          01320000
               10  SV-FSCL-WK-END-DTE    PIC X(10)  VALUE SPACE.        01330000
W20445         10  SV-DEPT-NBR           PIC S9(04)V COMP-3.            01340000
W20445         10  SV-SUB-CL-NBR         PIC S9(04)V COMP-3.            01350000
               10  SV-STR-NBR            PIC S9(04) COMP VALUE 0.       01360000
           05  SV-UPDATE-FIELDS.                                        01370000
               10  SV-SLS-RTL-AMT        PIC S9(11)V99  COMP-3 VALUE +0.01380000
                                                                        01390000
      ******************************************************************01400000
      * INRD020 - WEEKLY SALES TRANSACTION LAYOUT                       01410000
      ******************************************************************01420000
W20445     COPY INRD020.                                                01430000
                                                                        01440000
      ******************************************************************01450000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                01460000
      ******************************************************************01470000
           COPY DPWS004.                                                01480000
                                                                        01490000
      ******************************************************************01500000
      *  USED FOR DB2 ERRORS                                            01510000
      ******************************************************************01520000
           EXEC SQL                                                     01530000
               INCLUDE SQLCA                                            01540000
           END-EXEC.                                                    01550000
                                                                        01560000
W33304******************************************************************01561002
W33304* DCLGEN FOR TINVPAR                                              01562002
W33304******************************************************************01563002
W33304     EXEC SQL                                                     01564002
W33304         INCLUDE TINVPAR                                          01565002
W33304     END-EXEC.                                                    01566002
W33304                                                                  01567002
W33304******************************************************************01568002
W33304* DCLGEN FOR TINCNTL                                              01569002
W33304******************************************************************01569102
W33304     EXEC SQL                                                     01569202
W33304         INCLUDE TINCNTL                                          01569302
W33304     END-EXEC.                                                    01569402
W33304                                                                  01569502
W33304******************************************************************01569605
W33304* DCLGEN FOR TDTATTR                                              01569705
W33304******************************************************************01569805
W33304     EXEC SQL                                                     01569905
W33304         INCLUDE TDTATTR                                          01570005
W33304     END-EXEC.                                                    01570105
W33304                                                                  01570205
      ******************************************************************01571005
      *  INVENTORY WEEKLY SHINK TABLE                                   01580000
      ******************************************************************01590000
           EXEC SQL                                                     01600000
W34517***      INCLUDE TINSHNK                                          01610000
W34517         INCLUDE INT00006                                         01620000
           END-EXEC.                                                    01630000
                                                                        01640000
      ***************************************************************** 01650000
      * DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01660000
      ***************************************************************** 01670000
           EXEC SQL                                                     01680000
               INCLUDE TCKRSTCN                                         01690000
           END-EXEC.                                                    01700000
                                                                        01710000
           EXEC SQL                                                     01720000
               INCLUDE TCKRSTIN                                         01730000
           END-EXEC.                                                    01740000
                                                                        01750000
                                                                        01760000
       01  CR-CHECKPOINT-RESTART-AREA.                                  01770000
W20445     05  CR-AREA-LEN                  PIC S9(04) VALUE +27  COMP. 01780000
           05  CR-CHECKPOINT-RESTART-VAR.                               01790000
W20445         10  CR-PREV-DTL-KEY          PIC  X(18) VALUE SPACES.    01800000
               10  FILLER REDEFINES CR-PREV-DTL-KEY.                    01810000
                   15  CR-FISCAL-WK-END-DTE PIC  X(10).                 01820000
W20445             15  CR-DEPT-NBR          PIC  S9(04)V COMP-3.        01830000
W20445             15  CR-SUB-CL-NBR        PIC  S9(04)V COMP-3.        01840000
                   15  CR-STR-NBR           PIC  S9(04) COMP.           01850000
               10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    01860000
                                                                        01870000
       01  CK-CHECKPOINT-SAVE-AREA.                                     01880000
W20445     05  CK-SAVE-PREV-KEY         PIC  X(18) VALUE SPACES.        01890000
           05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       01900000
               10  CK-FISCAL-WK-END-DTE PIC  X(10).                     01910000
W20445         10  CK-DEPT-NBR          PIC  S9(04)V COMP-3.            01920000
W20445         10  CK-SUB-CL-NBR        PIC  S9(04)V COMP-3.            01930000
               10  CK-STR-NBR           PIC  S9(04) COMP.               01940000
                                                                        01950000
      *-------------------*                                             01960000
       PROCEDURE DIVISION.                                              01970000
      *-------------------*                                             01980000
                                                                        01990000
       0000-INKUP302.                                                   02000000
                                                                        02010000
           PERFORM 1000-INITIALIZATION.                                 02020000
                                                                        02030000
           PERFORM 2000-PROCESS-INPUT                                   02040000
                UNTIL PS-EOF-CONDENSED-FILE.                            02050000
                                                                        02060000
           PERFORM 8000-EOJ-ROUTINE.                                    02070000
                                                                        02080000
           STOP RUN.                                                    02090000
                                                                        02100000
      ******************************************************************02110000
      * OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02120000
      * PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02130000
      ******************************************************************02140000
                                                                        02150000
       1000-INITIALIZATION.                                             02160000
                                                                        02170000
           OPEN INPUT CONDENSED-FILE.                                   02180000
                                                                        02190000
           PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02200000
                                                                        02210000
      * CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02220000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02230000
                PERFORM 7500-SELECT-RESTART-INFO                        02240000
                MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                   02250000
                                             CR-CHECKPOINT-RESTART-VAR  02260000
                MOVE CR-PREV-DTL-KEY          TO CK-SAVE-PREV-KEY       02270000
           ELSE                                                         02280000
               SET PS-FIRST-COMMIT TO TRUE                              02290000
               INITIALIZE CR-CHECKPOINT-RESTART-VAR                     02300000
           END-IF.                                                      02310000
                                                                        02320000
           PERFORM 4000-READ-CONDENSED-FILE UNTIL                       02330000
              (PA-INPUT-COUNT > CR-INPUT-READ-COUNT)                    02340000
               OR                                                       02350000
               PS-EOF-CONDENSED-FILE.                                   02360000
                                                                        02370000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02380000
               DISPLAY 'FISCAL WEEK  END DATE ' IN020-FSCL-MN-END-DTE   02390000
               DISPLAY 'DEPARTMENT NBR        ' IN020-DEPT-NBR          02400000
               DISPLAY 'SUB CLASS NBR         ' IN020-SUB-CL-NBR        02410000
               DISPLAY 'STORE NBR             ' IN020-STR-NBR           02420000
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              02430000
                        PA-INPUT-COUNT                                  02440000
           END-IF.                                                      02450000
                                                                        02460000
           IF PS-EOF-CONDENSED-FILE                                     02470000
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       02480000
                   CONTINUE                                             02490000
               ELSE                                                     02500000
                   DISPLAY '** NO RECORDS ON INPUT FILE **'             02510000
           ELSE                                                         02520000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        02530000
               DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                  02540000
                    TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'             02550000
           END-IF.                                                      02560000
                                                                        02570000
      ******************************************************************02580000
      * PROCESS THE SORTED/CONDENSED FILE - UPDATE OR INSERT AS NEEDED  02590000
      ******************************************************************02600000
       2000-PROCESS-INPUT.                                              02610000
                                                                        02620000
           MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          02630000
                                                                        02640000
W33304     PERFORM 2200-SELECT-INV-DATES.                               02650002
W33304     IF PS-SKIP-RECORD-YES                                        02650104
W33304        ADD 1 TO PA-SKIP-COUNT                                    02650204
W33304     ELSE                                                         02650304
              PERFORM 7000-SELECT-DB-ROW                                02652004
                                                                        02660004
W33304        IF PS-PROGRAM-DEADLOCKED                                  02670009
W33304            CONTINUE                                              02680009
W33304        ELSE                                                      02690009
W33304            EVALUATE TRUE                                         02700009
W33304                WHEN PI-UPDATE-INSHNK-ROW                         02710009
W33304                    PERFORM 7100-UPDATE-INSHNK-ROW                02720009
W33304                WHEN PI-INSERT-INSHNK-ROW                         02730009
W33304                    PERFORM 7200-INSERT-INSHNK-ROW                02740009
W33304                WHEN OTHER                                        02750009
W33304                    MOVE '7000-SELECT-DB-ROW' TO PV-PARAGRAPH-NAME02760009
W33304                    MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED      02770009
W33304                    PERFORM 9999-SQL-ABEND                        02780009
W33304            END-EVALUATE                                          02790009
W33304        END-IF                                                    02801007
W33304     END-IF.                                                      02802004
                                                                        02810000
           IF PS-PROGRAM-DEADLOCKED                                     02820000
               CONTINUE                                                 02830000
           ELSE                                                         02840000
               PERFORM 7700-COMMIT-PROCESSING                           02850000
               PERFORM 4000-READ-CONDENSED-FILE                         02860000
           END-IF.                                                      02870000
                                                                        02880000
      ******************************************************************02890000
      * CALCULATE FIELDS FOR UPDATE OF DATABASE                         02900000
      ******************************************************************02910000
       2100-CALCULATE-UPDATES.                                          02920000
      * ADD DB2 TABLE ROW VALUES TO CURRENT INPUT RECORD ROW VALUES     02930000
                                                                        02940000
           COMPUTE SV-SLS-RTL-AMT       =                               02950000
W34517*            INSHNK-SLS-RTL-AMT      + IN020-SLS-RTL-AMT.         02960000
W34517             INT00006-SLS-RTL-AMT    + IN020-SLS-RTL-AMT.         02970000
                                                                        02980000
           ADD IN020-SLS-RTL-AMT      TO PA-SLS-RTL-AMT-IN.             02990000
           ADD SV-SLS-RTL-AMT         TO PA-SLS-RTL-AMT-TOT.            03000000
                                                                        03010000
W33304******************************************************************03011002
W33304* SELECT OPN_FSCL_MN_DTE AND PLND_INV_DTE FROM INV TABLES         03012002
W33304******************************************************************03013002
W33304 2200-SELECT-INV-DATES.                                           03014002
W33304                                                                  03016002
W33304     EXEC SQL                                                     03017002
W33304       SELECT B.OPN_FSCL_MN_DTE                                   03018002
W33304             ,A.PLND_INV_DTE                                      03018102
W33304         INTO :INCNTL-OPN-FSCL-MN-DTE                             03019002
W33304             ,:INVPAR-PLND-INV-DTE                                03019102
W33304         FROM TINVPAR A                                           03019202
W33304             ,TINCNTL B                                           03019302
W33304        WHERE B.ACTV_IND = 'Y'                                    03019402
W33304          AND A.INV_ID = B.INV_ID                                 03019502
W33304          AND A.LOC_INV_STAT_CDE = 'IN'                           03019602
W33304          AND A.LOC_NBR = :IN020-STR-NBR                          03019702
W33304          AND A.ACTL_FIN_BK_DTE = '9999-09-09'                    03019802
W33304     END-EXEC                                                     03019902
W33304                                                                  03020002
W33304     EVALUATE SQLCODE                                             03020102
W33304         WHEN 0                                                   03020202
W33304             PERFORM 2300-SELECT-FSCL-WK-END-DTE                  03020302
W33304         WHEN +100                                                03020402
W33304             SET PS-SKIP-RECORD-YES TO TRUE                       03020502
W33304         WHEN OTHER                                               03020602
W33304             MOVE PE-MSG-08            TO PV-OPERATION-ATTEMPTED  03020702
W33304             MOVE '2200-SELECT-INV-DATES'                         03020802
W33304                                       TO PV-PARAGRAPH-NAME       03020902
W33304             PERFORM 9999-SQL-ABEND                               03021002
W33304     END-EVALUATE.                                                03021102
W33304******************************************************************03021202
W33304* SELECT FSCL_WK_END_DTE FROM TDTATTR USING PLND_INV_DTE          03021402
W33304******************************************************************03021502
W33304 2300-SELECT-FSCL-WK-END-DTE.                                     03021602
W33304                                                                  03021802
W33304     EXEC SQL                                                     03021902
W33304       SELECT FSCL_WK_END_DTE                                     03022002
W33304         INTO :DTATTR-FSCL-WK-END-DTE                             03022102
W33304         FROM TDTATTR                                             03022302
W33304        WHERE KY_DTE = :INVPAR-PLND-INV-DTE                       03022502
W33304     END-EXEC                                                     03023002
W33304                                                                  03023102
W33304     EVALUATE SQLCODE                                             03023202
W33304         WHEN 0                                                   03023302
W33304             CONTINUE                                             03023402
W33304         WHEN +100                                                03023502
W33304             SET PS-SKIP-RECORD-YES TO TRUE                       03023602
W33304         WHEN OTHER                                               03023702
W33304             MOVE PE-MSG-09            TO PV-OPERATION-ATTEMPTED  03023802
W33304             MOVE '2300-SELECT-FSCL-WK-END-DTE'                   03023902
W33304                                       TO PV-PARAGRAPH-NAME       03024002
W33304             PERFORM 9999-SQL-ABEND                               03024102
W33304     END-EVALUATE.                                                03024202
      ******************************************************************03025002
W34517* READS THE CONDENSED FILE INTO THE TINSHNK LAYOUT                03030000
      ******************************************************************03040000
       4000-READ-CONDENSED-FILE.                                        03050000
           READ CONDENSED-FILE INTO IN020-UPDATE-REC                    03060000
              AT END                                                    03070000
                MOVE 'Y' TO PS-EOF-CONDENSED-FILE-SW.                   03080000
                                                                        03090000
W33304     SET PS-SKIP-RECORD-NO TO TRUE.                               03091008
W33304                                                                  03092009
           IF PS-EOF-CONDENSED-FILE                                     03100000
               MOVE IN020-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   03110000
               MOVE IN020-DEPT-NBR            TO CR-DEPT-NBR            03120000
               MOVE IN020-SUB-CL-NBR          TO CR-SUB-CL-NBR          03130000
               MOVE IN020-STR-NBR             TO CR-STR-NBR             03140000
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    03150000
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  03160000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       03170000
                                             TCKRSTINF-WORK-STRG-DESC   03180000
               EXEC SQL                                                 03190000
                 UPDATE TCKRSTINF                                       03200000
                    SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      03210000
                  WHERE JOB_NAME   = :PC-JOB-NAME                       03220000
                    AND PLAN_NAME  = :PC-PROGRAM-NAME                   03230000
               END-EXEC                                                 03240000
               IF SQLCODE = 0                                           03250000
                   CONTINUE                                             03260000
               ELSE                                                     03270000
                   MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  03280000
                   MOVE '* 4000-READ-CONDENSED-FILE *' TO               03290000
                        PV-PARAGRAPH-NAME                               03300000
                   PERFORM 9999-SQL-ABEND                               03310000
               END-IF                                                   03320000
           ELSE                                                         03330000
               ADD 1                         TO PA-INPUT-COUNT          03340000
           END-IF.                                                      03350000
                                                                        03360000
      ******************************************************************03370000
      * SELECT A ROW FROM THE MONTHLY INV  TABLE THAT MATCHES INPUT KEY 03380000
      *   SQLCODE FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT      03390000
      ******************************************************************03400000
       7000-SELECT-DB-ROW.                                              03410000
                                                                        03420000
W33304     MOVE DTATTR-FSCL-WK-END-DTE TO INT00006-FSCL-WK-END-DTE.     03451002
W33304     MOVE IN020-FSCL-MN-END-DTE  TO INT00006-ML-PSTG-MN-END-DTE.  03452002
W33304     MOVE INCNTL-OPN-FSCL-MN-DTE TO INT00006-FSCL-MN-END-DTE.     03453003
W20445                                                                  03460000
W20445     MOVE IN020-DEPT-NBR        TO PV-EDIT-DEPT-NBR.              03470000
W34517***  MOVE PV-EDIT-DEPT-NBR-RED  TO INSHNK-DEPT-NBR.               03480000
W34517     MOVE PV-EDIT-DEPT-NBR-RED  TO INT00006-DEPT-NBR.             03490000
W20445                                                                  03500000
W20445     MOVE IN020-SUB-CL-NBR      TO PV-EDIT-SUB-CLASS.             03510000
W34517**** MOVE PV-EDIT-CLASS-P2      TO INSHNK-SUB-CL-NBR.             03520000
W34517     MOVE PV-EDIT-CLASS-P2      TO INT00006-SUB-CL-NBR.           03530000
W20445                                                                  03540000
W34517**** MOVE IN020-STR-NBR         TO INSHNK-STR-NBR.                03550000
W34517     MOVE IN020-STR-NBR         TO INT00006-STR-NBR.              03560000
W20445                                                                  03570000
           EXEC SQL                                                     03580000
               SELECT SLS_RTL_AMT                                       03590000
W34517******   INTO :INSHNK-SLS-RTL-AMT                                 03600000
W34517         INTO :INT00006-SLS-RTL-AMT                               03610000
W34517******   FROM TINSHNK                                             03620000
W34517         FROM INT_INV_SHRK                                        03630000
W34517*****   WHERE   FSCL_WK_END_DTE     = :INSHNK-FSCL-WK-END-DTE     03640000
W34517*****     AND   DEPT_NBR            = :INSHNK-DEPT-NBR            03650000
W34517*****     AND   SUB_CL_NBR          = :INSHNK-SUB-CL-NBR          03660000
W34517*****     AND   STR_NBR             = :INSHNK-STR-NBR             03670000
W34517        WHERE   FSCL_WK_END_DTE     = :INT00006-FSCL-WK-END-DTE   03680000
W34517          AND   DEPT_NBR            = :INT00006-DEPT-NBR          03690000
W34517          AND   SUB_CL_NBR          = :INT00006-SUB-CL-NBR        03700000
W34517          AND   STR_NBR             = :INT00006-STR-NBR           03710000
W33304          AND   ML_PSTG_MN_END_DTE  = :INT00006-ML-PSTG-MN-END-DTE03711003
           END-EXEC.                                                    03720000
                                                                        03730000
           EVALUATE SQLCODE                                             03740000
               WHEN 0                                                   03750000
                   SET PI-UPDATE-INSHNK-ROW       TO TRUE               03760000
               WHEN +100                                                03770000
                   SET PI-INSERT-INSHNK-ROW       TO TRUE               03780000
               WHEN -911                                                03790000
                   ADD +1             TO PV-DEADLOCK-COUNT              03800000
                   DISPLAY 'DEADLOCK -911 IN 7000-SELECT-DB-ROW'        03810000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03820000
                       MOVE '7000-SELECT-DB-ROW' TO                     03830000
                                                    PV-PARAGRAPH-NAME   03840000
W34517****             MOVE 'SELECT AGAINST TINSHNK'                    03850000
W34517                 MOVE 'SELECT AGAINST INT00006'                   03860000
                                      TO PV-OPERATION-ATTEMPTED         03870000
                       PERFORM 9000-DEADLOCK-ERROR                      03880000
                   ELSE                                                 03890000
                       PERFORM 7999-RESTART-PROCESS                     03900000
                   END-IF                                               03910000
               WHEN OTHER                                               03920000
                   MOVE '7000-SELECT-DB-ROW'   TO PV-PARAGRAPH-NAME     03930000
                   MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             03940000
                   PERFORM 9999-SQL-ABEND                               03950000
           END-EVALUATE.                                                03960000
                                                                        03970000
                                                                        03980000
      ***************************************************************** 03990000
      * THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO, DEPT  04000000
      * SUB CLASS AND STORE. CURRENT TABLE VALUES UPDATED TO INCLUDE    04010000
      * VALUES FROM INPUT REC MLRD020                                   04020000
      ***************************************************************** 04030000
       7100-UPDATE-INSHNK-ROW.                                          04040000
                                                                        04050000
           PERFORM 2100-CALCULATE-UPDATES.                              04060000
                                                                        04070000
W20445                                                                  04100000
W20445     MOVE IN020-DEPT-NBR        TO PV-EDIT-DEPT-NBR.              04110000
W34517**** MOVE PV-EDIT-DEPT-NBR-RED  TO INSHNK-DEPT-NBR.               04120000
W34517     MOVE PV-EDIT-DEPT-NBR-RED  TO INT00006-DEPT-NBR.             04130000
W20445                                                                  04140000
W20445     MOVE IN020-SUB-CL-NBR      TO PV-EDIT-SUB-CLASS.             04150000
W34517**** MOVE PV-EDIT-CLASS-P2      TO INSHNK-SUB-CL-NBR.             04160000
W34517     MOVE PV-EDIT-CLASS-P2      TO INT00006-SUB-CL-NBR.           04170000
W20445                                                                  04180000
W34517*    MOVE IN020-STR-NBR         TO INSHNK-STR-NBR.                04190000
W34517     MOVE IN020-STR-NBR         TO INT00006-STR-NBR.              04200000
W20445                                                                  04210000
PLJ  **************************************                             04220000
           EXEC SQL                                                     04230000
W34517*****   UPDATE TINSHNK                                            04240000
W34517        UPDATE INT_INV_SHRK                                       04250000
              SET SLS_RTL_AMT         = :SV-SLS-RTL-AMT                 04260000
W34517****    WHERE   FSCL_WK_END_DTE     = :INSHNK-FSCL-WK-END-DTE     04270000
W34517****      AND   DEPT_NBR            = :INSHNK-DEPT-NBR            04280000
W34517****      AND   SUB_CL_NBR          = :INSHNK-SUB-CL-NBR          04290000
W34517****      AND   STR_NBR             = :INSHNK-STR-NBR             04300000
W34517        WHERE   FSCL_WK_END_DTE     = :INT00006-FSCL-WK-END-DTE   04310000
W34517          AND   DEPT_NBR            = :INT00006-DEPT-NBR          04320000
W34517          AND   SUB_CL_NBR          = :INT00006-SUB-CL-NBR        04330000
W34517          AND   STR_NBR             = :INT00006-STR-NBR           04340000
W33304          AND   ML_PSTG_MN_END_DTE  = :INT00006-ML-PSTG-MN-END-DTE04341003
           END-EXEC                                                     04350000
                                                                        04360000
                                                                        04370000
           EVALUATE SQLCODE                                             04380000
               WHEN 0                                                   04390000
                   ADD 1 TO PA-UPDATE-COUNT                             04400000
               WHEN -911                                                04410000
                   ADD +1             TO PV-DEADLOCK-COUNT              04420000
                   DISPLAY 'DEADLOCK -911 IN 7100-UPDATE-INSHNK-ROW'    04430000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04440000
                       MOVE '7100-UPDATE-INSHNK-ROW' TO                 04450000
                                                    PV-PARAGRAPH-NAME   04460000
W34517****             MOVE 'UPDATE AGAINST TINSHNK'                    04470000
W34517                 MOVE 'UPDATE AGAINST INT00006'                   04480000
                                      TO PV-OPERATION-ATTEMPTED         04490000
                       PERFORM 9000-DEADLOCK-ERROR                      04500000
                   ELSE                                                 04510000
                       PERFORM 7999-RESTART-PROCESS                     04520000
                   END-IF                                               04530000
               WHEN OTHER                                               04540000
                   MOVE '7100-UPDATE-INSHNK-ROW' TO PV-PARAGRAPH-NAME   04550000
                   MOVE PE-MSG-02              TO PV-OPERATION-ATTEMPTED04560000
                   PERFORM 9999-SQL-ABEND                               04570000
           END-EVALUATE.                                                04580000
                                                                        04590000
      ***************************************************************** 04600000
      * THERE WAS NO MATCHING ROW ON THE MONTHLY INCL TABLE. INITIAL  * 04610000
      * - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 04620000
      * - CALCULATED FIELDS ARE INITIALLY SET TO 0 AND UPDATED IN RECALC04630000
      ***************************************************************** 04640000
       7200-INSERT-INSHNK-ROW.                                          04650000
                                                                        04660000
W20445                                                                  04690000
W20445     MOVE IN020-DEPT-NBR         TO PV-EDIT-DEPT-NBR.             04700000
W34517**** MOVE PV-EDIT-DEPT-NBR-RED   TO INSHNK-DEPT-NBR.              04710000
W34517     MOVE PV-EDIT-DEPT-NBR-RED   TO INT00006-DEPT-NBR.            04720000
W20445                                                                  04730000
W20445     MOVE IN020-SUB-CL-NBR       TO PV-EDIT-SUB-CLASS.            04740000
W34517**** MOVE PV-EDIT-CLASS-P2       TO INSHNK-SUB-CL-NBR.            04750000
W34517     MOVE PV-EDIT-CLASS-P2       TO INT00006-SUB-CL-NBR.          04760000
W20445                                                                  04770000
W34517*    MOVE IN020-STR-NBR          TO INSHNK-STR-NBR.               04780000
W34517     MOVE IN020-STR-NBR          TO INT00006-STR-NBR.             04790000
W20445                                                                  04820000
W34517***  MOVE IN020-SLS-RTL-AMT      TO INSHNK-SLS-RTL-AMT.           04830000
W34517     MOVE IN020-SLS-RTL-AMT      TO INT00006-SLS-RTL-AMT.         04840000
W20445                                                                  04850000
                                                                        04860000
           EXEC SQL                                                     04870000
W34517*****    INSERT INTO TINSHNK                                      04880000
W34517         INSERT INTO INT_INV_SHRK                                 04890000
                   (   FSCL_WK_END_DTE                                  04900000
W33304               , ML_PSTG_MN_END_DTE                               04901003
                     , DEPT_NBR                                         04910000
                     , SUB_CL_NBR                                       04920000
                     , STR_NBR                                          04930000
                     , FSCL_MN_END_DTE                                  04940000
                     , SLS_RTL_AMT                                      04950000
                     , SHNK_RTL_AMT)                                    04960000
               VALUES                                                   04970000
W34517*            (   :INSHNK-FSCL-WK-END-DTE                          04980000
W34517*              , :INSHNK-DEPT-NBR                                 04990000
W34517*              , :INSHNK-SUB-CL-NBR                               05000000
W34517*              , :INSHNK-STR-NBR                                  05010000
W34517*              , :INSHNK-FSCL-MN-END-DTE                          05020000
W34517*              , :INSHNK-SLS-RTL-AMT                              05030000
W34517             (   :INT00006-FSCL-WK-END-DTE                        05040000
W33304               , :INT00006-ML-PSTG-MN-END-DTE                     05050003
W34517               , :INT00006-DEPT-NBR                               05051003
W34517               , :INT00006-SUB-CL-NBR                             05060000
W34517               , :INT00006-STR-NBR                                05070000
W34517               , :INT00006-FSCL-MN-END-DTE                        05080000
W34517               , :INT00006-SLS-RTL-AMT                            05090000
                     , 0                       )                        05100000
           END-EXEC.                                                    05110000
                                                                        05120000
PLJ******* MOVE ZERO TO SQLCODE.                                        05130000
                                                                        05140000
           EVALUATE SQLCODE                                             05150000
               WHEN 0                                                   05160000
                   ADD 1 TO PA-INSERT-COUNT                             05170000
                   ADD IN020-SLS-RTL-AMT      TO PA-SLS-RTL-AMT-IN      05180000
               WHEN -911                                                05190000
                   ADD +1             TO PV-DEADLOCK-COUNT              05200000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              05210000
                       MOVE '7200-INSERT-INSHNK-ROW' TO                 05220000
                                                    PV-PARAGRAPH-NAME   05230000
W34517*****            MOVE 'INSERT AGAINST TINSHNK'                    05240000
W34517                 MOVE 'INSERT AGAINST INT00006'                   05250000
                                      TO PV-OPERATION-ATTEMPTED         05260000
                       PERFORM 9000-DEADLOCK-ERROR                      05270000
                   ELSE                                                 05280000
                       PERFORM 7999-RESTART-PROCESS                     05290000
                   END-IF                                               05300000
               WHEN OTHER                                               05310000
                   DISPLAY 'WK DTE ' IN020-FSCL-WK-END-DTE              05320000
                   DISPLAY 'DEPT   ' IN020-DEPT-NBR                     05330000
                   DISPLAY 'SUB CL ' IN020-SUB-CL-NBR                   05340000
                   DISPLAY 'STR    ' IN020-STR-NBR                      05350000
                   DISPLAY 'MN DTE ' IN020-FSCL-MN-END-DTE              05360000
                   DISPLAY 'SLS AMT ' IN020-SLS-RTL-AMT                 05370000
                   MOVE '7200-INSERT-INSHNK-ROW' TO PV-PARAGRAPH-NAME   05380000
                   MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED05390000
                   PERFORM 9999-SQL-ABEND                               05400000
           END-EVALUATE.                                                05410000
                                                                        05420000
      ******************************************************************05430000
      * 7300-GET-COMMIT-TIMESTAMP.                                     *05440000
      * PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *05450000
      *            CONTROL TABLE                                       *05460000
      ******************************************************************05470000
       7300-GET-COMMIT-TIMESTAMP.                                       05480000
                                                                        05490000
      * CHECKPOINT TAKEN BASED ON DB2 CHECKPOINT RESTART TABLE          05500000
           EXEC SQL                                                     05510000
             SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       05520000
               INTO :PV-COMMIT-TIMESTAMP                                05530000
               FROM TCKRSTCNTL                                          05540000
              WHERE JOB_NAME  = :PC-JOB-NAME                            05550000
                AND PLAN_NAME = :PC-PROGRAM-NAME                        05560000
           END-EXEC.                                                    05570000
                                                                        05580000
           EVALUATE TRUE                                                05590000
               WHEN SQLCODE = 0                                         05600000
      **     DISPLAY 'NEXT COMMIT AT TIMESTAMP: ', PV-COMMIT-TIMESTAMP  05610000
                   CONTINUE                                             05620000
               WHEN SQLCODE NOT EQUAL ZERO                              05630000
                   MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME05640000
                   MOVE 'SELECT TMSTMP FROM TCKRSTCNTL'                 05650000
                                      TO PV-OPERATION-ATTEMPTED         05660000
                   PERFORM 9999-SQL-ABEND                               05670000
           END-EVALUATE.                                                05680000
                                                                        05690000
      ******************************************************************05700000
      * 7400-INIT-CHECKPOINT-SELECT                                    *05710000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *05720000
      *            IF WE ARE IN A RESTART CONDITION.                   *05730000
      ******************************************************************05740000
       7400-INIT-CHECKPOINT-SELECT.                                     05750000
                                                                        05760000
           EXEC SQL                                                     05770000
             SELECT  CKPT_STAT_CODE                                     05780000
                    ,CKPT_FRQNCY_QTY                                    05790000
               INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         05800000
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        05810000
               FROM  TCKRSTCNTL                                         05820000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           05830000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       05840000
           END-EXEC.                                                    05850000
                                                                        05860000
           IF SQLCODE = 0                                               05870000
               CONTINUE                                                 05880000
           ELSE                                                         05890000
               MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  05900000
               MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     05910000
               PERFORM 9999-SQL-ABEND                                   05920000
           END-IF.                                                      05930000
                                                                        05940000
      ******************************************************************05950000
      * 7500-SELECT-RESTART-INFO                                       *05960000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *05970000
      *            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *05980000
      ******************************************************************05990000
       7500-SELECT-RESTART-INFO.                                        06000000
                                                                        06010000
           EXEC SQL                                                     06020000
             SELECT  WORK_STRG_DESC                                     06030000
               INTO  :TCKRSTINF-WORK-STRG-DESC                          06040000
               FROM  TCKRSTINF                                          06050000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           06060000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       06070000
           END-EXEC.                                                    06080000
                                                                        06090000
           IF SQLCODE = 0                                               06100000
               CONTINUE                                                 06110000
           ELSE                                                         06120000
               MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   06130000
               MOVE 'SELECT  FROM TCKRSTINF'                            06140000
                                      TO PV-OPERATION-ATTEMPTED         06150000
               PERFORM 9999-SQL-ABEND                                   06160000
           END-IF.                                                      06170000
                                                                        06180000
      ******************************************************************06190000
      * 7600-SET-CURRENT-TIMESTAMP.                                    *06200000
      * PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *06210000
      ******************************************************************06220000
       7600-SET-CURRENT-TIMESTAMP.                                      06230000
                                                                        06240000
           EXEC SQL                                                     06250000
                SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           06260000
           END-EXEC.                                                    06270000
           IF SQLCODE = 0                                               06280000
               CONTINUE                                                 06290000
           ELSE                                                         06300000
               MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 06310000
               MOVE 'SET TIMESTAMP'                                     06320000
                                      TO PV-OPERATION-ATTEMPTED         06330000
               PERFORM 9999-SQL-ABEND                                   06340000
           END-IF.                                                      06350000
                                                                        06360000
      ******************************************************************06370000
      * 7700-COMMIT-PROCESSING.                                        *06380000
      * PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *06390000
      *          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*06400000
      ******************************************************************06410000
       7700-COMMIT-PROCESSING.                                          06420000
           MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     06430000
                                                                        06440000
           PERFORM 7600-SET-CURRENT-TIMESTAMP.                          06450000
                                                                        06460000
      * PREPARE COMMIT RECORD FOR UPDATE                                06470000
           IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                06480000
               MOVE IN020-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   06490000
               MOVE IN020-DEPT-NBR            TO CR-DEPT-NBR            06500000
               MOVE IN020-SUB-CL-NBR          TO CR-SUB-CL-NBR          06510000
               MOVE IN020-STR-NBR             TO CR-STR-NBR             06520000
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    06530000
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  06540000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       06550000
                                             TCKRSTINF-WORK-STRG-DESC   06560000
               IF PS-FIRST-COMMIT                                       06570000
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                06580000
                   PERFORM 7900-UPDATE-CHECKPOINT-STATUS                06590000
                   MOVE 'N' TO PS-FIRST-COMMIT-SW                       06600000
               END-IF                                                   06610000
               PERFORM 7800-COMMIT-CHANGES                              06620000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        06630000
           END-IF.                                                      06640000
                                                                        06650000
      ******************************************************************06660000
      * 7800-COMMIT-CHANGES.                                            06670000
      * PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      06680000
      *            TAKE A COMMIT.                                       06690000
      *  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    06700000
      ******************************************************************06710000
       7800-COMMIT-CHANGES.                                             06720000
                                                                        06730000
           EXEC SQL                                                     06740000
             UPDATE TCKRSTINF                                           06750000
                SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          06760000
              WHERE JOB_NAME       = :PC-JOB-NAME                       06770000
                AND PLAN_NAME      = :PC-PROGRAM-NAME                   06780000
           END-EXEC.                                                    06790000
                                                                        06800000
           IF SQLCODE = 0                                               06810000
               CONTINUE                                                 06820000
      ****     DISPLAY 'COMMIT TAKEN ==>> ' CR-CHECKPOINT-RESTART-AREA  06830000
      ****             ' <<=='                                          06840000
           ELSE                                                         06850000
               MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED06860000
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06870000
               PERFORM 9999-SQL-ABEND                                   06880000
           END-IF.                                                      06890000
                                                                        06900000
           EXEC SQL                                                     06910000
               COMMIT                                                   06920000
           END-EXEC.                                                    06930000
                                                                        06940000
           IF SQLCODE = 0                                               06950000
               CONTINUE                                                 06960000
           ELSE                                                         06970000
               MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED06980000
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06990000
               PERFORM 9999-SQL-ABEND                                   07000000
           END-IF.                                                      07010000
                                                                        07020000
      ******************************************************************07030000
      * 7900-UPDATE-CHECKPOINT-STATUS                                   07040000
      * PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   07050000
      *                                                                 07060000
      ******************************************************************07070000
       7900-UPDATE-CHECKPOINT-STATUS.                                   07080000
                                                                        07090000
           EXEC SQL                                                     07100000
             UPDATE  TCKRSTCNTL                                         07110000
                SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        07120000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           07130000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       07140000
           END-EXEC.                                                    07150000
                                                                        07160000
           IF SQLCODE = 0                                               07170000
               CONTINUE                                                 07180000
           ELSE                                                         07190000
               MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME07200000
               PERFORM 9999-SQL-ABEND                                   07210000
           END-IF.                                                      07220000
                                                                        07230000
           EJECT                                                        07240000
                                                                        07250000
      ******************************************************************07260000
      * PROGRAM RESTART DUE TO A DEADLOCK AGAINST TINSCL ROW FOR UPDATE 07270000
      *  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  07280000
      ******************************************************************07290000
       7999-RESTART-PROCESS.                                            07300000
                                                                        07310000
           SET PS-PROGRAM-DEADLOCKED TO TRUE.                           07320000
                                                                        07330000
           CLOSE CONDENSED-FILE.                                        07340000
                                                                        07350000
           PERFORM 7500-SELECT-RESTART-INFO.                            07360000
                                                                        07370000
           DISPLAY '**** RESTART **** '.                                07380000
           MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 07390000
           DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   07400000
      *-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      07410000
      *-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        07420000
      *-- RESTART INFORMATION IN NOT CLEARED OUT.                       07430000
           IF PS-FIRST-COMMIT                                           07440000
               INITIALIZE TCKRSTINF-WORK-STRG-DESC (1:28)               07450000
               DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     07460000
                      ' BEGINNING'                                      07470000
           ELSE                                                         07480000
               DISPLAY 'TCKRSTINF-LAST CKPT '                           07490000
                        TCKRSTINF-WORK-STRG-DESC (1:28)                 07500000
      * INFO ON LAST CHECKPOINT TAKEN IS IN CR-CHECKPOINT-RESTART-AREA. 07510000
               MOVE TCKRSTINF-WORK-STRG-DESC TO                         07520000
                    CR-CHECKPOINT-RESTART-AREA                          07530000
               DISPLAY 'CHECKPOINT RESTART INFORMATION:'                07540000
               DISPLAY 'WEEK  END DATE  ' CR-FISCAL-WK-END-DTE          07550000
               DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   07560000
               DISPLAY 'SUB CLASS NBR   ' CR-SUB-CL-NBR                 07570000
               DISPLAY 'STORE NBR       ' CR-STR-NBR                    07580000
               DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           07590000
           END-IF.                                                      07600000
                                                                        07610000
           OPEN INPUT CONDENSED-FILE.                                   07620000
           MOVE ZEROES                          TO PA-INPUT-COUNT.      07630000
                                                                        07640000
      *POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          07650000
           PERFORM 4000-READ-CONDENSED-FILE                             07660000
               UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               07670000
               OR PS-EOF-CONDENSED-FILE.                                07680000
                                                                        07690000
           IF PS-EOF-CONDENSED-FILE                                     07700000
               DISPLAY 'END OF INPUT FILE ON RESTART'                   07710000
           ELSE                                                         07720000
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              07730000
                        PA-INPUT-COUNT                                  07740000
               DISPLAY 'FISCAL MONTH END DATE ' IN020-FSCL-MN-END-DTE   07750000
               DISPLAY 'DEPARTMENT NBR        ' IN020-DEPT-NBR          07760000
               DISPLAY 'SUB CLASS NBR         ' IN020-SUB-CL-NBR        07770000
               DISPLAY 'STORE NBR             ' IN020-STR-NBR           07780000
           END-IF.                                                      07790000
                                                                        07800000
      ******************************************************************07810000
      *  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *07820000
      ******************************************************************07830000
       8000-EOJ-ROUTINE.                                                07840000
                                                                        07850000
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       07860000
           PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       07870000
                                                                        07880000
           DISPLAY 'INPUT RECORDS PROCESSED  ', PA-INPUT-COUNT.         07890000
           DISPLAY 'UPDATES PROCESSED        ', PA-UPDATE-COUNT.        07900000
           DISPLAY 'INSERTS PROCESSED        ', PA-INSERT-COUNT.        07910000
W33304     DISPLAY 'INPUT RECORDS SKIPPED    ', PA-SKIP-COUNT.          07911004
                                                                        07920000
           MOVE PA-SLS-RTL-AMT-IN   TO PD-DISPLAY-TOTAL.                07930000
           DISPLAY 'SLS-RTL-AMT INPUT : ', PD-DISPLAY-TOTAL.            07940000
           MOVE PA-SLS-RTL-AMT-TOT  TO PD-DISPLAY-TOTAL.                07950000
           DISPLAY 'SLS-RTL-AMT TOTAL : ', PD-DISPLAY-TOTAL.            07960000
                                                                        07970000
           CLOSE CONDENSED-FILE.                                        07980000
                                                                        07990000
      ******************************************************************08000000
      *  PERFROMED BY 7100-UPDATE AND 7200-INSERT                       08010000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   08020000
      ******************************************************************08030000
       9000-DEADLOCK-ERROR.                                             08040000
                                                                        08050000
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     08060000
               PERFORM 9999-SQL-ABEND.                                  08070000
                                                                        08080000
      ******************************************************************08090000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               08100000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             08110000
      ******************************************************************08120000
       9999-SQL-ABEND.                                                  08130000
                                                                        08140000
           MOVE +4013                 TO ABEND-CODE.                    08150000
           DISPLAY '**  ABEND     **'.                                  08160000
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              08170000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            08180000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       08190000
                                                                        08200000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         08210000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        08220000
                                                                        08230000
           COPY DPPD004.                                                08240000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           08250000
