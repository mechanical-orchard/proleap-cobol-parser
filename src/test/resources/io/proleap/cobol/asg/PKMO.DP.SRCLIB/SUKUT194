       IDENTIFICATION DIVISION.                                         00010001
       PROGRAM-ID.    SUKUT194.                                         00020002
       AUTHOR.        JIM ARENDT.                                       00030001
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040001
       DATE-WRITTEN.  SEPTEMBER, 2017.                                  00050001
       DATE-COMPILED.                                                   00060001
      ******************************************************************00070001
      *  DB2                                                            00080001
      * RETRIEVE SML INFORMATION                                        00090035
      ******************************************************************00100001
      * DATE: 09/2017 MADE BY:JIM ARENDT  INITIAL IMPLEMENTATION        00110001
      ******************************************************************00120001
       ENVIRONMENT DIVISION.                                            00130001
       CONFIGURATION SECTION.                                           00140001
       SOURCE-COMPUTER.    IBM-3090.                                    00150001
       OBJECT-COMPUTER.    IBM-3090.                                    00160001
       INPUT-OUTPUT SECTION.                                            00170001
       FILE-CONTROL.                                                    00180001
                                                                        00190001
           SELECT INPUT-SML-FILE                                        00200005
                  ASSIGN TO INP01.                                      00210001
                                                                        00220001
           SELECT OUTPUT-SML-FILE                                       00230001
                  ASSIGN TO OUT01.                                      00240001
                                                                        00250001
       DATA DIVISION.                                                   00260001
       FILE SECTION.                                                    00270001
                                                                        00280001
       FD  INPUT-SML-FILE                                               00290005
           RECORDING MODE IS F                                          00300001
           LABEL RECORDS OMITTED                                        00310001
           BLOCK CONTAINS 0 RECORDS                                     00320001
           DATA RECORD IS INPUT-SML-RECORD.                             00330005
       01  INPUT-SML-RECORD                    PIC  X(250).             00340005
                                                                        00350001
       FD  OUTPUT-SML-FILE                                              00360001
           RECORDING MODE IS F                                          00370001
           LABEL RECORDS OMITTED                                        00380001
           BLOCK CONTAINS 0 RECORDS                                     00390001
           DATA RECORD IS OUTPUT-SML-RECORD.                            00400001
       01  OUTPUT-SML-RECORD                   PIC  X(250).             00410005
                                                                        00420001
       WORKING-STORAGE SECTION.                                         00430001
                                                                        00440001
      ******************************************************************00450001
      * PROGRAM CONSTANTS                                               00460001
      ******************************************************************00470001
       01  PC-CONSTANTS-FIELDS.                                         00480001
           05  PC-PGM-NAME                     PIC  X(08) VALUE         00490001
                                                          'SUKUT194'.   00500002
           05  PC-MAX-RETRIES                  PIC S9(03) VALUE +3      00510001
                                                          COMP-3.       00520001
           05  PC-BLANK-TMST                   PIC  X(26) VALUE         00530052
               '0001-01-01-01.01.01.000001'.                            00540006
                                                                        00550001
      ******************************************************************00560001
      * PROGRAM VARIABLES                                               00570001
      ******************************************************************00580001
       01  PV-VARIABLE-FIELDS.                                          00590001
           05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACE.  00600001
           05  PV-DB2-OPERATION                PIC  X(30) VALUE SPACE.  00610001
           05  PV-RETRY-COUNTER                PIC S9(04) VALUE ZEROS   00620001
                                                          COMP SYNC.    00630001
           05  PV-EDIT-FIELD                   PIC  ZZZ,ZZZ,ZZ9.        00640015
           05  PV-TRIP-ID                      PIC S9(09) COMP.         00650001
           05  PV-SHIPT-UNT-ID                 PIC S9(18)V COMP-3.      00660003
           05  PV-PREV-TRN-NBR                 PIC S9(09)  COMP.        00670054
           05  PV-NULL-IND                     PIC S9(04)  VALUE ZERO   00680057
                                                           COMP SYNC.   00690057
           05  PV-CRE-TMST                     PIC  X(26)  VALUE SPACES.00700047
           05  PV-SCAN-TMST                    PIC  X(26)  VALUE SPACES.00710047
           05  PV-DIVERT-TMST                  PIC  X(26)  VALUE SPACES.00720005
           05  PV-HOLD-SCAN-TMST               PIC  X(26)  VALUE SPACES.00730029
           05  PV-HOLD-DIVERT-TMST             PIC  X(26)  VALUE SPACES.00740029
           05  PV-TMST-DETAIL.                                          00750005
               10  PV-TMST-DATE                PIC  X(10)  VALUE SPACES.00760005
               10  FILLER                      PIC  X(01)  VALUE SPACES.00770005
               10  PV-TMST-TIME.                                        00780013
                   15 PV-TMST-HH               PIC  X(02)  VALUE SPACES.00790013
                   15 PV-COLON-1               PIC  X(01)  VALUE SPACES.00800013
                   15 PV-TMST-MM               PIC  X(02)  VALUE SPACES.00810013
                   15 PV-COLON-2               PIC  X(01)  VALUE SPACES.00820013
                   15 PV-TMST-SS               PIC  X(02)  VALUE SPACES.00830013
               10  FILLER                      PIC  X(07)  VALUE SPACES.00840005
                                                                        00850020
      ******************************************************************00860001
      * PROGRAM ACCUMULATORS                                            00870001
      ******************************************************************00880001
       01  PA-PROGRAM-ACCUMULATORS.                                     00890001
           05  PA-INPUT-RECORDS-READ           PIC  9(09) VALUE ZEROS.  00900001
           05  PA-SML-RECORDS-READ             PIC  9(09) VALUE ZEROS.  00910004
           05  PA-SML-NOT-FOUND                PIC  9(09) VALUE ZEROS.  00920038
           05  PA-DTL-RECORDS-READ             PIC  9(09) VALUE ZEROS.  00930004
           05  PA-OUTPUT-RECS-WROTE            PIC  9(09) VALUE ZEROS.  00940001
                                                                        00950001
      ******************************************************************00960001
      * PROGRAM SWITCHES                                                00970001
      ******************************************************************00980001
       01  PS-SWITCH-AREAS.                                             00990001
           05  PS-FIRST-TIME-SW                PIC  X(01) VALUE 'Y'.    01000022
               88  PS-FIRST-TIME-Y                        VALUE 'Y'.    01010001
               88  PS-FIRST-TIME-N                        VALUE 'N'.    01020001
           05  PS-FIRST-SML-SW                 PIC  X(01) VALUE 'Y'.    01030022
               88  PS-FIRST-SML-Y                         VALUE 'Y'.    01040022
               88  PS-FIRST-SML-N                         VALUE 'N'.    01050022
           05  PS-END-OF-INPUT-FILE-SW         PIC  X(01) VALUE 'N'.    01060001
               88  PS-END-OF-INPUT-FILE                   VALUE 'Y'.    01070001
               88  PS-NOT-END-OF-FILE                     VALUE 'N'.    01080001
           05  PS-TMST-CSR-EOF-SW              PIC  X(01) VALUE 'N'.    01090007
               88  PS-TMST-CSR-EOF                        VALUE 'Y'.    01100007
               88  PS-TMST-CSR-NOT-EOF                    VALUE 'N'.    01110007
           05  PS-DTL-CSR-EOF-SW               PIC  X(01) VALUE 'N'.    01120005
               88  PS-DTL-CSR-EOF                         VALUE 'Y'.    01130005
               88  PS-DTL-CSR-NOT-EOF                     VALUE 'N'.    01140005
           05  PS-WRITE-ROW-SW                 PIC  X(01) VALUE 'N'.    01150021
               88  PS-WRITE-ROW-Y                         VALUE 'Y'.    01160030
               88  PS-WRITE-ROW-N                         VALUE 'N'.    01170021
           05  PS-PROCESS-SW                   PIC  X(01) VALUE 'S'.    01180005
               88  PS-PROCESS-SCAN                        VALUE 'S'.    01190005
               88  PS-PROCESS-DIVERT                      VALUE 'D'.    01200005
               88  PS-PROCESS-NOT-FOUND                   VALUE 'N'.    01210020
                                                                        01220001
      ******************************************************************01230001
      * ABEND INFORMATION                                               01240001
      ******************************************************************01250001
       01  ABEND-CODE                          PIC S9(04) VALUE ZEROS   01260001
                                                          COMP SYNC.    01270001
           88  ABEND-4001-WRITE-ERROR                     VALUE +4001.  01280001
           88  ABEND-4002-READ-ERROR                      VALUE +4002.  01290001
           88  ABEND-4003-CTRL-CARD-ERROR                 VALUE +4003.  01300001
           88  ABEND-4004-TABLE-ERROR                     VALUE +4004.  01310001
           88  ABEND-4005-OPEN-ERROR                      VALUE +4005.  01320001
           88  ABEND-4006-CLOSE-ERROR                     VALUE +4006.  01330001
           88  ABEND-4007-SEQUENCE-ERROR                  VALUE +4007.  01340001
           88  ABEND-4008-DATA-ERROR                      VALUE +4008.  01350001
           88  ABEND-4009-KEY-DATA-ERROR                  VALUE +4009.  01360001
           88  ABEND-4013-DB2-ERROR                       VALUE +4013.  01370001
           88  ABEND-4019-CAL-SUB-ERROR                   VALUE +4019.  01380001
           88  ABEND-4020-MQ-ERROR                        VALUE +4020.  01390001
           88  ABEND-4444-FORCED-ABEND                    VALUE +4444.  01400001
                                                                        01410001
      ******************************************************************01420001
      ****ABEND ROUTINE INFORMATION                                     01430001
           COPY SQLCA2.                                                 01440001
                                                                        01450001
      ****ABEND ROUTINE INFORMATION                                     01460001
           COPY DPWS004.                                                01470001
                                                                        01480001
      ****INPUT/OUTPUT COPYBOOK                                         01490005
           COPY SURD163.                                                01500001
                                                                        01510001
      ******************************************************************01520001
      * TABLE INCLUSIONS                                                01530001
      ******************************************************************01540001
      ** SUT_OTBND_STR_SCN TABLE                                        01550048
           EXEC SQL INCLUDE SUT00121 END-EXEC.                          01560048
                                                                        01570048
      ** SUT_OTBND_CART TABLE                                           01580001
           EXEC SQL INCLUDE SUT00024 END-EXEC.                          01590017
                                                                        01600002
      ** SUT_OTBND_LOC                                                  01610002
           EXEC SQL INCLUDE SUT00027 END-EXEC.                          01620002
                                                                        01630002
      ** SUT_OTBND_UPC                                                  01640002
           EXEC SQL INCLUDE SUT00028 END-EXEC.                          01650002
                                                                        01660002
      ** XLT_SKU                                                        01670002
           EXEC SQL INCLUDE XLT00003 END-EXEC.                          01680002
                                                                        01690002
      ** XLT_VND_STYL                                                   01700002
           EXEC SQL INCLUDE XLT00004 END-EXEC.                          01710002
                                                                        01720002
      ** XLT_UPC                                                        01730002
           EXEC SQL INCLUDE XLT00006 END-EXEC.                          01740002
                                                                        01750002
      ** TSUCRDV                                                        01760002
           EXEC SQL INCLUDE TSUCRDV  END-EXEC.                          01770002
                                                                        01780005
      ** TPURCHS                                                        01790005
           EXEC SQL INCLUDE TPURCHS  END-EXEC.                          01800005
                                                                        01810002
      ** DB2 TABLE INCLUSION                                            01820001
           EXEC SQL INCLUDE SQLCA    END-EXEC.                          01830001
                                                                        01840001
      ******************************************************************01850002
      * CURSOR TO RETRIEVE THE DIVERT AND/OR SCAN TIMESTAMP             01860028
      ******************************************************************01870002
           EXEC SQL                                                     01880002
             DECLARE TMST_CSR CURSOR FOR                                01890010
               SELECT                                                   01900028
                      C.DIVERT_TMST                                     01910028
                    , '0001-01-01-01.01.01.000001'                      01920026
                 FROM SUT_OTBND_CART B                                  01930002
                    , TSUCRDV        C                                  01940028
                WHERE B.SHIPT_UNT_ID  = :PV-SHIPT-UNT-ID                01950005
                  AND B.SHIPT_UNT_ID  =  C.SHIPT_UNT_ID                 01960002
                  AND C.ACTV_CDE      = 'A'                             01970002
                  AND C.DIVERT_TMST  IN                                 01980002
                     (SELECT MAX(D.DIVERT_TMST)                         01990002
                        FROM TSUCRDV D                                  02000002
                       WHERE C.SHIPT_UNT_ID  =  D.SHIPT_UNT_ID)         02010002
             UNION                                                      02020026
               SELECT                                                   02030028
                      '0001-01-01-01.01.01.000001'                      02040028
                    , F.CRE_TMST AS SCAN_TMST                           02050028
                 FROM SUT_OTBND_CART E                                  02060025
                    , SUT_OTBND_LOC  F                                  02070025
                WHERE E.SHIPT_UNT_ID  = :PV-SHIPT-UNT-ID                02080025
                  AND E.SHIPT_UNT_ID  = F.SHIPT_UNT_ID                  02090025
                  AND E.OTBND_TRIP_ID = F.OTBND_TRIP_ID                 02100025
                  AND F.SCN_CDE       = 'SHON'                          02110025
                  AND F.ACTV_CDE      = 'A'                             02120025
                 WITH UR                                                02130025
          END-EXEC.                                                     02140002
                                                                        02150002
      ******************************************************************02160005
      * CURSOR TO RETRIEVE THE DETAIL                                   02170020
      ******************************************************************02180005
           EXEC SQL                                                     02190005
             DECLARE DTL_CSR CURSOR FOR                                 02200005
               SELECT A.SHIPT_UNT_ID                                    02210005
                    , A.TRN_NBR                                         02220005
                    , A.RCVR_SEQ_NBR                                    02230005
                    , A.TRN_LNE_NBR                                     02240005
                    , A.TRN_TYP_CDE                                     02250005
                    , A.SHPD_UNT_QTY                                    02260005
                    , C.SKU_NBR                                         02270005
                 FROM SUT_OTBND_UPC A                                   02280005
                    , XLT_UPC       B                                   02290005
                    , XLT_SKU       C                                   02300005
                    , XLT_VND_STYL  D                                   02310005
               WHERE SHIPT_UNT_ID  = :PV-SHIPT-UNT-ID                   02320005
                 AND A.UPC_NBR     =  B.UPC_NBR                         02330005
                 AND B.INTR_UPC_ID =  C.INTR_UPC_ID                     02340005
                 AND C.STYL_ID     =  D.STYL_ID                         02350005
               WITH UR                                                  02360005
          END-EXEC.                                                     02370005
                                                                        02380005
                                                                        02390004
       PROCEDURE DIVISION.                                              02400002
      ******************************************************************02410001
       0000-MAINLINE-PROCESSING.                                        02420001
                                                                        02430001
           PERFORM 1000-INITIALIZATION.                                 02440001
                                                                        02450001
           PERFORM 2000-PROCESS-INPUT-FILE                              02460029
             UNTIL PS-END-OF-INPUT-FILE.                                02470001
                                                                        02480001
           PERFORM 9000-WRAPUP.                                         02490001
                                                                        02500001
           GOBACK.                                                      02510001
                                                                        02520001
      ******************************************************************02530001
      * INITIALIZATION ROUTINE                                          02540001
      ******************************************************************02550001
       1000-INITIALIZATION.                                             02560001
                                                                        02570001
           DISPLAY ' '.                                                 02580001
           DISPLAY '*******************************************'.       02590001
           DISPLAY '***  PROGRAM NAME:  '  PC-PGM-NAME.                 02600001
           DISPLAY ' '.                                                 02610001
                                                                        02620001
           OPEN INPUT  INPUT-SML-FILE                                   02630005
                OUTPUT OUTPUT-SML-FILE.                                 02640001
                                                                        02650001
           PERFORM 1100-READ-INPUT-FILE.                                02660001
                                                                        02670001
                                                                        02680001
      ******************************************************************02690001
      * READ THE INPUT TRIP SML FILE                                    02700004
      ******************************************************************02710001
       1100-READ-INPUT-FILE.                                            02720001
                                                                        02730001
           READ INPUT-SML-FILE INTO SU163-EXTRACT-RECORD                02740005
              AT END                                                    02750001
                 SET PS-END-OF-INPUT-FILE TO TRUE.                      02760001
                                                                        02770001
           IF PS-END-OF-INPUT-FILE                                      02780001
               IF PS-FIRST-TIME-Y                                       02790001
                  DISPLAY ' '                                           02800001
                  DISPLAY '-- INPUT FILE MISSING --'                    02810001
                  DISPLAY ' '                                           02820001
               END-IF                                                   02830001
           ELSE                                                         02840001
               ADD 1                     TO PA-INPUT-RECORDS-READ       02850001
               MOVE SU163-SHIPT-UNIT-ID  TO PV-SHIPT-UNT-ID             02860006
               SET PS-FIRST-TIME-N       TO TRUE                        02870001
           END-IF.                                                      02880001
                                                                        02890001
      ******************************************************************02900001
      * OPEN THE TMST_CSR CURSOR                                        02910056
      ******************************************************************02920001
       1200-OPEN-TMST-CSR.                                              02930007
                                                                        02940001
           EXEC SQL                                                     02950001
             OPEN TMST_CSR                                              02960007
           END-EXEC.                                                    02970001
                                                                        02980001
           EVALUATE TRUE                                                02990001
               WHEN SQLCODE = +0                                        03000001
               WHEN SQLCODE = -904                                      03010001
               WHEN SQLCODE = -911                                      03020001
               WHEN SQLCODE = -913                                      03030001
                    CONTINUE                                            03040001
                                                                        03050001
               WHEN SQLWARN0 NOT EQUAL SPACE                            03060001
               WHEN SQLCODE NOT EQUAL ZERO                              03070001
                    DISPLAY ' ERROR SHIPT-UNT-ID = '                    03080015
                                              PV-SHIPT-UNT-ID           03090015
                    MOVE '1200-OPEN-TMST-CSR'                           03100007
                                           TO PV-PARAGRAPH-NAME         03110001
                    MOVE 'ERROR ON OPEN OF TMST_CSR'                    03120007
                                           TO PV-DB2-OPERATION          03130001
                    SET ABEND-4005-OPEN-ERROR TO TRUE                   03140001
                    PERFORM 9200-SQL-ABEND                              03150001
                                                                        03160001
           END-EVALUATE.                                                03170001
                                                                        03180001
      ******************************************************************03190004
      * OPEN THE DTL_CSR CURSOR                                         03200056
      ******************************************************************03210004
       1250-OPEN-DTL-CSR.                                               03220004
                                                                        03230004
           EXEC SQL                                                     03240004
             OPEN DTL_CSR                                               03250004
           END-EXEC.                                                    03260004
                                                                        03270004
           EVALUATE TRUE                                                03280004
               WHEN SQLCODE = +0                                        03290004
               WHEN SQLCODE = -904                                      03300004
               WHEN SQLCODE = -911                                      03310004
               WHEN SQLCODE = -913                                      03320004
                    CONTINUE                                            03330004
                                                                        03340004
               WHEN SQLWARN0 NOT EQUAL SPACE                            03350004
               WHEN SQLCODE NOT EQUAL ZERO                              03360004
                    DISPLAY ' ERROR SHIPT-UNT-ID = '                    03370015
                                              PV-SHIPT-UNT-ID           03380015
                    MOVE '1250-OPEN-DTL-CSR'                            03390004
                                           TO PV-PARAGRAPH-NAME         03400004
                    MOVE 'ERROR ON OPEN OF DTL_CSR'                     03410004
                                           TO PV-DB2-OPERATION          03420004
                    SET ABEND-4005-OPEN-ERROR TO TRUE                   03430004
                    PERFORM 9200-SQL-ABEND                              03440004
                                                                        03450004
           END-EVALUATE.                                                03460004
                                                                        03470004
      ******************************************************************03480001
      * RETRIEVE THE DIVERT/SCAN TIMESTAMPS FROM THE TMST_CSR CURSOR    03490056
      ******************************************************************03500001
       1300-FETCH-TMST-CSR.                                             03510007
                                                                        03520001
           PERFORM                                                      03530001
               WITH TEST AFTER                                          03540001
               VARYING PV-RETRY-COUNTER                                 03550001
               FROM 1 BY 1                                              03560001
               UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES)                03570001
                   OR (SQLCODE = +0                                     03580001
                   OR  SQLCODE = +100)                                  03590001
                                                                        03600005
               EXEC SQL                                                 03610005
                  FETCH TMST_CSR                                        03620007
                    INTO :PV-DIVERT-TMST                                03630026
                        ,:PV-SCAN-TMST                                  03640026
               END-EXEC                                                 03650005
                                                                        03660018
               EVALUATE TRUE                                            03670019
                   WHEN SQLCODE = ZERO                                  03680001
                       SET PS-WRITE-ROW-Y        TO TRUE                03690031
                       ADD 1                     TO PA-SML-RECORDS-READ 03700004
                                                                        03710001
                   WHEN SQLCODE = +100                                  03720001
                       SET PS-TMST-CSR-EOF       TO TRUE                03730007
                                                                        03740001
                   WHEN SQLCODE = -904                                  03750001
                   WHEN SQLCODE = -911                                  03760001
                   WHEN SQLCODE = -913                                  03770001
                       CONTINUE                                         03780001
                                                                        03790001
                   WHEN SQLWARN0 NOT EQUAL SPACE                        03800001
                   WHEN SQLCODE NOT EQUAL ZERO                          03810001
                       DISPLAY ' ERROR SHIPT-UNT-ID = '                 03820015
                                                     PV-SHIPT-UNT-ID    03830015
                       MOVE '1300-FETCH-TMST-CSR' TO PV-PARAGRAPH-NAME  03840007
                       MOVE 'ERROR ON FETCHING TMST_CSR'                03850007
                                                 TO PV-DB2-OPERATION    03860001
                       SET ABEND-4002-READ-ERROR TO TRUE                03870001
                       PERFORM 9200-SQL-ABEND                           03880001
                                                                        03890001
               END-EVALUATE                                             03900001
           END-PERFORM.                                                 03910001
                                                                        03920001
           IF (PV-RETRY-COUNTER > PC-MAX-RETRIES)                       03930001
               DISPLAY ' ERROR SHIPT-UNT-ID = '    PV-SHIPT-UNT-ID      03940015
               MOVE '1300-FETCH-TMST-CSR'       TO PV-PARAGRAPH-NAME    03950007
               MOVE 'MAX RETRIES EXCEEDED'      TO PV-DB2-OPERATION     03960001
               SET ABEND-4002-READ-ERROR        TO TRUE                 03970001
               PERFORM 9200-SQL-ABEND                                   03980001
           END-IF.                                                      03990001
                                                                        04000001
      ******************************************************************04010004
      * RETRIEVE THE DTL TRAILER DATA FROM THE DTL_CSR CURSOR           04020056
      ******************************************************************04030004
       1350-FETCH-DTL-CSR.                                              04040004
                                                                        04050004
           PERFORM                                                      04060004
               WITH TEST AFTER                                          04070004
               VARYING PV-RETRY-COUNTER                                 04080004
               FROM 1 BY 1                                              04090004
               UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES)                04100004
                   OR (SQLCODE = +0                                     04110004
                   OR  SQLCODE = +100)                                  04120004
                                                                        04130005
               EXEC SQL                                                 04140005
                  FETCH DTL_CSR                                         04150005
                    INTO  :SUT00028-SHIPT-UNT-ID                        04160005
                         ,:SUT00028-TRN-NBR                             04170005
                         ,:SUT00028-RCVR-SEQ-NBR                        04180005
                         ,:SUT00028-TRN-LNE-NBR                         04190005
                         ,:SUT00028-TRN-TYP-CDE                         04200005
                         ,:SUT00028-SHPD-UNT-QTY                        04210005
                         ,:XLT00003-SKU-NBR                             04220005
               END-EXEC                                                 04230005
                                                                        04240004
               EVALUATE TRUE                                            04250004
                   WHEN SQLCODE = ZERO                                  04260004
                       ADD 1                     TO PA-DTL-RECORDS-READ 04270004
                                                                        04280004
                   WHEN SQLCODE = +100                                  04290004
                       SET PS-DTL-CSR-EOF        TO TRUE                04300004
                                                                        04310004
                   WHEN SQLCODE = -904                                  04320004
                   WHEN SQLCODE = -911                                  04330004
                   WHEN SQLCODE = -913                                  04340004
                       CONTINUE                                         04350004
                                                                        04360004
                   WHEN SQLWARN0 NOT EQUAL SPACE                        04370004
                   WHEN SQLCODE NOT EQUAL ZERO                          04380004
                       DISPLAY ' ERROR SHIPT-UNT-ID = '                 04390015
                                                    PV-SHIPT-UNT-ID     04400015
                       MOVE '1350-FETCH-DTL-CSR' TO PV-PARAGRAPH-NAME   04410004
                       MOVE 'ERROR ON FETCHING DTL_CSR'                 04420004
                                                 TO PV-DB2-OPERATION    04430004
                       SET ABEND-4002-READ-ERROR TO TRUE                04440004
                       PERFORM 9200-SQL-ABEND                           04450004
                                                                        04460004
               END-EVALUATE                                             04470004
           END-PERFORM.                                                 04480004
                                                                        04490004
           IF (PV-RETRY-COUNTER > PC-MAX-RETRIES)                       04500004
               DISPLAY ' ERROR SHIPT-UNT-ID = '    PV-SHIPT-UNT-ID      04510015
               MOVE '1350-FETCH-DTL-CSR'        TO PV-PARAGRAPH-NAME    04520004
               MOVE 'MAX RETRIES EXCEEDED'      TO PV-DB2-OPERATION     04530004
               SET ABEND-4002-READ-ERROR        TO TRUE                 04540004
               PERFORM 9200-SQL-ABEND                                   04550004
           END-IF.                                                      04560004
                                                                        04570004
      ******************************************************************04580001
      * PROCESS ALL RECORDS FROM THE INPUT FILE                         04590053
      ******************************************************************04600001
       2000-PROCESS-INPUT-FILE.                                         04610028
                                                                        04620022
           MOVE PC-BLANK-TMST      TO PV-HOLD-SCAN-TMST                 04630052
                                      PV-HOLD-DIVERT-TMST.              04640052
           SET PS-WRITE-ROW-N                                           04650050
               PS-TMST-CSR-NOT-EOF TO TRUE.                             04660050
                                                                        04670029
           PERFORM 1200-OPEN-TMST-CSR.                                  04680007
                                                                        04690001
           PERFORM 1300-FETCH-TMST-CSR.                                 04700030
           IF PS-TMST-CSR-EOF                                           04710007
              ADD 1                TO PA-SML-NOT-FOUND                  04720052
              PERFORM 2700-GET-CRE-TMST                                 04730052
                                                                        04740029
           ELSE                                                         04750029
              PERFORM 2200-PROCESS-TMST-RECORDS                         04760029
                UNTIL PS-TMST-CSR-EOF                                   04770029
           END-IF.                                                      04780028
                                                                        04790044
           PERFORM 3000-CLOSE-TMST-CSR.                                 04800029
                                                                        04810029
           SET PS-FIRST-SML-N      TO TRUE.                             04820052
           PERFORM 2300-PROCESS-SML-RECORDS.                            04830030
                                                                        04840001
           PERFORM 1100-READ-INPUT-FILE.                                04850001
                                                                        04860001
      ******************************************************************04870029
      * LOOP THRU ALL RECORDS IN THE TMST_CSR AND SAVE THE LATEST       04880030
      * DIVERT AND SCAN TIMESTAMPS.                                     04890030
      ******************************************************************04900029
       2200-PROCESS-TMST-RECORDS.                                       04910029
                                                                        04920029
           IF PV-SCAN-TMST > PV-HOLD-SCAN-TMST                          04930029
              MOVE PV-SCAN-TMST    TO PV-HOLD-SCAN-TMST                 04940029
           END-IF.                                                      04950029
                                                                        04960029
           IF PV-DIVERT-TMST > PV-HOLD-DIVERT-TMST                      04970029
               MOVE PV-DIVERT-TMST TO PV-HOLD-DIVERT-TMST               04980029
           END-IF.                                                      04990029
                                                                        05000029
           PERFORM 1300-FETCH-TMST-CSR.                                 05010029
                                                                        05020029
      ******************************************************************05030005
      * PROCESS ALL THE RECORDS IN THE DTL_CSR CURSOR                   05040056
      ******************************************************************05050005
       2300-PROCESS-SML-RECORDS.                                        05060030
                                                                        05070005
           IF PV-HOLD-DIVERT-TMST > PV-HOLD-SCAN-TMST                   05080029
              SET PS-PROCESS-DIVERT       TO TRUE                       05090052
           ELSE                                                         05100005
              IF PV-HOLD-SCAN-TMST > PV-HOLD-DIVERT-TMST                05110029
                 SET PS-PROCESS-SCAN      TO TRUE                       05120052
              ELSE                                                      05130020
                 SET PS-PROCESS-NOT-FOUND TO TRUE                       05140020
              END-IF                                                    05150026
           END-IF.                                                      05160020
                                                                        05170036
           SET PS-DTL-CSR-NOT-EOF   TO TRUE.                            05180005
           MOVE ZEROES              TO PV-PREV-TRN-NBR.                 05190055
           PERFORM 1250-OPEN-DTL-CSR.                                   05200005
                                                                        05210005
           PERFORM 1350-FETCH-DTL-CSR.                                  05220021
           IF PS-DTL-CSR-EOF                                            05230005
              IF PS-WRITE-ROW-Y                                         05240031
                 PERFORM 2450-WRITE-EMPTY-ROW                           05250036
              END-IF                                                    05260036
                                                                        05270005
           ELSE                                                         05280005
              SET PS-WRITE-ROW-N    TO TRUE                             05290021
              PERFORM 2400-PROCESS-DTL-RECORDS                          05300005
                UNTIL PS-DTL-CSR-EOF                                    05310005
                                                                        05320005
           END-IF.                                                      05330005
                                                                        05340005
           PERFORM 3500-CLOSE-DTL-CSR.                                  05350005
                                                                        05360005
      ******************************************************************05370001
      * MANIFEST DETAIL FOUND, POPULATE THE CARTON RECORD               05380056
      ******************************************************************05390001
       2400-PROCESS-DTL-RECORDS.                                        05400005
                                                                        05410001
           IF PS-PROCESS-DIVERT                                         05420005
              SET SU163-DIVERT-TO-TRLR    TO TRUE                       05430005
              MOVE PV-HOLD-DIVERT-TMST    TO PV-TMST-DETAIL             05440029
              MOVE ':'                    TO PV-COLON-1                 05450013
                                             PV-COLON-2                 05460013
              MOVE PV-TMST-DATE           TO SU163-MFST-DATE            05470005
              MOVE PV-TMST-TIME           TO SU163-MFST-TIME            05480005
           ELSE                                                         05490005
              IF PS-PROCESS-SCAN                                        05500020
                 SET SU163-SCAN-ONTO-TRLR TO TRUE                       05510020
                 MOVE PV-HOLD-SCAN-TMST   TO PV-TMST-DETAIL             05520029
                 MOVE ':'                 TO PV-COLON-1                 05530020
                                             PV-COLON-2                 05540020
                 MOVE PV-TMST-DATE        TO SU163-MFST-DATE            05550020
                 MOVE PV-TMST-TIME        TO SU163-MFST-TIME            05560020
              ELSE                                                      05570046
                 IF PV-CRE-TMST = SPACES                                05580059
                    CONTINUE                                            05590057
                 ELSE                                                   05600057
                    MOVE PV-CRE-TMST      TO PV-TMST-DETAIL             05610057
                    MOVE ':'              TO PV-COLON-1                 05620057
                                             PV-COLON-2                 05630046
                    MOVE PV-TMST-DATE     TO SU163-MFST-DATE            05640057
                    MOVE PV-TMST-TIME     TO SU163-MFST-TIME            05650057
                 END-IF                                                 05660057
              END-IF                                                    05670057
           END-IF.                                                      05680047
                                                                        05690005
           MOVE SUT00028-RCVR-SEQ-NBR     TO SU163-RCVR-SEQ-NBR.        05700005
           MOVE SUT00028-TRN-LNE-NBR      TO SU163-TRN-LNE-NBR.         05710005
           MOVE SUT00028-TRN-TYP-CDE      TO SU163-TRN-TYP-CDE.         05720005
           MOVE SUT00028-SHPD-UNT-QTY     TO SU163-SHPD-UNT-QTY.        05730005
           MOVE XLT00003-SKU-NBR          TO SU163-SKU-NBR.             05740005
           MOVE SUT00028-TRN-NBR          TO SU163-TRN-NBR.             05750054
                                                                        05760005
           IF SUT00028-TRN-TYP-CDE = 'PO'                               05770005
              IF SUT00028-TRN-NBR = PV-PREV-TRN-NBR                     05780054
                 MOVE PURCHS-SEASET-YR      TO SU163-SEASET-YR          05790054
                 MOVE PURCHS-SEASET-SHRT-NM TO SU163-SEASET-SHRT-NM     05800054
              ELSE                                                      05810054
                 MOVE SUT00028-TRN-NBR      TO PV-PREV-TRN-NBR          05820054
                 PERFORM 2600-SELECT-SEA-SET                            05830054
                 MOVE PURCHS-SEASET-YR      TO SU163-SEASET-YR          05840054
                 MOVE PURCHS-SEASET-SHRT-NM TO SU163-SEASET-SHRT-NM     05850054
              END-IF                                                    05860054
           ELSE                                                         05870054
              MOVE ZEROES                   TO PV-PREV-TRN-NBR          05880055
           END-IF.                                                      05890054
                                                                        05900001
           PERFORM 2500-WRITE-OUTPUT-RECORD.                            05910021
                                                                        05920001
           PERFORM 1350-FETCH-DTL-CSR.                                  05930005
                                                                        05940001
      ******************************************************************05950021
      * NO MANIFEST DETAIL FOUND, POPULATE THE CARTON RECORD            05960056
      ******************************************************************05970021
       2450-WRITE-EMPTY-ROW.                                            05980021
                                                                        05990021
           IF PS-PROCESS-DIVERT                                         06000021
              SET SU163-DIVERT-TO-TRLR    TO TRUE                       06010021
              MOVE PV-HOLD-DIVERT-TMST    TO PV-TMST-DETAIL             06020029
              MOVE ':'                    TO PV-COLON-1                 06030021
                                             PV-COLON-2                 06040021
              MOVE PV-TMST-DATE           TO SU163-MFST-DATE            06050021
              MOVE PV-TMST-TIME           TO SU163-MFST-TIME            06060021
           ELSE                                                         06070021
              IF PS-PROCESS-SCAN                                        06080021
                 SET SU163-SCAN-ONTO-TRLR TO TRUE                       06090021
                 MOVE PV-HOLD-SCAN-TMST   TO PV-TMST-DETAIL             06100029
                 MOVE ':'                 TO PV-COLON-1                 06110021
                                             PV-COLON-2                 06120021
                 MOVE PV-TMST-DATE        TO SU163-MFST-DATE            06130021
                 MOVE PV-TMST-TIME        TO SU163-MFST-TIME            06140021
              ELSE                                                      06150047
                 IF PV-CRE-TMST = SPACES                                06160059
                    CONTINUE                                            06170058
                 ELSE                                                   06180058
                    MOVE PV-CRE-TMST      TO PV-TMST-DETAIL             06190058
                    MOVE ':'              TO PV-COLON-1                 06200058
                                             PV-COLON-2                 06210047
                    MOVE PV-TMST-DATE     TO SU163-MFST-DATE            06220058
                    MOVE PV-TMST-TIME     TO SU163-MFST-TIME            06230058
                 END-IF                                                 06240058
              END-IF                                                    06250058
           END-IF.                                                      06260021
                                                                        06270021
           PERFORM 2500-WRITE-OUTPUT-RECORD.                            06280021
                                                                        06290021
      ******************************************************************06300001
      * WRITE THE OUTPUT RECORD                                         06310001
      ******************************************************************06320001
       2500-WRITE-OUTPUT-RECORD.                                        06330021
                                                                        06340001
           WRITE OUTPUT-SML-RECORD FROM SU163-EXTRACT-RECORD.           06350001
                                                                        06360001
           ADD +1              TO PA-OUTPUT-RECS-WROTE.                 06370001
                                                                        06380005
      ******************************************************************06390005
      * RETRIEVE THE SEASONAL SET DATA FOR THE PO                       06400005
      ******************************************************************06410005
       2600-SELECT-SEA-SET.                                             06420021
                                                                        06430005
           PERFORM                                                      06440005
               WITH TEST AFTER                                          06450005
               VARYING PV-RETRY-COUNTER                                 06460005
               FROM 1 BY 1                                              06470005
               UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES)                06480005
                   OR (SQLCODE = +0                                     06490005
                   OR  SQLCODE = +100)                                  06500005
                                                                        06510005
               EXEC SQL                                                 06520005
                    SELECT  A.SEASET_YR                                 06530005
                          , A.SEASET_SHRT_NM                            06540005
                      INTO :PURCHS-SEASET-YR                            06550005
                          ,:PURCHS-SEASET-SHRT-NM                       06560005
                      FROM TPURCHS A                                    06570005
                     WHERE A.PO_NBR         = :SUT00028-TRN-NBR         06580005
                       AND A.VER_STATUS_CDE = 'A'                       06590005
                      WITH UR                                           06600033
               END-EXEC                                                 06610005
                                                                        06620005
               EVALUATE TRUE                                            06630005
                   WHEN SQLCODE = ZERO                                  06640005
                   WHEN SQLCODE = +100                                  06650005
                       CONTINUE                                         06660005
                                                                        06670005
                   WHEN SQLCODE = -904                                  06680005
                   WHEN SQLCODE = -911                                  06690005
                   WHEN SQLCODE = -913                                  06700005
                       CONTINUE                                         06710005
                                                                        06720005
                   WHEN SQLWARN0 NOT EQUAL SPACE                        06730005
                   WHEN SQLCODE NOT EQUAL ZERO                          06740005
                       DISPLAY ' ERROR TRN-NBR =      '                 06750016
                                                    SUT00028-TRN-NBR    06760016
                       DISPLAY ' ERROR SHIPT-UNT-ID = '                 06770016
                                                    PV-SHIPT-UNT-ID     06780016
                       MOVE '2600-SELECT-SEA-SET'                       06790021
                                                 TO PV-PARAGRAPH-NAME   06800005
                       MOVE 'ERROR ON SELECT OF SEA SET'                06810005
                                                 TO PV-DB2-OPERATION    06820005
                       DISPLAY 'ERROR TRN-NBR = '   SUT00028-TRN-NBR    06830005
                       SET ABEND-4002-READ-ERROR TO TRUE                06840005
                       PERFORM 9200-SQL-ABEND                           06850005
                                                                        06860005
               END-EVALUATE                                             06870005
           END-PERFORM.                                                 06880005
                                                                        06890005
           IF (PV-RETRY-COUNTER > PC-MAX-RETRIES)                       06900005
               DISPLAY ' ERROR TRN-NBR =      '    SUT00028-TRN-NBR     06910016
               DISPLAY ' ERROR SHIPT-UNT-ID = '    PV-SHIPT-UNT-ID      06920016
               MOVE '2600-SELECT-SEA-SET'       TO PV-PARAGRAPH-NAME    06930021
               MOVE 'MAX RETRIES EXCEEDED'      TO PV-DB2-OPERATION     06940005
               SET ABEND-4002-READ-ERROR        TO TRUE                 06950005
               PERFORM 9200-SQL-ABEND                                   06960005
           END-IF.                                                      06970005
                                                                        06980005
      ******************************************************************06990046
      * RETRIEVE THE CREATE TIMESTAMP                                   07000047
      ******************************************************************07010046
       2700-GET-CRE-TMST.                                               07020048
                                                                        07030046
           PERFORM                                                      07040046
               WITH TEST AFTER                                          07050046
               VARYING PV-RETRY-COUNTER                                 07060046
               FROM 1 BY 1                                              07070046
               UNTIL (PV-RETRY-COUNTER > PC-MAX-RETRIES)                07080046
                   OR (SQLCODE = +0                                     07090046
                   OR  SQLCODE = +100)                                  07100046
                                                                        07110046
               EXEC SQL                                                 07120046
                    SELECT  MAX(CRE_TMST)                               07130057
                      INTO :PV-CRE-TMST                                 07140047
                           :PV-NULL-IND                                 07150057
                      FROM SUT_OTBND_STR_SCN                            07160046
                     WHERE SHIPT_UNT_ID  = :PV-SHIPT-UNT-ID             07170047
                       AND ACTV_IND      = 'Y'                          07180046
                      WITH UR                                           07190046
               END-EXEC                                                 07200046
                                                                        07210046
               EVALUATE TRUE                                            07220046
                   WHEN SQLCODE = ZERO                                  07230046
                      IF PV-NULL-IND = -1                               07240057
                         MOVE SPACES        TO PV-CRE-TMST              07250059
                      END-IF                                            07260057
                                                                        07270047
                   WHEN SQLCODE = +100                                  07280046
                       MOVE SPACES          TO PV-CRE-TMST              07290059
                                                                        07300046
                   WHEN SQLCODE = -904                                  07310046
                   WHEN SQLCODE = -911                                  07320046
                   WHEN SQLCODE = -913                                  07330046
                       CONTINUE                                         07340046
                                                                        07350046
                   WHEN SQLWARN0 NOT EQUAL SPACE                        07360046
                   WHEN SQLCODE NOT EQUAL ZERO                          07370046
                       DISPLAY ' ERROR TRN-NBR =      '                 07380046
                                                    SUT00028-TRN-NBR    07390046
                       DISPLAY ' ERROR SHIPT-UNT-ID = '                 07400046
                                                    PV-SHIPT-UNT-ID     07410046
                       MOVE '2700-GET-CRE-TMST'  TO PV-PARAGRAPH-NAME   07420047
                       MOVE 'ERROR ON SELECT OF CRE TMST'               07430047
                                                 TO PV-DB2-OPERATION    07440046
                       DISPLAY 'ERROR TRN-NBR = '   SUT00028-TRN-NBR    07450046
                       SET ABEND-4002-READ-ERROR TO TRUE                07460046
                       PERFORM 9200-SQL-ABEND                           07470046
                                                                        07480046
               END-EVALUATE                                             07490046
           END-PERFORM.                                                 07500046
                                                                        07510046
           IF (PV-RETRY-COUNTER > PC-MAX-RETRIES)                       07520046
               DISPLAY ' ERROR TRN-NBR =      '    SUT00028-TRN-NBR     07530046
               DISPLAY ' ERROR SHIPT-UNT-ID = '    PV-SHIPT-UNT-ID      07540046
               MOVE '2700-GET-CRE-TMST'         TO PV-PARAGRAPH-NAME    07550047
               MOVE 'MAX RETRIES EXCEEDED'      TO PV-DB2-OPERATION     07560046
               SET ABEND-4002-READ-ERROR        TO TRUE                 07570046
               PERFORM 9200-SQL-ABEND                                   07580046
           END-IF.                                                      07590046
                                                                        07600046
      ******************************************************************07610001
      * CLOSE THE TMST_CSR CURSOR                                       07620056
      ******************************************************************07630001
       3000-CLOSE-TMST-CSR.                                             07640007
                                                                        07650001
           EXEC SQL                                                     07660001
              CLOSE TMST_CSR                                            07670007
           END-EXEC.                                                    07680001
                                                                        07690001
           EVALUATE TRUE                                                07700001
               WHEN SQLCODE = +0                                        07710001
               WHEN SQLCODE = -904                                      07720001
               WHEN SQLCODE = -911                                      07730001
               WHEN SQLCODE = -913                                      07740001
                    CONTINUE                                            07750001
                                                                        07760001
               WHEN SQLWARN0 NOT EQUAL SPACE                            07770001
               WHEN SQLCODE NOT EQUAL ZERO                              07780001
                    DISPLAY ' ERROR SHIPT-UNT-ID = '                    07790015
                                                   PV-SHIPT-UNT-ID      07800015
                    MOVE '3000-CLOSE-TMST-CSR'  TO PV-PARAGRAPH-NAME    07810007
                    MOVE 'ERROR ON CLOSE OF TMST_CSR'                   07820007
                                                TO PV-DB2-OPERATION     07830001
                    SET ABEND-4006-CLOSE-ERROR  TO TRUE                 07840001
                    PERFORM 9200-SQL-ABEND                              07850001
                                                                        07860001
           END-EVALUATE.                                                07870001
                                                                        07880001
      ******************************************************************07890004
      * CLOSE THE DTL_CSR CURSOR                                        07900056
      ******************************************************************07910004
       3500-CLOSE-DTL-CSR.                                              07920004
                                                                        07930004
           EXEC SQL                                                     07940004
              CLOSE DTL_CSR                                             07950004
           END-EXEC.                                                    07960004
                                                                        07970004
           EVALUATE TRUE                                                07980004
               WHEN SQLCODE = +0                                        07990004
               WHEN SQLCODE = -904                                      08000004
               WHEN SQLCODE = -911                                      08010004
               WHEN SQLCODE = -913                                      08020004
                    CONTINUE                                            08030004
                                                                        08040004
               WHEN SQLWARN0 NOT EQUAL SPACE                            08050004
               WHEN SQLCODE NOT EQUAL ZERO                              08060004
                    DISPLAY ' ERROR SHIPT-UNT-ID = '                    08070015
                                                   PV-SHIPT-UNT-ID      08080015
                    MOVE '3500-CLOSE-DTL-CSR'   TO PV-PARAGRAPH-NAME    08090004
                    MOVE 'ERROR ON CLOSE OF DTL_CSR'                    08100004
                                                TO PV-DB2-OPERATION     08110004
                    SET ABEND-4006-CLOSE-ERROR  TO TRUE                 08120004
                    PERFORM 9200-SQL-ABEND                              08130004
                                                                        08140004
           END-EVALUATE.                                                08150004
                                                                        08160004
      ******************************************************************08170001
      * CLOSE INPUT/OUTPUT FILES AND DISPLAY PROGRAM COUNTS             08180001
      ******************************************************************08190001
       9000-WRAPUP.                                                     08200001
                                                                        08210001
           CLOSE INPUT-SML-FILE                                         08220005
                 OUTPUT-SML-FILE.                                       08230001
                                                                        08240001
           PERFORM 9100-DISPLAY-COUNTS.                                 08250001
                                                                        08260001
      ******************************************************************08270001
      * DISPLAY PROGRAM COUNTS                                          08280001
      ******************************************************************08290001
       9100-DISPLAY-COUNTS.                                             08300001
                                                                        08310001
           MOVE PA-INPUT-RECORDS-READ              TO PV-EDIT-FIELD.    08320014
           DISPLAY ' INPUT RECORDS READ..........:'   PV-EDIT-FIELD.    08330041
                                                                        08340001
           MOVE PA-SML-RECORDS-READ                TO PV-EDIT-FIELD.    08350014
           DISPLAY ' TMST CSR RECORDS READ.....:'     PV-EDIT-FIELD.    08360041
                                                                        08370038
           MOVE PA-SML-NOT-FOUND                   TO PV-EDIT-FIELD.    08380038
           DISPLAY ' TMST CSR RECORDS NOT FOUND:'     PV-EDIT-FIELD.    08390041
                                                                        08400004
           MOVE PA-DTL-RECORDS-READ                TO PV-EDIT-FIELD.    08410014
           DISPLAY ' DETAIL CSR RECORDS READ.....:'   PV-EDIT-FIELD.    08420041
                                                                        08430001
           MOVE PA-OUTPUT-RECS-WROTE               TO PV-EDIT-FIELD.    08440014
           DISPLAY ' OUTPUT RECORDS WROTE........:'   PV-EDIT-FIELD.    08450041
                                                                        08460001
           DISPLAY ' '.                                                 08470001
           DISPLAY '*******************************************'.       08480001
           DISPLAY ' '.                                                 08490001
                                                                        08500001
      ******************************************************************08510001
      * ABEND ROUTINE FOR BAD SQL CALLS                                 08520001
      ******************************************************************08530001
       9200-SQL-ABEND.                                                  08540001
                                                                        08550001
           DISPLAY '** ABEND     **'.                                   08560001
           DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    08570001
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              08580001
           DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               08590001
           DISPLAY '** SQLCODE   ** = ' SQLCODE.                        08600001
                                                                        08610001
      ***************************************************************** 08620001
      *    COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED  08630001
      *    TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.   08640001
      ***************************************************************** 08650001
           COPY DPPD004.                                                08660001
                                                                        08670001
           CALL 'ILBOABN0' USING ABEND-CODE.                            08680001
