000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             TCKUP005.                                00050002
000600 AUTHOR.                 BARB SCHULTZ.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            OCTOBER 2009.                            00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100***************************************************************** 00110000
001200*                                                               * 00120000
001300*  THIS PROGRAM INSERTS TO THE DEBIT EXCEPTION TABLES.          * 00130011
001400*                                                               * 00140000
001500*   INPUT: INP01 - DEBIT EXCEPTIONS FILE FROM TCKRP003          * 00150011
002200*                                                               * 00220000
002300***************************************************************** 00230000
002400*                                                               * 00240000
002500*  THE PROGRAM TAKES THE SEQUENTIAL FILE PRODUCED IN TCKRP003   * 00250000
002600*  AND INSERTS TO THE EPT_TNDR_EXC AND EPT_TNDR_EXC_RPT_DTE     * 00260011
002600*  TABLES.                                                      * 00270011
003200*                                                               * 00320000
003300***************************************************************** 00330000
003400 ENVIRONMENT DIVISION.                                            00340000
003500***************************************************************** 00350000
003600                                                                  00360000
003700 CONFIGURATION SECTION.                                           00370000
003800                                                                  00380000
003900 SOURCE-COMPUTER.        IBM-3090.                                00390000
004000                                                                  00400000
004100 OBJECT-COMPUTER.        IBM-3090.                                00410000
004200                                                                  00420000
004300 INPUT-OUTPUT SECTION.                                            00430000
004400                                                                  00440000
004500 FILE-CONTROL.                                                    00450000
004600                                                                  00460000
004700     SELECT DEBIT-EXCEPTION-FILE                                  00470000
004800         ASSIGN TO INP01.                                         00480000
006730                                                                  00673000
006740******************************************************************00674000
006750 DATA DIVISION.                                                   00675000
006760******************************************************************00676000
006770                                                                  00677000
006780 FILE SECTION.                                                    00678000
006790                                                                  00679000
006800 FD  DEBIT-EXCEPTION-FILE                                         00680000
006900     RECORDING MODE IS F                                          00690000
007000     BLOCK CONTAINS 0 RECORDS                                     00700000
007100     LABEL RECORDS ARE STANDARD.                                  00710000
007200                                                                  00720000
007300 01  DEBIT-EXCEPTION-RECORD PIC X(78).                            00730005
007400                                                                  00740000
012000******************************************************************01200000
012100 WORKING-STORAGE SECTION.                                         01210000
012200******************************************************************01220000
012300 01  FILLER                            PIC X(50)  VALUE           01230000
012400     ' *** WORKING STORAGE STARTS HERE FOR TCKUP005 *** '.        01240002
012500                                                                  01250000
015100******************************************************************01510000
015200*   ABEND CODE - AND NUMBER FOR EACH POSSIBLE TYPE OF ABEND.     *01520000
015300******************************************************************01530000
015400 01  AC-ABEND-CODE                    PIC S9(04) VALUE ZERO       01540000
015500                                                 COMP SYNC.       01550000
015600     88  AC-INPUT-FILE-ERROR                     VALUE +4003.     01560006
015700     88  AC-CALENDAR-ROUTINE-ERROR               VALUE +4019.     01570000
015800     88  AC-TABLE-OVERFLOW                       VALUE +4004.     01580000
015900                                                                  01590000
016000 01  ABEND-CODE                       PIC S9(04) VALUE ZERO       01600000
016100                                                 COMP SYNC.       01610000
016200                                                                  01620000
016600******************************************************************01660000
016700*   PROGRAM SWITCHES                                             *01670000
016800******************************************************************01680000
016900 01  PS-PROGRAM-SWITCHES.                                         01690000
017600     05  PS-END-OF-DEBIT-FILE-SW     PIC  X(01) VALUE 'N'.        01760000
017700         88  PS-END-OF-DEBIT-FILE               VALUE 'Y'.        01770000
018940                                                                  01894000
018950******************************************************************01895000
018960*   PROGRAM CONSTANTS                                            *01896000
018970******************************************************************01897000
018980 01  PC-CONSTANTS.                                                01898000
019000     05  PC-PROGRAM-NAME             PIC X(08)     VALUE          01900000
019100                                                   'TCKUP005'.    01910002
019300                                                                  01930000
019400******************************************************************01940000
019500*   PROGRAM ACCUMULATERS.                                        *01950000
019600******************************************************************01960000
019700 01  PA-ACCUMULATORS.                                             01970006
020400     05  PA-FILE-RECS-READ           PIC  9(07)    VALUE ZEROES.  02040000
186800     05  PA-INS-EPT00060             PIC  9(07)    VALUE ZEROES.  02050006
186800     05  PA-INS-EPT00061             PIC  9(07)    VALUE ZEROES.  02051006
020600                                                                  02060000
020700******************************************************************02070000
020800*   PROGRAM VARIABLES.                                           *02080000
020900******************************************************************02090000
021000 01  PV-PROGRAM-VARIABLES.                                        02100000
021100     05  PV-PARAGRAPH-NAME           PIC  X(40) VALUE SPACE.      02110006
021200     05  PV-DB2-OPERATION            PIC  X(40) VALUE SPACE.      02120006
021400     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(40) VALUE SPACES.     02140006
025872                                                                  02587200
025873******************************************************************02587300
025874*   DATE AND TIME FIELDS.                                        *02587400
025875******************************************************************02587500
025876 01  PV-DATE-AND-TIME-FIELDS.                                     02587600
026100     05  PV-CURR-DATE-CCYYMMDD.                                   02610000
026200         10  PV-CURR-DATE-CCYY       PIC 9(04)     VALUE ZEROES.  02620000
026300         10  PV-CURR-DATE-MM         PIC 9(02)     VALUE ZEROES.  02630000
026400         10  PV-CURR-DATE-DD         PIC 9(02)     VALUE ZEROES.  02640000
026500     05  PV-CURR-TIME.                                            02650000
026600         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZEROES.  02660000
026700         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZEROES.  02670000
026800         10  PV-CURR-TIME-SS         PIC  9(02)    VALUE ZEROES.  02680000
032400                                                                  03240000
032500     05  PV-ISO-SLS-DATE.                                         03250000
032600         10  PV-ISO-SLS-CCYY         PIC  9(04)    VALUE ZEROES.  03260000
032700         10  PV-ISO-DASH1            PIC  X(01)    VALUE '-'.     03270000
032800         10  PV-ISO-SLS-MM           PIC  9(02)    VALUE ZEROES.  03280000
032900         10  PV-ISO-DASH2            PIC  X(01)    VALUE '-'.     03290000
033000         10  PV-ISO-SLS-DD           PIC  9(02)    VALUE ZEROES.  03300000
033100                                                                  03310000
034709                                                                  03470900
034790******************************************************************03479000
034800*    STANDARD DB2 ERROR HANDLING AREA                            *03480000
034900******************************************************************03490000
035000     COPY DPWS004.                                                03500000
035100                                                                  03510000
035700******************************************************************03570000
035800*    STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA             *03580000
035900******************************************************************03590000
036000     EXEC SQL                                                     03600000
036100          INCLUDE SQLCA                                           03610000
036200     END-EXEC.                                                    03620000
036300                                                                  03630000
036400     COPY SQLCA2.                                                 03640000
036500                                                                  03650000
036600******************************************************************03660000
036700*    STANDARD DB2 DCLGEN FOR THE EPT_TND_EXC TABLE               *03670006
036800******************************************************************03680000
036900     EXEC SQL                                                     03690000
037000          INCLUDE EPT00060                                        03700006
037100     END-EXEC.                                                    03710000
036500                                                                  03711006
036600******************************************************************03712006
036700*    STANDARD DB2 DCLGEN FOR THE EPT_TND_EXC_RPT_DTE TABLE       *03713006
036800******************************************************************03714006
036900     EXEC SQL                                                     03715006
037000          INCLUDE EPT00061                                        03716006
037100     END-EXEC.                                                    03717006
037200                                                                  03720000
063894******************************************************************06389400
063895*  DEBIT EXCEPTION FILE LAYOUT                                   *06389501
063896******************************************************************06389600
063897     COPY TCRD021.                                                06389701
063898                                                                  06389800
067200***************************************************************** 06720000
067300* PROCEDURE DIVISION.                                           * 06730000
067400***************************************************************** 06740000
067500 PROCEDURE DIVISION.                                              06750000
067600                                                                  06760000
068300     PERFORM 1000-INITIALIZE-PROGRAM.                             06830000
068400                                                                  06840000
068500     PERFORM 2000-PROCESS-DEBIT-FILE                              06850000
068600       UNTIL PS-END-OF-DEBIT-FILE.                                06860000
068800                                                                  06880000
069800     PERFORM 8000-END-PROGRAM.                                    06980000
069900                                                                  06990000
070000     GOBACK.                                                      07000000
070100                                                                  07010000
070200******************************************************************07020000
070300* 1000-INITIALIZE-PROGRAM                                         07030000
070400*  -  OPEN FILE                                                   07040006
070600*  -  READ 1ST RECORD ON DEBIT EXCEPTION FILE                     07060001
070800******************************************************************07080000
070900 1000-INITIALIZE-PROGRAM.                                         07090000
071000                                                                  07100000
071100     OPEN INPUT  DEBIT-EXCEPTION-FILE.                            07110000
071900                                                                  07190000
071900     PERFORM 5000-READ-DEBIT-EXCEPTION-FILE.                      07200006
071900                                                                  07210000
077000     IF PS-END-OF-DEBIT-FILE                                      07211006
077100        DISPLAY 'DEBIT EXCEPT FILE MISSING'                       07220006
077100        MOVE '1000-INITIALIZE-PROGRAM ' TO PV-PARAGRAPH-NAME      07230006
077100        SET AC-INPUT-FILE-ERROR TO TRUE                           07240007
077100        PERFORM 9000-ABEND                                        07250007
077100     END-IF.                                                      07260006
077100                                                                  07270006
082200******************************************************************08220000
082400* MOVE FIELDS FOR INSERT                                         *08240003
082700******************************************************************08270000
068500 2000-PROCESS-DEBIT-FILE.                                         08281007
082900     MOVE TC021-RPT-DTE          TO EPT00061-RPT-DTE.             08290006
082900     MOVE TC021-SLS-DTE          TO EPT00060-SLS-DTE              08290106
082900                                    EPT00061-SLS-DTE.             08290206
082900     MOVE TC021-STR-NBR          TO EPT00060-STR-NBR              08290406
082900                                    EPT00061-STR-NBR.             08290506
082900     MOVE TC021-RGST-ID          TO EPT00060-RGST-ID              08290606
082900                                    EPT00061-RGST-ID.             08290706
082900     MOVE TC021-TRN-NBR          TO EPT00060-TRN-NBR              08290806
082900                                    EPT00061-TRN-NBR.             08290906
082900     MOVE TC021-STRT-TIME        TO EPT00060-STRT-TM              08291006
082900                                    EPT00061-STRT-TM.             08291106
082900     MOVE TC021-TNDR-SEQ-NBR     TO EPT00060-EXC-SEQ-NBR          08291206
082900                                    EPT00061-EXC-SEQ-NBR.         08291306
082900     MOVE TC021-CARD-NBR         TO EPT00060-TNDR-ID.             08291406
082900     MOVE TC021-TNDR-AMT         TO EPT00060-TNDR-AMT.            08291506
082900     MOVE TC021-SALE-TYPE        TO EPT00060-EXC-TRN-STAT-CDE.    08291606
082900     MOVE TC021-SOURCE-CDE       TO EPT00060-EXC-TRN-SRC-CDE.     08291706
082900     MOVE TC021-REASON-CDE       TO EPT00060-EXC-RSN-CDE.         08291806
186800                                                                  18680000
186800     PERFORM 3000-INSERT-EXC-TBL.                                 18690006
186800     IF SQLCODE = +0 OR                                           18690113
186800        SQLCODE = -803 OR                                         18690213
186800        SQLCODE = -811                                            18690313
186800         PERFORM 3100-INSERT-EXC-RPT-TBL                          18691006
186800     END-IF.                                                      18700006
186800                                                                  18700106
186800     PERFORM 5000-READ-DEBIT-EXCEPTION-FILE.                      18701006
186800                                                                  18702006
076000***************************************************************** 18702106
186800*    INSERT EXCEPTION TABLE                                       18703007
076000***************************************************************** 18710006
186800 3000-INSERT-EXC-TBL.                                             18710106
186800                                                                  18710210
186800     EXEC SQL INSERT                                              18710306
186800         INTO EPT_TNDR_EXC                                        18710406
186800             (SLS_DTE                                             18710506
186800             ,STR_NBR                                             18710606
186800             ,RGST_ID                                             18710706
186800             ,TRN_NBR                                             18710806
186800             ,STRT_TM                                             18710906
186800             ,EXC_SEQ_NBR                                         18711006
186800             ,TNDR_ID                                             18711106
186800             ,TNDR_AMT                                            18711206
186800             ,EXC_RSN_CDE                                         18711306
186800             ,EXC_TRN_SRC_CDE                                     18711406
186800             ,EXC_TRN_STAT_CDE                                    18711506
186800             ,CPL_IND                                             18711606
186800             ,LAST_UPD_USR_ID                                     18711706
186800             ,LAST_UPD_TMST)                                      18711806
186800         VALUES                                                   18711906
186800            (:EPT00060-SLS-DTE                                    18712006
186800            ,:EPT00060-STR-NBR                                    18712106
186800            ,:EPT00060-RGST-ID                                    18712206
186800            ,:EPT00060-TRN-NBR                                    18712306
186800            ,:EPT00060-STRT-TM                                    18712406
186800            ,:EPT00060-EXC-SEQ-NBR                                18712506
186800            ,:EPT00060-TNDR-ID                                    18712606
186800            ,:EPT00060-TNDR-AMT                                   18712706
186800            ,:EPT00060-EXC-RSN-CDE                                18712806
186800            ,:EPT00060-EXC-TRN-SRC-CDE                            18712906
186800            ,:EPT00060-EXC-TRN-STAT-CDE                           18713006
186800            ,'N'                                                  18713106
186800            ,'COMPUTER'                                           18713206
186800            ,CURRENT TIMESTAMP)                                   18713306
186800         END-EXEC.                                                18713706
186800                                                                  18713806
186800         EVALUATE SQLCODE                                         18713909
186800             WHEN +0                                              18714009
186800                  ADD +1 TO PA-INS-EPT00060                       18714114
186800             WHEN -803                                            18714212
186800             WHEN -811                                            18714312
186800                  CONTINUE                                        18714414
186800             WHEN OTHER                                           18714506
186800                 MOVE '3000-INSERT-EXC-TBL' TO PV-PARAGRAPH-NAME  18714606
186800                 MOVE 'ERROR ON INSERT ON EPT_TNDR_EXC'           18714706
186800                                 TO PV-DB2-OPERATION-ATTEMPTED    18714811
186800                 PERFORM 9900-SQL-ABEND                           18714906
186800         END-EVALUATE.                                            18715006
186800                                                                  18715106
076000***************************************************************** 18715206
186800*    INSERT EXCEPTION REPORT TABLE                                18715307
076000***************************************************************** 18715406
186800                                                                  18715510
186800 3100-INSERT-EXC-RPT-TBL.                                         18715610
186800     EXEC SQL INSERT                                              18715706
186800         INTO EPT_TNDR_EXC_RPT_DTE                                18715806
186800             (SLS_DTE                                             18715906
186800             ,STR_NBR                                             18716006
186800             ,RGST_ID                                             18716106
186800             ,TRN_NBR                                             18716206
186800             ,STRT_TM                                             18716306
186800             ,EXC_SEQ_NBR                                         18716406
186800             ,RPT_DTE)                                            18716506
186800         VALUES                                                   18717206
186800            (:EPT00061-SLS-DTE                                    18717306
186800            ,:EPT00061-STR-NBR                                    18717406
186800            ,:EPT00061-RGST-ID                                    18717506
186800            ,:EPT00061-TRN-NBR                                    18717606
186800            ,:EPT00061-STRT-TM                                    18717706
186800            ,:EPT00061-EXC-SEQ-NBR                                18717806
186800            ,:EPT00061-RPT-DTE)                                   18717909
186800         END-EXEC.                                                18718910
186800                                                                  18719010
186800         EVALUATE SQLCODE                                         18719110
186800             WHEN +0                                              18719409
186800                  ADD +1 TO PA-INS-EPT00061                       18719506
186800             WHEN -803                                            18719612
186800             WHEN -811                                            18719812
186800                  CONTINUE                                        18719912
186800             WHEN OTHER                                           18720012
186800                 MOVE '3100-INSERT-EXC-RPT-TBL'                   18720112
186800                                         TO PV-PARAGRAPH-NAME     18720212
186800                 MOVE 'ERROR ON INSERT ON EPT_TNDR_EXC_RPT_DTE'   18720312
186800                                TO PV-DB2-OPERATION-ATTEMPTED     18720412
186800                 PERFORM 9900-SQL-ABEND                           18720512
186800         END-EVALUATE.                                            18720612
186800                                                                  18720806
076000***************************************************************** 18721606
076100*     READ DEBIT EXCEPTION FILE     TCRD021                       18722006
076200***************************************************************** 18730006
076300 5000-READ-DEBIT-EXCEPTION-FILE.                                  18740006
076400                                                                  18750006
076500     READ DEBIT-EXCEPTION-FILE INTO TC021-DATA                    18760009
076600        AT END                                                    18770006
076700           SET PS-END-OF-DEBIT-FILE TO TRUE                       18780006
076800     END-READ.                                                    18790006
076900                                                                  18800006
077000     IF PS-END-OF-DEBIT-FILE                                      18810006
077000        CONTINUE                                                  18820006
077200     ELSE                                                         18830006
077300        ADD +1 TO PA-FILE-RECS-READ                               18840006
077400     END-IF.                                                      18850006
077500                                                                  18860006
077500******************************************************************18870006
077500* 8000-END-PROGRAM                                               *18871006
077500*     CLOSE FILES AND CURSORS                                    *18872006
077500******************************************************************18873006
077500 8000-END-PROGRAM.                                                18880006
077500                                                                  18890006
077500     DISPLAY 'RECORDS READ ' PA-FILE-RECS-READ.                   18900006
186800     DISPLAY 'RECORDS INSERTED INTO EPT00060 ' PA-INS-EPT00060.   18900106
186800     DISPLAY 'RECORDS INSERTED INTO EPT00061 ' PA-INS-EPT00061.   18900206
077500                                                                  18901006
077500     CLOSE DEBIT-EXCEPTION-FILE.                                  18910006
077500                                                                  18920006
184542***************************************************************** 45810006
184543* 9000-ABEND                                                      45820006
184544*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  45830006
184545***************************************************************** 45840006
184546 9000-ABEND.                                                      45850006
184547                                                                  45860006
184548     DISPLAY '** ABEND           **'.                             45870006
184549     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          45880006
184550     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        45890006
184560     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         45900006
184570                                                                  45910006
184580******************************************************************45920006
184700*     PERFORMS ABEND PROCESSING FOR SQL ERRORS.                  *45950006
185100******************************************************************45990006
185200 9900-SQL-ABEND.                                                  46000006
185300                                                                  46010006
185400     DISPLAY '9900-SQL-ABEND'.                                    46020006
185500     DISPLAY '**  ABEND     **'.                                  46030006
185600     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               46040006
185700     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             46050006
185800     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    46060006
185900                                                                  46070006
186000******************************************************************46080006
186100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *46090006
186200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *46100006
186300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *46110006
186400* FORMAT.                                                        *46120006
186500******************************************************************46130006
186600                                                                  46140006
186700     COPY DPPD004.                                                46150006
186800                                                                  46160006
186900     MOVE +4013 TO ABEND-CODE.                                    46170006
187000     CALL 'ILBOABN0' USING ABEND-CODE.                            46180006
