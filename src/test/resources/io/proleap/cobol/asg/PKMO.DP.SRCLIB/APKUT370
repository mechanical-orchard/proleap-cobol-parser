000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT370.                                        00020000
000300 AUTHOR.         COGNIZANT.                                       00030000
000400 DATE-WRITTEN.   FEB 2020.                                        00040000
000500                                                                  00050000
000600*----------------------------------------------------------------*00060000
000700*    COBOL 2 WITH DB2 SQL.                                       *00070000
000800*                                                                *00080000
000900*    VALIDATE IMPORT FREIGHT INVOICES FROM TRANSINTERNATIONAL    *00090010
001000*                                                                *00100000
001100* THIS PROGRAM IS TO VALIDATE THE IMPORT FREIGHT INVOICES FROM   *00110000
001200* TRANSINTERNATIONAL. VERFICATION ARE DONE TO DETERMINE THEY     *00120000
001300* MEET ALL OF THE REQUIREMENTS FOR BEING LOADED INTO THE INVOICE *00130000
001400* DATABASE. FIELD LEVEL VERIFICATION IS DONE JUST TO ENSURE      *00140000
001500* CERTAIN DATA IS PRESENT FOR INVOICES COMING FROM SPECIFIC      *00150000
001600* VENDOR TYPES.  ALL INVOICES THAT PASS THE EDITS WILL BE WRITTEN*00160000
001700* TO VALID INVOICE FILE & ALL INVOICES THAT FAIL THE EDITS WILL  *00170000
001800* BE WRITTEN TO A REJECTION FILE WHICH WILL BE USED TO GENERATE  *00180000
001900* A REPORT OF ALL REJECTIONS.                                    *00190000
002000*----------------------------------------------------------------*00200000
002100* INPUT:                                                         *00210000
002300* 1. IMPORT FREIGHT INVOICES CHARGES FILE        (APRD128)       *00230000
002400* 2. IMPORT FREIGHT INVOICES CONTROL FILE        (APRD128)       *00240000
002500*                                                                *00250000
002700* OUTPUT:                                                        *00270000
002900* 1. VALID INVOICES TO BE LOADED         (APRD016)               *00290000
003000* 2. THE REJECTED INVOICE FILE           (APRD129)               *00300000
003100*                                                                *00310000
003300* DB2 TABLES:                                                    *00330000
003500* 1. TEXTENT - EXTERNAL ENTERPRISE VENDOR TABLE                  *00350000
003600* 2. TENTNME - VENDOR NAME TABLE                                 *00360000
003700* 3. TINVOIC - AP INVOICE HEADER TABLE                           *00370011
003800* 4. TEXINVC - AP EXPENSE INVOICE TABLE                          *00380011
003810* 5. TADJRNL - AP ADJUSTMENT JOURNAL TABLE                       *00381011
003900* 6. TPURCHS - PURCHASE ORDER TABLE                              *00390011
004000* 7. TIMCNPO - PO TRACKING CONTAINER PO TABLE                    *00400011
004100* 8. TIMCNTK - CONTAINER TRACKING TABLE                          *00410011
004100* 9. TALCHRG - ALLOWANCE CHARGES                                 *00411017
004200*----------------------------------------------------------------*00420000
004300* CHANGE LOG:                                                    *00430000
004400*                                                                *00440000
004500* DATE  11/03/2020                                               *00450011
004600* CHANGE MADE:  INITIAL VERSION.                                 *00460001
004800* MADE BY: NANCY EILBES                WR/IR #: CHG0250510       *00480011
007010*                                                               * 00481015
007020* DATE  05/10/2023                                              * 00482016
007030*    CHANGE MADE: RECOMPILED FOR CHANGES TO COPYBOOK APWS010    * 00483015
007050*    MADE BY: JEAN KURK               WR/IR #: CHG0288104       * 00484016
007010*                                                               * 00485017
007020* DATE  11/15/2023                                              * 00486017
007030*    CHANGE MADE: ADDED TALCHRG TO LOOKUP IN S200-              * 00487017
007050*    MADE BY: JEAN KURK               WR/IR #: CHG0297100       * 00488017
004900*                                                                *00490000
005000*----------------------------------------------------------------*00500000
005100                                                                  00510000
005200 ENVIRONMENT DIVISION.                                            00520000
005300 INPUT-OUTPUT SECTION.                                            00530000
005400 FILE-CONTROL.                                                    00540000
005500                                                                  00550000
005600     SELECT CONTROL-TOTAL-FILE ASSIGN TO INP01.                   00560000
005700     SELECT FREIGHT-INVCS-FILE ASSIGN TO INP02.                   00570000
005800     SELECT VALID-INVC-FILE   ASSIGN TO OUT01.                    00580000
005900     SELECT INVC-ERRORS-FILE  ASSIGN TO OUT02.                    00590000
006000                                                                  00600000
006100 DATA DIVISION.                                                   00610000
006200                                                                  00620000
006300 FILE SECTION.                                                    00630000
006400                                                                  00640000
006500 FD  CONTROL-TOTAL-FILE                                           00650000
006600     RECORDING MODE IS  F                                         00660000
006700     LABEL RECORDS  ARE STANDARD                                  00670000
006800     DATA RECORD    IS  CONTROL-TOT-RECORD.                       00680000
006900                                                                  00690000
007000 01  CONTROL-TOT-RECORD            PIC X(105).                    00700000
007100                                                                  00710000
007200 FD  FREIGHT-INVCS-FILE                                           00720000
007300     RECORDING MODE IS  F                                         00730000
007400     LABEL RECORDS  ARE STANDARD                                  00740000
007500     DATA RECORD    IS  FRGT-INVCS-RECORD.                        00750000
007600                                                                  00760000
007700 01  FRGT-INVCS-RECORD             PIC X(105).                    00770000
007800                                                                  00780000
007900 FD  VALID-INVC-FILE                                              00790000
008000     RECORDING MODE IS  F                                         00800000
008100     LABEL RECORDS  ARE STANDARD                                  00810000
008200     DATA RECORD    IS  VALID-INVC-RECORD.                        00820000
008300                                                                  00830000
008400 01  VALID-INVC-RECORD             PIC X(476).                    00840000
008500                                                                  00850000
008600 FD  INVC-ERRORS-FILE                                             00860000
008700     RECORDING MODE IS  F                                         00870000
008800     LABEL RECORDS  ARE STANDARD                                  00880000
008900     DATA RECORD    IS  INVC-ERRORS-RECORD.                       00890000
009000                                                                  00900000
009100 01  INVC-ERRORS-RECORD            PIC X(492).                    00910000
009200                                                                  00920000
009300 EJECT                                                            00930000
009400 WORKING-STORAGE SECTION.                                         00940000
009500                                                                  00950000
009600 01  FILLER                          PIC X(25) VALUE              00960000
009700                             'WS FOR APKUT370 BEGINS==>'.         00970000
009800                                                                  00980000
009900 01  PROGRAM-CONSTANTS.                                           00990000
010000     05  PC-PERCENT                  PIC X(16) VALUE ALL '%'.     01000000
010100     05  PC-ONE                      PIC X(01) VALUE SPACES.      01010000
010200     05  PC-DFLT-DTE                 PIC X(10) VALUE '0001-01-01'.01020000
010200     05  PC-OAF-CHRG                 PIC X(03) VALUE 'AOF'.       01021017
010300                                                                  01030000
010400 01  PV-PROGRAM-VARIABLES.                                        01040000
010500     05  PV-INVC-VND-NBR             PIC X(09) VALUE SPACES.      01050000
010600     05  PV-INVC-PO-NBR              PIC S9(9) COMP               01060000
010700                                               VALUE ZEROES.      01070000
010800     05  PV-INVC-DTE                 PIC X(10) VALUE SPACES.      01080000
010900     05  PV-CONTAINER-NBR            PIC X(12) VALUE SPACES.      01090000
011000     05  PV-LIKE-INVOICE-NBR         PIC X(22) VALUE SPACES.      01100000
011100     05  PV-INVC-FOR-LIKE-COND       PIC X(16) VALUE SPACES.      01110000
011200     05  PV-IMPRT-BOL-ID             PIC X(30) VALUE SPACES.      01120000
011300                                                                  01130000
011400 01  ABEND-CODE                      PIC S9(4) COMP SYNC          01140000
011500                                               VALUE ZEROES.      01150000
011600     88 AP-TABLE-FULL                          VALUE +4004.       01160000
011700     88 AP-EMPTY-FILE                          VALUE +4005.       01170000
011800     88 AP-INVALID-DATA                        VALUE +4008.       01180000
011900     88 AP-DB2-ERROR                           VALUE +4013.       01190000
012000                                                                  01200000
012100 01  WS-ABEND-FILEDS.                                             01210000
012200     05  WS-ABEND-PROGRAM            PIC X(8)  VALUE 'APKUT370'.  01220000
012300     05  WS-ABEND-PARAGRAPH          PIC X(50) VALUE SPACES.      01230000
012400     05  WS-ABEND-OPERATION          PIC X(50) VALUE SPACES.      01240000
012500     05  WS-ABEND-STRUCTURE-1        PIC X(8)  VALUE SPACES.      01250000
012600     05  WS-ABEND-STRUCTURE-2        PIC X(8)  VALUE SPACES.      01260000
012700     05  WS-ABEND-STATUS             PIC XX    VALUE SPACES.      01270000
012800                                                                  01280000
012900 01  WS-WORK-AREA-INIT.                                           01290000
013000     05  WS-CHRG-AMT                 PIC 9(10)V99  VALUE ZEROES.  01300000
013100     05  WS-INVC-NET-AMT             PIC 9(10)V99  VALUE ZEROES.  01310000
013200     05  WS-ACCUM-CHRG-AMT           PIC 9(10)V99  VALUE ZEROES.  01320000
013300     05  WS-CCYY-MM-DD.                                           01330000
013400         10  WS-CCYY                 PIC X(04)     VALUE SPACES.  01340000
013500         10  FILLER                  PIC X(01)     VALUE '-'.     01350000
013600         10  WS-MM                   PIC X(02)     VALUE SPACES.  01360000
013700         10  FILLER                  PIC X(01)     VALUE '-'.     01370000
013800         10  WS-DD                   PIC X(02)     VALUE SPACES.  01380000
013900     05  WS-FMT-CCYYMMDD.                                         01390000
014000         10  WS-FMT-CCYY             PIC 9(04)     VALUE ZEROES.  01400000
014100         10  WS-FMT-MM               PIC 9(02)     VALUE ZEROES.  01410000
014200         10  WS-FMT-DD               PIC 9(02)     VALUE ZEROES.  01420000
014300     05  WS-ERROR-CODE-AREA.                                      01430000
014400         10  WS-ERR-TABLE            OCCURS 20 TIMES              01440000
014500                                     INDEXED BY WS-ERR-IDX.       01450000
014600             15  WS-ERR-CDE          PIC 9(02).                   01460000
014700                                                                  01470000
014800 01  WS-WORK-AREA.                                                01480000
014900     05  WS-HOLD-INVC-VND-NBR        PIC X(09)     VALUE SPACES.  01490000
015000     05  WS-HOLD-INVC-PO-NBR         PIC 9(09)     VALUE ZEROES.  01500000
015100     05  WS-HOLD-INVC-ID             PIC X(22)     VALUE SPACES.  01510000
015200     05  WS-NUM-RECD-CNT             PIC 9(09)     VALUE ZEROES.  01520005
015210     05  WS-CNTL-RECD-CNT            PIC 9(09)     VALUE ZEROES.  01521005
015300     05  WS-NUM-NET-AMT              PIC 9(12)V99  VALUE ZEROES.  01530003
015310     05  WS-CNTL-NET-COST-AMT        PIC 9(12)V99  VALUE ZEROES.  01531003
015400     05  WS-CALC-NET-COST-AMT        PIC 9(12)V99  VALUE ZEROES.  01540000
015500     05  WS-CALC-RECD-CNT            PIC 9(09)     VALUE ZEROES.  01550000
015600                                                                  01560000
015700     COPY DPWS500.                                                01570000
015800                                                                  01580000
015900 01  WS-PROGRAM-COUNTERS.                                         01590000
016000     05  WS-CHRGS-INP-CNT            PIC 9(9)      VALUE ZEROES.  01600000
016100     05  WS-VALID-INVC-CNT           PIC 9(9)      VALUE ZEROES.  01610000
016200     05  WS-REJECT-REC-CNT           PIC 9(9)      VALUE ZEROES.  01620000
016300                                                                  01630000
016400 01  PS-SWITCHES-MISC.                                            01640000
016500     05  END-OF-INVC-FILE-SW         PIC X(01)     VALUE 'N'.     01650000
016600         88  END-OF-INVC-FILE                      VALUE 'Y'.     01660000
016700     05  END-OF-CNTRL-FILE-SW        PIC X(01)     VALUE 'N'.     01670000
016800         88  END-OF-CNTRL-FILE                     VALUE 'Y'.     01680000
016900                                                                  01690000
017000 01  PS-SWITCHES.                                                 01700000
017100     05  PS-INV-HEADER-SW            PIC X(01)     VALUE 'N'.     01710000
017200         88  HDR-FOUND                             VALUE 'Y'.     01720000
017300         88  NO-HDR-FOUND                          VALUE 'N'.     01730000
017400     05  PS-INV-CHRG-SW              PIC X(01)     VALUE 'N'.     01740000
017500         88  CHRG-FOUND                            VALUE 'Y'.     01750000
017600         88  NO-CHRG-FOUND                         VALUE 'N'.     01760000
017700     05  PS-ERROR-SW                 PIC X(01)     VALUE 'N'.     01770000
017800         88  INVOICE-ERROR                         VALUE 'Y'.     01780000
017900         88  NO-INVOICE-ERROR                      VALUE 'N'.     01790000
018000     05  PS-DATE-INVALID             PIC X(01)     VALUE 'N'.     01800000
018100         88  PS-VALID-DATE                         VALUE 'Y'.     01810000
018200         88  PS-NOT-VALID-DATE                     VALUE 'N'.     01820000
018300     05  PS-PO-NBR-VALID             PIC X(01)     VALUE 'N'.     01830000
018400         88  PS-VALID-PO-NBR                       VALUE 'Y'.     01840000
018500         88  PS-NOT-VALID-PO-NBR                   VALUE 'N'.     01850000
018600     05  PS-FREIGHT-VALID            PIC X(01)     VALUE 'N'.     01860000
018700         88  FREIGHT-FND                           VALUE 'Y'.     01870000
018800         88  FREIGHT-NOT-FND                       VALUE 'N'.     01880000
018900                                                                  01890000
019000 01  RUN-TIME                        PIC 9(8).                    01900000
019100 01  DATE-IN                         PIC X(6).                    01910000
019200 01  NUMERIC-DATE                    PIC 9(6).                    01920000
019300 01  CUR-DATE                        PIC X(08).                   01930000
019400 EJECT                                                            01940000
019500*----------------------------------------------------------------*01950000
019600*  IMPORT FREIGHT INVOICES INPUT FILE - INP01                     01960000
019700*----------------------------------------------------------------*01970000
019800     COPY APRD128.                                                01980000
019900 EJECT                                                            01990000
020000*----------------------------------------------------------------*02000000
020100*  IMPORT FREIGHT INVOICES EDITING AREA                           02010000
020200*----------------------------------------------------------------*02020000
020300 01  WS-EDIT-AREA.                                                02030004
020400     COPY APWS128.                                                02040004
020500 EJECT                                                            02050000
020600*----------------------------------------------------------------*02060000
020700*  VALID INVOICES TO BE LOADED - OUT01                            02070000
020800*----------------------------------------------------------------*02080000
020900     COPY APRD016.                                                02090000
021000 EJECT                                                            02100000
021100*----------------------------------------------------------------*02110000
021200*  REJECTED INVOICE FILE - OUT02                                  02120000
021300*----------------------------------------------------------------*02130000
021400     COPY APRD129.                                                02140000
021500 EJECT                                                            02150000
021600*----------------------------------------------------------------*02160000
021700*  IMPORT LANDED COST INVOICE EDIT CODES.                         02170000
021800*----------------------------------------------------------------*02180000
021900 01  WS-EDIT-CODES.                                               02190000
022000     COPY APWS010.                                                02200000
022100 EJECT                                                            02210000
022200     COPY DPWS004.                                                02220000
022300                                                                  02230000
022400*----------------------------------------------------------------*02240000
022500*  COMMUNICATIONS AREA2 FOR DB2                                   02250000
022600*----------------------------------------------------------------*02260000
022700     COPY SQLCA2.                                                 02270000
022800                                                                  02280000
022900     EXEC SQL                                                     02290000
023000          INCLUDE SQLCA                                           02300000
023100     END-EXEC.                                                    02310000
023200*----------------------------------------------------------------*02320000
023300*  EXTERNAL ENTITY TABLE                                          02330000
023400*----------------------------------------------------------------*02340000
023500     EXEC SQL                                                     02350000
023600          INCLUDE TADJRNL                                         02360000
023700     END-EXEC.                                                    02370000
023800*----------------------------------------------------------------*02380000
023900*  EXTERNAL ENTITY TABLE                                          02390000
024000*----------------------------------------------------------------*02400000
024100     EXEC SQL                                                     02410000
024200          INCLUDE TEXTENT                                         02420000
024300     END-EXEC.                                                    02430000
024400*----------------------------------------------------------------*02440000
024500*  EXTERNAL ENTITY NAME TABLE                                     02450000
024600*----------------------------------------------------------------*02460000
024700     EXEC SQL                                                     02470000
024800          INCLUDE TENTNME                                         02480000
024900     END-EXEC.                                                    02490000
025000*----------------------------------------------------------------*02500000
025100*  AP INVOICE HEADER TABLE                                        02510000
025200*----------------------------------------------------------------*02520000
025300     EXEC SQL                                                     02530000
025400          INCLUDE TINVOIC                                         02540000
025500     END-EXEC.                                                    02550000
025600*----------------------------------------------------------------*02560000
025700*  AP EXPENSE INVOICE TABLE                                       02570000
025800*----------------------------------------------------------------*02580000
025900     EXEC SQL                                                     02590000
026000          INCLUDE TEXINVC                                         02600000
026100     END-EXEC.                                                    02610000
026200*----------------------------------------------------------------*02620000
026300*  PURCHASE ORDER TABLE                                           02630000
026400*----------------------------------------------------------------*02640000
026500     EXEC SQL                                                     02650000
026600          INCLUDE TPURCHS                                         02660000
026700     END-EXEC.                                                    02670000
026800*----------------------------------------------------------------*02680000
026900*  PO TRACKING CONTAINER PO TABLE                                 02690000
027000*----------------------------------------------------------------*02700000
027100     EXEC SQL                                                     02710000
027200          INCLUDE TIMCNPO                                         02720000
027300     END-EXEC.                                                    02730000
027400*----------------------------------------------------------------*02740000
027500*  PO CONTAINER TRACKING                                          02750000
027600*----------------------------------------------------------------*02760000
027700     EXEC SQL                                                     02770000
027800          INCLUDE TIMCNTK                                         02780000
027900     END-EXEC.                                                    02790000
027400*----------------------------------------------------------------*02791017
027500*  AP ALLOWANCE CHARGE                                            02792017
027600*----------------------------------------------------------------*02793017
027700     EXEC SQL                                                     02794017
027800          INCLUDE TALCHRG                                         02795017
027900     END-EXEC.                                                    02796017
028000*----------------------------------------------------------------*02800000
028100*    DB2 AREA FOR SYSDUMMY1                                       02810000
028200*----------------------------------------------------------------*02820000
028300     EXEC SQL                                                     02830000
028400          INCLUDE SYSDUMMY                                        02840000
028500     END-EXEC.                                                    02850000
028600                                                                  02860000
028700 01  FILLER                        PIC X(25) VALUE                02870000
028800          '<====WS FOR APKUT370 ENDS'.                            02880000
028900 EJECT                                                            02890000
029000******************************************************************02900000
029100 PROCEDURE DIVISION.                                              02910000
029200******************************************************************02920000
029300                                                                  02930000
029400 A100-MAINLINE.                                                   02940000
029500                                                                  02950000
029600     PERFORM B100-HOUSEKEEPING.                                   02960000
029700                                                                  02970000
029800     PERFORM B200-PROCESS-IMPORT-INVOICES                         02980002
029810       UNTIL END-OF-INVC-FILE.                                    02981002
029900                                                                  02990000
030000     PERFORM B300-END-OF-JOB.                                     03000000
030100                                                                  03010000
030200     GOBACK.                                                      03020000
030300                                                                  03030000
030400 EJECT                                                            03040000
030500*---------------------------------------------------------------* 03050000
030600* GET DATE, TIME, OPEN FILES, INITIALIZE RECORD LAYOUTS AND       03060000
030700* PERFORM INITIAL READ OF INPUT FILES.                            03070000
030800*---------------------------------------------------------------* 03080000
030900 B100-HOUSEKEEPING.                                               03090000
031000                                                                  03100000
031100     ACCEPT RUN-TIME FROM TIME.                                   03110000
031200     ACCEPT DATE-IN  FROM DATE.                                   03120000
031300     ACCEPT CUR-DATE FROM DATE YYYYMMDD.                          03130000
031400     MOVE   DATE-IN    TO NUMERIC-DATE.                           03140000
031500                                                                  03150000
031600     DISPLAY '------------ START OF APKUT370 ------------'.       03160000
031700     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    03170000
031800                                                                  03180000
031900     OPEN  INPUT   FREIGHT-INVCS-FILE                             03190000
032000                   CONTROL-TOTAL-FILE.                            03200000
032100     OPEN  OUTPUT  VALID-INVC-FILE                                03210000
032200                   INVC-ERRORS-FILE.                              03220000
032300                                                                  03230000
032400     INITIALIZE DCLTEXTENT                                        03240000
032500                DCLTENTNME                                        03250000
032600                DCLTINVOIC                                        03260000
032700                DCLTEXINVC                                        03270000
032800                DCLTPURCHS                                        03280000
032900                DCLTIMCNPO                                        03290000
033000                DCLTIMCNTK                                        03300000
033100                DCLTADJRNL.                                       03310000
033200                                                                  03320000
033300     INITIALIZE AP128-IMPORT-FREIGHT-RECORD                       03330000
033400                AP016-INVOICE-LOAD-RECORD                         03340000
033500                AP129-FRGT-INV-REJECT-RECORD.                     03350000
033600                                                                  03360000
033700     PERFORM H100-INITIALIZE.                                     03370000
033800                                                                  03380000
036200                                                                  03620000
036300     PERFORM D100-SUMMARIZE-CONTROL-RECDS.                        03630003
036301                                                                  03630103
036310     PERFORM R200-READ-INVC-RECD.                                 03631003
036400                                                                  03640000
036500     IF END-OF-INVC-FILE                                          03650000
036600        DISPLAY '***************************************'         03660000
036700        DISPLAY '* CHARGES INPUT FILE IS EMPTY.        *'         03670000
036800        DISPLAY '* NO INVOICES TO PROCESS              *'         03680000
036900        DISPLAY '***************************************'         03690000
037000        GOBACK                                                    03700000
037100     END-IF.                                                      03710000
037200                                                                  03720000
037300     MOVE AP128-INVC-VND-NBR  TO WS-HOLD-INVC-VND-NBR.            03730000
037400     MOVE AP128-INVC-PO-NBR   TO WS-HOLD-INVC-PO-NBR.             03740000
037500     MOVE AP128-INVC-ID       TO WS-HOLD-INVC-ID.                 03750000
037600                                                                  03760000
037700 EJECT                                                            03770000
037800*---------------------------------------------------------------* 03780000
037900* THE INPUT FILE WILL CONTAIN MULTIPLE RECORDS FOR EACH VENDOR/PO 03790000
038000* /INVOICE. AS EACH RECORD IS READ, IT MUST BE DETERMINED IF THE  03800000
038100* SAME INVOICE IS BEING PROCESSED.  EACH RECORD FOR THE INVOICE   03810000
038200* WILL BE LOADED INTO THE INVOICE TABLE IN WORKING STORAGE. WHEN  03820000
038300* A RECORD IS READ THAT IS FOR NEW VENDOR/INVOICE OR END-OF-FILE  03830000
038400* IS REACHED, THE INVOICE TABLE WILL BE EDITED.                   03840000
038500*---------------------------------------------------------------* 03850000
038600 B200-PROCESS-IMPORT-INVOICES.                                    03860000
038700                                                                  03870000
038800     IF (AP128-INVC-VND-NBR  NOT = WS-HOLD-INVC-VND-NBR) OR       03880000
038900        (AP128-INVC-PO-NBR   NOT = WS-HOLD-INVC-PO-NBR)  OR       03890000
039000        (AP128-INVC-ID       NOT = WS-HOLD-INVC-ID)               03900000
039100        SET NO-INVOICE-ERROR TO TRUE                              03910000
039200        PERFORM E100-EDIT-INVC-TBL                                03920000
039300                                                                  03930000
039400        IF INVOICE-ERROR                                          03940000
039500           PERFORM C100-PROCESS-REJECT-INVOICE                    03950000
039600        ELSE                                                      03960000
039700           PERFORM C200-PROCESS-INVOICE                           03970000
039800        END-IF                                                    03980000
039900                                                                  03990000
040000        PERFORM H100-INITIALIZE                                   04000000
040100                                                                  04010000
040200        MOVE AP128-INVC-VND-NBR   TO WS-HOLD-INVC-VND-NBR         04020000
040300        MOVE AP128-INVC-PO-NBR    TO WS-HOLD-INVC-PO-NBR          04030000
040400        MOVE AP128-INVC-ID        TO WS-HOLD-INVC-ID              04040000
040500     END-IF.                                                      04050000
040600                                                                  04060000
040700     PERFORM M100-MOVE-INVC-REC-TO-TBL.                           04070000
040800     PERFORM R200-READ-INVC-RECD.                                 04080000
040900                                                                  04090000
041000 EJECT                                                            04100000
041100*---------------------------------------------------------------* 04110000
041200* FINISH PROCESSING THE LAST VENDOR/INVOICE IN THE EDIT TABLE,    04120000
041300* CLOSE FILES AND DISPLAY COUNTER TOTALS.                         04130000
041400*---------------------------------------------------------------* 04140000
041500 B300-END-OF-JOB.                                                 04150000
041600                                                                  04160000
041700     SET NO-INVOICE-ERROR TO TRUE                                 04170000
041800     PERFORM E100-EDIT-INVC-TBL                                   04180000
041900                                                                  04190000
042000     IF INVOICE-ERROR                                             04200000
042100        PERFORM C100-PROCESS-REJECT-INVOICE                       04210000
042200      ELSE                                                        04220000
042300        PERFORM C200-PROCESS-INVOICE                              04230000
042400     END-IF                                                       04240000
042500                                                                  04250000
042600     SET WS-ERR-IDX TO 1.                                         04260000
042700     SET AP129-IDX  TO 1.                                         04270000
042800     SET WS-ERR-IDX DOWN BY 1.                                    04280000
042900     SET AP129-IDX  DOWN BY 1.                                    04290000
043000                                                                  04300000
043100     IF (WS-CALC-RECD-CNT NOT = WS-CNTL-RECD-CNT)                 04310000
043200     OR (WS-CALC-NET-COST-AMT NOT = WS-CNTL-NET-COST-AMT)         04320000
043300        IF WS-ERR-IDX NOT = 20                                    04330000
043400           SET WS-ERR-IDX UP BY 1                                 04340000
043500        END-IF                                                    04350000
043600        SET INVOICE-ERROR              TO TRUE                    04360000
043700        SET INVALID-CONTROL-TOTAL      TO TRUE                    04370000
043800        MOVE WS010-ERROR-CODES                                    04380000
043900          TO WS-ERR-CDE(WS-ERR-IDX)                               04390000
044000                                                                  04400000
044100        INITIALIZE AP129-FRGT-INV-REJECT-RECORD                   04410000
044200        MOVE WS-CNTL-RECD-CNT          TO AP129-CNTL-RECD-COUNT   04420000
044300        MOVE WS-CNTL-NET-COST-AMT      TO AP129-CNTL-NET-COST-AMT 04430000
044400        MOVE WS-CALC-RECD-CNT          TO AP129-CALC-RECD-COUNT   04440000
044500        MOVE WS-CALC-NET-COST-AMT      TO AP129-CALC-NET-COST-AMT 04450000
044600                                                                  04460000
044700        PERFORM P100-POPULATE-REJECT-ERRORS                       04470000
044800        PERFORM W200-WRITE-REJECT-RECORD                          04480000
044900        MOVE 4094                      TO RETURN-CODE             04490000
045000     END-IF.                                                      04500000
045100                                                                  04510000
045200     CLOSE FREIGHT-INVCS-FILE                                     04520000
045300           CONTROL-TOTAL-FILE                                     04530000
045400           VALID-INVC-FILE                                        04540000
045500           INVC-ERRORS-FILE                                       04550000
045600                                                                  04560000
045700     DISPLAY '************************************************'.  04570000
045800     DISPLAY 'TOTAL INVOICE RECORDS READ    = ' WS-CALC-RECD-CNT  04580000
045900     DISPLAY 'TOTAL INVOICES TO VALID FILE  = ' WS-VALID-INVC-CNT 04590012
046000     DISPLAY 'TOTAL INVOICES TO REJECT FILE = ' WS-REJECT-REC-CNT 04600000
046100     DISPLAY '************************************************'.  04610000
046200                                                                  04620000
046210 EJECT                                                            04621004
046500*---------------------------------------------------------------* 04650000
046600* PROCESS A VENDOR/PO/INVOICE THAT HAS ERROR(S) AND WRITE IT OUT  04660000
046700* TO THE REJECT FILE.  THERE WILL BE ONE RECORD FOR EACH VENDOR/  04670000
046800* PO/INVOICE THAT HAS ERROR(S).                                   04680000
046900*---------------------------------------------------------------* 04690000
047000 C100-PROCESS-REJECT-INVOICE.                                     04700000
047100                                                                  04710000
047200     SET AP129-IDX                                                04720000
047300         CHRG-IDX  TO 1.                                          04730000
047400     SET AP129-IDX DOWN BY 1.                                     04740000
047500     SET CHRG-IDX  DOWN BY 1.                                     04750000
047600                                                                  04760000
047700     PERFORM M200-MAP-REJECT-RECORD                               04770000
047800     VARYING INV-IDX FROM 1 BY 1                                  04780000
047900       UNTIL INV-IDX > 30 OR                                      04790000
048000             WS128-RECORD-TYPE-CODE(INV-IDX) = SPACES.            04800000
048100                                                                  04810000
048200     PERFORM P100-POPULATE-REJECT-ERRORS                          04820000
048300     VARYING WS-ERR-IDX FROM 1 BY 1                               04830000
048400       UNTIL WS-ERR-IDX > 20 OR                                   04840000
048500             WS-ERR-CDE(WS-ERR-IDX)  = ZEROES OR                  04850000
048600             AP129-IDX > 20.                                      04860000
048700                                                                  04870000
048800     PERFORM W200-WRITE-REJECT-RECORD.                            04880000
048900                                                                  04890000
049000 EJECT                                                            04900000
049100*---------------------------------------------------------------* 04910000
049200* PROCESS THE VENDOR/PO/INVOICE.  WRITE OUT THE                   04920000
049300* CURRENT VENDOR/PO/INVOICE TO THE VALID LOAD FILE                04930000
049400*---------------------------------------------------------------* 04940000
049500 C200-PROCESS-INVOICE.                                            04950000
049600                                                                  04960000
049700     INITIALIZE AP016-INVOICE-LOAD-RECORD.                        04970000
049800     SET TALCHRG-INDEX TO 1.                                      04980000
049900     SET TALCHRG-INDEX DOWN BY 1.                                 04990000
050000                                                                  05000000
050100     MOVE 'APKUT370'             TO AP016-SRCPGM.                 05010000
050200     MOVE 'N'                    TO AP016-HOLD-IND.               05020000
050300     MOVE 'EE'                   TO AP016-ENTR-MTHD-CDE.          05030000
050400     MOVE 'PD'                   TO AP016-STATUS-CDE.             05040000
050500     MOVE '01'                   TO AP016-TERM-TYP-CDE.           05050000
050600     MOVE '01'                   TO AP016-TERM-BASIS-DTE-CDE.     05060000
050700     MOVE 30                     TO AP016-NET-DUE-DAY-QTY.        05070000
050800                                                                  05080000
050900     PERFORM M300-MAP-VALID-LOAD-RECORD                           05090000
051000     VARYING INV-IDX FROM 1 BY 1                                  05100000
051100       UNTIL INV-IDX > 30 OR                                      05110000
051200             WS128-RECORD-TYPE-CODE(INV-IDX) = SPACES.            05120000
051300                                                                  05130000
051400     PERFORM W100-WRITE-VALID-INVC-RECORD.                        05140000
051500                                                                  05150000
051600 EJECT                                                            05160000
051610*---------------------------------------------------------------* 05161003
051620* SUMMARIZE THE RECORD COUNT AND DOLLAR AMOUNT ON THE CONTROL     05162003
051630* RECORDS SO A VALID COMPARISON CAN BE DONE IF THERE IS MORE      05163003
051640* THAN ONE FILE PROCESSED AT A TIME.                              05164003
051650*---------------------------------------------------------------* 05165003
051660 D100-SUMMARIZE-CONTROL-RECDS.                                    05166003
051670                                                                  05167003
051680     PERFORM R100-READ-CONTROL-RECD.                              05168003
051690                                                                  05169003
051691     IF END-OF-CNTRL-FILE                                         05169103
051692        DISPLAY '*************************'                       05169203
051693        DISPLAY '*  EMPTY CONTROL FILE   *'                       05169303
051694        DISPLAY '*************************'                       05169403
051695        MOVE 'CONTROL-FILE-READ'   TO WS-ABEND-PARAGRAPH          05169503
051696        SET AP-EMPTY-FILE          TO TRUE                        05169603
051697        PERFORM Z100-ABEND                                        05169703
051698     ELSE                                                         05169803
051699        IF AP128-RECORD-TYPE-CODE NOT = '9'                       05169903
051700           DISPLAY '****************************************'     05170003
051701           DISPLAY '*  CONTROL FILE HAS NO CONTROL RECORD  *'     05170103
051702           DISPLAY '****************************************'     05170203
051703           MOVE 'INVALID-CONTROL-REC' TO WS-ABEND-PARAGRAPH       05170303
051704           SET  AP-INVALID-DATA       TO TRUE                     05170403
051705           PERFORM Z100-ABEND                                     05170503
051706        ELSE                                                      05170603
051707           PERFORM UNTIL END-OF-CNTRL-FILE                        05170703
051713             MOVE AP128-CNTL-RECD-COUNT   TO WS-NUM-RECD-CNT      05171306
051714             ADD WS-NUM-RECD-CNT          TO WS-CNTL-RECD-CNT     05171406
051718             MOVE AP128-CNTL-NET-COST-AMT TO WS-NUM-NET-AMT       05171807
051719             ADD WS-NUM-NET-AMT           TO WS-CNTL-NET-COST-AMT 05171907
051720             INITIALIZE AP128-IMPORT-FREIGHT-RECORD               05172007
051721             PERFORM R100-READ-CONTROL-RECD                       05172107
051722           END-PERFORM                                            05172207
051723     END-IF.                                                      05172307
051724                                                                  05172407
051725 EJECT                                                            05172507
051730*---------------------------------------------------------------* 05173005
051800* PERFORM EDIT CHECKS PER SPECIFICATIONS                          05180000
051900* -- THE EDIT-REC-TYPES CHECK ROUTINE WILL CHECK SPECIFIC ERRORS  05190000
052000*    PER RECORD TYPE AND WILL KEEP ANY SUMMARIZATION TOTALS       05200000
052100*    AND COUNTS THAT ARE NECESSARY FOR EDITTING AFTER THE         05210000
052200*    ENTIRE INVOICE IS LOADED                                     05220000
052300* -- THE EDIT-OVERALL ROUTINE WILL CHECK MISSING RECORD TYPES,    05230000
052400*    DETAIL AND SUMMARY TOTAL DISCREPENCIES, ETC..........        05240000
052500*---------------------------------------------------------------* 05250000
052600 E100-EDIT-INVC-TBL.                                              05260000
052700                                                                  05270000
052800     PERFORM E200-EDIT-REC-TYPES                                  05280000
052900        VARYING INV-IDX FROM 1 BY 1                               05290000
053000        UNTIL INV-IDX > 30 OR WS128-SPACES(INV-IDX).              05300000
053100                                                                  05310000
053200     PERFORM E300-EDIT-OVERALL-INVOICE.                           05320000
053300                                                                  05330000
053400 EJECT                                                            05340000
053500*---------------------------------------------------------------* 05350000
053600* PERFORM EDIT CHECKS ON THE INDIVIDUAL RECORD TYPES THAT MAKE    05360000
053700* UP ONE COMPLETE VENDOR/PO/INVOICE.NOTE THAT THE EDITING IS DONE 05370000
053800* ON THE DATA THAT HAS BEEN LOADED TO THE INVOICE EDIT TABLE, NOT 05380000
053900* THE EDI INPUT RECORD LAYOUT.                                    05390000
054000*---------------------------------------------------------------* 05400000
054100 E200-EDIT-REC-TYPES.                                             05410000
054200                                                                  05420000
054300* EVALUATE FOR HEADER AND CHARGE RECORD TYPE                      05430000
054400     EVALUATE WS128-RECORD-TYPE-CODE(INV-IDX)                     05440000
054500        WHEN '1'                                                  05450000
054600             SET HDR-FOUND          TO TRUE                       05460000
054700             MOVE WS128-INVC-NET-COST-AMT(INV-IDX)                05470000
054800                                    TO WS-INVC-NET-AMT            05480000
054900             ADD WS-INVC-NET-AMT    TO WS-CALC-NET-COST-AMT       05490000
055000             PERFORM F100-VALIDATE-REC-TYPE-01                    05500000
055100        WHEN '2'                                                  05510000
055200             SET CHRG-FOUND         TO TRUE                       05520000
055300             PERFORM F200-VALIDATE-REC-TYPE-02                    05530000
055400        WHEN OTHER                                                05540000
055500             CONTINUE                                             05550000
055600     END-EVALUATE.                                                05560000
055700                                                                  05570000
055800 EJECT                                                            05580000
055900*---------------------------------------------------------------* 05590000
056000* THIS PARAGRAPH DOES VARIOUS EDIT CHECKS ON THE OVERALL INVOICE  05600000
056100* THAT CURRENTLY RESIDES IN THE INVOICE EDIT TABLE. SOME OF THE   05610000
056200* EDITS: VERIFY THAT THERE ARE IS AT LEAST ONE OF EACH OF THE     05620000
056300* FOLLOWING RECORD TYPES - 01,02; COMPARE THE SUM OF THE          05630000
056400* CHARGE AMOUNTS TO THE SENT NET COST AMOUNT SENT BY THE VENDOR.  05640000
056500*---------------------------------------------------------------* 05650000
056600 E300-EDIT-OVERALL-INVOICE.                                       05660000
056700                                                                  05670000
056800* VALIDATE HEADER/CHARGES RECORD.                                 05680000
056900                                                                  05690000
057000     IF HDR-FOUND                                                 05700000
057100        CONTINUE                                                  05710000
057200     ELSE                                                         05720000
057300        SET NO-HDR-FOUND       TO TRUE                            05730000
057400        IF WS-ERR-IDX NOT = 20                                    05740000
057500           SET WS-ERR-IDX UP BY 1                                 05750000
057600        END-IF                                                    05760000
057700        SET INVOICE-ERROR      TO TRUE                            05770000
057800        SET MISSING-01-REC-ERR TO TRUE                            05780000
057900        MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)          05790000
058000     END-IF.                                                      05800000
058100                                                                  05810000
058200     IF CHRG-FOUND                                                05820000
058300        CONTINUE                                                  05830000
058400     ELSE                                                         05840000
058500        IF WS-ERR-IDX NOT = 20                                    05850000
058600           SET WS-ERR-IDX UP BY 1                                 05860000
058700        END-IF                                                    05870000
058800        SET INVOICE-ERROR      TO TRUE                            05880000
058900        SET MISSING-02-REC-ERR TO TRUE                            05890000
059000        MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)          05900000
059100     END-IF.                                                      05910000
059200                                                                  05920000
059300* VALIDATE THAT INVOICE NET COST AMOUNT IS GREATER THAN ZERO.     05930000
059400                                                                  05940000
059500     IF WS-INVC-NET-AMT > ZERO                                    05950000
059600        CONTINUE                                                  05960000
059700     ELSE                                                         05970000
059800        IF WS-ERR-IDX NOT = 20                                    05980000
059900           SET WS-ERR-IDX UP BY 1                                 05990000
060000        END-IF                                                    06000000
060100        SET INVOICE-ERROR TO TRUE                                 06010000
060200        SET NET-COST-GT-ZERO-ERR TO TRUE                          06020000
060300        MOVE WS010-ERROR-CODES TO                                 06030000
060400             WS-ERR-CDE(WS-ERR-IDX)                               06040000
060500     END-IF.                                                      06050000
060600                                                                  06060000
060700* VALIDATE INVOICE NET COST AMT IS EQUAL TO SUM OF CHARGES AMT.   06070000
060800                                                                  06080000
060900     IF WS-INVC-NET-AMT NOT = WS-ACCUM-CHRG-AMT                   06090000
061000        IF WS-ERR-IDX NOT = 20                                    06100000
061100           SET WS-ERR-IDX UP BY 1                                 06110000
061200        END-IF                                                    06120000
061300        SET INVOICE-ERROR            TO TRUE                      06130000
061400        SET NET-COST-NE-CHRG-SUM-ERR TO TRUE                      06140000
061500        MOVE WS010-ERROR-CODES       TO WS-ERR-CDE(WS-ERR-IDX)    06150000
061600     END-IF.                                                      06160000
061700                                                                  06170000
061800* VALIDATING FOR FREIGHT CHARGE INVOICE                           06180000
061900                                                                  06190000
062000     IF FREIGHT-FND                                               06200000
062100        CONTINUE                                                  06210000
062200     ELSE                                                         06220000
062300        IF WS-ERR-IDX NOT = 20                                    06230000
062400           SET WS-ERR-IDX UP BY 1                                 06240000
062500        END-IF                                                    06250000
062600        SET INVOICE-ERROR       TO TRUE                           06260000
062700        SET NO-FREIGHT-RATE-ERR TO TRUE                           06270000
062800        MOVE WS010-ERROR-CODES  TO WS-ERR-CDE(WS-ERR-IDX)         06280000
062900     END-IF.                                                      06290000
063000                                                                  06300000
063100*---------------------------------------------------------------* 06310000
063200* VALIDATING THE VARIOUS PARTS OF RECORD TYPE 01                  06320000
063300*---------------------------------------------------------------* 06330000
063400 F100-VALIDATE-REC-TYPE-01.                                       06340000
063500                                                                  06350000
063600* VALIDATE THE VENDOR NUMBER.                                     06360000
063700                                                                  06370000
063800     IF WS128-INVC-VND-NBR(INV-IDX) = SPACES                      06380000
063900     OR WS128-INVC-VND-NBR(INV-IDX) NOT NUMERIC                   06390000
064000        IF WS-ERR-IDX NOT = 20                                    06400000
064100           SET WS-ERR-IDX UP BY 1                                 06410000
064200        END-IF                                                    06420000
064300        SET INVOICE-ERROR      TO TRUE                            06430000
064400        SET NO-VENDOR-NBR-ERR  TO TRUE                            06440000
064500        MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)          06450000
064600     ELSE                                                         06460000
064700        INITIALIZE DCLTEXTENT                                     06470000
064800                   DCLTENTNME                                     06480000
064900        MOVE WS128-INVC-VND-NBR(INV-IDX) TO EXTENT-DUN-NBR        06490000
065000        PERFORM S300-SELECT-TENTNME                               06500000
065100     END-IF.                                                      06510000
065200                                                                  06520000
065300* VALIDATE THE PO NUMBER                                          06530000
065400                                                                  06540000
065500     IF WS128-INVC-PO-NBR(INV-IDX) NOT NUMERIC                    06550000
065600     OR WS128-INVC-PO-NBR(INV-IDX) = ZEROES                       06560000
065700        IF WS-ERR-IDX NOT = 20                                    06570000
065800           SET WS-ERR-IDX UP BY 1                                 06580000
065900        END-IF                                                    06590000
066000        SET INVOICE-ERROR         TO TRUE                         06600000
066100        SET NO-PO-NBR-ERR         TO TRUE                         06610000
066200        MOVE WS010-ERROR-CODES    TO WS-ERR-CDE(WS-ERR-IDX)       06620000
066300     ELSE                                                         06630000
066400        SET PS-NOT-VALID-PO-NBR   TO TRUE                         06640000
066500        INITIALIZE DCLTPURCHS                                     06650000
066600        MOVE WS128-INVC-PO-NBR(INV-IDX) TO PV-INVC-PO-NBR         06660000
066700        PERFORM S600-SELECT-TPURCHS                               06670000
066800        IF PS-NOT-VALID-PO-NBR                                    06680000
066900           IF WS-ERR-IDX NOT = 20                                 06690000
067000              SET WS-ERR-IDX UP BY 1                              06700000
067100           END-IF                                                 06710000
067200           SET INVOICE-ERROR      TO TRUE                         06720000
067300           SET INVALID-PO-NBR-ERR TO TRUE                         06730000
067400           MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)       06740000
067500        ELSE                                                      06750000
067600           IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'            06760000
067700              CONTINUE                                            06770000
067800           ELSE                                                   06780000
067900              IF WS-ERR-IDX NOT = 20                              06790000
068000                 SET WS-ERR-IDX UP BY 1                           06800000
068100              END-IF                                              06810000
068200              SET INVOICE-ERROR         TO TRUE                   06820000
068300              SET NON-IMPORT-PO-NBR-ERR TO TRUE                   06830000
068400              MOVE WS010-ERROR-CODES    TO WS-ERR-CDE(WS-ERR-IDX) 06840000
068500           END-IF                                                 06850000
068600        END-IF                                                    06860000
068700     END-IF.                                                      06870000
068800                                                                  06880000
068900* VALIDATE THE INVOICE NUMBER.                                    06890000
069000                                                                  06900000
069100     IF WS128-INVC-ID(INV-IDX) = SPACES                           06910000
069200     OR WS128-INVC-ID(INV-IDX) = '0000000000000000000000'         06920000
069300        IF WS-ERR-IDX NOT = 20                                    06930000
069400           SET WS-ERR-IDX UP BY 1                                 06940000
069500        END-IF                                                    06950000
069600        SET INVOICE-ERROR      TO TRUE                            06960000
069700        SET NO-INV-NBR-ERR     TO TRUE                            06970000
069800        MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)          06980000
069900     END-IF.                                                      06990000
070000                                                                  07000000
070100*VALIDATE PO/INVOICE NBR DUPLICATION ON TINVOIC                   07010000
070200                                                                  07020000
070300     MOVE WS128-INVC-PO-NBR(INV-IDX)   TO PV-INVC-PO-NBR.         07030000
070400     MOVE SPACES                       TO PV-LIKE-INVOICE-NBR.    07040000
070500     STRING WS128-INVC-ID(INV-IDX)     DELIMITED BY SPACE         07050000
070600            PC-PERCENT                 DELIMITED BY SIZE          07060000
070700       INTO PV-LIKE-INVOICE-NBR.                                  07070000
070800                                                                  07080000
070900     PERFORM S100-CHECK-TINVOIC-PO-CONT.                          07090000
071000                                                                  07100000
071100*VALIDATE CONTAINER/PO DUPLICATION ON TEXINVC                     07110000
071200                                                                  07120000
071300     MOVE WS128-INVC-PO-NBR(INV-IDX)   TO PV-INVC-PO-NBR.         07130000
071400     MOVE WS128-CONTAINER-NBR(INV-IDX) TO PV-CONTAINER-NBR.       07140000
071500     MOVE WS128-IMPRT-BOL-ID(INV-IDX)  TO PV-IMPRT-BOL-ID.        07150000
071600     MOVE WS128-INVC-VND-NBR(INV-IDX)  TO PV-INVC-VND-NBR.        07160000
071700                                                                  07170000
071800     PERFORM S200-CHECK-TEXINVC-PO-CONT.                          07180000
071900                                                                  07190000
072000*VALIDATE INVOICE DUPLICATION IN ADJUSTMENT DATABASE              07200000
072100                                                                  07210000
072200     STRING WS128-INVC-ID(INV-IDX) DELIMITED BY SPACE             07220000
072300            PC-PERCENT             DELIMITED BY SIZE              07230000
072400       INTO PV-INVC-FOR-LIKE-COND.                                07240000
072500                                                                  07250000
072600     MOVE WS128-INVC-VND-NBR(INV-IDX)  TO PV-INVC-VND-NBR         07260000
072700     MOVE WS128-INVC-PO-NBR(INV-IDX)   TO PV-INVC-PO-NBR          07270000
072800     IF WS128-INVC-DTE(INV-IDX) = SPACES                          07280000
072900     OR WS128-INVC-DTE(INV-IDX) = ZEROES                          07290000
073000        MOVE PC-DFLT-DTE               TO PV-INVC-DTE             07300000
073100     ELSE                                                         07310000
073200        MOVE WS128-INVC-DTE(INV-IDX)   TO PV-INVC-DTE             07320000
073300     END-IF                                                       07330000
073400     INITIALIZE DCLTADJRNL.                                       07340000
073500     PERFORM S700-CHECK-TADJRNL.                                  07350000
073600                                                                  07360000
073700* VALIDATE THE INVOICE DATE                                       07370000
073800     IF WS128-INVC-DTE(INV-IDX) = SPACES                          07380000
073900     OR WS128-INVC-DTE(INV-IDX) = '0000-00-00'                    07390000
074000     OR WS128-INVC-DTE(INV-IDX) = ZEROES                          07400000
074100        IF WS-ERR-IDX NOT = 20                                    07410000
074200           SET WS-ERR-IDX UP BY 1                                 07420000
074300        END-IF                                                    07430000
074400        SET INVOICE-ERROR            TO TRUE                      07440000
074500        SET NO-INV-DATE-ERR          TO TRUE                      07450000
074600        MOVE WS010-ERROR-CODES       TO WS-ERR-CDE(WS-ERR-IDX)    07460000
074700     ELSE                                                         07470000
074800        MOVE ZEROES                  TO  WS-CCYY-MM-DD            07480000
074900        MOVE WS128-INVC-DTE(INV-IDX) TO  WS-CCYY-MM-DD            07490000
075000        PERFORM G100-CHECK-DATE                                   07500000
075100        IF PS-NOT-VALID-DATE                                      07510000
075200           IF WS-ERR-IDX NOT = 20                                 07520000
075300              SET WS-ERR-IDX UP BY 1                              07530000
075400           END-IF                                                 07540000
075500           SET INVOICE-ERROR        TO TRUE                       07550000
075600           SET INV-DATE-INVALID-ERR TO TRUE                       07560000
075700           MOVE WS010-ERROR-CODES   TO WS-ERR-CDE(WS-ERR-IDX)     07570000
075800        ELSE                                                      07580000
075900           UNSTRING WS-CCYY-MM-DD  DELIMITED BY '-'               07590000
076000               INTO WS-FMT-CCYY, WS-FMT-MM, WS-FMT-DD             07600000
076100                                                                  07610000
076200           IF CUR-DATE >= WS-FMT-CCYYMMDD                         07620000
076300              CONTINUE                                            07630000
076400           ELSE                                                   07640000
076500              IF WS-ERR-IDX NOT = 20                              07650000
076600                 SET WS-ERR-IDX UP BY 1                           07660000
076700              END-IF                                              07670000
076800              SET INVOICE-ERROR        TO TRUE                    07680000
076900              SET INV-DATE-INVALID-ERR TO TRUE                    07690000
077000              MOVE WS010-ERROR-CODES   TO WS-ERR-CDE(WS-ERR-IDX)  07700000
077100           END-IF                                                 07710000
077200        END-IF                                                    07720000
077300     END-IF.                                                      07730000
077400                                                                  07740000
077500* VALIDATE THE CONTAINER NUMBER                                   07750000
077600                                                                  07760000
077700     IF WS128-CONTAINER-NBR(INV-IDX) = SPACES                     07770000
077800     OR WS128-CONTAINER-NBR(INV-IDX) = '000000000000'             07780000
077900        IF WS-ERR-IDX NOT = 20                                    07790000
078000           SET WS-ERR-IDX UP BY 1                                 07800000
078100        END-IF                                                    07810000
078200        SET INVOICE-ERROR TO TRUE                                 07820000
078300        SET NO-CONTAINER-NBR-ERR     TO TRUE                      07830000
078400        MOVE WS010-ERROR-CODES TO                                 07840000
078500             WS-ERR-CDE(WS-ERR-IDX)                               07850000
078600     ELSE                                                         07860000
078700        MOVE WS128-CONTAINER-NBR(INV-IDX) TO PV-CONTAINER-NBR     07870000
078800        INITIALIZE DCLTIMCNTK                                     07880000
078900        PERFORM S400-CHECK-TIMCNTK                                07890000
079000     END-IF.                                                      07900000
079100                                                                  07910000
079200*VALIDATE CONTAINER/PO ON TIMCNPO                                 07920000
079300                                                                  07930000
079400     MOVE WS128-INVC-PO-NBR(INV-IDX)   TO PV-INVC-PO-NBR.         07940000
079500     MOVE WS128-CONTAINER-NBR(INV-IDX) TO PV-CONTAINER-NBR.       07950000
079600                                                                  07960000
079700     PERFORM S500-CHECK-PO-CONTNR.                                07970000
079800                                                                  07980000
079900*---------------------------------------------------------------* 07990000
080000* VALIDATING THE VARIOUS PARTS OF RECORD TYPE 02                  08000000
080100*---------------------------------------------------------------* 08010000
080200 F200-VALIDATE-REC-TYPE-02.                                       08020000
080300                                                                  08030000
080400* VALIDATE CHARGE CODE                                            08040000
080500                                                                  08050000
080600     IF WS128-VALID-CHRG-CDE(INV-IDX)                             08060000
080700        CONTINUE                                                  08070000
080800     ELSE                                                         08080000
080900        IF WS-ERR-IDX NOT = 20                                    08090000
081000           SET WS-ERR-IDX UP BY 1                                 08100000
081100        END-IF                                                    08110000
081200        SET INVOICE-ERROR        TO TRUE                          08120000
081300        SET INVALID-CHRG-CDE-ERR TO TRUE                          08130000
081400        MOVE WS010-ERROR-CODES   TO WS-ERR-CDE(WS-ERR-IDX)        08140000
081500     END-IF.                                                      08150000
081600                                                                  08160000
081700* VALIDATE THE CHARGE AMOUNT. ADD UP THE CHARGE AMOUNTS           08170000
081800                                                                  08180000
081900     MOVE WS128-CHRG-AMT(INV-IDX) TO WS-CHRG-AMT                  08190000
082000                                                                  08200000
082100     IF WS-CHRG-AMT > ZEROES                                      08210000
082200        ADD  WS-CHRG-AMT          TO WS-ACCUM-CHRG-AMT            08220000
082300     ELSE                                                         08230000
082400        IF WS-ERR-IDX NOT = 20                                    08240000
082500           SET WS-ERR-IDX UP BY 1                                 08250000
082600        END-IF                                                    08260000
082700        SET INVOICE-ERROR         TO TRUE                         08270000
082800        SET CHRG-AMT-GT-ZERO-ERR  TO TRUE                         08280000
082900        MOVE WS010-ERROR-CODES    TO WS-ERR-CDE(WS-ERR-IDX)       08290000
083000     END-IF.                                                      08300000
083100                                                                  08310000
083200* FINDING FREIGHT CHARGE INVOICE.                                 08320000
083300                                                                  08330000
083400     IF FREIGHT-FND                                               08340000
083500        CONTINUE                                                  08350000
083600     ELSE                                                         08360000
083700        IF (WS128-CHRG-CDE(INV-IDX)     = 'OAF') AND              08370000
083800           (WS128-CHRG-AMT(INV-IDX) NOT = ZEROES)                 08380000
083900           SET FREIGHT-FND TO TRUE                                08390000
084000        END-IF                                                    08400000
084100     END-IF.                                                      08410000
084200                                                                  08420000
084300*---------------------------------------------------------------* 08430000
084400* VALIDATING THE SENT INVOICE DATE.                               08440000
084500*---------------------------------------------------------------* 08450000
084600 G100-CHECK-DATE.                                                 08460000
084700                                                                  08470000
084800     INITIALIZE DPG51                                             08480000
084900                DPG52                                             08490000
085000                DPG53                                             08500000
085100                DPG54                                             08510000
085200                DPG55                                             08520000
085300                DPG56.                                            08530000
085400                                                                  08540000
085500     SET PS-NOT-VALID-DATE TO TRUE.                               08550000
085600                                                                  08560000
085700     IF WS-CCYY-MM-DD > '0000-00-00'                              08570000
085800        SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE                    08580000
085900        SET DPG52-LK-DTE-ISO-FMT       TO TRUE                    08590000
086000        MOVE WS-CCYY-MM-DD             TO DPG52-LK-DATE-INPUT     08600000
086100        MOVE SPACES                    TO PS-DATE-INVALID         08610000
086200                                                                  08620000
086300        CALL  DP500-KOHLS-CALENDAR-ROUTINE USING                  08630000
086400                                          DPG51 DPG52 DPG53       08640000
086500                                          DPG54 DPG55 DPG56       08650000
086600                                                                  08660000
086700         IF (DPG54-SEVERE-ERROR                                   08670000
086800            OR                                                    08680000
086900             DPG54-WARNING-ERROR)                                 08690000
087000             SET PS-NOT-VALID-DATE TO TRUE                        08700000
087100         ELSE                                                     08710000
087200            SET PS-VALID-DATE TO TRUE                             08720000
087300         END-IF                                                   08730000
087400     END-IF.                                                      08740000
087500                                                                  08750000
087600 EJECT                                                            08760000
087700*---------------------------------------------------------------* 08770000
087800* INITIALIZE THE EDIT TABLE THAT WILL HOLD THE ENTIRE INVOICE.    08780000
087900* ALSO, INITIALIZE THE RELATED COUNTERS, SWITCHES AND SAVE FIELDS.08790000
088000*---------------------------------------------------------------* 08800000
088100 H100-INITIALIZE.                                                 08810000
088200                                                                  08820000
088300     PERFORM VARYING INV-IDX FROM 1 BY 1                          08830000
088400        UNTIL INV-IDX > 30                                        08840000
088500        INITIALIZE WS128-RECORD-TYPE-CODE(INV-IDX)                08850000
088600        INITIALIZE WS128-DATA-AREA(INV-IDX)                       08860000
088700     END-PERFORM.                                                 08870000
088800                                                                  08880000
088900     PERFORM VARYING WS-ERR-IDX FROM 1 BY 1                       08890000
089000        UNTIL WS-ERR-IDX > 20                                     08900000
089100        INITIALIZE WS-ERR-TABLE(WS-ERR-IDX)                       08910000
089200     END-PERFORM.                                                 08920000
089300                                                                  08930000
089400     INITIALIZE PV-PROGRAM-VARIABLES                              08940000
089500                WS-WORK-AREA-INIT                                 08950000
089600                PS-SWITCHES.                                      08960000
089700                                                                  08970000
089800     SET INV-IDX TO 1.                                            08980000
089900     SET INV-IDX DOWN BY 1.                                       08990000
090000     SET WS-ERR-IDX TO 1.                                         09000000
090100     SET WS-ERR-IDX DOWN BY 1.                                    09010000
090200                                                                  09020000
090300 EJECT                                                            09030000
090400*---------------------------------------------------------------* 09040000
090500* MOVE THE INPUT RECORD TO THE INVOICE EDIT TABLE.                09050000
090600*---------------------------------------------------------------* 09060000
090700 M100-MOVE-INVC-REC-TO-TBL.                                       09070000
090800                                                                  09080000
090900     SET INV-IDX UP BY 1.                                         09090000
091000     IF INV-IDX > 30                                              09100000
091100        DISPLAY '************** ABEND **************'             09110013
091200        DISPLAY '*   TOO MANY FREIGHT RECORDS FOR  *'             09120013
091300        DISPLAY '*   VENDOR : AP128-INVC-VND-NBR   *'             09130014
091400        DISPLAY '*   PO NBR : AP128-INVC-PO-NBR    *'             09140014
091500        DISPLAY '*   INVOICE: AP128-INVC-ID        *'             09150014
091600        DISPLAY '*   THAT CAN NOT BE LOADED INTO   *'             09160013
091700        DISPLAY '*   THE EDIT INVOICE TABLE        *'             09170013
091800        DISPLAY '*   PROGRAM: APKUT370             *'             09180013
091900        DISPLAY '*   PARA:M100-MOVE-INVC-REC-TO-TBL*'             09190000
092000        DISPLAY '***********************************'             09200013
092100        SET AP-TABLE-FULL TO TRUE                                 09210000
092200        CALL 'ILBOABN0' USING ABEND-CODE                          09220000
092300     ELSE                                                         09230000
092400        MOVE AP128-RECORD-TYPE-CODE                               09240000
092500                              TO WS128-RECORD-TYPE-CODE(INV-IDX)  09250000
092600        MOVE AP128-DATA-AREA  TO WS128-DATA-AREA(INV-IDX)         09260000
092700     END-IF.                                                      09270000
092800                                                                  09280000
092900 EJECT                                                            09290000
093000*---------------------------------------------------------------* 09300000
093100* MOVE THE INVOICE EDIT TABLE CONTENTS TO THE REJECT RECORD       09310000
093200* FORMAT IF THERE WERE ANY ERRORS FOUND DURING THE EDIT PROCESS.  09320000
093300*---------------------------------------------------------------* 09330000
093400 M200-MAP-REJECT-RECORD.                                          09340000
093500                                                                  09350000
093600     IF WS128-INVC-HEADER(INV-IDX)                                09360000
093700        MOVE WS128-INVC-VND-NBR(INV-IDX)                          09370000
093800                                     TO AP129-VND-NBR             09380000
093900        MOVE WS128-INVC-PO-NBR(INV-IDX)                           09390000
094000                                     TO AP129-PO-NBR              09400000
094100        MOVE WS128-INVC-ID(INV-IDX)  TO AP129-INVC-ID             09410000
094200        MOVE WS128-INVC-DTE(INV-IDX) TO AP129-INVC-DTE            09420000
094300        MOVE WS128-INVC-NET-COST-AMT(INV-IDX)                     09430000
094400                                     TO AP129-NET-COST-AMT        09440000
094500        MOVE WS128-IMPRT-BOL-ID(INV-IDX)                          09450000
094600                                     TO AP129-IMPRT-BOL-ID        09460000
094700        MOVE WS128-CONTAINER-NBR(INV-IDX)                         09470000
094800                                     TO AP129-CONTAINER-NBR       09480000
094900     END-IF.                                                      09490000
095000                                                                  09500000
095100     IF NO-HDR-FOUND                                              09510000
095200        MOVE WS128-CHRG-VND-NBR(INV-IDX)                          09520000
095300                                     TO AP129-VND-NBR             09530000
095400        MOVE WS128-CHRG-PO-NBR(INV-IDX)                           09540000
095500                                     TO AP129-PO-NBR              09550000
095600        MOVE WS128-CHRG-INVC-ID(INV-IDX)                          09560000
095700                                     TO AP129-INVC-ID             09570000
095800     END-IF.                                                      09580000
095900                                                                  09590000
096000     IF WS128-INVC-CHARGES(INV-IDX) AND (CHRG-IDX < 20)           09600000
096100        SET CHRG-IDX UP BY 1                                      09610000
096200        MOVE WS128-CHRG-CDE(INV-IDX) TO AP129-CHRG-CDE(CHRG-IDX)  09620000
096300        MOVE WS128-CHRG-AMT(INV-IDX) TO AP129-CHRG-AMT(CHRG-IDX)  09630000
096400     END-IF.                                                      09640000
096500                                                                  09650000
096600 EJECT                                                            09660000
096700*---------------------------------------------------------------* 09670000
096800* MOVE THE INVOICE EDIT TABLE CONTENTS TO THE VALID LOAD RECORD   09680000
096900*---------------------------------------------------------------* 09690000
097000 M300-MAP-VALID-LOAD-RECORD.                                      09700000
097100                                                                  09710000
097200     IF WS128-INVC-HEADER(INV-IDX)                                09720000
097300        MOVE WS128-INVC-VND-NBR(INV-IDX)                          09730000
097400                                     TO AP016-REMIT-TO-DUN-NBR    09740000
097500        MOVE WS128-INVC-PO-NBR(INV-IDX)                           09750000
097600                                     TO AP016-PO-NBR              09760000
097700        MOVE WS128-INVC-ID(INV-IDX)  TO AP016-INVC-ID             09770000
097800        MOVE WS128-INVC-DTE(INV-IDX) TO AP016-INVC-DTE            09780000
097900        MOVE WS128-INVC-NET-COST-AMT(INV-IDX)                     09790000
098000                                     TO AP016-INVC-NET-COST-AMT   09800000
098100        MOVE WS128-IMPRT-BOL-ID(INV-IDX)                          09810000
098200                                     TO AP016-IMPRT-BOL-ID        09820000
098300        MOVE WS128-CONTAINER-NBR(INV-IDX)                         09830000
098400                                     TO AP016-CONTAINER-NBR       09840000
098500     END-IF.                                                      09850000
098600                                                                  09860000
098700     IF WS128-INVC-CHARGES(INV-IDX) AND (TALCHRG-INDEX NOT =  20) 09870000
098800        SET TALCHRG-INDEX UP BY 1                                 09880000
098900        MOVE 'C'       TO AP016-ALW-CHRG-TYP-CDE(TALCHRG-INDEX)   09890000
099000                                                                  09900000
099100*       IF  WS128-CHRG-CDE(INV-IDX) = 'MSC'                       09910009
099200*           MOVE 'MIS' TO AP016-ALW-CHRG-CDE(TALCHRG-INDEX)       09920009
099300*       ELSE                                                      09930009
099400            MOVE WS128-CHRG-CDE(INV-IDX)                          09940000
099500                       TO AP016-ALW-CHRG-CDE(TALCHRG-INDEX)       09950000
099600*       END-IF                                                    09960009
099700                                                                  09970000
099800        MOVE WS128-CHRG-AMT(INV-IDX)                              09980000
099900                       TO AP016-ALW-CHRG-AMT(TALCHRG-INDEX)       09990000
100000     END-IF.                                                      10000000
100100                                                                  10010000
100200 EJECT                                                            10020000
100300*---------------------------------------------------------------* 10030000
100400* POPULATE THE REJECT ERRORS OF THE REJECT FORMAT FROM THE        10040000
100500* WORKING STORAGE ERROR TABLE.                                    10050000
100600*---------------------------------------------------------------* 10060000
100700 P100-POPULATE-REJECT-ERRORS.                                     10070000
100800                                                                  10080000
100900     SET AP129-IDX UP BY 1.                                       10090000
101000     MOVE WS-ERR-CDE(WS-ERR-IDX)                                  10100000
101100                                 TO AP129-ERR-CDE(AP129-IDX).     10110000
101200                                                                  10120000
101300 EJECT                                                            10130000
101400*---------------------------------------------------------------* 10140000
101500* READ THE TI INVOICE CONTROL FILE                                10150000
101600*---------------------------------------------------------------* 10160000
101700 R100-READ-CONTROL-RECD.                                          10170000
101800                                                                  10180000
101900     READ CONTROL-TOTAL-FILE INTO AP128-IMPORT-FREIGHT-RECORD     10190000
102000       AT END                                                     10200000
102100*     MOVE ZEROES TO WS-CNTL-RECD-CNT WS-NUM-NET-AMT              10210007
102110      SET END-OF-CNTRL-FILE   TO TRUE.                            10211003
102200                                                                  10220000
102300 EJECT                                                            10230000
102400*---------------------------------------------------------------* 10240000
102500* READ THE TI INVOICE CHARGES FILE                                10250000
102600*---------------------------------------------------------------* 10260000
102700 R200-READ-INVC-RECD.                                             10270000
102800                                                                  10280000
102900     READ FREIGHT-INVCS-FILE INTO AP128-IMPORT-FREIGHT-RECORD     10290000
103000       AT END                                                     10300000
103100      SET END-OF-INVC-FILE    TO TRUE.                            10310000
103200                                                                  10320000
103300     IF NOT END-OF-INVC-FILE                                      10330000
103400        ADD 1                 TO WS-CALC-RECD-CNT                 10340000
103500                                 WS-CHRGS-INP-CNT                 10350000
103600     END-IF.                                                      10360000
103700                                                                  10370000
103800*----------------------------------------------------------------*10380000
103900*    CHECKS FOR DUPLICATE PO/INVOICE ON TINVOIC TABLE.           *10390000
104000*----------------------------------------------------------------*10400000
104100 S100-CHECK-TINVOIC-PO-CONT.                                      10410000
104200                                                                  10420000
104300     EXEC SQL                                                     10430000
104400         SELECT '1'                                               10440000
104500           INTO :PC-ONE                                           10450000
104600           FROM SYSIBM.SYSDUMMY1 X                                10460000
104700          WHERE EXISTS                                            10470000
104800               (SELECT 1                                          10480000
104900                  FROM TINVOIC A                                  10490000
105000                 WHERE A.PO_NBR  = :PV-INVC-PO-NBR                10500000
105100                   AND A.INVC_ID LIKE :PV-LIKE-INVOICE-NBR        10510000
105200                   AND X.IBMREQD = X.IBMREQD)                     10520000
105300     END-EXEC.                                                    10530000
105400                                                                  10540000
105500     EVALUATE TRUE                                                10550000
105600         WHEN SQLCODE = ZERO                                      10560000
105700              SET DUPL-PO-INV-DB-ERR TO TRUE                      10570000
105800              SET INVOICE-ERROR      TO TRUE                      10580000
105900              IF WS-ERR-IDX NOT = 20                              10590000
106000                 SET WS-ERR-IDX UP BY 1                           10600000
106100              END-IF                                              10610000
106200              MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)    10620000
106300         WHEN SQLCODE = +100                                      10630000
106400              CONTINUE                                            10640000
106500         WHEN SQLWARN0 NOT = SPACES                               10650000
106600         WHEN SQLCODE  NOT = ZERO                                 10660000
106700              MOVE 'S100-CHECK-TINVOIC-PO-CONT'                   10670000
106800                                     TO WS-ABEND-PARAGRAPH        10680000
106900              MOVE 'UNSUCCESSFUL EXISTENCE CHECK'                 10690000
107000                                     TO WS-ABEND-OPERATION        10700000
107100              MOVE 'TINVOIC'         TO WS-ABEND-STRUCTURE-1      10710000
107200              MOVE SPACES            TO WS-ABEND-STRUCTURE-2      10720000
107300              PERFORM Z999-SQL-ERROR                              10730000
107400     END-EVALUATE.                                                10740000
107500                                                                  10750000
107600 EJECT                                                            10760000
107700*----------------------------------------------------------------*10770000
107800*    CHECKS FOR DUPLICATE PO/CONTAINER ON TEXINVC TABLE.         *10780000
107900*----------------------------------------------------------------*10790000
108000 S200-CHECK-TEXINVC-PO-CONT.                                      10800000
108100                                                                  10810000
108200     EXEC SQL                                                     10820000
108300         SELECT '1'                                               10830000
108400           INTO :PC-ONE                                           10840000
108500           FROM SYSIBM.SYSDUMMY1 X                                10850000
108600          WHERE EXISTS                                            10860000
108700               (SELECT 1                                          10870000
108800                  FROM TEXINVC A                                  10880000
108900                     , TINVOIC B                                  10890000
108900                     , TALCHRG C                                  10891017
109000                 WHERE A.PO_NBR         = :PV-INVC-PO-NBR         10900000
109100                   AND A.PO_NBR         = B.PO_NBR                10910000
109100                   AND A.PO_NBR         = C.PO_NBR                10911017
109200                   AND A.INVC_ID        = B.INVC_ID               10920000
109200                   AND A.INVC_ID        = C.INVC_ID               10921017
109300                   AND (A.IMPRT_BOL_ID  = :PV-IMPRT-BOL-ID        10930000
109400                    OR A.INVC_CONTNR_ID = :PV-CONTAINER-NBR)      10940000
109500                   AND B.RMIT_VND_ID    = :PV-INVC-VND-NBR        10950000
109500                   AND C.ALW_CHRG_CDE   = :PC-OAF-CHRG            10951017
109600                   AND X.IBMREQD        = X.IBMREQD)              10960000
109700     END-EXEC.                                                    10970000
109800                                                                  10980000
109900     EVALUATE TRUE                                                10990000
110000         WHEN SQLCODE = ZERO                                      11000000
110100              SET PO-CONTNR-DUP-INV-ERR TO TRUE                   11010000
110200              SET INVOICE-ERROR         TO TRUE                   11020000
110300              IF WS-ERR-IDX NOT = 20                              11030000
110400                 SET WS-ERR-IDX UP BY 1                           11040000
110500              END-IF                                              11050000
110600              MOVE WS010-ERROR-CODES    TO WS-ERR-CDE(WS-ERR-IDX) 11060000
110700         WHEN SQLCODE = +100                                      11070000
110800              CONTINUE                                            11080000
110900         WHEN SQLWARN0 NOT = SPACES                               11090000
111000         WHEN SQLCODE  NOT = ZERO                                 11100000
111100              MOVE 'S200-CHECK-TEXINVC-PO-CONT'                   11110000
111200                                        TO WS-ABEND-PARAGRAPH     11120000
111300              MOVE 'UNSUCCESSFUL EXISTENCE CHECK'                 11130000
111400                                        TO WS-ABEND-OPERATION     11140000
111500              MOVE 'TEXINVC'            TO WS-ABEND-STRUCTURE-1   11150000
111600              MOVE SPACES               TO WS-ABEND-STRUCTURE-2   11160000
111700              PERFORM Z999-SQL-ERROR                              11170000
111800     END-EVALUATE.                                                11180000
111900                                                                  11190000
112000 EJECT                                                            11200000
112100*---------------------------------------------------------------* 11210000
112200* CHECK FOR VALID DUNS NUMBER BY SELECTING THE ENT_NAME_DESC.   * 11220000
112300* VENDOR MUST BE ACTIVE.                                        * 11230000
112400*---------------------------------------------------------------* 11240000
112500 S300-SELECT-TENTNME.                                             11250000
112600                                                                  11260000
112700     EXEC SQL                                                     11270000
112800        SELECT B.ENT_NAME_DESC                                    11280000
112900          INTO :ENTNME-ENT-NAME-DESC                              11290000
113000          FROM TEXTENT A                                          11300000
113100              ,TENTNME B                                          11310000
113200         WHERE  A.ENT_ID       = B.ENT_ID                         11320000
113300           AND  A.DUN_NBR      = :EXTENT-DUN-NBR                  11330000
113400           AND  A.SCAC_CDE     <> '    '                          11340000
113500           AND  A.STATUS_CDE   = 'A'                              11350000
113600           AND  B.TYPE_CDE     = '01'                             11360000
113700     END-EXEC.                                                    11370000
113800                                                                  11380000
113900     EVALUATE TRUE                                                11390000
114000        WHEN SQLCODE = ZEROS                                      11400000
114100             CONTINUE                                             11410000
114200        WHEN SQLCODE = +100                                       11420000
114300             IF WS-ERR-IDX NOT = 20                               11430000
114400                SET WS-ERR-IDX UP BY 1                            11440000
114500             END-IF                                               11450000
114600             SET INVOICE-ERROR          TO TRUE                   11460000
114700             SET INVALID-VENDOR-NBR-ERR TO TRUE                   11470000
114800             MOVE WS010-ERROR-CODES     TO WS-ERR-CDE(WS-ERR-IDX) 11480000
114900        WHEN OTHER                                                11490000
115000             MOVE 'S300-SELECT-TENTNME'  TO WS-ABEND-PARAGRAPH    11500000
115100             MOVE 'UNSUCCESSFUL SELECT EXTENT'                    11510000
115200                                         TO WS-ABEND-OPERATION    11520000
115300             MOVE 'TENTNME '             TO WS-ABEND-STRUCTURE-1  11530000
115400             MOVE 'TEXTENT '             TO WS-ABEND-STRUCTURE-2  11540000
115500             PERFORM Z999-SQL-ERROR                               11550000
115600     END-EVALUATE.                                                11560000
115700                                                                  11570000
115800 EJECT                                                            11580000
115900*---------------------------------------------------------------* 11590000
116000* CHECK FOR EXISTENCE CONTAINER NUMBER                            11600000
116100*---------------------------------------------------------------* 11610000
116200 S400-CHECK-TIMCNTK.                                              11620000
116300                                                                  11630000
116400     EXEC SQL                                                     11640000
116500         SELECT A.CONTNR_ID                                       11650000
116600               ,A.CONTNR_SEQ_NBR                                  11660000
116700         INTO :IMCNTK-CONTNR-ID                                   11670000
116800             ,:IMCNTK-CONTNR-SEQ-NBR                              11680000
116900         FROM TIMCNTK A                                           11690000
117000         WHERE A.CONTNR_ID = :PV-CONTAINER-NBR                    11700000
117100         FETCH FIRST 1 ROW ONLY                                   11710000
117200     END-EXEC.                                                    11720000
117300                                                                  11730000
117400     EVALUATE TRUE                                                11740000
117500         WHEN SQLCODE = ZERO                                      11750000
117600              CONTINUE                                            11760000
117700         WHEN SQLCODE = +100                                      11770000
117800              IF WS-ERR-IDX NOT = 20                              11780000
117900                 SET WS-ERR-IDX UP BY 1                           11790000
118000              END-IF                                              11800000
118100              SET INVOICE-ERROR      TO TRUE                      11810000
118200              SET INVALID-CONTAINER-NBR-ERR                       11820000
118300                                     TO TRUE                      11830000
118400              MOVE WS010-ERROR-CODES TO WS-ERR-CDE(WS-ERR-IDX)    11840000
118500         WHEN SQLWARN0 NOT = SPACES                               11850000
118600         WHEN SQLCODE  NOT = ZERO                                 11860000
118700              MOVE 'S400-CHECK-TIMCNTK'                           11870000
118800                                     TO WS-ABEND-PARAGRAPH        11880000
118900              MOVE 'UNSUCCESSFUL EXISTENCE CHECK'                 11890000
119000                                     TO WS-ABEND-OPERATION        11900000
119100              MOVE 'TIMCNTK '        TO WS-ABEND-STRUCTURE-1      11910000
119200              MOVE SPACES            TO WS-ABEND-STRUCTURE-2      11920000
119300              MOVE SPACES            TO WS-ABEND-STRUCTURE-2      11930000
119400              PERFORM Z999-SQL-ERROR                              11940000
119500     END-EVALUATE.                                                11950000
119600                                                                  11960000
119700 EJECT                                                            11970000
119800*---------------------------------------------------------------* 11980000
119900* CHECK FOR EXISTENCE OF VALID PO/CONTAINER ID COMBINATION        11990000
120000*---------------------------------------------------------------* 12000000
120100 S500-CHECK-PO-CONTNR.                                            12010000
120200                                                                  12020000
120300     EXEC SQL                                                     12030000
120400         SELECT '1'                                               12040000
120500           INTO :PC-ONE                                           12050000
120600           FROM SYSIBM.SYSDUMMY1 X                                12060000
120700          WHERE EXISTS                                            12070000
120800               (SELECT 1                                          12080000
120900                  FROM TIMCNPO A                                  12090000
121000                 WHERE A.CONTNR_ID = :PV-CONTAINER-NBR            12100000
121100                   AND A.PO_NBR    = :PV-INVC-PO-NBR              12110000
121200                   AND X.IBMREQD   = X.IBMREQD)                   12120000
121300     END-EXEC.                                                    12130000
121400                                                                  12140000
121500     EVALUATE TRUE                                                12150000
121600         WHEN SQLCODE = ZERO                                      12160000
121700              CONTINUE                                            12170000
121800         WHEN SQLCODE = +100                                      12180000
121900              SET INVALID-PO-CONTNR-ERR TO TRUE                   12190000
122000              SET INVOICE-ERROR         TO TRUE                   12200000
122100              IF WS-ERR-IDX NOT = 20                              12210000
122200                 SET WS-ERR-IDX UP BY 1                           12220000
122300              END-IF                                              12230000
122400              MOVE WS010-ERROR-CODES    TO WS-ERR-CDE(WS-ERR-IDX) 12240000
122500         WHEN SQLWARN0 NOT = SPACES                               12250000
122600         WHEN SQLCODE  NOT = ZERO                                 12260000
122700              MOVE 'S500-CHECK-PO-CONTNR '                        12270000
122800                                        TO WS-ABEND-PARAGRAPH     12280000
122900              MOVE 'UNSUCCESSFUL EXISTENCE CHECK'                 12290000
123000                                        TO WS-ABEND-OPERATION     12300000
123100              MOVE 'TIMCNPO '           TO WS-ABEND-STRUCTURE-1   12310000
123200              MOVE SPACES               TO WS-ABEND-STRUCTURE-2   12320000
123300              PERFORM Z999-SQL-ERROR                              12330000
123400     END-EVALUATE.                                                12340000
123500                                                                  12350000
123600 EJECT                                                            12360000
123700*---------------------------------------------------------------* 12370000
123800* CHECK FOR VALID PURCHASE ORDER NUMBER BY SELECTING THE          12380000
123900* PO_TYP_CDE (THE PO MUST BE ACTIVE).                             12390000
124000*---------------------------------------------------------------* 12400000
124100 S600-SELECT-TPURCHS.                                             12410000
124200                                                                  12420000
124300     EXEC SQL                                                     12430000
124400         SELECT PO_TYP_CDE                                        12440000
124500         INTO  :PURCHS-PO-TYP-CDE                                 12450000
124600         FROM  TPURCHS                                            12460000
124700         WHERE PO_NBR         = :PV-INVC-PO-NBR                   12470000
124800           AND VER_STATUS_CDE = 'A'                               12480000
124900     END-EXEC.                                                    12490000
125000                                                                  12500000
125100     EVALUATE TRUE                                                12510000
125200        WHEN SQLCODE = ZEROS                                      12520000
125300             SET PS-VALID-PO-NBR         TO TRUE                  12530000
125400        WHEN SQLCODE = +100                                       12540000
125500             SET PS-NOT-VALID-PO-NBR     TO TRUE                  12550000
125600        WHEN OTHER                                                12560000
125700             MOVE 'S600-SELECT-TPURCHS ' TO WS-ABEND-PARAGRAPH    12570000
125800             MOVE 'UNSUCCESSFUL SELECT PURCHS'                    12580000
125900                                         TO WS-ABEND-OPERATION    12590000
126000             MOVE 'TPURCHS '             TO WS-ABEND-STRUCTURE-1  12600000
126100             MOVE SPACES                 TO WS-ABEND-STRUCTURE-2  12610000
126200             PERFORM Z999-SQL-ERROR                               12620000
126300     END-EVALUATE.                                                12630000
126400                                                                  12640000
126500 EJECT                                                            12650000
126600*----------------------------------------------------------------*12660000
126700*    CHECKS FOR DUPLICATE VENDOR/INVOICE ON TADJRNL TABLE.       *12670000
126800*----------------------------------------------------------------*12680000
126900 S700-CHECK-TADJRNL.                                              12690000
127000                                                                  12700000
127100     EXEC SQL                                                     12710000
127200         SELECT '1'                                               12720000
127300           INTO :PC-ONE                                           12730000
127400           FROM SYSIBM.SYSDUMMY1 X                                12740000
127500          WHERE EXISTS                                            12750000
127600               (SELECT 1                                          12760000
127700                  FROM TADJRNL A                                  12770000
127800                 WHERE A.VND_NBR    = :PV-INVC-VND-NBR            12780000
127900                   AND A.DOC_NBR LIKE :PV-INVC-FOR-LIKE-COND      12790000
128000                   AND A.PO_NBR     = :PV-INVC-PO-NBR             12800000
128100                   AND A.DOC_DTE    = :PV-INVC-DTE                12810000
128200                   AND X.IBMREQD    = X.IBMREQD)                  12820000
128300     END-EXEC.                                                    12830000
128400                                                                  12840000
128500     EVALUATE TRUE                                                12850000
128600         WHEN SQLCODE = ZERO                                      12860000
128700              SET DUPL-VND-INV-ADJ-ERR TO TRUE                    12870000
128800              SET INVOICE-ERROR        TO TRUE                    12880000
128900              IF WS-ERR-IDX NOT = 20                              12890000
129000                 SET WS-ERR-IDX UP BY 1                           12900000
129100              END-IF                                              12910000
129200              MOVE WS010-ERROR-CODES   TO WS-ERR-CDE(WS-ERR-IDX)  12920000
129300         WHEN SQLCODE = +100                                      12930000
129400              CONTINUE                                            12940000
129500         WHEN SQLWARN0 NOT = SPACES                               12950000
129600         WHEN SQLCODE  NOT = ZERO                                 12960000
129700              MOVE 'S700-CHECK-TADJRNL'                           12970000
129800                                       TO WS-ABEND-PARAGRAPH      12980000
129900              MOVE 'UNSUCCESSFUL EXISTENCE CHECK'                 12990000
130000                                       TO WS-ABEND-OPERATION      13000000
130100              MOVE 'TADJRNL'           TO WS-ABEND-STRUCTURE-1    13010000
130200              MOVE SPACES              TO WS-ABEND-STRUCTURE-2    13020000
130300              PERFORM Z999-SQL-ERROR                              13030000
130400     END-EVALUATE.                                                13040000
130500                                                                  13050000
130600 EJECT                                                            13060000
130700*---------------------------------------------------------------* 13070000
130800* WRITE OUT A RECORD TO THE VALID INVOIVE LOAD FILE               13080000
130900*---------------------------------------------------------------* 13090000
131000 W100-WRITE-VALID-INVC-RECORD.                                    13100000
131100                                                                  13110000
131200     WRITE VALID-INVC-RECORD FROM AP016-INVOICE-LOAD-RECORD.      13120000
131300                                                                  13130000
131400     INITIALIZE AP016-INVOICE-LOAD-RECORD.                        13140000
131500                                                                  13150000
131600     ADD 1                    TO WS-VALID-INVC-CNT.               13160000
131700                                                                  13170000
131800 EJECT                                                            13180000
131900*---------------------------------------------------------------* 13190000
132000* WRITE OUT A RECORD TO THE REJECT FILE.                          13200000
132100*---------------------------------------------------------------* 13210000
132200 W200-WRITE-REJECT-RECORD.                                        13220000
132300                                                                  13230000
132400     WRITE INVC-ERRORS-RECORD FROM AP129-FRGT-INV-REJECT-RECORD.  13240000
132500                                                                  13250000
132600     INITIALIZE AP129-FRGT-INV-REJECT-RECORD.                     13260000
132700                                                                  13270000
132800     ADD 1                    TO WS-REJECT-REC-CNT.               13280000
132900                                                                  13290000
133000 EJECT                                                            13300000
133100*---------------------------------------------------------------* 13310000
133200*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                 *13320000
133300*---------------------------------------------------------------* 13330000
133400 Z100-ABEND.                                                      13340000
133500                                                                  13350000
133600     DISPLAY '** ABEND           **'.                             13360000
133700     DISPLAY '** PROGRAM         ** = ' WS-ABEND-PROGRAM.         13370000
133800     DISPLAY '** PARAGRAPH       ** = ' WS-ABEND-PARAGRAPH.       13380000
133900     DISPLAY '** OPERATION       ** = ' WS-ABEND-OPERATION.       13390000
134000                                                                  13400000
134100     CALL  'ILBOABN0' USING ABEND-CODE.                           13410000
134200                                                                  13420000
134300 EJECT                                                            13430000
134400*---------------------------------------------------------------* 13440000
134500* PROCESS DB2 ABENDS.                                             13450000
134600*---------------------------------------------------------------* 13460000
134700 Z999-SQL-ERROR.                                                  13470000
134800                                                                  13480000
134900     DISPLAY '*** DB2 ERROR '.                                    13490000
135000     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 13500000
135100     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               13510000
135200     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               13520000
135300     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             13530000
135400     IF WS-ABEND-STRUCTURE-2 > SPACES                             13540000
135500         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         13550000
135600                                                                  13560000
135700     MOVE +4013                    TO ABEND-CODE.                 13570000
135800                                                                  13580000
135900     COPY DPPD004.                                                13590000
136000                                                                  13600000
136100     CALL 'ILBOABN0' USING ABEND-CODE.                            13610000
