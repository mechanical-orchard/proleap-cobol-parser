000100 IDENTIFICATION DIVISION.                                         00010011
000200 PROGRAM-ID.      XSKUP131.                                       00020011
000300 AUTHOR.          MEDHA CHOUDHURY.                                00030011
000400 DATE-WRITTEN.    FEBRUARY 2010.                                  00040011
000500*--------------------------------------------------------------*  00050011
000600* DESCRIPTION:                                                 *  00060011
000700*      PERFORMS PURGE PROCESS FOR PRICE CHANGE DATA WITHIN     *  00070011
000800*      THE XS DOMAIN HISTORY TABLES. THERE ARE TWO CURSORS,    *  00080011
000900*      PRIMARY AND SECONDARY. PRIMARY MEANS PARENT ROWS THAT   *  00090011
000901*      HAVE CHILD ROWS, AND SECONDARY MEANS PARENT ROWS THAT   *  00100011
000902*      DO NOT HAVE CHILD ROWS ASSOCIATED WITH THEM. THERE IS   *  00110011
000903*      RI (CASCADE) ADDED BETWEEN XST_PRCHGH AND               *  00120011
000904*      XST_PRCHG_MDSEH ON PRCHG_ID AND ANOTHER RI (CASCADE)    *  00130011
000905*      BETWEEN XST_PRCHGH AND XST_STR_GP_PRCHGH ON PRCHG_ID.   *  00140011
000906*      HENCE, PURGING AT THE XST_PRCHGH LEVEL MEANS THAT THE   *  00150011
000907*      XST_STR_GP_PRCHGH AND XST_PRCHG_MDSEH ROWS WILL ALSO    *  00160011
000908*      DELETE THROUGH THE RI. COMMIT HAPPENS EVERY 3000 ROWS.  *  00170026
000909*                                                              *  00180011
001000*  INPUTS:                                                     *  00190011
001100*      CURSOR DATA. NO INPUT FILE.                             *  00200011
001200*                                                              *  00210011
001300*  OUTPUTS:                                                    *  00220011
001400*      NONE                                                    *  00230011
001500*--------------------------------------------------------------*  00240011
001600*--------------------------------------------------------------*  00250011
001700* HISTORY LOG:                                                    00260011
001800*--------------------------------------------------------------*  00270011
001900* DATE:        02/03/2010                                         00280011
002000* WR/IR#:      WR33394                                            00290011
002100* PROGRAMMER:  MEDHA CHOUDHURY                                    00300011
002200* DESCRIPTION: PURGE PRCHGH, STR_GP_PRCHGH & PRCHG_MDSEH DATA.    00310011
002400*--------------------------------------------------------------*  00320011
002500* DATE:                                                           00330011
002600* WR/IR#:                                                         00340011
002700* PROGRAMMER:                                                     00350011
002800* DESCRIPTION:                                                    00360011
002900*--------------------------------------------------------------*  00370011
003000 ENVIRONMENT DIVISION.                                            00380011
003100 CONFIGURATION SECTION.                                           00390011
003200 SOURCE-COMPUTER.        IBM-3090.                                00400011
003300 OBJECT-COMPUTER.        IBM-3090.                                00410011
003400 INPUT-OUTPUT SECTION.                                            00420011
003500                                                                  00430011
003600 DATA DIVISION.                                                   00440011
003700 FILE SECTION.                                                    00450011
003800                                                                  00460011
003900*--------------------------------------------------------------*  00470011
004000 WORKING-STORAGE SECTION.                                         00480011
004100*--------------------------------------------------------------*  00490011
004200 01  PS-PROGRAM-SWITCHES.                                         00500011
004300     05  PS-END-OF-FILE-SW            PIC  X(001).                00510011
004400         88  PS-END-OF-FILE-YES                   VALUE 'Y'.      00520011
004500         88  PS-END-OF-FILE-NO                    VALUE 'N'.      00530011
004600     05  PS-RESTART-REQUIRED-SW  PIC X(01)          VALUE 'N'.    00540011
004700         88  PS-RESTART-REQUIRED                    VALUE 'Y'.    00550011
004800         88  PS-RESTART-NOT-REQUIRED                VALUE 'N'.    00560011
016400*PTASK0033859 START                                               00570011
016401     05  PS-PRIMARY-CURSOR-SW        PIC X(01) VALUE 'Y'.         00580012
016402         88  PS-MORE-DATA-PRI                  VALUE 'Y'.         00590011
016403         88  PS-NO-MORE-DATA-PRI               VALUE 'N'.         00600011
016404     05  PS-SECONDARY-CURSOR-SW      PIC X(01) VALUE 'Y'.         00610012
016405         88  PS-MORE-DATA-SEC                  VALUE 'Y'.         00620011
016406         88  PS-NO-MORE-DATA-SEC               VALUE 'N'.         00630011
016407*PTASK0033859 END                                                 00640011
016408*--------------------------------------------------------------*  00650011
016409* PROGRAM CONSTANTS                                               00660011
016410*--------------------------------------------------------------*  00670011
016411 01  PC-PROGRAM-CONSTANTS.                                        00680011
016412     05  PC-JOB-NAME             PIC  X(06)  VALUE 'XSK126'.      00690011
016413     05  PC-CKPT-JOB-NAME        PIC  X(06)  VALUE 'XSK126'.      00700011
016415     05  PC-CKPT-PLAN-NAME       PIC  X(08)  VALUE 'XSKUP131'.    00710011
016416     05  PC-PROGRAM-NAME         PIC  X(08)  VALUE 'XSKUP131'.    00720011
016417     05  PC-MAX-RETRIES          PIC S9(03)  VALUE +3 COMP-3.     00730011
016418     05  PC-MAX-DEADLOCKS        PIC S9(03)  VALUE +3 COMP-3.     00740011
016440*PTASK0033859 START                                               00750011
      ********                                                          00760025
016441     05  PC-MAX-COMMIT-COUNT     PIC S9(05)  VALUE +10 COMP-3.    00770034
016441     05  PV-DB2-COUNT            PIC S9(9) COMP VALUE ZERO.       00780017
      ********                                                          00790025
016442*PTASK0033859 END                                                 00800011
016443     05  PC-TRAN-PRES-FUNC-CODES.                                 00810011
016444         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00820011
016445         10  PC-TRAN-PRES-FUNC-CKPT   PIC  X(05)  VALUE 'CKPT '.  00830011
016446         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00840011
016447         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00850011
016448         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00860011
016449*--------------------------------------------------------------*  00870011
016450* PV- PROGRAM VARIABLES                                           00880011
016451*--------------------------------------------------------------*  00890011
016452 01  PV-PROGRAM-VARAIBLES.                                        00900011
016453     05  PV-PARAGRAPH-NAME        PIC X(40)   VALUE SPACES.       00910011
016454     05  PV-SQL-SUB               PIC S9(09)  VALUE 0  COMP.      00920011
016455     05  PV-RETRY                 PIC 9999    VALUE 0  COMP.      00930011
016456     05  PV-ABEND-CODE            PIC 9999    VALUE 0  COMP.      00940011
016457     05  PV-CALC-DB2-DATE         PIC  X(10)  VALUE SPACES.       00950011
016458     05  PV-CALC-NBR-DAYS         PIC  9(05)  VALUE 0.            00960011
016459     05  PV-DEL-MARK-TMST         PIC  X(26)  VALUE SPACES.       00970011
016460     05  PV-DEL-EXPIRE-DATE       PIC  X(10)  VALUE SPACES.       00980011
016461     05  PV-DEL-OLDER-DATE        PIC  X(10)  VALUE SPACES.       00990011
016462     05  PV-LAST-PRCHG-ID         PIC  S9(9)  VALUE ZEROES COMP.  01000011
016463     05  PV-EXIST-VAR             PIC  S9(4)  COMP SYNC.          01010011
016464*PTASK0033859 START                                               01020011
016465     05  PV-FETCH-PRI-COUNT       PIC  S9(9).                     01030011
016466     05  PV-FETCH-SEC-COUNT       PIC  S9(9).                     01040011
027504******PV-PRCHG-IDP IS THE HOST VARIABLE FOR PRIMARY CURSOR        01050011
027505     05  PV-PRCHG-IDP             PIC  S9(9) COMP.                01060011
027842******PV-PRCHG-IDS IS THE HOST VARIABLE FOR SECONDARY CURSOR      01070011
027843     05  PV-PRCHG-IDS             PIC  S9(9) COMP.                01080011
027844     05  PV-PRI-COMMIT-COUNT      PIC  S9(5) VALUE 0.             01090011
027845     05  PV-SEC-COMMIT-COUNT      PIC  S9(5) VALUE 0.             01100011
027846*PTASK0033859 END                                                 01110011
027852*--------------------------------------------------------------*  01120011
027853* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01130011
027854*--------------------------------------------------------------*  01140011
027855     COPY DPWS004.                                                01150011
027856                                                                  01160011
027857*--------------------------------------------------------------*  01170011
027858* DATE ROUTINE COPY MEMBERS                                       01180011
027859*--------------------------------------------------------------*  01190011
027860     COPY DPWS500.                                                01200011
027861                                                                  01210011
027862*--------------------------------------------------------------*  01220011
027863* DB2 ABEND COPYBOOK                                              01230011
027864*--------------------------------------------------------------*  01240011
027865     COPY DPWS900.                                                01250011
027866                                                                  01260011
027867*--------------------------------------------------------------*  01270011
027868* DB2 MESSAGE AREA                                                01280011
027869*--------------------------------------------------------------*  01290011
027870     COPY SQLCA2.                                                 01300011
027871*--------------------------------------------------------------*  01310011
027872* PROGRAM COUNTERS                                                01320011
027873*--------------------------------------------------------------*  01330011
027874 01  PV-PROGRAM-COUNTERS         COMP-3.                          01340011
027875     05  PV-NUMBER-OF-RETRIES     PIC 9(9) VALUE 0.               01350011
027876                                                                  01360011
027877*PTASK0033859 START                                               01370011
027878     05  PV-TOTAL-DEL-CNT         PIC 9(9) VALUE 0.               01380011
027879     05  PV-PRIMARY-DEL-CNT       PIC 9(9) VALUE 0.               01390011
027879     05  PV-CHILDREN-DEL-CNT      PIC 9(9) VALUE 0.               01400016
027880     05  PV-SECONDARY-DEL-CNT     PIC 9(9) VALUE 0.               01410011
027881*PTASK0033859 END                                                 01420011
027882                                                                  01430011
027883*--------------------------------------------------------------*  01440011
027884* ERROR HANDLING                                                  01450011
027885*--------------------------------------------------------------*  01460011
027886 01  PV-MISC-ABEND-FIELDS.                                        01470011
027887     05  PV-OPERATION-MSG-1      PIC X(40) VALUE SPACES.          01480011
027888     05  PV-OPERATION-MSG-2      PIC X(40) VALUE SPACES.          01490011
027889     05  PV-DB2-OPERATION        PIC X(30) VALUE SPACES.          01500011
027890                                                                  01510011
027891 01  ABEND-CODE                  PIC S9(4) VALUE 0  COMP SYNC.    01520011
027892     88  ABEND-4003-CTRL-CARD-ERROR        VALUE +4003.           01530011
027893     88  ABEND-4013-DB2-ERROR              VALUE +4013.           01540011
027894     88  ABEND-4019-CAL-SUB-ERROR          VALUE +4019.           01550011
027895     88  ABEND-4020-MQ-ERROR               VALUE +4020.           01560011
027896     88  ABEND-4444-FORCED-ABEND           VALUE +4444.           01570011
027897     88  ABEND-4008                        VALUE +4008.           01580011
027898     88  ABEND-4005                        VALUE +4005.           01590011
027899                                                                  01600011
027900*--------------------------------------------------------------*  01610011
027901* DB2 COMMUNICATIONS AREA                                         01620011
027902*--------------------------------------------------------------*  01630011
027903     EXEC SQL                                                     01640011
027904       INCLUDE SQLCA                                              01650011
027905     END-EXEC.                                                    01660011
027906                                                                  01670011
027907*--------------------------------------------------------------*  01680011
027908* DB2 TABLE XST00127 (XST_PRCHGH) PRICE CHANGE TABLE              01690011
027909*--------------------------------------------------------------*  01700011
027910     EXEC SQL                                                     01710011
027911       INCLUDE XST00127                                           01720011
027912     END-EXEC.                                                    01730011
027913                                                                  01740011
027914*--------------------------------------------------------------*  01750011
027915* DB2 TABLE XST00128 (XST_STR_GP_PRCHGH) STORE GROUP PRICE CHANGE 01760011
027916*--------------------------------------------------------------*  01770011
027917     EXEC SQL                                                     01780011
027918       INCLUDE XST00128                                           01790011
027919     END-EXEC.                                                    01800011
027920                                                                  01810011
027921*--------------------------------------------------------------*  01820011
027922* DB2 TABLE XST00129 (XST_PRCHG_MDSEH) PRICE CHANGE MERCHANDISE   01830011
027923*--------------------------------------------------------------*  01840011
027924     EXEC SQL                                                     01850011
027925       INCLUDE XST00129                                           01860011
027926     END-EXEC.                                                    01870011
027927                                                                  01880011
027928*PTASK0033859 START                                               01890011
027929     EXEC SQL                                                     01900011
027930         DECLARE PRI-CURSOR CURSOR WITH HOLD FOR                  01910011
027931          SELECT DISTINCT PRCHG_ID                                01920011
027933            FROM XST_STR_GP_PRCHGH                                01930011
027934           WHERE PRCHG_EFF_DTE < CURRENT DATE - 1 YEAR            01940023
027935           ORDER BY PRCHG_ID                                      01950011
027936     END-EXEC.                                                    01960011
027937                                                                  01970011
027938     EXEC SQL                                                     01980011
027939         DECLARE SEC-CURSOR CURSOR WITH HOLD FOR                  01990011
027940           SELECT DISTINCT A.PRCHG_ID                             02000011
027942            FROM  XST_PRCHGH A                                    02010011
027943            WHERE NOT EXISTS                                      02020011
027944                 (SELECT 1                                        02030011
027945                    FROM XST_STR_GP_PRCHGH B                      02040011
027946                   WHERE A.PRCHG_ID = B.PRCHG_ID)                 02050011
028000                      OR NOT EXISTS                               02060011
028100                        (SELECT 1                                 02070011
028200                           FROM XST_PRCHG_MDSEH C                 02080011
028300                          WHERE A.PRCHG_ID = C.PRCHG_ID)          02090011
028301           ORDER BY A.PRCHG_ID                                    02100011
028302     END-EXEC.                                                    02110011
028303                                                                  02120011
028304*PTASK0033859 END                                                 02130011
028305******************************************************************02140011
028306*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             02150011
028307******************************************************************02160011
260107     COPY DPWS991.                                                02161032
018200                                                                  02162032
028308     COPY DPLS001.                                                02170011
028309     05  WORK-STORAGE-PASSED.                                     02180011
028310******************************************************************02190011
028311*PA - PROGRAM ACCUMULATORS                                        02200011
028312******************************************************************02210011
028313         10  PROGRAM-ACCUMULATORS.                                02220011
028314             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 02230011
028315                                                       COMP-3.    02240011
028316                                                                  02250011
028317*--------------------------------------------------------------*  02260011
028318 PROCEDURE DIVISION.                                              02270011
028319*--------------------------------------------------------------*  02280011
028320 0000-MAINLINE.                                                   02290011
028321                                                                  02300011
028322     PERFORM 1000-INITIALIZATION.                                 02310011
028323                                                                  02320011
028324*    PERFORM 2000-PROCESS-DELETES UNTIL DP001-PREP-TRANS-EOF.     02330011
028324     PERFORM 2000-PROCESS-DELETES.                                02340011
028325                                                                  02350011
028326     PERFORM 9999-WRAPUP.                                         02360011
028327                                                                  02370011
028328     GOBACK.                                                      02380011
028329                                                                  02390011
056291**************************************************************    02400011
056292* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02410011
056293**************************************************************    02420011
056294 1000-INITIALIZATION.                                             02430011
056295                                                                  02440011
056296     DISPLAY '********************************************'.      02450011
056297     DISPLAY '*   START OF PROGRAM XSKUP131              *'.      02460011
056298     DISPLAY '********************************************'.      02470011
056299                                                                  02480011
056301                                                                  02490011
056304                                                                  02500011
056305******************************************************************02510011
056306*  MAIN PROCESSING PARAGRAPH.                                     02520011
056307******************************************************************02530011
056308 2000-PROCESS-DELETES.                                            02540011
056309*    DISPLAY '***2000***'.                                        02550022
056309                                                                  02560021
056310*    SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02570011
056311                                                                  02580011
056312     PERFORM 2100-OPEN-PRI-CURSOR.                                02590011
056313                                                                  02600011
056314     PERFORM 2200-FETCH-PRI-CURSOR                                02610011
056315       UNTIL PS-NO-MORE-DATA-PRI.                                 02620011
056316                                                                  02630011
056317     PERFORM 2300-CLOSE-PRI-CURSOR.                               02640011
056318                                                                  02650011
056319     PERFORM 3100-OPEN-SEC-CURSOR.                                02660011
056320                                                                  02670011
056321     PERFORM 3200-FETCH-SEC-CURSOR                                02680011
056322       UNTIL PS-NO-MORE-DATA-SEC.                                 02690011
056323                                                                  02700011
056324     PERFORM 3300-CLOSE-SEC-CURSOR.                               02710011
056467*----------------------------------------------------------------*02720011
056468*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02730011
056469*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02740011
056470*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02750011
056471*----------------------------------------------------------------*02760011
056491*PTASK0033859 START                                               02770011
056492**************************************************************** *02780011
056493*** OPEN PRIMARY CURSOR                                        * *02790011
056494**************************************************************** *02800011
056495 2100-OPEN-PRI-CURSOR.                                            02810011
056496****************************************************************  02820011
056309*    DISPLAY '***2100***'.                                        02830022
056498           EXEC SQL                                               02840011
056499             OPEN PRI-CURSOR                                      02850011
056500           END-EXEC.                                              02860011
056501                                                                  02870011
056502          EVALUATE TRUE                                           02880011
056503            WHEN SQLCODE = 0                                      02890011
056504                 CONTINUE                                         02900011
056505            WHEN SQLWARN0 NOT EQUAL SPACE                         02910011
056506            WHEN SQLCODE  NOT EQUAL ZERO                          02920011
056507                 MOVE '2100-OPEN-PRI-CURSOR'                      02930011
056508                           TO PV-PARAGRAPH-NAME                   02940011
056509                 MOVE 'OPEN TABLE CURSOR'                         02950011
056510                           TO PV-DB2-OPERATION                    02960011
056511            PERFORM  Z900-SQL-ABEND                               02970011
056512          END-EVALUATE.                                           02980011
056513                                                                  02990011
056514**************************************************************** *03000011
056515*** FETCH PRIMARY CURSOR                                       * *03010011
056516****************************************************************  03020011
056517 2200-FETCH-PRI-CURSOR.                                           03030011
056518****************************************************************  03040011
056309*    DISPLAY '***2200***'.                                        03050022
056519        EXEC SQL                                                  03060011
056520            FETCH PRI-CURSOR                                      03070011
056521             INTO :PV-PRCHG-IDP                                   03080011
056522        END-EXEC.                                                 03090011
056523                                                                  03100011
056524        EVALUATE TRUE                                             03110011
056525            WHEN SQLCODE = ZERO                                   03120011
056526*          SET PS-MORE-DATA-PRI TO TRUE                           03130011
056527             ADD +1 TO PV-PRI-COMMIT-COUNT                        03140011
056528             PERFORM 4000-DELETE-PRI-MDSE                         03150011
056529           CONTINUE                                               03160011
056530                                                                  03170011
056531            WHEN SQLCODE = +100                                   03180011
056532             SET PS-NO-MORE-DATA-PRI TO TRUE                      03190011
056533                                                                  03200011
056534            WHEN SQLWARN0 NOT EQUAL SPACE                         03210011
056535            WHEN SQLCODE  NOT EQUAL ZERO                          03220011
056536              MOVE '2200-FETCH-PRI-CURSOR'                        03230011
056537                              TO PV-PARAGRAPH-NAME                03240011
056538              MOVE 'FETCH TABLE CURSOR'                           03250011
056539                              TO PV-DB2-OPERATION                 03260011
056540                        PERFORM  Z900-SQL-ABEND                   03270011
056541        END-EVALUATE.                                             03280011
056542******************************************************************03290011
056543*** CLOSE PRIMARY CURSOR                                          03300011
056544******************************************************************03310011
056545 2300-CLOSE-PRI-CURSOR.                                           03320011
056546******************************************************************03330011
056309*    DISPLAY '***2300***'.                                        03340022
056547     EXEC SQL                                                     03350011
056548          CLOSE PRI-CURSOR                                        03360011
056549     END-EXEC.                                                    03370011
056550                                                                  03380011
056551     EVALUATE TRUE                                                03390011
056552         WHEN SQLCODE = ZERO                                      03400011
056553            CONTINUE                                              03410011
056554                                                                  03420011
056555         WHEN SQLCODE NOT EQUAL ZERO                              03430011
056556         WHEN SQLWARN0 NOT EQUAL SPACE                            03440011
056557              MOVE '2300-CLOSE-PRI-CURSOR'                        03450011
056558                                 TO PV-PARAGRAPH-NAME             03460011
056559              MOVE 'CLOSE TABLE CURSOR'                           03470011
056560                                 TO PV-DB2-OPERATION              03480011
056561              PERFORM Z900-SQL-ABEND                              03490011
056562     END-EVALUATE.                                                03500011
056563                                                                  03510011
056564******************************************************************03520011
056565*** OPEN SECONDARY CURSOR                                         03530011
056566******************************************************************03540011
056567 3100-OPEN-SEC-CURSOR.                                            03550011
056568******************************************************************03560011
056309*    DISPLAY '***3100***'.                                        03570022
056570         EXEC SQL                                                 03580011
056571            OPEN SEC-CURSOR                                       03590011
056572         END-EXEC.                                                03600011
056573                                                                  03610011
056574          EVALUATE TRUE                                           03620011
056575              WHEN SQLCODE EQUAL ZERO                             03630011
056576               CONTINUE                                           03640011
056577                                                                  03650011
056578              WHEN SQLWARN0 NOT EQUAL SPACE                       03660011
056579              WHEN SQLCODE  NOT EQUAL ZERO                        03670011
056580                MOVE '3100-OPEN-SEC-CURSOR'                       03680011
056581                            TO PV-PARAGRAPH-NAME                  03690011
056582                MOVE 'OPEN TABLE CURSOR'                          03700011
056583                            TO PV-DB2-OPERATION                   03710011
056584              PERFORM  Z900-SQL-ABEND                             03720011
056585          END-EVALUATE.                                           03730011
056586                                                                  03740011
056587******************************************************************03750011
056588*** FETCH SECONDARY CURSOR                                        03760011
056589******************************************************************03770011
056590 3200-FETCH-SEC-CURSOR.                                           03780011
056591******************************************************************03790011
056309*    DISPLAY '***3200***'.                                        03800022
056593         EXEC SQL                                                 03810011
056594           FETCH SEC-CURSOR                                       03820011
056595            INTO :PV-PRCHG-IDS                                    03830011
056596         END-EXEC.                                                03840011
056597                                                                  03850011
056598      EVALUATE TRUE                                               03860011
056599           WHEN SQLCODE = ZERO                                    03870011
056601            ADD +1 TO PV-SEC-COMMIT-COUNT                         03880011
056602            PERFORM 4100-DELETE-SEC-MDSE                          03890011
056603           CONTINUE                                               03900011
056604                                                                  03910011
056605           WHEN SQLCODE = +100                                    03920011
056606            SET PS-NO-MORE-DATA-SEC TO TRUE                       03930011
056607                                                                  03940011
056608           WHEN SQLWARN0 NOT EQUAL SPACE                          03950011
056609           WHEN SQLCODE  NOT EQUAL ZERO                           03960011
056610           MOVE '3200-FETCH-SEC-CURSOR'                           03970011
056611                              TO PV-PARAGRAPH-NAME                03980011
056612           MOVE 'FETCH TABLE CURSOR'                              03990011
056613                              TO PV-DB2-OPERATION                 04000011
056614                      PERFORM  Z900-SQL-ABEND                     04010011
056615      END-EVALUATE.                                               04020011
056616******************************************************************04030011
056617* CLOSE SECONDARY CURSOR                                          04040011
056618******************************************************************04050011
056619 3300-CLOSE-SEC-CURSOR.                                           04060011
056620******************************************************************04070011
056309*    DISPLAY '***3300***'.                                        04080022
056621        EXEC SQL                                                  04090011
056622            CLOSE SEC-CURSOR                                      04100011
056623        END-EXEC.                                                 04110011
056624                                                                  04120011
056625     EVALUATE TRUE                                                04130011
056626         WHEN SQLCODE = ZERO                                      04140011
056627              CONTINUE                                            04150011
056628         WHEN SQLWARN0 NOT EQUAL SPACE                            04160011
056629         WHEN SQLCODE NOT EQUAL ZERO                              04170011
056630              MOVE '3300-CLOSE-SEC-CURSOR'                        04180011
056631                                 TO PV-PARAGRAPH-NAME             04190011
056632              MOVE 'CLOSE TABLE CURSOR'                           04200011
056633                                 TO PV-DB2-OPERATION              04210011
056634              PERFORM Z900-SQL-ABEND                              04220011
056635     END-EVALUATE.                                                04230011
056636*--------------------------------------------------------------*  04240011
056637*   PRIMARY DELETE PARAGRAPH. THIS PARAGRAPH DELETES THE ROWS  *  04250011
056638*   FETCHED IN THE PRIMARY CURSOR.                             *  04260011
056639*--------------------------------------------------------------*  04270011
056640 4000-DELETE-PRI-MDSE.                                            04280011
056309*    DISPLAY '***4000***'.                                        04290022
056641     MOVE '4000-DELETE-PRI-MDSE' TO PV-PARAGRAPH-NAME.            04300011
056642                                                                  04310011
056642     PERFORM 5000-COUNT-CHILDREN.                                 04320016
056642                                                                  04330016
056643     PERFORM                                                      04340011
056644         WITH TEST AFTER                                          04350011
056645         VARYING PV-NUMBER-OF-RETRIES                             04360011
056646         FROM 1 BY 1                                              04370011
056647         UNTIL (PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES             04380011
056648            OR (SQLCODE = +100 OR +0))                            04390011
056649                                                                  04400011
056650         EXEC SQL                                                 04410011
056651              DELETE FROM XST_PRCHGH                              04420011
056652               WHERE PRCHG_ID = :PV-PRCHG-IDP                     04430011
056653         END-EXEC                                                 04440011
056654                                                                  04450011
056655         EVALUATE TRUE                                            04460011
056656           WHEN SQLCODE = 0                                       04470011
056657                ADD +1 TO PV-PRIMARY-DEL-CNT                      04480011
056658           WHEN SQLCODE = -904                                    04490011
056659           WHEN SQLCODE = -911                                    04500011
056660           WHEN SQLCODE = -913                                    04510011
056661                CONTINUE                                          04520011
056662           WHEN OTHER                                             04530011
056669             MOVE 'ERROR ON PRIMARY DELETE OF PRCHG_MDSEH ' TO    04540011
056670                  PV-DB2-OPERATION                                04550011
056671             PERFORM 9900-SQL-ABEND                               04560011
056672         END-EVALUATE                                             04570011
056673     END-PERFORM.                                                 04580011
056674                                                                  04590011
056675     IF PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES                     04600011
056676         MOVE 'MDSE DEL RETRY EXCEEDED' TO PV-DB2-OPERATION       04610011
056677         PERFORM 9900-SQL-ABEND                                   04620011
056678     END-IF.                                                      04630011
056679                                                                  04640011
056680     IF PV-PRI-COMMIT-COUNT > PC-MAX-COMMIT-COUNT                 04650011
056681         PERFORM 6000-COMMIT-DB2                                  04660011
056682     END-IF.                                                      04670011
056683                                                                  04680011
056684*--------------------------------------------------------------*  04690011
056685*   SECONDARY DELETE PARAGRAPH. THIS PARAGRAPH DELETES THE     *  04700011
056686*   ROWS FETCHED IN THE SECONDARY CURSOR.                      *  04710011
056687*--------------------------------------------------------------*  04720011
056688 4100-DELETE-SEC-MDSE.                                            04730011
056309*    DISPLAY '***4100***'.                                        04740022
056690     MOVE '4100-DELETE-SEC-MDSE' TO PV-PARAGRAPH-NAME.            04750011
056691                                                                  04760011
056692     PERFORM                                                      04770011
056693        WITH TEST AFTER                                           04780011
056694        VARYING PV-NUMBER-OF-RETRIES                              04790011
056695        FROM 1 BY 1                                               04800011
056696        UNTIL (PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES              04810011
056697           OR (SQLCODE = +100 OR +0))                             04820011
056698                                                                  04830011
056699         EXEC SQL                                                 04840011
056700              DELETE FROM XST_PRCHGH                              04850011
056701               WHERE PRCHG_ID = :PV-PRCHG-IDS                     04860011
056702         END-EXEC                                                 04870011
056703                                                                  04880011
056704         EVALUATE TRUE                                            04890011
056705           WHEN SQLCODE = 0                                       04900011
056706*            ADD +1 TO PV-DELETE-STR-GP-CNT                       04910011
056707             ADD +1 TO PV-SECONDARY-DEL-CNT                       04920011
056708           WHEN SQLCODE = -904                                    04930011
056709           WHEN SQLCODE = -911                                    04940011
056710           WHEN SQLCODE = -913                                    04950011
056711             CONTINUE                                             04960011
056712           WHEN OTHER                                             04970011
056718             MOVE 'ERROR ON SECONDARY DELETE' TO                  04980011
056719                  PV-DB2-OPERATION                                04990011
056720             PERFORM 9900-SQL-ABEND                               05000011
056722         END-EVALUATE                                             05010011
056723     END-PERFORM.                                                 05020011
056724                                                                  05030011
056725     IF PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES                     05040011
056726         MOVE 'DELETE RETRIES EXCEEDED' TO PV-DB2-OPERATION       05050011
056727         PERFORM 9900-SQL-ABEND                                   05060011
056728     END-IF.                                                      05070011
056729                                                                  05080011
056730     IF PV-SEC-COMMIT-COUNT > PC-MAX-COMMIT-COUNT                 05090011
056731         PERFORM 6000-COMMIT-DB2                                  05100011
056732     END-IF.                                                      05110011
056733                                                                  05120011
056636*--------------------------------------------------------------*  05130016
056637*   COUNT CHILDREN. THIS PARAGRAPH COUNTS THE ROWS IN THE      *  05140016
056638*   CHILDREN TABLES.                                           *  05150016
056639*--------------------------------------------------------------*  05160016
056640 5000-COUNT-CHILDREN.                                             05170016
056309*    DISPLAY '***5000***'.                                        05180022
056641     MOVE '5000-COUNT-CHILDREN' TO PV-PARAGRAPH-NAME.             05190016
056642                                                                  05200016
056642     MOVE 0 TO PV-DB2-COUNT.                                      05210018
056642                                                                  05220018
056643     PERFORM                                                      05230016
056644         WITH TEST AFTER                                          05240016
056645         VARYING PV-NUMBER-OF-RETRIES                             05250016
056646         FROM 1 BY 1                                              05260016
056647         UNTIL (PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES             05270016
056648            OR (SQLCODE = +100 OR +0))                            05280016
056649                                                                  05290016
056650         EXEC SQL                                                 05300016
056651              SELECT COUNT(*)                                     05310016
056651              INTO   :PV-DB2-COUNT                                05320017
056651              FROM XST_STR_GP_PRCHGH                              05330016
056652               WHERE PRCHG_ID = :PV-PRCHG-IDP                     05340016
056653         END-EXEC                                                 05350016
056654                                                                  05360016
056655         EVALUATE TRUE                                            05370016
056656           WHEN SQLCODE = 0                                       05380016
056657                ADD PV-DB2-COUNT TO PV-CHILDREN-DEL-CNT           05390017
056658           WHEN SQLCODE = -904                                    05400016
056659           WHEN SQLCODE = -911                                    05410016
056660           WHEN SQLCODE = -913                                    05420016
056661                CONTINUE                                          05430016
056662           WHEN OTHER                                             05440016
056669             MOVE 'ERROR ON CHILDREN COUNT OF STR_GP_PRCHGH' TO   05450017
056670                  PV-DB2-OPERATION                                05460016
056671             PERFORM 9900-SQL-ABEND                               05470016
056672         END-EVALUATE                                             05480016
056673     END-PERFORM.                                                 05490016
056674                                                                  05500016
056675     IF PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES                     05510018
056676         MOVE 'STR_GP_PRCHGH RETRY EXCEEDED' TO PV-DB2-OPERATION  05520018
056677         PERFORM 9900-SQL-ABEND                                   05530018
056678     END-IF.                                                      05540018
056679                                                                  05550018
056674     MOVE 0 TO PV-DB2-COUNT.                                      05560018
056674                                                                  05570018
056643     PERFORM                                                      05580018
056644         WITH TEST AFTER                                          05590018
056645         VARYING PV-NUMBER-OF-RETRIES                             05600018
056646         FROM 1 BY 1                                              05610018
056647         UNTIL (PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES             05620018
056648            OR (SQLCODE = +100 OR +0))                            05630018
056649                                                                  05640018
056650         EXEC SQL                                                 05650018
056651              SELECT COUNT(*)                                     05660018
056651              INTO   :PV-DB2-COUNT                                05670018
056651              FROM XST_PRCHG_MDSEH                                05680018
056652               WHERE PRCHG_ID = :PV-PRCHG-IDP                     05690018
056653         END-EXEC                                                 05700018
056654                                                                  05710018
056655         EVALUATE TRUE                                            05720018
056656           WHEN SQLCODE = 0                                       05730018
056657                ADD PV-DB2-COUNT TO PV-CHILDREN-DEL-CNT           05740018
056658           WHEN SQLCODE = -904                                    05750018
056659           WHEN SQLCODE = -911                                    05760018
056660           WHEN SQLCODE = -913                                    05770018
056661                CONTINUE                                          05780018
056662           WHEN OTHER                                             05790018
056669             MOVE 'ERROR ON CHILDREN COUNT OF PRCHG_MDSEH' TO     05800018
056670                  PV-DB2-OPERATION                                05810018
056671             PERFORM 9900-SQL-ABEND                               05820018
056672         END-EVALUATE                                             05830018
056673     END-PERFORM.                                                 05840018
056674                                                                  05850018
056675     IF PV-NUMBER-OF-RETRIES > PC-MAX-RETRIES                     05860018
056676         MOVE 'PRCHG_MDSEH RETRY EXCEEDED' TO PV-DB2-OPERATION    05870018
056677         PERFORM 9900-SQL-ABEND                                   05880018
056678     END-IF.                                                      05890018
056679                                                                  05900018
111600***************************************************************** 05910018
111700* COMMIT AFTER EVERY 5000 ROWS                                    05920011
111900***************************************************************** 05930011
112000 6000-COMMIT-DB2.                                                 05940011
056309*    DISPLAY '***6000***'.                                        05950022
112101     MOVE '6000-COMMIT-DB2' TO PV-PARAGRAPH-NAME.                 05960011
112102                                                                  05970011
112200     EXEC SQL                                                     05980011
112300        COMMIT                                                    05990011
112400     END-EXEC.                                                    06000011
112500                                                                  06010011
112600     EVALUATE TRUE                                                06020011
112700         WHEN SQLCODE = ZERO                                      06030011
112800              MOVE 0 TO PV-PRI-COMMIT-COUNT                       06040011
112810              MOVE 0 TO PV-SEC-COMMIT-COUNT                       06050011
112900         WHEN SQLWARN0 NOT EQUAL SPACE                            06060011
113000         WHEN SQLCODE NOT EQUAL ZERO                              06070011
113100              MOVE '6000-COMMIT-DB2'   TO PV-PARAGRAPH-NAME       06080011
113300              MOVE 'ERROR DURING COMMIT'                          06090011
113400                                       TO PV-DB2-OPERATION        06100011
113401         PERFORM 9900-SQL-ABEND                                   06110011
113402     END-EVALUATE.                                                06120011
113403                                                                  06130011
113404*--------------------------------------------------------------*  06140011
113405* 9900-SQL-ABEND.                                                 06150011
113406*     SQL ABEND ROUTINE.                                          06160011
113407*--------------------------------------------------------------*  06170011
113408 9900-SQL-ABEND.                                                  06180011
113409                                                                  06190011
113410     DISPLAY '** ABEND     **'.                                   06200011
113411     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06210011
113412     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06220011
113413     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06230011
113414                                                                  06240011
113415     COPY DPPD004.                                                06250011
113416     SET ABEND-4013-DB2-ERROR TO TRUE.                            06260011
113417     CALL 'ILBOABN0' USING ABEND-CODE.                            06270011
113418                                                                  06280011
113419*--------------------------------------------------------------*  06290011
113420* 9999-WRAPUP.                                                    06300011
113421*     END OF PROGRAM ROUTINE.  RESET STATUS CODE AND DISPLAYS     06310011
113422*     DATA COUNTS FROM THE PROGRAM.                               06320011
113423*--------------------------------------------------------------*  06330011
113424 9999-WRAPUP.                                                     06340011
113425                                                                  06350011
113426     DISPLAY '   '.                                               06360011
113427     DISPLAY '*********************************************'.     06370011
113428     DISPLAY '**SUMMARY OF XSKUP131 - PRICE CHANGE DELETES*'.     06380011
113429     DISPLAY '*********************************************'.     06390011
113430                                                                  06400011
113431     COMPUTE PV-TOTAL-DEL-CNT =                                   06410011
113432             PV-PRIMARY-DEL-CNT                                   06420016
113432           + PV-CHILDREN-DEL-CNT                                  06430016
113432           + PV-SECONDARY-DEL-CNT                                 06440016
113433                                                                  06450011
113434     DISPLAY 'PRIMARY ROWS DELETED: '                             06460011
113435             PV-PRIMARY-DEL-CNT                                   06470011
113436                                                                  06480011
113434     DISPLAY 'CHILDREN ROWS DELETED: '                            06490016
113435             PV-CHILDREN-DEL-CNT                                  06500016
113436                                                                  06510016
113437     DISPLAY 'SECONDARY ROWS DELETED: '                           06520011
113438             PV-SECONDARY-DEL-CNT.                                06530011
113439                                                                  06540011
113440     DISPLAY 'TOTAL ROWS DELETED: '                               06550011
113441             PV-TOTAL-DEL-CNT.                                    06560011
113442                                                                  06570011
113443     DISPLAY 'END OF PROGRAM: ' PC-PROGRAM-NAME.                  06580011
113444                                                                  06590011
113447                                                                  06600011
113474******************************************************************06610011
113474*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *06620011
113474*  CODE OCCURS.                                                  *06630011
113475******************************************************************06640011
113476 Z900-SQL-ABEND.                                                  06650011
113477                                                                  06660011
113478     DISPLAY '** ABEND     **'.                                   06670011
113479     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06680011
113480     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06690011
113481     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06700011
113436                                                                  06710028
113481     DISPLAY ' '.                                                 06720028
113436                                                                  06730028
113434     DISPLAY 'PRIMARY ROWS DELETED: '                             06740028
113435             PV-PRIMARY-DEL-CNT.                                  06750028
113436                                                                  06760028
113434     DISPLAY 'CHILDREN ROWS DELETED: '                            06770028
113435             PV-CHILDREN-DEL-CNT.                                 06780028
113436                                                                  06790028
113437     DISPLAY 'SECONDARY ROWS DELETED: '                           06800028
113438             PV-SECONDARY-DEL-CNT.                                06810028
113439                                                                  06820028
113440     DISPLAY 'TOTAL ROWS DELETED: '                               06830028
113441             PV-TOTAL-DEL-CNT.                                    06840028
113483******************************************************************06860011
113484*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *06870011
113485*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*06880011
113486*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *06890011
113487******************************************************************06900011
113488     COPY DPPD001.                                                06910011
