000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.    DLKUP008.                                         00050001
000600 AUTHOR.        BUDDY BARNES.                                     00060000
000700 INSTALLATION.  KOHLS.                                            00070000
000800 DATE-WRITTEN   JUNE 2004.                                        00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*  THIS PROGRAM READS AN INPUT FILE CONTAINING BUSEV PURGE DATA, *00120000
001300*  AND DELETES BUSINESS EVENTS FROM PCT_BUS_EVNT_EXPRT AND        00130000
001310*  PCT_BUS_EVNT_DTL(BECAUSE OF THE DELETE CASCADE).               00131001
001320******************************************************************00132002
001330                                                                  00133002
001340******************************************************************00134002
001350 ENVIRONMENT DIVISION.                                            00135002
001360******************************************************************00136002
001370                                                                  00137002
001380 CONFIGURATION SECTION.                                           00138002
001390                                                                  00139002
001400 SOURCE-COMPUTER.        IBM-3090.                                00140002
001500 OBJECT-COMPUTER.        IBM-3090.                                00150002
001600                                                                  00160002
001700 INPUT-OUTPUT SECTION.                                            00170002
001800                                                                  00180002
001900 FILE-CONTROL.                                                    00190002
002000                                                                  00200002
002100     SELECT BUSEV-FILE                                            00210002
002200         ASSIGN TO INP01.                                         00220002
002300                                                                  00230002
002400******************************************************************00240002
002500 DATA DIVISION.                                                   00250002
002600******************************************************************00260002
002700                                                                  00270002
002800 FILE SECTION.                                                    00280002
002900                                                                  00290002
003000 FD  BUSEV-FILE                                                   00300002
003100     RECORDING MODE IS F                                          00310002
003200     LABEL RECORDS ARE STANDARD                                   00320002
003300     BLOCK CONTAINS 0 RECORDS.                                    00330002
003400                                                                  00340002
003500 01  BUSEV-RECORD                     PIC X(050).                 00350002
003600                                                                  00360002
003700******************************************************************00370002
003800 WORKING-STORAGE SECTION.                                         00380002
003900******************************************************************00390002
004000******************************************************************00400002
004100*  RECORD LAYOUT FOR PURGE BUSEV PROCESSING                       00410002
004200******************************************************************00420002
004300     COPY DLRD007.                                                00430002
004400                                                                  00440002
004500******************************************************************00450002
004600*  DB2 FORMATTED MESSAGE AREA                                     00460002
004700******************************************************************00470002
004800     COPY DPWS004.                                                00480002
004900     COPY SQLCA2.                                                 00490002
005000******************************************************************00500002
005100*  COMMUNICATIONS AREA FOR DB2                                    00510002
005200******************************************************************00520002
005210                                                                  00521002
005220     EXEC SQL                                                     00522002
005230          INCLUDE SQLCA                                           00523002
005240     END-EXEC.                                                    00524002
005250                                                                  00525002
005260******************************************************************00526002
005270*  COBOL DECLARATION FOR PCT_BUS_EVNT_EXPRT                       00527002
005280******************************************************************00528002
005290     EXEC SQL                                                     00529002
005300          INCLUDE PCT00011                                        00530002
005400     END-EXEC.                                                    00540002
005500                                                                  00550002
005600 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00560002
005700                                                   COMP SYNC.     00570002
005800                                                                  00580002
005900 01  DATABASE-KEYS.                                               00590002
006000     05  DK-EVNT-EXPRT-ID            PIC S9(09)    COMP.          00600002
006100                                                                  00610002
006200 01  PS-PROGRAM-SWITCHES.                                         00620002
006300     05  PS-EOF-SW                   PIC  X(01)    VALUE 'N'.     00630002
006400         88  PS-EOF                                VALUE 'Y'.     00640002
006500         88  PS-NOT-EOF                            VALUE 'N'.     00650002
006600     05  PS-DELETE-SUCCESSFUL-SW     PIC  X(01)    VALUE 'N'.     00660002
006700         88  PS-DELETE-SUCCESSFUL                  VALUE 'Y'.     00670002
006800         88  PS-DELETE-NOT-SUCCESSFUL              VALUE 'N'.     00680002
006900                                                                  00690002
007000 01  PC-PROGRAM-CONSTANTS.                                        00700002
007100     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00710002
007200         'DLKUP008'.                                              00720002
007300     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 100.     00730002
007400                                                                  00740002
007500 01  PA-PROGRAM-ACCUMULATORS.                                     00750002
007600     05  PA-COMMIT-COUNT             PIC  S9(09)  VALUE +0 COMP-3.00760002
007700     05  PA-COMMIT-COUNTER           PIC  S9(09)  VALUE +0 COMP-3.00770002
007800     05  PA-COMMIT-TOTAL             PIC  S9(09)  VALUE +0 COMP-3.00780002
007900     05  PA-RECS-READ                PIC  S9(09)  VALUE +0 COMP-3.00790002
008000     05  PA-BUSEV-DELETES            PIC  S9(09)  VALUE +0 COMP-3.00800002
008100     05  PA-BUSEV-DEL-FAIL           PIC  S9(09)  VALUE +0 COMP-3.00810002
008200     05  PA-BUSEV-NOT-FOUND          PIC  S9(09)  VALUE +0 COMP-3.00820002
008300                                                                  00830002
008400 01  PV-PROGRAM-VARIABLES.                                        00840002
008500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00850002
008600     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00860002
008700     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00870002
008800     05  PV-DISPLAY-NBR              PIC ZZZ,ZZZ,ZZ9.             00880002
008900     05  PV-EVNT-EXPRT-ID-HOLD       PIC  S9(10) COMP VALUE +0.   00890003
008910     05  PV-EVNT-EXPRT-ID            PIC  S9(9)  COMP VALUE +0.   00891003
009000                                                                  00900002
009100 01  PV-COMMIT-INFO.                                              00910002
009200     05  FILLER                      PIC X(10) VALUE 'BUSEV KEY:'.00920002
009300     05  PV-COMMIT-KEY.                                           00930002
009400         10  PV-COMMIT-EXPRT-ID      PIC 9(10) VALUE ZERO.        00940002
009500         10  FILLER                  PIC X(01) VALUE SPACE.       00950002
009600                                                                  00960002
009700******************************************************************00970002
009800 PROCEDURE DIVISION.                                              00980002
009900******************************************************************00990002
010000                                                                  01000002
010100 0000-PROGRAM-MAINLINE.                                           01010002
010200                                                                  01020002
010300     PERFORM 1000-INITIALIZE.                                     01030002
010400     PERFORM 2000-PROCESS-INPUT                                   01040002
010500       UNTIL PS-EOF.                                              01050002
010600     PERFORM 9000-EOJ-ROUTINE.                                    01060002
010700                                                                  01070002
010800     STOP RUN.                                                    01080002
010900                                                                  01090002
011000******************************************************************01100002
011100*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01110002
011200******************************************************************01120002
011300 1000-INITIALIZE.                                                 01130002
011400                                                                  01140002
011500     OPEN INPUT  BUSEV-FILE.                                      01150002
011600                                                                  01160002
011700     MOVE +0 TO PA-COMMIT-COUNTER                                 01170002
011800                PA-COMMIT-TOTAL                                   01180002
011900                                                                  01190002
012000     PERFORM 7000-READ-INPUT.                                     01200002
012100                                                                  01210002
012200******************************************************************01220002
012300*  PROCESS THE INPUT FILE AND DELETE THE CORRESPONDING ROW ON     01230002
012400*  THE PCT_BUS_EVNT_EXPRT TABLE.                                  01240002
012500******************************************************************01250002
012600 2000-PROCESS-INPUT.                                              01260002
012700                                                                  01270002
012800     PERFORM 8000-DELETE-BUSEV.                                   01280002
012900                                                                  01290002
013000     IF PA-COMMIT-COUNTER > PC-COMMIT-HOLD                        01300002
013100         EXEC SQL                                                 01310002
013200            COMMIT                                                01320002
013300         END-EXEC                                                 01330002
013400                                                                  01340002
013500         IF SQLCODE NOT = +0                                      01350002
013600             DISPLAY '### COMMIT FAILED ! ###'                    01360002
013700             PERFORM 9100-SQL-ABEND                               01370002
013800         END-IF                                                   01380002
013900                                                                  01390002
014000         ADD PA-COMMIT-COUNTER           TO PA-COMMIT-TOTAL       01400002
014100         MOVE DL007-EVNT-EXPRT-ID        TO PV-COMMIT-EXPRT-ID    01410002
014200                                                                  01420002
014300         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                  01430002
014400                                                                  01440002
014500         MOVE +0 TO PA-COMMIT-COUNTER                             01450002
014600     END-IF.                                                      01460002
014700                                                                  01470002
014800     PERFORM 7000-READ-INPUT.                                     01480002
014900                                                                  01490002
015000******************************************************************01500002
015100*  READ   THE INPUT FILE                                          01510002
015200******************************************************************01520002
015300 7000-READ-INPUT.                                                 01530002
015400                                                                  01540002
015500     INITIALIZE DL007-BUSEV-PURGE-LAYOUT.                         01550002
015600                                                                  01560002
015700     READ BUSEV-FILE INTO DL007-BUSEV-PURGE-LAYOUT                01570002
015800       AT END                                                     01580002
015900         SET PS-EOF  TO TRUE                                      01590002
016000       NOT AT END                                                 01600002
016100         ADD +1 TO PA-RECS-READ.                                  01610002
016200                                                                  01620002
016300                                                                  01630002
016400******************************************************************01640002
016500*  DELETE FROM PCT_BUS_EVNT_EXPRT                                 01650002
016600******************************************************************01660002
016700 8000-DELETE-BUSEV.                                               01670002
016800                                                                  01680002
016900     MOVE DL007-EVNT-EXPRT-ID     TO PV-EVNT-EXPRT-ID-HOLD.       01690003
016910     MOVE PV-EVNT-EXPRT-ID-HOLD   TO PV-EVNT-EXPRT-ID.            01691003
017000                                                                  01700002
017100     EXEC SQL                                                     01710002
017200         DELETE FROM PCT_BUS_EVNT_EXPRT                           01720002
017300          WHERE EVNT_EXPRT_ID     = :PV-EVNT-EXPRT-ID             01730002
017400     END-EXEC.                                                    01740002
017500                                                                  01750002
017600     EVALUATE TRUE                                                01760002
017700         WHEN SQLCODE = 0                                         01770002
017800             ADD +1           TO PA-BUSEV-DELETES                 01780002
017900             ADD +1           TO PA-COMMIT-COUNTER                01790002
018000         WHEN SQLCODE = +100                                      01800002
018100             ADD +1           TO PA-BUSEV-NOT-FOUND               01810002
018200             DISPLAY ' '                                          01820002
018300             DISPLAY '*******************************************'01830002
018400             DISPLAY '  BUSEV DELETE NOT FOUND (+100)'            01840002
018500             DISPLAY '  BUSEV EXPRT ID   : ' DL007-EVNT-EXPRT-ID  01850002
018600             DISPLAY '*******************************************'01860002
018700         WHEN SQLCODE = -904                                      01870002
018800         WHEN SQLCODE = -911                                      01880002
018900         WHEN SQLCODE = -913                                      01890002
019000             ADD +1           TO PA-BUSEV-DEL-FAIL                01900002
019100             DISPLAY ' '                                          01910002
019200             DISPLAY '*******************************************'01920002
019300             DISPLAY '  BUSEV DELETE FAIL ( -904, -911, -913)'    01930002
019400             DISPLAY '  BUSEV EXPRT ID   : ' DL007-EVNT-EXPRT-ID  01940002
019500             DISPLAY '*******************************************'01950002
019600         WHEN SQLCODE < 0                                         01960002
019700         WHEN SQLCODE > 0                                         01970002
019800         WHEN SQLWARN0 = 'W'                                      01980002
019900             MOVE '8000-DELETE-BUSEV'                             01990002
020000                         TO PV-PARAGRAPH-NAME                     02000002
020100             MOVE 'DELETE FROM PCT_BUS_EVNT_EXPRT'                02010002
020200                         TO PV-DB2-OPERATION-ATTEMPTED            02020002
020300             PERFORM 9100-SQL-ABEND                               02030002
020400     END-EVALUATE.                                                02040002
020500                                                                  02050002
020600******************************************************************02060002
020700*  CLOSE OUTPUT FILE.  DISPLAY RECORD COUNTS                      02070002
020800******************************************************************02080002
020900 9000-EOJ-ROUTINE.                                                02090002
021000                                                                  02100002
021100     CLOSE BUSEV-FILE.                                            02110002
021200                                                                  02120002
021300     DISPLAY SPACE.                                               02130002
021400     DISPLAY '****************************************'.          02140002
021500     DISPLAY '**    DLKUP008 SUMMARY STATISTICS     **'.          02150002
021600     DISPLAY '****************************************'.          02160002
021700     MOVE PA-RECS-READ            TO PV-DISPLAY-COUNT.            02170002
021800     DISPLAY 'TOTAL RECORDS READ            : '  PV-DISPLAY-COUNT.02180002
021900                                                                  02190002
022000     MOVE PA-BUSEV-DELETES        TO PV-DISPLAY-COUNT.            02200002
022100     DISPLAY 'TOTAL BUSEV DELETES           : '  PV-DISPLAY-COUNT.02210002
022200                                                                  02220002
022300     MOVE PA-BUSEV-DEL-FAIL       TO PV-DISPLAY-COUNT.            02230002
022400     DISPLAY 'TOTAL BUSEV DELETES FAILED    : '  PV-DISPLAY-COUNT.02240002
022500                                                                  02250002
022600     MOVE PA-BUSEV-NOT-FOUND      TO PV-DISPLAY-COUNT.            02260002
022700     DISPLAY 'TOTAL BUSEV NOT FOUND         : '  PV-DISPLAY-COUNT.02270002
022800                                                                  02280002
022900     DISPLAY '****************************************'.          02290002
023000                                                                  02300002
023100******************************************************************02310002
023200*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02320002
023300*  ERROR OR WARNING CODE OCCURS.                                  02330002
023400******************************************************************02340002
023500 9100-SQL-ABEND.                                                  02350002
023600                                                                  02360002
023700     DISPLAY '9100-SQL-ABEND'.                                    02370002
023800     DISPLAY '** ABEND     **'.                                   02380002
023900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02390002
024000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02400002
024100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02410002
024200     DISPLAY '***'                                                02420002
024300     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO            02430002
024400     DISPLAY '***'                                                02440002
024500     DISPLAY '*** COMMITTED UPDATE COUNTS FOLLOW: ***'            02450002
024600     DISPLAY '***'                                                02460002
024700     EXEC SQL                                                     02470002
024800          ROLLBACK                                                02480002
024900     END-EXEC.                                                    02490002
025000******************************************************************02500002
025100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02510002
025200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02520002
025300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02530002
025400* FORMAT.                                                         02540002
025500******************************************************************02550002
025600     COPY DPPD004.                                                02560002
025700                                                                  02570002
025800     MOVE +4013                  TO ABEND-CODE.                   02580002
025900     CALL 'ILBOABN0' USING ABEND-CODE.                            02590002
