000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         SVKUT028.                                    00020000
000300 AUTHOR.             KARI SUTTON.                                 00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       MAY 1996.                                    00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* THIS PROGRAM EXTRACTS THE DAILY ACTIVITY FROM THE KMC ACTIVITY *00090000
001000* TABLE, SVT_KOHLS_CRD_TXN, FOR NON-ECOMM STORES.                *00100000
001100*                                                                *00110000
001200*                                                                *00120000
001300* INPUT FILES:   DAILY-SALES-FILE          DDNAME = INP01        *00130000
001400*                                                                *00140000
001500* OUTPUT FILES:  KMC-DAILY-ACTIVITY        DDNAME = OUT01        *00150000
001600*                                                                *00160000
001700*---------------------------------------------------------------* 00170025
W3540C******************************************************************00171025
W3540C* MODIFICATION LOG                                               *00171129
W3540C* ------------ ---                                               *00171229
W3540C*                                                                *00171329
W3540C* REQUIREMENT  : MAKE DATE AND TIMESTAMP RELATED CHANGES FOR     *00172007
W3540C*                FSH PROJECT                                     *00173007
W3540C* PROJECT ID   : W3540C                                          *00174007
W3540C* AUTHOR       : COGNIZANT                                       *00175007
W3540C* DATE CHANGED : 15-OCT-2012                                     *00176007
W3540C* CHANGES MADE : 1.MODIFIED THE CONTROL-RECORD FORMAT TO HANDLE  *00177007
W3540C*                  THE BEGIN AND END TIMESTAMPS                  *00177107
W3540C*                2.DATE FORMAT CHANGED FROM ISO-FMT TO TIMESTAMP *00178007
W3540C*                  FORMAT                                        *00178107
W3540C*                3.REMOVED THE INCREMENT LOGIC FROM DATE-ROUTINE *00179007
W3540C*                4.MODIFIED THE PROGRAM SUCH THAT IT WRITES THE  *00179107
W3540C*                  MODIFIED CONTROL-RECORD TO THE                *00179207
W3540C*                  CONTROL-DATE-FILE                             *00179307
W3540C*---------------------------------------------------------------* 00179425
001800******************************************************************00180000
P10237*  06/12/2015  COSA DATA SECURITY PROJECT.                       *00181041
P10237*     CHANGES MADE TO CONVERT THE DL# FROM SVT_KOHLS_CRD_TXN     *00182041
P10237*  TABLE TO ASCII FORMAT, THEN ENCRYPT THIS ASCII VALUE USING    *00182141
P10237*  PROTEGRITY MODULE AND THEN CONVERT THE ENCRYPTED DL# FROM     *00183041
P10237*  BINARY TO BASE-64 FORMAT AND CHANGES TO ACCOMMODATE THE       *00184041
P10237*  ENCRYPTED DL#.                                                *00185041
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429          *00188041
P10237******************************************************************00189041
P12431*  09/03/2018  MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED        *00189168
P12431*              ORD_NBR FIELD IN THE SVT TABLES.                  *00189268
P12431*  MADE BY: COGNIZANT                   WR#: CHG0208643          *00189367
P12431******************************************************************00189467
001900 ENVIRONMENT DIVISION.                                            00190000
002000******************************************************************00200000
002100                                                                  00210000
002200 CONFIGURATION SECTION.                                           00220000
002300                                                                  00230000
002400 SOURCE-COMPUTER.    IBM-3090.                                    00240000
002500 OBJECT-COMPUTER.    IBM-3090.                                    00250000
002600                                                                  00260000
002700 INPUT-OUTPUT SECTION.                                            00270000
002800                                                                  00280000
002900 FILE-CONTROL.                                                    00290000
003000                                                                  00300000
003100     SELECT KMC-DAILY-ACTIVITY   ASSIGN TO OUT01.                 00310000
W3540C     SELECT CONTROL-DATE-FILE    ASSIGN TO INP01                  00320027
W3540C                   FILE STATUS IS FS-FILE-STATUS.                 00321019
003300                                                                  00330000
003400******************************************************************00340000
003500 DATA DIVISION.                                                   00350000
003600******************************************************************00360000
003700                                                                  00370000
003800 FILE SECTION.                                                    00380000
003900                                                                  00390000
004000 FD  KMC-DAILY-ACTIVITY                                           00400000
004100     RECORDING MODE IS F                                          00410000
004200     BLOCK CONTAINS 0 RECORDS                                     00420000
004300     LABEL RECORDS ARE OMITTED.                                   00430000
004400                                                                  00440000
P12431 01  KMC-DAILY-RECORD            PIC  X(198).                     00451065
004600                                                                  00460000
004700 FD  CONTROL-DATE-FILE                                            00461023
004800     RECORDING MODE IS F                                          00462023
004900     BLOCK CONTAINS 0 RECORDS                                     00463023
005000     LABEL RECORDS ARE OMITTED.                                   00464023
005100                                                                  00465023
005200 01  CONTROL-DATE-RECORD         PIC  X(80).                      00466023
005300                                                                  00530000
005400 WORKING-STORAGE SECTION.                                         00540000
005500                                                                  00550000
005600 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00560000
W3540C 01  FS-FILE-STATUS              PIC  X(02)     VALUE SPACES.     00561019
005700                                                                  00570000
005800******************************************************************00580000
005900*    CR-CONTROL RECORD                                           *00590000
006000******************************************************************00600000
W3540C******************************************************************00601129
W3540C* A NEW CONTROL CARD IS INTRODUCED TO SUPPORT THE NEW FORMAT.    *00601229
W3540C******************************************************************00601329
W3540C 01  CR-CONTROL-RECORD.                                           00610007
W3540C     05  CR-CONTROL-BEG-TS.                                       00620007
W3540C         10  CR-CONTROL-BEG-DATE.                                 00621007
W3540C             15  CR-CONTROL-BEG-DATE-CC  PIC  X(02) VALUE SPACES. 00630007
W3540C             15  CR-CONTROL-BEG-DATE-YY  PIC  X(02) VALUE SPACES. 00640007
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00650007
W3540C             15  CR-CONTROL-BEG-DATE-MM  PIC  X(02) VALUE SPACES. 00660007
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00670007
W3540C             15  CR-CONTROL-BEG-DATE-DD  PIC  X(02) VALUE SPACES. 00680007
W3540C         10  FILLER                      PIC  X(01) VALUE SPACES. 00680107
W3540C         10  CR-CONTROL-BEG-TIME.                                 00680207
W3540C             15  CR-CONTROL-BEG-TIME-HH  PIC  X(02) VALUE SPACES. 00681007
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00682007
W3540C             15  CR-CONTROL-BEG-TIME-MM  PIC  X(02) VALUE SPACES. 00683007
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00685007
W3540C             15  CR-CONTROL-BEG-TIME-SS  PIC  X(02) VALUE SPACES. 00686007
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00687007
W3540C             15  CR-CONTROL-BEG-TIME-TT  PIC  X(06) VALUE SPACES. 00688007
W3540C     05  FILLER                          PIC  X(01) VALUE SPACES. 00689007
W3540C     05  CR-CONTROL-END-TS.                                       00689107
W3540C         10  CR-CONTROL-END-DATE.                                 00689207
W3540C             15  CR-CONTROL-END-DATE-CC  PIC  X(02) VALUE SPACES. 00689518
W3540C             15  CR-CONTROL-END-DATE-YY  PIC  X(02) VALUE SPACES. 00689718
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00689818
W3540C             15  CR-CONTROL-END-DATE-MM  PIC  X(02) VALUE SPACES. 00689918
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00690018
W3540C             15  CR-CONTROL-END-DATE-DD  PIC  X(02) VALUE SPACES. 00690118
W3540C         10  FILLER                      PIC  X(01) VALUE SPACES. 00690218
W3540C         10  CR-CONTROL-END-TIME.                                 00690318
W3540C             15  CR-CONTROL-END-TIME-HH  PIC  X(02) VALUE SPACES. 00690418
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00690518
W3540C             15  CR-CONTROL-END-TIME-MM  PIC  X(02) VALUE SPACES. 00690618
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00690718
W3540C             15  CR-CONTROL-END-TIME-SS  PIC  X(02) VALUE SPACES. 00690818
W3540C             15  FILLER                  PIC  X(01) VALUE SPACES. 00690918
W3540C             15  CR-CONTROL-END-TIME-TT  PIC  X(06) VALUE SPACES. 00691018
W3540C     05  FILLER                          PIC  X(01) VALUE SPACES. 00692032
W3540C     05  CR-CONTROL-REST-IND             PIC  X(01) VALUE SPACES. 00692132
W3540C     05  FILLER                          PIC  X(25) VALUE SPACES. 00693032
007000                                                                  00700000
007100******************************************************************00710000
007200*    PC-PROGRAM CONSTANTS                                        *00720000
007300******************************************************************00730000
007400 01  PC-PROGRAM-CONSTANTS.                                        00740000
007500     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT028'. 00750000
P10237     05  PC-DPKUT052             PIC  X(08)     VALUE 'DPKUT052'. 00751054
007600     05  PC-JOB-NAME             PIC X(08)      VALUE 'SVK065  '. 00760000
007800                                                                  00780000
007900******************************************************************00790000
008000*    PV-PROGRAM VARIABLES                                        *00800000
008100******************************************************************00810000
008200 01  PV-PROGRAM-VARIABLES.                                        00820000
008300     05  PV-PARAGRAPH-NAME            PIC  X(30)     VALUE SPACES.00830000
008400     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(30)     VALUE SPACES.00840000
008500                                                                  00850000
008600     05  PV-CARD-BALANCE              PIC S9(07)V9(02)            00860000
008700                                                     VALUE ZEROES 00870000
008800                                                     COMP-3.      00880000
P10237     05  PV-ASCII                     PIC  X(21).                 00881042
P10237     05  PV-DL-LENGTH                 PIC  9(09)     VALUE ZEROES.00882052
P10237     05  PV-INPUT-TEXT                PIC  X(34).                 00883045
P10237     05  PV-OUTPUT-TEXT               PIC  X(48)     VALUE SPACES.00884045
P12431     05  PV-ORD-NBR-NULL-IND          PIC S9(4) COMP VALUE +0.    00885065
008900                                                                  00890000
W3540C     05  PV-BEGIN-TIMESTAMP-DTL.                                  01051007
W3540C         10  PV-BEGIN-DATE.                                       01051107
W3540C             15  PV-BEGIN-DATE-CC     PIC  X(02).                 01052007
W3540C             15  PV-BEGIN-DATE-YY     PIC  X(02).                 01053014
W3540C             15  FILLER               PIC  X(01).                 01054014
W3540C             15  PV-BEGIN-DATE-MM     PIC  X(02).                 01055014
W3540C             15  FILLER               PIC  X(01).                 01056014
W3540C             15  PV-BEGIN-DATE-DD     PIC  X(02).                 01057014
W3540C         10  FILLER                   PIC  X(01).                 01058007
W3540C         10  PV-BEGIN-TIME.                                       01058107
W3540C             15  PV-BEGIN-TIME-HH     PIC  X(02).                 01059007
W3540C             15  FILLER               PIC  X(01).                 01059107
W3540C             15  PV-BEGIN-TIME-MM     PIC  X(02).                 01059207
W3540C             15  FILLER               PIC  X(01).                 01059307
W3540C             15  PV-BEGIN-TIME-SS     PIC  X(02).                 01059407
W3540C             15  FILLER               PIC  X(01).                 01059507
W3540C             15  PV-BEGIN-TIME-TTTTTT PIC  X(06).                 01059607
W3540C                                                                  01059707
W3540C     05  PV-BEGIN-TIMESTAMP REDEFINES PV-BEGIN-TIMESTAMP-DTL      01060007
W3540C                                      PIC  X(26).                 01070007
W3540C                                                                  01080007
W3540C     05  PV-END-TIMESTAMP-DTL.                                    01239707
W3540C         10  PV-END-DATE.                                         01239807
W3540C             15  PV-END-DATE-CC       PIC  X(02).                 01240018
W3540C             15  PV-END-DATE-YY       PIC  X(02).                 01240118
W3540C             15  FILLER               PIC  X(01).                 01240218
W3540C             15  PV-END-DATE-MM       PIC  X(02).                 01240318
W3540C             15  FILLER               PIC  X(01).                 01240418
W3540C             15  PV-END-DATE-DD       PIC  X(02).                 01240518
W3540C         10  FILLER                   PIC  X(01).                 01240618
W3540C         10  PV-END-TIME.                                         01240718
W3540C             15  PV-END-TIME-HH       PIC  X(02).                 01240818
W3540C             15  FILLER               PIC  X(01).                 01240918
W3540C             15  PV-END-TIME-MM       PIC  X(02).                 01241018
W3540C             15  FILLER               PIC  X(01).                 01241118
W3540C             15  PV-END-TIME-SS       PIC  X(02).                 01241218
W3540C             15  FILLER               PIC  X(01).                 01241318
W3540C             15  PV-END-TIME-TTTTTT   PIC  X(06).                 01241418
W3540C                                                                  01241518
W3540C     05  PV-END-TIMESTAMP REDEFINES                               01244007
W3540C         PV-END-TIMESTAMP-DTL   PIC  X(26).                       01250007
W3540C                                                                  01260007
W3540C     05  PV-CURRENT-TS.                                           01260207
W3540C         10  PV-CURRENT-DATE.                                     01260307
W3540C             15  PV-CURRENT-DATE-CC   PIC  X(02)    VALUE SPACES. 01260418
W3540C             15  PV-CURRENT-DATE-YY   PIC  X(02)    VALUE SPACES. 01260518
W3540C             15  FILLER               PIC  X(01)    VALUE '-'.    01260618
W3540C             15  PV-CURRENT-DATE-MM   PIC  X(02)    VALUE SPACES. 01260718
W3540C             15  FILLER               PIC  X(01)    VALUE '-'.    01260818
W3540C             15  PV-CURRENT-DATE-DD   PIC  X(02)    VALUE SPACES. 01260918
W3540C         10  FILLER                   PIC  X(01)    VALUE '-'.    01261018
W3540C         10  PV-CURRENT-TIME.                                     01261118
W3540C             15  PV-CURRENT-TIME-HH   PIC  X(02)    VALUE SPACES. 01261218
W3540C             15  FILLER               PIC  X(01)    VALUE '.'.    01261318
W3540C             15  PV-CURRENT-TIME-MM   PIC  X(02)    VALUE SPACES. 01261418
W3540C             15  FILLER               PIC  X(01)    VALUE '.'.    01261518
W3540C             15  PV-CURRENT-TIME-SS   PIC  X(02)    VALUE SPACES. 01261618
W3540C             15  FILLER               PIC  X(01)    VALUE '.'.    01261718
W3540C             15  PV-CURRENT-TIME-TT   PIC  X(06)    VALUE SPACES. 01261818
W3540C                                                                  01261918
W3540C     05  PV-CURRENT-TIMESTAMP  REDEFINES                          01262018
W3540C         PV-CURRENT-TS         PIC  X(26).                        01262118
W3540C                                                                  01262218
W3540C     05  PV-TEMP-TIMESTAMP.                                       01262318
W3540C         10  PV-TEMP-DATE.                                        01262418
W3540C             15  PV-TEMP-DATE-CC      PIC  X(02).                 01263007
W3540C             15  PV-TEMP-DATE-YY      PIC  X(02).                 01264014
W3540C             15  FILLER               PIC  X(01).                 01265014
W3540C             15  PV-TEMP-DATE-MM      PIC  X(02).                 01266014
W3540C             15  FILLER               PIC  X(01).                 01267014
W3540C             15  PV-TEMP-DATE-DD      PIC  X(02).                 01268014
W3540C         10  FILLER                   PIC  X(01).                 01269007
W3540C         10  PV-TEMP-TIME.                                        01269107
W3540C             15  PV-TEMP-TIME-HH      PIC  X(02).                 01269207
W3540C             15  FILLER               PIC  X(01).                 01269307
W3540C             15  PV-TEMP-TIME-MM      PIC  X(02).                 01269407
W3540C             15  FILLER               PIC  X(01).                 01269507
W3540C             15  PV-TEMP-TIME-SS      PIC  X(02).                 01269607
W3540C             15  FILLER               PIC  X(01).                 01269707
W3540C             15  PV-TEMP-TIME-TTTTTT  PIC  X(06).                 01269807
W3540C******************************************************************01269932
W3540C*    CONTROL CARD LAYOUT FOR WRITE                               *01270032
W3540C******************************************************************01271032
W3540C 01  WRITE-CONTROL-CARD.                                          01272032
W3540C     05  CONTROL-CARD-BEG-DATE          PIC  X(26)   VALUE SPACES.01273032
W3540C     05  FILLER                         PIC  X(01)   VALUE SPACES.01274032
W3540C     05  CONTROL-CARD-END-DATE          PIC  X(26)   VALUE SPACES.01275032
W3540C     05  FILLER                         PIC  X(01)   VALUE SPACES.01276032
W3540C     05  RESTART-INDICATOR              PIC  X(01)   VALUE SPACES.01277032
W3540C     05  FILLER                         PIC  X(25)   VALUE SPACES.01278032
W3540C                                                                  01279032
012699                                                                  01280031
013300                                                                  01330000
013400******************************************************************01340000
013500*    PS-PROGRAM SWITCHES                                         *01350000
013600******************************************************************01360000
013700 01  PS-PROGRAM-SWITCHES.                                         01370000
013800     05  PS-END-OF-SVT00002-CSR-SW    PIC  X(01)     VALUE 'N'.   01380000
013900         88  PS-END-OF-SVT00002-CURSOR               VALUE 'Y'.   01390000
014000                                                                  01400000
014100******************************************************************01410000
014200*    PA-PROGRAM ACCUMULATORS                                     *01420000
014300******************************************************************01430000
014400 01  PA-PROGRAM-ACCUMULATORS.                                     01440000
014500     05  PA-ACTIVITY-ROWS-FETCHED     PIC S9(11)     COMP-3       01450000
014600                                                     VALUE ZEROES.01460000
014700     05  PA-ACTIVITY-ROWS-WRITTEN     PIC S9(11)     COMP-3       01470000
014800                                                     VALUE ZEROES.01480000
014900                                                                  01490000
P10237******************************************************************01490143
P10237*    LK52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.             *01490245
P10237******************************************************************01490343
P10237 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              01490445
P10237     05  LK52-CONVERSION-TYPE         PIC  X(01).                 01490550
P10237         88  EBCDIC-TO-ASCII                         VALUE '1'.   01490651
P10237         88  ASCII-TO-EBCDIC                         VALUE '2'.   01490751
P10237     05  LK52-LENGTH                  PIC S9(03)     COMP-3.      01490850
P10237     05  LK52-FROM-AREA               PIC  X(50)     VALUE SPACES.01490950
P10237     05  LK52-TO-AREA                 PIC  X(50)     VALUE SPACES.01491050
P10237     05  LK52-RETURN-CODE             PIC  X(02)     VALUE '00'.  01492050
P10237         88  GOOD-LK52-RET-CODE                      VALUE '00'.  01492151
017600                                                                  01492943
015000******************************************************************01502000
015100*    KMC DAILY EXTRACT RECORD LAYOUT                             *01510000
015200******************************************************************01520000
015300     COPY SVRD022.                                                01530000
015400                                                                  01540000
015500******************************************************************01550000
015600*    REFUND AUTHORIZATION CONSTANTS                              *01560000
015700******************************************************************01570000
015800     COPY SVWS004.                                                01580000
015900                                                                  01590000
016000******************************************************************01600000
016100*    DATE ROUTINE COPY MEMBERS                                   *01610000
016200******************************************************************01620000
016300     COPY DPWS500.                                                01630000
016400                                                                  01640000
016500******************************************************************01650000
016600*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *01660000
016700******************************************************************01670000
016800     COPY DPWS004.                                                01680000
016900                                                                  01690000
P10237******************************************************************01690145
P10237*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA       *01690245
P10237******************************************************************01690345
P10237     COPY DPWS022.                                                01690445
P10237                                                                  01690545
P10237******************************************************************01691040
P10237* LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY *01692040
P10237* MODULE                                                         *01693040
P10237******************************************************************01694040
P10237     COPY PTYCCSIP.                                               01695040
P10237                                                                  01696040
P10237******************************************************************01697040
P10237* LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY *01698040
P10237* MODULE                                                         *01699040
P10237******************************************************************01699140
P10237     COPY DPWS031.                                                01699252
P10237                                                                  01699340
017000******************************************************************01700000
017100*    SV-KOHL'S STORED VALUE CARD PRODUCT TABLE (SVT_CRD_PROD)    *01710000
017200******************************************************************01720000
017300     EXEC SQL                                                     01730000
017400         INCLUDE SVT00000                                         01740000
017500     END-EXEC.                                                    01750000
017600                                                                  01760000
017700******************************************************************01770000
017800*    SV-KOHL'S STORED VALUE CARD TABLE                           *01780000
017900******************************************************************01790000
018000     EXEC SQL                                                     01800000
018100         INCLUDE SVT00001                                         01810000
018200     END-EXEC.                                                    01820000
018300                                                                  01830000
018400******************************************************************01840000
018500*    SV-KOHL'S STORED VALUE CARD ACTIVITY TABLE                  *01850000
018600******************************************************************01860000
018700     EXEC SQL                                                     01870000
018800         INCLUDE SVT00002                                         01880000
018900     END-EXEC.                                                    01890000
019000                                                                  01900000
019100******************************************************************01910000
019200*  SQL AND COBOL DECLARATIONS FOR THE STORE TABLE                *01920000
019300******************************************************************01930000
019400     EXEC SQL                                                     01940000
019500         INCLUDE XST00001                                         01950000
019600     END-EXEC.                                                    01960000
019700                                                                  01970000
019800******************************************************************01980000
019900*    STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA              *01990000
020000******************************************************************02000000
020100     EXEC SQL                                                     02010000
020200         INCLUDE SQLCA                                            02020000
020300     END-EXEC.                                                    02030000
020400                                                                  02040000
020500     COPY SQLCA2.                                                 02050000
020600                                                                  02060000
020700******************************************************************02070000
020800*    CURSOR DECLARATION FOR KMC ACTIVITY CURSOR                  *02080000
020900******************************************************************02090000
021000     EXEC SQL                                                     02100000
021100         DECLARE  KMC_ACTVY_CURSOR CURSOR FOR                     02110000
021200          SELECT  A.CRD_NBR                                       02120000
021300                 ,TRN_AUTH_TMST                                   02130000
021400                 ,DRV_LIC_NBR                                     02140000
021500                 ,TRN_RVRSL_CDE                                   02150000
021600                 ,TRN_VOID_IND                                    02160000
021700                 ,ACTVY_TYP_CDE                                   02170000
021800                 ,POS_DTE                                         02180000
021900                 ,A.STR_NBR                                       02190000
022000                 ,POS_TRMNL_NBR                                   02200000
022100                 ,POS_TRN_NBR                                     02210000
022200                 ,APP_AUTH_AMT                                    02220000
022300                 ,POS_OPRT_ID                                     02230000
P12431                 ,ORD_NBR                                         02231065
022400                 ,APVL_USR_ID                                     02240000
022500                 ,ACTVY_STAT_CDE                                  02250000
022600                 ,ORIG_AUTH_AMT                                   02260000
022700                 ,T.CRD_TYP_CDE                                   02270000
022800                 ,A.ST_CDE                                        02280000
022900                 ,S.BALANCE                                       02290000
023000                 ,P.CRD_STK_TYP_ID                                02300000
023100            FROM  SVT_KOHLS_CRD_TXN A,                            02310000
023200                  SVT_KOHLS_CRD_ACCT T,                           02320000
023300                  SVT_CRD_PROD P                                  02330000
023400                 ,XST_LOC L                                       02340000
023500                 ,(SELECT S.CRD_NBR                               02350000
023600                         ,SUM(S.APP_AUTH_AMT) AS BALANCE          02360000
023700                     FROM SVT_KOHLS_CRD_TXN S                     02370000
023800                     GROUP BY S.CRD_NBR) AS S                     02380000
023900           WHERE  A.CRD_NBR = T.CRD_NBR                           02390000
024000              AND A.CRD_NBR = S.CRD_NBR                           02400000
024100              AND T.CRD_PROD_YR = P.CRD_PROD_YR                   02410000
024200              AND T.SHIPT_REQ_NBR = P.SHIPT_REQ_NBR               02420000
024300              AND A.STR_NBR = L.LOC_NBR                           02430000
RPTFIX              AND A.ACTVY_STAT_CDE IN (1,2)                       02431061
024400              AND A.ACTVY_TYP_CDE IN(1,2,3)                       02440057
024500              AND L.LOC_TYP_CDE IN ('DS')                         02450058
024600              AND L.E_BUS_IND <> 'Y'                              02460000
W3540C              AND A.TRN_AUTH_TMST > :PV-BEGIN-TIMESTAMP           02471007
W3540C              AND A.TRN_AUTH_TMST <= :PV-END-TIMESTAMP            02481007
024900           WITH UR                                                02490000
025000     END-EXEC.                                                    02500000
025100 PROCEDURE DIVISION.                                              02510000
025200                                                                  02520000
025300******************************************************************02530000
025400 A100-MAINLINE.                                                   02540000
025500******************************************************************02550000
025600                                                                  02560000
025700     PERFORM B100-INITIALIZE.                                     02570000
025800                                                                  02580000
025900     PERFORM B200-PROCESS-CARD-ACTIVITY                           02590000
026000         UNTIL PS-END-OF-SVT00002-CURSOR.                         02600000
026100                                                                  02610000
026200     PERFORM C300-CLOSE-SVT00002-CURSOR                           02620000
026300                                                                  02630000
026400     PERFORM B300-EOJ-ROUTINE.                                    02640000
026500                                                                  02650000
026600     GOBACK.                                                      02660000
026700******************************************************************02670000
026800*     B100-INITIALIZE                                            *02680000
026900* ==> PROCESSES:                                                 *02690000
027000*     -READS THE DAILY SALES FILE TO GET THE DATE                *02700000
027100*     -CALLS THE DATE ROUTINE TO CALCULATE THE CENTURY FOR THE   *02710000
027200*      CURRENT DATE AND ALSO TO CALCULATE THE NEXT DAY           *02720000
027300*     -OPENS THE CURSOR FOR THE KMC ACTIVITY TABLE AND FETCHES   *02730000
027400*      THE FIRST ROW                                             *02740000
027500* ==> PERFORMED FROM: A100-MAINLINE                              *02750000
027600******************************************************************02760000
027700 B100-INITIALIZE.                                                 02770000
027800                                                                  02780000
027900     OPEN INPUT  CONTROL-DATE-FILE.                               02781018
028000     OPEN OUTPUT KMC-DAILY-ACTIVITY.                              02800000
028100                                                                  02810000
028200     READ CONTROL-DATE-FILE INTO CR-CONTROL-RECORD                02820000
028300         AT END                                                   02830000
028400             DISPLAY ' '                                          02840000
028500             DISPLAY '** ABEND     **'                            02850000
028600             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        02860000
028700             DISPLAY '** PARAGRAPH **  = B100-INITIALIZE'         02870000
028800             DISPLAY '** EMPTY CONTROL FILE'                      02880000
028900             DISPLAY DPG54-ERROR-MESSAGE                          02890000
029000             DISPLAY ' '                                          02900000
029100             MOVE +4003 TO ABEND-CODE                             02910000
029200             CALL 'ILBOABN0' USING ABEND-CODE                     02920000
029300     END-READ.                                                    02930000
029400                                                                  02940039
W3540C                                                                  02941432
W3540C     IF CR-CONTROL-REST-IND = 'R'                                 02941832
W3540C        MOVE CR-CONTROL-BEG-TS    TO PV-TEMP-TIMESTAMP            02941938
W3540C        PERFORM C100-DATE-ROUTINE                                 02942038
W3540C        MOVE PV-TEMP-TIMESTAMP    TO PV-BEGIN-TIMESTAMP-DTL       02942138
W3540C        MOVE CR-CONTROL-END-TS    TO PV-TEMP-TIMESTAMP            02942232
W3540C        PERFORM C100-DATE-ROUTINE                                 02942332
W3540C        MOVE PV-TEMP-TIMESTAMP    TO PV-END-TIMESTAMP-DTL         02942432
W3540C     ELSE                                                         02942532
W3540C        MOVE CR-CONTROL-END-TS    TO PV-TEMP-TIMESTAMP            02942638
W3540C        PERFORM C100-DATE-ROUTINE                                 02942738
W3540C        MOVE PV-TEMP-TIMESTAMP   TO PV-BEGIN-TIMESTAMP-DTL        02942838
W3540C                                                                  02942939
W3540C        EXEC SQL                                                  02943032
W3540C           SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP          02944032
W3540C        END-EXEC                                                  02950032
W3540C                                                                  02950108
W3540C        MOVE PV-CURRENT-TIMESTAMP TO PV-TEMP-TIMESTAMP            02951032
W3540C        PERFORM C100-DATE-ROUTINE                                 02960032
W3540C        MOVE PV-TEMP-TIMESTAMP    TO PV-END-TIMESTAMP-DTL         02961032
W3540C     END-IF.                                                      02970032
W3540C                                                                  02970132
W3540C     DISPLAY PC-PROGRAM-NAME ' DATE FROM : '                      02971007
W3540C             PV-BEGIN-TIMESTAMP-DTL ' TO : ' PV-END-TIMESTAMP-DTL.02972007
W3540C                                                                  02973007
P10237     MOVE PC-PROGRAM-NAME         TO DP031-PROGRAM-NAME.          02990052
030000     PERFORM C200-OPEN-SVT00002-CURSOR.                           03000000
030100     PERFORM D100-FETCH-SVT00002-CURSOR.                          03010000
030200                                                                  03020000
030300******************************************************************03030000
030400*     B200-PROCESS-CARD-ACTIVITY                                 *03040000
030500* ==> PROCESSES:                                                 *03050000
030600*     -FETCHES THE NEXT ROW FROM THE CURSOR                      *03060000
030700* ==> PERFORMED FROM: A100-MAINLINE                              *03070000
030800******************************************************************03080000
030900 B200-PROCESS-CARD-ACTIVITY.                                      03090000
031000                                                                  03100000
031100     IF SVT00002-ACTVY-TYP-CDE = 2                                03110000
031200       AND SVT00000-CRD-STK-TYP-ID = 'KCK'                        03120000
031300         CONTINUE                                                 03130000
031400     ELSE                                                         03140000
031500         PERFORM E200-WRITE-SVT00002-ACTIVITY                     03150000
031600     END-IF.                                                      03160000
031700                                                                  03170000
031800     PERFORM D100-FETCH-SVT00002-CURSOR.                          03180000
031900                                                                  03190000
032000******************************************************************03200000
032100*     B300-EOJ-ROUTINE                                           *03210000
032200* ==> PROCESSES:                                                 *03220000
032300*     -CLOSES THE KMC ACTIVITY CURSOR                            *03230000
032400* ==> PERFORMED FROM: A100-MAINLINE                              *03240000
032500******************************************************************03250000
032600 B300-EOJ-ROUTINE.                                                03260000
032700                                                                  03270000
032800     CLOSE CONTROL-DATE-FILE                                      03270118
032900           KMC-DAILY-ACTIVITY.                                    03270218
033000                                                                  03270326
W3540C     IF CR-CONTROL-REST-IND NOT = 'R'                             03273133
W3540C        MOVE PV-BEGIN-TIMESTAMP     TO CONTROL-CARD-BEG-DATE      03273336
W3540C        MOVE PV-END-TIMESTAMP       TO CONTROL-CARD-END-DATE      03273434
W3540C        MOVE CR-CONTROL-REST-IND    TO RESTART-INDICATOR          03273532
W3540C        OPEN OUTPUT CONTROL-DATE-FILE                             03273632
W3540C        WRITE CONTROL-DATE-RECORD FROM WRITE-CONTROL-CARD         03274132
W3540C                                                                  03274232
W3540C        IF FS-FILE-STATUS = '00'                                  03274332
W3540C           DISPLAY '** TIMESTAMP HAS BEEN UPDATED SUCCESSFULLY'   03274432
W3540C                   '   IN THE CONTROL CARD '                      03274532
W3540C           DISPLAY '   WITH THE TIME STAMP  : '                   03274635
W3540C                       CONTROL-CARD-BEG-DATE                      03274739
W3540C                   ' ' CONTROL-CARD-END-DATE ' **'                03274835
W3540C        ELSE                                                      03274932
W3540C           DISPLAY '** ABEND **'                                  03275032
W3540C           DISPLAY '** PROGRAM = ' PC-PROGRAM-NAME ' **'          03275132
W3540C           DISPLAY '** PARAGRAPH = B300-EOJ-ROUTINE **'           03275232
W3540C           DISPLAY '** ERROR IN WRITE      **'                    03275332
W3540C           MOVE +4001                   TO ABEND-CODE             03275432
W3540C           CALL 'ILBOABN0' USING ABEND-CODE                       03275532
W3540C        END-IF                                                    03275632
W3540C        CLOSE CONTROL-DATE-FILE                                   03275732
W3540C     END-IF.                                                      03276032
W3540C                                                                  03277032
033100     DISPLAY ' '.                                                 03310000
033200     DISPLAY PC-PROGRAM-NAME                                      03320000
033300             '  ROWS FETCHED FROM SVT_KOHLS_CRD_TXN  '            03330000
033400                                        PA-ACTIVITY-ROWS-FETCHED. 03340000
033500     DISPLAY PC-PROGRAM-NAME '  ROWS WRITTEN TO OUTPUT FILE:  '   03350000
033600                                        PA-ACTIVITY-ROWS-WRITTEN. 03360000
033700     DISPLAY ' '.                                                 03370000
033800                                                                  03380000
033900******************************************************************03390000
034000*     C100-DATE-ROUTINE.                                         *03400000
034100* ==> PROCESSES:                                                 *03410000
034200*     -VALIDATES THE DATE INPUT ON THE CONTROL FILE              *03420000
034300* ==> PERFORMED FROM: B100-INITIALIZE                            *03430000
034400******************************************************************03440000
034500 C100-DATE-ROUTINE.                                               03450000
034600                                                                  03460000
035000                                                                  03500000
035100     INITIALIZE DPG51 DPG52 DPG53                                 03510025
035200                DPG54 DPG55 DPG56.                                03520025
035300                                                                  03530025
035400     SET DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                      03540025
035800                                                                  03580025
W3540C     MOVE PV-TEMP-DATE              TO DPG52-LK-DATE-INPUT.       03590007
036000     SET DPG52-LK-DTE-ISO-FMT       TO TRUE.                      03600000
036100                                                                  03610000
036200     CALL DP500-KOHLS-CALENDAR-ROUTINE                            03620020
036300       USING DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.                 03630020
036400                                                                  03640000
036500     EVALUATE TRUE                                                03650021
036600         WHEN DPG54-SEVERE-ERROR                                  03660000
036700         WHEN DPG54-DATE-INVALID                                  03670000
036800             DISPLAY ' '                                          03680000
036900             DISPLAY '** ABEND     **'                            03690000
037000             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        03700000
037100             DISPLAY '** PARAGRAPH **  = C100-DATE-ROUTI'         03710000
037200             DISPLAY '** BAD CALL TO CALENDAR MODULE '            03720000
W3540C             DISPLAY '** INVALID INPUT TIMESTAMP     '            03730028
037400             DISPLAY DPG54-ERROR-MESSAGE                          03740000
037500             DISPLAY ' '                                          03750000
037600             MOVE +4019 TO ABEND-CODE                             03760000
037700             CALL 'ILBOABN0' USING ABEND-CODE                     03770000
037800     END-EVALUATE.                                                03780000
037900                                                                  03790000
039200                                                                  03920000
039300******************************************************************03930000
039400*     C200-OPEN-SVT00002-CURSOR.                                 *03940000
039500* ==> PROCESSES:                                                 *03950000
039600*     -OPENS THE KMC ACTIVITY CURSOR                             *03960000
039700* ==> PERFORMED FROM: B100-INITIALIZE                            *03970000
039800******************************************************************03980000
039900 C200-OPEN-SVT00002-CURSOR.                                       03990000
040000                                                                  04000000
040100     EXEC SQL                                                     04010000
040200         OPEN KMC_ACTVY_CURSOR                                    04020000
040300     END-EXEC.                                                    04030000
040400                                                                  04040000
040500     EVALUATE TRUE                                                04050000
040600         WHEN SQLCODE = +0                                        04060000
040700             CONTINUE                                             04070000
040800         WHEN OTHER                                               04080000
040900             MOVE 'C200-OPEN-SVT00002-CURSOR       '              04090000
041000                               TO PV-PARAGRAPH-NAME               04100000
041100             MOVE 'OPEN KMC ACTIVITY CURSOR      '                04110000
041200                               TO PV-DB2-OPERATION-ATTEMPTED      04120000
041300             PERFORM Z900-SQL-ABEND                               04130000
041400     END-EVALUATE.                                                04140000
041500                                                                  04150000
041600******************************************************************04160000
041700*     C300-CLOSE-SVT00002-CURSOR.                                *04170000
041800* ==> PROCESSES:                                                 *04180000
041900*     -CLOSES THE KMC ACTIVITY CURSOR                            *04190000
042000* ==> PERFORMED FROM: B300-EOJ-ROUTINE                           *04200000
042100******************************************************************04210000
042200 C300-CLOSE-SVT00002-CURSOR.                                      04220000
042300                                                                  04230000
042400     EXEC SQL                                                     04240000
042500         CLOSE KMC_ACTVY_CURSOR                                   04250000
042600     END-EXEC.                                                    04260000
042700                                                                  04270000
042800     EVALUATE TRUE                                                04280000
042900         WHEN SQLCODE = +0                                        04290000
043000             CONTINUE                                             04300000
043100         WHEN OTHER                                               04310000
043200             MOVE 'C300-CLOSE-SVT00002-CURSOR      '              04320000
043300                               TO PV-PARAGRAPH-NAME               04330000
043400             MOVE 'CLOSE KMC ACTIVITY CURSOR     '                04340000
043500                               TO PV-DB2-OPERATION-ATTEMPTED      04350000
043600             PERFORM Z900-SQL-ABEND                               04360000
043700     END-EVALUATE.                                                04370000
043800                                                                  04380000
043900******************************************************************04390000
044000*     D100-FETCH-SVT00002-CURSOR.                                *04400000
044100* ==> PROCESSES:                                                 *04410000
044200*     -FETCHES A ROW FROM THE KMC ACTIVITY CURSOR                *04420000
044300* ==> PERFORMED FROM: B100-INITIALIZE                            *04430000
044400*                     B200-PROCESS-CARD-ACTIVITY                 *04440000
044500******************************************************************04450000
044600 D100-FETCH-SVT00002-CURSOR.                                      04460000
044700                                                                  04470000
P12431     MOVE 0 TO PV-ORD-NBR-NULL-IND.                               04471065
P12431     MOVE SPACES TO SVT00002-ORD-NBR-TEXT.                        04472065
044800     EXEC SQL                                                     04480000
044900         FETCH  KMC_ACTVY_CURSOR                                  04490000
045000          INTO  :SVT00002-CRD-NBR                                 04500000
045100               ,:SVT00002-TRN-AUTH-TMST                           04510000
045200               ,:SVT00002-DRV-LIC-NBR                             04520000
045300               ,:SVT00002-TRN-RVRSL-CDE                           04530000
045400               ,:SVT00002-TRN-VOID-IND                            04540000
045500               ,:SVT00002-ACTVY-TYP-CDE                           04550000
045600               ,:SVT00002-POS-DTE                                 04560000
045700               ,:SVT00002-STR-NBR                                 04570000
045800               ,:SVT00002-POS-TRMNL-NBR                           04580000
045900               ,:SVT00002-POS-TRN-NBR                             04590000
046000               ,:SVT00002-APP-AUTH-AMT                            04600000
046100               ,:SVT00002-POS-OPRT-ID                             04610000
P12431               ,:SVT00002-ORD-NBR :PV-ORD-NBR-NULL-IND            04611065
046200               ,:SVT00002-APVL-USR-ID                             04620000
046300               ,:SVT00002-ACTVY-STAT-CDE                          04630000
046400               ,:SVT00002-ORIG-AUTH-AMT                           04640000
046500               ,:SVT00001-CRD-TYP-CDE                             04650000
046600               ,:SVT00002-ST-CDE                                  04660000
046700               ,:PV-CARD-BALANCE                                  04670000
046800               ,:SVT00000-CRD-STK-TYP-ID                          04680000
046900     END-EXEC.                                                    04690000
047000                                                                  04700000
047100     EVALUATE TRUE                                                04710000
047200         WHEN SQLCODE = +0                                        04720000
047300             ADD +1 TO PA-ACTIVITY-ROWS-FETCHED                   04730000
047400         WHEN SQLCODE = +100                                      04740000
047500             SET PS-END-OF-SVT00002-CURSOR                        04750000
047600                               TO TRUE                            04760000
047700         WHEN OTHER                                               04770000
047800             MOVE 'D100-FETCH-SVT00002-CURSOR      '              04780000
047900                               TO PV-PARAGRAPH-NAME               04790000
048000             MOVE 'FETCH KMC ACTIVITY CURSOR     '                04800000
048100                               TO PV-DB2-OPERATION-ATTEMPTED      04810000
048200             PERFORM Z900-SQL-ABEND                               04820000
048300     END-EVALUATE.                                                04830000
048400                                                                  04840000
048500******************************************************************04850000
048600*     E200-WRITE-SVT00002-ACTIVITY                               *04860000
048700* ==> PROCESSES:                                                 *04870000
048800*     -WRITES THE OUTPUT RECORD                                  *04880000
048900*     -THE EXTRACT FILE WILL NOT PASS THE VOID INDICATOR FOR     *04890000
049000*      THOSE TRANSACTIONS WHICH ARE ORIGINAL TRANSACTIONS WHICH  *04900000
049100*      WERE VOIDED.  THIS IS BECAUSE THE POS FILE WILL NOT PASS  *04910000
049200*      THE VOID INDICATOR ON THE ORIGINAL TRANSACTION, JUST ON   *04920000
049300*      THE VOID.                                                 *04930000
049400* ==> PERFORMED FROM:  D100-FETCH-SVT00002-CURSOR                *04940000
049500******************************************************************04950000
049600 E200-WRITE-SVT00002-ACTIVITY.                                    04960000
049700                                                                  04970000
049800     INITIALIZE SV022-KMCACT-EXTRACT-RECORD.                      04980000
049900                                                                  04990000
050000     MOVE SVT00001-CRD-TYP-CDE  TO SV022-CRD-TYP-CDE.             05000000
050100     MOVE SVT00002-CRD-NBR      TO SV022-CRD-NBR.                 05010000
P10237     IF SVT00002-DRV-LIC-NBR NOT EQUAL SPACES                     05021040
P10237         PERFORM E210-EBCDIC-ASCII                                05022040
P10237         PERFORM E220-ENCRYPT-DL                                  05023040
P10237         PERFORM E230-BINARY-BASE64                               05024040
P10237         MOVE PV-OUTPUT-TEXT  TO SV022-DRV-LIC-NBR                05025045
P10237     ELSE                                                         05026040
P10237         MOVE SPACES          TO SV022-DRV-LIC-NBR                05027046
P10237     END-IF.                                                      05028040
050300     IF (SVT00002-TRN-RVRSL-CDE = SV004-REV-CDE-NORMAL            05030000
050400     AND SVT00002-TRN-VOID-IND = SV004-VOID-TRANS)                05040000
050500         MOVE 'N'               TO SV022-TRN-VOID-IND             05050000
050600     ELSE                                                         05060000
050700         MOVE SVT00002-TRN-VOID-IND                               05070000
050800                                TO SV022-TRN-VOID-IND             05080000
050900     END-IF.                                                      05090000
051000     MOVE SVT00002-TRN-RVRSL-CDE TO SV022-TRN-RVRSL-CDE.          05100000
051100     MOVE SVT00002-ACTVY-TYP-CDE TO SV022-ACTVY-TYP-CDE.          05110000
051200     MOVE SVT00002-TRN-AUTH-TMST TO SV022-TRN-AUTH-TMST.          05120000
051300     MOVE SVT00002-POS-DTE      TO SV022-POS-DTE.                 05130000
051400     MOVE SVT00002-STR-NBR      TO SV022-STR-NBR.                 05140000
051500     MOVE SVT00002-POS-TRMNL-NBR TO SV022-TRMNL-NBR.              05150000
051600     MOVE SVT00002-POS-TRN-NBR  TO SV022-TRN-NBR.                 05160000
051700     MOVE SVT00002-APP-AUTH-AMT TO SV022-APP-AUTH-AMT.            05170000
051800     MOVE SVT00002-ACTVY-STAT-CDE TO SV022-ACTVY-STAT-CDE.        05180000
051900     MOVE SVT00002-ORIG-AUTH-AMT TO SV022-ORIG-AUTH-AMT.          05190000
052000     MOVE SVT00002-POS-OPRT-ID  TO SV022-POS-OPER-ID.             05200000
P12431     IF PV-ORD-NBR-NULL-IND < +0                                  05201065
P12431        MOVE SPACES                TO SV022-ORD-NBR               05202065
P12431     ELSE                                                         05203065
P12431        MOVE SVT00002-ORD-NBR-TEXT TO SV022-ORD-NBR               05204065
P12431     END-IF.                                                      05205065
052100     MOVE SVT00002-APVL-USR-ID  TO SV022-APPR-USER-ID.            05210000
052200     MOVE SVT00002-ST-CDE       TO SV022-ST-CDE                   05220000
052300     IF PV-CARD-BALANCE NEGATIVE                                  05230000
052400         SET SV022-OVERTENDERED                                   05240000
052500                                TO TRUE                           05250000
052600     ELSE                                                         05260000
052700         SET SV022-NOT-OVER TO TRUE                               05270000
052800     END-IF.                                                      05280000
052900                                                                  05290000
053000     WRITE KMC-DAILY-RECORD                                       05300000
053100         FROM SV022-KMCACT-EXTRACT-RECORD.                        05310000
053200                                                                  05320000
053300     ADD +1 TO PA-ACTIVITY-ROWS-WRITTEN.                          05330000
053400                                                                  05340000
P10237******************************************************************05341041
P10237*     E210-EBCDIC-ASCII                                          *05342041
P10237* ==> PROCESSES:                                                 *05343041
P10237*     - CONVERTS THE DATA FROM EBCDIC TO ASCII FORMAT            *05344041
P10237* ==> PERFORMED FROM:  E200-WRITE-SVT00002-ACTIVITY              *05345041
P10237******************************************************************05346041
P10237 E210-EBCDIC-ASCII.                                               05347041
P10237     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA                    05348045
P10237                PV-ASCII                                          05349141
P10237                PV-DL-LENGTH.                                     05349241
P10237                                                                  05349345
P10237     INSPECT FUNCTION REVERSE(SVT00002-DRV-LIC-NBR)               05349749
P10237          TALLYING PV-DL-LENGTH FOR LEADING SPACES.               05349849
P10237     COMPUTE PV-DL-LENGTH = 21 - PV-DL-LENGTH.                    05349949
P10237                                                                  05350149
P10237     SET  EBCDIC-TO-ASCII       TO TRUE.                          05350249
P10237     MOVE SVT00002-DRV-LIC-NBR  TO LK52-FROM-AREA.                05350349
P10237     MOVE PV-DL-LENGTH          TO LK52-LENGTH.                   05350449
P10237                                                                  05350549
P10237     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            05350652
P10237                                  LK52-LENGTH                     05350749
P10237                                  LK52-FROM-AREA                  05350849
P10237                                  LK52-TO-AREA                    05350949
P10237                                  LK52-RETURN-CODE.               05351049
P10237     IF GOOD-LK52-RET-CODE                                        05351149
P10237        MOVE LK52-TO-AREA       TO PV-ASCII                       05351249
P10237     ELSE                                                         05351349
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO ASCII'             05351553
P10237        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             05351655
P10237        DISPLAY 'STORE-NBR       - ' SVT00002-STR-NBR             05351753
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             05351853
P10237        DISPLAY 'TERMINAL-NBR    - ' SVT00002-POS-TRMNL-NBR       05351953
P10237        DISPLAY 'TRANSACTION-NBR - ' SVT00002-POS-TRN-NBR         05352053
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 05352153
P10237        MOVE +4008 TO ABEND-CODE                                  05352253
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          05352362
P10237     END-IF.                                                      05352453
P10237                                                                  05352553
P10237******************************************************************05352653
P10237*     E220-ENCRYPT-DL                                            *05352753
P10237* ==> PROCESSES:                                                 *05352853
P10237*     - CALLS THE PROTEGRITY MODULE TO ENCRYPT THE DL#           *05352953
P10237*     - RETURNED DL# WILL BE IN BINARY FORMAT                    *05353053
P10237* ==> PERFORMED FROM:  E200-WRITE-SVT00002-ACTIVITY              *05353153
P10237******************************************************************05353253
P10237 E220-ENCRYPT-DL.                                                 05353353
P10237     INITIALIZE CSI-PARAMETERS                                    05353453
P10237                DP031-PROTEG-PGM-PARAMETERS.                      05353553
P10237     MOVE 'DRIVER-LICENSE'        TO DP031-FIELD.                 05353653
P10237     SET CSI-ENCRYPT-FUNCTION     TO TRUE.                        05353753
P10237     SET DP031-IDNBR              TO TRUE.                        05353853
P10237     MOVE LK52-LENGTH             TO CSI-CLEAR-TEXT-LENGTH.       05353953
P10237     MOVE 34                      TO CSI-CIPHER-TEXT-LENGTH.      05354053
P10237     MOVE PV-ASCII                TO DP031-CLEAR-TEXT.            05354153
P10237     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      05354253
P10237     IF CSI-RETURN-CODE NOT = ZERO                                05354353
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   05354453
P10237        DISPLAY 'STORE-NBR       - ' SVT00002-STR-NBR             05354553
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             05354653
P10237        DISPLAY 'TERMINAL-NBR    - ' SVT00002-POS-TRMNL-NBR       05354753
P10237        DISPLAY 'TRANSACTION-NBR - ' SVT00002-POS-TRN-NBR         05354853
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 05354953
P10237        PERFORM DP031-9999-ABEND                                  05355053
P10237     END-IF.                                                      05355153
P10237                                                                  05355253
P10237******************************************************************05355353
P10237*     E230-BINARY-BASE64                                         *05355453
P10237* ==> PROCESSES:                                                 *05355553
P10237*     - CONVERTS THE DATA FROM BINARY TO BASE64 FORMAT           *05355653
P10237* ==> PERFORMED FROM:  E200-WRITE-SVT00002-ACTIVITY              *05355753
P10237******************************************************************05355853
P10237 E230-BINARY-BASE64.                                              05355953
P10237     INITIALIZE PV-INPUT-TEXT                                     05356053
P10237                PV-OUTPUT-TEXT.                                   05356153
P10237     MOVE DP031-CIPHER-TEXT      TO PV-INPUT-TEXT.                05356253
P10237     MOVE CSI-CIPHER-TEXT-LENGTH TO DP022-INLEN.                  05356353
P10237     MOVE 48                     TO DP022-OUTLEN-IN.              05356453
P10237     CALL  DP022-MGCXB2R  USING DP022-PARMS,                      05356553
P10237                                PV-INPUT-TEXT,                    05356653
P10237                                PV-OUTPUT-TEXT.                   05356753
P10237     IF RETURN-CODE NOT EQUAL 0                                   05356853
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO BASE64'            05357053
P10237        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  05357155
P10237        DISPLAY 'STORE-NBR       - ' SVT00002-STR-NBR             05357253
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             05357353
P10237        DISPLAY 'TERMINAL-NBR    - ' SVT00002-POS-TRMNL-NBR       05357453
P10237        DISPLAY 'TRANSACTION-NBR - ' SVT00002-POS-TRN-NBR         05357553
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 05357653
P10237        MOVE +4008 TO ABEND-CODE                                  05357753
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          05357862
P10237     END-IF.                                                      05357953
P10237                                                                  05358053
053500******************************************************************05359047
053600*     Z900-SQL-ABEND                                             *05360000
053700* ==> PROCESSES:                                                 *05370000
053800*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *05380000
053900* ==> PERFORMED FROM:                                            *05390000
054000******************************************************************05400000
054100 Z900-SQL-ABEND.                                                  05410000
054200                                                                  05420000
054300     DISPLAY 'Z900-SQL-ABEND'.                                    05430000
054400     DISPLAY '**  ABEND     **'.                                  05440000
054500     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               05450000
054600     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             05460000
054700     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    05470000
054800                                                                  05480000
054900******************************************************************05490000
055000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05500000
055100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05510000
055200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05520000
055300* FORMAT.                                                        *05530000
055400******************************************************************05540000
055500     COPY DPPD004.                                                05550000
055600                                                                  05560000
055700     MOVE +4013 TO ABEND-CODE.                                    05570000
055800     CALL 'ILBOABN0' USING ABEND-CODE.                            05580000
P10237                                                                  05581041
P10237******************************************************************05590041
P10237* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE      * 05600052
P10237* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION               * 05610048
P10237******************************************************************05620041
P10237     COPY DPPD031.                                                05630052
P10237                                                                  05640041
