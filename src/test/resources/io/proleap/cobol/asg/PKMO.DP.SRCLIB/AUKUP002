000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.         AUKUP002.                                    00040001
000500 AUTHOR.             BARB ERTL.                                   00050001
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060001
000700 DATE-WRITTEN.       FEBRUARY 2008.                               00070001
000800 DATE-COMPILED.                                                   00080001
000900                                                                  00090001
001000******************************************************************00100001
001100* THIS PROGRAM WILL INSERT A ROW IN THE GCT_GFT_CRD_RECNCL TABLE *00110001
001200* USING CHECKPOINT/RESTART.                                      *00120001
001300*                                                                *00130001
001400* INPUT FILES:   UPDATE POSTING FILE       DDNAME = INP01        *00140001
001500*                                                                *00150001
001600* OUTPUT FILES:  N/A                                             *00160001
001700*                                                                *00170001
001800******************************************************************00180001
260107* CHG0260107 - 08/13/2021 - JIM HUNTER                           *00181007
260107* ADDING DPWS991 COPYBOOK TO CONVERT CALL TO DPKUT901 FROM       *00182007
260107* STATIC TO DYNAMIC.                                             *00183007
260107******************************************************************00184007
001900                                                                  00190001
002000******************************************************************00200001
002100 ENVIRONMENT DIVISION.                                            00210001
002200******************************************************************00220001
002300                                                                  00230001
002400 CONFIGURATION SECTION.                                           00240001
002500                                                                  00250001
002600 SOURCE-COMPUTER.    IBM-3090.                                    00260001
002700 OBJECT-COMPUTER.    IBM-3090.                                    00270001
002800                                                                  00280001
002900 INPUT-OUTPUT SECTION.                                            00290001
003000                                                                  00300001
003100 FILE-CONTROL.                                                    00310001
003200                                                                  00320001
003300******************************************************************00330001
003400 DATA DIVISION.                                                   00340001
003500******************************************************************00350001
003600                                                                  00360001
003700 WORKING-STORAGE SECTION.                                         00370001
003800                                                                  00380001
003900 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00390001
004000                                                                  00400001
004100******************************************************************00410001
004200*PC - PROGRAM CONSTANTS                                           00420001
004300******************************************************************00430001
004400 01  PROGRAM-CONSTANTS.                                           00440001
004500     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00450001
004600                                                COMP SYNC.        00460001
004700     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00470001
004800                                                COMP SYNC.        00480001
004900     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'AUK025  '. 00490001
005000     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'AUKUP002'. 00500001
005100     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'AUKUP002'. 00510001
005200                                                                  00520001
005300     05  PC-TRAN-PRES-FUNC-CODES.                                 00530001
005400         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00540001
005500         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00550001
005600         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00560001
005700         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00570001
005800                                                                  00580001
005900******************************************************************00590001
006000*PV - PROGRAM VARIABLES                                           00600001
006100******************************************************************00610001
006200 01  PROGRAM-VARIABLES.                                           00620001
006300     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00630001
006400     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00640001
006500     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00650001
006600     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00660001
006700                                                                  00670001
006800******************************************************************00680001
006900*PS - PROGRAM SWITCHES                                            00690001
007000******************************************************************00700001
007100 01  PROGRAM-SWITCHES.                                            00710001
007200     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00720001
007300         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00730001
007400         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00740001
007500                                                                  00750001
007600******************************************************************00760001
007700*  BLACKHAWK POSTING RECORD LAYOUT                               *00770001
007800******************************************************************00780001
007900     COPY AURD013.                                                00790001
008000                                                                  00800001
008100******************************************************************00810001
008200*  DCLGEN FOR BLACKHAWK 3RD PARTY GIFT CARD RECONCILE TABLE      *00820001
008300******************************************************************00830001
008400     EXEC SQL                                                     00840001
008500         INCLUDE GCT00001                                         00850004
008600     END-EXEC.                                                    00860001
008700                                                                  00870001
008800******************************************************************00880001
008900*  SQL COMMUNICATIONS WORK AREA                                  *00890001
009000******************************************************************00900001
009100     COPY SQLCA2.                                                 00910001
009200                                                                  00920001
009300******************************************************************00930001
009400*  DB2 FORMATTED ERROR MESSAGE                                   *00940001
009500******************************************************************00950001
009600     COPY DPWS004.                                                00960001
009700                                                                  00970001
009800******************************************************************00980001
009900*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *00990001
010000******************************************************************01000001
260107     COPY DPWS991.                                                01010007
010100                                                                  01010107
010100     COPY DPLS001.                                                01011007
010200     05  WORK-STORAGE-PASSED.                                     01020001
010300******************************************************************01030001
010400*PA - PROGRAM ACCUMULATORS                                        01040001
010500******************************************************************01050001
010600         10  PROGRAM-ACCUMULATORS.                                01060001
010700             15  PA-CRD-INSERTED           PIC S9(11)  VALUE ZERO 01070001
010800                                                       COMP-3.    01080001
010900                                                                  01090001
011000 01  FILLER                          PIC X(4096)  VALUE SPACE.    01100001
011100******************************************************************01110001
011200*  COMMUNICATIONS AREA FOR DB2                                   *01120001
011300******************************************************************01130001
011400     EXEC SQL                                                     01140001
011500         INCLUDE SQLCA                                            01150001
011600     END-EXEC.                                                    01160001
011700                                                                  01170001
011800******************************************************************01180001
011900 PROCEDURE DIVISION.                                              01190001
012000******************************************************************01200001
012100 0000-MAINLINE.                                                   01210002
012200                                                                  01220001
012300     PERFORM 1000-INITIALIZE.                                     01230002
012400                                                                  01240001
012500     PERFORM 2000-PROCESS-UPDATE-RECORDS                          01250002
012600         UNTIL DP001-PREP-TRANS-EOF.                              01260001
012700                                                                  01270001
012800     PERFORM 3000-EOJ-ROUTINE.                                    01280002
012900                                                                  01290001
013000     GOBACK.                                                      01300001
013100                                                                  01310001
013200******************************************************************01320001
013300*     1000-INITIALIZE                                            *01330002
013400* ==> PROCESSES:                                                 *01340001
013500* ==> PERFORMED FROM: 0000-MAINLINE                              *01350002
013600******************************************************************01360001
013700 1000-INITIALIZE.                                                 01370002
013800                                                                  01380001
013900     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01390001
014000     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01400002
014100                                                                  01410001
014200******************************************************************01420001
014300*     2000-PROCESS-UPDATE-RECORDS                                *01430002
014400* ==> PROCESSES:                                                 *01440001
014500* ==> PERFORMED FROM: 0000-MAINLINE                              *01450002
014600******************************************************************01460001
014700 2000-PROCESS-UPDATE-RECORDS.                                     01470002
014800                                                                  01480001
014900     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01490001
015000                                                                  01500001
015100     PERFORM 7000-INSERT-RECON-RECORD.                            01510002
015200                                                                  01520001
015300*----------------------------------------------------------------*01530001
015400*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01540001
015500*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01550001
015600*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01560001
015700*----------------------------------------------------------------*01570001
015800     IF PS-RESTART-REQUIRED                                       01580001
015900         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01590001
016000     ELSE                                                         01600001
016100         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01610001
016200     END-IF.                                                      01620001
016300                                                                  01630001
016400     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01640002
016500                                                                  01650001
016600******************************************************************01660001
016700*     3000-EOJ-ROUTINE                                           *01670002
016800* ==> PROCESSES:                                                 *01680001
016900* ==> PERFORMED FROM: 0000-MAINLINE                              *01690002
017000******************************************************************01700001
017100 3000-EOJ-ROUTINE.                                                01710002
017200                                                                  01720001
017300     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             01730001
017400     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01740002
017500                                                                  01750001
017600******************************************************************01760001
017700*     4000-BUILD-COMM-AREA-TRAN-PRES                             *01770002
017800* ==> PROCESSES:                                                 *01780001
017900*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *01790001
018000*       TRANSACTION PRESENTATION MODULE.                         *01800001
018100* ==> PERFORMED FROM:                                            *01810001
018200******************************************************************01820001
018300 4000-BUILD-COMM-AREA-TRAN-PRES.                                  01830002
018400                                                                  01840001
018500     MOVE LENGTH OF WORK-STORAGE-PASSED                           01850001
018600                                       TO DP001-WORK-STRG-LENGTH. 01860001
018700     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         01870001
018800     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        01880001
018900     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         01890002
019000     MOVE DP001-TRANS-RECORD           TO AU013-DETAIL-TRANS.     01900002
019100     IF DP001-CKPT-TAKEN                                          01910001
019200         INITIALIZE PV-DEADLOCK-COUNTER                           01920001
019300     END-IF.                                                      01930001
019400                                                                  01940001
019500******************************************************************01950001
019600*     7000-INSERT-RECON-RECORD                                   *01960002
019700* ==> PROCESSES:                                                 *01970001
019800*     - INSERTS A ROW ON THE GCT_GFT_CRD_RECNCL TABLE            *01980002
019900* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *01990002
020000******************************************************************02000001
020100 7000-INSERT-RECON-RECORD.                                        02010002
020200                                                                  02020001
020300     PERFORM WITH TEST AFTER                                      02030001
020400         VARYING PV-SQL-SUB                                       02040001
020500         FROM 1 BY 1                                              02050001
020600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02060001
020700                OR SQLCODE = -911                                 02070001
020800                OR SQLCODE = 0)                                   02080001
020900                                                                  02090001
021000         EXEC SQL                                                 02100001
021100             INSERT INTO GCT_GFT_CRD_RECNCL                       02110003
021200                 (CRD_ACCT_NBR                                    02120002
021300                 ,CRE_TMST                                        02130002
021400                 ,VND_TRN_ID                                      02140002
021500                 ,VND_RECNCL_DTE                                  02150002
021600                 ,VND_RECNCL_TRN_NBR                              02160002
021700                 ,RECNCL_RSPN_CDE                                 02170005
021800                 ,RSLU_TYP_CDE                                    02180002
021900                 ,CRD_PRVDR_SHRT_NM)                              02190002
022000             VALUES                                               02200002
022100                 (:AU013-GIFT-CARD-NBR                            02210002
022200                 ,CURRENT TIMESTAMP                               02220002
022300                 ,:AU013-TRN-ID                                   02230002
022400                 ,CURRENT DATE                                    02240002
022500                 ,:AU013-BLACKHAWK-TRAN-NBR                       02250002
022600                 ,:AU013-RESPONSE-CODE                            02260002
022700                 ,:AU013-TYPE-CODE                                02270002
022800                 ,:AU013-PARTNER)                                 02280002
022900         END-EXEC                                                 02290001
023000                                                                  02300001
023100         EVALUATE TRUE                                            02310001
023200             WHEN SQLCODE = 0                                     02320001
023300                 ADD +1 TO PA-CRD-INSERTED                        02330002
023400             WHEN SQLCODE = -911                                  02340001
023500                 ADD +1 TO PV-DEADLOCK-COUNTER                    02350001
023600                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02360001
023700                     MOVE '7000-VERIFY-CRD-TXN-RECORD           ' 02370002
023800                                      TO PV-PARAGRAPH-NAME        02380001
023900                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02390001
024000                                      TO PV-DB2-OPER-ATTEMPTED    02400001
024100                     PERFORM 9999-SQL-ABEND                       02410002
024200                 ELSE                                             02420001
024300                     SET PS-RESTART-REQUIRED TO TRUE              02430001
024400                 END-IF                                           02440001
024500             WHEN OTHER                                           02450001
024600                 DISPLAY 'UPDATE ABENDED ON CARD '                02460002
024700                           AU013-GIFT-CARD-NBR                    02470002
024800                 MOVE '7000-INSERT-RECON-RECORD           '       02480002
024900                                      TO PV-PARAGRAPH-NAME        02490001
025000                 MOVE 'UPDATE GCT_GFT_CRD_RECNCL     '            02500006
025100                                      TO PV-DB2-OPER-ATTEMPTED    02510001
025200                 PERFORM 9999-SQL-ABEND                           02520002
025300         END-EVALUATE                                             02530001
025400     END-PERFORM.                                                 02540001
025500                                                                  02550001
025600     IF PV-SQL-SUB > PC-MAX-RETRIES                               02560001
025700         MOVE '7000-VERIFY-CRD-TXN-RECORD           '             02570002
025800                                      TO PV-PARAGRAPH-NAME        02580001
025900         MOVE 'VERIFY RETRIES EXCEEDED       '                    02590001
026000                                      TO PV-DB2-OPER-ATTEMPTED    02600001
026100         PERFORM 9999-SQL-ABEND                                   02610002
026200     END-IF.                                                      02620001
026300                                                                  02630001
026400******************************************************************02640001
026500*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *02650001
026600*  CODE OCCURS.                                                  *02660001
026700******************************************************************02670001
026800 9999-SQL-ABEND.                                                  02680002
026900                                                                  02690001
027000     DISPLAY '** ABEND     **'.                                   02700001
027100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02710001
027200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02720001
027300     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          02730001
027400                                                                  02740001
027500******************************************************************02750001
027600*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02760001
027700*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *02770001
027800*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *02780001
027900*  FORMAT.                                                       *02790001
028000******************************************************************02800001
028100     COPY DPPD004.                                                02810001
028200                                                                  02820001
028300     MOVE +4013 TO ABEND-CODE.                                    02830001
028400     CALL 'ILBOABN0' USING ABEND-CODE.                            02840001
028500                                                                  02850001
028600******************************************************************02860001
028700*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02870001
028800*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*02880001
028900*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *02890001
029000******************************************************************02900001
029100     COPY DPPD001.                                                02910001
