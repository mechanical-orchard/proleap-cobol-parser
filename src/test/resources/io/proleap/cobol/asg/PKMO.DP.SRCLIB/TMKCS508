000100 IDENTIFICATION DIVISION.                                         00010000
000200 TITLE 'CHECK PACK BY STORE ALLOCATIONS'.                         00020000
000201*                                                                 00020100
000202*********************************************************         00020200
000203* *   IF ANY CHANGES ARE MADE TO THIS PROGRAM         * *         00020300
000204* *   BE SURE TO CHECK THE BATCH PROGRAM (TMKUP508)   * *         00020400
000205* *   TO SEE IF THE SAME CHANGE SHOULD BE MADE        * *         00020500
000206*********************************************************         00020600
000207*CHANGE HISTORY:                                        *         00020703
000208*********************************************************         00020800
000209*    CHANGES                                            *         00020900
000210*     MADE BY: PRITHIVIRAJ SUBRAMANIAN (COGNIZANT)      *         00021000
000211*     DATE:    12/06/2014                               *         00021100
000212*                                                       *         00021200
000213*      CHANGES THRU OUT THE PROGRAM TO INCREASE THE     *         00021300
000214*      SIZE OF PO# FROM 7 DIGITS TO 8 DIGITS.           *         00021400
000215*      TAGGED WITH *PS 10/12/2014                       *         00021500
000216*********************************************************         00021600
000217*                                                                 00021700
000218 PROGRAM-ID.    TMKCS508.                                         00021800
000219 AUTHOR.        DENNIS STEFFEN - OMNI RESOURCES.                  00021900
000220 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00022000
000230 DATE-WRITTEN.  FEBRUARY 1997.                                    00023000
000240 DATE-COMPILED.                                                   00024000
000250 ENVIRONMENT DIVISION.                                            00025000
000260 CONFIGURATION SECTION.                                           00026000
000270 SOURCE-COMPUTER.        IBM-3090.                                00027000
000280 OBJECT-COMPUTER.        IBM-3090.                                00028000
000290 DATA DIVISION.                                                   00029000
000300 WORKING-STORAGE SECTION.                                         00030000
000400                                                                  00040000
000500 01  PROGRAM-SWITCHES.                                            00050000
000600     05  PS-DONE-SW                   PIC  X    VALUE 'N'.        00060000
000700         88  PS-NOT-DONE                        VALUE 'N'.        00070000
000800         88  PS-DONE                            VALUE 'Y'.        00080000
000900     05  PS-ERRORS-SW                 PIC  X    VALUE 'N'.        00090000
001000         88  PS-NO-ERRORS                       VALUE 'N'.        00100000
001100         88  PS-YES-ERRORS                      VALUE 'Y'.        00110000
001200     05  PS-EOF-RECITM-SW             PIC  X    VALUE 'N'.        00120000
001300         88  PS-EOF-RECITM                      VALUE 'Y'.        00130000
001400     05  PS-EOF-RECDIS-SW             PIC  X    VALUE 'N'.        00140000
001500         88  PS-START-RECDIS                    VALUE 'N'.        00150000
001600         88  PS-EOF-RECDIS                      VALUE 'Y'.        00160000
001700     05  PS-RECITM-CSR-SW             PIC  X    VALUE 'N'.        00170000
001800         88  PS-RECITM-CSR-CLOSED               VALUE 'N'.        00180000
001900         88  PS-RECITM-CSR-OPEN                 VALUE 'Y'.        00190000
002000     05  PS-RECDIS-CSR-SW             PIC  X    VALUE 'N'.        00200000
002100         88  PS-RECDIS-CSR-CLOSED               VALUE 'N'.        00210000
002200         88  PS-RECDIS-CSR-OPEN                 VALUE 'Y'.        00220000
002300     05  PS-DISCREPANCY-SW            PIC  X    VALUE 'N'.        00230000
002400         88  PS-NO-DISCREPANCY                  VALUE 'N'.        00240000
002500         88  PS-DISCREPANCY                     VALUE 'Y'.        00250000
002600     05  PS-CALL-API-SW               PIC  X    VALUE 'N'.        00260000
002700         88  PS-CALL-API-NO                     VALUE 'N'.        00270000
002800         88  PS-CALL-API-YES                    VALUE 'Y'.        00280000
002900                                                                  00290000
003000 01  PROGRAM-VARIABLES.                                           00300000
003100     05  PV-CICS-RESP                 PIC S9(4) VALUE ZERO        00310000
003200                                                COMP SYNC.        00320000
003300     05  PV-SQLCODE                   PIC S9(9) COMP-4.           00330000
003400     05  PV-DISPLAY-SQLCODE           PIC -Z(8)9.                 00340000
003500*PS 10/12/2014 CHANGE STARTS                                      00350000
003600     05  PV-DISP-PO-NBR               PIC 9(8).                   00360000
003700*PS 10/12/2014 CHANGE ENDS                                        00370000
003800     05  PV-DISP-REC-SEQ-NBR          PIC 9(4).                   00380000
003900     05  PV-DISP-PO-LNE-NBR           PIC 9(3).                   00390000
004000     05  PV-DISP-OPER-UNT-ID          PIC 9(4).                   00400000
004100     05  PV-DISP-FCLTY-ID             PIC 9(4).                   00410000
004200     05  PV-DISP-STR-NBR              PIC 9(4).                   00420000
004300     05  PV-RETURN-MSG                PIC X(40).                  00430000
004400                                                                  00440000
004500     05  PV-TEMP-AMT                  PIC 9(7)V9(2).              00450000
004600     05  PV-TEMP-QTY                  PIC 9(4).                   00460000
004700     05  PV-OP.                                                   00470000
004800         10  PV-OP-N                  PIC 9999.                   00480000
004900     05  PV-FCLTY.                                                00490000
005000         10  PV-FCLTY-N               PIC 9.                      00500000
005100     05  PV-PO.                                                   00510000
005200         10  PV-PO-N                  PIC 9(8).                   00520000
005300     05  PV-LINE.                                                 00530000
005400         10  PV-LINE-N                PIC 999.                    00540000
005500     05  PV-REC-SEQ-NBR.                                          00550000
005600         10  PV-REC-SEQ-NBR-N         PIC 999.                    00560000
005700     05  DK-ITM-NBR                   PIC S9(15)V COMP-3.         00570000
005800     05  PV-UNT-RTL-AMT               PIC S9(7)V9(2).             00580000
005900     05  PV-GP-QTY                    PIC S9(9).                  00590000
006000     05  PV-GP-AMT                    PIC S9(7)V9(2).             00600000
006100                                                                  00610000
006200 01  PROGRAM-KEYS.                                                00620000
006300     05  DK-PO-NBR                    PIC S9(9) COMP VALUE ZERO.  00630000
006400     05  DK-LINE-NBR                  PIC S9(9) COMP VALUE ZERO.  00640000
006500                                                                  00650000
006600 01  PROGRAM-LITERALS.                                            00660000
006700     05  PC-CURRENT-PROGRAM-NAME      PIC X(8)  VALUE 'TMKCS508'. 00670000
006800     05  PC-TROUBLE-WTR               PIC X(8)  VALUE 'TMKCS521'. 00680000
006900     05  PC-TROUBLE-LENGTH            PIC S9(4) VALUE +600        00690000
007000                                                COMP.             00700000
007100     05  PC-A                         PIC X     VALUE 'A'.        00710000
007200     05  PC-MAX-OCCURENCES            PIC S9(3) VALUE +999        00720000
007300                                                COMP-3.           00730000
007400     05  PC-MAX-RETRIES               PIC S9(4) VALUE +3          00740000
007500                                                COMP SYNC.        00750000
007600     05  PC-TMKCS508                  PIC X(08) VALUE             00760000
007700                                                'TMKCS508'.       00770000
007800     05  PC-000                       PIC X(03) VALUE '000'.      00780000
007900     05  PC-999                       PIC X(03) VALUE '999'.      00790000
008000                                                                  00800000
008100     05  PC-532                       PIC S9(4) COMP VALUE +532.  00810000
008200*  STORE OVER-SHIPPED                                             00820000
008300     05  PC-533                       PIC S9(4) COMP VALUE +533.  00830000
008400     05  PC-600                       PIC S9(4) COMP VALUE +600.  00840000
008500                                                                  00850000
008600     05  PC-PRICE-DISC-TEXT.                                      00860000
008700         10  PC-PRICE-DISC-TEXT-1.                                00870000
008800             15  PC-PD-TEXT-1         PIC X(15) VALUE             00880000
008900             'PO UNIT RTL  : '.                                   00890000
009000             15  PC-PD-PO-UNT-RTL     PIC ZZZZZZ9.99.             00900000
009100             15  PC-PD-TEXT-2         PIC X(15) VALUE             00910000
009200             ' SKU UNIT RTL: '.                                   00920000
009300             15  PC-PD-SKU-UNT-RTL    PIC ZZZZZZ9.99.             00930000
009400         10  PC-PRICE-DISC-TEXT-2.                                00940000
009500             15  PC-PD-TEXT-5         PIC X(21) VALUE             00950000
009600             'PO GRP QTY   :       '.                             00960000
009700             15  PC-PD-PO-GP-QTY      PIC ZZZ9.                   00970000
009800             15  PC-PD-TEXT-6         PIC X(21) VALUE             00980000
009900             ' SKU GRP QTY :       '.                             00990000
010000             15  PC-PD-SKU-GP-QTY     PIC ZZZ9.                   01000000
010100         10  PC-PRICE-DISC-TEXT-3.                                01010000
010200             15  PC-PD-TEXT-3         PIC X(15) VALUE             01020000
010300             'PO GRP RTL   : '.                                   01030000
010400             15  PC-PD-PO-GP-RTL      PIC ZZZZZZ9.99.             01040000
010500             15  PC-PD-TEXT-4         PIC X(15) VALUE             01050000
010600             ' SKU GRP RTL : '.                                   01060000
010700             15  PC-PD-SKU-GP-RTL     PIC ZZZZZZ9.99.             01070000
010800                                                                  01080000
010900*  PACK BY STORE SYSTEM ERROR                                     01090000
011000                                                                  01100000
011100 01  PC-MESSAGE-NUMBERS.                                          01110000
011200     05  PC-TSYMSG-01527              PIC 9(5) VALUE 1527.        01120000
011300*TRANSCRIPTION COMPLETE - PACK-BY-STORE OTR FAILED, CHECK TROUBLE 01130000
011400     05  PC-TSYMSG-01528              PIC 9(5) VALUE 1528.        01140000
011500*TRANSCRIPTION COMPLETE - TROUBLE SYSTEM ERROR                    01150000
011600* - PBS OTR CHECK NOT DONE                                        01160000
011700                                                                  01170000
011800 01  PC-SYSTEM-ERROR-TEXT.                                        01180000
011900     05  FILLER                       PIC X(50) VALUE             01190000
012000         'THE PACKED-BY-STORE OPEN-TO-RECEIVE CHECK HAS     '.    01200000
012100     05  FILLER                       PIC X(50) VALUE             01210000
012200         'ENCOUNTERED A SYSTEM ERROR.  THE CHECK COULD NOT  '.    01220000
012300     05  FILLER                       PIC X(50) VALUE             01230000
012400         'BE COMPLETED.  THIS PO/RECEIVER NEEDS TO BE       '.    01240000
012500     05  FILLER                       PIC X(50) VALUE             01250000
012600         'CHECKED MANUALLY.  LINES PRIOR TO THE LINE WITH   '.    01260000
012700     05  FILLER                       PIC X(50) VALUE             01270000
012800         'THIS ERROR HAVE ALREADY BEEN CHECKED FOR OVERAGES.'.    01280000
012900                                                                  01290000
013000                                                                  01300000
013100 01  PT-STORE-TABLE.                                              01310000
013200     05  PT-STR-NBR                   PIC S9(4) COMP              01320000
013300             OCCURS 999 TIMES INDEXED BY PT-IDX, PT-END-IDX.      01330000
013400                                                                  01340000
013500 01  PRV-PROGRAM-RETURN-VARIABLES.                                01350000
013600     05  PRV-00                       PIC X(42) VALUE             01360000
013700         '00PROGRAM CALL WAS SUCCESSFUL             '.            01370000
013800     05  PRV-01                       PIC X(42) VALUE             01380000
013900         '01DIDNT ALLOCATE TO STORES DUE TO TROUBLE '.            01390000
014000     05  PRV-2A                       PIC X(42) VALUE             01400000
014100         '2ARECORD NOT FOUND - TALLPLN SELECT       '.            01410000
014200     05  PRV-2B                       PIC X(42) VALUE             01420000
014300         '2BDB2-ERROR - TALLPLN SELECT              '.            01430000
014400     05  PRV-2C                       PIC X(42) VALUE             01440000
014500         '2CDB2-ERROR - TRECEIV SELECT              '.            01450000
014600     05  PRV-2D                       PIC X(42) VALUE             01460000
014700         '2DDB2-ERROR - TPURITM SELECT              '.            01470000
014800     05  PRV-2E                       PIC X(42) VALUE             01480000
014900         '2EDB2-ERROR - XLV_SKU SELECT              '.            01490000
015000     05  PRV-2F                       PIC X(42) VALUE             01500000
015100         '2FDB2-ERROR - TCOCNTL SELECT              '.            01510000
015200     05  PRV-2G                       PIC X(42) VALUE             01520000
015300         '2GDB2-ERROR - PRICE-CHANGE-CSR OPEN       '.            01530000
015400     05  PRV-2H                       PIC X(42) VALUE             01540000
015500         '2HDB2-ERROR - PRICE-CHANGE-CSR FETCH      '.            01550000
015600     05  PRV-2I                       PIC X(42) VALUE             01560000
015700         '2IDB2-ERROR - PRICE-CHANGE-CSR CLOSE      '.            01570000
015800     05  PRV-2K                       PIC X(42) VALUE             01580000
015900         '2KDB2-ERROR - TMESTDS SELECT              '.            01590000
016000     05  PRV-2L                       PIC X(42) VALUE             01600000
016100         '2LDB2-ERROR - TVNDSTL SELECT              '.            01610000
016200     05  PRV-2M                       PIC X(42) VALUE             01620000
016300         '2MDB2-ERROR - TWEBITM SELECT              '.            01630000
016400     05  PRV-2N                       PIC X(42) VALUE             01640000
016500         '2EDB2-ERROR - XLV_SKU_STR SELECT          '.            01650000
016600     05  PRV-TM500-RETURN-MSG.                                    01660000
016700         10  PRV-PGM                  PIC X(3).                   01670000
016800         10  FILLER                   PIC X(1).                   01680000
016900         10  PRV-PARA                 PIC X(4).                   01690000
017000         10  FILLER                   PIC X(1).                   01700000
017100         10  PRV-TBL                  PIC X(12).                  01710000
017200         10  FILLER                   PIC X(1).                   01720000
017300         10  PRV-OP                   PIC X(4).                   01730000
017400         10  FILLER                   PIC X(1).                   01740000
017500         10  PRV-FCLTY                PIC X(1).                   01750000
017600         10  FILLER                   PIC X(1).                   01760000
017700         10  PRV-PO                   PIC X(8).                   01770000
017800         10  FILLER                   PIC X(1).                   01780000
017900         10  PRV-LINE                 PIC X(3).                   01790000
018000         10  FILLER                   PIC X(1).                   01800000
018100         10  PRV-REC-SEQ-NBR          PIC X(3).                   01810000
018200         10  FILLER                   PIC X(1).                   01820000
018300                                                                  01830000
018400/                                                                 01840000
018500     COPY TMWS500.                                                01850000
018600/                                                                 01860000
018700     COPY TMWS508.                                                01870000
018800/                                                                 01880000
018900     COPY DPWS276.                                                01890000
019000/                                                                 01900000
019100     COPY DPWS013.                                                01910000
019200/                                                                 01920000
019300     COPY DPWS020.                                                01930000
019400*----------------------------------------------------------------*01940000
019500*  COPYBOOK FOR LOGISTICS DOMAIN ITEM ACCESS MODULE               01950000
019600     COPY XLWS001.                                                01960000
019700*----------------------------------------------------------------*01970000
019800/                                                                 01980000
019900     EXEC SQL                                                     01990000
020000          INCLUDE TRECITM                                         02000000
020100     END-EXEC.                                                    02010000
020200/                                                                 02020000
020300     EXEC SQL                                                     02030000
020400          INCLUDE TRECDIS                                         02040000
020500     END-EXEC.                                                    02050000
020600/                                                                 02060000
020700     EXEC SQL                                                     02070000
020800          INCLUDE TPURITM                                         02080000
020900     END-EXEC.                                                    02090000
021000/                                                                 02100000
021100     EXEC SQL                                                     02110000
021200          INCLUDE TPURCHS                                         02120000
021300     END-EXEC.                                                    02130000
021400/                                                                 02140000
021500*----------------------------------------------------------------*02150000
021600     EXEC SQL                                                     02160000
021700          INCLUDE SQLCA                                           02170000
021800     END-EXEC.                                                    02180000
021900/                                                                 02190000
022000******************************************************************02200000
022100*    THIS IS A LIST OF LINE NUMBERS FOR THE PO, RCVR              02210000
022200******************************************************************02220000
022300     EXEC SQL                                                     02230000
022400          DECLARE RECITM-CSR CURSOR FOR                           02240000
022500          SELECT B.PO_LNE_NBR                                     02250000
022600               , B.APP_PO_LNE_NBR                                 02260000
022700               , B.SKU_SEQ_NBR                                    02270000
022800               , B.UNT_RTL_PR_AMT                                 02280000
022900               , B.ITM_NBR                                        02290000
023000               , B.GP_RTL_AMT                                     02300000
023100               , B.GP_QTY                                         02310000
023200           FROM  TRECITM A                                        02320000
023300               , TPURITM B                                        02330000
023400           WHERE A.ORD_NBR        = :TM508-PO-NBR                 02340000
023500             AND A.OPER_UNT_ID    = :TM508-OPER-UNT-ID            02350000
023600             AND A.REC_SEQ_NBR    = :TM508-REC-SEQ-NBR            02360000
023700                                                                  02370000
023800             AND A.VER_STATUS_CDE = :PC-A                         02380000
023900             AND B.VER_STATUS_CDE = :PC-A                         02390000
024000             AND A.ORD_NBR        =  B.PO_NBR                     02400000
024100             AND A.ORD_LNE_NBR    =  B.APP_PO_LNE_NBR             02410000
024200         ORDER BY B.PO_LNE_NBR                                    02420000
024300     END-EXEC.                                                    02430000
024400/                                                                 02440000
024500******************************************************************02450000
024600*    THIS IS A LIST OF STORES FOR THE PO, RCVR, LINE              02460000
024700******************************************************************02470000
024800     EXEC SQL                                                     02480000
024900          DECLARE RECDIS-CSR CURSOR FOR                           02490000
025000          SELECT STR_NBR                                          02500000
025100            FROM TRECDIS                                          02510000
025200           WHERE ORD_NBR         = :TM508-PO-NBR                  02520000
025300             AND ORD_LNE_NBR     = :PURITM-APP-PO-LNE-NBR         02530000
025400             AND REC_SEQ_NBR     = :TM508-REC-SEQ-NBR             02540000
025500             AND OPER_UNT_ID     = :TM508-OPER-UNT-ID             02550000
025600             AND FCLTY_ID        = :TM508-FCLTY-ID                02560000
025800         ORDER BY STR_NBR                                         02580000
025900     END-EXEC.                                                    02590000
026000/                                                                 02600000
026100 LINKAGE SECTION.                                                 02610000
026200                                                                  02620000
026300 01  DFHCOMMAREA.                                                 02630000
026400     05  FILLER                       OCCURS 1 TO 15000 TIMES     02640000
026500                                      DEPENDING ON EIBCALEN.      02650000
026600         10  FILLER                   PIC X.                      02660000
026700                                                                  02670000
026800/                                                                 02680000
026900 PROCEDURE DIVISION.                                              02690000
027000                                                                  02700000
027100     PERFORM 1000-HOUSEKEEPING.                                   02710000
027200                                                                  02720000
027300     PERFORM 4000-CHECK-DIRECT-STORE                              02730000
027400                                                                  02740000
027500     MOVE TM508-COMMAREA              TO DFHCOMMAREA.             02750000
027600                                                                  02760000
027700     GOBACK.                                                      02770000
027800                                                                  02780000
027900 1000-HOUSEKEEPING.                                               02790000
028000     MOVE DFHCOMMAREA                 TO TM508-COMMAREA.          02800000
028100     INITIALIZE DP276-OTR-TABLE                                   02810000
028200                DP276-RETURN-DATA                                 02820000
028300                PT-STORE-TABLE.                                   02830000
028400                                                                  02840000
028500     SET DP276-PACK-BY-STORE          TO TRUE.                    02850000
028600     SET DP276-PO-OTR                 TO TRUE.                    02860000
028700                                                                  02870000
028800     MOVE TM508-PO-NBR                TO DP276-PO-NBR             02880000
028900     MOVE TM508-REC-SEQ-NBR           TO DP276-REC-SEQ-NBR        02890000
029000     MOVE TM508-OPER-UNT-ID           TO DP276-OPER-UNT-ID        02900000
029100     MOVE TM508-FCLTY-ID              TO DP276-FCLTY-ID.          02910000
029200                                                                  02920000
029300******************************************************************02930000
029400 4000-CHECK-DIRECT-STORE.                                         02940000
029500******************************************************************02950000
029600     PERFORM 7000-OPEN-RECITM-CSR.                                02960000
029700                                                                  02970000
029800     IF PS-RECITM-CSR-OPEN                                        02980000
029900         PERFORM 7100-FETCH-RECITM-CSR                            02990000
030000     END-IF.                                                      03000000
030100                                                                  03010000
030200     IF PS-NO-ERRORS                                              03020000
030300         PERFORM 4100-PROCESS-RECITMS UNTIL PS-EOF-RECITM         03030000
030400             OR PS-YES-ERRORS                                     03040000
030500     END-IF                                                       03050000
030600                                                                  03060000
030700     IF PS-RECITM-CSR-OPEN                                        03070000
030800         PERFORM 7200-CLOSE-RECITM-CSR                            03080000
030900     END-IF.                                                      03090000
031000/                                                                 03100000
031100 4100-PROCESS-RECITMS.                                            03110000
031200                                                                  03120000
031300     MOVE PURITM-PO-LNE-NBR           TO DP276-PO-LNE-NBR.        03130000
031400                                                                  03140000
031500     PERFORM 4110-CALC-OTR.                                       03150000
031600                                                                  03160000
031700* DPKCS276 WILL ALLOW A NEGATIVE OTR FOR A PACK-BY-STORE RECEIVER.03170000
031800* DPKCS276 DEALS WITH ALL STORES IN TMESTDS FOR THE PO.  WE ARE   03180000
031900* ONLY CONCERNED WITH THE STORES IN THE CURRENT RCVR AND LINE.    03190000
032000* THE TWO LISTS MAY NOT BE THE SAME.                              03200000
032100                                                                  03210000
032200     PERFORM 4200-TABLIZE-STORES                                  03220000
032300                                                                  03230000
032400     PERFORM 4300-CHECK-RCVR-STORES                               03240000
032500                                                                  03250000
032600     PERFORM 7100-FETCH-RECITM-CSR.                               03260000
032700*----------------------------------------------------------------*03270000
032800 4110-CALC-OTR.                                                   03280000
032900                                                                  03290000
033000     EXEC CICS LINK                                               03300000
033100         PROGRAM  ('DPKCS276')                                    03310000
033200         COMMAREA (DP276-COMMAREA)                                03320000
033300         RESP     (PV-CICS-RESP)                                  03330000
033400     END-EXEC.                                                    03340000
033500                                                                  03350000
033600*  CHECK CICS RETURN CODE                                         03360000
033700     IF PV-CICS-RESP = DFHRESP(NORMAL)                            03370000
033800         CONTINUE                                                 03380000
033900     ELSE                                                         03390000
034000         SET DP013-CICS-ABEND                                     03400000
034100             DP013-NO-ROLLBACK   TO TRUE                          03410000
034200         MOVE '4110-CALC-OTR'                                     03420000
034300                                 TO DP013-PARAGRAPH               03430000
034400         MOVE 'ATTEMPTING TO LINK TO PROGRAM DPKCS276'            03440000
034500                                 TO DP013-MESSAGE-TEXT (1)        03450000
034600         PERFORM DP013-0000-PROCESS-ABEND                         03460000
034700     END-IF.                                                      03470000
034800                                                                  03480000
034900*  CHECK DP276-RETURN-CODE                                        03490000
035000     EVALUATE TRUE                                                03500000
035100     WHEN DP276-RETURN-CODE = ZERO                                03510000
035200         CONTINUE                                                 03520000
035300     WHEN DP276-RETURN-CODE = 3                                   03530000
035400             MOVE 11                TO TM508-RETURN-CODE          03540000
035500     WHEN DP276-RETURN-CODE = 6                                   03550000
035600             MOVE 12                TO TM508-RETURN-CODE          03560000
035700     WHEN DP276-RETURN-CODE = 4                                   03570000
035800     WHEN DP276-RETURN-CODE = 7                                   03580000
035900     WHEN DP276-RETURN-CODE = 12                                  03590000
036000     WHEN DP276-RETURN-CODE = 17                                  03600000
036100     WHEN DP276-RETURN-CODE = 19                                  03610000
036200     WHEN DP276-RETURN-CODE = 21                                  03620000
036300     WHEN DP276-RETURN-CODE = 23                                  03630000
036400     WHEN DP276-RETURN-CODE = 27                                  03640000
036500     WHEN DP276-RETURN-CODE = 31                                  03650000
036600     WHEN DP276-RETURN-CODE = 35                                  03660000
036700             MOVE 13                TO TM508-RETURN-CODE          03670000
036800     WHEN OTHER                                                   03680000
036900         EVALUATE TRUE                                            03690000
037000         WHEN DP276-SOFT-ABORT                                    03700000
037100         WHEN DP276-NO-DISTRO                                     03710000
037200             MOVE 1                   TO TM508-RETURN-CODE        03720000
037300             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         03730000
037400             PERFORM 9900-SOFT-ABORT                              03740000
037500         WHEN OTHER                                               03750000
037600             MOVE 2                   TO TM508-RETURN-CODE        03760000
037700             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         03770000
037800             PERFORM 9800-CROAK                                   03780000
037900         END-EVALUATE                                             03790000
038000     END-EVALUATE.                                                03800000
038100/                                                                 03810000
038200 4200-TABLIZE-STORES.                                             03820000
038300                                                                  03830000
038400     SET PS-START-RECDIS TO TRUE.                                 03840000
038500     PERFORM 7300-OPEN-RECDIS-CSR.                                03850000
038600                                                                  03860000
038700     IF PS-RECDIS-CSR-OPEN                                        03870000
038800         PERFORM 7400-FETCH-RECDIS-CSR                            03880000
038900     END-IF                                                       03890000
039000                                                                  03900000
039100     IF PS-NO-ERRORS                                              03910000
039200         PERFORM VARYING PT-IDX FROM 1 BY 1                       03920000
039300                 UNTIL PS-EOF-RECDIS OR PT-IDX > 999              03930000
039400             MOVE RECDIS-STR-NBR      TO PT-STR-NBR (PT-IDX)      03940000
039500             SET PT-END-IDX           TO PT-IDX                   03950000
039600             PERFORM 7400-FETCH-RECDIS-CSR                        03960000
039700         END-PERFORM                                              03970000
039800     END-IF.                                                      03980000
039900                                                                  03990000
040000     IF PS-RECDIS-CSR-OPEN                                        04000000
040100         PERFORM 7500-CLOSE-RECDIS-CSR                            04010000
040200     END-IF.                                                      04020000
040300                                                                  04030000
040400/                                                                 04040000
040500 4300-CHECK-RCVR-STORES.                                          04050000
040600                                                                  04060000
040700* FOR EACH STORE ON THE GIVEN PO, RECEIVER, AND LINE, CHECK TO    04070000
040800* SEE IF IT HAS A NEGATIVE OTR.  THIS WOULD DENOTE AN             04080000
040900* OVER-SHIPMENT OF THE MDSE FOR THAT STORE.  THE PRESENCE OF THE  04090000
041000* FIRST ERROR PUTS THE LINE IN ERROR.  SO WRITE THE TROUBLE ROW   04100000
041100* AND CONTINUE WITH THE OTHER LINES IN THE RECEIVER.              04110000
041200* IF A STORE ISN'T FOUND IN THE OTR TABLE THEN IT HAS RECEIVED    04120000
041300* MERCHANDISE THAN IT WASN'T SUPPOSED TO HAVE.  THIS WOULD ALSO   04130000
041400* CAUSE THE LINE TO BE PUT INTO TROUBLE AS AN OVERAGE JUST LIKE   04140000
041500* A NEGATIVE OTR.                                                 04150000
041600*                                                                 04160000
041700     PERFORM 4310-STORE-SEARCH                                    04170000
041800         VARYING PT-IDX FROM 1 BY 1                               04180000
041900         UNTIL                                                    04190000
042000             PT-IDX > 999 OR                                      04200000
042100             PT-IDX > PT-END-IDX OR                               04210000
042200             PT-STR-NBR(PT-IDX) = ZERO.                           04220000
042300                                                                  04230000
042400 4310-STORE-SEARCH.                                               04240000
042500                                                                  04250000
042600     MOVE PT-STR-NBR(PT-IDX) TO DP276-SEARCH-NBR                  04260000
042700     SET DP276-IDX TO 1                                           04270000
042800     SEARCH DP276-WORK-AREA                                       04280000
042900         WHEN DP276-STORE-NBR (DP276-IDX) = ZERO                  04290000
043000             MOVE PC-532    TO TM500-TRBL-RSN-CDE                 04300000
043100             SET TM500-NO-DETAILS                                 04310000
043200                            TO TRUE                               04320000
043300             SET TM500-CREATE-AUTO TO TRUE                        04330000
043400             PERFORM 5000-MAKE-TROUBLE                            04340000
043500             SET PT-IDX TO 999                                    04350000
043600         WHEN DP276-STORE-NBR (DP276-IDX) = DP276-SEARCH-NBR      04360000
043700             IF DP276-OTR-QTY (DP276-IDX) < ZERO                  04370000
043800                 MOVE PC-532                                      04380000
043900                            TO TM500-TRBL-RSN-CDE                 04390000
044000                 SET TM500-NO-DETAILS                             04400000
044100                            TO TRUE                               04410000
044200                 SET TM500-CREATE-AUTO TO TRUE                    04420000
044300                 PERFORM 5000-MAKE-TROUBLE                        04430000
044400                 SET PT-IDX TO 999                                04440000
044500             END-IF                                               04450000
044600     END-SEARCH.                                                  04460000
044700/                                                                 04470000
044800 5000-MAKE-TROUBLE.                                               04480000
044900                                                                  04490000
045000     MOVE TM508-PO-NBR             TO TM500-PO-NBR.               04500000
045100     MOVE PURITM-APP-PO-LNE-NBR    TO TM500-PO-LNE-NBR.           04510000
045200     MOVE TM508-OPER-UNT-ID        TO TM500-OPER-UNT-ID.          04520000
045300     MOVE TM508-FCLTY-ID           TO TM500-FCLTY-ID.             04530000
045400     MOVE TM508-REC-SEQ-NBR        TO TM500-REC-SEQ-NBR.          04540000
045500     MOVE PC-CURRENT-PROGRAM-NAME  TO TM500-NOTIF-UID.            04550000
045600                                                                  04560000
045700     EXEC CICS                                                    04570000
045800         LINK PROGRAM  (PC-TROUBLE-WTR)                           04580000
045900              COMMAREA (TM500-FIELDS)                             04590000
046000              LENGTH   (PC-TROUBLE-LENGTH)                        04600000
046100     END-EXEC.                                                    04610000
046200                                                                  04620000
046300     EVALUATE TRUE                                                04630000
046400         WHEN TM500-CALL-SUCCESSFUL                               04640000
046500         WHEN TM500-DUPLICATE-TROUBLE                             04650000
046600         WHEN TM500-TTRBNTF-UPDATE-NOT-FND                        04660000
046700         WHEN TM500-DIDNT-ALLOC-DUE-TO-TRBL                       04670000
046800             CONTINUE                                             04680000
046900                                                                  04690000
047000         WHEN OTHER                                               04700000
047100             MOVE 999                 TO TM508-RETURN-CODE        04710000
047200             MOVE PC-TSYMSG-01528     TO TM508-MSG-NUMBER         04720000
047300             PERFORM 9800-CROAK                                   04730000
047400     END-EVALUATE.                                                04740000
047500                                                                  04750000
047600     ADD 1 TO TM508-TROUBLE-COUNT.                                04760000
047700/                                                                 04770000
047800 7000-OPEN-RECITM-CSR.                                            04780000
047900     EXEC SQL                                                     04790000
048000         OPEN RECITM-CSR                                          04800000
048100     END-EXEC.                                                    04810000
048200                                                                  04820000
048300     EVALUATE TRUE                                                04830000
048400         WHEN SQLCODE = ZERO                                      04840000
048500             SET PS-RECITM-CSR-OPEN   TO TRUE                     04850000
048600         WHEN SQLCODE = -904                                      04860000
048700         WHEN SQLCODE = -911                                      04870000
048800         WHEN SQLCODE = -913                                      04880000
048900             MOVE 3                   TO TM508-RETURN-CODE        04890000
049000             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         04900000
049100             PERFORM 9900-SOFT-ABORT                              04910000
049200         WHEN OTHER                                               04920000
049300             MOVE 4                   TO TM508-RETURN-CODE        04930000
049400             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         04940000
049500             PERFORM 9800-CROAK                                   04950000
049600     END-EVALUATE.                                                04960000
049700/                                                                 04970000
049800 7100-FETCH-RECITM-CSR.                                           04980000
049900     EXEC SQL                                                     04990000
050000         FETCH RECITM-CSR                                         05000000
050100         INTO   :PURITM-PO-LNE-NBR                                05010000
050200              , :PURITM-APP-PO-LNE-NBR                            05020000
050300              , :PURITM-SKU-SEQ-NBR                               05030000
050400              , :PURITM-UNT-RTL-PR-AMT                            05040000
050500              , :PURITM-ITM-NBR                                   05050000
050600              , :PURITM-GP-RTL-AMT                                05060000
050700              , :PURITM-GP-QTY                                    05070000
050800     END-EXEC.                                                    05080000
050900                                                                  05090000
051000     MOVE ZEROES TO DK-ITM-NBR                                    05100000
051100                                                                  05110000
051200     EVALUATE TRUE                                                05120000
051300         WHEN SQLCODE = ZERO                                      05130000
051400             SET PS-CALL-API-YES     TO TRUE                      05140000
051500             MOVE PURITM-ITM-NBR     TO DK-ITM-NBR                05150000
051600             CONTINUE                                             05160000
051700         WHEN SQLCODE = +100                                      05170000
051800             SET PS-EOF-RECITM     TO TRUE                        05180000
051900         WHEN OTHER                                               05190000
052000             MOVE 5                   TO TM508-RETURN-CODE        05200000
052100             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05210000
052200             PERFORM 9800-CROAK                                   05220000
052300     END-EVALUATE.                                                05230000
052400/                                                                 05240000
052500 7200-CLOSE-RECITM-CSR.                                           05250000
052600     EXEC SQL                                                     05260000
052700         CLOSE RECITM-CSR                                         05270000
052800     END-EXEC.                                                    05280000
052900                                                                  05290000
053000     EVALUATE TRUE                                                05300000
053100         WHEN SQLCODE = ZERO                                      05310000
053200             SET PS-RECITM-CSR-CLOSED TO TRUE                     05320000
053300         WHEN OTHER                                               05330000
053400             MOVE 6                   TO TM508-RETURN-CODE        05340000
053500             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05350000
053600             PERFORM 9800-CROAK                                   05360000
053700     END-EVALUATE.                                                05370000
053800/                                                                 05380000
053900 7300-OPEN-RECDIS-CSR.                                            05390000
054000                                                                  05400000
054100     SET PS-RECDIS-CSR-CLOSED TO TRUE                             05410000
054200                                                                  05420000
054300     EXEC SQL                                                     05430000
054400         OPEN RECDIS-CSR                                          05440000
054500     END-EXEC.                                                    05450000
054600                                                                  05460000
054700     EVALUATE TRUE                                                05470000
054800         WHEN SQLCODE = ZERO                                      05480000
054900             SET PS-RECDIS-CSR-OPEN TO TRUE                       05490000
055000         WHEN SQLCODE = -904                                      05500000
055100         WHEN SQLCODE = -911                                      05510000
055200         WHEN SQLCODE = -913                                      05520000
055300             MOVE 7                   TO TM508-RETURN-CODE        05530000
055400             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05540000
055500             PERFORM 9900-SOFT-ABORT                              05550000
055600         WHEN OTHER                                               05560000
055700             MOVE 8                   TO TM508-RETURN-CODE        05570000
055800             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05580000
055900             PERFORM 9800-CROAK                                   05590000
056000     END-EVALUATE.                                                05600000
056100/                                                                 05610000
056200 7400-FETCH-RECDIS-CSR.                                           05620000
056300     EXEC SQL                                                     05630000
056400         FETCH RECDIS-CSR                                         05640000
056500         INTO   :RECDIS-STR-NBR                                   05650000
056600     END-EXEC.                                                    05660000
056700                                                                  05670000
056800     EVALUATE TRUE                                                05680000
056900         WHEN SQLCODE = ZERO                                      05690000
057000             CONTINUE                                             05700000
057100         WHEN SQLCODE = +100                                      05710000
057200             SET PS-EOF-RECDIS        TO TRUE                     05720000
057300         WHEN OTHER                                               05730000
057400             MOVE 9                   TO TM508-RETURN-CODE        05740000
057500             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05750000
057600             PERFORM 9800-CROAK                                   05760000
057700     END-EVALUATE.                                                05770000
057800/                                                                 05780000
057900 7500-CLOSE-RECDIS-CSR.                                           05790000
058000     EXEC SQL                                                     05800000
058100         CLOSE RECDIS-CSR                                         05810000
058200     END-EXEC.                                                    05820000
058300                                                                  05830000
058400     EVALUATE TRUE                                                05840000
058500         WHEN SQLCODE = ZERO                                      05850000
058600             CONTINUE                                             05860000
058700         WHEN OTHER                                               05870000
058800             MOVE 10                  TO TM508-RETURN-CODE        05880000
058900             MOVE PC-TSYMSG-01527     TO TM508-MSG-NUMBER         05890000
059000             PERFORM 9800-CROAK                                   05900000
059100     END-EVALUATE.                                                05910000
059200/                                                                 05920000
059300*----------------------------------------------------------------*05930000
059400*    WHEN A FATAL ERROR OCCURS PASS THE ERROR SWITCHES BACK TO    05940000
059500*    THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG.         *05950000
059600*----------------------------------------------------------------*05960000
059700 9800-CROAK.                                                      05970000
059800                                                                  05980000
059900     SET PS-YES-ERRORS                TO TRUE                     05990000
060000     SET TM508-FATAL-ERROR                                        06000000
060100         TM508-CROAK                  TO TRUE                     06010000
060200     MOVE SQLCODE                     TO PV-SQLCODE               06020000
060300                                                                  06030000
060400* IF AN ERROR OCCURRED BEFORE A LINE NUMBER IS AVAILABLE, MOVE 99906040000
060500* TO MAKE THE ROW ACCESSABLE TO THE TROUBLE RESOLUTION SCREENS.   06050000
060600                                                                  06060000
060700     IF PURITM-APP-PO-LNE-NBR         = ZERO                      06070000
060800         MOVE 1                       TO PURITM-APP-PO-LNE-NBR    06080000
060900                                         DP276-PO-LNE-NBR         06090000
061000     END-IF                                                       06100000
061100                                                                  06110000
061200     PERFORM 9950-FORMAT-ERROR-MSG.                               06120000
061300                                                                  06130000
061400* IF TROUBLE ITSELF HAS ABENDED WE CAN'T INVOKE IT AGAIN.         06140000
061500     IF TM508-RETURN-CODE = 999                                   06150000
061600         CONTINUE                                                 06160000
061700     ELSE                                                         06170000
061800         PERFORM 9810-WRITE-ABEND-TRBL                            06180000
061900     END-IF.                                                      06190000
062000                                                                  06200000
062100     SET DP013-LINK-RETURN                                        06210000
062200         DP013-NO-ROLLBACK TO TRUE                                06220000
062300     PERFORM DP013-0000-PROCESS-ABEND.                            06230000
062400                                                                  06240000
062500 9810-WRITE-ABEND-TRBL.                                           06250000
062600                                                                  06260000
062700     MOVE PC-533            TO TM500-TRBL-RSN-CDE                 06270000
062800     SET TM500-ADD-DETAILS  TO TRUE                               06280000
062900     SET TM500-CREATE-AUTO  TO TRUE                               06290000
063000     MOVE PC-SYSTEM-ERROR-TEXT TO TM500-FREEFORM-TEXT.            06300000
063100     PERFORM 5000-MAKE-TROUBLE.                                   06310000
063200                                                                  06320000
063300*----------------------------------------------------------------*06330000
063400*    THE DB2 RESOURCE IS NOT AVAILABLE, PASS THE ERROR SWITCHES  *06340000
063500*    BACK TO THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG  *06350000
063600*----------------------------------------------------------------*06360000
063700 9900-SOFT-ABORT.                                                 06370000
063800                                                                  06380000
063900                                                                  06390000
064000* IF AN ERROR OCCURRED BEFORE A LINE NUMBER IS AVAILABLE, MOVE 99906400000
064100* TO MAKE THE ROW ACCESSABLE TO THE TROUBLE RESOLUTION SCREENS.   06410000
064200                                                                  06420000
064300     IF PURITM-APP-PO-LNE-NBR         = ZERO                      06430000
064400         MOVE 1                       TO PURITM-APP-PO-LNE-NBR    06440000
064500                                         DP276-PO-LNE-NBR         06450000
064600     END-IF                                                       06460000
064700                                                                  06470000
064800     PERFORM 9810-WRITE-ABEND-TRBL                                06480000
064900                                                                  06490000
065000     SET PS-YES-ERRORS                                            06500000
065100         TM508-FATAL-ERROR                                        06510000
065200         TM508-SOFT-ABORT             TO TRUE.                    06520000
065300                                                                  06530000
065400     PERFORM 9950-FORMAT-ERROR-MSG.                               06540000
065500                                                                  06550000
065600     SET DP013-LINK-RETURN                                        06560000
065700         DP013-NO-ROLLBACK TO TRUE                                06570000
065800                                                                  06580000
065900     PERFORM DP013-0000-PROCESS-ABEND.                            06590000
066000                                                                  06600000
066100 9950-FORMAT-ERROR-MSG.                                           06610000
066200                                                                  06620000
066300     MOVE SQLCODE                     TO PV-SQLCODE               06630000
066400                                         PV-DISPLAY-SQLCODE.      06640000
066500                                                                  06650000
066600     MOVE DP276-PO-NBR                TO PV-DISP-PO-NBR           06660000
066700     IF DP276-PO-LNE-NBR = ZERO                                   06670000
066800         MOVE DK-LINE-NBR             TO PV-DISP-PO-LNE-NBR       06680000
066900     ELSE                                                         06690000
067000         MOVE DP276-PO-LNE-NBR        TO PV-DISP-PO-LNE-NBR       06700000
067100     END-IF                                                       06710000
067200     MOVE DP276-REC-SEQ-NBR           TO PV-DISP-REC-SEQ-NBR      06720000
067300     MOVE DP276-OPER-UNT-ID           TO PV-DISP-OPER-UNT-ID      06730000
067400     MOVE DP276-FCLTY-ID              TO PV-DISP-FCLTY-ID         06740000
067500     MOVE DP276-STR-NBR               TO PV-DISP-STR-NBR.         06750000
067600                                                                  06760000
067700     STRING '** TMKCS508 ** ERROR; '                              06770000
067800         PV-RETURN-MSG DELIMITED BY SIZE                          06780000
067900                                 INTO DP013-MESSAGE-TEXT (1)      06790000
068000                                                                  06800000
068100     STRING  ' DP276-RC = ' DP276-RETURN-CODE                     06810000
068200             '; SQLCODE = ' PV-DISPLAY-SQLCODE                    06820000
068300                                  DELIMITED BY SIZE               06830000
068400                                 INTO DP013-MESSAGE-TEXT (2)      06840000
068500                                                                  06850000
068600     MOVE '  PO    REC  LNE OPER FCLTY STR'                       06860000
068700                                   TO DP013-MESSAGE-TEXT (3)      06870000
068800                                                                  06880000
068900     STRING                                                       06890000
069000         PV-DISP-PO-NBR '-'                                       06900000
069100         PV-DISP-REC-SEQ-NBR '-'                                  06910000
069200         PV-DISP-PO-LNE-NBR '-'                                   06920000
069300         PV-DISP-OPER-UNT-ID '-'                                  06930000
069400         PV-DISP-FCLTY-ID '-'                                     06940000
069500         PV-DISP-STR-NBR                                          06950000
069600         DELIMITED BY SIZE INTO DP013-MESSAGE-TEXT (4).           06960000
069700/                                                                 06970000
069800*----------------------------------------------------------------*06980000
069900*    ABEND PROCESSOR MODULE                                      *06990000
070000*----------------------------------------------------------------*07000000
070100                                                                  07010000
070200     COPY DPPD013.                                                07020000
070300                                                                  07030000
070400******************************************************************07040000
070500 9999-RETURN-MSG.                                                 07050000
070600******************************************************************07060000
070700                                                                  07070000
070800     COMPUTE PV-OP-N = TM500-OPER-UNT-ID * 1.                     07080000
070900     COMPUTE PV-FCLTY-N = TM500-FCLTY-ID * 1.                     07090000
071000     COMPUTE PV-PO-N = TM500-PO-NBR      * 1.                     07100000
071100     COMPUTE PV-LINE-N = TM500-PO-LNE-NBR * 1.                    07110000
071200     COMPUTE PV-REC-SEQ-NBR-N = TM500-REC-SEQ-NBR * 1.            07120000
071300                                                                  07130000
071400     MOVE '508'                 TO PRV-PGM.                       07140000
071500     MOVE PV-OP                 TO PRV-OP.                        07150000
071600     MOVE PV-FCLTY              TO PRV-FCLTY.                     07160000
071700     MOVE PV-PO                 TO PRV-PO.                        07170000
071800     MOVE PV-LINE               TO PRV-LINE.                      07180000
071900     MOVE PV-REC-SEQ-NBR        TO PRV-REC-SEQ-NBR.               07190000
072000                                                                  07200000
072100     MOVE PRV-TM500-RETURN-MSG  TO TM500-RETURN-MSG.              07210000
