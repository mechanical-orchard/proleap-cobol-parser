000200***************************************************************** 00020001
000300 IDENTIFICATION DIVISION.                                         00030001
000400***************************************************************** 00040001
000500                                                                  00050001
000600 PROGRAM-ID.             SUKUT101.                                00060001
000700 AUTHOR.                 PATRICK BURKE.                           00070001
000800 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00080001
000900 DATE-WRITTEN            JANUARY 2005.                            00090001
001000 DATE-COMPILED.                                                   00100001
001100***************************************************************** 00110001
001300*  THIS PROGRAM WILL CREATE AN EXTRACT FILE CONTAINING OLD DATA * 00130001
001400*  CREATED MORE THAN X(PARM VALUE) NUMBER OF MONTHS OLD.        * 00140001
001900***************************************************************** 00190001
002000***************************************************************** 00200001
002100 ENVIRONMENT DIVISION.                                            00210001
002200***************************************************************** 00220001
002300                                                                  00230001
002400 CONFIGURATION SECTION.                                           00240001
002500                                                                  00250001
002600 SOURCE-COMPUTER.        IBM-3090.                                00260001
002700 OBJECT-COMPUTER.        IBM-3090.                                00270001
002800                                                                  00280001
002900 INPUT-OUTPUT SECTION.                                            00290001
003000                                                                  00300001
003100 FILE-CONTROL.                                                    00310001
003200*                                                                 00320001
003300     SELECT SU-CARTON-EXTRACT-FILE                                00330002
003400         ASSIGN TO OUT01.                                         00340001
003500*                                                                 00350001
003600***************************************************************** 00360001
003700 DATA DIVISION.                                                   00370001
003800***************************************************************** 00380001
003900*                                                                 00390001
004000 FILE SECTION.                                                    00400001
004100*                                                                 00410001
004200 FD  SU-CARTON-EXTRACT-FILE                                       00420002
004300     RECORDING MODE IS F                                          00430001
004400     BLOCK CONTAINS 0  RECORDS.                                   00440001
004500 01  SU-CARTON-EXTRACT-RECORD        PIC  X(50).                  00450007
004600*                                                                 00460001
004700                                                                  00470001
004800 WORKING-STORAGE SECTION.                                         00480001
004900*                                                                 00490001
005000 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00500001
005100                                                   COMP SYNC.     00510001
005200*                                                                 00520001
005300 01  PROGRAM-SWITCHES.                                            00530001
005400     05  PS-EOF-CTN-CURSOR-SW        PIC  X(01)    VALUE 'N'.     00540001
005500         88  PS-EOF-CTN-CSR                        VALUE 'Y'.     00550001
005600         88  PS-NOT-EOF-CTN-CSR                    VALUE 'N'.     00560001
005700                                                                  00570001
005800 01  PC-PROGRAM-CONSTANTS.                                        00580001
005900     05  PC-CURRENT-PROGRAM-NAME    PIC  X(08)     VALUE          00590001
006000                                                   'SUKUT101'.    00600001
006100                                                                  00610001
006200 01  PV-PROGRAM-VARIABLES.                                        00620001
006300     05  PV-DISPLAY-PURGE-WEEKS      PIC  Z(09).                  00630001
006400     05  PV-PURGE-TMST               PIC  X(26).                  00640001
006500     05  PV-PURGE-DATE               PIC  X(10).                  00650001
006600                                                                  00660001
006700     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00670001
006800     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00680001
006900     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00690001
007000                                                                  00700001
007100     05  PV-CTN-FETCH-CNT            PIC  9(09)    VALUE ZERO.    00710001
007200     05  PV-CTN-OUTPUT-CNT           PIC  9(09)    VALUE ZERO.    00720001
007300     05  PV-TOTAL-CNT                PIC  9(09)    VALUE ZERO.    00730001
007400                                                                  00740001
007500 01  DK-DB-KEYS.                                                  00750001
007600     05  DK-PURGE-WEEKS              PIC S9(09)  COMP.            00760001
007700                                                                  00770001
007800******************************************************************00780005
007810*  FILE LAYOUT FOR CARTON REQUEST EXTRACT.                        00781005
007820******************************************************************00782005
007900     COPY SURD053.                                                00790003
008100/                                                                 00810001
008200******************************************************************00820001
008300*  DB2 FORMATTED MESSAGE AREA                                     00830001
008400******************************************************************00840001
008500     COPY DPWS004.                                                00850001
008600                                                                  00860001
008700******************************************************************00870001
008800*  COPY BOOK FOR THE PARAMETER TABLE                              00880001
008900******************************************************************00890001
009000     EXEC SQL                                                     00900001
009100          INCLUDE TKRPRPM                                         00910001
009200     END-EXEC.                                                    00920001
009300                                                                  00930001
009400******************************************************************00940001
009500*  COPY BOOK FOR THE LABEL REQUEST TABLE                          00950001
009600******************************************************************00960001
009700     EXEC SQL                                                     00970001
009800          INCLUDE SUT00044                                        00980002
009900     END-EXEC.                                                    00990001
010000                                                                  01000001
010100******************************************************************01010001
010200*  DB2 COMMUNICATION AREA                                         01020001
010300******************************************************************01030001
010400     EXEC SQL                                                     01040001
010500         INCLUDE SQLCA                                            01050001
010600     END-EXEC.                                                    01060001
010700                                                                  01070001
010800******************************************************************01080001
010900*  DB2 COMMUNICATION AREA2                                        01090001
011000******************************************************************01100001
011100     COPY SQLCA2.                                                 01110001
011200                                                                  01120001
011300                                                                  01130001
011400******************************************************************01140001
011500     EXEC SQL                                                     01150001
011600       DECLARE CTN-CSR CURSOR FOR                                 01160001
011700         SELECT DC_NBR                                            01170001
011800               ,ACM_LBL_STA_NBR                                   01180001
011900               ,ACM_MSG_RCV_TMST                                  01190001
012000          FROM  SUT_CART_PRCD_MSG                                 01200001
012100          WHERE ACM_CART_RCV_DTE < (CURRENT DATE -                01210004
012200                                  (:DK-PURGE-WEEKS * 7) DAYS)     01220004
012300     END-EXEC.                                                    01230001
012400                                                                  01240001
012500*                                                                 01250001
012600 PROCEDURE DIVISION.                                              01260001
012700*                                                                 01270001
012800 0000-MAINLINE-PROCESSING.                                        01280001
012900******************************************************************01290001
013000**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      01300001
013100******************************************************************01310001
013200                                                                  01320001
013300     PERFORM 1000-INITIALIZATION.                                 01330001
013400                                                                  01340001
013500     PERFORM 2000-PROCESS-CTN                                     01350001
013600       UNTIL PS-EOF-CTN-CSR.                                      01360001
013700                                                                  01370001
013800     PERFORM 2300-CLOSE-CTN-CSR.                                  01380001
013900                                                                  01390001
014000     DISPLAY 'CTN FETCHED=' PV-CTN-FETCH-CNT   '  **'.            01400001
014100     DISPLAY '                                 '.                 01410001
014200     DISPLAY 'TOTAL OUT  =' PV-TOTAL-CNT       '  **'             01420001
014300                                                                  01430001
014400     CLOSE SU-CARTON-EXTRACT-FILE.                                01440002
014500                                                                  01450001
014600     GOBACK.                                                      01460001
014700                                                                  01470001
014800 1000-INITIALIZATION.                                             01480001
014900******************************************************************01490001
015000**  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               01500001
015100******************************************************************01510001
015200                                                                  01520001
015300     OPEN OUTPUT SU-CARTON-EXTRACT-FILE.                          01530002
015400                                                                  01540001
015500     PERFORM 7000-GET-PURGE-WEEKS.                                01550001
015600                                                                  01560001
015700     DISPLAY '** SUKUT101 **'.                                    01570002
015800     DISPLAY '** PURGE ' PV-DISPLAY-PURGE-WEEKS ' WEEKS **'.      01580001
015900     DISPLAY '** DATE  ' PV-PURGE-DATE.                           01590001
016000                                                                  01600001
016100     SET  PS-NOT-EOF-CTN-CSR  TO  TRUE.                           01610001
016200                                                                  01620001
016300     PERFORM 2100-OPEN-CTN-CSR.                                   01630001
016400     PERFORM 2200-FETCH-CTN-CSR.                                  01640001
016500                                                                  01650001
016600*                                                                 01660001
016700 2000-PROCESS-CTN.                                                01670001
016800                                                                  01680001
016900     INITIALIZE  SU053-EXTRACT-RECORD.                            01690002
017000                                                                  01700001
017100     MOVE SUT00044-DC-NBR           TO  SU053-DC-NBR.             01710002
017200     MOVE SUT00044-ACM-LBL-STA-NBR  TO  SU053-ACM-LBL-STA-NBR.    01720003
017300     MOVE SUT00044-ACM-MSG-RCV-TMST TO  SU053-ACM-MSG-RCV-TMST.   01730002
017400                                                                  01740001
017500                                                                  01750001
017600     IF  PS-EOF-CTN-CSR                                           01760001
017700         ADD  1  TO  PV-CTN-OUTPUT-CNT                            01770001
017800         PERFORM 2300-CLOSE-CTN-CSR                               01780001
017900         PERFORM 8000-WRITE-EXTRACT-RECORD                        01790001
018000     ELSE                                                         01800001
018100         PERFORM 8000-WRITE-EXTRACT-RECORD                        01810001
018200         PERFORM 2200-FETCH-CTN-CSR                               01820001
018300     END-IF.                                                      01830001
018400                                                                  01840001
018500 2100-OPEN-CTN-CSR.                                               01850001
018600     MOVE '2100-OPEN-CTN-CSR'    TO PV-ABEND-PARAGRAPH.           01860001
018700                                                                  01870001
018800     EXEC SQL                                                     01880001
018900          OPEN CTN-CSR                                            01890001
019000     END-EXEC.                                                    01900001
019100                                                                  01910001
019200     EVALUATE TRUE                                                01920001
019300         WHEN SQLCODE = 0                                         01930001
019400             CONTINUE                                             01940001
019500         WHEN SQLWARN0 NOT = SPACES                               01950001
019600         WHEN SQLCODE < ZERO                                      01960001
019700         WHEN SQLCODE > ZERO                                      01970001
019800             MOVE '2100-OPEN-CTN-CSR'                             01980001
019900                             TO PV-PARAGRAPH-NAME                 01990001
020000             MOVE 'OPEN THE CTN_CURSOR            '               02000001
020100                             TO PV-DB2-OPERATION-ATTEMPTED        02010001
020200             PERFORM 9100-SQL-ABEND                               02020001
020300     END-EVALUATE.                                                02030001
020400                                                                  02040001
020500                                                                  02050001
020600 2200-FETCH-CTN-CSR.                                              02060001
020700     MOVE '2200-FETCH-CTN-CSR'   TO PV-ABEND-PARAGRAPH.           02070001
020800                                                                  02080001
020900     EXEC SQL                                                     02090001
021000          FETCH CTN-CSR                                           02100001
021100          INTO  :SUT00044-DC-NBR                                  02110002
021200              , :SUT00044-ACM-LBL-STA-NBR                         02120002
021300              , :SUT00044-ACM-MSG-RCV-TMST                        02130002
021400     END-EXEC.                                                    02140001
021500                                                                  02150001
021600     EVALUATE TRUE                                                02160001
021700       WHEN SQLCODE = ZEROS                                       02170001
021800            ADD  1  TO  PV-CTN-FETCH-CNT                          02180001
021900       WHEN SQLCODE = +100                                        02190001
022000            SET PS-EOF-CTN-CSR  TO TRUE                           02200001
022100       WHEN SQLWARN0 NOT = SPACES                                 02210001
022200       WHEN SQLCODE < ZERO                                        02220001
022300       WHEN SQLCODE > ZERO                                        02230001
022400           MOVE '2200-FETCH-CTN-CSR'                              02240001
022500                               TO PV-PARAGRAPH-NAME               02250001
022600           MOVE 'FETCH CTN CURSOR '                               02260001
022700                               TO PV-DB2-OPERATION-ATTEMPTED      02270001
022800           PERFORM 9100-SQL-ABEND                                 02280001
022900     END-EVALUATE.                                                02290001
023000                                                                  02300001
023100                                                                  02310001
023200 2300-CLOSE-CTN-CSR.                                              02320001
023300     MOVE '2300-CLOSE-CTN-CSR'   TO PV-ABEND-PARAGRAPH.           02330001
023400                                                                  02340001
023500     EXEC SQL                                                     02350001
023600         CLOSE CTN-CSR                                            02360001
023700     END-EXEC.                                                    02370001
023800                                                                  02380001
023900     EVALUATE TRUE                                                02390001
024000         WHEN SQLCODE = ZERO                                      02400001
024100         WHEN SQLCODE = -904                                      02410001
024200         WHEN SQLCODE = -911                                      02420001
024300              CONTINUE                                            02430001
024400         WHEN SQLWARN0 NOT = SPACES                               02440001
024500         WHEN SQLCODE < ZERO                                      02450001
024600         WHEN SQLCODE > ZERO                                      02460001
024700              MOVE '2300-CLOSE-CTN-CSR'                           02470001
024800                              TO PV-PARAGRAPH-NAME                02480001
024900              MOVE 'CLOSE THE CTN-CSR              '              02490001
025000                              TO PV-DB2-OPERATION-ATTEMPTED       02500001
025100              PERFORM 9100-SQL-ABEND                              02510001
025200     END-EVALUATE.                                                02520001
025300                                                                  02530001
025400                                                                  02540001
025500                                                                  02550001
025600 7000-GET-PURGE-WEEKS.                                            02560001
025700                                                                  02570001
025800     EXEC SQL                                                     02580001
025900         SELECT  FUNC_QTY                                         02590001
026000           INTO :DK-PURGE-WEEKS                                   02600001
026100           FROM TKRPRPM                                           02610001
026200          WHERE LOC_ID            =  90                           02620001
026300            AND INTFC_SYS_CDE     = 'KHL'                         02630001
026400            AND SYS_PRC_FUNC_CDE  = 'PAPURG'                      02640001
026500            AND FUNC_PRC_STAT_CDE = 'AC'                          02650001
026600     END-EXEC.                                                    02660001
026700                                                                  02670001
026800     EVALUATE TRUE                                                02680001
026900         WHEN SQLCODE = ZEROS                                     02690001
027000              MOVE  DK-PURGE-WEEKS  TO  PV-DISPLAY-PURGE-WEEKS    02700001
027100              PERFORM 7100-GET-PURGE-DATE                         02710001
027200         WHEN SQLCODE = +100                                      02720001
027300              CONTINUE                                            02730001
027400         WHEN SQLWARN0 NOT = SPACES                               02740001
027500         WHEN SQLCODE < ZERO                                      02750001
027600         WHEN SQLCODE > ZERO                                      02760001
027700             MOVE '7000-GET-PURGE-WEEKS'                          02770001
027800                             TO PV-PARAGRAPH-NAME                 02780001
027900             MOVE 'GET NUMBER OF WEEKS TO PURGE   '               02790001
028000                             TO PV-DB2-OPERATION-ATTEMPTED        02800001
028100             PERFORM 9100-SQL-ABEND                               02810001
028200     END-EVALUATE.                                                02820001
028300                                                                  02830001
028400                                                                  02840001
028500 7100-GET-PURGE-DATE.                                             02850001
028600                                                                  02860001
028700     EXEC SQL                                                     02870001
028800         SELECT  (CURRENT_DATE -                                  02880001
028900                  (:DK-PURGE-WEEKS * 7) DAYS)                     02890001
029000           INTO :PV-PURGE-DATE                                    02900001
029100           FROM TKRPRPM                                           02910001
029200          WHERE LOC_ID            =  90                           02920001
029300            AND INTFC_SYS_CDE     = 'KHL'                         02930001
029400            AND SYS_PRC_FUNC_CDE  = 'PAPURG'                      02940001
029500            AND FUNC_PRC_STAT_CDE = 'AC'                          02950001
029600     END-EXEC.                                                    02960001
029700                                                                  02970001
029800     EVALUATE TRUE                                                02980001
029900         WHEN SQLCODE = ZEROS                                     02990001
030000         WHEN SQLCODE = +100                                      03000001
030100              CONTINUE                                            03010001
030200         WHEN SQLWARN0 NOT = SPACES                               03020001
030300         WHEN SQLCODE < ZERO                                      03030001
030400         WHEN SQLCODE > ZERO                                      03040001
030500             MOVE '7100-GET-PURGE-DATE '                          03050001
030600                             TO PV-PARAGRAPH-NAME                 03060001
030700             MOVE 'CALCULATE PURGE DATE           '               03070001
030800                             TO PV-DB2-OPERATION-ATTEMPTED        03080001
030900             PERFORM 9100-SQL-ABEND                               03090001
031000     END-EVALUATE.                                                03100001
031100                                                                  03110001
031200                                                                  03120001
031300 8000-WRITE-EXTRACT-RECORD.                                       03130001
031400     WRITE SU-CARTON-EXTRACT-RECORD                               03140002
031500       FROM SU053-EXTRACT-RECORD.                                 03150002
031600                                                                  03160001
031700     ADD  1  TO  PV-TOTAL-CNT.                                    03170001
031800                                                                  03180001
031900 9100-SQL-ABEND.                                                  03190001
032000******************************************************************03200001
032100*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03210001
032200*  ERROR OR WARNING CODE OCCURS.                                  03220001
032300******************************************************************03230001
032400     DISPLAY '9100-SQL-ABEND'.                                    03240001
032500     DISPLAY '** ABEND     **'.                                   03250001
032600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03260001
032700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03270001
032800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03280001
032900                                                                  03290001
033000******************************************************************03300001
033100* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03310001
033200* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03320001
033300* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03330001
033400* FORMAT.                                                         03340001
033500******************************************************************03350001
033600     COPY DPPD004.                                                03360001
033700                                                                  03370001
033800     MOVE +4013                  TO ABEND-CODE.                   03380001
033900     CALL 'ILBOABN0' USING ABEND-CODE.                            03390001
034000                                                                  03400001
