000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SEKUT015.                                00050000
000600 AUTHOR.                 RICK TULLOCH.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           05-09-06.                                00080013
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*        THIS PROGRAM RETRIEVES ORGANIZATION HIERARCHY           *00120013
001201*  INFORMATION FROM THE XS DOMAIN AND COMPARES AGAINST AN        *00120113
001202*  EXTRACT CREATED FROM THE PREVIOUS CYCLE TO IDENTIFY CHANGES   *00120213
001203*  THAT MUST BE COMMUNICATED, AND PREPARE THE EXTRACT FILE FOR   *00120313
001204*  THE CURRENT CYCLE.  ALL LOCATION ADDS/CHANGES/DELETES, AND    *00120413
001205*  REALIGNMENTS DETECTED WILL LEAD TO THE CREATION OF E-MAIL     *00120513
001206*  COMMUNICATION DETAIL LINES.                                   *00120613
001207*                                                                *00120713
001210*        A CUSTOM RETURN CODE MAY BE SET AT THE END OF THIS      *00121004
001220*  PROCESS TO ALLOW A MORE SPECIFIC SUBJECT LINE TO BE PREPARED  *00122004
001230*  FOR E-MAIL COMMUNICATIONS.                                    *00123004
001240*                                                                *00124004
001250*        4050 - AN ORGANIZATION HIERARCHY REALIGNMENT OR         *00125004
001260*               INITIAL ASSIGNMENT FOR A PREVIOUSLY DEFINED      *00126004
001270*               STORE HAS BEEN DETECTED.                         *00127004
001300******************************************************************00130000
001400                                                                  00140000
001500******************************************************************00150000
001600 ENVIRONMENT DIVISION.                                            00160000
001700******************************************************************00170000
001800                                                                  00180000
001900 CONFIGURATION SECTION.                                           00190000
002000                                                                  00200000
002100 SOURCE-COMPUTER.        IBM-3090.                                00210000
002200 OBJECT-COMPUTER.        IBM-3090.                                00220000
002300                                                                  00230000
002400 INPUT-OUTPUT SECTION.                                            00240000
002500                                                                  00250000
002600 FILE-CONTROL.                                                    00260000
002700                                                                  00270000
002800     SELECT PREV-CYCLE-EXTRACT-FILE                               00280000
002900         ASSIGN TO INP01.                                         00290000
003000                                                                  00300000
003100     SELECT CURR-CYCLE-EXTRACT-FILE                               00310000
003200         ASSIGN TO OUT01.                                         00320000
003300                                                                  00330000
003400     SELECT REALIGNMENT-EMAIL-FILE                                00340000
003500         ASSIGN TO OUT02.                                         00350010
003510                                                                  00351014
003520     SELECT CSV-ORG-HIER-EXTRACT-FILE                             00352014
003530         ASSIGN TO OUT03.                                         00353014
003600                                                                  00360000
003700******************************************************************00370000
003800 DATA DIVISION.                                                   00380000
003900******************************************************************00390000
004000                                                                  00400000
004100 FILE SECTION.                                                    00410000
004200                                                                  00420000
004300 FD  PREV-CYCLE-EXTRACT-FILE                                      00430000
004400     RECORDING MODE IS F                                          00440000
004500     LABEL RECORDS ARE STANDARD                                   00450000
004600     BLOCK CONTAINS 0 RECORDS                                     00460000
004700     RECORD CONTAINS 40 CHARACTERS                                00470000
004800     DATA RECORDS IS PC-PREV-CYCLE-EXTRACT-RECORD.                00480000
004900                                                                  00490000
005000 01  PC-PREV-CYCLE-EXTRACT-RECORD                                 00500000
005100                                 PIC X(40).                       00510000
005200                                                                  00520000
005300 FD  CURR-CYCLE-EXTRACT-FILE                                      00530000
005400     RECORDING MODE IS F                                          00540000
005500     LABEL RECORDS ARE STANDARD                                   00550000
005600     BLOCK CONTAINS 0 RECORDS                                     00560000
005700     RECORD CONTAINS 40 CHARACTERS                                00570000
005800     DATA RECORDS IS CC-CURR-CYCLE-EXTRACT-RECORD.                00580000
005900                                                                  00590000
006000 01  CC-CURR-CYCLE-EXTRACT-RECORD                                 00600000
006100                                 PIC X(40).                       00610000
006200                                                                  00620000
006300 FD  REALIGNMENT-EMAIL-FILE                                       00630000
006400     RECORDING MODE IS F                                          00640000
006500     LABEL RECORDS ARE STANDARD                                   00650000
006600     BLOCK CONTAINS 0 RECORDS                                     00660000
006700     RECORD CONTAINS 80 CHARACTERS                                00670000
006800     DATA RECORDS IS RE-REALIGNMENT-EMAIL-RECORD.                 00680000
006900                                                                  00690000
007000 01  RE-REALIGNMENT-EMAIL-RECORD PIC X(80).                       00700000
007010                                                                  00701014
007020 FD  CSV-ORG-HIER-EXTRACT-FILE                                    00702014
007030     RECORDING MODE IS F                                          00703014
007040     LABEL RECORDS ARE STANDARD                                   00704014
007050     BLOCK CONTAINS 0 RECORDS                                     00705014
007060     RECORD CONTAINS 27 CHARACTERS                                00706017
007070     DATA RECORDS IS CO-CSV-ORG-HIER-EXTRACT-RECORD.              00707014
007080                                                                  00708014
007090 01  CO-CSV-ORG-HIER-EXTRACT-RECORD                               00709014
007091                                 PIC X(27).                       00709117
007100                                                                  00710000
007200 WORKING-STORAGE SECTION.                                         00720000
007300                                                                  00730000
007400*                                                                 00740000
007500*  ORGANIZATION HIERARCHY EXTRACT RECORD LAYOUT FOR USE WITH      00750000
007600*  THE PREVIOUS CYCLE VERSION OF THE FILE.                        00760000
007700*                                                                 00770000
007800                                                                  00780000
007900     COPY SERD006 REPLACING SE006- BY SEP06-.                     00790000
008000                                                                  00800000
008100*                                                                 00810000
008200*  ORGANIZATION HIERARCHY EXTRACT RECORD LAYOUT FOR USE WITH      00820000
008300*  THE CURRENT CYCLE VERSION OF THE FILE.                         00830000
008400*                                                                 00840000
008500                                                                  00850000
008600     COPY SERD006.                                                00860000
008610                                                                  00861005
008620*                                                                 00862005
008630*  PARAMETER LIST FOR CALLING THE "GET CURRENT JOB INFORMATION"   00863005
008640*  ROUTINE.                                                       00864005
008650*                                                                 00865005
008660                                                                  00866005
008670     COPY DPWS085.                                                00867005
008700                                                                  00870001
008800*                                                                 00880001
008900*  VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004        00890001
009000*                                                                 00900001
009100                                                                  00910001
009200     COPY DPWS004.                                                00920001
009300                                                                  00930001
009400 01  ABEND-CODE                  PIC S9(04)   VALUE ZERO          00940001
009500                                              COMP SYNC.          00950001
009600     88  AC-DB2-ERROR-4013                    VALUE +4013.        00960001
009700                                                                  00970000
009800 01  PS-PROGRAM-SWITCHES.                                         00980000
009900     05  PS-END-OF-PREV-CYCLE-FILE-SW                             00990000
010000                                 PIC X(1)     VALUE 'N'.          01000000
010100         88  PS-END-OF-PREV-CYCLE-FILE        VALUE 'Y'.          01010000
010200     05  PS-END-OF-CURR-CYCLE-CSR-SW                              01020000
010300                                 PIC X(1)     VALUE 'N'.          01030000
010400         88  PS-END-OF-CURR-CYCLE-CSR         VALUE 'Y'.          01040000
010410     05  PS-HAVE-EMAIL-LINES-SW  PIC X(1)     VALUE 'N'.          01041005
010430         88  PS-HAVE-EMAIL-LINES              VALUE 'Y'.          01043005
010500                                                                  01050000
010600 01  PV-PROGRAM-VARIABLES.                                        01060000
010700     05  PV-PREV-CYCLE-LOC-NBR   PIC 9(5)     VALUE ZEROS.        01070000
010800         88  PV-PREV-CYCLE-EOF-LOC-NBR        VALUE 99999.        01080000
010900     05  PV-CURR-CYCLE-LOC-NBR   PIC 9(5)     VALUE ZEROS.        01090000
011000         88  PV-CURR-CYCLE-EOF-LOC-NBR        VALUE 99999.        01100000
011010     05  PV-RETURN-CODE          PIC S9(4)    VALUE ZEROS         01101004
011021                                              COMP SYNC.          01102104
011022         88  PV-ORG-HIER-REALIGN-RET-CODE     VALUE +4050.        01102204
011100     05  PV-RETRY-COUNT          PIC S9(4)    VALUE ZEROS         01110001
011200                                              COMP SYNC.          01120001
011300     05  PV-LAST-DB2-ACTION      PIC X(50)    VALUE SPACES.       01130001
011400         88  PV-OPEN-ORG-HIER-CURSOR          VALUE               01140001
011500             'OPEN THE ORGANIZATION HIERARCHY CURSOR          '.  01150001
011600         88  PV-FETCH-ORG-HIER-ROW            VALUE               01160001
011700             'FETCH A ROW FROM THE ORG HIERARCHY CURSOR       '.  01170001
011800         88  PV-CLOSE-ORG-HIER-CURSOR         VALUE               01180001
011900             'CLOSE THE ORGANIZATION HIERARCHY CURSOR         '.  01190001
012000                                                                  01200000
012100 01  PC-PROGRAM-CONSTANTS.                                        01210000
012200     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'SEKUT015'.   01220000
012210     05  PC-TEST-JOB-NAME-PREFIX PIC X(2)     VALUE 'TK'.         01221005
012300     05  PC-MAXIMUM-RETRY-COUNT  PIC S9(4)    VALUE +2            01230001
012400                                              COMP SYNC.          01240001
012500     05  PC-NULL-INDICATOR       PIC S9(4)    VALUE -1            01250001
012600                                              COMP SYNC.          01260001
012700     05  PC-DEPARTMENT-STORE-TYPE                                 01270001
012800                                 PIC X(2)     VALUE 'DS'.         01280001
012900     05  PC-SUCCESSFUL-SQLCODE   PIC S9(9)    VALUE ZEROS         01290001
013000                                              COMP SYNC.          01300001
013100     05  PC-END-OF-CURSOR-SQLCODE                                 01310001
013200                                 PIC S9(9)    VALUE +100          01320001
013300                                              COMP SYNC.          01330001
013400     05  PC-RESOURCE-NOT-AVAIL-SQLCODE                            01340001
013500                                 PIC S9(9)    VALUE -904          01350001
013600                                              COMP SYNC.          01360001
013700     05  PC-DEADLOCK-W-ROLLBCK-SQLCODE                            01370001
013800                                 PIC S9(9)    VALUE -911          01380001
013900                                              COMP SYNC.          01390001
014000     05  PC-DEADLOCK-WO-ROLLBCK-SQLCODE                           01400001
014100                                 PIC S9(9)    VALUE -913          01410001
014200                                              COMP SYNC.          01420001
014300                                                                  01430000
014400 01  PT-PROGRAM-TOTALS.                                           01440000
014500     05  PT-PREV-CYCLE-RCDS-READ PIC S9(7)    VALUE ZEROS         01450000
014600                                              COMP-3.             01460000
014700     05  PT-CURR-CYCLE-ROWS-READ PIC S9(7)    VALUE ZEROS         01470000
014800                                              COMP-3.             01480000
014900     05  PT-CURR-CYCLE-RCDS-WRITTEN                               01490000
015000                                 PIC S9(7)    VALUE ZEROS         01500000
015100                                              COMP-3.             01510000
015110     05  PT-REALIGN-EMAIL-LNS-WRITTEN                             01511006
015120                                 PIC S9(7)    VALUE ZEROS         01512005
015130                                              COMP-3.             01513005
015140     05  PT-CSV-ORG-HIER-RCDS-WRITTEN                             01514014
015150                                 PIC S9(7)    VALUE ZEROS         01515014
015160                                              COMP-3.             01516014
015200                                                                  01520000
015300 01  TD-TOTAL-DISPLAY-MESSAGE.                                    01530000
015400     05  TD-TOTAL-ID             PIC X(51)    VALUE SPACES.       01540000
015500         88  TD-PREV-CYCLE-RCDS-READ-ID       VALUE               01550000
015600             'PREVIOUS CYCLE ORG HIER EXTRACT RECORDS READ . . .'.01560000
015700         88  TD-CURR-CYCLE-ROWS-READ-ID       VALUE               01570000
015800             'CURRENT CYCLE ORG HIER CURSOR ROWS READ  . . . . .'.01580000
015900         88  TD-CURR-CYCLE-RCDS-WRITTEN-ID    VALUE               01590000
016000             'CURRENT CYCLE ORG HIER EXTRACT RECORDS WRITTEN . .'.01600000
016010         88  TD-REALIGN-EMAIL-LNS-WRITTN-ID   VALUE               01601005
016020             'ORG HIER REALIGNMENT E-MAIL NOTICE LINES WRITTEN .'.01602005
016030         88  TD-CSV-ORG-HIER-RCDS-WRITTN-ID   VALUE               01603015
016040             'ORG HIER CSV EXTRACT RECORDS WRITTEN . . . . . . .'.01604014
016100     05  TD-TOTAL-AMOUNT         PIC Z,ZZZ,ZZ9                    01610000
016200                                              VALUE ZEROS.        01620000
016201                                                                  01620105
016210 01  EN-EMAIL-NOTICE-LINES.                                       01621005
016220     05  EN-TEST-SUBMISSION-NOTE PIC X(80)    VALUE               01622005
016230         '  ***** THIS WAS NOT GENERATED FROM PRODUCTION *****'.  01623005
016240     05  EN-TITLE                PIC X(80)    VALUE               01624005
016250         'ORGANIZATION HIERARCHY CHANGES NOTIFICATION'.           01625005
016251     05  EN-IDENTITY-MANAGEMENT-NOTE.                             01625108
016252         10  FILLER              PIC X(40)    VALUE               01625208
016253             'THE FOLLOWING CHANGES ARE BEING SENT TO '.          01625308
016254         10  FILLER              PIC X(40)    VALUE               01625408
016255             'IDENTITY MANAGEMENT:'.                              01625508
016260     05  EN-STORE-REALIGNED-LINE.                                 01626005
016270         10  FILLER              PIC X(8)     VALUE '  STORE '.   01627008
016280         10  EN-SR-LOC-NBR       PIC ZZZZ9    VALUE ZEROS.        01628005
016290         10  FILLER              PIC X(33)    VALUE               01629005
016291             ' REALIGNED FROM DIST/REGION/TERR '.                 01629105
016292         10  EN-SR-PREV-DIST-NBR PIC X(4)     VALUE SPACES.       01629212
016293         10  EN-SR-PREV-DIST-NBR-N                                01629312
016294                                 REDEFINES EN-SR-PREV-DIST-NBR    01629412
016295                                 PIC ZZZ9.                        01629512
016296         10  FILLER              PIC X(1)     VALUE '/'.          01629612
016297         10  EN-SR-PREV-REGN-NBR PIC X(4)     VALUE SPACES.       01629712
016298         10  EN-SR-PREV-REGN-NBR-N                                01629812
016299                                 REDEFINES EN-SR-PREV-REGN-NBR    01629912
016300                                 PIC ZZZ9.                        01630012
016301         10  FILLER              PIC X(1)     VALUE '/'.          01630112
016302         10  EN-SR-PREV-TERR-NBR PIC X(4)     VALUE SPACES.       01630212
016303         10  EN-SR-PREV-TERR-NBR-N                                01630312
016304                                 REDEFINES EN-SR-PREV-TERR-NBR    01630412
016305                                 PIC ZZZ9.                        01630512
016306         10  FILLER              PIC X(4)     VALUE ' TO '.       01630612
016307         10  EN-SR-CURR-DIST-NBR PIC X(4)     VALUE SPACES.       01630712
016308         10  EN-SR-CURR-DIST-NBR-N                                01630812
016309                                 REDEFINES EN-SR-CURR-DIST-NBR    01630912
016310                                 PIC ZZZ9.                        01631012
016311         10  FILLER              PIC X(1)     VALUE '/'.          01631112
016312         10  EN-SR-CURR-REGN-NBR PIC X(4)     VALUE SPACES.       01631212
016313         10  EN-SR-CURR-REGN-NBR-N                                01631312
016314                                 REDEFINES EN-SR-CURR-REGN-NBR    01631412
016315                                 PIC ZZZ9.                        01631512
016316         10  FILLER              PIC X(1)     VALUE '/'.          01631612
016317         10  EN-SR-CURR-TERR-NBR PIC X(4)     VALUE SPACES.       01631712
016318         10  EN-SR-CURR-TERR-NBR-N                                01631812
016319                                 REDEFINES EN-SR-CURR-TERR-NBR    01631912
016320                                 PIC ZZZ9.                        01632012
016326         10  FILLER              PIC X(2)     VALUE '.'.          01632612
016327     05  EN-STORE-ADDED-LINE.                                     01632712
016328         10  FILLER              PIC X(12)    VALUE               01632812
016329             '  NEW STORE '.                                      01632912
016330         10  EN-SA-LOC-NBR       PIC ZZZZ9    VALUE ZEROS.        01633012
016331         10  FILLER              PIC X(63)    VALUE               01633112
016332             ' ADDED TO IDENTITY MANAGEMENT.'.                    01633212
016333     05  EN-STORE-DELETED-LINE.                                   01633312
016334         10  FILLER              PIC X(8)     VALUE '  STORE '.   01633412
016335         10  EN-SD-LOC-NBR       PIC ZZZZ9    VALUE ZEROS.        01633512
016336         10  FILLER              PIC X(34)    VALUE               01633611
016337             ' REMOVED FROM IDENTITY MANAGEMENT '.                01633711
016338         10  FILLER              PIC X(17)    VALUE               01633811
016339             '(DIST/REGION/TERR'.                                 01633911
016341         10  EN-SD-DIST-NBR      PIC X(4)     VALUE SPACES.       01634112
016342         10  EN-SD-DIST-NBR-N    REDEFINES EN-SD-DIST-NBR         01634212
016344                                 PIC ZZZ9.                        01634412
016345         10  FILLER              PIC X(1)     VALUE '/'.          01634511
016346         10  EN-SD-REGN-NBR      PIC X(4)     VALUE SPACES.       01634612
016347         10  EN-SD-REGN-NBR-N    REDEFINES EN-SD-REGN-NBR         01634712
016348                                 PIC ZZZ9.                        01634812
016349         10  FILLER              PIC X(1)     VALUE '/'.          01634911
016350         10  EN-SD-TERR-NBR      PIC X(4)     VALUE SPACES.       01635012
016351         10  EN-SD-TERR-NBR-N    REDEFINES EN-SD-TERR-NBR         01635112
016352                                 PIC ZZZ9.                        01635212
016353         10  FILLER              PIC X(2)     VALUE ').'.         01635311
016360                                                                  01636005
016370 01  OH-ORG-HIER-CSV-RECORD.                                      01637014
016371     05  FILLER                  PIC X(1)     VALUE SPACES.       01637116
016372         88  OH-CSV-QUOTE-1                   VALUE '"'.          01637216
016373     05  OH-LOC-NBR              PIC X(4)     VALUE SPACES.       01637316
016374         88  OH-LOC-NBR-ID                    VALUE 'LOC#'.       01637416
016375     05  FILLER                  PIC X(1)     VALUE SPACES.       01637516
016376         88  OH-CSV-QUOTE-2                   VALUE '"'.          01637616
016377     05  FILLER                  PIC X(1)     VALUE SPACES.       01637714
016378         88  OH-CSV-COMMA-1                   VALUE ','.          01637815
016379     05  FILLER                  PIC X(1)     VALUE SPACES.       01637916
016380         88  OH-CSV-QUOTE-3                   VALUE '"'.          01638016
016381     05  OH-DIST-NBR             PIC X(4)     VALUE SPACES.       01638114
016382         88  OH-DIST-NBR-ID                   VALUE 'DIST'.       01638214
016383     05  FILLER                  PIC X(1)     VALUE SPACES.       01638316
016384         88  OH-CSV-QUOTE-4                   VALUE '"'.          01638416
016385     05  FILLER                  PIC X(1)     VALUE SPACES.       01638514
016386         88  OH-CSV-COMMA-2                   VALUE ','.          01638615
016387     05  FILLER                  PIC X(1)     VALUE SPACES.       01638716
016388         88  OH-CSV-QUOTE-5                   VALUE '"'.          01638816
016389     05  OH-REGN-NBR             PIC X(4)     VALUE SPACES.       01638914
016390         88  OH-REGN-NBR-ID                   VALUE 'REGN'.       01639014
016391     05  FILLER                  PIC X(1)     VALUE SPACES.       01639116
016392         88  OH-CSV-QUOTE-6                   VALUE '"'.          01639216
016393     05  FILLER                  PIC X(1)     VALUE SPACES.       01639314
016394         88  OH-CSV-COMMA-3                   VALUE ','.          01639415
016395     05  FILLER                  PIC X(1)     VALUE SPACES.       01639516
016396         88  OH-CSV-QUOTE-7                   VALUE '"'.          01639616
016397     05  OH-TERR-NBR             PIC X(4)     VALUE SPACES.       01639714
016398         88  OH-TERR-NBR-ID                   VALUE 'TERR'.       01639814
016399     05  FILLER                  PIC X(1)     VALUE SPACES.       01639916
016400         88  OH-CSV-QUOTE-8                   VALUE '"'.          01640016
016401                                                                  01640114
016410*                                                                 01641001
016500*  SQL AND COBOL DECLARATIONS FOR THE XS DOMAIN LOCATION TABLE    01650001
016600*  (XST_LOC).                                                     01660001
016700*                                                                 01670001
016800                                                                  01680001
016900     EXEC SQL                                                     01690001
017000         INCLUDE XST00001                                         01700001
017100     END-EXEC.                                                    01710001
017200                                                                  01720001
017300*                                                                 01730001
017400*  SQL AND COBOL DECLARATIONS FOR THE XS DOMAIN LOCATION-DISTRICT 01740001
017500*  ASSOCIATION TABLE (XST_LOC_DIST).                              01750001
017600*                                                                 01760001
017700                                                                  01770001
017800     EXEC SQL                                                     01780001
017900         INCLUDE XST00002                                         01790001
018000     END-EXEC.                                                    01800001
018100                                                                  01810001
018200*                                                                 01820001
018300*  SQL AND COBOL DECLARATIONS FOR THE XS DOMAIN DISTRICT-REGION   01830001
018400*  ASSOCIATION TABLE (XST_DIST_REGN).                             01840001
018500*                                                                 01850001
018600                                                                  01860001
018700     EXEC SQL                                                     01870001
018800         INCLUDE XST00004                                         01880001
018900     END-EXEC.                                                    01890001
019000                                                                  01900001
019100*                                                                 01910001
019200*  SQL AND COBOL DECLARATIONS FOR THE XS DOMAIN REGION-TERRITORY  01920001
019300*  ASSOCIATION TABLE (XST_REGN_TERR).                             01930001
019400*                                                                 01940001
019500                                                                  01950001
019600     EXEC SQL                                                     01960001
019700         INCLUDE XST00006                                         01970001
019800     END-EXEC.                                                    01980001
019900                                                                  01990001
020000*                                                                 02000001
020100*  STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                02010001
020200*                                                                 02020001
020300                                                                  02030001
020400     EXEC SQL                                                     02040001
020500         INCLUDE SQLCA                                            02050001
020600     END-EXEC.                                                    02060001
020700                                                                  02070001
020800*                                                                 02080001
020900*  CURSOR USED TO RETRIEVE ALL DEFINED DEPARTMENT STORES NOT      02090001
021000*  FINANCIALLY CLOSED AND THEIR CURRENT ORGANIZATION HIERARCHY    02100001
021100*  RELATIONSHIPS.                                                 02110001
021200*                                                                 02120001
021300                                                                  02130001
021400     EXEC SQL                                                     02140001
021500         DECLARE ORG_HIER_CURSOR CURSOR FOR                       02150001
021600             SELECT L.LOC_NBR,                                    02160001
021700                    COALESCE (OH.DIST_NBR, 0),                    02170001
021800                    COALESCE (OH.REGN_NBR, 0),                    02180001
021900                    COALESCE (OH.TERR_NBR, 0)                     02190001
022000                 FROM XST_LOC L LEFT JOIN                         02200009
022100                     (SELECT LD.LOC_NBR,                          02210001
022200                             LD.DIST_NBR,                         02220001
022300                             DR.REGN_NBR,                         02230001
022400                             RT.TERR_NBR                          02240001
022500                          FROM XST_LOC_DIST LD,                   02250009
022600                               XST_DIST_REGN DR,                  02260009
022700                               XST_REGN_TERR RT                   02270009
022800                          WHERE ((LD.END_DTE IS NULL) AND         02280001
022900                                (LD.DIST_NBR = DR.DIST_NBR) AND   02290001
023000                                (DR.END_DTE IS NULL) AND          02300001
023100                                (DR.REGN_NBR = RT.REGN_NBR) AND   02310001
023200                                (RT.END_DTE IS NULL))) AS OH      02320001
023300                 ON L.LOC_NBR = OH.LOC_NBR                        02330001
023400                 WHERE ((L.LOC_TYP_CDE =                          02340001
023500                                  :PC-DEPARTMENT-STORE-TYPE)  AND 02350001
023600                       (L.FINCL_CLO_DTE IS NULL))                 02360001
023700                 ORDER BY L.LOC_NBR                               02370001
023800     END-EXEC.                                                    02380001
023900                                                                  02390000
024000******************************************************************02400000
024100 PROCEDURE DIVISION.                                              02410000
024200******************************************************************02420000
024300                                                                  02430000
024400 0000-MAINLINE.                                                   02440000
024500                                                                  02450000
024600     PERFORM 1000-INITIALIZE.                                     02460000
024700                                                                  02470000
024800     PERFORM 2000-PROCESS-ORG-HIER-EXTRACTS                       02480000
024900         UNTIL ((PS-END-OF-PREV-CYCLE-FILE)                       02490000
025000                 AND (PS-END-OF-CURR-CYCLE-CSR)).                 02500000
025100                                                                  02510000
025200     PERFORM 1500-DISPLAY-PROGRAM-TOTALS.                         02520000
025300                                                                  02530000
025310     MOVE PV-RETURN-CODE TO RETURN-CODE.                          02531004
025320                                                                  02532004
025400     GOBACK.                                                      02540000
025500                                                                  02550000
025600******************************************************************02560000
025700*  INITIALIZE FOR PROGRAM PROCESSING.  OPEN ALL FILES, AND THE   *02570013
025710*  CURRENT ORGANIZATION HIERARCHY CURSOR, INITIALIZE THE EXTRACT *02571013
025800*  FILE LAYOUTS, AND PERFORM A PRIMING READ ON THE PREVIOUS      *02580013
025900*  CYCLE'S EXTRACT FILE, AND A PRIMING FETCH ON THE CURRENT      *02590013
025901*  ORGANIZATION HIERARCHY CURSOR.  PREPARE AND WRITE THE HEADER  *02590114
025902*  RECORD FOR THE ORGANIZATION HIERARCHY CSV FILE.               *02590214
026000******************************************************************02600000
026100                                                                  02610000
026200 1000-INITIALIZE.                                                 02620000
026300     OPEN INPUT PREV-CYCLE-EXTRACT-FILE                           02630000
026400          OUTPUT CURR-CYCLE-EXTRACT-FILE                          02640000
026500                 REALIGNMENT-EMAIL-FILE                           02650014
026510                 CSV-ORG-HIER-EXTRACT-FILE.                       02651014
026600                                                                  02660000
026700     INITIALIZE SEP06-ORG-HIER-EXTRACT-RECORD                     02670000
026800                SE006-ORG-HIER-EXTRACT-RECORD.                    02680000
026900                                                                  02690000
027000     PERFORM 7000-READ-PREV-CYCLE-FILE.                           02700000
027100                                                                  02710002
027200     INITIALIZE PV-RETRY-COUNT.                                   02720002
027300     PERFORM                                                      02730002
027400             WITH TEST AFTER                                      02740002
027500             UNTIL ((SQLCODE = PC-SUCCESSFUL-SQLCODE)             02750002
027600                    OR (PV-RETRY-COUNT > PC-MAXIMUM-RETRY-COUNT)) 02760002
027700         EXEC SQL                                                 02770002
027800             OPEN ORG_HIER_CURSOR                                 02780002
027900         END-EXEC                                                 02790002
028000                                                                  02800002
028100         EVALUATE TRUE                                            02810002
028200             WHEN SQLCODE = PC-RESOURCE-NOT-AVAIL-SQLCODE         02820002
028300             WHEN SQLCODE = PC-DEADLOCK-W-ROLLBCK-SQLCODE         02830002
028400             WHEN SQLCODE = PC-DEADLOCK-WO-ROLLBCK-SQLCODE        02840002
028500                 ADD +1 TO PV-RETRY-COUNT                         02850002
028600             WHEN SQLWARN0 NOT = SPACES                           02860002
028700             WHEN SQLCODE < ZERO                                  02870002
028800             WHEN SQLCODE > ZERO                                  02880002
028900                 SET PV-OPEN-ORG-HIER-CURSOR TO TRUE              02890002
029000                 PERFORM 9100-DB2-ERROR                           02900002
029100         END-EVALUATE                                             02910002
029200     END-PERFORM.                                                 02920002
029300                                                                  02930002
029400     IF PV-RETRY-COUNT > PC-MAXIMUM-RETRY-COUNT                   02940002
029500         SET PV-OPEN-ORG-HIER-CURSOR TO TRUE                      02950002
029600         PERFORM 9100-DB2-ERROR                                   02960002
029700     END-IF.                                                      02970002
029800                                                                  02980002
029900     PERFORM 7100-FETCH-ORG-HIER-ROW.                             02990002
029901                                                                  02990114
029910     INITIALIZE OH-ORG-HIER-CSV-RECORD.                           02991014
029930     SET OH-CSV-QUOTE-1                                           02993016
029940         OH-LOC-NBR-ID                                            02994016
029960         OH-CSV-QUOTE-2                                           02996016
029961         OH-CSV-COMMA-1                                           02996116
029962         OH-CSV-QUOTE-3                                           02996216
029970         OH-DIST-NBR-ID                                           02997014
029980         OH-CSV-QUOTE-4                                           02998016
029991         OH-CSV-COMMA-2                                           02999114
029992         OH-CSV-QUOTE-5                                           02999216
029993         OH-REGN-NBR-ID                                           02999314
029994         OH-CSV-QUOTE-6                                           02999416
029995         OH-CSV-COMMA-3                                           02999514
029996         OH-CSV-QUOTE-7                                           02999616
029997         OH-TERR-NBR-ID                                           02999716
029998         OH-CSV-QUOTE-8 TO TRUE.                                  02999816
029999                                                                  02999914
030000     PERFORM 8200-WRITE-CSV-ORG-HIER-RECORD.                      03000014
030010*1000-EXIT.                                                       03001000
030100                                                                  03010000
030200******************************************************************03020000
030300*  DISPLAY SUMMARY TOTALS OF I/O ACTIVITY.                       *03030000
030400******************************************************************03040000
030500                                                                  03050000
030600 1500-DISPLAY-PROGRAM-TOTALS.                                     03060000
030700     SET TD-PREV-CYCLE-RCDS-READ-ID TO TRUE.                      03070000
030800     MOVE PT-PREV-CYCLE-RCDS-READ TO TD-TOTAL-AMOUNT.             03080000
030900     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       03090000
031000               TD-TOTAL-DISPLAY-MESSAGE.                          03100000
031100                                                                  03110000
031200     SET TD-CURR-CYCLE-ROWS-READ-ID TO TRUE.                      03120000
031300     MOVE PT-CURR-CYCLE-ROWS-READ TO TD-TOTAL-AMOUNT.             03130000
031400     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       03140000
031500               TD-TOTAL-DISPLAY-MESSAGE.                          03150000
031600                                                                  03160000
031700     SET TD-CURR-CYCLE-RCDS-WRITTEN-ID TO TRUE.                   03170000
031800     MOVE PT-CURR-CYCLE-RCDS-WRITTEN TO TD-TOTAL-AMOUNT.          03180000
031900     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       03190000
032000               TD-TOTAL-DISPLAY-MESSAGE.                          03200000
032001                                                                  03200105
032002     SET TD-REALIGN-EMAIL-LNS-WRITTN-ID TO TRUE.                  03200205
032003     MOVE PT-REALIGN-EMAIL-LNS-WRITTEN TO TD-TOTAL-AMOUNT.        03200305
032004     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       03200405
032005               TD-TOTAL-DISPLAY-MESSAGE.                          03200505
032006                                                                  03200614
032007     SET TD-CSV-ORG-HIER-RCDS-WRITTN-ID TO TRUE.                  03200715
032008     MOVE PT-CSV-ORG-HIER-RCDS-WRITTEN TO TD-TOTAL-AMOUNT.        03200814
032009     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - '                       03200914
032010               TD-TOTAL-DISPLAY-MESSAGE.                          03201014
032100*1500-EXIT.                                                       03210000
032200                                                                  03220000
032300******************************************************************03230000
032400*  PROCESS A COMPARISON BETWEEN AN EXTRACT RECORD FROM THE       *03240000
032500*  PREVIOUS CYCLE'S ORGANIZATION HIERARCHY EXTRACT FILE, AND     *03250013
032510*  THE INFORMATION FROM THE CURRENT ORGANIZATION HIERARCHY       *03251013
032520*  CURSOR.  IF THE LOCATION NUMBERS MATCH, PREPARE A CURRENT     *03252013
032600*  CYCLE EXTRACT RECORD, AND EXAMINE THE HIERARCHY INFORMATION   *03260013
032700*  TO IDENTIFY IF ANY OF THE VALUES HAVE CHANGED.  IF SO, RECORD *03270013
032800*  THE PREVIOUS VALUES IN THE APPROPRIATE FIELDS OF THE CURRENT  *03280013
032810*  CYCLE EXTRACT RECORD, AND PREPARE REALIGNMENT DETAIL          *03281013
032900*  INFORMATION FOR THE E-MAIL COMMUNICATION FILE.  WRITE THE     *03290013
032910*  EXTRACT RECORD AND ADVANCE TO THE NEXT RECORD AND ROW.  IF    *03291013
033000*  THE PREVIOUS CYCLE'S LOCATION NUMBER IS GREATER THAN THE      *03300013
033100*  CURRENT LOCATION NUMBER FROM THE CURSOR, A NEW LOCATION HAS   *03310013
033110*  BEEN DETECTED, AND A NEW LOCATION DETAIL LINE IS PREPARED FOR *03311013
033200*  THE E-MAIL COMMUNICATION FILE, A CURRENT CYCLE EXTRACT RECORD *03320013
033210*  IS PREPARED AND WRITTEN, AND THE NEXT ROW IS READ FROM THE    *03321013
033300*  CURSOR.  IF THE PREVIOUS CYCLE'S LOCATION NUMBER IS LESS THAN *03330013
033400*  THE CURRENT LOCATION NUMBER FROM THE CURSOR, A LOCATION HAS   *03340013
033500*  BEEN REMOVED, AND A DELETED LOCATION DETAIL LINE IS PREPARED  *03350013
033510*  FOR THE E-MAIL COMMUNICATION FILE, AND THE NEXT RECORD READ   *03351013
033600*  FROM THE PREVIOUS CYCLE EXTRACT FILE.                         *03360013
033800******************************************************************03380000
033900                                                                  03390000
034000 2000-PROCESS-ORG-HIER-EXTRACTS.                                  03400000
034100     EVALUATE TRUE                                                03410000
034200         WHEN (PV-PREV-CYCLE-LOC-NBR = PV-CURR-CYCLE-LOC-NBR)     03420000
034300             PERFORM 3000-PREPARE-ORG-HIER-EXTRACT                03430002
034400             IF (SEP06-DIST-NBR NOT = SE006-DIST-NBR)             03440003
034500                 MOVE SEP06-DIST-NBR TO SE006-PREV-DIST-NBR       03450003
034600             END-IF                                               03460003
034700             IF (SEP06-REGN-NBR NOT = SE006-REGN-NBR)             03470003
034800                 MOVE SEP06-REGN-NBR TO SE006-PREV-REGN-NBR       03480003
034900             END-IF                                               03490003
035000             IF (SEP06-TERR-NBR NOT = SE006-TERR-NBR)             03500003
035100                 MOVE SEP06-TERR-NBR TO SE006-PREV-TERR-NBR       03510003
035200             END-IF                                               03520003
035300             IF ((SE006-PREV-DIST-NBR NOT = SPACES)               03530003
035400                     OR (SE006-PREV-REGN-NBR NOT = SPACES)        03540003
035500                     OR (SE006-PREV-TERR-NBR NOT = SPACES))       03550003
035510                 SET PV-ORG-HIER-REALIGN-RET-CODE TO TRUE         03551004
035520                 IF (NOT PS-HAVE-EMAIL-LINES)                     03552005
035600                     PERFORM 3100-GENERATE-EMAIL-HEADER           03560005
035700                     SET PS-HAVE-EMAIL-LINES TO TRUE              03570005
035900                 END-IF                                           03590005
035901                 MOVE SE006-LOC-NBR-N TO EN-SR-LOC-NBR            03590105
035902                 IF (SEP06-DIST-NBR NUMERIC)                      03590212
035903                     MOVE SEP06-DIST-NBR-N TO                     03590312
035904                               EN-SR-PREV-DIST-NBR-N              03590412
035905                 ELSE                                             03590512
035906                     MOVE SEP06-DIST-NBR TO EN-SR-PREV-DIST-NBR   03590612
035907                 END-IF                                           03590712
035908                 IF (SEP06-REGN-NBR NUMERIC)                      03590812
035909                     MOVE SEP06-REGN-NBR-N TO                     03590912
035910                               EN-SR-PREV-REGN-NBR-N              03591012
035911                 ELSE                                             03591112
035912                     MOVE SEP06-REGN-NBR TO EN-SR-PREV-REGN-NBR   03591212
035913                 END-IF                                           03591312
035914                 IF (SEP06-TERR-NBR NUMERIC)                      03591412
035915                     MOVE SEP06-TERR-NBR-N TO                     03591512
035916                               EN-SR-PREV-TERR-NBR-N              03591612
035917                 ELSE                                             03591712
035918                     MOVE SEP06-TERR-NBR TO EN-SR-PREV-TERR-NBR   03591812
035919                 END-IF                                           03591912
035920                 IF (SE006-DIST-NBR NUMERIC)                      03592012
035921                     MOVE SE006-DIST-NBR-N TO                     03592112
035922                               EN-SR-CURR-DIST-NBR-N              03592212
035923                 ELSE                                             03592312
035924                     MOVE SE006-DIST-NBR TO EN-SR-CURR-DIST-NBR   03592412
035925                 END-IF                                           03592512
035926                 IF (SE006-REGN-NBR NUMERIC)                      03592612
035927                     MOVE SE006-REGN-NBR-N TO                     03592712
035928                               EN-SR-CURR-REGN-NBR-N              03592812
035929                 ELSE                                             03592912
035930                     MOVE SE006-REGN-NBR TO EN-SR-CURR-REGN-NBR   03593012
035931                 END-IF                                           03593112
035932                 IF (SE006-TERR-NBR NUMERIC)                      03593212
035933                     MOVE SE006-TERR-NBR-N TO                     03593312
035934                               EN-SR-CURR-TERR-NBR-N              03593412
035935                 ELSE                                             03593512
035936                     MOVE SE006-TERR-NBR TO EN-SR-CURR-TERR-NBR   03593612
035937                 END-IF                                           03593712
035939                 MOVE EN-STORE-REALIGNED-LINE TO                  03593912
035940                           RE-REALIGNMENT-EMAIL-RECORD            03594012
035941                 PERFORM 8100-WRITE-REALIGN-EMAIL-LINE            03594112
035950             END-IF                                               03595012
036000             PERFORM 8000-WRITE-CURR-CYCLE-RECORD                 03600003
036010             PERFORM 8200-WRITE-CSV-ORG-HIER-RECORD               03601014
036100             PERFORM 7000-READ-PREV-CYCLE-FILE                    03610003
036200             PERFORM 7100-FETCH-ORG-HIER-ROW                      03620003
036300         WHEN (PV-PREV-CYCLE-LOC-NBR > PV-CURR-CYCLE-LOC-NBR)     03630003
036400             PERFORM 3000-PREPARE-ORG-HIER-EXTRACT                03640003
036510             IF (NOT PS-HAVE-EMAIL-LINES)                         03651005
036520                 PERFORM 3100-GENERATE-EMAIL-HEADER               03652005
036530                 SET PS-HAVE-EMAIL-LINES TO TRUE                  03653005
036540             END-IF                                               03654005
036541             MOVE SE006-LOC-NBR-N TO EN-SA-LOC-NBR                03654105
036542             MOVE EN-STORE-ADDED-LINE TO                          03654205
036543                       RE-REALIGNMENT-EMAIL-RECORD                03654305
036544             PERFORM 8100-WRITE-REALIGN-EMAIL-LINE                03654405
036550             PERFORM 8000-WRITE-CURR-CYCLE-RECORD                 03655005
036560             PERFORM 8200-WRITE-CSV-ORG-HIER-RECORD               03656014
036600             PERFORM 7100-FETCH-ORG-HIER-ROW                      03660002
036700         WHEN OTHER                                               03670000
036710             IF (NOT PS-HAVE-EMAIL-LINES)                         03671005
036720                 PERFORM 3100-GENERATE-EMAIL-HEADER               03672005
036730                 SET PS-HAVE-EMAIL-LINES TO TRUE                  03673005
036740             END-IF                                               03674005
036750             MOVE SEP06-LOC-NBR-N TO EN-SD-LOC-NBR                03675011
036751             IF (SEP06-DIST-NBR NUMERIC)                          03675112
036752                 MOVE SEP06-DIST-NBR-N TO EN-SD-DIST-NBR-N        03675212
036753             ELSE                                                 03675312
036754                 MOVE SEP06-DIST-NBR TO EN-SD-DIST-NBR            03675412
036755             END-IF                                               03675512
036756             IF (SEP06-REGN-NBR NUMERIC)                          03675612
036757                 MOVE SEP06-REGN-NBR-N TO EN-SD-REGN-NBR-N        03675712
036758             ELSE                                                 03675812
036759                 MOVE SEP06-REGN-NBR TO EN-SD-REGN-NBR            03675912
036760             END-IF                                               03676012
036761             IF (SEP06-TERR-NBR NUMERIC)                          03676112
036762                 MOVE SEP06-TERR-NBR-N TO EN-SD-TERR-NBR-N        03676212
036763             ELSE                                                 03676312
036764                 MOVE SEP06-TERR-NBR TO EN-SD-TERR-NBR            03676412
036765             END-IF                                               03676512
036766             MOVE EN-STORE-DELETED-LINE TO                        03676612
036770                       RE-REALIGNMENT-EMAIL-RECORD                03677005
036780             PERFORM 8100-WRITE-REALIGN-EMAIL-LINE                03678005
037100             PERFORM 7000-READ-PREV-CYCLE-FILE                    03710000
037200     END-EVALUATE.                                                03720000
037300*2000-EXIT.                                                       03730000
037400                                                                  03740000
037500******************************************************************03750000
037600*  PREPARE THE STATIC COMPONENTS OF AN ORGANIZATION HIERARCHY    *03760002
037700*  EXTRACT RECORD, AND THE CSV VERSION OF THE EXTRACT RECORD.    *03770014
037800******************************************************************03780000
037900                                                                  03790000
038000 3000-PREPARE-ORG-HIER-EXTRACT.                                   03800002
038100     INITIALIZE SE006-ORG-HIER-EXTRACT-RECORD.                    03810002
038200     MOVE XST00001-LOC-NBR TO SE006-LOC-NBR-N.                    03820002
038300     IF (XST00002-DIST-NBR = 0)                                   03830002
038400         SET SE006-DIST-UNKNOWN TO TRUE                           03840002
038500     ELSE                                                         03850002
038600         MOVE XST00002-DIST-NBR TO SE006-DIST-NBR-N               03860002
038700     END-IF.                                                      03870002
038800     IF (XST00004-REGN-NBR = 0)                                   03880002
038900         SET SE006-REGN-UNKNOWN TO TRUE                           03890002
039000     ELSE                                                         03900002
039100         MOVE XST00004-REGN-NBR TO SE006-REGN-NBR-N               03910002
039200     END-IF.                                                      03920002
039300     IF (XST00006-TERR-NBR = 0)                                   03930002
039400         SET SE006-TERR-UNKNOWN TO TRUE                           03940002
039500     ELSE                                                         03950002
039600         MOVE XST00006-TERR-NBR TO SE006-TERR-NBR-N               03960002
039700     END-IF.                                                      03970002
039701                                                                  03970114
039710     INITIALIZE OH-ORG-HIER-CSV-RECORD.                           03971014
039711     SET OH-CSV-QUOTE-1 TO TRUE.                                  03971116
039720     MOVE SE006-LOC-NBR(2:4) TO OH-LOC-NBR.                       03972016
039730     SET OH-CSV-QUOTE-2                                           03973016
039731         OH-CSV-COMMA-1                                           03973116
039732         OH-CSV-QUOTE-3 TO TRUE.                                  03973216
039740     MOVE SE006-DIST-NBR TO OH-DIST-NBR.                          03974014
039741     SET OH-CSV-QUOTE-4                                           03974116
039742         OH-CSV-COMMA-2                                           03974216
039743         OH-CSV-QUOTE-5 TO TRUE.                                  03974316
039760     MOVE SE006-REGN-NBR TO OH-REGN-NBR.                          03976014
039761     SET OH-CSV-QUOTE-6                                           03976116
039762         OH-CSV-COMMA-3                                           03976216
039763         OH-CSV-QUOTE-7 TO TRUE.                                  03976316
039780     MOVE SE006-TERR-NBR TO OH-TERR-NBR.                          03978014
039790     SET OH-CSV-QUOTE-8 TO TRUE.                                  03979016
039800*3000-EXIT.                                                       03980002
039900                                                                  03990002
040000******************************************************************04000002
040100*  GENERATE THE HEADER INFORMATION ON THE REALIGNMENT E-MAIL     *04010005
040200*  MESSAGE.                                                      *04020005
040300******************************************************************04030002
040400                                                                  04040002
040500 3100-GENERATE-EMAIL-HEADER.                                      04050005
040501     CALL DP085-GET-CURR-JOB-INFO-PGM                             04050105
040502         USING DP085-GET-CURR-JOB-INFO-PARMS.                     04050205
040503                                                                  04050305
040504     IF (DP085-JOB-NAME(1:2) = PC-TEST-JOB-NAME-PREFIX)           04050405
040505         MOVE EN-TEST-SUBMISSION-NOTE TO                          04050505
040506                   RE-REALIGNMENT-EMAIL-RECORD                    04050605
040507         PERFORM 8100-WRITE-REALIGN-EMAIL-LINE                    04050705
040508     END-IF.                                                      04050805
040509     MOVE EN-TITLE TO RE-REALIGNMENT-EMAIL-RECORD.                04050905
040510     PERFORM 8100-WRITE-REALIGN-EMAIL-LINE.                       04051005
040511     INITIALIZE RE-REALIGNMENT-EMAIL-RECORD.                      04051105
040512     PERFORM 8100-WRITE-REALIGN-EMAIL-LINE.                       04051205
040513     MOVE EN-IDENTITY-MANAGEMENT-NOTE TO                          04051308
040514               RE-REALIGNMENT-EMAIL-RECORD.                       04051408
040515     PERFORM 8100-WRITE-REALIGN-EMAIL-LINE.                       04051508
040516     INITIALIZE RE-REALIGNMENT-EMAIL-RECORD.                      04051608
040517     PERFORM 8100-WRITE-REALIGN-EMAIL-LINE.                       04051708
040518*3100-EXIT.                                                       04051805
040520                                                                  04052005
040530******************************************************************04053005
040540*  READ AN ORGANIZATION HIERARCHY EXTRACT RECORD FROM THE        *04054005
040550*  PREVIOUS PROCESSING CYCLE, AND ACCUMULATE I/O TOTALS.         *04055005
040560******************************************************************04056005
040570                                                                  04057005
040580 7000-READ-PREV-CYCLE-FILE.                                       04058005
040600     READ PREV-CYCLE-EXTRACT-FILE                                 04060000
040700         INTO SEP06-ORG-HIER-EXTRACT-RECORD                       04070000
040800         AT END                                                   04080000
040900             SET PS-END-OF-PREV-CYCLE-FILE TO TRUE                04090000
041000             SET PV-PREV-CYCLE-EOF-LOC-NBR TO TRUE                04100000
041100     END-READ.                                                    04110000
041200                                                                  04120000
041300     IF (NOT PS-END-OF-PREV-CYCLE-FILE)                           04130000
041400         ADD +1 TO PT-PREV-CYCLE-RCDS-READ                        04140000
041500         MOVE SEP06-LOC-NBR TO PV-PREV-CYCLE-LOC-NBR              04150000
041600     END-IF.                                                      04160000
041700*7000-EXIT.                                                       04170000
041800                                                                  04180002
041900******************************************************************04190002
042000*  FETCH A DEPARTMENT STORE ROW FROM THE ORGANIZATION            *04200002
042100*  HIERARCHY CURSOR.                                             *04210002
042200******************************************************************04220002
042300                                                                  04230002
042400 7100-FETCH-ORG-HIER-ROW.                                         04240002
042500     EXEC SQL                                                     04250002
042600         FETCH ORG_HIER_CURSOR                                    04260002
042700             INTO :XST00001-LOC-NBR,                              04270002
042800                  :XST00002-DIST-NBR,                             04280002
042900                  :XST00004-REGN-NBR,                             04290002
043000                  :XST00006-TERR-NBR                              04300002
043100     END-EXEC.                                                    04310002
043200                                                                  04320002
043300     EVALUATE TRUE                                                04330002
043400         WHEN (SQLWARN0 NOT = SPACES)                             04340002
043500             SET PV-FETCH-ORG-HIER-ROW TO TRUE                    04350002
043600             PERFORM 9100-DB2-ERROR                               04360002
043700         WHEN (SQLCODE = PC-SUCCESSFUL-SQLCODE)                   04370002
043800             ADD +1 TO PT-CURR-CYCLE-ROWS-READ                    04380002
043900             MOVE XST00001-LOC-NBR TO PV-CURR-CYCLE-LOC-NBR       04390002
044000         WHEN (SQLCODE = PC-END-OF-CURSOR-SQLCODE)                04400002
044100             SET PS-END-OF-CURR-CYCLE-CSR TO TRUE                 04410006
044200             SET PV-CURR-CYCLE-EOF-LOC-NBR TO TRUE                04420002
044300         WHEN OTHER                                               04430002
044400             SET PV-FETCH-ORG-HIER-ROW TO TRUE                    04440002
044500             PERFORM 9100-DB2-ERROR                               04450002
044600     END-EVALUATE.                                                04460002
044700*7100-EXIT.                                                       04470000
044800                                                                  04480000
044900******************************************************************04490000
045000*  WRITE AN IMAGE OF THE CURRENT ORGANIZATION HIERARCHY          *04500000
045100*  RELATIONSHIP FOR A LOCATION, INCLUDING DIFFERENCES FROM THE   *04510000
045200*  PREVIOUS CYCLE, AND ACCUMULATE I/O TOTALS.                    *04520000
045300******************************************************************04530000
045400                                                                  04540000
045500 8000-WRITE-CURR-CYCLE-RECORD.                                    04550000
045600     WRITE CC-CURR-CYCLE-EXTRACT-RECORD                           04560000
045700         FROM SE006-ORG-HIER-EXTRACT-RECORD.                      04570000
045800                                                                  04580000
045900     ADD +1 TO PT-CURR-CYCLE-RCDS-WRITTEN.                        04590000
046000*8000-EXIT.                                                       04600000
046010                                                                  04601005
046020******************************************************************04602005
046030*  WRITE A LINE FOR THE ORGANIZATION REALIGNMENT EMAIL           *04603005
046040*  NOTIFICATION MESSAGE, AND ACCUMULATE I/O TOTALS.              *04604005
046050******************************************************************04605005
046060                                                                  04606005
046070 8100-WRITE-REALIGN-EMAIL-LINE.                                   04607005
046081     WRITE RE-REALIGNMENT-EMAIL-RECORD.                           04608105
046090                                                                  04609005
046091     ADD +1 TO PT-REALIGN-EMAIL-LNS-WRITTEN.                      04609105
046092*8100-EXIT.                                                       04609205
046093                                                                  04609314
046094******************************************************************04609414
046095*  WRITE A CSV IMAGE OF THE CURRENT ORGANIZATION HIERARCHY       *04609514
046096*  RELATIONSHIP FOR A LOCATION, AND ACCUMULATE I/O TOTALS.       *04609614
046098******************************************************************04609814
046099                                                                  04609914
046100 8200-WRITE-CSV-ORG-HIER-RECORD.                                  04610014
046101     WRITE CO-CSV-ORG-HIER-EXTRACT-RECORD                         04610115
046102         FROM OH-ORG-HIER-CSV-RECORD.                             04610214
046103                                                                  04610314
046104     ADD +1 TO PT-CSV-ORG-HIER-RCDS-WRITTEN.                      04610414
046105*8200-EXIT.                                                       04610514
046110                                                                  04611000
046200******************************************************************04620000
046300*  CLOSE ALL FILES AND OPEN CURSORS.                             *04630002
046400******************************************************************04640000
046500                                                                  04650000
046600 9000-EOJ-ROUTINE.                                                04660000
046700     CLOSE PREV-CYCLE-EXTRACT-FILE                                04670000
046800           CURR-CYCLE-EXTRACT-FILE                                04680000
046900           REALIGNMENT-EMAIL-FILE                                 04690014
046910           CSV-ORG-HIER-EXTRACT-FILE.                             04691014
047000                                                                  04700002
047100     EXEC SQL                                                     04710002
047200         CLOSE ORG_HIER_CURSOR                                    04720002
047300     END-EXEC.                                                    04730002
047400                                                                  04740002
047500     IF SQLCODE NOT = PC-SUCCESSFUL-SQLCODE                       04750002
047600         SET PV-CLOSE-ORG-HIER-CURSOR TO TRUE                     04760002
047700         PERFORM 9100-DB2-ERROR                                   04770002
047800     END-IF.                                                      04780002
047900*9000-EXIT.                                                       04790000
048000                                                                  04800002
048100******************************************************************04810002
048200*  FORMAT A DB2 ERROR MESSAGE, AND ABEND THE PROGRAM.            *04820002
048300******************************************************************04830002
048400                                                                  04840002
048500 9100-DB2-ERROR.                                                  04850002
048600     DISPLAY '** ABEND **'.                                       04860002
048700     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - SQL ERROR'.             04870002
048800     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - ATTEMPTING TO '         04880002
048900               PV-LAST-DB2-ACTION.                                04890002
049000                                                                  04900002
049100*                                                                 04910002
049200*  ROUTINE TO CONVERT THE SQLCA INTO A READABLE FORMAT, USING     04920002
049300*  THE CALLED MODULE DSNTIAR.                                     04930002
049400*                                                                 04940002
049500                                                                  04950002
049600     COPY DPPD004.                                                04960002
049700                                                                  04970002
049800     SET AC-DB2-ERROR-4013 TO TRUE.                               04980002
049900     CALL 'ILBOABN0' USING ABEND-CODE.                            04990002
050000*9100-EXIT.                                                       05000002
