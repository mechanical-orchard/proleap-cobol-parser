000100 IDENTIFICATION DIVISION.                                         00010038
000200 PROGRAM-ID.         AHKUP030.                                    00020038
000300 AUTHOR.             NANCY EILBES.                                00030038
000400 DATE-WRITTEN.       APRIL 2000.                                  00040038
000500 DATE-COMPILED.                                                   00050038
000600*************************************************************     00060038
000700*    COBOL 2 WITH SQL                                       *     00070038
000800*                                                           *     00080038
000900*   AHKUP030 - ARCHIVE HISTORY DATA DELETION - TINVOIC      *     00090041
001000*                                                           *     00100038
001100*   PROGRAM OVERVIEW:                                       *     00110038
001200*                                                           *     00120038
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TINVOIC.  *     00130041
001400*  ROWS DELETED ARE THOSE PREVIOUSLY:                       *     00140038
001500*  - IDENTIFIED/EXTRACTED WITHIN THE ARCHIVE/HISTORY SYSTEM.*     00150038
001600*                                                           *     00160038
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170038
001800*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00180038
001900*  THESE COLUMNS ARE PO_NBR, INVC_ID.                       *     00190041
002000*                                                           *     00200038
002100*  NOTE THAT CASCADE/DELETE WILL ALSO REMOVE RELATED ROWS   *     00210038
002200*  FROM THE FOLLOWING TABLES:                               *     00220038
002300*  - TMDINVC                                                *     00230038
002400*  - TEXINVC                                                *     00240038
002500*                                                           *     00250038
002600*   INPUT:                                                  *     00260038
002700*                                                           *     00270038
002800*     1. TINVOIC DELETION FILE  COPYBOOK AHRD001            *     00280041
002900*                                                           *     00290038
003000*   DB2 TABLES:                                             *     00300038
003100*                                                           *     00310038
003200*        TINVOIC - AP INVOICE TABLE                         *     00320038
003300*        TMDINVC - MERCHANDISE INVOICE TABLE                *     00330038
003400*        TEXINVC - EXPENSE INVOICE TABLE                    *     00340038
003500*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00350038
003600*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00360038
003700*                                                           *     00370038
003800*************************************************************     00380038
003810*-----------------------------------------------------------*     00381042
003820*  CHANGE LOG:                                              *     00382042
003830* 06/19/07                                                  *     00383046
003840*     MATCH BY DC PROJECT.                                  *     00384042
003850*     INCREASED SIZE OF INPUT FILE FROM 186 TO 189.  THIS   *     00385042
003860*     WAS NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE       *     00386042
003870*     AHRD001 COPYBOOK: DC-NBR AND MTCH-LVL-CDE.            *     00387042
003880* MADE BY: MICHELE RINDFLEISCH                 WR# 32804    *     00388045
003890*-----------------------------------------------------------*     00389042
004000*************************************************************     00400038
004100 EJECT                                                            00410038
004200 ENVIRONMENT DIVISION.                                            00420038
004300 CONFIGURATION SECTION.                                           00430038
004400 SOURCE-COMPUTER.        IBM-370.                                 00440038
004500 OBJECT-COMPUTER.        IBM-370.                                 00450038
004600                                                                  00460038
004700 INPUT-OUTPUT SECTION.                                            00470038
004800 FILE-CONTROL.                                                    00480038
004900     SELECT TINVOIC-EXTRACT-FILE ASSIGN TO INP01.                 00490041
005000                                                                  00500038
005100 DATA DIVISION.                                                   00510038
005200 FILE SECTION.                                                    00520038
005300 FD  TINVOIC-EXTRACT-FILE                                         00530041
005400     RECORDING MODE IS F                                          00540038
005500     LABEL RECORDS ARE STANDARD                                   00550038
005600     BLOCK CONTAINS 0 RECORDS                                     00560038
005700     RECORD CONTAINS 189 CHARACTERS                               00570044
005800     DATA RECORD IS TINVOIC-EXTRACT-DATA.                         00580041
005900 01  TINVOIC-EXTRACT-DATA       PIC X(189).                       00590042
006000                                                                  00600038
006100                                                                  00610038
006200 EJECT                                                            00620038
006300 WORKING-STORAGE SECTION.                                         00630038
006400                                                                  00640038
006500 01  FILLER                       PIC X(58)     VALUE             00650038
006600     '************WORKING STORAGE STARTS HERE*******************'.00660038
006700                                                                  00670038
006800 01  PV-PROGRAM-VARIABLES.                                        00680038
006900     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP030'. 00690038
007000     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00700038
007100     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00710038
007200     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00720038
007300                                                                  00730038
007400     05  PV-TINVOIC-INPUT-COUNT   PIC S9(09)    VALUE ZERO        00740041
007500                                                COMP-3.           00750038
007600     05  PV-TINVOIC-DELETE-COUNT  PIC S9(09)    VALUE ZERO        00760041
007700                                                COMP-3.           00770038
007800     05  PV-SQL-DELETE-COUNT      PIC S9(09)    VALUE ZERO        00780038
007900                                                COMP-3.           00790038
008000     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00800038
008100                                                COMP-3.           00810038
008200     05  PV-DISP-INVC-ID          PIC X(09)    VALUE SPACES.      00820041
008300     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00830038
008400 01  PC-PROGRAM-CONSTANTS.                                        00840038
008500     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00850038
008600                                                COMP SYNC.        00860038
008700     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00870038
008800     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00880038
008900     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00890038
009000                                                                  00900038
009100 01  PS-PROGRAM-SWITCHES.                                         00910038
009200     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00920038
009300         88  COMMITS-TAKEN                      VALUE 'T'.        00930038
009400         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00940038
009500     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00950038
009600         88  MORE-EXTRACT                       VALUE 'M'.        00960038
009700         88  END-OF-EXTRACT                     VALUE 'E'.        00970038
009800     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00980038
009900         88  NORMAL-RUN                         VALUE '0'.        00990038
010000         88  RESTART-RUN                        VALUE '9'.        01000038
010100                                                                  01010038
010200 01  WS-COUNTER.                                                  01020038
010300     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01030038
010400     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01040038
010500                                                                  01050038
010600 01  CKPT-RESTART-INFO.                                           01060038
010700     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01070038
010800                                                                  01080038
010900*----------------------------------------------------------------*01090038
011000*  ABEND DATA AREAS                                              *01100038
011100*----------------------------------------------------------------*01110038
011200 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01120038
011300                                             COMP SYNC.           01130038
011400     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01140038
011500     88  AC-BAD-DATA                         VALUE +4008.         01150038
011600     88  AC-DB2-ERROR                        VALUE +4013.         01160038
011700     88  AC-DATE-ERROR                       VALUE +4019.         01170038
011800                                                                  01180038
011900                                                                  01190038
012000 01  ABEND-AREAS.                                                 01200038
012100     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01210038
012200             '*****       ABEND'.                                 01220038
012300     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01230038
012400             '*****   PROGRAM: AHKUP030'.                         01240038
012500     05  AA-PARAGRAPH-LIT.                                        01250038
012600         10  FILLER              PIC  X(17)  VALUE                01260038
012700             '***** PARAGRAPH: '.                                 01270038
012800         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01280038
012900     05  AA-MESSAGE-LINE-1.                                       01290038
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300038
013100         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01310038
013200     05  AA-MESSAGE-LINE-2.                                       01320038
013300         10  FILLER              PIC  X(06)  VALUE '*****'.       01330038
013400         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01340038
013500     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01350038
013600             '*****    DB2 ERROR'.                                01360038
013700     05  AA-DB2-OPERATION-LIT.                                    01370038
013800         10  FILLER              PIC  X(17)  VALUE                01380038
013900             '***** OPERATION: '.                                 01390038
014000         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01400038
014100     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01410038
014200     EJECT                                                        01420038
014300                                                                  01430038
014400*----------------------------------------------------------------*01440038
014500*      TINVOIC DELETION CONTROL FILE                              01450041
014600*----------------------------------------------------------------*01460038
014700*                                                                 01470038
014800     COPY AHRD001.                                                01480041
014900     EJECT                                                        01490038
015000     COPY DPWS004.                                                01500038
015100     EJECT                                                        01510038
015200                                                                  01520038
015300*----------------------------------------------------------------*01530038
015400*      TINVOIC TABLE LAYOUT                                       01540041
015500*----------------------------------------------------------------*01550038
015600         EXEC SQL                                                 01560038
015700             INCLUDE TINVOIC                                      01570041
015800         END-EXEC.                                                01580038
015900                                                                  01590038
016000*----------------------------------------------------------------*01600041
016100*      TCKRSTCNTL TABLE LAYOUT                                    01610041
016200*----------------------------------------------------------------*01620041
016300         EXEC SQL                                                 01630041
016400             INCLUDE TCKRSTCN                                     01640041
016500         END-EXEC.                                                01650041
016600                                                                  01660041
016700*----------------------------------------------------------------*01670041
016800*      TCKRSTINF TABLE LAYOUT                                     01680041
016900*----------------------------------------------------------------*01690041
017000         EXEC SQL                                                 01700041
017100             INCLUDE TCKRSTIN                                     01710041
017200         END-EXEC.                                                01720041
017300 EJECT                                                            01730041
017400*----------------------------------------------------------------*01740041
017500*  DB2 COMMUNICATION AREA                                         01750041
017600*----------------------------------------------------------------*01760041
017700*                                                                 01770041
017800     EXEC SQL                                                     01780041
017900         INCLUDE SQLCA                                            01790041
018000     END-EXEC.                                                    01800041
018100                                                                  01810041
018200*----------------------------------------------------------------*01820041
018300*  DB2 COMMUNICATION AREA2                                        01830041
018400*----------------------------------------------------------------*01840041
018500*                                                                 01850041
018600     COPY SQLCA2.                                                 01860041
018700     EJECT                                                        01870041
018800 PROCEDURE DIVISION.                                              01880041
018900 A100-MAINLINE-ROUTINE.                                           01890041
019000                                                                  01900041
019100     PERFORM B100-INITIALIZATION.                                 01910041
019200                                                                  01920041
019300     PERFORM B200-TINVOIC-EXTRACT-PROCESS                         01930041
019400       UNTIL END-OF-EXTRACT.                                      01940041
019500                                                                  01950041
019600     PERFORM B300-EOJ-PROCESSING.                                 01960041
019700                                                                  01970041
019800     GOBACK.                                                      01980041
019900 EJECT                                                            01990041
020000 B100-INITIALIZATION.                                             02000041
020100                                                                  02010041
020200     EXEC SQL                                                     02020041
020300         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02030041
020400     END-EXEC.                                                    02040041
020500                                                                  02050041
020600     PERFORM X300-GET-CHECKPOINT-CNTL.                            02060041
020700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02070041
020800                                                                  02080041
020900     OPEN INPUT TINVOIC-EXTRACT-FILE.                             02090041
021000                                                                  02100041
021100     IF RESTART-RUN                                               02110041
021200         PERFORM X200-CHECKPOINT-RESTART                          02120041
021300     ELSE                                                         02130041
021400         PERFORM R100-READ-EXTRACT-FILE                           02140041
021500     END-IF.                                                      02150041
021600                                                                  02160041
021700     PERFORM X500-SET-CHECKPOINT-TIME.                            02170041
021800                                                                  02180041
021900                                                                  02190041
022000     EJECT                                                        02200041
022100 B200-TINVOIC-EXTRACT-PROCESS.                                    02210041
022200                                                                  02220041
022300     MOVE AH001-B-PO-NBR            TO INVOIC-PO-NBR              02230041
022400                                       PV-DISP-PO-NBR.            02240041
022500     MOVE AH001-B-INVC-ID           TO INVOIC-INVC-ID             02250041
022600                                       PV-DISP-INVC-ID.           02260041
022700                                                                  02270041
022800     PERFORM D100-DELETE-TINVOIC.                                 02280041
022900                                                                  02290041
023000     PERFORM X100-CHECKPOINT-CHECK.                               02300041
023100                                                                  02310041
023200     PERFORM R100-READ-EXTRACT-FILE.                              02320041
023300     EJECT                                                        02330041
023400                                                                  02340041
023500                                                                  02350041
023600 B300-EOJ-PROCESSING.                                             02360041
023700                                                                  02370041
023800     DISPLAY '** AHKUP030 SUMMARY **'.                            02380041
023900     DISPLAY '** TINVOIC INPUT COUNT  = ' PV-TINVOIC-INPUT-COUNT. 02390041
024000     DISPLAY '** TINVOIC DELETE COUNT = ' PV-TINVOIC-DELETE-COUNT.02400041
024100     DISPLAY '** SQL DELETE COUNT     = ' PV-SQL-DELETE-COUNT.    02410041
024200                                                                  02420041
024300     CLOSE  TINVOIC-EXTRACT-FILE.                                 02430041
024400                                                                  02440041
024500     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02450041
024600     PERFORM X600-UPDATE-TCKRSTCNTL.                              02460041
024700                                                                  02470041
024800     EJECT                                                        02480041
024900*----------------------------------------------------------------*02490041
025000*    DELETES FROM THE TINVOIC TABLE.  CASCADE DELETE WILL ALSO   *02500041
025100*    CAUSE ROWS TO BE DELETED FROM TMDINVC AND TEXINVC TABLES.   *02510041
025200*----------------------------------------------------------------*02520041
025300 D100-DELETE-TINVOIC.                                             02530041
025400                                                                  02540041
025500     MOVE 'D100-DELETE-TINVOIC' TO PV-CURRENT-PARAGRAPH.          02550041
025600                                                                  02560041
025700     PERFORM WITH TEST AFTER                                      02570041
025800        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02580041
025900          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02590041
026000             OR SQLCODE = ZERO                                    02600041
026100                                                                  02610041
026200         EXEC SQL                                                 02620041
026300              DELETE                                              02630041
026400                FROM TINVOIC                                      02640041
026500               WHERE PO_NBR  = :INVOIC-PO-NBR                     02650041
026600                 AND INVC_ID = :INVOIC-INVC-ID                    02660041
026700         END-EXEC                                                 02670041
026800                                                                  02680041
026900         EVALUATE TRUE                                            02690041
027000             WHEN SQLCODE = ZERO                                  02700041
027100                 ADD 1 TO PV-TINVOIC-DELETE-COUNT                 02710041
027200                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02720041
027300                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02730041
027400                                                                  02740041
027500             WHEN SQLCODE = -904                                  02750041
027600             WHEN SQLCODE = -913                                  02760041
027700                  CONTINUE                                        02770041
027800                                                                  02780041
027900             WHEN SQLCODE = +100                                  02790041
028000                 MOVE PV-CURRENT-PARAGRAPH                        02800041
028100                                     TO AA-PARAGRAPH-NAME         02810041
028200                 DISPLAY '******** PO NUMBER:'                    02820041
028300                          PV-DISP-PO-NBR                          02830041
028400                 DISPLAY '******** INVOICE ID:'                   02840041
028500                          PV-DISP-INVC-ID                         02850041
028600                 MOVE 'ROW NOT ON TABLE ********'                 02860041
028700                          TO AA-MESSAGE-1                         02870041
028800                 MOVE SPACES TO AA-MESSAGE-2                      02880041
028900                 MOVE 'UNSUCCESSFUL DELETE'                       02890041
029000                          TO AA-DB2-OPERATION                     02900041
029100                 MOVE 'TINVOIC'  TO AA-DB2-TABLE                  02910041
029200                 PERFORM Z999-DB2-ABEND                           02920041
029300             WHEN SQLWARN0 NOT = SPACES                           02930041
029400             WHEN SQLCODE  NOT = ZERO                             02940041
029500                 MOVE PV-CURRENT-PARAGRAPH                        02950041
029600                                     TO AA-PARAGRAPH-NAME         02960041
029700                 DISPLAY '******** PO NUMBER:'                    02970041
029800                          PV-DISP-PO-NBR                          02980041
029900                 DISPLAY '******** INVOICE ID:'                   02990041
030000                          PV-DISP-INVC-ID                         03000041
030100                 MOVE SPACES TO AA-MESSAGE-1                      03010041
030200                                AA-MESSAGE-2                      03020041
030300                 MOVE 'UNSUCCESSFUL DELETE'                       03030041
030400                                     TO AA-DB2-OPERATION          03040041
030500                 MOVE 'TINVOIC'      TO AA-DB2-TABLE              03050041
030600                 PERFORM Z999-DB2-ABEND                           03060041
030700         END-EVALUATE                                             03070041
030800     END-PERFORM.                                                 03080041
030900                                                                  03090041
031000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03100041
031100         MOVE PV-CURRENT-PARAGRAPH                                03110041
031200                             TO AA-PARAGRAPH-NAME                 03120041
031300         DISPLAY '******** PO NUMBER :'                           03130041
031400                          PV-DISP-PO-NBR                          03140041
031500         DISPLAY '******** INVOICE ID:'                           03150041
031600                          PV-DISP-INVC-ID                         03160041
031700         MOVE SPACES TO AA-MESSAGE-1                              03170041
031800                        AA-MESSAGE-2                              03180041
031900         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03190041
032000                             TO AA-DB2-OPERATION                  03200041
032100         MOVE 'TINVOIC'      TO AA-DB2-TABLE                      03210041
032200         PERFORM Z999-DB2-ABEND                                   03220041
032300     END-IF.                                                      03230041
032400                                                                  03240041
032500     EJECT                                                        03250041
032600 R100-READ-EXTRACT-FILE.                                          03260041
032700                                                                  03270041
032800     READ TINVOIC-EXTRACT-FILE                                    03280041
032900          INTO AH001-DRIVER-RECORD-LAYOUT                         03290041
033000          AT END SET END-OF-EXTRACT TO TRUE.                      03300041
033100                                                                  03310041
033200     IF MORE-EXTRACT                                              03320041
033300         ADD 1 TO PV-TINVOIC-INPUT-COUNT                          03330041
033400     END-IF.                                                      03340041
033500                                                                  03350041
033600                                                                  03360041
033700     EJECT                                                        03370041
033800*----------------------------------------------------------------*03380041
033900*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03390041
034000*----------------------------------------------------------------*03400041
034100 X100-CHECKPOINT-CHECK.                                           03410041
034200                                                                  03420041
034300     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03430041
034400                                                                  03440041
034500     EXEC SQL                                                     03450041
034600       SET :WS-TMST = CURRENT TIMESTAMP                           03460041
034700     END-EXEC.                                                    03470041
034800                                                                  03480041
034900     IF SQLCODE = +0                                              03490041
035000         CONTINUE                                                 03500041
035100     ELSE                                                         03510041
035200         MOVE PV-CURRENT-PARAGRAPH                                03520041
035300                             TO AA-PARAGRAPH-NAME                 03530041
035400         MOVE SPACES TO AA-MESSAGE-1                              03540041
035500                        AA-MESSAGE-2                              03550041
035600         MOVE 'BAD SET COMMAND'                                   03560041
035700                             TO AA-DB2-OPERATION                  03570041
035800         MOVE SPACES             TO AA-DB2-TABLE                  03580041
035900         PERFORM Z999-DB2-ABEND                                   03590041
036000     END-IF.                                                      03600041
036100                                                                  03610041
036200     IF WS-TMST > WS-HOLD-TMST                                    03620041
036300         IF NO-COMMITS-TAKEN                                      03630041
036400             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03640041
036500             PERFORM X600-UPDATE-TCKRSTCNTL                       03650041
036600             SET COMMITS-TAKEN TO TRUE                            03660041
036700         END-IF                                                   03670041
036800         PERFORM X700-UPDATE-TCKRSTINF                            03680041
036900         PERFORM Y100-COMMIT                                      03690041
037000         PERFORM X500-SET-CHECKPOINT-TIME                         03700041
037100     END-IF.                                                      03710041
037200                                                                  03720041
037300 EJECT                                                            03730041
037400*----------------------------------------------------------------*03740041
037500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03750041
037600*----------------------------------------------------------------*03760041
037700 X200-CHECKPOINT-RESTART.                                         03770041
037800                                                                  03780041
037900     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03790041
038000                                                                  03800041
038100     PERFORM X400-GET-CHECKPOINT-INFO.                            03810041
038200     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03820041
038300                                                                  03830041
038400     DISPLAY '** AHKUP030 CHECKPOINT RESTART **'                  03840041
038500     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03850041
038600              CR-EXTRACT-RECS-WORKED.                             03860041
038700     DISPLAY '***********************************************'    03870041
038800                                                                  03880041
038900     PERFORM R100-READ-EXTRACT-FILE                               03890041
039000         CR-EXTRACT-RECS-WORKED TIMES.                            03900041
039100     PERFORM R100-READ-EXTRACT-FILE.                              03910041
039200 EJECT                                                            03920041
039300*----------------------------------------------------------------*03930041
039400*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03940041
039500*----------------------------------------------------------------*03950041
039600 X300-GET-CHECKPOINT-CNTL.                                        03960041
039700                                                                  03970041
039800     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     03980041
039900                                                                  03990041
040000     PERFORM WITH TEST AFTER                                      04000041
040100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04010041
040200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04020041
040300                     SQLCODE = ZERO                               04030041
040400                                                                  04040041
040500             EXEC SQL                                             04050041
040600              SELECT CKPT_STAT_CODE                               04060041
040700               INTO :PV-CKPT-STAT-CODE                            04070041
040800               FROM TCKRSTCNTL                                    04080041
040900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04090041
041000             END-EXEC                                             04100041
041100                                                                  04110041
041200             EVALUATE TRUE                                        04120041
041300                 WHEN SQLCODE = ZERO                              04130041
041400                 WHEN SQLCODE = -904                              04140041
041500                 WHEN SQLCODE = -913                              04150041
041600                      CONTINUE                                    04160041
041700                                                                  04170041
041800                 WHEN SQLWARN0 NOT = SPACES                       04180041
041900                 WHEN SQLCODE  NOT = ZERO                         04190041
042000                     MOVE PV-CURRENT-PARAGRAPH                    04200041
042100                                         TO AA-PARAGRAPH-NAME     04210041
042200                     DISPLAY '******** PLAN_NAME:'                04220041
042300                              PV-PROGRAM-NAME                     04230041
042400                     MOVE SPACES TO AA-MESSAGE-1                  04240041
042500                                    AA-MESSAGE-2                  04250041
042600                     MOVE 'UNSUCCESSFUL SELECT'                   04260041
042700                                         TO AA-DB2-OPERATION      04270041
042800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04280041
042900                     PERFORM Z999-DB2-ABEND                       04290041
043000             END-EVALUATE                                         04300041
043100     END-PERFORM.                                                 04310041
043200                                                                  04320041
043300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04330041
043400         MOVE PV-CURRENT-PARAGRAPH                                04340041
043500                             TO AA-PARAGRAPH-NAME                 04350041
043600         DISPLAY '******** PLAN_NAME:'                            04360041
043700                  PV-PROGRAM-NAME                                 04370041
043800         MOVE SPACES TO AA-MESSAGE-1                              04380041
043900                        AA-MESSAGE-2                              04390041
044000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04400041
044100                             TO AA-DB2-OPERATION                  04410041
044200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04420041
044300         PERFORM Z999-DB2-ABEND                                   04430041
044400     END-IF.                                                      04440041
044500                                                                  04450041
044600 EJECT                                                            04460041
044700*----------------------------------------------------------------*04470041
044800*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04480041
044900*----------------------------------------------------------------*04490041
045000 X400-GET-CHECKPOINT-INFO.                                        04500041
045100                                                                  04510041
045200     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04520041
045300                                                                  04530041
045400     PERFORM WITH TEST AFTER                                      04540041
045500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04550041
045600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04560041
045700                     SQLCODE = ZERO                               04570041
045800                                                                  04580041
045900             EXEC SQL                                             04590041
046000              SELECT WORK_STRG_DESC                               04600041
046100               INTO :TCKRSTINF-WORK-STRG-DESC                     04610041
046200               FROM TCKRSTINF                                     04620041
046300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04630041
046400             END-EXEC                                             04640041
046500                                                                  04650041
046600             EVALUATE TRUE                                        04660041
046700                 WHEN SQLCODE = ZERO                              04670041
046800                 WHEN SQLCODE = -904                              04680041
046900                 WHEN SQLCODE = -913                              04690041
047000                      CONTINUE                                    04700041
047100                                                                  04710041
047200                 WHEN SQLWARN0 NOT = SPACES                       04720041
047300                 WHEN SQLCODE  NOT = ZERO                         04730041
047400                     MOVE PV-CURRENT-PARAGRAPH                    04740041
047500                                         TO AA-PARAGRAPH-NAME     04750041
047600                     DISPLAY '******** PLAN_NAME:'                04760041
047700                              PV-PROGRAM-NAME                     04770041
047800                     MOVE SPACES TO AA-MESSAGE-1                  04780041
047900                                    AA-MESSAGE-2                  04790041
048000                     MOVE 'UNSUCCESSFUL SELECT'                   04800041
048100                                         TO AA-DB2-OPERATION      04810041
048200                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04820041
048300                     PERFORM Z999-DB2-ABEND                       04830041
048400             END-EVALUATE                                         04840041
048500     END-PERFORM.                                                 04850041
048600                                                                  04860041
048700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04870041
048800         MOVE PV-CURRENT-PARAGRAPH                                04880041
048900                             TO AA-PARAGRAPH-NAME                 04890041
049000         DISPLAY '******** PLAN_NAME:'                            04900041
049100                  PV-PROGRAM-NAME                                 04910041
049200         MOVE SPACES TO AA-MESSAGE-1                              04920041
049300                        AA-MESSAGE-2                              04930041
049400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04940041
049500                             TO AA-DB2-OPERATION                  04950041
049600         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      04960041
049700         PERFORM Z999-DB2-ABEND                                   04970041
049800     END-IF.                                                      04980041
049900                                                                  04990041
050000 EJECT                                                            05000041
050100*----------------------------------------------------------------*05010041
050200*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05020041
050300*----------------------------------------------------------------*05030041
050400 X500-SET-CHECKPOINT-TIME.                                        05040041
050500                                                                  05050041
050600     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05060041
050700                                                                  05070041
050800     PERFORM WITH TEST AFTER                                      05080041
050900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05090041
051000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05100041
051100                     SQLCODE = ZERO                               05110041
051200                                                                  05120041
051300             EXEC SQL                                             05130041
051400              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05140041
051500               INTO :WS-HOLD-TMST                                 05150041
051600               FROM TCKRSTCNTL                                    05160041
051700               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05170041
051800             END-EXEC                                             05180041
051900                                                                  05190041
052000             EVALUATE TRUE                                        05200041
052100                 WHEN SQLCODE = ZERO                              05210041
052200                 WHEN SQLCODE = -904                              05220041
052300                 WHEN SQLCODE = -913                              05230041
052400                      CONTINUE                                    05240041
052500                                                                  05250041
052600                 WHEN SQLWARN0 NOT = SPACES                       05260041
052700                 WHEN SQLCODE  NOT = ZERO                         05270041
052800                     MOVE PV-CURRENT-PARAGRAPH                    05280041
052900                                         TO AA-PARAGRAPH-NAME     05290041
053000                     DISPLAY '******** PLAN_NAME:'                05300041
053100                              PV-PROGRAM-NAME                     05310041
053200                     MOVE SPACES TO AA-MESSAGE-1                  05320041
053300                                    AA-MESSAGE-2                  05330041
053400                     MOVE 'UNSUCCESSFUL SELECT'                   05340041
053500                                         TO AA-DB2-OPERATION      05350041
053600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05360041
053700                     PERFORM Z999-DB2-ABEND                       05370041
053800             END-EVALUATE                                         05380041
053900     END-PERFORM.                                                 05390041
054000                                                                  05400041
054100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05410041
054200         MOVE PV-CURRENT-PARAGRAPH                                05420041
054300                             TO AA-PARAGRAPH-NAME                 05430041
054400         DISPLAY '******** PLAN_NAME:'                            05440041
054500                  PV-PROGRAM-NAME                                 05450041
054600         MOVE SPACES TO AA-MESSAGE-1                              05460041
054700                        AA-MESSAGE-2                              05470041
054800         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05480041
054900                             TO AA-DB2-OPERATION                  05490041
055000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05500041
055100         PERFORM Z999-DB2-ABEND                                   05510041
055200     END-IF.                                                      05520041
055300                                                                  05530041
055400 EJECT                                                            05540041
055500*----------------------------------------------------------------*05550041
055600*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05560041
055700*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05570041
055800*----------------------------------------------------------------*05580041
055900 X600-UPDATE-TCKRSTCNTL.                                          05590041
056000                                                                  05600041
056100     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05610041
056200                                                                  05620041
056300     PERFORM WITH TEST AFTER                                      05630041
056400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05640041
056500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05650041
056600                     SQLCODE = ZERO                               05660041
056700                                                                  05670041
056800             EXEC SQL                                             05680041
056900                 UPDATE TCKRSTCNTL                                05690041
057000                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05700041
057100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05710041
057200             END-EXEC                                             05720041
057300                                                                  05730041
057400             EVALUATE TRUE                                        05740041
057500                 WHEN SQLCODE = ZERO                              05750041
057600                 WHEN SQLCODE = -904                              05760041
057700                 WHEN SQLCODE = -913                              05770041
057800                      CONTINUE                                    05780041
057900                                                                  05790041
058000                 WHEN SQLWARN0 NOT = SPACES                       05800041
058100                 WHEN SQLCODE  NOT = ZERO                         05810041
058200                     MOVE PV-CURRENT-PARAGRAPH                    05820041
058300                                         TO AA-PARAGRAPH-NAME     05830041
058400                     DISPLAY '******** PLAN_NAME:'                05840041
058500                              PV-PROGRAM-NAME                     05850041
058600                     MOVE SPACES TO AA-MESSAGE-1                  05860041
058700                                    AA-MESSAGE-2                  05870041
058800                     MOVE 'UNSUCCESSFUL UPDATE'                   05880041
058900                                         TO AA-DB2-OPERATION      05890041
059000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05900041
059100                     PERFORM Z999-DB2-ABEND                       05910041
059200             END-EVALUATE                                         05920041
059300     END-PERFORM.                                                 05930041
059400                                                                  05940041
059500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05950041
059600         MOVE PV-CURRENT-PARAGRAPH                                05960041
059700                             TO AA-PARAGRAPH-NAME                 05970041
059800         DISPLAY '******** PLAN_NAME:'                            05980041
059900                  PV-PROGRAM-NAME                                 05990041
060000         MOVE SPACES TO AA-MESSAGE-1                              06000041
060100                        AA-MESSAGE-2                              06010041
060200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06020041
060300                             TO AA-DB2-OPERATION                  06030041
060400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06040041
060500         PERFORM Z999-DB2-ABEND                                   06050041
060600     END-IF.                                                      06060041
060700                                                                  06070041
060800     EJECT                                                        06080041
060900*----------------------------------------------------------------*06090041
061000*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06100041
061100*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06110041
061200*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06120041
061300*----------------------------------------------------------------*06130041
061400 X700-UPDATE-TCKRSTINF.                                           06140041
061500                                                                  06150041
061600     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06160041
061700                                                                  06170041
061800     MOVE PV-TINVOIC-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06180041
061900     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06190041
062000     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06200041
062100                                                                  06210041
062200     PERFORM WITH TEST AFTER                                      06220041
062300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06230041
062400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06240041
062500                     SQLCODE = ZERO                               06250041
062600                                                                  06260041
062700             EXEC SQL                                             06270041
062800                 UPDATE TCKRSTINF                                 06280041
062900                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06290041
063000                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06300041
063100             END-EXEC                                             06310041
063200                                                                  06320041
063300             EVALUATE TRUE                                        06330041
063400                 WHEN SQLCODE = ZERO                              06340041
063500                 WHEN SQLCODE = -904                              06350041
063600                 WHEN SQLCODE = -913                              06360041
063700                      CONTINUE                                    06370041
063800                                                                  06380041
063900                 WHEN SQLWARN0 NOT = SPACES                       06390041
064000                 WHEN SQLCODE  NOT = ZERO                         06400041
064100                     MOVE PV-CURRENT-PARAGRAPH                    06410041
064200                                         TO AA-PARAGRAPH-NAME     06420041
064300                     DISPLAY '******** PLAN_NAME:'                06430041
064400                              PV-PROGRAM-NAME                     06440041
064500                     MOVE SPACES TO AA-MESSAGE-1                  06450041
064600                                    AA-MESSAGE-2                  06460041
064700                     MOVE 'UNSUCCESSFUL UPDATE'                   06470041
064800                                         TO AA-DB2-OPERATION      06480041
064900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06490041
065000                     PERFORM Z999-DB2-ABEND                       06500041
065100             END-EVALUATE                                         06510041
065200     END-PERFORM.                                                 06520041
065300                                                                  06530041
065400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06540041
065500         MOVE PV-CURRENT-PARAGRAPH                                06550041
065600                             TO AA-PARAGRAPH-NAME                 06560041
065700         DISPLAY '******** PLAN_NAME:'                            06570041
065800                  PV-PROGRAM-NAME                                 06580041
065900         MOVE SPACES TO AA-MESSAGE-1                              06590041
066000                        AA-MESSAGE-2                              06600041
066100         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06610041
066200                             TO AA-DB2-OPERATION                  06620041
066300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06630041
066400         PERFORM Z999-DB2-ABEND                                   06640041
066500     END-IF.                                                      06650041
066600                                                                  06660041
066700 EJECT                                                            06670041
066800                                                                  06680041
066900*----------------------------------------------------------------*06690041
067000*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06700041
067100*----------------------------------------------------------------*06710041
067200 Y100-COMMIT.                                                     06720041
067300                                                                  06730041
067400     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06740041
067500                                                                  06750041
067600     EXEC SQL                                                     06760041
067700         COMMIT                                                   06770041
067800     END-EXEC.                                                    06780041
067900                                                                  06790041
068000     EVALUATE TRUE                                                06800041
068100         WHEN SQLCODE = ZEROS                                     06810041
068200             CONTINUE                                             06820041
068300         WHEN OTHER                                               06830041
068400             MOVE PV-CURRENT-PARAGRAPH                            06840041
068500                                 TO AA-PARAGRAPH-NAME             06850041
068600             MOVE SPACES TO AA-MESSAGE-1                          06860041
068700                            AA-MESSAGE-2                          06870041
068800             MOVE 'UNSUCCESSFUL COMMIT'                           06880041
068900                                 TO AA-DB2-OPERATION              06890041
069000             MOVE SPACES         TO AA-DB2-TABLE                  06900041
069100             PERFORM Z999-DB2-ABEND                               06910041
069200     END-EVALUATE.                                                06920041
069300 EJECT                                                            06930041
069400 Z900-PROCESS-ABEND.                                              06940041
069500                                                                  06950041
069600     DISPLAY '*** ABEND'.                                         06960041
069700     DISPLAY '*** PROGRAM   = AHKUP030'.                          06970041
069800     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             06980041
069900     DISPLAY AA-MESSAGE-LINE-1.                                   06990041
070000     DISPLAY AA-MESSAGE-LINE-2.                                   07000041
070100     COPY DPPD004.                                                07010041
070200     CALL 'ILBOABN0' USING ABEND-CODE.                            07020041
070300                                                                  07030041
070400                                                                  07040041
070500                                                                  07050041
070600 Z999-DB2-ABEND.                                                  07060041
070700                                                                  07070041
070800     DISPLAY AA-ABEND-LIT.                                        07080041
070900     DISPLAY AA-DB2-ERROR-LIT.                                    07090041
071000     DISPLAY AA-PROGRAM-LIT.                                      07100041
071100     DISPLAY AA-PARAGRAPH-LIT.                                    07110041
071200     DISPLAY AA-DB2-OPERATION-LIT.                                07120041
071300     DISPLAY AA-DB2-TABLE.                                        07130041
071400     SET AC-DB2-ERROR TO TRUE.                                    07140041
071500                                                                  07150041
071600     COPY DPPD004.                                                07160041
071700                                                                  07170041
071800     CALL 'ILBOABN0' USING ABEND-CODE.                            07180041
