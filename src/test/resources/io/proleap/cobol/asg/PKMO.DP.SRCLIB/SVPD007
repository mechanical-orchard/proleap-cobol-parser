000100******************************************************************00010000
000200* SVPD007                                                         00020000
000300*  THIS COPYBOOK IS TO BE USED TO FORMAT STORED VALUE CARD        00030000
000400*  INPUTED FROM 10 TO 30 DIGITS, WITH LEADING SPACES OR ZEROES    00040000
000500*  AND FORMAT INTO THE FOLLOWING 30 DIGIT STRUCTURE, leading zeros00050000
000510*                                                                 00110000
000600*  1-11 SV007-UPC-NBR   9(11)                                     00060000
000700* 12-17 SV007-BIN-NBR   9(6)                                      00070000
000800* 18    SV007-CARD-TYPE 9(1)                                      00080000
000900* 19-30 SV007-CARD-NBR  9(12)                                     00090000
001000* Note: input 13 digit card converted droping 1st 2 and last digit00100000
001100*                                                                 00110000
001200*  INCLUDE SVWS007 (WORKING STORAGE)                              00120000
001210*  INCLUDE COPY DPWS040I (WORKING STORAGE)                        00120000
001300*  IN ANY PROGRAM THAT INCLUDES THIS MODULE                       00130000
001400*                                                                 00140000
001500* ****** FORMAT INPUTTED CARD *****************                   00150000
001600*  MOVE CARD FROM SCREEN             TO SV007-CARD-NUMBER-IN      00160000
001700*  MOVE FROM INTERNAL NUMERIC FORMAT TO SV007-CARD-NUMBER9-IN     00170000
001800*  SET SV007-FORMAT-IN               TO TRUE                      00180000
001900*  PERFORM SV007-FORMAT-CARD                                      00190000
002000*                                                                 00200000
002100*  **** MOVE RESULTING FIELDS ***************                     00210000
002200*  MOVE SV007-CARD-NUMBER            TO <X(30) FIELD>             00220000
002300*  MOVE SV007-CARD-NUMBER9     RESULTING INTERNAL FORMAT 9(30)    00230000
002400* or                                                              00240000
002500*  MOVE SV007-CARD-NBR               TO (12 or 13 numeric)        00250000
002600*                                                                 00260000
002700* **** FORMAT FOR DISPLAY *********************************       00270000
002800* TO DISPLAY CARD LEFT JUSTIFIED AS 10, 12, 19, OR 30 DIGIT CARD  00280000
002900* Note: 13 input card is display as a converted 10 digit card     00290000
003000*                                                                 00300000
003100* 1) to display formatted card in SV007-CARD-NUMBER               00310000
003200*    In first call, for both format & display, do the following:  00320000
003300*     SET SV007-FORMAT-BOTH       TO TRUE                         00330000
003400* 2) or make a 2nd call                                           00340000
003500*     SET SV007-FORMAT-DISPLAY    TO TRUE                         00350000
003600*     PERFORM SV007-FORMAT-CARD                                   00360000
003700* 3) or move formatted card number                                00370000
003800*     MOVE ASC-CRD-NUMBER         TO SV007-CARD-NUMBER9           00380000
003900*     SET SV007-FORMAT-DISPLAY    TO TRUE                         00390000
004000*     PERFORM SV007-FORMAT-CARD                                   00400000
004100*     SET SV007-FORMAT-BOTH       TO TRUE                         00410000
004200* 4) for screens that only display 13 digits on screen            00420000
004300*     MOVE ASC-CRD-NUMBER         TO SV007-CARD-NUMBER9           00430000
004400*     MOVE 13                     TO SV007-CARD-NUMBER-DIS-LENGTH 00440000
004500*     SET SV007-FORMAT-DISPLAY    TO TRUE                         00450000
004600*     PERFORM SV007-FORMAT-CARD                                   00460000
004700*                                                                 00470000
004800******************************************************************00480000
004900 SV007-FORMAT-CARD.                                               00490000
005000                                                                  00500000
005100     SET SV007-NOT-FORMAT-ERROR TO TRUE.                          00510000
005200     IF SV007-FORMAT-IN OR SV007-FORMAT-BOTH                      00520000
005300         PERFORM SV007-FORMAT-CARD-IN.                            00530000
005400                                                                  00540000
005500     IF SV007-FORMAT-DISPLAY OR SV007-FORMAT-BOTH                 00550000
005600         PERFORM SV007-FORMAT-CARD-DISPLAY.                       00560000
005700                                                                  00570000
005800                                                                  00580000
005900 SV007-FORMAT-CARD-IN.                                            00590000
006000                                                                  00600000
006100* if card number lenght has not been set befor call               00610000
006200* then right justify as 30 digits with leading zeroes             00620000
006300                                                                  00630000
006400     IF SV007-CARD-NUMBER-LENGTH = 0                              00640000
006500* replace any leading spaces with zeros                           00650000
006600       INSPECT SV007-CARD-NUMBER-IN REPLACING LEADING " " BY "0"  00660000
006700       MOVE 0                        TO SV007-LEADING-0-CNT       00670000
006800* count trailing spaces to determine what to right justify        00680000
006900       INSPECT SV007-CARD-NUMBER-IN                               00690000
007000            TALLYING SV007-LEADING-0-CNT FOR ALL " "              00700000
007100* compute actual in length                                        00710000
007200       COMPUTE SV007-CARD-NUMBER-IN-LENGTH =                      00720000
007300               SV007-MAX-CARD-NBR-LENGTH -                        00730000
007400               SV007-LEADING-0-CNT                                00740000
007500     ELSE                                                         00750000
007600       MOVE SV007-CARD-NUMBER-LENGTH                              00760000
007700         TO SV007-CARD-NUMBER-IN-LENGTH                           00770000
007800     END-IF.                                                      00780000
007900                                                                  00790000
008000* compute position of move to right justify                       00800000
008100     COMPUTE SV007-CARD-COL-TO =                                  00810000
008200             (30 - SV007-CARD-NUMBER-IN-LENGTH) + 1               00820000
008300* move all zeroes to work area to right justify                   00830000
008400     MOVE ALL "0"                  TO SV007-CARD-JUSTIFIED        00840000
008500* move input card to formatted card, right justified              00850000
008600     MOVE SV007-CARD-NUMBER-IN(1:SV007-CARD-NUMBER-IN-LENGTH)     00860000
008700       TO SV007-CARD-JUSTIFIED(SV007-CARD-COL-TO:)                00870000
008800     IF SV007-CARD-NUMBER-LENGTH = 0                              00880000
008900* count leading zeroes to determine length of card                00890000
009000       MOVE 0                        TO SV007-LEADING-0-CNT       00900000
009100       INSPECT SV007-CARD-JUSTIFIED                               00910000
009200          TALLYING SV007-LEADING-0-CNT FOR LEADING "0"            00920000
009300       COMPUTE SV007-CARD-NUMBER-LENGTH =                         00930000
009400               SV007-MAX-CARD-NBR-LENGTH -                        00940000
009500               SV007-LEADING-0-CNT                                00950000
009600     END-IF.                                                      00960000
009700                                                                  00970000
009800* re-determine input card length, allowing for leading zeroes     00980000
009900* in 10, 12, 19, and 30 digit cards                               00990000
010000     EVALUATE TRUE                                                01000000
010100* 10 digit card for 1 to 10 digits                                01010000
010200       WHEN SV007-CARD-NUMBER-LENGTH < 11                         01020000
010300         MOVE 10                     TO SV007-CARD-NUMBER-LENGTH  01030000
010400* 12 digit card for 11 & 12 digits                                01040000
010500       WHEN SV007-CARD-NUMBER-LENGTH < 13                         01050000
010600         MOVE 12                     TO SV007-CARD-NUMBER-LENGTH  01060000
010700* 13 digit stays 13                                               01070000
010800       WHEN SV007-CARD-NUMBER-LENGTH = 13                         01080000
010900         CONTINUE                                                 01090000
011000* 19 digit card for 14 to 19 digits                               01100000
011100       WHEN SV007-CARD-NUMBER-LENGTH < 20                         01110000
011200         MOVE 19                     TO SV007-CARD-NUMBER-LENGTH  01120000
011300* 30 digit card for 20 to 30 digits                               01130000
011400       WHEN OTHER                                                 01140000
011500         MOVE 30 TO SV007-CARD-NUMBER-LENGTH                      01150000
011600     END-EVALUATE.                                                01160000
011700                                                                  01170000
011800* move to formatted card based on length                          01180000
011900     MOVE ZEROES                     TO SV007-CARD-NUMBER9        01190000
012000     EVALUATE TRUE                                                01200000
012100       WHEN SV007-CARD-NUMBER-LENGTH = 13                         01210000
012200* move bytes 10 bytes of 13 digits droping 1st 2, and last digit  01220000
012300         MOVE SV007-CARD-13-JUST-10                               01230000
012400                                     TO SV007-CARD-10-OUT         01240000
012500       WHEN SV007-CARD-NUMBER-LENGTH = 19                         01250000
012600* for 19 digit safeway card type = 2, treat as a 13 digit card    01260000
012700        AND SV007-CARD-JUST-BIN = SV007-SAFEWAY-BIN               01270000
012800        AND SV007-CARD-TYPE-JUST = 2                              01280000
012900         MOVE SV007-CARD-13-JUST-10                               01290000
013000                                     TO SV007-CARD-10-OUT         01300000
013100         MOVE 13                     TO SV007-CARD-NUMBER-LENGTH  01310000
013200       WHEN SV007-CARD-NUMBER-LENGTH = 30                         01320000
013300* for 30 digit safeway card type = 2, treat as a 13 digit card    01330000
013400        AND SV007-CARD-JUST-BIN = SV007-SAFEWAY-BIN               01340000
013500        AND SV007-CARD-TYPE-JUST = 2                              01350000
013600         MOVE SV007-CARD-13-JUST-10                               01360000
013700                                     TO SV007-CARD-10-OUT         01370000
013800         MOVE 13                     TO SV007-CARD-NUMBER-LENGTH  01380000
013900       WHEN OTHER                                                 01390000
014000* otherwise the justifed 30 digits are move to 30 digit card      01400000
014100         MOVE SV007-CARD-JUSTIFIED   TO SV007-CARD-NUMBER         01410000
014200     END-EVALUATE.                                                01420000
014300                                                                  01430000
014400     IF SV007-CARD-NUMBER NOT NUMERIC                             01440000
014500       SET SV007-FORMAT-ERROR        TO TRUE.                     01450000
                                                                                
014700* ---------------------------------------------------------               
                                                                                
014800 SV007-FORMAT-CARD-DISPLAY.                                               
014900                                                                  01490000
014901     INSPECT SV007-CARD-NUMBER REPLACING ALL " " BY "0"           01490000
                                                                                
015000* left justify as 10, 12, 19, or 30 digit card                    01500000
015100                                                                  01510000
015200     EVALUATE TRUE                                                01520000
015300* display blank card                                              01530000
015400       WHEN SV007-CARD-NUMBER9 = ZEROES                           01540000
015500         MOVE SPACES                 TO SV007-CARD-NUMBER-DISPLAY 01550000
015600* display 10 digit card                                                   
015900       WHEN SV007-CARD-12-OUT2 = "00"                             01590000
                 IF SV007-CARD-10-OUT = SV007-CARD-13-JUST-10                   
                    MOVE SV007-CARD-13-JUST TO SV007-CARD-NUMBER-DISPLAY        
                 ELSE                                                           
                    MOVE SV007-CARD-10-OUT  TO SV007-CARD-NUMBER-DISPLAY        
                 END-IF                                                         
016100* display 12 digit card                                           01610000
016200       WHEN SV007-CARD-OUT-UPC = ZEROES                           01620000
016300        AND SV007-CARD-OUT-BIN = ZEROES                           01630000
               IF SV007-CARD-TYPE-OUT NOT = "2"                                 
016400           MOVE SV007-CARD-12-OUT    TO SV007-CARD-NUMBER-DISPLAY 01640000
               ELSE                                                             
016100* display 13 digit card                                           01610000
                 MOVE SV007-CARD-13-OUT    TO SV007-CARD-NUMBER-DISPLAY         
               END-IF                                                           
016500* display 19 digit card                                           01650000
016600       WHEN SV007-CARD-OUT-UPC = ZEROES                           01660000
016700         IF SV007-CARD-NUMBER-DIS-LENGTH = 30                     01670000
016800           MOVE SV007-CARD-19-OUT    TO SV007-CARD-NUMBER-DISPLAY 01680000
016900         ELSE                                                     01690000
      * display 13 digit card                                                   
017000           MOVE SV007-CARD-12-OUT    TO SV007-CARD-NUMBER-DISPLAY 01700000
017100         END-IF                                                   01710000
017200* display 30 digit card                                           01720000
017300       WHEN OTHER                                                 01730000
017400         IF SV007-CARD-NUMBER-DIS-LENGTH = 30                     01740000
017500           MOVE SV007-CARD-NUMBER    TO SV007-CARD-NUMBER-DISPLAY 01750000
017600         ELSE                                                     01760000
017700           MOVE SV007-CARD-12-OUT    TO SV007-CARD-NUMBER-DISPLAY 01770000
017800         END-IF                                                   01780000
017900     END-EVALUATE.                                                01790000
                                                                                
                                                                                
