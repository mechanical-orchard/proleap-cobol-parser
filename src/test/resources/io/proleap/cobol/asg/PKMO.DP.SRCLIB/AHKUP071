000100 IDENTIFICATION DIVISION.                                         00010006
000200 PROGRAM-ID.         AHKUP071.                                    00020014
000300 AUTHOR.             AYAN (COGNIZANT).                            00030006
000400 DATE-WRITTEN.       JAN 2014.                                    00040016
000500 DATE-COMPILED.                                                   00050006
000600*************************************************************     00060006
000700*   AHKUP071 - ARCHIVE HISTORY DATA DELETION - TAURECD      *     00070016
000800*                                                           *     00080016
000900*   PROGRAM OVERVIEW:                                       *     00090016
001000*                                                           *     00100016
001100*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TAURECD.  *     00110016
001200*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00120016
001300*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00130016
001400*                                                           *     00140016
001500*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00150016
001600*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00160016
001700*                                                           *     00170016
002200*   DB2 TABLES:                                             *     00220016
002300*                                                           *     00230016
002400*        TAURECD    - RECEIPT DISTRIBUTION AUDIT TABLE      *     00240016
002500*        TCKRSTINF  - CHECKPOINT/RESTART INFO TABLE         *     00250016
002600*        TCKRSTCNTL - CHECKPOINT/RESTART CONTROL TABLE      *     00260016
002700*                                                           *     00270016
002800*************************************************************     00280016
002900*                                                           *     00290016
003000*************************************************************     00300016
003100 EJECT                                                            00310016
003200 ENVIRONMENT DIVISION.                                            00320016
003300 CONFIGURATION SECTION.                                           00330016
003400 SOURCE-COMPUTER.        IBM-370.                                 00340016
003500 OBJECT-COMPUTER.        IBM-370.                                 00350016
003600                                                                  00360016
003700 INPUT-OUTPUT SECTION.                                            00370016
003800 FILE-CONTROL.                                                    00380016
003900     SELECT TAURECD-SORTED-FILE ASSIGN TO INP01.                  00390016
004000                                                                  00400016
004100 DATA DIVISION.                                                   00410016
004200 FILE SECTION.                                                    00420016
004300 FD  TAURECD-SORTED-FILE                                          00430016
004400     RECORDING MODE IS F                                          00440016
004500     LABEL RECORDS ARE STANDARD                                   00450016
004600     BLOCK CONTAINS 0 RECORDS                                     00460016
004700     RECORD CONTAINS 12  CHARACTERS                               00470016
004800     DATA RECORD IS TAURECD-SORTED-DATA.                          00480016
004900 01  TAURECD-SORTED-DATA       PIC X(12).                         00490016
005000                                                                  00500016
005100                                                                  00510016
005200 EJECT                                                            00520016
005300 WORKING-STORAGE SECTION.                                         00530016
005400                                                                  00540016
005500 01  FILLER                       PIC X(58)     VALUE             00550016
005600     '************WORKING STORAGE STARTS HERE*******************'.00560016
005700                                                                  00570016
005800 01  PV-PROGRAM-VARIABLES.                                        00580016
005900     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP071'.  00590016
006000     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00600016
006100     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00610016
006200     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00620016
006300                                                                  00630016
006400     05  PV-TAURECD-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00640016
006500                                               COMP-3.            00650016
006600     05  PV-TAURECD-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00660016
006700                                               COMP-3.            00670016
006800     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00680016
006900                                               COMP-3.            00690016
007000     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00700016
007100                                               COMP-3.            00710016
007200     05  PV-DISP-ORD-NBR          PIC X(09)    VALUE SPACES.      00720016
007300     05  PV-DISP-ORD-LNE-NBR      PIC X(09)    VALUE SPACES.      00730016
007400     05  PV-DISP-REC-SEQ-NBR      PIC X(09)    VALUE SPACES.      00740016
007500                                                                  00750016
007600* TAURECD SORTED FILE LAYOUT                                      00760016
007700                                                                  00770016
007800     05  PV-INPUT-REC.                                            00780016
007900         10  PV-INP-ORD-NBR       PIC S9(09)   VALUE ZERO         00790016
008000                                               COMP.              00800016
008100         10  PV-INP-ORD-LNE-NBR   PIC S9(09)   VALUE ZERO         00810016
008200                                               COMP.              00820016
008300         10  PV-INP-RCV-SEQ-NBR   PIC S9(09)   VALUE ZERO         00830016
008400                                               COMP.              00840016
008500                                                                  00850006
008600 01  PC-PROGRAM-CONSTANTS.                                        00860006
008700     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00870006
008800                                                COMP SYNC.        00880006
008900     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00890006
009000     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00900006
009100     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00910006
009200                                                                  00920006
009300 01  PS-PROGRAM-SWITCHES.                                         00930006
009400     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00940006
009500         88  COMMITS-TAKEN                      VALUE 'T'.        00950006
009600         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00960006
009700     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00970006
009800         88  MORE-EXTRACT                       VALUE 'M'.        00980006
009900         88  END-OF-EXTRACT                     VALUE 'E'.        00990006
010000     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        01000006
010100         88  NORMAL-RUN                         VALUE '0'.        01010006
010200         88  RESTART-RUN                        VALUE '9'.        01020006
010300                                                                  01030006
010400 01  WS-COUNTER.                                                  01040006
010500     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01050006
010600     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01060006
010700                                                                  01070006
010800 01  CKPT-RESTART-INFO.                                           01080006
010900     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01090006
011000                                                                  01100006
011100*----------------------------------------------------------------*01110006
011200*  ABEND DATA AREAS                                              *01120006
011300*----------------------------------------------------------------*01130006
011400 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01140006
011500                                             COMP SYNC.           01150006
011800     88  AC-DB2-ERROR                        VALUE +4013.         01160006
012000                                                                  01170006
012100                                                                  01180006
012200 01  ABEND-AREAS.                                                 01190006
012300     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01200006
012400             '*****       ABEND'.                                 01210006
012500     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01220006
012600             '*****   PROGRAM: AHKUP071'.                         01230014
012700     05  AA-PARAGRAPH-LIT.                                        01240006
012800         10  FILLER              PIC  X(17)  VALUE                01250006
012900             '***** PARAGRAPH: '.                                 01260006
013000         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01270006
013100     05  AA-MESSAGE-LINE-1.                                       01280006
013200         10  FILLER              PIC  X(06)  VALUE '*****'.       01290006
013300         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01300006
013400     05  AA-MESSAGE-LINE-2.                                       01310006
013500         10  FILLER              PIC  X(06)  VALUE '*****'.       01320006
013600         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01330006
013700     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01340006
013800             '*****    DB2 ERROR'.                                01350006
013900     05  AA-DB2-OPERATION-LIT.                                    01360006
014000         10  FILLER              PIC  X(17)  VALUE                01370006
014100             '***** OPERATION: '.                                 01380006
014200         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01390006
014300     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01400006
014400     EJECT                                                        01410006
014500                                                                  01420006
014600     COPY DPWS004.                                                01430006
014700     EJECT                                                        01440006
014800*----------------------------------------------------------------*01450006
014900*      TAURECD TABLE LAYOUT                                       01460006
015000*----------------------------------------------------------------*01470006
015100         EXEC SQL                                                 01480006
015200             INCLUDE TAURECD                                      01490006
015300         END-EXEC.                                                01500006
015400                                                                  01510006
015500*----------------------------------------------------------------*01520006
015600*      TCKRSTCNTL TABLE LAYOUT                                    01530006
015700*----------------------------------------------------------------*01540006
015800         EXEC SQL                                                 01550006
015900             INCLUDE TCKRSTCN                                     01560006
016000         END-EXEC.                                                01570006
016100                                                                  01580006
016200*----------------------------------------------------------------*01590006
016300*      TCKRSTINF TABLE LAYOUT                                     01600006
016400*----------------------------------------------------------------*01610006
016500         EXEC SQL                                                 01620006
016600             INCLUDE TCKRSTIN                                     01630006
016700         END-EXEC.                                                01640006
016800 EJECT                                                            01650006
016900*----------------------------------------------------------------*01660006
017000*  DB2 COMMUNICATION AREA                                         01670006
017100*----------------------------------------------------------------*01680006
017200*                                                                 01690006
017300     EXEC SQL                                                     01700006
017400         INCLUDE SQLCA                                            01710006
017500     END-EXEC.                                                    01720006
017600                                                                  01730006
017700*----------------------------------------------------------------*01740006
017800*  DB2 COMMUNICATION AREA2                                        01750006
017900*----------------------------------------------------------------*01760006
018000*                                                                 01770006
018100     COPY SQLCA2.                                                 01780006
018200     EJECT                                                        01790006
018300 PROCEDURE DIVISION.                                              01800006
018400 A100-MAINLINE-ROUTINE.                                           01810006
018500                                                                  01820006
018600     PERFORM B100-INITIALIZATION.                                 01830006
018700                                                                  01840006
018800     PERFORM B200-TAURECD-SORTED-PROCESS                          01850013
018900       UNTIL END-OF-EXTRACT.                                      01860006
019000                                                                  01870006
019100     PERFORM B300-EOJ-PROCESSING.                                 01880006
019200                                                                  01890006
019300     GOBACK.                                                      01900006
019400 EJECT                                                            01910006
019500 B100-INITIALIZATION.                                             01920006
019600                                                                  01930006
019700     EXEC SQL                                                     01940006
019800         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01950006
019900     END-EXEC.                                                    01960006
020000                                                                  01970006
020100     PERFORM X300-GET-CHECKPOINT-CNTL.                            01980006
020200     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01990006
020300                                                                  02000006
020400     OPEN INPUT TAURECD-SORTED-FILE.                              02010010
020500                                                                  02020006
020600     IF RESTART-RUN                                               02030006
020700         PERFORM X200-CHECKPOINT-RESTART                          02040006
020800     ELSE                                                         02050006
020900         PERFORM R100-READ-SORTED-FILE                            02060012
021000     END-IF.                                                      02070006
021100                                                                  02080006
021200     PERFORM X500-SET-CHECKPOINT-TIME.                            02090006
021300                                                                  02100006
021400                                                                  02110006
021500     EJECT                                                        02120006
021600 B200-TAURECD-SORTED-PROCESS.                                     02130013
021700                                                                  02140006
021800     MOVE PV-INP-ORD-NBR            TO PV-DISP-ORD-NBR.           02150011
021900     MOVE PV-INP-ORD-LNE-NBR        TO PV-DISP-ORD-LNE-NBR.       02160007
022000     MOVE PV-INP-RCV-SEQ-NBR        TO PV-DISP-REC-SEQ-NBR.       02170007
022100                                                                  02180006
022200     PERFORM D100-DELETE-TAURECD.                                 02190002
022300                                                                  02200001
022400     PERFORM X100-CHECKPOINT-CHECK.                               02210001
022500                                                                  02220001
022600     PERFORM R100-READ-SORTED-FILE.                               02230012
022700     EJECT                                                        02240001
022800                                                                  02250001
022900                                                                  02260001
023000 B300-EOJ-PROCESSING.                                             02270001
023100                                                                  02280001
023200     DISPLAY '** AHKUP071 SUMMARY **'.                            02290014
023300     DISPLAY '** TAURECD INPUT RECORDS COUNT          = '         02300011
023400                                         PV-TAURECD-INPUT-COUNT.  02310011
023500     DISPLAY '** TAURECD DELETE QUERY EXECUTION COUNT = '         02320011
023600                                         PV-TAURECD-DELETE-COUNT. 02330011
023700     DISPLAY '** SQL DELETE RECORDS COUNT             = '         02340011
023800                                         PV-SQL-DELETE-COUNT.     02350011
023900                                                                  02360001
024000     CLOSE  TAURECD-SORTED-FILE.                                  02370010
024100                                                                  02380001
024200     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02390001
024300     PERFORM X600-UPDATE-TCKRSTCNTL.                              02400001
024400                                                                  02410001
024500     EJECT                                                        02420001
024600*----------------------------------------------------------------*02430001
024700*    DELETES FROM THE TAURECD TABLE. NO OTHER TABLES REFERENCE   *02440002
024800*    THIS TABLE.                                                 *02450001
024900*----------------------------------------------------------------*02460006
025000 D100-DELETE-TAURECD.                                             02470006
025100                                                                  02480006
025200     MOVE 'D100-DELETE-TAURECD' TO PV-CURRENT-PARAGRAPH.          02490006
025300                                                                  02500007
025400     MOVE PV-INP-ORD-NBR        TO AURECD-ORD-NBR                 02510007
025500     MOVE PV-INP-RCV-SEQ-NBR    TO AURECD-REC-SEQ-NBR             02520007
025600     MOVE PV-INP-ORD-LNE-NBR    TO AURECD-ORD-LNE-NBR             02530007
025700                                                                  02540006
025800     PERFORM WITH TEST AFTER                                      02550006
025900        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02560006
026000          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02570006
026100             OR SQLCODE = ZERO                                    02580006
026200             OR SQLCODE = +100                                    02590006
026300                                                                  02600006
026400         EXEC SQL                                                 02610006
026500              DELETE                                              02620006
026600                FROM TAURECD                                      02630006
026700               WHERE ORD_NBR     = :AURECD-ORD-NBR                02640006
026800                 AND REC_SEQ_NBR = :AURECD-REC-SEQ-NBR            02650007
026900                 AND ORD_LNE_NBR = :AURECD-ORD-LNE-NBR            02660003
027000         END-EXEC                                                 02670001
027100                                                                  02680001
027200         EVALUATE TRUE                                            02690001
027300                                                                  02700006
027400             WHEN SQLCODE = ZERO                                  02710001
027500                 ADD +1              TO PV-TAURECD-DELETE-COUNT   02720017
027600                 MOVE SQLERRD(3)     TO PV-SQLERRD3               02730017
027700                 ADD PV-SQLERRD3     TO PV-SQL-DELETE-COUNT       02740017
027800                                                                  02750001
027900             WHEN SQLCODE = +100                                  02760006
028000             WHEN SQLCODE = -904                                  02770001
028100             WHEN SQLCODE = -913                                  02780001
028200                  CONTINUE                                        02790001
028300                                                                  02800001
028400             WHEN SQLWARN0 NOT = SPACES                           02810006
028500             WHEN SQLCODE  NOT = ZERO                             02820006
028600                 MOVE PV-CURRENT-PARAGRAPH                        02830006
028700                                     TO AA-PARAGRAPH-NAME         02840006
028800                 DISPLAY '******** ORD NBR:'                      02850006
028900                          PV-DISP-ORD-NBR                         02860006
029000                 DISPLAY '******** ORD LNE NBR:'                  02870006
029100                          PV-DISP-ORD-LNE-NBR                     02880006
029200                 DISPLAY '******** REC SEQ NBR :'                 02890006
029300                          PV-DISP-REC-SEQ-NBR                     02900006
029400                 MOVE SPACES TO AA-MESSAGE-1                      02910006
029500                                AA-MESSAGE-2                      02920006
029600                 MOVE 'UNSUCCESSFUL DELETE'                       02930006
029700                                     TO AA-DB2-OPERATION          02940006
029800                 MOVE 'TAURECD'      TO AA-DB2-TABLE              02950006
029900                 PERFORM Z999-DB2-ABEND                           02960006
030000                                                                  02970006
030100         END-EVALUATE                                             02980006
030200                                                                  02990006
030300     END-PERFORM.                                                 03000006
030400                                                                  03010006
030500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03020006
030600         MOVE PV-CURRENT-PARAGRAPH   TO AA-PARAGRAPH-NAME         03030017
030800         DISPLAY '******** ORD NBR:'                              03050006
030900                          PV-DISP-ORD-NBR                         03060006
031000         DISPLAY '******** ORD LNE NBR:'                          03070006
031100                          PV-DISP-ORD-LNE-NBR                     03080006
031200         DISPLAY '******** REC SEQ NBR :'                         03090006
031300                          PV-DISP-REC-SEQ-NBR                     03100006
031400         MOVE SPACES TO AA-MESSAGE-1                              03110006
031500                        AA-MESSAGE-2                              03120006
031600         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03130006
031700                                     TO AA-DB2-OPERATION          03140017
031800         MOVE 'TAURECD'              TO AA-DB2-TABLE              03150017
031900         PERFORM Z999-DB2-ABEND                                   03160006
032000     END-IF.                                                      03170006
032100                                                                  03180006
032200     EJECT                                                        03190006
032300 R100-READ-SORTED-FILE.                                           03200012
032400                                                                  03210006
032500     READ TAURECD-SORTED-FILE                                     03220009
032600          INTO PV-INPUT-REC                                       03230007
032700          AT END SET END-OF-EXTRACT  TO TRUE.                     03240017
032800                                                                  03250006
032900     IF MORE-EXTRACT                                              03260006
033000         ADD 1                       TO PV-TAURECD-INPUT-COUNT    03270017
033100     END-IF.                                                      03280006
033200                                                                  03290006
033300                                                                  03300006
033400     EJECT                                                        03310006
033500*----------------------------------------------------------------*03320006
033600*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03330006
033700*----------------------------------------------------------------*03340006
033800 X100-CHECKPOINT-CHECK.                                           03350006
033900                                                                  03360006
034000     MOVE 'X100-CHECKPOINT-CHECK'    TO PV-CURRENT-PARAGRAPH.     03370017
034100                                                                  03380006
034200     EXEC SQL                                                     03390006
034300       SET :WS-TMST = CURRENT TIMESTAMP                           03400006
034400     END-EXEC.                                                    03410006
034500                                                                  03420006
034600     IF SQLCODE = +0                                              03430006
034700         CONTINUE                                                 03440006
034800     ELSE                                                         03450006
034900         MOVE PV-CURRENT-PARAGRAPH   TO AA-PARAGRAPH-NAME         03460017
035100         MOVE SPACES                 TO AA-MESSAGE-1              03480017
035200                                        AA-MESSAGE-2              03490017
035300         MOVE 'BAD SET COMMAND'      TO AA-DB2-OPERATION          03500017
035500         MOVE SPACES                 TO AA-DB2-TABLE              03520017
035600         PERFORM Z999-DB2-ABEND                                   03530006
035700     END-IF.                                                      03540006
035800                                                                  03550006
035900     IF WS-TMST > WS-HOLD-TMST                                    03560006
036000         IF NO-COMMITS-TAKEN                                      03570006
036100             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03580006
036200             PERFORM X600-UPDATE-TCKRSTCNTL                       03590006
036300             SET COMMITS-TAKEN       TO TRUE                      03600017
036400         END-IF                                                   03610006
036500         PERFORM X700-UPDATE-TCKRSTINF                            03620006
036600         PERFORM Y100-COMMIT                                      03630006
036700         PERFORM X500-SET-CHECKPOINT-TIME                         03640006
036800     END-IF.                                                      03650006
036900                                                                  03660006
037000 EJECT                                                            03670006
037100*----------------------------------------------------------------*03680006
037200*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03690006
037300*----------------------------------------------------------------*03700006
037400 X200-CHECKPOINT-RESTART.                                         03710006
037500                                                                  03720006
037600     MOVE 'X200-CHECKPOINT-RESTART'  TO PV-CURRENT-PARAGRAPH.     03730017
037700                                                                  03740006
037800     PERFORM X400-GET-CHECKPOINT-INFO.                            03750006
037900     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03760006
038000                                                                  03770006
038100     DISPLAY '** AHKUP071 CHECKPOINT RESTART **'                  03780014
038200     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03790006
038300              CR-EXTRACT-RECS-WORKED.                             03800006
038400     DISPLAY '***********************************************'    03810006
038500                                                                  03820006
038600     PERFORM R100-READ-SORTED-FILE                                03830012
038700         CR-EXTRACT-RECS-WORKED TIMES.                            03840006
038800     PERFORM R100-READ-SORTED-FILE.                               03850012
038900 EJECT                                                            03860006
039000*----------------------------------------------------------------*03870006
039100*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03880006
039200*----------------------------------------------------------------*03890006
039300 X300-GET-CHECKPOINT-CNTL.                                        03900006
039400                                                                  03910006
039500     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     03920006
039600                                                                  03930006
039700     PERFORM WITH TEST AFTER                                      03940006
039800             VARYING PC-RETRY-COUNT FROM 1 BY 1                   03950006
039900             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             03960006
040000                     SQLCODE = ZERO                               03970006
040100                                                                  03980006
040200             EXEC SQL                                             03990006
040300              SELECT CKPT_STAT_CODE                               04000006
040400               INTO :PV-CKPT-STAT-CODE                            04010006
040500               FROM TCKRSTCNTL                                    04020006
040600               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04030006
040700             END-EXEC                                             04040006
040800                                                                  04050006
040900             EVALUATE TRUE                                        04060006
041000                 WHEN SQLCODE = ZERO                              04070006
041100                 WHEN SQLCODE = -904                              04080006
041200                 WHEN SQLCODE = -913                              04090006
041300                      CONTINUE                                    04100006
041400                                                                  04110006
041500                 WHEN SQLWARN0 NOT = SPACES                       04120006
041600                 WHEN SQLCODE  NOT = ZERO                         04130006
041700                     MOVE PV-CURRENT-PARAGRAPH                    04140006
041800                                         TO AA-PARAGRAPH-NAME     04150006
041900                     DISPLAY '******** PLAN_NAME:'                04160006
042000                              PV-PROGRAM-NAME                     04170006
042100                     MOVE SPACES TO AA-MESSAGE-1                  04180006
042200                                    AA-MESSAGE-2                  04190006
042300                     MOVE 'UNSUCCESSFUL SELECT'                   04200006
042400                                         TO AA-DB2-OPERATION      04210006
042500                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04220006
042600                     PERFORM Z999-DB2-ABEND                       04230006
042700             END-EVALUATE                                         04240006
042800     END-PERFORM.                                                 04250006
042900                                                                  04260006
043000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04270006
043100         MOVE PV-CURRENT-PARAGRAPH                                04280006
043200                             TO AA-PARAGRAPH-NAME                 04290006
043300         DISPLAY '******** PLAN_NAME:'                            04300006
043400                  PV-PROGRAM-NAME                                 04310006
043500         MOVE SPACES TO AA-MESSAGE-1                              04320006
043600                        AA-MESSAGE-2                              04330006
043700         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04340006
043800                             TO AA-DB2-OPERATION                  04350006
043900         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04360006
044000         PERFORM Z999-DB2-ABEND                                   04370006
044100     END-IF.                                                      04380006
044200                                                                  04390006
044300 EJECT                                                            04400006
044400*----------------------------------------------------------------*04410006
044500*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04420006
044600*----------------------------------------------------------------*04430006
044700 X400-GET-CHECKPOINT-INFO.                                        04440006
044800                                                                  04450006
044900     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04460006
045000                                                                  04470006
045100     PERFORM WITH TEST AFTER                                      04480006
045200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04490006
045300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04500006
045400                     SQLCODE = ZERO                               04510006
045500                                                                  04520006
045600             EXEC SQL                                             04530006
045700              SELECT WORK_STRG_DESC                               04540006
045800               INTO :TCKRSTINF-WORK-STRG-DESC                     04550006
045900               FROM TCKRSTINF                                     04560006
046000               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04570006
046100             END-EXEC                                             04580006
046200                                                                  04590006
046300             EVALUATE TRUE                                        04600006
046400                 WHEN SQLCODE = ZERO                              04610006
046500                 WHEN SQLCODE = -904                              04620006
046600                 WHEN SQLCODE = -913                              04630006
046700                      CONTINUE                                    04640006
046800                                                                  04650006
046900                 WHEN SQLWARN0 NOT = SPACES                       04660006
047000                 WHEN SQLCODE  NOT = ZERO                         04670006
047100                     MOVE PV-CURRENT-PARAGRAPH                    04680006
047200                                         TO AA-PARAGRAPH-NAME     04690006
047300                     DISPLAY '******** PLAN_NAME:'                04700006
047400                              PV-PROGRAM-NAME                     04710006
047500                     MOVE SPACES         TO AA-MESSAGE-1          04720017
047600                                            AA-MESSAGE-2          04730017
047700                     MOVE 'UNSUCCESSFUL SELECT'                   04740006
047800                                         TO AA-DB2-OPERATION      04750006
047900                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04760006
048000                     PERFORM Z999-DB2-ABEND                       04770006
048100             END-EVALUATE                                         04780006
048200     END-PERFORM.                                                 04790006
048300                                                                  04800006
048400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04810006
048500         MOVE PV-CURRENT-PARAGRAPH                                04820006
048600                             TO AA-PARAGRAPH-NAME                 04830006
048700         DISPLAY '******** PLAN_NAME:'                            04840006
048800                  PV-PROGRAM-NAME                                 04850006
048900         MOVE SPACES TO AA-MESSAGE-1                              04860006
049000                        AA-MESSAGE-2                              04870006
049100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04880006
049200                             TO AA-DB2-OPERATION                  04890006
049300         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      04900006
049400         PERFORM Z999-DB2-ABEND                                   04910006
049500     END-IF.                                                      04920006
049600                                                                  04930006
049700 EJECT                                                            04940006
049800*----------------------------------------------------------------*04950006
049900*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *04960006
050000*----------------------------------------------------------------*04970006
050100 X500-SET-CHECKPOINT-TIME.                                        04980006
050200                                                                  04990006
050300     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05000006
050400                                                                  05010006
050500     PERFORM WITH TEST AFTER                                      05020006
050600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05030006
050700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05040006
050800                     SQLCODE = ZERO                               05050006
050900                                                                  05060006
051000             EXEC SQL                                             05070006
051100              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05080006
051200               INTO :WS-HOLD-TMST                                 05090006
051300               FROM TCKRSTCNTL                                    05100006
051400               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05110006
051500             END-EXEC                                             05120006
051600                                                                  05130006
051700             EVALUATE TRUE                                        05140006
051800                 WHEN SQLCODE = ZERO                              05150006
051900                 WHEN SQLCODE = -904                              05160006
052000                 WHEN SQLCODE = -913                              05170006
052100                      CONTINUE                                    05180006
052200                                                                  05190006
052300                 WHEN SQLWARN0 NOT = SPACES                       05200006
052400                 WHEN SQLCODE  NOT = ZERO                         05210006
052500                     MOVE PV-CURRENT-PARAGRAPH                    05220006
052600                                         TO AA-PARAGRAPH-NAME     05230006
052700                     DISPLAY '******** PLAN_NAME:'                05240006
052800                              PV-PROGRAM-NAME                     05250006
052900                     MOVE SPACES         TO AA-MESSAGE-1          05260017
053000                                            AA-MESSAGE-2          05270017
053100                     MOVE 'UNSUCCESSFUL SELECT'                   05280006
053200                                         TO AA-DB2-OPERATION      05290006
053300                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05300006
053400                     PERFORM Z999-DB2-ABEND                       05310006
053500             END-EVALUATE                                         05320006
053600     END-PERFORM.                                                 05330006
053700                                                                  05340006
053800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05350006
053900         MOVE PV-CURRENT-PARAGRAPH                                05360006
054000                             TO AA-PARAGRAPH-NAME                 05370006
054100         DISPLAY '******** PLAN_NAME:'                            05380006
054200                  PV-PROGRAM-NAME                                 05390006
054300         MOVE SPACES TO AA-MESSAGE-1                              05400006
054400                        AA-MESSAGE-2                              05410006
054500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05420006
054600                             TO AA-DB2-OPERATION                  05430006
054700         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05440006
054800         PERFORM Z999-DB2-ABEND                                   05450006
054900     END-IF.                                                      05460006
055000                                                                  05470006
055100 EJECT                                                            05480006
055200*----------------------------------------------------------------*05490006
055300*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05500006
055400*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05510006
055500*----------------------------------------------------------------*05520006
055600 X600-UPDATE-TCKRSTCNTL.                                          05530006
055700                                                                  05540006
055800     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05550006
055900                                                                  05560006
056000     PERFORM WITH TEST AFTER                                      05570006
056100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05580006
056200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05590006
056300                     SQLCODE = ZERO                               05600006
056400                                                                  05610006
056500             EXEC SQL                                             05620006
056600                 UPDATE TCKRSTCNTL                                05630006
056700                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05640006
056800                 WHERE PLAN_NAME    = :PV-PROGRAM-NAME            05650006
056900             END-EXEC                                             05660006
057000                                                                  05670006
057100             EVALUATE TRUE                                        05680006
057200                 WHEN SQLCODE = ZERO                              05690006
057300                 WHEN SQLCODE = -904                              05700006
057400                 WHEN SQLCODE = -913                              05710006
057500                      CONTINUE                                    05720006
057600                                                                  05730006
057700                 WHEN SQLWARN0 NOT = SPACES                       05740006
057800                 WHEN SQLCODE  NOT = ZERO                         05750006
057900                     MOVE PV-CURRENT-PARAGRAPH                    05760006
058000                                         TO AA-PARAGRAPH-NAME     05770006
058100                     DISPLAY '******** PLAN_NAME:'                05780006
058200                              PV-PROGRAM-NAME                     05790006
058300                     MOVE SPACES         TO AA-MESSAGE-1          05800017
058400                                            AA-MESSAGE-2          05810017
058500                     MOVE 'UNSUCCESSFUL UPDATE'                   05820006
058600                                         TO AA-DB2-OPERATION      05830006
058700                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05840006
058800                     PERFORM Z999-DB2-ABEND                       05850006
058900             END-EVALUATE                                         05860006
059000     END-PERFORM.                                                 05870006
059100                                                                  05880006
059200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05890006
059300         MOVE PV-CURRENT-PARAGRAPH                                05900006
059400                             TO AA-PARAGRAPH-NAME                 05910006
059500         DISPLAY '******** PLAN_NAME:'                            05920006
059600                  PV-PROGRAM-NAME                                 05930006
059700         MOVE SPACES TO AA-MESSAGE-1                              05940006
059800                        AA-MESSAGE-2                              05950006
059900         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    05960006
060000                             TO AA-DB2-OPERATION                  05970006
060100         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05980006
060200         PERFORM Z999-DB2-ABEND                                   05990006
060300     END-IF.                                                      06000006
060400                                                                  06010006
060500     EJECT                                                        06020006
060600*----------------------------------------------------------------*06030006
060700*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06040006
060800*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06050006
060900*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06060006
061000*----------------------------------------------------------------*06070006
061100 X700-UPDATE-TCKRSTINF.                                           06080006
061200                                                                  06090006
061300     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06100006
061400                                                                  06110006
061500     MOVE PV-TAURECD-INPUT-COUNT  TO CR-EXTRACT-RECS-WORKED.      06120017
061600     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06130006
061700     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06140006
061800                                                                  06150006
061900     PERFORM WITH TEST AFTER                                      06160006
062000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06170006
062100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06180006
062200                     SQLCODE = ZERO                               06190006
062300                                                                  06200006
062400             EXEC SQL                                             06210006
062500                 UPDATE TCKRSTINF                                 06220006
062600                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06230006
062700                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06240006
062800             END-EXEC                                             06250006
062900                                                                  06260006
063000             EVALUATE TRUE                                        06270006
063100                 WHEN SQLCODE = ZERO                              06280006
063200                 WHEN SQLCODE = -904                              06290006
063300                 WHEN SQLCODE = -913                              06300006
063400                      CONTINUE                                    06310006
063500                                                                  06320006
063600                 WHEN SQLWARN0 NOT = SPACES                       06330006
063700                 WHEN SQLCODE  NOT = ZERO                         06340006
063800                     MOVE PV-CURRENT-PARAGRAPH                    06350006
063900                                         TO AA-PARAGRAPH-NAME     06360006
064000                     DISPLAY '******** PLAN_NAME:'                06370006
064100                              PV-PROGRAM-NAME                     06380006
064200                     MOVE SPACES         TO AA-MESSAGE-1          06390017
064300                                            AA-MESSAGE-2          06400017
064400                     MOVE 'UNSUCCESSFUL UPDATE'                   06410006
064500                                         TO AA-DB2-OPERATION      06420006
064600                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06430006
064700                     PERFORM Z999-DB2-ABEND                       06440006
064800             END-EVALUATE                                         06450006
064900     END-PERFORM.                                                 06460006
065000                                                                  06470006
065100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06480006
065200         MOVE PV-CURRENT-PARAGRAPH                                06490006
065300                             TO AA-PARAGRAPH-NAME                 06500006
065400         DISPLAY '******** PLAN_NAME:'                            06510006
065500                  PV-PROGRAM-NAME                                 06520006
065600         MOVE SPACES         TO AA-MESSAGE-1                      06530017
065700                               AA-MESSAGE-2                       06540017
065800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06550006
065900                             TO AA-DB2-OPERATION                  06560006
066000         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06570006
066100         PERFORM Z999-DB2-ABEND                                   06580006
066200     END-IF.                                                      06590006
066300                                                                  06600006
066400 EJECT                                                            06610006
066500                                                                  06620006
066600*----------------------------------------------------------------*06630006
066700*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06640006
066800*----------------------------------------------------------------*06650006
066900 Y100-COMMIT.                                                     06660006
067000                                                                  06670006
067100     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06680006
067200                                                                  06690006
067300     EXEC SQL                                                     06700006
067400         COMMIT                                                   06710006
067500     END-EXEC.                                                    06720006
067600                                                                  06730006
067700     EVALUATE TRUE                                                06740006
067800         WHEN SQLCODE = ZEROS                                     06750006
067900             CONTINUE                                             06760006
068000         WHEN OTHER                                               06770006
068100             MOVE PV-CURRENT-PARAGRAPH                            06780006
068200                                 TO AA-PARAGRAPH-NAME             06790006
068300             MOVE SPACES         TO AA-MESSAGE-1                  06800017
068400                                   AA-MESSAGE-2                   06810017
068500             MOVE 'UNSUCCESSFUL COMMIT'                           06820006
068600                                 TO AA-DB2-OPERATION              06830006
068700             MOVE SPACES         TO AA-DB2-TABLE                  06840006
068800             PERFORM Z999-DB2-ABEND                               06850006
068900     END-EVALUATE.                                                06860006
069000 EJECT                                                            06870006
069100 Z900-PROCESS-ABEND.                                              06880006
069200                                                                  06890006
069300     DISPLAY '*** ABEND'.                                         06900006
069400     DISPLAY '*** PROGRAM   = AHKUP071'.                          06910014
069500     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             06920006
069600     DISPLAY AA-MESSAGE-LINE-1.                                   06930006
069700     DISPLAY AA-MESSAGE-LINE-2.                                   06940006
069800     COPY DPPD004.                                                06950006
069900     CALL 'ILBOABN0' USING ABEND-CODE.                            06960006
070000                                                                  06970006
070100                                                                  06980006
070200                                                                  06990006
070300 Z999-DB2-ABEND.                                                  07000006
070400                                                                  07010006
070500     DISPLAY AA-ABEND-LIT.                                        07020006
070600     DISPLAY AA-DB2-ERROR-LIT.                                    07030006
070700     DISPLAY AA-PROGRAM-LIT.                                      07040006
070800     DISPLAY AA-PARAGRAPH-LIT.                                    07050006
070900     DISPLAY AA-DB2-OPERATION-LIT.                                07060006
071000     DISPLAY AA-DB2-TABLE.                                        07070006
071100     SET AC-DB2-ERROR TO TRUE.                                    07080006
071200                                                                  07090006
071300     COPY DPPD004.                                                07100006
071400                                                                  07110006
071500     CALL 'ILBOABN0' USING ABEND-CODE.                            07120006
