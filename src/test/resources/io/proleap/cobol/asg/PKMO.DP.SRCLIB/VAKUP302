       IDENTIFICATION DIVISION.                                         00010000
                                                                        00020000
       PROGRAM-ID.    VAKUP302.                                         00030000
       AUTHOR.        JULIE SEIDLER.                                    00040000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
       DATE-WRITTEN.  1999-09-24.                                       00060000
       DATE-COMPILED.                                                   00070000
                                                                        00080000
W34517******************************************************************00090000
W34517*                                                                 00100000
W34517*               !!!  I M P O R T A N T  !!!                       00110000
W34517*                                                                 00120000
W34517*                                                                 00130000
W34517*    !!!  THIS PROGRAM MUST BE KEPT IN SYNC WITH INKUP302  !!!    00140000
W34517*                                                                 00150000
W34517*                                                                 00160000
W34517*                                                                 00170000
      ******************************************************************00180000
W34517* VAKUP302 - WEEKLY SUB-CLASS STORE SHRINK TABLE UPDATE (TINSHNK) 00190000
W34517* THIS PROGRAM PERFORMS UPDATES FOR THE BRAND VENDOR INVENTORY    00200000
W34517* LEDGER FINANCIALS. ANY CHANGES MADE TO THIS PROGRAM MUST ALSO   00210000
W34517* BY MADE TO THE BRAND VENDOR VERSION OF THIS PROGRAM INKUP302.   00220000
W34517*                                                                 00230000
W34517* CHANGE MADE: CREATE SPLIT PROCESS FOR VA VERSION OF INV LEDGER. 00240000
W34517*              WR34517  PATTY JAEGER - OCT. 14, 2008 INSTALL DATE 00250000
W34517******************************************************************00260000
      *                                                                 00270000
      *CHANGE HISTORY:                                                  00280000
      * WR/PROJ DATE       PGMR        DESCRIPTION OF CHANGES           00290000
      * ------- ---------- ----------- -------------------------------- 00300000
W20445* W20445  09-01-2004 ROD JANSSEN DETAILED INVNENTORY ADJUSTMENT   00310000
W34517* W34517  07-18-2008 P. JAEGER   BRAND VENDOR                     00320000
W34517* W34517             (CLONE OF INKUP302 FOR BV/VA)                00330000
W33304* W33304  07-18-2008 INFOSYS/    HILO CHANGES.                    00331001
W33304*                     JIMMY                                       00332001
      ******************************************************************00340000
                                                                        00350000
       ENVIRONMENT DIVISION.                                            00360000
       CONFIGURATION SECTION.                                           00370000
       SOURCE-COMPUTER.        IBM-3090.                                00380000
       OBJECT-COMPUTER.        IBM-3090.                                00390000
       INPUT-OUTPUT SECTION.                                            00400000
       FILE-CONTROL.                                                    00410000
                                                                        00420000
           SELECT CONDENSED-FILE                                        00430000
               ASSIGN TO INP01.                                         00440000
                                                                        00450000
       DATA DIVISION.                                                   00460000
       FILE SECTION.                                                    00470000
                                                                        00480000
       FD  CONDENSED-FILE                                               00490000
           LABEL RECORDS ARE STANDARD                                   00500000
           RECORDING MODE IS F                                          00510000
           BLOCK CONTAINS 0 RECORDS.                                    00520000
W20445 01  CONDENSED-RECORD            PIC X(80).                       00530000
                                                                        00540000
       WORKING-STORAGE SECTION.                                         00550000
                                                                        00560000
       01  FILLER                      PIC X(28)   VALUE                00570000
                'BEGINNING OF WORKING STORAGE'.                         00580000
       01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00590000
                                                                        00600000
       01  PC-PROGRAM-CONSTANTS.                                        00610000
W34517     05  PC-JOB-NAME             PIC  X(06)    VALUE 'VAK217'.    00620000
W34517     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'VAKUP302'.  00630000
           05  PC-MAX-DEADLOCKS        PIC S9(03) VALUE +3.             00640000
                                                                        00650000
       01  PE-PROGRAM-ERROR-MESSAGES.                                   00660000
           05  PE-MSG-01                       PIC X(50) VALUE          00670000
                'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00680000
           05  PE-MSG-02                       PIC X(50) VALUE          00690000
                'ATTEMPT TO UPDATE ROW ON TABLE TINSHNK FAILED    '.    00700000
           05  PE-MSG-03                       PIC X(50) VALUE          00710000
                'ATTEMPT TO INSERT ROW ON TABLE TINSHNK FAILED    '.    00720000
           05  PE-MSG-04                       PIC X(50) VALUE          00730000
                'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00740000
           05  PE-MSG-05                       PIC X(50) VALUE          00750000
                'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00760000
           05  PE-MSG-06                       PIC X(50) VALUE          00770000
                'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00780000
           05  PE-MSG-07                       PIC X(50) VALUE          00790000
                'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00800000
W33304     05  PE-MSG-08                       PIC X(50) VALUE          00801001
W33304          'SELECT ON JOIN OF TINVPAR AND TINCNTL FAILED'.         00802001
W33304     05  PE-MSG-09                       PIC X(50) VALUE          00803001
W33304          'SELECT ON TDTATTR FAILED'.                             00804001
                                                                        00810000
       01  PS-PROGRAM-SWITCHES.                                         00820000
           05  PS-EOF-CONDENSED-FILE-SW     PIC X(01)     VALUE 'N'.    00830000
               88  PS-EOF-CONDENSED-FILE                  VALUE 'Y'.    00840000
           05  PS-INSHNK-CURSOR-EOF-SW      PIC X(01)     VALUE 'N'.    00850000
               88  PS-END-OF-TABLE-RECS                   VALUE 'Y'.    00860000
           05  PS-FIRST-COMMIT-SW           PIC X(01)     VALUE 'N'.    00870000
               88  PS-FIRST-COMMIT                        VALUE 'Y'.    00880000
           05  PS-DEADLOCK-RESTART-SW       PIC X(01)     VALUE 'N'.    00890000
               88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00900000
W33304     05  PS-SKIP-RECORD-SW            PIC X(01)     VALUE 'N'.    00901001
W33304         88  PS-SKIP-RECORD-YES                     VALUE 'Y'.    00902001
W33304         88  PS-SKIP-RECORD-NO                      VALUE 'N'.    00903001
                                                                        00910000
       01  PI-PROGRAM-INDICATORS.                                       00920000
           05  PI-PROCESSING-OPTIONS-IND    PIC X(01)     VALUE 'P'.    00930000
               88  PI-UPDATE-INSHNK-ROW                   VALUE 'U'.    00940000
               88  PI-INSERT-INSHNK-ROW                   VALUE 'I'.    00950000
                                                                        00960000
       01  PROGRAM-VARIABLES.                                           00970000
           05  PV-RETRY-COUNT                  PIC S9(04) VALUE +0.     00980000
           05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0.     00990000
                                                                        01000000
           05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01010000
           05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01020000
           05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01030000
           05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01040000
           05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01050000
W20445     05  PV-EDIT-SUB-CLASS               PIC 9(03) VALUE ZEROS.   01060000
W20445     05  PV-EDIT-SUB-CLASS-RED REDEFINES                          01070000
W20445         PV-EDIT-SUB-CLASS.                                       01080000
W20445         10  PV-EDIT-CLASS-P1            PIC X(01).               01090000
W20445         10  PV-EDIT-CLASS-P2            PIC X(02).               01100000
W20445     05  PV-EDIT-DEPT-NBR                PIC 9(03) VALUE ZEROS.   01110000
W20445     05  PV-EDIT-DEPT-NBR-RED REDEFINES                           01120000
W20445         PV-EDIT-DEPT-NBR                PIC X(03).               01130000
                                                                        01140000
       01  PA-PROGRAM-ACCUMULATORS.                                     01150000
           05  PA-RECORD-COUNTS.                                        01160000
               10  PA-INPUT-COUNT        PIC  9(09)  VALUE ZEROES.      01170000
               10  PA-UPDATE-COUNT       PIC  9(09)  VALUE ZEROES.      01180000
               10  PA-INSERT-COUNT       PIC  9(09)  VALUE ZEROES.      01190000
W33304         10  PA-SKIP-COUNT         PIC  9(09)  VALUE ZEROES.      01191001
           05  PA-ACCUMULATORS.                                         01200000
               10 PA-SLS-RTL-AMT-IN      PIC S9(13)V99 VALUE 0.         01210000
               10 PA-SLS-RTL-AMT-TOT     PIC S9(13)V99 VALUE 0.         01220000
                                                                        01230000
       01  PD-PROGRAM-DISPLAYS.                                         01240000
           05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01250000
           05  PD-DISPLAY-TOTAL          PIC  Z,ZZZ,ZZZ,ZZZ,ZZ9.99-.    01260000
                                                                        01270000
       01  SAVE-AREA.                                                   01280000
           05  SV-PRIMARY-KEY.                                          01290000
               10  SV-FSCL-WK-END-DTE    PIC X(10)  VALUE SPACE.        01300000
W20445         10  SV-DEPT-NBR           PIC S9(04)V COMP-3.            01310000
W20445         10  SV-SUB-CL-NBR         PIC S9(04)V COMP-3.            01320000
               10  SV-STR-NBR            PIC S9(04) COMP VALUE 0.       01330000
           05  SV-UPDATE-FIELDS.                                        01340000
               10  SV-SLS-RTL-AMT        PIC S9(11)V99  COMP-3 VALUE +0.01350000
                                                                        01360000
      ******************************************************************01370000
W34517* VARD020 - WEEKLY SALES TRANSACTION LAYOUT                       01380000
W34517*   CLONED COPYBOOK INRD020                                       01390000
      ******************************************************************01400000
W34517     COPY VARD020.                                                01410000
W34517                                                                  01420000
      ******************************************************************01430000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                01440000
      ******************************************************************01450000
           COPY DPWS004.                                                01460000
                                                                        01470000
      ******************************************************************01480000
      *  USED FOR DB2 ERRORS                                            01490000
      ******************************************************************01500000
           EXEC SQL                                                     01510000
               INCLUDE SQLCA                                            01520000
           END-EXEC.                                                    01530000
                                                                        01540000
W33304******************************************************************01541001
W33304* DCLGEN FOR TINVPAR                                              01542001
W33304******************************************************************01543001
W33304     EXEC SQL                                                     01544001
W33304         INCLUDE TINVPAR                                          01545001
W33304     END-EXEC.                                                    01546001
W33304                                                                  01547001
W33304******************************************************************01548001
W33304* DCLGEN FOR TINCNTL                                              01549001
W33304******************************************************************01549101
W33304     EXEC SQL                                                     01549201
W33304         INCLUDE TINCNTL                                          01549301
W33304     END-EXEC.                                                    01549401
W33304                                                                  01549501
W33304******************************************************************01549601
W33304* DCLGEN FOR TDTATTR                                              01549701
W33304******************************************************************01549801
W33304     EXEC SQL                                                     01549901
W33304         INCLUDE TDTATTR                                          01550001
W33304     END-EXEC.                                                    01550101
W33304                                                                  01550201
      ******************************************************************01551000
      *  INVENTORY WEEKLY SHINK TABLE                                   01560000
      ******************************************************************01570000
           EXEC SQL                                                     01580000
               INCLUDE TINSHNK                                          01590000
           END-EXEC.                                                    01600000
                                                                        01610000
      ***************************************************************** 01620000
      * DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01630000
      ***************************************************************** 01640000
           EXEC SQL                                                     01650000
               INCLUDE TCKRSTCN                                         01660000
           END-EXEC.                                                    01670000
                                                                        01680000
           EXEC SQL                                                     01690000
               INCLUDE TCKRSTIN                                         01700000
           END-EXEC.                                                    01710000
                                                                        01720000
                                                                        01730000
       01  CR-CHECKPOINT-RESTART-AREA.                                  01740000
W20445     05  CR-AREA-LEN                  PIC S9(04) VALUE +27  COMP. 01750000
           05  CR-CHECKPOINT-RESTART-VAR.                               01760000
W20445         10  CR-PREV-DTL-KEY          PIC  X(18) VALUE SPACES.    01770000
               10  FILLER REDEFINES CR-PREV-DTL-KEY.                    01780000
                   15  CR-FISCAL-WK-END-DTE PIC  X(10).                 01790000
W20445             15  CR-DEPT-NBR          PIC  S9(04)V COMP-3.        01800000
W20445             15  CR-SUB-CL-NBR        PIC  S9(04)V COMP-3.        01810000
                   15  CR-STR-NBR           PIC  S9(04) COMP.           01820000
               10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    01830000
                                                                        01840000
       01  CK-CHECKPOINT-SAVE-AREA.                                     01850000
W20445     05  CK-SAVE-PREV-KEY         PIC  X(18) VALUE SPACES.        01860000
           05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       01870000
               10  CK-FISCAL-WK-END-DTE PIC  X(10).                     01880000
W20445         10  CK-DEPT-NBR          PIC  S9(04)V COMP-3.            01890000
W20445         10  CK-SUB-CL-NBR        PIC  S9(04)V COMP-3.            01900000
               10  CK-STR-NBR           PIC  S9(04) COMP.               01910000
                                                                        01920000
      *-------------------*                                             01930000
       PROCEDURE DIVISION.                                              01940000
      *-------------------*                                             01950000
                                                                        01960000
W34517 0000-VAKUP302.                                                   01970000
                                                                        01980000
           PERFORM 1000-INITIALIZATION.                                 01990000
                                                                        02000000
           PERFORM 2000-PROCESS-INPUT                                   02010000
                UNTIL PS-EOF-CONDENSED-FILE.                            02020000
                                                                        02030000
           PERFORM 8000-EOJ-ROUTINE.                                    02040000
                                                                        02050000
           STOP RUN.                                                    02060000
                                                                        02070000
      ******************************************************************02080000
      * OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02090000
      * PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02100000
      ******************************************************************02110000
                                                                        02120000
       1000-INITIALIZATION.                                             02130000
                                                                        02140000
           OPEN INPUT CONDENSED-FILE.                                   02150000
                                                                        02160000
           PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02170000
                                                                        02180000
      * CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02190000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02200000
                PERFORM 7500-SELECT-RESTART-INFO                        02210000
                MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                   02220000
                                             CR-CHECKPOINT-RESTART-VAR  02230000
                MOVE CR-PREV-DTL-KEY          TO CK-SAVE-PREV-KEY       02240000
           ELSE                                                         02250000
               SET PS-FIRST-COMMIT TO TRUE                              02260000
               INITIALIZE CR-CHECKPOINT-RESTART-VAR                     02270000
           END-IF.                                                      02280000
                                                                        02290000
           PERFORM 4000-READ-CONDENSED-FILE UNTIL                       02300000
              (PA-INPUT-COUNT > CR-INPUT-READ-COUNT)                    02310000
               OR                                                       02320000
               PS-EOF-CONDENSED-FILE.                                   02330000
                                                                        02340000
           IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02350000
W34517         DISPLAY 'FISCAL WEEK  END DATE ' VA020-FSCL-MN-END-DTE   02360000
W34517         DISPLAY 'DEPARTMENT NBR        ' VA020-DEPT-NBR          02370000
W34517         DISPLAY 'SUB CLASS NBR         ' VA020-SUB-CL-NBR        02380000
W34517         DISPLAY 'STORE NBR             ' VA020-STR-NBR           02390000
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              02400000
                        PA-INPUT-COUNT                                  02410000
           END-IF.                                                      02420000
                                                                        02430000
           IF PS-EOF-CONDENSED-FILE                                     02440000
               IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       02450000
                   CONTINUE                                             02460000
               ELSE                                                     02470000
                   DISPLAY '** NO RECORDS ON INPUT FILE **'             02480000
           ELSE                                                         02490000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        02500000
               DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                  02510000
                    TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'             02520000
           END-IF.                                                      02530000
                                                                        02540000
      ******************************************************************02550000
      * PROCESS THE SORTED/CONDENSED FILE - UPDATE OR INSERT AS NEEDED  02560000
      ******************************************************************02570000
       2000-PROCESS-INPUT.                                              02580000
                                                                        02590000
           MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          02600000
                                                                        02610000
W33304     PERFORM 2200-SELECT-INV-DATES.                               02611001
W33304     IF PS-SKIP-RECORD-YES                                        02612001
W33304        ADD 1 TO PA-SKIP-COUNT                                    02613001
W33304     ELSE                                                         02614001
              PERFORM 7000-SELECT-DB-ROW                                02620001
                                                                        02630000
W33304        IF PS-PROGRAM-DEADLOCKED                                  02640005
W33304            CONTINUE                                              02650005
W33304        ELSE                                                      02660005
W33304            EVALUATE TRUE                                         02670005
W33304                WHEN PI-UPDATE-INSHNK-ROW                         02680005
W33304                    PERFORM 7100-UPDATE-INSHNK-ROW                02690005
W33304                WHEN PI-INSERT-INSHNK-ROW                         02700005
W33304                    PERFORM 7200-INSERT-INSHNK-ROW                02710005
W33304                WHEN OTHER                                        02720005
W33304                    MOVE '7000-SELECT-DB-ROW' TO PV-PARAGRAPH-NAME02730005
W33304                    MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED      02740005
W33304                    PERFORM 9999-SQL-ABEND                        02750005
W33304            END-EVALUATE                                          02760005
W33304        END-IF                                                    02771001
           END-IF.                                                      02772005
                                                                        02780000
           IF PS-PROGRAM-DEADLOCKED                                     02790000
               CONTINUE                                                 02800000
           ELSE                                                         02810000
               PERFORM 7700-COMMIT-PROCESSING                           02820000
               PERFORM 4000-READ-CONDENSED-FILE                         02830000
           END-IF.                                                      02840000
                                                                        02850000
      ******************************************************************02860000
      * CALCULATE FIELDS FOR UPDATE OF DATABASE                         02870000
      ******************************************************************02880000
       2100-CALCULATE-UPDATES.                                          02890000
      * ADD DB2 TABLE ROW VALUES TO CURRENT INPUT RECORD ROW VALUES     02900000
                                                                        02910000
           COMPUTE SV-SLS-RTL-AMT       =                               02920000
W34517             INSHNK-SLS-RTL-AMT      + VA020-SLS-RTL-AMT.         02930000
                                                                        02940000
W34517     ADD VA020-SLS-RTL-AMT      TO PA-SLS-RTL-AMT-IN.             02950000
           ADD SV-SLS-RTL-AMT         TO PA-SLS-RTL-AMT-TOT.            02960000
                                                                        02970000
W33304******************************************************************02971001
W33304* SELECT OPN_FSCL_MN_DTE AND PLND_INV_DTE FROM INV TABLES         02972001
W33304******************************************************************02973001
W33304 2200-SELECT-INV-DATES.                                           02974001
W33304                                                                  02975001
W33304     EXEC SQL                                                     02976001
W33304       SELECT B.OPN_FSCL_MN_DTE                                   02977001
W33304             ,A.PLND_INV_DTE                                      02978001
W33304         INTO :INCNTL-OPN-FSCL-MN-DTE                             02979001
W33304             ,:INVPAR-PLND-INV-DTE                                02979101
W33304         FROM TINVPAR A                                           02979201
W33304             ,TINCNTL B                                           02979301
W33304        WHERE B.ACTV_IND = 'Y'                                    02979401
W33304          AND A.INV_ID = B.INV_ID                                 02979501
W33304          AND A.LOC_INV_STAT_CDE = 'IN'                           02979601
W33304          AND A.LOC_NBR = :VA020-STR-NBR                          02979704
W33304          AND A.ACTL_FIN_BK_DTE = '9999-09-09'                    02979801
W33304     END-EXEC                                                     02979901
W33304                                                                  02980001
W33304     EVALUATE SQLCODE                                             02980101
W33304         WHEN 0                                                   02980201
W33304             PERFORM 2300-SELECT-FSCL-WK-END-DTE                  02980301
W33304         WHEN +100                                                02980401
W33304             SET PS-SKIP-RECORD-YES TO TRUE                       02980501
W33304         WHEN OTHER                                               02980601
W33304             MOVE PE-MSG-08            TO PV-OPERATION-ATTEMPTED  02980701
W33304             MOVE '2200-SELECT-INV-DATES'                         02980801
W33304                                       TO PV-PARAGRAPH-NAME       02980901
W33304             PERFORM 9999-SQL-ABEND                               02981001
W33304     END-EVALUATE.                                                02981101
W33304******************************************************************02981201
W33304* SELECT FSCL_WK_END_DTE FROM TDTATTR USING PLND_INV_DTE          02981301
W33304******************************************************************02981401
W33304 2300-SELECT-FSCL-WK-END-DTE.                                     02981501
W33304                                                                  02981601
W33304     EXEC SQL                                                     02981701
W33304       SELECT FSCL_WK_END_DTE                                     02981801
W33304         INTO :DTATTR-FSCL-WK-END-DTE                             02981901
W33304         FROM TDTATTR                                             02982001
W33304        WHERE KY_DTE = :INVPAR-PLND-INV-DTE                       02982101
W33304     END-EXEC                                                     02982201
W33304                                                                  02982301
W33304     EVALUATE SQLCODE                                             02982401
W33304         WHEN 0                                                   02982501
W33304             CONTINUE                                             02982601
W33304         WHEN +100                                                02982701
W33304             SET PS-SKIP-RECORD-YES TO TRUE                       02982801
W33304         WHEN OTHER                                               02982901
W33304             MOVE PE-MSG-09            TO PV-OPERATION-ATTEMPTED  02983001
W33304             MOVE '2300-SELECT-FSCL-WK-END-DTE'                   02983101
W33304                                       TO PV-PARAGRAPH-NAME       02983201
W33304             PERFORM 9999-SQL-ABEND                               02983301
W33304     END-EVALUATE.                                                02983401
      ******************************************************************02984000
      * READS THE CONDENSED FILE INTO THE TINSHNK LAYOUT                02990000
      ******************************************************************03000000
       4000-READ-CONDENSED-FILE.                                        03010000
W34517     READ CONDENSED-FILE INTO VA020-UPDATE-REC                    03020000
              AT END                                                    03030000
                MOVE 'Y' TO PS-EOF-CONDENSED-FILE-SW.                   03040000
                                                                        03050000
W33304     SET PS-SKIP-RECORD-NO TO TRUE.                               03051003
W33304                                                                  03052005
           IF PS-EOF-CONDENSED-FILE                                     03060000
W34517         MOVE VA020-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   03070000
W34517         MOVE VA020-DEPT-NBR            TO CR-DEPT-NBR            03080000
W34517         MOVE VA020-SUB-CL-NBR          TO CR-SUB-CL-NBR          03090000
W34517         MOVE VA020-STR-NBR             TO CR-STR-NBR             03100000
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    03110000
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  03120000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       03130000
                                             TCKRSTINF-WORK-STRG-DESC   03140000
               EXEC SQL                                                 03150000
                 UPDATE TCKRSTINF                                       03160000
                    SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      03170000
                  WHERE JOB_NAME   = :PC-JOB-NAME                       03180000
                    AND PLAN_NAME  = :PC-PROGRAM-NAME                   03190000
               END-EXEC                                                 03200000
               IF SQLCODE = 0                                           03210000
                   CONTINUE                                             03220000
               ELSE                                                     03230000
                   MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  03240000
                   MOVE '* 4000-READ-CONDENSED-FILE *' TO               03250000
                        PV-PARAGRAPH-NAME                               03260000
                   PERFORM 9999-SQL-ABEND                               03270000
               END-IF                                                   03280000
           ELSE                                                         03290000
               ADD 1                         TO PA-INPUT-COUNT          03300000
           END-IF.                                                      03310000
                                                                        03320000
      ******************************************************************03330000
      * SELECT A ROW FROM THE MONTHLY INV  TABLE THAT MATCHES INPUT KEY 03340000
      *   SQLCODE FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT      03350000
      ******************************************************************03360000
       7000-SELECT-DB-ROW.                                              03370000
                                                                        03380000
W33304     MOVE DTATTR-FSCL-WK-END-DTE TO INSHNK-FSCL-WK-END-DTE.       03391001
W33304     MOVE VA020-FSCL-MN-END-DTE  TO INSHNK-ML-PSTG-MN-END-DTE.    03392001
W33304     MOVE INCNTL-OPN-FSCL-MN-DTE TO INSHNK-FSCL-MN-END-DTE.       03393001
W20445                                                                  03400000
W34517     MOVE VA020-DEPT-NBR        TO PV-EDIT-DEPT-NBR.              03410000
W20445     MOVE PV-EDIT-DEPT-NBR-RED  TO INSHNK-DEPT-NBR.               03420000
W20445                                                                  03430000
W34517     MOVE VA020-SUB-CL-NBR      TO PV-EDIT-SUB-CLASS.             03440000
W20445     MOVE PV-EDIT-CLASS-P2      TO INSHNK-SUB-CL-NBR.             03450000
W20445                                                                  03460000
W34517     MOVE VA020-STR-NBR         TO INSHNK-STR-NBR.                03470000
W20445                                                                  03480000
           EXEC SQL                                                     03490000
               SELECT SLS_RTL_AMT                                       03500000
               INTO :INSHNK-SLS-RTL-AMT                                 03510000
               FROM TINSHNK                                             03520000
W20445        WHERE   FSCL_WK_END_DTE     = :INSHNK-FSCL-WK-END-DTE     03530000
W20445          AND   DEPT_NBR            = :INSHNK-DEPT-NBR            03540000
W20445          AND   SUB_CL_NBR          = :INSHNK-SUB-CL-NBR          03550000
W20445          AND   STR_NBR             = :INSHNK-STR-NBR             03560000
W33304          AND   ML_PSTG_MN_END_DTE  = :INSHNK-ML-PSTG-MN-END-DTE  03561001
           END-EXEC.                                                    03570000
                                                                        03580000
           EVALUATE SQLCODE                                             03590000
               WHEN 0                                                   03600000
                   SET PI-UPDATE-INSHNK-ROW       TO TRUE               03610000
               WHEN +100                                                03620000
                   SET PI-INSERT-INSHNK-ROW       TO TRUE               03630000
               WHEN -911                                                03640000
                   ADD +1             TO PV-DEADLOCK-COUNT              03650000
                   DISPLAY 'DEADLOCK -911 IN 7000-SELECT-DB-ROW'        03660000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03670000
                       MOVE '7000-SELECT-DB-ROW' TO                     03680000
                                                    PV-PARAGRAPH-NAME   03690000
                       MOVE 'SELECT AGAINST TINSHNK'                    03700000
                                      TO PV-OPERATION-ATTEMPTED         03710000
                       PERFORM 9000-DEADLOCK-ERROR                      03720000
                   ELSE                                                 03730000
                       PERFORM 7999-RESTART-PROCESS                     03740000
                   END-IF                                               03750000
               WHEN OTHER                                               03760000
                   MOVE '7000-SELECT-DB-ROW'   TO PV-PARAGRAPH-NAME     03770000
                   MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             03780000
                   PERFORM 9999-SQL-ABEND                               03790000
           END-EVALUATE.                                                03800000
                                                                        03810000
                                                                        03820000
      ***************************************************************** 03830000
      * THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO, DEPT  03840000
      * SUB CLASS AND STORE. CURRENT TABLE VALUES UPDATED TO INCLUDE    03850000
      * VALUES FROM INPUT REC MLRD020                                   03860000
      ***************************************************************** 03870000
       7100-UPDATE-INSHNK-ROW.                                          03880000
                                                                        03890000
           PERFORM 2100-CALCULATE-UPDATES.                              03900000
                                                                        03910000
W20445                                                                  03930000
W34517     MOVE VA020-DEPT-NBR        TO PV-EDIT-DEPT-NBR.              03940000
W20445     MOVE PV-EDIT-DEPT-NBR-RED  TO INSHNK-DEPT-NBR.               03950000
W20445                                                                  03960000
W34517     MOVE VA020-SUB-CL-NBR      TO PV-EDIT-SUB-CLASS.             03970000
W20445     MOVE PV-EDIT-CLASS-P2      TO INSHNK-SUB-CL-NBR.             03980000
W20445                                                                  03990000
W34517     MOVE VA020-STR-NBR         TO INSHNK-STR-NBR.                04000000
W20445                                                                  04010000
           EXEC SQL                                                     04020000
              UPDATE TINSHNK                                            04030000
              SET SLS_RTL_AMT         = :SV-SLS-RTL-AMT                 04040000
W20445        WHERE   FSCL_WK_END_DTE     = :INSHNK-FSCL-WK-END-DTE     04050000
W20445          AND   DEPT_NBR            = :INSHNK-DEPT-NBR            04060000
W20445          AND   SUB_CL_NBR          = :INSHNK-SUB-CL-NBR          04070000
W20445          AND   STR_NBR             = :INSHNK-STR-NBR             04080000
W33304          AND   ML_PSTG_MN_END_DTE  = :INSHNK-ML-PSTG-MN-END-DTE  04081001
           END-EXEC                                                     04090000
                                                                        04100000
           EVALUATE SQLCODE                                             04110000
               WHEN 0                                                   04120000
                   ADD 1 TO PA-UPDATE-COUNT                             04130000
               WHEN -911                                                04140000
                   ADD +1             TO PV-DEADLOCK-COUNT              04150000
                   DISPLAY 'DEADLOCK -911 IN 7100-UPDATE-INSHNK-ROW'    04160000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04170000
                       MOVE '7100-UPDATE-INSHNK-ROW' TO                 04180000
                                                    PV-PARAGRAPH-NAME   04190000
                       MOVE 'UPDATE AGAINST TINSHNK'                    04200000
                                      TO PV-OPERATION-ATTEMPTED         04210000
                       PERFORM 9000-DEADLOCK-ERROR                      04220000
                   ELSE                                                 04230000
                       PERFORM 7999-RESTART-PROCESS                     04240000
                   END-IF                                               04250000
               WHEN OTHER                                               04260000
                   MOVE '7100-UPDATE-INSHNK-ROW' TO PV-PARAGRAPH-NAME   04270000
                   MOVE PE-MSG-02              TO PV-OPERATION-ATTEMPTED04280000
                   PERFORM 9999-SQL-ABEND                               04290000
           END-EVALUATE.                                                04300000
                                                                        04310000
      ***************************************************************** 04320000
      * THERE WAS NO MATCHING ROW ON THE MONTHLY INCL TABLE. INITIAL  * 04330000
      * - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 04340000
      * - CALCULATED FIELDS ARE INITIALLY SET TO 0 AND UPDATED IN RECALC04350000
      ***************************************************************** 04360000
       7200-INSERT-INSHNK-ROW.                                          04370000
                                                                        04380000
W20445                                                                  04400000
W34517     MOVE VA020-DEPT-NBR         TO PV-EDIT-DEPT-NBR.             04410000
W20445     MOVE PV-EDIT-DEPT-NBR-RED   TO INSHNK-DEPT-NBR.              04420000
W20445                                                                  04430000
W34517     MOVE VA020-SUB-CL-NBR       TO PV-EDIT-SUB-CLASS.            04440000
W20445     MOVE PV-EDIT-CLASS-P2       TO INSHNK-SUB-CL-NBR.            04450000
W20445                                                                  04460000
W34517     MOVE VA020-STR-NBR          TO INSHNK-STR-NBR.               04470000
W20445                                                                  04490000
W34517     MOVE VA020-SLS-RTL-AMT      TO INSHNK-SLS-RTL-AMT.           04500000
W20445                                                                  04510000
           EXEC SQL                                                     04520000
               INSERT INTO TINSHNK                                      04530000
                   (   FSCL_WK_END_DTE                                  04540000
W33304               , ML_PSTG_MN_END_DTE                               04541001
                     , DEPT_NBR                                         04550000
                     , SUB_CL_NBR                                       04560000
                     , STR_NBR                                          04570000
                     , FSCL_MN_END_DTE                                  04580000
                     , SLS_RTL_AMT                                      04590000
                     , SHNK_RTL_AMT)                                    04600000
               VALUES                                                   04610000
W20445             (   :INSHNK-FSCL-WK-END-DTE                          04620000
W33304               , :INSHNK-ML-PSTG-MN-END-DTE                       04621001
W20445               , :INSHNK-DEPT-NBR                                 04630000
W20445               , :INSHNK-SUB-CL-NBR                               04640000
W20445               , :INSHNK-STR-NBR                                  04650000
W20445               , :INSHNK-FSCL-MN-END-DTE                          04660000
W20445               , :INSHNK-SLS-RTL-AMT                              04670000
                     , 0                       )                        04680000
           END-EXEC.                                                    04690000
                                                                        04700000
           EVALUATE SQLCODE                                             04710000
               WHEN 0                                                   04720000
                   ADD 1 TO PA-INSERT-COUNT                             04730000
W34517             ADD VA020-SLS-RTL-AMT      TO PA-SLS-RTL-AMT-IN      04740000
               WHEN -911                                                04750000
                   ADD +1             TO PV-DEADLOCK-COUNT              04760000
                   IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04770000
                       MOVE '7200-INSERT-INSHNK-ROW' TO                 04780000
                                                    PV-PARAGRAPH-NAME   04790000
                       MOVE 'INSERT AGAINST TINSHNK'                    04800000
                                      TO PV-OPERATION-ATTEMPTED         04810000
                       PERFORM 9000-DEADLOCK-ERROR                      04820000
                   ELSE                                                 04830000
                       PERFORM 7999-RESTART-PROCESS                     04840000
                   END-IF                                               04850000
               WHEN OTHER                                               04860000
W34517             DISPLAY 'WK DTE ' VA020-FSCL-WK-END-DTE              04870000
W34517             DISPLAY 'DEPT   ' VA020-DEPT-NBR                     04880000
W34517             DISPLAY 'SUB CL ' VA020-SUB-CL-NBR                   04890000
W34517             DISPLAY 'STR    ' VA020-STR-NBR                      04900000
W34517             DISPLAY 'MN DTE ' VA020-FSCL-MN-END-DTE              04910000
W34517             DISPLAY 'SLS AMT ' VA020-SLS-RTL-AMT                 04920000
                   MOVE '7200-INSERT-INSHNK-ROW' TO PV-PARAGRAPH-NAME   04930000
                   MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED04940000
                   PERFORM 9999-SQL-ABEND                               04950000
           END-EVALUATE.                                                04960000
                                                                        04970000
      ******************************************************************04980000
      * 7300-GET-COMMIT-TIMESTAMP.                                     *04990000
      * PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *05000000
      *            CONTROL TABLE                                       *05010000
      ******************************************************************05020000
       7300-GET-COMMIT-TIMESTAMP.                                       05030000
                                                                        05040000
      * CHECKPOINT TAKEN BASED ON DB2 CHECKPOINT RESTART TABLE          05050000
           EXEC SQL                                                     05060000
             SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       05070000
               INTO :PV-COMMIT-TIMESTAMP                                05080000
               FROM TCKRSTCNTL                                          05090000
              WHERE JOB_NAME  = :PC-JOB-NAME                            05100000
                AND PLAN_NAME = :PC-PROGRAM-NAME                        05110000
           END-EXEC.                                                    05120000
                                                                        05130000
           EVALUATE TRUE                                                05140000
               WHEN SQLCODE = 0                                         05150000
      **     DISPLAY 'NEXT COMMIT AT TIMESTAMP: ', PV-COMMIT-TIMESTAMP  05160000
                   CONTINUE                                             05170000
               WHEN SQLCODE NOT EQUAL ZERO                              05180000
                   MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME05190000
                   MOVE 'SELECT TMSTMP FROM TCKRSTCNTL'                 05200000
                                      TO PV-OPERATION-ATTEMPTED         05210000
                   PERFORM 9999-SQL-ABEND                               05220000
           END-EVALUATE.                                                05230000
                                                                        05240000
      ******************************************************************05250000
      * 7400-INIT-CHECKPOINT-SELECT                                    *05260000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *05270000
      *            IF WE ARE IN A RESTART CONDITION.                   *05280000
      ******************************************************************05290000
       7400-INIT-CHECKPOINT-SELECT.                                     05300000
                                                                        05310000
           EXEC SQL                                                     05320000
             SELECT  CKPT_STAT_CODE                                     05330000
                    ,CKPT_FRQNCY_QTY                                    05340000
               INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         05350000
                    ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        05360000
               FROM  TCKRSTCNTL                                         05370000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           05380000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       05390000
           END-EXEC.                                                    05400000
                                                                        05410000
           IF SQLCODE = 0                                               05420000
               CONTINUE                                                 05430000
           ELSE                                                         05440000
               MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  05450000
               MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     05460000
               PERFORM 9999-SQL-ABEND                                   05470000
           END-IF.                                                      05480000
                                                                        05490000
      ******************************************************************05500000
      * 7500-SELECT-RESTART-INFO                                       *05510000
      * PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *05520000
      *            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *05530000
      ******************************************************************05540000
       7500-SELECT-RESTART-INFO.                                        05550000
                                                                        05560000
           EXEC SQL                                                     05570000
             SELECT  WORK_STRG_DESC                                     05580000
               INTO  :TCKRSTINF-WORK-STRG-DESC                          05590000
               FROM  TCKRSTINF                                          05600000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           05610000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       05620000
           END-EXEC.                                                    05630000
                                                                        05640000
           IF SQLCODE = 0                                               05650000
               CONTINUE                                                 05660000
           ELSE                                                         05670000
               MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   05680000
               MOVE 'SELECT  FROM TCKRSTINF'                            05690000
                                      TO PV-OPERATION-ATTEMPTED         05700000
               PERFORM 9999-SQL-ABEND                                   05710000
           END-IF.                                                      05720000
                                                                        05730000
      ******************************************************************05740000
      * 7600-SET-CURRENT-TIMESTAMP.                                    *05750000
      * PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *05760000
      ******************************************************************05770000
       7600-SET-CURRENT-TIMESTAMP.                                      05780000
                                                                        05790000
           EXEC SQL                                                     05800000
                SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           05810000
           END-EXEC.                                                    05820000
           IF SQLCODE = 0                                               05830000
               CONTINUE                                                 05840000
           ELSE                                                         05850000
               MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 05860000
               MOVE 'SET TIMESTAMP'                                     05870000
                                      TO PV-OPERATION-ATTEMPTED         05880000
               PERFORM 9999-SQL-ABEND                                   05890000
           END-IF.                                                      05900000
                                                                        05910000
      ******************************************************************05920000
      * 7700-COMMIT-PROCESSING.                                        *05930000
      * PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *05940000
      *          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*05950000
      ******************************************************************05960000
       7700-COMMIT-PROCESSING.                                          05970000
           MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     05980000
                                                                        05990000
           PERFORM 7600-SET-CURRENT-TIMESTAMP.                          06000000
                                                                        06010000
      * PREPARE COMMIT RECORD FOR UPDATE                                06020000
           IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                06030000
W34517         MOVE VA020-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   06040000
W34517         MOVE VA020-DEPT-NBR            TO CR-DEPT-NBR            06050000
W34517         MOVE VA020-SUB-CL-NBR          TO CR-SUB-CL-NBR          06060000
W34517         MOVE VA020-STR-NBR             TO CR-STR-NBR             06070000
               MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    06080000
      *        MOVE COMMIT INFO TO WORKING STORAGE ROW                  06090000
               MOVE CR-CHECKPOINT-RESTART-AREA TO                       06100000
                                             TCKRSTINF-WORK-STRG-DESC   06110000
               IF PS-FIRST-COMMIT                                       06120000
                   MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                06130000
                   PERFORM 7900-UPDATE-CHECKPOINT-STATUS                06140000
                   MOVE 'N' TO PS-FIRST-COMMIT-SW                       06150000
               END-IF                                                   06160000
               PERFORM 7800-COMMIT-CHANGES                              06170000
               PERFORM 7300-GET-COMMIT-TIMESTAMP                        06180000
           END-IF.                                                      06190000
                                                                        06200000
      ******************************************************************06210000
      * 7800-COMMIT-CHANGES.                                            06220000
      * PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      06230000
      *            TAKE A COMMIT.                                       06240000
      *  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    06250000
      ******************************************************************06260000
       7800-COMMIT-CHANGES.                                             06270000
                                                                        06280000
           EXEC SQL                                                     06290000
             UPDATE TCKRSTINF                                           06300000
                SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          06310000
              WHERE JOB_NAME       = :PC-JOB-NAME                       06320000
                AND PLAN_NAME      = :PC-PROGRAM-NAME                   06330000
           END-EXEC.                                                    06340000
                                                                        06350000
           IF SQLCODE = 0                                               06360000
               CONTINUE                                                 06370000
      ****     DISPLAY 'COMMIT TAKEN ==>> ' CR-CHECKPOINT-RESTART-AREA  06380000
      ****             ' <<=='                                          06390000
           ELSE                                                         06400000
               MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED06410000
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06420000
               PERFORM 9999-SQL-ABEND                                   06430000
           END-IF.                                                      06440000
                                                                        06450000
           EXEC SQL                                                     06460000
               COMMIT                                                   06470000
           END-EXEC.                                                    06480000
                                                                        06490000
           IF SQLCODE = 0                                               06500000
               CONTINUE                                                 06510000
           ELSE                                                         06520000
               MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED06530000
               MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06540000
               PERFORM 9999-SQL-ABEND                                   06550000
           END-IF.                                                      06560000
                                                                        06570000
      ******************************************************************06580000
      * 7900-UPDATE-CHECKPOINT-STATUS                                   06590000
      * PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   06600000
      *                                                                 06610000
      ******************************************************************06620000
       7900-UPDATE-CHECKPOINT-STATUS.                                   06630000
                                                                        06640000
           EXEC SQL                                                     06650000
             UPDATE  TCKRSTCNTL                                         06660000
                SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        06670000
              WHERE  JOB_NAME  = :PC-JOB-NAME                           06680000
                AND  PLAN_NAME = :PC-PROGRAM-NAME                       06690000
           END-EXEC.                                                    06700000
                                                                        06710000
           IF SQLCODE = 0                                               06720000
               CONTINUE                                                 06730000
           ELSE                                                         06740000
               MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME06750000
               PERFORM 9999-SQL-ABEND                                   06760000
           END-IF.                                                      06770000
                                                                        06780000
           EJECT                                                        06790000
                                                                        06800000
      ******************************************************************06810000
      * PROGRAM RESTART DUE TO A DEADLOCK AGAINST TINSCL ROW FOR UPDATE 06820000
      *  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  06830000
      ******************************************************************06840000
       7999-RESTART-PROCESS.                                            06850000
                                                                        06860000
           SET PS-PROGRAM-DEADLOCKED TO TRUE.                           06870000
                                                                        06880000
           CLOSE CONDENSED-FILE.                                        06890000
                                                                        06900000
           PERFORM 7500-SELECT-RESTART-INFO.                            06910000
                                                                        06920000
           DISPLAY '**** RESTART **** '.                                06930000
           MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 06940000
           DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   06950000
      *-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      06960000
      *-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        06970000
      *-- RESTART INFORMATION IN NOT CLEARED OUT.                       06980000
           IF PS-FIRST-COMMIT                                           06990000
               INITIALIZE TCKRSTINF-WORK-STRG-DESC (1:28)               07000000
               DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     07010000
                      ' BEGINNING'                                      07020000
           ELSE                                                         07030000
               DISPLAY 'TCKRSTINF-LAST CKPT '                           07040000
                        TCKRSTINF-WORK-STRG-DESC (1:28)                 07050000
      * INFO ON LAST CHECKPOINT TAKEN IS IN CR-CHECKPOINT-RESTART-AREA. 07060000
               MOVE TCKRSTINF-WORK-STRG-DESC TO                         07070000
                    CR-CHECKPOINT-RESTART-AREA                          07080000
               DISPLAY 'CHECKPOINT RESTART INFORMATION:'                07090000
               DISPLAY 'WEEK  END DATE  ' CR-FISCAL-WK-END-DTE          07100000
               DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   07110000
               DISPLAY 'SUB CLASS NBR   ' CR-SUB-CL-NBR                 07120000
               DISPLAY 'STORE NBR       ' CR-STR-NBR                    07130000
               DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           07140000
           END-IF.                                                      07150000
                                                                        07160000
           OPEN INPUT CONDENSED-FILE.                                   07170000
           MOVE ZEROES                          TO PA-INPUT-COUNT.      07180000
                                                                        07190000
      *POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          07200000
           PERFORM 4000-READ-CONDENSED-FILE                             07210000
               UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               07220000
               OR PS-EOF-CONDENSED-FILE.                                07230000
                                                                        07240000
           IF PS-EOF-CONDENSED-FILE                                     07250000
               DISPLAY 'END OF INPUT FILE ON RESTART'                   07260000
           ELSE                                                         07270000
               DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              07280000
                        PA-INPUT-COUNT                                  07290000
W34517         DISPLAY 'FISCAL MONTH END DATE ' VA020-FSCL-MN-END-DTE   07300000
W34517         DISPLAY 'DEPARTMENT NBR        ' VA020-DEPT-NBR          07310000
W34517         DISPLAY 'SUB CLASS NBR         ' VA020-SUB-CL-NBR        07320000
W34517         DISPLAY 'STORE NBR             ' VA020-STR-NBR           07330000
           END-IF.                                                      07340000
                                                                        07350000
      ******************************************************************07360000
      *  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *07370000
      ******************************************************************07380000
       8000-EOJ-ROUTINE.                                                07390000
                                                                        07400000
           MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       07410000
           PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       07420000
                                                                        07430000
           DISPLAY 'INPUT RECORDS PROCESSED  ', PA-INPUT-COUNT.         07440000
           DISPLAY 'UPDATES PROCESSED        ', PA-UPDATE-COUNT.        07450000
           DISPLAY 'INSERTS PROCESSED        ', PA-INSERT-COUNT.        07460000
W33304     DISPLAY 'INPUT RECORDS SKIPPED    ', PA-SKIP-COUNT.          07461001
                                                                        07470000
           MOVE PA-SLS-RTL-AMT-IN   TO PD-DISPLAY-TOTAL.                07480000
           DISPLAY 'SLS-RTL-AMT INPUT : ', PD-DISPLAY-TOTAL.            07490000
           MOVE PA-SLS-RTL-AMT-TOT  TO PD-DISPLAY-TOTAL.                07500000
           DISPLAY 'SLS-RTL-AMT TOTAL : ', PD-DISPLAY-TOTAL.            07510000
                                                                        07520000
           CLOSE CONDENSED-FILE.                                        07530000
                                                                        07540000
      ******************************************************************07550000
      *  PERFROMED BY 7100-UPDATE AND 7200-INSERT                       07560000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   07570000
      ******************************************************************07580000
       9000-DEADLOCK-ERROR.                                             07590000
                                                                        07600000
               MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     07610000
               PERFORM 9999-SQL-ABEND.                                  07620000
                                                                        07630000
      ******************************************************************07640000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               07650000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             07660000
      ******************************************************************07670000
       9999-SQL-ABEND.                                                  07680000
                                                                        07690000
           MOVE +4013                 TO ABEND-CODE.                    07700000
           DISPLAY '**  ABEND     **'.                                  07710000
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              07720000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            07730000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       07740000
                                                                        07750000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         07760000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        07770000
                                                                        07780000
           COPY DPPD004.                                                07790000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           07800000
