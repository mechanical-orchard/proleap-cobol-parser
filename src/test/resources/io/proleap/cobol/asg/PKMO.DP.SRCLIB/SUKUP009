000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.    SUKUP009.                                         00040000
000500 AUTHOR.        DEANNA BRANTNER                                   00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN   MARCH, 2002.                                      00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*  THIS PROGRAM WILL READ AN INPUT FILE                           00100000
001100*  AND UPDATE THE TSUOBTS.FINCL_POST_TMST TO CURRENT TIMESTAMP.   00110000
001200******************************************************************00120000
001300 ENVIRONMENT DIVISION.                                            00130000
001400 CONFIGURATION SECTION.                                           00140000
001500                                                                  00150000
001600 SOURCE-COMPUTER.        IBM-3090.                                00160000
001700 OBJECT-COMPUTER.        IBM-3090.                                00170000
001800                                                                  00180000
001900 INPUT-OUTPUT SECTION.                                            00190000
002000                                                                  00200000
002100 FILE-CONTROL.                                                    00210000
002200                                                                  00220000
002300     SELECT TSUOBTS-UNLOAD-FILE                                   00230000
002400         ASSIGN TO INP01.                                         00240003
002500                                                                  00250000
002600*    SELECT OUTPUT-FILE                                           00260003
002700*        ASSIGN TO OUT01.                                         00270003
002800                                                                  00280000
002900******************************************************************00290000
003000 DATA DIVISION.                                                   00300000
003100 FILE SECTION.                                                    00310000
003200                                                                  00320000
003300 FD  TSUOBTS-UNLOAD-FILE                                          00330000
003400     RECORDING MODE IS F                                          00340000
003500     LABEL RECORDS ARE STANDARD                                   00350000
003600     BLOCK CONTAINS 0 RECORDS.                                    00360000
003700                                                                  00370000
003800 01  TSUOBTS-UNLOAD-RECORD             PIC X(13).                 00380000
003900*                                                                 00390000
004000*FD  OUTPUT-FILE                                                  00400003
004100*    RECORDING MODE IS F                                          00410003
004200*    LABEL RECORDS ARE STANDARD                                   00420003
004300*    BLOCK CONTAINS 0 RECORDS.                                    00430003
004400*                                                                 00440003
004500*01  OUTPUT-RECORD           PIC  X(013).                         00450003
004600******************************************************************00460000
004700 WORKING-STORAGE SECTION.                                         00470000
004800******************************************************************00480000
004900******************************************************************00490000
005000*  COPY BOOK FOR INPUT FILE                                       00500000
005100******************************************************************00510000
005200     COPY SURD012.                                                00520000
005300*                                                                 00530000
005400******************************************************************00540000
005500*  DB2 FORMATTED MESSAGE AREA                                     00550000
005600******************************************************************00560000
005700     COPY DPWS004.                                                00570000
005800*                                                                 00580000
005900******************************************************************00590000
006000*  COMMUNICATIONS AREA FOR DB2                                    00600000
006100******************************************************************00610000
006200     EXEC SQL                                                     00620000
006300          INCLUDE SQLCA                                           00630000
006400     END-EXEC.                                                    00640000
006500*                                                                 00650000
006600******************************************************************00660000
006700*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE TSUOBTR TABLE      00670000
006800******************************************************************00680000
006900     EXEC SQL                                                     00690000
007000          INCLUDE TSUOBTR                                         00700000
007100     END-EXEC.                                                    00710000
007200*                                                                 00720000
007300******************************************************************00730000
007400*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE TSUOBTS TABLE      00740000
007500******************************************************************00750000
007600     EXEC SQL                                                     00760000
007700          INCLUDE TSUOBTS                                         00770000
007800     END-EXEC.                                                    00780000
007900*                                                                 00790000
008000******************************************************************00800000
008100*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE TKRPRPM TABLE      00810000
008200******************************************************************00820000
008300     EXEC SQL                                                     00830000
008400          INCLUDE TKRPRPM                                         00840000
008500     END-EXEC.                                                    00850000
008600*                                                                 00860000
008700******************************************************************00870000
008800 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00880000
008900                                                   COMP SYNC.     00890000
009000                                                                  00900000
009100 01  PS-PROGRAM-SWITCHES.                                         00910000
009200     05  PS-END-OF-FILE-SW           PIC  X(01)    VALUE 'N'.     00920000
009300         88  PS-END-OF-FILE                        VALUE 'Y'.     00930000
009400         88  PS-NOT-END-OF-FILE                    VALUE 'N'.     00940000
009500                                                                  00950000
009600 01  PC-PROGRAM-CONSTANTS.                                        00960000
009700     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00970000
009800                                                   COMP SYNC.     00980000
009900     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00990000
010000         'SUKUP009'.                                              01000000
010100     05  PC-CURRENT-OPERATING-COMPANY                             01010000
010200                                     PIC  X(02)    VALUE '03'.    01020000
010300     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01030000
010400                                                   COMP SYNC.     01040000
010500     05  PC-UPDATE-TIMESTAMP         PIC  X(26)    VALUE SPACES.  01050000
010600     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  01060000
010700     05  PC-DEFAULT-TIMESTAMP        PIC  X(26)    VALUE          01070000
010800                               '1111-11-11-11.11.11.111111'.      01080000
010900                                                                  01090000
011000 01  PV-PROGRAM-VARIABLES.                                        01100000
011100     05  PV-STAT-CDE                 PIC  X(02)    VALUE SPACES.  01110000
011200     05  PV-ITEM-NBR                 PIC  9(15)    VALUE ZERO.    01120000
011300     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01130000
011400     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01140000
011500     05  PV-READ-COUNTER             PIC S9(09)    VALUE ZERO     01150000
011600                                                   COMP SYNC.     01160000
011700     05  PV-UPDATE-COUNTER           PIC S9(09)    VALUE ZERO     01170000
011800                                                   COMP SYNC.     01180000
011900     05  PV-UPDATE-COUNTER-2         PIC S9(09)    VALUE ZERO     01190000
012000                                                   COMP SYNC.     01200000
012100     05  PV-SHIPPED-ONLY-COUNT       PIC S9(09)    VALUE ZERO     01210000
012200                                                   COMP SYNC.     01220000
012300     05  PV-UNLOADED-ONLY-COUNT      PIC S9(09)    VALUE ZERO     01230000
012400                                                   COMP SYNC.     01240000
012500     05  PV-SHIP-UNLOAD-COUNT        PIC S9(09)    VALUE ZERO     01250000
012600                                                   COMP SYNC.     01260000
012700     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01270000
012800     05  PV-DISPLAY-SQLCODE          PIC +999.                    01280000
012900     05  PV-DISPLAY-TRIP             PIC Z(11).                   01290000
013000                                                                  01300000
013100     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01310000
013200                                                   COMP-3.        01320000
013300                                                                  01330000
013400******************************************************************01340000
013500 PROCEDURE DIVISION.                                              01350000
013600******************************************************************01360000
013700******************************************************************01370000
013800* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01380000
013900*      PROGRAM.                                                   01390000
014000******************************************************************01400000
014100 0000-PROGRAM-MAINLINE.                                           01410000
014200                                                                  01420000
014300     PERFORM 1000-INITIALIZE.                                     01430000
014400     IF PS-NOT-END-OF-FILE                                        01440000
014500         PERFORM 2000-PROCESS-TSUOBTS-FILE                        01450000
014600            UNTIL PS-END-OF-FILE                                  01460000
014700     END-IF.                                                      01470000
014800     PERFORM 9000-EOJ-ROUTINE.                                    01480000
014900                                                                  01490000
015000     STOP RUN.                                                    01500000
015100                                                                  01510000
015200******************************************************************01520000
015300*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    01530000
015400*    -- OPEN OUTPUT FILE                                          01540000
015500*    -- READ INPUT FILE                                           01550000
015600******************************************************************01560000
015700 1000-INITIALIZE.                                                 01570000
015800                                                                  01580000
015900     OPEN INPUT  TSUOBTS-UNLOAD-FILE                              01590000
016000*        OUTPUT  OUTPUT-FILE.                                     01600003
016100                                                                  01610000
016200     EXEC SQL                                                     01620000
016300          SELECT CURRENT TIMESTAMP                                01630000
016400            INTO  :PC-CURRENT-TIMESTAMP                           01640000
016500            FROM  SYSIBM.SYSDUMMY1                                01650000
016600     END-EXEC.                                                    01660000
016700     DISPLAY '* * * * * * * * * * * '.                            01670000
016800     DISPLAY 'CURRENT PROGRAM ' PC-CURRENT-PROGRAM-NAME.          01680000
016900     DISPLAY 'TMST USED FOR THIS RUN ' PC-CURRENT-TIMESTAMP.      01690000
017000                                                                  01700000
017100     PERFORM 7000-READ-FILE.                                      01710000
017200                                                                  01720000
017300******************************************************************01730000
017400*  UPDATE THE FINCL_POST_TMST WITH THE CURRENT TIMESTAMP.  READ   01740000
017500*  NEXT RECORD.                                                   01750000
017600******************************************************************01760000
017700 2000-PROCESS-TSUOBTS-FILE.                                       01770000
017800                                                                  01780000
017900*    PERFORM 3000-CHECK-IF-DC-INTRNST.                            01790001
018000     IF SU012-SHIPPED-FROM-DC AND SU012-NOT-UNLOADED-AT-STORE     01800000
018100         MOVE 'DS' TO PV-STAT-CDE                                 01810000
018200         ADD  1  TO  PV-SHIPPED-ONLY-COUNT                        01820000
018300     ELSE                                                         01830000
018400        IF SU012-NOT-SHIPPED-FROM-DC AND SU012-UNLOADED-AT-STORE  01840000
018500            MOVE 'SU' TO PV-STAT-CDE                              01850000
018600         ADD  1  TO  PV-UNLOADED-ONLY-COUNT                       01860000
018700        ELSE                                                      01870000
018800            IF SU012-SHIPPED-FROM-DC AND SU012-UNLOADED-AT-STORE  01880000
018900                MOVE 'DS' TO PV-STAT-CDE                          01890000
019000                PERFORM 8000-UPDATE-TSUOBTS                       01900000
019100                MOVE 'SU' TO PV-STAT-CDE                          01910000
019200                ADD  1  TO  PV-SHIP-UNLOAD-COUNT                  01920000
019300            END-IF                                                01930000
019400        END-IF                                                    01940000
019500     END-IF.                                                      01950000
019600     PERFORM 8000-UPDATE-TSUOBTS.                                 01960000
019700*    PERFORM 6000-WRITE-OUTPUT.                                   01970002
019800                                                                  01980000
019900     IF  PV-UPDATE-COUNTER-2  > 10                                01990000
020000         EXEC SQL                                                 02000000
020100              COMMIT                                              02010000
020200         END-EXEC                                                 02020000
020300         MOVE  ZEROES  TO  PV-UPDATE-COUNTER-2                    02030000
020400     END-IF.                                                      02040000
020500                                                                  02050000
020600     PERFORM 7000-READ-FILE.                                      02060000
020700                                                                  02070000
020800******************************************************************02080000
020900*  CHECK DC TO SEE IF THE DC HAS STARTED INTRANSIT PROCESSING.    02090000
021000******************************************************************02100000
021100*3000-CHECK-IF-DC-INTRNST.                                        02110001
021200*     MOVE SU012-TRIP-ID  TO SUOBTR-OTBND-TRIP-ID.                02120001
021300*     EXEC SQL                                                    02130001
021400*         SELECT A.ORGN_OPER_UNT_ID                               02140001
021500*         INTO  :SUOBTR-ORGN-OPER-UNT-ID                          02150001
021600*         FROM  TSUOBTR A                                         02160001
021700*              ,TKRPRPM C                                         02170001
021800*         WHERE  A.OTBND_TRIP_ID     =  :SUOBTR-OTBND-TRIP-ID     02180001
021900*           AND  A.ORGN_OPER_UNT_ID  =  C.LOC_ID                  02190001
022000*           AND  C.INTFC_SYS_CDE     = 'KHL'                      02200001
022100*           AND  C.SYS_PRC_FUNC_CDE  = 'INTTRK'                   02210001
022200*           AND  C.FUNC_PRC_STAT_CDE = 'AC'                       02220001
022300*           AND  C.FUNC_TXT          = 'Y'                        02230001
022400*     END-EXEC.                                                   02240001
022500*                                                                 02250001
022600*    EVALUATE TRUE                                                02260001
022700*        WHEN SQLCODE = ZERO                                      02270001
022800*            MOVE PC-CURRENT-TIMESTAMP  TO PC-UPDATE-TIMESTAMP    02280001
022900*            MOVE 'Y'                   TO SU012-INTRNST-SW       02290001
023000*            MOVE SQLCODE               TO PV-DISPLAY-SQLCODE     02300001
023100*            MOVE SU012-TRIP-ID         TO PV-DISPLAY-TRIP        02310001
023200*            DISPLAY 'INTRANSIT ======= '                         02320001
023300*                     PV-DISPLAY-TRIP '==' PV-DISPLAY-SQLCODE     02330001
023400*        WHEN OTHER                                               02340001
023500*            MOVE PC-DEFAULT-TIMESTAMP  TO PC-UPDATE-TIMESTAMP    02350001
023600*            MOVE 'N'                   TO SU012-INTRNST-SW       02360001
023700*            MOVE SQLCODE               TO PV-DISPLAY-SQLCODE     02370001
023800*            MOVE SU012-TRIP-ID         TO PV-DISPLAY-TRIP        02380001
023900*            DISPLAY 'NOT INTRANSIT === '                         02390001
024000*                     PV-DISPLAY-TRIP '==' PV-DISPLAY-SQLCODE     02400001
024100*    END-EVALUATE.                                                02410001
024200*                                                                 02420001
024300******************************************************************02430000
024400*  LB TE OUTPUT FILE.                                             02440000
024500******************************************************************02450000
024600*6000-WRITE-OUTPUT.                                               02460002
024700*                                                                 02470002
024800*    WRITE OUTPUT-RECORD FROM                                     02480002
024900*          SU012-EXTRACT-RECORD.                                  02490002
025000*                                                                 02500002
025100******************************************************************02510000
025200*  READ INPUT FILE.                                               02520000
025300******************************************************************02530000
025400 7000-READ-FILE.                                                  02540000
025500      INITIALIZE SU012-EXTRACT-RECORD.                            02550000
025600                                                                  02560000
025700      READ TSUOBTS-UNLOAD-FILE INTO                               02570000
025800           SU012-EXTRACT-RECORD                                   02580000
025900            AT END SET PS-END-OF-FILE TO TRUE.                    02590000
026000                                                                  02600000
026100      IF PS-END-OF-FILE                                           02610000
026200          CONTINUE                                                02620000
026300      ELSE                                                        02630000
026400          ADD +1 TO PV-READ-COUNTER                               02640000
026500      END-IF.                                                     02650000
026600                                                                  02660000
026700******************************************************************02670000
026800*  UPDATE THE FINCL_POST_TMST TO CURRENT TIMESTAMP.               02680000
026900******************************************************************02690000
027000 8000-UPDATE-TSUOBTS.                                             02700000
027100                                                                  02710000
027200     EXEC SQL                                                     02720000
027300          UPDATE TSUOBTS                                          02730000
027400             SET FINCL_POST_TMST = :PC-CURRENT-TIMESTAMP          02740004
027500           WHERE OTBND_TRIP_ID   = :SU012-TRIP-ID                 02750000
027600             AND TRIP_STAT_CDE   = :PV-STAT-CDE                   02760000
027700     END-EXEC.                                                    02770000
027800                                                                  02780000
027900     EVALUATE TRUE                                                02790000
028000         WHEN SQLCODE = ZERO                                      02800000
028100             ADD +1 TO PV-UPDATE-COUNTER                          02810000
028200             ADD +1 TO PV-UPDATE-COUNTER-2                        02820000
028300         WHEN SQLCODE = +100                                      02830000
028400             CONTINUE                                             02840000
028500         WHEN SQLWARN0 NOT = SPACES                               02850000
028600         WHEN SQLCODE < ZERO                                      02860000
028700         WHEN SQLCODE > ZERO                                      02870000
028800             MOVE '8000-UPDATE-TSUOBTS '                          02880000
028900                                 TO PV-PARAGRAPH-NAME             02890000
029000             MOVE 'UPDATE TSUOBTS '                               02900000
029100                                 TO PV-DB2-OPERATION-ATTEMPTED    02910000
029200             DISPLAY 'TRIP ID BEING PROCESSED IS '                02920000
029300                     SU012-TRIP-ID                                02930000
029400             PERFORM 9100-SQL-ABEND                               02940000
029500     END-EVALUATE.                                                02950000
029600                                                                  02960000
029700******************************************************************02970000
029800*  CLOSE INPUT FILE.  DISPLAY COUNTERS.                           02980000
029900******************************************************************02990000
030000 9000-EOJ-ROUTINE.                                                03000000
030100     CLOSE TSUOBTS-UNLOAD-FILE                                    03010000
030200*          OUTPUT-FILE.                                           03020003
030300                                                                  03030000
030400     MOVE PV-READ-COUNTER              TO  PV-DISPLAY-COUNT.      03040000
030500     DISPLAY 'TOTAL RECORDS READ    '      PV-DISPLAY-COUNT.      03050000
030600     MOVE PV-UPDATE-COUNTER            TO  PV-DISPLAY-COUNT.      03060000
030700     DISPLAY 'TOTAL TSUOBTS UPDATED '      PV-DISPLAY-COUNT.      03070000
030800     MOVE PV-SHIPPED-ONLY-COUNT        TO  PV-DISPLAY-COUNT.      03080000
030900     DISPLAY 'SHIPPED ONLY COUNT    '      PV-DISPLAY-COUNT.      03090000
031000     MOVE PV-UNLOADED-ONLY-COUNT       TO  PV-DISPLAY-COUNT.      03100000
031100     DISPLAY 'UNLOADED ONLY COUNT   '      PV-DISPLAY-COUNT.      03110000
031200     MOVE PV-SHIP-UNLOAD-COUNT         TO  PV-DISPLAY-COUNT.      03120000
031300     DISPLAY 'SHIP/UNLOAD COUNT     '      PV-DISPLAY-COUNT.      03130000
031400     DISPLAY '* * * * * * * * * * * '.                            03140000
031500                                                                  03150000
031600******************************************************************03160000
031700*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03170000
031800*  ERROR OR WARNING CODE OCCURS.                                  03180000
031900******************************************************************03190000
032000 9100-SQL-ABEND.                                                  03200000
032100     DISPLAY '9100-SQL-ABEND'.                                    03210000
032200     DISPLAY '** ABEND     **'.                                   03220000
032300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03230000
032400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03240000
032500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03250000
032600                                                                  03260000
032700******************************************************************03270000
032800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03280000
032900* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         03290000
033000* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     03300000
033100* FORMAT.                                                         03310000
033200******************************************************************03320000
033300     COPY DPPD004.                                                03330000
033400                                                                  03340000
033500     MOVE +4013                  TO ABEND-CODE.                   03350000
033600     CALL 'ILBOABN0' USING ABEND-CODE.                            03360000
