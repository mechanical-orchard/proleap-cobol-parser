000100****************************************************************  00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300****************************************************************  00030000
000400 PROGRAM-ID.    SUKUP016.                                         00040000
000500 AUTHOR.        GERMAN BANDA.                                     00050000
000600 DATE-WRITTEN.  OCTOBER, 2003.                                    00060000
000700                                                                  00070000
000800****************************************************************  00080000
000900*  THIS PROGRAM WILL SELECT FROM THE PARM TABLE (TKRPRPM) TO      00090000
001000*  DETERMINE A PURGE DATE. IF THE RECORD ON THE ARCHIVE FILE      00100000
001100*  (PKMO.SU.SHIPMENT.LOC.SUK100) IS OLDER THEN THE PARM DATE, THE 00110000
001200*  RECORD WILL BE WRITTEN TO AN NEW GENERATION FILE.              00120000
001210*  THIS WILL HELP MAINTAIN THE SIZE OF THE ROLLING ARCHIVE FILE   00121000
001300****************************************************************  00130000
001400                                                                  00140000
001500****************************************************************  00150000
001600 ENVIRONMENT DIVISION.                                            00160000
001700****************************************************************  00170000
001800                                                                  00180000
001900****************************************************************  00190000
002000 INPUT-OUTPUT SECTION.                                            00200000
002100****************************************************************  00210000
002200                                                                  00220000
002300****************************************************************  00230000
002400 FILE-CONTROL.                                                    00240000
002500****************************************************************  00250000
002600     SELECT INPUT-FILE                                            00260000
002700         ASSIGN TO INP01.                                         00270000
002800                                                                  00280000
002801     SELECT ARCHIVE-FILE-OUT                                      00280100
002802         ASSIGN TO OUT01.                                         00280200
002803                                                                  00280300
002804     SELECT ARCHIVE-FILE2-OUT                                     00280400
002805         ASSIGN TO OUT02.                                         00280500
002900****************************************************************  00290000
003000 DATA DIVISION.                                                   00300000
003100****************************************************************  00310000
003200                                                                  00320000
003300****************************************************************  00330000
003400 FILE SECTION.                                                    00340000
003500****************************************************************  00350000
003600                                                                  00360000
003700 FD  INPUT-FILE                                                   00370000
003800     RECORDING MODE IS F                                          00380000
003900     LABEL RECORDS ARE STANDARD                                   00390000
004000     RECORD CONTAINS 118                                          00400000
004100     BLOCK CONTAINS 0 RECORDS                                     00410000
004200     DATA RECORD IS INPUT-RECORD.                                 00420000
004300 01  INPUT-RECORD                        PIC  X(118).             00430000
004400                                                                  00440000
004410 FD  ARCHIVE-FILE-OUT                                             00441000
004420     RECORDING MODE IS F                                          00442000
004430     LABEL RECORDS ARE STANDARD                                   00443000
004440     BLOCK CONTAINS 0 RECORDS.                                    00444000
004450                                                                  00445000
004460 01  ARCHIVE-RECORD-OUT               PIC  X(118).                00446000
004470                                                                  00447000
004480 FD  ARCHIVE-FILE2-OUT                                            00448000
004490     RECORDING MODE IS F                                          00449000
004491     LABEL RECORDS ARE STANDARD                                   00449100
004492     BLOCK CONTAINS 0 RECORDS.                                    00449200
004493                                                                  00449300
004494 01  ARCHIVE-RECORD2-OUT               PIC  X(118).               00449400
004495                                                                  00449500
004500                                                                  00450000
004600                                                                  00460000
004700/                                                                 00470000
004800 WORKING-STORAGE SECTION.                                         00480000
004900                                                                  00490000
005015 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO   00501500
005016                                                     COMP SYNC.   00501600
005017                                                                  00501700
005018 01  PV-PROGRAM-VARIABLES.                                        00501800
005019     05  PV-PARAGRAPH-NAME              PIC  X(30)  VALUE SPACES. 00501900
005020     05  PV-DB2-OPERATION-ATTEMPTED     PIC  X(30)  VALUE SPACES. 00502000
005030     05  PV-NULL-IND-1                  PIC S9(04)  VALUE +0      00503000
005040                                                    COMP.         00504000
005050     05  PV-NUMBER-READS                 PIC 9(09).               00505009
005061     05  PV-NUMBER-READS-TOTAL           PIC 9(09).               00506109
005070     05  PV-WRITE-COUNTER-ARCH           PIC 9(09).               00507009
005072     05  PV-WRITE-COUNTER-PURGE          PIC 9(09).               00507209
005075     05  PV-COMMIT-COUNTER               PIC 9(09)     VALUE ZERO.00507509
005080     05  PV-COMMIT-COUNT                 PIC S9(09)    VALUE +0   00508000
005090                                                   COMP SYNC.     00509000
005100     05  PV-NBR-SUM-UPDATES              PIC S9(09)  VALUE ZERO   00510000
005200                                                     COMP-3.      00520000
005300     05  PV-ABEND-PARAGRAPH              PIC  X(30)  VALUE SPACE. 00530000
005400     05  PV-DISPLAY-FIELD                PIC  9(09)  VALUE ZEROS. 00540000
005410     05  PV-DISPLAY-COUNT                PIC ZZZ,ZZZ,ZZ9.         00541000
005500     05  PV-DISPLAY-CRTN                 PIC  9(18)  VALUE ZEROS. 00550000
005600     05  PV-DISPLAY-ORIG-CRTN            PIC  9(18)  VALUE ZEROS. 00560000
005700     05  PV-CICS-MSG-AREA                PIC  X(80) VALUE SPACE.  00570000
005800     05  PV-CICS-RESPONSE                PIC S9(08) VALUE ZEROS   00580000
005900                                                    COMP SYNC.    00590000
005910     05  PV-PURGE-DATE                   PIC  X(10) VALUE SPACE.  00591000
006000 01  PC-PROGRAM-CONSTANTS.                                        00600000
006100     05  PC-CURRENT-PROGRAM-NAME         PIC  X(08)  VALUE        00610000
006200         'SUKUP016'.                                              00620000
006300     05  PC-COMMIT-HOLD                  PIC 9(5)    VALUE 10000. 00630000
006310     05  PC-READ-COUNTER                 PIC 9(7)    VALUE        00631008
006320                                                     5000000.     00632009
006400 01  DK-DB2-KEYS.                                                 00640000
006500     05  DK-OPER-UNT-ID                  PIC S9(04)  VALUE ZEROS  00650000
006600                                                     COMP.        00660000
006610     05  DK-PURGE-WEEKS                  PIC S9(09)  COMP.        00661000
006700                                                                  00670000
006800 01  PS-PROGRAM-SWITCHES.                                         00680000
006900     05  PS-END-OF-INPUT-SW              PIC  X(01)  VALUE 'N'.   00690000
007000         88  PS-END-OF-INPUT                         VALUE 'Y'.   00700000
007010         88  PS-NOT-END-OF-INPUT                     VALUE 'N'.   00701000
007400                                                                  00740000
007410*-----------------------------------------------------------------00741001
007420*  RECORD LAYOUT FOR THE ARCHIVE FILE INPUT AND OUTPUT            00742001
007430*-----------------------------------------------------------------00743001
007440     COPY SURD020.                                                00744001
007450                                                                  00745001
007500*---------------------------------------------------------------* 00750000
007600*  COPY BOOK FOR DB2 FORMATTED MESSAGE AREA                       00760000
007700*---------------------------------------------------------------* 00770000
007800     COPY DPWS004.                                                00780000
007900                                                                  00790000
008000*                                                                 00800000
008100*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE PARAMETER TABLE    00810000
008200*                                                                 00820000
008300     EXEC SQL                                                     00830000
008400          INCLUDE TKRPRPM                                         00840000
008500     END-EXEC.                                                    00850000
008600*                                                                 00860000
008700*  COMMUNICATION AREAS FOR DB2                                    00870000
008800*                                                                 00880000
008900     EXEC SQL                                                     00890000
009000         INCLUDE SQLCA                                            00900000
009100     END-EXEC.                                                    00910000
009200                                                                  00920000
009300***************************************************************** 00930000
009400                                                                  00940000
009500******************************************************************00950000
009600 PROCEDURE DIVISION.                                              00960000
009700******************************************************************00970000
009800                                                                  00980000
009900 0000-MAINLINE.                                                   00990000
010000                                                                  01000000
010100     OPEN INPUT  INPUT-FILE.                                      01010005
010200     OPEN OUTPUT ARCHIVE-FILE-OUT                                 01020005
010210                 ARCHIVE-FILE2-OUT.                               01021000
010300     PERFORM 6000-READ-INPUT.                                     01030000
010400                                                                  01040000
010500     IF PS-NOT-END-OF-INPUT                                       01050000
010510        PERFORM 1000-SELECT-PARM-DATE                             01051000
010520     END-IF                                                       01052000
010530                                                                  01053000
010600     PERFORM 2200-PROCESS-FILE                                    01060000
010700       UNTIL  PS-END-OF-INPUT.                                    01070000
011000                                                                  01100000
011100     DISPLAY '***END OF FILE TOTALS****'                          01110000
011110     MOVE PV-NUMBER-READS-TOTAL TO PV-DISPLAY-COUNT               01111000
011120                                                                  01112000
011130     DISPLAY 'NUMBER OF RECORDS READ:  ' PV-DISPLAY-COUNT         01113000
011140     MOVE ZEROES              TO PV-NUMBER-READS                  01114000
011150                                 PV-DISPLAY-COUNT                 01115000
011160     MOVE PV-WRITE-COUNTER-PURGE TO PV-DISPLAY-COUNT              01116000
011170     DISPLAY 'NUMBER OF PURGE RECORDS: ' PV-DISPLAY-COUNT         01117000
011180                                                                  01118000
011181     MOVE ZEROES              TO PV-DISPLAY-COUNT                 01118100
011190                                                                  01119000
011191     MOVE PV-WRITE-COUNTER-ARCH  TO PV-DISPLAY-COUNT              01119100
011192     DISPLAY 'NUMBER OF ARCHV RECORDS: ' PV-DISPLAY-COUNT         01119200
011193                                                                  01119300
012300     CLOSE INPUT-FILE                                             01230000
012410           ARCHIVE-FILE-OUT                                       01241000
012420           ARCHIVE-FILE2-OUT.                                     01242000
012500     GOBACK.                                                      01250000
012600                                                                  01260000
012610******************************************************************01261000
012620*  SELECT THE NUMBER OF PURGE DATE FROM THE PARM TABLE            01262000
012630******************************************************************01263000
012640 1000-SELECT-PARM-DATE.                                           01264000
012641     EXEC SQL                                                     01264100
012642         SELECT  (CURRENT_DATE -                                  01264200
012643                  (FUNC_QTY * 7) DAYS)                            01264300
012644           INTO :PV-PURGE-DATE                                    01264400
012647           FROM TKRPRPM                                           01264700
012648          WHERE LOC_ID            =  90                           01264800
012649            AND INTFC_SYS_CDE     = 'KHL'                         01264900
012650            AND SYS_PRC_FUNC_CDE  = 'ARCHPG'                      01265000
012651            AND FUNC_PRC_STAT_CDE = 'AC'                          01265100
012660     END-EXEC.                                                    01266000
012692                                                                  01269200
012693     EVALUATE TRUE                                                01269300
012694         WHEN SQLCODE = ZERO                                      01269400
012695             CONTINUE                                             01269500
012697         WHEN OTHER                                               01269700
012698             MOVE '1000-SELECT-PARM-WEEKS' TO                     01269800
012700                                            PV-ABEND-PARAGRAPH    01270000
012701             MOVE SQLCODE   TO PV-DB2-OPERATION-ATTEMPTED         01270100
012707             PERFORM 9100-SQL-ABEND                               01270700
012708     END-EVALUATE.                                                01270800
012709                                                                  01270900
012710                                                                  01271000
012711******************************************************************01271100
012738                                                                  01273800
012740 2200-PROCESS-FILE.                                               01274000
012800                                                                  01280000
013300        IF SU020-BUILD-DATE < PV-PURGE-DATE                       01330000
013400           PERFORM 8000-WRITE-ARCH-RECORD-PURGE                   01340000
013500        ELSE                                                      01350000
013610           PERFORM 8100-WRITE-ARCH-RECORD-CURR                    01361000
013700        END-IF                                                    01370000
014200                                                                  01420000
014300     IF PV-NUMBER-READS > PC-READ-COUNTER                         01430002
015100        MOVE PV-NUMBER-READS-TOTAL TO PV-DISPLAY-COUNT            01510002
015110                                                                  01511002
015200        DISPLAY 'NUMBER OF RECORDS READ:  ' PV-DISPLAY-COUNT      01520002
015300        MOVE ZEROES              TO PV-NUMBER-READS               01530002
015301                                    PV-DISPLAY-COUNT              01530102
015310        MOVE PV-WRITE-COUNTER-PURGE TO PV-DISPLAY-COUNT           01531002
015330        DISPLAY 'NUMBER OF PURGE RECORDS: ' PV-DISPLAY-COUNT      01533002
015340                                                                  01534002
015341        MOVE ZEROES              TO PV-DISPLAY-COUNT              01534102
015350                                                                  01535002
015360        MOVE PV-WRITE-COUNTER-ARCH  TO PV-DISPLAY-COUNT           01536002
015370        DISPLAY 'NUMBER OF ARCHV RECORDS: ' PV-DISPLAY-COUNT      01537002
015371        MOVE ZEROES              TO PV-DISPLAY-COUNT              01537102
015380                                                                  01538002
015400     END-IF                                                       01540002
015600                                                                  01560000
016000                                                                  01600000
016100     PERFORM 6000-READ-INPUT.                                     01610000
019100 6000-READ-INPUT.                                                 01910000
019200                                                                  01920000
019210     INITIALIZE SU020-VEND-ARCHIVE-RECORD                         01921000
019220                                                                  01922000
019230     READ INPUT-FILE                                              01923000
019240          INTO SU020-VEND-ARCHIVE-RECORD                          01924000
019250            AT END                                                01925000
019260               SET PS-END-OF-INPUT  TO TRUE                       01926000
019270                                                                  01927000
019280            NOT AT END                                            01928000
019290               SET PS-NOT-END-OF-INPUT  TO TRUE                   01929000
019291               ADD +1 TO PV-NUMBER-READS                          01929100
019292                         PV-NUMBER-READS-TOTAL                    01929200
019293     END-READ.                                                    01929300
020200                                                                  02020000
020292******************************************************************02029200
020293*  WRITE THE OUTPUT RECORD FILE 1                                 02029300
020294*  RECORDS THAT HAVE A BUILD DATE OLDER THEN THE PARM DATE        02029400
020295******************************************************************02029500
020296 8000-WRITE-ARCH-RECORD-PURGE.                                    02029600
020297                                                                  02029700
020298     WRITE ARCHIVE-RECORD-OUT                                     02029804
020299       FROM SU020-VEND-ARCHIVE-RECORD.                            02029900
020300                                                                  02030000
020301     ADD +1 TO PV-WRITE-COUNTER-PURGE.                            02030100
020302                                                                  02030200
020303******************************************************************02030300
020304*  WRITE THE OUTPUT RECORD FILE 2                                 02030400
020305******************************************************************02030500
020306 8100-WRITE-ARCH-RECORD-CURR.                                     02030600
020307                                                                  02030700
020308     WRITE ARCHIVE-RECORD2-OUT                                    02030804
020309       FROM SU020-VEND-ARCHIVE-RECORD.                            02030900
020310                                                                  02031000
020311     ADD +1 TO PV-WRITE-COUNTER-ARCH.                             02031100
020313                                                                  02031300
020320 9100-SQL-ABEND.                                                  02032000
020400******************************************************************02040000
020500*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02050000
020600*  ERROR OR WARNING CODE OCCURS.                                  02060000
020700******************************************************************02070000
020800     DISPLAY '9100-SQL-ABEND'.                                    02080000
020900     DISPLAY '** ABEND     **'.                                   02090000
021000     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02100000
021100     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02110000
021200     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     02120000
021300                                                                  02130000
021400******************************************************************02140000
021500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02150000
021600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02160000
021700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02170000
021800* FORMAT.                                                         02180000
021900******************************************************************02190000
022000     COPY DPPD004.                                                02200000
022100                                                                  02210000
022200     MOVE +4013                  TO ABEND-CODE.                   02220000
022300     CALL 'ILBOABN0' USING ABEND-CODE.                            02230000
022400*9100-EXIT.                                                       02240000
022500                                                                  02250000
