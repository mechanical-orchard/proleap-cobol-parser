000100*----------------------------------------------------------------*00010099
000200 IDENTIFICATION DIVISION.                                         00020099
000300*----------------------------------------------------------------*00030099
000400 PROGRAM-ID.           EPKUT075.                                  00040099
000500 AUTHOR.               DOUG JONES.                                00050099
000600 INSTALLATION.         KOHLS DEPARTMENT STORES.                   00060099
000700 DATE-WRITTEN          JANUARY 2003.                              00070099
000800 DATE-COMPILED.                                                   00080099
000900                                                                  00090099
001000******************************************************************00100099
001100*    THIS PROGRAM WILL RUN WEEKLY AND EVALUATE THE LOWEST UNIT   *00110099
001200*    RETAIL TABLE.  IT WILL LOOK AT ALL INTERNAL UPC / AD VERSION*00120099
001300*    COMBINATIONS FOR THE OLDEST WEEK.  THE PROGRAM WILL LOOK    *00130099
001400*    FIRST TO SEE IF ANOTHER ROW EXISTS ON THE TABLE ACCORSS ALL *00140099
001500*    WEEKS OF HISTORICAL, AND THEN COMPARE  THE MINIMUM VALUE    *00150099
001600*    IF ONE EXISTS TO THE ROW FROM THE OLDEST WEEK BEING         *00160099
001700*    DELETED.  IF IT'S GREATER THAN THE ROW BEING DELETED,       *00170099
001800*    A RECORD WOULD BE WRITTEN TO A FILE TO INFORM THE PLU       *00180099
001900*    PROCESS THAT A NEW LOWEST 13  WEEK PRICE NOW EXISTS.        *00190099
002000*    IF THE MINIMUM ROW IS LOWER THAN THE ROW BEING DELETED,     *00200099
002100*    NO RECORD IS WRITTEN AS THE PLU PROCESS WOULD'VE BEEN MADE  *00210099
002200*    AWARE OF THE NEW LOWEST PRICE VIA NIGHTLY PROCESSING.       *00220099
002300*                                                                *00230099
002400*    IF NO MINIMUM VALUE IS FOUND ACCROSS HISTORY FOR THE SKU    *00240099
002500*    ADVERSION COMBINATION, THEN A FILE IS WRITTEN OUT TO INFORM *00250099
002600*    THE PLU CHANGES PROCES THAT A NEW LOWEST 13  WEEK PRICE     *00260099
002700*    DOES NOT EXIST, AND THAT IT NEEDS TO SEND THE REGULAR RETAIL*00270099
002800*    AMOUNT TO THE STORE AS THE LOWEST 13  WEEK VALUE.           *00280099
002810*-----------------------------------------------------------      00281099
002820* HISTORY LOG:                                                    00282099
002830*-----------------------------------------------------------      00283099
002840* DATE:        12/05/11                                           00284099
002850* WR/IR#:      WR#21599                                           00285099
002860* PROGRAMMER:  ROB SWAGER                                         00286099
002870* DESCRIPTION: EXTEND LOWEST 6 WEEK RETURN PRICE PROCESSING       00287099
002880*              TO 13 WEEKS.                                       00288099
002891*                                                                 00289199
002892*----------------------------------------------------------       00289299
002893* DATE:        04/23/20                                           00289399
002894* CHG:CHG0243538                                                  00289499
002895* PROGRAMMER:  GERMAN BANDA                                       00289599
002896* DESCRIPTION: COMMENT OUT DELETE PARA  3000-DEL-EPT_LO_RT.       00289699
002897*              PERFORMING SINGLE GROUP DELETE CAUSING STRAIN ON   00289799
002898*              DB2 IN WRITING LOG FILES. NEW FILE                 00289899
002899*              CURR-LWST-DROP-ITM-FILE WILL BE CREATED AND        00289999
002900*              WILL BE READ INTO NEW PROGRAM(EPKUP107). NEW       00290099
002901*              PROGRAM WILL PERFORM INDIVIDUAL DELETES AND PERFORM00290199
002902*              COMMITS TO CREATE SMALLER UNITS OF WORK.           00290299
002903*----------------------------------------------------------       00290399
002910******************************************************************00291099
003000 ENVIRONMENT DIVISION.                                            00300099
003100******************************************************************00310099
003200                                                                  00320099
003300 CONFIGURATION SECTION.                                           00330099
003400 INPUT-OUTPUT SECTION.                                            00340099
003500 FILE-CONTROL.                                                    00350099
003600                                                                  00360099
003700     SELECT POS-DATE-FILE                                         00370099
003800         ASSIGN TO INP01.                                         00380099
003900                                                                  00390099
004000     SELECT NEW-LWST-W13-WEEK-FILE                                00400099
004100         ASSIGN TO OUT01.                                         00410099
004200                                                                  00420099
004300     SELECT NO-LWST-W13-WEEK-FILE                                 00430099
004400         ASSIGN TO OUT02.                                         00440099
004401                                                                  00440199
004402     SELECT CURR-LWST-DROP-ITM-FILE                               00440299
004403         ASSIGN TO OUT03.                                         00440399
004404                                                                  00440499
004410*    SELECT OLD-WK-BEG-DT-DEL-FILE                                00441099
004420*        ASSIGN TO OUT03.                                         00442099
004500                                                                  00450099
004600*----------------------------------------------------------------*00460099
004700 DATA DIVISION.                                                   00470099
004800*----------------------------------------------------------------*00480099
004900                                                                  00490099
005000 FILE SECTION.                                                    00500099
005100                                                                  00510099
005200 FD POS-DATE-FILE                                                 00520099
005300     RECORDING MODE IS F                                          00530099
005400     LABEL RECORDS ARE STANDARD                                   00540099
005500     RECORD CONTAINS 80 CHARACTERS                                00550099
005600     BLOCK CONTAINS 0 RECORDS                                     00560099
005700     DATA RECORD IS POS-DATE-RECORD.                              00570099
005800                                                                  00580099
005900 01 POS-DATE-RECORD        PIC X(80).                             00590099
006000                                                                  00600099
006100 FD  NEW-LWST-W13-WEEK-FILE                                       00610099
006200     RECORDING MODE IS F                                          00620099
006300     LABEL RECORDS ARE STANDARD                                   00630099
006400     BLOCK CONTAINS 0 RECORDS                                     00640099
006500     RECORD CONTAINS 023 CHARACTERS                               00650099
006600     DATA RECORD IS NEW-LWST-W13-WEEK-RECORD.                     00660099
006700                                                                  00670099
006800 01  NEW-LWST-W13-WEEK-RECORD         PIC X(23).                  00680099
006900                                                                  00690099
007000 FD  NO-LWST-W13-WEEK-FILE                                        00700099
007100     RECORDING MODE IS F                                          00710099
007200     LABEL RECORDS ARE STANDARD                                   00720099
007300     BLOCK CONTAINS 0 RECORDS                                     00730099
007400     RECORD CONTAINS 018 CHARACTERS                               00740099
007500     DATA RECORD IS NO-LWST-W13-WEEK-RECORD.                      00750099
007600                                                                  00760099
007700 01  NO-LWST-W13-WEEK-RECORD          PIC X(18).                  00770099
007800                                                                  00780099
007810 FD  CURR-LWST-DROP-ITM-FILE                                      00781099
007820     RECORDING MODE IS F                                          00782099
007830     LABEL RECORDS ARE STANDARD                                   00783099
007840     BLOCK CONTAINS 0 RECORDS                                     00784099
007850     RECORD CONTAINS 018 CHARACTERS                               00785099
007860     DATA RECORD IS CURR-LWST-DROP-ITM-RECORD.                    00786099
007870                                                                  00787099
007880 01  CURR-LWST-DROP-ITM-RECORD        PIC X(18).                  00788099
007890                                                                  00789099
007900 WORKING-STORAGE SECTION.                                         00790099
008000                                                                  00800099
008100 01  FILLER                           PIC X(32)    VALUE          00810099
008200     '   WORKING STORAGE STARTS HERE  '.                          00820099
008300                                                                  00830099
008400 01  PC-PROGRAM-CONSTANTS.                                        00840099
008500     05  PC-ROW-NOT-FOUND           PIC S9(04)   VALUE +100       00850099
008600                                                 COMP SYNC.       00860099
008700     05  PC-CURRENT-PROGRAM-NAME    PIC X(08)    VALUE            00870099
008800                                                 'EPKUT075'.      00880099
008900     05  PC-DECREMENT-DAYS          PIC  X(05)   VALUE '00098'.   00890099
009000                                                                  00900099
009100 01  PV-PROGRAM-VARIABLES.                                        00910099
009200     05  PV-PARAGRAPH-NAME          PIC  X(30)   VALUE SPACE.     00920099
009300     05  PV-OPERATION-MSG-1         PIC  X(40)   VALUE SPACE.     00930099
009400     05  PV-OPERATION-MSG-2         PIC  X(40)   VALUE SPACE.     00940099
009500     05  PV-DB2-OPERATION           PIC  X(30)   VALUE SPACE.     00950099
009600     05  PV-MIN-UNT-RTL-AMT         PIC  S9(07)V9(02) VALUE ZEROS 00960099
009700                                                      COMP-3.     00970099
009800 01  PV-DATE-AND-TIME-FIELDS.                                     00980099
009900     05  PV-WEEK-BEG-DT-CCYY-MM-DD     PIC X(10)  VALUE SPACE.    00990099
010000     05  PV-OLD-WEEK-BEG-DT            PIC X(10)  VALUE SPACE.    01000099
010100                                                                  01010099
010200 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01020099
010300                                                  COMP SYNC.      01030099
010400     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01040099
010500     88  AC-DB2-ERROR                             VALUE +4013.    01050099
010600     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01060099
010700                                                                  01070099
010800 01  PS-PROGRAM-SWITCHES.                                         01080099
010900     05  PS-PS-END-OF-DATE-SW         PIC X(1)       VALUE 'N'.   01090099
011000         88  PS-END-OF-DATE-FILE                     VALUE 'Y'.   01100099
011100     05  PS-LW13WK-HIST-SW            PIC X(1)       VALUE 'N'.   01110099
011200         88  PS-LW13WK-HIST                          VALUE 'Y'.   01120099
011300         88  PS-NO-LW13WK-HIST                       VALUE 'N'.   01130099
011400     05  PS-DROP-ITEM-SW              PIC X(1)       VALUE 'N'.   01140099
011500         88  PS-NOT-OF-DROP-ITM-CSR                  VALUE 'N'.   01150099
011600         88  PS-END-OF-DROP-ITM-CSR                  VALUE 'Y'.   01160099
011700                                                                  01170099
011800 01  PA-PROGRAM-ACCUMULATORS.                                     01180099
011900     05  PA-DROP-ITM-CNT              PIC  9(09)     VALUE ZEROS. 01190099
011910     05  PA-DROP-ITM-DELETE           PIC  9(09)     VALUE ZEROS. 01191099
012000     05  PA-TOT-NEW-LW13WK-REC-CNT    PIC  9(09)     VALUE ZEROS. 01200099
012100     05  PA-TOT-DELETE-REC-CNT        PIC  9(09)     VALUE ZEROS. 01210099
012200                                                                  01220099
012210*01  PV-OLD-WEEK-DELETE-OUTPUT-RCRD.                              01221099
012220*    05  FILLER                       PIC  X(01)     VALUE "'".   01222099
012230*    05  PV-OLDEST-WEEK-DATE          PIC  X(10)     VALUE ZEROS. 01223099
012231*    05  FILLER                       PIC  X(01)     VALUE "'".   01223199
012232*    05  FILLER                       PIC  X(68)     VALUE SPACES.01223299
012250                                                                  01225099
012300 01  PV-ABEND-CODE   COMP  SYNC       PIC S9(04)     VALUE +0000. 01230099
012400     88  PV-ABEND-4009-CARD-ERROR                    VALUE +4009. 01240099
012600     88  PV-ABEND-4013-DB2-ERROR                     VALUE +4013. 01260099
012700                                                                  01270099
012800******************************************************************01280099
012900* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    01290099
013000******************************************************************01300099
013100 01  CC-CONTROL-CARD.                                             01310099
013200     05  CC-PROCDT-CCYY-MM-DD.                                    01320099
013300         10 CC-PROCESS-DT-CCYY       PIC X(04)  VALUE SPACES.     01330099
013400         10 FILLER                   PIC X(01)  VALUE SPACES.     01340099
013500         10 CC-PROCESS-DT-MM         PIC X(02)  VALUE SPACES.     01350099
013600         10 FILLER                   PIC X(01)  VALUE SPACES.     01360099
013700         10 CC-PROCESS-DT-DD         PIC X(02)  VALUE SPACES.     01370099
013800     05  FILLER                      PIC X(70)  VALUE SPACES.     01380099
013900                                                                  01390099
014000*----------------------------------------------------------------*01400099
014100* EPRD119 LOWEST 13  WEEK PRICE CHANGE COPYBOOK                  *01410099
014200*----------------------------------------------------------------*01420099
014300                                                                  01430099
014400     COPY EPRD119.                                                01440099
014500                                                                  01450099
014600*----------------------------------------------------------------*01460099
014700* EPRD120 LOWEST 13  WEEK PRICE WEEKLY DELETE COPYBOOK           *01470099
014800*----------------------------------------------------------------*01480099
014900                                                                  01490099
015000     COPY EPRD120.                                                01500099
015100                                                                  01510099
015200*----------------------------------------------------------------*01520099
015300*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01530099
015400*----------------------------------------------------------------*01540099
015500     COPY DPWS500.                                                01550099
015600                                                                  01560099
015700*----------------------------------------------------------------*01570099
015800* DPWS004 VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004*01580099
015900*----------------------------------------------------------------*01590099
016000                                                                  01600099
016100     COPY DPWS004.                                                01610099
016200                                                                  01620099
016300*----------------------------------------------------------------*01630099
016400* DB2 TABLE DB2PDBA.EPT_LO_RTL LOWEST 13  WEEK RETAIL TABLE      *01640099
016500*----------------------------------------------------------------*01650099
016600                                                                  01660099
016700     EXEC SQL                                                     01670099
016800         INCLUDE EPT00011                                         01680099
016900     END-EXEC.                                                    01690099
017000                                                                  01700099
017100*----------------------------------------------------------------*01710099
017200* STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                *01720099
017300*----------------------------------------------------------------*01730099
017400                                                                  01740099
017500     EXEC SQL                                                     01750099
017600         INCLUDE SQLCA                                            01760099
017700     END-EXEC.                                                    01770099
017800                                                                  01780099
017900     COPY SQLCA2.                                                 01790099
018000                                                                  01800099
018100*----------------------------------------------------------------*01810099
018200* MAIN CURSOR SELECTS ALL SKU / AD VERSION COMBINATIONS FOR THE  *01820099
018300* OLDEST WEEK THAT WILL DROP OFF THE LOWEST UNIT RETAIL TABLE.   *01830099
018400*----------------------------------------------------------------*01840099
018500                                                                  01850099
018600     EXEC SQL                                                     01860099
018700         DECLARE DROP-ITM-CSR CURSOR FOR                          01870099
018800                                                                  01880099
018900            SELECT  INTR_UPC_ID                                   01890099
019000                   ,STR_GP_TYP_CDE                                01900099
019100                   ,STR_GP_ID                                     01910099
019200                   ,SLS_WK_BEG_DTE                                01920099
019300                   ,UNT_RTL_AMT                                   01930099
019400                                                                  01940099
019500              FROM EPT_LO_RTL                                     01950099
019600                                                                  01960099
019700              WHERE SLS_WK_BEG_DTE = :PV-OLD-WEEK-BEG-DT          01970099
019800                                                                  01980099
019900            ORDER BY INTR_UPC_ID                                  01990099
020000                                                                  02000099
020100        WITH UR                                                   02010099
020200                                                                  02020099
020300     END-EXEC.                                                    02030099
020400                                                                  02040099
020500 01  EW-END-WORKING-STORAGE           PIC X(32)      VALUE        02050099
020600     ' END OF WORKING STORAGE SECTION '.                          02060099
020700                                                                  02070099
020800*----------------------------------------------------------------*02080099
020900 PROCEDURE DIVISION.                                              02090099
021000*----------------------------------------------------------------*02100099
021100                                                                  02110099
021200 0000-MAINLINE-LOGIC.                                             02120099
021300                                                                  02130099
021400     PERFORM 1000-INITIALIZE.                                     02140099
021500     PERFORM 2000-PROCESS-AD-VERSIONS.                            02150099
021600     PERFORM 8000-CLOSING-ROUTINE.                                02160099
021700     GOBACK.                                                      02170099
021800                                                                  02180099
021900*----------------------------------------------------------------*02190099
022000*1000-INITIALIZE.                                                *02200099
022100*    THE INITIALIZTION ROUTINE OPENS FILES AND READS IN THE      *02210099
022200*    CONTROL CARD DATE.                                          *02220099
022300*----------------------------------------------------------------*02230099
022400 1000-INITIALIZE.                                                 02240099
022500                                                                  02250099
022600     OPEN INPUT   POS-DATE-FILE.                                  02260099
022700                                                                  02270099
022800     OPEN OUTPUT  NEW-LWST-W13-WEEK-FILE                          02280099
022900                  NO-LWST-W13-WEEK-FILE                           02290099
022910                  CURR-LWST-DROP-ITM-FILE.                        02291099
023000                                                                  02300099
023100     READ POS-DATE-FILE INTO CC-CONTROL-CARD                      02310099
023200         AT END                                                   02320099
023300             SET PS-END-OF-DATE-FILE TO TRUE.                     02330099
023400                                                                  02340099
023500     IF PS-END-OF-DATE-FILE                                       02350099
023600         MOVE '1000-INITIALIZE'         TO PV-PARAGRAPH-NAME      02360099
023700         MOVE 'DATE CARD MISSING      ' TO PV-OPERATION-MSG-1     02370099
023800         SET AC-CONTROL-CARD-ERROR TO TRUE                        02380099
023900         PERFORM 9999-ABEND                                       02390099
024000     END-IF.                                                      02400099
024100                                                                  02410099
024200     DISPLAY PC-CURRENT-PROGRAM-NAME                              02420099
024300             ' - CONTROL CARD = (' CC-PROCDT-CCYY-MM-DD ')'.      02430099
024400                                                                  02440099
024500     CLOSE POS-DATE-FILE.                                         02450099
024600                                                                  02460099
024700     PERFORM 1100-FIND-FISCAL-WK-BEG-DT.                          02470099
024800     PERFORM 1200-FIND-OLDEST-13WK-PRD-DT.                        02480099
024900                                                                  02490099
025000*----------------------------------------------------------------*02500099
025100*1100-FIND-FISCAL-WK-BEG-DT.                                     *02510099
025200*    USES THE CONTROL CARD DATE TO OBTAIN THE FIRST FISCAL DAY   *02520099
025300*    OF THE WEEK.                                                *02530099
025400*----------------------------------------------------------------*02540099
025500 1100-FIND-FISCAL-WK-BEG-DT.                                      02550099
025600                                                                  02560099
025700     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02570099
025800                                                                  02580099
025900     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   02590099
026000     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   02600099
026100     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   02610099
026200     MOVE CC-PROCDT-CCYY-MM-DD         TO DPG52-LK-DATE-INPUT.    02620099
026300     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02630099
026400                                             DPG54 DPG55 DPG56.   02640099
026500     EVALUATE TRUE                                                02650099
026600         WHEN DPG54-SEVERE-ERROR                                  02660099
026700         WHEN DPG54-DATE-INVALID                                  02670099
026800             MOVE '1100-FIND-FISCAL-WK-BEG-DT'                    02680099
026900                                           TO PV-PARAGRAPH-NAME   02690099
027000             MOVE 'ERROR CONVERTING INPUT CARD DATE'              02700099
027100                                           TO PV-OPERATION-MSG-1  02710099
027200             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                02720099
027300             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  02730099
027400             PERFORM 9999-ABEND                                   02740099
027500     END-EVALUATE.                                                02750099
027600                                                                  02760099
027700     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO                           02770099
027800                                       PV-WEEK-BEG-DT-CCYY-MM-DD  02780099
027900                                                                  02790099
028000     DISPLAY 'WEEK BEGIN DATE= ' PV-WEEK-BEG-DT-CCYY-MM-DD.       02800099
028100                                                                  02810099
028200*----------------------------------------------------------------*02820099
028300*1200-FIND-OLDEST-13WK-PRD-DT.                                   *02830099
028400*    THIS SECTION FINDS THE WEEK BEGIN DATE LOOKING BACK 14      *02840099
028500*    WEEKS.                                                      *02850099
028600*----------------------------------------------------------------*02860099
028700 1200-FIND-OLDEST-13WK-PRD-DT.                                    02870099
028800                                                                  02880099
028900     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02890099
029000                                                                  02900099
029100     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   02910099
029200     SET  DPG51-DECREMENT-DATE         TO TRUE.                   02920099
029300     MOVE PC-DECREMENT-DAYS            TO DPG51-INCR-DECR-DAYS-X. 02930099
029400     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   02940099
029500     MOVE CC-PROCDT-CCYY-MM-DD         TO DPG52-LK-DATE-INPUT.    02950099
029600     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02960099
029700                                             DPG54 DPG55 DPG56.   02970099
029800     EVALUATE TRUE                                                02980099
029900         WHEN DPG54-SEVERE-ERROR                                  02990099
030000         WHEN DPG54-DATE-INVALID                                  03000099
030100             MOVE '1100-FIND-FISCAL-WK-BEG-DT'                    03010099
030200                                           TO PV-PARAGRAPH-NAME   03020099
030300             MOVE 'ERROR CONVERTING INPUT CARD DATE'              03030099
030400                                           TO PV-OPERATION-MSG-1  03040099
030500             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                03050099
030600             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  03060099
030700             PERFORM 9999-ABEND                                   03070099
030800     END-EVALUATE.                                                03080099
030900     MOVE DPG55-1ST-WKDY-DB2ISO-FMT  TO                           03090099
031000                                        PV-OLD-WEEK-BEG-DT.       03100099
031100                                                                  03110099
031200     DISPLAY 'OLDEST WEEK BEGIN DATE= ' PV-OLD-WEEK-BEG-DT.       03120099
031201                                                                  03120199
031210*    MOVE PV-OLD-WEEK-BEG-DT         TO PV-OLDEST-WEEK-DATE.      03121099
031300                                                                  03130099
031310*    WRITE OLD-WK-BEG-DT-DEL-RECORD FROM                          03131099
031320*                          PV-OLD-WEEK-DELETE-OUTPUT-RCRD.        03132099
031330                                                                  03133099
031400*----------------------------------------------------------------*03140099
031500*2000-PROCESS-AD-VERSIONS.                                       *03150099
031600*    THIS SECTION PROCESSES THE MAIN CURSOR, WRITING OUT A NEW   *03160099
031700*    LOWEST PRICE FILE FOR PLU PROCESSING WHEN ONE IS DETECTED   *03170099
031800*    ACCORSS HISTORICAL GIVEN THE ROWS THAT ARE DROPPING.        *03180099
031900*    IN ADDITION, IF NO MATCH EXISTS IN HISTORICAL THEN THE      *03190099
032000*    ITEM AND AD VERSION ARE BEING DROPPED AND THE PLU PROCESS   *03200099
032100*    NEEDS TO BE MADE AWARE.  THIS WILL KEY THE PLU CHANGE PROCE *03210099
032200*    TO SET THE LOWEST 13 WEEK PRICE VALUE BACK TO REGULAR RETAIL*03220099
032300*----------------------------------------------------------------*03230099
032400 2000-PROCESS-AD-VERSIONS.                                        03240099
032500                                                                  03250099
032600     PERFORM 2100-OPEN-DROP-ITM-CSR.                              03260099
032700     PERFORM 2200-PROCESS-DROP-ITM-CSR                            03270099
032800               UNTIL PS-END-OF-DROP-ITM-CSR.                      03280099
032900     PERFORM 2900-CLOSE-DROP-ITM-CSR.                             03290099
033000*    PERFORM 3000-DEL-EPT_LO_RT.                                  03300099
033100*----------------------------------------------------------------*03310099
033200*2100-OPEN-DROP-ITM-CSR.                                         *03320099
033300*    THIS SECTION OPENS THE DROPPED ITEM CURSOR                  *03330099
033400*----------------------------------------------------------------*03340099
033500 2100-OPEN-DROP-ITM-CSR.                                          03350099
033600                                                                  03360099
033700     EXEC SQL                                                     03370099
033800          OPEN DROP-ITM-CSR                                       03380099
033900     END-EXEC.                                                    03390099
034000                                                                  03400099
034100     EVALUATE TRUE                                                03410099
034200         WHEN SQLCODE = ZERO                                      03420099
034300              SET PS-NOT-OF-DROP-ITM-CSR TO TRUE                  03430099
034400              PERFORM 2800-FETCH-DROP-ITM-CSR                     03440099
034500         WHEN SQLWARN0 NOT EQUAL SPACE                            03450099
034600         WHEN SQLCODE NOT EQUAL ZERO                              03460099
034700             MOVE '2100-OPEN-DROP-ITM-CSR'                        03470099
034800                                   TO PV-PARAGRAPH-NAME           03480099
034900             MOVE 'ERROR ON OPEN OF DRPO ITM CSR'                 03490099
035000                                   TO PV-DB2-OPERATION            03500099
035100             DISPLAY 'SQLCODE= ' SQLCODE                          03510099
035200             PERFORM 9900-SQL-ABEND                               03520099
035300     END-EVALUATE.                                                03530099
035400                                                                  03540099
035500*----------------------------------------------------------------*03550099
035600*2200-PROCESS-DROP-ITM-CSR                                       *03560099
035700*    THIS SECTION WILL LOOK FOR ANOTHER ROW OUTSIDE OF THE OLDEST*03570099
035800*    WEEK FOR THE ITEM / AD VERSION SCHEDULED TO ROLL OFF.  IF   *03580099
035900*    A ROW IS NOT FOUND A DELETE RECORD WILL BE CREATED FOR THE  *03590099
036000*    PLU CHANGE PROCESS.  IF A ROW IS FOUND, NO DELETE RECORD    *03600099
036100*    WILL BE CREATED, BUT THE PROGRAM WILL COMPARE THE PRICE     *03610099
036200*    ROLLING OFF TO THE LOWEST PRICE FOUND ON THE TABLE.  IF THAT*03620099
036300*    PRICE IS HIGHER THAN THE ONE ROLLING OFF, A RECORD WILL BE  *03630099
036400*    WRITTEN TO A FILE SO THE PLU CHANGE PROCESS CAN RECOGNIZE   *03640099
036500*    THE NEW LOWEST 13  WEEK PRICE.  IF IT'S SMALLER THAN THE    *03650099
036600*    ONE ROLLING OFF, NOW RECORD IS CREATED.                     *03660099
036700*----------------------------------------------------------------*03670099
036800 2200-PROCESS-DROP-ITM-CSR.                                       03680099
036900                                                                  03690099
037000     PERFORM 2300-SELECT-MIN-LP-FRM-HIST.                         03700099
037100                                                                  03710099
037110     MOVE EPT00011-INTR-UPC-ID     TO  EP120-INTR-UPC-ID.         03711099
037120     MOVE EPT00011-STR-GP-TYP-CDE  TO  EP120-STR-GP-TYP-CDE.      03712099
037130     MOVE EPT00011-STR-GP-ID       TO  EP120-STR-GP-ID.           03713099
037140     MOVE EPT00011-SLS-WK-BEG-DTE  TO  EP120-SLS-WK-BEG-DTE.      03714099
037150                                                                  03715099
037200     IF PS-NO-LW13WK-HIST                                         03720099
037700        PERFORM 2400-WRITE-DELETE-RECORD                          03770099
037800     ELSE                                                         03780099
037900        PERFORM 2500-DET-IF-NEW-LW13WK-PRICE                      03790099
038000     END-IF.                                                      03800099
038001                                                                  03800199
038010     PERFORM 2700-WRITE-DROP-ITM-RECORD.                          03801099
038100                                                                  03810099
038200     PERFORM 2800-FETCH-DROP-ITM-CSR.                             03820099
038300                                                                  03830099
038400*----------------------------------------------------------------*03840099
038500*2300-SELECT-MIN-LP-FRM-HIST.                                    *03850099
038600*    THIS SECTION WILL SELECT THE MINIMUM UNIT RETAIL VALUE      *03860099
038700*    FOR THE ITEM SLATED TO ROLL OFF.                            *03870099
038800*----------------------------------------------------------------*03880099
038900 2300-SELECT-MIN-LP-FRM-HIST.                                     03890099
039000                                                                  03900099
039100     EXEC SQL                                                     03910099
039200          SELECT  MIN(UNT_RTL_AMT)                                03920099
039300                                                                  03930099
039400            INTO :PV-MIN-UNT-RTL-AMT                              03940099
039500                                                                  03950099
039600             FROM EPT_LO_RTL                                      03960099
039700                                                                  03970099
039800            WHERE INTR_UPC_ID = :EPT00011-INTR-UPC-ID             03980099
039900              AND STR_GP_TYP_CDE = :EPT00011-STR-GP-TYP-CDE       03990099
040000************* AND STR_GP_ID = :EPT00011-STR-GP-ID                 04000099
040100              AND SLS_WK_BEG_DTE <> :PV-OLD-WEEK-BEG-DT           04010099
040200                  WITH UR                                         04020099
040300     END-EXEC.                                                    04030099
040400                                                                  04040099
040500     EVALUATE TRUE                                                04050099
040600        WHEN SQLCODE = ZERO                                       04060099
040700            SET PS-LW13WK-HIST TO TRUE                            04070099
040800        WHEN SQLCODE = +100 OR -305                               04080099
040900            SET PS-NO-LW13WK-HIST TO TRUE                         04090099
041000        WHEN OTHER                                                04100099
041100           MOVE '2300-SELECT-MIN-LP-FRM-HIST'                     04110099
041200                                 TO PV-PARAGRAPH-NAME             04120099
041300           MOVE 'ERROR SELECTING LW13WK HIST'                     04130099
041400                                 TO PV-DB2-OPERATION              04140099
041500           DISPLAY 'SQLCODE= ' SQLCODE                            04150099
041600           PERFORM 9900-SQL-ABEND                                 04160099
041700     END-EVALUATE.                                                04170099
041800                                                                  04180099
043010*----------------------------------------------------------------*04301099
043020*2400-WRITE-DELETE-RECORD.                                       *04302099
043030*    THIS SECTION WILL CREATE A DELETE RECORD WHEN NO HISTORY    *04303099
043040*    IS AVAILABLE FOR AN ITEM/AD VERSINO SLATED TO ROLL.         *04304099
043050*----------------------------------------------------------------*04305099
043060 2400-WRITE-DELETE-RECORD.                                        04306099
043070                                                                  04307099
043080     WRITE NO-LWST-W13-WEEK-RECORD FROM                           04308099
043090                           EP120-LWST-W13-WK-DEL-RCD.             04309099
043091                                                                  04309199
043092     ADD 1                       TO PA-TOT-DELETE-REC-CNT.        04309299
043093                                                                  04309399
043100*----------------------------------------------------------------*04310099
043200*2500-DET-IF-NEW-LW13WK-PRICE.                                   *04320099
043300*    THIS SECTION  WILL COMPARE THE 13  WEEK PRICE VALUE SCHEDULE*04330099
043400*    TO ROLL OFF TO THE MINIMUM VALUE REMAINING ON THE LOWEST    *04340099
043500*    PRICE TABLE FOR THE SKU / AD VERSION COMBINATION.  IF THE   *04350099
043600*    MINIMUM VALUE IS HIGHER THAN THE ROW SCHEDULED TO BE DELETED*04360099
043700*    THEN A RECORD WILL BE WRITTEN TO A FILE IN ORDER TO ALERT   *04370099
043800*    THE PLU CHANGE PROCESS THAT A NEW LOWEST 13  WEEK PRICE     *04380099
043900*    EXISTS.  IF IT'S LOWER THAN THE ONE ROLLING OFF NO RECORD   *04390099
044000*    IS GENERATED AS THE NIGHTLY LOWEST PRICE PROCESS WOULD'VE   *04400099
044100*    RECOGNIZED THE LOWER VALUE WHEN LOOKING AT ALL WEEKS.       *04410099
044200*----------------------------------------------------------------*04420099
044300 2500-DET-IF-NEW-LW13WK-PRICE.                                    04430099
044400                                                                  04440099
044500     IF PV-MIN-UNT-RTL-AMT > EPT00011-UNT-RTL-AMT                 04450099
044600        MOVE EPT00011-INTR-UPC-ID     TO  EP119-INTR-UPC-ID       04460099
044700        MOVE EPT00011-STR-GP-TYP-CDE  TO  EP119-STR-GP-TYP-CDE    04470099
044800        MOVE EPT00011-STR-GP-ID       TO  EP119-STR-GP-ID         04480099
044900        MOVE EPT00011-SLS-WK-BEG-DTE  TO  EP119-SLS-WK-BEG-DTE    04490099
045000        MOVE PV-MIN-UNT-RTL-AMT       TO  EP119-UNT-RTL-AMT       04500099
045100        PERFORM 2600-WRITE-NEW-LW13WK-RECORD                      04510099
045200     ELSE                                                         04520099
045300        CONTINUE                                                  04530099
045400     END-IF.                                                      04540099
045500                                                                  04550099
045600*----------------------------------------------------------------*04560099
045700*2600-WRITE-NEW-LW13WK-RECORD.                                   *04570099
045800*    THIS SECTION WILL CREATE A RECORD WHEN THERE IS HISTORICAL  *04580099
045900*    INFORMATION FOR THE ITEM/AD VERSION SLATED TO ROLL, AND THE *04590099
046000*    MINIMUM VALUE REMAINING IS HIGHER THAN THE VALUE ROLLLING   *04600099
046100*    OFF.  IF THIS IS THE CASE THE STORES WOULD NOT HAVE DETECTED*04610099
046200*    THE PRICE IN DAILY PROCESSING BECAUSE AT THE TIME OF DAILY  *04620099
046300*    PROCESSING IT WOULD NOT HAVE BEEN THE LOWEST PRICE.         *04630099
046400*----------------------------------------------------------------*04640099
046500 2600-WRITE-NEW-LW13WK-RECORD.                                    04650099
046600                                                                  04660099
046700     WRITE NEW-LWST-W13-WEEK-RECORD FROM                          04670099
046800                           EP119-LWST-W13-WK-CHG-RCD.             04680099
046900                                                                  04690099
047000     ADD 1                       TO PA-TOT-NEW-LW13WK-REC-CNT.    04700099
047100                                                                  04710099
047110*----------------------------------------------------------------*04711099
047120*2700-WRITE-DROP-ITM-RECORD                                     * 04712099
047130*    THIS SECTION WILL CREATE A DELETE RECORD WHEN NO HISTORY    *04713099
047140*    IS AVAILABLE FOR AN ITEM/AD VERSINO SLATED TO ROLL.         *04714099
047150*----------------------------------------------------------------*04715099
047160 2700-WRITE-DROP-ITM-RECORD.                                      04716099
047170                                                                  04717099
047180     WRITE CURR-LWST-DROP-ITM-RECORD FROM                         04718099
047190                           EP120-LWST-W13-WK-DEL-RCD.             04719099
047191                                                                  04719199
047192     ADD 1                       TO PA-DROP-ITM-DELETE.           04719299
047193                                                                  04719399
047200***************************************************************** 04720099
047300**2800-FETCH-DROP-ITM-CSR.                                        04730099
047400**    FETCH THE NEXT ROW FROM THE DROPPED ITEM CSR.  WHEN NO MORE 04740099
047500**    DROPPED ITEM ADVERSION COMBINATION EXIST, SET END OF CSR    04750099
047600**    TO TRUE.                                                    04760099
047700***************************************************************** 04770099
047800 2800-FETCH-DROP-ITM-CSR.                                         04780099
047900                                                                  04790099
048000     EXEC SQL                                                     04800099
048100       FETCH DROP-ITM-CSR                                         04810099
048200          INTO :EPT00011-INTR-UPC-ID                              04820099
048300              ,:EPT00011-STR-GP-TYP-CDE                           04830099
048400              ,:EPT00011-STR-GP-ID                                04840099
048500              ,:EPT00011-SLS-WK-BEG-DTE                           04850099
048600              ,:EPT00011-UNT-RTL-AMT                              04860099
048700     END-EXEC.                                                    04870099
048800                                                                  04880099
048900     EVALUATE TRUE                                                04890099
049000         WHEN SQLCODE = ZERO                                      04900099
049100             ADD +1 TO PA-DROP-ITM-CNT                            04910099
049200         WHEN SQLCODE = PC-ROW-NOT-FOUND                          04920099
049300             SET PS-END-OF-DROP-ITM-CSR TO TRUE                   04930099
049400         WHEN SQLWARN0 NOT EQUAL SPACE                            04940099
049500         WHEN SQLCODE NOT EQUAL ZERO                              04950099
049600             MOVE '2800-FETCH-DROP-ITM-CSR'                       04960099
049700                                   TO PV-PARAGRAPH-NAME           04970099
049800             MOVE 'ERROR ON FETCH OF DRP ITM CSR'                 04980099
049900                                   TO PV-DB2-OPERATION            04990099
050000             DISPLAY 'SQLCODE= ' SQLCODE                          05000099
050100             PERFORM 9900-SQL-ABEND                               05010099
050200     END-EVALUATE.                                                05020099
050300                                                                  05030099
050400*----------------------------------------------------------------*05040099
050500*2900-CLOSE-DROP-ITM-CSR.                                        *05050099
050600*    THIS SECTION CLOSES THE AD VERSION CURSOR                   *05060099
050700*----------------------------------------------------------------*05070099
050800 2900-CLOSE-DROP-ITM-CSR.                                         05080099
050900                                                                  05090099
051000     EXEC SQL                                                     05100099
051100          CLOSE DROP-ITM-CSR                                      05110099
051200     END-EXEC.                                                    05120099
051300                                                                  05130099
051400     EVALUATE TRUE                                                05140099
051500         WHEN SQLCODE = ZERO                                      05150099
051600              CONTINUE                                            05160099
051700         WHEN SQLWARN0 NOT EQUAL SPACE                            05170099
051800         WHEN SQLCODE NOT EQUAL ZERO                              05180099
051900             MOVE '2900-CLOSE-DROP-ITM-CSR'                       05190099
052000                                   TO PV-PARAGRAPH-NAME           05200099
052100             MOVE 'ERROR ON CLOSE OF DRP ITM CSR'                 05210099
052200                                   TO PV-DB2-OPERATION            05220099
052300             DISPLAY 'SQLCODE= ' SQLCODE                          05230099
052400             PERFORM 9900-SQL-ABEND                               05240099
052500     END-EVALUATE.                                                05250099
052600                                                                  05260099
052610*----------------------------------------------------------------*05261099
052620*3000-DEL-EPT_LO_RT.                                             *05262099
052630*    THIS SECTION PURGES DATA FROM EPL-LO-RT.                    *05263099
052640*----------------------------------------------------------------*05264099
052650*3000-DEL-EPT_LO_RT.                                              05265099
052660*                                                                 05266099
052670*    EXEC SQL                                                     05267099
052680*    LOCK TABLE EPT_LO_RTL IN EXCLUSIVE MODE                      05268099
052690*    END-EXEC.                                                    05269099
052691*                                                                 05269199
052692*    EVALUATE TRUE                                                05269299
052693*        WHEN SQLCODE = ZERO                                      05269399
052694*             CONTINUE                                            05269499
052695*        WHEN SQLWARN0 NOT EQUAL SPACE                            05269599
052696*        WHEN SQLCODE NOT EQUAL ZERO                              05269699
052697*            MOVE '3000-DEL-EPT_LO_RT'                            05269799
052698*                                  TO PV-PARAGRAPH-NAME           05269899
052699*            MOVE '3000-DEL-EPT_LO_RT'                            05269999
052700*                                  TO PV-DB2-OPERATION            05270099
052701*            DISPLAY 'SQLCODE= ' SQLCODE                          05270199
052702*            PERFORM 9900-SQL-ABEND                               05270299
052703*    END-EVALUATE.                                                05270399
052704*    EXEC SQL                                                     05270499
052705*       DELETE FROM EPT_LO_RTL                                    05270599
052706*        WHERE SLS_WK_BEG_DTE  <= :PV-OLD-WEEK-BEG-DT             05270699
052707*    END-EXEC.                                                    05270799
052708*                                                                 05270899
052709*    EVALUATE TRUE                                                05270999
052710*       WHEN SQLCODE = ZERO                                       05271099
052712*            CONTINUE                                             05271299
052713*       WHEN SQLCODE = +100                                       05271399
052714*        DISPLAY 'SQLCODE= ' SQLCODE                              05271499
052715*        DISPLAY 'NO RECORDS FOUND'                               05271599
052716*       WHEN SQLWARN0 NOT EQUAL SPACE                             05271699
052717*       WHEN SQLCODE NOT EQUAL ZERO                               05271799
052718*           MOVE '3000-DEL-EPT_LO_RT'                             05271899
052719*                                   TO PV-PARAGRAPH-NAME          05271999
052720*           MOVE 'UNSUCCESSFUL DELETE'                            05272099
052721*                                   TO PV-DB2-OPERATION           05272199
052722*                                                                 05272299
052723*           DISPLAY 'SQLCODE= ' SQLCODE                           05272399
052724*           PERFORM 9900-SQL-ABEND                                05272499
052725*    END-EVALUATE.                                                05272599
052730*----------------------------------------------------------------*05273099
052800*8000-CLOSING-ROUTINE.                                           *05280099
052900*    DISPLAYS PROGRAM ACCUMULATORS AND CLOSES OUTPUT FILES       *05290099
053000*----------------------------------------------------------------*05300099
053100 8000-CLOSING-ROUTINE.                                            05310099
053200                                                                  05320099
053300     CLOSE NEW-LWST-W13-WEEK-FILE                                 05330099
053400           NO-LWST-W13-WEEK-FILE                                  05340099
053410           CURR-LWST-DROP-ITM-FILE.                               05341099
053500                                                                  05350099
053600     DISPLAY '**************************************'.            05360099
053700     DISPLAY 'FETCHED ITEMS     = ' PA-DROP-ITM-CNT.              05370099
053710     DISPLAY 'DROPPED(DEL) RCDS = ' PA-DROP-ITM-DELETE.           05371099
053800     DISPLAY 'NEW LOW 13WK RCDS = ' PA-TOT-NEW-LW13WK-REC-CNT.    05380099
053900     DISPLAY 'DELETE RCDS       = ' PA-TOT-DELETE-REC-CNT.        05390099
054000     DISPLAY '**************************************'.            05400099
054100                                                                  05410099
054200*----------------------------------------------------------------*05420099
054300*     9900-SQL-ABEND                                             *05430099
054400* ==> PROCESSES:                                                 *05440099
054500*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *05450099
054600* ==> PERFORMED FROM:                                            *05460099
054700*----------------------------------------------------------------*05470099
054800 9900-SQL-ABEND.                                                  05480099
054900                                                                  05490099
055000     DISPLAY '9900-SQL-ABEND'.                                    05500099
055100     DISPLAY '**  ABEND     **'.                                  05510099
055200     DISPLAY '**  PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.       05520099
055300     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             05530099
055400     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION.              05540099
055500                                                                  05550099
055600*----------------------------------------------------------------*05560099
055700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05570099
055800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05580099
055900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05590099
056000* FORMAT.                                                        *05600099
056100*----------------------------------------------------------------*05610099
056200     COPY DPPD004.                                                05620099
056300                                                                  05630099
056400     SET PV-ABEND-4013-DB2-ERROR TO TRUE.                         05640099
056500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05650099
056600                                                                  05660099
056700******************************************************************05670099
056800* 9999-ABEND                                                      05680099
056900*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  05690099
057000******************************************************************05700099
057100 9999-ABEND.                                                      05710099
057200     DISPLAY '** ABEND           **'.                             05720099
057300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  05730099
057400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05740099
057500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05750099
057600     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05760099
057700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         05770099
