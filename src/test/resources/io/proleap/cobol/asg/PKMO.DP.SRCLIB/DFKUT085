000100 IDENTIFICATION DIVISION.                                         00010000
000110                                                                  00011000
000120 PROGRAM-ID.    DFKUT085.                                         00012000
000130 AUTHOR.        MARK RENTMEESTER                                  00013000
000140 DATE-WRITTEN.  JUNE 1999                                         00014000
000150******************************************************************00015000
000160*  THIS PROGRAM CREATES A DOWNLOAD FILE OF FISCAL MTD SALES      *00016000
000170*  CALCULATED BY STORE BY DAY.  THE DOWNLOAD WILL BE TRANSMITTED *00017000
000180*  TO THE LAN VIA FTP.                                           *00018000
000190******************************************************************00019000
000200*                                                                 00020000
000300*  CHANGED 02/12/2004 BY STEVEN NOWAK               WR# 26583     00030000
000400*  CHANGE TO TABLE TDADPTS, RECOMPILE TO PULL IN CHNGD DCLGEN     00040000
000500*                                                                 00050000
000600******************************************************************00060000
000700 ENVIRONMENT DIVISION.                                            00070000
000800 INPUT-OUTPUT SECTION.                                            00080000
000900                                                                  00090000
001000 FILE-CONTROL.                                                    00100000
001100                                                                  00110000
001200     SELECT DATE-CONTROL-FILE                                     00120000
001210         ASSIGN TO INP01.                                         00121000
001220                                                                  00122000
001230     SELECT DAILY-STORE-SALES-FILE                                00123000
001240         ASSIGN TO OUT01.                                         00124000
001250                                                                  00125000
001260 DATA DIVISION.                                                   00126000
001270 FILE SECTION.                                                    00127000
001280 FD  DATE-CONTROL-FILE                                            00128000
001290     RECORDING MODE IS F                                          00129000
001300     LABEL RECORDS ARE STANDARD                                   00130000
001400     BLOCK CONTAINS 0 CHARACTERS.                                 00140000
001500 01  DATE-CONTROL-RCD               PIC X(80).                    00150000
001600                                                                  00160000
001700 FD  DAILY-STORE-SALES-FILE                                       00170000
001800     RECORDING MODE IS F                                          00180000
001900     LABEL RECORDS ARE STANDARD                                   00190000
002000     BLOCK CONTAINS 0 CHARACTERS.                                 00200000
002100 01  DAILY-STORE-SALES-RCD          PIC X(484).                   00210012
002200                                                                  00220000
002300 WORKING-STORAGE SECTION.                                         00230000
002400 01  PS-PROGRAM-SWITCHES.                                         00240000
002500     05  PS-END-DAILY-SLS-CSR-SW    PIC X      VALUE 'N'.         00250000
002501         88  PS-END-DAILY-SLS-CSR              VALUE 'Y'.         00250100
002502     05  PS-END-MONTH-DTE-CSR-SW    PIC X      VALUE 'N'.         00250200
002503         88  PS-END-MONTH-DTE-CSR              VALUE 'Y'.         00250300
002504     05  PS-LEAP-YEAR-SW            PIC X      VALUE 'N'.         00250400
002505         88  PS-LEAP-YEAR                      VALUE 'Y'.         00250500
002504     05  PS-YEAR-HAS-53-WEEKS-SW    PIC X      VALUE 'N'.         00250613
002505         88  PS-YEAR-HAS-53-WEEKS              VALUE 'Y'.         00250713
002506     05  PS-FIRST-WRITE-SW          PIC X      VALUE 'Y'.         00250805
002507         88  PS-FIRST-WRITE                    VALUE 'Y'.         00250905
002508         88  PS-NOT-FIRST-WRITE                VALUE 'N'.         00251005
002509 01  PV-PROGRAM-VARIABLES.                                        00251105
109900     05  PV-PARAGRAPH-NAME       PIC  X(30) VALUE SPACE.          00251208
109900     05  PV-OPERATION-MSG-1      PIC  X(30) VALUE SPACE.          00251308
109900     05  PV-OPERATION-MSG-2      PIC  X(30) VALUE SPACE.          00251408
002510     05  PV-RECS-FROM-CSR           PIC 9(10)  VALUE 0.           00251505
002511     05  PV-RECS-WRITTEN            PIC 9(10)  VALUE 0.           00251605
002512     05  ABEND-CODE                 PIC S9(4)  VALUE 0 COMP SYNC. 00251705
002513     05  PV-FSCL-MONTH              PIC X(2)   VALUE SPACE.       00251805
002514     05  PV-FSCL-YEAR               PIC X(4)   VALUE SPACE.       00251905
002515     05  PV-FSCL-YR-NUM             PIC 9(4)   VALUE 0 COMP-3.    00252005
002516     05  PV-DAYS-IN-MONTH           PIC S9(4)  BINARY.            00252105
002517     05  PV-SALES-RECORD.                                         00252205
002518         10  PV-DAILY-SALES         OCCURS 28 TO 35 TIMES         00252305
002519                                    DEPENDING ON PV-DAYS-IN-MONTH 00252405
002520                                    INDEXED BY SLS-IDX            00252505
002521                                    PIC S9(11)V99 VALUE 0.        00252607
002522         10  PV-MTD-SALES           PIC S9(11)V99.                00252707
002523     05  PV-SAVE-STORE-NUM          PIC S9(4) COMP.               00252805
002524 01  LY-LEAP-YEAR-VARIABLES.                                      00252905
002525     05  LY-CONTROL-YEAR            PIC  9(4)  VALUE 0.           00253005
002526     05  LY-TEMP-NUM                PIC S9(4)  VALUE 0 BINARY.    00253105
002527     05  LY-LEAP-REMAINDER          PIC S9(4)  VALUE 0 BINARY.    00253205
002528 01  CC-CONTROL-CARD.                                             00253305
002529     05  CC-MONTH                   PIC X(3)   VALUE SPACE.       00253405
002530     05  FILLER                     PIC X(1)   VALUE SPACE.       00253505
002540     05  CC-YEAR                    PIC X(4)   VALUE SPACE.       00254000
002550     05  FILLER                     PIC X(72)  VALUE SPACE.       00255000
002551 01  OUTPUT-HEADER-LINE.                                          00255100
002552     05  FILLER                     PIC X(5)   VALUE 'STORE'.     00255200
002553     05  FILLER                     PIC X(1)   VALUE ','.         00255300
002554     05  FILLER                     PIC X(10)  VALUE 'STORE NAME'.00255400
002555     05  FILLER                     PIC X(1)   VALUE ','.         00255500
002556     05  PV-KY-DATE-SAVE            OCCURS 28 TO 35 TIMES         00255600
002557                                    DEPENDING ON PV-DAYS-IN-MONTH 00255700
002558                                    INDEXED BY DTE-IDX.           00255800
002559         10  PV-KY-DATE             PIC X(10)  VALUE SPACE.       00255900
002560         10  FILLER                 PIC X(1)   VALUE ','.         00256000
002561     05  PV-MTD-TOTAL               PIC X(10).                    00256100
002562******************************************************************00256200
002563*    RECORD LAYOUT FOR THE DAILY SALES DOWNLOAD FILE             *00256300
002564******************************************************************00256400
002565     COPY DFRD085.                                                00256500
002566                                                                  00256600
062900******************************************************************00256707
063000*    DATE CALCULATION ROUTINE RECORD LAYOUT                      *00256807
063100******************************************************************00256907
063200     COPY DPWS500.                                                00257007
002567                                                                  00257100
002568*----------------------------------------------------------------*00257200
002569*    DAILY DEPARTMENT SALES TABLE - DFT_ML_FINCL_SUM             *00257300
002570*----------------------------------------------------------------*00257400
002580     EXEC SQL                                                     00258000
002590         INCLUDE DFT00002                                         00259000
002600     END-EXEC.                                                    00260000
002700                                                                  00270000
002800*----------------------------------------------------------------*00280000
002900*    DATE ATTRIBUTES TABLE                                       *00290000
003000*----------------------------------------------------------------*00300000
003100     EXEC SQL                                                     00310000
003200         INCLUDE TDTATTR                                          00320000
003210     END-EXEC.                                                    00321000
003220                                                                  00322000
003230*----------------------------------------------------------------*00323000
003240*    DB2 TABLE XST_LOC - STORE LOCATION TABLE                    *00324000
003250*----------------------------------------------------------------*00325000
003260     EXEC SQL                                                     00326000
003270         INCLUDE XST00001                                         00327000
003280     END-EXEC.                                                    00328000
003290                                                                  00329000
003300*----------------------------------------------------------------*00330000
003310*    SQL COMMUNICATION AREA                                      *00331000
003320*----------------------------------------------------------------*00332000
003330     EXEC SQL                                                     00333000
003340         INCLUDE SQLCA                                            00334000
003350     END-EXEC.                                                    00335000
003360                                                                  00336000
003370* SQL COMMUNICATION AREA2                                         00337000
003380     COPY SQLCA2.                                                 00338000
003390                                                                  00339000
003400*----------------------------------------------------------------*00340000
003500*    MONTH DATES CURSOR                                          *00350000
003600*----------------------------------------------------------------*00360000
003610     EXEC SQL                                                     00361000
003620         DECLARE MONTH_DTE_CSR CURSOR FOR                         00362000
003630         SELECT KY_DTE                                            00363000
003631          FROM TDTATTR                                            00363205
003632          WHERE FSCL_MN_NBR = :PV-FSCL-MONTH                      00363305
003633            AND FSCL_YR_NBR = :PV-FSCL-YEAR                       00363405
003634     END-EXEC.                                                    00363505
003635                                                                  00363605
003636*----------------------------------------------------------------*00363705
003637*    DAILY SALES CURSOR                                          *00363805
003638*----------------------------------------------------------------*00363905
003639     EXEC SQL                                                     00364005
003640         DECLARE DAILY_SLS_CSR CURSOR FOR                         00364105
003650         SELECT A.SLS_DTE                                         00365000
003660               ,A.STR_NBR                                         00366000
003670               ,SUM(A.DLY_DOL_AMT)                                00367004
003690          FROM DFT_ML_FINCL_SUM  A                                00368000
003700          WHERE A.SLS_DTE IN (                                    00369000
003800            SELECT B.KY_DTE FROM TDTATTR B                        00370000
003900             WHERE B.FSCL_MN_NBR  = :PV-FSCL-MONTH                00380000
004000              AND  B.FSCL_YR_NBR  = :PV-FSCL-YEAR)                00390000
004010              AND  A.DLY_DOL_AMT <> 0                             00400000
004100         GROUP BY A.STR_NBR, A.SLS_DTE                            00410004
004200     END-EXEC.                                                    00420000
004300                                                                  00430000
004400                                                                  00440000
004500 PROCEDURE DIVISION.                                              00450000
004600 M0000-MAINLINE.                                                  00460000
004700                                                                  00470000
004800     PERFORM A1000-INITIALIZATION.                                00480000
004900                                                                  00490000
005000     PERFORM B1000-BUILD-DAILY-SLS                                00500000
005100            UNTIL PS-END-DAILY-SLS-CSR.                           00510000
005200                                                                  00520000
005300     PERFORM C1000-CLOSE-FILES.                                   00530000
005400                                                                  00540000
005500     DISPLAY 'NUM OF RECS FROM CURSOR ' PV-RECS-FROM-CSR.         00550000
005600     DISPLAY 'OUTPUT RECS ' PV-RECS-WRITTEN.                      00560000
005700                                                                  00570000
005800     GOBACK.                                                      00580000
005900                                                                  00590000
005910*----------------------------------------------------------------*00591000
005920 A1000-INITIALIZATION.                                            00592000
005930*----------------------------------------------------------------*00593000
005940     OPEN INPUT  DATE-CONTROL-FILE                                00594000
005950          OUTPUT DAILY-STORE-SALES-FILE.                          00595000
005960                                                                  00596000
005970     PERFORM A1100-READ-DATE-CONTROL-FILE.                        00597000
005980                                                                  00598000
005990     PERFORM A1200-COMPUTE-DATE-INFO.                             00599000
005991                                                                  00599100
005992     PERFORM A1300-OPEN-CURSORS.                                  00599200
005993                                                                  00599300
005996     PERFORM A1500-FETCH-DTE-CSR                                  00599600
005997            UNTIL PS-END-MONTH-DTE-CSR.                           00599700
005998                                                                  00599800
005994     PERFORM A1400-FORMAT-RECORDS.                                00599906
005995                                                                  00600006
005999* INITIAL FETCH                                                   00600100
006000     PERFORM B1500-FETCH-DAILY-SLS-CSR.                           00600200
006001     PERFORM B1400-NEXT-STORE.                                    00600300
006002*----------------------------------------------------------------*00600400
006003 A1100-READ-DATE-CONTROL-FILE.                                    00600500
006004*----------------------------------------------------------------*00600600
006005     DISPLAY 'A1100-READ-DATE-CONTROL'.                           00600700
006006                                                                  00600800
006007     READ DATE-CONTROL-FILE                                       00600900
006008             INTO CC-CONTROL-CARD                                 00601000
006009     END-READ.                                                    00601100
006010                                                                  00601200
006020     DISPLAY 'DATE-CONTROL ' CC-CONTROL-CARD.                     00602000
006030*----------------------------------------------------------------*00603000
006040 A1200-COMPUTE-DATE-INFO.                                         00604000
006050*----------------------------------------------------------------*00605000
006060     MOVE CC-YEAR TO PV-FSCL-YEAR.                                00606000
006070                                                                  00607000
006080     EVALUATE TRUE                                                00608000
006090       WHEN CC-MONTH = 'FEB'                                      00609000
006100          MOVE '01'  TO  PV-FSCL-MONTH                            00610000
006200       WHEN CC-MONTH = 'MAR'                                      00620000
006300          MOVE '02'  TO  PV-FSCL-MONTH                            00630000
006400       WHEN CC-MONTH = 'APR'                                      00640000
006500          MOVE '03'  TO  PV-FSCL-MONTH                            00650000
006600       WHEN CC-MONTH = 'MAY'                                      00660000
006700          MOVE '04'  TO  PV-FSCL-MONTH                            00670000
006800       WHEN CC-MONTH = 'JUN'                                      00680000
006810          MOVE '05'  TO  PV-FSCL-MONTH                            00681000
006820       WHEN CC-MONTH = 'JUL'                                      00682000
006821          MOVE '06'  TO  PV-FSCL-MONTH                            00682100
006822       WHEN CC-MONTH = 'AUG'                                      00682200
006823          MOVE '07'  TO  PV-FSCL-MONTH                            00682300
006824       WHEN CC-MONTH = 'SEP'                                      00682400
006825          MOVE '08'  TO  PV-FSCL-MONTH                            00682500
006826       WHEN CC-MONTH = 'OCT'                                      00682600
006827          MOVE '09'  TO  PV-FSCL-MONTH                            00682700
006828       WHEN CC-MONTH = 'NOV'                                      00682800
006829          MOVE '10'  TO  PV-FSCL-MONTH                            00682900
006830       WHEN CC-MONTH = 'DEC'                                      00683000
006831          MOVE '11'  TO  PV-FSCL-MONTH                            00683100
006832       WHEN CC-MONTH = 'JAN'                                      00683200
006833          MOVE '12'  TO  PV-FSCL-MONTH                            00683300
006834          MOVE PV-FSCL-YEAR  TO  PV-FSCL-YR-NUM                   00683400
006835          SUBTRACT 1 FROM PV-FSCL-YR-NUM                          00683500
006836          MOVE PV-FSCL-YR-NUM  TO  PV-FSCL-YEAR                   00683600
006837     END-EVALUATE.                                                00683700
006838                                                                  00683800
006839***************************************************************   00683905
006839*  LEAP YEAR DOES NOT DETERMINE WHETHER THERE ARE 35 DAYS IN A    00684005
006839*  MONTH.  THIS OCCURS ONCE EVERY 6 YEARS WHEN THERE ARE 53 WEEKS 00684105
006839*  IN A FISCAL YEAR.  NEED TO CALL THE CALENDAR ROUTINE TO DETER- 00684207
006839*  MINE IF THERE ARE 53 WEEKS IN JANUARY.                         00684307
006839*  CHANGED 3/2007 BY DEANNA BRANTNER.                             00684405
006839***************************************************************   00684505
006839*DETERMINE WHETHER FISCAL YEAR IS LEAP YEAR                       00684605
006840*    MOVE PV-FSCL-YEAR  TO  LY-CONTROL-YEAR.                      00684705
006841*    DIVIDE LY-CONTROL-YEAR BY 4                                  00684805
006842*          GIVING LY-TEMP-NUM REMAINDER LY-LEAP-REMAINDER.        00684905
006843*    IF LY-LEAP-REMAINDER = ZERO                                  00685005
006844*        SET PS-LEAP-YEAR TO TRUE                                 00685105
006845*    END-IF.                                                      00685205
006846                                                                  00685305
006847     DISPLAY 'PV-FSCL-MONTH ' PV-FSCL-MONTH.                      00685405
006848     DISPLAY 'PV-FSCL-YEAR '  PV-FSCL-YEAR.                       00685505
006849*----------------------------------------------------------------*00685605
006850 A1300-OPEN-CURSORS.                                              00685705
006860*----------------------------------------------------------------*00686000
006870     EXEC SQL                                                     00687000
006880         OPEN DAILY_SLS_CSR                                       00688000
006890     END-EXEC.                                                    00689000
006891                                                                  00689100
006892     IF SQLCODE < 0                                               00689200
006893         DISPLAY 'OPEN UNSUCCESSFUL FOR DFT_ML_FINCL_SUM'         00689300
006894         PERFORM U9980-SQL-ERROR                                  00689400
006895     END-IF.                                                      00689500
006896                                                                  00689600
006897     IF (SQLCODE > 0 AND NOT EQUAL +100)  OR                      00689700
006898           SQLWARN0 = 'W'                                         00689800
006899         DISPLAY 'OPEN WARNING FOR DFT_ML_FINCL_SUM'              00689900
006900         PERFORM U9990-SQL-WARNING                                00690000
007000     END-IF.                                                      00700000
007001                                                                  00700100
007002     EXEC SQL                                                     00700200
007003         OPEN MONTH_DTE_CSR                                       00700300
007004     END-EXEC.                                                    00700400
007005                                                                  00700500
007006     IF SQLCODE < 0                                               00700600
007007         DISPLAY 'OPEN UNSUCCESSFUL FOR DB2 TABLE TDTATTR'        00700700
007008         PERFORM U9980-SQL-ERROR                                  00700800
007009     END-IF.                                                      00700900
007010                                                                  00701000
007011     IF (SQLCODE > 0 AND NOT EQUAL +100)  OR                      00701100
007012           SQLWARN0 = 'W'                                         00701200
007013         DISPLAY 'OPEN WARNING FOR DB2 TABLE TDTATTR'             00701300
007014         PERFORM U9990-SQL-WARNING                                00701400
007015     END-IF.                                                      00701500
007016*----------------------------------------------------------------*00701600
007017 A1400-FORMAT-RECORDS.                                            00701700
007018*----------------------------------------------------------------*00701800
007019     EVALUATE TRUE                                                00701900
007020       WHEN CC-MONTH = 'MAR'                                      00702000
007021       WHEN CC-MONTH = 'JUN'                                      00702100
007022       WHEN CC-MONTH = 'SEP'                                      00702200
007023       WHEN CC-MONTH = 'DEC'                                      00702300
007024       WHEN CC-MONTH = 'JAN' AND PS-YEAR-HAS-53-WEEKS             00702513
007025          MOVE 35  TO  PV-DAYS-IN-MONTH                           00702600
007026       WHEN OTHER                                                 00702700
007027          MOVE 28  TO  PV-DAYS-IN-MONTH                           00702800
007028     END-EVALUATE.                                                00702900
007029                                                                  00703000
007030     SET DTE-IDX  TO  1.                                          00703100
007031*----------------------------------------------------------------*00703200
007032 A1500-FETCH-DTE-CSR.                                             00703300
007033*----------------------------------------------------------------*00703400
007034     EXEC SQL                                                     00703500
007035         FETCH MONTH_DTE_CSR                                      00703600
007036             INTO :DTATTR-KY-DTE                                  00703700
007037     END-EXEC.                                                    00703905
007038                                                                  00704005
007039     IF SQLCODE < 0                                               00704105
007040         DISPLAY 'FETCH UNSUCCESSFUL FOR DFT_ML_FINCL_SUM'        00704205
007041         PERFORM U9980-SQL-ERROR                                  00704305
007042     END-IF.                                                      00704405
007043                                                                  00704505
007044     IF (SQLCODE > 0 AND SQLCODE NOT EQUAL +100) OR               00704605
007045               SQLWARN0 = 'W'                                     00704705
007046         DISPLAY 'FETCH WARNING FOR DFT_ML_FINCL_SUM'             00704805
007047         PERFORM U9990-SQL-WARNING                                00704905
007048     END-IF.                                                      00705005
007049                                                                  00705105
007050     IF SQLCODE = +100                                            00705205
007051         SET PS-END-MONTH-DTE-CSR TO TRUE                         00705305
007052     ELSE                                                         00705405
007053         MOVE DTATTR-KY-DTE  TO  PV-KY-DATE(DTE-IDX)              00705505
007053         IF CC-MONTH = 'JAN'                                      00705607
00705              PERFORM A1600-CHECK-FISCAL-WEEK                      00705707
007055         END-IF                                                   00705807
007054         SET DTE-IDX UP BY 1                                      00705905
007055     END-IF.                                                      00706005
007056                                                                  00706105
054700******************************************************************00706207
054800 A1600-CHECK-FISCAL-WEEK.                                         00706307
054900*     CALL KOHLS CALENDAR ROUTINE:                                00706407
055000*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            00706507
055100*       RETURN: WEEK NUMBER                                       00706607
055200******************************************************************00706707
055400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              00706907
055500                                                                  00707007
055600     SET  DPG51-VALID-FISCAL-CALENDAR  TO TRUE.                   00707110
055700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   00707207
055800     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   00707307
055900     MOVE DTATTR-KY-DTE                TO DPG52-LK-DATE-INPUT.    00707407
056000                                                                  00707607
056100     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    00707707
056200                                             DPG54 DPG55 DPG56.   00707807
056300     EVALUATE TRUE                                                00707907
056400        WHEN DPG54-SEVERE-ERROR                                   00708007
056500        WHEN DPG54-DATE-INVALID                                   00708107
056600           MOVE  'A1600-CHECK-FISCAL-WEEK' TO PV-PARAGRAPH-NAME   00708208
056800           MOVE 'ERROR RETRIEVING FISCAL WEEK ' TO                00708408
                                               PV-OPERATION-MSG-1       00708508
057000           MOVE DPG54-ERROR-MESSAGE TO   PV-OPERATION-MSG-2       00708608
057200           PERFORM 9999-ABEND                                     00708807
057300     END-EVALUATE.                                                00708907
057400                                                                  00709007
057500     IF DPG56-FISCAL-WEEK-NBR  = 53                               00709107
007054         SET PS-YEAR-HAS-53-WEEKS  TO TRUE                        00709613
057700     END-IF.                                                      00709707
057700                                                                  00709807
007057*----------------------------------------------------------------*00709907
007058 B1000-BUILD-DAILY-SLS.                                           00710007
007059*----------------------------------------------------------------*00710107
007060                                                                  00710207
007061*CHECK FOR NEXT STORE OR NEXT DAY OF MONTH                        00710307
007062                                                                  00710407
007063     IF DFT00002-STR-NBR NOT EQUAL DF085-STORE-NBR                00710507
007064        PERFORM B1100-MOVE-DAILY-SLS VARYING SLS-IDX              00710607
007065           FROM 1 BY 1 UNTIL SLS-IDX > PV-DAYS-IN-MONTH           00710707
007066                                                                  00710807
007067        MOVE PV-MTD-SALES    TO  DF085-MTD-TOTAL                  00710907
007068        PERFORM B1200-WRITE-DAILY-SALES-RECORD                    00711007
007069        PERFORM B1400-NEXT-STORE                                  00711107
007070     END-IF.                                                      00711207
007071                                                                  00711307
007072     IF DFT00002-SLS-DTE > PV-KY-DATE(DTE-IDX)                    00711407
007073        SET SLS-IDX UP BY 1                                       00711507
007074        SET DTE-IDX UP BY 1                                       00711607
007075     ELSE                                                         00711707
007076          PERFORM B1300-ADD-SALES                                 00711807
007077          PERFORM B1500-FETCH-DAILY-SLS-CSR                       00711907
007078     END-IF.                                                      00712007
007079                                                                  00712107
007080*----------------------------------------------------------------*00712207
007081 B1100-MOVE-DAILY-SLS.                                            00712307
007082*----------------------------------------------------------------*00712407
007083     MOVE PV-DAILY-SALES(SLS-IDX)                                 00712507
007084                            TO  DF085-DAILY-SALES(D85-IDX).       00712607
007085     SET D85-IDX UP BY 1.                                         00712707
007086     MOVE 0 TO PV-DAILY-SALES(SLS-IDX).                           00712807
007087                                                                  00712907
007088*----------------------------------------------------------------*00713007
007089 B1200-WRITE-DAILY-SALES-RECORD.                                  00713107
007090*----------------------------------------------------------------*00713207
007091     IF PS-FIRST-WRITE                                            00713307
007092        MOVE ' MTD TOTAL'  TO  PV-MTD-TOTAL                       00713407
007093        WRITE DAILY-STORE-SALES-RCD FROM OUTPUT-HEADER-LINE       00713507
007094        SET PS-NOT-FIRST-WRITE  TO  TRUE                          00713607
007095     END-IF.                                                      00713707
007096                                                                  00713807
007097     WRITE DAILY-STORE-SALES-RCD  FROM  DF085-RECORD.             00713907
007098     ADD 1 TO PV-RECS-WRITTEN.                                    00714007
007099                                                                  00714107
007100*----------------------------------------------------------------*00714207
007101 B1300-ADD-SALES.                                                 00714307
007102*----------------------------------------------------------------*00714407
007103     ADD DFT00002-DLY-DOL-AMT TO  PV-DAILY-SALES(SLS-IDX).        00714507
007105     ADD DFT00002-DLY-DOL-AMT TO  PV-MTD-SALES.                   00714607
007107*----------------------------------------------------------------*00714707
007108 B1400-NEXT-STORE.                                                00714807
007109*----------------------------------------------------------------*00714907
007110     SET SLS-IDX  TO  1.                                          00715007
007111     SET DTE-IDX  TO  1.                                          00715107
007112     SET D85-IDX  TO  1.                                          00715207
007113     MOVE 0  TO  PV-MTD-SALES.                                    00715307
007114     MOVE DFT00002-STR-NBR TO  DF085-STORE-NBR.                   00715407
007115     MOVE DF085-STORE-NBR  TO  PV-SAVE-STORE-NUM.                 00715507
007116                                                                  00715607
007117     EXEC SQL                                                     00715707
007118         SELECT LOC_10_ABBR_NM                                    00715807
007119         INTO :XST00001-LOC-10-ABBR-NM                            00715907
007120         FROM XST_LOC                                             00716007
007121         WHERE LOC_NBR     = :PV-SAVE-STORE-NUM                   00716107
007122           AND LOC_TYP_CDE = 'DS'                                 00716207
007123     END-EXEC.                                                    00716307
007124                                                                  00716407
007125     MOVE PV-SAVE-STORE-NUM  TO  XST00001-LOC-NBR.                00716507
007126                                                                  00716607
007127     IF SQLCODE < 0                                               00716707
007128         DISPLAY 'FETCH UNSUCCESSFUL FOR DB2 TABLE XST00001'      00716807
007129         PERFORM U9980-SQL-ERROR                                  00716907
007130     END-IF.                                                      00717007
007131                                                                  00717107
007132     IF (SQLCODE > 0 AND SQLCODE NOT EQUAL +100) OR               00717207
007133          SQLWARN0 = 'W'                                          00717307
007134         DISPLAY 'FETCH WARNING FOR DB2 TABLE XST00001'           00717407
007135         PERFORM U9990-SQL-WARNING                                00717507
007136     END-IF.                                                      00717607
007137                                                                  00717707
007138     IF SQLCODE = +100                                            00717807
007139        CONTINUE                                                  00717907
007140     ELSE                                                         00718007
007141        MOVE XST00001-LOC-10-ABBR-NM TO DF085-STORE-NAME          00718107
007142     END-IF.                                                      00718207
007143*----------------------------------------------------------------*00718307
007144 B1500-FETCH-DAILY-SLS-CSR.                                       00718407
007145*----------------------------------------------------------------*00718507
007146     EXEC SQL                                                     00718607
007147         FETCH DAILY_SLS_CSR                                      00718707
007148             INTO :DFT00002-SLS-DTE                               00718807
007149                 ,:DFT00002-STR-NBR                               00718907
007150                 ,:DFT00002-DLY-DOL-AMT                           00719007
007152     END-EXEC.                                                    00719107
007153                                                                  00719207
007154     IF SQLCODE < 0                                               00719307
007155         DISPLAY 'FETCH UNSUCCESSFUL FOR DFT_ML_FINCL_SUM'        00719407
007156         PERFORM U9980-SQL-ERROR                                  00719507
007157     END-IF.                                                      00719607
007158                                                                  00719707
007159     IF (SQLCODE > 0 AND SQLCODE NOT EQUAL +100) OR               00719807
007160               SQLWARN0 = 'W'                                     00719907
007161         DISPLAY 'FETCH WARNING FOR DFT_ML_FINCL_SUM'             00720007
007162         PERFORM U9990-SQL-WARNING                                00720107
007163     END-IF.                                                      00720207
007164                                                                  00720307
007165     IF SQLCODE = +100                                            00720407
007166         PERFORM B1100-MOVE-DAILY-SLS VARYING SLS-IDX             00720507
007167           FROM 1 BY 1 UNTIL SLS-IDX > PV-DAYS-IN-MONTH           00720607
007168                                                                  00720707
007169         MOVE PV-MTD-SALES    TO  DF085-MTD-TOTAL                 00720807
007170         PERFORM B1200-WRITE-DAILY-SALES-RECORD                   00720907
007171         SET PS-END-DAILY-SLS-CSR TO TRUE                         00721007
007172     ELSE                                                         00721107
007173         ADD 1  TO  PV-RECS-FROM-CSR                              00721207
007174     END-IF.                                                      00721307
007175                                                                  00721407
007176*----------------------------------------------------------------*00721507
007177 C1000-CLOSE-FILES.                                               00721607
007178*----------------------------------------------------------------*00721707
007179     CLOSE DATE-CONTROL-FILE                                      00721807
007180           DAILY-STORE-SALES-FILE.                                00721907
007181                                                                  00722007
007182     PERFORM C2000-CLOSE-DAILY-SLS-CSR.                           00722107
007183*----------------------------------------------------------------*00722207
007184 C2000-CLOSE-DAILY-SLS-CSR.                                       00722307
007185*----------------------------------------------------------------*00722407
007186     EXEC SQL                                                     00722507
007187         CLOSE DAILY_SLS_CSR                                      00722607
007188     END-EXEC.                                                    00722707
007189                                                                  00722807
007190     IF SQLCODE < 0                                               00722907
007191          DISPLAY 'CLOSE UNSUCCESSFUL FOR DFT_ML_FINCL_SUM'       00723007
007192          PERFORM U9980-SQL-ERROR                                 00723107
007193     END-IF.                                                      00723207
007194                                                                  00723307
007195     IF SQLCODE > 0                                               00723407
007196          DISPLAY 'CLOSE WARNING FOR DFT_ML_FINCL_SUM'            00723507
007197          PERFORM U9990-SQL-WARNING                               00723607
007198     END-IF.                                                      00723707
007199*----------------------------------------------------------------*00723807
007200 U9980-SQL-ERROR.                                                 00723907
007210*----------------------------------------------------------------*00724007
007220     MOVE SQLCODE    TO SQLCODE2.                                 00724107
007230     MOVE SQLERRD(3) TO SQLERRD3.                                 00724207
007240     DISPLAY '** ABEND **       ** = SQLWARNING'.                 00724307
007250     DISPLAY '** PROGRAM        ** = DFKUT085'.                   00724407
007260     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  00724507
007270     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  00724607
007280     DISPLAY '** SQLERRM        ** = ' SQLERRM.                   00725000
007290     DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  00726000
007300                                                                  00727000
007400     MOVE 4013 TO ABEND-CODE.                                     00728000
007500     CALL 'ILBOABN0' USING ABEND-CODE.                            00729000
007600*----------------------------------------------------------------*00730000
007700 U9990-SQL-WARNING.                                               00740000
007800*----------------------------------------------------------------*00750000
007900                                                                  00760000
008000     MOVE SQLCODE    TO SQLCODE2.                                 00770000
008100     MOVE SQLERRD(3) TO SQLERRD3.                                 00780000
008200     DISPLAY '** ABEND **       ** = SQLWARNING'.                 00790000
008300     DISPLAY '** PROGRAM        ** = DFKUT085'.                   00800000
008400     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  00810000
008500     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  00820000
008600     DISPLAY '** SQLWARN0       ** = ' SQLWARN0.                  00830000
008700     DISPLAY '** SQLWARN1       ** = ' SQLWARN1.                  00840000
008800     DISPLAY '** SQLWARN2       ** = ' SQLWARN2.                  00850000
008900     DISPLAY '** SQLWARN3       ** = ' SQLWARN3.                  00860000
009000     DISPLAY '** SQLWARN4       ** = ' SQLWARN4.                  00870000
009100     DISPLAY '** SQLWARN5       ** = ' SQLWARN5.                  00880000
009200     DISPLAY '** SQLWARN6       ** = ' SQLWARN6.                  00890000
009300     DISPLAY '** SQLWARN7       ** = ' SQLWARN7.                  00900000
009400                                                                  00910000
009500     MOVE 4013 TO ABEND-CODE.                                     00920000
009600     CALL 'ILBOABN0' USING ABEND-CODE.                            00930000
009700                                                                  00940000
133900******************************************************************00950008
134100*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  00970008
134200******************************************************************00980008
134300 9999-ABEND.                                                      00990008
134400     DISPLAY '** ABEND           **'.                             01000008
134600     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        01020008
134700     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       01030008
134800     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       01040008
009500     MOVE 4019 TO ABEND-CODE.                                     01041009
134900     CALL 'ILBOABN0' USING ABEND-CODE.                            01050009
