000100 IDENTIFICATION DIVISION.                                         00010002
000200*                                                                 00020002
000300 PROGRAM-ID.         DPKUT901.                                    00030002
000400 AUTHOR.             J.FECHTER.                                   00040002
000500 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00050002
000600 DATE-WRITTEN.       11-09-89.                                    00060002
000700 DATE-COMPILED.                                                   00070002
000800                                                                  00080002
000900******************************************************************00090002
001000*  THE PURPOSE OF THIS PROGRAM IS TO:                            *00100002
001100*     - PRESENT TRANSACTION RECORDS TO A DB2 MAINTENANCE PROGRAM *00110002
001200*       RUNNING UDER THE DB2 CHECKPOINT RESTART SYSTEM.          *00120002
001300*     - ISSUES CHECKPOINTS BASED ON THE CHECKPOINT CONTROLS DE-  *00130002
001400*       FINED FOR THE MAINTENANCE PROGRAM.                       *00140002
001500*     - RETURN THE CONTENTS OF WORKING-STORAGE AND THE NEXT      *00150002
001600*       TRANSACTION TO BE PROCESSED TO THE MAINTENANCE PROGRAM   *00160002
001700*       IN A RESTART SITUATION AS OF THE POINT IN TIME WHEN THE  *00170002
001800*       LAST CHECKPOINT WAS TAKEN BEFORE AN ABEND OCCURRED.      *00180002
001900*                                                                *00190002
002000*  THE PROGRAMS PROCESSING IS CONTROLED BY FUNCTION CODES (OPEN, *00200002
002100*  TRANS, CKPT, RSTRT AND CLOSE) THAT ARE PASSED TO IT BY A DB2  *00210002
002200*  MAINTENANCE PROGRAM.                                          *00220002
002300*                                                                *00230002
002400*  AN OPEN FUNCTION CODE WILL VERIFY THAT A CHECKPOINT CONTROL   *00240002
002500*  RECORD HAS BEEN DEFINED IN THE CHECKPOINT CONTROL TABLE       *00250002
002600*  (TCKRSTCNTL) FOR THE DB2 MAINTENANCE PROGRAM, DETERMINE IF    *00260002
002700*  THE MAINTENANCE PROGRAM IS IN A NORMAL RUN MODE OR RESTART    *00270002
002800*  MODE; IF IT'S IN A NORMAL RUN MODE SET CKPT_STAT_CODE TO '3'  *00280002
002900*  (UPDATE PROCESSING STARTED), INITIALIZE WORKING-STORAGE AND   *00290002
003000*  OPEN THE INPUT PREPARED TRANSACTION FILE; IF THE MAINTENANCE  *00300002
003100*  PROGRAM IS IN A RESTART RUN THE WORKING-STORAGE CONTENTS OF   *00310002
003200*  THE MAINTENANCE PROGRAM AND TRANSACTION RECORD PROCESSED AS   *00320002
003300*  OF THE LAST CHECKPOINT TAKEN ARE RETURNED TO THE MAINTENANCE  *00330002
003400*  PROGRAM.                                                      *00340002
003500*                                                                *00350002
003600*  A TRANS FUNCTION CODE WILL READ THE PREPARED TRANSACTION      *00360002
003700*  FILE, AND DETERMINE IF A CHECKPOINT NEEDS TO BE TAKEN; IF A   *00370002
003800*  CHECKPOINT SHOULD BE TAKEN THE CURRENT WORKING-STORAGE CON-   *00380002
003900*  TENTS OF THE MAINTENANCE PROGRAM AND SEQUENCE NUMBER OF THE   *00390002
004000*  LAST TRANSACTION RECORD PROCESSED ARE SAVED IN THE CHECKPOINT *00400002
004100*  INFORMATION TABLE (TCKRSTINF), A CHECKPOINT IS TAKEN AND THE  *00410002
004200*  TRANSACTION RECORD READ PRIOR TO THE CHECKPOINT IS RETURNED   *00420002
004300*  TO THE MAINTENANCE PROGRAM TO BE PROCESSED.                   *00430002
004400*                                                                *00440002
004500*  A CKPT FUNCTION CODE WILL SAVE THE CURRENT WORKING-STORAGE    *00450002
004600*  CONTENTS OF THE MAINTENANCE PROGRAM AND SEQUENCE NUMBER OF    *00460002
004700*  THE TRANSACTION RECORD LAST PROCESSED IN THE CHECKPOINT IN-   *00470002
004800*  FORMATION TABLE (TCKRSTINF), ISSUE A CHECKPOINT AND RETURN    *00480002
004900*  CONTROL TO THE MAINTENANCE PROGRAM.                           *00490002
005000*                                                                *00500002
005100*  A RSTRT FUNCTION CODE WILL CLOSE AND REOPEN THE PREPARED      *00510002
005200*  TRANSACTION FILE AND PERFORM THE RESTART RUN LOGIC.  THIS     *00520002
005300*  FUNCTION CODE IS ONLY ISSUED BY A MAINTENANCE PROGRAM WHEN A  *00530002
005400*  DEADLOCK (SQLCODE -911) HAS OCCURRED BETWEEN THE MAINTENANCE  *00540002
005500*  PROGRAM AND ANOTHER PROGRAM THAT HAS RESULTED IN ALL THE UP-  *00550002
005600*  DATES MADE BY THE MAINTENANCE PROGRAM BEING ROLLEDBACK TO THE *00560002
005700*  LAST COMMIT.                                                  *00570002
005800*                                                                *00580002
005900*  A CLOSE FUNCTION CODE WILL CLOSE THE PREPARED TRANSACTION     *00590002
006000*  FILE, SET THE CKPT_STAT_CODE TO '4' (UPDATE PROCESSING COM-   *00600002
006100*  PLETED), UPDATE OTHER STATISTICS PERTAINING TO THE UPDATE     *00610002
006200*  PROCESS IN THE CHECKPOINT CONTROL RECORD, DELETE ANY ENTRIES  *00620002
006300*  LEFT IN THE CHECKPOINT INFORMATION TABLE FROM THE UPDATE PRO- *00630002
006400*  CESS, DISPLAY SOME STATISTICS FROM THE MIANTENANCE RUN AND    *00640002
006500*  RETURN CONTROL TO THE MAINTENANCE PROGRAM.                    *00650002
006600*                                                                *00660002
006700*  DB2 TABLES:                                                   *00670002
006800*    - TCKRSTCNTL                                                *00680002
006900*    - TCKRSTINF                                                 *00690002
007000*                                                                *00700002
007100*  INPUT FILES:                                                  *00710002
007200*    - PREPARED TRANSACTION FILE               DDNAME= INP01     *00720002
007300*                                                                *00730002
007400*  OUTPUT FILES:                                                 *00740002
007500*    - N/A                                                       *00750002
007600******************************************************************00760002
007700*  CHANGE MADE:  MODIFIED PROGRAM TO USE THE WORKING-STORAGE     *00770002
007800*                AREA PASSED IN THE LINKAGE SECTION DIFFERENTLY. *00780002
007900*                THE CHANGE WILL CAUSE THE LINKAGE AREA DEFINED  *00790002
008000*                BETWEEN TWO PROGRAMS TO BE USED MORE EFFI-      *00800002
008100*                CIENTLY.                                        *00810002
008200*      MADE BY:  JIM FECHTER                                     *00820002
008300*         DATE:  02/12/90                                        *00830002
008400*         WR #:  827                                             *00840002
008500******************************************************************00850002
008600*  CHANGE MADE:  MODIFIED THE PROGRAM IN HOW IT CALCULATES THE   *00860002
008700*                CHECKPOINT DURATION.  IN SOME CASES WHEN THE    *00870002
008800*                TIME BETWEEN THE FIRST AND SECOND CHECKPOINT IS *00880002
008900*                MORE THAN AN HOUR THE CHECKPOIN DURATION CALCU- *00890002
009000*                LATED RESULTED IN AN INVALID TIME CAUSING A DB2 *00900002
009100*                ABEND BECAUSE OF A BAD TIMESTAMP.               *00910002
009200*      MADE BY:  JIM FECHTER                                     *00920002
009300*         DATE:  06/14/90                                        *00930002
009400*         WR #:  827                                             *00940002
009500******************************************************************00950002
009600 EJECT                                                            00960002
009700 ENVIRONMENT DIVISION.                                            00970002
009800*                                                                 00980002
009900 CONFIGURATION SECTION.                                           00990002
010000                                                                  01000002
010100 SOURCE-COMPUTER.    IBM-3090.                                    01010002
010200 OBJECT-COMPUTER.    IBM-3090.                                    01020002
010300                                                                  01030002
010400 INPUT-OUTPUT SECTION.                                            01040002
010500                                                                  01050002
010600 FILE-CONTROL.                                                    01060002
010700                                                                  01070002
010800     SELECT PREPARED-TRANSACTION-FILE    ASSIGN TO INP01.         01080002
010900                                                                  01090002
011000 EJECT                                                            01100002
011100 DATA DIVISION.                                                   01110002
011200*                                                                 01120002
011300 FILE SECTION.                                                    01130002
011400                                                                  01140002
011500 FD  PREPARED-TRANSACTION-FILE                                    01150002
011600     LABEL RECORDS ARE OMITTED                                    01160002
011700     RECORDING MODE IS V                                          01170002
011800     BLOCK CONTAINS 0 RECORDS                                     01180002
011900     DATA RECORD IS DP010I-TRANS-PREP-RECORD.                     01190002
012000*                                                                 01200002
012100     COPY DPRD010I.                                               01210002
012200  EJECT                                                           01220002
012300*                                                                 01230002
012400 WORKING-STORAGE SECTION.                                         01240002
012500                                                                  01250002
012600 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   01260002
012700                                                                  01270002
012800 01  PROGRAM-CONSTANTS.                                           01280002
012900     05  PC-CONTENTION-LIMIT     PIC S9(05)     VALUE +3  COMP-3. 01290002
013000     05  PC-TOTAL-SS-IN-A-DAY    PIC S9(09)     VALUE +86400      01300002
013100                                                COMP-3.           01310002
013200     05  PC-ONE                  PIC 9(01)      VALUE 1.          01320002
013300     05  PC-TWO                  PIC 9(01)      VALUE 2.          01330002
013310     05  PC-PIVOT-YEAR           PIC X(02)      VALUE '80'.       01331003
013400 EJECT                                                            01340002
013500 01  PROGRAM-ACCUMULATORS.                                        01350002
013600     05  PA-CKPT-CNTLS-COUNT     PIC S9(05)     VALUE +0  COMP-3. 01360002
013700     05  PA-CKPT-IND-ON-QTY      PIC S9(05)     VALUE +0  COMP-3. 01370002
013800     05  PA-LAST-TRANS-SEQ-PROCESSED                              01380002
013900                                 PIC S9(09)     VALUE +0  COMP-3. 01390002
014000     05  PA-NMBR-TBL-ENTRIES     PIC S9(03)     VALUE +0  COMP-3. 01400002
014100     05  PA-TBL-OVERFLOW         PIC S9(03)     VALUE +0  COMP-3. 01410002
014200     05  PA-TOTAL-SS-SINCE-LAST-CKPT                              01420002
014300                                 PIC S9(09)     VALUE +0  COMP-3. 01430002
014400     05  PA-TOTAL-SS-LAST-CKPT   PIC S9(09)     VALUE +0  COMP-3. 01440002
014500     05  PA-TOTAL-SS-CURRENT     PIC S9(09)     VALUE +0  COMP-3. 01450002
014600     05  PA-CALC-SS-CURRENT      PIC S9(09)     VALUE +0  COMP-3. 01460002
014700     05  PA-HH-LAST-CKPT         PIC 9(02)      VALUE ZERO.       01470002
014800     05  PA-CALC-HH-IN-SS        PIC S9(09)     VALUE +0  COMP-3. 01480002
014900     05  PA-CALC-MM-IN-SS        PIC S9(09)     VALUE +0  COMP-3. 01490002
015000 EJECT                                                            01500002
015100 01  TRANS-PRES-SAVE-FIELDS.                                      01510002
015200     05  TP-TRANS-QTY            PIC S9(09)     VALUE +0  COMP-3. 01520002
015300     05  TP-TRANS-PRCSD-QTY      PIC S9(09)     VALUE +0  COMP-3. 01530002
015400     05  TP-CKPT-FRQNCY          PIC S9(05)     VALUE +0  COMP-3. 01540002
015500     05  TP-RST-QTY              PIC S9(05)     VALUE +0  COMP-3. 01550002
015600     05  TP-CKPT-TAKEN-QTY       PIC S9(09)     VALUE +0  COMP-3. 01560002
015700     05  TP-FIRST-CKPT-TIME.                                      01570002
015800         10  TP-FIRST-CKPT-TIME-HH                                01580002
015900                                 PIC 9(02)       VALUE ZERO.      01590002
016000         10  TP-FIRST-CKPT-TIME-MM                                01600002
016100                                 PIC 9(02)       VALUE ZERO.      01610002
016200         10  TP-FIRST-CKPT-TIME-SS                                01620002
016300                                 PIC 9(02)       VALUE ZERO.      01630002
016400         10  TP-FIRST-CKPT-TIME-HUN                               01640002
016500                                 PIC 9(02)       VALUE ZERO.      01650002
016600     05  TP-FIRST-CKPT REDEFINES TP-FIRST-CKPT-TIME               01660002
016700                                 PIC 9(08).                       01670002
016800     05  TP-SECOND-CKPT-TIME.                                     01680002
016900         10  TP-SECOND-CKPT-TIME-HH                               01690002
017000                                 PIC 9(02)       VALUE ZERO.      01700002
017100         10  TP-SECOND-CKPT-TIME-MM                               01710002
017200                                 PIC 9(02)       VALUE ZERO.      01720002
017300         10  TP-SECOND-CKPT-TIME-SS                               01730002
017400                                 PIC 9(02)       VALUE ZERO.      01740002
017500         10  TP-SECOND-CKPT-TIME-HUN                              01750002
017600                                 PIC 9(02)       VALUE ZERO.      01760002
017700     05  TP-SECOND-CKPT REDEFINES TP-SECOND-CKPT-TIME             01770002
017800                                 PIC 9(08).                       01780002
017900     05  TP-SAVE-WORK-STRG-LENGTH                                 01790002
018000                                 PIC S9(09)     VALUE +0  COMP-3. 01800002
018100     05  TP-END-OF-PREP-TRANS-FILE-SW                             01810002
018200                                 PIC X(01)      VALUE 'N'.        01820002
018300         88  END-OF-PREP-TRANS-FILE             VALUE 'Y'.        01830002
018400 EJECT                                                            01840002
018500 01  SYSTEM-DATE.                                                 01850002
018600     05  SD-SYSTEM-DATE-YY       PIC XX         VALUE SPACES.     01860002
018700     05  SD-SYSTEM-DATE-MM       PIC XX         VALUE SPACES.     01870002
018800     05  SD-SYSTEM-DATE-DD       PIC XX         VALUE SPACES.     01880002
018900                                                                  01890002
019000 01  SYSTEM-TIME.                                                 01900002
019100     05  ST-SYSTEM-TIME-HH       PIC 9(02)      VALUE ZERO.       01910002
019200     05  ST-SYSTEM-TIME-MM       PIC 9(02)      VALUE ZERO.       01920002
019300     05  ST-SYSTEM-TIME-SS       PIC 9(02)      VALUE ZERO.       01930002
019400     05  ST-SYSTEM-TIME-HUN      PIC 9(02)      VALUE ZERO.       01940002
019500                                                                  01950002
019600 01  CKPT-DURATION.                                               01960002
019700     05  CD-CKPT-DURATION-HH     PIC 9(02)      VALUE ZERO.       01970002
019800     05  CD-CKPT-DURATION-MM     PIC 9(02)      VALUE ZERO.       01980002
019900     05  CD-CKPT-DURATION-SS     PIC 9(02)      VALUE ZERO.       01990002
020000     05  CD-CKPT-DURATION-HUN    PIC 9(02)      VALUE ZERO.       02000002
020100 01  CKPT-DURATION-TIME REDEFINES CKPT-DURATION                   02010002
020200                                 PIC 9(08).                       02020002
020300                                                                  02030002
020400 01  DATE-TIME.                                                   02040002
020500     05  DT-DATE-STAMP.                                           02050002
020600         10  DT-DATE-STAMP-CC    PIC X(02)      VALUE SPACES.     02060003
020610             88  DT-DATE-STAMP-CC-19            VALUE '19'.       02061003
020620             88  DT-DATE-STAMP-CC-20            VALUE '20'.       02062003
020700         10  DT-DATE-STAMP-YY    PIC X(02)      VALUE SPACES.     02070002
020800         10  FILLER              PIC X(01)      VALUE '-'.        02080002
020900         10  DT-DATE-STAMP-MM    PIC X(02)      VALUE SPACES.     02090002
021000         10  FILLER              PIC X(01)      VALUE '-'.        02100002
021100         10  DT-DATE-STAMP-DD    PIC X(02)      VALUE SPACES.     02110002
021200     05  FILLER                  PIC X(01)      VALUE '-'.        02120002
021300     05  DT-TIME-STAMP.                                           02130002
021400         10  DT-TIME-STAMP-HH    PIC X(02)      VALUE SPACES.     02140002
021500         10  FILLER              PIC X(01)      VALUE '.'.        02150002
021600         10  DT-TIME-STAMP-MM    PIC X(02)      VALUE SPACES.     02160002
021700         10  FILLER              PIC X(01)      VALUE '.'.        02170002
021800         10  DT-TIME-STAMP-SS    PIC X(02)      VALUE SPACES.     02180002
021900         10  FILLER              PIC X(01)      VALUE '.'.        02190002
022000         10  DT-TIME-STAMP-HUN   PIC X(04)      VALUE ZERO.       02200002
022100 01  DATE-TIME-STAMP REDEFINES DATE-TIME                          02210002
022200                                 PIC X(24).                       02220002
022300                                                                  02230002
022400 01  CKPT-DURATION-FORMAT.                                        02240002
022500     05  CD-CKPT-DURATION-FOR-HH PIC X(02)      VALUE SPACES.     02250002
022600     05  FILLER                  PIC X(01)      VALUE '.'.        02260002
022700     05  CD-CKPT-DURATION-FOR-MM PIC X(02)      VALUE SPACES.     02270002
022800     05  FILLER                  PIC X(01)      VALUE '.'.        02280002
022900     05  CD-CKPT-DURATION-FOR-SS PIC X(02)      VALUE SPACES.     02290002
023000 01  CKPT-DURATION-STAMP REDEFINES CKPT-DURATION-FORMAT           02300002
023100                                 PIC X(08).                       02310002
023200 EJECT                                                            02320002
023300 01  PROGRAM-VARIABLES.                                           02330002
023400     05  PV-SQLCODE              PIC S9(9)      VALUE +0  COMP.   02340002
023500         88  SQLCODE-OK                         VALUE +0.         02350002
023600         88  ROW-DOESNT-EXIST                   VALUE +100.       02360002
023700         88  TABLE-CONTENTION                   VALUES ARE        02370002
023800                                                      -904        02380002
023900                                                      -911.       02390002
024000     05  PV-HOLD-WORK-STRG-TEXT  PIC X(4022)    VALUE SPACES.     02400002
024100     05  PV-HOLD-SEQ-NMBR        PIC S9(03)     VALUE +0  COMP-3. 02410002
024200     05  PV-SECOND-CKPT-TIME.                                     02420002
024300         10  PV-SECOND-CKPT-TIME-HH                               02430002
024400                                 PIC 9(02)      VALUE ZERO.       02440002
024500         10  PV-SECOND-CKPT-TIME-MM                               02450002
024600                                 PIC 9(03)      VALUE ZERO.       02460002
024700         10  PV-SECOND-CKPT-TIME-SS                               02470002
024800                                 PIC 9(03)      VALUE ZERO.       02480002
024900                                                                  02490002
025000 01  SWITCHES.                                                    02500002
025100     05  SW-OPEN-REQUEST-VERIFIED-SW                              02510002
025200                                 PIC X(01)      VALUE 'N'.        02520002
025300         88  OPEN-REQUEST-VERIFIED              VALUE 'Y'.        02530002
025400     05  SW-BAD-SQLCODE-SW       PIC X(01)      VALUE 'N'.        02540002
025500         88  BAD-SQLCODE                        VALUE 'Y'.        02550002
025600     05  SW-DB2-CALL-COMPLETE-SW PIC X(01)      VALUE 'N'.        02560002
025700         88  DB2-CALL-COMPLETE                  VALUE 'Y'.        02570002
025800 EJECT                                                            02580002
025900 01  MESSAGES-RETURN-CODES.                                       02590002
026000     05  MR-BAD-SQLCODE.                                          02600002
026100         10  MR-MSG-BAD-SQLCODE  PIC X(80)      VALUE             02610002
026200         'BAD SQLCODE RECEIVED                                    02620002
026300-        '                        '.                              02630002
026400         10  MR-RC-BAD-SQLCODE   PIC 9(04)      VALUE 4013.       02640002
026500                                                                  02650002
026600     05  MR-JOB-PLAN-DOESNT-EXIST.                                02660002
026700         10  MR-MSG-DOESNT-EXIST PIC X(80)      VALUE             02670002
026800         'CHECKPOINT CONTROLS ARE NOT DEFINED FOR THE THE JOB/PLAN02680002
026900-        ' REQUESTED              '.                              02690002
027000         10  MR-RC-DOESNT-EXIST  PIC 9(04)      VALUE 4031.       02700002
027100                                                                  02710002
027200     05  MR-INVALID-FUNCTION.                                     02720002
027300         10  MR-MSG-INVALID-FUNC                                  02730002
027400                                 PIC X(80)      VALUE             02740002
027500         'INVALID FUNCTION CODE - REQUEST CANNOT BE PROCESSED     02750002
027600-        '                        '.                              02760002
027700         10  MR-RC-INVALID-FUNC  PIC 9(04)      VALUE 4032.       02770002
027800                                                                  02780002
027900     05  MR-PREP-TRANS-NOT-CREATED.                               02790002
028000         10  MR-MSG-PREP-TRANS-NOT-CREATED                        02800002
028100                                 PIC X(80)      VALUE             02810002
028200         'PREPARED TRANSACTION FILE HAS NOT BEEN CREATED          02820002
028300-        '                        '.                              02830002
028400         10  MR-RC-PREP-TRANS-NOT-CREATED                         02840002
028500                                 PIC 9(04)      VALUE 4033.       02850002
028600                                                                  02860002
028700     05  MR-CKPT-CNTLS-IN-USE.                                    02870002
028800         10  MR-MSG-CKPT-CNTLS-IN-USE                             02880002
028900                                 PIC X(80)      VALUE             02890002
029000         'CHECKPOINT CONTROLS FOR THIS JOB/PLAN ARE BEING UPDATED 02900002
029100-        'BY THE MAINT. SESSION   '.                              02910002
029200         10  MR-RC-CKPT-CNTLS-IN-USE                              02920002
029300                                 PIC 9(04)      VALUE 4034.       02930002
029400                                                                  02940002
029500     05  MR-CHECKPOINT-TAKEN.                                     02950002
029600         10  MR-MSG-CKPT-TAKEN   PIC X(80)      VALUE             02960002
029700         'A CHECKPOINT WAS ISSUED                                 02970002
029800-        '                        '.                              02980002
029900         10  MR-RC-CKPT-TAKEN    PIC 9(04)      VALUE 4035.       02990002
030000                                                                  03000002
030100     05  MR-RESTART-PROCESS.                                      03010002
030200         10  MR-MSG-RESTART      PIC X(80)      VALUE             03020002
030300         'DB2 MAINTENANCE PROGRAM IS BEING RESTARTED              03030002
030400-        '                        '.                              03040002
030500         10  MR-RC-RESTART       PIC 9(04)      VALUE 4036.       03050002
030600                                                                  03060002
030700     05  MR-BAD-WORK-STRG-LENGTH.                                 03070002
030800         10  MR-MSG-BAD-WS-LENGTH                                 03080002
030900                                 PIC X(80)      VALUE             03090002
031000         'LENGTH OF WORKING-STORAGE PASSED THE TRANS PRESENTATION 03100002
031100-        'MODULE IS DIFFERENT     '.                              03110002
031200         10  MR-RC-BAD-WS-LENGTH PIC 9(04)      VALUE 4037.       03120002
031300 EJECT                                                            03130002
031400*                                                                 03140002
031500*    DCLGEN FOR CHECKPOINT RESTART CONTROL TABLE.                 03150002
031600*                                                                 03160002
031700     EXEC SQL                                                     03170002
031800         INCLUDE TCKRSTCN                                         03180002
031900     END-EXEC.                                                    03190002
032000 EJECT                                                            03200002
032100*                                                                 03210002
032200*    DCLGEN FOR CHECKPOINT RESTART INFORMATION TABLE.             03220002
032300*                                                                 03230002
032400     EXEC SQL                                                     03240002
032500         INCLUDE TCKRSTIN                                         03250002
032600     END-EXEC.                                                    03260002
032700 EJECT                                                            03270002
032800*                                                                 03280002
032900*    SQL COMMUNICATIONS WORK AREA.                                03290002
033000*                                                                 03300002
033100     EXEC SQL                                                     03310002
033200         INCLUDE SQLCA                                            03320002
033300     END-EXEC.                                                    03330002
033400 EJECT                                                            03340002
033500 LINKAGE SECTION.                                                 03350002
033600*                                                                 03360002
033700*    TRANSACTION PRESENTATION MODULE LINKAGE SECTION.             03370002
033800*                                                                 03380002
033900     COPY DPLS001.                                                03390002
034000                                                                  03400002
034100     05  WORK-STRG-SECTION                                        03410002
034200         OCCURS 999 TIMES        PIC X(4022).                     03420002
034300 EJECT                                                            03430002
034400     EXEC SQL                                                     03440002
034500         DECLARE INFCSR CURSOR FOR                                03450002
034600          SELECT SEQ_NMBR                                         03460002
034700                ,RST_TRANS_SEQ_NMBR                               03470002
034800                ,WORK_STRG_DESC                                   03480002
034900            FROM TCKRSTINF                                        03490002
035000           WHERE JOB_NAME = :DP001-JOB-NAME                       03500002
035100             AND PLAN_NAME = :DP001-PLAN-NAME                     03510002
035200         ORDER BY SEQ_NMBR                                        03520002
035300     END-EXEC.                                                    03530002
035400 EJECT                                                            03540002
035500 PROCEDURE DIVISION USING DP001-TRANS-PRES-PARAMETERS             03550002
035600                          DP001-TRANS-RECORD                      03560002
035700                          DP001-WORK-STRG-AREA.                   03570002
035800                                                                  03580002
035900                                                                  03590002
036000******************************************************************03600002
036100* A100-MAINLINE-PROCESSING                                       *03610002
036200*      CONTROLS FLOW OF THE PROGRAM.                             *03620002
036300******************************************************************03630002
036400                                                                  03640002
036500 A100-MAINLINE-PROCESSING.                                        03650002
036600                                                                  03660002
036700     PERFORM B050-INITIALIZATION-ROUTINE.                         03670002
036800                                                                  03680002
036900     IF DP001-FUNC-CODE = 'OPEN'                                  03690002
037000         PERFORM B100-VERIFY-OPEN-REQUEST                         03700002
037100           UNTIL OPEN-REQUEST-VERIFIED                            03710002
037200         IF DP001-RET-CODE = ZERO                                 03720002
037300             PERFORM B200-PROCESS-TRANS-REQUEST                   03730002
037400         END-IF                                                   03740002
037500     ELSE                                                         03750002
037600         IF DP001-FUNC-CODE = 'TRANS'                             03760002
037700             PERFORM B200-PROCESS-TRANS-REQUEST                   03770002
037800         ELSE                                                     03780002
037900             IF DP001-FUNC-CODE = 'CLOSE'                         03790002
038000                 PERFORM B300-PROCESS-CLOSE-REQUEST               03800002
038100             ELSE                                                 03810002
038200                 IF DP001-FUNC-CODE = 'CKPT'                      03820002
038300                     PERFORM B400-PROCESS-CKPT-REQUEST            03830002
038400                 ELSE                                             03840002
038500                     IF DP001-FUNC-CODE = 'RSTRT'                 03850002
038600                         PERFORM B500-PROCESS-RSTRT-REQUEST       03860002
038700                     ELSE                                         03870002
038800                         MOVE MR-MSG-INVALID-FUNC TO              03880002
038900                             DP001-MESSAGE                        03890002
039000                         MOVE MR-RC-INVALID-FUNC TO               03900002
039100                             DP001-RET-CODE                       03910002
039200                     END-IF                                       03920002
039300                 END-IF                                           03930002
039400             END-IF                                               03940002
039500         END-IF                                                   03950002
039600     END-IF.                                                      03960002
039700                                                                  03970002
039800     IF DP001-SQLCODE = ZERO                                      03980002
039900       OR DP001-SQLCODE = +100                                    03990002
040000       OR DP001-SQLCODE = -911                                    04000002
040100         CONTINUE                                                 04010002
040200     ELSE                                                         04020002
040300         PERFORM Z920-ROLLBACK                                    04030002
040400     END-IF.                                                      04040002
040500                                                                  04050002
040600     GOBACK.                                                      04060002
040700 EJECT                                                            04070002
040800******************************************************************04080002
040900* B050-INITIALIZATION-ROUTINE.                                   *04090002
041000*      INITIALIZE ALL WORKAREAS THAT COULD BE USED REGARDLESS    *04100002
041100*      OF THE FUNCTION REQUESTED.                                *04110002
041200*                                                                *04120002
041300*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *04130002
041400******************************************************************04140002
041500                                                                  04150002
041600 B050-INITIALIZATION-ROUTINE.                                     04160002
041700                                                                  04170002
041800     MOVE +0 TO DP001-RET-CODE                                    04180002
041900                DP001-SQLCODE                                     04190002
042000                DP001-SQLERRD3                                    04200002
042100                PA-CKPT-CNTLS-COUNT.                              04210002
042200                                                                  04220002
042300     MOVE SPACES TO DP001-MESSAGE                                 04230002
042400                    DP001-SQLERRMC                                04240002
042500                    DP001-SQLWARN.                                04250002
042600                                                                  04260002
042700     MOVE 'N' TO SW-OPEN-REQUEST-VERIFIED-SW                      04270002
042800                 SW-BAD-SQLCODE-SW.                               04280002
042900                                                                  04290002
043000     MOVE ZERO TO PV-SQLCODE.                                     04300002
043100                                                                  04310002
043200     IF END-OF-PREP-TRANS-FILE                                    04320002
043300         MOVE 'Y' TO DP001-PREP-TRANS-EOF-IND                     04330002
043400     ELSE                                                         04340002
043500         MOVE 'N' TO DP001-PREP-TRANS-EOF-IND                     04350002
043600     END-IF.                                                      04360002
043700 EJECT                                                            04370002
043800******************************************************************04380002
043900* B100-VERIFY-OPEN-REQUEST.                                      *04390002
044000*      DETERMINE IF THE CHECKPOINT CONTROLS EXIST IN THE CHECK-  *04400002
044100*      POINT CONTROL TABLE (TCKRSTCNTL) FOR THE JOB/PLAN RE-     *04410002
044200*      QUESTED.  IF THE CONTROLS EXIST, PROCESSING IS DETERMINED *04420002
044300*      BY THE STATUS OF THE CONTROL RECORD.  IF THE SQLCODE RE-  *04430002
044400*      TURNED INDICATES THERE IS A TABLE CONTENTION, REISSUE THE *04440002
044500*      REQUEST UNTIL THE NUMBER OF REQUESTS IS THE SAME AS OR    *04450002
044600*      EXCEEDS THE DEADLOCK LIMIT DEFINED.                       *04460002
044700*                                                                *04470002
044800*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *04480002
044900******************************************************************04490002
045000                                                                  04500002
045100 B100-VERIFY-OPEN-REQUEST.                                        04510002
045200                                                                  04520002
045300     MOVE ZERO TO TP-TRANS-PRCSD-QTY                              04530002
045400                  TP-RST-QTY                                      04540002
045500                  TP-CKPT-TAKEN-QTY.                              04550002
045600                                                                  04560002
045700     PERFORM Z100-DETERMINE-JOB-PLAN-EXISTS.                      04570002
045800                                                                  04580002
045900     MOVE SQLCODE TO PV-SQLCODE.                                  04590002
046000                                                                  04600002
046100     IF SQLCODE-OK                                                04610002
046200         MOVE 'Y' TO SW-OPEN-REQUEST-VERIFIED-SW                  04620002
046300         IF TCKRSTCNTL-CKPT-STAT-CODE = '2'                       04630002
046400             PERFORM C100-PROCESS-OPEN-REQUEST                    04640002
046500         ELSE                                                     04650002
046600             IF TCKRSTCNTL-CKPT-STAT-CODE = '3'                   04660002
046700                 PERFORM C300-RESTART-PROCESS                     04670002
046800                 ADD +1 TO TP-RST-QTY                             04680002
046900                 DISPLAY '*** ' DP001-PLAN-NAME ' IS BEING '      04690002
047000                         'RESTARTED.'                             04700002
047100                 IF DP001-RET-CODE = ZERO                         04710002
047200                     MOVE MR-MSG-RESTART TO DP001-MESSAGE         04720002
047300                     MOVE MR-RC-RESTART TO DP001-RET-CODE         04730002
047400                 END-IF                                           04740002
047500             ELSE                                                 04750002
047600                 PERFORM C200-SET-CKPT-STAT-ERROR-MSG             04760002
047700             END-IF                                               04770002
047800         END-IF                                                   04780002
047900     ELSE                                                         04790002
048000         IF ROW-DOESNT-EXIST                                      04800002
048100             MOVE MR-MSG-DOESNT-EXIST TO DP001-MESSAGE            04810002
048200             MOVE MR-RC-DOESNT-EXIST TO DP001-RET-CODE            04820002
048300             MOVE SQLCODE TO DP001-SQLCODE                        04830002
048400             MOVE SQLERRD(3) TO DP001-SQLERRD3                    04840002
048500             MOVE SQLERRMC TO DP001-SQLERRMC                      04850002
048600             MOVE 'Y' TO SW-OPEN-REQUEST-VERIFIED-SW              04860002
048700         ELSE                                                     04870002
048800             IF TABLE-CONTENTION                                  04880002
048900                 ADD +1 TO PA-CKPT-CNTLS-COUNT                    04890002
049000                 IF (PA-CKPT-CNTLS-COUNT > PC-CONTENTION-LIMIT)   04900002
049100                   OR (PA-CKPT-CNTLS-COUNT = PC-CONTENTION-LIMIT) 04910002
049200                     MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE     04920002
049300                     MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE     04930002
049400                     MOVE SQLCODE TO DP001-SQLCODE                04940002
049500                     MOVE SQLERRD(3) TO DP001-SQLERRD3            04950002
049600                     MOVE SQLERRMC TO DP001-SQLERRMC              04960002
049700                     MOVE 'Y' TO SW-OPEN-REQUEST-VERIFIED-SW      04970002
049800                 END-IF                                           04980002
049900             ELSE                                                 04990002
050000                 MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE         05000002
050100                 MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE         05010002
050200                 MOVE SQLCODE TO DP001-SQLCODE                    05020002
050300                 MOVE SQLWARN TO DP001-SQLWARN                    05030002
050400                 MOVE SQLERRD(3) TO DP001-SQLERRD3                05040002
050500                 MOVE SQLERRMC TO DP001-SQLERRMC                  05050002
050600                 MOVE 'Y' TO SW-OPEN-REQUEST-VERIFIED-SW          05060002
050700             END-IF                                               05070002
050800         END-IF                                                   05080002
050900     END-IF.                                                      05090002
051000 EJECT                                                            05100002
051100******************************************************************05110002
051200* B200-PROCESS-TRANS-REQUEST.                                    *05120002
051300*      READ THE PREPARED TRANSACTION FILE.  IF END-OF-FILE TAKE  *05130002
051400*      A CHECKPOINT; IF THE RETURN CODE IS SET TO (4037 - CHECK- *05140002
051500*      POINT TAKEN) OVERLAY THE RETURN CODE TO INDICATE THAT     *05150002
051600*      END-OF-FILE HAS BEEN REACHED.  IF NOT END-OF-FILE, DETER- *05160002
051700*      MINE IF A CHECKPOINT NEEDS TO BE TAKEN AND MOVE THE       *05170002
051800*      TRANSACTION JUST READ TO THE LINKAGE AREA.                *05180002
051900*                                                                *05190002
052000*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *05200002
052100******************************************************************05210002
052200                                                                  05220002
052300 B200-PROCESS-TRANS-REQUEST.                                      05230002
052400                                                                  05240002
052500     READ PREPARED-TRANSACTION-FILE                               05250002
052600         AT END                                                   05260002
052700           MOVE 'Y' TO TP-END-OF-PREP-TRANS-FILE-SW.              05270002
052800                                                                  05280002
052900     IF END-OF-PREP-TRANS-FILE                                    05290002
053000         MOVE 999999999 TO PA-LAST-TRANS-SEQ-PROCESSED            05300002
053100         PERFORM C400-TAKE-A-CHECKPOINT                           05310002
053200         MOVE 'Y' TO DP001-PREP-TRANS-EOF-IND                     05320002
053300     ELSE                                                         05330002
053400         PERFORM C500-DETERMINE-TAKE-CKPT                         05340002
053500         ADD +1 TO TP-TRANS-PRCSD-QTY                             05350002
053600         MOVE DP010I-TRANS-SEQ-NMBR TO                            05360002
053700             PA-LAST-TRANS-SEQ-PROCESSED                          05370002
053800         MOVE DP010I-TRANS-REC TO DP001-TRANS-RECORD              05380002
053900     END-IF.                                                      05390002
054000 EJECT                                                            05400002
054100******************************************************************05410002
054200* B300-PROCESS-CLOSE-REQUEST.                                    *05420002
054300*      CLOSE THE PREPARED TRANSACTION FILE, UPDATE THE CHECK-    *05430002
054400*      POINT CONTROL RECORD INDICATING THAT THE MAINTENANCE PRO- *05440002
054500*      GRAM HAS COMPLETED PROCESSING ALONG WITH ANY STATISTICS   *05450002
054600*      CAPTURED FOR THE MAINTENANCE PROCESS, DELETE ANY DATA     *05460002
054700*      SAVED FROM THE LAST CHECKPOINT IN THE CHECKPOINT INFORMA- *05470002
054800*      TION TABLE AND DISPLAY A MESSAGE ON SYSOUT THAT THE       *05480002
054900*      TRANSACTION PRESENTATION MODULE HAS COMPLETED PROCESSING  *05490002
055000*      FOR THE MAINTENANCE PROGRAM ALONG WITH SOME STATISTICS    *05500002
055100*      CAPTURED FROM THE MAINTENANCE PROCESS.                    *05510002
055200*                                                                *05520002
055300*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *05530002
055400******************************************************************05540002
055500                                                                  05550002
055600 B300-PROCESS-CLOSE-REQUEST.                                      05560002
055700                                                                  05570002
055800     CLOSE PREPARED-TRANSACTION-FILE.                             05580002
055900                                                                  05590002
056000     ACCEPT SYSTEM-DATE FROM DATE.                                05600002
056100     MOVE SD-SYSTEM-DATE-YY TO DT-DATE-STAMP-YY.                  05610002
056200     MOVE SD-SYSTEM-DATE-MM TO DT-DATE-STAMP-MM.                  05620002
056300     MOVE SD-SYSTEM-DATE-DD TO DT-DATE-STAMP-DD.                  05630002
056301     IF DT-DATE-STAMP-YY > PC-PIVOT-YEAR                          05630103
056302         SET DT-DATE-STAMP-CC-19 TO TRUE                          05630203
056303     ELSE                                                         05630303
056304         SET DT-DATE-STAMP-CC-20 TO TRUE                          05630403
056310     END-IF.                                                      05631003
056400                                                                  05640002
056500     ACCEPT SYSTEM-TIME FROM TIME.                                05650002
056600     MOVE ST-SYSTEM-TIME-HH TO DT-TIME-STAMP-HH.                  05660002
056700     MOVE ST-SYSTEM-TIME-MM TO DT-TIME-STAMP-MM.                  05670002
056800     MOVE ST-SYSTEM-TIME-SS TO DT-TIME-STAMP-SS.                  05680002
056900     MOVE ST-SYSTEM-TIME-HUN TO DT-TIME-STAMP-HUN.                05690002
057000                                                                  05700002
057100     MOVE TP-SECOND-CKPT-TIME-HH TO PV-SECOND-CKPT-TIME-HH.       05710002
057200     MOVE TP-SECOND-CKPT-TIME-MM TO PV-SECOND-CKPT-TIME-MM.       05720002
057300     MOVE TP-SECOND-CKPT-TIME-SS TO PV-SECOND-CKPT-TIME-SS.       05730002
057400                                                                  05740002
057500     IF TP-FIRST-CKPT-TIME-HH > PV-SECOND-CKPT-TIME-HH            05750002
057600         ADD 24 TO PV-SECOND-CKPT-TIME-HH                         05760002
057700     END-IF.                                                      05770002
057800                                                                  05780002
057900     IF TP-FIRST-CKPT-TIME-MM > PV-SECOND-CKPT-TIME-MM            05790002
058000         SUBTRACT 1 FROM PV-SECOND-CKPT-TIME-HH                   05800002
058100         ADD 60 TO PV-SECOND-CKPT-TIME-MM                         05810002
058200     END-IF.                                                      05820002
058300                                                                  05830002
058400     IF TP-FIRST-CKPT-TIME-SS > PV-SECOND-CKPT-TIME-SS            05840002
058500         SUBTRACT 1 FROM PV-SECOND-CKPT-TIME-MM                   05850002
058600         ADD 60 TO PV-SECOND-CKPT-TIME-SS                         05860002
058700     END-IF.                                                      05870002
058800                                                                  05880002
058900     SUBTRACT TP-FIRST-CKPT-TIME-HH FROM PV-SECOND-CKPT-TIME-HH   05890002
059000         GIVING CD-CKPT-DURATION-HH.                              05900002
059100                                                                  05910002
059200     SUBTRACT TP-FIRST-CKPT-TIME-MM FROM PV-SECOND-CKPT-TIME-MM   05920002
059300         GIVING CD-CKPT-DURATION-MM.                              05930002
059400                                                                  05940002
059500     SUBTRACT TP-FIRST-CKPT-TIME-SS FROM PV-SECOND-CKPT-TIME-SS   05950002
059600         GIVING CD-CKPT-DURATION-SS.                              05960002
059700                                                                  05970002
059800     MOVE CD-CKPT-DURATION-HH TO CD-CKPT-DURATION-FOR-HH.         05980002
059900     MOVE CD-CKPT-DURATION-MM TO CD-CKPT-DURATION-FOR-MM.         05990002
060000     MOVE CD-CKPT-DURATION-SS TO CD-CKPT-DURATION-FOR-SS.         06000002
060100                                                                  06010002
060200     ADD +1 TO TP-CKPT-TAKEN-QTY.                                 06020002
060300                                                                  06030002
060400     MOVE 'N' TO SW-DB2-CALL-COMPLETE-SW.                         06040002
060500                                                                  06050002
060600     PERFORM Z300-UPDATE-CKPT-CNTLS                               06060002
060700         UNTIL DB2-CALL-COMPLETE.                                 06070002
060800                                                                  06080002
060900     IF SQLCODE-OK                                                06090002
061000         PERFORM Z800-DELETE-CKPT-INFO                            06100002
061100         IF SQLCODE-OK                                            06110002
061200             PERFORM Z400-COMMIT-UPDATES                          06120002
061300             IF SQLCODE-OK                                        06130002
061400                 MOVE ZERO TO DP001-RET-CODE                      06140002
061500                 PERFORM C600-DISPLAY-END-PROCESS-MSG             06150002
061600             END-IF                                               06160002
061700         END-IF                                                   06170002
061800     END-IF.                                                      06180002
061900                                                                  06190002
062000 EJECT                                                            06200002
062100******************************************************************06210002
062200* B400-PROCESS-CKPT-REQUEST.                                     *06220002
062300*      THIS ROUTINE PROCESSES A REQUEST FROM THE MAINTENANCE     *06230002
062400*      PROGRAM TO TAKE A CHECKPOINT.                             *06240002
062500*                                                                *06250002
062600*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *06260002
062700******************************************************************06270002
062800                                                                  06280002
062900 B400-PROCESS-CKPT-REQUEST.                                       06290002
063000                                                                  06300002
063100     PERFORM C400-TAKE-A-CHECKPOINT.                              06310002
063200                                                                  06320002
063300 EJECT                                                            06330002
063400******************************************************************06340002
063500* B500-PROCESS-RSTRT-REQUEST.                                    *06350002
063600*      THIS ROUTINE PROCESSES A REQUEST FROM THE MAINTENANCE     *06360002
063700*      PROGRAM THAT IT NEEDS TO RESTART FROM THE LAST CHECK-     *06370002
063800*      POINT TAKEN.                                              *06380002
063900*                                                                *06390002
064000*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *06400002
064100******************************************************************06410002
064200                                                                  06420002
064300 B500-PROCESS-RSTRT-REQUEST.                                      06430002
064400                                                                  06440002
064500     CLOSE PREPARED-TRANSACTION-FILE.                             06450002
064600                                                                  06460002
064700     PERFORM C300-RESTART-PROCESS.                                06470002
064800                                                                  06480002
064900     IF DP001-RET-CODE = ZERO                                     06490002
065000         MOVE MR-MSG-RESTART TO DP001-MESSAGE                     06500002
065100         MOVE MR-RC-RESTART TO DP001-RET-CODE                     06510002
065200     END-IF.                                                      06520002
065300                                                                  06530002
065400 EJECT                                                            06540002
065500******************************************************************06550002
065600* C100-PROCESS-OPEN-REQUEST.                                     *06560002
065700*      DELETE ANY ROWS IN THE CHECKPOINT INFORMATION TABLE FOR   *06570002
065800*      THE JOB/PLAN REQUESTED.  THERE SHOULD ONLY BE INFORMATION *06580002
065900*      LEFT IN THE CHECKPOINT INFORMATION TABLE IF THE MAINTEN-  *06590002
066000*      ANCE PROGRAM ABENDED AND A DECISION WAS MADE TO SET THE   *06600002
066100*      STATUS CODE OF THE CHECKPOINT CONTROL RECORD BACK TO      *06610002
066200*      TRANSACTION PREPARATION PROCESS COMPLETED AND TREAT THE   *06620002
066300*      RESTART AS A NORMAL RUN.                                  *06630002
066400*      SET THE CHECKPOINT CONTROL STATUS TO 'UPDATE PROCSS STAR- *06640002
066500*      TED' AND OPEN THE INPUT PREPARED TRANSACTION FILE.        *06650002
066600*                                                                *06660002
066700*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *06670002
066800******************************************************************06680002
066900                                                                  06690002
067000 C100-PROCESS-OPEN-REQUEST.                                       06700002
067100                                                                  06710002
067200     MOVE DP001-WORK-STRG-LENGTH TO                               06720002
067300         TP-SAVE-WORK-STRG-LENGTH.                                06730002
067400                                                                  06740002
067500     PERFORM Z800-DELETE-CKPT-INFO.                               06750002
067600                                                                  06760002
067700     IF (SQLCODE-OK                                               06770002
067800       OR ROW-DOESNT-EXIST)                                       06780002
067900         MOVE 'N' TO SW-DB2-CALL-COMPLETE-SW                      06790002
068000         PERFORM Z200-UPDATE-CKPT-CNTL-STATUS                     06800002
068100             UNTIL DB2-CALL-COMPLETE                              06810002
068200         IF SQLCODE-OK                                            06820002
068300             PERFORM C400-TAKE-A-CHECKPOINT                       06830002
068400             IF DP001-RET-CODE = MR-RC-CKPT-TAKEN                 06840002
068500                 MOVE ZERO TO DP001-RET-CODE                      06850002
068600                 MOVE 'N' TO TP-END-OF-PREP-TRANS-FILE-SW         06860002
068700                 PERFORM D300-OPEN-PREPARED-TRANS-FILE            06870002
068800             END-IF                                               06880002
068900         END-IF                                                   06890002
069000     END-IF.                                                      06900002
069100 EJECT                                                            06910002
069200******************************************************************06920002
069300* C200-SET-CKPT-STAT-ERROR-MSG.                                  *06930002
069400*      SET AN APPROPRIATE ERROR MESSAGE INDICATING THE STATUS OF *06940002
069500*      THE CHECKPOINT CONTROL RECORD.                            *06950002
069600*                                                                *06960002
069700*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *06970002
069800******************************************************************06980002
069900                                                                  06990002
070000 C200-SET-CKPT-STAT-ERROR-MSG.                                    07000002
070100                                                                  07010002
070200     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           07020002
070300         MOVE MR-MSG-CKPT-CNTLS-IN-USE TO DP001-MESSAGE           07030002
070400         MOVE MR-RC-CKPT-CNTLS-IN-USE TO DP001-RET-CODE           07040002
070500     ELSE                                                         07050002
070600         MOVE MR-MSG-PREP-TRANS-NOT-CREATED TO DP001-MESSAGE      07060002
070700         MOVE MR-RC-PREP-TRANS-NOT-CREATED TO DP001-RET-CODE      07070002
070800     END-IF.                                                      07080002
070900 EJECT                                                            07090002
071000******************************************************************07100002
071100* C300-RESTART-PROCESS.                                          *07110002
071200*      RETRIEVE THE DATA SAVED IN THE CHECKPOINT INFORMATION     *07120002
071300*      TABLE FROM THE LAST CHECKPOINT, REOPEN THE PREPARED       *07130002
071400*      TRANSACTION FILE, REPOSITION THE FILE TO THE NEXT RECORD  *07140002
071500*      TO BE PROCESSED AFTER THE LAST CHECKPOINT AND FORMAT THE  *07150002
071600*      DATA AREA TO BE PASSED BACK TO THE MAINTENANCE PROGRAM.   *07160002
071700*                                                                *07170002
071800*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *07180002
071900*      PERFORMED BY B500-PROCESS-RSTRT-REQUEST.                  *07190002
072000******************************************************************07200002
072100                                                                  07210002
072200 C300-RESTART-PROCESS.                                            07220002
072300                                                                  07230002
072400     MOVE ZERO TO PA-NMBR-TBL-ENTRIES.                            07240002
072500                                                                  07250002
072600     PERFORM Z900-OPEN-INFCSR-CURSOR.                             07260002
072700                                                                  07270002
072800     PERFORM D400-RETRIEVE-CKPT-INFO                              07280002
072900         UNTIL (ROW-DOESNT-EXIST                                  07290002
073000            OR BAD-SQLCODE).                                      07300002
073100                                                                  07310002
073200     IF BAD-SQLCODE                                               07320002
073300         CONTINUE                                                 07330002
073400     ELSE                                                         07340002
073500         PERFORM Z910-CLOSE-INFCSR-CURSOR                         07350002
073600     END-IF.                                                      07360002
073700                                                                  07370002
073800     IF BAD-SQLCODE                                               07380002
073900         CONTINUE                                                 07390002
074000     ELSE                                                         07400002
074100         IF TP-SAVE-WORK-STRG-LENGTH = DP001-WORK-STRG-LENGTH     07410002
074200             PERFORM D300-OPEN-PREPARED-TRANS-FILE                07420002
074300             MOVE +0 TO DP010I-TRANS-SEQ-NMBR                     07430002
074400                        DP010I-TRANS-REC-LENGTH                   07440002
074500             IF END-OF-PREP-TRANS-FILE                            07450002
074600                 MOVE 'Y' TO DP001-PREP-TRANS-EOF-IND             07460002
074700             ELSE                                                 07470002
074800                 IF PA-NMBR-TBL-ENTRIES = ZERO                    07480002
074900                     MOVE ZERO TO TCKRSTINF-RST-TRANS-SEQ-NMBR    07490002
075000                 END-IF                                           07500002
075100                 PERFORM D500-REPOSITION-PREP-TRAN-FILE           07510002
075200                     UNTIL ((DP010I-TRANS-SEQ-NMBR >              07520002
075300                           TCKRSTINF-RST-TRANS-SEQ-NMBR)          07530002
075400                        OR END-OF-PREP-TRANS-FILE)                07540002
075500                 IF END-OF-PREP-TRANS-FILE                        07550002
075600                     MOVE 'Y' TO DP001-PREP-TRANS-EOF-IND         07560002
075700                 ELSE                                             07570002
075800                     ADD +1 TO TP-TRANS-PRCSD-QTY                 07580002
075900                     MOVE DP010I-TRANS-REC TO                     07590002
076000                         DP001-TRANS-RECORD                       07600002
076100                 END-IF                                           07610002
076200             END-IF                                               07620002
076300         ELSE                                                     07630002
076400             MOVE MR-MSG-BAD-WS-LENGTH TO DP001-MESSAGE           07640002
076500             MOVE MR-RC-BAD-WS-LENGTH TO DP001-RET-CODE           07650002
076600         END-IF                                                   07660002
076700     END-IF.                                                      07670002
076800 EJECT                                                            07680002
076900******************************************************************07690002
077000* C400-TAKE-A-CHECKPOINT.                                        *07700002
077100*      SAVE THE DATA THAT THE MAINTENANCE PROGRAM AND TRANSAC-   *07710002
077200*      TION PRESENTATION MODULE WOULD NEED TO CONTINUE PROCESS-  *07720002
077300*      IF A RESTART WOULD NEED TO OCCUR FROM THE CHECKPOINT      *07730002
077400*      ABOUT TO BE TAKEN IN THE CHECKPOINT INFORMATION TABLE.    *07740002
077500*                                                                *07750002
077600*      PERFORMED BY B200-PROCESS-TRANS-REQUEST.                  *07760002
077700*      PERFORMED BY B400-PROCESS-CKPT-REQUEST.                   *07770002
077800*      PERFORMED BY C100-PROCESS-OPEN-REQUEST.                   *07780002
077900*      PERFORMED BY C500-DETERMINE-TAKE-CKPT.                    *07790002
078000******************************************************************07800002
078100                                                                  07810002
078200 C400-TAKE-A-CHECKPOINT.                                          07820002
078300                                                                  07830002
078400     IF TP-SAVE-WORK-STRG-LENGTH = DP001-WORK-STRG-LENGTH         07840002
078500         ADD +1 TO TP-CKPT-TAKEN-QTY                              07850002
078600         IF TP-CKPT-TAKEN-QTY = PC-ONE                            07860002
078700             ACCEPT TP-FIRST-CKPT-TIME FROM TIME                  07870002
078800         ELSE                                                     07880002
078900             IF TP-CKPT-TAKEN-QTY = PC-TWO                        07890002
079000                 ACCEPT TP-SECOND-CKPT-TIME FROM TIME             07900002
079100             END-IF                                               07910002
079200         END-IF                                                   07920002
079300         DIVIDE DP001-WORK-STRG-LENGTH BY 4022 GIVING             07930002
079400             PA-NMBR-TBL-ENTRIES REMAINDER PA-TBL-OVERFLOW        07940002
079500         IF PA-TBL-OVERFLOW > 0                                   07950002
079600             ADD +1 TO PA-NMBR-TBL-ENTRIES                        07960002
079700         END-IF                                                   07970002
079800*        ADD 1 TO PA-NMBR-TBL-ENTRIES FOR THE                     07980002
079900*        TRANS-PRES-SAVE-FIELDS.                                  07990002
080000         ADD +1 TO PA-NMBR-TBL-ENTRIES                            08000002
080100         MOVE PA-LAST-TRANS-SEQ-PROCESSED TO                      08010002
080200             TCKRSTINF-RST-TRANS-SEQ-NMBR                         08020002
080300         MOVE 4022 TO TCKRSTINF-WORK-STRG-DESC-LEN                08030002
080400         PERFORM D200-SAVE-WORKING-STORAGE                        08040002
080500             VARYING TCKRSTINF-SEQ-NMBR                           08050002
080600             FROM 1 BY 1                                          08060002
080700             UNTIL TCKRSTINF-SEQ-NMBR > PA-NMBR-TBL-ENTRIES       08070002
080800               OR BAD-SQLCODE                                     08080002
080900         IF SQLCODE-OK                                            08090002
081000             PERFORM Z400-COMMIT-UPDATES                          08100002
081100         END-IF                                                   08110002
081200     ELSE                                                         08120002
081300         MOVE MR-MSG-BAD-WS-LENGTH TO DP001-MESSAGE               08130002
081400         MOVE MR-RC-BAD-WS-LENGTH TO DP001-RET-CODE               08140002
081500     END-IF.                                                      08150002
081600 EJECT                                                            08160002
081700******************************************************************08170002
081800* C500-DETERMINE-TAKE-CKPT.                                      *08180002
081900*      BASED ON THE CHECKPOINT CONTROLS DEFINED FOR THE MAINTEN- *08190002
082000*      ANCE PROGRAM AND THE ACTUAL CHECKPOINT COUNTS BEING KEPT, *08200002
082100*      DETERMINE IF A CHECKPOINT SHOULD BE TAKEN.                *08210002
082200*                                                                *08220002
082300*      PERFORMED BY B200-PROCESS-TRANS-REQUEST.                  *08230002
082400******************************************************************08240002
082500                                                                  08250002
082600 C500-DETERMINE-TAKE-CKPT.                                        08260002
082700                                                                  08270002
082800     IF DP010I-CHECKPOINT-IND = 'Y'                               08280002
082900         ADD +1 TO PA-CKPT-IND-ON-QTY                             08290002
083000     END-IF.                                                      08300002
083100                                                                  08310002
083200     IF TCKRSTCNTL-CKPT-CNTL-CODE = 'R'                           08320002
083300         CONTINUE                                                 08330002
083400     ELSE                                                         08340002
083500         IF TCKRSTCNTL-CKPT-TYPE-CODE = ('C' OR 'L')              08350002
083600             IF ((PA-CKPT-IND-ON-QTY > TP-CKPT-FRQNCY)            08360002
083700               OR (PA-CKPT-IND-ON-QTY = TP-CKPT-FRQNCY))          08370002
083800                 PERFORM C400-TAKE-A-CHECKPOINT                   08380002
083900                 MOVE ZERO TO PA-CKPT-IND-ON-QTY                  08390002
084000             END-IF                                               08400002
084100         ELSE                                                     08410002
084200             ACCEPT SYSTEM-TIME FROM TIME                         08420002
084300             PERFORM D100-CALC-TOTAL-CURRENT-SS                   08430002
084400             COMPUTE PA-TOTAL-SS-SINCE-LAST-CKPT =                08440002
084500                 (PA-CALC-SS-CURRENT - PA-TOTAL-SS-LAST-CKPT)     08450002
084600             IF ((PA-TOTAL-SS-SINCE-LAST-CKPT >                   08460002
084700                   TP-CKPT-FRQNCY)                                08470002
084800               OR (PA-TOTAL-SS-SINCE-LAST-CKPT =                  08480002
084900                   TP-CKPT-FRQNCY))                               08490002
085000                 PERFORM C400-TAKE-A-CHECKPOINT                   08500002
085100                 MOVE PA-TOTAL-SS-CURRENT TO PA-TOTAL-SS-LAST-CKPT08510002
085200                 MOVE ST-SYSTEM-TIME-HH TO PA-HH-LAST-CKPT        08520002
085300             END-IF                                               08530002
085400         END-IF                                                   08540002
085500     END-IF.                                                      08550002
085600 EJECT                                                            08560002
085700******************************************************************08570002
085800* C600-DISPLAY-END-PROCESS-MSG.                                  *08580002
085900*      DISPLAY A MESSAGE ON SYSOUT INDICATING THAT THE TRANSAC-  *08590002
086000*      TION PRESENTATION MODULE HAS COMPLETED PROCESSING FOR THE *08600002
086100*      MAINTENANCE PROGRAM ALONG WITH STATISTICS CAPTURED FROM   *08610002
086200*      THE MAINTENANCE PROCESS.                                  *08620002
086300*                                                                *08630002
086400*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *08640002
086500******************************************************************08650002
086600                                                                  08660002
086700 C600-DISPLAY-END-PROCESS-MSG.                                    08670002
086800                                                                  08680002
086900     DISPLAY '*** ' DP001-PLAN-NAME.                              08690002
087000     DISPLAY '*** TRANSACTION PRESENATION MODULE HAS COMPLETED'.  08700002
087100     DISPLAY '*** PROCESSING'.                                    08710002
087200     DISPLAY ' '.                                                 08720002
087300     DISPLAY '    NBR TRANS = ' TP-TRANS-QTY.                     08730002
087400     DISPLAY '    NBR TRANS PROCESSED = ' TP-TRANS-PRCSD-QTY.     08740002
087500     DISPLAY '    NBR CKPTS TAKEN = ' TP-CKPT-TAKEN-QTY.          08750002
087600     DISPLAY ' '.                                                 08760002
087700 EJECT                                                            08770002
087800******************************************************************08780002
087900* D100-CALC-TOTAL-CURRENT-SS.                                    *08790002
088000*      CALCULATE THE TOTAL NUMBER OF SECONDS THAT HAVE PASSED    *08800002
088100*      FOR TODAY.  IF PROCESSING HAS CARRIED OVER INTO THE NEXT  *08810002
088200*      DAY FROM THE LAST CHECKPOINT THAT WAS TAKEN, CALCULATE    *08820002
088300*      THE TOTAL NUMBER OF SECONDS THAT HAVE PASSED FOR TODAY    *08830002
088400*      EQUAL TO THE TOTAL NUMBER OF SECONDS IN A DAY PLUS THE    *08840002
088500*      TOTAL NUMBER OF SECONDS INTO THE NEW DAY.  THIS CALCULA-  *08850002
088600*      TION IS USED TO DETERMINE IF A CHECKPOINT SHOULD BE TAKEN *08860002
088700*      IF CHECKPOINTS ARE SETUP TO BE TAKEN ON A TIME INTERVAL.  *08870002
088800*                                                                *08880002
088900*      PERFORMED BY C500-DETERMINE-TAKE-A-CKPT.                  *08890002
089000*      PERFORMED BY D300-OPEN-PREPARED-TRANS-FILE.               *08900002
089100******************************************************************08910002
089200                                                                  08920002
089300 D100-CALC-TOTAL-CURRENT-SS.                                      08930002
089400                                                                  08940002
089500     COMPUTE PA-CALC-HH-IN-SS = (ST-SYSTEM-TIME-HH * 3600).       08950002
089600                                                                  08960002
089700     COMPUTE PA-CALC-MM-IN-SS = (ST-SYSTEM-TIME-MM * 60).         08970002
089800                                                                  08980002
089900     COMPUTE PA-TOTAL-SS-CURRENT = (PA-CALC-HH-IN-SS              08990002
090000                                  + PA-CALC-MM-IN-SS              09000002
090100                                  + ST-SYSTEM-TIME-SS).           09010002
090200                                                                  09020002
090300     IF ST-SYSTEM-TIME-HH < PA-HH-LAST-CKPT                       09030002
090400         COMPUTE PA-CALC-SS-CURRENT = (PA-TOTAL-SS-CURRENT        09040002
090500                                     + PC-TOTAL-SS-IN-A-DAY)      09050002
090600     ELSE                                                         09060002
090700         MOVE PA-TOTAL-SS-CURRENT TO PA-CALC-SS-CURRENT           09070002
090800     END-IF.                                                      09080002
090900 EJECT                                                            09090002
091000******************************************************************09100002
091100* D200-SAVE-WORKING-STORAGE.                                     *09110002
091200*      INSERT OR UPDATE THE DATA BEING SAVED FROM THE MAINTEN-   *09120002
091300*      ANCE PROGRAM AND TRANSACTION PRESENTATION MODULE INTO THE *09130002
091400*      CHECKPOINT INFORMATION TABLE.                             *09140002
091500*                                                                *09150002
091600*      PERFORMED BY C400-TAKE-A-CHECKPOINT.                      *09160002
091700******************************************************************09170002
091800                                                                  09180002
091900 D200-SAVE-WORKING-STORAGE.                                       09190002
092000                                                                  09200002
092100     IF TCKRSTINF-SEQ-NMBR = PA-NMBR-TBL-ENTRIES                  09210002
092200         MOVE SPACES TO TCKRSTINF-WORK-STRG-DESC-TEXT             09220002
092300         MOVE TRANS-PRES-SAVE-FIELDS TO                           09230002
092400             TCKRSTINF-WORK-STRG-DESC-TEXT                        09240002
092500     ELSE                                                         09250002
092600         MOVE WORK-STRG-SECTION (TCKRSTINF-SEQ-NMBR) TO           09260002
092700             TCKRSTINF-WORK-STRG-DESC-TEXT                        09270002
092800     END-IF.                                                      09280002
092900                                                                  09290002
093000     IF TP-CKPT-TAKEN-QTY = PC-ONE                                09300002
093100         PERFORM Z500-INSERT-CKPT-INFO                            09310002
093200     ELSE                                                         09320002
093300         PERFORM Z600-UPDATE-CKPT-INFO                            09330002
093400     END-IF.                                                      09340002
093500 EJECT                                                            09350002
093600******************************************************************09360002
093700* D300-OPEN-PREPARED-TRANS-FILE.                                 *09370002
093800*      OPEN THE PREPARED TRANSACTION FILE AND INITIALIZE         *09380002
093900*      PROCESSING COUNTERS AND FIELDS.                           *09390002
094000*                                                                *09400002
094100*      PERFORMED BY C100-PROCESS-OPEN-REQUEST.                   *09410002
094200*      PERFORMED BY C300-RESTART-PROCESS.                        *09420002
094300******************************************************************09430002
094400                                                                  09440002
094500 D300-OPEN-PREPARED-TRANS-FILE.                                   09450002
094600                                                                  09460002
094700     OPEN INPUT PREPARED-TRANSACTION-FILE.                        09470002
094800                                                                  09480002
094900     ACCEPT SYSTEM-TIME FROM TIME.                                09490002
095000     MOVE ST-SYSTEM-TIME-HH TO PA-HH-LAST-CKPT.                   09500002
095100     PERFORM D100-CALC-TOTAL-CURRENT-SS.                          09510002
095200     MOVE PA-TOTAL-SS-CURRENT TO PA-TOTAL-SS-LAST-CKPT.           09520002
095300     MOVE ZERO TO PA-CKPT-IND-ON-QTY.                             09530002
095400 EJECT                                                            09540002
095500******************************************************************09550002
095600* D400-RETRIEVE-CKPT-INFO.                                       *09560002
095700*      RETRIEVE THE DATA SAVED IN THE CHECKPOINT INFORMATION     *09570002
095800*      TABLE FROM THE LAST CHECKPOINT.                           *09580002
095900*                                                                *09590002
096000*      PERFORMED BY C300-RESTART-PROCESS.                        *09600002
096100******************************************************************09610002
096200                                                                  09620002
096300 D400-RETRIEVE-CKPT-INFO.                                         09630002
096400                                                                  09640002
096500     PERFORM Z700-FETCH-CKPT-INFO.                                09650002
096600                                                                  09660002
096700     IF SQLCODE-OK                                                09670002
096800         IF TCKRSTINF-SEQ-NMBR = PC-ONE                           09680002
096900             MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                09690002
097000                 PV-HOLD-WORK-STRG-TEXT                           09700002
097100             MOVE TCKRSTINF-SEQ-NMBR TO PV-HOLD-SEQ-NMBR          09710002
097200         ELSE                                                     09720002
097300             MOVE PV-HOLD-WORK-STRG-TEXT TO                       09730002
097400                 WORK-STRG-SECTION (PV-HOLD-SEQ-NMBR)             09740002
097500             MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                09750002
097600                 PV-HOLD-WORK-STRG-TEXT                           09760002
097700             MOVE TCKRSTINF-SEQ-NMBR TO PV-HOLD-SEQ-NMBR          09770002
097800         END-IF                                                   09780002
097900     ELSE                                                         09790002
098000         IF ROW-DOESNT-EXIST                                      09800002
098100             MOVE PV-HOLD-WORK-STRG-TEXT TO                       09810002
098200                 TRANS-PRES-SAVE-FIELDS                           09820002
098300             MOVE PV-HOLD-SEQ-NMBR TO PA-NMBR-TBL-ENTRIES         09830002
098400         END-IF                                                   09840002
098500     END-IF.                                                      09850002
098600                                                                  09860002
098700 EJECT                                                            09870002
098800******************************************************************09880002
098900* D500-REPOSITION-PREP-TRAN-FILE.                                *09890002
099000*      READ THROUGH THE PREPARED TRANSACTION FILE REPOSITIONING  *09900002
099100*      IN THE FILE ON THE NEXT TRANSACTION TO BE PROCESSED AFTER *09910002
099200*      THE LAST CHECKPOINT THAT WAS TAKEN.                       *09920002
099300*                                                                *09930002
099400*      PERFORMED BY C300-RESTART-PROCESS.                        *09940002
099500******************************************************************09950002
099600                                                                  09960002
099700 D500-REPOSITION-PREP-TRAN-FILE.                                  09970002
099800                                                                  09980002
099900     READ PREPARED-TRANSACTION-FILE                               09990002
100000         AT END                                                   10000002
100100           MOVE 'Y' TO TP-END-OF-PREP-TRANS-FILE-SW.              10010002
100200                                                                  10020002
100300     IF END-OF-PREP-TRANS-FILE                                    10030002
100400         MOVE 'Y' TO DP001-PREP-TRANS-EOF-IND                     10040002
100500     END-IF.                                                      10050002
100600 EJECT                                                            10060002
100700******************************************************************10070002
100800* Z100-DETERMINE-JOB-PLAN-EXISTS.                                *10080002
100900*      RETRIEVES THE CHECKPOINT STATUS CODE, CONTROL CODE, CON-  *10090002
101000*      TROL TYPE, FREQUENCY AND TRANSACTION QUANTITY FOR THE     *10100002
101100*      JOB/PLAN REQUESTED.                                       *10110002
101200*                                                                *10120002
101300*      PERFORMED BY B100-VERIFY-OPEN-REQUEST.                    *10130002
101400******************************************************************10140002
101500                                                                  10150002
101600 Z100-DETERMINE-JOB-PLAN-EXISTS.                                  10160002
101700                                                                  10170002
101800     EXEC SQL                                                     10180002
101900         SELECT  CKPT_STAT_CODE                                   10190002
102000                ,CKPT_CNTL_CODE                                   10200002
102100                ,CKPT_TYPE_CODE                                   10210002
102200                ,CKPT_FRQNCY_QTY                                  10220002
102300                ,TRANS_QTY                                        10230002
102400           INTO :TCKRSTCNTL-CKPT-STAT-CODE,                       10240002
102500                :TCKRSTCNTL-CKPT-CNTL-CODE,                       10250002
102600                :TCKRSTCNTL-CKPT-TYPE-CODE,                       10260002
102700                :TP-CKPT-FRQNCY,                                  10270002
102800                :TP-TRANS-QTY                                     10280002
102900           FROM TCKRSTCNTL                                        10290002
103000          WHERE JOB_NAME = :DP001-JOB-NAME                        10300002
103100            AND PLAN_NAME = :DP001-PLAN-NAME                      10310002
103200     END-EXEC.                                                    10320002
103300 EJECT                                                            10330002
103400******************************************************************10340002
103500* Z200-UPDATE-CKPT-CNTL-STATUS.                                  *10350002
103600*      UPDATE THE CHECKPOINT CONTROLS STATUS CODE TO INDICATE    *10360002
103700*      MAINTENANCE PROCESSING HAS STARTED.                       *10370002
103800*                                                                *10380002
103900*      PERFORMED BY C100-PROCESS-OPEN-REQUEST.                   *10390002
104000******************************************************************10400002
104100                                                                  10410002
104200 Z200-UPDATE-CKPT-CNTL-STATUS.                                    10420002
104300                                                                  10430002
104400     EXEC SQL                                                     10440002
104500         UPDATE TCKRSTCNTL                                        10450002
104600            SET CKPT_STAT_CODE = '3'                              10460002
104700          WHERE JOB_NAME = :DP001-JOB-NAME                        10470002
104800            AND PLAN_NAME = :DP001-PLAN-NAME                      10480002
104900     END-EXEC.                                                    10490002
105000                                                                  10500002
105100     MOVE SQLCODE TO PV-SQLCODE.                                  10510002
105200                                                                  10520002
105300     IF SQLCODE-OK                                                10530002
105400         MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW                      10540002
105500     ELSE                                                         10550002
105600         IF TABLE-CONTENTION                                      10560002
105700             ADD +1 TO PA-CKPT-CNTLS-COUNT                        10570002
105800             IF ((PA-CKPT-CNTLS-COUNT > PC-CONTENTION-LIMIT)      10580002
105900               OR (PA-CKPT-CNTLS-COUNT = PC-CONTENTION-LIMIT))    10590002
106000                 MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE         10600002
106100                 MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE         10610002
106200                 MOVE SQLCODE TO DP001-SQLCODE                    10620002
106300                 MOVE SQLWARN TO DP001-SQLWARN                    10630002
106400                 MOVE SQLERRD(3) TO DP001-SQLERRD3                10640002
106500                 MOVE SQLERRMC TO DP001-SQLERRMC                  10650002
106600                 MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW              10660002
106700             END-IF                                               10670002
106800         ELSE                                                     10680002
106900             MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE             10690002
107000             MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE             10700002
107100             MOVE SQLCODE TO DP001-SQLCODE                        10710002
107200             MOVE SQLWARN TO DP001-SQLWARN                        10720002
107300             MOVE SQLERRD(3) TO DP001-SQLERRD3                    10730002
107400             MOVE SQLERRMC TO DP001-SQLERRMC                      10740002
107500             MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW                  10750002
107600         END-IF                                                   10760002
107700     END-IF.                                                      10770002
107800 EJECT                                                            10780002
107900******************************************************************10790002
108000* Z300-UPDATE-CKPT-CNTLS.                                        *10800002
108100*      UPDATE THE CHECKPOINT CONTROLS RECORD INDICATING MAIN-    *10810002
108200*      TENANCE PROCESSING IS COMPLETE AND WITH STATISTICS CAP-   *10820002
108300*      TURED DURING THE MAINTENANCE PROCESS.                     *10830002
108400*                                                                *10840002
108500*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *10850002
108600******************************************************************10860002
108700                                                                  10870002
108800 Z300-UPDATE-CKPT-CNTLS.                                          10880002
108900                                                                  10890002
109000     EXEC SQL                                                     10900002
109100         UPDATE TCKRSTCNTL                                        10910002
109200            SET  CKPT_STAT_CODE = '4'                             10920002
109300                ,TRANS_PRCSD_QTY = :TP-TRANS-PRCSD-QTY            10930002
109400                ,RST_QTY = :TP-RST-QTY                            10940002
109500                ,CKPT_TAKEN_QTY = :TP-CKPT-TAKEN-QTY              10950002
109600                ,PRCSD_TMESTP = :DATE-TIME-STAMP                  10960002
109700                ,CKPT_DURATION_TIME = :CKPT-DURATION-STAMP        10970002
109800          WHERE JOB_NAME = :DP001-JOB-NAME                        10980002
109900            AND PLAN_NAME = :DP001-PLAN-NAME                      10990002
110000     END-EXEC.                                                    11000002
110100                                                                  11010002
110200     MOVE SQLCODE TO PV-SQLCODE.                                  11020002
110300                                                                  11030002
110400     IF SQLCODE-OK                                                11040002
110500         MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW                      11050002
110600     ELSE                                                         11060002
110700         IF TABLE-CONTENTION                                      11070002
110800             ADD +1 TO PA-CKPT-CNTLS-COUNT                        11080002
110900             IF ((PA-CKPT-CNTLS-COUNT > PC-CONTENTION-LIMIT)      11090002
111000               OR (PA-CKPT-CNTLS-COUNT = PC-CONTENTION-LIMIT))    11100002
111100                 MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE         11110002
111200                 MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE         11120002
111300                 MOVE SQLCODE TO DP001-SQLCODE                    11130002
111400                 MOVE SQLWARN TO DP001-SQLWARN                    11140002
111500                 MOVE SQLERRD(3) TO DP001-SQLERRD3                11150002
111600                 MOVE SQLERRMC TO DP001-SQLERRMC                  11160002
111700                 MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW              11170002
111800             END-IF                                               11180002
111900         ELSE                                                     11190002
112000             MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE             11200002
112100             MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE             11210002
112200             MOVE SQLCODE TO DP001-SQLCODE                        11220002
112300             MOVE SQLWARN TO DP001-SQLWARN                        11230002
112400             MOVE SQLERRD(3) TO DP001-SQLERRD3                    11240002
112500             MOVE SQLERRMC TO DP001-SQLERRMC                      11250002
112600             MOVE 'Y' TO SW-DB2-CALL-COMPLETE-SW                  11260002
112700         END-IF                                                   11270002
112800     END-IF.                                                      11280002
112900                                                                  11290002
113000 EJECT                                                            11300002
113100******************************************************************11310002
113200* Z400-COMMIT-UPDATES.                                           *11320002
113300*      COMMIT THE UPDATES TO THE CHECKPOINT CONTROL TABLE,       *11330002
113400*      CHECKPOINT INFORMATION TABLE AND ANY DB2 TABLES THAT      *11340002
113500*      ARE UPDATED BY THE MAINTENANCE PROGRAM.                   *11350002
113600*                                                                *11360002
113700*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *11370002
113800*      PERFORMED BY C400-TAKE-A-CHECKPOINT.                      *11380002
113900******************************************************************11390002
114000                                                                  11400002
114100 Z400-COMMIT-UPDATES.                                             11410002
114200                                                                  11420002
114300     EXEC SQL                                                     11430002
114400         COMMIT                                                   11440002
114500     END-EXEC.                                                    11450002
114600                                                                  11460002
114700     MOVE SQLCODE TO PV-SQLCODE.                                  11470002
114800                                                                  11480002
114900     IF SQLCODE-OK                                                11490002
115000         MOVE MR-MSG-CKPT-TAKEN TO DP001-MESSAGE                  11500002
115100         MOVE MR-RC-CKPT-TAKEN TO DP001-RET-CODE                  11510002
115200     ELSE                                                         11520002
115300         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 11530002
115400         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 11540002
115500         MOVE SQLCODE TO DP001-SQLCODE                            11550002
115600         MOVE SQLWARN TO DP001-SQLWARN                            11560002
115700         MOVE SQLERRD(3) TO DP001-SQLERRD3                        11570002
115800         MOVE SQLERRMC TO DP001-SQLERRMC                          11580002
115900     END-IF.                                                      11590002
116000 EJECT                                                            11600002
116100******************************************************************11610002
116200* Z500-INSERT-CKPT-INFO.                                         *11620002
116300*      INSERT THE DATA BEING SAVED FOR A RESTART FROM THE MAIN-  *11630002
116400*      TENANCE PROGRAM AND TRANSACTION PRESENTATION MODULE INTO  *11640002
116500*      THE CHECKPOINT INFORMATION TABLE.  AN INSERT OF THE DATA  *11650002
116600*      IS DONE ONLY FOR THE FIRST CHECKPOINT TAKEN.              *11660002
116700*                                                                *11670002
116800*      PERFORMED BY D200-SAVE-WORKING-STORAGE.                   *11680002
116900******************************************************************11690002
117000                                                                  11700002
117100 Z500-INSERT-CKPT-INFO.                                           11710002
117200                                                                  11720002
117300     EXEC SQL                                                     11730002
117400         INSERT INTO TCKRSTINF                                    11740002
117500                (JOB_NAME                                         11750002
117600                ,PLAN_NAME                                        11760002
117700                ,SEQ_NMBR                                         11770002
117800                ,RST_TRANS_SEQ_NMBR                               11780002
117900                ,WORK_STRG_DESC)                                  11790002
118000         VALUES (:DP001-JOB-NAME,                                 11800002
118100                 :DP001-PLAN-NAME,                                11810002
118200                 :TCKRSTINF-SEQ-NMBR,                             11820002
118300                 :PA-LAST-TRANS-SEQ-PROCESSED,                    11830002
118400                 :TCKRSTINF-WORK-STRG-DESC)                       11840002
118500     END-EXEC.                                                    11850002
118600                                                                  11860002
118700     MOVE SQLCODE TO PV-SQLCODE.                                  11870002
118800                                                                  11880002
118900     IF SQLCODE-OK                                                11890002
119000         CONTINUE                                                 11900002
119100     ELSE                                                         11910002
119200         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            11920002
119300         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 11930002
119400         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 11940002
119500         MOVE SQLCODE TO DP001-SQLCODE                            11950002
119600         MOVE SQLWARN TO DP001-SQLWARN                            11960002
119700         MOVE SQLERRD(3) TO DP001-SQLERRD3                        11970002
119800         MOVE SQLERRMC TO DP001-SQLERRMC                          11980002
119900     END-IF.                                                      11990002
120000 EJECT                                                            12000002
120100******************************************************************12010002
120200* Z600-UPDATE-CKPT-INFO.                                         *12020002
120300*      UPDATE THE DATA BEING SAVED FOR A RESTART FROM THE MAIN-  *12030002
120400*      TENANCE PROGRAM AND TRANSACTION PRESENTATION MODULE INTO  *12040002
120500*      THE CHECKPOINT INFORMATION TABLE.  UPDATES ARE ISSUED TO  *12050002
120600*      THE TABLE TO SAVE THE DATA AFTER THE FIRST CHECKPOINT IS  *12060002
120700*      TAKEN.                                                    *12070002
120800*                                                                *12080002
120900*      PERFORMED BY D200-SAVE-WORKING-STORAGE.                   *12090002
121000******************************************************************12100002
121100                                                                  12110002
121200 Z600-UPDATE-CKPT-INFO.                                           12120002
121300                                                                  12130002
121400     EXEC SQL                                                     12140002
121500         UPDATE TCKRSTINF                                         12150002
121600            SET  RST_TRANS_SEQ_NMBR = :PA-LAST-TRANS-SEQ-PROCESSED12160002
121700                ,WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC       12170002
121800          WHERE JOB_NAME = :DP001-JOB-NAME                        12180002
121900            AND PLAN_NAME = :DP001-PLAN-NAME                      12190002
122000            AND SEQ_NMBR = :TCKRSTINF-SEQ-NMBR                    12200002
122100     END-EXEC.                                                    12210002
122200                                                                  12220002
122300     MOVE SQLCODE TO PV-SQLCODE.                                  12230002
122400                                                                  12240002
122500     IF SQLCODE-OK                                                12250002
122600         CONTINUE                                                 12260002
122700     ELSE                                                         12270002
122800         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            12280002
122900         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 12290002
123000         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 12300002
123100         MOVE SQLCODE TO DP001-SQLCODE                            12310002
123200         MOVE SQLWARN TO DP001-SQLWARN                            12320002
123300         MOVE SQLERRD(3) TO DP001-SQLERRD3                        12330002
123400         MOVE SQLERRMC TO DP001-SQLERRMC                          12340002
123500     END-IF.                                                      12350002
123600 EJECT                                                            12360002
123700******************************************************************12370002
123800* Z700-FETCH-CKPT-INFO.                                          *12380002
123900*      RETRIEVE THE DATA SAVED IN THE CHECKPOINT INFORMATION     *12390002
124000*      TABLE FROM THE LAST CHECKPOINT.                           *12400002
124100*                                                                *12410002
124200*      PERFORMED BY D400-RETRIEVE-CKPT-INFO.                     *12420002
124300******************************************************************12430002
124400                                                                  12440002
124500 Z700-FETCH-CKPT-INFO.                                            12450002
124600                                                                  12460002
124700     EXEC SQL                                                     12470002
124800         FETCH INFCSR INTO                                        12480002
124900               :TCKRSTINF-SEQ-NMBR                                12490002
125000              ,:TCKRSTINF-RST-TRANS-SEQ-NMBR                      12500002
125100              ,:TCKRSTINF-WORK-STRG-DESC                          12510002
125200     END-EXEC.                                                    12520002
125300                                                                  12530002
125400     MOVE SQLCODE TO PV-SQLCODE.                                  12540002
125500                                                                  12550002
125600     IF (SQLCODE-OK                                               12560002
125700       OR ROW-DOESNT-EXIST)                                       12570002
125800         CONTINUE                                                 12580002
125900     ELSE                                                         12590002
126000         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            12600002
126100         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 12610002
126200         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 12620002
126300         MOVE SQLCODE TO DP001-SQLCODE                            12630002
126400         MOVE SQLWARN TO DP001-SQLWARN                            12640002
126500         MOVE SQLERRD(3) TO DP001-SQLERRD3                        12650002
126600         MOVE SQLERRMC TO DP001-SQLERRMC                          12660002
126700     END-IF.                                                      12670002
126800 EJECT                                                            12680002
126900******************************************************************12690002
127000* Z800-DELETE-CKPT-INFO.                                         *12700002
127100*      DELETE THE DATA SAVED IN THE CHECKPOINT INFORMATION TABLE.*12710002
127200*                                                                *12720002
127300*      PERFORMED BY B300-PROCESS-CLOSE-REQUEST.                  *12730002
127400******************************************************************12740002
127500                                                                  12750002
127600 Z800-DELETE-CKPT-INFO.                                           12760002
127700                                                                  12770002
127800     EXEC SQL                                                     12780002
127900         DELETE FROM TCKRSTINF                                    12790002
128000          WHERE JOB_NAME = :DP001-JOB-NAME                        12800002
128100            AND PLAN_NAME = :DP001-PLAN-NAME                      12810002
128200     END-EXEC.                                                    12820002
128300                                                                  12830002
128400     MOVE SQLCODE TO PV-SQLCODE.                                  12840002
128500                                                                  12850002
128600     IF (SQLCODE-OK                                               12860002
128700       OR ROW-DOESNT-EXIST)                                       12870002
128800         CONTINUE                                                 12880002
128900     ELSE                                                         12890002
129000         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            12900002
129100         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 12910002
129200         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 12920002
129300         MOVE SQLCODE TO DP001-SQLCODE                            12930002
129400         MOVE SQLWARN TO DP001-SQLWARN                            12940002
129500         MOVE SQLERRD(3) TO DP001-SQLERRD3                        12950002
129600         MOVE SQLERRMC TO DP001-SQLERRMC                          12960002
129700     END-IF.                                                      12970002
129800 EJECT                                                            12980002
129900******************************************************************12990002
130000* Z900-OPEN-INFCSR-CURSOR.                                       *13000002
130100*      OPEN THE CURSOR USED TO FETCH ROWS FROM THE CHECKPOINT    *13010002
130200*      INFORMATION TABLE.                                        *13020002
130300*                                                                *13030002
130400*      PERFORMED BY C300-RESTART-PROCESS.                        *13040002
130500******************************************************************13050002
130600                                                                  13060002
130700 Z900-OPEN-INFCSR-CURSOR.                                         13070002
130800                                                                  13080002
130900     EXEC SQL                                                     13090002
131000         OPEN INFCSR                                              13100002
131100     END-EXEC.                                                    13110002
131200                                                                  13120002
131300     MOVE SQLCODE TO PV-SQLCODE.                                  13130002
131400                                                                  13140002
131500     IF SQLCODE-OK                                                13150002
131600         CONTINUE                                                 13160002
131700     ELSE                                                         13170002
131800         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            13180002
131900         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 13190002
132000         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 13200002
132100         MOVE SQLCODE TO DP001-SQLCODE                            13210002
132200         MOVE SQLWARN TO DP001-SQLWARN                            13220002
132300         MOVE SQLERRD(3) TO DP001-SQLERRD3                        13230002
132400         MOVE SQLERRMC TO DP001-SQLERRMC                          13240002
132500     END-IF.                                                      13250002
132600 EJECT                                                            13260002
132700******************************************************************13270002
132800* Z910-CLOSE-INFCSR-CURSOR.                                      *13280002
132900*      CLOSE THE CURSOR USED TO FETCH ROWS FROM THE CHECKPOINT   *13290002
133000*      INFORMATION TABLE.                                        *13300002
133100*                                                                *13310002
133200*      PERFORMED BY C300-RESTART-PROCESS.                        *13320002
133300******************************************************************13330002
133400                                                                  13340002
133500 Z910-CLOSE-INFCSR-CURSOR.                                        13350002
133600                                                                  13360002
133700     EXEC SQL                                                     13370002
133800         CLOSE INFCSR                                             13380002
133900     END-EXEC.                                                    13390002
134000                                                                  13400002
134100                                                                  13410002
134200     MOVE SQLCODE TO PV-SQLCODE.                                  13420002
134300                                                                  13430002
134400     IF SQLCODE-OK                                                13440002
134500         CONTINUE                                                 13450002
134600     ELSE                                                         13460002
134700         MOVE 'Y' TO SW-BAD-SQLCODE-SW                            13470002
134800         MOVE MR-MSG-BAD-SQLCODE TO DP001-MESSAGE                 13480002
134900         MOVE MR-RC-BAD-SQLCODE TO DP001-RET-CODE                 13490002
135000         MOVE SQLCODE TO DP001-SQLCODE                            13500002
135100         MOVE SQLWARN TO DP001-SQLWARN                            13510002
135200         MOVE SQLERRD(3) TO DP001-SQLERRD3                        13520002
135300         MOVE SQLERRMC TO DP001-SQLERRMC                          13530002
135400     END-IF.                                                      13540002
135500 EJECT                                                            13550002
135600******************************************************************13560002
135700* Z920-ROLLBACK.                                                 *13570002
135800*      ROLLBACK ANY UPDATES SINCE THE LAST COMMIT IF A BAD       *13580002
135900*      SQLCODE IS RETURNCED ON A DB2 CALL.                       *13590002
136000*                                                                *13600002
136100*      PERFORMED BY A100-MAINLINE-PROCESSING.                    *13610002
136200******************************************************************13620002
136300                                                                  13630002
136400 Z920-ROLLBACK.                                                   13640002
136500                                                                  13650002
136600     EXEC SQL                                                     13660002
136700         ROLLBACK                                                 13670002
136800     END-EXEC.                                                    13680002
