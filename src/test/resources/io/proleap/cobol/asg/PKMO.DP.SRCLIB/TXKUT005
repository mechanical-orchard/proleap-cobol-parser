000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000400                                                                  00030000
000500 PROGRAM-ID.             TXKUT005.                                00040000
000600 AUTHOR.                 KATHY PRIESTER.                          00050000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060000
000800 DATE-WRITTEN.           MARCH 2001.                              00070000
000900 DATE-COMPILED.                                                   00080000
001000                                                                  00090000
001100******************************************************************00100046
001200*  THIS PROGRAM CREATES AN EXTRACT FILE FOR TAX REPORTING.       *00110000
001300*                                                                *00120000
001400*  IT USES THE POS TRANSACTION DATA BASE AS ITS SOURCE.          *00130000
001500*                                                                *00140000
001600*  THE PROGRAM HAS AN INPUT CONTROL CARD CONTAINING THE CURRENT  *00150000
001700*  PROCESSING DATE.                                              *00160000
001800*                                                                *00170000
001900*  THE OPERATING TABLES CONTAIN THE MOST CURRENT TRANSACTIONS.   *00180000
002200*                                                                *00190000
002300*  THE INFORMATION IN THE TRANSACTION DATABASE TABLES IS STORED  *00200000
002400*  IN PARTITIONS.  IN THE OPERATING DATABASE, EACH PARTITION     *00210000
002500*  CONTAINS ALL OF THE TRANSACTIONS PROCESSED IN ONE DAY.  THE   *00220000
002600*  TABLE TEPPART INDICATES THE PARTITION TO LOOK IN FOR EACH     *00230000
002700*  PROCESSING DATE.                                              *00240000
003100*                                                                *00250000
003200*  FIRST THIS PROGRAM SELECTS ALL OF THE TRANSACTIONS FROM THE   *00260000
003300*  TEPTRN TABLE FOR THE CURRENT PROCESSING DATE.                 *00270000
003400*                                                                *00280000
003500*  IT USES THE XST_LOC TABLE TO GET INFORMATION ABOUT THE STORE  *00290000
003600*  ON EACH TRANSACTION.  IT NEEDS THIS TABLE TO GET THE ZIP CODE *00300000
003700*  AND AN INDICATOR THAT SPECIFIES WHETHER THE STORE IS AN       *00310000
003800*  E-COMMERCE STORE.  THE STORE GEO CODE FILE IS A VSAM FILE     *00320000
003900*  CONTAINING THE TAXWARE GEO CODE FOR EACH STORE.               *00330000
004000*                                                                *00340000
004100*  TAX INFORMATION FOR E-COMMERCE TRANSACTIONS IS TAKEN FROM     *00350000
004200*  THE TEPITM TABLE.                                             *00360000
004300*                                                                *00370000
004400*  TAX INFORMATION FOR BRICK AND MORTAR TRANSACTIONS IS TAKEN    *00380000
004500*  FROM THE TEPRTX TABLE.                                        *00390000
004600*                                                                *00400000
C74909******************************************************************00410000
C74909*  CHANGE DATE :- 12/24/2013  *                                   00420000
C74909*  CHANGE MADE :- MODIFIED THE PROGRAM FOR REVERSAL TRANSACTION. *00430000
C74909*                 ELIMINATE REVERSAL TRANSACTION & CORRECTION &  *00440000
C74909*                 REVERSAL DONE ON SAME DAY.                      00450000
C74909*  MADE BY     :- COGNIZANT               WR/IR #: CHG0074909     00460000
004700******************************************************************00470000
004710*  10/04/11  TY HOPP                                             *00480000
004720*  ADD PARA 5415- TO DISPLAY BAD TRANSACTIONS AND SKIP RECORD    *00490000
004721*  UNTIL A PERMANENT CURSOR SOLUTION TO TEPLIS HAS BEEN TESTED.  *00500000
004722******************************************************************00510000
004723*  10/02/12  TY HOPP                                             *00520000
004724*  ADD -811 LOGIC TO 7600- CALL TO HANDLE MULTIPLE ROWS.         *00530000
004725*  CHANGE MARKED TDH001                                          *00540000
004726******************************************************************00550000
004727*  06/04/13  DAVE WELLER                                         *00560000
004728*  CHANGES RELATED TO SFS CHANGE TO TEPTRN                       *00570000
004729*  CHANGE MARKED C53632                                          *00580000
004730******************************************************************00590000
C62728*  10/21/13  DAVE WELLER  CHG0062728                             *00600000
C62728*  CHANGES TO REMOVE REFERENCES TO COSA HISTORY TABLES, WHICH    *00610000
C62728*  ARE NO LONGER BEING UPDATED.                                  *00620000
C62728*  REMOVED LOGIC THAT REFERENCING THE FOLLOWING COSA HISTORY     *00630000
C62728*  TABLES FOR 9607 - FSH 2013-CFMC PROJECT.                      *00640000
C62728******************************************************************00650000
C70860******************************************************************00660000
C70860*  12/24/13  COGNIZANT    CHG0070860                             *00670000
C70860*  FIX TO CORRECT THE SHIPPING CHARGE TAX FOR SFS TRANSACTION    *00680000
C70860******************************************************************00690000
CH7019*  02/20/2014  CHANGES TO REMOVE THE TAX COMPUTATION FOR THE    * 00700000
CH7019*              ITEMS WHICH HAS TAX AMOUNT IN TEPITM TABLE.      * 00710000
CH7019*  MADE BY: COGNIZANT                        CHG77019           * 00720000
CH7019***************************************************************** 00730000
C76279******************************************************************00740000
C76279*  02/24/13  COGNIZANT    CHG0076279                             *00750000
C76279*  BOPUS COMPANION PROJECT - MODIFIED THE TRANSACTION INDICATIOR *00760000
C76279*  SWITCH TO HAVE BOPUS-B, SFS - S & OTHERS - N. CHANGES MADE TO *00770000
C76279*  PROCESS BOPUS TRANSACTION AS AN ECOMMERCE STORE               *00780000
C76279*  ALSO ZIPCODE WILL BE LOOKED UP IN XST_LOC TABLE FOR BOPUS     *00790000
C76279*  TRANSACTION.                                                  *00800000
C76279******************************************************************00810000
C92405******************************************************************00820000
C92405*  12/17/14  BARB SCHULTZ CHG0092405                             *00830000
C92405*  MARKETPLACE PROJECT - ADDED CODE TO BYPASS ALL WAYFAIR ITEMS. *00840000
C92405******************************************************************00850000
C19114******************************************************************00860001
C19114*  08/13/15  COGNIZANT    CHG0119114                             *00870003
C19114*  MODIFIED THE SHIP-CSR TO AVOID THE DUPLICATE SHIPPING RECORDS *00880001
C19114*  THE CURSOR WAS EXTRACTING THE DUPLICATE RECORDS WHENEVER THERE*00890001
C19114*  ARE MORE THAN ONE ITEM PER TRANSACTION                        *00900001
C19114******************************************************************00910001
P10237*  05/26/2015  COSA DATA SECURITY PROJECT.                       *00920000
P10237*     CHANGES MADE TO CONVERT THE ZIP CODE TO BINARY FORMAT, THEN*00930000
P10237*  DECRYPT THIS BINARY VALUE USING PROTEGRITY MODULE AND THEN    *00940000
P10237*  CONVERT THE DECRYPTED ZIP CODE TO EBCDIC FORMAT               *00950000
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429          *00960000
P10237******************************************************************00970000
006491*  05/02/2016  OUTLET - TX CHANGES.                              *00980005
006492*     CHANGES MADE TO PROCESS OUTLET STORES AS ECOMM FOR ITEM LVL*00990005
006493*     TAX PROCESSING.OUTLET STORES =  '001'                      *01000006
006495*  MADE BY: ACCENTURE                   WR#: CHG0139454          *01010005
006496******************************************************************01020005
STCFEE* CHANGE #: CHG0160001   JIM HUNTER         DATE:2017-01-30       01030051
STCFEE* --------------------                                            01040051
STCFEE* ADDING LOGIC TO CAPTURE FEES FROM THE TEPLIS TABLE FOR THE      01050010
STCFEE* SALES TAX COMPLIANCE PROJECT.                                   01060010
STCFEE* CONVERT B&M TEPLIS CALL TO A CURSOR AND REMOVE PARA             01070014
STCFEE* 5415-BAD-TRANS-DISPLAY.                                         01080014
STCFEE* ALSO, INITIALIZE TX006-TAXWARE-PROD-CDE WITH THE VALUES LOADED  01090010
STCFEE* INTO EPITM_TX_PRD_CDE_DESC INSTEAD OF ZEROES.                   01100010
STCFEE******************************************************************01110010
P10237******************************************************************01111072
CHG344*  05/24/2017                                                     01112072
CHG344*     CHANGES TO REMOVE BRICK AND MORTAR STORE TRANSACTIONS       01113072
CHG344*     AND BOPUS TRANSACTIONS FROM TAX BATCH PROCESS.              01114072
CHG344*  MADE BY: COGNIZANT                   WR#: CHG0169344          *01115072
BOSS  ******************************************************************01116076
BOSS  *  02/23/2018                                                     01117076
BOSS  *     CHANGES TO ADD LOGIC FOR BOSS ONLY WHERE BOPUS IS STILL IN  01118076
BOSS  *     THE PROGRAM.                                                01119076
BOSS  *  MADE BY: BARB SCHULTZ                WR#: CHG0188487          *01119177
BOSS  ******************************************************************01119276
004740 ENVIRONMENT DIVISION.                                            01120000
004750 INPUT-OUTPUT SECTION.                                            01130000
004760                                                                  01140000
004770 FILE-CONTROL.                                                    01150000
004780                                                                  01160000
004790     SELECT POS-DATE-CARD-FILE                                    01170000
004800         ASSIGN TO INP01.                                         01180000
004900                                                                  01190000
005000     SELECT TAX-EXTRACT-FILE                                      01200000
005100         ASSIGN TO OUT01.                                         01210000
005200                                                                  01220000
005300******************************************************************01230000
005400 DATA DIVISION.                                                   01240000
005500******************************************************************01250000
005600                                                                  01260000
005700 FILE SECTION.                                                    01270000
005800                                                                  01280000
005900 FD  POS-DATE-CARD-FILE                                           01290000
006000     RECORDING MODE IS F                                          01300000
006100     BLOCK CONTAINS 0 RECORDS                                     01310000
006200     LABEL RECORDS ARE STANDARD.                                  01320000
006300                                                                  01330000
006400 01  POS-DATE-CARD-RECORD            PIC X(80).                   01340000
006500                                                                  01350000
006600 FD  TAX-EXTRACT-FILE                                             01360000
006700     RECORDING MODE IS F                                          01370000
006800     LABEL RECORDS ARE STANDARD                                   01380000
006900     BLOCK CONTAINS 0 RECORDS                                     01390000
007000     RECORD CONTAINS 200 CHARACTERS                               01400000
007100     DATA RECORD IS TAX-EXTRACT-RECORD.                           01410000
007200                                                                  01420000
007300 01  TAX-EXTRACT-RECORD       PIC X(200).                         01430000
007400                                                                  01440000
007500 WORKING-STORAGE SECTION.                                         01450000
007600                                                                  01460000
007700******************************************************************01470000
007800* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    01480000
007900******************************************************************01490000
008000 01  CC-CONTROL-CARD.                                             01500000
008100     05  CC-CONTROL-CARD-DISPLAY.                                 01510000
008200         10  CC-CONTROL-NAME     PIC X(14)    VALUE               01520000
008300                                              'P.O.S. DATE = '.   01530000
008400         10  CC-POS-DATE-MMDDYY.                                  01540000
008500             15  CC-POS-DATE-MM  PIC 9(2)     VALUE ZERO.         01550000
008600             15  CC-POS-DATE-DD  PIC 9(2)     VALUE ZERO.         01560000
008700             15  CC-POS-DATE-YY  PIC 9(2)     VALUE ZERO.         01570000
008800     05  FILLER                  PIC X(60)    VALUE SPACE.        01580000
008900                                                                  01590000
009000 01  PV-POS-CCYY-MM-DD.                                           01600000
009100     05  PV-POS-CC               PIC X(02).                       01610000
009200     05  PV-POS-YY               PIC X(02).                       01620000
009300     05  FILLER                  PIC X(01).                       01630000
009400     05  PV-POS-MM               PIC X(02).                       01640000
009500     05  FILLER                  PIC X(01).                       01650000
009600     05  PV-POS-DD               PIC X(02).                       01660000
009700                                                                  01670000
009800 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01680000
009900                                                  COMP SYNC.      01690000
010000     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01700000
P10237     88  AC-TABLE-OVERFLOW                        VALUE +4004.    01710000
010100     88  AC-DB2-ERROR                             VALUE +4013.    01720000
010200     88  AC-TXKUT032-ERROR                        VALUE +4014.    01730000
010300     88  AC-TXKUT033-ERROR                        VALUE +4015.    01740000
P10237                                                                  01750000
P10237 01  ABEND-CODE                        PIC S9(04) VALUE ZERO      01760000
P10237                                                  COMP SYNC.      01770000
P10237     88  AC-CONVERSION-ERROR                      VALUE +4008.    01780000
010400                                                                  01790000
010500 01  PS-PROGRAM-SWITCHES.                                         01800000
011100     05  PS-NULL-IND6            PIC S9(4) COMP VALUE ZERO.       01860000
011200         88 PS-IND6-IS-NULL             VALUE -1.                 01870000
STCFEE     05  PS-NULL-IND7            PIC S9(4) COMP VALUE ZERO.       01880018
011300     05  PS-TEPECX-EXISTS-SW         PIC S9 COMP-3 VALUE ZERO.    01890000
011400         88  PS-TEPECX-EXISTS-YES                  VALUE 1.       01900000
011500         88  PS-TEPECX-EXISTS-NO                   VALUE ZERO.    01910000
CHG859     05  PS-PS-SHIP-CODE-NOT-FOUND-SW   PIC S9 COMP-3 VALUE ZERO. 01920073
CHG859         88  PS-SHIP-CODE-FOUND                VALUE 1.           01930000
CHG859         88  PS-SHIP-CODE-NOT-FOUND               VALUE ZERO.     01940000
011600     05  RESEND-OF-ECOM-TABLE-SWITCH                              01950073
011700                                 PIC X(1)     VALUE 'N'.          01960000
011800         88  PS-NOT-END-OF-ECOM-TABLE         VALUE 'N'.          01970000
011900         88  PS-END-OF-ECOM-TABLE             VALUE 'Y'.          01980000
P10237     05  PS-END-OF-ZIP-TABLE-SWITCH                               01990000
P10237                                 PIC X(1)     VALUE 'N'.          02000000
P10237         88  PS-NOT-END-OF-ZIP-TABLE          VALUE 'N'.          02010000
P10237         88  PS-END-OF-ZIP-TABLE              VALUE 'Y'.          02020000
012000     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      02030000
012100         88  PS-END-OF-CARD-FILE-YES              VALUE 'Y'.      02040000
012200     05  PS-END-OF-LATE-COR-CURSOR-SW                             02050000
012300                                 PIC X(1)     VALUE 'N'.          02060000
012400         88  PS-END-OF-LATE-COR-CURSOR        VALUE 'Y'.          02070000
012500         88  PS-NOT-END-OF-LATE-COR-CURSOR    VALUE 'N'.          02080000
012600     05  PS-END-OF-LATE-VOID-CURSOR-SW                            02090000
012700                                 PIC X(1)     VALUE 'N'.          02100000
012800         88  PS-END-OF-LATE-VOID-CURSOR       VALUE 'Y'.          02110000
012900         88  PS-NOT-END-OF-LATE-VOID-CURSOR   VALUE 'N'.          02120000
013000     05  PS-END-OF-LINE-ITEM-CURSOR-SW                            02130000
013100                                 PIC X(1)     VALUE 'N'.          02140000
013200         88  PS-END-OF-LINE-ITEM-CURSOR       VALUE 'Y'.          02150000
013300         88  PS-NOT-END-OF-LINE-ITEM-CURSOR   VALUE 'N'.          02160000
013400     05  PS-END-OF-POS-TRAN-CURSOR-SW                             02170000
013500                                 PIC X(1)     VALUE 'N'.          02180000
013600         88  PS-END-OF-POS-TRAN-CURSOR        VALUE 'Y'.          02190000
013700         88  PS-NOT-END-OF-POS-TRAN-CURSOR    VALUE 'N'.          02200000
013800     05  PS-END-OF-SSFEES-CURSOR-SW                               02210000
013900                                 PIC X(1)     VALUE SPACE.        02220000
014000         88  PS-END-OF-SSFEES-CURSOR          VALUE 'Y'.          02230000
014100         88  PS-NOT-END-OF-SSFEES-CURSOR      VALUE 'N'.          02240000
014200     05  PS-END-OF-SHIP-CURSOR-SW                                 02290000
014300                                  PIC X(1)     VALUE SPACE.       02300000
014400         88  PS-END-OF-SHIP-CURSOR             VALUE 'Y'.         02310000
014500         88  PS-NOT-END-OF-SHIP-CURSOR         VALUE 'N'.         02320000
014600     05  PS-ECOMMERCE-STORE-SW                                    02330000
014700                                  PIC X(1)     VALUE SPACE.       02340000
014800         88  PS-ECOMMERCE-STORE                VALUE 'Y'.         02350000
014900         88  PS-NOT-ECOMMERCE-STORE            VALUE 'N'.         02360000
015000     05  PS-ECOMMERCE-RETURN-SW                                   02370000
015100                                  PIC X(1)     VALUE SPACE.       02380000
015200         88  PS-ECOMMERCE-RETURN               VALUE 'Y'.         02390000
015300         88  PS-NOT-ECOMMERCE-RETURN           VALUE 'N'.         02400000
015400     05  PS-RECEIPTED-RETURN-SW                                   02410000
015500                                  PIC X(1)     VALUE SPACE.       02420000
015600         88  PS-RECEIPTED-RETURN               VALUE 'Y'.         02430000
015700         88  PS-NON-RECEIPTED-RETURN           VALUE 'N'.         02440000
016200     05  PS-OMNI-CHNL-NULL-SW                                     02490000
016210                                  PIC X(1)     VALUE 'Y'.         02500000
016220         88  PS-OMNI-CHNL-IS-NULL              VALUE 'Y'.         02510000
016230         88  PS-OMNI-CHNL-IS-NOT-NULL          VALUE 'N'.         02520000
016240     05  PS-END-OF-TEPITM-CSR-SW  PIC X(01)    VALUE 'N'.         02530000
016250         88  PS-END-OF-TEPITM-CSR              VALUE 'Y'.         02540000
016260         88  PS-NOT-END-OF-TEPITM-CSR          VALUE 'N'.         02550000
TMPFIX     05  PS-END-OF-TEPITM-MISS-CSR-SW  PIC X(01)    VALUE 'N'.    02560000
TMPFIX         88  PS-END-OF-TEPITM-MISS-CSR              VALUE 'Y'.    02570000
TMPFIX         88  PS-NOT-END-OF-TEPITM-MISS-CSR          VALUE 'N'.    02580000
TMPFIX     05  PS-ORIG-SALES-DATE-FOUND-SW PIC X(01) VALUE 'N'.         02590000
TMPFIX         88  PS-ORIG-SALES-DATE-FOUND          VALUE 'Y'.         02600000
TMPFIX         88  PS-ORIG-SALES-DATE-NOT-FOUND      VALUE 'N'.         02610000
016300     05  PS-TRN-TYP-CDE           PIC X(02)    VALUE SPACES.      02620000
016400         88  PS-SALE-TRANSACTION               VALUES '01' '02'.  02630000
016500         88  PS-RETURN-TRANSACTION             VALUES '11' '12'.  02640000
016600         88  PS-MIX-MODE-TRANSACTION           VALUES '22' '23'.  02650000
016700         88  PS-PRICE-ADJ-TRANSACTION          VALUES '24' '25'.  02660000
016800         88  PS-EMP-CASH-TRANSACTION  VALUES '02' '12' '22' '25'. 02670000
016900                                                                  02680000
017000 01  PC-PROGRAM-CONSTANTS.                                        02690000
017100     05  PC-CURRENT-PROGRAM-NAME PIC   X(8)   VALUE 'TXKUT005'.   02700000
P10237     05  PC-DPKUT052             PIC   X(8)   VALUE 'DPKUT052'.   02710000
017200     05  PC-SALE                 PIC   X(02)  VALUE '01'.         02720000
017300     05  PC-ASSOC-SALE           PIC   X(02)  VALUE '02'.         02730000
017400     05  PC-RETURN               PIC   X(02)  VALUE '11'.         02740000
017500     05  PC-ASSOC-RETURN         PIC   X(02)  VALUE '12'.         02750000
017600     05  PC-EVEN-EXCHANGE        PIC   X(02)  VALUE '21'.         02760000
017700     05  PC-ASSOC-MIX-MODE       PIC   X(02)  VALUE '22'.         02770000
017800     05  PC-MIX-MODE             PIC   X(02)  VALUE '23'.         02780000
017900     05  PC-PRICE-ADJUSTMENT     PIC   X(02)  VALUE '24'.         02790000
018000     05  PC-ASSOC-PRICE-ADJ      PIC   X(02)  VALUE '25'.         02800000
018100     05  PC-NEGATIVE-ROUNDING    PIC S9(7)V9(6)                   02810000
018200                                              VALUE -.009999.     02820000
018300     05  PC-MISC-SKU             PIC   X(08)  VALUE '09910000'.   02830000
018400     05  PC-SHIPPING-CHARGE      PIC   X(08)  VALUE '85010001'.   02840000
018500     05  PC-GIFT-WRAPPING        PIC   X(08)  VALUE '85020001'.   02850000
018600     05  PC-SPACES               PIC   X(10)  VALUE SPACES.       02860000
P10237     05  PC-ZIP-MAX              PIC S9(5)    COMP                02870000
P10237                                              VALUE +99999.       02880000
018700                                                                  02890000
018800 01  PV-PROGRAM-VARIABLES.                                        02900000
018900     05  PV-PARAGRAPH-NAME       PIC  X(30)   VALUE SPACE.        02910000
019000     05  PV-DB2-OPERATION        PIC  X(40)   VALUE SPACE.        02920000
019100     05  PV-WORK-AMOUNT          PIC S9(7)V99 COMP-3 VALUE ZERO.  02930000
019200     05  PV-UPC                  PIC  9(13).                      02940000
019300     05  PV-STR-NBR-9            PIC  9(04)   VALUE ZERO.         02950000
019400     05  PV-RGST-ID-9            PIC  9(04)   VALUE ZERO.         02960000
019500     05  PV-TRN-NBR-9            PIC  9(04)   VALUE ZERO.         02970000
019600     05  PV-SAVE-STR-NBR         PIC S9(04)   COMP VALUE ZERO.    02980000
019700     05  PV-WORK-STR-NBR         PIC S9(04)   COMP VALUE ZERO.    02990000
019800     05  PV-SAVE-SLD-QTY         PIC S9(04)   COMP VALUE ZERO.    03000000
019900     05  PV-SAVE-ST-CODE         PIC  X(02)   VALUE SPACES.       03010000
020000     05  PV-SAVE-RCPT-TX-TOT-CDE PIC  X(02)   VALUE SPACES.       03020000
020100     05  PV-SHIP-ST-CODE         PIC  X(02)   VALUE SPACES.       03030000
P10237     05  PV-ZIP-CODE             PIC  X(05)   VALUE SPACES.       03040000
P10237     05  PV-ZIP-LENGTH           PIC  9(09)   VALUE ZEROES.       03050000
P10237     05  PV-INPUT-TEXT           PIC  X(24)   VALUE SPACES.       03060000
P10237     05  PV-OUTPUT-TEXT          PIC  X(18)   VALUE SPACES.       03070000
P10237     05  PV-ENCR-ZIP-CODE        PIC  X(24)   VALUE SPACES.       03080000
020200     05  PV-SHIP-ZIP-CODE        PIC  X(05)   VALUE SPACES.       03090000
020300     05  PV-SHIP-GEO-CODE        PIC  X(02)   VALUE SPACES.       03100000
020400     05  PV-SAVE-ZIP-CDE         PIC  X(05)   VALUE SPACES.       03110000
020500     05  PV-SAVE-GEO-CDE         PIC  X(02)   VALUE SPACES.       03120000
020600     05  PV-BUS-LOC-IND          PIC  X(01)   VALUE SPACE.        03130000
020700     05  PV-DEPT-NBR             PIC  X(03)   VALUE SPACE.        03140000
020800     05  PV-SUB-CL-NBR           PIC  X(02)   VALUE SPACE.        03150000
020900     05  PV-MAJ-CL-NBR           PIC  S9(4)   COMP-3 VALUE ZERO.  03160000
021000     05  PV-SKU-NBR              PIC  X(08)   VALUE SPACE.        03170000
021100         88  PV-MISC-SKU                  VALUE '09910000'.       03180000
021200         88  PV-TAX-REFUND-SKU            VALUE '88268073'.       03190000
021300         88  PV-SHIPPING-CHARGE           VALUE '85010001'.       03200000
021400     05  PV-SKU                   PIC  9(08)   VALUE ZERO.        03210000
021500     05  PV-SKU-C                 PIC S9(08)   VALUE ZERO COMP-3. 03220000
021600     05  PV-LATE-COR-ROWS-FETCHED PIC S9(09)   COMP-3 VALUE ZERO. 03230000
021700     05  PV-TAX-RATE-PCT         PIC S9(1)V9(5) COMP-3 VALUE ZERO.03240000
021800     05  PV-PRV-TX-AMT           PIC S9(7)V9(2) COMP-3 VALUE ZERO.03250000
021900     05  PV-TRN-CHRGD-AMT        PIC S9(7)V9(2) COMP-3 VALUE ZERO.03260000
022000     05  PV-TX-AMT               PIC S9(7)V9(2) COMP-3 VALUE ZERO.03270000
022100     05  PV-TX-AMT-UR            PIC S9(7)V9(6) COMP-3 VALUE ZERO.03280000
022300     05  PV-ORIG-PARTN-NBR        PIC S9(04)     COMP.            03300000
022310     05  PV-ORD-PARTN-NBR        PIC S9(04)     COMP.             03310000
022500     05  PV-SLS-CORR-SEQ-NBR      PIC S9(04)     COMP.            03320000
022600     05  PV-ORIG-TX-RT-PCT        PIC S9V9(04)   COMP-3.          03330000
022700     05  PV-ORIG-TX-AMT           PIC S9(7)V99   COMP-3.          03340000
P10237     05  PV-ORIG-ZIP-5-CDE        PIC X(24).                      03350000
022900     05  PV-ORIG-GEOG-CDE         PIC X(02).                      03360000
023000     05  PV-ORIG-TRN-DTE          PIC X(10).                      03370000
023100     05  PV-SAVE-ZIP-5-CDE        PIC X(05).                      03380000
023200     05  PV-SAVE-GEOG-CDE         PIC X(02).                      03390000
023300     05  PV-TAX-VAR               PIC S9(7)V99   COMP-3.          03400000
023400     05  PV-SRVC-TYP-CDE          PIC X(01).                      03410000
023500     05  PV-ORD-DTE               PIC X(10).                      03420000
023800     05  PV-ROUND-IND             PIC X.                          03450000
023910     05  PV-SHP-CSR-SETUP-FIELDS.                                 03470000
023911         10 PV-SHP-PARTN-NBR          PIC  S9(4) COMP.            03480000
023912         10 PV-SHP-STR-NBR            PIC  S9(4) COMP.            03490000
023913         10 PV-SHP-RGST-ID            PIC  S9(4) COMP.            03500000
023914         10 PV-SHP-TRN-NBR            PIC  S9(4) COMP.            03510000
023915         10 PV-SHP-STRT-TM            PIC   X(8).                 03520000
023916         10 PV-TRN-DTE                PIC   X(10)                 03530000
                                            VALUE '9999-09-09'.         03540000
016200     05  PS-OMNI-CHNL-IND             PIC X(1) VALUE 'T'.         03550000
C76279     05  PS-TRAN-IND                  PIC X(1) VALUE ' '.         03560000
C76279         88  PS-SFS                            VALUE 'S'.         03570000
C76279         88  PS-BPS                            VALUE 'B'.         03580000
BOSS           88  PS-BOS                            VALUE 'O'.         03581075
C76279         88  PS-OTH                            VALUE 'N'.         03590000
TMPFIX     05  PV-SLS-DTE-WRK               PIC X(10)                   03600000
TMPFIX                                      VALUE '9999-09-09'.         03610000
023917                                                                  03620000
P10237******************************************************************03630000
P10237* LK52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.                 03640000
P10237******************************************************************03650000
P10237 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              03660000
P10237   05  LK52-CONVERSION-TYPE      PIC  X(01).                      03670000
P10237     88  EBCDIC-TO-ASCII                     VALUE '1'.           03680000
P10237     88  ASCII-TO-EBCDIC                     VALUE '2'.           03690000
P10237   05  LK52-LENGTH               PIC S9(03)  COMP-3.              03700000
P10237   05  LK52-FROM-AREA            PIC  X(50)  VALUE SPACES.        03710000
P10237   05  LK52-TO-AREA              PIC  X(50)  VALUE SPACES.        03720000
P10237   05  LK52-RETURN-CODE          PIC  X(02)  VALUE '00'.          03730000
P10237     88  GOOD-LK52-RET-CODE                  VALUE '00'.          03740000
P10237*                                                                 03750000
023918                                                                  03760000
023919 01  PA-PROGRAM-ACCUMULATORS.                                     03770000
023920     05  PA-TRN-TX-AMT          PIC S9(7)V99 COMP-3.              03780000
023921                                                                  03790000
023930 01  EC-ECOM-STORE-TABLE.                                         03800000
023940     05  EC-ECOM-STORE-TABLE-ENTRIES OCCURS 2000 TIMES            03810000
023950                                     INDEXED BY EC-IDX, EC-IDX2.  03820000
023960         10  EC-STR-NBR          PIC S9(4) COMP.                  03830000
023970         10  EC-BUS-LOC-IND      PIC  X(1).                       03840000
023980         10  EC-ST-CDE           PIC  X(2).                       03850000
023990         10  EC-ZIP-CODE         PIC  X(5).                       03860000
024000         10  EC-GEO-CODE         PIC  X(2).                       03870000
024100         10  EC-GEO-FOUND-IND    PIC  X(1).                       03880000
024200         10  EC-ROUND-IND        PIC  X(1).                       03890000
024300                                                                  03900000
P10237******************************************************************03910000
P10237*  PV-ZIP-CODE-TABLE - TO STORE THE ENCRYPTED AND ITS             03920000
P10237*                      CORRESPONDING DECRYPTED CLEAR ZIP-CODE.    03930000
P10237******************************************************************03940000
P10237 01  PV-ZIP-CODE-TABLE.                                           03950000
P10237     05  PV-ZIP-CODE-TABLE-ENTRIES OCCURS 99999 TIMES             03960000
P10237                                     INDEXED BY ZP-IDX, ZP-IDX2.  03970000
P10237         10  ENCRYPT-ZIP         PIC  X(24).                      03980000
P10237         10  DECRYPT-ZIP         PIC  X(5).                       03990000
P10237                                                                  04000000
024400***************************************************************** 04010000
024500*  TAX EXTRACT FILE RECORD LAYOUT                                 04020000
024600***************************************************************** 04030000
024700     COPY TXRD006.                                                04040000
024800                                                                  04050000
P10237******************************************************************04060000
P10237*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA        04070000
P10237******************************************************************04080000
P10237     COPY DPWS022.                                                04090000
P10237                                                                  04100000
024900******************************************************************04110000
025000*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             04120000
025100******************************************************************04130000
025200     COPY DPWS500.                                                04140000
025300                                                                  04150000
025400******************************************************************04160000
025500*  ENTER A DESCRIPTION                                            04170000
025600******************************************************************04180000
025700     COPY DPWS004.                                                04190000
025800                                                                  04200000
025900******************************************************************04210000
026000*  ENTER A DESCRIPTION                                            04220000
026100******************************************************************04230000
026200     COPY ARWS012.                                                04240000
026300                                                                  04250000
P10237******************************************************************04260000
P10237*  LAYOUT FOR THE PARAMETERS NEEDED TO INVOKE PROTEGRITY MODULE  *04270000
P10237******************************************************************04280000
P10237     COPY PTYCCSIP.                                               04290000
P10237                                                                  04300000
P10237******************************************************************04310000
P10237*  LAYOUT FOR THE WORKING VARIABLES TO INVOKE PROTEGRITY MODULE  *04320000
P10237******************************************************************04330000
P10237     COPY DPWS031.                                                04340000
P10237                                                                  04350000
026400******************************************************************04360000
026500*  POS TRANSACTION TABLE LAYOUT                                   04370000
026600******************************************************************04380000
026700     EXEC SQL                                                     04390000
026800         INCLUDE TEPTRN                                           04400000
026900     END-EXEC.                                                    04410000
027000                                                                  04420000
027800******************************************************************04430000
027900*  ITEM PLANNED SHIPMENT TABLE                                    04440000
028000******************************************************************04450000
028100     EXEC SQL                                                     04460000
028200         INCLUDE TEPIPS                                           04470000
028300     END-EXEC.                                                    04480000
028400                                                                  04490000
029200******************************************************************04500000
029300*  POS ITEM TABLE LAYOUT                                          04510000
029400******************************************************************04520000
029500     EXEC SQL                                                     04530000
029600         INCLUDE TEPITM                                           04540000
029700     END-EXEC.                                                    04550000
029800                                                                  04560000
030600******************************************************************04570000
030700*  POS PROCESSING KEY TABLE LAYOUT (FOR LATE AND SALES CORRECTION 04580000
030800*  TRANSACTIONS)                                                  04590000
030900******************************************************************04600000
031000     EXEC SQL                                                     04610000
031100         INCLUDE TEPDKEY                                          04620000
031200     END-EXEC.                                                    04630000
031300                                                                  04640000
031400******************************************************************04650000
031500*  ECOMMERCE ORDER TABLE                                          04660000
031600******************************************************************04670000
031700     EXEC SQL                                                     04680000
031800         INCLUDE TEPORD                                           04690000
031900     END-EXEC.                                                    04700000
032000                                                                  04710000
032100******************************************************************04720000
032800******************************************************************04790000
032900*  POS KOHLS TAX EXEMPT ID TABLE                                  04800000
033000******************************************************************04810000
033100     EXEC SQL                                                     04820000
033200         INCLUDE TEPTAX                                           04830000
033300     END-EXEC.                                                    04840000
033400                                                                  04850000
033500******************************************************************04860000
033600*  POS PARTITION TABLE                                            04870000
033700******************************************************************04880000
033800     EXEC SQL                                                     04890000
033900         INCLUDE TEPPART                                          04900000
034000     END-EXEC.                                                    04910000
034100                                                                  04920000
034200******************************************************************04930000
034300*  POS ITEM RETURN TABLE                                          04940000
034400******************************************************************04950000
034500     EXEC SQL                                                     04960000
034600         INCLUDE TEPIRT                                           04970000
034700     END-EXEC.                                                    04980000
034800                                                                  04990000
034900******************************************************************05000000
035000*  LINE ITEM SERVICE FEES TABLE                                   05010000
035100******************************************************************05020000
035200     EXEC SQL                                                     05030000
035300         INCLUDE TEPLIS                                           05040000
035400     END-EXEC.                                                    05050000
035500                                                                  05060000
035600******************************************************************05070000
035700*  TEPECX TABLE                                                   05080000
035800******************************************************************05090000
035900     EXEC SQL                                                     05100000
036000         INCLUDE TEPECX                                           05110000
036100     END-EXEC.                                                    05120000
036200                                                                  05130000
036300******************************************************************05140000
036400*   SHIPPING INFORMATION TABLE                                    05150000
036500******************************************************************05160000
036600     EXEC SQL                                                     05170000
036700         INCLUDE TEPSHP                                           05180000
036800     END-EXEC.                                                    05190000
036900                                                                  05200000
037700******************************************************************05210000
037800*   XST_LOC - XS SELLING & CUST SERVICE DOMAIN LOCATION TABLE    *05220000
037900******************************************************************05230000
038000     EXEC SQL                                                     05240000
038100         INCLUDE XST00001                                         05250000
038200     END-EXEC.                                                    05260000
038300                                                                  05270000
038400******************************************************************05280000
038500*   XST_LOC_ATTR - XS LOCATION ATTRIBUTE TABLE                   *05290000
038600******************************************************************05300000
038700     EXEC SQL                                                     05310000
038800         INCLUDE XST00025                                         05320000
038900     END-EXEC.                                                    05330000
039000                                                                  05340000
039100******************************************************************05350000
039200*  TSTATE CONTAINS THE ROUNDING INDICATOR FOR EACH STATE.         05360000
039300*  0 - CONVENTIONAL ROUNDING                                      05370000
039400*  1 - ALWAYS ROUND UP (UNCONVENTIONAL ROUNDING)                  05380000
039500******************************************************************05390000
039600     EXEC SQL                                                     05400000
039700         INCLUDE TSTATE                                           05410000
039800     END-EXEC.                                                    05420000
039900                                                                  05430000
040000******************************************************************05440000
040100*  VOID TRANSACTION TABLE.                                       *05450000
040200******************************************************************05460000
040300     EXEC SQL                                                     05470000
040400         INCLUDE TEPVDA                                           05480000
040500     END-EXEC.                                                    05490000
040600                                                                  05500000
040700******************************************************************05510000
040800*  DB2 AREA FOR COMMUNICATIONS                                    05520000
040900******************************************************************05530000
041000     EXEC SQL                                                     05540000
041100         INCLUDE SQLCA                                            05550000
041200     END-EXEC.                                                    05560000
041300                                                                  05570000
041400******************************************************************05580000
041500*  CURSOR TO CONTROL THE MAIN PROCESSING OF THE PROGRAM           05590000
041600******************************************************************05600000
041700     EXEC SQL                                                     05610000
041800         DECLARE POS-TRN-CSR CURSOR FOR                           05620000
041900             SELECT T.STR_NBR                                     05630052
042000                   ,T.RGST_ID                                     05640052
042100                   ,T.TRN_NBR                                     05650052
042200                   ,T.STRT_TM                                     05660052
042300                   ,T.SLS_CORR_SEQ_NBR                            05670052
042400                   ,T.TRN_TYP_CDE                                 05680052
042500                   ,T.TRN_STAT_CDE                                05690052
042600                   ,T.SLS_DTE                                     05700052
042700                   ,T.TRN_DTE                                     05710052
042800                   ,T.SLS_TX_AMT                                  05720052
042900                   ,T.VOID_ABRT_CDE                               05730052
043000                   ,T.POS_CPBL_LVL_NBR                            05740052
043100                   ,T.OMNI_CHNL_FFLMT_TYP_CDE                     05750052
043100                   ,NVL(T.POS_TYP_CDE,' ')                        05760052
043200             FROM TEPTRN T,                                       05770052
CHG344                  XST_LOC L                                       05771072
043300             WHERE T.PARTN_NBR        = :EPPART-PARTN-NBR         05780061
CHG344               AND L.LOC_NBR          = T.STR_NBR                 05781072
CHG344               AND T.VOID_ABRT_CDE    = 'N'                       05790072
043500               AND T.TRN_STAT_CDE     = 'Z'                       05800052
BOSS                AND (T.OMNI_CHNL_FFLMT_TYP_CDE NOT IN ('BPS', 'BOS')05801075
CHG344                   OR L.E_BUS_IND = 'Y')                          05802072
043600               AND T.TRN_TYP_CDE     IN (:PC-SALE                 05810052
043700                                      ,:PC-ASSOC-SALE             05820000
043800                                      ,:PC-RETURN                 05830000
043900                                      ,:PC-ASSOC-RETURN           05840000
044000                                      ,:PC-ASSOC-MIX-MODE         05850000
044100                                      ,:PC-MIX-MODE               05860000
044200                                      ,:PC-PRICE-ADJUSTMENT       05870000
044300                                      ,:PC-ASSOC-PRICE-ADJ        05880000
044400                                      )                           05890000
044500             ORDER BY T.STR_NBR                                   05900052
044600                     ,T.RGST_ID                                   05910052
044700                     ,T.TRN_NBR                                   05920052
044800                     ,T.STRT_TM                                   05930052
044900                     ,T.SLS_CORR_SEQ_NBR                          05940052
045000             WITH UR                                              05950000
045100     END-EXEC.                                                    05960000
045200                                                                  05970000
045300******************************************************************05980000
045400*  CURSOR TO CONTROL THE RETRIEVAL OF THE LATE AND CORRECTION     05990000
045500*  TRANSACTIONS                                                   06000000
045600******************************************************************06010000
045700     EXEC SQL                                                     06020000
045800         DECLARE LATE-COR-CSR CURSOR FOR                          06030000
045900             SELECT A.PARTN_NBR                                   06040000
046000                   ,A.STR_NBR                                     06050000
046100                   ,A.RGST_ID                                     06060000
046200                   ,A.TRN_NBR                                     06070000
046300                   ,A.STRT_TM                                     06080000
046400                   ,A.SLS_CORR_SEQ_NBR                            06090000
046500                   ,A.TRN_TYP_CDE                                 06100000
046600                   ,A.TRN_STAT_CDE                                06110000
046700                   ,A.SLS_DTE                                     06120000
046800                   ,A.TRN_DTE                                     06130000
046900                   ,A.SLS_TX_AMT                                  06140000
047000                   ,A.VOID_ABRT_CDE                               06150000
047100                   ,A.POS_CPBL_LVL_NBR                            06160000
047200                   ,A.OMNI_CHNL_FFLMT_TYP_CDE                     06170000
043100                   ,NVL(A.POS_TYP_CDE,' ')                        06180009
047300             FROM TEPTRN  A                                       06190000
047400                 ,TEPDKEY D                                       06200000
047500                 ,TEPPART F                                       06210000
CHG344                 ,XST_LOC L                                       06211072
047600            WHERE  A.PARTN_NBR        = F.PARTN_NBR               06220061
047700               AND D.PRCG_DTE         = :EPDKEY-PRCG-DTE          06230000
CHG344               AND L.LOC_NBR          = A.STR_NBR                 06231072
047800               AND D.SLS_DTE          = F.SLS_DTE                 06240000
047900               AND A.STR_NBR          = D.STR_NBR                 06250000
048000               AND A.RGST_ID          = D.RGST_ID                 06260000
048100               AND A.TRN_NBR          = D.TRN_NBR                 06270000
048200               AND A.STRT_TM          = D.STRT_TM                 06280000
048300               AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        06290000
048400               AND VOID_ABRT_CDE      = 'N'                       06300052
C74909               AND TRN_STAT_CDE      IN ('V', 'L')                06310052
BOSS                AND (A.OMNI_CHNL_FFLMT_TYP_CDE NOT IN ('BPS', 'BOS')06311075
CHG344                    OR L.E_BUS_IND = 'Y')                         06312072
048600               AND TRN_TYP_CDE       IN (:PC-SALE                 06320052
048700                                        ,:PC-ASSOC-SALE           06330000
048800                                        ,:PC-RETURN               06340000
048900                                        ,:PC-ASSOC-RETURN         06350000
049000                                        ,:PC-ASSOC-MIX-MODE       06360000
049100                                        ,:PC-MIX-MODE             06370000
049200                                        ,:PC-PRICE-ADJUSTMENT     06380000
049300                                        ,:PC-ASSOC-PRICE-ADJ      06390000
049400                                        )                         06400000
C74909             UNION ALL                                            06410000
C74909             SELECT A.PARTN_NBR                                   06420000
C74909                   ,A.STR_NBR                                     06430000
C74909                   ,A.RGST_ID                                     06440000
C74909                   ,A.TRN_NBR                                     06450000
C74909                   ,A.STRT_TM                                     06460000
C74909                   ,A.SLS_CORR_SEQ_NBR                            06470000
C74909                   ,A.TRN_TYP_CDE                                 06480000
C74909                   ,A.TRN_STAT_CDE                                06490000
C74909                   ,A.SLS_DTE                                     06500000
C74909                   ,A.TRN_DTE                                     06510000
C74909                   ,A.SLS_TX_AMT                                  06520000
C74909                   ,A.VOID_ABRT_CDE                               06530000
C74909                   ,A.POS_CPBL_LVL_NBR                            06540000
C74909                   ,A.OMNI_CHNL_FFLMT_TYP_CDE                     06550000
047200                   ,NVL(A.POS_TYP_CDE,' ')                        06560009
C74909             FROM TEPTRN  A                                       06570000
C74909                 ,TEPDKEY D                                       06580000
C74909                 ,TEPPART F                                       06590000
CHG344                 ,XST_LOC L                                       06591072
C74909            WHERE  A.PARTN_NBR        = F.PARTN_NBR               06600061
C74909               AND D.PRCG_DTE         = :EPDKEY-PRCG-DTE          06610000
CHG344               AND L.LOC_NBR          = A.STR_NBR                 06611072
C74909               AND D.SLS_DTE          = F.SLS_DTE                 06620000
C74909               AND A.STR_NBR          = D.STR_NBR                 06630000
C74909               AND A.RGST_ID          = D.RGST_ID                 06640000
C74909               AND A.TRN_NBR          = D.TRN_NBR                 06650000
C74909               AND A.STRT_TM          = D.STRT_TM                 06660000
C74909               AND A.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        06670000
C74909               AND VOID_ABRT_CDE      = 'N'                       06680000
C74909               AND TRN_STAT_CDE      =  'R'                       06690000
BOSS                AND (A.OMNI_CHNL_FFLMT_TYP_CDE NOT IN ('BPS', 'BOS')06691175
CHG344                    OR L.E_BUS_IND = 'Y')                         06692072
C74909               AND TRN_TYP_CDE       IN (:PC-SALE                 06700000
C74909                                        ,:PC-ASSOC-SALE           06710000
C74909                                        ,:PC-RETURN               06720000
C74909                                        ,:PC-ASSOC-RETURN         06730000
C74909                                        ,:PC-ASSOC-MIX-MODE       06740000
C74909                                        ,:PC-MIX-MODE             06750000
C74909                                        ,:PC-PRICE-ADJUSTMENT     06760000
C74909                                        ,:PC-ASSOC-PRICE-ADJ      06770000
C74909                                        )                         06780000
C74909             AND NOT EXISTS                                       06790000
C74909             (SELECT 1 FROM TEPTRN B                              06800000
C74909              WHERE  B.PARTN_NBR        = A.PARTN_NBR             06810061
C74909               AND B.SLS_DTE          = A.SLS_DTE                 06820000
C74909               AND B.PRCG_DTE          = A.PRCG_DTE               06830000
C74909               AND B.STR_NBR          = A.STR_NBR                 06840000
C74909               AND B.RGST_ID          = A.RGST_ID                 06850000
C74909               AND B.TRN_NBR          = A.TRN_NBR                 06860000
C74909               AND B.STRT_TM          = A.STRT_TM                 06870000
C74909               AND VOID_ABRT_CDE      = 'R'                       06880000
C74909               AND TRN_STAT_CDE      =  'V'                       06890000
C74909             )                                                    06900000
C74909             ORDER BY 2                                           06910000
C74909                     ,3                                           06920000
C74909                     ,4                                           06930000
C74909                     ,5                                           06940000
C74909                     ,6                                           06950000
050000             WITH UR                                              06960000
050100     END-EXEC.                                                    06970000
050200                                                                  06980000
050300******************************************************************06990000
050400* CURSOR TO CONTROL THE RETRIEVAL OF THE LATE VOID TRANSACTIONS. *07000000
050500******************************************************************07010000
050600     EXEC SQL                                                     07020000
050700         DECLARE LATE-VOID-CSR CURSOR FOR                         07030000
050800             SELECT D.PARTN_NBR                                   07040000
050900                   ,D.STR_NBR                                     07050000
051000                   ,D.RGST_ID                                     07060000
051100                   ,D.TRN_NBR                                     07070000
051200                   ,D.STRT_TM                                     07080000
051300                   ,D.SLS_CORR_SEQ_NBR                            07090000
051400                   ,D.TRN_TYP_CDE                                 07100000
051500                   ,D.TRN_STAT_CDE                                07110000
051600                   ,D.SLS_DTE                                     07120000
051700                   ,D.TRN_DTE                                     07130000
051800                   ,D.SLS_TX_AMT                                  07140000
051900                   ,D.VOID_ABRT_CDE                               07150000
052000                   ,D.POS_CPBL_LVL_NBR                            07160000
052100                   ,D.OMNI_CHNL_FFLMT_TYP_CDE                     07170000
052100                   ,NVL(D.POS_TYP_CDE,' ')                        07180009
052200             FROM TEPDKEY A                                       07190000
052300                 ,TEPPART B                                       07200000
052400                 ,TEPVDA  C                                       07210000
052500                 ,TEPTRN  D                                       07220000
052600             WHERE A.PRCG_DTE         = :EPDKEY-PRCG-DTE          07230062
052700               AND B.SLS_DTE          = A.SLS_DTE                 07240000
052800               AND C.PARTN_NBR        = B.PARTN_NBR               07250000
052900               AND C.STR_NBR          = A.STR_NBR                 07260000
053000               AND C.RGST_ID          = A.RGST_ID                 07270000
053100               AND C.TRN_NBR          = A.TRN_NBR                 07280000
053200               AND C.STRT_TM          = A.STRT_TM                 07290000
053300               AND C.SLS_CORR_SEQ_NBR = A.SLS_CORR_SEQ_NBR        07300000
053400               AND D.PARTN_NBR        = C.PARTN_NBR               07310000
053500               AND D.STR_NBR          = C.STR_NBR                 07320000
053600               AND D.RGST_ID          = C.RGST_ID                 07330000
053700               AND D.TRN_NBR          = C.VOID_TRN_NBR            07340000
053800               AND D.TRN_STAT_CDE     = 'Z'                       07350000
053900               AND D.TRN_TYP_CDE     IN (:PC-SALE                 07360000
054000                                        ,:PC-ASSOC-SALE           07370000
054100                                        ,:PC-RETURN               07380000
054200                                        ,:PC-ASSOC-RETURN         07390000
054300                                        ,:PC-ASSOC-MIX-MODE       07400000
054400                                        ,:PC-MIX-MODE             07410000
054500                                        ,:PC-PRICE-ADJUSTMENT     07420000
054600                                        ,:PC-ASSOC-PRICE-ADJ      07430000
054700                                        )                         07440000
054800             ORDER BY D.STR_NBR                                   07450000
054900                     ,D.RGST_ID                                   07460000
055000                     ,D.TRN_NBR                                   07470000
055100                     ,D.STRT_TM                                   07480000
055200                     ,D.SLS_CORR_SEQ_NBR                          07490000
055300             WITH UR                                              07500000
055400     END-EXEC.                                                    07510000
055500                                                                  07520000
055600******************************************************************07530000
055700*  CURSOR TO RETRIEVE ITEMS FOR E-COMM TRANSACTIONS               07540000
055800******************************************************************07550000
055900     EXEC SQL                                                     07560000
056000         DECLARE ITEMS-CSR CURSOR FOR                             07570000
056100             SELECT LNE_ITM_SEQ_NBR                               07580000
056200                   ,DEPT_NBR                                      07590000
056300                   ,SUB_CL_NBR                                    07600000
056400                   ,SLD_QTY                                       07610000
056500                   ,NET_CHRGD_AMT                                 07620000
056600                   ,UPC_NBR                                       07630000
056700                   ,SAL_RET_CDE                                   07640000
056800                   ,TXBL_IND                                      07650000
056900                   ,RCPT_TX_TOT_CDE                               07660000
057000                   ,TX_RT_PCT                                     07670000
057100                   ,TX_AMT                                        07680000
057200                   ,SKU_NBR                                       07690000
057300                   ,MAJ_CL_NBR                                    07700000
057400                   ,RCPT_SEQ_NBR                                  07710000
057500                   ,SBJCT_TO_TX_AMT                               07720000
STCFEE                   ,TX_PRD_CDE_DESC                               07730046
057600             FROM TEPITM                                          07740000
057700             WHERE PARTN_NBR        = :EPTRN-PARTN-NBR            07750061
057800               AND STR_NBR          = :EPTRN-STR-NBR              07760000
057900               AND RGST_ID          = :EPTRN-RGST-ID              07770000
058000               AND TRN_NBR          = :EPTRN-TRN-NBR              07780000
058100               AND STRT_TM          = :EPTRN-STRT-TM              07790000
058200               AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR     07800000
058300               AND LIV_RSLU_CDE    IN ('+', '-')                  07810000
C92405               AND NOT (DEPT_NBR = '070' AND                      07820000
C92405                        SUB_CL_NBR = '91')                        07830000
058400             ORDER BY RCPT_TX_TOT_CDE                             07840000
058500                     ,LNE_ITM_SEQ_NBR                             07850000
058600             WITH UR                                              07860000
058700     END-EXEC.                                                    07870000
058800                                                                  07880000
063500******************************************************************08360069
063600* CURSOR TO RETREIVE ZIP CODE AND GEO CODE FOR A LINE ITEM       *08370000
063700* USING THE ITEM NUMBER ON A RETURNED ITEM.  THIS IS REQUIRED    *08380000
063800* FOR EMPLOYEE RETURN TRANSACTIONS.                              *08390000
063900******************************************************************08400000
064000     EXEC SQL                                                     08410000
064100         DECLARE TEPITM-CSR CURSOR FOR                            08420000
064200             SELECT A.TRN_DTE                                     08430000
064300                   ,B.TX_RT_PCT                                   08440000
064400                   ,B.TX_AMT                                      08450000
064500                   ,B.SKU_NBR                                     08460000
064600                   ,D.ZIP_5_CDE                                   08470000
064700                   ,D.TX_GEOG_CDE                                 08480000
064800             FROM TEPTRN  A                                       08490000
064900                 ,TEPITM  B                                       08500000
065000                 ,TEPIPS  C                                       08510000
065100                 ,TEPSHP  D                                       08520000
065200             WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR        08530061
065300               AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR       08540000
065400               AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID       08550000
065500               AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR       08560000
065600               AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM       08570000
065700               AND B.UPC_NBR          = :EPITM-UPC-NBR            08580000
065800               AND B.LIV_RSLU_CDE    IN ('+', '-')                08590000
065900               AND A.PARTN_NBR        = B.PARTN_NBR               08600000
066000               AND A.STR_NBR          = B.STR_NBR                 08610000
066100               AND A.RGST_ID          = B.RGST_ID                 08620000
066200               AND A.TRN_NBR          = B.TRN_NBR                 08630000
066300               AND A.STRT_TM          = B.STRT_TM                 08640000
066400               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        08650000
066500               AND B.PARTN_NBR        = C.PARTN_NBR               08660000
066600               AND B.STR_NBR          = C.STR_NBR                 08670000
066700               AND B.RGST_ID          = C.RGST_ID                 08680000
066800               AND B.TRN_NBR          = C.TRN_NBR                 08690000
066900               AND B.STRT_TM          = C.STRT_TM                 08700000
067000               AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR        08710000
067100               AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR         08720000
067200               AND C.PARTN_NBR        = D.PARTN_NBR               08730000
067300               AND C.STR_NBR          = D.STR_NBR                 08740000
067400               AND C.RGST_ID          = D.RGST_ID                 08750000
067500               AND C.TRN_NBR          = D.TRN_NBR                 08760000
067600               AND C.STRT_TM          = D.STRT_TM                 08770000
067700               AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        08780000
067800               AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR          08790000
067900             WITH UR                                              08800000
068000     END-EXEC.                                                    08810000
TMPFIX******************************************************************08820000
TMPFIX* CURSOR TO RETREIVE ZIP CODE AND GEO CODE FOR A LINE ITEM       *08830000
TMPFIX* USING THE ITEM NUMBER ON A RETURNED ITEM.  THIS IS REQUIRED    *08840000
TMPFIX* FOR EMPLOYEE RETURN TRANSACTIONS.                              *08850000
TMPFIX******************************************************************08860000
TMPFIX     EXEC SQL                                                     08870000
TMPFIX         DECLARE TEPITM-MISS-CSR CURSOR FOR                       08880000
TMPFIX             SELECT A.TRN_DTE                                     08890000
TMPFIX                   ,B.TX_RT_PCT                                   08900000
TMPFIX                   ,B.TX_AMT                                      08910000
TMPFIX                   ,B.SKU_NBR                                     08920000
TMPFIX                   ,D.ZIP_5_CDE                                   08930000
TMPFIX                   ,D.TX_GEOG_CDE                                 08940000
TMPFIX             FROM TEPTRN  A                                       08950000
TMPFIX                 ,TEPITM  B                                       08960000
TMPFIX                 ,TEPSHP  D                                       08970000
TMPFIX             WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR        08980061
TMPFIX               AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR       08990000
TMPFIX               AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID       09000000
TMPFIX               AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR       09010000
TMPFIX*              AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM       09020000
TMPFIX*              AND B.UPC_NBR          = :EPITM-UPC-NBR            09030000
TMPFIX               AND B.LIV_RSLU_CDE    IN ('+', '-')                09040000
TMPFIX               AND A.PARTN_NBR        = B.PARTN_NBR               09050000
TMPFIX               AND A.STR_NBR          = B.STR_NBR                 09060000
TMPFIX               AND A.RGST_ID          = B.RGST_ID                 09070000
TMPFIX               AND A.TRN_NBR          = B.TRN_NBR                 09080000
TMPFIX               AND A.STRT_TM          = B.STRT_TM                 09090000
TMPFIX               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        09100000
TMPFIX               AND B.PARTN_NBR        = D.PARTN_NBR               09110000
TMPFIX               AND B.STR_NBR          = D.STR_NBR                 09120000
TMPFIX               AND B.RGST_ID          = D.RGST_ID                 09130000
TMPFIX               AND B.TRN_NBR          = D.TRN_NBR                 09140000
TMPFIX               AND B.STRT_TM          = D.STRT_TM                 09150000
TMPFIX               AND B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        09160000
TMPFIX             WITH UR                                              09170000
TMPFIX     END-EXEC.                                                    09180000
068100                                                                  09190000
073300******************************************************************09200000
073400*  CURSOR TO RETRIEVE SPECIAL SERVICE FEES FOR THE TRANSACTION.   09210000
073500******************************************************************09220000
073600     EXEC SQL                                                     09230000
073700         DECLARE SSFEES-CSR CURSOR FOR                            09240000
073800            SELECT A.LNE_ITM_SEQ_NBR                              09250010
073900                  ,A.SRVC_SEQ_NBR                                 09260010
074000                  ,A.SRVC_TYP_CDE                                 09270010
074100                  ,A.SRVC_AMT                                     09280010
074200                  ,A.TX_RT_PCT                                    09290010
074300                  ,A.TX_AMT                                       09300010
074400              FROM TEPLIS A                                       09310010
STCFEE                 , TEPITM B                                       09320010
074500             WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR          09330061
074600               AND A.STR_NBR          = :EPTRN-STR-NBR            09340010
074700               AND A.RGST_ID          = :EPTRN-RGST-ID            09350010
074800               AND A.TRN_NBR          = :EPTRN-TRN-NBR            09360010
074900               AND A.STRT_TM          = :EPTRN-STRT-TM            09370010
075000               AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR   09380010
STCFEE               AND A.PARTN_NBR        = B.PARTN_NBR               09390010
STCFEE               AND A.STR_NBR          = B.STR_NBR                 09400010
STCFEE               AND A.RGST_ID          = B.RGST_ID                 09410010
STCFEE               AND A.TRN_NBR          = B.TRN_NBR                 09420010
STCFEE               AND A.STRT_TM          = B.STRT_TM                 09430010
STCFEE               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        09440010
STCFEE               AND A.LNE_ITM_SEQ_NBR  = B.LNE_ITM_SEQ_NBR         09450010
STCFEE               AND A.SRVC_TYP_CDE    <> 'F'                       09460010
STCFEE               AND B.LIV_RSLU_CDE    IN ('+', '-')                09470010
075100             ORDER BY LNE_ITM_SEQ_NBR                             09480010
037400             WITH UR                                              09490010
075300     END-EXEC.                                                    09500000
075400                                                                  09510000
STCFEE                                                                  09520014
075500******************************************************************09850013
075600*  CURSOR TO RETRIEVE SHIPPING INFORMATION TRANSACTION.           09860000
C92405*  ADDED TEPITM AND TEPIPS TO CURSOR. THIS WAS NEEDED TO BYPASS   09870000
C92405*  WAYFAIR ITEMS.                                                 09880000
075700******************************************************************09890000
075800     EXEC SQL                                                     09900000
075900         DECLARE SHIP-CSR CURSOR FOR                              09910000
C19114             SELECT SHIP_TYP_CDE                                  09920004
C19114                   ,SHIP_CHRG_AMT                                 09930004
C19114                   ,ZIP_5_CDE                                     09940004
C19114                   ,TX_RT_PCT                                     09950004
C19114                   ,TX_AMT                                        09960004
C19114                   ,TX_GEOG_CDE                                   09970004
C19114             FROM TEPSHP                                          09980004
C19114             WHERE PARTN_NBR   =:PV-SHP-PARTN-NBR                 09990061
C19114              AND STR_NBR          =:PV-SHP-STR-NBR               10000004
C19114              AND RGST_ID          =:PV-SHP-RGST-ID               10010004
C19114              AND TRN_NBR          =:PV-SHP-TRN-NBR               10020004
C19114              AND STRT_TM          =:PV-SHP-STRT-TM               10030004
C19114              AND SLS_CORR_SEQ_NBR =:EPTRN-SLS-CORR-SEQ-NBR       10040004
C19114              AND SHIP_CHRG_AMT   ^= 0                            10050004
C19114              AND PLND_SHIPT_NBR NOT IN                           10060004
C19114            ( SELECT 1 FROM TEPIPS IPS,                           10070004
C19114                            TEPITM ITM                            10080004
C19114             WHERE IPS.PARTN_NBR        =:PV-SHP-PARTN-NBR        10090004
C19114              AND IPS.STR_NBR          =:PV-SHP-STR-NBR           10100004
C19114              AND IPS.RGST_ID          =:PV-SHP-RGST-ID           10110004
C19114              AND IPS.TRN_NBR          =:PV-SHP-TRN-NBR           10120004
C19114              AND IPS.STRT_TM          =:PV-SHP-STRT-TM           10130004
C19114              AND IPS.SLS_CORR_SEQ_NBR =:EPTRN-SLS-CORR-SEQ-NBR   10140004
C19114              AND IPS.PARTN_NBR      = ITM.PARTN_NBR              10150004
C19114              AND IPS.STR_NBR        = ITM.STR_NBR                10160004
C19114              AND IPS.RGST_ID        = ITM.RGST_ID                10170004
C19114              AND IPS.TRN_NBR        = ITM.TRN_NBR                10180004
C19114              AND IPS.STRT_TM        = ITM.STRT_TM                10190004
C19114              AND IPS.SLS_CORR_SEQ_NBR = ITM.SLS_CORR_SEQ_NBR     10200004
C19114              AND IPS.LNE_ITM_SEQ_NBR = ITM.LNE_ITM_SEQ_NBR       10210004
C19114              AND  (DEPT_NBR = '070' AND                          10220004
C19114                       SUB_CL_NBR = '91'))                        10230004
C19114       ORDER BY PLND_SHIPT_NBR                                    10240004
C19114   WITH UR                                                        10250004
077600     END-EXEC.                                                    10260000
077700                                                                  10270000
077800******************************************************************10280000
077900 PROCEDURE DIVISION.                                              10290000
078000******************************************************************10300000
078100 0000-MAINLINE.                                                   10310000
078200                                                                  10320000
078300     PERFORM 1000-INITIALIZE.                                     10330000
078400                                                                  10340000
078500     PERFORM 2000-PROCESS-DATA.                                   10350000
078600                                                                  10360000
078700     PERFORM 9000-EOJ-ROUTINE.                                    10370000
078800                                                                  10380000
078900     GOBACK.                                                      10390000
079000                                                                  10400000
079100******************************************************************10410000
079200* OPEN ALL FILES.                                                *10420000
079300* GET THE DATE CONTROL CARD.                                     *10430000
079400* CONVERT THE DATE ON THE CONTROL CARD TO DB2 DATE FORMAT.       *10440000
079500* GET INTERNAL UPC FOR SPECIAL SERVICE ITEMS.                    *10450000
079600* FIND THE COSA PARTITION NUMBER FOR THE PROCESSING DATE.        *10460000
079700******************************************************************10470000
079800 1000-INITIALIZE.                                                 10480000
079900                                                                  10490000
080000     PERFORM 1100-OPEN-FILES.                                     10500000
080100                                                                  10510000
080200     INITIALIZE TX006-TAX-AUDIT-RECORD                            10520000
P10237                PV-ZIP-CODE-TABLE                                 10530000
080300                EC-ECOM-STORE-TABLE.                              10540000
080400                                                                  10550000
P10237     MOVE PC-CURRENT-PROGRAM-NAME TO DP031-PROGRAM-NAME.          10560000
P10237                                                                  10570000
080500     SET EC-IDX2 TO 1.                                            10580000
P10237     SET ZP-IDX2 TO 1.                                            10590000
080600                                                                  10600000
080700     PERFORM 1200-READ-DATE-CC-CARD.                              10610000
080800                                                                  10620000
080900     PERFORM 1300-CONVERT-INPUT-DATE.                             10630000
081000     MOVE PV-POS-CCYY-MM-DD        TO EPPART-SLS-DTE.             10640000
081100                                                                  10650000
081200     PERFORM 1500-SELECT-PARTITION-NUMBER.                        10660000
081300                                                                  10670000
081400******************************************************************10680000
081500* OPEN THE CONTROL CARD FILE AS INPUT.                           *10690000
081600* OPEN THE EXTRACT FILE AS OUTPUT.                               *10700000
081700******************************************************************10710000
081800 1100-OPEN-FILES.                                                 10720000
081900                                                                  10730000
082000     OPEN INPUT  POS-DATE-CARD-FILE                               10740000
082100          OUTPUT TAX-EXTRACT-FILE.                                10750000
082200                                                                  10760000
082300******************************************************************10770000
082400* READ THE DATE CONTROL CARD AND CLOSE THE FILE.                 *10780000
082500* IF THE DATE CONTROL CARD WAS NOT FOUND, ABEND THE PROGRAM.     *10790000
082600******************************************************************10800000
082700 1200-READ-DATE-CC-CARD.                                          10810000
082800                                                                  10820000
082900     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 10830000
083000        AT END                                                    10840000
083100           SET PS-END-OF-CARD-FILE-YES TO TRUE.                   10850000
083200                                                                  10860000
083300     DISPLAY 'TXKUT005 CONTROL CARD: ' CC-CONTROL-CARD.           10870000
083400                                                                  10880000
083500     CLOSE POS-DATE-CARD-FILE.                                    10890000
083600                                                                  10900000
083700     IF PS-END-OF-CARD-FILE-YES                                   10910000
083800        DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME            10920000
083900        DISPLAY 'DATE CONTROL CARD EMPTY'                         10930000
084000        SET AC-CONTROL-CARD-ERROR TO TRUE                         10940000
084100        CALL 'ILBOABN0' USING AC-ABEND-CODE                       10950000
084200     END-IF.                                                      10960000
084300                                                                  10970000
084400******************************************************************10980000
084500*     CALL KOHLS CALENDAR ROUTINE:                                10990000
084600*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            11000000
084700*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 11010000
084800******************************************************************11020000
084900 1300-CONVERT-INPUT-DATE.                                         11030000
085000                                                                  11040000
085100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              11050000
085200                                                                  11060000
085300     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   11070000
085400     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   11080000
085500     SET  DPG52-LK-DTE-GREG            TO TRUE.                   11090000
085600     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    11100000
085700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    11110000
085800                                             DPG54 DPG55 DPG56.   11120000
085900     IF DPG54-SEVERE-ERROR                                        11130000
086000            DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME        11140000
086100            DISPLAY 'DATE CONTROL CARD INVALID'                   11150000
086200            SET AC-CONTROL-CARD-ERROR TO TRUE                     11160000
086300            CALL 'ILBOABN0' USING AC-ABEND-CODE                   11170000
086400     END-IF.                                                      11180000
086500                                                                  11190000
086600     DISPLAY 'EXECUTION DATE USED = ' DPG55-DB2-ISO-DATE-FMT.     11200000
086700                                                                  11210000
086800     MOVE DPG55-DB2-ISO-DATE-FMT       TO PV-POS-CCYY-MM-DD       11220000
086900                                          EPDKEY-PRCG-DTE.        11230000
087000                                                                  11240000
087100******************************************************************11250000
087200*  SELECT THE PARTITON NUMBER FOR THE POS CURSOR                  11260000
087300******************************************************************11270000
087400 1500-SELECT-PARTITION-NUMBER.                                    11280000
087500                                                                  11290000
087600     EXEC SQL                                                     11300000
087700         SELECT  PARTN_NBR                                        11310000
087800         INTO   :EPPART-PARTN-NBR                                 11320000
087900         FROM    TEPPART                                          11330000
088000         WHERE   SLS_DTE           = :EPPART-SLS-DTE              11340000
088200           AND STR_GP_CDE = 'A'                                   11350000
088300         WITH UR                                                  11360000
088400     END-EXEC.                                                    11370000
088500                                                                  11380000
088600     EVALUATE SQLCODE                                             11390000
088700         WHEN ZERO                                                11400000
088800             MOVE EPPART-PARTN-NBR TO EPTRN-PARTN-NBR             11410000
088900         WHEN OTHER                                               11420000
089000             DISPLAY EPPART-SLS-DTE                               11430000
089100             MOVE '1500-SELECT-PARTITION-NUMBER'                  11440000
089200                                   TO PV-PARAGRAPH-NAME           11450000
089300             MOVE 'ERROR ON GETTING PARTITION NUMBER '            11460000
089400                                   TO PV-DB2-OPERATION            11470000
089500             PERFORM 9200-SQL-ABEND                               11480000
089600     END-EVALUATE.                                                11490000
089700                                                                  11500000
089800******************************************************************11510000
089900*  CONTROL THE PROCESSING OF THE CURSORS THAT WILL DRIVE THE     *11520000
090000*  PROGRAM                                                       *11530000
090100******************************************************************11540000
090200 2000-PROCESS-DATA.                                               11550000
090300                                                                  11560000
090400*** GET THE LATE VOID TRANSACTIONS.                               11570000
090500                                                                  11580000
090600     PERFORM 2700-OPEN-LATE-VOID-CURSOR.                          11590000
090700     PERFORM 2800-FETCH-LATE-VOID-CURSOR.                         11600000
C76279     PERFORM 2950-DETERMINE-TRAN-TYPE.                            11610000
091300                                                                  11620000
091400     IF PS-NOT-END-OF-LATE-VOID-CURSOR                            11630000
091500         MOVE EPTRN-STR-NBR        TO PV-SAVE-STR-NBR             11640000
091600                                      PV-WORK-STR-NBR             11650000
091700         PERFORM 8100-SEARCH-FOR-STORE-INFO                       11660000
091800         IF PS-END-OF-ECOM-TABLE                                  11670000
091900             PERFORM 8200-GET-STORE-INFO                          11680000
092000         END-IF                                                   11690000
092100         IF PV-BUS-LOC-IND = 'Y'                                  11700000
092200            OR (PV-BUS-LOC-IND = 'N'                              11710000
092300                AND PS-OMNI-CHNL-IS-NOT-NULL)                     11720000
092300            OR EPTRN-POS-TYP-CDE = '001'                          11730005
092310             SET PS-ECOMMERCE-STORE     TO TRUE                   11740000
092320         ELSE                                                     11750000
092330             SET PS-NOT-ECOMMERCE-STORE TO TRUE                   11760000
092340         END-IF                                                   11770000
092350     END-IF.                                                      11780000
092360                                                                  11790000
092370     PERFORM UNTIL PS-END-OF-LATE-VOID-CURSOR                     11800000
092380         PERFORM 3000-PROCESS-TRANSACTION                         11810000
092390         THRU    3000-PROCESS-TRANSACTION-EXIT                    11820000
092400         PERFORM 2800-FETCH-LATE-VOID-CURSOR                      11830000
C76279         PERFORM 2950-DETERMINE-TRAN-TYPE                         11840000
093000     END-PERFORM.                                                 11850000
093100                                                                  11860000
093200     PERFORM 2900-CLOSE-LATE-VOID-CURSOR.                         11870000
093300                                                                  11880000
093400*** GET THE LATE TRANSACTIONS AND SALES CORRECTIONS               11890000
093500                                                                  11900000
093600     PERFORM 2100-OPEN-LATE-COR-CURSOR.                           11910000
093700     PERFORM 2200-FETCH-LATE-COR-CURSOR.                          11920000
C76279     PERFORM 2950-DETERMINE-TRAN-TYPE.                            11930000
094120                                                                  11940000
094130     IF PS-NOT-END-OF-LATE-COR-CURSOR                             11950000
094140         MOVE EPTRN-STR-NBR        TO PV-SAVE-STR-NBR             11960000
094150                                      PV-WORK-STR-NBR             11970000
094160         PERFORM 8100-SEARCH-FOR-STORE-INFO                       11980000
094170         IF PS-END-OF-ECOM-TABLE                                  11990000
094180             PERFORM 8200-GET-STORE-INFO                          12000000
094190         END-IF                                                   12010000
094200         IF PV-BUS-LOC-IND = 'Y'                                  12020000
094300            OR (PV-BUS-LOC-IND = 'N'                              12030000
094400                AND PS-OMNI-CHNL-IS-NOT-NULL)                     12040000
092300            OR EPTRN-POS-TYP-CDE = '001'                          12050005
094500             SET PS-ECOMMERCE-STORE     TO TRUE                   12060000
094600         ELSE                                                     12070000
094700             SET PS-NOT-ECOMMERCE-STORE TO TRUE                   12080000
094800         END-IF                                                   12090000
094900     END-IF.                                                      12100000
095000                                                                  12110000
095100     PERFORM UNTIL PS-END-OF-LATE-COR-CURSOR                      12120000
095200         PERFORM 3000-PROCESS-TRANSACTION                         12130000
095300         THRU    3000-PROCESS-TRANSACTION-EXIT                    12140000
095400         PERFORM 2200-FETCH-LATE-COR-CURSOR                       12150000
C76279         PERFORM 2950-DETERMINE-TRAN-TYPE                         12160000
096000     END-PERFORM.                                                 12170000
096010     PERFORM 2300-CLOSE-LATE-COR-CURSOR.                          12180000
096020                                                                  12190000
096030     MOVE EPPART-PARTN-NBR TO EPTRN-PARTN-NBR.                    12200000
096040                                                                  12210000
096050*** GET TODAYS TRANSACTIONS                                       12220000
096060                                                                  12230000
096070     PERFORM 2400-OPEN-POS-TRAN-CURSOR.                           12240000
096080     PERFORM 2500-FETCH-POS-TRANS-CURSOR.                         12250000
C76279     PERFORM 2950-DETERMINE-TRAN-TYPE.                            12260000
096500                                                                  12270000
096600     IF PS-NOT-END-OF-POS-TRAN-CURSOR                             12280000
096700         MOVE EPTRN-STR-NBR        TO PV-SAVE-STR-NBR             12290000
096800                                      PV-WORK-STR-NBR             12300000
096900         PERFORM 8100-SEARCH-FOR-STORE-INFO                       12310000
097000         IF PS-END-OF-ECOM-TABLE                                  12320000
097100             PERFORM 8200-GET-STORE-INFO                          12330000
097200         END-IF                                                   12340000
097300         IF PV-BUS-LOC-IND = 'Y'                                  12350000
097400            OR (PV-BUS-LOC-IND = 'N'                              12360000
097500                AND PS-OMNI-CHNL-IS-NOT-NULL)                     12370000
092300            OR EPTRN-POS-TYP-CDE = '001'                          12380005
097510                                                                  12390000
097600             SET PS-ECOMMERCE-STORE     TO TRUE                   12400000
097700         ELSE                                                     12410000
097800             SET PS-NOT-ECOMMERCE-STORE TO TRUE                   12420000
097900         END-IF                                                   12430000
098000     END-IF.                                                      12440000
098100                                                                  12450000
098200     PERFORM UNTIL PS-END-OF-POS-TRAN-CURSOR                      12460000
098300         PERFORM 3000-PROCESS-TRANSACTION                         12470000
098400         THRU    3000-PROCESS-TRANSACTION-EXIT                    12480000
098500         PERFORM 2500-FETCH-POS-TRANS-CURSOR                      12490000
C76279         PERFORM 2950-DETERMINE-TRAN-TYPE                         12500000
098803     END-PERFORM.                                                 12510000
098804     PERFORM 2600-CLOSE-POS-TRAN-CURSOR.                          12520000
098805                                                                  12530000
098806***************************************************************** 12540000
098807*  OPEN THE LATE / CORRECTIONS CURSOR                             12550000
098808***************************************************************** 12560000
098809 2100-OPEN-LATE-COR-CURSOR.                                       12570000
098810                                                                  12580000
098820     EXEC SQL                                                     12590000
098830         OPEN LATE-COR-CSR                                        12600000
098840     END-EXEC.                                                    12610000
098850                                                                  12620000
098860     EVALUATE SQLCODE                                             12630000
098870         WHEN ZERO                                                12640000
098880             CONTINUE                                             12650000
098890         WHEN OTHER                                               12660000
098900             MOVE '2100-OPEN-LATE-COR-CURSOR'                     12670000
099000                                             TO PV-PARAGRAPH-NAME 12680000
099100             MOVE 'ERROR ON OPENING LATE COR CURSOR '             12690000
099200                                            TO PV-DB2-OPERATION   12700000
099300             PERFORM 9200-SQL-ABEND                               12710000
099400     END-EVALUATE.                                                12720000
099500                                                                  12730000
099600******************************************************************12740000
099700*  FETCH THE LATE AND SALES CORRECTION CURSOR                     12750000
099800******************************************************************12760000
099900 2200-FETCH-LATE-COR-CURSOR.                                      12770000
100000                                                                  12780000
100100     MOVE 0 TO PS-NULL-IND6.                                      12790000
100200     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                12800000
100300                                                                  12810000
100400     EXEC SQL                                                     12820000
100500         FETCH LATE-COR-CSR                                       12830000
100600         INTO  :EPTRN-PARTN-NBR                                   12840000
100700              ,:EPTRN-STR-NBR                                     12850000
100800              ,:EPTRN-RGST-ID                                     12860000
100900              ,:EPTRN-TRN-NBR                                     12870000
101000              ,:EPTRN-STRT-TM                                     12880000
101100              ,:EPTRN-SLS-CORR-SEQ-NBR                            12890000
101200              ,:EPTRN-TRN-TYP-CDE                                 12900000
101300              ,:EPTRN-TRN-STAT-CDE                                12910000
101400              ,:EPTRN-SLS-DTE                                     12920000
101500              ,:EPTRN-TRN-DTE                                     12930000
101600              ,:EPTRN-SLS-TX-AMT                                  12940000
101700              ,:EPTRN-VOID-ABRT-CDE                               12950000
101800              ,:EPTRN-POS-CPBL-LVL-NBR                            12960000
101900              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6       12970000
101900              ,:EPTRN-POS-TYP-CDE                                 12980008
102000     END-EXEC.                                                    12990000
102300                                                                  13000000
102400     EVALUATE SQLCODE                                             13010000
102500         WHEN ZERO                                                13020000
102600             ADD +1 TO PV-LATE-COR-ROWS-FETCHED                   13030000
102700         WHEN +100                                                13040000
102800             SET PS-END-OF-LATE-COR-CURSOR  TO TRUE               13050000
102900         WHEN OTHER                                               13060000
103000             MOVE '2200-FETCH-LATE-COR-CURSOR'                    13070000
103100                                            TO PV-PARAGRAPH-NAME  13080000
103200             MOVE 'ERROR ON FETCHING LATE COR CURSOR '            13090000
103300                                            TO PV-DB2-OPERATION   13100000
103400             PERFORM 9200-SQL-ABEND                               13110000
103500     END-EVALUATE.                                                13120000
103600                                                                  13130000
103700***************************************************************** 13140000
103800*  CLOSE THE LATE COR CURSOR                                      13150000
103900***************************************************************** 13160000
104000 2300-CLOSE-LATE-COR-CURSOR.                                      13170000
104100                                                                  13180000
104200     EXEC SQL                                                     13190000
104300         CLOSE LATE-COR-CSR                                       13200000
104400     END-EXEC.                                                    13210000
104500                                                                  13220000
104600     EVALUATE SQLCODE                                             13230000
104700         WHEN ZERO                                                13240000
104800             CONTINUE                                             13250000
104900         WHEN OTHER                                               13260000
105000             MOVE '2300-CLOSE-LATE-COR-CURSOR'                    13270000
105100                                            TO PV-PARAGRAPH-NAME  13280000
105200             MOVE 'ERROR ON CLOSING LATE COR CURSOR '             13290000
105300                                            TO PV-DB2-OPERATION   13300000
105400             PERFORM 9200-SQL-ABEND                               13310000
105500     END-EVALUATE.                                                13320000
105600                                                                  13330000
105700***************************************************************** 13340000
105800*  OPEN THE POS TRANSACTION CURSOR                                13350000
105900***************************************************************** 13360000
106000 2400-OPEN-POS-TRAN-CURSOR.                                       13370000
106100                                                                  13380000
106200     EXEC SQL                                                     13390000
106300         OPEN POS-TRN-CSR                                         13400000
106400     END-EXEC.                                                    13410000
106500                                                                  13420000
106600     EVALUATE SQLCODE                                             13430000
106700         WHEN ZERO                                                13440000
106800             CONTINUE                                             13450000
106900         WHEN OTHER                                               13460000
107000             MOVE '2400-OPEN-POS-TRAN-CURSOR'                     13470000
107100                                            TO PV-PARAGRAPH-NAME  13480000
107200             MOVE 'ERROR ON OPENING POS TRANS CURSOR '            13490000
107300                                            TO PV-DB2-OPERATION   13500000
107400             PERFORM 9200-SQL-ABEND                               13510000
107500     END-EVALUATE.                                                13520000
107600                                                                  13530000
107700******************************************************************13540000
107800*  FETCH THE ORIGINAL POS CURSOR                                 *13550000
107900******************************************************************13560000
108000 2500-FETCH-POS-TRANS-CURSOR.                                     13570000
108100                                                                  13580000
108200     MOVE 0 TO PS-NULL-IND6.                                      13590000
108300     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                13600000
108400                                                                  13610000
108500     EXEC SQL                                                     13620000
108600         FETCH POS-TRN-CSR                                        13630000
108700         INTO  :EPTRN-STR-NBR                                     13640000
108800              ,:EPTRN-RGST-ID                                     13650000
108900              ,:EPTRN-TRN-NBR                                     13660000
109000              ,:EPTRN-STRT-TM                                     13670000
109100              ,:EPTRN-SLS-CORR-SEQ-NBR                            13680000
109200              ,:EPTRN-TRN-TYP-CDE                                 13690000
109300              ,:EPTRN-TRN-STAT-CDE                                13700000
109400              ,:EPTRN-SLS-DTE                                     13710000
109500              ,:EPTRN-TRN-DTE                                     13720000
109600              ,:EPTRN-SLS-TX-AMT                                  13730000
109700              ,:EPTRN-VOID-ABRT-CDE                               13740000
109800              ,:EPTRN-POS-CPBL-LVL-NBR                            13750000
109900              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6       13760000
109900              ,:EPTRN-POS-TYP-CDE                                 13770005
110000     END-EXEC.                                                    13780000
110300                                                                  13790000
110400     EVALUATE SQLCODE                                             13800000
110500         WHEN ZERO                                                13810000
110600             CONTINUE                                             13820000
110700         WHEN +100                                                13830000
110800             SET PS-END-OF-POS-TRAN-CURSOR  TO TRUE               13840000
110900         WHEN OTHER                                               13850000
111000             MOVE '2500-FETCH-POS-TRANS-CURSOR'                   13860000
111100                                            TO PV-PARAGRAPH-NAME  13870000
111200             MOVE 'ERROR ON FETCHING POS TRANS INFO '             13880000
111300                                            TO PV-DB2-OPERATION   13890000
111400             PERFORM 9200-SQL-ABEND                               13900000
111500     END-EVALUATE.                                                13910000
111600                                                                  13920000
111700***************************************************************** 13930000
111800*  CLOSE THE POS TRANSACTION CURSOR                               13940000
111900***************************************************************** 13950000
112000 2600-CLOSE-POS-TRAN-CURSOR.                                      13960000
112100                                                                  13970000
112200     EXEC SQL                                                     13980000
112300         CLOSE POS-TRN-CSR                                        13990000
112400     END-EXEC.                                                    14000000
112500                                                                  14010000
112600     EVALUATE SQLCODE                                             14020000
112700         WHEN ZERO                                                14030000
112800             CONTINUE                                             14040000
112900         WHEN OTHER                                               14050000
113000             MOVE '2600-CLOSE-POS-TRAN-CURSOR'                    14060000
113100                                            TO PV-PARAGRAPH-NAME  14070000
113200             MOVE 'ERROR ON CLOSING POS TRANS CURSOR '            14080000
113300                                            TO PV-DB2-OPERATION   14090000
113400             PERFORM 9200-SQL-ABEND                               14100000
113500     END-EVALUATE.                                                14110000
113600                                                                  14120000
113700***************************************************************** 14130000
113800*  OPEN THE LATE VOID CURSOR.                                     14140000
113900***************************************************************** 14150000
114000 2700-OPEN-LATE-VOID-CURSOR.                                      14160000
114100                                                                  14170000
114200     EXEC SQL                                                     14180000
114300         OPEN LATE-VOID-CSR                                       14190000
114400     END-EXEC.                                                    14200000
114500                                                                  14210000
114600     EVALUATE SQLCODE                                             14220000
114700         WHEN ZERO                                                14230000
114800             CONTINUE                                             14240000
114900         WHEN OTHER                                               14250000
115000             MOVE '2700-OPEN-LATE-VOID-CURSOR'                    14260000
115100                                            TO PV-PARAGRAPH-NAME  14270000
115200             MOVE 'ERROR ON OPENING LATE VOID CURSOR '            14280000
115300                                            TO PV-DB2-OPERATION   14290000
115400             PERFORM 9200-SQL-ABEND                               14300000
115500     END-EVALUATE.                                                14310000
115600                                                                  14320000
115700******************************************************************14330000
115800*  FETCH THE ORIGINAL POS CURSOR                                 *14340000
115900******************************************************************14350000
116000 2800-FETCH-LATE-VOID-CURSOR.                                     14360000
116100                                                                  14370000
116200     MOVE 0 TO PS-NULL-IND6.                                      14380000
116300     MOVE SPACES TO EPTRN-OMNI-CHNL-FFLMT-TYP-CDE.                14390000
116400                                                                  14400000
116410     EXEC SQL                                                     14410000
116420         FETCH LATE-VOID-CSR                                      14420000
116430         INTO  :EPTRN-PARTN-NBR                                   14430000
116440              ,:EPTRN-STR-NBR                                     14440000
116450              ,:EPTRN-RGST-ID                                     14450000
116460              ,:EPTRN-TRN-NBR                                     14460000
116470              ,:EPTRN-STRT-TM                                     14470000
116480              ,:EPTRN-SLS-CORR-SEQ-NBR                            14480000
116490              ,:EPTRN-TRN-TYP-CDE                                 14490000
116500              ,:EPTRN-TRN-STAT-CDE                                14500000
116600              ,:EPTRN-SLS-DTE                                     14510000
116700              ,:EPTRN-TRN-DTE                                     14520000
116800              ,:EPTRN-SLS-TX-AMT                                  14530000
116900              ,:EPTRN-VOID-ABRT-CDE                               14540000
117000              ,:EPTRN-POS-CPBL-LVL-NBR                            14550000
117100              ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE :PS-NULL-IND6       14560000
117100              ,:EPTRN-POS-TYP-CDE                                 14570005
117200     END-EXEC.                                                    14580000
117600     EVALUATE SQLCODE                                             14590000
117700         WHEN ZERO                                                14600000
117800*  MOVING 'V' HERE BECAUSE ABENDS AND TRANSACTIONS THAT COME      14610000
117900*  THROUGH DATA COLLECT IN THE WRONG ORDER WILL NOT HAVE THE      14620000
118000*  VOID ABORT CODE SET.                                           14630000
118100             MOVE 'V'             TO EPTRN-VOID-ABRT-CDE          14640000
118200         WHEN +100                                                14650000
118300             SET PS-END-OF-LATE-VOID-CURSOR TO TRUE               14660000
118400         WHEN OTHER                                               14670000
118500             MOVE '2800-FETCH-LATE-VOIDS-CURSOR'                  14680000
118600                                            TO PV-PARAGRAPH-NAME  14690000
118700             MOVE 'ERROR ON FETCHING LATE VOID INFO '             14700000
118800                                            TO PV-DB2-OPERATION   14710000
118900             PERFORM 9200-SQL-ABEND                               14720000
119000     END-EVALUATE.                                                14730000
119100                                                                  14740000
119200***************************************************************** 14750000
119300*  CLOSE THE  LATE VOID CURSOR                                    14760000
119400***************************************************************** 14770000
119500 2900-CLOSE-LATE-VOID-CURSOR.                                     14780000
119600                                                                  14790000
119700     EXEC SQL                                                     14800000
119800         CLOSE LATE-VOID-CSR                                      14810000
119900     END-EXEC.                                                    14820000
120000                                                                  14830000
120100     EVALUATE SQLCODE                                             14840000
120200         WHEN ZERO                                                14850000
120300             CONTINUE                                             14860000
120400         WHEN OTHER                                               14870000
120500             MOVE '2900-CLOSE-LATE-VOID-CURSOR'                   14880000
120600                                            TO PV-PARAGRAPH-NAME  14890000
120700             MOVE 'ERROR ON CLOSING LATE VOID CURSOR '            14900000
120800                                            TO PV-DB2-OPERATION   14910000
120900             PERFORM 9200-SQL-ABEND                               14920000
121000     END-EVALUATE.                                                14930000
121100                                                                  14940000
C76279***************************************************************** 14950000
C76279*  THIS DETERMINE THE TRANSACTION TYPE                            14960000
C76279*  IF NULL VALUE IN THE TABLE, THEN THIS TRANSACTION WILL BE      14970000
C76279*  CONSIDERED AS OTHERS(N)                                        14980000
C76279*  IF 'SFS' VALUE IN THE TABLE, THEN THIS TRANSACTION WILL BE     14990000
C76279*  CONSIDERED AS SHIP FROM STORE (S)                              15000000
C76279*  IF 'BPS' VALUE IN THE TABLE, THEN THIS TRANSACTION WILL BE     15010000
C76279*  CONSIDERED AS BOPUS (B)                                        15020000
BOSS  *  IF 'BOS' VALUE IN THE TABLE, THEN THIS TRANSACTION WILL BE     15021075
BOSS  *  CONSIDERED AS BOSS (O)                                         15022075
BOSS  *  IF OTHER THAN BPS, BOS AND SFS, THEN THIS TRANSACTION WILL BE  15030075
C76279*  CONSIDERED AS OTHERS(N). THIS IS FOR FUTURE TRANSACTION TYPE   15040000
C76279***************************************************************** 15050000
C76279 2950-DETERMINE-TRAN-TYPE.                                        15060000
C76279                                                                  15070000
C76279     IF PS-IND6-IS-NULL                                           15080000
C76279         SET PS-OMNI-CHNL-IS-NULL TO TRUE                         15090000
C76279         MOVE 'N' TO PS-OMNI-CHNL-IND                             15100000
C76279         SET PS-OTH TO TRUE                                       15110000
C76279     ELSE                                                         15120000
C76279         SET PS-OMNI-CHNL-IS-NOT-NULL TO TRUE                     15130000
C76279         MOVE 'Y' TO PS-OMNI-CHNL-IND                             15140000
C76279         EVALUATE TRUE                                            15150000
C76279             WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SFS'          15160000
C76279                   SET PS-SFS TO TRUE                             15170000
C76279*            WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'BPS'          15180063
C76279*                  SET PS-BPS TO TRUE                             15190063
CHG344             WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SDD'          15191072
CHG344                   SET PS-SFS TO TRUE                             15192072
C76279             WHEN  OTHER                                          15200000
C76279                   SET PS-OTH TO TRUE                             15210000
C76279         END-EVALUATE                                             15220000
C76279     END-IF.                                                      15230000
121200******************************************************************15240000
121300* WHEN THERE IS A CHANGE IN STORE NUMBER GET STORE INFORMATION   *15250000
121400* FOR THE NEW STORE.                                             *15260000
121500*                                                                *15270000
121600* CHECK IF THERE IS A TAX EXEMPT ID FOR TRANSACTIONS WITH SALES  *15280000
121700* TAX AMOUNT OF ZERO.                                            *15290000
121800*                                                                *15300000
121900* WRITE OUT THE TAX RECORD FOR TAX EXEMPT CUSTOMERS.             *15310000
122000*                                                                *15320000
122100* THE REST OF THE PROCESSING OF TRANSACTIONS IS DIFFERENT FOR    *15330000
122200* BRICK AND MORTAR AND E-COMMERCE TRANSACTIONS. E-COMMERCE       *15340000
122300* SALES CORRECTIONS ARE PROCESSED THE SAME AS BRICK & MORTAR     *15350000
122400* TRANSACTIONS.                                                  *15360000
122500******************************************************************15370000
122600 3000-PROCESS-TRANSACTION.                                        15380000
122700                                                                  15390000
122800**** BAD TRANSACTION BYPASS LOGIC ****************                15400000
122900*    IF EPTRN-PARTN-NBR = 94                                      15410000
123000*       AND EPTRN-STR-NBR = 44                                    15420000
123100*       AND EPTRN-RGST-ID = 26                                    15430000
123200*       AND EPTRN-TRN-NBR = 814                                   15440000
123300*       GO TO 3000-PROCESS-TRANSACTION-EXIT.                      15450000
******                                                                  15460000
*******    IF PV-WORK-STR-NBR NOT EQUAL PV-SAVE-STR-NBR                 15470000
*******       MOVE PV-WORK-STR-NBR    TO  PV-SAVE-STR-NBR               15480000
*******    END-IF.                                                      15490000
CHG859     SET PS-NOT-ECOMMERCE-RETURN TO TRUE.                         15500000
124092     IF EPTRN-STR-NBR NOT EQUAL PV-SAVE-STR-NBR                   15510000
124093         MOVE EPTRN-STR-NBR TO PV-SAVE-STR-NBR                    15520000
124094                               PV-WORK-STR-NBR                    15530000
124095         PERFORM 8100-SEARCH-FOR-STORE-INFO                       15540000
124096         IF PS-END-OF-ECOM-TABLE                                  15550000
124097             PERFORM 8200-GET-STORE-INFO                          15560000
124098         END-IF                                                   15570000
124099     END-IF.                                                      15580000
124300                                                                  15590000
124400     IF PV-BUS-LOC-IND = 'Y'                                      15600000
124500       OR (PV-BUS-LOC-IND = 'N'                                   15610000
124600           AND PS-OMNI-CHNL-IS-NOT-NULL)                          15620000
092300            OR EPTRN-POS-TYP-CDE = '001'                          15630005
124700         SET PS-ECOMMERCE-STORE     TO TRUE                       15640000
124800     ELSE                                                         15650000
124900         SET PS-NOT-ECOMMERCE-STORE TO TRUE                       15660000
125000     END-IF.                                                      15670000
125100                                                                  15680000
125200     MOVE EPTRN-SLS-DTE            TO PV-POS-CCYY-MM-DD.          15690000
125300     MOVE EPTRN-STR-NBR            TO PV-STR-NBR-9.               15700000
125400     MOVE EPTRN-RGST-ID            TO PV-RGST-ID-9.               15710000
125500     MOVE EPTRN-TRN-NBR            TO PV-TRN-NBR-9.               15720000
125600     MOVE EPTRN-TRN-TYP-CDE        TO PS-TRN-TYP-CDE.             15730000
125700     MOVE ZERO                     TO PA-TRN-TX-AMT               15740000
125800                                      PV-PRV-TX-AMT               15750000
125900                                      PV-TRN-CHRGD-AMT.           15760000
126000                                                                  15770000
126100     IF EPTRN-SLS-TX-AMT = ZERO                                   15780000
126200         PERFORM 3100-CHECK-FOR-TAX-EXEMPT-NBR                    15790000
126300     ELSE                                                         15800000
126400         MOVE SPACES TO EPTAX-TX-EXMPT-ID                         15810000
126500     END-IF.                                                      15820000
126600                                                                  15830000
126700     IF PS-ECOMMERCE-STORE                                        15840000
126800         PERFORM 4000-PROCESS-ECOMMERCE-TRANS                     15850000
TMPFIX         MOVE ZERO TO PV-SAVE-STR-NBR                             15860000
126900*    ELSE                                                         15870064
127000*        PERFORM 5000-PROCESS-BRICK-MRTR-TRNS                     15880064
127100     END-IF.                                                      15890000
127400                                                                  15900000
127500 3000-PROCESS-TRANSACTION-EXIT.                                   15910000
127600     EXIT.                                                        15920000
127700******************************************************************15930000
127800*  CHECK IF THERE IS A TAX EXEMPT NUMBER IN THE TEPTAX TABLE FOR  15940000
127900*  THE TRANSACTION.  WHEN ONE IS FOUND SET TAX-EXEMPT-YES TO TRUE 15950000
128000*  AND MOVE THE TAX EXEMPT ID TO THE OUTPUT RECORD.  OTHERWISE    15960000
128100*  SET THE TX-EXEMPT-NO TO TRUE.                                  15970000
128200******************************************************************15980000
128300 3100-CHECK-FOR-TAX-EXEMPT-NBR.                                   15990000
128400                                                                  16000000
128500     EXEC SQL                                                     16010000
128600       SELECT TX_EXMPT_ID                                         16020000
128700         INTO :EPTAX-TX-EXMPT-ID                                  16030000
128800         FROM TEPTAX                                              16040000
128900        WHERE PARTN_NBR        = :EPTRN-PARTN-NBR                 16050000
129000          AND STR_NBR          = :EPTRN-STR-NBR                   16060000
129100          AND RGST_ID          = :EPTRN-RGST-ID                   16070000
129200          AND TRN_NBR          = :EPTRN-TRN-NBR                   16080000
129300          AND STRT_TM          = :EPTRN-STRT-TM                   16090000
129400          AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR          16100000
129500        WITH UR                                                   16110000
129600     END-EXEC.                                                    16120000
129700                                                                  16130000
129800     EVALUATE SQLCODE                                             16140000
129900         WHEN ZERO                                                16150000
130000             CONTINUE                                             16160000
130100         WHEN +100                                                16170000
130200             MOVE SPACES              TO EPTAX-TX-EXMPT-ID        16180000
130300         WHEN OTHER                                               16190000
130400             MOVE '3100-CHECK-FOR-TAX-EXEMPT-NBR'                 16200000
130500                                            TO  PV-PARAGRAPH-NAME 16210000
130600             MOVE 'ERROR ON SELECTING FROM TEPTAX TABLE'          16220000
130700                                            TO PV-DB2-OPERATION   16230000
130800             PERFORM 9200-SQL-ABEND                               16240000
130900     END-EVALUATE.                                                16250000
131000                                                                  16260000
131100******************************************************************16270000
131200*  FETCH ALL LINE ITEMS FOR THE TRANSACTION FROM THE LINE ITEM   *16280000
131300*  TABLE.  THE TAX AMOUNT AND TAX RATE FOR ECOMMERCE TRANSACTIONS*16290000
131400*  IS ON THE TEPITM TABLE.                                       *16300000
131500*                                                                *16310000
131600*  SKIP ALL ITEMS WITH DEPT 099 SUB CL 10 AND A NET CHARGED AMT  *16320000
131700*  OF ZERO.  THIS IS USED TO MARK A LINE ITEM PLACE FOR GIFT WRAP*16330000
131800*  AND SHIPPING REFUNDS ON THE TEPLIS TABLE.                     *16340000
131900*                                                                *16350000
132000*  FETCH SPECIAL SERVICE FEES FROM TEPLIS TABLE.  SHIPPING       *16360000
132100*  CHARGES ARE IGNORED ON SALE TRANSACTIONS BECAUSE THEY ARE     *16370000
132200*  IN THE TEPSHP TABLE.  HOWEVER SHIPPING RETURNS ARE ON THE     *16380000
132300*  IN THE TEPLIS TABLE.  GIFT WRAP RETURNS AND SALES ARE BOTH IN *16390000
132400*  TEPLIS.  SHIPPING CHARGES ARE IN TEPLIS FOR SALES CORRECTIONS.*16400000
132500*                                                                *16410000
132600*  FOR SALE TRANSACTIONS & MIX MODE TRANSACTIONS, FETCH SHIPPING *16420000
132700*  CHARGES FROM TEPSHP TABLE.  THERE ARE NO TEPSHP ROWS FOR      *16430000
132800*  RETURNS.                                                      *16440000
132900******************************************************************16450000
133000 4000-PROCESS-ECOMMERCE-TRANS.                                    16460000
133210                                                                  16470000
133220     PERFORM 7900-GET-ECOMMERCE-ORDER-NBR.                        16480000
133230     SET PS-NOT-END-OF-LINE-ITEM-CURSOR  TO TRUE.                 16490000
133240     PERFORM 4400-OPEN-LINE-ITEM-CURSOR.                          16500000
133250     PERFORM 4500-FETCH-LINE-ITEM-CURSOR.                         16510000
133260                                                                  16520000
133270     IF PS-NOT-END-OF-LINE-ITEM-CURSOR                            16530000
133280         MOVE EPITM-RCPT-TX-TOT-CDE TO PV-SAVE-RCPT-TX-TOT-CDE    16540000
133290     END-IF                                                       16550000
133300                                                                  16560000
133400     PERFORM UNTIL PS-END-OF-LINE-ITEM-CURSOR                     16570000
133500         MOVE EPTRN-STR-NBR TO PV-WORK-STR-NBR                    16580000
133600         MOVE EPITM-DEPT-NBR       TO PV-DEPT-NBR                 16590000
133700         MOVE EPITM-MAJ-CL-NBR     TO PV-MAJ-CL-NBR               16600000
133800         MOVE EPITM-SUB-CL-NBR     TO PV-SUB-CL-NBR               16610000
133900         IF EPITM-SKU-NBR > 0                                     16620000
134000             MOVE EPITM-SKU-NBR    TO PV-SKU                      16630000
134100             MOVE PV-SKU           TO PV-SKU-NBR                  16640000
134200         ELSE                                                     16650000
134300             MOVE SPACES           TO PV-SKU-NBR                  16660000
134400         END-IF                                                   16670000
134500         EVALUATE TRUE                                            16680000
134600            WHEN PV-MISC-SKU AND                                  16690000
134700                 EPITM-NET-CHRGD-AMT = 0                          16700000
134800                    CONTINUE                                      16710000
134900            WHEN PV-TAX-REFUND-SKU                                16720000
135000                    PERFORM 5500-PROCESS-TAX-REFUND               16730000
135100            WHEN OTHER                                            16740000
135200                    PERFORM 4100-PROCESS-ECOMMERCE-ITEM           16750000
135300         END-EVALUATE                                             16760000
135400         PERFORM 4500-FETCH-LINE-ITEM-CURSOR                      16770000
135500     END-PERFORM.                                                 16780000
135600                                                                  16790000
135700     PERFORM 4600-CLOSE-LINE-ITEM-CURSOR.                         16800000
135800                                                                  16810000
135900     SET PS-NOT-END-OF-SSFEES-CURSOR TO TRUE.                     16820000
136000     PERFORM 7210-OPEN-SSFEES-CURSOR                              16830000
136100     PERFORM 7220-FETCH-SSFEES-CURSOR                             16840000
136200     PERFORM UNTIL PS-END-OF-SSFEES-CURSOR                        16850000
136300         IF EPLIS-SRVC-TYP-CDE = 'W'                              16860000
136400           OR (PS-RETURN-TRANSACTION                              16870000
136500           AND EPTRN-TRN-STAT-CDE NOT = 'R')                      16880000
136600             PERFORM 4200-PROCESS-SSFEES-CURSOR                   16890000
136700         END-IF                                                   16900000
136800         PERFORM 7220-FETCH-SSFEES-CURSOR                         16910000
136900     END-PERFORM                                                  16920000
137000     PERFORM 7230-CLOSE-SSFEES-CURSOR                             16930000
137100                                                                  16940000
137200     SET PS-NOT-END-OF-SHIP-CURSOR TO TRUE.                       16950000
CHG859         MOVE EPTRN-PARTN-NBR                                     16960000
CHG859             TO PV-SHP-PARTN-NBR.                                 16970000
CHG859         MOVE EPTRN-STR-NBR                                       16980000
CHG859             TO PV-SHP-STR-NBR.                                   16990000
CHG859         MOVE EPTRN-RGST-ID                                       17000000
CHG859             TO PV-SHP-RGST-ID.                                   17010000
CHG859         MOVE EPTRN-TRN-NBR                                       17020000
CHG859             TO PV-SHP-TRN-NBR.                                   17030000
CHG859         MOVE EPTRN-STRT-TM                                       17040000
CHG859             TO PV-SHP-STRT-TM.                                   17050000
137507     PERFORM 7310-OPEN-SHIP-CURSOR.                               17060000
137508     PERFORM 7320-FETCH-SHIP-CURSOR.                              17070000
137509                                                                  17080000
137510     PERFORM UNTIL PS-END-OF-SHIP-CURSOR                          17090000
137514          PERFORM 4300-PROCESS-SHIP-CURSOR                        17100000
137515          PERFORM 7320-FETCH-SHIP-CURSOR                          17110000
137516     END-PERFORM.                                                 17120000
C70860     PERFORM 7330-CLOSE-SHIP-CURSOR.                              17130000
137518                                                                  17140000
137520******************************************************************17150000
137530* PROCES A LINE ITEM FOR AN E-COMMERCE TRANSACTION               *17160000
137540*                                                                *17170000
137550* PERFORM PROCESSING FOR RETURN TRANSACTIONS.                    *17180000
137560*                                                                *17190000
137570* GET TAX RATE INFORMATION AND GEOGRAPHIC INFORMATION.  FOR      *17200000
137580* RETURN TRANSACTIONS GET THE INFORMATION FROM THE ORIGINAL      *17210000
137590* TRANSACTION.                                                   *17220000
137600******************************************************************17230000
137700 4100-PROCESS-ECOMMERCE-ITEM.                                     17240000
137800                                                                  17250000
137900     MOVE EPITM-UPC-NBR            TO PV-UPC.                     17260000
138000     MOVE EPITM-SLD-QTY            TO PV-SAVE-SLD-QTY.            17270000
138100     MOVE EPITM-TX-RT-PCT          TO PV-TAX-RATE-PCT.            17280000
138200                                                                  17290000
STCFEE**   SALES TAX COMPLIANCE - THE ITEM TAX AMOUNT WILL CONTAIN THE  17300011
STCFEE**   TAX FOR BOTH THE ITEM AND ASSOCIATED FEES.                   17310011
STCFEE**   FOR 'MOST' TRANSACTIONS, THE SUBJECT TO TAX WILL CONTAIN     17320011
STCFEE**   THE SUM OF THE ITEM AND ASSOCIATED FEE AMOUNTS THAT ARE      17330011
STCFEE**   TAXABLE.  IF SUBJECT TO TAX IS ZERO AND THE TRAN ISN'T A     17340050
STCFEE**   REVERSAL AND EITHER THE THE TAX AMOUNT IS > 0 OR THE ITEM    17350050
STCFEE**   IS TAX EXEMPT, THEN THE NET CHARGED AMOUNT WIL BE USED       17360050
STCFEE**   FOR THE ITEM TAXABLE AMOUNT.                                 17370050
STCFEE**   ASSOCIATED FEES FROM THE TEPLIS TABLE WILL BE ADDED IN IF    17380036
STCFEE**   IF THE FEE TAXABLE IND = 'Y'.                                17390036
STCFEE     IF (EPITM-SBJCT-TO-TX-AMT = ZERO                             17400042
STCFEE     OR  EPTRN-TRN-STAT-CDE    = 'R')                             17410042
STCFEE         IF (EPITM-TX-AMT  NOT = ZERO)                            17420037
STCFEE         OR (EPTAX-TX-EXMPT-ID NOT = SPACES)                      17430037
STCFEE             MOVE EPITM-NET-CHRGD-AMT     TO PV-WORK-AMOUNT       17440029
STCFEE             PERFORM 5450-DETERMINE-TXBL-FEE-AMT                  17450041
STCFEE             ADD EPLIS-SRVC-AMT           TO PV-WORK-AMOUNT       17460041
STCFEE         ELSE                                                     17470037
STCFEE             MOVE ZEROES                  TO PV-WORK-AMOUNT       17480037
STCFEE         END-IF                                                   17490037
STCFEE     ELSE                                                         17500011
STCFEE         MOVE EPITM-SBJCT-TO-TX-AMT       TO PV-WORK-AMOUNT       17510047
STCFEE     END-IF.                                                      17520011
139500                                                                  17530000
STCFEE     MOVE EPITM-TX-AMT         TO PV-TX-AMT.                      17540025
140600                                                                  17550000
140700     IF PV-WORK-AMOUNT = ZERO AND PV-TX-AMT = ZERO                17560000
140800         CONTINUE                                                 17570000
140900     ELSE                                                         17580000
141000         IF PS-RETURN-TRANSACTION OR                              17590000
141100           ((PS-MIX-MODE-TRANSACTION OR PS-PRICE-ADJ-TRANSACTION) 17600000
141200                                     AND                          17610000
141300            (EPITM-SAL-RET-CDE =         'R' OR 'B'))             17620000
141400             PERFORM 7500-GET-ORIG-TRANS-INFO                     17630000
141500             IF PS-ECOMMERCE-RETURN                               17640000
141600                 PERFORM 4110-ECOMM-RETURN-PROCESSING             17650000
141700             END-IF                                               17660000
141800         ELSE                                                     17670000
141900             MOVE EPTRN-TRN-DTE    TO PV-ORD-DTE                  17680000
142000             IF EPORD-ORD-NBR-TEXT > SPACES                       17690000
142100                 MOVE EPTRN-SLS-CORR-SEQ-NBR TO                   17700000
142200                      PV-SLS-CORR-SEQ-NBR                         17710000
142300             ELSE                                                 17720000
142400                 MOVE ZERO TO PV-SLS-CORR-SEQ-NBR                 17730000
142500             END-IF                                               17740000
BOSS               IF NOT PS-BPS AND NOT PS-BOS                         17750075
142600                PERFORM 7600-GET-GEO-INFO                         17760000
142610                IF PS-SHIP-CODE-NOT-FOUND                         17770000
142611                   PERFORM 8300-SHIP-ZIPCODE                      17780000
142620                END-IF                                            17790000
C76279             END-IF                                               17800000
142700         END-IF                                                   17810000
142800                                                                  17820000
142900         MOVE EPITM-DEPT-NBR           TO PV-DEPT-NBR             17830000
143000         MOVE EPITM-MAJ-CL-NBR         TO PV-MAJ-CL-NBR           17840000
143100         MOVE EPITM-SUB-CL-NBR         TO PV-SUB-CL-NBR           17850000
143200                                                                  17860000
143300         IF EPITM-SKU-NBR > 0                                     17870000
143400             MOVE EPITM-SKU-NBR        TO PV-SKU                  17880000
143500             MOVE PV-SKU               TO PV-SKU-NBR              17890000
143600         ELSE                                                     17900000
143700             MOVE SPACES               TO PV-SKU-NBR              17910000
143800         END-IF                                                   17920000
143900                                                                  17930000
144000         PERFORM 4120-PROCESS-OUTPUT-RECORD                       17940000
144100     END-IF.                                                      17950000
144200                                                                  17960000
144300******************************************************************17970000
144400* GET THE TAX RATE AND AMOUNT FROM THE ITEM TABLE.               *17980000
144500* IF THE RETURN IS A RECEIPTED RETURN GET THE ORIGINAL           *17990000
144600* TRANSACTION INFORMATION.                                       *18000000
144700******************************************************************18010000
144800 4110-ECOMM-RETURN-PROCESSING.                                    18020000
144900                                                                  18030000
145500     IF PS-RECEIPTED-RETURN                                       18040000
145600         PERFORM 7800-GET-RETURN-INFO                             18050000
145700     END-IF.                                                      18060000
145800                                                                  18070000
145900******  IF THE ORIGINAL TRANSACTION IS NOT FOUND IN PARA 7800-    18080000
146000******  PROCESS THE RETURN LIKE A NON RECEIPTED RETURN.           18090000
146100                                                                  18100000
146200     IF PS-NON-RECEIPTED-RETURN                                   18110000
146300         PERFORM 8100-SEARCH-FOR-STORE-INFO                       18120000
146400         MOVE PV-POS-CCYY-MM-DD TO PV-ORD-DTE                     18130000
146500     END-IF.                                                      18140000
146600                                                                  18150000
146700******************************************************************18160000
146800* FORMAT THE OUTPUT RECORD FOR ECOMMERCE LINE ITEMS.             *18170000
146900******************************************************************18180000
147000 4120-PROCESS-OUTPUT-RECORD.                                      18190000
147100                                                                  18200000
147200     INITIALIZE                       TX006-TAX-AUDIT-RECORD.     18210000
147300     MOVE EPTRN-PARTN-NBR          TO TX006-PARTITION.            18220000
147400     MOVE EPTRN-RGST-ID            TO TX006-RGST-ID.              18230000
147500     MOVE EPTRN-TRN-NBR            TO TX006-TRN-NBR.              18240000
147600     MOVE EPTRN-STRT-TM            TO TX006-START-TIME.           18250000
147700     MOVE EPTRN-SLS-CORR-SEQ-NBR   TO TX006-SLS-CORR-SEQ-NBR.     18260000
147800     MOVE EPTRN-TRN-TYP-CDE        TO TX006-TRN-TYP-CDE.          18270000
147900     MOVE EPTRN-POS-CPBL-LVL-NBR   TO TX006-POS-CPBL-LVL-NBR.     18280000
148000     MOVE EPITM-LNE-ITM-SEQ-NBR    TO TX006-LNE-ITM-SEQ-NBR.      18290000
148100     MOVE EPITM-RCPT-TX-TOT-CDE    TO TX006-RCPT-TX-TOT-CDE.      18300000
STCFEE     MOVE EPITM-TX-PRD-CDE-DESC-TEXT TO TX006-TAXWARE-PROD-CDE.   18310046
148200     MOVE EPTAX-TX-EXMPT-ID        TO TX006-TAX-EXMPT-ID.         18320000
148300     MOVE EPORD-ORD-NBR-TEXT       TO                             18330000
148400          TX006-ECOMMERCE-ORDER-NUMBER.                           18340000
148500                                                                  18350000
148600     MOVE PV-SHIP-ST-CODE          TO TX006-ST-CDE.               18360000
148700     MOVE PV-SHIP-ZIP-CODE         TO TX006-ZIP-CDE.              18370000
148800     MOVE PV-SHIP-GEO-CODE         TO TX006-GEO-CDE.              18380000
148900     MOVE PV-STR-NBR-9             TO TX006-STR-NBR.              18390000
149000     MOVE PV-ORD-DTE               TO TX006-ORDER-DTE.            18400000
149600     MOVE PV-POS-CCYY-MM-DD        TO TX006-PROCESS-DTE.          18410000
149700     MOVE PV-TAX-RATE-PCT          TO TX006-TAX-RT-PCT.           18420000
149800     MOVE PV-UPC                   TO TX006-MDSE-ID.              18430000
149900     IF PV-DEPT-NBR NUMERIC                                       18440000
150000         MOVE PV-DEPT-NBR          TO TX006-DEPT-NBR              18450000
150100     ELSE                                                         18460000
150200         MOVE ZERO                 TO TX006-DEPT-NBR              18470000
150300     END-IF.                                                      18480000
150400     MOVE PV-MAJ-CL-NBR            TO TX006-MAJ-CL-NBR            18490000
150500     IF PV-SUB-CL-NBR NUMERIC                                     18500000
150600         MOVE PV-SUB-CL-NBR        TO TX006-SUB-CL-NBR            18510000
150700     ELSE                                                         18520000
150800         MOVE ZERO                 TO TX006-SUB-CL-NBR            18530000
150900     END-IF.                                                      18540000
151000     MOVE PV-SKU-NBR               TO TX006-SKU-NBR.              18550000
151100                                                                  18560000
151200     IF PV-WORK-AMOUNT < 0                                        18570000
151300        SET TX006-CREDIT-YES TO TRUE                              18580000
151400        COMPUTE TX006-TAXABLE-AMT    = PV-WORK-AMOUNT * -1        18590000
151500        END-COMPUTE                                               18600045
151600        IF PV-TX-AMT < 0                                          18610045
151700            COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT   * -1       18620000
151800            END-COMPUTE                                           18630045
151900        ELSE                                                      18640045
152000            COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT   *  1       18650045
152100            END-COMPUTE                                           18660045
152200        END-IF                                                    18670045
152300     ELSE                                                         18680000
152400        SET TX006-CREDIT-NO TO TRUE                               18690000
152500        COMPUTE TX006-TAXABLE-AMT    = PV-WORK-AMOUNT * 1         18700000
152600        END-COMPUTE                                               18710045
152700        IF PV-TX-AMT < 0                                          18720045
152800            COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT   * -1       18730045
152900            END-COMPUTE                                           18740045
153000        ELSE                                                      18750045
153100            COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT   *  1       18760000
153200            END-COMPUTE                                           18770045
153300        END-IF                                                    18780045
153400     END-IF.                                                      18790000
153500                                                                  18800000
153600     MOVE PV-SAVE-SLD-QTY          TO TX006-SLD-QTY.              18810000
153700                                                                  18820000
153800     IF TX006-TX-AMT = ZERO                                       18830000
153900         SET TX006-EXEMPT-YES          TO TRUE                    18840000
154000         SET TX006-SALES-AMOUNT-PASSED TO TRUE                    18850000
154100     ELSE                                                         18860000
154200         SET TX006-EXEMPT-NO           TO TRUE                    18870000
154300         SET TX006-TAX-AMOUNT-PASSED   TO TRUE                    18880000
154400     END-IF.                                                      18890000
154500                                                                  18900000
154600     IF TX006-DEPT-NBR    = '099' AND                             18910000
154700        TX006-SUB-CL-NBR  = '10'                                  18920000
154800           MOVE PC-MISC-SKU TO TX006-SKU-NBR                      18930000
154900     END-IF.                                                      18940000
C76279     PERFORM 5600-POPULATE-TRNTYP-OUTPUT.                         18950000
155000                                                                  18960000
155100     PERFORM 8000-WRITE-TX-RECORD.                                18970000
155200                                                                  18980000
159200                                                                  18990000
159300***************************************************************** 19000000
159400*  PROCESS AN OCCURANCE OF A SPECIAL SERVICE FEE                  19010000
159500***************************************************************** 19020000
159600 4200-PROCESS-SSFEES-CURSOR.                                      19030000
159700                                                                  19040000
159800     MOVE EPLIS-SRVC-AMT           TO PV-WORK-AMOUNT.             19050000
159900     MOVE EPLIS-TX-RT-PCT          TO PV-TAX-RATE-PCT.            19060000
160000     MOVE EPLIS-TX-AMT             TO PV-TX-AMT.                  19070000
160100     MOVE EPLIS-SRVC-TYP-CDE       TO PV-SRVC-TYP-CDE.            19080000
160200                                                                  19090000
160300     PERFORM 7400-READ-DEPT-CLASS-TABLE.                          19100000
160400                                                                  19110000
160500     IF PS-RETURN-TRANSACTION                                     19120000
160600         PERFORM 7500-GET-ORIG-TRANS-INFO                         19130000
160700         IF PS-ECOMMERCE-RETURN AND PS-RECEIPTED-RETURN           19140000
160800             PERFORM 7800-GET-RETURN-INFO                         19150000
160900         END-IF                                                   19160000
161000         IF PS-NON-RECEIPTED-RETURN                               19170000
161100             PERFORM 8100-SEARCH-FOR-STORE-INFO                   19180000
161200             MOVE PV-POS-CCYY-MM-DD TO PV-ORD-DTE                 19190000
161300         END-IF                                                   19200000
161400     ELSE                                                         19210000
161500         IF PS-ECOMMERCE-STORE                                    19220000
161600             MOVE EPLIS-LNE-ITM-SEQ-NBR    TO                     19230000
161700                  EPITM-LNE-ITM-SEQ-NBR                           19240000
161800             MOVE EPTRN-SLS-CORR-SEQ-NBR TO PV-SLS-CORR-SEQ-NBR   19250000
BOSS               IF NOT PS-BPS AND NOT PS-BOS                         19260075
161900                PERFORM 7600-GET-GEO-INFO                         19270000
CHG859                IF PS-SHIP-CODE-NOT-FOUND                         19280000
CHG859                   PERFORM 8300-SHIP-ZIPCODE                      19290000
CHG858                END-IF                                            19300000
C76279             END-IF                                               19310000
162000         END-IF                                                   19320000
162100     END-IF.                                                      19330000
162200                                                                  19340000
162300     PERFORM 4700-PROCESS-OUTPUT-RECORD.                          19350000
162400                                                                  19360000
162500***************************************************************** 19370000
162600*  PROCESS AN OCCURANCE OF A SHIPPING CHARGE FEE                  19380000
162700***************************************************************** 19390000
162800 4300-PROCESS-SHIP-CURSOR.                                        19400000
162900                                                                  19410000
C92405     IF EPSHP-SHIP-CHRG-AMT = 0                                   19420000
C92405         CONTINUE                                                 19430000
C92405     ELSE                                                         19440000
163000         MOVE EPSHP-SHIP-CHRG-AMT     TO PV-WORK-AMOUNT           19450000
163100         MOVE EPSHP-TX-RT-PCT         TO PV-TAX-RATE-PCT          19460000
163200         MOVE EPSHP-TX-AMT            TO PV-TX-AMT                19470000
163300         MOVE 'S'                     TO PV-SRVC-TYP-CDE          19480000
163400         MOVE SPACES                  TO PV-SHIP-ST-CODE          19490000
163500         IF EPSHP-ZIP-5-CDE = SPACES                              19500000
163600            CONTINUE                                              19510000
163700         ELSE                                                     19520000
P10237            MOVE EPSHP-ZIP-5-CDE      TO PV-ENCR-ZIP-CODE         19530000
P10237            PERFORM 8400-PROCESS-ZIP-CDE                          19540000
P10237            MOVE PV-ZIP-CODE          TO PV-SHIP-ZIP-CODE         19550000
164100            MOVE EPSHP-TX-GEOG-CDE    TO PV-SHIP-GEO-CODE         19560000
164200         END-IF                                                   19570000
164300         PERFORM 7400-READ-DEPT-CLASS-TABLE                       19580000
164400         PERFORM 4700-PROCESS-OUTPUT-RECORD                       19590000
C92405     END-IF.                                                      19600000
164500                                                                  19610000
164600***************************************************************** 19620000
164700*  OPEN THE ITEMS CURSOR                                          19630000
164800***************************************************************** 19640000
164900 4400-OPEN-LINE-ITEM-CURSOR.                                      19650000
165000                                                                  19660000
165100     EXEC SQL                                                     19670000
165200         OPEN ITEMS-CSR                                           19680000
165300     END-EXEC.                                                    19690000
165400                                                                  19700000
165500     EVALUATE TRUE                                                19710000
165600         WHEN SQLCODE = ZERO                                      19720000
165700             CONTINUE                                             19730000
165800         WHEN SQLWARN0 NOT EQUAL SPACE                            19740000
165900         WHEN SQLCODE NOT EQUAL ZERO                              19750000
166000             MOVE '4400-OPEN-LINE-ITEM-CURSOR'                    19760000
166100                                            TO PV-PARAGRAPH-NAME  19770000
166200             MOVE 'ERROR ON OPENING LINE ITEM CURSOR '            19780000
166300                                            TO PV-DB2-OPERATION   19790000
166400             PERFORM 9200-SQL-ABEND                               19800000
166500     END-EVALUATE.                                                19810000
166600                                                                  19820000
166700****************************************************************  19830000
166800*  FETCH THE ITEMS CURSOR                                         19840000
166900****************************************************************  19850000
167000 4500-FETCH-LINE-ITEM-CURSOR.                                     19860000
167100                                                                  19870000
STCFEE     MOVE ZERO TO PS-NULL-IND7.                                   19880018
167100                                                                  19890018
167200     EXEC SQL                                                     19900000
167300     FETCH ITEMS-CSR                                              19910000
167400         INTO  :EPITM-LNE-ITM-SEQ-NBR                             19920000
167500              ,:EPITM-DEPT-NBR                                    19930000
167600              ,:EPITM-SUB-CL-NBR                                  19940000
167700              ,:EPITM-SLD-QTY                                     19950000
167800              ,:EPITM-NET-CHRGD-AMT                               19960000
167900              ,:EPITM-UPC-NBR                                     19970000
168000              ,:EPITM-SAL-RET-CDE                                 19980000
168100              ,:EPITM-TXBL-IND                                    19990000
168200              ,:EPITM-RCPT-TX-TOT-CDE                             20000000
168300              ,:EPITM-TX-RT-PCT                                   20010000
168400              ,:EPITM-TX-AMT                                      20020000
168500              ,:EPITM-SKU-NBR                                     20030000
168600              ,:EPITM-MAJ-CL-NBR                                  20040000
168700              ,:EPITM-RCPT-SEQ-NBR                                20050000
168800              ,:EPITM-SBJCT-TO-TX-AMT                             20060000
STCFEE              ,:EPITM-TX-PRD-CDE-DESC:PS-NULL-IND7                20070046
168900     END-EXEC.                                                    20080000
169000                                                                  20090000
169100     EVALUATE SQLCODE                                             20100000
169200         WHEN ZERO                                                20110000
STCFEE             IF PS-NULL-IND7 = -1                                 20120046
STCFEE                 MOVE SPACES TO EPITM-TX-PRD-CDE-DESC-TEXT        20130046
STCFEE             END-IF                                               20140046
169400         WHEN +100                                                20150000
169500             SET PS-END-OF-LINE-ITEM-CURSOR TO TRUE               20160000
169600         WHEN OTHER                                               20170000
169700             MOVE '4500-FETCH-LINE-ITEM-CURSOR'                   20180000
169800                                            TO PV-PARAGRAPH-NAME  20190000
169900             MOVE 'ERROR ON FETCHING LINE ITEM CURSOR '           20200000
170000                                            TO PV-DB2-OPERATION   20210000
170100             PERFORM 9200-SQL-ABEND                               20220000
170200     END-EVALUATE.                                                20230000
170300                                                                  20240000
170400***************************************************************** 20250000
170500*  CLOSE THE ITEMS CURSOR                                         20260000
170600***************************************************************** 20270000
170700 4600-CLOSE-LINE-ITEM-CURSOR.                                     20280000
170800                                                                  20290000
170900     EXEC SQL                                                     20300000
171000         CLOSE ITEMS-CSR                                          20310000
171100     END-EXEC.                                                    20320000
171200                                                                  20330000
171300     EVALUATE SQLCODE                                             20340000
171400         WHEN ZERO                                                20350000
171500             CONTINUE                                             20360000
171600         WHEN OTHER                                               20370000
171700             MOVE '4600-CLOSE-LINE-ITEM-CURSOR'                   20380000
171800                                            TO PV-PARAGRAPH-NAME  20390000
171900             MOVE 'ERROR ON CLOSING LINE ITEM CURSOR '            20400000
172000                                            TO PV-DB2-OPERATION   20410000
172100             PERFORM 9200-SQL-ABEND                               20420000
172200     END-EVALUATE.                                                20430000
172300                                                                  20440000
172400******************************************************************20450000
172500*  CREATE AN OUTPUT RECORD FOR AN ECOMMERCE GIFT WRAP OR SHIPPING*20460000
172600*  LINE ITEM.                                                    *20470000
172700******************************************************************20480000
172800 4700-PROCESS-OUTPUT-RECORD.                                      20490000
173000                                                                  20500000
173100     INITIALIZE                   TX006-TAX-AUDIT-RECORD.         20510000
173200     MOVE PV-SHIP-ST-CODE         TO TX006-ST-CDE.                20520000
173300     MOVE PV-SHIP-ZIP-CODE        TO TX006-ZIP-CDE.               20530000
173400     MOVE PV-SHIP-GEO-CODE        TO TX006-GEO-CDE.               20540000
173500     MOVE PV-STR-NBR-9            TO TX006-STR-NBR.               20550000
173600     MOVE PV-ORD-DTE              TO TX006-ORDER-DTE.             20560000
173700     MOVE PV-POS-CCYY-MM-DD       TO TX006-PROCESS-DTE.           20570000
173800     MOVE PV-TAX-RATE-PCT         TO TX006-TAX-RT-PCT.            20580000
173900     MOVE PV-UPC                  TO TX006-MDSE-ID.               20590000
174000     MOVE EPTRN-PARTN-NBR         TO TX006-PARTITION.             20600000
174100     MOVE EPTRN-RGST-ID           TO TX006-RGST-ID.               20610000
174200     MOVE EPTRN-TRN-NBR           TO TX006-TRN-NBR.               20620000
174300     MOVE EPTRN-STRT-TM           TO TX006-START-TIME.            20630000
174400     MOVE EPTRN-SLS-CORR-SEQ-NBR  TO TX006-SLS-CORR-SEQ-NBR.      20640000
174500     MOVE EPTRN-TRN-TYP-CDE        TO TX006-TRN-TYP-CDE.          20650000
174600     MOVE EPTRN-POS-CPBL-LVL-NBR   TO TX006-POS-CPBL-LVL-NBR.     20660000
174700     MOVE EPORD-ORD-NBR-TEXT      TO TX006-ECOMMERCE-ORDER-NUMBER.20670000
174800     IF PV-DEPT-NBR NUMERIC                                       20680000
174900         MOVE PV-DEPT-NBR         TO TX006-DEPT-NBR               20690000
175000     ELSE                                                         20700000
175100         MOVE ZERO                TO TX006-DEPT-NBR               20710000
175200     END-IF.                                                      20720000
175300     IF PV-SUB-CL-NBR NUMERIC                                     20730000
175400         MOVE PV-SUB-CL-NBR       TO TX006-SUB-CL-NBR             20740000
175500     ELSE                                                         20750000
175600         MOVE PV-SUB-CL-NBR       TO TX006-SUB-CL-NBR             20760000
175700     END-IF.                                                      20770000
175800     MOVE PV-SKU-NBR              TO TX006-SKU-NBR.               20780000
175900* SHIPPING CHARGES                                                20790000
176000     IF PV-SKU-NBR = SPACES AND                                   20800000
176100        PV-DEPT-NBR = 850 AND                                     20810000
176200        PV-SUB-CL-NBR = 10                                        20820000
176300        MOVE PC-SHIPPING-CHARGE TO TX006-SKU-NBR                  20830000
176400     END-IF.                                                      20840000
176500* GIFT WRAPPING                                                   20850000
176600     IF PV-SKU-NBR = SPACES AND                                   20860000
176700        PV-DEPT-NBR = 850 AND                                     20870000
176800        PV-SUB-CL-NBR = 20                                        20880000
176900        MOVE PC-GIFT-WRAPPING TO TX006-SKU-NBR                    20890000
177000     END-IF.                                                      20900000
177100                                                                  20910000
177200     MOVE +1 TO TX006-SLD-QTY.                                    20920000
177300                                                                  20930000
177400     IF PV-WORK-AMOUNT < 0                                        20940000
177500         SET TX006-CREDIT-YES  TO TRUE                            20950000
177600         COMPUTE PV-WORK-AMOUNT  = PV-WORK-AMOUNT                 20960000
177700                                 * -1                             20970000
177800         END-COMPUTE                                              20980000
177900         IF PV-TX-AMT < 0                                         20990000
178000             COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT             21000000
178100                                          * -1                    21010000
178200             END-COMPUTE                                          21020000
178300         ELSE                                                     21030000
178400             COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT             21040000
178500                                          *  1                    21050000
178600             END-COMPUTE                                          21060000
178700         END-IF                                                   21070000
178800     ELSE                                                         21080000
178900         SET TX006-CREDIT-NO   TO TRUE                            21090000
179000         IF PV-TX-AMT < 0                                         21100000
179100             COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT             21110000
179200                                          * -1                    21120000
179300             END-COMPUTE                                          21130000
179400         ELSE                                                     21140000
179500             COMPUTE TX006-TX-AMT ROUNDED = PV-TX-AMT             21150000
179600                                          *  1                    21160000
179700             END-COMPUTE                                          21170000
179800         END-IF                                                   21180000
179900     END-IF.                                                      21190000
180000                                                                  21200000
180100     MOVE PV-WORK-AMOUNT   TO TX006-TAXABLE-AMT.                  21210000
180200                                                                  21220000
180300     MOVE EPTAX-TX-EXMPT-ID TO TX006-TAX-EXMPT-ID.                21230000
180400                                                                  21240000
180500     IF TX006-TX-AMT = ZERO                                       21250000
180600         SET TX006-EXEMPT-YES          TO TRUE                    21260000
180700         SET TX006-SALES-AMOUNT-PASSED TO TRUE                    21270000
180800     ELSE                                                         21280000
180900         SET TX006-EXEMPT-NO           TO TRUE                    21290000
181000         SET TX006-TAX-AMOUNT-PASSED   TO TRUE                    21300000
181100     END-IF.                                                      21310000
181200                                                                  21320000
C76279     PERFORM 5600-POPULATE-TRNTYP-OUTPUT.                         21330000
C76279                                                                  21340000
181300     IF TX006-TAXABLE-AMT > ZERO OR TX006-TX-AMT > ZERO           21350000
181400          PERFORM 8000-WRITE-TX-RECORD                            21360000
181500     END-IF.                                                      21370000
181600                                                                  21380000
STCFEE***************************************************************** 24900011
STCFEE* DETERMINES THE TOTAL TAXABLE FEES REFUNDED WITH AN ITEM.        24910011
STCFEE***************************************************************** 24920011
STCFEE 5450-DETERMINE-TXBL-FEE-AMT.                                     24930011
STCFEE                                                                  24940011
STCFEE     EXEC SQL                                                     24950011
STCFEE       SELECT  SUM(SRVC_AMT)                                      24960011
STCFEE         INTO  :EPLIS-SRVC-AMT                                    24970011
STCFEE         FROM  TEPLIS                                             24980011
STCFEE        WHERE  PARTN_NBR          = :EPTRN-PARTN-NBR              24990011
STCFEE          AND  STR_NBR            = :EPTRN-STR-NBR                25000011
STCFEE          AND  RGST_ID            = :EPTRN-RGST-ID                25010011
STCFEE          AND  TRN_NBR            = :EPTRN-TRN-NBR                25020011
STCFEE          AND  STRT_TM            = :EPTRN-STRT-TM                25030011
STCFEE          AND  SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR       25040011
STCFEE          AND  LNE_ITM_SEQ_NBR    = :EPITM-LNE-ITM-SEQ-NBR        25050011
STCFEE          AND  SRVC_TYP_CDE       = 'F'                           25060011
STCFEE          AND  FEE_TXBL_IND       = 'Y'                           25070046
STCFEE       WITH UR                                                    25080011
STCFEE     END-EXEC.                                                    25090011
STCFEE                                                                  25100011
STCFEE     EVALUATE TRUE                                                25110011
STCFEE         WHEN SQLCODE = ZERO                                      25120011
STCFEE            CONTINUE                                              25130047
STCFEE         WHEN SQLCODE = +100 OR -305                              25140011
STCFEE            MOVE ZEROES  TO  EPLIS-SRVC-AMT                       25150011
STCFEE                                                                  25160011
STCFEE         WHEN OTHER                                               25170011
STCFEE             DISPLAY ' '                                          25180011
STCFEE             DISPLAY 'PARTN_NBR        = ' EPTRN-PARTN-NBR        25190011
STCFEE             DISPLAY 'STR_NBR          = ' EPTRN-STR-NBR          25200011
STCFEE             DISPLAY 'RGST_ID          = ' EPTRN-RGST-ID          25210011
STCFEE             DISPLAY 'TRN_NBR          = ' EPTRN-TRN-NBR          25220011
STCFEE             DISPLAY 'STRT_TM          = ' EPTRN-STRT-TM          25230011
STCFEE             DISPLAY 'SLS_CORR_SEQ_NBR = ' EPTRN-SLS-CORR-SEQ-NBR 25240011
STCFEE             DISPLAY 'LNE_ITM_SEQ_NBR  = ' EPITM-LNE-ITM-SEQ-NBR  25250011
STCFEE             DISPLAY '*****************************'              25260011
STCFEE                                                                  25270011
STCFEE             MOVE '5450-DETERMINE-TXBL-FEE-AMT'                   25280011
STCFEE                                           TO PV-PARAGRAPH-NAME   25290011
STCFEE             MOVE 'ERROR ON TEPLIS SELECT' TO PV-DB2-OPERATION    25300011
STCFEE                                                                  25310011
STCFEE             PERFORM 9200-SQL-ABEND                               25320011
STCFEE     END-EVALUATE.                                                25330011
STCFEE                                                                  25340011
227680                                                                  25350011
227690******************************************************************25360000
227691* FORMAT THE TAX REFUND TRANSACTION.  PUT THE NET CHARGED AMOUNT *25370000
227692* IN THE TAX AMOUNT BUCKET.                                      *25380000
227693******************************************************************25390000
227694 5500-PROCESS-TAX-REFUND.                                         25400000
227695                                                                  25410000
227696     INITIALIZE                       TX006-TAX-AUDIT-RECORD.     25420000
227697     MOVE PV-SHIP-ST-CODE          TO TX006-ST-CDE.               25430000
227698     MOVE PV-SHIP-ZIP-CODE         TO TX006-ZIP-CDE.              25440000
227699     MOVE PV-SHIP-GEO-CODE         TO TX006-GEO-CDE.              25450000
227700     MOVE PV-STR-NBR-9             TO TX006-STR-NBR.              25460000
227800     MOVE EPTRN-TRN-DTE            TO TX006-ORDER-DTE.            25470000
227900     MOVE PV-POS-CCYY-MM-DD        TO TX006-PROCESS-DTE.          25480000
228000     MOVE EPTRN-PARTN-NBR          TO TX006-PARTITION.            25490000
228100     MOVE EPTRN-RGST-ID            TO TX006-RGST-ID.              25500000
228200     MOVE EPTRN-TRN-NBR            TO TX006-TRN-NBR.              25510000
228300     MOVE EPTRN-STRT-TM            TO TX006-START-TIME.           25520000
228400     MOVE EPTRN-SLS-CORR-SEQ-NBR   TO TX006-SLS-CORR-SEQ-NBR.     25530000
228500     MOVE EPTRN-TRN-TYP-CDE        TO TX006-TRN-TYP-CDE.          25540000
228600     MOVE EPTRN-POS-CPBL-LVL-NBR   TO TX006-POS-CPBL-LVL-NBR.     25550000
228700     MOVE EPITM-LNE-ITM-SEQ-NBR    TO TX006-LNE-ITM-SEQ-NBR.      25560000
228800     IF EPITM-DEPT-NBR NUMERIC                                    25570000
228900         MOVE EPITM-DEPT-NBR       TO TX006-DEPT-NBR              25580000
229000     ELSE                                                         25590000
229100         MOVE ZERO                 TO TX006-DEPT-NBR              25600000
229200     END-IF.                                                      25610000
229300     MOVE EPITM-MAJ-CL-NBR         TO TX006-MAJ-CL-NBR.           25620000
229400     IF EPITM-SUB-CL-NBR NUMERIC                                  25630000
229500         MOVE EPITM-SUB-CL-NBR     TO TX006-SUB-CL-NBR            25640000
229600     ELSE                                                         25650000
229700         MOVE ZERO                 TO TX006-SUB-CL-NBR            25660000
229800     END-IF.                                                      25670000
229900     MOVE EPITM-SKU-NBR            TO TX006-SKU-NBR.              25680000
STCFEE     MOVE EPITM-TX-PRD-CDE-DESC-TEXT TO TX006-TAXWARE-PROD-CDE.   25690046
230100                                                                  25700000
230200     IF EPITM-NET-CHRGD-AMT < 0                                   25710000
230300         SET TX006-CREDIT-YES      TO TRUE                        25720000
230400         COMPUTE PV-WORK-AMOUNT =                                 25730000
230500                 EPITM-NET-CHRGD-AMT * -1                         25740000
230600         END-COMPUTE                                              25750000
230700     ELSE                                                         25760000
230800         SET TX006-CREDIT-NO       TO TRUE                        25770000
230900         MOVE EPITM-NET-CHRGD-AMT  TO PV-WORK-AMOUNT              25780000
231000     END-IF.                                                      25790000
231100     MOVE PV-WORK-AMOUNT           TO TX006-TX-AMT.               25800000
231200     SET TX006-EXEMPT-NO           TO TRUE.                       25810000
231300     SET TX006-TAX-AMOUNT-PASSED   TO TRUE.                       25820000
231400                                                                  25830000
231500     PERFORM 8000-WRITE-TX-RECORD.                                25840000
231600                                                                  25850000
C76279******************************************************************25860000
C76279* SET THE TRANSACTION TYPE FOR THE OUTPUT RECORD BEFORE THE WRITE*25870000
C76279******************************************************************25880000
C76279 5600-POPULATE-TRNTYP-OUTPUT.                                     25890000
C76279                                                                  25900000
C76279     EVALUATE TRUE                                                25910000
C76279         WHEN PS-OMNI-CHNL-IND = 'Y'                              25920000
C76279              IF  PS-SFS                                          25930000
C76279                  SET TX006-TRAN-IND-SFS  TO TRUE                 25940000
C76279              END-IF                                              25950000
C76279*             IF  PS-BPS                                          25960066
C76279*                 SET TX006-TRAN-IND-BPS  TO TRUE                 25970066
C76279*             END-IF                                              25980066
C76279              IF  PS-OTH                                          25990000
C76279                  SET TX006-TRAN-IND-OTH  TO TRUE                 26000000
C76279              END-IF                                              26010000
C76279         WHEN PS-OMNI-CHNL-IND = 'N'                              26020000
C76279              SET TX006-TRAN-IND-OTH      TO TRUE                 26030000
C76279     END-EVALUATE.                                                26040000
C76279                                                                  26050000
231700******************************************************************26060000
231800* OPEN THE SPECIAL SERVICES CURSOR.                              *26070000
231900******************************************************************26080000
232000 7210-OPEN-SSFEES-CURSOR.                                         26090000
232100                                                                  26100000
232200     EXEC SQL                                                     26110000
232300         OPEN SSFEES-CSR                                          26120000
232400     END-EXEC.                                                    26130000
232500                                                                  26140000
232600     EVALUATE SQLCODE                                             26150000
232700         WHEN ZERO                                                26160000
232800             CONTINUE                                             26170000
232900         WHEN OTHER                                               26180000
233000             MOVE '7210-OPEN-SSFEES-CURSOR' TO PV-PARAGRAPH-NAME  26190000
233100             MOVE 'ERROR ON OPENING SSFEES CURSOR '               26200000
233200                                            TO PV-DB2-OPERATION   26210000
233300             PERFORM 9200-SQL-ABEND                               26220000
233400     END-EVALUATE.                                                26230000
233500                                                                  26240000
233600***************************************************************** 26250000
233700*  FETCH THE SPECIAL SERVICE FEE INFORMATION                      26260000
233800***************************************************************** 26270000
233900 7220-FETCH-SSFEES-CURSOR.                                        26280000
234000                                                                  26290000
234100     EXEC SQL                                                     26300000
234200         FETCH SSFEES-CSR                                         26310000
234300           INTO :EPLIS-LNE-ITM-SEQ-NBR                            26320000
234400               ,:EPLIS-SRVC-SEQ-NBR                               26330000
234500               ,:EPLIS-SRVC-TYP-CDE                               26340000
234600               ,:EPLIS-SRVC-AMT                                   26350000
234700               ,:EPLIS-TX-RT-PCT                                  26360000
234800               ,:EPLIS-TX-AMT                                     26370000
234900     END-EXEC.                                                    26380000
235000                                                                  26390000
235100     EVALUATE SQLCODE                                             26400000
235200         WHEN ZERO                                                26410000
235300             CONTINUE                                             26420000
235400         WHEN +100                                                26430000
235500             SET PS-END-OF-SSFEES-CURSOR  TO TRUE                 26440000
235600         WHEN OTHER                                               26450000
235700             MOVE '7220-FETCH-SSFEES-CURSOR' TO PV-PARAGRAPH-NAME 26460000
235800             MOVE 'ERROR ON FETCHING SSFEES CURSOR '              26470000
235900                                             TO PV-DB2-OPERATION  26480000
236000             PERFORM 9200-SQL-ABEND                               26490000
236100     END-EVALUATE.                                                26500000
236200                                                                  26510000
236300***************************************************************** 26520000
236400*  CLOSE THE SPECIAL SERVICES FEES CURSOR                         26530000
236500***************************************************************** 26540000
236600 7230-CLOSE-SSFEES-CURSOR.                                        26550000
236700                                                                  26560000
236800     EXEC SQL                                                     26570000
236900         CLOSE SSFEES-CSR                                         26580000
237000     END-EXEC.                                                    26590000
237100                                                                  26600000
237200     EVALUATE SQLCODE                                             26610000
237300         WHEN ZERO                                                26620000
237400             CONTINUE                                             26630000
237500         WHEN OTHER                                               26640000
237600             MOVE '7230-CLOSE-SSFEES-CURSOR' TO PV-PARAGRAPH-NAME 26650000
237700             MOVE 'ERROR ON CLOSING SSFEES CURSOR '               26660000
237800                                             TO PV-DB2-OPERATION  26670000
237900             PERFORM 9200-SQL-ABEND                               26680000
238000     END-EVALUATE.                                                26690000
238100                                                                  26700000
C76279                                                                  26710014
238200***************************************************************** 27530000
238300*  OPEN THE SHIPPING CHARGES CURSOR                               27540000
238400***************************************************************** 27550000
238500 7310-OPEN-SHIP-CURSOR.                                           27560000
238600                                                                  27570000
239400     EXEC SQL                                                     27580000
239500         OPEN SHIP-CSR                                            27590000
239600     END-EXEC.                                                    27600000
239700                                                                  27610000
239800     EVALUATE SQLCODE                                             27620000
239900         WHEN ZERO                                                27630000
240000             CONTINUE                                             27640000
240100         WHEN OTHER                                               27650000
240200             MOVE '7310-OPEN-SHIP-CURSOR'   TO PV-PARAGRAPH-NAME  27660000
240300             MOVE 'ERROR ON OPENING SHIP CURSOR '                 27670000
240400                                            TO PV-DB2-OPERATION   27680000
240500             PERFORM 9200-SQL-ABEND                               27690000
240600     END-EVALUATE.                                                27700000
240700                                                                  27710000
240800***************************************************************** 27720000
240900*  FETCH THE SHIPPING CHARGES INFORMATION                         27730000
241000***************************************************************** 27740000
241100 7320-FETCH-SHIP-CURSOR.                                          27750000
241200                                                                  27760000
241300     EXEC SQL                                                     27770000
241400         FETCH SHIP-CSR                                           27780000
241500          INTO :EPSHP-SHIP-TYP-CDE                                27790000
241600              ,:EPSHP-SHIP-CHRG-AMT                               27800000
241700              ,:EPSHP-ZIP-5-CDE                                   27810000
241800              ,:EPSHP-TX-RT-PCT                                   27820000
241900              ,:EPSHP-TX-AMT                                      27830000
242000              ,:EPSHP-TX-GEOG-CDE                                 27840000
C92405              ,:EPSHP-PLND-SHIPT-NBR                              27850000
242100     END-EXEC.                                                    27860000
242200                                                                  27870000
242300                                                                  27880000
242400     EVALUATE SQLCODE                                             27890000
242500         WHEN ZERO                                                27900000
242620             CONTINUE                                             27910000
242630         WHEN +100                                                27920000
242640             SET PS-END-OF-SHIP-CURSOR  TO TRUE                   27930000
242650         WHEN OTHER                                               27940000
242660             MOVE '7320-FETCH-SHIP-CURSOR'  TO PV-PARAGRAPH-NAME  27950000
242670             MOVE 'ERROR ON FETCHING SHIP CURSOR '                27960000
242680                                            TO PV-DB2-OPERATION   27970000
242690             PERFORM 9200-SQL-ABEND                               27980000
242700     END-EVALUATE.                                                27990000
242800                                                                  28000000
242900***************************************************************** 28010000
243000*  CLOSE THE SHIPPING CHARGES CURSOR                              28020000
243100***************************************************************** 28030000
243200 7330-CLOSE-SHIP-CURSOR.                                          28040000
243300                                                                  28050000
243400     EXEC SQL                                                     28060000
243500         CLOSE SHIP-CSR                                           28070000
243600     END-EXEC.                                                    28080000
243700                                                                  28090000
243800     EVALUATE SQLCODE                                             28100000
243900         WHEN ZERO                                                28110000
244000             CONTINUE                                             28120000
244100         WHEN OTHER                                               28130000
244200             MOVE '7330-CLOSE-SHIP-CURSOR'  TO PV-PARAGRAPH-NAME  28140000
244300             MOVE 'ERROR ON CLOSING SHIP CURSOR '                 28150000
244400                                            TO PV-DB2-OPERATION   28160000
244500             PERFORM 9200-SQL-ABEND                               28170000
244600     END-EVALUATE.                                                28180000
244700                                                                  28190000
244800******************************************************************28200000
244900*  FOR SHIPPING AND GIFT WRAP - SEARCH THE WORKING STORAGE TABLE  28210000
245000*  FOR THE DEPT SUBCLASS AND SKU SEQUENCE NUMBER.                 28220000
245100******************************************************************28230000
245200 7400-READ-DEPT-CLASS-TABLE.                                      28240000
245300                                                                  28250000
245400     SET AR012-INDX                TO 1.                          28260000
245500     SEARCH AR012-SPECIAL-SERVICE-TABLE VARYING AR012-INDX        28270000
245600         AT END PERFORM 9150-DEPT-CLASS-ERROR                     28280000
245700       WHEN PV-SRVC-TYP-CDE = AR012-SRVC-TYP-CDE (AR012-INDX)     28290000
245800             MOVE AR012-DEPT-NBR  (AR012-INDX)                    28300000
245900                                   TO PV-DEPT-NBR                 28310000
246000             MOVE AR012-SUB-CL-NBR (AR012-INDX)                   28320000
246100                                   TO PV-SUB-CL-NBR               28330000
246200             MOVE AR012-UPC-NBR     (AR012-INDX)                  28340000
246300                                   TO PV-UPC                      28350000
246400             MOVE AR012-SKU-NBR     (AR012-INDX)                  28360000
246500                                   TO PV-SKU-NBR                  28370000
246600             MOVE PV-SKU-NBR       TO PV-SKU                      28380000
246700     END-SEARCH.                                                  28390000
246800                                                                  28400000
246900******************************************************************28410000
247000*  GET THE ORIGINAL TRANSACTION FOR THE RETURN.  GET THE STORE   *28420000
247100*  INFORMATION FOR THE ORIGINAL TRANSACTION.                     *28430000
247200******************************************************************28440000
247300 7500-GET-ORIG-TRANS-INFO.                                        28450000
247400                                                                  28460000
247700     PERFORM 7510-GET-ORIG-TRANSACTION.                           28470000
247800     IF PS-NON-RECEIPTED-RETURN                                   28480000
247900         MOVE EPTRN-STR-NBR              TO PV-WORK-STR-NBR       28490000
248000     ELSE                                                         28500000
248100         MOVE EPIRT-ORIG-STR-NBR         TO PV-WORK-STR-NBR       28510000
248310         PERFORM 8100-SEARCH-FOR-STORE-INFO                       28520000
248320         IF PS-END-OF-ECOM-TABLE                                  28530000
248330             PERFORM 8200-GET-STORE-INFO                          28540000
248340         END-IF                                                   28550000
248350         PERFORM 7530-GET-ORIG-PARTN-NBR                          28560000
TMPFIX         IF  PS-NON-RECEIPTED-RETURN                              28570000
                   SET PS-ORIG-SALES-DATE-NOT-FOUND TO TRUE             28580000
TMPFIX             PERFORM 7531-GET-ORIG-SALES-DATE                     28590000
TMPFIX             IF PS-ORIG-SALES-DATE-FOUND                          28600000
TMPFIX                   MOVE EPIRT-ORIG-SLS-DTE TO PV-TRN-DTE          28610000
TMPFIX                   MOVE PV-SLS-DTE-WRK TO EPIRT-ORIG-SLS-DTE      28620000
TMPFIX                   SET PS-RECEIPTED-RETURN     TO TRUE            28630000
TMPFIX                   PERFORM 7530-GET-ORIG-PARTN-NBR                28640000
TMPFIX             END-IF                                               28650000
TMPFIX         END-IF                                                   28660000
248350                                                                  28670000
248360         IF PV-BUS-LOC-IND = 'Y'                                  28680000
248370             SET PS-ECOMMERCE-RETURN     TO TRUE                  28690000
248380         ELSE                                                     28700000
248390             SET PS-NOT-ECOMMERCE-RETURN TO TRUE                  28710000
248400         END-IF                                                   28720000
248500         SET PS-TEPECX-EXISTS-NO TO TRUE                          28730000
CHG859         PERFORM 7538-TEPECX-PART-FETCH                           28740000
248600         PERFORM 7540-CHECK-FOR-TEPECX                            28750000
248700         IF PS-TEPECX-EXISTS-YES                                  28760000
TMPFIX                   SET PS-RECEIPTED-RETURN     TO TRUE            28770000
TMPFIX             SET PS-ECOMMERCE-RETURN TO TRUE                      28780000
248900         ELSE                                                     28790000
249000             SET PS-NOT-ECOMMERCE-RETURN TO TRUE                  28800000
249100         END-IF                                                   28810000
249400     END-IF.                                                      28820000
249500                                                                  28830000
249600     IF PS-NON-RECEIPTED-RETURN                                   28840000
249700         MOVE EPTRN-STR-NBR              TO PV-WORK-STR-NBR       28850000
249800         IF PS-ECOMMERCE-STORE                                    28860000
249810             SET PS-ECOMMERCE-RETURN TO TRUE                      28870000
249820         END-IF                                                   28880000
249830     END-IF.                                                      28890000
249840                                                                  28900000
249850***************************************************************** 28910000
249860*  GET THE ORIGINAL TRANSACTION INFORMATION FROM TEPIRT         * 28920000
249870***************************************************************** 28930000
249880 7510-GET-ORIG-TRANSACTION.                                       28940000
249890                                                                  28950000
249900     EXEC SQL                                                     28960000
250000             SELECT ORIG_SLS_DTE                                  28970000
250100                   ,ORIG_STR_NBR                                  28980000
250200                   ,ORIG_RGST_ID                                  28990000
250300                   ,ORIG_TRN_NBR                                  29000000
250400                   ,ORIG_STRT_TM                                  29010000
250500                   ,ORIG_LNE_ITM_NBR                              29020000
250600             INTO  :EPIRT-ORIG-SLS-DTE                            29030000
250700                  ,:EPIRT-ORIG-STR-NBR                            29040000
250800                  ,:EPIRT-ORIG-RGST-ID                            29050000
250900                  ,:EPIRT-ORIG-TRN-NBR                            29060000
251000                  ,:EPIRT-ORIG-STRT-TM                            29070000
251100                  ,:EPIRT-ORIG-LNE-ITM-NBR                        29080000
251200             FROM TEPIRT A                                        29090000
251300             WHERE PARTN_NBR          = :EPTRN-PARTN-NBR          29100000
251400               AND STR_NBR            = :EPTRN-STR-NBR            29110000
251500               AND RGST_ID            = :EPTRN-RGST-ID            29120000
251600               AND TRN_NBR            = :EPTRN-TRN-NBR            29130000
251700               AND A.STRT_TM          = :EPTRN-STRT-TM            29140000
251800               AND A.SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR   29150000
251900               AND A.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR    29160000
252000               WITH UR                                            29170000
252100     END-EXEC.                                                    29180000
252200                                                                  29190000
252300     EVALUATE SQLCODE                                             29200000
252400         WHEN ZERO                                                29210000
252500             SET PS-RECEIPTED-RETURN     TO TRUE                  29220000
252600         WHEN +100                                                29230000
252700             SET PS-NON-RECEIPTED-RETURN TO TRUE                  29240000
252800             MOVE EPTRN-STR-NBR         TO PV-WORK-STR-NBR        29250000
252900         WHEN OTHER                                               29260000
253000             MOVE '7510-GET-ORIG-TRANSACTION'                     29270000
253100                                            TO PV-PARAGRAPH-NAME  29280000
253110             DISPLAY EPIRT-ORIG-STRT-TM                           29290000
253200             MOVE 'ERROR ON GETTING RETURN CURSOR '               29300000
253300                                            TO PV-DB2-OPERATION   29310000
253400             PERFORM 9200-SQL-ABEND                               29320000
253500     END-EVALUATE.                                                29330000
253600                                                                  29340000
253700***************************************************************** 29350000
253800*  GET THE ORIGINAL PARTITION NUMBER FOR A RETURN PROCESSED AT  * 29360000
253900*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 29370000
254000*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              29380000
254100***************************************************************** 29390000
254200 7530-GET-ORIG-PARTN-NBR.                                         29400000
254300                                                                  29410000
254400     EXEC SQL                                                     29420000
254500          SELECT  P.PARTN_NBR                                     29430000
254610                 ,TRN_DTE                                         29440000
254700          INTO    :PV-ORIG-PARTN-NBR                              29450000
254810                 ,:PV-TRN-DTE                                     29460000
254900          FROM TEPTRN T, TEPPART P                                29470000
255000         WHERE P.SLS_DTE = :EPIRT-ORIG-SLS-DTE                    29480000
255010         AND T.PARTN_NBR= P.PARTN_NBR                             29490000
255020         AND T.STR_NBR            = :EPIRT-ORIG-STR-NBR           29500000
255030         AND T.RGST_ID      = :EPIRT-ORIG-RGST-ID                 29510000
255040         AND T.TRN_NBR      = :EPIRT-ORIG-TRN-NBR                 29520000
TMPFIX*        AND T.STRT_TM    = :EPIRT-ORIG-STRT-TM                   29530000
255060         AND T.SLS_CORR_SEQ_NBR = ( SELECT MAX(SLS_CORR_SEQ_NBR)  29540000
255070                          FROM TEPTRN S                           29550000
255080                        WHERE                                     29560000
255090                S.PARTN_NBR=T.PARTN_NBR                           29570000
255091              AND S.STR_NBR = T.STR_NBR                           29580000
255092              AND S.RGST_ID = T.RGST_ID                           29590000
255093              AND S.TRN_NBR = T.TRN_NBR                           29600000
255094              AND S.STRT_TM = T.STRT_TM)                          29610000
255100         WITH UR                                                  29620000
255200     END-EXEC.                                                    29630000
255300                                                                  29640000
255400     EVALUATE SQLCODE                                             29650000
255500         WHEN ZERO                                                29660000
255600             CONTINUE                                             29670000
255700         WHEN -811                                                29680000
255800             DISPLAY EPIRT-ORIG-SLS-DTE ' '                       29690000
255900                     'MORE THAN ONE PARTITION FOR PROCESSING DAY' 29700000
256000             SET PS-NON-RECEIPTED-RETURN TO TRUE                  29710000
256100             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       29720000
256200         WHEN +100                                                29730000
256300             SET PS-NON-RECEIPTED-RETURN TO TRUE                  29740000
256400             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       29750000
256500         WHEN OTHER                                               29760000
256600             MOVE 'PARAGRAPH 7530-GET-ORIG-PARTN-NBR'             29770000
256700                                            TO PV-PARAGRAPH-NAME  29780000
256800             PERFORM 9200-SQL-ABEND                               29790000
256900     END-EVALUATE.                                                29800000
257000                                                                  29810000
TMPFIX***************************************************************** 29820000
TMPFIX*  GET THE ORIGINAL PARTITION NUMBER FOR A RETURN PROCESSED AT  * 29830000
TMPFIX*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 29840000
TMPFIX*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              29850000
TMPFIX***************************************************************** 29860000
TMPFIX 7531-GET-ORIG-SALES-DATE.                                        29870000
TMPFIX                                                                  29880000
TMPFIX     EXEC SQL                                                     29890000
TMPFIX          SELECT  E.SLS_DTE                                       29900000
TMPFIX          INTO    :PV-SLS-DTE-WRK                                 29910000
TMPFIX          FROM TEPECX E, TEPPART P                                29920000
TMPFIX         WHERE P.SLS_DTE = :EPIRT-ORIG-SLS-DTE                    29930000
TMPFIX         AND E.ORD_PARTN_NBR= P.PARTN_NBR                         29940000
TMPFIX         AND E.STR_NBR      = :EPIRT-ORIG-STR-NBR                 29950000
TMPFIX         AND E.RGST_ID      = :EPIRT-ORIG-RGST-ID                 29960000
TMPFIX         AND E.TRN_NBR      = :EPIRT-ORIG-TRN-NBR                 29970000
TMPFIX*        AND E.STRT_TM    = :EPIRT-ORIG-STRT-TM                   29980000
TMPFIX         WITH UR                                                  29990000
TMPFIX     END-EXEC.                                                    30000000
TMPFIX                                                                  30010000
TMPFIX     EVALUATE SQLCODE                                             30020000
TMPFIX         WHEN ZERO                                                30030000
TMPFIX             SET PS-ORIG-SALES-DATE-FOUND   TO TRUE               30040000
TMPFIX         WHEN -811                                                30050000
TMPFIX             DISPLAY EPIRT-ORIG-SLS-DTE ' '                       30060000
TMPFIX                     'MORE THAN ONE PARTITION FOR PROCESSING DAY' 30070000
TMPFIX             SET PS-NON-RECEIPTED-RETURN TO TRUE                  30080000
TMPFIX             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       30090000
TMPFIX         WHEN +100                                                30100000
TMPFIX             SET PS-ORIG-SALES-DATE-NOT-FOUND   TO TRUE           30110000
TMPFIX         WHEN OTHER                                               30120000
TMPFIX             MOVE 'PARAGRAPH 7530-GET-ORIG-PARTN-NBR'             30130000
TMPFIX                                            TO PV-PARAGRAPH-NAME  30140000
TMPFIX             PERFORM 9200-SQL-ABEND                               30150000
TMPFIX     END-EVALUATE.                                                30160000
257010***************************************************************** 30170000
257020*  GET THE ORDER PARTITION NUMBER FOR A RETURN PROCESSED AT  *    30180000
257030*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 30190000
257040*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              30200000
CHG859***************************************************************** 30210000
CHG859 7538-TEPECX-PART-FETCH.                                          30220000
CHG859***************************************************************** 30230000
CHG859     EXEC SQL                                                     30240000
CHG859          SELECT  PARTN_NBR                                       30250000
CHG859          INTO    :PV-ORD-PARTN-NBR                               30260000
CHG859          FROM TEPPART                                            30270000
CHG859         WHERE SLS_DTE = :PV-TRN-DTE                              30280000
CHG859         WITH UR                                                  30290000
CHG859     END-EXEC.                                                    30300000
CHG859                                                                  30310000
CHG859     EVALUATE SQLCODE                                             30320000
CHG859         WHEN ZERO                                                30330000
CHG859             CONTINUE                                             30340000
CHG859         WHEN -811                                                30350000
CHG859             DISPLAY EPIRT-ORIG-SLS-DTE ' '                       30360000
CHG859                     'MORE THAN ONE PARTITION FOR PROCESSING DAY' 30370000
CHG859             SET PS-NON-RECEIPTED-RETURN TO TRUE                  30380000
CHG859             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       30390000
CHG859         WHEN +100                                                30400000
CHG859             SET PS-NON-RECEIPTED-RETURN TO TRUE                  30410000
CHG859             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       30420000
CHG859         WHEN OTHER                                               30430000
CHG859             MOVE 'PARAGRAPH 7538-TEPECX-PART-FETCH '             30440000
CHG859                                            TO PV-PARAGRAPH-NAME  30450000
CHG859             PERFORM 9200-SQL-ABEND                               30460000
CHG859     END-EVALUATE.                                                30470000
257130***************************************************************** 30480000
257200*  LOOK FOR A TEPECX ROW FOR THE ORIGINAL TRANSACTION.          * 30490000
257300*  IF A ROW IS FOUND, THEN THE ORIGINAL TRANSACTION WAS AN ECOM * 30500000
257400*  TRANSACTION, ELSE, IT WAS NOT.                               * 30510000
257500***************************************************************** 30520000
257600 7540-CHECK-FOR-TEPECX.                                           30530000
257700                                                                  30540000
257800     EXEC SQL                                                     30550000
257900          SELECT  1                                               30560000
258000          INTO    :PS-TEPECX-EXISTS-SW                            30570000
258100          FROM TEPECX                                             30580000
258200         WHERE ORD_PARTN_NBR =  :PV-ORD-PARTN-NBR                 30590000
258300           AND STR_NBR       =  :EPIRT-ORIG-STR-NBR               30600000
258400           AND RGST_ID       =  :EPIRT-ORIG-RGST-ID               30610000
258500           AND TRN_NBR       =  :EPIRT-ORIG-TRN-NBR               30620000
TMPFIX*          AND STRT_TM       =  :EPIRT-ORIG-STRT-TM               30630000
258610         WITH UR                                                  30640000
258620     END-EXEC.                                                    30650000
258630                                                                  30660000
258640     EVALUATE SQLCODE                                             30670000
258650         WHEN ZERO                                                30680000
               WHEN -811                                                30690000
258660             CONTINUE                                             30700000
258670         WHEN +100                                                30710000
258680             CONTINUE                                             30720000
258690         WHEN OTHER                                               30730000
258700             MOVE 'PARAGRAPH 7540-CHECK-FOR-TEPECX'               30740000
258701                                            TO PV-PARAGRAPH-NAME  30750000
258702             PERFORM 9200-SQL-ABEND                               30760000
258703     END-EVALUATE.                                                30770000
258704                                                                  30780000
258705***************************************************************** 30790000
258706*  GET THE GEO INFORMATION                                        30800000
258707***************************************************************** 30810000
258708 7600-GET-GEO-INFO.                                               30820000
258709                                                                  30830000
258710     EXEC SQL                                                     30840000
258720       SELECT  B.ZIP_5_CDE                                        30850000
258730              ,B.TX_GEOG_CDE                                      30860000
258740        INTO  :EPSHP-ZIP-5-CDE                                    30870000
258750             ,:EPSHP-TX-GEOG-CDE                                  30880000
258760        FROM TEPIPS  A                                            30890000
258770            ,TEPSHP  B                                            30900000
258780        WHERE A.PARTN_NBR        = :EPTRN-PARTN-NBR               30910000
258790          AND A.STR_NBR          = :EPTRN-STR-NBR                 30920000
258800          AND A.RGST_ID          = :EPTRN-RGST-ID                 30930000
258900          AND A.TRN_NBR          = :EPTRN-TRN-NBR                 30940000
259000          AND A.STRT_TM          = :EPTRN-STRT-TM                 30950000
259100          AND B.SLS_CORR_SEQ_NBR                                  30960000
259110             = ( SELECT MAX(SLS_CORR_SEQ_NBR)                     30970000
259120                          FROM TEPIPS S                           30980000
259130                        WHERE                                     30990000
259140                S.PARTN_NBR=A.PARTN_NBR                           31000000
259150              AND S.STR_NBR = A.STR_NBR                           31010000
259160              AND S.RGST_ID = A.RGST_ID                           31020000
259170              AND S.TRN_NBR = A.TRN_NBR                           31030000
259180              AND S.STRT_TM = A.STRT_TM)                          31040000
259200          AND A.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR         31050000
259300          AND A.PARTN_NBR        = B.PARTN_NBR                    31060000
259400          AND A.STR_NBR          = B.STR_NBR                      31070000
259500          AND A.RGST_ID          = B.RGST_ID                      31080000
259600          AND A.TRN_NBR          = B.TRN_NBR                      31090000
259700          AND A.STRT_TM          = B.STRT_TM                      31100000
259800          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             31110000
259900          AND A.PLND_SHIPT_NBR   = B.PLND_SHIPT_NBR               31120000
260000          WITH UR                                                 31130000
260100     END-EXEC.                                                    31140000
260400                                                                  31150000
260500     EVALUATE SQLCODE                                             31160000
260600         WHEN ZERO                                                31170000
260700*TDH001 - PULLED GEO DATA FROM FIRST ROW                          31180000
260800         WHEN -811                                                31190000
260900             MOVE SPACES             TO PV-SHIP-ST-CODE           31200000
P10237             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          31210000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    31220000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     31230000
P10237                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          31240000
P10237             ELSE                                                 31250000
P10237                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          31260000
P10237             END-IF                                               31270000
261300             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          31280000
CHG859             SET PS-SHIP-CODE-FOUND TO TRUE                       31290000
261400         WHEN +100                                                31300000
CHG859            SET PS-SHIP-CODE-NOT-FOUND TO TRUE                    31310000
262000         WHEN OTHER                                               31320000
262100             MOVE '7600-GET-GEO-CURSOR'                           31330000
262200                                            TO PV-PARAGRAPH-NAME  31340000
262300             MOVE 'ERROR ON GETTING GEO CURSOR '                  31350000
262400                                            TO PV-DB2-OPERATION   31360000
262500             PERFORM 9200-SQL-ABEND                               31370000
262600     END-EVALUATE.                                                31380000
262700                                                                  31390000
262800***************************************************************** 31400000
273700* NOTE:  THE ORIG-LNE-ITM-SEQ-NBR ON TEPIRT IS ONLY SET WHEN    * 31940000
273800* A GIFT RECEIPT WAS GENERATED WITH THE TRANSACTION.  IF        * 31950000
273900* ORIG-LNE-ITN-SEQ-NBR IS ZERO, GET THE ITEM FROM TEPITM.       * 31960000
274000*                                                               * 31970000
274400***************************************************************** 31980000
274500 7800-GET-RETURN-INFO.                                            31990000
274600                                                                  32000000
274700     IF EPIRT-ORIG-LNE-ITM-NBR > ZERO                             32010000
275100         PERFORM 7820-GET-OPERATING-SHIP-INFO                     32020000
TMPFIX             IF PS-NON-RECEIPTED-RETURN                           32030000
TMPFIX               PERFORM  7821-GET-OPERATING-SHIP-MISS              32040000
TMPFIX             END-IF                                               32050000
275300     ELSE                                                         32060000
276900         SET PS-NOT-END-OF-TEPITM-CSR TO TRUE                     32070000
277000         PERFORM 7860-OPEN-TEPITM-CSR                             32080000
277100         PERFORM 7871-FETCH-TEPITM-CSR                            32090000
277200         IF PS-NOT-END-OF-TEPITM-CSR                              32100000
P10237             MOVE PV-ORIG-ZIP-5-CDE  TO PV-ENCR-ZIP-CODE          32110000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    32120000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     32130000
P10237                 MOVE PV-ZIP-CODE    TO PV-SAVE-ZIP-5-CDE         32140000
P10237             ELSE                                                 32150000
P10237                 MOVE SPACES         TO PV-SAVE-ZIP-5-CDE         32160000
P10237             END-IF                                               32170000
277400             MOVE PV-ORIG-GEOG-CDE   TO PV-SAVE-GEOG-CDE          32180000
277500             PERFORM 7870-PROCESS-TEPITM-CSR                      32190000
277600                 UNTIL PS-END-OF-TEPITM-CSR                       32200000
277700         ELSE                                                     32210000
TMPFIX           SET PS-NOT-END-OF-TEPITM-MISS-CSR TO TRUE              32220000
TMPFIX           PERFORM 7883-OPEN-TEPITM-MISS-CSR                      32230000
TMPFIX           PERFORM 7884-FETCH-TEPITM-MISS-CSR                     32240000
TMPFIX           IF PS-NOT-END-OF-TEPITM-MISS-CSR                       32250000
P10237             MOVE PV-ORIG-ZIP-5-CDE  TO PV-ENCR-ZIP-CODE          32260000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    32270000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     32280000
P10237                 MOVE PV-ZIP-CODE    TO PV-SAVE-ZIP-5-CDE         32290000
P10237             ELSE                                                 32300000
P10237                 MOVE SPACES         TO PV-SAVE-ZIP-5-CDE         32310000
P10237             END-IF                                               32320000
TMPFIX             MOVE PV-ORIG-GEOG-CDE   TO PV-SAVE-GEOG-CDE          32330000
TMPFIX             PERFORM 7885-PROCESS-TEPITM-MISS-CSR                 32340000
TMPFIX                 UNTIL PS-END-OF-TEPITM-MISS-CSR                  32350000
TMPFIX           ELSE                                                   32360000
TMPFIX             SET PS-NON-RECEIPTED-RETURN TO TRUE                  32370000
TMPFIX             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       32380000
TMPFIX           END-IF                                                 32390000
TMPFIX            PERFORM 7886-CLOSE-TEPITM-MISS-CSR                    32400000
TMPFIX         END-IF                                                   32410000
TMPFIX         PERFORM 7880-CLOSE-TEPITM-CSR                            32420000
TMPFIX     END-IF.                                                      32430000
278400     MOVE PV-ORIG-TRN-DTE  TO PV-ORD-DTE.                         32440000
285200***************************************************************   32450000
285300* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   32460000
285400***************************************************************   32470000
285500 7820-GET-OPERATING-SHIP-INFO.                                    32480000
285600                                                                  32490000
285700     EXEC SQL                                                     32500000
285800       SELECT  A.TRN_DTE                                          32510000
285900              ,B.TX_RT_PCT                                        32520000
286000              ,B.TX_AMT                                           32530000
286100              ,B.SKU_NBR                                          32540000
286200              ,D.ZIP_5_CDE                                        32550000
286300              ,D.TX_GEOG_CDE                                      32560000
286400        INTO  :PV-ORIG-TRN-DTE                                    32570000
286500             ,:PV-ORIG-TX-RT-PCT                                  32580000
286600             ,:PV-ORIG-TX-AMT                                     32590000
286700             ,:PV-SKU-C                                           32600000
286800             ,:EPSHP-ZIP-5-CDE                                    32610000
286900             ,:EPSHP-TX-GEOG-CDE                                  32620000
287000        FROM TEPTRN  A                                            32630000
287100            ,TEPITM  B                                            32640000
287200            ,TEPIPS  C                                            32650000
287300            ,TEPSHP  D                                            32660000
287400            ,TEPPART P                                            32670000
287500            ,TEPECX  E                                            32680000
287600        WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR             32690000
287700          AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR            32700000
287800          AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID            32710000
287900          AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR            32720000
288000          AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM            32730000
288100          AND B.LNE_ITM_SEQ_NBR  = :EPIRT-ORIG-LNE-ITM-NBR        32740000
288200          AND A.PARTN_NBR        = B.PARTN_NBR                    32750000
288300          AND A.STR_NBR          = B.STR_NBR                      32760000
288400          AND A.RGST_ID          = B.RGST_ID                      32770000
288500          AND A.TRN_NBR          = B.TRN_NBR                      32780000
288600          AND A.STRT_TM          = B.STRT_TM                      32790000
288700          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             32800000
288900          AND A.STR_NBR          = E.STR_NBR                      32810000
289000          AND A.RGST_ID          = E.RGST_ID                      32820000
289100          AND A.TRN_NBR          = E.TRN_NBR                      32830000
289200          AND A.STRT_TM          = E.STRT_TM                      32840000
289300          AND B.PARTN_NBR        = C.PARTN_NBR                    32850000
289400          AND B.STR_NBR          = C.STR_NBR                      32860000
289410          AND B.RGST_ID          = C.RGST_ID                      32870000
289420          AND B.TRN_NBR          = C.TRN_NBR                      32880000
289430          AND B.STRT_TM          = C.STRT_TM                      32890000
289440          AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR             32900000
289450          AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR              32910000
289460          AND C.PARTN_NBR        = D.PARTN_NBR                    32920000
289470          AND C.STR_NBR          = D.STR_NBR                      32930000
289480          AND C.RGST_ID          = D.RGST_ID                      32940000
289490          AND C.TRN_NBR          = D.TRN_NBR                      32950000
289500          AND C.STRT_TM          = D.STRT_TM                      32960000
289600          AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR             32970000
289700          AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR               32980000
289800          AND E.ORD_PARTN_NBR    = :PV-ORD-PARTN-NBR              32990000
289900          AND P.SLS_DTE          = E.SLS_DTE                      33000000
289900          AND P.STR_GP_CDE       = 'A'                            33010048
290000          WITH UR                                                 33020000
290100     END-EXEC.                                                    33030000
290400                                                                  33040000
290500     EVALUATE SQLCODE                                             33050000
290600         WHEN ZERO                                                33060000
                    SET  PS-RECEIPTED-RETURN   TO TRUE                  33070000
290700             MOVE SPACES             TO PV-SHIP-ST-CODE           33080000
P10237             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          33090000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    33100000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     33110000
P10237                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          33120000
P10237             ELSE                                                 33130000
P10237                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          33140000
P10237             END-IF                                               33150000
291100             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          33160000
291200             MOVE PV-SKU-C           TO PV-SKU                    33170000
291300         WHEN +100                                                33180000
291400             SET PS-NON-RECEIPTED-RETURN TO TRUE                  33190000
291500             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       33200000
291600         WHEN OTHER                                               33210000
291700             MOVE '7820-GET-OPERATING-SHIP-INFO'                  33220000
291800                                            TO PV-PARAGRAPH-NAME  33230000
291900             MOVE 'ERROR SELECTING FROM TEPSHP'                   33240000
292000                                            TO PV-DB2-OPERATION   33250000
292100             PERFORM 9200-SQL-ABEND                               33260000
292200     END-EVALUATE.                                                33270000
292300                                                                  33280000
TMPFIX***************************************************************   33290000
TMPFIX* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   33300000
TMPFIX***************************************************************   33310000
TMPFIX 7821-GET-OPERATING-SHIP-MISS.                                    33320000
TMPFIX                                                                  33330000
TMPFIX     EXEC SQL                                                     33340000
TMPFIX       SELECT  A.TRN_DTE                                          33350000
TMPFIX              ,B.TX_RT_PCT                                        33360000
TMPFIX              ,B.TX_AMT                                           33370000
TMPFIX              ,B.SKU_NBR                                          33380000
TMPFIX              ,D.ZIP_5_CDE                                        33390000
TMPFIX              ,D.TX_GEOG_CDE                                      33400000
TMPFIX        INTO  :PV-ORIG-TRN-DTE                                    33410000
TMPFIX             ,:PV-ORIG-TX-RT-PCT                                  33420000
TMPFIX             ,:PV-ORIG-TX-AMT                                     33430000
TMPFIX             ,:PV-SKU-C                                           33440000
TMPFIX             ,:EPSHP-ZIP-5-CDE                                    33450000
TMPFIX             ,:EPSHP-TX-GEOG-CDE                                  33460000
TMPFIX        FROM TEPTRN  A                                            33470000
TMPFIX            ,TEPITM  B                                            33480000
TMPFIX            ,TEPSHP  D                                            33490000
TMPFIX            ,TEPPART P                                            33500000
TMPFIX            ,TEPECX  E                                            33510000
TMPFIX        WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR             33520000
TMPFIX          AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR            33530000
TMPFIX          AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID            33540000
TMPFIX          AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR            33550000
TMPFIX          AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM            33560000
TMPFIX          AND B.SKU_NBR          = :PV-SKU-NBR                    33570000
TMPFIX*         AND B.LNE_ITM_SEQ_NBR  = :EPIRT-ORIG-LNE-ITM-NBR        33580000
TMPFIX          AND A.PARTN_NBR        = B.PARTN_NBR                    33590000
TMPFIX          AND A.STR_NBR          = B.STR_NBR                      33600000
TMPFIX          AND A.RGST_ID          = B.RGST_ID                      33610000
TMPFIX          AND A.TRN_NBR          = B.TRN_NBR                      33620000
TMPFIX          AND A.STRT_TM          = B.STRT_TM                      33630000
TMPFIX          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             33640000
TMPFIX          AND A.STR_NBR          = E.STR_NBR                      33650000
TMPFIX          AND A.RGST_ID          = E.RGST_ID                      33660000
TMPFIX          AND A.TRN_NBR          = E.TRN_NBR                      33670000
TMPFIX          AND A.STRT_TM          = E.STRT_TM                      33680000
TMPFIX          AND B.PARTN_NBR        = D.PARTN_NBR                    33690000
TMPFIX          AND B.STR_NBR          = D.STR_NBR                      33700000
TMPFIX          AND B.RGST_ID          = D.RGST_ID                      33710000
TMPFIX          AND B.TRN_NBR          = D.TRN_NBR                      33720000
TMPFIX          AND B.STRT_TM          = D.STRT_TM                      33730000
TMPFIX          AND B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR             33740000
TMPFIX          AND E.ORD_PARTN_NBR    = :PV-ORD-PARTN-NBR              33750000
TMPFIX          AND P.SLS_DTE          = E.SLS_DTE                      33760000
TMPFIX          WITH UR                                                 33770000
TMPFIX     END-EXEC.                                                    33780000
TMPFIX                                                                  33790000
TMPFIX     EVALUATE SQLCODE                                             33800000
TMPFIX         WHEN ZERO                                                33810000
TMPFIX         WHEN -811                                                33820000
TMPFIX             SET  PS-RECEIPTED-RETURN   TO TRUE                   33830000
TMPFIX             MOVE SPACES             TO PV-SHIP-ST-CODE           33840000
P10237             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          33850000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    33860000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     33870000
P10237                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          33880000
P10237             ELSE                                                 33890000
P10237                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          33900000
P10237             END-IF                                               33910000
TMPFIX             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          33920000
TMPFIX             MOVE PV-SKU-C           TO PV-SKU                    33930000
TMPFIX         WHEN +100                                                33940000
TMPFIX             SET PS-NON-RECEIPTED-RETURN TO TRUE                  33950000
TMPFIX             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       33960000
TMPFIX         WHEN OTHER                                               33970000
TMPFIX             MOVE '7821-GET-OPERATING-SHIP-INFO-MISS'             33980000
TMPFIX                                            TO PV-PARAGRAPH-NAME  33990000
TMPFIX             MOVE 'ERROR SELECTING FROM TEPSHP'                   34000000
TMPFIX                                            TO PV-DB2-OPERATION   34010000
TMPFIX             PERFORM 9200-SQL-ABEND                               34020000
TMPFIX     END-EVALUATE.                                                34030000
TMPFIX                                                                  34040000
301100***************************************************************   34050000
301200*  OPEN TEPITM CURSOR.                                        *   34060000
301300***************************************************************   34070000
301400 7860-OPEN-TEPITM-CSR.                                            34080000
301500                                                                  34090000
301600     EXEC SQL                                                     34100000
301700         OPEN TEPITM-CSR                                          34110000
301800     END-EXEC.                                                    34120000
301900                                                                  34130000
302000     EVALUATE SQLCODE                                             34140000
302100         WHEN ZERO                                                34150000
302200             CONTINUE                                             34160000
302300         WHEN OTHER                                               34170000
302400             MOVE '7850-OPEN-TEPITM-CSR'                          34180000
302500                                            TO PV-PARAGRAPH-NAME  34190000
302600             MOVE 'ERROR OPENING TEPITM CURSOR '                  34200000
302700                                            TO PV-DB2-OPERATION   34210000
302800             PERFORM 9200-SQL-ABEND                               34220000
302900     END-EVALUATE.                                                34230000
303000                                                                  34240000
303100***************************************************************   34250000
303200*  THE TEPITM CURSOR FETCHES ALL LINE ITEMS ON THE ORIGINAL   *   34260000
303300*  TRANSACTION THAT ARE THE SAME ITEM THAT WAS RETURNED.      *   34270000
303400*  USE THE ZIP CODE AND GEO CODE ON THE FIRST ITEM FOUND THAT *   34280000
303500*  HAS THE SAME TAX RATE.  IF THERE IS NO MATCHING TAX RATE   *   34290000
303600*  USE ZIP CODE AND GEO CODE ON THE FIRST LINE ITEM.          *   34300000
303700***************************************************************   34310000
303800 7870-PROCESS-TEPITM-CSR.                                         34320000
303900                                                                  34330000
304000     IF PV-ORIG-TX-RT-PCT = PV-TAX-RATE-PCT                       34340000
304100         MOVE SPACES            TO PV-SHIP-ST-CODE                34350000
P10237         MOVE PV-ORIG-ZIP-5-CDE TO PV-ENCR-ZIP-CODE               34360000
P10237         IF  PV-ENCR-ZIP-CODE NOT = SPACES                        34370000
P10237             PERFORM 8400-PROCESS-ZIP-CDE                         34380000
P10237             MOVE PV-ZIP-CODE   TO PV-SHIP-ZIP-CODE               34390000
P10237         ELSE                                                     34400000
P10237             MOVE SPACES        TO PV-SHIP-ZIP-CODE               34410000
P10237         END-IF                                                   34420000
304500         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               34430000
304600         SET PS-END-OF-TEPITM-CSR TO TRUE                         34440000
304700     ELSE                                                         34450000
304800         PERFORM 7871-FETCH-TEPITM-CSR                            34460000
304900     END-IF.                                                      34470000
305000                                                                  34480000
305100***************************************************************   34490000
305200*  FETCH TEPITM CURSOR.                                       *   34500000
305300***************************************************************   34510000
305400 7871-FETCH-TEPITM-CSR.                                           34520000
305500                                                                  34530000
305600     EXEC SQL                                                     34540000
305700         FETCH TEPITM-CSR                                         34550000
305800          INTO :PV-ORIG-TRN-DTE                                   34560000
305900              ,:PV-ORIG-TX-RT-PCT                                 34570000
306000              ,:PV-ORIG-TX-AMT                                    34580000
306100              ,:PV-SKU-C                                          34590000
306200              ,:PV-ORIG-ZIP-5-CDE                                 34600000
306300              ,:PV-ORIG-GEOG-CDE                                  34610000
306400     END-EXEC.                                                    34620000
306500                                                                  34630000
306600     EVALUATE SQLCODE                                             34640000
306700         WHEN ZERO                                                34650000
306800             CONTINUE                                             34660000
306900         WHEN +100                                                34670000
307000             SET PS-END-OF-TEPITM-CSR TO TRUE                     34680000
307100             MOVE SPACES            TO  PV-SHIP-ST-CODE           34690000
307200             MOVE PV-SAVE-ZIP-5-CDE TO  PV-SHIP-ZIP-CODE          34700000
307600             MOVE PV-SAVE-GEOG-CDE  TO  PV-SHIP-GEO-CODE          34710000
307700             MOVE PV-SKU-C          TO  PV-SKU                    34720000
307800         WHEN OTHER                                               34730000
307900             MOVE '7861-FETCH-TEPITM-CSR'   TO PV-PARAGRAPH-NAME  34740000
308000             MOVE 'ERROR FETCHING TEPITM CURSOR '                 34750000
308100                                            TO PV-DB2-OPERATION   34760000
308200             PERFORM 9200-SQL-ABEND                               34770000
308300     END-EVALUATE.                                                34780000
308400                                                                  34790000
308500***************************************************************   34800000
308600*  CLOSE TEPITM CURSOR.                                       *   34810000
308700***************************************************************   34820000
308800 7880-CLOSE-TEPITM-CSR.                                           34830000
308900                                                                  34840000
309000     EXEC SQL                                                     34850000
309100         CLOSE TEPITM-CSR                                         34860000
309200     END-EXEC.                                                    34870000
309300                                                                  34880000
309400     EVALUATE SQLCODE                                             34890000
309500         WHEN ZERO                                                34900000
309600             CONTINUE                                             34910000
309700         WHEN OTHER                                               34920000
309800             MOVE '7870-CLOSE-TEPITM-CSR'   TO PV-PARAGRAPH-NAME  34930000
309900             MOVE 'ERROR CLOSING TEPITM CURSOR '                  34940000
310000                                            TO PV-DB2-OPERATION   34950000
310100             PERFORM 9200-SQL-ABEND                               34960000
310200     END-EVALUATE.                                                34970000
TMPFIX***************************************************************   34980000
TMPFIX*  OPEN TEPITM CURSOR.                                        *   34990000
TMPFIX***************************************************************   35000000
TMPFIX 7883-OPEN-TEPITM-MISS-CSR.                                       35010000
TMPFIX                                                                  35020000
TMPFIX     EXEC SQL                                                     35030000
TMPFIX         OPEN TEPITM-MISS-CSR                                     35040000
TMPFIX     END-EXEC.                                                    35050000
TMPFIX                                                                  35060000
TMPFIX     EVALUATE SQLCODE                                             35070000
TMPFIX         WHEN ZERO                                                35080000
TMPFIX             CONTINUE                                             35090000
TMPFIX         WHEN OTHER                                               35100000
TMPFIX             MOVE '7883-OPEN-TEPITM-MISS-CSR'                     35110000
TMPFIX                                            TO PV-PARAGRAPH-NAME  35120000
TMPFIX             MOVE 'ERROR OPENING TEPITM MISS CURSOR '             35130000
TMPFIX                                            TO PV-DB2-OPERATION   35140000
TMPFIX             PERFORM 9200-SQL-ABEND                               35150000
TMPFIX     END-EVALUATE.                                                35160000
TMPFIX***************************************************************   35170000
TMPFIX*  FETCH TEPITM MISS CURSOR                                      *35180000
TMPFIX***************************************************************   35190000
TMPFIX 7884-FETCH-TEPITM-MISS-CSR.                                      35200000
TMPFIX                                                                  35210000
TMPFIX     EXEC SQL                                                     35220000
TMPFIX         FETCH TEPITM-MISS-CSR                                    35230000
TMPFIX          INTO :PV-ORIG-TRN-DTE                                   35240000
TMPFIX              ,:PV-ORIG-TX-RT-PCT                                 35250000
TMPFIX              ,:PV-ORIG-TX-AMT                                    35260000
TMPFIX              ,:PV-SKU-C                                          35270000
TMPFIX              ,:PV-ORIG-ZIP-5-CDE                                 35280000
TMPFIX              ,:PV-ORIG-GEOG-CDE                                  35290000
TMPFIX     END-EXEC.                                                    35300000
TMPFIX                                                                  35310000
TMPFIX     EVALUATE SQLCODE                                             35320000
TMPFIX         WHEN ZERO                                                35330000
TMPFIX             CONTINUE                                             35340000
TMPFIX         WHEN +100                                                35350000
TMPFIX             SET PS-END-OF-TEPITM-MISS-CSR TO TRUE                35360000
TMPFIX             MOVE SPACES            TO  PV-SHIP-ST-CODE           35370000
TMPFIX             MOVE PV-SAVE-ZIP-5-CDE TO  PV-SHIP-ZIP-CODE          35380000
TMPFIX             MOVE PV-SAVE-GEOG-CDE  TO  PV-SHIP-GEO-CODE          35390000
TMPFIX             MOVE PV-SKU-C          TO  PV-SKU                    35400000
TMPFIX         WHEN OTHER                                               35410000
TMPFIX             MOVE '7884-FETCH-TEPITM-MISS-CSR'                    35420000
TMPFIX                                            TO PV-PARAGRAPH-NAME  35430000
TMPFIX             MOVE 'ERROR FETCHING TEPITM CURSOR '                 35440000
TMPFIX                                            TO PV-DB2-OPERATION   35450000
TMPFIX             PERFORM 9200-SQL-ABEND                               35460000
TMPFIX     END-EVALUATE.                                                35470000
TMPFIX***************************************************************   35480000
TMPFIX*  THE TEPITM CURSOR FETCHES ALL LINE ITEMS ON THE ORIGINAL   *   35490000
TMPFIX*  TRANSACTION THAT ARE THE SAME ITEM THAT WAS RETURNED.      *   35500000
TMPFIX*  USE THE ZIP CODE AND GEO CODE ON THE FIRST ITEM FOUND THAT *   35510000
TMPFIX*  HAS THE SAME TAX RATE.  IF THERE IS NO MATCHING TAX RATE   *   35520000
TMPFIX*  USE ZIP CODE AND GEO CODE ON THE FIRST LINE ITEM.          *   35530000
TMPFIX***************************************************************   35540000
TMPFIX 7885-PROCESS-TEPITM-MISS-CSR.                                    35550000
TMPFIX                                                                  35560000
TMPFIX     IF PV-ORIG-TX-RT-PCT = PV-TAX-RATE-PCT                       35570000
TMPFIX         MOVE SPACES            TO PV-SHIP-ST-CODE                35580000
P10237         MOVE PV-ORIG-ZIP-5-CDE TO PV-ENCR-ZIP-CODE               35590000
P10237         IF  PV-ENCR-ZIP-CODE NOT = SPACES                        35600000
P10237             PERFORM 8400-PROCESS-ZIP-CDE                         35610000
P10237             MOVE PV-ZIP-CODE   TO PV-SHIP-ZIP-CODE               35620000
P10237         ELSE                                                     35630000
P10237             MOVE SPACES        TO PV-SHIP-ZIP-CODE               35640000
P10237         END-IF                                                   35650000
TMPFIX         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               35660000
TMPFIX         SET PS-END-OF-TEPITM-MISS-CSR TO TRUE                    35670000
TMPFIX     ELSE                                                         35680000
TMPFIX         PERFORM 7884-FETCH-TEPITM-MISS-CSR                       35690000
TMPFIX     END-IF.                                                      35700000
TMPFIX                                                                  35710000
TMPFIX***************************************************************   35720000
TMPFIX*  CLOSE TEPITM MISS CURSOR.                                  *   35730000
TMPFIX***************************************************************   35740000
TMPFIX 7886-CLOSE-TEPITM-MISS-CSR.                                      35750000
TMPFIX                                                                  35760000
TMPFIX     EXEC SQL                                                     35770000
TMPFIX         CLOSE TEPITM-MISS-CSR                                    35780000
TMPFIX     END-EXEC.                                                    35790000
TMPFIX                                                                  35800000
TMPFIX     EVALUATE SQLCODE                                             35810000
TMPFIX         WHEN ZERO                                                35820000
TMPFIX             CONTINUE                                             35830000
TMPFIX         WHEN OTHER                                               35840000
TMPFIX             MOVE '7886-CLOSE-TEPITM-MISS-CSR'                    35850000
TMPFIX                                            TO PV-PARAGRAPH-NAME  35860000
TMPFIX             MOVE 'ERROR CLOSING TEPITM MISS CURSOR '             35870000
TMPFIX                                            TO PV-DB2-OPERATION   35880000
TMPFIX             PERFORM 9200-SQL-ABEND                               35890000
TMPFIX     END-EVALUATE.                                                35900000
TMPFIX                                                                  35910000
TMPFIX                                                                  35920000
310400***************************************************************** 35930000
310500*  GET THE ECOMMERCE ORDER NUMBER                               * 35940000
310600***************************************************************** 35950000
310700 7900-GET-ECOMMERCE-ORDER-NBR.                                    35960000
310800                                                                  35970000
310900     MOVE SPACES TO EPORD-ORD-NBR-TEXT.                           35980000
311000                                                                  35990000
311100     EXEC SQL                                                     36000000
311200           SELECT ORD_NBR                                         36010000
311300           INTO :EPORD-ORD-NBR                                    36020000
311400           FROM TEPORD                                            36030000
311500           WHERE PARTN_NBR        = :EPTRN-PARTN-NBR              36040000
311600             AND STR_NBR          = :EPTRN-STR-NBR                36050000
311700             AND RGST_ID          = :EPTRN-RGST-ID                36060000
311800             AND TRN_NBR          = :EPTRN-TRN-NBR                36070000
311900             AND STRT_TM          = :EPTRN-STRT-TM                36080000
312000             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       36090000
312100             WITH UR                                              36100000
312200     END-EXEC.                                                    36110000
312300                                                                  36120000
312400     EVALUATE SQLCODE                                             36130000
312500         WHEN ZERO                                                36140000
312600             CONTINUE                                             36150000
312700         WHEN +100                                                36160000
312800             MOVE SPACES TO EPORD-ORD-NBR-TEXT                    36170000
312900         WHEN OTHER                                               36180000
313000             MOVE '7900-GET-ECOMMERCE-ORDER-NBR'                  36190000
313100                                            TO PV-PARAGRAPH-NAME  36200000
313200             MOVE 'ERROR GETTING ECOMMERCE ORDER #'               36210000
313300                                            TO PV-DB2-OPERATION   36220000
313400             PERFORM 9200-SQL-ABEND                               36230000
313500     END-EVALUATE.                                                36240000
313600                                                                  36250000
313700******************************************************************36260000
313800*  IF THE RECORD IS A LATE VOID, FLIP THE CREDIT INDICATOR SO IT *36270000
313900*  IS THE OPPOSITE OF THE VALUE FOR THE VOIDED TRANSACTION.      *36280000
314000*  WRITE A REFORMATTED ACCOUNTS RECEIVABLE TRANSACTION RECORD.   *36290000
314100******************************************************************36300000
314200 8000-WRITE-TX-RECORD.                                            36310000
314400                                                                  36320000
314500     IF EPTRN-VOID-ABRT-CDE = 'V'                                 36330000
314600         IF TX006-CREDIT-YES                                      36340000
314700            SET TX006-CREDIT-NO  TO TRUE                          36350000
314800         ELSE                                                     36360000
314900            SET TX006-CREDIT-YES TO TRUE                          36370000
315000         END-IF                                                   36380000
315100         SET TX006-VOID-TRANSACTION TO TRUE                       36390000
315200     END-IF.                                                      36400000
315300                                                                  36410000
315400     WRITE TAX-EXTRACT-RECORD                                     36420000
315500         FROM TX006-TAX-AUDIT-RECORD.                             36430000
315600                                                                  36440000
315700******************************************************************36450000
315800*  CHECK TABLE WHEN CHANGE IN STORE NUMBER TO SEE IF ECOMMERCE    36460000
315900*  STORE BEFORE GETTING INFORMATION FROM XST_LOC.                 36470000
316000******************************************************************36480000
316100 8100-SEARCH-FOR-STORE-INFO.                                      36490000
316200                                                                  36500000
316300     SET EC-IDX                    TO 1.                          36510000
316400     SET PS-NOT-END-OF-ECOM-TABLE  TO TRUE.                       36520000
316500     SEARCH EC-ECOM-STORE-TABLE-ENTRIES VARYING EC-IDX            36530000
316600         AT END                                                   36540000
316700             SET PS-END-OF-ECOM-TABLE      TO TRUE                36550000
316800         WHEN PV-WORK-STR-NBR = EC-STR-NBR (EC-IDX)               36560000
316900             MOVE EC-BUS-LOC-IND  (EC-IDX) TO PV-BUS-LOC-IND      36570000
317000             MOVE EC-ST-CDE       (EC-IDX) TO PV-SHIP-ST-CODE     36580000
317100                                              PV-SAVE-ST-CODE     36590000
317200             MOVE EC-ZIP-CODE     (EC-IDX) TO PV-SHIP-ZIP-CODE    36600000
317300                                              PV-SAVE-ZIP-CDE     36610000
317340             MOVE EC-GEO-CODE     (EC-IDX) TO PV-SHIP-GEO-CODE    36620000
317350             MOVE EC-ROUND-IND    (EC-IDX) TO PV-ROUND-IND        36630000
317360     END-SEARCH.                                                  36640000
317370                                                                  36650000
317380****************************************************************  36660000
317390*  OPEN THE ECOMMERCE INDICATOR CURSOR                            36670000
317400****************************************************************  36680000
317500 8200-GET-STORE-INFO.                                             36690000
317600                                                                  36700000
317700                                                                  36710000
317800     EXEC SQL                                                     36720000
317900       SELECT A.ZIP_10_CDE                                        36730000
318000             ,A.ST_CDE                                            36740000
318100             ,A.E_BUS_IND                                         36750000
318200             ,B.ST_TX_RND_MTHD_CDE                                36760000
318300             ,COALESCE(C.GEO_CDE, '00')                           36770000
318400             ,COALESCE(C.TX_ALT_ZIP_10_CDE, :PC-SPACES)           36780000
318500        INTO :XST00001-ZIP-10-CDE                                 36790000
318600            ,:XST00001-ST-CDE                                     36800000
318700            ,:XST00001-E-BUS-IND                                  36810000
318800            ,:TSTATE-ST-TX-RND-MTHD-CDE                           36820000
318900            ,:XST00025-GEO-CDE                                    36830000
319000            ,:XST00025-TX-ALT-ZIP-10-CDE                          36840000
319100       FROM XST_LOC A                                             36850000
319200          , TSTATE  B                                             36860000
319300          , XST_LOC_ATTR C                                        36870000
319400       WHERE A.ST_CDE  =   B.STATE_CODE                           36880000
319500         AND A.LOC_NBR =   C.LOC_NBR                              36890000
319600         AND A.LOC_NBR =  :PV-WORK-STR-NBR                        36900000
319700       WITH UR                                                    36910000
319800     END-EXEC.                                                    36920000
319900                                                                  36930000
320000     EVALUATE SQLCODE                                             36940000
320100         WHEN ZERO                                                36950000
320200             MOVE PV-WORK-STR-NBR  TO EC-STR-NBR (EC-IDX2)        36960000
320300             MOVE XST00001-ZIP-10-CDE (1:5)                       36970000
320400                                   TO EC-ZIP-CODE (EC-IDX2)       36980000
320500                                      PV-SHIP-ZIP-CODE            36990000
320600                                      PV-SAVE-ZIP-CDE             37000000
321000             MOVE XST00001-ST-CDE  TO EC-ST-CDE (EC-IDX2)         37010000
321100                                      PV-SHIP-ST-CODE             37020000
321200                                      PV-SAVE-ST-CODE             37030000
321300             MOVE XST00001-E-BUS-IND                              37040000
321400                                   TO EC-BUS-LOC-IND (EC-IDX2)    37050000
321500                                      PV-BUS-LOC-IND              37060000
321600             MOVE TSTATE-ST-TX-RND-MTHD-CDE                       37070000
321700                                   TO EC-ROUND-IND   (EC-IDX2)    37080000
321800                                      PV-ROUND-IND                37090000
321900             IF XST00025-GEO-CDE = SPACES                         37100000
322000                MOVE 'N'         TO EC-GEO-FOUND-IND (EC-IDX2)    37110000
322100                MOVE '00'        TO EC-GEO-CODE (EC-IDX2)         37120000
322200                                    PV-SHIP-GEO-CODE              37130000
322300             ELSE                                                 37140000
322400                MOVE XST00025-GEO-CDE TO EC-GEO-CODE (EC-IDX2)    37150000
322500                                         PV-SHIP-GEO-CODE         37160000
322600                                         PV-SAVE-GEO-CDE          37170000
322700             END-IF                                               37180000
322800                                                                  37190000
322900             IF XST00025-TX-ALT-ZIP-10-CDE = SPACES               37200000
323000               CONTINUE                                           37210000
323100             ELSE                                                 37220000
323200               IF XST00025-TX-ALT-ZIP-10-CDE (1:5) NUMERIC        37230000
323300                 MOVE XST00025-TX-ALT-ZIP-10-CDE                  37240000
323400                                   TO EC-ZIP-CODE (EC-IDX2)       37250000
323500                                      PV-SHIP-ZIP-CODE            37260000
323900               END-IF                                             37270000
324000             END-IF                                               37280000
324100                                                                  37290000
324200             MOVE 'Y'            TO EC-GEO-FOUND-IND (EC-IDX2)    37300000
324300             SET EC-IDX2 UP BY 1                                  37310000
324400         WHEN OTHER                                               37320000
324500             MOVE '8200-GET-STORE-INFO'     TO PV-PARAGRAPH-NAME  37330000
324600             MOVE 'ERROR ON GETTING STORE INFO FROM XST_LOC'      37340000
324700                                            TO PV-DB2-OPERATION   37350000
324800             DISPLAY 'STORE NUMBER IS ' PV-WORK-STR-NBR           37360000
324900             PERFORM 9200-SQL-ABEND                               37370000
325000     END-EVALUATE.                                                37380000
CHG859****************************************************************  37390000
CHG859*  PULL THE ECOMMERCE ZIP  CODE                                   37400000
CHG859****************************************************************  37410000
CHG859 8300-SHIP-ZIPCODE.                                               37420000
CHG859     MOVE SPACE TO PV-SHIP-ST-CODE.                               37430000
CHG859     EXEC SQL                                                     37440000
CHG859             SELECT DISTINCT                                      37450000
CHG859                    D.ZIP_5_CDE                                   37460000
CHG859                   ,D.TX_GEOG_CDE                                 37470000
CHG859             INTO                                                 37480000
CHG859                  :EPSHP-ZIP-5-CDE                                37490000
CHG859                 ,:EPSHP-TX-GEOG-CDE                              37500000
CHG859             FROM                                                 37510000
CHG859                 TEPSHP  D                                        37520000
CHG859             WHERE D.PARTN_NBR        =  :EPTRN-PARTN-NBR         37530000
CHG859               AND D.STR_NBR          =  :EPTRN-STR-NBR           37540000
CHG859               AND D.RGST_ID          =  :EPTRN-RGST-ID           37550000
CHG859               AND D.TRN_NBR          =  :EPTRN-TRN-NBR           37560000
CHG859               AND D.STRT_TM          =  :EPTRN-STRT-TM           37570000
CHG859               AND D.SLS_CORR_SEQ_NBR                             37580000
CHG859             = ( SELECT MAX(SLS_CORR_SEQ_NBR)                     37590000
CHG859                          FROM TEPSHP S                           37600000
CHG859                        WHERE                                     37610000
CHG859                S.PARTN_NBR=D.PARTN_NBR                           37620000
CHG859              AND S.STR_NBR = D.STR_NBR                           37630000
CHG859              AND S.RGST_ID = D.RGST_ID                           37640000
CHG859              AND S.TRN_NBR = D.TRN_NBR                           37650000
CHG859              AND S.STRT_TM = D.STRT_TM)                          37660000
CHG859             WITH UR                                              37670000
CHG859      END-EXEC.                                                   37680000
CHG859     EVALUATE SQLCODE                                             37690000
CHG859         WHEN ZERO                                                37700000
CHG859         WHEN -811                                                37710000
CHG859             MOVE SPACES             TO PV-SHIP-ST-CODE           37720000
P10237             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          37730000
P10237             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    37740000
P10237                 PERFORM 8400-PROCESS-ZIP-CDE                     37750000
P10237                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          37760000
P10237             ELSE                                                 37770000
P10237                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          37780000
P10237             END-IF                                               37790000
CHG859             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          37800000
CHG859             SET PS-SHIP-CODE-FOUND  TO TRUE                      37810000
CHG859         WHEN +100                                                37820000
CHG859             SET PS-SHIP-CODE-NOT-FOUND TO TRUE                   37830000
CHG859             MOVE PV-SAVE-ST-CODE    TO PV-SHIP-ST-CODE           37840000
CHG859             MOVE PV-SAVE-ZIP-CDE    TO PV-SHIP-ZIP-CODE          37850000
CHG859             MOVE PV-SAVE-GEO-CDE    TO PV-SHIP-GEO-CODE          37860000
CHG859         WHEN OTHER                                               37870000
CHG859             MOVE '8300-SHIP-ZIPCODE'                             37880000
CHG859                                            TO PV-PARAGRAPH-NAME  37890000
CHG859             MOVE 'ERROR GETTING ZICODE #'                        37900000
CHG859                                            TO PV-DB2-OPERATION   37910000
CHG859             PERFORM 9200-SQL-ABEND                               37920000
CHG859     END-EVALUATE.                                                37930000
CHG859                                                                  37940000
P10237******************************************************************37950000
P10237* SEARCH THE ZIP CODE                                            *37960000
P10237******************************************************************37970000
P10237 8400-PROCESS-ZIP-CDE.                                            37980000
P10237                                                                  37990000
P10237     SET ZP-IDX                      TO 1.                        38000000
P10237     SET PS-NOT-END-OF-ZIP-TABLE     TO TRUE.                     38010000
P10237                                                                  38020000
P10237     SEARCH PV-ZIP-CODE-TABLE-ENTRIES VARYING ZP-IDX              38030000
P10237         AT END                                                   38040000
P10237             SET PS-END-OF-ZIP-TABLE TO TRUE                      38050000
P10237             PERFORM 8500-UNPROTECT-ZIP                           38060000
P10237         WHEN PV-ENCR-ZIP-CODE = ENCRYPT-ZIP (ZP-IDX)             38070000
P10237             MOVE DECRYPT-ZIP (ZP-IDX) TO PV-ZIP-CODE             38080000
P10237     END-SEARCH.                                                  38090000
P10237                                                                  38100000
P10237******************************************************************38110000
P10237*     DECRYPT THE ZIP CODE                                       *38120000
P10237******************************************************************38130000
P10237 8500-UNPROTECT-ZIP.                                              38140000
P10237                                                                  38150000
P10237     PERFORM 8600-BASE64-BINARY.                                  38160000
P10237     PERFORM 8700-DECYRPT-ZIP.                                    38170000
P10237     PERFORM 8800-ASCII-EBCDIC.                                   38180000
P10237     MOVE PV-ENCR-ZIP-CODE     TO ENCRYPT-ZIP (ZP-IDX2).          38190000
P10237     MOVE PV-ZIP-CODE          TO DECRYPT-ZIP (ZP-IDX2).          38200000
P10237     SET ZP-IDX2 UP BY 1.                                         38210000
P10237                                                                  38220000
P10237     IF ZP-IDX2 > PC-ZIP-MAX                                      38230000
P10237         DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME           38240000
P10237         DISPLAY 'INTERNAL ZIP TABLE OVERFLOW'                    38250000
P10237         DISPLAY 'INCREASE THE ZIP TABLE SIZE MORE THAN 99999'    38260000
P10237         SET AC-TABLE-OVERFLOW TO TRUE                            38270000
P10237         CALL 'ILBOABN0' USING AC-ABEND-CODE                      38280000
P10237     END-IF.                                                      38290000
P10237                                                                  38300000
P10237******************************************************************38310000
P10237*     8600-BASE64-BINARY                                         *38320000
P10237*  ==> PROCESSES:                                                *38330000
P10237*     - CONVERTS THE DATA FROM BASE64 TO BINARY FORMAT           *38340000
P10237******************************************************************38350000
P10237 8600-BASE64-BINARY.                                              38360000
P10237                                                                  38370000
P10237     INITIALIZE PV-INPUT-TEXT                                     38380000
P10237                PV-OUTPUT-TEXT                                    38390000
P10237                PV-ZIP-LENGTH.                                    38400000
P10237                                                                  38410000
P10237     MOVE PV-ENCR-ZIP-CODE           TO PV-INPUT-TEXT.            38420000
P10237     INSPECT PV-ENCR-ZIP-CODE TALLYING PV-ZIP-LENGTH              38430000
P10237             FOR CHARACTERS BEFORE INITIAL SPACE.                 38440000
P10237                                                                  38450000
P10237     MOVE PV-ZIP-LENGTH              TO DP022-INLEN.              38460000
P10237     MOVE 18                         TO DP022-OUTLEN-IN.          38470000
P10237                                                                  38480000
P10237     CALL  DP022-MGCXR2B   USING DP022-PARMS,                     38490000
P10237                                 PV-INPUT-TEXT,                   38500000
P10237                                 PV-OUTPUT-TEXT.                  38510000
P10237                                                                  38520000
P10237     IF RETURN-CODE NOT EQUAL 0                                   38530000
P10237        DISPLAY 'ERROR WHILE CONVERTING BASE64 TO BINARY'         38540000
P10237        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  38550000
P10237        DISPLAY 'ENCRYPTED ZIP   - ' PV-ENCR-ZIP-CODE             38560000
P10237        SET AC-CONVERSION-ERROR      TO TRUE                      38570000
P10237        CALL 'ILBOABN0' USING AC-ABEND-CODE                       38580075
P10237     END-IF.                                                      38590000
P10237                                                                  38600000
P10237******************************************************************38610000
P10237*     8700-DECYRPT-ZIP                                            38620000
P10237*  ==> PROCESSES:                                                *38630000
P10237*     - CALLS THE PROTEGRITY MODULE TO DECRYPT THE ZIP CODE      *38640000
P10237*       RETURNED ZIP CODE VALUE WILL BE IN ASCII FORMAT          *38650000
P10237******************************************************************38660000
P10237 8700-DECYRPT-ZIP.                                                38670000
P10237                                                                  38680000
P10237     INITIALIZE CSI-PARAMETERS                                    38690000
P10237                DP031-PROTEG-PGM-PARAMETERS.                      38700000
P10237                                                                  38710000
P10237     MOVE 'ZIP-CODE'                 TO DP031-FIELD.              38720000
P10237     SET CSI-DECRYPT-FUNCTION        TO TRUE.                     38730000
P10237     SET DP031-CUST-INFO             TO TRUE.                     38740000
P10237     MOVE DP022-OUTLEN-OUT           TO CSI-CIPHER-TEXT-LENGTH.   38750000
P10237     MOVE 5                          TO CSI-CLEAR-TEXT-LENGTH.    38760000
P10237     MOVE PV-OUTPUT-TEXT             TO DP031-CIPHER-TEXT.        38770000
P10237                                                                  38780000
P10237     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      38790000
P10237                                                                  38800000
P10237     IF CSI-RETURN-CODE NOT = ZERO                                38810000
P10237        DISPLAY 'ENCRYPTED ZIP      - ' PV-ENCR-ZIP-CODE          38820000
P10237        DISPLAY 'INPUT ZIP LENGTH   - ' PV-ZIP-LENGTH             38830000
P10237        PERFORM DP031-9999-ABEND                                  38840000
P10237     END-IF.                                                      38850000
P10237                                                                  38860000
P10237******************************************************************38870000
P10237*     8800-ASCII-EBCDIC                                          *38880000
P10237*  ==> PROCESSES:                                                *38890000
P10237*     - CONVERTS THE DATA FROM ASCII TO EBCDIC FORMAT            *38900000
P10237******************************************************************38910000
P10237 8800-ASCII-EBCDIC.                                               38920000
P10237                                                                  38930000
P10237     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA.                   38940000
P10237                                                                  38950000
P10237     SET  ASCII-TO-EBCDIC       TO TRUE.                          38960000
P10237     MOVE DP031-CLEAR-TEXT      TO LK52-FROM-AREA.                38970000
P10237     MOVE CSI-CLEAR-TEXT-LENGTH TO LK52-LENGTH.                   38980000
P10237                                                                  38990000
P10237     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            39000000
P10237                                  LK52-LENGTH                     39010000
P10237                                  LK52-FROM-AREA                  39020000
P10237                                  LK52-TO-AREA                    39030000
P10237                                  LK52-RETURN-CODE.               39040000
P10237     IF GOOD-LK52-RET-CODE                                        39050000
P10237        MOVE LK52-TO-AREA            TO PV-ZIP-CODE               39060000
P10237     ELSE                                                         39070000
P10237        DISPLAY 'ERROR WHILE CONVERTING ASCII TO EBCDIC'          39080000
P10237        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             39090000
P10237        DISPLAY 'ENCRYPTED ZIP   - ' PV-ENCR-ZIP-CODE             39100000
P10237        SET AC-CONVERSION-ERROR      TO TRUE                      39110000
P10237        CALL 'ILBOABN0' USING AC-ABEND-CODE                       39120075
P10237     END-IF.                                                      39130000
P10237                                                                  39140000
325200******************************************************************39150000
325300*  CLOSE ALL FILES.                                              *39160000
325400******************************************************************39170000
325500 9000-EOJ-ROUTINE.                                                39180000
325600                                                                  39190000
325700     PERFORM VARYING EC-IDX FROM 1 BY 1                           39200000
325800             UNTIL   EC-IDX > 1000                                39210000
325900        IF EC-GEO-FOUND-IND (EC-IDX) = 'N'                        39220000
326000            DISPLAY 'GEO CODE NOT FOUND FOR STORE '               39230000
326100                    EC-STR-NBR (EC-IDX)                           39240000
326200        END-IF                                                    39250000
326300     END-PERFORM.                                                 39260000
326400                                                                  39270000
326500     CLOSE TAX-EXTRACT-FILE.                                      39280000
326600                                                                  39290000
326700                                                                  39300000
326800***************************************************************** 39310000
326900*  DISPLAY ERROR MESSAGE WHEN A DEPT CLASS ERROR IS ENCOUNTERED.  39320000
327000***************************************************************** 39330000
327100 9150-DEPT-CLASS-ERROR.                                           39340000
327200                                                                  39350000
327300     DISPLAY PC-CURRENT-PROGRAM-NAME                              39360000
327400               ' - DEPT CLASS NOT FOUND FOR SPECIAL SERVICE'.     39370000
P10237     DISPLAY '7400-READ-DEPT-CLASS-TABLE'.                        39380000
327600     DISPLAY 'STORE # ' PV-STR-NBR-9.                             39390000
327700     DISPLAY 'REGISTER # ' PV-RGST-ID-9.                          39400000
327800     DISPLAY 'TRAN # ' PV-TRN-NBR-9.                              39410000
327900     DISPLAY 'SPECIAL SERVICE CODE ' PV-SRVC-TYP-CDE.             39420000
328000                                                                  39430000
328100******************************************************************39440000
328200* 9200-SQL-ABEND                                                  39450000
328300*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.39460000
328400******************************************************************39470000
328500 9200-SQL-ABEND.                                                  39480000
328600                                                                  39490000
328700     DISPLAY '** ABEND        **'.                                39500000
328800     DISPLAY '** PROGRAM      ** = ' PC-CURRENT-PROGRAM-NAME.     39510000
328900     DISPLAY '** PARAGRAPH    ** = ' PV-PARAGRAPH-NAME.           39520000
329000     DISPLAY '** OPERATION    ** = ' PV-DB2-OPERATION.            39530000
329100                                                                  39540000
329200******************************************************************39550000
329300* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     39560000
329400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      39570000
329500******************************************************************39580000
329600     COPY DPPD004.                                                39590000
329700                                                                  39600000
329800     SET AC-DB2-ERROR TO TRUE.                                    39610000
329900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         39620000
330000                                                                  39630000
P10237******************************************************************39640000
P10237*  COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE     * 39650000
P10237*  PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION              * 39660000
P10237******************************************************************39670000
P10237     COPY DPPD031.                                                39680000
P10237                                                                  39690000
