000100*-----------------------*                                                 
000200 IDENTIFICATION DIVISION.                                                 
000300*-----------------------*                                                 
000400 PROGRAM-ID.    TRKCS166.                                                 
000500 AUTHOR.        MIKE FRIESS.                                              
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
000700 DATE-WRITTEN.  JANUARY, 2000.                                            
000800 DATE-COMPILED.                                                           
000900                                                                          
001000*---------------------------------------------------------------*         
001100*    Y166 - BOOKING REFERECE NUMBER LIST.                       *         
001200*                                                               *         
001300*    THIS PROGRAM GENERATES A LIST OF BOOKING DELIVERY DATES,   *         
001400*    ORIGIN SHIPED FROM CODES AND EXTERNAL REFERRENCE NUMBERS.  *         
001600*---------------------------------------------------------------*         
001610*****************************************************************         
001620* DATE  05/16/2011                                                        
001630*  CHANGE MADE: THE NEW SYSTEM OF RECORD FOR OUTER PACK QTY WILL          
001640*  BE RMS AND PUBLISHED TO TPURITM.  CHANGED OUTR-PCK-CSR                 
001650*  TO SELECT  OUTR_PK_QTY FROM TPURITM AND REMOVED JOIN TO TUPC           
001660*  AND TSKXREF.                                                           
001670*  MADE BY: GERMAN BANDA                                                  
001680*****************************************************************         
263697* CHANGED 11/08/2021    BY JIM HUNTER      WR: CHG0263697                 
263697* CHANGE CALL OF DPKUT100 TO CALL DP010I-NUMERIC-EDIT-ROUTINE             
263697* MAKING THE CALL DYNAMIC VS STATIC.                                      
263697*---------------------------------------------------------------*         
CICS  * CHANGED  1/12/2023    BY JIM HUNTER      WR: CHG0278495                 
CICS  * ADD COPYBOOK DPWS930 AND MAKE THE CICS ARCHITECTURE CALL                
CICS  * DYNAMIC INSTEAD OF STATIC BY CALLING DP930-CICS-ARCH-API.               
CICS  *-----------------------------------------------------------------        
001700                                                                          
001800 ENVIRONMENT DIVISION.                                                    
001900                                                                          
002000 DATA DIVISION.                                                           
002100                                                                          
002200 WORKING-STORAGE SECTION.                                                 
002300                                                                          
002401 01  DK-DB2-KEYS.                                                         
002402     15  DK-PO-NBR                      PIC S9(09)  COMP.                 
002403     15  DK-PO-BKG-SEQ-NBR              PIC S9(09)  COMP.                 
002600                                                                          
002700 01  PC-PROGRAM-CONSTANTS.                                                
002800     05  PC-CURRENT-MAP-NAME            PIC  X(08)  VALUE                 
002900                                                    'TR166A  '.           
003000     05  PC-CURRENT-MAPSET-NAME         PIC  X(08)  VALUE                 
003100                                                    'TRKM166 '.           
003200     05  PC-CURRENT-PROGRAM-NAME        PIC  X(08)  VALUE                 
003300                                                    'TRKCS166'.           
003400     05  PC-LIST-QUEUE-SEQ              PIC  9(01)  VALUE 1.              
003500     05  PC-SEL-QUEUE-SEQ               PIC  9(01)  VALUE 2.              
003510     05  PC-LIST-FORMAT                 PIC  X(01)  VALUE '2'.            
003520*---------------------------------------------------------------*         
003530*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
003550*---------------------------------------------------------------*         
003600***  05  PC-ITEMS-PER-PANEL             PIC S9(04)  VALUE +10             
003700***                                                 COMP SYNC.            
003710     05  PC-ITEMS-PER-PANEL             PIC S9(04)  VALUE +09             
003720                                                    COMP SYNC.            
003800     05  PC-MAX-BLOCKS-IN-ARRAY         PIC S9(04)  VALUE +2              
003900                                                    COMP SYNC.            
004000     05  PC-MAX-ITEMS                   PIC S9(09)  VALUE                 
004100                                                    +1000000              
004200                                                    COMP-3.               
004300     05  PC-MSG-NUMBER-LENGTH           PIC S9(04)  VALUE +5              
004400                                                    COMP SYNC.            
004500     05  PC-MAX-RETRIES                 PIC S9(03)  VALUE 3               
004600                                                    COMP-3.               
004700     05  PC-INIT-DATE                   PIC  X(10)  VALUE                 
004800                                                    '0001-01-01'.         
004900     05  PC-TSYMSG-NUMBERS.                                               
005000         10  PC-TSYMSG-00008            PIC  9(05)  VALUE 00008.          
005100         10  PC-TSYMSG-00069            PIC  9(05)  VALUE 00069.          
005200         10  PC-TSYMSG-00070            PIC  9(05)  VALUE 00070.          
005300         10  PC-TSYMSG-00050            PIC  9(05)  VALUE 00050.          
005400         10  PC-TSYMSG-00101            PIC  9(05)  VALUE 00101.          
005500         10  PC-TSYMSG-00279            PIC  9(05)  VALUE 00279.          
005600                                                                          
005700 01  PS-PROGRAM-SWITCHES.                                                 
005800     05  PS-ERROR-SW                    PIC  X(01)  VALUE 'Y'.            
005900         88  PS-NO-ERROR                            VALUE 'Y'.            
006000         88  PS-ERROR                               VALUE 'N'.            
006100     05  PS-COMMAREA-SW                 PIC  X(01)  VALUE 'N'.            
006200         88  PS-COMMAREA-VALID                      VALUE 'Y'.            
006300         88  PS-COMMAREA-NOT-VALID                  VALUE 'N'.            
006400                                                                          
006500 01  PV-PROGRAM-VARIABLES.                                                
006600     05  PV-DEPT-NBR                    PIC  X(04).                       
006700     05  PV-DEPT-NBR-N REDEFINES                                          
006701         PV-DEPT-NBR                    PIC S9(04).                       
006702     05  PV-SUB                         PIC S9(04)  VALUE +0              
006703                                                    COMP SYNC.            
006800     05  PV-REMAINDER                   PIC S9(04)  VALUE +0              
006900                                                    COMP SYNC.            
007000     05  PV-READ-COUNT                  PIC S9(09)  VALUE +0              
007100                                                    COMP-3.               
007200     05  PV-ITEM-IN-USE                 PIC S9(09)  VALUE +0              
007300                                                    COMP-3.               
007400     05  PV-TOP-ITEM                    PIC S9(09)  VALUE +0              
007500                                                    COMP-3.               
007600     05  PV-BOTTOM-ITEM                 PIC S9(09)  VALUE +0              
007700                                                    COMP-3.               
007800     05  PV-BLOCK-NUMBER                PIC S9(04)  VALUE +0              
007900                                                    COMP SYNC.            
008000     05  PV-CICS-RESP                   PIC S9(04)  VALUE +0              
008100                                                    COMP SYNC.            
008200     05  PV-HIGHEST-BLOCK-WRITTEN       PIC S9(04)  VALUE +0              
008300                                                    COMP SYNC.            
008400     05  PV-LIST-ITEM-NUMBER            PIC S9(04)  VALUE +0              
008500                                                    COMP SYNC.            
008600     05  PV-RETRY-COUNTER               PIC S9(04)  VALUE +0              
008700                                                    COMP SYNC.            
008800     05  PV-TAUCNTK-CNT                 PIC S9(04)  VALUE +0              
008900                                                    COMP SYNC.            
009000     05  PV-TIMCNTK-CNT                 PIC S9(04)  VALUE +0              
009100                                                    COMP SYNC.            
009110     05  PV-TRN-CNT                     PIC S9(04)  VALUE +0              
009120                                                    COMP SYNC.            
009800     05  PV-DATE-BREAK.                                                   
009900         10 FILLER                      PIC  X(02).                       
010000         10 PV-DB-YY                    PIC  X(02).                       
010100         10 FILLER                      PIC  X(01).                       
010200         10 PV-DB-MM                    PIC  X(02).                       
010300         10 FILLER                      PIC  X(01).                       
010400         10 PV-DB-DD                    PIC  X(02).                       
010500     05  PV-DATE-DISPLAY.                                                 
010600         10 PV-DD-MM                    PIC  X(02).                       
010700         10 FILLER                      PIC  X(01)  VALUE '/'.            
010800         10 PV-DD-DD                    PIC  X(02).                       
010900         10 FILLER                      PIC  X(01)  VALUE '/'.            
011000         10 PV-DD-YY                    PIC  X(02).                       
011010                                                                          
011015     05  PV-AD-DTE-IND                  PIC S9(04)  VALUE +0              
011020                                                    COMP.                 
011101     05  PV-SHPMT-TYPE.                                                   
011102         10 PV-SHPMT-FROM-CDE           PIC  X(03).                       
011103         10 FILLER                      PIC  X(01) VALUE '-'.             
011104         10 PV-SHPMT-TO-CDE             PIC  X(03).                       
011110                                                                          
011111     05  PV-ITEM-CART-CNT               PIC S9(04)  VALUE +0              
011112                                                    COMP.                 
011113     05  PV-PO-CART-CNT                 PIC S9(05)  VALUE +0              
011120                                                    COMP.                 
011200*---------------------------------------------------------------*         
011300*    MAP LAYOUT                                                 *         
011400*---------------------------------------------------------------*         
011500                                                                          
011600     COPY TRKM166.                                                        
011700                                                                          
011800 01  MR-OCCURS-LAYOUT                    REDEFINES  TR166AO.              
011900     05  FILLER                          PIC X(260).                      
012000                                                                          
012100     05  MR-SCROLL-AREA                  OCCURS 9 TIMES.                  
012110*---------------------------------------------------------------*         
012120*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
012130*---------------------------------------------------------------*         
012200***      10  MR-SELECTL                  PIC S9(04) COMP.                 
012300***      10  MR-SELECTA                  PIC  X(01).                      
012400***      10  MR-SELECTC                  PIC  X(01).                      
012500***      10  MR-SELECTH                  PIC  X(01).                      
012600***      10  MR-SELECTI                  PIC  X(01).                      
012700                                                                          
012800***      10  MR-ACTIONL                  PIC S9(04) COMP.                 
012900***      10  MR-ACTIONA                  PIC  X(01).                      
013000***      10  MR-ACTIONC                  PIC  X(01).                      
013100***      10  MR-ACTIONH                  PIC  X(01).                      
013200***      10  MR-ACTION                   PIC  X(03).                      
013201                                                                          
013202         10  MR-DELY-DTL                 PIC S9(04) COMP.                 
013203         10  MR-DELY-DTA                 PIC  X(01).                      
013204         10  MR-DELY-DTC                 PIC  X(01).                      
013205         10  MR-DELY-DTH                 PIC  X(01).                      
013206         10  MR-DELY-DT                  PIC  X(05).                      
013207                                                                          
013208         10  MR-TYPEL                    PIC S9(04) COMP.                 
013209         10  MR-TYPEA                    PIC  X(01).                      
013210         10  MR-TYPEC                    PIC  X(01).                      
013211         10  MR-TYPEH                    PIC  X(01).                      
013212         10  MR-TYPE                     PIC  X(03).                      
013213                                                                          
013214         10  MR-REF-NBRL                 PIC S9(04) COMP.                 
013215         10  MR-REF-NBRA                 PIC  X(01).                      
013216         10  MR-REF-NBRC                 PIC  X(01).                      
013217         10  MR-REF-NBRH                 PIC  X(01).                      
013218         10  MR-REF-NBR                  PIC  X(15).                      
019800                                                                          
019900 EJECT                                                                    
020000*---------------------------------------------------------------*         
020100*    ATTRIBUTE SETTINGS COPYBOOK.                               *         
020200*---------------------------------------------------------------*         
020300                                                                          
020400     COPY DPWS015.                                                        
020500                                                                          
020600 EJECT                                                                    
020700*---------------------------------------------------------------*         
020800*    FUNCTION KEYS COPYBOOK.                                    *         
020900*---------------------------------------------------------------*         
021000                                                                          
021100     COPY DPWS016.                                                        
021200                                                                          
021300 EJECT                                                                    
021400*---------------------------------------------------------------*         
021500*    NUMERIC EDIT LAYOUT.                                       *         
021600*---------------------------------------------------------------*         
021700                                                                          
021800     COPY DPWS010I.                                                       
021900                                                                          
022000 EJECT                                                                    
022100*---------------------------------------------------------------*         
CICS  *    PARAMETERS FOR CALLING THE CICS ARCHITECTURE API.          *         
022300*---------------------------------------------------------------*         
022400                                                                          
022500     COPY DPWS030.                                                        
CICS       COPY DPWS930.                                                        
022700 EJECT                                                                    
022800*---------------------------------------------------------------*         
022900*    STANDARD COMMAREA.                                         *         
023000*---------------------------------------------------------------*         
023100                                                                          
023200     COPY DPWS020.                                                        
023300     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                        
023400                                                                          
023500*---------------------------------------------------------------*         
023600* INTER-APPLICATION COMMAREA.                                   *         
023700*   TRWS117 - IS THE INPUT LAYOUT WHEN COMING FROM THE PO       *         
023800*             CONTAINER LIST SCREEN.                            *         
023900*---------------------------------------------------------------*         
024000                                                                          
024100         10  INTER-APPL-COMM-AREA       PIC X(200).                       
024200     COPY TRWS117.                                                        
024300                                                                          
024400*---------------------------------------------------------------*         
024500*  THIS IS THE APPLICATION-SPECIFIC COMMAREA.                   *         
024600*---------------------------------------------------------------*         
024700         10  ASC-SPECIFIC-COMMAREA.                                       
024800             15  ASC-LIST-KEYS.                                           
025010                 20  ASC-KEY-PO-NBR           PIC S9(09)  COMP.           
025020                 20  ASC-KEY-PO-BKG-SEQ-NBR   PIC S9(09)  COMP.           
025100             15  ASC-BLOCK-ENTRIES OCCURS 2 TIMES.                        
025200                 20  ASC-BLOCK-MODIFIED-SW          PIC  X(01).           
025300                     88  ASC-BLOCK-NOT-MODIFIED     VALUE 'N'.            
025400                     88  ASC-BLOCK-MODIFIED         VALUE 'Y'.            
025500                                                                          
025600                 20  ASC-ITEM-ARRAY.                                      
025700                     25  ASC-ITEM-ENTRIES OCCURS 9 TIMES.                 
025800                         30  ASC-LIST-ITEM-NUMBER                         
025900                                                    PIC S9(09)            
026000                                                    COMP-3.               
026100                         30  ASC-TEMP-SELECTED-SW   PIC  X(01).           
026200                             88  ASC-VALID-SELECT   VALUE ' '             
026300                                                          'S'             
026400                                                          'B'             
026500                                                          'E'.            
026600                             88  ASC-TEMP-NO-SELECT VALUE ' '.            
026700                             88  ASC-TEMP-SELECT    VALUE 'S'.            
026800                             88  ASC-TEMP-BEGIN     VALUE 'B'.            
026900                             88  ASC-TEMP-END       VALUE 'E'.            
027000                         30  ASC-SELECTED-SW        PIC  X(01).           
027100                             88  ASC-NO-SELECT      VALUE ' '.            
027200                             88  ASC-SELECT         VALUE 'S'.            
027300                             88  ASC-BEGIN          VALUE 'B'.            
027400                             88  ASC-END            VALUE 'E'.            
027500                         30  ASC-ACTION             PIC  X(03).           
027501                         30  ASC-DELY-DT            PIC  X(10).           
027510                         30  ASC-TYPE               PIC  X(03).           
027710                         30  ASC-REF-NBR            PIC  X(15).           
028900                                                                          
029000             15  ASC-BLK-SUB                         PIC S9(04)           
029100                                                          COMP            
029200                                                          SYNC.           
029300             15  ASC-ITEM-SUB                        PIC S9(04)           
029400                                                          COMP            
029500                                                          SYNC.           
029600             15  ASC-NUMBER-OF-ITEMS-READ            PIC S9(09)           
029700                                                          COMP-3.         
029800             15  ASC-NUMBER-OF-SELECTED-ITEMS        PIC S9(09)           
029900                                                          COMP-3.         
030000             15  ASC-ITEMS-DISPLAYED                 PIC S9(03)           
030100                                                          COMP-3.         
030200             15  ASC-ITEM-AT-TOP-OF-PANEL            PIC S9(09)           
030300                                                          COMP-3.         
030400             15  ASC-ITEM-AT-BOT-OF-PANEL            PIC S9(09)           
030500                                                          COMP-3.         
030600             15  ASC-HIGHEST-BLOCK-WRITTEN           PIC S9(04)           
030700                                                          COMP            
030800                                                          SYNC.           
030900             15  ASC-START-OF-SELECTED-RANGE         PIC S9(09)           
031000                                                          COMP-3.         
031100             15  ASC-END-OF-SELECTED-RANGE           PIC S9(09)           
031200                                                          COMP-3.         
031300             15  ASC-ITEMS-LEFT-INDICATOR            PIC  X(01).          
031400                 88  ASC-ITEMS-LEFT-ON-DB            VALUE 'Y'.           
031500                 88  ASC-NO-ITEMS-LEFT-ON-DB         VALUE 'N'.           
031600             15  ASC-TEMP-QUEUE-UPDATE-SW            PIC  X(01).          
031700                 88  ASC-UPDATE-TSQ                  VALUE 'Y'.           
031800                 88  ASC-NO-TSQ-UPDATE               VALUE ' '.           
031900             15  ASC-LIST-QUEUE-NAME.                                     
032000                 20  ASC-LIST-TERM-ID                PIC  X(04).          
032100                 20  ASC-LIST-TASK-NUMBER            PIC S9(05)           
032200                                                          COMP-3.         
032300                 20  ASC-LIST-SEQ                    PIC  9(01).          
032400             15  ASC-SEL-QUEUE-NAME.                                      
032500                 20  ASC-SEL-TERM-ID                 PIC  X(04).          
032600                 20  ASC-SEL-TASK-NUMBER             PIC S9(05)           
032700                                                          COMP-3.         
032800                 20  ASC-SEL-SEQ                     PIC  9(01).          
032900             15  ASC-START-ITEM-REQUEST.                                  
033000                 20  ASC-START-ITEM-REQUEST-N        PIC  9(05).          
033100                                                                          
033200 EJECT                                                                    
033300*---------------------------------------------------------------*         
033400*    ABEND PROCESSING COPYBOOK.                                 *         
033500*---------------------------------------------------------------*         
033600                                                                          
033700     COPY DPWS013.                                                        
033800                                                                          
033900 EJECT                                                                    
033901*---------------------------------------------------------------*         
033902*    DB2 AREA FOR TPURCHS                                       *         
033903*---------------------------------------------------------------*         
033904     EXEC SQL                                                             
033905          INCLUDE TPURCHS                                                 
033906     END-EXEC.                                                            
033913*---------------------------------------------------------------*         
033914*    DB2 AREA FOR TIMBKPO - BOOKING PURCHASE ORDER TABLE        *         
033915*---------------------------------------------------------------*         
033916     EXEC SQL                                                             
033917          INCLUDE TIMBKPO                                                 
033918     END-EXEC.                                                            
033919*---------------------------------------------------------------*         
033920*    DB2 AREA FOR TIMFOB - IMPORTS FREE ON BOARD TABLE          *         
033921*---------------------------------------------------------------*         
033922     EXEC SQL                                                             
033923          INCLUDE TIMFOB                                                  
033924     END-EXEC.                                                            
033925*---------------------------------------------------------------*         
033926*    DB2 AREA FOR TIMPOE - IMPORTS PORT OF ENTRY TABLE          *         
033927*---------------------------------------------------------------*         
033928     EXEC SQL                                                             
033929          INCLUDE TIMPOE                                                  
033930     END-EXEC.                                                            
033931*---------------------------------------------------------------*         
033932*    DB2 AREA FOR TENTNME - ENTITY NAME TABLE                   *         
033933*---------------------------------------------------------------*         
033934     EXEC SQL                                                             
033935          INCLUDE TENTNME                                                 
033936     END-EXEC.                                                            
033937*---------------------------------------------------------------*         
033938*    DB2 AREA FOR TPLNSHP - PLAN SHIPMENT TABLE                 *         
033939*---------------------------------------------------------------*         
033940     EXEC SQL                                                             
033941          INCLUDE TPLNSHP                                                 
033942     END-EXEC.                                                            
033943*---------------------------------------------------------------*         
033950*    DB2 AREA FOR TPURITM - PURCHASE ITEM TABLE                 *         
033960*---------------------------------------------------------------*         
033970     EXEC SQL                                                             
033980          INCLUDE TPURITM                                                 
033990     END-EXEC.                                                            
034000*---------------------------------------------------------------*         
034100*    DB2 AREA FOR TSKXREF TABLE                                 *         
034200*---------------------------------------------------------------*         
034300     EXEC SQL                                                             
034400          INCLUDE TSKXREF                                                 
034500     END-EXEC.                                                            
034501*---------------------------------------------------------------*         
034502*    DB2 AREA FOR TUPC TABLE                                    *         
034503*---------------------------------------------------------------*         
034504     EXEC SQL                                                             
034505          INCLUDE TUPC                                                    
034506     END-EXEC.                                                            
034507*---------------------------------------------------------------*         
034508*    DB2 AREA FOR XLT_SKU                                       *         
034509*---------------------------------------------------------------*         
034510     EXEC SQL                                                             
034520          INCLUDE XLT00003                                                
034530     END-EXEC.                                                            
034540*---------------------------------------------------------------*         
034550*    DB2 AREA FOR XLT_VND_STYL                                  *         
034560*---------------------------------------------------------------*         
034570     EXEC SQL                                                             
034580          INCLUDE XLT00004                                                
034590     END-EXEC.                                                            
038200*---------------------------------------------------------------*         
038300*    DB2 AREA FOR COMMUNICATIONS                                *         
038400*---------------------------------------------------------------*         
038500     EXEC SQL                                                             
038600          INCLUDE SQLCA                                                   
038700     END-EXEC.                                                            
038701*---------------------------------------------------------------*         
038702*    CURSOR FOR PO BOOKING LIST.                                *         
038703*---------------------------------------------------------------*         
038704                                                                          
038705     EXEC SQL                                                             
038706          DECLARE  BOOKING-CSR CURSOR                                     
038707              FOR  SELECT                                                 
038708                   PO_BKG_DELY_TMST                                       
038721                 , EXTL_REF_NBR                                           
038722                 , ORGN_SHPD_FR_CDE                                       
038723            FROM   TIMBKPO                                                
038724           WHERE   PO_NBR         = :DK-PO-NBR                            
038725             AND   PO_BKG_SEQ_NBR = :DK-PO-BKG-SEQ-NBR                    
038726        ORDER BY   PO_BKG_DELY_TMST                                       
038727     END-EXEC.                                                            
038728                                                                          
038729 EJECT                                                                    
038730*----------------------------------------------------------------*        
038731*    CURSOR DECLARATION FOR SELECTING OUTER PACK QUANTITY        *        
038732*----------------------------------------------------------------*        
038733                                                                          
038734     EXEC SQL                                                             
038735          DECLARE  OUTR-PCK-CSR CURSOR                            02970099
038736             FOR   SELECT                                         02980099
038737                   A.UNT_QTY                                      03000099
038738                ,  A.OUTR_PK_QTY                                  02990099
038739             FROM  TPURITM  A                                     03010099
038760             WHERE A.PO_NBR         = :DK-PO-NBR                          
038800             AND   A.VER_STATUS_CDE = 'A'                         03050099
038801             FOR   FETCH ONLY                                     03060099
038802     END-EXEC.                                                            
038803                                                                          
038804 EJECT                                                                    
043000*----------------------------------------------------------------*        
043100 LINKAGE SECTION.                                                         
043200                                                                          
043300 01  DFHCOMMAREA.                                                         
043400     05  FILLER                         OCCURS  1 TO 4072 TIMES           
043500                                        DEPENDING ON EIBCALEN.            
043600         10  FILLER                     PIC X.                            
043700                                                                          
043800 EJECT                                                                    
043900*----------------------------------------------------------------*        
044000 PROCEDURE DIVISION.                                                      
044100*----------------------------------------------------------------*        
044200*   THIS MODULE IS THE HIGHEST PROCESSING LEVEL IN THE PROGRAM.  *        
044300*   FIRST, CALL THE CICS ARCHITECTURE API, PERFORM THE PROGRAM   *        
044400*   PROCESSING AND THEN CALL THE CICS ARCHITECTURE API TO EXIT.  *        
044500*----------------------------------------------------------------*        
044600 0000-MAIN-MODULE.                                                        
044700                                                                          
044800     INITIALIZE DP030-CICS-API-FIELDS.                                    
044900     MOVE +1                       TO DP030-NUMBER-OF-MAPS.               
045000     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.                  
045100     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).                 
045200     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                               
045300     MOVE LENGTH OF TR166AI        TO DP030-MAP-LENGTH (1).               
045400     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).             
045500     PERFORM 0001-CALL-CICS-ARCH-API.                                     
045600                                                                          
045700     PERFORM 1000-CONTROL-PROCESSING                                      
045800                                                                          
045900     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).             
046000     PERFORM 0001-CALL-CICS-ARCH-API.                                     
046100                                                                          
046200*----------------------------------------------------------------*        
046300*   THIS PARAGRAPH CALLS THE CICS ARCHITECTURE API SUBROUTINE    *        
046400*   AND WILL ABEND IF ANY ERRORS OCCURRED IN THAT CALL.          *        
046500*----------------------------------------------------------------*        
046600 0001-CALL-CICS-ARCH-API.                                                 
046700                                                                          
CICS       CALL DP930-CICS-ARCH-API USING DFHEIBLK                              
046900                                    DFHCOMMAREA                           
047000                                    DP030-CICS-API-FIELDS                 
047100                                    DP020-STANDARD-COMMAREA               
047200                                    TR166AI.                              
047300                                                                          
047400     IF  DP030-RC-CALL-SUCCESSFUL                                         
047500         CONTINUE                                                         
047600     ELSE                                                                 
047700         SET DP013-NO-ROLLBACK                                            
047800             DP013-XCTL-DISPLAY-RESTART                                   
047900             DP013-CICS-ABEND      TO TRUE                                
048000         MOVE '0001-CALL-CICS-ARCH-API'                                   
048100                                   TO DP013-PARAGRAPH                     
CICS           MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O        
CICS  -             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)              
048400         MOVE DP030-RETURN-CODE    TO DP013-MESSAGE-TEXT (3)              
048500         PERFORM DP013-0000-PROCESS-ABEND                                 
048600     END-IF.                                                              
048700                                                                          
048800 EJECT                                                                    
048900*----------------------------------------------------------------*        
049000* PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT      *        
049100* COURSE OF ACTION IS FOR THIS TRANSACTION.                      *        
049200*                                                                *        
049300* NOTE:  PV-TOP-ITEM IS THE ITEM THAT IS REQUESTED TO BE AT THE  *        
049400*  TOP OF THE PANEL.  MOVING ASC-ITEM-AT-TOP-OF-PANEL TO THIS    *        
049500*  MEANS THAT POSITION WITHIN THE LIST WILL NOT CHANGE -- THIS   *        
049600*  IS THE DEFAULT WHICH WILL BE OVERRIDDEN BY SCROLLING ACTIONS. *        
049700*----------------------------------------------------------------*        
049800 1000-CONTROL-PROCESSING.                                                 
049900                                                                          
050000     EVALUATE TRUE                                                        
050100         WHEN DP020-NEXT-ACT-INITIAL                                      
050200             INITIALIZE ASC-SPECIFIC-COMMAREA                             
050300             MOVE EIBTRMID         TO ASC-LIST-TERM-ID                    
050400                                      ASC-SEL-TERM-ID                     
050500             MOVE DP020-SRC-TASK-NUMBER                                   
050600                                   TO ASC-LIST-TASK-NUMBER                
050700                                      ASC-SEL-TASK-NUMBER                 
050800             MOVE PC-LIST-QUEUE-SEQ                                       
050900                                   TO ASC-LIST-SEQ                        
051000             MOVE PC-SEL-QUEUE-SEQ TO ASC-SEL-SEQ                         
051100             PERFORM 1100-PROCESS-INTER-APPL-COMM                         
051200*-------$TEMPLATE NOTE$------------------------------------------*        
051300* IF THE DATA EXPECTED IS NOT RECEIVED FROM CALLING APPLICATION,*         
051400* SETUP APPROPRIATE MESSAGE AND SEVERITY AND SET APPL-ERROR TO *          
051500* TRUE, THIS WILL RETURN TO CALLING APPLICATION WHEN API CALLED.*         
051600*----------------------------------------------------------------*        
051700             IF  PS-COMMAREA-NOT-VALID                                    
051800                 SET DP020-NEXT-ACT-APPL-ERROR                            
051900                                   TO TRUE                                
052000             ELSE                                                         
052100                 PERFORM 4000-BUILD-INITIAL-PANEL                         
052200             END-IF                                                       
052300                                                                          
052400         WHEN DP020-NEXT-ACT-READ-MAP                                     
052500             MOVE ASC-ITEM-AT-TOP-OF-PANEL                                
052600                                   TO PV-TOP-ITEM                         
052700             PERFORM 2000-PROCESS-PANEL                                   
052800                                                                          
052900         WHEN DP020-NEXT-ACT-RETURN                                       
053000             MOVE ASC-ITEM-AT-TOP-OF-PANEL                                
053100                                   TO PV-TOP-ITEM                         
053200             MOVE ZERO             TO ASC-ITEM-AT-TOP-OF-PANEL            
053300             MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                     
053310             MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR             
053400             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                         
053500             PERFORM 3000-EDIT-DATA-IN-COMMAREA                           
053600                                                                          
053700         WHEN OTHER                                                       
053800             SET DP013-LOGIC-ABEND TO TRUE                                
053900             SET DP013-NO-ROLLBACK TO TRUE                                
054000             MOVE '1000-CONTROL-PROCESSING'                               
054100                                   TO DP013-PARAGRAPH                     
054200             MOVE 'INVALID NEXT APPLICATION ACTIVITY RECEIVED'            
054300                                   TO DP013-MESSAGE-TEXT(1)               
054400             PERFORM DP013-0000-PROCESS-ABEND                             
054500     END-EVALUATE.                                                        
054600                                                                          
054700 EJECT                                                                    
054800*----------------------------------------------------------------*        
054900* DETERMINE IF DATA WAS PASSED THROUGH INTER-APPL COMMAREA OR    *        
055000* IF THERE IS DATA TO BE USED IN THE NAV-KEY FIELD.              *        
055100*----------------------------------------------------------------*        
055200 1100-PROCESS-INTER-APPL-COMM.                                            
055300                                                                          
055400     SET PS-COMMAREA-VALID         TO TRUE.                               
055500     MOVE SPACE                    TO ASC-START-ITEM-REQUEST.             
055600                                                                          
055601     IF  DP020-INT-APPL-FORMAT-IND = PC-LIST-FORMAT                       
055602          MOVE TR117-PO-NBR        TO DK-PO-NBR                           
055603                                      ASC-KEY-PO-NBR                      
055604          MOVE TR117-PO-SEQ-NBR    TO DK-PO-BKG-SEQ-NBR                   
055605                                      ASC-KEY-PO-BKG-SEQ-NBR              
056300     END-IF.                                                              
056400                                                                          
056500 EJECT                                                                    
056600*----------------------------------------------------------------*        
056700* DO ANY PROCESSING FOR KEYS FOR WHICH NO EDITTING OF THE DATA   *        
056800* ON THE SCREEN NEEDS TO BE DONE.  IF ONE OF THOSE KEYS IS NOT   *        
056900* USED, EDIT THE DATA ON THE SCREEN AND GO ON TO CHECK THE REST  *        
057000* OF THE FUNCTION KEYS.  NOTE THAT WITH THE API, NO INVALID      *        
057100* FUNCTION KEYS CAN GET THIS FAR.                                *        
057200*----------------------------------------------------------------*        
057300 2000-PROCESS-PANEL.                                                      
057400                                                                          
057500     EVALUATE TRUE                                                        
057600         WHEN DP020-SRC-AID = DP016-CLEAR                                 
057700             MOVE ZERO             TO ASC-ITEM-AT-TOP-OF-PANEL            
057800             PERFORM 3000-EDIT-DATA-IN-COMMAREA                           
057900             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                         
058000                                                                          
058100         WHEN DP020-FK-REFRESH (DP020-SRC-AID)                            
058200             MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                     
058210             MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR             
058300             PERFORM 2050-DELETE-LIST-QUEUE                               
058400             PERFORM 4000-BUILD-INITIAL-PANEL                             
058500                                                                          
058600         WHEN OTHER                                                       
058700             PERFORM 2200-MOVE-SCREEN-TO-COMMAREA                         
058800             PERFORM 3000-EDIT-DATA-IN-COMMAREA                           
058900             IF  PS-NO-ERROR                                              
059000                 SET DP030-CONTINUE-GO                                    
059100                                 TO TRUE                                  
059200                 PERFORM 2100-CHECK-FUNCTION-KEY                          
059300             ELSE                                                         
059400                 SET DP030-OVERRIDE-GO                                    
059500                                 TO TRUE                                  
059600             END-IF                                                       
059700     END-EVALUATE.                                                        
059800                                                                          
059900 EJECT                                                                    
060000*----------------------------------------------------------------*        
060100*  DELETE THE LIST ITEMS TEMP STORAGE QUEUE.                     *        
060200*----------------------------------------------------------------*        
060300 2050-DELETE-LIST-QUEUE.                                                  
060400                                                                          
060500     EXEC CICS                                                            
060600         DELETEQ TS                                                       
060700             QUEUE (ASC-LIST-QUEUE-NAME)                                  
060800             RESP  (PV-CICS-RESP)                                         
060900     END-EXEC.                                                            
061000                                                                          
061100     IF (PV-CICS-RESP = DFHRESP(NORMAL)) OR                               
061200        (PV-CICS-RESP = DFHRESP(QIDERR))                                  
061300         CONTINUE                                                         
061400     ELSE                                                                 
061500         SET DP013-CICS-ABEND      TO TRUE                                
061600         SET DP013-NO-ROLLBACK     TO TRUE                                
061700                                                                          
061800         MOVE '2050-DELETE-LIST-QUEUE'                                    
061900                                   TO DP013-PARAGRAPH                     
062000         MOVE 'ERROR TRYING TO DELETE LIST TEMP STORAGE QUEUE'            
062100                                   TO DP013-MESSAGE-TEXT (1)              
062200         PERFORM DP013-0000-PROCESS-ABEND                                 
062300     END-IF.                                                              
062400                                                                          
062500     MOVE +0                       TO ASC-HIGHEST-BLOCK-WRITTEN.          
062600                                                                          
062700 EJECT                                                                    
062800*----------------------------------------------------------------*        
062900* ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED FIRST.*        
063000* NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED FROM THE  *        
063100* CICS ARCHITECTURE API.                                         *        
063200*----------------------------------------------------------------*        
063300 2100-CHECK-FUNCTION-KEY.                                                 
063400                                                                          
063500     EVALUATE TRUE                                                        
063600                                                                          
063700         WHEN DP020-FK-FIRST-PAGE(DP020-SRC-AID)                          
063800             MOVE +1               TO PV-TOP-ITEM                         
063910             MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                     
063920             MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR             
064000             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                         
064100             PERFORM 3200-RESET-ATTRIBUTES                                
064200                                                                          
064300         WHEN DP020-FK-PREV-PAGE(DP020-SRC-AID)                           
064400             PERFORM 2110-BROWSE-BACKWARD                                 
064500             MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                     
064510             MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR             
064600             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                         
064700             PERFORM 3200-RESET-ATTRIBUTES                                
064800                                                                          
064900         WHEN DP020-FK-NEXT-PAGE(DP020-SRC-AID)                           
065000             PERFORM 2120-BROWSE-FORWARD                                  
065001             MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                     
065002             MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR             
065200             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                         
065300                                                                          
065400         WHEN DP020-SRC-AID = DP016-ENTER                                 
065500             PERFORM 2130-CHECK-FOR-JUMP-BROWSE                           
065600             IF  PS-ERROR                                                 
065700                 CONTINUE                                                 
065800             ELSE                                                         
065904                 MOVE ASC-KEY-PO-NBR         TO DK-PO-NBR                 
065905                 MOVE ASC-KEY-PO-BKG-SEQ-NBR TO DK-PO-BKG-SEQ-NBR         
066000                 PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                     
066100                 PERFORM 3200-RESET-ATTRIBUTES                            
066200             END-IF                                                       
066300                                                                          
066400         WHEN OTHER                                                       
066500             SET DP013-NO-ROLLBACK                                        
066600                 DP013-XCTL-DISPLAY-RESTART                               
066700                 DP013-CICS-ABEND  TO TRUE                                
066800             MOVE '2100-CHECK-FUNCTION-KEY'                               
066900                                   TO DP013-PARAGRAPH                     
067000             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'              
067100                                   TO DP013-MESSAGE-TEXT (1)              
067200             PERFORM DP013-0000-PROCESS-ABEND                             
067300     END-EVALUATE.                                                        
067400                                                                          
067500 EJECT                                                                    
067600*----------------------------------------------------------------*        
067700*    IF THE USER HITS THE PAGE BACKWARD KEY, COMPUTE THE TOP     *        
067800*    ITEM NUMBER FOR THE NEW PAGE.  IF IT IS ABOVE THE TOP,      *        
067900*    SET THE TOP ITEM NUMBER TO +1 AND DISPLAY THE TOP OF LIST   *        
068000*    MESSAGE.                                                    *        
068100*----------------------------------------------------------------*        
068200 2110-BROWSE-BACKWARD.                                                    
068300                                                                          
068400     SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-AT-TOP-OF-PANEL            
068500         GIVING PV-TOP-ITEM.                                              
068600*                                                                         
068700     IF  ((PV-TOP-ITEM < +1)                                              
068800       OR (PV-TOP-ITEM = +1))                                             
068900         MOVE +1                   TO PV-TOP-ITEM                         
069000*------- TOP OF LIST --------                                             
069100         MOVE PC-TSYMSG-00069      TO DP020-MSG-NUMBER                    
069200         SET DP020-MSG-INFORMATIONAL TO TRUE                              
069300     END-IF.                                                              
069400                                                                          
069500 EJECT                                                                    
069600*----------------------------------------------------------------*        
069700*    IF THE USER HITS THE PAGE FORWARD KEY, COMPUTE THE TOP      *        
069800*    ITEM NUMBER FOR THE NEW PAGE.  IF THE USER ATTEMPTS TO GO   *        
069900*    PAST THE END, ISSUE THE BOTTOM OF LIST MESSAGE.             *        
070000*----------------------------------------------------------------*        
070100 2120-BROWSE-FORWARD.                                                     
070200                                                                          
070300     ADD PC-ITEMS-PER-PANEL ASC-ITEM-AT-TOP-OF-PANEL                      
070400         GIVING PV-TOP-ITEM.                                              
070500     IF  PV-TOP-ITEM > ASC-NUMBER-OF-ITEMS-READ                           
070600         MOVE ASC-ITEM-AT-TOP-OF-PANEL                                    
070700                                   TO PV-TOP-ITEM                         
070800*------- BOTTOM OF LIST -----------                                       
070900         MOVE PC-TSYMSG-00070      TO DP020-MSG-NUMBER                    
071000         SET DP020-MSG-INFORMATIONAL                                      
071100                                   TO TRUE                                
071200     ELSE                                                                 
071300         COMPUTE PV-BOTTOM-ITEM =                                         
071400             PV-TOP-ITEM + PC-ITEMS-PER-PANEL - 1                         
071500         IF  PV-BOTTOM-ITEM > ASC-NUMBER-OF-ITEMS-READ                    
071600*------------BOTTOM OF LIST ---------                                     
071700             MOVE PC-TSYMSG-00070  TO DP020-MSG-NUMBER                    
071800             SET DP020-MSG-INFORMATIONAL                                  
071900                                   TO TRUE                                
072000         END-IF                                                           
072100     END-IF.                                                              
072200                                                                          
072300 EJECT                                                                    
072400*----------------------------------------------------------------*        
072500*    THE USER CAN CHANGE THE CURRENT BEGINNING LIST NUMBER SO    *        
072600*    THAT THE TRANSACTION WILL JUMP TO THAT POINT IN THE LIST.   *        
072700*    THIS IS A FASTER WAY TO GET TO A CERTAIN POINT IN THE LIST  *        
072800*    RATHER THAN HITTING NEXT-PAGE TO GET TO THAT POINT.         *        
072900*    THE NEW LIST NUMBER ENTERED IS EDITED TO MAKE SURE THAT     *        
073000*    IT IS NUMERIC AND FALLS BETWEEN A SPECIFIED RANGE.          *        
073100*----------------------------------------------------------------*        
073200 2130-CHECK-FOR-JUMP-BROWSE.                                              
073300                                                                          
073400     SET PS-NO-ERROR               TO TRUE.                               
073500     IF (ASC-START-ITEM-REQUEST = SPACE)                                  
073600         MOVE ASC-ITEM-AT-TOP-OF-PANEL                                    
073700                                   TO PV-TOP-ITEM                         
073800     ELSE                                                                 
073900         MOVE ASC-START-ITEM-REQUEST                                      
074000                                   TO DP010I-UNEDITED-FIELD               
074100         MOVE PC-MSG-NUMBER-LENGTH TO DP010I-MAXIMUM-DIGITS               
074200         MOVE +0                   TO DP010I-MAXIMUM-DECIMALS             
074300         SET DP010I-NEGATIVE-NOT-ALLOWED                                  
074400                                   TO TRUE                                
263697         CALL DP010I-NUMERIC-EDIT-ROUTINE                                 
263697              USING DP010I-NUMERIC-EDIT-AREA                              
074600                                                                          
074700         IF  NOT DP010I-ERROR-DETECTED                                    
074800             MOVE DP010I-NUMERIC-FIELD                                    
074900                                   TO  ASC-START-ITEM-REQUEST-N           
075000             IF  ASC-START-ITEM-REQUEST-N > ZERO                          
075100                 IF  ASC-START-ITEM-REQUEST-N >                           
075200                                          ASC-NUMBER-OF-ITEMS-READ        
075300                     MOVE SPACE TO ASC-START-ITEM-REQUEST                 
075400                     COMPUTE PV-TOP-ITEM =                                
075500                             ASC-NUMBER-OF-ITEMS-READ                     
075600                             - PC-ITEMS-PER-PANEL + 1                     
075700                     IF  PV-TOP-ITEM < +1                                 
075800                         MOVE +1   TO PV-TOP-ITEM                         
075900                         MOVE PC-TSYMSG-00070                             
076000                                   TO DP020-MSG-NUMBER                    
076100                         SET DP020-MSG-INFORMATIONAL                      
076200                                   TO TRUE                                
076300                     END-IF                                               
076400                 ELSE                                                     
076500                     MOVE ASC-START-ITEM-REQUEST-N                        
076600                                   TO PV-TOP-ITEM                         
076700                     MOVE SPACE    TO ASC-START-ITEM-REQUEST              
076800                     COMPUTE PV-BOTTOM-ITEM =                             
076900                         PV-TOP-ITEM + PC-ITEMS-PER-PANEL - 1             
077000                     IF  PV-BOTTOM-ITEM > ASC-NUMBER-OF-ITEMS-READ        
077100*----------------------- BOTTOM OF LIST --------------                    
077200                         MOVE PC-TSYMSG-00070                             
077300                                   TO DP020-MSG-NUMBER                    
077400                         SET DP020-MSG-INFORMATIONAL                      
077500                                   TO TRUE                                
077600                     END-IF                                               
077700                 END-IF                                                   
077800             ELSE                                                         
077900*--------------- VALUE OUT OF RANGE ------------------                    
078000                 MOVE PC-TSYMSG-00101                                     
078100                                   TO DP020-MSG-NUMBER                    
078200                 MOVE -1           TO ASTRTITL                            
078300                 SET DP030-SET-CURSOR-APPL-1                              
078400                                   TO TRUE                                
078500                 MOVE DP015-REVERSE                                       
078600                                   TO ASTRTITH                            
078700                 MOVE DP015-RED    TO ASTRTITC                            
078800                 MOVE DP015-UNP-NUM-BRT-MDT                               
078900                                   TO ASTRTITA                            
079000                 SET DP020-MSG-FATAL                                      
079100                                   TO TRUE                                
079200                 SET PS-ERROR      TO TRUE                                
079300             END-IF                                                       
079400                                                                          
079500         ELSE                                                             
079600             MOVE PC-TSYMSG-00008  TO DP020-MSG-NUMBER                    
079700             MOVE -1               TO ASTRTITL                            
079800             SET DP030-SET-CURSOR-APPL-1 TO TRUE                          
079900             MOVE DP015-REVERSE    TO ASTRTITH                            
080000             MOVE DP015-RED        TO ASTRTITC                            
080100             MOVE DP015-UNP-NUM-BRT-MDT                                   
080200                                   TO ASTRTITA                            
080300             SET DP020-MSG-FATAL   TO TRUE                                
080400             SET PS-ERROR          TO TRUE                                
080500         END-IF                                                           
080600     END-IF.                                                              
080700                                                                          
080800 EJECT                                                                    
080900*----------------------------------------------------------------*        
081000*  MOVE ALL OF THE FIELDS THAT WERE ENTERED / CHANGED ON THE     *        
081100*  SCREEN INTO THE COMMAREA.  ALL EDITTING IS DONE IN THE COMM.  *        
081200*----------------------------------------------------------------*        
081300 2200-MOVE-SCREEN-TO-COMMAREA.                                            
081400                                                                          
081500     MOVE PV-TOP-ITEM              TO PV-ITEM-IN-USE.                     
081600     MOVE +1                       TO PV-SUB.                             
081700                                                                          
081800     PERFORM 3100-SET-SUBSCRIPTS.                                         
081900     IF  ASTRTITL > ZERO                                                  
082000         MOVE ASTRTITI         TO ASC-START-ITEM-REQUEST                  
082100     ELSE                                                                 
082200         IF  ASTRTITF = DP015-ERASE-EOF                                   
082300             INITIALIZE ASC-START-ITEM-REQUEST                            
082400         END-IF                                                           
082500     END-IF.                                                              
082600                                                                          
082700 EJECT                                                                    
082800*----------------------------------------------------------------*        
082900*  EDIT ALL OF THE DATA ON THE SCREEN AS IT RESIDES IN THE       *        
083000*  COMMAREA (EDITTING IS NOT DONE AGAINST THE SCREEN DIRECTLY).  *        
083100*----------------------------------------------------------------*        
083200 3000-EDIT-DATA-IN-COMMAREA.                                              
083300                                                                          
083400     SET PS-NO-ERROR               TO TRUE.                               
083500     PERFORM 3200-RESET-ATTRIBUTES.                                       
083600     MOVE ASC-ITEMS-DISPLAYED      TO PV-SUB.                             
083700*----------------------------------------------------------------*        
083800* CALCULATE THE POSITION OF THE LAST ITEM DISPLAYED. *                    
083900* EDITTING IS DONE FROM THE BOTTOM UP. *                                  
084000*----------------------------------------------------------------*        
084100     COMPUTE PV-ITEM-IN-USE = PV-TOP-ITEM +                               
084200         ASC-ITEMS-DISPLAYED - 1.                                         
084300     PERFORM 3100-SET-SUBSCRIPTS.                                         
084400                                                                          
084500 EJECT                                                                    
084600*----------------------------------------------------------------*        
084700*    DETERMINE THE VALUE OF THE ITEM SUBSCRIPT BASED ON THE ITEM *        
084800*    CURRENTLY IN USE AND THE FIRST ITEM IN THE ARRAY.  THIS WILL*        
084900*    POSITION US IN THE 1ST BLOCK OF THE ARRAY.                  *        
085000*                                                                *        
085100*    IF THE ITEM SUBSCRIPT EXCEEDS THE MAXIMUM NUMBER OF ITEMS   *        
085200*    IN A BLOCK, RECALCULATE THE SUBSCRIPT BY SUBTRACTING OUT    *        
085300*    THE MAXIMUM NUMBER OF ITEMS.  THIS WILL CORRECTLY POSITION  *        
085400*    US IN THE 2ND BLOCK OF THE ARRAY.                           *        
085500*----------------------------------------------------------------*        
085600 3100-SET-SUBSCRIPTS.                                                     
085700                                                                          
085800     COMPUTE ASC-ITEM-SUB =                                               
085900         (PV-ITEM-IN-USE - ASC-LIST-ITEM-NUMBER(1 1)) + 1.                
086000                                                                          
086100     IF ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                                 
086200         SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-SUB                    
086300                                                                          
086400         MOVE PC-MAX-BLOCKS-IN-ARRAY TO ASC-BLK-SUB                       
086500     ELSE                                                                 
086600         MOVE +1                     TO ASC-BLK-SUB                       
086700     END-IF.                                                              
086800                                                                          
086900 EJECT                                                                    
087000*----------------------------------------------------------------*        
087100*  RESET THE ATTRIBUTES OF ALL ENTERABLE FIELDS ON THE MAP.      *        
087200*----------------------------------------------------------------*        
087300 3200-RESET-ATTRIBUTES.                                                   
087400                                                                          
087500     MOVE DP015-UNP-ALP-NOR-OFF    TO ASTRTITA.                           
087600     MOVE DP015-GREEN              TO ASTRTITC.                           
087700     MOVE DP015-UNDERLINE          TO ASTRTITH.                           
087710*---------------------------------------------------------------*         
087720*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
087730*---------------------------------------------------------------*         
087800                                                                          
087900***  PERFORM                                                              
088000***      VARYING PV-SUB                                                   
088100***      FROM 1 BY 1                                                      
088200***      UNTIL PV-SUB > (PC-ITEMS-PER-PANEL  OR                           
088300***                      ASC-ITEMS-DISPLAYED)                             
088400***      MOVE DP015-UNP-ALP-NOR-OFF                                       
088500***                                TO MR-SELECTA (PV-SUB)                 
088600***      MOVE DP015-GREEN          TO MR-SELECTC (PV-SUB)                 
088700***      MOVE DP015-UNDERLINE      TO MR-SELECTH (PV-SUB)                 
088800***                                                                       
088900***      MOVE DP015-ASK-DRK-OFF                                           
089000***                                TO MR-SELECTA (PV-SUB)                 
089100***      MOVE DP015-HL-OFF         TO MR-SELECTH (PV-SUB)                 
089200***  END-PERFORM.                                                         
089300                                                                          
089400 EJECT                                                                    
089500*----------------------------------------------------------------*        
089600*    INITIALIZE BOTH BLOCKS IN THE ARRAY.                        *        
089700*    INITIALIZE ALL COUNTERS AND FLAGS.                          *        
089800*    READ THE DATA BASE FOR THE 1ST TIME AND FILL UP THE ARRAY.  *        
089900*    DISPLAY THE PANEL TO USER.                                  *        
090000*----------------------------------------------------------------*        
090100 4000-BUILD-INITIAL-PANEL.                                                
090200                                                                          
090300     INITIALIZE                 ASC-BLOCK-ENTRIES (1)                     
090400                                ASC-BLOCK-ENTRIES (2).                    
090500     MOVE +1                 TO ASC-BLK-SUB.                              
090600     SET ASC-ITEMS-LEFT-ON-DB                                             
090700                             TO TRUE.                                     
090800                                                                          
090900     MOVE +0                 TO ASC-ITEM-SUB                              
091000                                ASC-NUMBER-OF-ITEMS-READ                  
091100                                ASC-NUMBER-OF-SELECTED-ITEMS              
091200                                ASC-HIGHEST-BLOCK-WRITTEN                 
091300                                ASC-START-OF-SELECTED-RANGE               
091400                                ASC-END-OF-SELECTED-RANGE                 
091500                                ASC-ITEM-AT-TOP-OF-PANEL.                 
091600     PERFORM 4010-OPEN-CURSOR.                                            
091700                                                                          
091800     PERFORM 4300-READ-ITEMS-FROM-DB.                                     
091900                                                                          
092000     PERFORM 4020-CLOSE-CURSOR.                                           
092100                                                                          
092200     MOVE +1                   TO  PV-TOP-ITEM.                           
092300     IF  ASC-NUMBER-OF-ITEMS-READ = ZERO                                  
092400         SET DP020-NEXT-ACT-APPL-ERROR TO TRUE                            
092500         SET DP020-MSG-FATAL   TO  TRUE                                   
092600*------- PURCHASE ORDER DOES NOT EXIST                                    
092700         MOVE PC-TSYMSG-00050  TO  DP020-MSG-NUMBER                       
092800     ELSE                                                                 
092900         PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                             
093000     END-IF.                                                              
093100                                                                          
093200 EJECT                                                                    
093300*----------------------------------------------------------------*        
093400*   OPEN THE BOOKING PO CURSOR                                   *        
093500*----------------------------------------------------------------*        
093600 4010-OPEN-CURSOR.                                                        
093700                                                                          
093800     PERFORM                                                              
093900         WITH TEST AFTER                                                  
094000         VARYING PV-RETRY-COUNTER                                         
094100         FROM 1 BY 1                                                      
094200         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
094300                   OR (SQLCODE = ZERO))                                   
094400                                                                          
094500         MOVE 'CURSOR: BOOKING-CSR' TO DP013-MESSAGE-TEXT (2)             
094600                                                                          
094700         EXEC SQL                                                         
094800              OPEN BOOKING-CSR                                            
094900         END-EXEC                                                         
095000                                                                          
095100         EVALUATE TRUE                                                    
095200             WHEN SQLCODE = ZERO                                          
095300             WHEN SQLCODE = -904                                          
095400             WHEN SQLCODE = -913                                          
095500                 CONTINUE                                                 
095600             WHEN SQLWARN0 NOT = SPACES                                   
095700             WHEN SQLCODE < ZERO                                          
095800             WHEN SQLCODE > ZERO                                          
095900                 MOVE '4010-OPEN-CURSOR'                                  
096000                                   TO DP013-PARAGRAPH                     
096100                 MOVE 'OPEN BKG CURSOR - '                                
096200                                   TO DP013-MESSAGE-TEXT (1)              
096300                 MOVE SQLCA        TO DP013-SQLCA                         
096400                 MOVE 'TIMBKPO '   TO DP013-DB2-TABLE-NAME (1)            
096500                 SET DP013-DB2-ABEND                                      
096600                     DP013-XCTL-DISPLAY-RESTART TO TRUE                   
096700                 PERFORM DP013-0000-PROCESS-ABEND                         
096800         END-EVALUATE                                                     
096900     END-PERFORM.                                                         
097000*                                                                         
097100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
097200         MOVE '4010-OPEN-CURSOR'   TO DP013-PARAGRAPH                     
097300         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO OPEN CSR'           
097400                                   TO DP013-MESSAGE-TEXT (1)              
097500         MOVE SQLCA                TO DP013-SQLCA                         
097600         MOVE 'TIMBKPO '           TO DP013-DB2-TABLE-NAME (1)            
097700         SET DP013-DB2-ABEND                                              
097800             DP013-XCTL-DISPLAY-RESTART                                   
097900                                   TO TRUE                                
098000         PERFORM DP013-0000-PROCESS-ABEND                                 
098100     END-IF.                                                              
098200                                                                          
098300 EJECT                                                                    
098400*----------------------------------------------------------------*        
098500*   CLOSE THE CONTAINER BOOKING CURSOR                           *        
098600*----------------------------------------------------------------*        
098700 4020-CLOSE-CURSOR.                                                       
098800                                                                          
098900     EXEC SQL                                                             
099000          CLOSE BOOKING-CSR                                               
099100     END-EXEC.                                                            
099200                                                                          
099300     EVALUATE TRUE                                                        
099400         WHEN SQLCODE = ZERO                                              
099500             CONTINUE                                                     
099600         WHEN SQLWARN0 NOT = SPACES                                       
099700         WHEN SQLCODE < ZERO                                              
099800         WHEN SQLCODE > ZERO                                              
099900             MOVE '4020-CLOSE-CURSOR'                                     
100000                               TO DP013-PARAGRAPH                         
100100             MOVE 'CLOSE BKG CURSOR '                                     
100200                               TO DP013-MESSAGE-TEXT (1)                  
100300             MOVE SQLCA        TO DP013-SQLCA                             
100400             MOVE 'TIMBKPO '   TO DP013-DB2-TABLE-NAME (1)                
100500             SET DP013-DB2-ABEND                                          
100600                 DP013-XCTL-DISPLAY-RESTART TO TRUE                       
100700             PERFORM DP013-0000-PROCESS-ABEND                             
100800     END-EVALUATE.                                                        
100900                                                                          
101000 EJECT                                                                    
101100*----------------------------------------------------------------*        
101200*    READ THE ITEMS FROM THE DATA BASE AND MOVE THEM INTO THE    *        
101300*    BLOCKS IN THE ARRAY.  WHENEVER BOTH BLOCKS BECOME FULL,     *        
101400*    WRITE OUT THE 1ST BLOCK TO TEMPORARY STORAGE, MOVE THE 2ND  *        
101500*    BLOCK IN THE ARRAY TO THE 1ST BLOCK, AND INITIALIZE THE     *        
101600*    2ND BLOCK MAKING IT AVAILABLE TO BE USED.                   *        
101700*                                                                *        
101800*    DUE TO THE SIZE OF THE TABLE, AND THE ORDER IN WHICH THE    *        
101900*    ROWS ARE SORTED, THE ENTIRE TABLE IS READ INTO THE PROGRAM  *        
102000*    UPON INITIALIZATION.                                        *        
102100*----------------------------------------------------------------*        
102200 4300-READ-ITEMS-FROM-DB.                                                 
102300                                                                          
102400     PERFORM                                                              
102500         VARYING PV-READ-COUNT                                            
102600         FROM 1 BY 1                                                      
102700         UNTIL ((PV-READ-COUNT > PC-MAX-ITEMS)                            
102800            OR (ASC-NO-ITEMS-LEFT-ON-DB))                                 
102900                                                                          
103000         PERFORM 4310-FETCH                                               
103100                                                                          
103200         IF  ASC-ITEMS-LEFT-ON-DB                                         
103300             IF  ASC-ITEM-SUB < PC-ITEMS-PER-PANEL                        
103400                 ADD +1            TO ASC-ITEM-SUB                        
103500             ELSE                                                         
103600                 ADD +1            TO ASC-BLK-SUB                         
103700                 MOVE +1           TO ASC-ITEM-SUB                        
103800                                                                          
103900                 IF  ASC-BLK-SUB > PC-MAX-BLOCKS-IN-ARRAY                 
104000                     MOVE +1       TO ASC-BLK-SUB                         
104100                     SET ASC-BLOCK-MODIFIED (1)                           
104200                                   TO TRUE                                
104300                     PERFORM 5100-WRITE-TEMP-STORAGE                      
104400                     MOVE ASC-BLOCK-ENTRIES                               
104500                               (PC-MAX-BLOCKS-IN-ARRAY)                   
104600                                TO ASC-BLOCK-ENTRIES(ASC-BLK-SUB)         
104700                     ADD +1        TO ASC-BLK-SUB                         
104800                     INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)           
104900                     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB)              
105000                                   TO  TRUE                               
105100                 END-IF                                                   
105200             END-IF                                                       
105300             ADD +1                TO  ASC-NUMBER-OF-ITEMS-READ           
105400             MOVE ASC-NUMBER-OF-ITEMS-READ                                
105500                                   TO  ASC-LIST-ITEM-NUMBER               
105600                                       (ASC-BLK-SUB ASC-ITEM-SUB)         
105617             MOVE IMBKPO-ORGN-SHPD-FR-CDE                                 
105618                                   TO  ASC-TYPE                           
105620                                       (ASC-BLK-SUB ASC-ITEM-SUB)         
105630             MOVE IMBKPO-EXTL-REF-NBR                                     
105640                                   TO  ASC-REF-NBR                        
105650                                       (ASC-BLK-SUB ASC-ITEM-SUB)         
105652             MOVE IMBKPO-PO-BKG-DELY-TMST (1:10)                          
105653                                   TO  ASC-DELY-DT                        
105660                                       (ASC-BLK-SUB ASC-ITEM-SUB)         
106600         END-IF                                                           
111500     END-PERFORM.                                                         
111600                                                                          
111700     IF  ASC-NUMBER-OF-ITEMS-READ > ZERO                                  
111800         MOVE +1               TO ASC-BLK-SUB                             
111900         PERFORM 5100-WRITE-TEMP-STORAGE                                  
112000         ADD +1                TO ASC-BLK-SUB                             
112100         PERFORM 5100-WRITE-TEMP-STORAGE                                  
112200                                                                          
112300         MOVE 1                TO ASC-BLK-SUB                             
112400                                  PV-BLOCK-NUMBER                         
112500         PERFORM 4410-READ-TEMP-STORAGE                                   
112600         IF  ASC-HIGHEST-BLOCK-WRITTEN GREATER THAN 1                     
112700             MOVE 2            TO ASC-BLK-SUB                             
112800                                  PV-BLOCK-NUMBER                         
112900             PERFORM 4410-READ-TEMP-STORAGE                               
113000         END-IF                                                           
113100     END-IF.                                                              
113200                                                                          
113300 EJECT                                                                    
113301*----------------------------------------------------------------*11340099
113302*    FETCH THE BOOKING CURSOR.                                   *11350099
113303*----------------------------------------------------------------*11360099
113304 4310-FETCH.                                                      11370099
113305                                                                  11380099
113306     EXEC SQL                                                     11390099
113307          FETCH BOOKING-CSR                                       11400099
113308          INTO  :IMBKPO-PO-BKG-DELY-TMST                          11410099
113309              , :IMBKPO-EXTL-REF-NBR                              11420099
113317              , :IMBKPO-ORGN-SHPD-FR-CDE                          11500099
113319     END-EXEC.                                                    11520099
113320                                                                  11530099
113321     EVALUATE TRUE                                                11540099
113322         WHEN SQLCODE = ZERO                                      11550099
113323         WHEN SQLCODE = +100                                      11560099
113324              CONTINUE                                            11570099
113325         WHEN SQLWARN0 NOT = SPACE                                11580099
113326         WHEN SQLCODE NOT = ZERO                                  11590099
113327              MOVE '4310-FETCH-CURSOR'                            11600099
113328                               TO DP013-PARAGRAPH                 11610099
113329              MOVE 'FETCH BOOKING CURSOR'                         11620099
113330                               TO DP013-MESSAGE-TEXT (1)          11630099
113331              MOVE SQLCA       TO DP013-SQLCA                     11640099
113332              SET DP013-DB2-ABEND                                 11650099
113333                               TO TRUE                            11660099
113334              PERFORM DP013-0000-PROCESS-ABEND                    11670099
113335     END-EVALUATE.                                                11680099
113336                                                                  11690099
113337     IF  SQLCODE EQUAL +100                                       11700099
113338         SET ASC-NO-ITEMS-LEFT-ON-DB                              11710099
113339                                   TO TRUE                        11720099
113340     END-IF.                                                      11730099
113350                                                                  11740099
113400 EJECT                                                            11750099
117600*----------------------------------------------------------------*        
117700*        FORMAT THE DB2 DATE TO MM/DD/YY.                        *        
117800*----------------------------------------------------------------*        
117900 4320-FORMAT-DATE.                                                        
118000                                                                          
118100     MOVE PV-DB-MM          TO  PV-DD-MM.                                 
118200     MOVE PV-DB-DD          TO  PV-DD-DD.                                 
118300     MOVE PV-DB-YY          TO  PV-DD-YY.                                 
118400                                                                          
118500 EJECT                                                                    
124800*----------------------------------------------------------------*        
124900* MOVE THE DISPLAYED FIELDS FROM THE COMMAREA TO THE SCREEN.     *        
125000*----------------------------------------------------------------*        
125100 4400-MOVE-COMMAREA-TO-SCREEN.                                            
125200                                                                          
125300     IF  (((PV-TOP-ITEM > ASC-LIST-ITEM-NUMBER (1 1))                     
125400         AND (PV-TOP-ITEM > ASC-LIST-ITEM-NUMBER (2 1)))                  
125500         OR  (PV-TOP-ITEM < ASC-LIST-ITEM-NUMBER (1 1)))                  
125600             MOVE +1    TO ASC-BLK-SUB                                    
125700             PERFORM 5100-WRITE-TEMP-STORAGE                              
125800             ADD +1     TO ASC-BLK-SUB                                    
125900             PERFORM 5100-WRITE-TEMP-STORAGE                              
126000             DIVIDE PV-TOP-ITEM BY PC-ITEMS-PER-PANEL                     
126100                 GIVING PV-BLOCK-NUMBER                                   
126200                 REMAINDER PV-REMAINDER                                   
126300             IF  PV-REMAINDER > ZERO                                      
126400                 ADD +1 TO PV-BLOCK-NUMBER                                
126500             END-IF                                                       
126600             MOVE +1    TO ASC-BLK-SUB                                    
126700             PERFORM 4410-READ-TEMP-STORAGE                               
126800             ADD +1     TO ASC-BLK-SUB                                    
126900                           PV-BLOCK-NUMBER                                
127000             PERFORM 4410-READ-TEMP-STORAGE                               
127100     END-IF.                                                              
127200     MOVE +1            TO ASC-BLK-SUB.                                   
127300     COMPUTE ASC-ITEM-SUB =                                               
127400         ((PV-TOP-ITEM - ASC-LIST-ITEM-NUMBER (1 1))                      
127500         + PC-ITEMS-PER-PANEL).                                           
127600                                                                          
127700     IF  ASC-ITEM-SUB > PC-ITEMS-PER-PANEL                                
127800         ADD +1         TO ASC-BLK-SUB                                    
127900         SUBTRACT PC-ITEMS-PER-PANEL FROM ASC-ITEM-SUB                    
128000     END-IF.                                                              
128100                                                                          
128200     COMPUTE ASC-ITEM-AT-BOT-OF-PANEL =                                   
128300         ((PV-TOP-ITEM + PC-ITEMS-PER-PANEL) - 1).                        
128400     PERFORM 4420-FORMAT-LIST-LINES                                       
128500         VARYING PV-SUB                                                   
128600         FROM PC-ITEMS-PER-PANEL BY -1                                    
128700         UNTIL PV-SUB < +1.                                               
128800                                                                          
128900     COMPUTE ASC-ITEMS-DISPLAYED =                                        
129000         ((ASC-ITEM-AT-BOT-OF-PANEL - PV-TOP-ITEM) + 1).                  
129001*                                                                         
129002     PERFORM 4401-SELECT-PO-DETAILS.                                      
129003     PERFORM 4402-SELECT-AD-DTE.                                          
129004     PERFORM 4403-SELECT-VND-STYL.                                        
129005     PERFORM 4404-OPEN-OUTR-PCK-CSR.                                      
129006     PERFORM 4405-FETCH-OUTR-PCK.                                         
129007     PERFORM 4406-CLOSE-OUTR-PCK-CSR.                                     
129010     PERFORM 4407-MOVE-PO-DTLS-TO-SCR.                                    
129100                                                                          
130000     MOVE PV-TOP-ITEM              TO ASC-ITEM-AT-TOP-OF-PANEL            
130100                                      ASTRTITO.                           
130200     MOVE ASC-ITEM-AT-BOT-OF-PANEL TO AENDITO.                            
130300     MOVE ASC-NUMBER-OF-ITEMS-READ TO ATOTITO.                            
130310*---------------------------------------------------------------*         
130320*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
130330*---------------------------------------------------------------*         
130400***  MOVE ASC-NUMBER-OF-SELECTED-ITEMS                                    
130500***                                TO ASELITO.                            
130600                                                                          
130700     IF  DP020-MSG-NUMBER-X = SPACE                                       
130800         IF  ASC-ITEM-AT-BOT-OF-PANEL < ASC-NUMBER-OF-ITEMS-READ          
130900*----------- MORE ITEMS TO DISPLAY ----                                   
131000             MOVE PC-TSYMSG-00279  TO DP020-MSG-NUMBER                    
131100             SET DP020-MSG-INFORMATIONAL TO TRUE                          
131200         END-IF                                                           
131300     END-IF.                                                              
131400                                                                          
131401 EJECT                                                                    
131402*----------------------------------------------------------------*        
131403*    SELECT PO DETAILS.                                          *        
131404*----------------------------------------------------------------*        
131405 4401-SELECT-PO-DETAILS.                                                  
131406                                                                          
131407     PERFORM                                                              
131408         WITH TEST AFTER                                                  
131409         VARYING PV-RETRY-COUNTER                                         
131410         FROM 1 BY 1                                                      
131411         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
131412            OR  (SQLCODE = ZERO)                                          
131413            OR  (SQLCODE = +100))                                         
131414                                                                          
131415         EXEC SQL                                                         
131416              SELECT A.DEPT_NBR,                                          
131417                     A.OTB_PER_NBR,                                       
131418                     A.TOT_UNT_QTY,                                       
131419                     A.PROD_CNTRY_CDE,                                    
131420                     B.ENT_NAME_DESC,                                     
131421                     C.CAN_IFNOT_SHIP_DTE,                                
131422                     C.EXT_CAN_DTE,                                       
131423                     C.STRT_FCTRY_DTE,                                    
131424                     C.LAST_FCTRY_DTE,                                    
131425                     C.DONT_SHIP_BEF_DTE,                                 
131426                     C.FOB_CDE,                                           
131427                     C.POE_CDE                                            
131428               INTO :PURCHS-DEPT-NBR,                                     
131429                    :PURCHS-OTB-PER-NBR,                                  
131430                    :PURCHS-TOT-UNT-QTY,                                  
131431                    :PURCHS-PROD-CNTRY-CDE,                               
131432                    :ENTNME-ENT-NAME-DESC,                                
131433                    :PLNSHP-CAN-IFNOT-SHIP-DTE,                           
131434                    :PLNSHP-EXT-CAN-DTE,                                  
131435                    :PLNSHP-STRT-FCTRY-DTE,                               
131436                    :PLNSHP-LAST-FCTRY-DTE,                               
131437                    :PLNSHP-DONT-SHIP-BEF-DTE,                            
131438                    :PLNSHP-FOB-CDE,                                      
131439                    :PLNSHP-POE-CDE                                       
131440                FROM TPURCHS A,                                           
131441                     TENTNME B,                                           
131442                     TPLNSHP C                                            
131443               WHERE A.PO_NBR         = :DK-PO-NBR                        
131444                 AND A.VER_STATUS_CDE = 'A'                               
131445                 AND B.ENT_ID         =  A.ENT_ID                         
131446                 AND B.TYPE_CDE       = '01'                              
131447                 AND C.PO_NBR         =  A.PO_NBR                         
131448                 AND C.VER_STATUS_CDE =  A.VER_STATUS_CDE                 
131449         END-EXEC                                                         
131450*                                                                         
131451         EVALUATE TRUE                                                    
131452             WHEN SQLCODE = ZERO                                          
131453             WHEN SQLCODE = +100                                          
131454             WHEN SQLCODE = -904                                          
131455             WHEN SQLCODE = -913                                          
131456                 CONTINUE                                                 
131457             WHEN SQLWARN0 NOT = SPACES                                   
131458             WHEN SQLCODE < ZERO                                          
131459             WHEN SQLCODE > ZERO                                          
131460                 MOVE '4401-SELECT-PO-DETAILS'                            
131461                                   TO DP013-PARAGRAPH                     
131462                 MOVE 'SQL ERROR SELECTING PO DETAILS'                    
131463                                   TO DP013-MESSAGE-TEXT (1)              
131464                 MOVE SQLCA        TO DP013-SQLCA                         
131465                 MOVE 'TPURCHS '   TO DP013-DB2-TABLE-NAME (1)            
131466                 SET DP013-DB2-ABEND                                      
131467                     DP013-XCTL-DISPLAY-RESTART TO TRUE                   
131468                 PERFORM DP013-0000-PROCESS-ABEND                         
131469         END-EVALUATE                                                     
131470     END-PERFORM.                                                         
131471*                                                                         
131472     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
131473         MOVE '4401-SELECT-PO-DETAILS'    TO DP013-PARAGRAPH              
131474         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT PO'          
131475                                   TO DP013-MESSAGE-TEXT (1)              
131476         MOVE SQLCA                TO DP013-SQLCA                         
131477         MOVE 'TPURCHS '           TO DP013-DB2-TABLE-NAME (1)            
131478         SET DP013-DB2-ABEND                                              
131479             DP013-XCTL-DISPLAY-RESTART                                   
131480                                   TO TRUE                                
131481         PERFORM DP013-0000-PROCESS-ABEND                                 
131482     END-IF.                                                              
131483                                                                          
131484 EJECT                                                                    
131485*----------------------------------------------------------------*        
131486*     SELECT AD DATE FROM TPURITM                                *        
131487*----------------------------------------------------------------*        
131488 4402-SELECT-AD-DTE.                                                      
131489                                                                          
131490     PERFORM                                                              
131491         WITH TEST AFTER                                                  
131492         VARYING PV-RETRY-COUNTER                                         
131493         FROM 1 BY 1                                                      
131494         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
131495         OR     (SQLCODE = ZERO)                                          
131496         OR     (SQLCODE = +100))                                         
131497                                                                          
131498         EXEC SQL                                                         
131499              SELECT                                                      
131500                     MIN(AD_EVNT_DTE)                                     
131501              INTO  :PURITM-AD-EVNT-DTE :PV-AD-DTE-IND                    
131502              FROM   TPURITM                                              
131503              WHERE  PO_NBR         = :DK-PO-NBR                          
131504                AND  VER_STATUS_CDE = 'A'                                 
131505                AND  AD_EVNT_DTE   ^= '0001-01-01'                        
131506         END-EXEC                                                         
131507*                                                                         
131508         EVALUATE TRUE                                                    
131509             WHEN SQLCODE = ZERO                                          
131510             WHEN SQLCODE = +100                                          
131511             WHEN SQLCODE = -904                                          
131512             WHEN SQLCODE = -913                                          
131513                  CONTINUE                                                
131514             WHEN SQLWARN0 NOT = SPACE                                    
131515             WHEN SQLCODE NOT = ZERO                                      
131516                  MOVE '4402-SELECT-AD-DTE'                               
131517                                   TO DP013-PARAGRAPH                     
131518                  MOVE 'SQL ERROR SELECTING AD DATE'                      
131519                                   TO DP013-MESSAGE-TEXT (1)              
131520                  MOVE SQLCA       TO DP013-SQLCA                         
131521                  MOVE 'TPURITM '  TO DP013-DB2-TABLE-NAME (1)            
131522                  SET DP013-DB2-ABEND                                     
131523                      DP013-XCTL-DISPLAY-RESTART TO TRUE                  
131524                  PERFORM DP013-0000-PROCESS-ABEND                        
131525         END-EVALUATE                                                     
131526     END-PERFORM.                                                         
131527*                                                                         
131528     IF SQLCODE EQUAL + 0                                                 
131529        MOVE PURITM-AD-EVNT-DTE    TO PV-DATE-BREAK                       
131530        PERFORM 4320-PROCESS-DATE                                         
131531        MOVE PV-DATE-DISPLAY       TO AADDTO                              
131532     ELSE                                                                 
131533        MOVE SPACES                TO AADDTO                              
131534     END-IF.                                                              
131535*                                                                         
131536     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
131537         MOVE '4402-SELECT-AD-DTE' TO DP013-PARAGRAPH                     
131538         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT AD-DA        
131539-             'TE'                 TO DP013-MESSAGE-TEXT (1)              
131540         MOVE SQLCA                TO DP013-SQLCA                         
131541         MOVE 'TPURITM '           TO DP013-DB2-TABLE-NAME (1)            
131542         SET DP013-DB2-ABEND                                              
131543             DP013-XCTL-DISPLAY-RESTART                                   
131544                                   TO TRUE                                
131545         PERFORM DP013-0000-PROCESS-ABEND                                 
131546     END-IF.                                                              
131547                                                                          
131548 EJECT                                                                    
131549*----------------------------------------------------------------*        
131550*     SELECT VENDOR STYLE NAME FROM XLT_VND_STYL TABLE           *        
131551*----------------------------------------------------------------*        
131552 4403-SELECT-VND-STYL.                                                    
131553                                                                          
131554     PERFORM                                                              
131555         WITH TEST AFTER                                                  
131556         VARYING PV-RETRY-COUNTER                                         
131557         FROM 1 BY 1                                                      
131558         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
131559            OR  (SQLCODE = ZERO)                                          
131560            OR  (SQLCODE = +100)                                          
131561            OR  (SQLCODE = -811))                                         
131562                                                                          
131563         EXEC SQL                                                         
131564              SELECT   DISTINCT                                           
131565                       VS_NBR                                             
131566                INTO   :XLT00004-VS-NBR                                   
131567                FROM   TPURITM A                                          
131568                   ,   XLT_SKU B                                          
131569                   ,   XLT_VND_STYL C                                     
131570               WHERE   A.PO_NBR       = :DK-PO-NBR                        
131571                 AND   A.VER_STATUS_CDE = 'A'                             
131572                 AND   A.ITM_NBR = B.ITM_NBR                              
131573                 AND   B.STYL_ID = C.STYL_ID                              
131574         END-EXEC                                                         
131575                                                                          
131576         EVALUATE TRUE                                                    
131577             WHEN SQLCODE = ZERO                                          
131578             WHEN SQLCODE = +100                                          
131579             WHEN SQLCODE = -811                                          
131580             WHEN SQLCODE = -904                                          
131581             WHEN SQLCODE = -913                                          
131582                 CONTINUE                                                 
131583             WHEN SQLWARN0 NOT = SPACES                                   
131584             WHEN SQLCODE < ZERO                                          
131585             WHEN SQLCODE > ZERO                                          
131586                 MOVE '4403-SELECT-VND-STYL'                              
131587                                     TO DP013-PARAGRAPH                   
131588                 MOVE 'SQL ERROR SELECTING VENDOR STYLE'                  
131589                                     TO DP013-MESSAGE-TEXT (1)            
131590                 MOVE SQLCA          TO DP013-SQLCA                       
131591                 MOVE 'XLT_VND_STYL' TO DP013-DB2-TABLE-NAME (1)          
131592                 SET DP013-DB2-ABEND                                      
131593                     DP013-XCTL-DISPLAY-RESTART TO TRUE                   
131594                 PERFORM DP013-0000-PROCESS-ABEND                         
131595         END-EVALUATE                                                     
131596     END-PERFORM.                                                         
131597*                                                                         
131598     IF  SQLCODE EQUAL +0                                                 
131599         MOVE XLT00004-VS-NBR       TO AVNDSTYO                           
131600     ELSE                                                                 
131601         IF  SQLCODE EQUAL -811                                           
131602             MOVE '*MULTIPLES*'     TO AVNDSTYO                           
131603         END-IF                                                           
131604     END-IF.                                                              
131605*                                                                         
131606     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
131607         MOVE '4403-SELECT-VND-STYL'    TO DP013-PARAGRAPH                
131608         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO SELECT VENDO        
131609-             'R STYLE'            TO DP013-MESSAGE-TEXT (1)              
131610         MOVE SQLCA                TO DP013-SQLCA                         
131611         MOVE 'XLT_VND_STYL'       TO DP013-DB2-TABLE-NAME (1)            
131612         SET DP013-DB2-ABEND                                              
131613             DP013-XCTL-DISPLAY-RESTART                                   
131614                                   TO TRUE                                
131615         PERFORM DP013-0000-PROCESS-ABEND                                 
131616     END-IF.                                                              
131617                                                                          
131618 EJECT                                                                    
131684*----------------------------------------------------------------*        
131685*     OPEN THE OUTER PACK CURSOR                                 *        
131686*----------------------------------------------------------------*        
131687 4404-OPEN-OUTR-PCK-CSR.                                                  
131688                                                                          
131689     PERFORM                                                              
131690         WITH TEST AFTER                                                  
131691         VARYING PV-RETRY-COUNTER                                         
131692         FROM 1 BY 1                                                      
131693         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                       
131694            OR  (SQLCODE = ZERO))                                         
131695                                                                          
131696         MOVE 'CURSOR:  OUTR-PCK-CSR' TO DP013-MESSAGE-TEXT (2)           
131697                                                                          
131698         EXEC SQL                                                         
131699              OPEN OUTR-PCK-CSR                                           
131700         END-EXEC                                                         
131701*                                                                         
131702         EVALUATE TRUE                                                    
131703             WHEN SQLCODE = ZERO                                          
131704             WHEN SQLCODE = -904                                          
131705             WHEN SQLCODE = -913                                          
131706                 CONTINUE                                                 
131707             WHEN SQLWARN0 NOT = SPACES                                   
131708             WHEN SQLCODE < ZERO                                          
131709             WHEN SQLCODE > ZERO                                          
131710                 MOVE '4404-OPEN-OUTR-PCK-CSR'                            
131711                                   TO DP013-PARAGRAPH                     
131712                 MOVE 'OPEN OUTER-PACK CURSOR - '                         
131713                                   TO DP013-MESSAGE-TEXT (1)              
131714                 MOVE SQLCA        TO DP013-SQLCA                         
131715                 MOVE 'TUPC   '   TO DP013-DB2-TABLE-NAME (1)             
131716                 SET DP013-DB2-ABEND                                      
131717                     DP013-XCTL-DISPLAY-RESTART TO TRUE                   
131718                 PERFORM DP013-0000-PROCESS-ABEND                         
131719         END-EVALUATE                                                     
131720     END-PERFORM.                                                         
131721*                                                                         
131722     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                                
131723         MOVE '4404-OPEN-OUTR-PCK-CSR'   TO DP013-PARAGRAPH               
131724         MOVE 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO OPEN CSR'           
131725                                   TO DP013-MESSAGE-TEXT (1)              
131726         MOVE SQLCA                TO DP013-SQLCA                         
131727         MOVE 'TUPC    '           TO DP013-DB2-TABLE-NAME (1)            
131728         SET DP013-DB2-ABEND                                              
131729             DP013-XCTL-DISPLAY-RESTART                                   
131730                                   TO TRUE                                
131731         PERFORM DP013-0000-PROCESS-ABEND                                 
131732     END-IF.                                                              
131733                                                                          
131734 EJECT                                                                    
131735*----------------------------------------------------------------*        
131736*     FETCH THE OUTER PACK QUANTITY                              *        
131737*----------------------------------------------------------------*        
131738 4405-FETCH-OUTR-PCK.                                                     
131739                                                                          
131740     PERFORM                                                              
131741         WITH TEST AFTER                                                  
131742         VARYING PV-RETRY-COUNTER                                         
131743         FROM 1 BY 1                                                      
131750         UNTIL (SQLCODE = +100)                                           
131800                                                                          
171987         EXEC SQL                                                 07910099
171988              FETCH OUTR-PCK-CSR                                  07920099
171990              INTO  :PURITM-UNT-QTY                               07940099
171991                 ,  :PURITM-OUTR-PK-QTY                           07930099
171992         END-EXEC                                                 07950099
171993*                                                                         
171994         EVALUATE TRUE                                                    
171995             WHEN SQLCODE = ZERO                                          
171996             WHEN SQLCODE = +100                                          
171997                  CONTINUE                                                
171998             WHEN SQLWARN0 NOT = SPACE                                    
171999             WHEN SQLCODE NOT = ZERO                                      
172000                  MOVE '4405-FETCH-OUTR-PCK'                              
172001                                   TO DP013-PARAGRAPH                     
172002                  MOVE 'FETCH OUTER-PACK CURSOR'                          
172003                                   TO DP013-MESSAGE-TEXT (1)              
172004                  MOVE SQLCA       TO DP013-SQLCA                         
172005                  SET DP013-DB2-ABEND                                     
172006                                   TO TRUE                                
172007                  PERFORM DP013-0000-PROCESS-ABEND                        
172008         END-EVALUATE                                                     
172009*                                                                         
172010         IF  SQLCODE EQUAL +0                                             
172011             IF PURITM-OUTR-PK-QTY = 0                                    
172012                DIVIDE 1 INTO PURITM-UNT-QTY                              
172013                GIVING PV-ITEM-CART-CNT ROUNDED                           
172014             ELSE                                                         
172015                DIVIDE PURITM-OUTR-PK-QTY INTO PURITM-UNT-QTY             
172016                GIVING PV-ITEM-CART-CNT ROUNDED                           
172017             END-IF                                                       
172018             ADD PV-ITEM-CART-CNT TO PV-PO-CART-CNT                       
172019         END-IF                                                           
172020     END-PERFORM.                                                         
172021                                                                          
172022 EJECT                                                                    
172023*----------------------------------------------------------------*        
172024*     CLOSE THE OUTER PACK CURSOR                                *        
172025*----------------------------------------------------------------*        
172026 4406-CLOSE-OUTR-PCK-CSR.                                                 
172027                                                                          
172028     EXEC SQL                                                             
172029          CLOSE OUTR-PCK-CSR                                              
172030     END-EXEC.                                                            
172031*                                                                         
172032     EVALUATE TRUE                                                        
172033         WHEN SQLCODE = ZERO                                              
172034             CONTINUE                                                     
172035         WHEN SQLWARN0 NOT = SPACES                                       
172036         WHEN SQLCODE < ZERO                                              
172037         WHEN SQLCODE > ZERO                                              
172038             MOVE '4406-CLOSE-OUTR-PCK-CSR'                               
172039                               TO DP013-PARAGRAPH                         
172040             MOVE 'CLOSE OUTER-PACK CURSOR '                              
172041                               TO DP013-MESSAGE-TEXT (1)                  
172042             MOVE SQLCA        TO DP013-SQLCA                             
172043             MOVE 'TUPC    '   TO DP013-DB2-TABLE-NAME (1)                
172044             SET DP013-DB2-ABEND                                          
172045                 DP013-XCTL-DISPLAY-RESTART TO TRUE                       
172046             PERFORM DP013-0000-PROCESS-ABEND                             
172047     END-EVALUATE.                                                        
172048                                                                          
172049 EJECT                                                                    
172050*----------------------------------------------------------------*        
172051*    MOVE PO DETAILS TO SCREEN.                                  *        
172052*----------------------------------------------------------------*        
172053 4407-MOVE-PO-DTLS-TO-SCR.                                                
172054                                                                          
172055     MOVE ASC-KEY-PO-NBR            TO APONBRO.                           
172056     MOVE PURCHS-DEPT-NBR           TO PV-DEPT-NBR-N.                     
172057     MOVE PV-DEPT-NBR-N             TO ADEPTO.                    DPKCS036
172058     MOVE PURCHS-OTB-PER-NBR        TO AOTBO.                             
172059     MOVE PURCHS-TOT-UNT-QTY        TO AUNTSO.                            
172060     MOVE PURCHS-PROD-CNTRY-CDE     TO ACNTRYO.                           
172061     MOVE ENTNME-ENT-NAME-DESC      TO AVNDNMEO.                          
172062     MOVE PLNSHP-FOB-CDE            TO AFOBO.                             
172063     MOVE PLNSHP-POE-CDE            TO APOEO.                             
172064     MOVE PV-PO-CART-CNT            TO ACTNSO.                            
172065*                                                                         
172066     IF PLNSHP-CAN-IFNOT-SHIP-DTE   =  PC-INIT-DATE                       
172067        MOVE SPACES                 TO ACANDTO                            
172068     ELSE                                                                 
172069        MOVE PLNSHP-CAN-IFNOT-SHIP-DTE                                    
172070                                    TO PV-DATE-BREAK                      
172071        PERFORM 4320-PROCESS-DATE                                         
172072        MOVE PV-DATE-DISPLAY        TO ACANDTO                            
172073     END-IF.                                                              
172074*                                                                         
172075     IF PLNSHP-EXT-CAN-DTE          =  PC-INIT-DATE                       
172076        MOVE SPACES                 TO AXCANDTO                           
172077     ELSE                                                                 
172078        MOVE PLNSHP-EXT-CAN-DTE     TO PV-DATE-BREAK                      
172079        PERFORM 4320-PROCESS-DATE                                         
172080        MOVE PV-DATE-DISPLAY        TO AXCANDTO                           
172081     END-IF.                                                              
172082*                                                                         
172083     IF PLNSHP-STRT-FCTRY-DTE       =  PC-INIT-DATE                       
172084        MOVE SPACES                 TO ASTXFDTO                           
172085     ELSE                                                                 
172086        MOVE PLNSHP-STRT-FCTRY-DTE  TO PV-DATE-BREAK                      
172087        PERFORM 4320-PROCESS-DATE                                         
172088        MOVE PV-DATE-DISPLAY        TO ASTXFDTO                           
172089     END-IF.                                                              
172090*                                                                         
172091     IF PLNSHP-LAST-FCTRY-DTE       =  PC-INIT-DATE                       
172092        MOVE SPACES                 TO ALTXFDTO                           
172093     ELSE                                                                 
172094        MOVE PLNSHP-LAST-FCTRY-DTE  TO PV-DATE-BREAK                      
172095        PERFORM 4320-PROCESS-DATE                                         
172096        MOVE PV-DATE-DISPLAY        TO ALTXFDTO                           
172097     END-IF.                                                              
172098*                                                                         
172099     IF PLNSHP-DONT-SHIP-BEF-DTE    =  PC-INIT-DATE                       
172100        MOVE SPACES                 TO ADSHBEFO                           
172101     ELSE                                                                 
172102        MOVE PLNSHP-DONT-SHIP-BEF-DTE                                     
172103                                    TO PV-DATE-BREAK                      
172104        PERFORM 4320-PROCESS-DATE                                         
172105        MOVE PV-DATE-DISPLAY        TO ADSHBEFO                           
172106     END-IF.                                                              
172107                                                                          
172108 EJECT                                                                    
172109*----------------------------------------------------------------*        
172110*    READ A BLOCK FROM TEMPORARY STORAGE INTO THE ARRAY.         *        
172111*----------------------------------------------------------------*        
172112 4410-READ-TEMP-STORAGE.                                                  
172113                                                                          
172114     EXEC CICS                                                            
172115         READQ TS                                                         
172116             QUEUE (ASC-LIST-QUEUE-NAME)                                  
172117             INTO  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))                       
172118             ITEM  (PV-BLOCK-NUMBER)                                      
172119             RESP  (PV-CICS-RESP)                                         
172120     END-EXEC.                                                            
172121                                                                          
172122     IF  ((PV-CICS-RESP = DFHRESP (NORMAL))                               
172123       OR (PV-CICS-RESP = DFHRESP (ITEMERR)))                             
172200         CONTINUE                                                         
172300     ELSE                                                                 
172400         SET DP013-CICS-ABEND     TO TRUE                                 
172500         SET DP013-NO-ROLLBACK    TO TRUE                                 
172600         MOVE '4410-READ-TEMP-STORAGE'                                    
172700                                  TO DP013-PARAGRAPH                      
172800         MOVE 'ERROR TRYING TO READ FROM TEMP STORAGE QUEUE'              
172900                                  TO DP013-MESSAGE-TEXT(1)                
173000         PERFORM DP013-0000-PROCESS-ABEND                                 
173100     END-IF.                                                              
173200                                                                          
173300     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB) TO TRUE.                     
173400                                                                          
173500     IF  PV-CICS-RESP = DFHRESP (ITEMERR)                                 
173600         INITIALIZE ASC-BLOCK-ENTRIES (ASC-BLK-SUB)                       
173700     END-IF.                                                              
173800                                                                          
173900 EJECT                                                                    
174000*----------------------------------------------------------------*        
174100*    PROCESS THE ITEMS IN THE ARRAY AND MOVE THEM TO THE MAP.    *        
174200*----------------------------------------------------------------*        
174300 4420-FORMAT-LIST-LINES.                                                  
174400                                                                          
174500     IF  ASC-ITEM-AT-BOT-OF-PANEL > ASC-NUMBER-OF-ITEMS-READ              
174600         SUBTRACT +1 FROM ASC-ITEM-AT-BOT-OF-PANEL                        
174610*---------------------------------------------------------------*         
174620*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
174630*---------------------------------------------------------------*         
174700***      MOVE DP015-ASK-DRK-OFF  TO MR-SELECTA    (PV-SUB)                
174800***      MOVE DP015-HL-OFF       TO MR-SELECTH    (PV-SUB)                
174900***      MOVE SPACES             TO MR-SELECTI    (PV-SUB)                
175000***                                 MR-ACTION     (PV-SUB)                
175100         MOVE SPACES             TO MR-DELY-DT    (PV-SUB)                
175200                                    MR-TYPE       (PV-SUB)                
175300                                    MR-REF-NBR    (PV-SUB)                
176000                                                                          
176200     ELSE                                                                 
176210*---------------------------------------------------------------*         
176220*    THESE LINES COMMENTED OUT TO MAKE NON SELECTABLE SCREEN.   *         
176230*---------------------------------------------------------------*         
176300***      IF  ASC-TEMP-SELECTED-SW (ASC-BLK-SUB ASC-ITEM-SUB)              
176400***                                                > SPACE                
176500***          MOVE ASC-TEMP-SELECTED-SW (ASC-BLK-SUB ASC-ITEM-SUB)         
176600***                              TO MR-SELECTI (PV-SUB)                   
176700***      ELSE                                                             
176800***          MOVE ASC-SELECTED-SW (ASC-BLK-SUB ASC-ITEM-SUB)              
176900***                              TO MR-SELECTI (PV-SUB)                   
177000***      END-IF                                                           
177100                                                                          
177200         IF  PV-TOP-ITEM NOT = ASC-ITEM-AT-TOP-OF-PANEL                   
177300***          MOVE ASC-ACTION   (ASC-BLK-SUB ASC-ITEM-SUB)                 
177400***                            TO MR-ACTION   (PV-SUB)                    
177602             IF ASC-DELY-DT (ASC-BLK-SUB ASC-ITEM-SUB) EQUAL              
177603                        SPACES OR PC-INIT-DATE                            
177604                 MOVE SPACES TO MR-DELY-DT (PV-SUB)                       
177605             ELSE                                                         
177606                 STRING  ASC-DELY-DT                                      
177607                          (ASC-BLK-SUB ASC-ITEM-SUB) (6:2) '/'            
177608                         ASC-DELY-DT                                      
177609                          (ASC-BLK-SUB ASC-ITEM-SUB) (9:2)                
177610                            DELIMITED BY SIZE                             
177611                              INTO MR-DELY-DT (PV-SUB)                    
177620             END-IF                                                       
177700             MOVE ASC-TYPE     (ASC-BLK-SUB ASC-ITEM-SUB)                 
177800                               TO MR-TYPE     (PV-SUB)                    
177900             MOVE ASC-REF-NBR  (ASC-BLK-SUB ASC-ITEM-SUB)                 
178000                               TO MR-REF-NBR  (PV-SUB)                    
179500         END-IF                                                           
179600     END-IF.                                                              
179700     SUBTRACT +1 FROM ASC-ITEM-SUB.                                       
179800     IF  ASC-ITEM-SUB < + 1                                               
179900         MOVE PC-ITEMS-PER-PANEL TO ASC-ITEM-SUB                          
180000         MOVE +1                 TO ASC-BLK-SUB                           
180100     END-IF.                                                              
180200                                                                          
180301*----------------------------------------------------------------*11760099
180302*        FORMAT THE DB2 DATE TO MM/DD/YY.                        *11770099
180303*----------------------------------------------------------------*11780099
180304 4320-PROCESS-DATE.                                               11790099
180305                                                                  11800099
180306     MOVE PV-DB-MM          TO  PV-DD-MM.                         11810099
180307     MOVE PV-DB-DD          TO  PV-DD-DD.                         11820099
180308     MOVE PV-DB-YY          TO  PV-DD-YY.                         11830099
180310                                                                  11840099
180400 EJECT                                                            11850099
180410*----------------------------------------------------------------*        
180500*    WRITE A NEW BLOCK FROM THE ARRAY TO TEMPORARY STORAGE.      *        
180600*    REWRITE AN EXISITING BLOCK ONLY IF IT HAS BEEN MODIFIED.    *        
180700*----------------------------------------------------------------*        
180800 5100-WRITE-TEMP-STORAGE.                                                 
180900                                                                          
181000     MOVE ASC-LIST-ITEM-NUMBER(ASC-BLK-SUB 1)                             
181100                                   TO PV-LIST-ITEM-NUMBER.                
181200     COMPUTE PV-BLOCK-NUMBER =                                            
181300         1 + ((PV-LIST-ITEM-NUMBER - 1) / PC-ITEMS-PER-PANEL).            
181400                                                                          
181500     IF (PV-BLOCK-NUMBER < ASC-HIGHEST-BLOCK-WRITTEN)                     
181600     OR (PV-BLOCK-NUMBER = ASC-HIGHEST-BLOCK-WRITTEN)                     
181700         IF  ASC-BLOCK-MODIFIED(ASC-BLK-SUB)                              
181800             PERFORM 5105-REWRITE-ASC-LISTQ                               
181900         END-IF                                                           
182000     ELSE                                                                 
182100         COMPUTE PV-HIGHEST-BLOCK-WRITTEN =                               
182200         ASC-HIGHEST-BLOCK-WRITTEN + 1                                    
182300         PERFORM 5110-WRITE-ASC-LISTQ                                     
182400         ADD +1                    TO ASC-HIGHEST-BLOCK-WRITTEN           
182500     END-IF.                                                              
182600                                                                          
182700     SET ASC-BLOCK-NOT-MODIFIED(ASC-BLK-SUB) TO TRUE.                     
182800                                                                          
182900 EJECT                                                                    
183000*----------------------------------------------------------------*        
183100*  REWRITE THE LIST TEMP STORAGE QUEUE FROM THE APPLICATION-     *        
183200*  SPECIFIC COMMAREA.                                            *        
183300*----------------------------------------------------------------*        
183400 5105-REWRITE-ASC-LISTQ.                                                  
183500                                                                          
183600     EXEC CICS                                                            
183700         WRITEQ TS                                                        
183800             QUEUE (ASC-LIST-QUEUE-NAME)                                  
183900             FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))                       
184000             ITEM  (PV-BLOCK-NUMBER)                                      
184100             REWRITE                                                      
184200             RESP  (PV-CICS-RESP)                                         
184300     END-EXEC.                                                            
184400                                                                          
184500     IF  PV-CICS-RESP = DFHRESP(NORMAL)                                   
184600         CONTINUE                                                         
184700     ELSE                                                                 
184800         SET DP013-CICS-ABEND            TO TRUE                          
184900         SET DP013-NO-ROLLBACK           TO TRUE                          
185000         MOVE '5105-REWRITE-ASC-LISTQ'   TO DP013-PARAGRAPH               
185100         MOVE 'ATTEMPTING TO REWRITE LIST TEMP STORAGE QUEUE'             
185200                                         TO DP013-MESSAGE-TEXT(1)         
185300         PERFORM DP013-0000-PROCESS-ABEND                                 
185400     END-IF.                                                              
185500                                                                          
185600 EJECT                                                                    
185700*----------------------------------------------------------------*        
185800*  WRITE THE LIST TEMP STORAGE QUEUE FROM THE APPLICATION-       *        
185900*  SPECIFIC COMMAREA.                                            *        
186000*----------------------------------------------------------------*        
186100 5110-WRITE-ASC-LISTQ.                                                    
186200                                                                          
186300     EXEC CICS                                                            
186400         WRITEQ TS                                                        
186500             QUEUE (ASC-LIST-QUEUE-NAME)                                  
186600             FROM  (ASC-BLOCK-ENTRIES(ASC-BLK-SUB))                       
186700             ITEM  (PV-BLOCK-NUMBER)                                      
186800             RESP  (PV-CICS-RESP)                                         
186900     END-EXEC.                                                            
187000                                                                          
187100     IF  PV-CICS-RESP NOT = DFHRESP (NORMAL)                              
187200         SET DP013-CICS-ABEND      TO TRUE                                
187300         SET DP013-NO-ROLLBACK     TO TRUE                                
187400         MOVE '5110-WRITE-ASC-LISTQ'                                      
187500                                   TO DP013-PARAGRAPH                     
187600         MOVE 'ATTEMPTING TO DELETE TEMP STORAGE QUEUE'                   
187700                                   TO DP013-MESSAGE-TEXT(1)               
187800         PERFORM DP013-0000-PROCESS-ABEND                                 
187900     END-IF.                                                              
188000                                                                          
188100 EJECT                                                                    
188200*----------------------------------------------------------------*        
188300*    ABEND PROCESSOR MODULE                                      *        
188400*----------------------------------------------------------------*        
188500                                                                          
188600     COPY DPPD013.                                                        
