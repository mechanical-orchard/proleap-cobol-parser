000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.         SVKUP085.                                    00040001
000500 AUTHOR.             MADHURA PETHE.                               00050008
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000700 DATE-WRITTEN.       JULY 2012.                                   00070008
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100* THIS PROGRAM WILL UPDATE THE ACTIVITY STATUS ON THE STORED     *00110000
001200* VALUE TRANSACTION TABLE, SVT_KOHLS_CRD_TXN USING CHECKPOINT/   *00120000
001300* RESTART. IT ALSO UPDATES THE SELR_PSTL_CDE AND SELR_TRN_ID ON  *00130000
001400* THE SVT_3RD_PTY_TRN TABLE.                                     *00140000
001500*                                                                *00150000
001600* INPUT FILES:   UPDATE POSTING FILE       DDNAME = INP01        *00160009
001700*                                                                *00170009
001800* OUTPUT FILES:  N/A                                             *00180009
001900*                                                                *00190009
002000******************************************************************00200009
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS991 TO    00201010
260107*                                      MAKE DPKUT901 CALL DYNAMIC.00202010
002200******************************************************************00220009
002300 ENVIRONMENT DIVISION.                                            00230009
002400******************************************************************00240009
002500                                                                  00250009
002600 CONFIGURATION SECTION.                                           00260009
002700                                                                  00270009
002800 SOURCE-COMPUTER.    IBM-3090.                                    00280009
002900 OBJECT-COMPUTER.    IBM-3090.                                    00290009
003000                                                                  00300009
003100 INPUT-OUTPUT SECTION.                                            00310009
003200                                                                  00320009
003300 FILE-CONTROL.                                                    00330009
003400                                                                  00340009
003500******************************************************************00350009
003600 DATA DIVISION.                                                   00360009
003700******************************************************************00370009
003800                                                                  00380009
003900 WORKING-STORAGE SECTION.                                         00390009
004000                                                                  00400009
004100 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00410009
004200                                                                  00420009
004300******************************************************************00430009
004400*PC - PROGRAM CONSTANTS                                           00440009
004500******************************************************************00450009
004600 01  PROGRAM-CONSTANTS.                                           00460009
004700     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00470009
004800                                                COMP SYNC.        00480009
004900     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00490009
005000                                                COMP SYNC.        00500009
005100     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'SVK006  '. 00510009
005200     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'SVKUP085'. 00520009
005300     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'SVKUP085'. 00530009
005400                                                                  00540009
005500     05  PC-TRAN-PRES-FUNC-CODES.                                 00550009
005600         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00560009
005700         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00570009
005800         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00580009
005900         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00590009
006000                                                                  00600009
006100******************************************************************00610009
006200*PV - PROGRAM VARIABLES                                           00620009
006300******************************************************************00630009
006400 01  PROGRAM-VARIABLES.                                           00640009
006500     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00650009
006600     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00660009
006700     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00670009
006800     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00680009
006900     05  PV-CARD-NBR            PIC S9(12)V COMP-3 VALUE ZERO.    00690009
007000                                                                  00700009
007100******************************************************************00710009
007200*PS - PROGRAM SWITCHES                                            00720009
007300******************************************************************00730009
007400 01  PROGRAM-SWITCHES.                                            00740009
007500     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00750009
007600         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00760009
007700         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00770009
007800                                                                  00780009
007900******************************************************************00790009
008000*  INCOMM  UPDATE POSTING RECORD LAYOUT                          *00800009
008100******************************************************************00810009
008200     COPY SVRD072.                                                00820009
008300                                                                  00830009
008400******************************************************************00840009
008500*  STORED VALUE CARD CONSTANTS                                   *00850009
008600******************************************************************00860009
008700     COPY SVWS004.                                                00870009
008800                                                                  00880009
008900******************************************************************00890009
009000*  DCLGEN FOR KOHL'S MERCHANDISE CARD ACTIVITY TABLE             *00900009
009100******************************************************************00910009
009200     EXEC SQL                                                     00920009
009300         INCLUDE SVT00002                                         00930009
009400     END-EXEC.                                                    00940009
009500                                                                  00950009
009600******************************************************************00960009
009700*  SQL COMMUNICATIONS WORK AREA                                  *00970009
009800******************************************************************00980009
009900     COPY SQLCA2.                                                 00990009
010000                                                                  01000009
010100******************************************************************01010009
010200*  DB2 FORMATTED ERROR MESSAGE                                   *01020009
010300******************************************************************01030009
010400     COPY DPWS004.                                                01040009
010500                                                                  01050009
010600******************************************************************01060009
010700*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01070009
010800******************************************************************01080009
260107     COPY DPWS991.                                                01090010
010900                                                                  01091010
010900     COPY DPLS001.                                                01092010
011000     05  WORK-STORAGE-PASSED.                                     01100009
011100******************************************************************01110009
011200*PA - PROGRAM ACCUMULATORS                                        01120009
011300******************************************************************01130009
011400         10  PROGRAM-ACCUMULATORS.                                01140009
011500             15  PA-CRD-TXN-ROWS-UPDATED   PIC S9(11)  VALUE ZERO 01150009
011600                                                       COMP-3.    01160009
011700             15  PA-CRD-TXN-ORIG-INSERTED  PIC S9(11)  VALUE ZERO 01170009
011800                                                       COMP-3.    01180009
011900             15  PA-CRD-TXN-VOIDS-INSERTED PIC S9(11)  VALUE ZERO 01190009
012000                                                       COMP-3.    01200009
012100                                                                  01210009
012200 01  FILLER                          PIC X(4096)  VALUE SPACE.    01220009
012300******************************************************************01230009
012400*  COMMUNICATIONS AREA FOR DB2                                   *01240009
012500******************************************************************01250009
012600     EXEC SQL                                                     01260009
012700         INCLUDE SQLCA                                            01270009
012800     END-EXEC.                                                    01280009
012900                                                                  01290009
013000******************************************************************01300009
013100 PROCEDURE DIVISION.                                              01310009
013200******************************************************************01320009
013300 A100-MAINLINE.                                                   01330009
013400                                                                  01340009
013500     PERFORM B100-INITIALIZE.                                     01350009
013600                                                                  01360009
013700     PERFORM B200-PROCESS-UPDATE-RECORDS                          01370009
013800         UNTIL DP001-PREP-TRANS-EOF.                              01380009
013900                                                                  01390009
014000     PERFORM B300-EOJ-ROUTINE.                                    01400009
014100                                                                  01410009
014200     GOBACK.                                                      01420009
014300                                                                  01430009
014400******************************************************************01440009
014500*     B100-INITIALIZE                                            *01450009
014600* ==> PROCESSES:                                                 *01460009
014700* ==> PERFORMED FROM: A100-MAINLINE                              *01470009
014800******************************************************************01480009
014900 B100-INITIALIZE.                                                 01490009
015000                                                                  01500009
015100     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01510009
015200     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01520009
015300                                                                  01530009
015400******************************************************************01540009
015500*     B200-PROCESS-UPDATE-RECORDS                                *01550009
015600* ==> PROCESSES:                                                 *01560009
015700* ==> PERFORMED FROM: A100-MAINLINE                              *01570009
015800******************************************************************01580009
015900 B200-PROCESS-UPDATE-RECORDS.                                     01590009
016000                                                                  01600009
016100     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         01610009
016200                                                                  01620009
016300     MOVE SV072-CARD-NBR TO PV-CARD-NBR.                          01630009
016400     PERFORM C100-UPDATE-CRD-TXN-RECORD.                          01640009
016500                                                                  01650009
016600*----------------------------------------------------------------*01660009
016700*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *01670009
016800*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *01680009
016900*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *01690009
017000*----------------------------------------------------------------*01700009
017100     IF PS-RESTART-REQUIRED                                       01710009
017200         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          01720009
017300     ELSE                                                         01730009
017400         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          01740009
017500     END-IF.                                                      01750009
017600                                                                  01760009
017700     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01770009
017800                                                                  01780009
017900******************************************************************01790009
018000*     B300-EOJ-ROUTINE                                           *01800009
018100* ==> PROCESSES:                                                 *01810009
018200* ==> PERFORMED FROM: A100-MAINLINE                              *01820009
018300******************************************************************01830009
018400 B300-EOJ-ROUTINE.                                                01840009
018500                                                                  01850009
018600     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             01860009
018700     PERFORM Z100-BUILD-COMM-AREA-TRAN-PRES.                      01870009
018800                                                                  01880009
018900******************************************************************01890009
019000*     Z100-BUILD-COMM-AREA-TRAN-PRES                             *01900009
019100* ==> PROCESSES:                                                 *01910009
019200*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *01920009
019300*       TRANSACTION PRESENTATION MODULE.                         *01930009
019400* ==> PERFORMED FROM:                                            *01940009
019500******************************************************************01950009
019600 Z100-BUILD-COMM-AREA-TRAN-PRES.                                  01960009
019700                                                                  01970009
019800     MOVE LENGTH OF WORK-STORAGE-PASSED                           01980009
019900                                       TO DP001-WORK-STRG-LENGTH. 01990009
020000     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         02000009
020100     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        02010009
020200     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         02020009
020300     MOVE DP001-TRANS-RECORD   TO SV072-DETAIL-TRANS.             02030009
020400     IF DP001-CKPT-TAKEN                                          02040009
020500         INITIALIZE PV-DEADLOCK-COUNTER                           02050009
020600     END-IF.                                                      02060009
020700                                                                  02070009
020800******************************************************************02080009
020900*     C100-UPDATE-CRD-TXN-RECORD                                 *02090009
021000* ==> PROCESSES:                                                 *02100009
021100*     - UPDATES THE ACTIVITY STATUS CODE TO VERIFIED             *02110009
021200* ==> PERFORMED FROM:  B200-PROCESS-UPDATE-RECORDS               *02120009
021300******************************************************************02130009
021400 C100-UPDATE-CRD-TXN-RECORD.                                      02140009
021500                                                                  02150009
021600     PERFORM WITH TEST AFTER                                      02160009
021700         VARYING PV-SQL-SUB                                       02170009
021800         FROM 1 BY 1                                              02180009
021900         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02190009
022000                OR SQLCODE = -911                                 02200009
022100                OR SQLCODE = 0)                                   02210009
022200                                                                  02220009
022300         EXEC SQL                                                 02230009
022400             UPDATE SVT_KOHLS_CRD_TXN                             02240009
022500             SET  ACTVY_STAT_CDE  = :SV004-STAT-VERIFIED-CD       02250009
022600                 ,TRN_PSTD_TMST   = CURRENT_TIMESTAMP             02260009
022700             WHERE CRD_NBR        = :PV-CARD-NBR                  02270009
022800               AND TRN_AUTH_TMST  = :SV072-TRN-AUTH-TMST          02280009
022900         END-EXEC                                                 02290009
023000                                                                  02300009
023100         EVALUATE TRUE                                            02310009
023200             WHEN SQLCODE = 0                                     02320009
023300                 ADD +1 TO PA-CRD-TXN-ROWS-UPDATED                02330009
023400             WHEN SQLCODE = -911                                  02340009
023500                 ADD +1 TO PV-DEADLOCK-COUNTER                    02350009
023600                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02360009
023700                     MOVE 'C100-VERIFY-CRD-TXN-RECORD           ' 02370009
023800                                      TO PV-PARAGRAPH-NAME        02380009
023900                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02390009
024000                                      TO PV-DB2-OPER-ATTEMPTED    02400009
024100                     PERFORM Z900-SQL-ABEND                       02410009
024200                 ELSE                                             02420009
024300                     SET PS-RESTART-REQUIRED TO TRUE              02430009
024400                 END-IF                                           02440009
024500             WHEN OTHER                                           02450009
024600                 MOVE SV072-CARD-NBR TO PV-CARD-NBR               02460009
024700                 DISPLAY 'UPDATE ABENDED ON CARD ' PV-CARD-NBR    02470009
024800                 MOVE 'C100-UPDATE-CRD-TXN-RECORD           '     02480009
024900                                      TO PV-PARAGRAPH-NAME        02490009
025000                 MOVE 'UPDATE SVT_KOHLS_CRD_TXN      '            02500009
025100                                      TO PV-DB2-OPER-ATTEMPTED    02510009
025200                 PERFORM Z900-SQL-ABEND                           02520009
025300         END-EVALUATE                                             02530009
025400     END-PERFORM.                                                 02540009
025500                                                                  02550009
025600     IF PV-SQL-SUB > PC-MAX-RETRIES                               02560009
025700         MOVE 'C100-VERIFY-CRD-TXN-RECORD           '             02570009
025800                                      TO PV-PARAGRAPH-NAME        02580009
025900         MOVE 'VERIFY RETRIES EXCEEDED       '                    02590009
026000                                      TO PV-DB2-OPER-ATTEMPTED    02600009
026100         PERFORM Z900-SQL-ABEND                                   02610009
026200     END-IF.                                                      02620009
026300                                                                  02630009
026400******************************************************************02640009
026500*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *02650009
026600*  CODE OCCURS.                                                  *02660009
026700******************************************************************02670009
026800 Z900-SQL-ABEND.                                                  02680009
026900                                                                  02690009
027000     DISPLAY '** ABEND     **'.                                   02700009
027100     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02710009
027200     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              02720009
027300     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          02730009
027400                                                                  02740009
027500******************************************************************02750009
027600*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02760009
027700*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *02770009
027800*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *02780009
027900*  FORMAT.                                                       *02790009
028000******************************************************************02800009
028100     COPY DPPD004.                                                02810009
028200                                                                  02820009
028300     MOVE +4013 TO ABEND-CODE.                                    02830009
028400     CALL 'ILBOABN0' USING ABEND-CODE.                            02840009
028500                                                                  02850009
028600******************************************************************02860009
028700*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *02870009
028800*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*02880009
028900*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *02890009
029000******************************************************************02900009
029100     COPY DPPD001.                                                02910009
