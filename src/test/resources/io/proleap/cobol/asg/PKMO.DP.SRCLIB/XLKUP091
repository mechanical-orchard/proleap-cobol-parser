000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.   XLKUP091.                                          00050000
000600 AUTHOR.       AYAN (COGNIZANT).                                  00060000
000700 INSTALLATION. KOHLS DEPARTMENT STORES.                           00070000
000800 DATE-WRITTEN. SEP, 2014.                                         00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*PROGRAM TO UPDATE PACK-UPC IN TPOPRPK TABLE WITH THE UPC-NBR    *00120000
001300*PRESENT IN XLT_PK_UPC TABLE. IF THE PREPK_UPC_NBR MATCHES WITH  *00130000
001310*THE UPC_NBR IN XLT_PK_UPC FOR EDI_ORD_IND = 'N', THEN THE       *00131000
001320*PREPK_UPC_NBR IS UPDATED WITH THE UPC_NBR FROM XLT_PK_UPC FOR   *00132000
001330*EDI_ORD_IND = 'Y'.                                              *00133000
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600******************************************************************00160000
001700                                                                  00170000
001800 CONFIGURATION SECTION.                                           00180000
001900                                                                  00190000
002000 SOURCE-COMPUTER.        IBM-3090.                                00200000
002100 OBJECT-COMPUTER.        IBM-3090.                                00210000
002200                                                                  00220000
002300******************************************************************00230000
002400 DATA DIVISION.                                                   00240000
002500******************************************************************00250000
002600                                                                  00260000
002700******************************************************************00270000
002800 WORKING-STORAGE SECTION.                                         00280000
002900******************************************************************00290000
003000******************************************************************00300000
003100*  COMMUNICATIONS AREA FOR DB2                                   *00310000
003200******************************************************************00320000
003300     EXEC SQL                                                     00330000
003400          INCLUDE SQLCA                                           00340000
003500     END-EXEC.                                                    00350000
003600                                                                  00360000
003700******************************************************************00370000
003800*  DB2 TABLE DECLARATION - TPOPRPK                               *00380000
003900******************************************************************00390000
004000     EXEC SQL                                                     00400000
004100          INCLUDE TPOPRPK                                         00410000
004200     END-EXEC.                                                    00420000
004300                                                                  00430000
004400******************************************************************00440000
004500*  DB2 TABLE DECLARATION - XLT_PK_UPC                            *00450000
004600******************************************************************00460000
004700     EXEC SQL                                                     00470000
004800          INCLUDE XLT00009                                        00480000
004900     END-EXEC.                                                    00490000
005000                                                                  00500000
005100******************************************************************00510000
005200*    CURSOR TO SELECT SKU'S WHICH HAS DIFFERENCES IN PACK-UPC    *00520000
005300*    VALUE FOR A PACK-SKU IN XLT_PK_UPC AND TPOPRPK TABLE        *00530000
005400******************************************************************00540000
005500     EXEC SQL                                                     00550000
005600        DECLARE PK_UPC_CSR CURSOR WITH HOLD FOR                   00560000
005700            SELECT                                                00570000
005900                   A.PO_NBR                                       00590000
006000                  ,A.PK_SKU_NBR                                   00600000
006010                  ,A.PREPK_UPC_NBR                                00601000
006020                  ,A.PK_DTL_CHG_TMST                              00602000
006100            FROM                                                  00610000
006200                   TPOPRPK    A                                   00620000
006300                  ,XLT_PK_UPC B                                   00630000
006400            WHERE                                                 00640000
006500                   A.PK_DTL_CHG_TMST >                            00650000
006510                              '2014-01-01-00.00.00.000000'        00651000
006600               AND B.PK_SKU_NBR      = A.PK_SKU_NBR               00660000
006700               AND B.UPC_NBR         = A.PREPK_UPC_NBR            00670000
006710               AND NOT B.EDI_ORD_IND = 'Y'                        00671000
006800            ORDER BY                                              00680000
006810                    PO_NBR                                        00681000
006820                   ,PK_SKU_NBR                                    00682000
006900     END-EXEC.                                                    00690000
007000                                                                  00700000
007100******************************************************************00710000
007200*  WORK AREA FOR SQL ERROR ROUTINE 'DSNTIAR'                     *00720000
007300******************************************************************00730000
007400     COPY DPWS004.                                                00740000
007500                                                                  00750000
007600 01  ABEND-CODE                    PIC S9(04)  VALUE +0           00760000
007700                                                   COMP SYNC.     00770000
007800 01  PS-PROGRAM-SWITCHES.                                         00780000
007900     05  PS-END-OF-SKU_DESC-CSR-SW PIC X(01)   VALUE 'N'.         00790000
008000         88  PS-END-OF-PK-UPC-CSR              VALUE 'Y'.         00800000
008100         88  PS-END-OF-PK-UPC-CSR-NO           VALUE 'N'.         00810000
008200                                                                  00820000
008300 01  PC-PROGRAM-CONSTANTS.                                        00830000
008400     05  PC-PGM-NAME               PIC X(08)   VALUE 'XLKUP091'.  00840000
008500     05  PC-COMMIT-HOLD            PIC 9(03)   VALUE 100.         00850000
008510     05  PC-PK-DTL-CHG-TMST        PIC X(26)   VALUE              00851000
008520                                  '2014-01-01-00.00.00.000000'.   00852000
008600                                                                  00860000
008700 01 PV-PROGRAM-VARIABLES.                                         00870000
008800     05  PV-ABEND-PARAGRAPH        PIC X(35)   VALUE SPACES.      00880000
008900     05  PV-DB2-OPN-ATTEMPTED      PIC X(35)   VALUE SPACES.      00890000
009000     05  PV-FETCH-CNT              PIC 9(13)   VALUE ZEROES.      00900000
009100     05  PV-UPDATE-CNT             PIC 9(13)   VALUE ZEROES.      00910000
009200     05  PV-UPD-COUNT-TOT          PIC 9(13)   VALUE ZEROES.      00920000
009300     05  PV-COMMIT-CNT             PIC 9(13)   VALUE ZEROES.      00930000
009400     05  PV-DISPLAY-COUNT          PIC Z(12)9.                    00940000
009500                                                                  00950000
009600 LINKAGE SECTION.                                                 00960000
009700 PROCEDURE DIVISION.                                              00970000
009800******************************************************************00980000
009900*  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.  *00990000
010000******************************************************************01000000
010100 0000-PROGRAM-MAINLINE.                                           01010000
010200                                                                  01020000
010300     PERFORM 1000-INITIALIZE.                                     01030000
010400     PERFORM 2000-PROCESS-PK-UPC-DIFF.                            01040000
010500     PERFORM 8000-EOJ-ROUTINE.                                    01050000
010600                                                                  01060000
010700     STOP RUN.                                                    01070000
010800                                                                  01080000
010900******************************************************************01090000
011000*  PERFORMS INITIALIZATION.                                      *01100000
011100******************************************************************01110000
011200 1000-INITIALIZE.                                                 01120000
011300                                                                  01130000
011400     DISPLAY 'START OF PROGRAM : ' PC-PGM-NAME.                   01140000
011500                                                                  01150000
011600     INITIALIZE DCLTPOPRPK                                        01160000
011700                DCLXLT00009                                       01170000
011800                PV-PROGRAM-VARIABLES.                             01180000
011900                                                                  01190000
012000     SET PS-END-OF-PK-UPC-CSR-NO  TO TRUE.                        01200000
012100                                                                  01210000
012200*                                                                 01220000
012300******************************************************************01230000
012400* PERFORMS MAIN PROCESSING                                       *01240000
012500******************************************************************01250000
012600 2000-PROCESS-PK-UPC-DIFF.                                        01260000
012700                                                                  01270000
012800     PERFORM 2100-OPEN-PK-UPC-CSR.                                01280000
012900                                                                  01290000
013000     PERFORM 2200-FETCH-PK-UPC-CSR                                01300000
013100       UNTIL PS-END-OF-PK-UPC-CSR.                                01310000
013200                                                                  01320000
013300     PERFORM 2300-CLOSE-PK-UPC-CSR.                               01330000
013400                                                                  01340000
013500*                                                                 01350000
013600******************************************************************01360000
013700* OPENS PACK DESCRIPTION DIFERENCE CURSOR                        *01370000
013800******************************************************************01380000
013900 2100-OPEN-PK-UPC-CSR.                                            01390000
014000                                                                  01400000
014100     EXEC SQL                                                     01410000
014200          OPEN PK_UPC_CSR                                         01420000
014300     END-EXEC.                                                    01430000
014400                                                                  01440000
014500     EVALUATE TRUE                                                01450000
014600         WHEN SQLCODE = 0                                         01460000
014700             CONTINUE                                             01470000
014800         WHEN OTHER                                               01480000
014900             MOVE '2100-OPEN-PK-UPC-CSR'                          01490000
015000                                     TO PV-ABEND-PARAGRAPH        01500000
015100             MOVE 'OPEN PK_UPC_CSR'  TO PV-DB2-OPN-ATTEMPTED      01510000
015300             PERFORM 9100-SQL-ABEND                               01530000
015400     END-EVALUATE.                                                01540000
015500                                                                  01550000
015600*                                                                 01560000
015700******************************************************************01570000
015800* FETCHES PACK DESCRIPTION DIFFERENCE CURSOR                     *01580000
015900******************************************************************01590000
016000 2200-FETCH-PK-UPC-CSR.                                           01600000
016100                                                                  01610000
016200     INITIALIZE DCLTPOPRPK                                        01620000
016300                DCLXLT00009.                                      01630000
016400                                                                  01640000
016500     EXEC SQL                                                     01650000
016600          FETCH PK_UPC_CSR                                        01660000
016700           INTO :POPRPK-PO-NBR                                    01670000
016800               ,:POPRPK-PK-SKU-NBR                                01680000
016900               ,:POPRPK-PREPK-UPC-NBR                             01690000
016910               ,:POPRPK-PK-DTL-CHG-TMST                           01691000
017000     END-EXEC.                                                    01700000
017100                                                                  01710000
017200     EVALUATE TRUE                                                01720000
017300         WHEN SQLCODE = ZEROS                                     01730000
017400             ADD 1                 TO PV-FETCH-CNT                01740000
017410             DISPLAY '** BEFORE UPDATE **'                        01741000
017420             DISPLAY 'PO NUMBER       :' POPRPK-PO-NBR            01742000
017430             DISPLAY 'PACK SKU NUMBER :' POPRPK-PK-SKU-NBR        01743000
017440             DISPLAY 'PACK UPC NUMBER :' POPRPK-PREPK-UPC-NBR     01744000
017500             PERFORM 2500-FETCH-PK-UPC                            01750000
017600         WHEN SQLCODE = +100                                      01760000
017700             SET PS-END-OF-PK-UPC-CSR                             01770000
017800                                   TO TRUE                        01780000
017900         WHEN OTHER                                               01790000
018000             MOVE '2200-FETCH-PK-UPC-CSR'                         01800000
018100                                   TO PV-ABEND-PARAGRAPH          01810000
018200             MOVE 'FETCH PK_UPC_CSR'                              01820000
018300                                   TO PV-DB2-OPN-ATTEMPTED        01830000
018400           PERFORM 9100-SQL-ABEND                                 01840000
018500     END-EVALUATE.                                                01850000
018600                                                                  01860000
018700*                                                                 01870000
018800******************************************************************01880000
018900* CLOSES PACK DESCRIPTION DIFFERENCE CURSOR                      *01890000
019000******************************************************************01900000
019100 2300-CLOSE-PK-UPC-CSR.                                           01910000
019200                                                                  01920000
019300     EXEC SQL                                                     01930000
019400          CLOSE PK_UPC_CSR                                        01940000
019500     END-EXEC.                                                    01950000
019600                                                                  01960000
019700     EVALUATE TRUE                                                01970000
019800         WHEN SQLCODE = 0                                         01980000
019900             IF PV-UPDATE-CNT > 0                                 01990000
020000               PERFORM 4000-COMMIT                                02000000
020100             END-IF                                               02010000
020200         WHEN OTHER                                               02020000
020300             MOVE '2300-CLOSE-PK-UPC-CSR'                         02030000
020400                                   TO PV-ABEND-PARAGRAPH          02040000
020500             MOVE 'CLOSE PK_UPC_CSR'                              02050000
020600                                   TO PV-DB2-OPN-ATTEMPTED        02060000
020700             PERFORM 9100-SQL-ABEND                               02070000
020800     END-EVALUATE.                                                02080000
020900                                                                  02090000
020901                                                                  02090100
020910*                                                                 02091000
020921******************************************************************02092100
020930* SELECT UPC-NBR FROM XLT_PK_UPC                                 *02093000
020931******************************************************************02093100
020960*                                                                 02096000
020970 2500-FETCH-PK-UPC.                                               02097000
020980                                                                  02098000
020990     MOVE POPRPK-PK-SKU-NBR        TO XLT00009-PK-SKU-NBR.        02099000
020991                                                                  02099100
020992     EXEC SQL                                                     02099200
020993         SELECT UPC_NBR                                           02099300
020994           INTO :XLT00009-UPC-NBR                                 02099400
020995           FROM XLT_PK_UPC                                        02099500
020996          WHERE PK_SKU_NBR  = :XLT00009-PK-SKU-NBR                02099600
020997            AND EDI_ORD_IND = 'Y'                                 02099700
020998         WITH UR                                                  02099800
020999     END-EXEC.                                                    02099900
021000                                                                  02100000
021001     EVALUATE TRUE                                                02100100
021002         WHEN SQLCODE = 0                                         02100200
021003             PERFORM 3000-UPDATE-TPOPRPK-PK-UPC                   02100300
021006         WHEN OTHER                                               02100600
021007             MOVE '2500-FETCH-PK-UPC'                             02100700
021008                                   TO PV-ABEND-PARAGRAPH          02100800
021009             MOVE 'SELECT XLT_PK_UPC'                             02100900
021010                                   TO PV-DB2-OPN-ATTEMPTED        02101000
021011             PERFORM 9100-SQL-ABEND                               02101100
021012     END-EVALUATE.                                                02101200
021015                                                                  02101500
021016                                                                  02101600
021020*                                                                 02102000
021100******************************************************************02110000
021200* UPDATES SKU DESCRIPTION IN TPOPRPK WITH THAT OF XLT_PK         *02120000
021300******************************************************************02130000
021400 3000-UPDATE-TPOPRPK-PK-UPC.                                      02140000
021500                                                                  02150000
021510     MOVE XLT00009-UPC-NBR         TO POPRPK-PREPK-UPC-NBR        02151000
021520                                                                  02152000
021600     EXEC SQL                                                     02160000
021700         UPDATE TPOPRPK                                           02170000
021800           SET  PREPK_UPC_NBR = :POPRPK-PREPK-UPC-NBR             02180000
021900         WHERE                                                    02190000
022000                PO_NBR       = :POPRPK-PO-NBR                     02200000
022100           AND  PK_SKU_NBR   = :POPRPK-PK-SKU-NBR                 02210000
022200     END-EXEC.                                                    02220000
022300                                                                  02230000
022400     EVALUATE TRUE                                                02240000
022500         WHEN SQLCODE = ZEROS                                     02250000
022600             ADD  1                TO  PV-UPDATE-CNT              02260000
022700                                       PV-UPD-COUNT-TOT           02270000
022800             DISPLAY '** AFTER UPDATE **'                         02280000
022810             DISPLAY 'PO NUMBER       :' POPRPK-PO-NBR            02281000
022900             DISPLAY 'PACK SKU NUMBER :' POPRPK-PK-SKU-NBR        02290000
022910             DISPLAY 'PACK UPC NUMBER :' POPRPK-PREPK-UPC-NBR     02291000
023000             IF PV-UPDATE-CNT = PC-COMMIT-HOLD                    02300000
023100                PERFORM 4000-COMMIT                               02310000
023200             END-IF                                               02320000
023300                                                                  02330000
023400         WHEN OTHER                                               02340000
023500             MOVE '3000-UPDATE-TPOPRPK-PK-UPC'                    02350000
023600                                   TO PV-ABEND-PARAGRAPH          02360000
023700             MOVE 'UDPATE TPOPRPK' TO PV-DB2-OPN-ATTEMPTED        02370000
023900           PERFORM 9100-SQL-ABEND                                 02390000
024000     END-EVALUATE.                                                02400000
024100                                                                  02410000
024200 EJECT                                                            02420000
024300*                                                                 02430000
024400******************************************************************02440000
024500* TAKES COMMIT                                                   *02450000
024600******************************************************************02460000
024700 4000-COMMIT.                                                     02470000
024800                                                                  02480000
024900     EXEC SQL                                                     02490000
025000         COMMIT                                                   02500000
025100     END-EXEC.                                                    02510000
025200                                                                  02520000
025300     EVALUATE TRUE                                                02530000
025400         WHEN SQLCODE = ZEROS                                     02540000
025500             MOVE 0                TO PV-UPDATE-CNT               02550000
025600             ADD +1                TO PV-COMMIT-CNT               02560000
025700         WHEN OTHER                                               02570000
025800             MOVE '4000-COMMIT'    TO PV-ABEND-PARAGRAPH          02580000
025900             MOVE 'COMMIT'         TO PV-DB2-OPN-ATTEMPTED        02590000
026000           PERFORM 9100-SQL-ABEND                                 02600000
026100     END-EVALUATE.                                                02610000
026200                                                                  02620000
026300*                                                                 02630000
026400******************************************************************02640000
026500* DISPLAYS PROGRAM STATISTICS                                    *02650000
026600******************************************************************02660000
026700 8000-EOJ-ROUTINE.                                                02670000
026800                                                                  02680000
026900     DISPLAY '*************************************************'. 02690000
027000     DISPLAY '**             XLKUP091 SUMMARY                **'. 02700000
027100     DISPLAY '*************************************************'. 02710000
027200     MOVE  PV-FETCH-CNT              TO PV-DISPLAY-COUNT.         02720000
027300     DISPLAY 'TOTAL RECORDS FETCHED  = ' PV-DISPLAY-COUNT.        02730000
027400     MOVE  PV-UPD-COUNT-TOT          TO PV-DISPLAY-COUNT.         02740000
027500     DISPLAY 'TOTAL RECORDS UPDATED  = ' PV-DISPLAY-COUNT.        02750000
027600     MOVE  PV-COMMIT-CNT             TO PV-DISPLAY-COUNT.         02760000
027700     DISPLAY 'TOTAL COMMITS TAKEN    = ' PV-DISPLAY-COUNT.        02770000
027800     DISPLAY '*************************************************'. 02780000
027900     DISPLAY 'END OF PROGRAM   : ' PC-PGM-NAME.                   02790000
028000                                                                  02800000
028100 EJECT                                                            02810000
028200*                                                                 02820000
028300******************************************************************02830000
028400* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *02840000
028500* ERROR OR WARNING CODE OCCURS.                                  *02850000
028600******************************************************************02860000
028700 9100-SQL-ABEND.                                                  02870000
028800                                                                  02880000
028900     DISPLAY '9100-SQL-ABEND'.                                    02890000
029000     DISPLAY '** ABEND     **'.                                   02900000
029100     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    02910000
029200     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02920000
029300     DISPLAY '** OPERATION ** = ' PV-DB2-OPN-ATTEMPTED.           02930000
029400     COPY DPPD004.                                                02940000
029500     MOVE +4013                      TO ABEND-CODE.               02950000
029600     CALL 'ILBOABN0' USING ABEND-CODE.                            02960000
029700                                                                  02970000
