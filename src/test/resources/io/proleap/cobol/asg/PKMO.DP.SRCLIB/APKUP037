000100 IDENTIFICATION DIVISION.                                         00010012
000200 PROGRAM-ID.     APKUP037.                                        00020012
000300 AUTHOR.         M WILKINSON.                                     00030012
000400*DATE-WRITTEN.   OCT 16,1996.                                     00040012
000500*DATE-COMPILED.                                                   00050012
000600******************************************************************00060015
000700*    COBOL 2  WITH SQL                                           *00070015
000800*                                                                *00080015
000900*    UPDATE BATCH CONTROL TABLE WITH RUN DATE                    *00090015
001000*                                                                *00100015
001100******************************************************************00110015
001200*                                                                *00120015
001300*    TAPCNTL - AP BATCH CONTROL TABLE.                           *00130015
001310*    TDTATTR - DATE ATTRIBUTE TABLE.                             *00131015
001400*                                                                *00140015
001500******************************************************************00150015
001600* CHANGE LOG:                                                    *00160015
001700*                                                                *00170015
001800* 10/16/96     INITIAL VERSION.                                  *00180015
001900*                                                                *00190015
002000* 02/03/98   ROBIN BERNOSKI               WR/IR #: WR5703        *00200015
002100*            - MODIFIED THE MANNER IN WHICH THE STANDARD         *00210015
002200*              DATE ROUTINE, DPKUT500, IS TO BE CALLED           *00220015
002300*              WITHIN A PROGRAM SO THAT THE CALL IS              *00230015
002400*              DYNAMIC.                                          *00240015
002500*            - REPLACED ++INCLUDES WITH COPY STATEMENTS.         *00250015
002600*                                                                *00260015
002700* 12/08/1999 JILL JUEL                   WR/IR #: WR6041         *00270015
002800*            - MODIFIED THE CHECK ON THE DATE ROUTINE TO         *00280015
002900*              CONFORM WITH Y2K STANDARDS BY ADDING              *00290015
003000*              DPG54-WARNING-ERROR.                              *00300015
003100*                                                                *00310015
003110* DATE  08/18/2004                                               *00311015
003120*     CHANGE MADE:                                               *00312015
003130*         REPLACED DATE ROUTINE WITH DATE ATTRIBUTE TABLE.       *00313015
003140*         ADDED LOGIC TO MAINTAIN NEW COLUMN ON TAPCNTL,         *00314015
003141*         NEXT_BTCH_PRC_DTE. ON WEEKDAYS, THIS WILL GET THE      *00314115
003142*         VALUE OF BTCH_PRC_DTE + 1 DAY.  ON SATURDAYS, IT WILL  *00314215
003143*         GET THE VALUE OF BTCH_PRC_DTE + 2 DAYS.  THIS NEW      *00314315
003144*         COLUMN WILL BE USED FOR PROCESSES THAT ARE CREATING    *00314415
003145*         TRANSACTIONS OUT OF ONE BATCH CYCLE THAT WON'T BE      *00314515
003146*         PROCESSED UNTIL THE NEXT BATCH CYCLE.                  *00314615
003150*     MADE BY: NANCY EILBES            WR/IR #: WR26679          *00315015
003200******************************************************************00320015
003300                                                                  00330012
003400 ENVIRONMENT DIVISION.                                            00340012
003500                                                                  00350012
003600 INPUT-OUTPUT SECTION.                                            00360012
003700                                                                  00370012
003800 DATA DIVISION.                                                   00380012
003900                                                                  00390012
004000 FILE SECTION.                                                    00400012
004100                                                                  00410012
004200/                                                                 00420012
004300 WORKING-STORAGE SECTION.                                         00430012
004400                                                                  00440012
004500 01  FILLER                        PIC X(25) VALUE                00450012
004600                             'WS FOR APKUP037 BEGINS==>'.         00460012
004700 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00470012
004800                                             VALUE ZEROS.         00480012
004900     88 AP-DB2-ERROR               VALUE +4013.                   00490012
005000                                                                  00500012
005100 01  PV-ABEND-FILEDS.                                             00510012
005200     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP037'. 00520012
005300     05  PV-ABEND-SQLCODE             PIC X(4)  VALUE SPACES.     00530012
005400     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00540012
005500     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00550012
005600     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00560012
005700     05  PV-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     00570012
005800     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     00580012
005900                                                                  00590012
006000 01  PV-WORK-AREA.                                                00600012
006100     05  PV-PROGRAM-NAME         PIC X(08)     VALUE 'APKUP037'.  00610012
006110     05  PV-CONTROL-DATE         PIC X(10)     VALUE SPACES.      00611013
006120     05  PV-ONE-DAY-LATER        PIC X(10)     VALUE SPACES.      00612013
006130     05  PV-TWO-DAYS-LATER       PIC X(10)     VALUE SPACES.      00613013
006140     05  PV-DATE-VALID-SW        PIC X         VALUE SPACES.      00614014
006150         88  PV-DATE-VALID                     VALUE 'Y'.         00615014
006200                                                                  00620012
006900 01  BATCH-PROCESS-DATE-AREA.                                     00690012
007000     05  BATCH-PROCESS-DATE-YYYY      PIC X(04) VALUE SPACES.     00700012
007100     05  FILLER                       PIC X(01) VALUE SPACES.     00710012
007200     05  BATCH-PROCESS-DATE-MM        PIC X(02) VALUE SPACES.     00720012
007300     05  FILLER                       PIC X(01) VALUE SPACES.     00730012
007400     05  BATCH-PROCESS-DATE-DD        PIC X(02) VALUE SPACES.     00740012
007500     05  FILLER                       PIC X(70) VALUE SPACES.     00750012
007600                                                                  00760013
007700 01  RUN-TIME.                                                    00770012
007800     05  R-HR                    PIC 99.                          00780012
007900     05  R-MIN                   PIC 99.                          00790012
008000     05  R-SEC                   PIC 99.                          00800012
008100     05  R-TH                    PIC 99.                          00810012
008200                                                                  00820013
008300 01  DATE-IN.                                                     00830012
008400     05 DATE-IN-YY               PIC XX.                          00840012
008500     05 DATE-IN-MM               PIC XX.                          00850012
008600     05 DATE-IN-DD               PIC XX.                          00860012
008700                                                                  00870012
008800     EJECT                                                        00880012
009200 01  FILLER                      PIC X(35)  VALUE                 00920012
009300     'END OF AP WORK RECORD AREA       **'.                       00930012
009400                                                                  00940012
009500     COPY DPWS004.                                                00950012
009600                                                                  00960012
009700******************************************************************00970012
009800*  COMMUNICATIONS AREA2 FOR DB2                                   00980012
009900******************************************************************00990012
010000     COPY SQLCA2.                                                 01000012
010100                                                                  01010012
010200                                                                  01020012
010300     EXEC SQL                                                     01030012
010400          INCLUDE SQLCA                                           01040012
010500     END-EXEC.                                                    01050012
010600                                                                  01060012
010700                                                                  01070012
010800     EXEC SQL                                                     01080012
010900          INCLUDE TAPCNTL                                         01090012
011000     END-EXEC.                                                    01100012
011100                                                                  01110012
011110     EXEC SQL                                                     01111013
011120          INCLUDE TDTATTR                                         01112013
011130     END-EXEC.                                                    01113013
011140                                                                  01114013
011200 01  FILLER                        PIC X(25) VALUE                01120012
011300          '<====WS FOR APKUP037 ENDS'.                            01130012
011400                                                                  01140012
011700                                                                  01170012
011800 PROCEDURE DIVISION.                                              01180012
011900                                                                  01190012
012000 A100-MAINLINE.                                                   01200012
012100                                                                  01210012
012200     PERFORM B100-INITIALIZATION.                                 01220013
012300     PERFORM B200-PROCESSING.                                     01230013
012500     PERFORM B300-END-OF-JOB.                                     01250013
012600                                                                  01260012
012700     GOBACK.                                                      01270012
012800        EJECT                                                     01280012
012810 B100-INITIALIZATION.                                             01281013
012820*                                                                 01282013
012830***************************************************************** 01283013
012840*    GET DATE, TIME, CONTROL DATE FROM JOB                        01284013
012850***************************************************************** 01285013
012860*                                                                 01286013
012870     ACCEPT RUN-TIME FROM TIME.                                   01287013
012880     ACCEPT DATE-IN  FROM DATE.                                   01288013
012890     ACCEPT BATCH-PROCESS-DATE-AREA.                              01289013
012891                                                                  01289113
012892     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    01289213
012893                                                                  01289313
012894     INITIALIZE DCLTAPCNTL                                        01289413
012895                DCLTDTATTR.                                       01289513
012896                                                                  01289613
012900                                                                  01290012
013100*                                                                 01310012
013200***************************************************************** 01320012
013300*     PROCESS CONTROL CARD:                                       01330012
013400*     -- EDIT FOR VALID DATE                                      01340012
013410*     -- CALCULATE NEXT BATCH DATE: ON SATURDAY (DAY NBR = 7)     01341013
013411*          NEXT BATCH DATE IS PLUS 2 ELSE IT IS PLUS 1            01341113
013420*     -- UPDATE CONTROL TABLE                                     01342013
013500***************************************************************** 01350012
013510 B200-PROCESSING.                                                 01351013
013600                                                                  01360013
013900     MOVE '-' TO BATCH-PROCESS-DATE-AREA(5:1)                     01390013
014000                 BATCH-PROCESS-DATE-AREA(8:1).                    01400013
014010                                                                  01401013
014100     MOVE BATCH-PROCESS-DATE-AREA TO PV-CONTROL-DATE.             01410013
014200     PERFORM S100-VALIDATE-DATE.                                  01420013
014300                                                                  01430013
014400     IF PV-DATE-VALID                                             01440013
016800        MOVE BATCH-PROCESS-DATE-AREA TO  APCNTL-BTCH-PRC-DTE      01680013
016900        IF  DTATTR-DAY-OF-WK-NBR = 7                              01690013
016910            MOVE PV-TWO-DAYS-LATER TO APCNTL-NEXT-BTCH-PRC-DTE    01691013
016920        ELSE                                                      01692013
016921            MOVE PV-ONE-DAY-LATER  TO APCNTL-NEXT-BTCH-PRC-DTE    01692113
016930        END-IF                                                    01693013
017000        PERFORM C100-UPDATE-CONTROL                               01700012
017100     END-IF.                                                      01710012
017200                                                                  01720012
017210 B300-END-OF-JOB.                                                 01721013
017220*                                                                 01722013
017230***************************************************************** 01723013
017240*     END JOB                                                     01724013
017250***************************************************************** 01725013
017260*                                                                 01726013
017270     DISPLAY '************************************************'.  01727013
017280     DISPLAY 'BATCH PROCESS DATE = ' BATCH-PROCESS-DATE-AREA.     01728013
017290     DISPLAY '************************************************'.  01729013
017291     DISPLAY ' PROGRAM APKUP037 ENDS NORMALLY '.                  01729113
017292                                                                  01729213
017300 C100-UPDATE-CONTROL.                                             01730012
017400*                                                                 01740012
017500***************************************************************** 01750012
017600*     UPDATE THE BATCH PROCESS DATE WITH BATCH RUN DATE           01760012
017700***************************************************************** 01770012
017800*                                                                 01780012
017900     EXEC SQL                                                     01790012
018000         UPDATE TAPCNTL                                           01800012
018100         SET                                                      01810012
018200             BTCH_PRC_DTE = :APCNTL-BTCH-PRC-DTE                  01820013
018210           , NEXT_BTCH_PRC_DTE = :APCNTL-NEXT-BTCH-PRC-DTE        01821013
018300     END-EXEC.                                                    01830012
018400                                                                  01840012
018500     EVALUATE TRUE                                                01850012
018600         WHEN SQLCODE = ZERO                                      01860012
018700              CONTINUE                                            01870012
018800                                                                  01880012
018900         WHEN SQLWARN0 NOT = SPACES                               01890012
019000         WHEN SQLCODE  NOT = ZERO                                 01900012
019100              MOVE 'C100-UPDATE-CONTROL '                         01910012
019200                              TO PV-ABEND-PARAGRAPH               01920012
019300              MOVE 'UNSUCCESSFUL UPDATE APCNTL  ROW'              01930012
019400                              TO PV-ABEND-OPERATION               01940012
019500              MOVE 'TAPCNTL ' TO PV-ABEND-STRUCTURE-1             01950012
019600              PERFORM Z999-SQL-ERROR                              01960012
019700     END-EVALUATE.                                                01970012
019800                                                                  01980012
021000                                                                  02100012
021100 S100-VALIDATE-DATE.                                              02110013
021200*                                                                 02120013
021300***************************************************************** 02130013
021400*    SELECT THE CONTROL CARD DATE FROM TDTATTR TO ENSURE IT IS    02140013
021410*    VALID.  RETURN DAY OF WEEK TO DETERMINE WHICH DATE SHOULD    02141013
021420*    BE USED AS NEXT AP BATCH DATE.                               02142013
021500***************************************************************** 02150013
021600*                                                                 02160013
021700     EXEC SQL                                                     02170013
021800         SELECT DAY_OF_WK_NBR                                     02180013
021810              , KY_DTE + 1 DAY                                    02181013
021820              , KY_DTE + 2 DAYS                                   02182013
021830           INTO :DTATTR-DAY-OF-WK-NBR                             02183013
021840              , :PV-ONE-DAY-LATER                                 02184013
021850              , :PV-TWO-DAYS-LATER                                02185013
021900           FROM TDTATTR                                           02190013
022000           WHERE KY_DTE = :PV-CONTROL-DATE                        02200013
022100     END-EXEC.                                                    02210013
022200                                                                  02220013
022300     EVALUATE TRUE                                                02230013
022400         WHEN SQLCODE = ZERO                                      02240013
022500              SET PV-DATE-VALID TO TRUE                           02250013
022700         WHEN SQLWARN0 NOT = SPACES                               02270013
022800         WHEN SQLCODE  NOT = ZERO                                 02280013
022900              MOVE 'S100-VALIDATE-DATE  '                         02290013
023000                              TO PV-ABEND-PARAGRAPH               02300013
023100              MOVE 'UNSUCCESSFUL SELECT FROM TABLE '              02310013
023200                              TO PV-ABEND-OPERATION               02320013
023300              MOVE 'TDTATTR ' TO PV-ABEND-STRUCTURE-1             02330013
023400              PERFORM Z999-SQL-ERROR                              02340013
023500     END-EVALUATE.                                                02350013
023510                                                                  02351013
023594                                                                  02359413
023600 Z997-ABEND.                                                      02360012
023700                                                                  02370012
023800     DISPLAY PV-ABEND-PROGRAM.                                    02380012
023900     DISPLAY PV-ABEND-PARAGRAPH.                                  02390012
024000     DISPLAY PV-ABEND-OPERATION.                                  02400012
024100                                                                  02410012
024200     CALL 'ILBOABN0' USING ABEND-CODE.                            02420012
024300                                                                  02430012
024400 Z999-SQL-ERROR.                                                  02440012
024500*                                                                 02450012
024600***************************************************************** 02460012
024700*     PROCESS DB2 ABENDS                                          02470012
024800***************************************************************** 02480012
024900*                                                                 02490012
025000     DISPLAY '*** DB2 ERROR '.                                    02500012
025100     DISPLAY '*** SQL CODE = '  PV-ABEND-SQLCODE.                 02510012
025200     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02520012
025300     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02530012
025400     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02540012
025500     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             02550012
025600     IF PV-ABEND-STRUCTURE-2 > SPACES                             02560012
025700         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2.         02570012
025800                                                                  02580012
025900     COPY DPPD004.                                                02590012
026000                                                                  02600012
026100     MOVE +4013                    TO ABEND-CODE.                 02610012
026200                                                                  02620012
026300     CALL 'ILBOABN0' USING ABEND-CODE.                            02630012
