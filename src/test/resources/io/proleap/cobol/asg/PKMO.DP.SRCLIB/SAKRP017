000100***************************************************************** 00010004
000200 IDENTIFICATION DIVISION.                                         00020004
000300***************************************************************** 00030004
000400                                                                  00040004
000500 PROGRAM-ID.             SAKRP017.                                00050004
000600 AUTHOR.                 MATTHEW STIFF.                           00060004
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070004
000800 DATE-WRITTEN            MAY 1999.                                00080004
000900 DATE-COMPILED.                                                   00090004
001000                                                                  00100004
001100***************************************************************** 00110004
001200* * * *>>>   THIS PROGRAM MUST BE COMPILED COBOL/390   <<<* * * * 00120004
001300***************************************************************** 00130004
001400*                                                                 00140004
001500*  THIS PROGRAM WILL CREATE A DAILY AMERICAN EXPRESS CORRECTIONS  00150004
001600*  AUDIT REPORT.                                                  00160004
001700*                                                                 00170004
001800*   INPUT: INP01 - CONTAINS POS DATE, WHICH IS USED AS THE        00180004
001900*                  PROCESS DATE TO CREATE THE REPORT.             00190004
002000*  OUTPUT: RPT01 - REPORT SHOWING AMERICAN EXPRESS CORRECTIONS    00200004
002100*                  BY SALES DATE.                                 00210004
002200*                                                                 00220004
002300***************************************************************** 00230004
002400*                                                                 00240004
002500*  THIS PROGRAM USES THE TEPDKEY TABLE TO JOIN THE TEPTRN,        00250004
002600*  TEPTND, AND TEPCRD TABLES.  THE TEPDKEY TABLE CONTAINS ALL     00260004
002700*  KEY INFORMATION FOR TRANSACTIONS THAT HAVE BEEN PROCESSED FOR  00270004
002800*  A PROCESSING DAY THAT DO NOT HAVE SALES DATES FOR THAT         00280004
002900*  PROCESSING DAY.  THE MOST COMMON EXAMPLE OF THIS IS A SALES    00290004
003000*  CORRECTION.                                                    00300004
003100*                                                                 00310004
003200*  THE REPORT USES DATA FROM THE TEPTND, TEPCRD, AND TEPTRN       00320004
003300*  TABLES.  A DETAIL LINE IS WRITTEN FOR EACH ROW FETCHED.        00330004
003400*  THE REPORT BREAKS ON STORE NUMBER AND ALSO SALES DATE.         00340004
003500*  WHEN A NEW STORE IS ENCOUNTERED, THE STORE TABLE IS READ TO    00350004
003600*  GET THE AMEX MERCHANT NUMBER FOR THAT STORE.  WHEN A NEW       00360004
003700*  SALES DATE IS ENCOUNTERED, THE DATE IS PASSED TO THE CALENDAR  00370004
003800*  TO BE CHANGED INTO GREGORIAN FORMAT.                           00380004
003900*                                                                 00390004
004000*  WHEN THE FETCH IS COMPLETE, A TOTAL LINE IS PRINTED AT THE     00400004
004100*  END OF THE REPORT.                                             00410004
004200*                                                                 00420004
004300***************************************************************** 00430004
004400* CHANGED: 09/22/04                                               00440004
004500* PROJECT: XS DOMAIN CONSTRAINTS    WR/IR#: WR27107               00450004
004600* PROGRAMMER:  THOMAS HANSON                                      00460004
004700* DESCRIPTION: REPLACED TSTR000 WITH XST_LOC_ATTR TABLE.          00470004
004800*              PER USER REQUEST, REMOVED MERCH_NBR FROM RPT.      00480004
004300***************************************************************** 00481007
004400* CHANGED: 01/12/05  WR/IR#: WR28146   PAUL OMAN                  00482008
004500* PROJECT: MASK CREDIT CARD NUMBERS.                              00483007
004700* DESCRIPTION: ONLY SHOW LAST 4 POSITIONS OF CREDIT CARD NUMBER   00485007
004900***************************************************************** 00490004
P10237* CHANGED: 07/01/15  WR/IR#: CHG0104429 COGNIZANT                 00491011
P10237* PROJECT: COSA DATA SECURITY.                                    00492010
P10237* DESCRIPTION: MASKED THE 11TH CHARACTER OF AMEX CREDIT CARD      00493011
P10237*              NUMBER AND ONLY LAST 4 POSITIONS ARE SHOWN ON      00493111
P10237*              REPORT.                                            00493211
P10237***************************************************************** 00494010
005000 ENVIRONMENT DIVISION.                                            00500004
005100***************************************************************** 00510004
005200                                                                  00520004
005300 CONFIGURATION SECTION.                                           00530004
005400                                                                  00540004
005500 SOURCE-COMPUTER.        IBM-3090.                                00550004
005600                                                                  00560004
005700 OBJECT-COMPUTER.        IBM-3090.                                00570004
005800                                                                  00580004
005900 INPUT-OUTPUT SECTION.                                            00590004
006000                                                                  00600004
006100 FILE-CONTROL.                                                    00610004
006200                                                                  00620004
006300     SELECT POS-DATE-CARD-FILE                                    00630004
006400         ASSIGN TO INP01.                                         00640004
006500                                                                  00650004
006600     SELECT AMEX-REPORT-FILE                                      00660004
006700         ASSIGN TO RPT01.                                         00670004
006800                                                                  00680004
006900 EJECT                                                            00690004
007000******************************************************************00700004
007100 DATA DIVISION.                                                   00710004
007200******************************************************************00720004
007300                                                                  00730004
007400 FILE SECTION.                                                    00740004
007500                                                                  00750004
007600 FD  POS-DATE-CARD-FILE                                           00760004
007700     RECORDING MODE IS F                                          00770004
007800     BLOCK CONTAINS 0 RECORDS                                     00780004
007900     LABEL RECORDS ARE STANDARD.                                  00790004
008000                                                                  00800004
008100 01  POS-DATE-CARD-RECORD            PIC X(80).                   00810004
008200                                                                  00820004
008300 FD  AMEX-REPORT-FILE                                             00830004
008400     RECORDING MODE IS F                                          00840004
008500     BLOCK CONTAINS 0  RECORDS.                                   00850004
008600                                                                  00860004
008700 01  AMEX-REPORT-RECORD              PIC  X(132).                 00870004
008800                                                                  00880004
008900 EJECT                                                            00890004
009000******************************************************************00900004
009100 WORKING-STORAGE SECTION.                                         00910004
009200******************************************************************00920004
009300 01  FILLER                            PIC X(50)  VALUE           00930004
009400     ' *** WORKING STORAGE STARTS HERE FOR SAKRP017 *** '.        00940004
009500                                                                  00950004
009600******************************************************************00960004
009700* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00970004
009800******************************************************************00980004
009900 01  CC-CONTROL-CARD.                                             00990004
010000     05  CC-CONTROL-CARD-DISPLAY.                                 01000004
010100         10  CC-CONTROL-NAME     PIC X(14)    VALUE SPACE.        01010004
010200             88  CC-VALID-CONTROL-NAME        VALUE               01020004
010300                 'P.O.S. DATE = '.                                01030004
010400         10  CC-POS-DATE-MMDDYY  PIC 9(6)     VALUE ZERO.         01040004
010500     05  FILLER                  PIC X(60)    VALUE SPACE.        01050004
010600                                                                  01060004
010700******************************************************************01070004
010800*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01080004
010900******************************************************************01090004
011000     COPY DPWS500.                                                01100004
011100                                                                  01110004
011200 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01120004
011300                                                  COMP SYNC.      01130004
011400     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    01140004
011500     88  AC-DB2-ERROR                             VALUE +4013.    01150004
011600     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    01160004
011700                                                                  01170004
011800                                                                  01180004
011900 EJECT                                                            01190004
012000 01  PS-PROGRAM-SWITCHES.                                         01200004
012100     05  PS-END-OF-CURSOR-SW           PIC X(01)  VALUE 'N'.      01210004
012200         88  PS-END-OF-CURSOR                     VALUE 'Y'.      01220004
012300     05  PS-END-OF-CARD-FILE-SW        PIC X(01)  VALUE 'N'.      01230004
012400         88  PS-END-OF-CARD-FILE                  VALUE 'Y'.      01240004
012500                                                                  01250004
012600 01  PC-CONSTANTS.                                                01260004
012700     05  PC-LINE-LIMIT               PIC S9(04)    VALUE +60.     01270004
012800     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     01280004
012900                                                   COMP SYNC.     01290004
013000     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01300004
013100                                                   'SAKRP017'.    01310004
013200     05  PC-REPORT-NBR-1             PIC  9(01)    VALUE 1.       01320004
013300     05  PC-AMEX-TENDER-TYPE         PIC  X(02)    VALUE '08'.    01330004
013400     05  PC-SYSTEM-CORRECTION        PIC  X(01)    VALUE 'S'.     01340004
013500     05  PC-REVERSAL-CORRECTION      PIC  X(01)    VALUE 'R'.     01350004
013600                                                                  01360004
013700 EJECT                                                            01370004
013800 01  PV-MISC-COUNT-FIELDS            COMP-3.                      01380004
013900     05  PV-PAGE-CNT                 PIC S9(05)    VALUE ZERO.    01390004
014000     05  PV-LINE-CNT                 PIC S9(03)    VALUE ZERO.    01400004
014100     05  PV-LINE-CNT-AHEAD           PIC S9(03)    VALUE ZERO.    01410004
014200     05  PV-CURSOR-CNT               PIC S9(07)    VALUE ZERO.    01420004
014300                                                                  01430004
014400******************************************************************01440004
014500*  ACCUMULATORS TO HOLD STORE AND COMPANY DOLLAR AMOUNTS.         01450004
014600******************************************************************01460004
014700 01  PA-PROGRAM-ACCUMULATORS.                                     01470004
014800     05  PA-STORE-SALES-AMOUNT       PIC S9(07)V99  VALUE ZERO    01480004
014900                                         COMP-3.                  01490004
015000     05  PA-STORE-RETURN-AMOUNT      PIC S9(07)V99  VALUE ZERO    01500004
015100                                         COMP-3.                  01510004
015200     05  PA-COMPANY-SALES-AMOUNT     PIC S9(07)V99  VALUE ZERO    01520004
015300                                         COMP-3.                  01530004
015400     05  PA-COMPANY-RETURN-AMOUNT    PIC S9(07)V99  VALUE ZERO    01540004
015500                                         COMP-3.                  01550004
015600                                                                  01560004
015700 01  PV-MISC-FIELDS.                                              01570004
015800     05  PV-PRINT-RECORD             PIC X(132)    VALUE SPACE.   01580004
015900     05  PV-LINE-SPACING             PIC S9(04)    VALUE ZERO     01590004
016000                                                   COMP SYNC.     01600004
016100     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01610004
016200     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01620004
016300     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01630004
016400     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01640004
016500     05  PV-EDIT-MASK                PIC  Z,ZZZ,ZZ9.              01650004
016600     05  PV-HOLD-STORE               PIC  S9(04)  COMP VALUE ZERO.01660004
016700     05  PV-HOLD-SALES-DATE          PIC   X(10)  VALUE SPACE.    01670004
016800     05  PV-AMOUNT                   PIC  S9(07)V99 COMP-3        01680004
016900                                          VALUE ZERO.             01690004
017000     05  PV-AMOUNT-FORMATTED         PIC   ZZ,ZZ9.99-.            01700004
017100*    05  PV-MERCH-NMBR               PIC   9(10)  VALUE ZERO.     01710004
017200     05  PV-CARD-NBR-16.                                          01720004
017300         10  PV-CARD-NBR-16-FIRST-4  PIC   X(04)  VALUE SPACE.    01730004
017400         10  FILLER                  PIC   X(01)  VALUE '-'.      01740004
017500         10  PV-CARD-NBR-16-SECOND-4 PIC   X(04)  VALUE SPACE.    01750004
017600         10  FILLER                  PIC   X(01)  VALUE '-'.      01760004
017700         10  PV-CARD-NBR-16-THIRD-4  PIC   X(04)  VALUE SPACE.    01770004
017800         10  FILLER                  PIC   X(01)  VALUE '-'.      01780004
017900         10  PV-CARD-NBR-16-LAST-4   PIC   X(04)  VALUE SPACE.    01790004
018000     05  PV-CARD-NBR-13.                                          01800004
018100         10  PV-CARD-NBR-13-FIRST-4  PIC   X(04)  VALUE SPACE.    01810004
018200         10  FILLER                  PIC   X(01)  VALUE '-'.      01820004
018300         10  PV-CARD-NBR-13-SECOND-3 PIC   X(03)  VALUE SPACE.    01830004
018400         10  FILLER                  PIC   X(01)  VALUE '-'.      01840004
018500         10  PV-CARD-NBR-13-THIRD-3  PIC   X(03)  VALUE SPACE.    01850004
018600         10  FILLER                  PIC   X(01)  VALUE '-'.      01860004
018700         10  PV-CARD-NBR-13-LAST-3   PIC   X(03)  VALUE SPACE.    01870004
018800         10  FILLER                  PIC   X(03)  VALUE SPACE.    01880004
018900                                                                  01890004
019000 01  PV-DATE-AND-TIME-FIELDS.                                     01900004
019100     05  PV-POS-CCYY-MM-DD           PIC X(10)     VALUE SPACE.   01910004
019200     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01920004
019300         10  PV-POS-CCYY             PIC X(04).                   01930004
019400         10  FILLER                  PIC X(01).                   01940004
019500         10  PV-POS-MM               PIC X(02).                   01950004
019600         10  FILLER                  PIC X(01).                   01960004
019700         10  PV-POS-DD               PIC X(02).                   01970004
019800     05  PV-CURR-DATE-CCYYMMDD.                                   01980004
019900         10  PV-CURR-DATE-CCYY       PIC  9(04).                  01990004
020000         10  PV-CURR-DATE-MM         PIC  9(02).                  02000004
020100         10  PV-CURR-DATE-DD         PIC  9(02).                  02010004
020200     05  PV-CURR-TIME.                                            02020004
020300         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    02030004
020400         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    02040004
020500         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    02050004
020600     05  PV-POS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02060004
020700     05  PV-SLS-DATE-FORMATTED       PIC  X(10)    VALUE SPACE.   02070004
020800 EJECT                                                            02080004
020900******************************************************************02090004
021000*  TOP OF PAGE HEADING LINE FOR PRINTING A 132 CHARACTER REPORT.  02100004
021100******************************************************************02110004
021200     COPY DPWS132.                                                02120004
021300                                                                  02130004
021400******************************************************************02140004
021500*  HEADING LINES FOR THE AMEX CORRECTIONS REPORT.                 02150004
021600******************************************************************02160004
021700 01  HL2-HEADING-LINE-2.                                          02170004
021800     05  FILLER                      PIC  X(33)    VALUE SPACE.   02180004
021900     05  FILLER                      PIC  X(17)    VALUE          02190004
022000                                          'AMERICAN EXPRESS '.    02200004
022100     05  FILLER                      PIC  X(12)    VALUE          02210004
022200                                          'CORRECTIONS '.         02220004
022300     05  FILLER                      PIC  X(10)    VALUE          02230004
022400                                          'AUDIT FOR '.           02240004
022500     05  FILLER                      PIC  X(11)    VALUE          02250004
022600                                          'PROCESSING '.          02260004
022700     05  FILLER                      PIC  X(06)    VALUE          02270004
022800                                          'DATE: '.               02280004
022900     05  HL2-DATE                    PIC  X(10)    VALUE SPACE.   02290004
023000     05  FILLER                      PIC  X(33)    VALUE SPACE.   02300004
023100                                                                  02310004
023200 01  HL3-HEADING-LINE-3.                                          02320004
023300     05  FILLER                      PIC  X(47)    VALUE ALL '-'. 02330004
023400     05  FILLER                      PIC  X(09)    VALUE          02340004
023500                                          ' STORE # '.            02350004
023600     05  HL3-STORE                   PIC  Z999.                   02360004
023700*    05  FILLER                      PIC  X(03)    VALUE SPACE.   02370004
023800*    05  FILLER                      PIC  X(11)    VALUE          02380004
023900*                                         'MERCHANT # '.          02390004
024000*    05  HL3-MERCHANT                PIC  X(10)    VALUE SPACE.   02400004
024100     05  FILLER                      PIC  X(01)    VALUE SPACE.   02410004
024200     05  FILLER                      PIC  X(71)    VALUE ALL '-'. 02420004
024300                                                                  02430004
024400 01  HL4-HEADING-LINE-4.                                          02440004
024500     05  FILLER                      PIC  X(50)    VALUE SPACE.   02450004
024600     05  FILLER                      PIC  X(04)    VALUE 'AUTH'.  02460004
024700     05  FILLER                      PIC  X(78)    VALUE SPACE.   02470004
024800                                                                  02480004
024900 01  HL5-HEADING-LINE-5.                                          02490004
025000     05  FILLER                      PIC  X(08)    VALUE SPACE.   02500004
025100     05  FILLER                      PIC  X(10)    VALUE          02510004
025200                                                   'SALES DATE'.  02520004
025300     05  FILLER                      PIC  X(04)    VALUE SPACE.   02530004
025400     05  FILLER                      PIC  X(05)    VALUE 'REG #'. 02540004
025500     05  FILLER                      PIC  X(02)    VALUE SPACE.   02550004
025600     05  FILLER                      PIC  X(07)    VALUE          02560004
025700                                                   'TRANS #'.     02570004
025800     05  FILLER                      PIC  X(02)    VALUE SPACE.   02580004
025900     05  FILLER                      PIC  X(08)    VALUE          02590004
026000                                                   'ASSOC ID'.    02600004
026100     05  FILLER                      PIC  X(02)    VALUE SPACE.   02610004
026200     05  FILLER                      PIC  X(06)    VALUE          02620004
026300                                                   'NUMBER'.      02630004
026400     05  FILLER                      PIC  X(11)    VALUE SPACE.   02640004
026500     05  FILLER                      PIC  X(06)    VALUE          02650004
026600                                                   'ACCT #'.      02660004
026700     05  FILLER                      PIC  X(12)    VALUE SPACE.   02670004
026800     05  FILLER                      PIC  X(04)    VALUE          02680004
026900                                                   'CODE'.        02690004
027000     05  FILLER                      PIC  X(08)    VALUE SPACE.   02700004
027100     05  FILLER                      PIC  X(05)    VALUE          02710004
027200                                                   'SALES'.       02720004
027300     05  FILLER                      PIC  X(06)    VALUE SPACE.   02730004
027400     05  FILLER                      PIC  X(07)    VALUE          02740004
027500                                                   'RETURNS'.     02750004
027600     05  FILLER                      PIC  X(04)    VALUE SPACE.   02760004
027700     05  FILLER                      PIC  X(10)    VALUE          02770004
027800                                                   'NET AMOUNT'.  02780004
027900     05  FILLER                      PIC  X(03)    VALUE SPACE.   02790004
028000                                                                  02800004
028100 01  HL6-HEADING-LINE-6.                                          02810004
028200     05  FILLER                      PIC  X(04)    VALUE SPACE.   02820004
028300     05  FILLER                      PIC  X(08)    VALUE          02830004
028400                                          'STORE # '.             02840004
028500     05  HL6-STORE                   PIC  Z999.                   02850004
028600     05  FILLER                      PIC  X(11)    VALUE          02860004
028700                                          ' TOTAL FOR '.          02870004
028800     05  HL6-DATE                    PIC  X(10)    VALUE SPACE.   02880004
028900     05  FILLER                      PIC  X(54)    VALUE SPACE.   02890004
029000     05  HL6-SALES-TOTAL             PIC  X(10)    VALUE SPACE.   02900004
029100     05  FILLER                      PIC  X(03)    VALUE SPACE.   02910004
029200     05  HL6-RETURN-TOTAL            PIC  X(10)    VALUE SPACE.   02920004
029300     05  FILLER                      PIC  X(04)    VALUE SPACE.   02930004
029400     05  HL6-NET-AMOUNT              PIC  X(10)    VALUE SPACE.   02940004
029500     05  FILLER                      PIC  X(04)    VALUE SPACE.   02950004
029600                                                                  02960004
029700******************************************************************02970004
029800*  DETAIL LINE PRINTED ON THE REPORT.                             02980004
029900******************************************************************02990004
030000 01  DL1-DETAIL-LINE-1.                                           03000004
030100     05  FILLER                      PIC  X(08)    VALUE SPACE.   03010004
030200     05  DL1-SALES-DATE              PIC  X(10)    VALUE SPACE.   03020004
030300     05  FILLER                      PIC  X(04)    VALUE SPACE.   03030004
030400     05  DL1-REGISTER                PIC  9(04)    VALUE ZERO.    03040004
030500     05  FILLER                      PIC  X(04)    VALUE SPACE.   03050004
030600     05  DL1-TRANSACTION             PIC  9(04)    VALUE ZERO.    03060004
030700     05  FILLER                      PIC  X(04)    VALUE SPACE.   03070004
030800     05  DL1-ASSOC-ID                PIC  X(08)    VALUE SPACE.   03080004
030900     05  FILLER                      PIC  X(02)    VALUE SPACE.   03090004
031000     05  DL1-AUTH-NBR                PIC  X(06)    VALUE SPACE.   03100004
031100     05  FILLER                      PIC  X(06)    VALUE SPACE.   03110004
031200     05  DL1-CARD-NBR.                                            03120004
031300         10  DL1-CARD-NBR-FIRST-4    PIC  X(04)    VALUE SPACE.   03130004
031400         10  FILLER                  PIC  X(01)    VALUE '-'.     03140004
031500         10  DL1-CARD-NBR-SECOND-6   PIC  X(06)    VALUE SPACE.   03150004
031600         10  FILLER                  PIC  X(01)    VALUE '-'.     03160004
031700         10  DL1-CARD-NBR-LAST-5     PIC  X(05)    VALUE SPACE.   03170004
031800     05  FILLER                      PIC  X(07)    VALUE SPACE.   03180004
031900     05  DL1-CODE                    PIC  X(01)    VALUE SPACE.   03190004
032000     05  FILLER                      PIC  X(06)    VALUE SPACE.   03200004
032100     05  DL1-SALES-AMOUNT            PIC  X(10)    VALUE SPACE.   03210004
032200     05  FILLER                      PIC  X(03)    VALUE SPACE.   03220004
032300     05  DL1-RETURN-AMOUNT           PIC  X(10)    VALUE SPACE.   03230004
032400     05  FILLER                      PIC  X(18)    VALUE SPACE.   03240004
032500                                                                  03250004
032600 EJECT                                                            03260004
032700******************************************************************03270004
032800*  TOTAL LINE PRINTED AT THE END OF THE REPORT                    03280004
032900******************************************************************03290004
033000 01 TL1-TOTAL-LINE-1.                                             03300004
033100    05  FILLER                       PIC X(01) VALUE SPACE.       03310004
033200    05  FILLER                       PIC X(08) VALUE              03320004
033300                                         'COMPANY '.              03330004
033400    05  FILLER                       PIC X(10) VALUE              03340004
033500                                         'TOTAL FOR '.            03350004
033600    05  FILLER                       PIC X(04) VALUE              03360004
033700                                         'ALL '.                  03370004
033800    05  FILLER                       PIC X(12) VALUE              03380004
033900                                         'CORRECTIONS '.          03390004
034000    05  FILLER                       PIC X(11) VALUE              03400004
034100                                         'ENTERED ON '.           03410004
034200    05  TL1-DATE                     PIC X(10) VALUE SPACE.       03420004
034300    05  FILLER                       PIC X(34) VALUE SPACE.       03430004
034400    05  TL1-SALES-AMOUNT             PIC ZZZ,ZZ9.99-.             03440004
034500    05  FILLER                       PIC X(02) VALUE SPACE.       03450004
034600    05  TL1-RETURN-AMOUNT            PIC ZZZ,ZZ9.99-.             03460004
034700    05  FILLER                       PIC X(03) VALUE SPACE.       03470004
034800    05  TL1-NET-AMOUNT               PIC ZZZ,ZZ9.99-.             03480004
034900    05  FILLER                       PIC X(04) VALUE SPACE.       03490004
035000                                                                  03500004
035100******************************************************************03510004
035200*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            03520004
035300******************************************************************03530004
035400     COPY DPWS004.                                                03540004
035500 EJECT                                                            03550004
035600******************************************************************03560004
035700*  DB2 COMMUNICATION AREA.                                        03570004
035800******************************************************************03580004
035900     EXEC SQL                                                     03590004
036000          INCLUDE SQLCA                                           03600004
036100     END-EXEC.                                                    03610004
036200 EJECT                                                            03620004
036300******************************************************************03630004
036400*  DB2 TABLE TEPPART - PARTITION TABLE                            03640004
036500******************************************************************03650004
036600     EXEC SQL                                                     03660004
036700          INCLUDE TEPPART                                         03670004
036800     END-EXEC.                                                    03680004
036900 EJECT                                                            03690004
037000******************************************************************03700004
037100*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           03710004
037200******************************************************************03720004
037300     EXEC SQL                                                     03730004
037400          INCLUDE TEPTRN                                          03740004
037500     END-EXEC.                                                    03750004
037600 EJECT                                                            03760004
037700******************************************************************03770004
037800*  DB2 TABLE TEPTND - TENDER TABLE                                03780004
037900******************************************************************03790004
038000     EXEC SQL                                                     03800004
038100          INCLUDE TEPTND                                          03810004
038200     END-EXEC.                                                    03820004
038300 EJECT                                                            03830004
038400******************************************************************03840004
038500*  DB2 TABLE TEPCRD - CREDIT TENDER TABLE                         03850004
038600******************************************************************03860004
038700     EXEC SQL                                                     03870004
038800          INCLUDE TEPCRD                                          03880004
038900     END-EXEC.                                                    03890004
039000 EJECT                                                            03900004
039100******************************************************************03910004
039200*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                03920004
039300******************************************************************03930004
039400     EXEC SQL                                                     03940004
039500          INCLUDE TEPDKEY                                         03950004
039600     END-EXEC.                                                    03960004
039700 EJECT                                                            03970004
039800******************************************************************03980004
039900*  DB2 TABLE TEPSAT - SALES AUDIT USER ID TABLE                   03990004
040000******************************************************************04000004
040100     EXEC SQL                                                     04010004
040200          INCLUDE TEPSAT                                          04020004
040300     END-EXEC.                                                    04030004
040400 EJECT                                                            04040004
040500******************************************************************04050004
040600*  DB2 TABLE XST_LOC_ATTR - STORE LOCATION ATTRIBUTE TABLE        04060004
040700******************************************************************04070004
040800*    EXEC SQL                                                     04080006
040900*         INCLUDE XST00025                                        04090006
041000*    END-EXEC.                                                    04100006
041100*EJECT                                                            04110006
041200******************************************************************04120004
041300*  CURSOR TO RETRIEVE AMEX CORRECTION DATA                        04130004
041400******************************************************************04140004
041500     EXEC SQL                                                     04150004
041600       DECLARE AMEX-CURSOR CURSOR FOR                             04160004
041700            SELECT  T.PARTN_NBR                                   04170004
041800                   ,T.STR_NBR                                     04180004
041900                   ,T.RGST_ID                                     04190004
042000                   ,T.TRN_NBR                                     04200004
042100                   ,T.STRT_TM                                     04210004
042200                   ,T.SLS_CORR_SEQ_NBR                            04220004
042300                   ,TRN_STAT_CDE                                  04230004
042400                   ,T.SLS_DTE                                     04240004
042500                   ,ASSOC_ID                                      04250004
042600                   ,TNDR_ID                                       04260004
042700                   ,TNDR_AMT                                      04270004
042800                   ,TNDR_ID_LEN_NBR                               04280004
042900                   ,AUTH_NBR                                      04290004
043000            FROM    TEPDKEY D                                     04300004
043100                   ,TEPTRN T                                      04310004
043200                   ,TEPTND N                                      04320004
043300                   ,TEPCRD C                                      04330004
043400                   ,TEPPART A                                     04340004
043500            WHERE   D.PRCG_DTE         = :EPDKEY-PRCG-DTE         04350004
043600              AND   D.SLS_DTE          = A.SLS_DTE                04360004
043700              AND   A.PARTN_NBR        = T.PARTN_NBR              04370004
043800              AND   D.STR_NBR          = T.STR_NBR                04380004
043900              AND   D.RGST_ID          = T.RGST_ID                04390004
044000              AND   D.TRN_NBR          = T.TRN_NBR                04400004
044100              AND   D.STRT_TM          = T.STRT_TM                04410004
044200              AND   D.SLS_CORR_SEQ_NBR = T.SLS_CORR_SEQ_NBR       04420004
044300              AND   T.PARTN_NBR        = N.PARTN_NBR              04430004
044400              AND   T.STR_NBR          = N.STR_NBR                04440004
044500              AND   T.RGST_ID          = N.RGST_ID                04450004
044600              AND   T.TRN_NBR          = N.TRN_NBR                04460004
044700              AND   T.STRT_TM          = N.STRT_TM                04470004
044800              AND   T.SLS_CORR_SEQ_NBR = N.SLS_CORR_SEQ_NBR       04480004
044900              AND   N.PARTN_NBR        = C.PARTN_NBR              04490004
045000              AND   N.STR_NBR          = C.STR_NBR                04500004
045100              AND   N.RGST_ID          = C.RGST_ID                04510004
045200              AND   N.TRN_NBR          = C.TRN_NBR                04520004
045300              AND   N.STRT_TM          = C.STRT_TM                04530004
045400              AND   N.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR       04540004
045500              AND   N.TNDR_SEQ_NBR     = C.TNDR_SEQ_NBR           04550004
045600              AND   D.SLS_CORR_SEQ_NBR <> 0                       04560004
045700              AND   VOID_ABRT_CDE      = 'N'                      04570004
045800              AND   TRN_STAT_CDE       IN ('V', 'R', 'L', 'Z')    04580004
045900              AND   TNDR_TYP_CDE       = :PC-AMEX-TENDER-TYPE     04590004
046000              AND   TNDR_VOID_IND      = 'N'                      04600004
046100              AND   STTLMNT_PRCD_CDE   = 'P'                      04610004
046200           ORDER BY T.STR_NBR                                     04620004
046300                   ,T.SLS_DTE                                     04630004
046400                   ,T.RGST_ID                                     04640004
046500                   ,T.TRN_NBR                                     04650004
046600           WITH UR                                                04660004
046700     END-EXEC.                                                    04670004
046800                                                                  04680004
046900***************************************************************** 04690004
047000* PROCEDURE DIVISION.                                           * 04700004
047100***************************************************************** 04710004
047200 PROCEDURE DIVISION.                                              04720004
047300                                                                  04730004
047400******************************************************************04740004
047500* 0000-MAINLINE-PARAGRAPH                                         04750004
047600*      PRODUCE AMEX CORRECTIONS REPORT                            04760004
047700******************************************************************04770004
047800 0000-MAINLINE-PARAGRAPH.                                         04780004
047900                                                                  04790004
048000     PERFORM 1000-INITIALIZE-PROGRAM.                             04800004
048100                                                                  04810004
048200     PERFORM 2000-PRODUCE-REPORT-LINES                            04820004
048300         UNTIL PS-END-OF-CURSOR.                                  04830004
048400                                                                  04840004
048500     IF PV-CURSOR-CNT           GREATER THAN ZERO                 04850004
048600         PERFORM 5200-PRINT-STORE-TOTAL-LINE                      04860004
048700     END-IF.                                                      04870004
048800                                                                  04880004
048900     PERFORM 4000-PRINT-REPORT-TOTALS.                            04890004
049000                                                                  04900004
049100     DISPLAY '****************************************'           04910004
049200     DISPLAY '*************** SAKRP017 ***************'           04920004
049300     DISPLAY '****************************************'           04930004
049400     MOVE PV-CURSOR-CNT          TO PV-EDIT-MASK                  04940004
049500     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04950004
049600     DISPLAY 'CORRECTION ROWS FETCHED........'                    04960004
049700         PV-EDIT-MASK                                             04970004
049800     DISPLAY '****************************************'           04980004
049900     DISPLAY '****************************************'           04990004
050000     DISPLAY '****************************************'           05000004
050100                                                                  05010004
050200     STOP RUN.                                                    05020004
050300                                                                  05030004
050400 EJECT                                                            05040004
050500                                                                  05050004
050600******************************************************************05060004
050700* 1000-INITIALIZE-PROGRAM                                         05070004
050800*     OPEN FILES, PROCESS CONTROL CARD, FORMAT REPORT HEADINGS,   05080004
050900*     OPEN AMEX-CUROSR, ATTEMPT FIRST FETCH OF CURSOR             05090004
051000******************************************************************05100004
051100 1000-INITIALIZE-PROGRAM.                                         05110004
051200                                                                  05120004
051300     OPEN INPUT  POS-DATE-CARD-FILE                               05130004
051400          OUTPUT AMEX-REPORT-FILE.                                05140004
051500                                                                  05150004
051600     PERFORM 1100-PROCESS-CONTROL-CARD.                           05160004
051700                                                                  05170004
051800     PERFORM 1200-FORMAT-HEADINGS.                                05180004
051900                                                                  05190004
052000     PERFORM 1300-PREPARE-FOR-REPORT.                             05200004
052100                                                                  05210004
052200******************************************************************05220004
052300* 1100-PROCESS-CONTROL-CARD                                       05230004
052400*     READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL   05240004
052500*     DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.  05250004
052600******************************************************************05260004
052700 1100-PROCESS-CONTROL-CARD.                                       05270004
052800                                                                  05280004
052900     PERFORM 1110-READ-POS-DATE-CARD-FILE.                        05290004
053000     CLOSE POS-DATE-CARD-FILE.                                    05300004
053100     IF PS-END-OF-CARD-FILE                                       05310004
053200         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   05320004
053300         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  05330004
053400         SET AC-CONTROL-CARD-ERROR TO TRUE                        05340004
053500         PERFORM 9999-ABEND                                       05350004
053600     END-IF.                                                      05360004
053700     DISPLAY PC-CURRENT-PROGRAM-NAME                              05370004
053800             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  05380004
053900     PERFORM 1115-CONVERT-INPUT-DATE.                             05390004
054000 EJECT                                                            05400004
054100                                                                  05410004
054200******************************************************************05420004
054300* 1110-READ-POS-DATE-CARD-FILE                                    05430004
054400*     READ DATE CONTROL CARD.                                     05440004
054500******************************************************************05450004
054600 1110-READ-POS-DATE-CARD-FILE.                                    05460004
054700     READ POS-DATE-CARD-FILE INTO CC-CONTROL-CARD                 05470004
054800        AT END                                                    05480004
054900           SET PS-END-OF-CARD-FILE TO TRUE.                       05490004
055000                                                                  05500004
055100******************************************************************05510004
055200* 1115-CONVERT-INPUT-DATE                                         05520004
055300*     CALL KOHLS CALENDAR ROUTINE:                                05530004
055400*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            05540004
055500*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 05550004
055600******************************************************************05560004
055700                                                                  05570004
055800 1115-CONVERT-INPUT-DATE.                                         05580004
055900                                                                  05590004
056000     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              05600004
056100                                                                  05610004
056200     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   05620004
056300     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   05630004
056400     SET  DPG52-LK-DTE-GREG            TO TRUE.                   05640004
056500     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    05650004
056600     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    05660004
056700                                             DPG54 DPG55 DPG56.   05670004
056800     EVALUATE TRUE                                                05680004
056900         WHEN DPG54-SEVERE-ERROR                                  05690004
057000         WHEN DPG54-DATE-INVALID                                  05700004
057100             MOVE '1115-CONVERT-INPUT-DATE'                       05710004
057200                                   TO PV-PARAGRAPH-NAME           05720004
057300             MOVE 'ERROR CONVERTING INPUT CARD DATE'              05730004
057400                                   TO PV-OPERATION-MSG-1          05740004
057500             SET AC-CALENDAR-ROUTINE-ERROR                        05750004
057600                                   TO TRUE                        05760004
057700             MOVE DPG54-ERROR-MESSAGE                             05770004
057800                                   TO PV-OPERATION-MSG-2          05780004
057900             PERFORM 9999-ABEND                                   05790004
058000     END-EVALUATE.                                                05800004
058100                                                                  05810004
058200     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD           05820004
058300                                      EPDKEY-PRCG-DTE.            05830004
058400     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-POS-DATE-FORMATTED.      05840004
058500 EJECT                                                            05850004
058600                                                                  05860004
058700******************************************************************05870004
058800* 1200-FORMAT-HEADINGS                                            05880004
058900*     GET CURRENT DATE AND TIME FROM SYSTEM.                      05890004
059000*     FORMAT REPORT FIELDS IN THE TOP PAGE HEADING LINE.          05900004
059100*     FORMAT HEADING LINE 2 WITH CONVERTED POS DATE.              05910004
059200******************************************************************05920004
059300 1200-FORMAT-HEADINGS.                                            05930004
059400                                                                  05940004
059500     MOVE FUNCTION CURRENT-DATE (1:8)                             05950004
059600                                   TO PV-CURR-DATE-CCYYMMDD.      05960004
059700     ACCEPT PV-CURR-TIME FROM TIME.                               05970004
059800                                                                  05980004
059900     MOVE PV-CURR-DATE-MM          TO DP132-RUN-MONTH.            05990004
060000     MOVE PV-CURR-DATE-DD          TO DP132-RUN-DAY.              06000004
060100     MOVE PV-CURR-DATE-CCYY        TO DP132-RUN-YEAR.             06010004
060200                                                                  06020004
060300     MOVE PV-CURR-TIME-HH          TO DP132-RUN-HOUR.             06030004
060400     MOVE PV-CURR-TIME-MM          TO DP132-RUN-MINUTE.           06040004
060500     MOVE PC-CURRENT-PROGRAM-NAME  TO DP132-PROGRAM-NAME.         06050004
060600     MOVE PC-REPORT-NBR-1          TO DP132-REPORT-NUMBER.        06060004
060700                                                                  06070004
060800     MOVE PV-POS-DATE-FORMATTED    TO HL2-DATE.                   06080004
060900 EJECT                                                            06090004
061000                                                                  06100004
061100******************************************************************06110004
061200* 1300-PREPARE FOR REPORT                                         06120004
061300*     - OPEN THE CURSOR                                           06130004
061400*     - FETCH FIRST RECORD                                        06140004
061500*     - IF RECORD                                                 06150004
061600******************************************************************06160004
061700 1300-PREPARE-FOR-REPORT.                                         06170004
061800                                                                  06180004
061900     PERFORM 8000-PRINT-HEADINGS.                                 06190004
062000     PERFORM 2100-OPEN-AMEX-CURSOR.                               06200004
062100     PERFORM 2200-FETCH-AMEX-CURSOR.                              06210004
062200     IF PS-END-OF-CURSOR                                          06220004
062300         DISPLAY '*** NO DATA PRESENT FOR AMEX CORR ***'          06230004
062400                 '*** ON SALES DATE '                             06240004
062500                 PV-POS-DATE-FORMATTED                            06250004
062600     ELSE                                                         06260004
062700         PERFORM 2500-PROCESS-FIRST-RECORD                        06270004
062800     END-IF.                                                      06280004
062900                                                                  06290004
063000******************************************************************06300004
063100* 2000-PRODUCE-REPORT-LINES                                       06310004
063200*  PRODUCE THE ACTUAL REPORT LINES                                06320004
063300******************************************************************06330004
063400 2000-PRODUCE-REPORT-LINES.                                       06340004
063500                                                                  06350004
063600     IF EPTRN-STR-NBR              = PV-HOLD-STORE                06360004
063700         CONTINUE                                                 06370004
063800     ELSE                                                         06380004
063900         PERFORM 3000-STORE-BREAK                                 06390004
064000     END-IF.                                                      06400004
064100                                                                  06410004
064200     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           06420004
064300         CONTINUE                                                 06430004
064400     ELSE                                                         06440004
064500         PERFORM 3500-SALES-DATE-BREAK                            06450004
064600     END-IF.                                                      06460004
064700                                                                  06470004
064800     PERFORM 5000-PRINT-DETAIL-LINE.                              06480004
064900     PERFORM 2200-FETCH-AMEX-CURSOR.                              06490004
065000                                                                  06500004
065100******************************************************************06510004
065200* 2100-OPEN-AMEX-CURSOR.                                          06520004
065300*     OPEN AMEX CURSOR                                            06530004
065400******************************************************************06540004
065500 2100-OPEN-AMEX-CURSOR.                                           06550004
065600                                                                  06560004
065700     EXEC SQL                                                     06570004
065800          OPEN AMEX-CURSOR                                        06580004
065900     END-EXEC.                                                    06590004
066000                                                                  06600004
066100     EVALUATE TRUE                                                06610004
066200         WHEN SQLCODE = ZERO                                      06620004
066300              CONTINUE                                            06630004
066400         WHEN SQLWARN0 NOT EQUAL SPACE                            06640004
066500         WHEN SQLCODE NOT EQUAL ZERO                              06650004
066600             MOVE '2100-OPEN AMEX CURSOR'                         06660004
066700                                   TO PV-PARAGRAPH-NAME           06670004
066800             MOVE 'ERROR ON OPEN OF AMEX-CURSOR'                  06680004
066900                                   TO PV-DB2-OPERATION            06690004
067000             PERFORM 9100-SQL-ABEND                               06700004
067100     END-EVALUATE.                                                06710004
067200 EJECT                                                            06720004
067300                                                                  06730004
067400******************************************************************06740004
067500* 2200-FETCH-SUMMARY-CURSOR                                       06750004
067600*   -FETCH ROWS THAT QUALIFY FOR THE REPORT                       06760004
067700******************************************************************06770004
067800 2200-FETCH-AMEX-CURSOR.                                          06780004
067900                                                                  06790004
068000     EXEC SQL                                                     06800004
068100          FETCH AMEX-CURSOR                                       06810004
068200           INTO :EPTRN-PARTN-NBR                                  06820004
068300               ,:EPTRN-STR-NBR                                    06830004
068400               ,:EPTRN-RGST-ID                                    06840004
068500               ,:EPTRN-TRN-NBR                                    06850004
068600               ,:EPTRN-STRT-TM                                    06860004
068700               ,:EPTRN-SLS-CORR-SEQ-NBR                           06870004
068800               ,:EPTRN-TRN-STAT-CDE                               06880004
068900               ,:EPTRN-SLS-DTE                                    06890004
069000               ,:EPTRN-ASSOC-ID                                   06900004
069100               ,:EPTND-TNDR-ID                                    06910004
069200               ,:EPTND-TNDR-AMT                                   06920004
069300               ,:EPTND-TNDR-ID-LEN-NBR                            06930004
069400               ,:EPCRD-AUTH-NBR                                   06940004
069500     END-EXEC.                                                    06950004
069600                                                                  06960004
069700     EVALUATE TRUE                                                06970004
069800         WHEN SQLCODE = ZERO                                      06980004
069900             ADD 1                 TO PV-CURSOR-CNT               06990004
070000         WHEN SQLCODE = PC-ROW-NOT-FOUND                          07000004
070100             SET PS-END-OF-CURSOR  TO TRUE                        07010004
070200         WHEN SQLWARN0 NOT EQUAL SPACE                            07020004
070300         WHEN SQLCODE NOT EQUAL ZERO                              07030004
070400             MOVE '2200-FETCH-AMEX-CURSOR'                        07040004
070500                                   TO PV-PARAGRAPH-NAME           07050004
070600             MOVE 'ERROR ON FETCH OF SETTLEMENT-CURSOR'           07060004
070700                                   TO PV-DB2-OPERATION            07070004
070800             PERFORM 9100-SQL-ABEND                               07080004
070900     END-EVALUATE.                                                07090004
071000 EJECT                                                            07100004
071100                                                                  07110004
071200******************************************************************07120004
071300* 2300-CLOSE-AMEX-CURSOR                                          07130004
071400*   -CLOSE THE CURSOR                                             07140004
071500******************************************************************07150004
071600 2300-CLOSE-AMEX-CURSOR.                                          07160004
071700                                                                  07170004
071800     EXEC SQL                                                     07180004
071900          CLOSE AMEX-CURSOR                                       07190004
072000     END-EXEC.                                                    07200004
072100                                                                  07210004
072200     EVALUATE TRUE                                                07220004
072300         WHEN SQLCODE = ZERO                                      07230004
072400              CONTINUE                                            07240004
072500         WHEN SQLWARN0 NOT EQUAL SPACE                            07250004
072600         WHEN SQLCODE NOT EQUAL ZERO                              07260004
072700             MOVE '2300-CLOSE-AMEX-CURSOR'                        07270004
072800                                   TO PV-PARAGRAPH-NAME           07280004
072900             MOVE 'ERROR ON CLOSE OF AMEX-CURSOR'                 07290004
073000                                   TO PV-DB2-OPERATION            07300004
073100             PERFORM 9100-SQL-ABEND                               07310004
073200     END-EVALUATE.                                                07320004
073300 EJECT                                                            07330004
073400                                                                  07340004
073500******************************************************************07350004
073600*  FIRST RECORD PROCESSING.  WRITE THE HEADER RECORDS AND MOVE    07360004
073700*  THE DATA INTO THE APPROPRIATE FIELDS.                          07370004
073800******************************************************************07380004
073900 2500-PROCESS-FIRST-RECORD.                                       07390004
074000                                                                  07400004
074100     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07410004
074200     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         07420004
074300*    PERFORM 3010-GET-MERCHANT-NUMBER.                            07430004
074400     PERFORM 5100-PRINT-STORE-MERCHANT-LINE.                      07440004
074500     PERFORM 3510-FORMAT-SALES-DATE.                              07450004
074600                                                                  07460004
074700******************************************************************07470004
074800*  PRINT THE STORE TOTAL WHEN A BREAK ON THE STORE NUMBER OCCURS  07480004
074900******************************************************************07490004
075000 3000-STORE-BREAK.                                                07500004
075100                                                                  07510004
075200     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         07520004
075300*    PERFORM 3010-GET-MERCHANT-NUMBER.                            07530004
075400     PERFORM 5100-PRINT-STORE-MERCHANT-LINE.                      07540004
075500                                                                  07550004
075600*** THE SALES DATE SHOULD ALWAYS BE PRINTED UNDER THE NEW STORE   07560004
075700*** INFORMATION.  THIS CHECKS TO SEE IF WE HAVE A DIFFERENT SALES 07570004
075800*** DATE WITH THE NEW STORE.                                      07580004
075900                                                                  07590004
076000     IF EPTRN-SLS-DTE              = PV-HOLD-SALES-DATE           07600004
076100         CONTINUE                                                 07610004
076200     ELSE                                                         07620004
076300         MOVE EPTRN-SLS-DTE        TO PV-HOLD-SALES-DATE          07630004
076400         PERFORM 3510-FORMAT-SALES-DATE                           07640004
076500     END-IF.                                                      07650004
076600                                                                  07660004
076700     MOVE ZERO TO                  PA-STORE-SALES-AMOUNT          07670004
076800                                   PA-STORE-RETURN-AMOUNT.        07680004
076900     MOVE EPTRN-STR-NBR            TO PV-HOLD-STORE.              07690004
077000                                                                  07700004
077100***************************************************************** 07710004
077200*  GET THE MERCHANT NUMBER FOR THE STORE                          07720004
077300***************************************************************** 07730004
077400*3010-GET-MERCHANT-NUMBER.                                        07740004
077500*                                                                 07750004
077600*    EXEC SQL                                                     07760004
077700*        SELECT  AMEX_MERCH_NBR                                   07770004
077800*        INTO    :XST00025-AMEX-MERCH-NBR                         07780004
077900*        FROM    XST_LOC_ATTR                                     07790004
078000*        WHERE   LOC_NBR = :EPTRN-STR-NBR                         07800004
078100*        WITH UR                                                  07810004
078200*    END-EXEC.                                                    07820004
078300*                                                                 07830004
078400*    EVALUATE TRUE                                                07840004
078500*        WHEN SQLCODE = ZERO                                      07850004
078600*            MOVE XST00025-AMEX-MERCH-NBR                         07860004
078700*                                  TO PV-MERCH-NMBR               07870004
078800*        WHEN SQLWARN0 NOT EQUAL SPACE                            07880004
078900*        WHEN SQLCODE NOT EQUAL ZERO                              07890004
079000*            MOVE '3010-GET-MERCHANT-NUMBER'                      07900004
079100*                                  TO PV-PARAGRAPH-NAME           07910004
079200*            MOVE 'ERROR ON GETTING MERCHANT NUMBER'              07920004
079300*                                  TO PV-DB2-OPERATION            07930004
079400*            PERFORM 9100-SQL-ABEND                               07940004
079500*    END-EVALUATE.                                                07950004
079600*                                                                 07960004
079700***************************************************************** 07970004
079800*  PRINT THE REQUIRED DATA ON A BREAK IN SALES DATE               07980004
079900***************************************************************** 07990004
080000 3500-SALES-DATE-BREAK.                                           08000004
080100                                                                  08010004
080200     PERFORM 5200-PRINT-STORE-TOTAL-LINE.                         08020004
080300     MOVE ZERO                     TO PA-STORE-SALES-AMOUNT       08030004
080400                                      PA-STORE-RETURN-AMOUNT.     08040004
080500     MOVE EPTRN-SLS-DTE            TO PV-HOLD-SALES-DATE.         08050004
080600     PERFORM 3510-FORMAT-SALES-DATE.                              08060004
080700                                                                  08070004
080800****************************************************************  08080004
080900*  CALL CALENDAR ROUTINE TO CONVERT THE SALES DATE FROM DB2       08090004
081000*  FORMAT INTO GREGORIAN FORMATTED FORMAT                         08100004
081100****************************************************************  08110004
081200 3510-FORMAT-SALES-DATE.                                          08120004
081300                                                                  08130004
081400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              08140004
081500                                                                  08150004
081600     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   08160004
081700     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   08170004
081800     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   08180004
081900     MOVE EPTRN-SLS-DTE                TO DPG52-LK-DATE-INPUT.    08190004
082000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    08200004
082100                                             DPG54 DPG55 DPG56.   08210004
082200     EVALUATE TRUE                                                08220004
082300         WHEN DPG54-SEVERE-ERROR                                  08230004
082400         WHEN DPG54-DATE-INVALID                                  08240004
082500             MOVE '3510-FORMAT-SALES-DATEE'                       08250004
082600                                   TO PV-PARAGRAPH-NAME           08260004
082700             MOVE 'ERROR CONVERTING SALES DATE'                   08270004
082800                                   TO PV-OPERATION-MSG-1          08280004
082900             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                08290004
083000             MOVE DPG54-ERROR-MESSAGE                             08300004
083100                                   TO PV-OPERATION-MSG-2          08310004
083200             PERFORM 9999-ABEND                                   08320004
083300     END-EVALUATE.                                                08330004
083400     MOVE DPG55-GREG-CC-DATE-FMT   TO PV-SLS-DATE-FORMATTED.      08340004
083500                                                                  08350004
083600******************************************************************08360004
083700* 4000-PRINT-REPORT-TOTALS                                        08370004
083800*     PRINT REPORT TOTALS (IF DATA WAS PRESENT & REPORT CREATED), 08380004
083900*     CLOSE REPORT FILE.                                          08390004
084000******************************************************************08400004
084100 4000-PRINT-REPORT-TOTALS.                                        08410004
084200                                                                  08420004
084300     PERFORM 2300-CLOSE-AMEX-CURSOR.                              08430004
084400     MOVE PV-POS-DATE-FORMATTED    TO TL1-DATE.                   08440004
084500     MOVE PA-COMPANY-SALES-AMOUNT                                 08450004
084600                                   TO TL1-SALES-AMOUNT.           08460004
084700     MOVE PA-COMPANY-RETURN-AMOUNT                                08470004
084800                                   TO TL1-RETURN-AMOUNT.          08480004
084900     COMPUTE PV-AMOUNT             = PA-COMPANY-RETURN-AMOUNT     08490004
085000                                   + PA-COMPANY-SALES-AMOUNT.     08500004
085100     MOVE PV-AMOUNT                TO TL1-NET-AMOUNT.             08510004
085200     MOVE +4                       TO PV-LINE-SPACING.            08520004
085300     MOVE TL1-TOTAL-LINE-1         TO PV-PRINT-RECORD.            08530004
085400     PERFORM 8200-WRITE-REPORT-LINE.                              08540004
085500     CLOSE AMEX-REPORT-FILE.                                      08550004
085600 EJECT                                                            08560004
085700                                                                  08570004
085800******************************************************************08580004
085900* 5000-PRINT-DETAIL-LINE                                          08590004
086000*     FORMAT AND PRINT REPORT DETAIL LINE.                        08600004
086100******************************************************************08610004
086200 5000-PRINT-DETAIL-LINE.                                          08620004
086300                                                                  08630004
086400     IF PV-LINE-CNT                > PC-LINE-LIMIT                08640004
086500         PERFORM 8000-PRINT-HEADINGS                              08650004
086600     END-IF.                                                      08660004
086700                                                                  08670004
086800     INITIALIZE                    DL1-SALES-AMOUNT               08680004
086900                                   DL1-RETURN-AMOUNT              08690004
087000                                   DL1-ASSOC-ID                   08700004
087100                                   DL1-CODE                       08710004
087200                                   DL1-CARD-NBR-FIRST-4           08720004
087300                                   DL1-CARD-NBR-SECOND-6          08730004
087400                                   DL1-CARD-NBR-LAST-5.           08740004
087500     MOVE PV-SLS-DATE-FORMATTED    TO DL1-SALES-DATE.             08750004
087600     MOVE EPTRN-RGST-ID            TO DL1-REGISTER.               08760004
087700     MOVE EPTRN-TRN-NBR            TO DL1-TRANSACTION.            08770004
087800     MOVE EPCRD-AUTH-NBR           TO DL1-AUTH-NBR.               08780004
087900     MOVE ALL '*'                  TO DL1-CARD-NBR-FIRST-4.       08790009
088000     MOVE ALL '*'                  TO DL1-CARD-NBR-SECOND-6.      08800009
P10237     MOVE '*'                      TO DL1-CARD-NBR-LAST-5(1:1).   08801010
P10237     MOVE EPTND-TNDR-ID (12:4)     TO DL1-CARD-NBR-LAST-5(2:4).   08810010
088200                                                                  08820004
088300     EVALUATE TRUE                                                08830004
088400         WHEN EPTND-TNDR-AMT       > ZERO                         08840004
088500             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         08850004
088600             MOVE PV-AMOUNT-FORMATTED                             08860004
088700                                   TO DL1-SALES-AMOUNT            08870004
088800             MOVE SPACE            TO DL1-RETURN-AMOUNT           08880004
088900             ADD EPTND-TNDR-AMT    TO PA-STORE-SALES-AMOUNT       08890004
089000                                                                  08900004
089100         WHEN EPTND-TNDR-AMT       < ZERO                         08910004
089200             MOVE EPTND-TNDR-AMT   TO PV-AMOUNT-FORMATTED         08920004
089300             MOVE PV-AMOUNT-FORMATTED                             08930004
089400                                   TO DL1-RETURN-AMOUNT           08940004
089500             MOVE SPACE            TO DL1-SALES-AMOUNT            08950004
089600             ADD EPTND-TNDR-AMT    TO PA-STORE-RETURN-AMOUNT      08960004
089700                                                                  08970004
089800         WHEN OTHER                                               08980004
089900             MOVE ZERO             TO PV-AMOUNT-FORMATTED         08990004
090000             MOVE PV-AMOUNT-FORMATTED                             09000004
090100                                   TO DL1-RETURN-AMOUNT           09010004
090200                                      DL1-SALES-AMOUNT            09020004
090300     END-EVALUATE.                                                09030004
090400                                                                  09040004
090500**** A LATE TRANSACTION, INDICATED BY A -1 SEQUENCE NUMBER, WILL N09050004
090600**** HAVE A SALES AUDIT USER ID.  A REGULAR CORRECTION WILL HVAE A09060004
090700**** SALES AUDIT USER ID.                                         09070004
090800                                                                  09080004
090900     IF EPTRN-SLS-CORR-SEQ-NBR     < ZERO                         09090004
091000         MOVE PC-SYSTEM-CORRECTION TO DL1-CODE                    09100004
091100     ELSE                                                         09110004
091200         IF EPTRN-TRN-STAT-CDE     = PC-REVERSAL-CORRECTION       09120004
091300             MOVE PC-REVERSAL-CORRECTION                          09130004
091400                                   TO DL1-CODE                    09140004
091500         END-IF                                                   09150004
091600         PERFORM 5010-SELECT-SLS-AUD-USER-ID                      09160004
091700     END-IF.                                                      09170004
091800                                                                  09180004
091900     MOVE DL1-DETAIL-LINE-1        TO PV-PRINT-RECORD.            09190004
092000                                                                  09200004
092100**** FOLLOWING CODE CHECKS IF THE LAST LINE PRINTED WAS SINGLE    09210004
092200**** SPACED (LIKE A DETAIL LINE) OR GREATER THAN SINGLE SPACED    09220004
092300**** (LIKE A HEADING LINE).  IF LAST LINE WAS NOT SINGLE SPACED,  09230004
092400**** PRINT THE DETAIL LINE DOUBLE SPACED.                         09240004
092500                                                                  09250004
092600     IF PV-LINE-SPACING            > +1                           09260004
092700         MOVE +2                   TO  PV-LINE-SPACING            09270004
092800     ELSE                                                         09280004
092900         MOVE +1                   TO  PV-LINE-SPACING            09290004
093000     END-IF.                                                      09300004
093100     PERFORM 8200-WRITE-REPORT-LINE.                              09310004
093200     MOVE +1                       TO  PV-LINE-SPACING.           09320004
093300 EJECT                                                            09330004
093400                                                                  09340004
093500***************************************************************** 09350004
093600* 5010-SELECT-SLS-AUD-USER-ID                                     09360004
093700*   - SELECT THE SALES AUDIT USER ID WHEN THE SALES CORRECTION    09370004
093800*     CORRECTION SEQUNCE NUMBER IS GREATER THAN ZERO              09380004
093900***************************************************************** 09390004
094000 5010-SELECT-SLS-AUD-USER-ID.                                     09400004
094100                                                                  09410004
094200     EXEC SQL                                                     09420004
094300         SELECT SLS_AUD_USR_ID                                    09430004
094400           INTO :EPSAT-SLS-AUD-USR-ID                             09440004
094500           FROM TEPSAT                                            09450004
094600          WHERE PARTN_NBR          = :EPTRN-PARTN-NBR             09460004
094700            AND STR_NBR            = :EPTRN-STR-NBR               09470004
094800            AND RGST_ID            = :EPTRN-RGST-ID               09480004
094900            AND TRN_NBR            = :EPTRN-TRN-NBR               09490004
095000            AND STRT_TM            = :EPTRN-STRT-TM               09500004
095100            AND SLS_CORR_SEQ_NBR   = :EPTRN-SLS-CORR-SEQ-NBR      09510004
095200         WITH UR                                                  09520004
095300     END-EXEC.                                                    09530004
095400                                                                  09540004
095500     EVALUATE TRUE                                                09550004
095600         WHEN SQLCODE = ZERO                                      09560004
095700             MOVE EPSAT-SLS-AUD-USR-ID                            09570004
095800                                   TO DL1-ASSOC-ID                09580004
095900         WHEN SQLCODE = PC-ROW-NOT-FOUND                          09590004
096000             MOVE 'UNKNOWN'        TO DL1-ASSOC-ID                09600004
096100         WHEN SQLWARN0 NOT EQUAL SPACE                            09610004
096200         WHEN SQLCODE NOT EQUAL ZERO                              09620004
096300             MOVE '5010-SELECT-SLS-AUD-USER-ID'                   09630004
096400                                   TO PV-PARAGRAPH-NAME           09640004
096500             MOVE 'ERROR ON SELECTING SLS AUD USER ID'            09650004
096600                                   TO PV-DB2-OPERATION            09660004
096700             PERFORM 9100-SQL-ABEND                               09670004
096800     END-EVALUATE.                                                09680004
096900                                                                  09690004
097000***************************************************************** 09700004
097100*  PRINT THE LINE CONTAINING THE STORE ANDMERCHANT NUMBER         09710004
097200***************************************************************** 09720004
097300 5100-PRINT-STORE-MERCHANT-LINE.                                  09730004
097400                                                                  09740004
097500**** FOLLOWING CODE CHECKS FOR ENOUGH ROOM ON THE PAGE TO         09750004
097600**** PRINT THE STORE / MERCHANT LINE, SALES DATE LINE,            09760004
097700**** AND AT LEAST ONE DETAIL LINE.                                09770004
097800                                                                  09780004
097900     MOVE PV-LINE-CNT              TO  PV-LINE-CNT-AHEAD.         09790004
098000     ADD +8                        TO  PV-LINE-CNT-AHEAD.         09800004
098100     IF PV-LINE-CNT-AHEAD          > PC-LINE-LIMIT                09810004
098200         PERFORM 8000-PRINT-HEADINGS                              09820004
098300     END-IF.                                                      09830004
098400                                                                  09840004
098500     MOVE EPTRN-STR-NBR            TO HL3-STORE.                  09850004
098600*    MOVE PV-MERCH-NMBR            TO HL3-MERCHANT.               09860004
098700     MOVE +4                       TO PV-LINE-SPACING.            09870004
098800     MOVE HL3-HEADING-LINE-3       TO PV-PRINT-RECORD.            09880004
098900     PERFORM 8200-WRITE-REPORT-LINE.                              09890004
099000                                                                  09900004
099100******************************************************************09910004
099200*  PRINT THE STORE TOTAL LINE INFORMATION                         09920004
099300******************************************************************09930004
099400 5200-PRINT-STORE-TOTAL-LINE.                                     09940004
099500                                                                  09950004
099600     IF PV-LINE-CNT                > PC-LINE-LIMIT                09960004
099700         PERFORM 8000-PRINT-HEADINGS                              09970004
099800     END-IF.                                                      09980004
099900                                                                  09990004
100000     MOVE PV-HOLD-STORE            TO HL6-STORE.                  10000004
100100     MOVE PV-SLS-DATE-FORMATTED    TO HL6-DATE.                   10010004
100200                                                                  10020004
100300     IF PA-STORE-SALES-AMOUNT      > ZERO                         10030004
100400         MOVE PA-STORE-SALES-AMOUNT                               10040004
100500                                   TO PV-AMOUNT-FORMATTED         10050004
100600         MOVE PV-AMOUNT-FORMATTED  TO HL6-SALES-TOTAL             10060004
100700     ELSE                                                         10070004
100800         MOVE SPACE                TO HL6-SALES-TOTAL             10080004
100900     END-IF.                                                      10090004
101000                                                                  10100004
101100     ADD  PA-STORE-SALES-AMOUNT    TO PA-COMPANY-SALES-AMOUNT.    10110004
101200                                                                  10120004
101300     IF PA-STORE-RETURN-AMOUNT     < ZERO                         10130004
101400         MOVE PA-STORE-RETURN-AMOUNT                              10140004
101500                                   TO PV-AMOUNT-FORMATTED         10150004
101600         MOVE PV-AMOUNT-FORMATTED  TO HL6-RETURN-TOTAL            10160004
101700     ELSE                                                         10170004
101800         MOVE SPACE                TO HL6-RETURN-TOTAL            10180004
101900     END-IF.                                                      10190004
102000                                                                  10200004
102100     ADD PA-STORE-RETURN-AMOUNT    TO PA-COMPANY-RETURN-AMOUNT.   10210004
102200     COMPUTE PV-AMOUNT             = PA-STORE-RETURN-AMOUNT       10220004
102300                                   + PA-STORE-SALES-AMOUNT.       10230004
102400     MOVE PV-AMOUNT                TO PV-AMOUNT-FORMATTED.        10240004
102500     MOVE PV-AMOUNT-FORMATTED      TO HL6-NET-AMOUNT.             10250004
102600     MOVE +2                       TO PV-LINE-SPACING.            10260004
102700     MOVE HL6-HEADING-LINE-6       TO PV-PRINT-RECORD.            10270004
102800     PERFORM 8200-WRITE-REPORT-LINE.                              10280004
102900                                                                  10290004
103000******************************************************************10300004
103100* 8000-PRINT-HEADINGS                                             10310004
103200*     PRINT THE HEADINGS FOR THE REPORT.                          10320004
103300******************************************************************10330004
103400 8000-PRINT-HEADINGS.                                             10340004
103500                                                                  10350004
103600     ADD +1                        TO PV-PAGE-CNT.                10360004
103700     MOVE PV-PAGE-CNT TO DP132-PAGE-NUMBER.                       10370004
103800     MOVE DP132-STANDRD-HEADER-132-COLS                           10380004
103900                                   TO PV-PRINT-RECORD.            10390004
104000     PERFORM 8100-WRITE-RPT-TOP-OF-PAGE.                          10400004
104100                                                                  10410004
104200     MOVE HL2-HEADING-LINE-2       TO PV-PRINT-RECORD.            10420004
104300     MOVE +1                       TO PV-LINE-SPACING.            10430004
104400     PERFORM 8200-WRITE-REPORT-LINE.                              10440004
104500                                                                  10450004
104600     MOVE +2                       TO PV-LINE-SPACING.            10460004
104700     MOVE HL4-HEADING-LINE-4       TO PV-PRINT-RECORD.            10470004
104800     PERFORM 8200-WRITE-REPORT-LINE.                              10480004
104900                                                                  10490004
105000     MOVE +1                       TO PV-LINE-SPACING.            10500004
105100     MOVE HL5-HEADING-LINE-5       TO PV-PRINT-RECORD.            10510004
105200     PERFORM 8200-WRITE-REPORT-LINE.                              10520004
105300     MOVE +2                       TO PV-LINE-SPACING.            10530004
105400                                                                  10540004
105500 EJECT                                                            10550004
105600                                                                  10560004
105700******************************************************************10570004
105800* 8100-WRITE-RPT-TOP-OF-PAGE                                      10580004
105900*     WRITE FIRST REPORT LINE AFTER PAGE BREAK.                   10590004
106000******************************************************************10600004
106100 8100-WRITE-RPT-TOP-OF-PAGE.                                      10610004
106200                                                                  10620004
106300     WRITE AMEX-REPORT-RECORD                                     10630004
106400       FROM PV-PRINT-RECORD                                       10640004
106500         AFTER ADVANCING PAGE.                                    10650004
106600     MOVE +1                       TO PV-LINE-CNT.                10660004
106700 EJECT                                                            10670004
106800                                                                  10680004
106900******************************************************************10690004
107000* 8200-WRITE-REPORT-LINE                                          10700004
107100*     WRITE REPORT LINE AFTER ADVANCING LINE SPACING.             10710004
107200******************************************************************10720004
107300 8200-WRITE-REPORT-LINE.                                          10730004
107400                                                                  10740004
107500     WRITE AMEX-REPORT-RECORD                                     10750004
107600       FROM PV-PRINT-RECORD                                       10760004
107700         AFTER ADVANCING PV-LINE-SPACING.                         10770004
107800                                                                  10780004
107900     ADD PV-LINE-SPACING TO PV-LINE-CNT.                          10790004
108000 EJECT                                                            10800004
108100                                                                  10810004
108200******************************************************************10820004
108300* 9100-SQL-ABEND                                                  10830004
108400*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.10840004
108500******************************************************************10850004
108600 9100-SQL-ABEND.                                                  10860004
108700     DISPLAY '** ABEND     **'.                                   10870004
108800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        10880004
108900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              10890004
109000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               10900004
109100                                                                  10910004
109200******************************************************************10920004
109300* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     10930004
109400* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      10940004
109500******************************************************************10950004
109600     COPY DPPD004.                                                10960004
109700                                                                  10970004
109800     SET AC-DB2-ERROR TO TRUE.                                    10980004
109900     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         10990004
110000                                                                  11000004
110100******************************************************************11010004
110200* 9999-ABEND                                                      11020004
110300*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  11030004
110400******************************************************************11040004
110500 9999-ABEND.                                                      11050004
110600     DISPLAY '** ABEND           **'.                             11060004
110700     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  11070004
110800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        11080004
110900     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       11090004
111000     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       11100004
111100     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         11110004
