000100 IDENTIFICATION DIVISION.                                         00010002
000200                                                                  00020002
000300 PROGRAM-ID.      TFKUP509.                                       00030002
000400 AUTHOR.          STEVEN NOWAK.                                   00040002
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050002
000600 DATE-WRITTEN.    03/22/10.                                       00060002
000700 DATE-COMPILED.                                                   00070002
000800                                                                  00080002
000900******************************************************************00090002
001000*  MODULE TYPE:   COBOL2 DB2 BATCH.                               00100002
001100*                                                                 00110002
001200*  PURPOSE: THIS PROGRAM PURGES F.A.S.T. TRANSFER RECORDS WHICH   00120002
001300*  ARE MORE THAN 25 MONTHS OLD.                                   00130002
001400*                                                                 00140002
001500*========================== CHANGE LOG ===========================00150002
001600*  AUTH        BY            DATE                 DESCRIPTION     00160002
001700*=================================================================00170002
001800* WR37120    S. NOWAK      03-22-10   CREATE PROGRAM              00180002
001800* PR#3403    C. PARMLEY    02-27-12   COMPILE FOR TTFITEM AND     00181003
001800*                                     TTFITRC CHANGES             00182003
260107* CHG0260107 JIM HUNTER    08-19-21  ADD COPYBOOK DPWS991 TO      00183004
260107*                                    MAKE DPKUT901 CALL DYNAMIC.  00184004
002000******************************************************************00200002
002100                                                                  00210002
002200 ENVIRONMENT DIVISION.                                            00220002
002300 CONFIGURATION SECTION.                                           00230002
002400                                                                  00240002
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250002
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260002
002700                                                                  00270002
002800 INPUT-OUTPUT SECTION.                                            00280002
002900 FILE-CONTROL.                                                    00290002
003000                                                                  00300002
003100 DATA DIVISION.                                                   00310002
003200 FILE SECTION.                                                    00320002
003300                                                                  00330002
003400                                                                  00340002
003500***************************************************************** 00350002
003600*                       WORKING STORAGE                           00360002
003700***************************************************************** 00370002
003800 WORKING-STORAGE SECTION.                                         00380002
003900                                                                  00390002
004000 01  W-START                          PIC  X(40)                  00400002
004100     VALUE 'TFKUP509 - WORKING STORAGE BEGINS HERE'.              00410002
004200                                                                  00420002
004300                                                                  00430002
004400***************************************************************** 00440002
004500*                         SWITCHES                                00450002
004600***************************************************************** 00460002
004700 01  PROGRAM-SWITCHES.                                            00470002
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00480002
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00490002
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00500002
005100                                                                  00510002
005200******************************************************************00520002
005300*                       ACCUMULATORS                              00530002
005400******************************************************************00540002
005500 01  PROGRAM-ACCUM.                                               00550002
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00560002
005700     05  PA-CKPT                      PIC  9(11) VALUE ZEROS.     00570002
005800                                                                  00580002
005900******************************************************************00590002
006000*                           CONSTANTS                             00600002
006100******************************************************************00610002
006200 01  PROGRAM-CONSTANTS.                                           00620002
006300     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00630002
006400                                                 COMP SYNC.       00640002
006500     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00650002
006600                                                 COMP SYNC.       00660002
006700                                                                  00670002
006800     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'TFK570  '.00680002
006900     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'TFKUP509'.00690002
007000     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'TFKUP509'.00700002
007100                                                                  00710002
007200     05  PC-TRAN-PRES-FUNC-CODES.                                 00720002
007300         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00730002
007400         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00740002
007500         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00750002
007600         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00760002
007700                                                                  00770002
007800     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00780002
007900     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00790002
008000                                                                  00800002
008100******************************************************************00810002
008200*                          VARIABLES                              00820002
008300******************************************************************00830002
008400 01  PROGRAM-VARIABLES.                                           00840002
008500     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00850002
008600     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00860002
008700     05  PV-RETRY-CNT                 PIC  9(03) VALUE ZERO.      00870002
008800     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00880002
008900     05  PV-DB2-OPERATION             PIC  X(30) VALUE SPACE.     00890002
009000     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00900002
009100     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00910002
009200                                                                  00920002
009300******************************************************************00930002
009400*               SYSTEM TIME AND DATE VARIABLES                    00940002
009500******************************************************************00950002
009600 01  SYS-DATE-TIME.                                               00960002
009700     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00970002
009800     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00980002
009900                                                                  00990002
010000 01  ST-BEG-TIME.                                                 01000002
010100     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     01010002
010200     05  FILLER                       PIC  X(01) VALUE ':'.       01020002
010300     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01030002
010400                                                                  01040002
010500 01  ST-END-TIME.                                                 01050002
010600     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01060002
010700     05  FILLER                       PIC  X(01) VALUE ':'.       01070002
010800     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01080002
010900                                                                  01090002
011000 01  SD-EDIT-DATE.                                                01100002
011100     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01110002
011200     05  FILLER                       PIC  X(01) VALUE '-'.       01120002
011300     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01130002
011400     05  FILLER                       PIC  X(01) VALUE '-'.       01140002
011500     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01150002
011600     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01160002
011700                                                                  01170002
011800******************************************************************01180002
011900*                        ERROR HANDLING                           01190002
012000******************************************************************01200002
012100 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01210002
012200                                                 COMP SYNC.       01220002
012300     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01230002
012400     88  ABEND-4444-FORCED-ABEND                 VALUE +4444.     01240002
012500                                                                  01250002
012600                                                                  01260002
012700******************************************************************01270002
012800*  DELETE RECORD                                                  01280002
012900******************************************************************01290002
013000     COPY TFRD059.                                                01300002
013100                                                                  01310002
013200******************************************************************01320002
013300*  DB2 FORMATTED ERROR MESSAGE                                    01330002
013400******************************************************************01340002
013500     COPY DPWS004.                                                01350002
013600                                                                  01360002
013700******************************************************************01370002
013800*  SQL COMMUNICATIONS WORK AREA                                   01380002
013900******************************************************************01390002
014000     COPY SQLCA2.                                                 01400002
014100                                                                  01410002
014200******************************************************************01420002
014300*  COMMUNICATIONS AREA FOR DB2                                    01430002
014400******************************************************************01440002
014500     EXEC SQL                                                     01450002
014600         INCLUDE SQLCA                                            01460002
014700     END-EXEC.                                                    01470002
014800                                                                  01480002
014900******************************************************************01490002
015000* DCLGEN LAYOUT AND COBOL DECLARATION FOR TRANSFER MASTER TABLE   01500002
015100******************************************************************01510002
015200     EXEC SQL                                                     01520002
015300         INCLUDE TTFMSTR                                          01530002
015400     END-EXEC.                                                    01540002
015500                                                                  01550002
015600******************************************************************01560002
015700* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM TABLE 01570002
015800******************************************************************01580002
015900     EXEC SQL                                                     01590002
016000         INCLUDE TTFITEM                                          01600002
016100     END-EXEC.                                                    01610002
016200                                                                  01620002
016300******************************************************************01630002
016400* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER CUST TBL   01640002
016500******************************************************************01650002
016600     EXEC SQL                                                     01660002
016700         INCLUDE TTFCUST                                          01670002
016800     END-EXEC.                                                    01680002
016900                                                                  01690002
017000******************************************************************01700002
017100* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER STAT TBL   01710002
017200******************************************************************01720002
017300     EXEC SQL                                                     01730002
017400         INCLUDE TTFSTAT                                          01740002
017500     END-EXEC.                                                    01750002
017600                                                                  01760002
017700******************************************************************01770002
017800* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM       01780002
017900* POSTING TABLE                                                   01790002
018000******************************************************************01800002
018100     EXEC SQL                                                     01810002
018200         INCLUDE TTFITPS                                          01820002
018300     END-EXEC.                                                    01830002
018400                                                                  01840002
018500******************************************************************01850002
018600* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER RECEIPT    01860002
018700* TABLE                                                           01870002
018800******************************************************************01880002
018900     EXEC SQL                                                     01890002
019000         INCLUDE TTFRCPT                                          01900002
019100     END-EXEC.                                                    01910002
019200                                                                  01920002
019300******************************************************************01930002
019400* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER            01940002
019500* DISCREPANCY TABLE                                               01950002
019600******************************************************************01960002
019700     EXEC SQL                                                     01970002
019800         INCLUDE TTFDSCP                                          01980002
019900     END-EXEC.                                                    01990002
020000                                                                  02000002
020100******************************************************************02010002
020200* DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM       02020002
020300* RECEIPT TABLE                                                   02030002
020400******************************************************************02040002
020500     EXEC SQL                                                     02050002
020600         INCLUDE TTFITRC                                          02060002
020700     END-EXEC.                                                    02070002
020800                                                                  02080002
020900                                                                  02090002
021000******************************************************************02100002
021100*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             02110002
021200******************************************************************02120002
260107     COPY DPWS991.                                                02130004
021300                                                                  02131004
021300     COPY DPLS001.                                                02132004
021400     05  WORK-STORAGE-PASSED.                                     02140002
021500******************************************************************02150002
021600*PA - PROGRAM ACCUMULATORS                                        02160002
021700******************************************************************02170002
021800         10  PROGRAM-ACCUMULATORS.                                02180002
021900             15  PA-DEL-MSTR-CNT  PIC S9(11) VALUE ZERO COMP-3.   02190002
022000             15  PA-DEL-ITEM-CNT  PIC S9(11) VALUE ZERO COMP-3.   02200002
022100             15  PA-DEL-CUST-CNT  PIC S9(11) VALUE ZERO COMP-3.   02210002
022200             15  PA-DEL-STAT-CNT  PIC S9(11) VALUE ZERO COMP-3.   02220002
022300             15  PA-DEL-ITPS-CNT  PIC S9(11) VALUE ZERO COMP-3.   02230002
022400             15  PA-DEL-RCPT-CNT  PIC S9(11) VALUE ZERO COMP-3.   02240002
022500             15  PA-DEL-DSCP-CNT  PIC S9(11) VALUE ZERO COMP-3.   02250002
022600             15  PA-DEL-ITRC-CNT  PIC S9(11) VALUE ZERO COMP-3.   02260002
022700                                                                  02270002
022800 01  FILLER                          PIC X(4096)  VALUE SPACE.    02280002
022900                                                                  02290002
023000                                                                  02300002
023100                                                                  02310002
023200 PROCEDURE DIVISION.                                              02320002
023300******************************************************************02330002
023400* MAINLINE-PROCESSING                                             02340002
023500******************************************************************02350002
023600                                                                  02360002
023700     PERFORM A100-INITIALIZE.                                     02370002
023800                                                                  02380002
023900     PERFORM B100-PROCESS-RECORDS                                 02390002
024000       UNTIL DP001-PREP-TRANS-EOF.                                02400002
024100                                                                  02410002
024200     PERFORM Z990-EOJ-ROUTINE.                                    02420002
024300                                                                  02430002
024400     GOBACK.                                                      02440002
024500                                                                  02450002
024600                                                                  02460002
024700******************************************************************02470002
024800* PREFORMS TASK INITIATION                                        02480002
024900******************************************************************02490002
025000 A100-INITIALIZE.                                                 02500002
025100                                                                  02510002
025200     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 02520002
025300                                                                  02530002
025400     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            02540002
025500     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            02550002
025600                                                                  02560002
025700     MOVE SYS-DATE (1:2) TO SD-CENT.                              02570002
025800     MOVE SYS-DATE (3:2) TO SD-YEAR.                              02580002
025900     MOVE SYS-DATE (5:2) TO SD-MONTH.                             02590002
026000     MOVE SYS-DATE (7:2) TO SD-DAY.                               02600002
026100                                                                  02610002
026200     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              02620002
026300                                                                  02630002
026400     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02640002
026500                                                                  02650002
026600                                                                  02660002
026700******************************************************************02670002
026800* PROCESS RECORDS                                                 02680002
026900******************************************************************02690002
027000 B100-PROCESS-RECORDS.                                            02700002
027100                                                                  02710002
027200     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02720002
027300                                                                  02730002
027400     PERFORM C100-DELETE-RECS.                                    02740002
027500                                                                  02750002
027600*----------------------------------------------------------------*02760002
027700*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02770002
027800*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02780002
027900*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02790002
028000*----------------------------------------------------------------*02800002
028100     IF  PS-RESTART-REQUIRED                                      02810002
028200         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02820002
028300     ELSE                                                         02830002
028400         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02840002
028500     END-IF.                                                      02850002
028600                                                                  02860002
028700     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02870002
028800                                                                  02880002
028900     ADD 1 TO PA-READ.                                            02890002
029000                                                                  02900002
029100                                                                  02910002
029200******************************************************************02920002
029300* DELETE RECORDS                                                  02930002
029400******************************************************************02940002
029500 C100-DELETE-RECS.                                                02950002
029600                                                                  02960002
029700     MOVE TF059-XFER-DKEY-ID TO TFMSTR-XFER-DKEY-ID.              02970002
029800                                                                  02980002
029900     PERFORM C200-DELETE-XFER-TTFMSTR.                            02990002
030000     PERFORM C300-DELETE-XFER-TTFITEM.                            03000002
030100     PERFORM C400-DELETE-XFER-TTFCUST.                            03010002
030200     PERFORM C500-DELETE-XFER-TTFSTAT.                            03020002
030300     PERFORM C600-DELETE-XFER-TTFITPS.                            03030002
030400     PERFORM C700-DELETE-XFER-TTFRCPT.                            03040002
030500     PERFORM C800-DELETE-XFER-TTFDSCP.                            03050002
030600     PERFORM C900-DELETE-XFER-TTFITRC.                            03060002
030700                                                                  03070002
030800                                                                  03080002
030900***************************************************************** 03090002
031000* DELETE FROM TTFMSTR                                             03100002
031100***************************************************************** 03110002
031200 C200-DELETE-XFER-TTFMSTR.                                        03120002
031300                                                                  03130002
031400     EXEC SQL                                                     03140002
031500         DELETE  FROM TTFMSTR                                     03150002
031600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          03160002
031700     END-EXEC.                                                    03170002
031800                                                                  03180002
031900     EVALUATE TRUE                                                03190002
032000         WHEN SQLCODE = ZERO                                      03200002
032100             ADD 1 TO PA-DEL-MSTR-CNT                             03210002
032200                                                                  03220002
032300         WHEN SQLCODE = +100                                      03230002
032400             CONTINUE                                             03240002
032500                                                                  03250002
032600         WHEN SQLWARN0 NOT = SPACES                               03260002
032700         WHEN SQLCODE < ZERO                                      03270002
032800         WHEN SQLCODE > ZERO                                      03280002
032900             DISPLAY '               '                            03290002
033000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        03300002
033100                                                                  03310002
033200             MOVE 'C200-DELETE-XFER-TTFMSTR' TO PV-PARAGRAPH-NAME 03320002
033300             MOVE 'DELETE ROW FROM TTFMSTR'  TO PV-DB2-OPERATION  03330002
033400                                                                  03340002
033500             PERFORM Z200-SQL-ABEND                               03350002
033600     END-EVALUATE.                                                03360002
033700                                                                  03370002
033800                                                                  03380002
033900***************************************************************** 03390002
034000* DELETE FROM TTFITEM                                             03400002
034100***************************************************************** 03410002
034200 C300-DELETE-XFER-TTFITEM.                                        03420002
034300                                                                  03430002
034400     EXEC SQL                                                     03440002
034500         DELETE  FROM TTFITEM                                     03450002
034600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          03460002
034700     END-EXEC.                                                    03470002
034800                                                                  03480002
034900     EVALUATE TRUE                                                03490002
035000         WHEN SQLCODE = ZERO                                      03500002
035100             ADD 1 TO PA-DEL-ITEM-CNT                             03510002
035200                                                                  03520002
035300         WHEN SQLCODE = +100                                      03530002
035400             CONTINUE                                             03540002
035500                                                                  03550002
035600         WHEN SQLWARN0 NOT = SPACES                               03560002
035700         WHEN SQLCODE < ZERO                                      03570002
035800         WHEN SQLCODE > ZERO                                      03580002
035900             DISPLAY '               '                            03590002
036000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        03600002
036100                                                                  03610002
036200             MOVE 'C300-DELETE-XFER-TTFITEM' TO PV-PARAGRAPH-NAME 03620002
036300             MOVE 'DELETE ROW FROM TTFITEM'  TO PV-DB2-OPERATION  03630002
036400                                                                  03640002
036500             PERFORM Z200-SQL-ABEND                               03650002
036600     END-EVALUATE.                                                03660002
036700                                                                  03670002
036800                                                                  03680002
036900***************************************************************** 03690002
037000* DELETE FROM TTFCUST                                             03700002
037100***************************************************************** 03710002
037200 C400-DELETE-XFER-TTFCUST.                                        03720002
037300                                                                  03730002
037400     EXEC SQL                                                     03740002
037500         DELETE  FROM TTFCUST                                     03750002
037600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          03760002
037700     END-EXEC.                                                    03770002
037800                                                                  03780002
037900     EVALUATE TRUE                                                03790002
038000         WHEN SQLCODE = ZERO                                      03800002
038100             ADD 1 TO PA-DEL-CUST-CNT                             03810002
038200                                                                  03820002
038300         WHEN SQLCODE = +100                                      03830002
038400             CONTINUE                                             03840002
038500                                                                  03850002
038600         WHEN SQLWARN0 NOT = SPACES                               03860002
038700         WHEN SQLCODE < ZERO                                      03870002
038800         WHEN SQLCODE > ZERO                                      03880002
038900             DISPLAY '               '                            03890002
039000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        03900002
039100                                                                  03910002
039200             MOVE 'C400-DELETE-XFER-TTFCUST' TO PV-PARAGRAPH-NAME 03920002
039300             MOVE 'DELETE ROW FROM TTFCUST'  TO PV-DB2-OPERATION  03930002
039400                                                                  03940002
039500             PERFORM Z200-SQL-ABEND                               03950002
039600     END-EVALUATE.                                                03960002
039700                                                                  03970002
039800                                                                  03980002
039900***************************************************************** 03990002
040000* DELETE FROM TTFSTAT                                             04000002
040100***************************************************************** 04010002
040200 C500-DELETE-XFER-TTFSTAT.                                        04020002
040300                                                                  04030002
040400     EXEC SQL                                                     04040002
040500         DELETE  FROM TTFSTAT                                     04050002
040600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          04060002
040700     END-EXEC.                                                    04070002
040800                                                                  04080002
040900     EVALUATE TRUE                                                04090002
041000         WHEN SQLCODE = ZERO                                      04100002
041100             ADD 1 TO PA-DEL-STAT-CNT                             04110002
041200                                                                  04120002
041300         WHEN SQLCODE = +100                                      04130002
041400             CONTINUE                                             04140002
041500                                                                  04150002
041600         WHEN SQLWARN0 NOT = SPACES                               04160002
041700         WHEN SQLCODE < ZERO                                      04170002
041800         WHEN SQLCODE > ZERO                                      04180002
041900             DISPLAY '               '                            04190002
042000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        04200002
042100                                                                  04210002
042200             MOVE 'C500-DELETE-XFER-TTFSTAT' TO PV-PARAGRAPH-NAME 04220002
042300             MOVE 'DELETE ROW FROM TTFSTAT'  TO PV-DB2-OPERATION  04230002
042400                                                                  04240002
042500             PERFORM Z200-SQL-ABEND                               04250002
042600     END-EVALUATE.                                                04260002
042700                                                                  04270002
042800                                                                  04280002
042900***************************************************************** 04290002
043000* DELETE FROM TTFITPS                                             04300002
043100***************************************************************** 04310002
043200 C600-DELETE-XFER-TTFITPS.                                        04320002
043300                                                                  04330002
043400     EXEC SQL                                                     04340002
043500         DELETE  FROM TTFITPS                                     04350002
043600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          04360002
043700     END-EXEC.                                                    04370002
043800                                                                  04380002
043900     EVALUATE TRUE                                                04390002
044000         WHEN SQLCODE = ZERO                                      04400002
044100             ADD 1 TO PA-DEL-ITPS-CNT                             04410002
044200                                                                  04420002
044300         WHEN SQLCODE = +100                                      04430002
044400             CONTINUE                                             04440002
044500                                                                  04450002
044600         WHEN SQLWARN0 NOT = SPACES                               04460002
044700         WHEN SQLCODE < ZERO                                      04470002
044800         WHEN SQLCODE > ZERO                                      04480002
044900             DISPLAY '               '                            04490002
045000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        04500002
045100                                                                  04510002
045200             MOVE 'C600-DELETE-XFER-TTFITPS' TO PV-PARAGRAPH-NAME 04520002
045300             MOVE 'DELETE ROW FROM TTFITPS'  TO PV-DB2-OPERATION  04530002
045400                                                                  04540002
045500             PERFORM Z200-SQL-ABEND                               04550002
045600     END-EVALUATE.                                                04560002
045700                                                                  04570002
045800                                                                  04580002
045900***************************************************************** 04590002
046000* DELETE FROM TTFRCPT                                             04600002
046100***************************************************************** 04610002
046200 C700-DELETE-XFER-TTFRCPT.                                        04620002
046300                                                                  04630002
046400     EXEC SQL                                                     04640002
046500         DELETE  FROM TTFRCPT                                     04650002
046600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          04660002
046700     END-EXEC.                                                    04670002
046800                                                                  04680002
046900     EVALUATE TRUE                                                04690002
047000         WHEN SQLCODE = ZERO                                      04700002
047100             ADD 1 TO PA-DEL-RCPT-CNT                             04710002
047200                                                                  04720002
047300         WHEN SQLCODE = +100                                      04730002
047400             CONTINUE                                             04740002
047500                                                                  04750002
047600         WHEN SQLWARN0 NOT = SPACES                               04760002
047700         WHEN SQLCODE < ZERO                                      04770002
047800         WHEN SQLCODE > ZERO                                      04780002
047900             DISPLAY '               '                            04790002
048000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        04800002
048100                                                                  04810002
048200             MOVE 'C700-DELETE-XFER-TTFRCPT' TO PV-PARAGRAPH-NAME 04820002
048300             MOVE 'DELETE ROW FROM TTFRCPT'  TO PV-DB2-OPERATION  04830002
048400                                                                  04840002
048500             PERFORM Z200-SQL-ABEND                               04850002
048600     END-EVALUATE.                                                04860002
048700                                                                  04870002
048800                                                                  04880002
048900***************************************************************** 04890002
049000* DELETE FROM TTFDSCP                                             04900002
049100***************************************************************** 04910002
049200 C800-DELETE-XFER-TTFDSCP.                                        04920002
049300                                                                  04930002
049400     EXEC SQL                                                     04940002
049500         DELETE  FROM TTFDSCP                                     04950002
049600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          04960002
049700     END-EXEC.                                                    04970002
049800                                                                  04980002
049900     EVALUATE TRUE                                                04990002
050000         WHEN SQLCODE = ZERO                                      05000002
050100             ADD 1 TO PA-DEL-DSCP-CNT                             05010002
050200                                                                  05020002
050300         WHEN SQLCODE = +100                                      05030002
050400             CONTINUE                                             05040002
050500                                                                  05050002
050600         WHEN SQLWARN0 NOT = SPACES                               05060002
050700         WHEN SQLCODE < ZERO                                      05070002
050800         WHEN SQLCODE > ZERO                                      05080002
050900             DISPLAY '               '                            05090002
051000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        05100002
051100                                                                  05110002
051200             MOVE 'C800-DELETE-XFER-TTFDSCP' TO PV-PARAGRAPH-NAME 05120002
051300             MOVE 'DELETE ROW FROM TTFDSCP'  TO PV-DB2-OPERATION  05130002
051400                                                                  05140002
051500             PERFORM Z200-SQL-ABEND                               05150002
051600     END-EVALUATE.                                                05160002
051700                                                                  05170002
051800                                                                  05180002
051900***************************************************************** 05190002
052000* DELETE FROM TTFITRC                                             05200002
052100***************************************************************** 05210002
052200 C900-DELETE-XFER-TTFITRC.                                        05220002
052300                                                                  05230002
052400     EXEC SQL                                                     05240002
052500         DELETE  FROM TTFITRC                                     05250002
052600          WHERE  (XFER_DKEY_ID  =  :TFMSTR-XFER-DKEY-ID)          05260002
052700     END-EXEC.                                                    05270002
052800                                                                  05280002
052900     EVALUATE TRUE                                                05290002
053000         WHEN SQLCODE = ZERO                                      05300002
053100             ADD 1 TO PA-DEL-ITRC-CNT                             05310002
053200                                                                  05320002
053300         WHEN SQLCODE = +100                                      05330002
053400             CONTINUE                                             05340002
053500                                                                  05350002
053600         WHEN SQLWARN0 NOT = SPACES                               05360002
053700         WHEN SQLCODE < ZERO                                      05370002
053800         WHEN SQLCODE > ZERO                                      05380002
053900             DISPLAY '               '                            05390002
054000             DISPLAY 'XFER-DKEY-ID = ' TFMSTR-XFER-DKEY-ID        05400002
054100                                                                  05410002
054200             MOVE 'C900-DELETE-XFER-TTFITRC' TO PV-PARAGRAPH-NAME 05420002
054300             MOVE 'DELETE ROW FROM TTFITRC'  TO PV-DB2-OPERATION  05430002
054400                                                                  05440002
054500             PERFORM Z200-SQL-ABEND                               05450002
054600     END-EVALUATE.                                                05460002
054700                                                                  05470002
054800                                                                  05480002
054900******************************************************************05490002
055000* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      05500002
055100* PRESENTATION MODULE                                             05510002
055200******************************************************************05520002
055300 X100-BUILD-COMM-AREA-TRAN-PRES.                                  05530002
055400                                                                  05540002
055500     MOVE LENGTH OF                                               05550002
055600          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          05560002
055700     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  05570002
055800     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 05580002
055900                                                                  05590002
056000     PERFORM X200-CALL-TRANS-PRES-MODULE.                         05600002
056100                                                                  05610002
056200     MOVE DP001-TRANS-RECORD  TO TF059-KEY-REC.                   05620002
056300                                                                  05630002
056400     IF  DP001-CKPT-TAKEN                                         05640002
056500         ADD 1 TO PA-CKPT                                         05650002
056600     END-IF.                                                      05660002
056700                                                                  05670002
056800                                                                  05680002
056900******************************************************************05690002
057000* VERIFY THE RETURN CODE ON THE CALLED MODULE                     05700002
057100******************************************************************05710002
057200 X200-CALL-TRANS-PRES-MODULE.                                     05720002
057300                                                                  05730002
057400     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         05740002
057500                                                                  05750002
057600     IF  DP001-GOOD-RET-CODE                                      05760002
057700     OR  DP001-CKPT-TAKEN                                         05770002
057800     OR  DP001-RESTART                                            05780002
057900         CONTINUE                                                 05790002
058000                                                                  05800002
058100     ELSE                                                         05810002
058200         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  05820002
058300         MOVE '** BAD CALL TO TRANS PREP MODULE **'               05830002
058400                                            TO PV-OPERATION-MSG   05840002
058500         MOVE DP001-RET-CODE                TO PV-RET-CODE        05850002
058600                                                                  05860002
058700         SET ABEND-4444-FORCED-ABEND TO TRUE                      05870002
058800                                                                  05880002
058900         PERFORM Z100-ABEND                                       05890002
059000     END-IF.                                                      05900002
059100                                                                  05910002
059200                                                                  05920002
059300******************************************************************05930002
059400* NON-DB2 ABEND                                                   05940002
059500******************************************************************05950002
059600 Z100-ABEND.                                                      05960002
059700                                                                  05970002
059800     PERFORM Z999-CONTROLS.                                       05980002
059900                                                                  05990002
060000     DISPLAY '                     '.                             06000002
060100     DISPLAY '** ABEND           **'.                             06010002
060200     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          06020002
060300     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        06030002
060400     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         06040002
060500     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              06050002
060600                                                                  06060002
060700     CALL 'ILBOABN0' USING ABEND-CODE.                            06070002
060800                                                                  06080002
060900                                                                  06090002
061000******************************************************************06100002
061100* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      06110002
061200* CODE OCCURS.                                                    06120002
061300******************************************************************06130002
061400 Z200-SQL-ABEND.                                                  06140002
061500                                                                  06150002
061600     PERFORM Z999-CONTROLS.                                       06160002
061700                                                                  06170002
061800     DISPLAY '** ABEND     **'.                                   06180002
061900     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06190002
062000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06200002
062100     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06210002
062200                                                                  06220002
062300******************************************************************06230002
062400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06240002
062500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06250002
062600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06260002
062700* FORMAT.                                                         06270002
062800******************************************************************06280002
062900     COPY DPPD004.                                                06290002
063000                                                                  06300002
063100     SET ABEND-4013-DB2-ERROR TO TRUE.                            06310002
063200                                                                  06320002
063300     CALL 'ILBOABN0' USING ABEND-CODE.                            06330002
063400                                                                  06340002
063500                                                                  06350002
063600******************************************************************06360002
063700* PREFORMS TASK TERMINATION PROCESSING                            06370002
063800******************************************************************06380002
063900 Z990-EOJ-ROUTINE.                                                06390002
064000                                                                  06400002
064100     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             06410002
064200                                                                  06420002
064300     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      06430002
064400                                                                  06440002
064500     PERFORM Z999-CONTROLS.                                       06450002
064600                                                                  06460002
064700                                                                  06470002
064800******************************************************************06480002
064900* DISPLAY CONTROLS FROM THE PROGRAM                               06490002
065000******************************************************************06500002
065100 Z999-CONTROLS.                                                   06510002
065200                                                                  06520002
065300     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 06530002
065400                                                                  06540002
065500     MOVE SYS-TIME (1:2) TO ST-END-HR.                            06550002
065600     MOVE SYS-TIME (3:2) TO ST-END-MN.                            06560002
065700                                                                  06570002
065800     DISPLAY '                    '.                              06580002
065900     DISPLAY '**********************'.                            06590002
066000     DISPLAY '   TFKUP509 CONTROLS  '.                            06600002
066100     DISPLAY '**********************'.                            06610002
066200     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         06620002
066300     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          06630002
066400     DISPLAY 'END TIME  = ' ST-END-TIME.                          06640002
066500     DISPLAY '======================'.                            06650002
066600     DISPLAY 'RECORDS READ   = ' PA-READ.                         06660002
066700     DISPLAY 'CHECKPOINTS    = ' PA-CKPT.                         06670002
066800     DISPLAY '               '.                                   06680002
066900     DISPLAY 'DEL-MSTR-CNT = ' PA-DEL-MSTR-CNT.                   06690002
067000     DISPLAY 'DEL-ITEM-CNT = ' PA-DEL-ITEM-CNT.                   06700002
067100     DISPLAY 'DEL-CUST-CNT = ' PA-DEL-CUST-CNT.                   06710002
067200     DISPLAY 'DEL-STAT-CNT = ' PA-DEL-STAT-CNT.                   06720002
067300     DISPLAY 'DEL-ITPS-CNT = ' PA-DEL-ITPS-CNT.                   06730002
067400     DISPLAY 'DEL-RCPT-CNT = ' PA-DEL-RCPT-CNT.                   06740002
067500     DISPLAY 'DEL-DSCP-CNT = ' PA-DEL-DSCP-CNT.                   06750002
067600     DISPLAY 'DEL-ITRC-CNT = ' PA-DEL-ITRC-CNT.                   06760002
067700     DISPLAY '               '.                                   06770002
067800                                                                  06780002
067900******************************************************************06790002
068000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06800002
068100* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  06810002
068200* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         06820002
068300******************************************************************06830002
068400     COPY DPPD001.                                                06840002
068500                                                                  06850002
068600                                                                  06860002
