                                                                        00010000
           EXEC CICS LINK                                               00020000
               PROGRAM  ('DPKCS277')                                    00030000
               COMMAREA (DP277-COMMAREA)                                00040000
               RESP     (PV-CICS-RESP)                                  00050000
           END-EXEC.                                                    00060000
                                                                        00070000
      *  CHECK CICS RETURN CODE                                         00080000
           IF PV-CICS-RESP = DFHRESP(NORMAL)                            00090000
               CONTINUE                                                 00100000
           ELSE                                                         00110000
               SET DP013-CICS-ABEND                                     00120000
                   DP013-NO-ROLLBACK   TO TRUE                          00130000
               MOVE '4200-CALC-OPEN-TO-REC'                             00140000
                                       TO DP013-PARAGRAPH               00150000
               MOVE 'ATTEMPTING TO LINK TO PROGRAM DPKCS276'            00160000
                                       TO DP013-MESSAGE-TEXT (1)        00170000
               PERFORM DP013-0000-PROCESS-ABEND                         00180000
           END-IF.                                                      00190000
                                                                        00200000
      *  CHECK DP277-RETURN-CODE                                        00210000
           EVALUATE TRUE                                                00220000
           WHEN DP277-RETURN-CODE = ZERO                                00230000
               CONTINUE                                                 00240000
           WHEN OTHER                                                   00250000
               EVALUATE TRUE                                            00260000
               WHEN DP277-SOFT-ABORT                                    00270000
                   PERFORM 4220-ROLLBACK                                00280000
               WHEN DP277-NO-DISTRO                                     00290000
                   CONTINUE                                             00300000
               WHEN OTHER                                               00310000
                   MOVE DP277-SEVERITY-IND                              00320000
                                       TO DP020-MSG-SEVERITY-IND        00330000
                   MOVE +1096          TO DP020-MSG-NUMBER              00340000
               END-EVALUATE                                             00350000
           END-EVALUATE.                                                00360000
                                                                        00370000
       4210-SEARCH-OTR.                                                 00380000
           IF DP277-LINE-LEVEL-OTR                                      00381000
               SET DP277-LNE-IDX TO 1                                   00390000
               SEARCH DP277-LNE-WORK-AREA                               00400000
               AT END                                                   00410000
                   CONTINUE                                             00420000
               WHEN DP277-LNE-NBR (DP277-LNE-IDX) = ZERO                00430000
      *  LINE NUMBER IS ZERO WHEN THERE IS NO STORE DISTRIBUTION        00440000
                   MOVE ALL '*'            TO DP277-OTR-OUT-X           00460000
                                              DP277-ORDER-QTY-X         00470000
               WHEN DP277-LNE-NBR (DP277-LNE-IDX) = DP277-SEARCH-NBR    00480000
      *  PROCESS OTR UNITS                                              00490000
                   MOVE DP277-LNE-OTR-QTY (DP277-LNE-IDX)               00500000
                                           TO DP277-OTR-OUT             00510000
                   MOVE DP277-LNE-DISTRO-OTR (DP277-LNE-IDX)            00511002
                                           TO DP277-DISTRO-OTR-OUT      00512002
                   ADD  DP277-LNE-OTR-QTY (DP277-LNE-IDX)               00520000
                                           TO DP277-TOTAL-OTR           00530000
                   ADD  DP277-LNE-DISTRO-OTR (DP277-LNE-IDX)            00531002
                                           TO DP277-TOTAL-DISTRO-OTR    00532002
      *  PROCESS OTR PACK QUANTITY                                      00540000
                   MOVE DP277-LNE-OTR-PK  (DP277-LNE-IDX)               00550000
                                           TO DP277-PK-OTR-OUT          00560000
                   ADD  DP277-LNE-OTR-PK  (DP277-LNE-IDX)               00570000
                                           TO DP277-TOTAL-PK-OTR        00580000
                   MOVE DP277-LNE-OTR-QTY-X (DP277-LNE-IDX)             00590000
                                           TO DP277-OTR-OUT-X           00591000
      *  PROCESS STORE DISTRO UNITS                                     00592000
                   MOVE DP277-LNE-DISTRO-QTY (DP277-LNE-IDX)            00593001
                                           TO DP277-ORDER-QTY           00594000
                   MOVE DP277-LNE-DISTRO-QTY-X (DP277-LNE-IDX)          00595000
                                           TO DP277-ORDER-QTY-X         00596000
      *  PROCESS STORE DISTRO PACK QUANTITY                             00597000
                   MOVE DP277-LNE-DISTRO-PK  (DP277-LNE-IDX)            00598000
                                           TO DP277-ORDER-PK-QTY        00599000
               END-SEARCH                                               00600000
           END-IF.                                                      00610000
           IF DP277-STORE-LEVEL-OTR                                     00611000
               SET DP277-STR-IDX TO 1                                   00612000
               SEARCH DP277-STR-WORK-AREA                               00613000
               AT END                                                   00614000
                   CONTINUE                                             00615000
               WHEN DP277-STORE-NBR (DP277-STR-IDX) = ZERO              00616000
      *  STORE NUMBER IS ZERO WHEN THERE IS NO STORE DISTRIBUTION       00617000
                   MOVE ALL '*'            TO DP277-OTR-OUT-X           00618000
                                              DP277-ORDER-QTY-X         00619000
               WHEN DP277-STORE-NBR (DP277-STR-IDX) = DP277-SEARCH-NBR  00619100
      *  PROCESS OTR UNITS                                              00619200
                   MOVE DP277-STR-OTR-QTY (DP277-STR-IDX)               00619300
                                           TO DP277-OTR-OUT             00619400
                   MOVE DP277-STR-DISTRO-OTR (DP277-STR-IDX)            00619502
                                           TO DP277-DISTRO-OTR-OUT      00619602
                   ADD  DP277-STR-OTR-QTY (DP277-STR-IDX)               00619700
                                           TO DP277-TOTAL-OTR           00619800
                   ADD  DP277-STR-DISTRO-OTR (DP277-STR-IDX)            00619902
                                           TO DP277-TOTAL-DISTRO-OTR    00620002
      *  PROCESS OTR PACK QUANTITY                                      00620100
                   MOVE DP277-STR-OTR-PK  (DP277-STR-IDX)               00620200
                                           TO DP277-PK-OTR-OUT          00620300
                   ADD  DP277-STR-OTR-PK  (DP277-STR-IDX)               00620400
                                           TO DP277-TOTAL-PK-OTR        00620500
                   MOVE DP277-STR-OTR-QTY-X (DP277-STR-IDX)             00620600
                                           TO DP277-OTR-OUT-X           00620700
      *  PROCESS STORE DISTRO UNITS                                     00620800
                   MOVE DP277-STR-DISTRO-QTY (DP277-STR-IDX)            00620900
                                           TO DP277-ORDER-QTY           00621000
                   MOVE DP277-STR-DISTRO-QTY-X (DP277-STR-IDX)          00621100
                                           TO DP277-ORDER-QTY-X         00621200
      *  PROCESS STORE DISTRO PACK QUANTITY                             00621300
                   MOVE DP277-STR-DISTRO-PK  (DP277-STR-IDX)            00621400
                                           TO DP277-ORDER-PK-QTY        00621500
               END-SEARCH                                               00621600
           END-IF.                                                      00621700
       4220-ROLLBACK.                                                   00622000
                                                                        00630000
           MOVE DP277-SEVERITY-IND     TO DP020-MSG-SEVERITY-IND        00640000
           MOVE +551                   TO DP020-MSG-NUMBER              00650000
                                                                        00660000
           EXEC CICS                                                    00670000
               SYNCPOINT ROLLBACK                                       00680000
           END-EXEC.                                                    00690000
                                                                        00700000
