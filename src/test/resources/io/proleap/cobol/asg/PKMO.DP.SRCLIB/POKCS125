000100*-----------------------*                                         00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300*-----------------------*                                         00030001
000400 PROGRAM-ID.    POKCS125.                                         00040001
000500 AUTHOR.        DIANE DARR.                                       00050001
000600 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00060001
000700 DATE-WRITTEN.  08-31-00.                                         00070001
000800 DATE-COMPILED.                                                   00080001
000900                                                                  00090001
001000*---------------------------------------------------------------* 00100001
001100*    W125 - ADDITIONAL PO FUNCTION MENU PROGRAM                 * 00110001
001200*                                                               * 00120001
001300*    THIS PROGRAM DISPLAYS A MENU. IT ALLOWS THE USER TO        * 00130001
001400*    TRANSFER CONTROL TO ONE OF TWO DIFFERENT SCREENS.          * 00140001
001500*                                                               * 00150001
001800*---------------------------------------------------------------* 00180001
C98147*   CHG0098147 -      11/12/14 - SUE BARTELT - TKMA537           *00181006
C98147*   EXPANDED PO NUMBER TO 8 DIGITS.                              *00182006
C98147*----------------------------------------------------------------*00183006
CICS  *  CHANGED 11/17/2022    BY BARB SCHULTZ    WR: CHG0278485       *00184011
CICS  *                                                                *00185009
CICS  *  ADDED COPYBOOK DPWS930 AND MADE THE CICS ARCHITECTURE CALL    *00186009
CICS  *  DYNAMIC INSTEAD OF STATIC BY CALLING DP930-CICS-ARCH-API.     *00187009
CICS  *----------------------------------------------------------------*00187109
001900 ENVIRONMENT DIVISION.                                            00190001
002000 DATA DIVISION.                                                   00200001
002100 WORKING-STORAGE SECTION.                                         00210001
002200*                                                                 00220001
002300 01  PC-PROGRAM-CONSTANTS.                                        00230001
002400     05  PC-CURRENT-MAP-NAME       PIC  X(08)  VALUE  'PO125A  '. 00240002
002500     05  PC-CURRENT-MAPSET-NAME    PIC  X(08)  VALUE  'POKM125 '. 00250003
002600     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08)  VALUE  'POKCS125'. 00260003
002700     05  PC-TSYMSG-NUMBERS.                                       00270001
002800         10  PC-TSYMSG-00008       PIC  9(05)  VALUE  00008.      00280001
002900         10  PC-TSYMSG-00083       PIC  9(05)  VALUE  00083.      00290001
003000         10  PC-TSYMSG-00984       PIC  9(05)  VALUE  00984.      00300001
003100         10  PC-TSYMSG-00148       PIC  9(05)  VALUE  00148.      00310001
003200         10  PC-TSYMSG-00069       PIC  9(05)  VALUE  00069.      00320001
003300         10  PC-TSYMSG-00070       PIC  9(05)  VALUE  00070.      00330001
003400         10  PC-TSYMSG-01189       PIC  9(05)  VALUE  01189.      00340001
003500     05  PC-INTER-APPL-CODES.                                     00350001
003600         10  PC-INTER-APPL-CRIT       PIC X(01)  VALUE ' '.       00360001
003700         10  PC-INTER-APPL-LIST       PIC X(01)  VALUE '1'.       00370001
003800     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +3        00380001
003900                                                 COMP.            00390001
004000*                                                                 00400001
004100 01  PS-PROGRAM-SWITCHES.                                         00410001
004200     05  PS-ERROR-SW               PIC  X(01)  VALUE  'N'.        00420001
004300         88  PS-ERROR                          VALUE  'Y'.        00430001
004400         88  PS-NO-ERROR                       VALUE  'N'.        00440001
004500     05  PS-COMMAREA-SW            PIC  X(01)  VALUE  'N'.        00450001
004600         88  PS-COMMAREA-VALID                 VALUE  'Y'.        00460001
004700         88  PS-COMMAREA-NOT-VALID             VALUE  'N'.        00470001
004800     05  PS-LIST-END-SW            PIC X(01)   VALUE  'N'.        00480001
004900         88  PS-LIST-END                       VALUE  'Y'.        00490001
005000         88  PS-NO-LIST-END                    VALUE  'N'.        00500001
005100                                                                  00510001
005200 01  PV-PROGRAM-VARIABLES.                                        00520001
005300     05  PV-DB2-COUNT              PIC S9(09)  VALUE +0           00530001
005400                                               COMP-3.            00540001
C98147     05  PV-PO-NUMBER              PIC 9(08)   VALUE ZERO.        00550005
005600                                                                  00560001
005700     05  PV-CICS-RESPONSE          PIC S9(04) VALUE +0            00570001
005800                                               COMP SYNC.         00580001
005900     05  PV-RETRY-COUNTER          PIC S9(04) VALUE +0            00590001
006000                                               COMP SYNC.         00600001
006100*----------------------------------------------------------------*00610001
006200*    MAP LAYOUT                                                  *00620001
006300*----------------------------------------------------------------*00630001
006400     COPY POKM125.                                                00640003
006500     EJECT                                                        00650001
006600*----------------------------------------------------------------*00660001
006700*    ATTRIBUTE SETTINGS COPYBOOK.                                *00670001
006800*----------------------------------------------------------------*00680001
006900     COPY DPWS015.                                                00690001
007000 EJECT                                                            00700001
007100*----------------------------------------------------------------*00710001
007200*    FUNCTION KEYS COPYBOOK                                      *00720001
007300*----------------------------------------------------------------*00730001
007400     COPY DPWS016.                                                00740001
007500 EJECT                                                            00750001
007600*----------------------------------------------------------------*00760001
007700*    THE LAYOUT FOR THE TEMPORARY STORAGE QUEUE CONTAINING       *00770001
007800*    SELECTED LIST ITEMS TO BE PROCESSED BY THIS PROGRAM.        *00780001
007900*----------------------------------------------------------------*00790001
008000     COPY POWS012.                                                00800001
008100 EJECT                                                            00810001
008200******************************************************************00820001
008300** THE CALLING PARAMETER LIST (DPWS010) FOR THE NUMERIC EDIT    **00830001
008400** SUB-ROUTINE (DPKUT100).                                      **00840001
008500******************************************************************00850001
008600     COPY DPWS010I.                                               00860001
008700 EJECT                                                            00870001
008800******************************************************************00880001
CICS  *    PARAMETERS FOR CALLING THE CICS ARCHITECTURE API.          **00890010
009100******************************************************************00910001
009200     COPY DPWS030.                                                00920001
CICS       COPY DPWS930.                                                00921010
009300 EJECT                                                            00930001
009400***************************************************************** 00940001
009500*    STANDARD COMMAREA.                                           00950001
009600***************************************************************** 00960001
009700                                                                  00970001
009800     COPY DPWS020.                                                00980001
009900     05  FILLER REDEFINES DP020-VARIABLE-COMMAREA.                00990001
010000                                                                  01000001
010100***************************************************************** 01010001
010200*    INTER-APPLICATION COMMAREA.                                  01020001
010300***************************************************************** 01030001
010400                                                                  01040001
010500         10  INTER-APPL-COMM-AREA PIC X(200).                     01050001
010600     COPY POWS017.                                                01060001
           COPY POWS011.                                                01061004
010700     COPY POWS013.                                                01070001
010800     COPY APWS300.                                                01080001
010900     COPY VLWS005.                                                01090001
011000***************************************************************** 01100001
011100*    SPECIFIC COMMMAREA FOR POKCS125.                             01110003
011200***************************************************************** 01120001
011300         10  ASC-SPECIFIC-COMMAREA.                               01130001
011400             15  ASC-USE-SELECTION-QUEUE-IND                      01140001
011500                                           PIC X(01).             01150001
011600                 88  ASC-USE-SELECTION-QUEUE    VALUE 'Y'.        01160001
011700             15  ASC-SEL-QUEUE-NAME        PIC X(08).             01170001
011800             15  ASC-NUMBER-OF-TS-ITEMS    PIC S9(05) COMP-3.     01180001
011900             15  ASC-NUMBER-OF-SELECTED-ITEMS                     01190001
012000                                           PIC S9(09) COMP-3.     01200001
012100             15  ASC-SEL-SUB               PIC S9(04) COMP.       01210001
012200             15  ASC-SEL-ITEM              PIC S9(04) COMP.       01220001
012300             15  ASC-PO-NBR                PIC  S9(9) COMP.       01230001
012400             15  ASC-VDR-NAME              PIC  X(30).            01240001
012500             15  ASC-DEPT-NBR              PIC  X(03).            01250001
012600             15  ASC-PREV-SCREEN           PIC  X(01).            01260001
012700                 88 ASC-LIST               VALUE 'Y'.             01270001
012800                 88 ASC-CRIT               VALUE 'N'.             01280001
012900 EJECT                                                            01290001
013000*----------------------------------------------------------------*01300001
013100*    ABEND PROCESSING COPYBOOK.                                  *01310001
013200*----------------------------------------------------------------*01320001
013300     COPY DPWS013.                                                01330001
013400                                                                  01340001
013500*---------------------------------------------------------------* 01350001
013600*    DB2 AREA FOR TPURCHS TABLE                                 * 01360001
013700*---------------------------------------------------------------* 01370001
013800     EXEC SQL                                                     01380001
013900          INCLUDE TPURCHS                                         01390001
014000     END-EXEC.                                                    01400001
014100*---------------------------------------------------------------* 01410001
014200*    DB2 AREA FOR TENTNME TABLE                                 * 01420001
014300*---------------------------------------------------------------* 01430001
014400     EXEC SQL                                                     01440001
014500          INCLUDE TENTNME                                         01450001
014600     END-EXEC.                                                    01460001
014700*---------------------------------------------------------------* 01470001
014800*    DB2 AREA FOR TPORESV TABLE                                 * 01480001
014900*---------------------------------------------------------------* 01490001
015000*    EXEC SQL                                                     01500007
015100*         INCLUDE TPORESV                                         01510007
015200*    END-EXEC.                                                    01520007
015300*---------------------------------------------------------------* 01530001
015400*    DB2 AREA FOR COMMUNICATIONS                                * 01540001
015500*---------------------------------------------------------------* 01550001
015600     EXEC SQL                                                     01560001
015700          INCLUDE SQLCA                                           01570001
015800     END-EXEC.                                                    01580001
015900*---------------------------------------------------------------* 01590001
016000 EJECT                                                            01600001
016100 LINKAGE SECTION.                                                 01610001
016200                                                                  01620001
016300 01  DFHCOMMAREA.                                                 01630001
016400     05  FILLER                         OCCURS  1 TO 4072 TIMES   01640001
016500                                        DEPENDING ON EIBCALEN.    01650001
016600         10  FILLER                     PIC X.                    01660001
016700                                                                  01670001
016800 PROCEDURE DIVISION.                                              01680001
016900***************************************************************** 01690001
017000** THIS MODULE CONTROLS THE OVERALL PROCESSING IN THE PROGRAM. ** 01700001
017100** THE SETUP AND PERFORM OF PARAGRAPH 9000-CALL-CICS-ARCH-API  ** 01710001
017200** MUST BE THE FIRST CODE EXECUTED IN THIS PROGRAM.            ** 01720001
017300**                                                             ** 01730001
017400** THE SECOND OR 'EXIT' PERFORM OF THIS PARAGRAPH MUST BE THE  ** 01740001
017500** LAST CODE EXECUTED ON EACH ITERATION OF THIS PROGRAM.       ** 01750001
017600***************************************************************** 01760001
017700 0000-MAIN-MODULE.                                                01770001
017800     INITIALIZE DP030-CICS-API-FIELDS.                            01780001
017900     MOVE +1                       TO DP030-NUMBER-OF-MAPS.       01790001
018000     MOVE PC-CURRENT-MAPSET-NAME   TO DP030-MAPSET-NAME.          01800001
018100     MOVE PC-CURRENT-MAP-NAME      TO DP030-MAP-NAME (1).         01810001
018200     SET DP030-RECEIVE-APPL-MAP    TO TRUE.                       01820001
018300     MOVE LENGTH OF PO125AI        TO DP030-MAP-LENGTH (1).       01830002
018400     MOVE 'PROGRAM ENTRY CALL'     TO DP013-MESSAGE-TEXT (1).     01840001
018500     PERFORM 9000-CALL-CICS-ARCH-API.                             01850001
018600                                                                  01860001
018700     PERFORM 1000-CONTROL-PROCESSING                              01870001
018800                                                                  01880001
018900     MOVE 'PROGRAM EXIT CALL'      TO DP013-MESSAGE-TEXT (1).     01890001
019000     PERFORM 9000-CALL-CICS-ARCH-API.                             01900001
019100*----------------------------------------------------------------*01910001
019200*    PROCESS THE APPROPRIATE PARAGRAPHS BASED ON WHAT THE NEXT   *01920001
019300*    COURSE OF ACTION IS FOR THIS TRANSACTION.                   *01930001
019400*----------------------------------------------------------------*01940001
019500 1000-CONTROL-PROCESSING.                                         01950001
019600                                                                  01960001
019700     EVALUATE TRUE                                                01970001
019800         WHEN DP020-NEXT-ACT-INITIAL                              01980001
019900             INITIALIZE ASC-SPECIFIC-COMMAREA                     01990001
020000             PERFORM 1100-PROCESS-INTER-APPL-COMM                 02000001
020100             IF  PS-COMMAREA-VALID                                02010001
020200                 PERFORM 4000-BUILD-INITIAL-PANEL                 02020001
020300             END-IF                                               02030001
020400                                                                  02040001
020500         WHEN DP020-NEXT-ACT-READ-MAP                             02050001
020600             PERFORM 2000-FKEY-PROCESSING                         02060001
020700                                                                  02070001
020800         WHEN DP020-NEXT-ACT-RETURN                               02080001
020900             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 02090001
021000                                                                  02100001
021100         WHEN OTHER                                               02110001
021200             SET DP013-LOGIC-ABEND                                02120001
021300                 DP013-NO-ROLLBACK TO TRUE                        02130001
021400             MOVE '1000-CONTROL-PROCESSING'                       02140001
021500                                   TO  DP013-PARAGRAPH            02150001
021600             MOVE 'INVALID NEXT ACTIVITY RETURNED TO APPL PGM:'   02160001
021700                                   TO  DP013-MESSAGE-TEXT(1)      02170001
021800             MOVE DP020-NEXT-APPL-ACTIVITY                        02180001
021900                                   TO DP013-MESSAGE-TEXT(2)       02190001
022000             PERFORM DP013-0000-PROCESS-ABEND                     02200001
022100     END-EVALUATE.                                                02210001
022200*----------------------------------------------------------------*02220001
022300*    VERIFY PO NUMBER IS VALID, PROCESS INTER-APPL-LIST          *02230001
022400*----------------------------------------------------------------*02240001
022500 1100-PROCESS-INTER-APPL-COMM.                                    02250001
022600                                                                  02260001
022700     EVALUATE DP020-INT-APPL-FORMAT-IND                           02270001
022800                                                                  02280001
022900         WHEN PC-INTER-APPL-CRIT                                  02290001
023000             SET ASC-CRIT        TO TRUE                          02300001
023100             PERFORM 1200-SELECT-TPURCHS                          02310001
023200                                                                  02320001
023300             IF PV-DB2-COUNT > 0                                  02330001
023400                SET PS-COMMAREA-VALID     TO TRUE                 02340001
023500             ELSE                                                 02350001
024700                MOVE PC-TSYMSG-00083 TO DP020-MSG-NUMBER          02351008
024800                SET PS-ERROR                                      02352008
024900                    PS-COMMAREA-NOT-VALID                         02353008
025000                    DP020-NEXT-ACT-APPL-ERROR                     02354008
025100                    DP020-MSG-FATAL                               02355008
025200                                 TO TRUE                          02356008
025400             END-IF                                               02358008
023600*                PERFORM 1250-CHECK-TPORESV                       02360007
023700*                IF  SQLCODE = +0                                 02370007
023800*                    MOVE PORESV-DEPT-NBR TO DP020-MSG-TEXT       02380007
023900*                    MOVE PC-TSYMSG-01189                         02390007
024000*                                TO DP020-MSG-NUMBER              02400007
024100*                    SET PS-ERROR                                 02410007
024200*                        PS-COMMAREA-NOT-VALID                    02420007
024300*                        DP020-NEXT-ACT-APPL-ERROR                02430007
024400*                        DP020-MSG-FATAL                          02440007
024500*                                TO TRUE                          02450007
024600*                ELSE                                             02460007
024700*                    MOVE PC-TSYMSG-00083 TO DP020-MSG-NUMBER     02470008
024800*                    SET PS-ERROR                                 02480008
024900*                        PS-COMMAREA-NOT-VALID                    02490008
025000*                        DP020-NEXT-ACT-APPL-ERROR                02500008
025100*                        DP020-MSG-FATAL                          02510008
025200*                                TO TRUE                          02520008
025300*                END-IF                                           02530007
025400*            END-IF                                               02540008
025500         WHEN PC-INTER-APPL-LIST                                  02550001
025600             SET PS-COMMAREA-VALID         TO TRUE                02560001
025700             SET ASC-USE-SELECTION-QUEUE                          02570001
025800                                 TO TRUE                          02580001
025900             SET ASC-LIST        TO TRUE                          02590001
026000             MOVE PO013-NUMBER-OF-SELECTED-ITEMS                  02600001
026100                                 TO ASC-NUMBER-OF-SELECTED-ITEMS  02610001
026200             MOVE PO013-NUMBER-OF-TS-ITEMS                        02620001
026300                                 TO ASC-NUMBER-OF-TS-ITEMS        02630001
026400             MOVE PO013-SEL-QUEUE-NAME                            02640001
026500                                 TO ASC-SEL-QUEUE-NAME            02650001
026600             PERFORM 1120-PREPARE-LIST-ENTRY                      02660001
026700                                                                  02670001
026800         WHEN OTHER                                               02680001
026900             MOVE PC-TSYMSG-00148 TO DP020-MSG-NUMBER             02690001
027000             SET PS-ERROR                                         02700001
027100                 PS-COMMAREA-NOT-VALID                            02710001
027200                 DP020-MSG-FATAL                                  02720001
027300                 DP020-NEXT-ACT-APPL-ERROR                        02730001
027400                                 TO TRUE                          02740001
027500     END-EVALUATE.                                                02750001
027600*----------------------------------------------------------------*02760001
027700*    ENTRY IS FROM A LIST.  GET THE PO NUMBER FROM THE           *02770001
027800*    TEMP STORAGE QUEUE PASSED FROM THE LIST.                    *02780001
027900*----------------------------------------------------------------*02790001
028000 1120-PREPARE-LIST-ENTRY.                                         02800001
028100                                                                  02810001
028200     MOVE PO012-MAX-ITEMS          TO ASC-SEL-SUB.                02820001
028300     MOVE ZERO                     TO ASC-SEL-ITEM.               02830001
028400     PERFORM 2115-GET-NEXT-PO.                                    02840001
028500*----------------------------------------------------------------*02850001
028600*    SELECT TPURCHS TABLE (VERIFY PO NUMBER IS VALID)            *02860001
028700*----------------------------------------------------------------*02870001
028800 1200-SELECT-TPURCHS.                                             02880001
028900                                                                  02890001
029000     MOVE PO017-PO-NBR TO ASC-PO-NBR.                             02900001
029100     MOVE ZEROES TO PV-DB2-COUNT.                                 02910001
029200                                                                  02920001
029300     EXEC SQL                                                     02930001
029400         SELECT COUNT(*)                                          02940001
029500         INTO :PV-DB2-COUNT                                       02950001
029600         FROM TPURCHS                                             02960001
029700         WHERE PO_NBR = :ASC-PO-NBR AND                           02970001
029800               VER_STATUS_CDE = 'A'                               02980001
029900     END-EXEC                                                     02990001
030000                                                                  03000001
030100     EVALUATE TRUE                                                03010001
030200         WHEN SQLCODE = +0                                        03020001
030300         WHEN SQLCODE = +100                                      03030001
030400              CONTINUE                                            03040001
030500         WHEN SQLCODE = -904                                      03050001
030600         WHEN SQLCODE = -911                                      03060001
030700         WHEN SQLCODE = -913                                      03070001
030800              MOVE PC-TSYMSG-00984      TO DP020-MSG-NUMBER       03080001
030900              SET PS-ERROR                                        03090001
031000                  DP020-NEXT-ACT-APPL-ERROR                       03100001
031100                  DP020-MSG-FATAL                                 03110001
031200                      TO TRUE                                     03120001
031300              MOVE 'PROGRAM EXIT CALL'  TO DP013-MESSAGE-TEXT (1) 03130001
031400              PERFORM 9000-CALL-CICS-ARCH-API                     03140001
031500                                                                  03150001
031600         WHEN SQLWARN0 NOT = SPACES                               03160001
031700         WHEN SQLCODE < +0                                        03170001
031800         WHEN SQLCODE > +0                                        03180001
031900              MOVE '1200-SELECT-TPURCHS'                          03190001
032000                              TO DP013-PARAGRAPH                  03200001
032100              MOVE 'UNSUCCESSFUL SELECT ON TPURCHS'               03210001
032200                              TO DP013-MESSAGE-TEXT (1)           03220001
032300              MOVE SQLCA      TO DP013-SQLCA                      03230001
032400              MOVE 'TPURCHS ' TO DP013-DB2-TABLE-NAME (1)         03240001
032500              SET DP013-DB2-ABEND                                 03250001
032600                  DP013-XCTL-DISPLAY-RESTART                      03260001
032700                              TO TRUE                             03270001
032800              PERFORM DP013-0000-PROCESS-ABEND                    03280001
032900     END-EVALUATE.                                                03290001
033000                                                                  03300001
033100*----------------------------------------------------------------*03310001
033200*    CHECK TO SEE IF THE PO NUMBER EXISTS ON TPORESV             *03320001
033300*----------------------------------------------------------------*03330001
033400*1250-CHECK-TPORESV.                                              03340007
033500*                                                                 03350007
033600*    PERFORM                                                      03360007
033700*        WITH TEST AFTER                                          03370007
033800*        VARYING PV-RETRY-COUNTER                                 03380007
033900*        FROM 1 BY 1                                              03390007
034000*        UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               03400007
034100*            OR (SQLCODE = +0)                                    03410007
034200*            OR (SQLCODE = +100))                                 03420007
034300*                                                                 03430007
034400*        EXEC SQL                                                 03440007
034500*             SELECT DEPT_NBR                                     03450007
034600*               INTO :PORESV-DEPT-NBR                             03460007
034700*               FROM TPORESV                                      03470007
034800*              WHERE RSVD_PO_NBR    = :ASC-PO-NBR                 03480007
034900*        END-EXEC                                                 03490007
035000*                                                                 03500007
035100*        EVALUATE TRUE                                            03510007
035200*            WHEN SQLCODE = +0                                    03520007
035300*            WHEN SQLCODE = +100                                  03530007
035400*            WHEN SQLCODE = -904                                  03540007
035500*            WHEN SQLCODE = -913                                  03550007
035600*                 CONTINUE                                        03560007
035700*                                                                 03570007
035800*            WHEN SQLWARN0 NOT = SPACES                           03580007
035900*            WHEN SQLCODE < +0                                    03590007
036000*            WHEN SQLCODE > +0                                    03600007
036100*                 MOVE '1250-CHECK-TPORESV'                       03610007
036200*                                 TO DP013-PARAGRAPH              03620007
036300*                 MOVE 'UNSUCCESSFUL SELECT ON PO RESERVATION'    03630007
036400*                                 TO DP013-MESSAGE-TEXT (1)       03640007
036500*                 MOVE SQLCA      TO DP013-SQLCA                  03650007
036600*                 MOVE 'TPORESV ' TO DP013-DB2-TABLE-NAME (1)     03660007
036700*                 SET DP013-DB2-ABEND                             03670007
036800*                     DP013-XCTL-DISPLAY-RESTART                  03680007
036900*                                 TO TRUE                         03690007
037000*                 PERFORM DP013-0000-PROCESS-ABEND                03700007
037100*        END-EVALUATE                                             03710007
037200*    END-PERFORM.                                                 03720007
037300*                                                                 03730007
037400*    IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03740007
037500*        MOVE '1250-CHECK-TPORESV' TO DP013-PARAGRAPH             03750007
037600*        MOVE 'MAX RETRIES EXCEEDED ON SELECT FOR PO NBR'         03760007
037700*                                 TO DP013-MESSAGE-TEXT (1)       03770007
037800*        MOVE SQLCA               TO DP013-SQLCA                  03780007
037900*        MOVE 'TPORESV '          TO DP013-DB2-TABLE-NAME (1)     03790007
038000*        SET DP013-DB2-ABEND                                      03800007
038100*            DP013-XCTL-DISPLAY-RESTART                           03810007
038200*                                 TO TRUE                         03820007
038300*        PERFORM DP013-0000-PROCESS-ABEND                         03830007
038400*    END-IF.                                                      03840007
038500                                                                  03850001
038600*----------------------------------------------------------------*03860001
038700* FURTHER DETERMINE PROCESSING PATH BASED ON FUNCTION KEY ACTIONS*03870001
038800* SPECIFIC FUNCTION KEYS LISTED HERE ARE ACTED UPON REGARDLESS OF*03880001
038900* EDITS.                                                         *03890001
039000*----------------------------------------------------------------*03900001
039100 2000-FKEY-PROCESSING.                                            03910001
039200                                                                  03920001
039300     EVALUATE TRUE                                                03930001
039400                                                                  03940001
039500         WHEN DP020-SRC-AID = DP016-CLEAR                         03950001
039600             PERFORM 4400-MOVE-COMMAREA-TO-SCREEN                 03960001
039700                                                                  03970001
039800         WHEN DP020-FK-REFRESH(DP020-SRC-AID)                     03980001
039900             PERFORM 4000-BUILD-INITIAL-PANEL                     03990001
040000                                                                  04000001
040100         WHEN DP020-FK-NEXT-SELECTION (DP020-SRC-AID)             04010001
040200             IF  ASC-USE-SELECTION-QUEUE                          04020001
040300                 PERFORM 2115-GET-NEXT-PO                         04030001
040400                 IF PS-LIST-END                                   04040001
040500                    SET PS-NO-LIST-END                            04050001
040600                                   TO TRUE                        04060001
040700                 ELSE                                             04070001
040800                    PERFORM 4000-BUILD-INITIAL-PANEL              04080001
040900                 END-IF                                           04090001
041000             ELSE                                                 04100001
041100*                --- BOTTOM OF LIST ---                           04110001
041200                 MOVE PC-TSYMSG-00070                             04120001
041300                                   TO DP020-MSG-NUMBER            04130001
041400                 SET DP020-MSG-INFORMATIONAL                      04140001
041500                     PS-LIST-END   TO TRUE                        04150001
041600             END-IF                                               04160001
041700                                                                  04170001
041800         WHEN DP020-FK-PREV-SELECTION (DP020-SRC-AID)             04180001
041900             IF  ASC-USE-SELECTION-QUEUE                          04190001
042000                 PERFORM 2120-GET-PREV-PO                         04200001
042100                 IF PS-LIST-END                                   04210001
042200                    SET PS-NO-LIST-END                            04220001
042300                                   TO TRUE                        04230001
042400                 ELSE                                             04240001
042500                    PERFORM 4000-BUILD-INITIAL-PANEL              04250001
042600                 END-IF                                           04260001
042700             ELSE                                                 04270001
042800*                --- TOP OF LIST ---                              04280001
042900                 MOVE PC-TSYMSG-00069                             04290001
043000                                   TO DP020-MSG-NUMBER            04300001
043100                 SET DP020-MSG-INFORMATIONAL                      04310001
043200                     PS-LIST-END   TO TRUE                        04320001
043300             END-IF                                               04330001
043400                                                                  04340001
043500         WHEN OTHER                                               04350001
043600             SET DP030-CONTINUE-GO TO TRUE                        04360001
043700             PERFORM 2100-CHECK-FUNCTION-KEY                      04370001
043800     END-EVALUATE.                                                04380001
043900******************************************************************04390001
044000** ACT ON ANY FUNCTION KEYS THAT REQUIRE EDITS TO BE PASSED     **04400001
044100** FIRST.  NOTE THAT INVALID FUNCTION KEYS WILL NOT BE RETURNED **04410001
044200** FROM THE CICS ARCHITECTURE API.                              **04420001
044300******************************************************************04430001
044400 2100-CHECK-FUNCTION-KEY.                                         04440001
044500     EVALUATE TRUE                                                04450001
044600         WHEN DP020-FK-LOCAL-GOTO (DP020-SRC-AID)                 04460001
044700             PERFORM 2110-PREPARE-INTER-APPL-COMM                 04470001
044800                                                                  04480001
044900         WHEN DP020-FK-LOCAL-FUNC-01 (DP020-SRC-AID)              04490001
045000             INITIALIZE VL005-INTER-APPL-COMMAREA                 04500001
045100             MOVE ASC-PO-NBR               TO VL005-PO-NUMBER     04510001
045101                                                                  04510101
045102*RS ADDED 2/9 2 LINES                                             04510201
045110         WHEN DP020-FK-LOCAL-FUNC-02 (DP020-SRC-AID)              04510301
045120             PERFORM 2110-PREPARE-INTER-APPL-COMM                 04510401
045200                                                                  04510501
               WHEN DP020-FK-LOCAL-FUNC-03 (DP020-SRC-AID)              04510604
                   INITIALIZE PO017-INTER-APPL-COMMAREA                 04510704
                   MOVE ASC-PO-NBR               TO PO017-PO-NBR        04510804
                   MOVE ASC-DEPT-NBR             TO PO017-DEPT-NBR      04510904
                   MOVE ASC-VDR-NAME             TO PO017-ENT-NAME-DESC 04511004
                                                                        04511404
               WHEN DP020-FK-LOCAL-FUNC-04 (DP020-SRC-AID)              04511504
                   INITIALIZE PO011-INTER-APPL-COMMAREA                 04511604
                   MOVE ASC-PO-NBR               TO PO011-PO-NBR        04511704
                                                                        04511804
045300         WHEN DP020-SRC-AID = DP016-ENTER                         04511904
045400             CONTINUE                                             04512004
045500                                                                  04512104
045600         WHEN DP020-FK-LOCAL-RETURN (DP020-SRC-AID)               04512204
045700             CONTINUE                                             04512304
045800                                                                  04512404
045900         WHEN OTHER                                               04513001
046000             SET DP013-NO-ROLLBACK                                04514001
046100                 DP013-XCTL-DISPLAY-RESTART                       04515001
046200                 DP013-CICS-ABEND  TO TRUE                        04516001
046300             MOVE '2100-CHECK-FUNCTION-KEY'                       04517001
046400                                   TO DP013-PARAGRAPH             04518001
046500             MOVE 'INVALID FUNCTION KEY NOT CAPTURED BY API'      04519001
046600                                   TO DP013-MESSAGE-TEXT (1)      04520001
046700             PERFORM DP013-0000-PROCESS-ABEND                     04530001
046800     END-EVALUATE.                                                04540001
046900*----------------------------------------------------------------*04550001
047000** MOVE DATA NECESSARY TO THE DESTINATION PROGRAM(S) INTO THE   **04560001
047100** INTER-APPLICATION COMMAREA.                                  **04570001
047200*----------------------------------------------------------------*04580001
047300 2110-PREPARE-INTER-APPL-COMM.                                    04590001
047400     INITIALIZE PO017-INTER-APPL-COMMAREA.                        04600001
047500     MOVE ASC-PO-NBR               TO PO017-PO-NBR.               04610001
047600     MOVE ASC-VDR-NAME             TO PO017-ENT-NAME-DESC.        04620001
047610     MOVE ASC-DEPT-NBR             TO PO017-DEPT-NBR.             04630001
047700     MOVE ASC-PO-NBR               TO AP300-PO-NBR.               04640001
047800     MOVE SPACES                   TO AP300-INVC-TYP-CDE.         04650001
047900 EJECT                                                            04660001
048000*----------------------------------------------------------------*04670001
048100*    GET THE PO NUMBER (KEY) OF THE NEXT SELECTED OBJECT         *04680001
048200*    FROM THE SELECTED-ITEMS TEMP. STORAGE QUEUE.                *04690001
048300*----------------------------------------------------------------*04700001
048400 2115-GET-NEXT-PO.                                                04710001
048500                                                                  04720001
048600     ADD +1                        TO ASC-SEL-SUB.                04730001
048700     IF  ASC-SEL-SUB > PO012-MAX-ITEMS                            04740001
048800         ADD +1                    TO ASC-SEL-ITEM                04750001
048900         MOVE +1                   TO ASC-SEL-SUB                 04760001
049000     END-IF.                                                      04770001
049100                                                                  04780001
049200     IF  ASC-SEL-ITEM NOT > ASC-NUMBER-OF-TS-ITEMS                04790001
049300         PERFORM 9100-READ-SEL-QUEUE                              04800001
049400         IF  PO012-ITEM (ASC-SEL-SUB) > ZERO                      04810001
049500             MOVE PO012-PO-NBR (ASC-SEL-SUB)                      04820001
049600                                   TO ASC-PO-NBR                  04830001
049700             SET PO012-INQ (ASC-SEL-SUB)                          04840001
049800                                   TO TRUE                        04850001
049900             PERFORM 9200-REWRITE-SEL-QUEUE                       04860001
050000         ELSE                                                     04870001
050100             SUBTRACT +1 FROM ASC-SEL-SUB                         04880001
050200*            --- BOTTOM OF LIST ---                               04890001
050300             MOVE PC-TSYMSG-00070  TO DP020-MSG-NUMBER            04900001
050400             SET DP020-MSG-INFORMATIONAL                          04910001
050500                 PS-LIST-END                                      04920001
050600                                   TO TRUE                        04930001
050700         END-IF                                                   04940001
050800     ELSE                                                         04950001
050900         SUBTRACT +1 FROM ASC-SEL-ITEM                            04960001
051000         MOVE PO012-MAX-ITEMS      TO ASC-SEL-SUB                 04970001
051100         MOVE PC-TSYMSG-00070      TO DP020-MSG-NUMBER            04980001
051200         SET DP020-MSG-INFORMATIONAL                              04990001
051300             PS-LIST-END                                          05000001
051400                                   TO TRUE                        05010001
051500     END-IF.                                                      05020001
051600*----------------------------------------------------------------*05030001
051700*    GET THE PO NUMBER (KEY) OF THE PREVIOUS SELECTED            *05040001
051800*    OBJECT FROM THE SELECTED-ITEMS TEMP. STORAGE QUEUE.         *05050001
051900*----------------------------------------------------------------*05060001
052000 2120-GET-PREV-PO.                                                05070001
052100                                                                  05080001
052200     SUBTRACT +1 FROM ASC-SEL-SUB.                                05090001
052300     IF  ASC-SEL-SUB < +1                                         05100001
052400         SUBTRACT +1 FROM ASC-SEL-ITEM                            05110001
052500         MOVE PO012-MAX-ITEMS      TO ASC-SEL-SUB                 05120001
052600     END-IF.                                                      05130001
052700                                                                  05140001
052800     IF  ASC-SEL-ITEM > ZERO                                      05150001
052900         PERFORM 9100-READ-SEL-QUEUE                              05160001
053000         MOVE PO012-PO-NBR (ASC-SEL-SUB)                          05170001
053100                                   TO ASC-PO-NBR                  05180001
053200     ELSE                                                         05190001
053300         MOVE +1                   TO ASC-SEL-ITEM                05200001
053400                                      ASC-SEL-SUB                 05210001
053500*        --- TOP OF LIST ---                                      05220001
053600         MOVE PC-TSYMSG-00069      TO DP020-MSG-NUMBER            05230001
053700         SET DP020-MSG-INFORMATIONAL                              05240001
053800             PS-LIST-END           TO TRUE                        05250001
053900     END-IF.                                                      05260001
054000                                                                  05270001
054100*----------------------------------------------------------------*05280001
054200*  POSITION THE CURSOR AT THE APPROPRIATE FIELD.                 *05290001
054300*  IF THERE IS ANY DATA TO MOVE TO THE SCREEN ON INITIAL, MOVE   *05300001
054400*  IT HERE.                                                      *05310001
054500*----------------------------------------------------------------*05320001
054600 4000-BUILD-INITIAL-PANEL.                                        05330001
054700                                                                  05340001
054800     EVALUATE TRUE                                                05350001
054900        WHEN ASC-CRIT                                             05360001
055000          MOVE PO017-PO-NBR           TO ASC-PO-NBR               05370001
055100        WHEN OTHER                                                05380001
055200          CONTINUE                                                05390001
055300     END-EVALUATE.                                                05400001
055400                                                                  05410001
055500     PERFORM 4100-SELECT-VENDNAME-DEPT.                           05420001
055600     PERFORM 4400-MOVE-COMMAREA-TO-SCREEN.                        05430001
055700*----------------------------------------------------------------*05440001
055800* SELECT VENDOR NAME AND PO DEPARTMENT                           *05450001
055900*----------------------------------------------------------------*05460001
056000 4100-SELECT-VENDNAME-DEPT.                                       05470001
056100                                                                  05480001
056200     EXEC SQL                                                     05490001
056300         SELECT ENT_NAME_DESC,                                    05500001
056400                DEPT_NBR                                          05510001
056500         INTO :ASC-VDR-NAME,                                      05520001
056600              :ASC-DEPT-NBR                                       05530001
056700         FROM TPURCHS A,                                          05540001
056800              TENTNME B                                           05550001
056900         WHERE                                                    05560001
057000              A.PO_NBR = :ASC-PO-NBR   AND                        05570001
057100              A.VER_STATUS_CDE = 'A'   AND                        05580001
057200              A.ENT_ID = B.ENT_ID      AND                        05590001
057300              B.TYPE_CDE = '01'                                   05600001
057400     END-EXEC.                                                    05610001
057500                                                                  05620001
057600     EVALUATE TRUE                                                05630001
057700         WHEN SQLCODE = ZERO                                      05640001
057800              CONTINUE                                            05650001
057900         WHEN SQLCODE = +100                                      05660001
058000              MOVE SPACES TO ASC-VDR-NAME                         05670001
058100         WHEN SQLWARN0 NOT EQUAL SPACE                            05680001
058200         WHEN SQLCODE NOT EQUAL ZERO                              05690001
058300              MOVE '4100-SELECT-VENDNME-DEPT'                     05700001
058400                           TO  DP013-PARAGRAPH                    05710001
058500              MOVE 'SELECT VENDOR NAME'                           05720001
058600                           TO  DP013-MESSAGE-TEXT (1)             05730001
058700              MOVE SQLCA   TO  DP013-SQLCA                        05740001
058800              SET DP013-DB2-ABEND                                 05750001
058900                           TO  TRUE                               05760001
059000              PERFORM DP013-0000-PROCESS-ABEND                    05770001
059100     END-EVALUATE.                                                05780001
059200 EJECT                                                            05790001
059300*----------------------------------------------------------------*05800001
059400*    RESTORE THE DATA ON THE SCREEN FROM THE COMM AREA.          *05810001
059500*----------------------------------------------------------------*05820001
059600 4400-MOVE-COMMAREA-TO-SCREEN.                                    05830001
059700     MOVE ASC-PO-NBR               TO PV-PO-NUMBER.               05840001
059800     MOVE PV-PO-NUMBER             TO APONMBRO.                   05850001
059900     MOVE ASC-VDR-NAME             TO AVDRNAMO.                   05860001
060000     MOVE ASC-DEPT-NBR             TO ADEPTNOO.                   05870001
060100 EJECT                                                            05880001
060200*----------------------------------------------------------------*05890001
060300*    WRITE COMMAREA TO TRANSFER CONTROL TO ANOTHER PROGRAM       *05900001
060400*----------------------------------------------------------------*05910001
060500 9000-CALL-CICS-ARCH-API.                                         05920001
CICS       CALL DP930-CICS-ARCH-API USING DFHEIBLK                      05930010
060700                                    DFHCOMMAREA                   05940010
060800                                    DP030-CICS-API-FIELDS         05950010
060900                                    DP020-STANDARD-COMMAREA       05960010
061000                                    PO125AI.                      05970010
061100     IF  DP030-RC-CALL-SUCCESSFUL                                 05980001
061200         CONTINUE                                                 05990001
061300     ELSE                                                         06000001
061400         SET DP013-NO-ROLLBACK                                    06010001
061500             DP013-XCTL-DISPLAY-RESTART                           06020001
061600             DP013-CICS-ABEND      TO TRUE                        06030001
061700         MOVE '9000-CALL-CICS-ARCH-API'                           06040010
061800                                   TO DP013-PARAGRAPH             06050001
CICS           MOVE 'CALL TO CICS ARCH API NOT SUCCESSFUL, RETURN-CODE O06060010
CICS  -             'N NEXT LINE'        TO DP013-MESSAGE-TEXT (2)      06070010
062100         MOVE DP030-RETURN-CODE                                   06080001
062200                                   TO DP013-MESSAGE-TEXT (3)      06090001
062300         PERFORM DP013-0000-PROCESS-ABEND                         06100001
062400     END-IF.                                                      06110001
062500 EJECT                                                            06120001
062600*----------------------------------------------------------------*06130001
062700*    READ AN ITEM FROM THE SELECTED ITEMS TEMP STORAGE QUEUE     *06140001
062800*----------------------------------------------------------------*06150001
062900 9100-READ-SEL-QUEUE.                                             06160001
063000     EXEC CICS                                                    06170001
063100         READQ TS                                                 06180001
063200             QUEUE (ASC-SEL-QUEUE-NAME)                           06190001
063300             INTO  (PO012-PO-SELECT-RECORD)                       06200001
063400             ITEM  (ASC-SEL-ITEM)                                 06210001
063500             RESP  (PV-CICS-RESPONSE)                             06220001
063600     END-EXEC.                                                    06230001
063700                                                                  06240001
063800     IF  PV-CICS-RESPONSE EQUAL DFHRESP(NORMAL)                   06250001
063900         CONTINUE                                                 06260001
064000     ELSE                                                         06270001
064100         SET DP013-LOGIC-ABEND                                    06280001
064200             DP013-NO-ROLLBACK     TO TRUE                        06290001
064300         MOVE '9100-READ-SEL-QUEUE'                               06300001
064400                                   TO DP013-PARAGRAPH             06310001
064500         MOVE 'ATTEMPTING TO READ THE LIST SELECTIONS TS QUEUE'   06320001
064600                                   TO DP013-MESSAGE-TEXT (1)      06330001
064700         PERFORM DP013-0000-PROCESS-ABEND                         06340001
064800     END-IF.                                                      06350001
064900 EJECT                                                            06360001
065000*----------------------------------------------------------------*06370001
065100*    UPDATE AN ITEM IN THE SELECTED ITEMS TEMP STORAGE QUEUE     *06380001
065200*----------------------------------------------------------------*06390001
065300 9200-REWRITE-SEL-QUEUE.                                          06400001
065400     EXEC CICS                                                    06410001
065500          WRITEQ TS                                               06420001
065600              QUEUE  (ASC-SEL-QUEUE-NAME)                         06430001
065700              FROM   (PO012-PO-SELECT-RECORD)                     06440001
065800              ITEM   (ASC-SEL-ITEM)                               06450001
065900              RESP   (PV-CICS-RESPONSE)                           06460001
066000              REWRITE                                             06470001
066100     END-EXEC.                                                    06480001
066200                                                                  06490001
066300     IF  PV-CICS-RESPONSE NOT EQUAL DFHRESP(NORMAL)               06500001
066400         SET DP013-CICS-ABEND                                     06510001
066500             DP013-NO-ROLLBACK     TO TRUE                        06520001
066600         MOVE '9200-REWRITE-SEL-QUEUE'                            06530001
066700                                   TO DP013-PARAGRAPH             06540001
066800         MOVE 'ATTEMPTING TO REWRITE THE LIST SELECTIONS QUEUE'   06550001
066900                                   TO DP013-MESSAGE-TEXT (1)      06560001
067000         PERFORM DP013-0000-PROCESS-ABEND                         06570001
067100     END-IF.                                                      06580001
067200 EJECT                                                            06590001
067300*----------------------------------------------------------------*06600001
067400*    ABEND PROCESSOR MODULE                                      *06610001
067500*----------------------------------------------------------------*06620001
067600     COPY DPPD013.                                                06630001
067700*----------------------------------------------------------------*06640001
