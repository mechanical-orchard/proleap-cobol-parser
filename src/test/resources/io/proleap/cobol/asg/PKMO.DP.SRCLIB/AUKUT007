000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.         AUKUT007.                                    00040001
000500 AUTHOR.             BARB ERTL.                                   00050001
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060001
000700 DATE-WRITTEN.       FEBRUARY 2008.                               00070001
000800 DATE-COMPILED.                                                   00080001
000900                                                                  00090001
001000******************************************************************00100001
001100* THIS PROGRAM PREPARES THE UPDATE POSTING FILE TO BE PROCESSED  *00110001
001200* BY AUKUP002 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120001
001300*                                                                *00130001
001400* THE PROGRAM READS THE UPDATE POSTING FILE, REFORMATS THE       *00140001
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150001
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160001
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170001
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180001
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190001
002000* OUT TO A SEQUENTIAL FILE.                                      *00200001
002100*                                                                *00210001
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220001
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230001
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240001
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250001
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260001
002700* ABENDS.                                                        *00270001
002800*                                                                *00280001
002900* INPUT FILES:   UPDATE-POSTING-FILE       DDNAME = INP01        *00290001
003000*                                                                *00300001
003100* OUTPUT FILES:  N/A                                             *00310001
003200*                                                                *00320001
003300******************************************************************00330001
260107* CHG0260107 - 08/13/2021 - JIM HUNTER                           *00330102
260107* ADDING DPWS990 COPYBOOK TO CONVERT CALL TO DPKUT900 FROM       *00330202
260107* STATIC TO DYNAMIC.                                             *00330302
260107******************************************************************00331002
003400                                                                  00340001
003500******************************************************************00350001
003600 ENVIRONMENT DIVISION.                                            00360001
003700******************************************************************00370001
003800                                                                  00380001
003900 CONFIGURATION SECTION.                                           00390001
004000                                                                  00400001
004100 SOURCE-COMPUTER.    IBM-3090.                                    00410001
004200 OBJECT-COMPUTER.    IBM-3090.                                    00420001
004300                                                                  00430001
004400 INPUT-OUTPUT SECTION.                                            00440001
004500                                                                  00450001
004600 FILE-CONTROL.                                                    00460001
004700                                                                  00470001
004800     SELECT UPDATE-POSTING-FILE  ASSIGN TO INP01.                 00480001
004900                                                                  00490001
005000******************************************************************00500001
005100 DATA DIVISION.                                                   00510001
005200******************************************************************00520001
005300                                                                  00530001
005400 FILE SECTION.                                                    00540001
005500                                                                  00550001
005600 FD  UPDATE-POSTING-FILE                                          00560001
005700     RECORDING MODE IS F                                          00570001
005800     BLOCK CONTAINS 0 RECORDS                                     00580001
005900     LABEL RECORDS ARE OMITTED.                                   00590001
006000                                                                  00600001
006100 01  UPDATE-POSTING-RECORD       PIC  X(150).                     00610001
006200                                                                  00620001
006300 WORKING-STORAGE SECTION.                                         00630001
006400                                                                  00640001
006500 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00650001
006600                                                                  00660001
006700******************************************************************00670001
006800*PC - PROGRAM CONSTANTS                                           00680001
006900******************************************************************00690001
007000 01  PROGRAM-CONSTANTS.                                           00700001
007100     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'AUKUT007'. 00710001
007200     05  PC-TRAN-PREP-FUNC-CODES.                                 00720001
007300         10  PC-TRAN-PREP-FUNC-OPEN                               00730001
007400                                 PIC X(05)      VALUE 'OPEN '.    00740001
007500         10  PC-TRAN-PREP-FUNC-WRITE                              00750001
007600                                 PIC X(05)      VALUE 'WRITE'.    00760001
007700         10  PC-TRAN-PREP-FUNC-CLOSE                              00770001
007800                                 PIC X(05)      VALUE 'CLOSE'.    00780001
007900     05  PC-JOB-NAME             PIC X(08)      VALUE 'AUK025  '. 00790001
008000     05  PC-PLAN-NAME            PIC X(08)      VALUE 'AUKUP002'. 00800001
008100     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +150 COMP.  00810001
008200                                                                  00820001
008300******************************************************************00830001
008400*PV - PROGRAM VARIABLES                                           00840001
008500******************************************************************00850001
008600 01  PROGRAM-VARIABLES.                                           00860001
008700     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00870001
008800         88  CONTROL-BREAK                      VALUE 'C'.        00880001
008900         88  LOGICAL-TRANSACTION                VALUE 'L'.        00890001
009000         88  TIME-INTERVAL                      VALUE 'T'.        00900001
009100         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00910001
009200     05  PV-HOLD-GIFT-CRD-NBR    PIC  X(19)     VALUE SPACES.     00920001
009300                                                                  00930001
009400******************************************************************00940001
009500*PA - PROGRAM ACCUMULATORS                                        00950001
009600******************************************************************00960001
009700 01  PROGRAM-ACCUMULATORS.                                        00970001
009800     05  PA-POSTING-RECORDS-READ PIC S9(11)     COMP-3            00980001
009900                                                VALUE ZEROES.     00990001
010000     05  PA-POSTING-RECS-WRITTEN PIC S9(11)     COMP-3            01000001
010100                                                VALUE ZEROES.     01010001
010200                                                                  01020001
010300******************************************************************01030001
010400*PS - PROGRAM SWITCHES                                            01040001
010500******************************************************************01050001
010600 01  PROGRAM-SWITCHES.                                            01060001
010700     05  PS-UPD-POSTING-EOF-SW   PIC X(01)      VALUE 'N'.        01070001
010800         88  PS-UPD-POSTING-EOF                 VALUE 'Y'.        01080001
010900     05  PS-FIRST-TRANS-READ-SW  PIC X(01)      VALUE 'Y'.        01090001
011000         88  FIRST-TRANS-READ                   VALUE 'Y'.        01100001
011100                                                                  01110001
011200******************************************************************01120001
011300*  BLACKHAWK UPDATE POSTING RECORD LAYOUT                        *01130001
011400******************************************************************01140001
011500     COPY AURD013.                                                01150001
011600                                                                  01160001
011700******************************************************************01170001
011800*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01180001
011900******************************************************************01190001
260107     COPY DPWS990.                                                01200002
012100                                                                  01210001
012000     COPY DPLS000.                                                01211002
012100                                                                  01212002
012200******************************************************************01220001
012300*  SQL COMMUNICATIONS WORK AREA                                  *01230001
012400******************************************************************01240001
012500     COPY SQLCA2.                                                 01250001
012600                                                                  01260001
012700******************************************************************01270001
012800 PROCEDURE DIVISION.                                              01280001
012900******************************************************************01290001
013000* 0000-MAINLINE-PROCESSING                                        01300001
013100*    CONTROLS FLOW OF THE PROGRAM                                *01310001
013200******************************************************************01320001
013300 0000-MAINLINE-PROCESSING.                                        01330001
013400                                                                  01340001
013500     PERFORM 1000-INITIALIZE.                                     01350001
013600                                                                  01360001
013700     PERFORM 2000-PROCESS-UPD-POSTING-FILE                        01370001
013800         UNTIL PS-UPD-POSTING-EOF.                                01380001
013900                                                                  01390001
014000     PERFORM 3000--END-OF-JOB-ROUTINE.                            01400001
014100                                                                  01410001
014200     GOBACK.                                                      01420001
014300                                                                  01430001
014400******************************************************************01440001
014500* 1000-INITIALIZE                                                *01450001
014600******************************************************************01460001
014700 1000-INITIALIZE.                                                 01470001
014800                                                                  01480001
014900     PERFORM 7000-ISSUE-OPEN-REQUEST.                             01490001
015000                                                                  01500001
015100     OPEN INPUT UPDATE-POSTING-FILE.                              01510001
015200                                                                  01520001
015300     PERFORM 7100-READ-UPDATE-POSTING-FILE.                       01530001
015400     IF PS-UPD-POSTING-EOF                                        01540001
015500         DISPLAY ' '                                              01550001
015600         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01560001
015700         DISPLAY 'UPDATE POSTING FILE IS EMPTY'                   01570001
015800         DISPLAY ' '                                              01580001
015900     END-IF.                                                      01590001
016000                                                                  01600001
016100******************************************************************01610001
016200* 2000-PROCESS-UPD-POSTING-FILE                                  *01620001
016300*     READ AN UPDATE POSTING RECORD.  IF END-OF-FILE, STOP PRO-  *01630001
016400*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01640001
016500*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01650001
016600*     CHECKPOINTS BEING TAKEN BY AUKUP002 AND ISSUE A WRITE      *01660001
016700*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01670001
016800******************************************************************01680001
016900 2000-PROCESS-UPD-POSTING-FILE.                                   01690001
017000                                                                  01700001
017100     IF FIRST-TRANS-READ                                          01710001
017200         MOVE AU013-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         01720001
017300         MOVE 'N' TO PS-FIRST-TRANS-READ-SW                       01730001
017400     END-IF.                                                      01740001
017500                                                                  01750001
017600     IF CONTROL-BREAK                                             01760001
017700         PERFORM 7200-CKPT-BY-CNTL-BREAK                          01770001
017800     ELSE                                                         01780001
017900         IF LOGICAL-TRANSACTION                                   01790001
018000             PERFORM 7300-CKPT-BY-LOGICAL-TRANS                   01800001
018100         ELSE                                                     01810001
018200             PERFORM 7400-CKPT-BY-TIME-OR-REQUEST                 01820001
018300         END-IF                                                   01830001
018400     END-IF.                                                      01840001
018500                                                                  01850001
018600     PERFORM 7100-READ-UPDATE-POSTING-FILE.                       01860001
018700                                                                  01870001
018800******************************************************************01880001
018900* 3000--END-OF-JOB-ROUTINE                                       *01890001
019000*                                                                *01900001
019100*                                                                *01910001
019200******************************************************************01920001
019300 3000--END-OF-JOB-ROUTINE.                                        01930001
019400                                                                  01940001
019500     CLOSE UPDATE-POSTING-FILE.                                   01950001
019600                                                                  01960001
019700     DISPLAY ' '.                                                 01970001
019800     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             01980001
019900     DISPLAY 'NUMBER OF POSTING RECORDS READ:        '            01990001
020000             PA-POSTING-RECORDS-READ.                             02000001
020100     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02010001
020200             PA-POSTING-RECS-WRITTEN.                             02020001
020300     DISPLAY ' '.                                                 02030001
020400                                                                  02040001
020500     PERFORM 7500-ISSUE-CLOSE-REQUEST.                            02050001
020600                                                                  02060001
020700******************************************************************02070001
020800* 7000-ISSUE-OPEN-REQUEST                                        *02080001
020900*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02090001
021000*     MODULE.                                                    *02100001
021100******************************************************************02110001
021200 7000-ISSUE-OPEN-REQUEST.                                         02120001
021300                                                                  02130001
021400     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02140001
021500     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02150001
021600     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02160001
021700                                                                  02170001
021800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02180001
021900                                                                  02190001
022000     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02200001
022100                                                                  02210001
022200******************************************************************02220001
022300* 7100-READ-UPDATE-POSTING-FILE                                  *02230001
022400******************************************************************02240001
022500 7100-READ-UPDATE-POSTING-FILE.                                   02250001
022600                                                                  02260001
022700     READ UPDATE-POSTING-FILE INTO AU013-DETAIL-TRANS             02270001
022800         AT END                                                   02280001
022900             SET PS-UPD-POSTING-EOF TO TRUE.                      02290001
023000                                                                  02300001
023100     IF PS-UPD-POSTING-EOF                                        02310001
023200         CONTINUE                                                 02320001
023300     ELSE                                                         02330001
023400         ADD +1 TO PA-POSTING-RECORDS-READ                        02340001
023500     END-IF.                                                      02350001
023600                                                                  02360001
023700******************************************************************02370001
023800* 7200-CKPT-BY-CNTL-BREAK                                        *02380001
023900*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02390001
024000*     TION RECORD "ON" IF THERE IS A CHANGE IN THE CARD          *02400001
024100*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02410001
024200*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02420001
024300*     MODULE.                                                    *02430001
024400* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02440001
024500******************************************************************02450001
024600 7200-CKPT-BY-CNTL-BREAK.                                         02460001
024700                                                                  02470001
024800     IF AU013-GIFT-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                02480001
024900         MOVE 'N' TO DP000-CHECKPOINT-IND                         02490001
025000     ELSE                                                         02500001
025100         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02510001
025200         MOVE AU013-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         02520001
025300     END-IF.                                                      02530001
025400                                                                  02540001
025500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02550001
025600     MOVE AU013-DETAIL-TRANS      TO DP000-TRANS-REC.             02560001
025700     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02570001
025800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02580001
025900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02590001
026000                                                                  02600001
026100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02610001
026200     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02620001
026300                                                                  02630001
026400******************************************************************02640001
026500* 7300-CKPT-BY-LOGICAL-TRANS.                                    *02650001
026600*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02660001
026700*     TION RECORD "ON" IF THERE IS A CHANGE IN THE CARD          *02670001
026800*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02680001
026900*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02690001
027000*     MODULE.                                                    *02700001
027100* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02710001
027200******************************************************************02720001
027300 7300-CKPT-BY-LOGICAL-TRANS.                                      02730001
027400                                                                  02740001
027500     IF AU013-GIFT-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                02750001
027600         MOVE 'N' TO DP000-CHECKPOINT-IND                         02760001
027700     ELSE                                                         02770001
027800         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02780001
027900         MOVE AU013-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         02790001
028000     END-IF.                                                      02800001
028100                                                                  02810001
028200     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02820001
028300     MOVE AU013-DETAIL-TRANS      TO DP000-TRANS-REC.             02830001
028400     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02840001
028500     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02850001
028600     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02860001
028700                                                                  02870001
028800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02880001
028900     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02890001
029000                                                                  02900001
029100******************************************************************02910001
029200* 7400-CKPT-BY-TIME-OR-REQUEST.                                  *02920001
029300*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02930001
029400*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *02940001
029500*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *02950001
029600*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *02960001
029700******************************************************************02970001
029800 7400-CKPT-BY-TIME-OR-REQUEST.                                    02980001
029900                                                                  02990001
030000     MOVE 'N' TO DP000-CHECKPOINT-IND.                            03000001
030100     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03010001
030200     MOVE AU013-DETAIL-TRANS      TO DP000-TRANS-REC.             03020001
030300     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03030001
030400     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03040001
030500     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03050001
030600                                                                  03060001
030700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03070001
030800     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           03080001
030900                                                                  03090001
031000******************************************************************03100001
031100* 7500-ISSUE-CLOSE-REQUEST                                       *03110001
031200*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03120001
031300*     MODULE.                                                    *03130001
031400******************************************************************03140001
031500 7500-ISSUE-CLOSE-REQUEST.                                        03150001
031600                                                                  03160001
031700     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03170001
031800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03180001
031900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03190001
032000                                                                  03200001
032100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03210001
032200                                                                  03220001
032300******************************************************************03230001
032400*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03240001
032500******************************************************************03250001
032600     COPY DPPD000.                                                03260001
032700                                                                  03270001
