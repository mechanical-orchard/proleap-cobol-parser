000100 TITLE 'PURGE CARTON DIRECTIVES'.                                         
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    SUKUT136.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
000600 DATE-WRITTEN   DECEMBER 2008.                                            
000700 DATE-COMPILED.                                                           
000800 ENVIRONMENT DIVISION.                                                    
000900 CONFIGURATION SECTION.                                                   
001000 SOURCE-COMPUTER.        IBM-3090.                                        
001100 OBJECT-COMPUTER.        IBM-3090.                                        
001200                                                                          
001300 INPUT-OUTPUT SECTION.                                                    
001400 FILE-CONTROL.                                                            
001500                                                                          
001600     SELECT UNLOAD-FILE                                                   
001700         ASSIGN TO OUT01.                                                 
001800                                                                          
001900******************************************************************        
002000 DATA DIVISION.                                                           
002100 FILE SECTION.                                                            
002200                                                                          
002300 FD  UNLOAD-FILE                                                          
002400     RECORDING MODE IS F                                                  
002500     LABEL RECORDS ARE STANDARD                                           
002600     BLOCK CONTAINS 0 RECORDS.                                            
002700                                                                          
002800*    FROM SUT00102                                                        
002900 01  UNLOAD-REC                       PIC X(168).                         
003000*                                                                         
003100/                                                                         
003200 WORKING-STORAGE SECTION.                                                 
003300                                                                          
003400     COPY SURD095.                                                        
003500                                                                          
003600     COPY DPWS004.                                                        
003700*                                                                         
003800     EXEC SQL                                                             
003900         INCLUDE SUT00102                                                 
004000     END-EXEC.                                                            
004100                                                                          
004200     EXEC SQL                                                             
004300         INCLUDE TCOCNTL                                                  
004400     END-EXEC.                                                            
004500                                                                          
004600     EXEC SQL                                                             
004700         INCLUDE TKRPRPM                                                  
004800     END-EXEC.                                                            
004900                                                                          
005000     EXEC SQL                                                             
005100          INCLUDE SQLCA                                                   
005200     END-EXEC.                                                            
005300                                                                          
005400 01  ABEND-CODE                      PIC S9(04)    VALUE +0               
005500                                                   COMP SYNC.             
005600                                                                          
005700 01  PS-PROGRAM-SWITCHES.                                                 
005800     05  PS-END-OF-DRIVE-CSR-SW       PIC  X(01) VALUE 'N'.               
005900         88  PS-END-DRIVE-CSR-YES                VALUE 'Y'.               
006000         88  PS-END-DRIVE-CSR-NO                 VALUE 'N'.               
006100                                                                          
006200 01  PC-PROGRAM-CONSTANTS.                                                
006300     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08) VALUE 'SUKUT136'.         
006400                                                                          
006500 01  DK-DB2-VARIABLES.                                                    
006600     05  DK-PURGE-DATE                PIC X(10).                          
006700                                                                          
006800 01  PV-PROGRAM-VARIABLES.                                                
006900                                                                          
007000     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.          
007100     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.          
007200*    05  PV-READ-COUNTER             PIC  S9(9) COMP.                     
007300     05  PV-WRITE-DRIVE-COUNTER      PIC  S9(9) COMP.                     
007400     05  PV-WRITE-WRKR-COUNTER       PIC  S9(9) COMP.                     
007500     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.                     
007600     05  PV-FUNC-QTY                 PIC  S9(4) COMP.                     
007700/                                                                         
007800     EXEC SQL                                                             
007900                                                                          
008000         DECLARE DRIVE-CSR CURSOR FOR                                     
008100         SELECT                                                           
008200             BRCDE_NBR                                                    
008300            ,CRE_TMST                                                     
008400            ,OPER_UNT_ID                                                  
008500            ,DIRV_RSN_CDE                                                 
008600            ,LGCL_LOC_NM                                                  
008700            ,AUD_CNTL_NBR                                                 
008800            ,SHIPT_UNT_ID                                                 
008900            ,AUD_STAT_CDE                                                 
009000            ,PO_NBR                                                       
009100            ,RCVR_SEQ_NBR                                                 
009200            ,PO_LNE_NBR                                                   
009300            ,PREPK_ID                                                     
009400            ,STR_NBR                                                      
009500            ,CRE_PGM_NM                                                   
009600            ,ACKNL_SEQ_NBR                                                
009700            ,CASI_CDE                                                     
009800            ,CART_STAT_CDE                                                
009900            ,AUD_FALR_RSN_NM                                              
010000            ,STR_ZN_ID                                                    
010100            ,SEASET_YR                                                    
010200            ,SEASET_SHRT_NM                                               
010300            ,CNVYR_PRC_ACTN_NM                                            
010400            ,CRE_BY_USR_ID                                                
010500          FROM  SUT_CART_DIRV_TRKG                                        
010600         WHERE  DATE(CRE_TMST) <= :DK-PURGE-DATE                          
010700     END-EXEC.                                                            
010800/                                                                         
010900 PROCEDURE DIVISION.                                                      
011000                                                                          
011100     PERFORM 1000-INITIALIZE.                                             
011200                                                                          
011300     PERFORM 2000-PROCESS-DRIVE-CSR                                       
011400             UNTIL PS-END-DRIVE-CSR-YES                                   
011500                                                                          
011600     PERFORM 9000-EOJ-ROUTINE.                                            
011700                                                                          
011800     GOBACK.                                                              
011900/                                                                         
012000 1000-INITIALIZE.                                                         
012100                                                                          
012200     OPEN OUTPUT UNLOAD-FILE                                              
012300                                                                          
012400     DISPLAY '* * * * * * * * * * * '.                                    
012500     DISPLAY 'CURRENT PROGRAM ' PC-CURRENT-PROGRAM-NAME.                  
012600                                                                          
012700     PERFORM 7000-GET-PROCESS-DATE.                                       
012800     DISPLAY ' PROCESS DATE = ' COCNTL-BTCH-PRC-DTE                       
012900                                                                          
013000     PERFORM 7010-GET-OFFSET-DATE.                                        
013100     DISPLAY ' OFFSET DAYS = ' PV-FUNC-QTY                                
013200     DISPLAY ' PURGE DATE  = ' DK-PURGE-DATE.                             
013300                                                                          
013400     PERFORM 7100-OPEN-DRIVE-CSR.                                         
013500     PERFORM 7110-FETCH-DRIVE-CSR.                                        
013600                                                                          
013700 2000-PROCESS-DRIVE-CSR.                                                  
013800                                                                          
013900     PERFORM 3000-BUILD-SU095-REC.                                        
014000     PERFORM 8000-WRITE-SU095-REC.                                        
014100                                                                          
014200     PERFORM 7110-FETCH-DRIVE-CSR.                                        
014300                                                                          
014400 3000-BUILD-SU095-REC.                                                    
014500                                                                          
014600     MOVE SUT00102-BRCDE-NBR          TO SU095-BRCDE-NBR                  
014700     MOVE SUT00102-CRE-TMST           TO SU095-CRE-TMST                   
014800     MOVE SUT00102-OPER-UNT-ID        TO SU095-OPER-UNT-ID                
014900     MOVE SUT00102-DIRV-RSN-CDE       TO SU095-DIRV-RSN-CDE               
015000     MOVE SUT00102-LGCL-LOC-NM        TO SU095-LGCL-LOC-NM                
015100     MOVE SUT00102-AUD-CNTL-NBR       TO SU095-AUD-CNTL-NBR               
015200     MOVE SUT00102-SHIPT-UNT-ID       TO SU095-SHIPT-UNT-ID               
015300     MOVE SUT00102-AUD-STAT-CDE       TO SU095-AUD-STAT-CDE               
015400     MOVE SUT00102-PO-NBR             TO SU095-PO-NBR                     
015500     MOVE SUT00102-RCVR-SEQ-NBR       TO SU095-RCVR-SEQ-NBR               
015600     MOVE SUT00102-PO-LNE-NBR         TO SU095-PO-LNE-NBR                 
015700     MOVE SUT00102-PREPK-ID           TO SU095-PREPK-ID                   
015800     MOVE SUT00102-STR-NBR            TO SU095-STR-NBR                    
015900     MOVE SUT00102-CRE-PGM-NM         TO SU095-CRE-PGM-NM                 
016000     MOVE SUT00102-ACKNL-SEQ-NBR      TO SU095-ACKNL-SEQ-NBR              
016100     MOVE SUT00102-CASI-CDE           TO SU095-CASI-CDE                   
016200     MOVE SUT00102-CART-STAT-CDE      TO SU095-CART-STAT-CDE              
016300     MOVE SUT00102-AUD-FALR-RSN-NM    TO SU095-AUD-FALR-RSN-NM            
016400     MOVE SUT00102-STR-ZN-ID          TO SU095-STR-ZN-ID                  
016500     MOVE SUT00102-SEASET-YR          TO SU095-SEASET-YR                  
016600     MOVE SUT00102-SEASET-SHRT-NM     TO SU095-SEASET-SHRT-NM             
016700     MOVE SUT00102-CNVYR-PRC-ACTN-NM  TO SU095-CNVYR-PRC-ACTN-NM          
016800     MOVE SUT00102-CRE-BY-USR-ID      TO SU095-CRE-BY-USR-ID.             
016900                                                                          
017000 7000-GET-PROCESS-DATE.                                                   
017100                                                                          
017200     MOVE '7000-GET-PROCESS-DATE'     TO PV-PARAGRAPH-NAME.               
017300                                                                          
017400     EXEC SQL                                                             
017500         SELECT                                                           
017600             BTCH_PRC_DTE                                                 
017700         INTO                                                             
017800             :COCNTL-BTCH-PRC-DTE                                         
017900         FROM                                                             
018000             TCOCNTL                                                      
018100         WHERE                                                            
018200             OPER_UNT_ID = 90                                             
018300         AND FCLTY_ID = 1                                                 
018400     END-EXEC.                                                            
018500                                                                          
018600     EVALUATE TRUE                                                        
018700         WHEN SQLCODE = ZERO                                              
018800             CONTINUE                                                     
018900         WHEN SQLWARN0 NOT = SPACES                                       
019000         WHEN SQLCODE < ZERO                                              
019100         WHEN SQLCODE > ZERO                                              
019200             MOVE '7000-GET-PROCESS-DATE' TO PV-PARAGRAPH-NAME            
019300             MOVE 'SELECT'        TO PV-DB2-OPERATION-ATTEMPTED           
019400             PERFORM 9100-SQL-ABEND                                       
019500     END-EVALUATE.                                                        
019600                                                                          
019700 7010-GET-OFFSET-DATE.                                                    
019800                                                                          
019900     MOVE '7010-GET-OFFSET-DATE'      TO PV-PARAGRAPH-NAME.               
020000                                                                          
020100     EXEC SQL                                                             
020200         SELECT                                                           
020300             FUNC_QTY                                                     
020400         ,   DATE(DAYS(:COCNTL-BTCH-PRC-DTE) - FUNC_QTY)                  
020500         INTO                                                             
020600             :PV-FUNC-QTY                                                 
020700           , :DK-PURGE-DATE                                               
020800         FROM                                                             
020900             TKRPRPM                                                      
021000         WHERE                                                            
021100             LOC_ID = 90                                                  
021200         AND INTFC_SYS_CDE = 'KHL'                                        
021300         AND SYS_PRC_FUNC_CDE = 'CDTPRG'                                  
021400         AND FUNC_PRC_STAT_CDE = 'AC'                                     
021500     END-EXEC.                                                            
021600                                                                          
021700     EVALUATE TRUE                                                        
021800         WHEN SQLCODE = ZERO                                              
021900             CONTINUE                                                     
022000         WHEN SQLWARN0 NOT = SPACES                                       
022100         WHEN SQLCODE < ZERO                                              
022200         WHEN SQLCODE > ZERO                                              
022300             MOVE '7010-GET-OFFSET-DATE' TO PV-PARAGRAPH-NAME             
022400             MOVE 'SELECT'        TO PV-DB2-OPERATION-ATTEMPTED           
022500             PERFORM 9100-SQL-ABEND                                       
022600     END-EVALUATE.                                                        
022700                                                                          
022800 7100-OPEN-DRIVE-CSR.                                                     
022900                                                                          
023000     MOVE '7100-OPEN-DRIVE-CSR'       TO PV-PARAGRAPH-NAME.               
023100                                                                          
023200     EXEC SQL                                                             
023300         OPEN DRIVE-CSR                                                   
023400     END-EXEC.                                                            
023500                                                                          
023600     EVALUATE TRUE                                                        
023700         WHEN SQLCODE = ZERO                                              
023800             SET PS-END-DRIVE-CSR-NO  TO TRUE                             
023900         WHEN SQLWARN0 NOT = SPACES                                       
024000         WHEN SQLCODE < ZERO                                              
024100         WHEN SQLCODE > ZERO                                              
024200             MOVE 'OPEN CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED            
024300             PERFORM 9100-SQL-ABEND                                       
024400     END-EVALUATE.                                                        
024500                                                                          
024600 7110-FETCH-DRIVE-CSR.                                                    
024700                                                                          
024800     MOVE '7110-FETCH-DRIVE-CSR'      TO PV-PARAGRAPH-NAME.               
024900     INITIALIZE DCLSUT00102.                                              
025000                                                                          
025100     EXEC SQL                                                             
025200         FETCH DRIVE-CSR                                                  
025300         INTO                                                             
025400              :SUT00102-BRCDE-NBR                                         
025500           ,  :SUT00102-CRE-TMST                                          
025600           ,  :SUT00102-OPER-UNT-ID                                       
025700           ,  :SUT00102-DIRV-RSN-CDE                                      
025800           ,  :SUT00102-LGCL-LOC-NM                                       
025900           ,  :SUT00102-AUD-CNTL-NBR                                      
026000           ,  :SUT00102-SHIPT-UNT-ID                                      
026100           ,  :SUT00102-AUD-STAT-CDE                                      
026200           ,  :SUT00102-PO-NBR                                            
026300           ,  :SUT00102-RCVR-SEQ-NBR                                      
026400           ,  :SUT00102-PO-LNE-NBR                                        
026500           ,  :SUT00102-PREPK-ID                                          
026600           ,  :SUT00102-STR-NBR                                           
026700           ,  :SUT00102-CRE-PGM-NM                                        
026800           ,  :SUT00102-ACKNL-SEQ-NBR                                     
026900           ,  :SUT00102-CASI-CDE                                          
027000           ,  :SUT00102-CART-STAT-CDE                                     
027100           ,  :SUT00102-AUD-FALR-RSN-NM                                   
027200           ,  :SUT00102-STR-ZN-ID                                         
027300           ,  :SUT00102-SEASET-YR                                         
027400           ,  :SUT00102-SEASET-SHRT-NM                                    
027500           ,  :SUT00102-CNVYR-PRC-ACTN-NM                                 
027600           ,  :SUT00102-CRE-BY-USR-ID                                     
027700     END-EXEC.                                                            
027800                                                                          
027900     EVALUATE TRUE                                                        
028000         WHEN SQLCODE = ZERO                                              
028100             CONTINUE                                                     
028200         WHEN SQLCODE = +100                                              
028300             SET PS-END-DRIVE-CSR-YES TO TRUE                             
028400         WHEN SQLWARN0 NOT = SPACES                                       
028500         WHEN SQLCODE < ZERO                                              
028600         WHEN SQLCODE > ZERO                                              
028700             MOVE 'FETCH CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED           
028800             PERFORM 9100-SQL-ABEND                                       
028900     END-EVALUATE.                                                        
029000                                                                          
029100 7120-CLOSE-DRIVE-CSR.                                                    
029200                                                                          
029300     MOVE '7120-CLOSE-DRIVE-CSR' TO PV-PARAGRAPH-NAME                     
029400     EXEC SQL                                                             
029500         CLOSE DRIVE-CSR                                                  
029600     END-EXEC                                                             
029700                                                                          
029800     EVALUATE TRUE                                                        
029900         WHEN SQLCODE = ZERO                                              
030000             CONTINUE                                                     
030100         WHEN SQLWARN0 NOT = SPACES                                       
030200         WHEN SQLCODE < ZERO                                              
030300         WHEN SQLCODE > ZERO                                              
030400             MOVE 'CLOSE CURSOR ' TO PV-DB2-OPERATION-ATTEMPTED           
030500             PERFORM 9100-SQL-ABEND                                       
030600     END-EVALUATE.                                                        
030700                                                                          
030800 8000-WRITE-SU095-REC.                                                    
030900     WRITE UNLOAD-REC FROM                                                
031000         SU095-RECORD.                                                    
031100     ADD +1                           TO PV-WRITE-DRIVE-COUNTER.          
031200/                                                                         
031300 9000-EOJ-ROUTINE.                                                        
031400                                                                          
031500     PERFORM 7120-CLOSE-DRIVE-CSR.                                        
031600                                                                          
031700     CLOSE UNLOAD-FILE                                                    
031800                                                                          
031900*    MOVE PV-READ-COUNTER                TO PV-DISPLAY-COUNT.             
032000*    DISPLAY 'TOTAL RECORDS READ             = ' PV-DISPLAY-COUNT.        
032100                                                                          
032200                                                                          
032300     MOVE PV-WRITE-DRIVE-COUNTER       TO PV-DISPLAY-COUNT.               
032400     DISPLAY 'TRIP ASGMT RECORDS WRITTEN     = ' PV-DISPLAY-COUNT.        
032500                                                                          
032600     MOVE PV-WRITE-WRKR-COUNTER        TO PV-DISPLAY-COUNT.               
032700     DISPLAY 'WRKR ASGMT RECORDS WRITTEN     = ' PV-DISPLAY-COUNT.        
032800     DISPLAY '* * * * * * * * * * * '.                                    
032900                                                                          
033000 9100-SQL-ABEND.                                                          
033100     DISPLAY '9100-SQL-ABEND'.                                            
033200     DISPLAY '** ABEND     **'.                                           
033300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.                
033400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.                      
033500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.             
033600                                                                          
033700     COPY DPPD004.                                                        
033800                                                                          
033900     MOVE +4013                  TO ABEND-CODE.                           
034000     CALL 'ILBOABN0' USING ABEND-CODE.                                    
034100                                                                          
