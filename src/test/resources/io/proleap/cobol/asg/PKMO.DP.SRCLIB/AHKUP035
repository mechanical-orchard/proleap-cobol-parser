000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         AHKUP035.                                    00020000
000300 AUTHOR.             NANCY EILBES.                                00030000
000400 DATE-WRITTEN.       APRIL 2000.                                  00040000
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*   AHKUP035 - ARCHIVE HISTORY DATA DELETION - TPURCHS      *     00090000
001000*                                                           *     00100000
001100*   PROGRAM OVERVIEW:                                       *     00110000
001200*                                                           *     00120000
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPURCHS.  *     00130000
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140000
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150000
001600*                                                           *     00160000
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170000
001800*  UNIQUE INDEX COLUMNS TO SPEED THE DELETION PROCESS.      *     00180000
001900*  THESE COLUMNS ARE PO_NBR, VER_NBR.                       *     00190000
002000*                                                           *     00200000
002100*   INPUT:                                                  *     00210000
002200*                                                           *     00220000
002300*     1. TPURCHS DELETION FILE  COPYBOOK DCLTPURCHS         *     00230000
002400*                                                           *     00240000
002500*   DB2 TABLES:                                             *     00250000
002600*                                                           *     00260000
002700*        TPURCHS - PURCHASE ORDER HEADER TABLE              *     00270000
002800*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00280000
002900*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00290000
003000*                                                           *     00300000
003100*************************************************************     00310000
003110* DATE: 06/20/2002 CHANGE MADE BY: RYAN STAUFFACHER.        *     00311000
003120* CHANGE MADE: INCREASED SIZE OF TPURCHS INPUT FILE BY ONE  *     00312000
003130* CHARACTER TO INCLUDE PO-IN-RMS-IND.                       *     00313000
003140*************************************************************     00314000
003150* DATE: 01/12/2005 CHANGE MADE BY: SUE BARTELT.             *     00315000
003160* CHANGE MADE: INCREASED SIZE OF TPURCHS INPUT FILE FROM 435*     00316000
003161* TO 471 TO INCLUDE:                                        *     00316100
003162* RMS-PO-UPD-TMST                                           *     00316200
003163* DUP-SKU-IND                                               *     00316300
003164* ORIG-PKGNG-CDE                                            *     00316400
003165* IMPRT-VND-ID                                              *     00316500
003166* IMPRT-FCTRY-ID                                            *     00316600
003167*************************************************************     00316700
003168* DATE: 07/01/2010 CHANGE MADE BY: COGNIZANT(KARTHIK K)     *     00316800
003169* CHANGE MADE: INCREASED SIZE OF TPURCHS INPUT FILE FROM 471*     00316900
003170* TO 484 TO INCLUDE:                                        *     00317000
003180* DERVD-LBL-TYP-CDE                                         *     00318000
003190* DELY-ID                                                   *     00319000
003191* PO-SHRT-CYC-IND                                           *     00319100
003192* WHSE-RPLNT-IND                                            *     00319200
003193*************************************************************     00319300
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00319445
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00319644
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00319744
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00319846
003300*************************************************************     00330000
003400 EJECT                                                            00340000
003500 ENVIRONMENT DIVISION.                                            00350000
003600 CONFIGURATION SECTION.                                           00360000
003700 SOURCE-COMPUTER.        IBM-370.                                 00370000
003800 OBJECT-COMPUTER.        IBM-370.                                 00380000
003900                                                                  00390000
004000 INPUT-OUTPUT SECTION.                                            00400000
004100 FILE-CONTROL.                                                    00410000
004200     SELECT TPURCHS-EXTRACT-FILE ASSIGN TO INP01.                 00420000
004300                                                                  00430000
004400 DATA DIVISION.                                                   00440000
004500 FILE SECTION.                                                    00450000
004600 FD  TPURCHS-EXTRACT-FILE                                         00460000
004700     RECORDING MODE IS F                                          00470000
004800     LABEL RECORDS ARE STANDARD                                   00480000
004900     BLOCK CONTAINS 0 RECORDS                                     00490000
005000     RECORD CONTAINS 484 CHARACTERS                               00500000
005100     DATA RECORD IS TPURCHS-EXTRACT-DATA.                         00510000
005300 01  TPURCHS-EXTRACT-DATA       PIC X(484).                       00530000
005400                                                                  00540000
005500                                                                  00550000
005600 EJECT                                                            00560000
005700 WORKING-STORAGE SECTION.                                         00570000
005800                                                                  00580000
005900 01  FILLER                       PIC X(58)     VALUE             00590000
006000     '************WORKING STORAGE STARTS HERE*******************'.00600000
006100                                                                  00610000
006200 01  PV-PROGRAM-VARIABLES.                                        00620000
006300     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP035'. 00630000
006400     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00640000
006500     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00650000
006600     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00660000
006700                                                                  00670000
006800     05  PV-TPURCHS-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00680000
006900                                                COMP-3.           00690000
007000     05  PV-TPURCHS-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00700000
007100                                                COMP-3.           00710000
007200     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00720000
007300                                                COMP-3.           00730000
007400     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00740000
007500                                                COMP-3.           00750000
007600     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00760000
007700     05  PV-DISP-VER-NBR          PIC X(09)    VALUE SPACES.      00770000
007702     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00770200
007703                                               VALUE ZEROES.      00770300
007800 01  PC-PROGRAM-CONSTANTS.                                        00780000
007900     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00790000
008000                                                COMP SYNC.        00800000
008100     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00810000
008200     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00820000
008300     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00830000
008400                                                                  00840000
008500 01  PS-PROGRAM-SWITCHES.                                         00850000
008600     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00860000
008700         88  COMMITS-TAKEN                      VALUE 'T'.        00870000
008800         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00880000
008900     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00890000
009000         88  MORE-EXTRACT                       VALUE 'M'.        00900000
009100         88  END-OF-EXTRACT                     VALUE 'E'.        00910000
009200     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00920000
009300         88  NORMAL-RUN                         VALUE '0'.        00930000
009400         88  RESTART-RUN                        VALUE '9'.        00940000
009500                                                                  00950000
009600 01  WS-COUNTER.                                                  00960000
009700     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     00970000
009800     05  WS-TMST                  PIC X(26)     VALUE SPACES.     00980000
009900                                                                  00990000
010000 01  CKPT-RESTART-INFO.                                           01000000
010100     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01010000
010200                                                                  01020000
010300*----------------------------------------------------------------*01030000
010400*  ABEND DATA AREAS                                              *01040000
010500*----------------------------------------------------------------*01050000
010600 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01060000
010700                                             COMP SYNC.           01070000
010800     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01080000
010900     88  AC-BAD-DATA                         VALUE +4008.         01090000
011000     88  AC-DB2-ERROR                        VALUE +4013.         01100000
011100     88  AC-DATE-ERROR                       VALUE +4019.         01110000
011200                                                                  01120000
011300                                                                  01130000
011400 01  ABEND-AREAS.                                                 01140000
011500     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01150000
011600             '*****       ABEND'.                                 01160000
011700     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01170000
011800             '*****   PROGRAM: AHKUP035'.                         01180000
011900     05  AA-PARAGRAPH-LIT.                                        01190000
012000         10  FILLER              PIC  X(17)  VALUE                01200000
012100             '***** PARAGRAPH: '.                                 01210000
012200         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01220000
012300     05  AA-MESSAGE-LINE-1.                                       01230000
012400         10  FILLER              PIC  X(06)  VALUE '*****'.       01240000
012500         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01250000
012600     05  AA-MESSAGE-LINE-2.                                       01260000
012700         10  FILLER              PIC  X(06)  VALUE '*****'.       01270000
012800         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01280000
012900     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01290000
013000             '*****    DB2 ERROR'.                                01300000
013100     05  AA-DB2-OPERATION-LIT.                                    01310000
013200         10  FILLER              PIC  X(17)  VALUE                01320000
013300             '***** OPERATION: '.                                 01330000
013400         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01340000
013500     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01350000
013600     EJECT                                                        01360000
013700                                                                  01370000
013800     COPY DPWS004.                                                01380000
013900     EJECT                                                        01390000
014000*----------------------------------------------------------------*01400000
014100*      TPURCHS TABLE LAYOUT                                       01410000
014200*----------------------------------------------------------------*01420000
014300         EXEC SQL                                                 01430000
014400             INCLUDE TPURCHS                                      01440000
014500         END-EXEC.                                                01450000
014600                                                                  01460000
014700*----------------------------------------------------------------*01470000
014800*      TCKRSTCNTL TABLE LAYOUT                                    01480000
014900*----------------------------------------------------------------*01490000
015000         EXEC SQL                                                 01500000
015100             INCLUDE TCKRSTCN                                     01510000
015200         END-EXEC.                                                01520000
015300                                                                  01530000
015400*----------------------------------------------------------------*01540000
015500*      TCKRSTINF TABLE LAYOUT                                     01550000
015600*----------------------------------------------------------------*01560000
015700         EXEC SQL                                                 01570000
015800             INCLUDE TCKRSTIN                                     01580000
015900         END-EXEC.                                                01590000
016000 EJECT                                                            01600000
016100*----------------------------------------------------------------*01610000
016200*  DB2 COMMUNICATION AREA                                         01620000
016300*----------------------------------------------------------------*01630000
016400*                                                                 01640000
016500     EXEC SQL                                                     01650000
016600         INCLUDE SQLCA                                            01660000
016700     END-EXEC.                                                    01670000
016800                                                                  01680000
016900*----------------------------------------------------------------*01690000
017000*  DB2 COMMUNICATION AREA2                                        01700000
017100*----------------------------------------------------------------*01710000
017200*                                                                 01720000
017300     COPY SQLCA2.                                                 01730000
017400     EJECT                                                        01740000
017500 PROCEDURE DIVISION.                                              01750000
017600 A100-MAINLINE-ROUTINE.                                           01760000
017700                                                                  01770000
017800     PERFORM B100-INITIALIZATION.                                 01780000
017900                                                                  01790000
018000     PERFORM B200-TPURCHS-EXTRACT-PROCESS                         01800000
018100       UNTIL END-OF-EXTRACT.                                      01810000
018200                                                                  01820000
018300     PERFORM B300-EOJ-PROCESSING.                                 01830000
018400                                                                  01840000
018500     GOBACK.                                                      01850000
018600 EJECT                                                            01860000
018700 B100-INITIALIZATION.                                             01870000
018800                                                                  01880000
018900     EXEC SQL                                                     01890000
019000         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01900000
019100     END-EXEC.                                                    01910000
019200                                                                  01920000
019300     PERFORM X300-GET-CHECKPOINT-CNTL.                            01930000
019400     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01940000
019500                                                                  01950000
019600     OPEN INPUT TPURCHS-EXTRACT-FILE.                             01960000
019700                                                                  01970000
019800     IF RESTART-RUN                                               01980000
019900         PERFORM X200-CHECKPOINT-RESTART                          01990000
020000     ELSE                                                         02000000
020100         PERFORM R100-READ-EXTRACT-FILE                           02010000
020200     END-IF.                                                      02020000
020300                                                                  02030000
020400     PERFORM X500-SET-CHECKPOINT-TIME.                            02040000
020500                                                                  02050000
020600                                                                  02060000
020700     EJECT                                                        02070000
020800 B200-TPURCHS-EXTRACT-PROCESS.                                    02080000
020900                                                                  02090000
021000     MOVE PURCHS-PO-NBR             TO PV-DISP-PO-NBR.            02100000
021100     MOVE PURCHS-VER-NBR            TO PV-DISP-VER-NBR.           02110000
021110     IF PURCHS-PO-NBR NOT = PV-SAVE-PO-NBR                        02111000
021120         MOVE PURCHS-PO-NBR TO PV-SAVE-PO-NBR                     02112000
021140     END-IF.                                                      02114000
021200                                                                  02120000
021300     PERFORM D100-DELETE-TPURCHS.                                 02130043
021400                                                                  02140000
021500     PERFORM X100-CHECKPOINT-CHECK.                               02150000
021600                                                                  02160000
021700     PERFORM R100-READ-EXTRACT-FILE.                              02170000
021800     EJECT                                                        02180000
021900                                                                  02190000
022000                                                                  02200000
022100 B300-EOJ-PROCESSING.                                             02210000
022200                                                                  02220000
022300     DISPLAY '** AHKUP035 SUMMARY **'.                            02230000
022400     DISPLAY '** TPURCHS INPUT COUNT = ' PV-TPURCHS-INPUT-COUNT.  02240000
022500     DISPLAY '** TPURCHS DELETE COUNT = ' PV-TPURCHS-DELETE-COUNT.02250000
022600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02260000
022700                                                                  02270000
022800     CLOSE  TPURCHS-EXTRACT-FILE.                                 02280000
022900                                                                  02290000
023000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02300000
023100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02310000
023200                                                                  02320000
023300     EJECT                                                        02330000
023449                                                                  02344939
023450*----------------------------------------------------------------*02345039
023500*    DELETES FROM THE TPURCHS TABLE.  CASCADE DELETE WILL ALSO   *02350000
023600*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *02360000
023700*    TABLES.                                                     *02370000
023800*----------------------------------------------------------------*02380000
023900 D100-DELETE-TPURCHS.                                             02390000
024000                                                                  02400000
024100     MOVE 'D100-DELETE-TPURCHS' TO PV-CURRENT-PARAGRAPH.          02410000
024200                                                                  02420000
024300     PERFORM WITH TEST AFTER                                      02430000
024400        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02440000
024500          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02450000
024501             OR SQLCODE = ZERO                                    02450100
024502                                                                  02450200
024800         EXEC SQL                                                 02480000
024900              DELETE                                              02490000
025000                FROM TPURCHS                                      02500000
025100               WHERE PO_NBR  = :PURCHS-PO-NBR                     02510000
025200                 AND VER_NBR = :PURCHS-VER-NBR                    02520000
025300         END-EXEC                                                 02530000
025400                                                                  02540000
025500         EVALUATE TRUE                                            02550000
025600             WHEN SQLCODE = ZERO                                  02560000
025700                 ADD 1 TO PV-TPURCHS-DELETE-COUNT                 02570000
025800                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02580000
025900                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02590000
026000                                                                  02600000
026100             WHEN SQLCODE = -904                                  02610000
026200             WHEN SQLCODE = -913                                  02620000
026210             WHEN SQLCODE = +100                                  02621000
026300                  CONTINUE                                        02630000
026400                                                                  02640000
027900             WHEN SQLWARN0 NOT = SPACES                           02790000
028000             WHEN SQLCODE  NOT = ZERO                             02800000
028100                 MOVE PV-CURRENT-PARAGRAPH                        02810000
028200                                     TO AA-PARAGRAPH-NAME         02820000
028300                 DISPLAY '******** PO NUMBER:'                    02830000
028400                          PV-DISP-PO-NBR                          02840000
028500                 DISPLAY '******** PO VER NBR:'                   02850000
028600                          PV-DISP-VER-NBR                         02860000
028700                 MOVE SPACES TO AA-MESSAGE-1                      02870000
028800                                AA-MESSAGE-2                      02880000
028900                 MOVE 'UNSUCCESSFUL DELETE'                       02890000
029000                                     TO AA-DB2-OPERATION          02900000
029100                 MOVE 'TPURCHS'      TO AA-DB2-TABLE              02910000
029200                 PERFORM Z999-DB2-ABEND                           02920000
029300         END-EVALUATE                                             02930000
029400     END-PERFORM.                                                 02940000
029500                                                                  02950000
029600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             02960000
029700         MOVE PV-CURRENT-PARAGRAPH                                02970000
029800                             TO AA-PARAGRAPH-NAME                 02980000
029900         DISPLAY '******** PO NUMBER:'                            02990000
030000                          PV-DISP-PO-NBR                          03000000
030100         DISPLAY '******** PO VER NBR :'                          03010000
030200                          PV-DISP-VER-NBR                         03020000
030300         MOVE SPACES TO AA-MESSAGE-1                              03030000
030400                        AA-MESSAGE-2                              03040000
030500         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03050000
030600                             TO AA-DB2-OPERATION                  03060000
030700         MOVE 'TPURCHS'      TO AA-DB2-TABLE                      03070000
030800         PERFORM Z999-DB2-ABEND                                   03080000
030900     END-IF.                                                      03090000
031000*                                                                 03100000
031100     EJECT                                                        03110000
031200 R100-READ-EXTRACT-FILE.                                          03120000
031300                                                                  03130000
031400     READ TPURCHS-EXTRACT-FILE                                    03140000
031500          INTO DCLTPURCHS                                         03150000
031600          AT END SET END-OF-EXTRACT TO TRUE.                      03160000
031700                                                                  03170000
031800     IF MORE-EXTRACT                                              03180000
031900         ADD 1 TO PV-TPURCHS-INPUT-COUNT                          03190000
032000     END-IF.                                                      03200000
032100                                                                  03210000
032200                                                                  03220000
032300     EJECT                                                        03230000
032400*----------------------------------------------------------------*03240000
032500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03250000
032600*----------------------------------------------------------------*03260000
032700 X100-CHECKPOINT-CHECK.                                           03270000
032800                                                                  03280000
032900     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03290000
033000                                                                  03300000
033100     EXEC SQL                                                     03310000
033200       SET :WS-TMST = CURRENT TIMESTAMP                           03320000
033300     END-EXEC.                                                    03330000
033400                                                                  03340000
033500     IF SQLCODE = +0                                              03350000
033600         CONTINUE                                                 03360000
033700     ELSE                                                         03370000
033800         MOVE PV-CURRENT-PARAGRAPH                                03380000
033900                             TO AA-PARAGRAPH-NAME                 03390000
034000         MOVE SPACES TO AA-MESSAGE-1                              03400000
034100                        AA-MESSAGE-2                              03410000
034200         MOVE 'BAD SET COMMAND'                                   03420000
034300                             TO AA-DB2-OPERATION                  03430000
034400         MOVE SPACES             TO AA-DB2-TABLE                  03440000
034500         PERFORM Z999-DB2-ABEND                                   03450000
034600     END-IF.                                                      03460000
034700                                                                  03470000
034800     IF WS-TMST > WS-HOLD-TMST                                    03480000
034900         IF NO-COMMITS-TAKEN                                      03490000
035000             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03500000
035100             PERFORM X600-UPDATE-TCKRSTCNTL                       03510000
035200             SET COMMITS-TAKEN TO TRUE                            03520000
035300         END-IF                                                   03530000
035400         PERFORM X700-UPDATE-TCKRSTINF                            03540000
035500         PERFORM Y100-COMMIT                                      03550000
035600         PERFORM X500-SET-CHECKPOINT-TIME                         03560000
035700     END-IF.                                                      03570000
035800                                                                  03580000
035900 EJECT                                                            03590000
036000*----------------------------------------------------------------*03600000
036100*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03610000
036200*----------------------------------------------------------------*03620000
036300 X200-CHECKPOINT-RESTART.                                         03630000
036400                                                                  03640000
036500     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03650000
036600                                                                  03660000
036700     PERFORM X400-GET-CHECKPOINT-INFO.                            03670000
036800     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03680000
036900                                                                  03690000
037000     DISPLAY '** AHKUP035 CHECKPOINT RESTART **'                  03700000
037100     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03710000
037200              CR-EXTRACT-RECS-WORKED.                             03720000
037300     DISPLAY '***********************************************'    03730000
037400                                                                  03740000
037500     PERFORM R100-READ-EXTRACT-FILE                               03750000
037600         CR-EXTRACT-RECS-WORKED TIMES.                            03760000
037700     PERFORM R100-READ-EXTRACT-FILE.                              03770000
037800 EJECT                                                            03780000
037900*----------------------------------------------------------------*03790000
038000*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *03800000
038100*----------------------------------------------------------------*03810000
038200 X300-GET-CHECKPOINT-CNTL.                                        03820000
038300                                                                  03830000
038400     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     03840000
038500                                                                  03850000
038600     PERFORM WITH TEST AFTER                                      03860000
038700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   03870000
038800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             03880000
038900                     SQLCODE = ZERO                               03890000
039000                                                                  03900000
039100             EXEC SQL                                             03910000
039200              SELECT CKPT_STAT_CODE                               03920000
039300               INTO :PV-CKPT-STAT-CODE                            03930000
039400               FROM TCKRSTCNTL                                    03940000
039500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 03950000
039600             END-EXEC                                             03960000
039700                                                                  03970000
039800             EVALUATE TRUE                                        03980000
039900                 WHEN SQLCODE = ZERO                              03990000
040000                 WHEN SQLCODE = -904                              04000000
040100                 WHEN SQLCODE = -913                              04010000
040200                      CONTINUE                                    04020000
040300                                                                  04030000
040400                 WHEN SQLWARN0 NOT = SPACES                       04040000
040500                 WHEN SQLCODE  NOT = ZERO                         04050000
040600                     MOVE PV-CURRENT-PARAGRAPH                    04060000
040700                                         TO AA-PARAGRAPH-NAME     04070000
040800                     DISPLAY '******** PLAN_NAME:'                04080000
040900                              PV-PROGRAM-NAME                     04090000
041000                     MOVE SPACES TO AA-MESSAGE-1                  04100000
041100                                    AA-MESSAGE-2                  04110000
041200                     MOVE 'UNSUCCESSFUL SELECT'                   04120000
041300                                         TO AA-DB2-OPERATION      04130000
041400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04140000
041500                     PERFORM Z999-DB2-ABEND                       04150000
041600             END-EVALUATE                                         04160000
041700     END-PERFORM.                                                 04170000
041800                                                                  04180000
041900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04190000
042000         MOVE PV-CURRENT-PARAGRAPH                                04200000
042100                             TO AA-PARAGRAPH-NAME                 04210000
042200         DISPLAY '******** PLAN_NAME:'                            04220000
042300                  PV-PROGRAM-NAME                                 04230000
042400         MOVE SPACES TO AA-MESSAGE-1                              04240000
042500                        AA-MESSAGE-2                              04250000
042600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04260000
042700                             TO AA-DB2-OPERATION                  04270000
042800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04280000
042900         PERFORM Z999-DB2-ABEND                                   04290000
043000     END-IF.                                                      04300000
043100                                                                  04310000
043200 EJECT                                                            04320000
043300*----------------------------------------------------------------*04330000
043400*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04340000
043500*----------------------------------------------------------------*04350000
043600 X400-GET-CHECKPOINT-INFO.                                        04360000
043700                                                                  04370000
043800     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04380000
043900                                                                  04390000
044000     PERFORM WITH TEST AFTER                                      04400000
044100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04410000
044200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04420000
044300                     SQLCODE = ZERO                               04430000
044400                                                                  04440000
044500             EXEC SQL                                             04450000
044600              SELECT WORK_STRG_DESC                               04460000
044700               INTO :TCKRSTINF-WORK-STRG-DESC                     04470000
044800               FROM TCKRSTINF                                     04480000
044900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04490000
045000             END-EXEC                                             04500000
045100                                                                  04510000
045200             EVALUATE TRUE                                        04520000
045300                 WHEN SQLCODE = ZERO                              04530000
045400                 WHEN SQLCODE = -904                              04540000
045500                 WHEN SQLCODE = -913                              04550000
045600                      CONTINUE                                    04560000
045700                                                                  04570000
045800                 WHEN SQLWARN0 NOT = SPACES                       04580000
045900                 WHEN SQLCODE  NOT = ZERO                         04590000
046000                     MOVE PV-CURRENT-PARAGRAPH                    04600000
046100                                         TO AA-PARAGRAPH-NAME     04610000
046200                     DISPLAY '******** PLAN_NAME:'                04620000
046300                              PV-PROGRAM-NAME                     04630000
046400                     MOVE SPACES TO AA-MESSAGE-1                  04640000
046500                                    AA-MESSAGE-2                  04650000
046600                     MOVE 'UNSUCCESSFUL SELECT'                   04660000
046700                                         TO AA-DB2-OPERATION      04670000
046800                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04680000
046900                     PERFORM Z999-DB2-ABEND                       04690000
047000             END-EVALUATE                                         04700000
047100     END-PERFORM.                                                 04710000
047200                                                                  04720000
047300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04730000
047400         MOVE PV-CURRENT-PARAGRAPH                                04740000
047500                             TO AA-PARAGRAPH-NAME                 04750000
047600         DISPLAY '******** PLAN_NAME:'                            04760000
047700                  PV-PROGRAM-NAME                                 04770000
047800         MOVE SPACES TO AA-MESSAGE-1                              04780000
047900                        AA-MESSAGE-2                              04790000
048000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04800000
048100                             TO AA-DB2-OPERATION                  04810000
048200         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      04820000
048300         PERFORM Z999-DB2-ABEND                                   04830000
048400     END-IF.                                                      04840000
048500                                                                  04850000
048600 EJECT                                                            04860000
048700*----------------------------------------------------------------*04870000
048800*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *04880000
048900*----------------------------------------------------------------*04890000
049000 X500-SET-CHECKPOINT-TIME.                                        04900000
049100                                                                  04910000
049200     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     04920000
049300                                                                  04930000
049400     PERFORM WITH TEST AFTER                                      04940000
049500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04950000
049600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04960000
049700                     SQLCODE = ZERO                               04970000
049800                                                                  04980000
049900             EXEC SQL                                             04990000
050000              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05000000
050100               INTO :WS-HOLD-TMST                                 05010000
050200               FROM TCKRSTCNTL                                    05020000
050300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05030000
050400             END-EXEC                                             05040000
050500                                                                  05050000
050600             EVALUATE TRUE                                        05060000
050700                 WHEN SQLCODE = ZERO                              05070000
050800                 WHEN SQLCODE = -904                              05080000
050900                 WHEN SQLCODE = -913                              05090000
051000                      CONTINUE                                    05100000
051100                                                                  05110000
051200                 WHEN SQLWARN0 NOT = SPACES                       05120000
051300                 WHEN SQLCODE  NOT = ZERO                         05130000
051400                     MOVE PV-CURRENT-PARAGRAPH                    05140000
051500                                         TO AA-PARAGRAPH-NAME     05150000
051600                     DISPLAY '******** PLAN_NAME:'                05160000
051700                              PV-PROGRAM-NAME                     05170000
051800                     MOVE SPACES TO AA-MESSAGE-1                  05180000
051900                                    AA-MESSAGE-2                  05190000
052000                     MOVE 'UNSUCCESSFUL SELECT'                   05200000
052100                                         TO AA-DB2-OPERATION      05210000
052200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05220000
052300                     PERFORM Z999-DB2-ABEND                       05230000
052400             END-EVALUATE                                         05240000
052500     END-PERFORM.                                                 05250000
052600                                                                  05260000
052700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05270000
052800         MOVE PV-CURRENT-PARAGRAPH                                05280000
052900                             TO AA-PARAGRAPH-NAME                 05290000
053000         DISPLAY '******** PLAN_NAME:'                            05300000
053100                  PV-PROGRAM-NAME                                 05310000
053200         MOVE SPACES TO AA-MESSAGE-1                              05320000
053300                        AA-MESSAGE-2                              05330000
053400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05340000
053500                             TO AA-DB2-OPERATION                  05350000
053600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05360000
053700         PERFORM Z999-DB2-ABEND                                   05370000
053800     END-IF.                                                      05380000
053900                                                                  05390000
054000 EJECT                                                            05400000
054100*----------------------------------------------------------------*05410000
054200*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05420000
054300*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05430000
054400*----------------------------------------------------------------*05440000
054500 X600-UPDATE-TCKRSTCNTL.                                          05450000
054600                                                                  05460000
054700     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05470000
054800                                                                  05480000
054900     PERFORM WITH TEST AFTER                                      05490000
055000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05500000
055100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05510000
055200                     SQLCODE = ZERO                               05520000
055300                                                                  05530000
055400             EXEC SQL                                             05540000
055500                 UPDATE TCKRSTCNTL                                05550000
055600                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05560000
055700                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05570000
055800             END-EXEC                                             05580000
055900                                                                  05590000
056000             EVALUATE TRUE                                        05600000
056100                 WHEN SQLCODE = ZERO                              05610000
056200                 WHEN SQLCODE = -904                              05620000
056300                 WHEN SQLCODE = -913                              05630000
056400                      CONTINUE                                    05640000
056500                                                                  05650000
056600                 WHEN SQLWARN0 NOT = SPACES                       05660000
056700                 WHEN SQLCODE  NOT = ZERO                         05670000
056800                     MOVE PV-CURRENT-PARAGRAPH                    05680000
056900                                         TO AA-PARAGRAPH-NAME     05690000
057000                     DISPLAY '******** PLAN_NAME:'                05700000
057100                              PV-PROGRAM-NAME                     05710000
057200                     MOVE SPACES TO AA-MESSAGE-1                  05720000
057300                                    AA-MESSAGE-2                  05730000
057400                     MOVE 'UNSUCCESSFUL UPDATE'                   05740000
057500                                         TO AA-DB2-OPERATION      05750000
057600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05760000
057700                     PERFORM Z999-DB2-ABEND                       05770000
057800             END-EVALUATE                                         05780000
057900     END-PERFORM.                                                 05790000
058000                                                                  05800000
058100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05810000
058200         MOVE PV-CURRENT-PARAGRAPH                                05820000
058300                             TO AA-PARAGRAPH-NAME                 05830000
058400         DISPLAY '******** PLAN_NAME:'                            05840000
058500                  PV-PROGRAM-NAME                                 05850000
058600         MOVE SPACES TO AA-MESSAGE-1                              05860000
058700                        AA-MESSAGE-2                              05870000
058800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    05880000
058900                             TO AA-DB2-OPERATION                  05890000
059000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05900000
059100         PERFORM Z999-DB2-ABEND                                   05910000
059200     END-IF.                                                      05920000
059300                                                                  05930000
059400     EJECT                                                        05940000
059500*----------------------------------------------------------------*05950000
059600*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *05960000
059700*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *05970000
059800*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *05980000
059900*----------------------------------------------------------------*05990000
060000 X700-UPDATE-TCKRSTINF.                                           06000000
060100                                                                  06010000
060200     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06020000
060300                                                                  06030000
060400     MOVE PV-TPURCHS-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06040000
060500     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06050000
060600     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06060000
060700                                                                  06070000
060800     PERFORM WITH TEST AFTER                                      06080000
060900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06090000
061000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06100000
061100                     SQLCODE = ZERO                               06110000
061200                                                                  06120000
061300             EXEC SQL                                             06130000
061400                 UPDATE TCKRSTINF                                 06140000
061500                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06150000
061600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06160000
061700             END-EXEC                                             06170000
061800                                                                  06180000
061900             EVALUATE TRUE                                        06190000
062000                 WHEN SQLCODE = ZERO                              06200000
062100                 WHEN SQLCODE = -904                              06210000
062200                 WHEN SQLCODE = -913                              06220000
062300                      CONTINUE                                    06230000
062400                                                                  06240000
062500                 WHEN SQLWARN0 NOT = SPACES                       06250000
062600                 WHEN SQLCODE  NOT = ZERO                         06260000
062700                     MOVE PV-CURRENT-PARAGRAPH                    06270000
062800                                         TO AA-PARAGRAPH-NAME     06280000
062900                     DISPLAY '******** PLAN_NAME:'                06290000
063000                              PV-PROGRAM-NAME                     06300000
063100                     MOVE SPACES TO AA-MESSAGE-1                  06310000
063200                                    AA-MESSAGE-2                  06320000
063300                     MOVE 'UNSUCCESSFUL UPDATE'                   06330000
063400                                         TO AA-DB2-OPERATION      06340000
063500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06350000
063600                     PERFORM Z999-DB2-ABEND                       06360000
063700             END-EVALUATE                                         06370000
063800     END-PERFORM.                                                 06380000
063900                                                                  06390000
064000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06400000
064100         MOVE PV-CURRENT-PARAGRAPH                                06410000
064200                             TO AA-PARAGRAPH-NAME                 06420000
064300         DISPLAY '******** PLAN_NAME:'                            06430000
064400                  PV-PROGRAM-NAME                                 06440000
064500         MOVE SPACES TO AA-MESSAGE-1                              06450000
064600                        AA-MESSAGE-2                              06460000
064700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06470000
064800                             TO AA-DB2-OPERATION                  06480000
064900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06490000
065000         PERFORM Z999-DB2-ABEND                                   06500000
065100     END-IF.                                                      06510000
065200                                                                  06520000
065300 EJECT                                                            06530000
065400                                                                  06540000
065500*----------------------------------------------------------------*06550000
065600*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06560000
065700*----------------------------------------------------------------*06570000
065800 Y100-COMMIT.                                                     06580000
065900                                                                  06590000
066000     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06600000
066100                                                                  06610000
066200     EXEC SQL                                                     06620000
066300         COMMIT                                                   06630000
066400     END-EXEC.                                                    06640000
066500                                                                  06650000
066600     EVALUATE TRUE                                                06660000
066700         WHEN SQLCODE = ZEROS                                     06670000
066800             CONTINUE                                             06680000
066900         WHEN OTHER                                               06690000
067000             MOVE PV-CURRENT-PARAGRAPH                            06700000
067100                                 TO AA-PARAGRAPH-NAME             06710000
067200             MOVE SPACES TO AA-MESSAGE-1                          06720000
067300                            AA-MESSAGE-2                          06730000
067400             MOVE 'UNSUCCESSFUL COMMIT'                           06740000
067500                                 TO AA-DB2-OPERATION              06750000
067600             MOVE SPACES         TO AA-DB2-TABLE                  06760000
067700             PERFORM Z999-DB2-ABEND                               06770000
067800     END-EVALUATE.                                                06780000
067900 EJECT                                                            06790000
069100                                                                  06910000
069200 Z999-DB2-ABEND.                                                  06920000
069300                                                                  06930000
069400     DISPLAY AA-ABEND-LIT.                                        06940000
069500     DISPLAY AA-DB2-ERROR-LIT.                                    06950000
069600     DISPLAY AA-PROGRAM-LIT.                                      06960000
069700     DISPLAY AA-PARAGRAPH-LIT.                                    06970000
069800     DISPLAY AA-DB2-OPERATION-LIT.                                06980000
069900     DISPLAY AA-DB2-TABLE.                                        06990000
070000     SET AC-DB2-ERROR TO TRUE.                                    07000000
070100                                                                  07010000
070200     COPY DPPD004.                                                07020000
070300                                                                  07030000
070400     CALL 'ILBOABN0' USING ABEND-CODE.                            07040000
