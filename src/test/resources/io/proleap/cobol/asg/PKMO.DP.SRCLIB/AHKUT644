000100 IDENTIFICATION DIVISION.                                         00010002
000200 PROGRAM-ID.    AHKUT644.                                         00020002
000300 AUTHOR.        BUDDY BARNES.                                     00030002
000400 INSTALLATION.  KOHLS.                                            00040002
000500 DATE-WRITTEN   JUN, 2011.                                        00050002
000600 DATE-COMPILED.                                                   00060002
000700                                                                  00070002
000800******************************************************************00080002
000900*  AHKUT644.   "ARCHIVE HISTORY" PROJECT. DATA OFFLOAD.          *00090002
001000*                                                                *00100002
001000*                                                                *00101002
001100*  PURPOSE:                                                      *00102002
001200*  THIS PROGRAM EXTRACTS ELIGIBLE ROWS BASED ON LAST_AUD_TMST ON *00103002
001300*  TIMCSEN IN ORDER TO CREATE AN ARCHIVE FILE OF TIMCSEN         *00104002
001300*  WHICH WILL THEN BE USED TO DELETE ROWS FROM TIMCSEN           *00105002
001600*                                                                *00106002
001700*  PROCESSING OVERVIEW:                                          *00107002
001800*  THIS PROGRAM ACCESSES TIMCSEN AND BASED ON A CONTROL CARD DATE*00108002
001900*  APPLIES SELECTION CRITERIA, CREATING AN OUTPUT FILE OF        *00109002
002100*  1) THE FULL ROW OF DATA FROM TIMCSEN                          *00110002
002400*                                                                *00120002
002500*  FOR EACH CSTM ID RETURNED THE FULL ROW OF DATA IS WRITTEN     *00130002
002600*  TO THE EXTRACT FILE TO BE USED FOR ARCHIVING AND DELETING.    *00140002
003000******************************************************************00150002
006020******************************************************************00160002
006030 ENVIRONMENT DIVISION.                                            00170002
006040 CONFIGURATION SECTION.                                           00180002
006050 SOURCE-COMPUTER.        IBM-3090.                                00190002
006060 OBJECT-COMPUTER.        IBM-3090.                                00200002
006070                                                                  00210002
006080 INPUT-OUTPUT SECTION.                                            00220002
006090 FILE-CONTROL.                                                    00230002
006100                                                                  00240002
006200     SELECT  OUT-ARCHIVE-FILE             ASSIGN TO OUT01.        00250002
006300                                                                  00260002
006400 DATA DIVISION.                                                   00270002
006500 FILE SECTION.                                                    00280002
006600                                                                  00290002
006700 FD  OUT-ARCHIVE-FILE                                             00300002
006800     RECORDING MODE IS F                                          00310002
006900     LABEL RECORDS ARE STANDARD                                   00320002
007000     BLOCK CONTAINS 0 RECORDS.                                    00330002
007100 01  OUT-ARCHIVE-RECORD              PIC  X(352).                 00340004
007200                                                                  00350002
007300 WORKING-STORAGE SECTION.                                         00360002
007400                                                                  00370002
007500 01  PC-PROGRAM-CONSTANTS.                                        00380002
007600     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT644'.  00390002
007700     05  PC-PGM-PROGRESS-DESC.                                    00400002
007800         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00410002
007800         10  PC-CONTINUING           PIC X(10) VALUE 'CONTINUING'.00420002
008500         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00430002
008600         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00440002
008700     05  PC-ABEND-INFO.                                           00450002
008800         10  PC-ABEND                PIC X(11) VALUE              00460002
008900                                               '** ABEND **'.     00470002
009000         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00480002
009100                                               '- PARA       : '. 00490002
009200         10  PC-ABEND-MSG-DISPLAY-PARA                            00500002
009300                                     PIC X(15) VALUE              00510002
009400                                               '  CALLED PARA: '. 00520002
009500         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00530002
009600                                               '  FOR ABEND# : '. 00540002
009700         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00550002
009800                                               '- ERROR IS   : '. 00560002
009900         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00570002
010000         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00580002
010100                                               '- ACTION     : '. 00590002
010200     05  PC-TEST-AND-SET-NULL-IND.                                00600002
010300         10  PC-NOT-NULL             PIC S9(4) COMP               00610002
010400                                               VALUE ZERO.        00620002
010500         10  PC-NULL                 PIC S9(4) COMP               00630002
010600                                               VALUE -1.          00640002
010700         10  PC-NULL-CONV-ERR        PIC S9(4) COMP               00650002
010800                                               VALUE -2.          00660002
010900         10  PC-NULLIF-QUESTION-MARK PIC X(01) VALUE '?'.         00670002
011000                                                                  00680002
011100     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 010000.      00690002
011200                                                                  00700002
011300 01  PS-PROGRAM-SWITCHES.                                         00710002
011400     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         00720002
011500         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         00730002
011600         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         00740002
012000                                                                  00750002
012100 01  PV-PROGRAM-VARIABLES.                                        00760002
012400     05  DISPLAY-CSTM-ENTR-ID        PIC  X(12) VALUE SPACES.     00770002
013600     05  PV-FUNC-QTY                  PIC S9(09) COMP.            00780002
012500     05  PV-PRG-TMST                 PIC X(26) VALUE SPACES.      00790002
012600     05  PV-PRG-TMST-DETAIL REDEFINES PV-PRG-TMST.                00800002
012700         10  PV-PRG-DATE             PIC X(10).                   00810002
012800         10  PV-PRG-TIME             PIC X(16).                   00820002
013000     05  PV-TABLE-ROW-FETCHED-CNT    PIC  9(9) VALUE 0.           00830002
013100     05  PV-ARCHIVE-WRITTEN-CNT       PIC  9(9) VALUE 0.          00840002
013800     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      00850002
013900     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      00860002
014000     05  PV-DB2-TABLE-NAME-1         PIC X(18) VALUE SPACES.      00870002
014100     05  PV-DB2-TABLE-NAME-2         PIC X(18) VALUE SPACES.      00871002
014200     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           00872002
014300     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           00873002
014400     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        00874002
014500                                                                  00875002
014600     05  PV-TMST                     PIC X(26) VALUE SPACES.      00876002
014700     05  PV-TIMESTAMP-DETAIL                                      00877002
014800         REDEFINES                                                00878002
014900         PV-TMST.                                                 00879002
015000         10  PV-TIMESTAMP-19.                                     00880002
015100             15  PV-TMS-DATE.                                     00890002
015200                 20  PV-TMS-YEAR.                                 00900002
015300                     25  PV-TMS-CC   PIC X(02).                   00910002
015400                     25  PV-TMS-YY   PIC X(02).                   00920002
015500                 20  FILLER          PIC X(01).                   00930002
015600                 20  PV-TMS-MONTH    PIC X(02).                   00940002
015700                 20  FILLER          PIC X(01).                   00941002
015800                 20  PV-TMS-DAY      PIC X(02).                   00942002
015900             15  FILLER              PIC X(01).                   00943002
016000             15  PV-TMS-HOUR         PIC X(02).                   00944002
016100             15  FILLER              PIC X(01).                   00945002
016200             15  PV-TMS-MINUTE       PIC X(02).                   00946002
016300             15  FILLER              PIC X(01).                   00947002
016400             15  PV-TMS-SECOND       PIC X(02).                   00948002
016500         10  FILLER                  PIC X(01).                   00949002
016600         10  PV-TMS-MSECOND          PIC X(06).                   00949102
014500                                                                  00949202
018200*---------------------------------------------------------------* 00949302
018300*  RECORD LAYOUT FOR ARCHIVE FILE.                              * 00949402
018400*---------------------------------------------------------------* 00949502
018500     COPY AHRD015.                                                00949602
018700                                                                  00949702
018800 01  DM-DISPLAY-MESSAGE.                                          00949802
018900     05  DM-01-10.                                                00949902
019000         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       00950002
019100         10  FILLER                  PIC X(02) VALUE ': '.        00960002
019200     05  DM-11-80.                                                00970002
019300         10  FILLER                  PIC X(27) VALUE              00980002
019400                                    'BEGIN ARCHIV FILE CREATION.'.00990002
019500         10  FILLER                  PIC X(01) VALUE SPACE.       01000002
019600         10  FILLER                  PIC X(42) VALUE ALL '*'.     01010002
019700     05  DM-81-120.                                               01020002
019800         10  FILLER                  PIC X(40) VALUE ALL '*'.     01030002
019900                                                                  01040002
020000 01  DP-DISPLAY-PROGRESS-MSG.                                     01050002
020100     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01060002
020200     05  FILLER                      PIC X(02) VALUE SPACE.       01070002
020300     05  DP-STATUS-DESCRIPTION       PIC X(13) VALUE SPACE.       01080002
020400     05  FILLER                      PIC X(04) VALUE ' AT '.      01090002
020500     05  DP-TIMESTAMP                PIC X(26) VALUE SPACE.       01100002
020600     05  FILLER                      PIC X(03) VALUE '.  '.       01110002
020700     05  FILLER                      PIC X(09) VALUE 'FETCHES: '. 01120002
020800     05  DP-TABLE-ROW-FETCHED-CNT    PIC ZZZ,ZZZ,ZZ9              01130002
020900                                               VALUE ZERO.        01140002
021000     05  FILLER                      PIC X(02) VALUE ', '.        01150002
021100     05  FILLER                      PIC X(09) VALUE 'WRITTEN: '. 01160002
021200     05  DP-ARCHIVE-WRITTEN-CNT       PIC ZZZ,ZZZ,ZZ9             01170002
021300                                               VALUE ZERO.        01180002
021400     05  FILLER                      PIC X(01) VALUE '.'.         01190002
021500                                                                  01200002
021600 01  ABEND-CODE                      PIC S9(04)                   01210002
021700                                               VALUE ZEROES       01220002
021800                                               COMP SYNC.         01230002
021900                                                                  01240002
022000*---------------------------------------------------------------* 01250002
022100*  DB2 FORMATTED MESSAGE AREA                                     01260002
022200*---------------------------------------------------------------* 01270002
022300     COPY DPWS004.                                                01280002
022400                                                                  01290002
022500*---------------------------------------------------------------* 01300002
022600*    DB2 AREA FOR TIMCSEN                                       * 01310002
022700*---------------------------------------------------------------* 01320002
022800     EXEC SQL                                                     01330002
022900          INCLUDE TIMCSEN                                         01340002
023000     END-EXEC.                                                    01350002
023100                                                                  01360002
022500*---------------------------------------------------------------* 01370002
022600*    DB2 AREA FOR TKRPRPM                                       * 01380002
022700*---------------------------------------------------------------* 01390002
022800     EXEC SQL                                                     01400002
022900          INCLUDE TKRPRPM                                         01410002
023000     END-EXEC.                                                    01420002
023100                                                                  01430002
023200*---------------------------------------------------------------* 01440002
023300*    DB2 AREA FOR SYSDUMMY                                      * 01450002
023400*---------------------------------------------------------------* 01460002
023500     EXEC SQL                                                     01470002
023600          INCLUDE SYSDUMMY                                        01480002
023700     END-EXEC.                                                    01490002
023800                                                                  01500002
023900*---------------------------------------------------------------* 01510002
024000*    DB2 AREA FOR COMMUNICATIONS                                * 01520002
024100*---------------------------------------------------------------* 01530002
024200     EXEC SQL                                                     01540002
024300          INCLUDE SQLCA                                           01550002
024400     END-EXEC.                                                    01560002
024500                                                                  01570002
024600*---------------------------------------------------------------* 01580002
024700*    DEFINE CURSOR FOR ACCESSING TIMCSEN                        * 01590002
024800*---------------------------------------------------------------* 01600002
024900     EXEC SQL                                                     01610002
025000         DECLARE TABLE-CURSOR CURSOR FOR                          01620002
025100           SELECT                                                 01630002
025200              CSTM_ENTR_ID                                        01640002
025300             ,ENT_ID                                              01650002
025400             ,BKR_REF_NBR                                         01660002
025500             ,FILD_TMST                                           01670002
025600             ,EST_CLR_TMST                                        01680002
025700             ,ACTL_CLR_TMST                                       01690002
025800             ,EXM_TMST                                            01700002
025800             ,REJ_TMST                                            01710002
025800             ,REJ_DESC                                            01720002
025800             ,LQDN_TMST                                           01730002
025800             ,LQDN_SSPNN_TMST                                     01740002
025800             ,LQDN_SSPNN_DESC                                     01750002
025800             ,DAT_SRC_ENT_ID                                      01760002
025800             ,CRE_BY_USR_ID                                       01761002
025800             ,CRE_TMST                                            01762002
025800             ,LAST_UPD_BY_USR_ID                                  01763002
025800             ,LAST_UPD_TMST                                       01764002
025800             ,MOM_DEST_POE_CDE                                    01765002
025800             ,MOM_TRIP_TYP_CDE                                    01765102
025800             ,ENTR_TYP_CDE                                        01765202
027900             FROM TIMCSEN                                         01765302
028100            WHERE LAST_UPD_TMST <=                                01765402
028100                    CURRENT TIMESTAMP - :PV-FUNC-QTY DAYS         01765502
028500         FOR FETCH ONLY                                           01765602
028600         WITH UR                                                  01765702
028700         OPTIMIZE FOR 1 ROW                                       01765802
028800     END-EXEC.                                                    01765902
029000                                                                  01766002
029100 PROCEDURE DIVISION.                                              01767002
029200                                                                  01768002
029300 0000-PROGRAM-MAINLINE.                                           01769002
029400                                                                  01770002
029500     PERFORM 1000-INITIALIZE.                                     01780002
029600                                                                  01790002
029700     PERFORM 2000-GET-NEXT-FROM-CURSOR                            01800002
029800         UNTIL PS-TABLE-LOOP-DONE.                                01810002
029900                                                                  01820002
030000     PERFORM 6000-EOJ-ROUTINE.                                    01830002
030100     STOP RUN.                                                    01840002
030200                                                                  01850002
030400******************************************************************01860002
030500*  INITIALIZATIONS                                               *01870002
030600******************************************************************01880002
030700 1000-INITIALIZE.                                                 01890002
030800                                                                  01900002
030900     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  01910002
031000     DISPLAY DM-DISPLAY-MESSAGE.                                  01920002
031400                                                                  01930002
031500     OPEN OUTPUT OUT-ARCHIVE-FILE.                                01940002
031600                                                                  01950002
328000     EXEC SQL                                                     01960002
328100         SELECT FUNC_QTY                                          01970002
328200           INTO   :PV-FUNC-QTY                                    01980002
328300           FROM   TKRPRPM                                         01990002
328400          WHERE LOC_ID           = 90                             02000002
328500            AND INTFC_SYS_CDE    = 'KHL'                          02010002
328600            AND SYS_PRC_FUNC_CDE = 'TRPGDY'                       02020002
328700            AND FUNC_PRC_STAT_CDE = 'AC'                          02021002
328800     END-EXEC.                                                    02022002
328900                                                                  02023002
329000     EVALUATE TRUE                                                02024002
329100         WHEN SQLCODE = +0                                        02025002
329200             CONTINUE                                             02026002
329300         WHEN OTHER                                               02027002
051900              MOVE '1000-INITIALIZE'                              02028002
052000                                 TO PV-PARAGRAPH-NAME             02029002
052100              MOVE 'SELECT FROM TABLE '                           02029102
052200                                 TO PV-DB2-OPERATION-MSG-1        02029202
052300              MOVE 'TKRPRPM'     TO PV-DB2-TABLE-NAME-1           02029302
052400              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           02029402
052500              PERFORM 9999-DB2-ABEND                              02029502
329900     END-EVALUATE.                                                02029602
328900                                                                  02029702
031200     MOVE PC-BEGINNING            TO DP-STATUS-DESCRIPTION.       02029802
033600     DISPLAY 'PURGE USING CURRENT TIMESTAMP - ' DP-TIMESTAMP      02029902
033600     DISPLAY 'MINUS - ' PV-FUNC-QTY ' DAYS'                       02030002
032500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02040002
032600     SET PS-TABLE-LOOP-NOT-DONE TO TRUE.                          02041002
032700     PERFORM 9100-OPEN-TABLE-CURSOR.                              02042002
033800                                                                  02043002
033100     INITIALIZE DCLTIMCSEN                                        02044002
033200                AH015-ARCHIVE-RECORD-LAYOUT.                      02045002
033300     PERFORM 9110-FETCH-TABLE-CURSOR.                             02046002
033400                                                                  02047002
033500     IF PS-TABLE-LOOP-DONE                                        02048002
033600         DISPLAY 'NO CUSTOMS ENTRY IDS SELECTED FROM CURSOR'      02049002
033700     END-IF.                                                      02050002
033800                                                                  02060002
033900******************************************************************02070002
034000*  FETCH NEXT FROM CURSOR & WRITE OUTPUT ARCHIVE FILE RECORD.    *02080002
034100******************************************************************02090002
034200 2000-GET-NEXT-FROM-CURSOR.                                       02100002
034300                                                                  02110002
034400     MOVE  IMCSEN-CSTM-ENTR-ID TO DISPLAY-CSTM-ENTR-ID.           02120002
034410*    DISPLAY 'FETCHED CUSTOMS ENTRY = ' DISPLAY-CSTM-ENTR-ID.     02130002
034610                                                                  02140002
036100     PERFORM 2010-POPULATE-ARCHIVE-RECORD.                        02150002
036200     PERFORM 9650-WRITE-ARCHIVE-RECORD.                           02160002
036300     PERFORM 2100-CHECK-PGM-PROGRESS.                             02170002
036600                                                                  02180002
036700     INITIALIZE DCLTIMCSEN                                        02190002
036800                AH015-ARCHIVE-RECORD-LAYOUT.                      02200003
036900     PERFORM 9110-FETCH-TABLE-CURSOR.                             02210002
036600                                                                  02220002
037100******************************************************************02230002
037200*  MOVE COLUMNS FROM TABLES TO FIELDS IN ARCHIVE FILE RECORD.    *02240002
037300******************************************************************02250002
037400 2010-POPULATE-ARCHIVE-RECORD.                                    02260002
037500                                                                  02270002
           MOVE IMCSEN-CSTM-ENTR-ID       TO AH015-CSTM-ENTR-ID.        02280002
           MOVE IMCSEN-ENT-ID             TO AH015-ENT-ID.              02290002
           MOVE IMCSEN-BKR-REF-NBR        TO AH015-BKR-REF-NBR.         02300002
           MOVE IMCSEN-FILD-TMST          TO AH015-FILD-TMST.           02310002
           MOVE IMCSEN-EST-CLR-TMST       TO AH015-EST-CLR-TMST.        02320002
           MOVE IMCSEN-ACTL-CLR-TMST      TO AH015-ACTL-CLR-TMST.       02330002
           MOVE IMCSEN-EXM-TMST           TO AH015-EXM-TMST.            02340002
           MOVE IMCSEN-REJ-TMST           TO AH015-REJ-TMST.            02350002
           MOVE IMCSEN-REJ-DESC           TO AH015-REJ-DESC.            02360002
           MOVE IMCSEN-LQDN-TMST          TO AH015-LQDN-TMST.           02370002
           MOVE IMCSEN-LQDN-SSPNN-TMST    TO AH015-LQDN-SSPNN-TMST.     02380002
           MOVE IMCSEN-LQDN-SSPNN-DESC    TO AH015-LQDN-SSPNN-DESC.     02390002
           MOVE IMCSEN-DAT-SRC-ENT-ID     TO AH015-DAT-SRC-ENT-ID.      02400002
           MOVE IMCSEN-CRE-BY-USR-ID      TO AH015-CRE-BY-USR-ID.       02410002
           MOVE IMCSEN-CRE-TMST           TO AH015-CRE-TMST.            02420002
           MOVE IMCSEN-LAST-UPD-BY-USR-ID TO AH015-LAST-UPD-BY-USR-ID.  02430002
           MOVE IMCSEN-LAST-UPD-TMST      TO AH015-LAST-UPD-TMST.       02440002
           MOVE IMCSEN-MOM-DEST-POE-CDE   TO AH015-MOM-DEST-POE-CDE.    02450002
           MOVE IMCSEN-MOM-TRIP-TYP-CDE   TO AH015-MOM-TRIP-TYP-CDE.    02460002
           MOVE IMCSEN-ENTR-TYP-CDE       TO AH015-ENTR-TYP-CDE.        02470002
042200                                                                  02480002
040700******************************************************************02490002
040800*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *02500002
040900*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *02510002
041000*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *02520002
041100******************************************************************02530002
041200 2100-CHECK-PGM-PROGRESS.                                         02540002
041300     DIVIDE    PV-ARCHIVE-WRITTEN-CNT                             02550002
041400         BY        PC-HOW-OFTEN-TO-DISPLAY                        02560002
041500         GIVING    PV-DISPLAY-NTH-MULTIPLE                        02570002
041600         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      02580002
041700                                                                  02590002
041800     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           02600002
041900         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      02610002
042000         PERFORM 6200-DISPLAY-PGM-PROGRESS                        02620002
042100     END-IF.                                                      02630002
042200                                                                  02640002
046400******************************************************************02650002
046500*  CLOSE CURSOR & OUTPUT FILE, DISPLAY END OF RUN MESSAGE.       *02660002
046600******************************************************************02670002
046700 6000-EOJ-ROUTINE.                                                02680002
046800                                                                  02690002
047100     CLOSE OUT-ARCHIVE-FILE.                                      02700002
047200                                                                  02710002
047300     PERFORM 9130-CLOSE-TABLE-CURSOR.                             02720002
047200                                                                  02730002
046900     MOVE PC-ENDING  TO  DP-STATUS-DESCRIPTION.                   02740002
047500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02750002
047600                                                                  02760002
047700     DISPLAY 'TOTAL CUSTOMS ENTRY IDS = '                         02770002
047700                                  PV-ARCHIVE-WRITTEN-CNT.         02780002
047900                                                                  02790002
048000******************************************************************02800002
048100*  DISPLAY PROGRAM PROGRESS.                                     *02810002
048200******************************************************************02820002
048300 6200-DISPLAY-PGM-PROGRESS.                                       02830002
048400                                                                  02840002
048500     EXEC SQL                                                     02850002
048600          SET :PV-TMST = CURRENT TIMESTAMP                        02860002
048700     END-EXEC.                                                    02870002
048800                                                                  02880002
048900     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                02890002
049000     MOVE PV-TMST                   TO DP-TIMESTAMP.              02900002
049100     MOVE PV-TABLE-ROW-FETCHED-CNT  TO DP-TABLE-ROW-FETCHED-CNT.  02910002
049200     MOVE PV-ARCHIVE-WRITTEN-CNT     TO DP-ARCHIVE-WRITTEN-CNT.   02920002
049300                                                                  02930002
049400     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             02940002
049600                                                                  02950002
049700******************************************************************02960002
049800*  OPEN   TABLE CURSOR                                           *02970002
049900******************************************************************02980002
050000 9100-OPEN-TABLE-CURSOR.                                          02990002
050100     EXEC SQL                                                     03000002
050200          OPEN TABLE-CURSOR                                       03010002
050300     END-EXEC.                                                    03020002
050400                                                                  03030002
050500     EVALUATE TRUE                                                03040002
050600         WHEN SQLCODE = ZERO                                      03050002
050700              CONTINUE                                            03060002
050800         WHEN SQLCODE = +100                                      03070002
050900              SET PS-TABLE-LOOP-DONE TO TRUE                      03080002
051000              MOVE '9100-OPEN-TABLE-CURSOR'                       03090002
051100                                 TO PV-PARAGRAPH-NAME             03100002
051200              MOVE 'OPEN TABLE CURSOR - NO ROWS SELECTED'         03110002
051300                                 TO PV-DB2-OPERATION-MSG-1        03120002
051400              MOVE 'TIMCSEN' TO PV-DB2-TABLE-NAME-1               03130002
051500              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           03140002
051600              PERFORM 9999-DB2-ABEND                              03150002
051700         WHEN SQLWARN0 NOT EQUAL SPACE                            03160002
051800         WHEN SQLCODE  NOT EQUAL ZERO                             03170002
051900              MOVE '9100-OPEN-TABLE-CURSOR'                       03180002
052000                                 TO PV-PARAGRAPH-NAME             03190002
052100              MOVE 'OPEN TABLE CURSOR'                            03200002
052200                                 TO PV-DB2-OPERATION-MSG-1        03210002
052300              MOVE 'TIMCSEN' TO PV-DB2-TABLE-NAME-1               03220002
052400              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           03230002
052500              PERFORM 9999-DB2-ABEND                              03240002
052600     END-EVALUATE.                                                03250002
052700                                                                  03260002
052900******************************************************************03270002
053000*  FETCH TABLE CURSOR                                            *03280002
053100******************************************************************03290002
053200 9110-FETCH-TABLE-CURSOR.                                         03300002
053300     EXEC SQL                                                     03310002
053400         FETCH TABLE-CURSOR                                       03320002
053500          INTO  :IMCSEN-CSTM-ENTR-ID                              03330002
053600               ,:IMCSEN-ENT-ID                                    03340002
053700               ,:IMCSEN-BKR-REF-NBR                               03350002
053800               ,:IMCSEN-FILD-TMST                                 03360002
053900               ,:IMCSEN-EST-CLR-TMST                              03370002
054000               ,:IMCSEN-ACTL-CLR-TMST                             03380002
054100               ,:IMCSEN-EXM-TMST                                  03390002
054100               ,:IMCSEN-REJ-TMST                                  03400002
054100               ,:IMCSEN-REJ-DESC                                  03410002
054100               ,:IMCSEN-LQDN-TMST                                 03420002
054100               ,:IMCSEN-LQDN-SSPNN-TMST                           03430002
054100               ,:IMCSEN-LQDN-SSPNN-DESC                           03440002
054100               ,:IMCSEN-DAT-SRC-ENT-ID                            03450002
054100               ,:IMCSEN-CRE-BY-USR-ID                             03460002
054100               ,:IMCSEN-CRE-TMST                                  03470002
054100               ,:IMCSEN-LAST-UPD-BY-USR-ID                        03480002
054100               ,:IMCSEN-LAST-UPD-TMST                             03490002
054100               ,:IMCSEN-MOM-DEST-POE-CDE                          03491002
054100               ,:IMCSEN-MOM-TRIP-TYP-CDE                          03492002
054100               ,:IMCSEN-ENTR-TYP-CDE                              03493002
056300     END-EXEC.                                                    03494002
056400                                                                  03495002
056500     EVALUATE TRUE                                                03496002
056600         WHEN SQLCODE = ZERO                                      03497002
056700              ADD +1                 TO PV-TABLE-ROW-FETCHED-CNT  03498002
056800         WHEN SQLCODE = +100                                      03499002
056900              SET PS-TABLE-LOOP-DONE TO TRUE                      03500002
057000         WHEN SQLWARN0 NOT EQUAL SPACE                            03510002
057100         WHEN SQLCODE NOT EQUAL ZERO                              03520002
057200              MOVE '9110-FETCH-TABLE-CURSOR'                      03530002
057300                                 TO PV-PARAGRAPH-NAME             03540002
057400              MOVE 'FETCH TABLE CURSOR'                           03550002
057500                                 TO PV-DB2-OPERATION-MSG-1        03560002
057600              MOVE 'TIMCSEN' TO PV-DB2-TABLE-NAME-1               03570002
057700              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           03580002
057800              PERFORM 9999-DB2-ABEND                              03590002
057900     END-EVALUATE.                                                03600002
058100                                                                  03610002
058200******************************************************************03620002
058300*  CLOSE TABLE CURSOR                                            *03630002
058400******************************************************************03640002
058500 9130-CLOSE-TABLE-CURSOR.                                         03650002
058600     EXEC SQL                                                     03660002
058700          CLOSE TABLE-CURSOR                                      03670002
058800     END-EXEC.                                                    03680002
058900                                                                  03690002
059000     EVALUATE TRUE                                                03700002
059100         WHEN SQLCODE = ZERO                                      03710002
059200              CONTINUE                                            03720002
059300         WHEN SQLWARN0 NOT EQUAL SPACE                            03730002
059400         WHEN SQLCODE NOT EQUAL ZERO                              03740002
059500              MOVE '9130-CLOSE-TABLE-CURSOR'                      03750002
059600                                 TO PV-PARAGRAPH-NAME             03760002
059700              MOVE 'CLOSE TABLE CURSOR'                           03770002
059800                                 TO PV-DB2-OPERATION-MSG-1        03780002
059900              MOVE 'TIMCSEN' TO PV-DB2-TABLE-NAME-1               03790002
060000              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           03800002
060100              PERFORM 9999-DB2-ABEND                              03810002
060200     END-EVALUATE.                                                03820002
060600                                                                  03830002
060700******************************************************************03840002
060800*  WRITE A RECORD TO THE ARCHIVE FILE                            *03850002
060900******************************************************************03860002
061000 9650-WRITE-ARCHIVE-RECORD.                                       03870002
061100     WRITE  OUT-ARCHIVE-RECORD  FROM  AH015-ARCHIVE-RECORD-LAYOUT.03880002
061200     ADD +1 TO PV-ARCHIVE-WRITTEN-CNT.                            03890002
061400                                                                  03900002
061700******************************************************************03910002
061800*  DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT  *03920002
061900*  AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN             *03930002
062000*  SQL ERROR OR WARNING CODE OCCURS.                             *03940002
062100******************************************************************03950002
062200 9999-DB2-ABEND.                                                  03960002
062300     DISPLAY PC-CURRENT-PROGRAM-NAME                              03970002
062400             ' 9999-DB2-ABEND'.                                   03980002
062500     DISPLAY PC-CURRENT-PROGRAM-NAME                              03990002
062600             ' ** ABEND           **'.                            04000002
062700     DISPLAY PC-CURRENT-PROGRAM-NAME                              04010002
062800             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       04020002
062900     DISPLAY PC-CURRENT-PROGRAM-NAME                              04030002
063000             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME-1.     04040002
063100     DISPLAY PC-CURRENT-PROGRAM-NAME                              04050002
063200             ' **                 ** = ' PV-DB2-TABLE-NAME-2.     04060002
063300     DISPLAY PC-CURRENT-PROGRAM-NAME                              04070002
063400             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  04080002
063500                                                                  04090002
063600     DISPLAY PC-CURRENT-PROGRAM-NAME                              04100002
063700             ' ** SQLCODE         ** = ' SQLCODE.                 04110002
063800     MOVE SQLCODE TO PV-SQLCODE.                                  04120002
063900     DISPLAY PC-CURRENT-PROGRAM-NAME                              04130002
064000             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          04140002
064100                                                                  04150002
064200     DISPLAY PC-CURRENT-PROGRAM-NAME                              04160002
064300             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            04170002
064400                                                                  04180002
064600*----------------------------------------------------------------*04190002
064700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *04200002
064800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *04210002
064900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *04220002
065000* FORMAT.                                                        *04230002
065100*----------------------------------------------------------------*04240002
065200     COPY DPPD004.                                                04250002
065300                                                                  04260002
065400     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     04270002
065500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           04280002
065700                                                                  04290002
065800*----------------------------------------------------------------*04300002
065900* CALL ABEND                                                     *04310002
066000*----------------------------------------------------------------*04320002
066100     MOVE +4013                  TO ABEND-CODE.                   04330002
066200     CALL 'ILBOABN0' USING ABEND-CODE.                            04340002
