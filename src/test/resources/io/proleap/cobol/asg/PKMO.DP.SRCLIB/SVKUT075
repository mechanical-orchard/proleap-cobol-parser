000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.         SVKUT075.                                    00040001
000500 AUTHOR.             MADHURA PETHE.                               00050008
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000700 DATE-WRITTEN.       JULY 2012.                                   00070008
000800 DATE-COMPILED.                                                   00080000
000900                                                                  00090000
001000******************************************************************00100000
001100* THIS PROGRAM PREPARES THE UPDATE POSTING FILE TO BE PROCESSED  *00110000
001200* BY SVKUP085 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120001
001300*                                                                *00130000
001400* THE PROGRAM READS THE UPDATE POSTING FILE, REFORMATS THE       *00140000
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150000
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160000
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170000
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180000
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190000
002000* OUT TO A SEQUENTIAL FILE.                                      *00200000
002100*                                                                *00210000
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220000
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230000
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240000
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250000
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260000
002700* ABENDS.                                                        *00270000
002800*                                                                *00280000
002900* INPUT FILES:   UPDATE-POSTING-FILE       DDNAME = INP01        *00290000
003000*                                                                *00300000
003100* OUTPUT FILES:  N/A                                             *00310000
003200*                                                                *00320000
003300******************************************************************00320110
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS990 TO    00321010
260107*                                      MAKE DPKUT900 CALL DYNAMIC.00322010
003300******************************************************************00330000
003400                                                                  00340000
003500******************************************************************00350000
003600 ENVIRONMENT DIVISION.                                            00360000
003700******************************************************************00370000
003800                                                                  00380000
003900 CONFIGURATION SECTION.                                           00390000
004000                                                                  00400000
004100 SOURCE-COMPUTER.    IBM-3090.                                    00410000
004200 OBJECT-COMPUTER.    IBM-3090.                                    00420000
004300                                                                  00430000
004400 INPUT-OUTPUT SECTION.                                            00440000
004500                                                                  00450000
004600 FILE-CONTROL.                                                    00460000
004700                                                                  00470000
004800     SELECT UPDATE-POSTING-FILE  ASSIGN TO INP01.                 00480000
004900                                                                  00490000
005000******************************************************************00500000
005100 DATA DIVISION.                                                   00510000
005200******************************************************************00520000
005300                                                                  00530000
005400 FILE SECTION.                                                    00540000
005500                                                                  00550000
005600 FD  UPDATE-POSTING-FILE                                          00560000
005700     RECORDING MODE IS F                                          00570000
005800     BLOCK CONTAINS 0 RECORDS                                     00580000
005900     LABEL RECORDS ARE OMITTED.                                   00590000
006000                                                                  00600000
006100 01  UPDATE-POSTING-RECORD       PIC  X(250).                     00610006
006200                                                                  00620000
006300 WORKING-STORAGE SECTION.                                         00630000
006400                                                                  00640000
006500 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00650000
006600                                                                  00660000
006700******************************************************************00670000
006800*PC - PROGRAM CONSTANTS                                           00680000
006900******************************************************************00690000
007000 01  PROGRAM-CONSTANTS.                                           00700000
007100     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT075'. 00710001
007200     05  PC-TRAN-PREP-FUNC-CODES.                                 00720000
007300         10  PC-TRAN-PREP-FUNC-OPEN                               00730000
007400                                 PIC X(05)      VALUE 'OPEN '.    00740000
007500         10  PC-TRAN-PREP-FUNC-WRITE                              00750000
007600                                 PIC X(05)      VALUE 'WRITE'.    00760000
007700         10  PC-TRAN-PREP-FUNC-CLOSE                              00770000
007800                                 PIC X(05)      VALUE 'CLOSE'.    00780000
007900     05  PC-JOB-NAME             PIC X(08)      VALUE 'SVK006  '. 00790001
008000     05  PC-PLAN-NAME            PIC X(08)      VALUE 'SVKUP085'. 00800001
008100     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +250 COMP.  00810007
008200                                                                  00820000
008300******************************************************************00830000
008400*PV - PROGRAM VARIABLES                                           00840000
008500******************************************************************00850000
008600 01  PROGRAM-VARIABLES.                                           00860000
008700     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00870000
008800         88  CONTROL-BREAK                      VALUE 'C'.        00880000
008900         88  LOGICAL-TRANSACTION                VALUE 'L'.        00890000
009000         88  TIME-INTERVAL                      VALUE 'T'.        00900000
009100         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00910000
009200     05  PV-HOLD-GIFT-CRD-NBR    PIC S9(12)V    VALUE ZERO COMP-3.00920000
009300                                                                  00930000
009400******************************************************************00940000
009500*PA - PROGRAM ACCUMULATORS                                        00950000
009600******************************************************************00960000
009700 01  PROGRAM-ACCUMULATORS.                                        00970000
009800     05  PA-POSTING-RECORDS-READ PIC S9(11)     COMP-3            00980000
009900                                                VALUE ZEROES.     00990000
010000     05  PA-POSTING-RECS-WRITTEN PIC S9(11)     COMP-3            01000000
010100                                                VALUE ZEROES.     01010000
010200                                                                  01020000
010300******************************************************************01030000
010400*PS - PROGRAM SWITCHES                                            01040000
010500******************************************************************01050000
010600 01  PROGRAM-SWITCHES.                                            01060000
010700     05  PS-UPD-POSTING-EOF-SW   PIC X(01)      VALUE 'N'.        01070000
010800         88  PS-UPD-POSTING-EOF                 VALUE 'Y'.        01080000
010900     05  PS-FIRST-TRANS-READ-SW  PIC X(01)      VALUE 'Y'.        01090000
011000         88  FIRST-TRANS-READ                   VALUE 'Y'.        01100000
011100                                                                  01110000
011200******************************************************************01120000
011300*  INCOMM  UPDATE POSTING RECORD LAYOUT                          *01130001
011400******************************************************************01140000
011500     COPY SVRD072.                                                01150001
011600                                                                  01160000
011700******************************************************************01170000
011800*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01180000
011900******************************************************************01190000
260107     COPY DPWS990.                                                01200010
012100                                                                  01210000
012000     COPY DPLS000.                                                01211010
012100                                                                  01212010
012200******************************************************************01220000
012300*  SQL COMMUNICATIONS WORK AREA                                  *01230000
012400******************************************************************01240000
012500     COPY SQLCA2.                                                 01250000
012600                                                                  01260000
012700******************************************************************01270008
012800 PROCEDURE DIVISION.                                              01280009
012900******************************************************************01290009
013000* A100-MAINLINE-PROCESSING                                        01300009
013100*    CONTROLS FLOW OF THE PROGRAM                                *01310009
013200******************************************************************01320009
013300 A100-MAINLINE-PROCESSING.                                        01330009
013400                                                                  01340009
013500     PERFORM B100-INITIALIZE.                                     01350009
013600                                                                  01360009
013700     PERFORM B200-PROCESS-UPD-POSTING-FILE                        01370009
013800         UNTIL PS-UPD-POSTING-EOF.                                01380009
013900                                                                  01390009
014000     PERFORM B300-END-OF-JOB-ROUTINE.                             01400009
014100                                                                  01410009
014200     GOBACK.                                                      01420009
014300                                                                  01430009
014400******************************************************************01440009
014500* B100-INITIALIZE                                                *01450009
014600******************************************************************01460009
014700 B100-INITIALIZE.                                                 01470009
014800                                                                  01480009
014900     PERFORM C100-ISSUE-OPEN-REQUEST.                             01490009
015000                                                                  01500009
015100     OPEN INPUT UPDATE-POSTING-FILE.                              01510009
015200                                                                  01520009
015300     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01530009
015400     IF PS-UPD-POSTING-EOF                                        01540009
015500         DISPLAY ' '                                              01550009
015600         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01560009
015700         DISPLAY 'UPDATE POSTING FILE IS EMPTY'                   01570009
015800         DISPLAY ' '                                              01580009
015900     END-IF.                                                      01590009
016000                                                                  01600009
016100******************************************************************01610009
016200* B200-PROCESS-UPD-POSTING-FILE                                  *01620009
016300*     READ AN UPDATE POSTING RECORD.  IF END-OF-FILE, STOP PRO-  *01630009
016400*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01640009
016500*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01650009
016600*     CHECKPOINTS BEING TAKEN BY SVKUP085 AND ISSUE A WRITE      *01660009
016700*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01670009
016800******************************************************************01680009
016900 B200-PROCESS-UPD-POSTING-FILE.                                   01690009
017000                                                                  01700009
017100     IF FIRST-TRANS-READ                                          01710009
017200         MOVE SV072-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR              01720009
017300         MOVE 'N' TO PS-FIRST-TRANS-READ-SW                       01730009
017400     END-IF.                                                      01740009
017500                                                                  01750009
017600     IF CONTROL-BREAK                                             01760009
017700         PERFORM C300-CKPT-BY-CNTL-BREAK                          01770009
017800     ELSE                                                         01780009
017900         IF LOGICAL-TRANSACTION                                   01790009
018000             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   01800009
018100         ELSE                                                     01810009
018200             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 01820009
018300         END-IF                                                   01830009
018400     END-IF.                                                      01840009
018500                                                                  01850009
018600     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01860009
018700                                                                  01870009
018800******************************************************************01880009
018900* B300-END-OF-JOB-ROUTINE                                        *01890009
019000*                                                                *01900009
019100*                                                                *01910009
019200******************************************************************01920009
019300 B300-END-OF-JOB-ROUTINE.                                         01930009
019400                                                                  01940009
019500     CLOSE UPDATE-POSTING-FILE.                                   01950009
019600                                                                  01960009
019700     DISPLAY ' '.                                                 01970009
019800     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             01980009
019900     DISPLAY 'NUMBER OF POSTING RECORDS READ:        '            01990009
020000             PA-POSTING-RECORDS-READ.                             02000009
020100     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02010009
020200             PA-POSTING-RECS-WRITTEN.                             02020009
020300     DISPLAY ' '.                                                 02030009
020400                                                                  02040009
020500     PERFORM C600-ISSUE-CLOSE-REQUEST.                            02050009
020600                                                                  02060009
020700******************************************************************02070009
020800* C100-ISSUE-OPEN-REQUEST                                        *02080009
020900*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02090009
021000*     MODULE.                                                    *02100009
021100******************************************************************02110009
021200 C100-ISSUE-OPEN-REQUEST.                                         02120009
021300                                                                  02130009
021400     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02140009
021500     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02150009
021600     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02160009
021700                                                                  02170009
021800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02180009
021900                                                                  02190009
022000     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02200009
022100                                                                  02210009
022200******************************************************************02220009
022300* C200-READ-UPDATE-POSTING-FILE                                  *02230009
022400******************************************************************02240009
022500 C200-READ-UPDATE-POSTING-FILE.                                   02250009
022600                                                                  02260009
022700     READ UPDATE-POSTING-FILE INTO SV072-DETAIL-TRANS             02270009
022800         AT END                                                   02280009
022900             SET PS-UPD-POSTING-EOF TO TRUE.                      02290009
023000                                                                  02300009
023100     IF PS-UPD-POSTING-EOF                                        02310009
023200         CONTINUE                                                 02320009
023300     ELSE                                                         02330009
023400         ADD +1 TO PA-POSTING-RECORDS-READ                        02340009
023500     END-IF.                                                      02350009
023600                                                                  02360009
023700******************************************************************02370009
023800* C300-CKPT-BY-CNTL-BREAK                                        *02380009
023900*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02390009
024000*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02400009
024100*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02410009
024200*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02420009
024300*     MODULE.                                                    *02430009
024400* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02440009
024500******************************************************************02450009
024600 C300-CKPT-BY-CNTL-BREAK.                                         02460009
024700                                                                  02470009
024800     IF SV072-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                     02480009
024900         MOVE 'N' TO DP000-CHECKPOINT-IND                         02490009
025000     ELSE                                                         02500009
025100         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02510009
025200         MOVE SV072-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR              02520009
025300     END-IF.                                                      02530009
025400                                                                  02540009
025500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02550009
025600     MOVE SV072-DETAIL-TRANS      TO DP000-TRANS-REC.             02560009
025700     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02570009
025800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02580009
025900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02590009
026000                                                                  02600009
026100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02610009
026200     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02620009
026300                                                                  02630009
026400******************************************************************02640009
026500* C400-CKPT-BY-LOGICAL-TRANS.                                    *02650009
026600*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02660009
026700*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02670009
026800*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02680009
026900*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02690009
027000*     MODULE.                                                    *02700009
027100* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02710009
027200******************************************************************02720009
027300 C400-CKPT-BY-LOGICAL-TRANS.                                      02730009
027400                                                                  02740009
027500     IF SV072-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                     02750009
027600         MOVE 'N' TO DP000-CHECKPOINT-IND                         02760009
027700     ELSE                                                         02770009
027800         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02780009
027900         MOVE SV072-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR              02790009
028000     END-IF.                                                      02800009
028100                                                                  02810009
028200     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02820009
028300     MOVE SV072-DETAIL-TRANS      TO DP000-TRANS-REC.             02830009
028400     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02840009
028500     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02850009
028600     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02860009
028700                                                                  02870009
028800     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02880009
028900     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02890009
029000                                                                  02900009
029100******************************************************************02910009
029200* C500-CKPT-BY-TIME-OR-REQUEST.                                  *02920009
029300*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02930009
029400*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *02940009
029500*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *02950009
029600*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *02960009
029700******************************************************************02970009
029800 C500-CKPT-BY-TIME-OR-REQUEST.                                    02980009
029900                                                                  02990009
030000     MOVE 'N' TO DP000-CHECKPOINT-IND.                            03000009
030100     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03010009
030200     MOVE SV072-DETAIL-TRANS      TO DP000-TRANS-REC.             03020009
030300     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03030009
030400     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03040009
030500     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03050009
030600                                                                  03060009
030700     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03070009
030800     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           03080009
030900                                                                  03090009
031000******************************************************************03100009
031100* C600-ISSUE-CLOSE-REQUEST                                       *03110009
031200*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03120009
031300*     MODULE.                                                    *03130009
031400******************************************************************03140009
031500 C600-ISSUE-CLOSE-REQUEST.                                        03150009
031600                                                                  03160009
031700     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03170009
031800     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03180009
031900     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03190009
032000                                                                  03200009
032100     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03210009
032200                                                                  03220009
032300******************************************************************03230009
032400*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03240009
032500******************************************************************03250009
032600     COPY DPPD000.                                                03260009
032700                                                                  03270009
