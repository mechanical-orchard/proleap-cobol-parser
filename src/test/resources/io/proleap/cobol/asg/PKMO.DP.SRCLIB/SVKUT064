000100******************************************************************00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300******************************************************************00030002
000400 PROGRAM-ID.         SVKUT064.                                    00040002
000500 AUTHOR.             DANIEL OKYERE.                               00050002
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060002
000700 DATE-WRITTEN.       SEPTEMBER 2004.                              00070002
000800 DATE-COMPILED.                                                   00080002
000900                                                                  00090002
001000******************************************************************00100002
001100* THIS PROGRAM PREPARES THE UPDATE POSTING FILE TO BE PROCESSED  *00110002
001200* BY SVKUP017 UNDER THE DB2 CHECKPOINT RESTART SYSTEM.           *00120002
001300*                                                                *00130002
001400* THE PROGRAM READS THE UPDATE POSTING FILE, REFORMATS THE       *00140002
001500* RECORDS AND SETS A CHECKPOINT INDICATOR ON THE RECORD BASED    *00150002
001600* ON HOW CHECKPOINTS WILL BE TAKEN BY THE MAINTENANCE PROGRAM.   *00160002
001700* AFTER A RECORD HAS BEEN REFORMATTED IT IS PASSED TO THE        *00170002
001800* TRANSACTION PREPARATION MODULE (DPKUT900) WHICH DOES SOME MORE *00180002
001900* PROCESSING ON THE RECORDS AND WRITES THE REFORMATTED RECORDS   *00190002
002000* OUT TO A SEQUENTIAL FILE.                                      *00200002
002100*                                                                *00210002
002200* THE PROGRAM COMMUNICATES WITH THE TRANSACTION PREPARATION      *00220002
002300* MODULE USING FUNCTION CODES (OPEN, WRITE, & CLOSE) AND CHECKS  *00230002
002400* THE RETURN CODE AFTER EACH REQUEST.  IF AN INVALID RETURN CODE *00240002
002500* IS RECEIVED, ANY INFORMATION THAT MAY BE HELPFUL IN RESOLVING  *00250002
002600* THE BAD RETURN CODE IS DISPLAYED ON SYSOUT AND THE PROGRAM     *00260002
002700* ABENDS.                                                        *00270002
002800*                                                                *00280002
002900* INPUT FILES:   UPDATE-POSTING-FILE       DDNAME = INP01        *00290002
003000*                                                                *00300002
003100* OUTPUT FILES:  N/A                                             *00310002
003200*                                                                *00320002
003300******************************************************************00320104
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS990 TO    00321004
260107*                                      MAKE DPKUT900 CALL DYNAMIC.00322004
003300******************************************************************00330002
003400                                                                  00340002
003500******************************************************************00350002
003600 ENVIRONMENT DIVISION.                                            00360002
003700******************************************************************00370002
003800                                                                  00380002
003900 CONFIGURATION SECTION.                                           00390002
004000                                                                  00400002
004100 SOURCE-COMPUTER.    IBM-3090.                                    00410002
004200 OBJECT-COMPUTER.    IBM-3090.                                    00420002
004300                                                                  00430002
004400 INPUT-OUTPUT SECTION.                                            00440002
004500                                                                  00450002
004600 FILE-CONTROL.                                                    00460002
004700                                                                  00470002
004800     SELECT UPDATE-POSTING-FILE  ASSIGN TO INP01.                 00480002
004900                                                                  00490002
005000******************************************************************00500002
005100 DATA DIVISION.                                                   00510002
005200******************************************************************00520002
005300                                                                  00530002
005400 FILE SECTION.                                                    00540002
005500                                                                  00550002
005600 FD  UPDATE-POSTING-FILE                                          00560002
005700     RECORDING MODE IS F                                          00570002
005800     BLOCK CONTAINS 0 RECORDS                                     00580002
005900     LABEL RECORDS ARE OMITTED.                                   00590002
006000                                                                  00600002
006100 01  UPDATE-POSTING-RECORD       PIC  X(110).                     00610002
006200                                                                  00620002
006300 WORKING-STORAGE SECTION.                                         00630002
006400                                                                  00640002
006500 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00650002
006600                                                                  00660002
006700******************************************************************00670002
006800*PC - PROGRAM CONSTANTS                                           00680002
006900******************************************************************00690002
007000 01  PROGRAM-CONSTANTS.                                           00700002
007100     05  PC-PROGRAM-NAME         PIC X(08)      VALUE 'SVKUT064'. 00710002
007200     05  PC-TRAN-PREP-FUNC-CODES.                                 00720002
007300         10  PC-TRAN-PREP-FUNC-OPEN                               00730002
007400                                 PIC X(05)      VALUE 'OPEN '.    00740002
007500         10  PC-TRAN-PREP-FUNC-WRITE                              00750002
007600                                 PIC X(05)      VALUE 'WRITE'.    00760002
007700         10  PC-TRAN-PREP-FUNC-CLOSE                              00770002
007800                                 PIC X(05)      VALUE 'CLOSE'.    00780002
007900     05  PC-JOB-NAME             PIC X(08)      VALUE 'SVK075  '. 00790002
008000     05  PC-PLAN-NAME            PIC X(08)      VALUE 'SVKUP017'. 00800002
008100     05  PC-TRANS-RECORD-LENGTH  PIC S9(04)     VALUE +110 COMP.  00810002
008200                                                                  00820002
008300******************************************************************00830002
008400*PV - PROGRAM VARIABLES                                           00840002
008500******************************************************************00850002
008600 01  PROGRAM-VARIABLES.                                           00860002
008700     05  PV-CHECKPOINT-TYPE      PIC X(01)      VALUE SPACE.      00870002
008800         88  CONTROL-BREAK                      VALUE 'C'.        00880002
008900         88  LOGICAL-TRANSACTION                VALUE 'L'.        00890002
009000         88  TIME-INTERVAL                      VALUE 'T'.        00900002
009100         88  REQUESTED-BY-PROGRAM               VALUE 'R'.        00910002
009200     05  PV-HOLD-GIFT-CRD-NBR    PIC S9(12)V    VALUE ZERO COMP-3.00920003
009300                                                                  00930002
009400******************************************************************00940002
009500*PA - PROGRAM ACCUMULATORS                                        00950002
009600******************************************************************00960002
009700 01  PROGRAM-ACCUMULATORS.                                        00970002
009800     05  PA-POSTING-RECORDS-READ PIC S9(11)     COMP-3            00980002
009900                                                VALUE ZEROES.     00990002
010000     05  PA-POSTING-RECS-WRITTEN PIC S9(11)     COMP-3            01000002
010100                                                VALUE ZEROES.     01010002
010200                                                                  01020002
010300******************************************************************01030002
010400*PS - PROGRAM SWITCHES                                            01040002
010500******************************************************************01050002
010600 01  PROGRAM-SWITCHES.                                            01060002
010700     05  PS-UPD-POSTING-EOF-SW   PIC X(01)      VALUE 'N'.        01070002
010800         88  PS-UPD-POSTING-EOF                 VALUE 'Y'.        01080002
010900     05  PS-FIRST-TRANS-READ-SW  PIC X(01)      VALUE 'Y'.        01090002
011000         88  FIRST-TRANS-READ                   VALUE 'Y'.        01100002
011100                                                                  01110002
011200******************************************************************01120002
011300*  SAFEWAY UPDATE POSTING RECORD LAYOUT                          *01130003
011400******************************************************************01140002
011500     COPY SVRD054.                                                01150003
011600                                                                  01160002
011700******************************************************************01170002
011800*  TRANSACTION PREPARATION MODULE LINKAGE SECTION                *01180002
011900******************************************************************01190002
260107     COPY DPWS990.                                                01200004
012100                                                                  01210002
012000     COPY DPLS000.                                                01211004
012100                                                                  01212004
012200******************************************************************01220002
012300*  SQL COMMUNICATIONS WORK AREA                                  *01230002
012400******************************************************************01240002
012500     COPY SQLCA2.                                                 01250002
012600                                                                  01260002
012800******************************************************************01280002
012900 PROCEDURE DIVISION.                                              01290002
013000******************************************************************01300002
013100* A100-MAINLINE-PROCESSING                                        01310002
013200*    CONTROLS FLOW OF THE PROGRAM                                *01320002
013300******************************************************************01330002
013400 A100-MAINLINE-PROCESSING.                                        01340002
013500                                                                  01350002
013600     PERFORM B100-INITIALIZE.                                     01360002
013700                                                                  01370002
013800     PERFORM B200-PROCESS-UPD-POSTING-FILE                        01380002
013900         UNTIL PS-UPD-POSTING-EOF.                                01390002
014000                                                                  01400002
014100     PERFORM B300-END-OF-JOB-ROUTINE.                             01410002
014200                                                                  01420002
014300     GOBACK.                                                      01430002
014400                                                                  01440003
014500******************************************************************01450002
014600* B100-INITIALIZE                                                *01460002
014700******************************************************************01470002
014800 B100-INITIALIZE.                                                 01480002
014900                                                                  01490002
015000     PERFORM C100-ISSUE-OPEN-REQUEST.                             01500002
015100                                                                  01510002
015200     OPEN INPUT UPDATE-POSTING-FILE.                              01520002
015300                                                                  01530002
015400     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01540002
015500     IF PS-UPD-POSTING-EOF                                        01550002
015600         DISPLAY ' '                                              01560002
015700         DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME          01570002
015800         DISPLAY 'UPDATE POSTING FILE IS EMPTY'                   01580002
015900         DISPLAY ' '                                              01590002
016000     END-IF.                                                      01600002
016100                                                                  01610002
016200******************************************************************01620002
016300* B200-PROCESS-UPD-POSTING-FILE                                  *01630002
016400*     READ AN UPDATE POSTING RECORD.  IF END-OF-FILE, STOP PRO-  *01640002
016500*     CESSING.  IF A RECORD IS READ, GATHER WHATEVER OTHER DATA  *01650002
016600*     IS NECESSARY TO TAKE CHECKPOINTS BASED ON THE TYPE OF      *01660002
016700*     CHECKPOINTS BEING TAKEN BY SVKUP017 AND ISSUE A WRITE      *01670003
016800*     REQUEST TO THE TRANSACTION PREPARATION PROGRAM.            *01680002
016900******************************************************************01690002
017000 B200-PROCESS-UPD-POSTING-FILE.                                   01700002
017100                                                                  01710002
017200     IF FIRST-TRANS-READ                                          01720002
017300         MOVE SV054-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         01730003
017400         MOVE 'N' TO PS-FIRST-TRANS-READ-SW                       01740002
017500     END-IF.                                                      01750002
017600                                                                  01760002
017700     IF CONTROL-BREAK                                             01770002
017800         PERFORM C300-CKPT-BY-CNTL-BREAK                          01780002
017900     ELSE                                                         01790002
018000         IF LOGICAL-TRANSACTION                                   01800002
018100             PERFORM C400-CKPT-BY-LOGICAL-TRANS                   01810002
018200         ELSE                                                     01820002
018300             PERFORM C500-CKPT-BY-TIME-OR-REQUEST                 01830002
018400         END-IF                                                   01840002
018500     END-IF.                                                      01850002
018600                                                                  01860002
018700     PERFORM C200-READ-UPDATE-POSTING-FILE.                       01870002
018800                                                                  01880002
019000******************************************************************01900002
019100* B300-END-OF-JOB-ROUTINE                                        *01910002
019200*                                                                *01920002
019300*                                                                *01930002
019400******************************************************************01940002
019500 B300-END-OF-JOB-ROUTINE.                                         01950002
019600                                                                  01960002
019700     CLOSE UPDATE-POSTING-FILE.                                   01970002
019800                                                                  01980002
019900     DISPLAY ' '.                                                 01990002
020000     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             02000002
020100     DISPLAY 'NUMBER OF POSTING RECORDS READ:        '            02010002
020200             PA-POSTING-RECORDS-READ.                             02020002
020300     DISPLAY 'NUMBER OF TRANS/PREP RECORDS WRITTEN:  '            02030002
020400             PA-POSTING-RECS-WRITTEN.                             02040002
020500     DISPLAY ' '.                                                 02050002
020600                                                                  02060002
020700     PERFORM C600-ISSUE-CLOSE-REQUEST.                            02070002
020800                                                                  02080002
020900******************************************************************02090002
021000* C100-ISSUE-OPEN-REQUEST                                        *02100002
021100*     ISSUE AN 'OPEN' REQUEST TO THE TRANSACTION PREPARATION     *02110002
021200*     MODULE.                                                    *02120002
021300******************************************************************02130002
021400 C100-ISSUE-OPEN-REQUEST.                                         02140002
021500                                                                  02150002
021600     MOVE PC-TRAN-PREP-FUNC-OPEN TO DP000-FUNC-CODE.              02160002
021700     MOVE PC-JOB-NAME            TO DP000-JOB-NAME.               02170002
021800     MOVE PC-PLAN-NAME           TO DP000-PLAN-NAME.              02180002
021900                                                                  02190002
022000     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02200002
022100                                                                  02210002
022200     MOVE DP000-CKPT-TYPE-CODE   TO PV-CHECKPOINT-TYPE.           02220002
022300                                                                  02230002
022400******************************************************************02240002
022500* C200-READ-UPDATE-POSTING-FILE                                  *02250002
022600******************************************************************02260002
022700 C200-READ-UPDATE-POSTING-FILE.                                   02270002
022800                                                                  02280002
022900     READ UPDATE-POSTING-FILE INTO SV054-DETAIL-TRANS             02290003
023000         AT END                                                   02300002
023100             SET PS-UPD-POSTING-EOF TO TRUE.                      02310002
023200                                                                  02320002
023300     IF PS-UPD-POSTING-EOF                                        02330002
023400         CONTINUE                                                 02340002
023500     ELSE                                                         02350002
023600         ADD +1 TO PA-POSTING-RECORDS-READ                        02360002
023700     END-IF.                                                      02370002
023800                                                                  02380002
023900******************************************************************02390002
024000* C300-CKPT-BY-CNTL-BREAK                                        *02400002
024100*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02410002
024200*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02420002
024300*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02430002
024400*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02440002
024500*     MODULE.                                                    *02450002
024600* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02460002
024700******************************************************************02470002
024800 C300-CKPT-BY-CNTL-BREAK.                                         02480002
024900                                                                  02490002
025000     IF SV054-GIFT-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                02500003
025100         MOVE 'N' TO DP000-CHECKPOINT-IND                         02510002
025200     ELSE                                                         02520002
025300         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02530002
025400         MOVE SV054-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         02540003
025500     END-IF.                                                      02550002
025600                                                                  02560002
025700     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02570002
025800     MOVE SV054-DETAIL-TRANS      TO DP000-TRANS-REC.             02580003
026000     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02600002
026100     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02610002
026200     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02620002
026300                                                                  02630002
026400     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02640002
026500     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02650002
026600                                                                  02660002
026700******************************************************************02670002
026800* C400-CKPT-BY-LOGICAL-TRANS.                                    *02680002
026900*     THIS ROUTINE SETS THE CHECKPOINT INDICATOR ON THE TRANSAC- *02690002
027000*     TION RECORD "ON" IF THERE IS A CHANGE IN THE KMC CARD      *02700002
027100*     NUMBER.  AFTER THE TRANSACTION RECORD HAS BEEN FORMATTED,  *02710002
027200*     A WRITE REQUEST IS ISSUED TO THE TRANSACTION PREPARATION   *02720002
027300*     MODULE.                                                    *02730002
027400* NOTE: AT THIS TIME CONTROL/LOGIC BREAK PROCESSING IS IDENTICAL.*02740002
027500******************************************************************02750002
027600 C400-CKPT-BY-LOGICAL-TRANS.                                      02760002
027700                                                                  02770002
027800     IF SV054-GIFT-CARD-NBR = PV-HOLD-GIFT-CRD-NBR                02780003
027900         MOVE 'N' TO DP000-CHECKPOINT-IND                         02790002
028000     ELSE                                                         02800002
028100         MOVE 'Y' TO DP000-CHECKPOINT-IND                         02810002
028200         MOVE SV054-GIFT-CARD-NBR TO PV-HOLD-GIFT-CRD-NBR         02820003
028300     END-IF.                                                      02830002
028400                                                                  02840002
028500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      02850002
028600     MOVE SV054-DETAIL-TRANS      TO DP000-TRANS-REC.             02860003
028800     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             02880002
028900     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              02890002
029000     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             02900002
029100                                                                  02910002
029200     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         02920002
029300     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           02930002
029400                                                                  02940002
029500******************************************************************02950002
029600* C500-CKPT-BY-TIME-OR-REQUEST.                                  *02960002
029700*     THIS ROUTINE BUILDS THE TRANSACTION RECORD AND ISSUES A    *02970002
029800*     WRITE REQUEST TO THE TRANSACTION PREPARATION MODULE IF     *02980002
029900*     CHECKPOINTS ARE TAKEN BY TIME INTERVAL (SECONDS) OR        *02990002
030000*     REQUESTED BY THE MAINTENANCE PROGRAM.                      *03000002
030100******************************************************************03010002
030200 C500-CKPT-BY-TIME-OR-REQUEST.                                    03020002
030300                                                                  03030002
030400     MOVE 'N' TO DP000-CHECKPOINT-IND.                            03040002
030500     MOVE PC-TRANS-RECORD-LENGTH  TO DP000-TRANS-REC-LENGTH.      03050002
030600     MOVE SV054-DETAIL-TRANS      TO DP000-TRANS-REC.             03060003
030800     MOVE PC-TRAN-PREP-FUNC-WRITE TO DP000-FUNC-CODE.             03080002
030900     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03090002
031000     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03100002
031100                                                                  03110002
031200     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03120002
031300     ADD +1 TO PA-POSTING-RECS-WRITTEN.                           03130002
031400                                                                  03140002
031500******************************************************************03150002
031600* C600-ISSUE-CLOSE-REQUEST                                       *03160002
031700*     ISSUE A 'CLOSE' REQUEST TO THE TRANSACTION PREPARATION     *03170002
031800*     MODULE.                                                    *03180002
031900******************************************************************03190002
032000 C600-ISSUE-CLOSE-REQUEST.                                        03200002
032100                                                                  03210002
032200     MOVE PC-TRAN-PREP-FUNC-CLOSE TO DP000-FUNC-CODE.             03220002
032300     MOVE PC-JOB-NAME             TO DP000-JOB-NAME.              03230002
032400     MOVE PC-PLAN-NAME            TO DP000-PLAN-NAME.             03240002
032500                                                                  03250002
032600     PERFORM Z900-CALL-TRANS-PREP-MODULE.                         03260002
032700                                                                  03270002
032800******************************************************************03280002
032900*  TRANSACTION PREPARATION MODULE CALL AND ERROR ROUTINES        *03290002
033000******************************************************************03300002
033100     COPY DPPD000.                                                03310002
033200                                                                  03320002
