000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400 PROGRAM-ID.    CEKUP024.                                         00040000
000500 AUTHOR.        TK46168.                                          00050000
000600 INSTALLATION.  KOHLS.                                            00060000
000700 DATE-WRITTEN.  AUGUST 2009.                                      00070000
000800 DATE-COMPILED.                                                   00080000
000900***************************************************************** 00090000
001000*  THIS PROGRAM WILL CLOSE AGING CS PULLS FOR IMPORT            * 00100000
001100*  REPLENISHMENT AND EFC (EFC ADDED IN 2011).                   * 00110000
001300*                                                               * 00120000
001700*  IT WILL READ THE TKRPRPM TABLE TO GET THE NUMBER OF DAYS TO  * 00130000
001800*  CHECK BACK (FUNC CDE CSPLCL) AND TO GET THE DC (LOC_ID)      * 00140000
001300*  NOTE:  INPUT FILE OBSOLETED JANUARY 2011.                    * 00150000
001700*  IT WILL READ THE INPUT FILE TO GET THE DC NUMBER TO BE       * 00160000
001800*  PROCESSED - EACH DC WILL BE PROCESSED SEPARATELY             * 00170000
001300*                                                               * 00180000
001700*  USING THE NUMBER OF DAYS FROM THE PARM RECORD, IT WILL CHECK * 00190000
001800*  THE CREATE DATE FOR THE CS PULL TO SEE IF IT IS OLD.  IF IT  * 00200000
001800*  IS, THEN UPDATE THE STATUS ON TCEPLIT/TCEPLRQ TABLES.        * 00210000
001900***************************************************************** 00220000
217830* 02/07/19 MADE BY: JIM HUNTER              CHG0217830            00230000
217830*  MAINFRAME REFACTORING - DB2 LUW HANDLES CALLS WITH CHAR        00240000
217830*  FORMATTING OF DECIMAL FIELDS DIFFERENTLY THAN THE MAINFRAME    00250000
217830*  VERSION OF DB2.   REPLACING THE CHAR FORMATTING WITH DIGITS.   00260000
217830*  CHAR RETURNS A LEADING SPACE AND TRAILING DECIMAL POINT        00270000
217830*  AND DIGITS DOESN'T.                                            00280000
217830*  SEE STOCK-PULL-CSR CURSOR.                                     00290000
217830*  NOTE: THIS PROGRAM FETCHES ITM_NBR INTO PV-ITEM-ID, WHICH IS   00300000
217830*  NOT REFERENCED.  THE CURSUR DOES HAVE ITM_NBR IN THE ORDER BY. 00310000
217830*                                                                 00311001
217830*  01/09/2020 JEAN KURK                                           00312001
217830*     RENAMED FROM WMKUP024 TO CEKUP024                           00313001
217830******************************************************************00320000
002000 ENVIRONMENT DIVISION.                                            00330000
002100 INPUT-OUTPUT SECTION.                                            00340000
002200                                                                  00350000
002300 FILE-CONTROL.                                                    00360000
002400                                                                  00370000
002500*    SELECT INPUT-FILE    ASSIGN TO UT-S-INP01.                   00380000
002700                                                                  00390000
002800***************************************************************** 00400000
002900 DATA DIVISION.                                                   00410000
003000 FILE SECTION.                                                    00420000
003100                                                                  00430000
003200*FD  INPUT-FILE                                                   00440000
003300*    RECORDING MODE IS F                                          00450000
003400*    LABEL RECORDS ARE STANDARD                                   00460000
003500*    RECORD CONTAINS 80                                           00470000
003600*    BLOCK CONTAINS 0 RECORDS                                     00480000
003700*    DATA RECORD IS INPUT-RECORD.                                 00490000
003800*01  INPUT-RECORD                PIC X(80).                       00500000
003900                                                                  00510000
003100                                                                  00520000
004800***************************************************************** 00530000
004900 WORKING-STORAGE SECTION.                                         00540000
005000                                                                  00550000
007700 01  DK-DB2-KEY-FIELDS.                                           00560000
007800     05  DK-PARM-VALUE                PIC S9(4) COMP VALUE 0.     00570000
007800     05  DK-LOC-ID                    PIC S9(4) COMP VALUE 0.     00580000
007800     05  DK-INTFC-SYS-CDE             PIC  X(3).                  00590000
002100*                                                                 00600000
002200 01  PV-PROGRAM-VARIABLES.                                        00610000
002300     05  PV-CURR-CNSTK-REQ-PL-NBR     PIC S9(09) COMP VALUE ZERO. 00620000
002400     05  PV-PREV-CNSTK-REQ-PL-NBR     PIC S9(09) COMP VALUE ZERO. 00630000
002400     05  PV-CURR-PL-LNE-NBR           PIC S9(04) COMP VALUE ZERO. 00640000
002400     05  PV-PREV-PL-LNE-NBR           PIC S9(04) COMP VALUE ZERO. 00650000
002400     05  PV-ITEM-ID                   PIC X(16) VALUE SPACES.     00660000
002500                                                                  00670000
002600     05  PV-TMST                      PIC X(26).                  00680000
002700     05  PV-HOLD-TMST                 PIC X(26).                  00700000
003400     05  PV-COMMIT-COUNT              PIC S9(04) COMP SYNC        00730000
003500                                          VALUE ZERO.             00740000
005800     05  PV-FETCH-COUNT               PIC S9(07) COMP-3           00750000
005900                                          VALUE ZERO.             00760000
006400     05  PV-UPDATE-TCEPLIT            PIC S9(07) COMP-3           00770000
006500                                          VALUE ZERO.             00780000
006400     05  PV-UPDATE-TCEPLRQ            PIC S9(07) COMP-3           00790000
006500                                          VALUE ZERO.             00800000
006400     05  PV-INSERT-TCEPLST            PIC S9(07) COMP-3           00810000
006500                                          VALUE ZERO.             00820000
006800     05  PV-DISP-NBR                  PIC Z,ZZZ,ZZ9.              00850000
006800     05  PV-DISP-LOC                  PIC ZZ9   VALUE ZEROES.     00860000
006900     05  PV-CNSTK-REQ-PL-NBR          PIC X(09) VALUE ZEROES.     00870000
007000     05  PV-CEPLIT-PL-LNE-NBR         PIC X(04) VALUE ZEROES.     00880000
007100     05  PV-RETRY-COUNT               PIC S9(04)  VALUE +0        00890000
007200                                                  COMP SYNC.      00900000
007300     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00910000
007400                                                 COMP SYNC.       00920000
007600     05  PV-ERROR-MESSAGE-1           PIC  X(60)  VALUE SPACES.   00940000
007700     05  PV-ERROR-MESSAGE-2           PIC  X(60)  VALUE SPACES.   00950000
007800                                                                  00960000
007900 01  PV-INPUT-RECORD.                                             00970000
008000     05  PV-INPUT-FACILITY-ID         PIC 9(03) VALUE ZEROES.     00980000
008100     05  FILLER                       PIC X(77) VALUE SPACES.     00990000
008900*                                                                 01000000
009000 01  PV-ABEND-FIELDS.                                             01010000
009100     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'CEKUP024'.01020000
009200     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    01030000
009300     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    01040000
009400     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    01050000
009500     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    01060000
009600     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    01070000
009700     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    01080000
009800     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01090000
009900     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01100000
010000     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01110000
010100     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    01120000
010200     05  PV-SQLCODE                   PIC 9(9)  VALUE ZERO.       01130000
010300                                                                  01140000
010400 01  PV-ABEND-CODE                    PIC S9(04)     VALUE +0     01150000
010500                                                     COMP SYNC.   01160000
010600     88  ABEND-4001-CTRL-CARD-ERROR                  VALUE +4001. 01170000
010700     88  ABEND-4002-INPUT-DATE-ERROR                 VALUE +4002. 01180000
010800     88  ABEND-4003-START-DATE-ERROR                 VALUE +4003. 01190000
010900     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01200000
011000*                                                                 01210000
011100 01  PC-PROGRAM-CONSTANTS.                                        01220000
011500     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'CEKUP024'. 01250000
011600*                                                                 01260000
011700 01  PS-PROGRAM-SWITCHES.                                         01270000
011800     05  PS-EOF-STOCK-PULL-SWITCH     PIC X(01)  VALUE 'N'.       01280000
011900         88  PS-END-STOCK-PULL                   VALUE 'Y'.       01290000
011900         88  PS-NOT-END-STOCK-PULL               VALUE 'N'.       01300000
012000     05  PS-COMMIT-SW                 PIC X(01)  VALUE SPACE.     01310000
012100         88  PS-COMMIT-NOW                       VALUE 'Y'.       01320000
012200         88  PS-AINT-TIME-YET-TO-COMMIT          VALUE 'N'.       01330000
005200     05  PS-END-OF-INPUT-SW           PIC X(01)  VALUE 'N'.       01340000
005300         88  PS-END-OF-INPUT                     VALUE 'Y'.       01350000
005400         88  PS-NOT-END-OF-INPUT                 VALUE 'N'.       01360000
012300                                                                  01370000
012700                                                                  01380000
012800*  USED FOR DB2 ERROR MESSAGE BUILDING                            01390000
012900     COPY DPWS004.                                                01400000
013000                                                                  01410000
013100*   DB2 SQL COMMUNICATION AREA                                    01420000
013200     EXEC SQL                                                     01430000
013300          INCLUDE SQLCA                                           01440000
013400     END-EXEC.                                                    01450000
013500                                                                  01460000
013600     EXEC SQL                                                     01470000
013700          INCLUDE TKRPRPM                                         01480000
013800     END-EXEC.                                                    01490000
013900                                                                  01500000
013600     EXEC SQL                                                     01510000
013700          INCLUDE TCEPLIT                                         01520000
013800     END-EXEC.                                                    01530000
013900                                                                  01540000
014000     EXEC SQL                                                     01550000
014100          INCLUDE TCEPLRQ                                         01560000
014200     END-EXEC.                                                    01570000
014300                                                                  01580000
014800     EXEC SQL                                                     01590000
014900          INCLUDE TCEPLST                                         01600000
015000     END-EXEC.                                                    01610000
015100                                                                  01620000
015600*  CHECKPOINT CONTROL TABLE                                       01630000
015700     EXEC SQL                                                     01640000
015800          INCLUDE TCKRSTCN                                        01650000
015900     END-EXEC.                                                    01660000
016000                                                                  01670000
016100     EXEC SQL                                                     01680000
016200          DECLARE STOCK-PULL-CSR CURSOR WITH HOLD FOR             01690000
016300           SELECT C.CRE_TMST                                      01700000
016400                 , B.CNSTK_REQ_PL_NBR                             01710000
016500                 , B.PL_LNE_NBR                                   01720000
217830                 , DIGITS(B.ITM_NBR)                              01730000
016600           FROM  TCEPLRQ A                                        01740000
016700               , TCEPLIT B                                        01750000
016700               , TCEPLST C                                        01760000
016800           WHERE     A.CNSTK_LOC_ID       = :DK-LOC-ID            01770000
016800                 AND A.CNSTK_REQ_PL_NBR   = B.CNSTK_REQ_PL_NBR    01780000
016900                 AND A.CNSTK_REQ_PL_NBR   = C.CNSTK_REQ_PL_NBR    01790000
017000                 AND B.STAT_CDE IN ('NW', 'IP')                   01800000
017100                 AND B.DWNLD_RDM_STAT_CDE = 'X'                   01810000
017100                 AND DATE (C.CRE_TMST)    <                       01820000
017100                      (CURRENT DATE - :DK-PARM-VALUE DAYS)        01830000
017200           ORDER BY                                               01840000
017300                    B.CNSTK_REQ_PL_NBR                            01850000
017400                 ,  B.PL_LNE_NBR                                  01860000
016500                 ,  B.ITM_NBR                                     01870000
017500           WITH UR                                                01880000
017600     END-EXEC.                                                    01890000
017600                                                                  01900000
           EXEC SQL                                                     01910000
                DECLARE LOC-ID-CSR CURSOR WITH HOLD FOR                 01920000
                SELECT  LOC_ID                                          01930000
                       ,FUNC_QTY                                        01940000
                  FROM  TKRPRPM                                         01950000
                 WHERE INTFC_SYS_CDE       = :DK-INTFC-SYS-CDE          01960000
                   AND SYS_PRC_FUNC_CDE    = 'CSPLCL'                   01970000
                   AND FUNC_PRC_STAT_CDE   = 'AC'                       01980000
                 WITH UR                                                01990000
           END-EXEC.                                                    02000000
017700/                                                                 02010000
017800 PROCEDURE DIVISION.                                              02020000
017900                                                                  02030000
018000 0000-PROGRAM-MAINLINE.                                           02040000
018100                                                                  02050000
018200     PERFORM 1000-INITIALIZATION.                                 02060000
023900                                                                  02070000
024000*PROCESS INPUT FILE.                                              02080000
024100     IF PS-END-OF-INPUT                                           02090000
024200*        DISPLAY '**** NO INPUT FILE FOUND FOR CEKUP024 ****'     02100000
024200         DISPLAY '**** PARM NOT FOUND FOR CEKUP024 ****'          02110000
024300     ELSE                                                         02120000
024400         PERFORM 1500-PROCESS-INPUT                               02130000
024500           UNTIL PS-END-OF-INPUT                                  02140000
024600     END-IF.                                                      02150000
018300                                                                  02160000
019100*    PERFORM 9000-END-ROUTINE.                                    02170000
           PERFORM 1220-CLOSE-LOC-ID-CURSOR.                            02180000
019200                                                                  02190000
019300     GOBACK.                                                      02200000
019400                                                                  02210000
019500     EJECT.                                                       02220000
019600                                                                  02230000
019600                                                                  02240000
019700 1000-INITIALIZATION.                                             02250000
019800                                                                  02260000
           ACCEPT DK-INTFC-SYS-CDE FROM SYSIN.                          02270000
028800*OPEN FILES                                                       02280000
027500*    OPEN INPUT INPUT-FILE.                                       02290000
019800                                                                  02300000
028800*READ FIRST INPUT RECORD                                          02310000
029000*    PERFORM 1200-READ-INPUT.                                     02320000
           PERFORM 1210-OPEN-LOC-ID-CURSOR.                             02330000
029000     PERFORM 1200-FETCH-LOC-ID-DAYS.                              02340000
019800                                                                  02350000
028800*GET THE PARM RECORD FOR THE NUMBER OF DAYS TO CHECK BACK         02360000
019900*    PERFORM 1100-GET-PARM.                                       02370000
020300                                                                  02380000
021900                                                                  02390000
022000*1100-GET-PARM.                                                   02400000
022100                                                                  02410000
054400*    MOVE ZERO                        TO KRPRPM-FUNC-QTY.         02420000
054500*    PERFORM                                                      02430000
054600*        WITH TEST AFTER                                          02440000
054700*        VARYING PV-RETRY-COUNT                                   02450000
054800*        FROM 1 BY 1                                              02460000
054900*        UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02470000
055000*           OR  (SQLCODE = +0) OR (SQLCODE = -305))               02480000
055100                                                                  02490000
055200                                                                  02500000
055300*        EXEC SQL                                                 02510000
055400*          SELECT  FUNC_QTY                                       02520000
055600*            INTO  :KRPRPM-FUNC-QTY                               02530000
055800*            FROM  TKRPRPM                                        02540000
055900*            WHERE LOC_ID              = 90                       02550000
056000*              AND INTFC_SYS_CDE       = 'KHL'                    02560000
056000*              AND SYS_PRC_FUNC_CDE    = 'CSPLCL'                 02570000
056000*              AND FUNC_PRC_STAT_CDE   = 'AC'                     02580000
056100*          WITH UR                                                02590000
056200*        END-EXEC                                                 02600000
056300                                                                  02610000
056400*        EVALUATE TRUE                                            02620000
056500*            WHEN SQLCODE = ZERO                                  02630000
020300*                MOVE KRPRPM-FUNC-QTY    TO DK-PARM-VALUE         02640000
056600*            WHEN SQLCODE = +100                                  02650000
056700*            WHEN SQLCODE = -305                                  02660000
056800*                CONTINUE                                         02670000
056900*            WHEN SQLCODE = -911                                  02680000
057000*            WHEN SQLCODE = -913                                  02690000
057100*            WHEN SQLCODE = -904                                  02700000
057200*                CONTINUE                                         02710000
057300*            WHEN SQLCODE  NOT = +0                               02720000
057400*                MOVE '1100-GET-PARM'                             02730000
057500*                                     TO PV-ABEND-PARAGRAPH       02740000
057600*                MOVE 'GET PARM DAYS'                             02750000
057700*                                     TO PV-ABEND-OPERATION       02760000
057800*                MOVE 'TKRPRPM'       TO PV-ABEND-STRUCTURE-1     02770000
057900*                PERFORM 9900-DB2-ABEND                           02780000
058000*        END-EVALUATE                                             02790000
058100*    END-PERFORM.                                                 02800000
058200                                                                  02810000
058300*    IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   02820000
058400*                         AND SQLCODE NOT = -305                  02830000
058500*        MOVE '1100-GET-PARM'                                     02840000
058600*                                TO PV-ABEND-PARAGRAPH            02850000
058700*        MOVE 'MAX RETRIES EXCEEDED'                              02860000
058800*                                TO PV-ABEND-OPERATION            02870000
058900*        PERFORM 9900-DB2-ABEND                                   02880000
059000*    END-IF.                                                      02890000
059100                                                                  02900000
059100                                                                  02910000
022000*1200-READ-INPUT.                                                 02920000
       1200-FETCH-LOC-ID-DAYS.                                          02930000
054500     PERFORM                                                      02940000
054600         WITH TEST AFTER                                          02950000
054700         VARYING PV-RETRY-COUNT                                   02960000
054800         FROM 1 BY 1                                              02970000
054900         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02980000
055000            OR  (SQLCODE = +0) OR (SQLCODE = -305)                02990000
055000                               OR (SQLCODE = +100))               03000000
055100                                                                  03010000
039100         EXEC SQL                                                 03020000
039200              FETCH LOC-ID-CSR                                    03030000
055600               INTO  :DK-LOC-ID                                   03040000
055600                    ,:DK-PARM-VALUE                               03050000
039500         END-EXEC                                                 03060000
039600                                                                  03070000
056400         EVALUATE TRUE                                            03080000
056500             WHEN SQLCODE = ZERO                                  03090000
029200                  MOVE ZERO         TO PV-CURR-CNSTK-REQ-PL-NBR   03100000
029200                  MOVE ZERO         TO PV-PREV-CNSTK-REQ-PL-NBR   03110000
029200                  MOVE ZERO         TO PV-CURR-PL-LNE-NBR         03120000
029200                  MOVE ZERO         TO PV-PREV-PL-LNE-NBR         03130000
029200                  MOVE ZERO         TO PV-FETCH-COUNT             03140000
029200                  MOVE ZERO         TO PV-COMMIT-COUNT            03150000
029200                  MOVE ZERO         TO PV-UPDATE-TCEPLIT          03160000
029200                  MOVE ZERO         TO PV-UPDATE-TCEPLRQ          03170000
029200                  MOVE ZERO         TO PV-INSERT-TCEPLST          03180000
027000                  SET PS-AINT-TIME-YET-TO-COMMIT   TO TRUE        03190000
011900                  SET PS-NOT-END-STOCK-PULL        TO TRUE        03200000
056600             WHEN SQLCODE = +100                                  03210000
056700             WHEN SQLCODE = -305                                  03220000
029200                 SET PS-END-OF-INPUT TO TRUE                      03230000
056900             WHEN SQLCODE = -911                                  03240000
057000             WHEN SQLCODE = -913                                  03250000
057100             WHEN SQLCODE = -904                                  03260000
057200                 CONTINUE                                         03270000
057300             WHEN SQLCODE  NOT = +0                               03280000
057400                 MOVE '1200-FETCH-LOC-ID-DAYS'                    03290000
057500                                      TO PV-ABEND-PARAGRAPH       03300000
057600                 MOVE 'GET LOC ID AND PARM DAYS'                  03310000
057700                                      TO PV-ABEND-OPERATION       03320000
057800                 MOVE 'TKRPRPM'       TO PV-ABEND-STRUCTURE-1     03330000
057900                 PERFORM 9900-DB2-ABEND                           03340000
058000         END-EVALUATE                                             03350000
058100     END-PERFORM.                                                 03360000
058200                                                                  03370000
058300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   03380000
058400                          AND SQLCODE NOT = -305                  03390000
058400                          AND SQLCODE NOT = +100                  03400000
058500         MOVE '1200-FETCH-LOC-ID-DAYS'                            03410000
058600                                 TO PV-ABEND-PARAGRAPH            03420000
058700         MOVE 'MAX RETRIES EXCEEDED'                              03430000
058800                                 TO PV-ABEND-OPERATION            03440000
058900         PERFORM 9900-DB2-ABEND                                   03450000
059000     END-IF.                                                      03460000
056300                                                                  03470000
029000*    READ INPUT-FILE INTO PV-INPUT-RECORD                         03480000
029100*       AT END                                                    03490000
029200*         SET PS-END-OF-INPUT TO TRUE                             03500000
029100*       NOT AT END                                                03510000
020300*         MOVE PV-INPUT-FACILITY-ID TO DK-LOC-ID                  03520000
029200*         MOVE ZERO                 TO PV-CURR-CNSTK-REQ-PL-NBR   03530000
029200*         MOVE ZERO                 TO PV-PREV-CNSTK-REQ-PL-NBR   03540000
029200*         MOVE ZERO                 TO PV-CURR-PL-LNE-NBR         03550000
029200*         MOVE ZERO                 TO PV-PREV-PL-LNE-NBR         03560000
029200*         MOVE ZERO                 TO PV-FETCH-COUNT             03570000
029200*         MOVE ZERO                 TO PV-COMMIT-COUNT            03580000
029200*         MOVE ZERO                 TO PV-UPDATE-TCEPLIT          03590000
029200*         MOVE ZERO                 TO PV-UPDATE-TCEPLRQ          03600000
029200*         MOVE ZERO                 TO PV-INSERT-TCEPLST          03610000
027000*         SET PS-AINT-TIME-YET-TO-COMMIT   TO TRUE                03620000
011900*         SET PS-NOT-END-STOCK-PULL        TO TRUE                03630000
029220*    END-READ.                                                    03640000
059100                                                                  03650000
034900 1210-OPEN-LOC-ID-CURSOR.                                         03660000
035000     PERFORM                                                      03670000
035100         WITH TEST AFTER                                          03680000
035200         VARYING PV-RETRY-COUNT                                   03690000
035300         FROM 1 BY 1                                              03700000
035400         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 03710000
035500            OR  (SQLCODE = +0))                                   03720000
035600                                                                  03730000
035700         EXEC SQL                                                 03740000
035800             OPEN LOC-ID-CSR                                      03750000
035900         END-EXEC                                                 03760000
036000                                                                  03770000
036100         EVALUATE TRUE                                            03780000
036200             WHEN SQLCODE = +0                                    03790000
036300             WHEN SQLCODE = -904                                  03800000
036400             WHEN SQLCODE = -911                                  03810000
036500             WHEN SQLCODE = -913                                  03820000
036600                  CONTINUE                                        03830000
036700             WHEN SQLWARN0 NOT = SPACE                            03840000
036800             WHEN SQLCODE  NOT = ZERO                             03850000
036900                  MOVE '1210-OPEN-LOC-ID-CURSOR'                  03860000
037000                                 TO PV-ABEND-PARAGRAPH            03870000
037100                  MOVE 'OPEN LOC-ID-CSR'                          03880000
037200                                 TO PV-ABEND-OPERATION            03890000
037300                  MOVE 'TKRPRPM' TO PV-ABEND-STRUCTURE-1          03900000
037500                  PERFORM 9900-DB2-ABEND                          03910000
037600         END-EVALUATE                                             03920000
037700     END-PERFORM.                                                 03930000
037800                                                                  03940000
037900     IF PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO    03950000
038000         MOVE '1210-OPEN-LOC-ID-CURSOR'                           03960000
038100                                 TO PV-ABEND-PARAGRAPH            03970000
038200         MOVE 'MAX RETRIES EXCEEDED'                              03980000
038300                                 TO PV-ABEND-OPERATION            03990000
038400         PERFORM 9900-DB2-ABEND                                   04000000
038500     END-IF.                                                      04010000
038600                                                                  04020000
041500 1220-CLOSE-LOC-ID-CURSOR.                                        04030000
041600                                                                  04040000
041700     PERFORM                                                      04050000
041800         WITH TEST AFTER                                          04060000
041900         VARYING PV-RETRY-COUNT                                   04070000
042000         FROM 1 BY 1                                              04080000
042100         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 04090000
042200            OR  (SQLCODE = +0))                                   04100000
042300                                                                  04110000
042400            EXEC SQL                                              04120000
042500                CLOSE LOC-ID-CSR                                  04130000
042600            END-EXEC                                              04140000
042700                                                                  04150000
042800            EVALUATE TRUE                                         04160000
042900                WHEN SQLCODE = 0                                  04170000
043000                    CONTINUE                                      04180000
043100                WHEN SQLCODE = -911                               04190000
043200                WHEN SQLCODE = -913                               04200000
043300                WHEN SQLCODE = -904                               04210000
043400                    CONTINUE                                      04220000
043500                WHEN SQLCODE  NOT = ZERO                          04230000
043600                     MOVE '1220-CLOSE-LOC-ID-CURSOR'              04240000
043700                                  TO PV-ABEND-PARAGRAPH           04250000
043800                     MOVE 'CLOSE LOC-ID-CSR'                      04260000
043900                                  TO PV-ABEND-OPERATION           04270000
044000                     MOVE 'TKRPRPM'   TO PV-ABEND-STRUCTURE-1     04280000
044200                     PERFORM 9900-DB2-ABEND                       04290000
044300            END-EVALUATE                                          04300000
044400                                                                  04310000
044500     END-PERFORM.                                                 04320000
044600                                                                  04330000
044700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   04340000
044800         MOVE '1220-CLOSE-LOC-ID-CURSOR'                          04350000
044900                                 TO PV-ABEND-PARAGRAPH            04360000
045000         MOVE 'MAX RETRIES EXCEEDED'                              04370000
045100                                 TO PV-ABEND-OPERATION            04380000
045200         PERFORM 9900-DB2-ABEND                                   04390000
045300     END-IF.                                                      04400000
022100                                                                  04410000
038600                                                                  04420000
059100                                                                  04430000
022000 1500-PROCESS-INPUT.                                              04440000
059000                                                                  04450000
059000     PERFORM 1700-PROCESS-CURSOR.                                 04460000
084100     PERFORM 9100-DISPLAY-COUNTS.                                 04470000
059000*    PERFORM 1200-READ-INPUT.                                     04480000
059000     PERFORM 1200-FETCH-LOC-ID-DAYS.                              04490000
      *    IF PS-END-OF-INPUT                                           04500000
      *        CONTINUE                                                 04510000
      *    ELSE                                                         04520000
019900*        PERFORM 1100-GET-PARM                                    04530000
      *    END-IF.                                                      04540000
058200                                                                  04550000
058200                                                                  04560000
022000 1700-PROCESS-CURSOR.                                             04570000
058200                                                                  04580000
020400     PERFORM 1710-OPEN-STOCK-PULL-CURSOR.                         04590000
020500     PERFORM 1720-FETCH-STOCK-PULL-CURSOR.                        04600000
020600                                                                  04610000
020700     IF PS-END-STOCK-PULL                                         04620000
020800         CONTINUE                                                 04630000
020900     ELSE                                                         04640000
020900*    1ST RECORD PROCESSING                                        04650000
021000         MOVE CEPLIT-CNSTK-REQ-PL-NBR TO                          04660000
021100                                       PV-PREV-CNSTK-REQ-PL-NBR   04670000
021000         MOVE CEPLIT-PL-LNE-NBR       TO PV-PREV-PL-LNE-NBR       04680000
021400         PERFORM 7700-SET-CHECKPOINT-TIME                         04690000
021500         SET PS-AINT-TIME-YET-TO-COMMIT                           04700000
021600                                      TO TRUE                     04710000
021800     END-IF.                                                      04720000
022100                                                                  04730000
018400     PERFORM 2000-PROCESS-STOCK-ORDER-LINES                       04740000
018500         UNTIL PS-END-STOCK-PULL.                                 04750000
018600                                                                  04760000
018600*    UPDATE LAST PULL AND LINE RECORD                             04770000
018700     IF PV-FETCH-COUNT > ZERO                                     04780000
026600         PERFORM 2500-UPDATE-TCEPLIT-STATUS                       04790000
075700         MOVE CEPLIT-CNSTK-REQ-PL-NBR  TO CEPLST-CNSTK-REQ-PL-NBR 04800000
075700         MOVE CEPLIT-PL-LNE-NBR        TO CEPLST-PL-LNE-NBR       04810000
026600         PERFORM 2510-INSERT-TCEPLST                              04820000
026600                                                                  04830000
018800         PERFORM 2520-UPDATE-TCEPLRQ-STATUS                       04840000
075700*        MOVE CEPLRQ-CNSTK-REQ-PL-NBR  TO CEPLST-CNSTK-REQ-PL-NBR 04850000
075700         MOVE ZEROES                   TO CEPLST-PL-LNE-NBR       04860000
026600         PERFORM 2510-INSERT-TCEPLST                              04870000
026600                                                                  04880000
026800         PERFORM 7710-COMMIT                                      04890000
018900     END-IF.                                                      04900000
019000                                                                  04910000
084000     PERFORM 1730-CLOSE-STOCK-PULL-CURSOR.                        04920000
019000                                                                  04930000
084100                                                                  04940000
034900 1710-OPEN-STOCK-PULL-CURSOR.                                     04950000
035000     PERFORM                                                      04960000
035100         WITH TEST AFTER                                          04970000
035200         VARYING PV-RETRY-COUNT                                   04980000
035300         FROM 1 BY 1                                              04990000
035400         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 05000000
035500            OR  (SQLCODE = +0))                                   05010000
035600                                                                  05020000
035700         EXEC SQL                                                 05030000
035800             OPEN STOCK-PULL-CSR                                  05040000
035900         END-EXEC                                                 05050000
036000                                                                  05060000
036100         EVALUATE TRUE                                            05070000
036200             WHEN SQLCODE = +0                                    05080000
036300             WHEN SQLCODE = -904                                  05090000
036400             WHEN SQLCODE = -911                                  05100000
036500             WHEN SQLCODE = -913                                  05110000
036600                  CONTINUE                                        05120000
036700             WHEN SQLWARN0 NOT = SPACE                            05130000
036800             WHEN SQLCODE  NOT = ZERO                             05140000
036900                  MOVE '1710-OPEN-STOCK-PULL-CURSOR'              05150000
037000                                 TO PV-ABEND-PARAGRAPH            05160000
037100                  MOVE 'OPEN STOCK-PULL'                          05170000
037200                                 TO PV-ABEND-OPERATION            05180000
037300                  MOVE 'TCEPLIT' TO PV-ABEND-STRUCTURE-1          05190000
037400                  MOVE 'TCEPLRQ' TO PV-ABEND-STRUCTURE-2          05200000
037500                  PERFORM 9900-DB2-ABEND                          05210000
037600         END-EVALUATE                                             05220000
037700     END-PERFORM.                                                 05230000
037800                                                                  05240000
037900     IF PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO    05250000
038000         MOVE '1710-OPEN-STOCK-PULL-CURSOR'                       05260000
038100                                 TO PV-ABEND-PARAGRAPH            05270000
038200         MOVE 'MAX RETRIES EXCEEDED'                              05280000
038300                                 TO PV-ABEND-OPERATION            05290000
038400         PERFORM 9900-DB2-ABEND                                   05300000
038500     END-IF.                                                      05310000
038600                                                                  05320000
038600                                                                  05330000
038700 1720-FETCH-STOCK-PULL-CURSOR.                                    05340000
038800                                                                  05350000
038900*    INITIALIZE DCLTCEPLIT                                        05360000
039000*               DCLTCEPLRQ.                                       05370000
039100     EXEC SQL                                                     05380000
039200          FETCH STOCK-PULL-CSR                                    05390000
039300           INTO   :CEPLST-CRE-TMST                                05400000
039300                 ,:CEPLIT-CNSTK-REQ-PL-NBR                        05410000
039400                 ,:CEPLIT-PL-LNE-NBR                              05420000
039400                 ,:PV-ITEM-ID                                     05430000
039500     END-EXEC.                                                    05440000
039600                                                                  05450000
039700     EVALUATE TRUE                                                05460000
039800         WHEN SQLCODE = ZERO                                      05470000
039900             ADD 1                 TO PV-FETCH-COUNT              05480000
040000             MOVE CEPLIT-CNSTK-REQ-PL-NBR                         05490000
040100                                      TO PV-CURR-CNSTK-REQ-PL-NBR 05500000
040000             MOVE CEPLIT-PL-LNE-NBR                               05510000
040100                                      TO PV-CURR-PL-LNE-NBR       05520000
040200         WHEN SQLCODE = +100                                      05530000
040300              SET PS-END-STOCK-PULL TO TRUE                       05540000
040400         WHEN SQLWARN0 NOT = SPACE                                05550000
040500         WHEN SQLCODE  NOT = +0                                   05560000
040600              MOVE '1720-FETCH-STOCK-PULL-CURSOR'                 05570000
040700                                   TO PV-ABEND-PARAGRAPH          05580000
040800              MOVE 'FETCH STOCK-PULL CURSOR'                      05590000
040900                                   TO PV-ABEND-OPERATION          05600000
041000              MOVE 'TCEPLIT'       TO PV-ABEND-STRUCTURE-1        05610000
041100              MOVE 'TCEPLRQ'       TO PV-ABEND-STRUCTURE-2        05620000
041200              PERFORM 9900-DB2-ABEND                              05630000
041300     END-EVALUATE.                                                05640000
041400                                                                  05650000
041400                                                                  05660000
041500 1730-CLOSE-STOCK-PULL-CURSOR.                                    05670000
041600                                                                  05680000
041700     PERFORM                                                      05690000
041800         WITH TEST AFTER                                          05700000
041900         VARYING PV-RETRY-COUNT                                   05710000
042000         FROM 1 BY 1                                              05720000
042100         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 05730000
042200            OR  (SQLCODE = +0))                                   05740000
042300                                                                  05750000
042400            EXEC SQL                                              05760000
042500                CLOSE STOCK-PULL-CSR                              05770000
042600            END-EXEC                                              05780000
042700                                                                  05790000
042800            EVALUATE TRUE                                         05800000
042900                WHEN SQLCODE = 0                                  05810000
043000                    CONTINUE                                      05820000
043100                WHEN SQLCODE = -911                               05830000
043200                WHEN SQLCODE = -913                               05840000
043300                WHEN SQLCODE = -904                               05850000
043400                    CONTINUE                                      05860000
043500                WHEN SQLCODE  NOT = ZERO                          05870000
043600                     MOVE '1730-CLOSE-STOCK-PULL-CURSOR'          05880000
043700                                  TO PV-ABEND-PARAGRAPH           05890000
043800                     MOVE 'CLOSE STOCK-PULL'                      05900000
043900                                  TO PV-ABEND-OPERATION           05910000
044000                     MOVE 'TCEPLIT'   TO PV-ABEND-STRUCTURE-1     05920000
044100                     MOVE 'TCEPLRQ'   TO PV-ABEND-STRUCTURE-2     05930000
044200                     PERFORM 9900-DB2-ABEND                       05940000
044300            END-EVALUATE                                          05950000
044400                                                                  05960000
044500     END-PERFORM.                                                 05970000
044600                                                                  05980000
044700     IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   05990000
044800         MOVE '1730-CLOSE-STOCK-PULL-CURSOR'                      06000000
044900                                 TO PV-ABEND-PARAGRAPH            06010000
045000         MOVE 'MAX RETRIES EXCEEDED'                              06020000
045100                                 TO PV-ABEND-OPERATION            06030000
045200         PERFORM 9900-DB2-ABEND                                   06040000
045300     END-IF.                                                      06050000
022100                                                                  06060000
022100                                                                  06070000
022000 2000-PROCESS-STOCK-ORDER-LINES.                                  06080000
026500                                                                  06090000
027500     PERFORM 1720-FETCH-STOCK-PULL-CURSOR.                        06100000
028510                                                                  06110000
026500*    FOR EACH LINE FOUND, UPDATE THE STATUS ON TCEPLIT            06120000
026500                                                                  06130000
027700     IF  PV-CURR-PL-LNE-NBR = PV-PREV-PL-LNE-NBR                  06140000
027700     AND PV-CURR-CNSTK-REQ-PL-NBR = PV-PREV-CNSTK-REQ-PL-NBR      06150000
027800         CONTINUE                                                 06160000
027900     ELSE                                                         06170000
026600         PERFORM 2500-UPDATE-TCEPLIT-STATUS                       06180000
075700         MOVE CEPLIT-CNSTK-REQ-PL-NBR  TO CEPLST-CNSTK-REQ-PL-NBR 06190000
075700         MOVE CEPLIT-PL-LNE-NBR        TO CEPLST-PL-LNE-NBR       06200000
026600         PERFORM 2510-INSERT-TCEPLST                              06210000
026600         PERFORM 3500-DECIDE-TO-COMMIT                            06220000
026700         IF PS-COMMIT-NOW                                         06230000
026800             PERFORM 7710-COMMIT                                  06240000
026900             PERFORM 7700-SET-CHECKPOINT-TIME                     06250000
027000             SET PS-AINT-TIME-YET-TO-COMMIT  TO TRUE              06260000
027200         END-IF                                                   06270000
027200         MOVE PV-CURR-PL-LNE-NBR TO PV-PREV-PL-LNE-NBR            06280000
027200     END-IF.                                                      06290000
027300                                                                  06300000
027700     IF PV-CURR-CNSTK-REQ-PL-NBR = PV-PREV-CNSTK-REQ-PL-NBR       06310000
027800         CONTINUE                                                 06320000
027900     ELSE                                                         06330000
018800         PERFORM 2520-UPDATE-TCEPLRQ-STATUS                       06340000
075700*        MOVE CEPLRQ-CNSTK-REQ-PL-NBR  TO CEPLST-CNSTK-REQ-PL-NBR 06350000
075700         MOVE PV-PREV-CNSTK-REQ-PL-NBR TO CEPLST-CNSTK-REQ-PL-NBR 06360000
075700         MOVE ZEROES                   TO CEPLST-PL-LNE-NBR       06370000
026600         PERFORM 2510-INSERT-TCEPLST                              06380000
026600         PERFORM 3500-DECIDE-TO-COMMIT                            06390000
026700         IF PS-COMMIT-NOW                                         06400000
026800             PERFORM 7710-COMMIT                                  06410000
026900             PERFORM 7700-SET-CHECKPOINT-TIME                     06420000
027000             SET PS-AINT-TIME-YET-TO-COMMIT  TO TRUE              06430000
027200         END-IF                                                   06440000
028400                                                                  06450000
028100         MOVE PV-CURR-CNSTK-REQ-PL-NBR                            06460000
028200                                      TO PV-PREV-CNSTK-REQ-PL-NBR 06470000
028300     END-IF.                                                      06480000
028400                                                                  06490000
028510                                                                  06500000
045500 2500-UPDATE-TCEPLIT-STATUS.                                      06510000
045600     MOVE PV-PREV-CNSTK-REQ-PL-NBR TO CEPLIT-CNSTK-REQ-PL-NBR     06520000
045600     MOVE PV-PREV-PL-LNE-NBR       TO CEPLIT-PL-LNE-NBR           06530000
045600                                                                  06540000
045700     PERFORM                                                      06550000
045800         WITH TEST AFTER                                          06560000
045900         VARYING PV-RETRY-COUNT                                   06570000
046000         FROM 1 BY 1                                              06580000
046100         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 06590000
046200            OR  (SQLCODE = +0))                                   06600000
046400                                                                  06610000
046500         EXEC SQL                                                 06620000
046600              UPDATE TCEPLIT                                      06630000
046700                 SET                                              06640000
046800                     STAT_CDE          = 'PD'                     06650000
047000               WHERE CNSTK_REQ_PL_NBR  = :CEPLIT-CNSTK-REQ-PL-NBR 06660000
047100                 AND PL_LNE_NBR        = :CEPLIT-PL-LNE-NBR       06670000
047200         END-EXEC                                                 06680000
047300                                                                  06690000
047400         EVALUATE TRUE                                            06700000
047500             WHEN SQLCODE = ZERO                                  06710000
047600                 ADD 1                TO PV-UPDATE-TCEPLIT        06720000
047700             WHEN SQLCODE = -911                                  06730000
047800             WHEN SQLCODE = -913                                  06740000
047900             WHEN SQLCODE = -904                                  06750000
048000                 CONTINUE                                         06760000
048100             WHEN SQLCODE  NOT = +0                               06770000
048200                 MOVE '2500-UPDATE-TCEPLIT-STATUS'                06780000
048300                                      TO PV-ABEND-PARAGRAPH       06790000
048400                 MOVE 'UPDATE ITEM STATUS'                        06800000
048500                                      TO PV-ABEND-OPERATION       06810000
048600                 MOVE 'TCEPLIT'       TO PV-ABEND-STRUCTURE-1     06820000
048700                 PERFORM 9900-DB2-ABEND                           06830000
048800         END-EVALUATE                                             06840000
048900     END-PERFORM.                                                 06850000
049000                                                                  06860000
049100     IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   06870000
049200         MOVE '2500-UPDATE-TCEPLIT-STATUS'                        06880000
049300                                 TO PV-ABEND-PARAGRAPH            06890000
049400         MOVE 'MAX RETRIES EXCEEDED'                              06900000
049500                                 TO PV-ABEND-OPERATION            06910000
049600         PERFORM 9900-DB2-ABEND                                   06920000
049700     END-IF.                                                      06930000
049800                                                                  06940000
049800                                                                  06950000
075500 2510-INSERT-TCEPLST.                                             06960000
049800                                                                  06970000
075600     MOVE '2510-INSERT-TCEPLST   '     TO PV-ABEND-PARAGRAPH.     06980000
075700                                                                  06990000
075800     MOVE 'PD'                     TO CEPLST-STAT-CDE.            07000000
075900     MOVE 'CEKUP024'               TO CEPLST-CRE-BY-USR-ID.       07010000
076000                                                                  07020000
076100*INSERT CENTRAL STOCK STATUS RECORD.                              07030000
076200     PERFORM WITH TEST AFTER                                      07040000
076300       VARYING PV-RETRY-COUNT FROM 1 BY 1                         07050000
076400         UNTIL PV-RETRY-COUNT > PC-MAX-RETRIES                    07060000
076500            OR SQLCODE = ZERO                                     07070000
076600                                                                  07080000
076700         EXEC SQL                                                 07090000
076800             INSERT INTO TCEPLST                                  07100000
076900                     (CNSTK_REQ_PL_NBR                            07110000
077000                   ,  PL_LNE_NBR                                  07120000
077100                   ,  CRE_TMST                                    07130000
077200                   ,  STAT_CDE                                    07140000
077300                   ,  CRE_BY_USR_ID)                              07150000
077400              VALUES (:CEPLST-CNSTK-REQ-PL-NBR                    07160000
077500                   ,  :CEPLST-PL-LNE-NBR                          07170000
077600                   ,  CURRENT TIMESTAMP                           07180000
077700                   ,  :CEPLST-STAT-CDE                            07190000
077800                   ,  :CEPLST-CRE-BY-USR-ID)                      07200000
077900         END-EXEC                                                 07210000
078000                                                                  07220000
078100         EVALUATE TRUE                                            07230000
078200           WHEN SQLCODE = ZERO                                    07240000
047600               ADD 1                TO PV-INSERT-TCEPLST          07250000
078400                                                                  07260000
078500           WHEN OTHER                                             07270000
078600               MOVE '2510-INSERT-TCEPLST  ' TO PV-ABEND-PARAGRAPH 07280000
078700               PERFORM 9900-DB2-ABEND                             07290000
078800         END-EVALUATE                                             07300000
078900     END-PERFORM.                                                 07310000
079000                                                                  07320000
079100     IF PV-RETRY-COUNT > PC-MAX-RETRIES                           07330000
079200                       AND SQLCODE NOT = ZERO                     07340000
079300         MOVE '2510-INSERT-TCEPLST  ' TO PV-ABEND-PARAGRAPH       07350000
079400         MOVE 'MAX RETRIES EXCEEDED'                              07360000
079500                                 TO PV-ABEND-OPERATION            07370000
079600         PERFORM 9900-DB2-ABEND                                   07380000
079700     END-IF.                                                      07390000
031300                                                                  07400000
031300                                                                  07410000
045500 2520-UPDATE-TCEPLRQ-STATUS.                                      07420000
045600                                                                  07430000
045700     PERFORM                                                      07440000
045800         WITH TEST AFTER                                          07450000
045900         VARYING PV-RETRY-COUNT                                   07460000
046000         FROM 1 BY 1                                              07470000
046100         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 07480000
046200            OR  (SQLCODE = +0))                                   07490000
046400                                                                  07500000
046500         EXEC SQL                                                 07510000
046600              UPDATE TCEPLRQ                                      07520000
046700                 SET                                              07530000
046800                     STAT_CDE          = 'PD'                     07540000
047000               WHERE CNSTK_REQ_PL_NBR  =                          07550000
047000                                   :PV-PREV-CNSTK-REQ-PL-NBR      07560000
047200         END-EXEC                                                 07570000
047300                                                                  07580000
047400         EVALUATE TRUE                                            07590000
047500             WHEN SQLCODE = ZERO                                  07600000
047600                 ADD 1                TO PV-UPDATE-TCEPLRQ        07610000
047700             WHEN SQLCODE = -911                                  07620000
047800             WHEN SQLCODE = -913                                  07630000
047900             WHEN SQLCODE = -904                                  07640000
048000                 CONTINUE                                         07650000
048100             WHEN SQLCODE  NOT = +0                               07660000
048200                 MOVE '2520-UPDATE-TCEPLRQ-STATUS'                07670000
048300                                      TO PV-ABEND-PARAGRAPH       07680000
048400                 MOVE 'UPDATE ITEM STATUS'                        07690000
048500                                      TO PV-ABEND-OPERATION       07700000
048600                 MOVE 'TCEPLIT'       TO PV-ABEND-STRUCTURE-1     07710000
048700                 PERFORM 9900-DB2-ABEND                           07720000
048800         END-EVALUATE                                             07730000
048900     END-PERFORM.                                                 07740000
049000                                                                  07750000
049100     IF  PV-RETRY-COUNT > PC-MAX-RETRIES AND SQLCODE NOT = ZERO   07760000
049200         MOVE '2520-UPDATE-TCEPLRQ-STATUS'                        07770000
049300                                 TO PV-ABEND-PARAGRAPH            07780000
049400         MOVE 'MAX RETRIES EXCEEDED'                              07790000
049500                                 TO PV-ABEND-OPERATION            07800000
049600         PERFORM 9900-DB2-ABEND                                   07810000
049700     END-IF.                                                      07820000
079800                                                                  07830000
079800                                                                  07840000
032900 3500-DECIDE-TO-COMMIT.                                           07850000
032800                                                                  07860000
033000     EXEC SQL                                                     07870000
033100       SET :PV-TMST = CURRENT TIMESTAMP                           07880000
033200     END-EXEC.                                                    07890000
033300                                                                  07900000
033400     EVALUATE TRUE                                                07910000
033500         WHEN SQLCODE = ZERO                                      07920000
033600             IF PV-TMST > PV-HOLD-TMST                            07930000
033700                 SET PS-COMMIT-NOW    TO TRUE                     07940000
033800             END-IF                                               07950000
033900         WHEN SQLWARN0 NOT EQUAL SPACE                            07960000
034000         WHEN SQLCODE NOT EQUAL ZERO                              07970000
034100             MOVE '3500-DECIDE-TO-COMMIT'                         07980000
034200                                      TO PV-ABEND-PARAGRAPH       07990000
034300             MOVE 'SELECT INTERVAL'   TO PV-ABEND-OPERATION       08000000
034400             MOVE 'TCKRSTCNTL'        TO PV-ABEND-STRUCTURE-1     08010000
034500             PERFORM 9900-DB2-ABEND                               08020000
034600     END-EVALUATE.                                                08030000
045400                                                                  08040000
045400                                                                  08050000
079900 7700-SET-CHECKPOINT-TIME.                                        08060000
079800                                                                  08070000
080000      EXEC SQL                                                    08080000
080100          SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)    08090000
080200          INTO :PV-HOLD-TMST                                      08100000
080300          FROM TCKRSTCNTL                                         08110000
080400          WHERE PLAN_NAME = :PC-PROGRAM-NAME                      08120000
080500      END-EXEC.                                                   08130000
080600                                                                  08140000
080700     EVALUATE TRUE                                                08150000
080800         WHEN SQLWARN0 NOT EQUAL SPACE                            08160000
080900         WHEN SQLCODE NOT EQUAL ZERO                              08170000
081000             MOVE '7700-SET-CHECKPOINT-TIME'                      08180000
081100                                      TO PV-ABEND-PARAGRAPH       08190000
081200             MOVE 'SELECT'            TO PV-ABEND-OPERATION       08200000
081300             MOVE 'TCKRSTCNTL'        TO PV-ABEND-STRUCTURE-1     08210000
081400             PERFORM 9900-DB2-ABEND                               08220000
081500     END-EVALUATE.                                                08230000
081600                                                                  08240000
081600                                                                  08250000
081700 7710-COMMIT.                                                     08260000
081800                                                                  08270000
081900     EXEC SQL                                                     08280000
082000         COMMIT                                                   08290000
082100     END-EXEC.                                                    08300000
082200                                                                  08310000
082300     EVALUATE TRUE                                                08320000
082400         WHEN SQLCODE = ZERO                                      08330000
082500             DISPLAY  'COMMIT AT ' PV-TMST (6:2) '/' PV-TMST (9:2)08340000
082600                     '/' PV-TMST (3:2)                            08350000
082700                     '  ' PV-TMST (12:2) ':'                      08360000
082800                     PV-TMST (15:2) ':' PV-TMST (18:2)            08370000
082900             ADD 1                    TO PV-COMMIT-COUNT          08380000
083000         WHEN SQLWARN0 NOT EQUAL SPACE                            08390000
083100         WHEN SQLCODE NOT EQUAL ZERO                              08400000
083200             MOVE '7710-COMMIT'                                   08410000
083300                                      TO PV-ABEND-PARAGRAPH       08420000
083400             MOVE 'COMMIT'            TO PV-ABEND-OPERATION       08430000
083500             PERFORM 9900-DB2-ABEND                               08440000
083600     END-EVALUATE.                                                08450000
083700                                                                  08460000
083700                                                                  08470000
083800*9000-END-ROUTINE.                                                08480000
083900                                                                  08490000
026000*CLOSE FILES.                                                     08500000
026100*    CLOSE INPUT-FILE.                                            08510000
084100                                                                  08520000
084100                                                                  08530000
083800 9100-DISPLAY-COUNTS.                                             08540000
083900                                                                  08550000
084200     DISPLAY SPACES.                                              08560000
084300*    MOVE PV-INPUT-FACILITY-ID        TO PV-DISP-LOC.             08570000
084300     MOVE DK-LOC-ID                   TO PV-DISP-LOC.             08580000
084400     DISPLAY 'LOCATION = ' PV-DISP-LOC.                           08590000
084200     DISPLAY SPACES.                                              08600000
084500                                                                  08610000
084300     MOVE PV-FETCH-COUNT              TO PV-DISP-NBR.             08620000
084400     DISPLAY 'STOCK ORDERS READ    = ' PV-DISP-NBR.               08630000
085400                                                                  08640000
085500     MOVE PV-COMMIT-COUNT             TO PV-DISP-NBR.             08650000
085600     DISPLAY 'COMMITS TAKEN        = ' PV-DISP-NBR.               08660000
085700                                                                  08670000
085500     MOVE PV-UPDATE-TCEPLIT           TO PV-DISP-NBR.             08680000
085600     DISPLAY 'TCEPLIT UPDATES      = ' PV-DISP-NBR.               08690000
085700                                                                  08700000
085500     MOVE PV-UPDATE-TCEPLRQ           TO PV-DISP-NBR.             08710000
085600     DISPLAY 'TCEPLRQ UPDATES      = ' PV-DISP-NBR.               08720000
085700                                                                  08730000
085500     MOVE PV-INSERT-TCEPLST           TO PV-DISP-NBR.             08740000
085600     DISPLAY 'TCEPLST INSERTS      = ' PV-DISP-NBR.               08750000
085700                                                                  08760000
085700                                                                  08770000
085800 9900-DB2-ABEND.                                                  08780000
085900                                                                  08790000
086000     MOVE SQLCODE TO PV-SQLCODE.                                  08800000
086100     DISPLAY '*** DB2 ERROR '.                                    08810000
086200     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       08820000
086300     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 08830000
086400     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               08840000
086500     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               08850000
086600     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       08860000
086700     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       08870000
086800     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       08880000
086900     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             08890000
087000                                                                  08900000
087100     IF PV-ABEND-STRUCTURE-2 > SPACES                             08910000
087200         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2          08920000
087300     END-IF.                                                      08930000
087500                                                                  08940000
087600     COPY DPPD004.                                                08950000
087700                                                                  08960000
087800     IF SQLCODE NOT = -911                                        08970000
087900         EXEC SQL                                                 08980000
088000              ROLLBACK                                            08990000
088100         END-EXEC                                                 09000000
088200     END-IF.                                                      09010000
088300                                                                  09020000
088400     MOVE +4013                  TO PV-ABEND-CODE.                09030000
088500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         09040000
088600                                                                  09050000
008100                                                                  09060000
