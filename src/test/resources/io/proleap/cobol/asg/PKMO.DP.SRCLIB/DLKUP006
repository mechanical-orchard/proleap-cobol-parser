000100******************************************************************00020002
000200 IDENTIFICATION DIVISION.                                         00030002
000300******************************************************************00040002
000400                                                                  00050002
000500 PROGRAM-ID.    DLKUP006.                                         00060002
000600 AUTHOR.        DAN HINTZ.                                        00070002
000700 INSTALLATION.  KOHLS.                                            00080002
000800 DATE-WRITTEN   APRIL 2009.                                       00090002
000900 DATE-COMPILED.                                                   00100002
001000                                                                  00110002
001100******************************************************************00120002
001200*  THIS PROGRAM READS A FILE CONTAINING DOOR SUMMARY HISTORY     *00130002
001300*  RECORDS.  THESE RECORDS CONTAIN THE BEGINNING AND ENDING      *00140002
001310*  TIMESTAMPS FOR EACH DOOR WHERE LABOR EVENTS WERE PROCESSED.   *00150002
001320*  THIS DATA WILL BE WRITTEN TO THE DLT_DC_DOOR_SUM TABLE.       *00160002
001400******************************************************************00180002
001500                                                                  00190002
001600******************************************************************00200002
001700 ENVIRONMENT DIVISION.                                            00210002
001800******************************************************************00220002
001900                                                                  00230002
002000 CONFIGURATION SECTION.                                           00240002
002100                                                                  00250002
002200 SOURCE-COMPUTER.        IBM-3090.                                00260002
002300 OBJECT-COMPUTER.        IBM-3090.                                00270002
002400                                                                  00280002
002500 INPUT-OUTPUT SECTION.                                            00290002
002600                                                                  00300002
002700 FILE-CONTROL.                                                    00310002
002800                                                                  00320002
003900     SELECT DL-DOOR-SUM-FILE                                      00330002
004000         ASSIGN TO INP01.                                         00340002
004100                                                                  00350002
003500******************************************************************00360002
003600 DATA DIVISION.                                                   00370002
003700******************************************************************00380002
003800                                                                  00390002
003900 FILE SECTION.                                                    00400002
005000*                                                                 00410002
005100 FD  DL-DOOR-SUM-FILE                                             00420002
005200     RECORDING MODE IS F                                          00430002
005300     LABEL RECORDS ARE STANDARD                                   00440002
005400     BLOCK CONTAINS 0 RECORDS.                                    00450002
005500 01  DL-DOOR-SUM-FILE-RECORD          PIC  X(92).                 00460002
005400*                                                                 00470002
005500*                                                                 00480002
005600******************************************************************00490002
005700 WORKING-STORAGE SECTION.                                         00500002
005800******************************************************************00510002
005900*                                                                 00520002
006000*                                                                 00530002
007900******************************************************************00540002
008000** DOOR SUMMARY RECORD COPYBOOK                                 **00550002
008100******************************************************************00560002
008200     COPY DLRD013.                                                00570002
008300*                                                                 00580002
008400*                                                                 00590002
007900******************************************************************00600002
008000** DB2 FORMATTED MESSAGE AREA                                   **00610002
008100******************************************************************00620002
008200     COPY DPWS004.                                                00630002
008300*                                                                 00640002
008400*                                                                 00650002
008600******************************************************************00660002
008700** COMMUNICATIONS AREA FOR DB2                                  **00670002
008800******************************************************************00680002
008900     EXEC SQL                                                     00690002
009000          INCLUDE SQLCA                                           00700002
009100     END-EXEC.                                                    00710002
009200*                                                                 00720002
009300*                                                                 00730002
009400******************************************************************00740002
009500** COBOL DECLARATION AND DCLGEN MEMBER FOR THE DOOR SUMMARY     **00750002
009600** HISTORY TABLE (DLT_DC_DOOR_SUM)                              **00760002
009700******************************************************************00770002
009800     EXEC SQL                                                     00780002
009900          INCLUDE DLT00011                                        00790002
010000     END-EXEC.                                                    00800002
010010*                                                                 00810002
010020*                                                                 00820002
011200 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00830002
011300                                                   COMP SYNC.     00840002
011400                                                                  00850002
009000 01  CC-CONTROL-CARD-PARAMETERS.                                  00851002
009100      05 CC-DC-NBR                   PIC 9(04).                   00852002
009200      05 FILLER                      PIC X(76) VALUE SPACE.       00853002
009300                                                                  00854002
012200 01  PC-PROGRAM-CONSTANTS.                                        00860002
012500     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00870002
012600         'DLKUP006'.                                              00880002
012900     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       00890002
013000                                                   COMP SYNC.     00900002
013300 01  PS-PROGRAM-SWITCHES.                                         00901002
013500     05  PS-EOF-DOOR-SUM-HIST-SW     PIC  X(01)    VALUE 'N'.     00902002
013500         88  PS-EOF-DOOR-SUM-HIST                  VALUE 'Y'.     00903002
013500         88  PS-NOT-EOF-DOOR-SUM-HIST              VALUE 'N'.     00904002
013200                                                                  00910002
013300 01  PV-PROGRAM-VARIABLES.                                        00920002
013500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00930002
013600     05  PV-DB2-TABLE-NAME           PIC  X(30)    VALUE SPACES.  00940002
013610     05  PV-DB2-OPERATION-MESSAGE    PIC  X(40)    VALUE SPACES.  00950005
026200     05  PV-SQLCODE                  PIC  Z(08)9-.                00951005
013700     05  PV-COUNTER                  PIC S9(04)    VALUE ZERO     00960002
013800                                                   COMP SYNC.     00970002
013700     05  PV-OPER-UNT-ID              PIC S9(04)    VALUE ZERO     00980002
013800                                                   COMP SYNC.     00990002
013610     05  PV-CRE-TIMESTAMP            PIC  X(26)    VALUE SPACES.  01000002
013610     05  PV-RECORDS-READ             PIC S9(05)    VALUE ZERO     01010002
013610                                                   COMP-3.        01011002
013610     05  PV-RECORDS-WRITTEN          PIC S9(05)    VALUE ZERO     01012002
013610                                                   COMP-3.        01013002
014500     05  PV-DISPLAY-COUNT            PIC ZZ,ZZ9.                  01020002
014600                                                                  01030002
022511                                                                  01110002
022520******************************************************************01120002
022600 PROCEDURE DIVISION.                                              01130002
022700******************************************************************01140002
022800                                                                  01150002
022810******************************************************************01160002
022820* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01170002
022830*      PROGRAM.                                                   01180002
022840******************************************************************01190002
022900 0000-PROGRAM-MAINLINE.                                           01200002
023400                                                                  01210002
053500     ACCEPT CC-CONTROL-CARD-PARAMETERS FROM SYSIN.                01211002
053600     DISPLAY 'CONTROL CARD SET-UP FOR THIS RUN IS: '              01212002
053700             CC-CONTROL-CARD-PARAMETERS.                          01213002
053800     IF CC-DC-NBR NOT NUMERIC                                     01214002
053900         MOVE 85                    TO CC-DC-NBR                  01215002
054000     END-IF.                                                      01216002
054100     MOVE CC-DC-NBR                 TO PV-OPER-UNT-ID.            01217002
054200                                                                  01218002
025322     OPEN INPUT DL-DOOR-SUM-FILE.                                 01220002
023400                                                                  01230002
016120     EXEC SQL                                                     01231002
016130          SET :PV-CRE-TIMESTAMP = CURRENT TIMESTAMP               01232002
016140     END-EXEC.                                                    01233002
016200                                                                  01234002
023504     PERFORM 7000-READ-DOOR-SUM-HIST-REC.                         01240002
023400                                                                  01250002
023504     PERFORM 2000-PROCESS-DOOR-SUM-HIST                           01251002
023504         UNTIL PS-EOF-DOOR-SUM-HIST.                              01251102
023400                                                                  01252002
023930     CLOSE DL-DOOR-SUM-FILE.                                      01260002
023950                                                                  01270002
023950     IF  PV-RECORDS-READ > 0                                      01271010
000600         MOVE PV-RECORDS-READ       TO PV-DISPLAY-COUNT           01272010
023952         DISPLAY 'DOOR SUMMARY HISTORY RECORDS READ...: '         01280010
                        PV-DISPLAY-COUNT                                01290010
000600         MOVE PV-RECORDS-WRITTEN    TO PV-DISPLAY-COUNT           01310010
023952         DISPLAY 'DOOR SUMMARY HISTORY RECORDS WRITTEN: '         01311010
                        PV-DISPLAY-COUNT                                01312010
023950     ELSE                                                         01312110
023952         DISPLAY '** EMPTY INPUT FILE **'                         01312210
023952         DISPLAY 'THERE WERE NOT ANY DOOR SUMMARY '               01312310
023952                 'HISTORY INPUT RECORDS TO PROCESS.'              01312410
023950     END-IF.                                                      01312510
023953                                                                  01313002
024000     STOP RUN.                                                    01390002
024010*                                                                 01400002
024100*0000-EXIT.                                                       01410002
024200*                                                                 01420002
024300*                                                                 01430002
026402******************************************************************01440002
026403*  PROCESS THE DOOR SUMMARY HISTORY RECORD.  FOR EACH RECORD      01450002
026403*  THAT IS READ, INSERT A ROW TO THE DLT_DC_DOOR_SUM TABLE.       01460002
026404******************************************************************01490002
026405 2000-PROCESS-DOOR-SUM-HIST.                                      01500002
026406                                                                  01510002
035900     INITIALIZE DCLDLT00011.                                      01520009
036000                                                                  01530009
           MOVE PV-OPER-UNT-ID       TO DLT00011-OPER-UNT-ID.           01581007
           MOVE DL013-EVNT-KY-1-TXT  TO DLT00011-DOOR-ID.               01582007
           MOVE DL013-EVNT-KY-2-TMST TO DLT00011-DOOR-SUM-END-TMST.     01583609
           MOVE DL013-EVNT-KY-1-TMST TO DLT00011-DOOR-SUM-STRT-TMST.    01584109
           MOVE PV-CRE-TIMESTAMP     TO DLT00011-DOOR-SUM-CRE-TMST.     01585007
026408                                                                  01590002
026407     PERFORM 2100-INSERT-DOOR-SUM-HIST-DATA.                      01592007
023400                                                                  01592102
021400     IF SQLCODE = +0                                              01592202
021500         EXEC SQL                                                 01592302
021600            COMMIT                                                01592402
021700         END-EXEC                                                 01592502
021800                                                                  01592602
021900         IF SQLCODE NOT = +0                                      01592702
022000             DISPLAY '### COMMIT FAILED ! ###'                    01592802
022100             PERFORM 9100-SQL-ABEND                               01592902
022200         END-IF                                                   01593002
022200     END-IF.                                                      01593102
022300                                                                  01593202
023504     PERFORM 7000-READ-DOOR-SUM-HIST-REC.                         01594002
026421*                                                                 01610002
026422*2000-EXIT.                                                       01620002
026423*                                                                 01630002
026430*                                                                 01640002
035610******************************************************************01650002
035620*  INSERT A ROW INTO THE DLT_DC_DOOR_SUM TABLE.                   01660002
035630******************************************************************01680002
035700 2100-INSERT-DOOR-SUM-HIST-DATA.                                  01690002
035800                                                                  01700002
043010     PERFORM WITH TEST AFTER                                      01730002
043020       VARYING PV-COUNTER FROM 1 BY 1                             01740002
043030         UNTIL (PV-COUNTER > PC-MAX-RETRIES                       01750002
043040                OR                                                01760002
043050                SQLCODE = ZERO                                    01770002
043040                OR                                                01771002
043050                SQLCODE = -803)                                   01772002
043060                                                                  01780002
036100         EXEC SQL                                                 01790002
036200             INSERT INTO DLT_DC_DOOR_SUM                          01800002
                       (OPER_UNT_ID                                     01801002
                       ,DOOR_ID                                         01802002
                       ,DOOR_SUM_END_TMST                               01803002
                       ,DOOR_SUM_STRT_TMST                              01804002
                       ,DOOR_SUM_CRE_TMST)                              01805002
036301             VALUES                                               01840002
                       (:DLT00011-OPER-UNT-ID                           01851002
                       ,:DLT00011-DOOR-ID                               01852002
                       ,:DLT00011-DOOR-SUM-END-TMST                     01853002
                       ,:DLT00011-DOOR-SUM-STRT-TMST                    01854002
                       ,:DLT00011-DOOR-SUM-CRE-TMST)                    01855002
040900         END-EXEC                                                 01940002
041000                                                                  01950002
043092         EVALUATE TRUE                                            01960002
043093             WHEN SQLCODE = -803                                  01970002
043093             WHEN SQLCODE = -904                                  01971002
043094             WHEN SQLCODE = -911                                  01980002
043094             WHEN SQLCODE = -913                                  01981002
043095                 CONTINUE                                         01990002
043105             WHEN SQLCODE = ZERO                                  01991002
043106                 ADD 1           TO PV-RECORDS-WRITTEN            01992002
043096             WHEN SQLWARN0 NOT = SPACES                           02000002
043097             WHEN SQLCODE < ZERO                                  02010002
043098             WHEN SQLCODE > ZERO                                  02020002
043099                 MOVE '2100-INSERT-DOOR-SUM-HIST-DATA '           02030002
043100                                 TO PV-PARAGRAPH-NAME             02040002
043101                 MOVE 'INSERT ROW TO DOOR HISTORY TABLE'          02050002
043102                                 TO PV-DB2-OPERATION-MESSAGE      02060002
043103                 MOVE 'DLT_DC_DOOR_SUM'                           02070002
                                       TO PV-DB2-TABLE-NAME             02071002
                       MOVE SQLCODE    TO PV-SQLCODE                    02072005
043104                 PERFORM 9100-SQL-ABEND                           02080002
043107         END-EVALUATE                                             02110002
043108     END-PERFORM.                                                 02120002
043109                                                                  02130002
043110     IF PV-COUNTER > PC-MAX-RETRIES                               02140002
043099         MOVE '2100-INSERT-DOOR-SUM-HIST-DATA '                   02141002
043112                                 TO PV-PARAGRAPH-NAME             02160002
043113         MOVE 'MAX RETRIES EXCEEDED ON INSERT TO DOOR HIST TABLE '02170002
043114                                 TO PV-DB2-OPERATION-MESSAGE      02180002
043115         MOVE 'DLT_DC_DOOR_SUM'  TO PV-DB2-TABLE-NAME             02190002
043116         PERFORM 9100-SQL-ABEND                                   02200002
043117     END-IF.                                                      02210002
042510*                                                                 02220002
042600*2100-EXIT.                                                       02230002
042700*                                                                 02240002
042800*                                                                 02250002
043253******************************************************************02260002
043260*  READ THE DOOR SUMMARY HISTORY RECORD                           02270002
043300******************************************************************02280002
043400 7000-READ-DOOR-SUM-HIST-REC.                                     02290002
043500     READ DL-DOOR-SUM-FILE                                        02300004
043600         INTO DL013-DOOR-SUMMARY-HISTORY                          02310002
043600              AT END                                              02311002
043600                  SET PS-EOF-DOOR-SUM-HIST TO TRUE.               02312002
043600                                                                  02313002
043600     IF  PS-NOT-EOF-DOOR-SUM-HIST                                 02314002
043600         ADD 1                             TO PV-RECORDS-READ     02315002
043600     END-IF.                                                      02316002
043710*                                                                 02320002
043800*7000-EXIT.                                                       02330002
042700*                                                                 02340002
042800*                                                                 02350002
049800 9100-SQL-ABEND.                                                  02360002
049900******************************************************************02370002
050000*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02380002
050100*  ERROR OR WARNING CODE OCCURS.                                  02390002
050200******************************************************************02400002
050300     DISPLAY '9100-SQL-ABEND'.                                    02410002
050400     DISPLAY '** ABEND           **'.                             02420002
050500     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  02430002
050701     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        02440002
050702     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME.        02450002
050705     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MESSAGE  02460002
050710     DISPLAY '**                 ** = '                           02470002
334500     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               02471005
050800                                                                  02480002
050900******************************************************************02490002
051000* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    02500002
051100* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         02510002
051200* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     02520002
051300* FORMAT.                                                         02530002
051400******************************************************************02540002
051500     COPY DPPD004.                                                02550002
051600                                                                  02560002
038300     EXEC SQL                                                     02561006
038400          ROLLBACK                                                02562006
038500     END-EXEC.                                                    02563006
050800                                                                  02564006
051700     MOVE +4013                  TO ABEND-CODE.                   02570002
051800     CALL 'ILBOABN0' USING ABEND-CODE.                            02580002
051900*9100-EXIT.                                                       02590002
