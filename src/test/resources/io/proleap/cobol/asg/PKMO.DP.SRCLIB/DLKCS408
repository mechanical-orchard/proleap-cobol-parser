000100 IDENTIFICATION DIVISION.                                         00010019
000200 PROGRAM-ID.    DLKCS408.                                         00020019
000300 AUTHOR.        PAUL OMAN.                                        00030019
000400                                                                  00040019
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050019
000600 DATE-WRITTEN.  JANUARY 2004.                                     00060019
000700 DATE-COMPILED.                                                   00070019
000800                                                                  00080019
000900 ENVIRONMENT DIVISION.                                            00090019
001000 CONFIGURATION SECTION.                                           00100019
001100 SOURCE-COMPUTER. IBM-3090.                                       00110019
001200 OBJECT-COMPUTER. IBM-3090.                                       00120019
001300                                                                  00130019
001400****************************************************************  00140019
001500*  D408 - TRANSACTION                                          *  00150019
001600*  NONE - MAPSET                                               *  00160019
001700*                                                              *  00170019
001800*  CALLS DLKUP003 WITH DLWS007 COPYBOOK TO END AND / OR        *  00180019
001900*        COPY ASSIGNMENTS AND ASSOCIATES.                      *  00190019
002000*                                                              *  00200019
002100*  PROGRAM IS IN THE CICS STARTUP LIST SO THAT WHEN CICS       *  00210019
002200*  STARTS RUNNING, IT WILL KICK OFF A RUN OF THIS TRANSACTION. *  00220019
002300*  THEN IT WILL STARTUP EVERY SO MANY MINUTES TO CHECK FOR     *  00230019
002400*  MORE ASSIGNMENTS TO PROCESS (DLCRST PARAMETER)              *  00240019
002500*                                                              *  00250019
002600*  IT SEARCHES THROUGH THE OPEN ASSIGNMENTS AND DETERMINES IF  *  00260019
002700*  THE ASSIGNMENT NEEDS TO BE COPIED TO A NEW ASSIGNMENT DUE   *  00270019
002800*  TO THE FACT THE ASSIGNMENT HAS BEEN OPEN FOR MORE THAN      *  00280019
002900*  X NUMBER OF MINUTES.                                        *  00290019
003000*       FOR EXAMPLE:                                           *  00300019
003100*           IT'S 10:00 AM ON JANUARY 5TH, 2004 AND THE         *  00310019
003200*           DLAINT FUNC-QTY (MINUTES) VALUE IS 30.             *  00320019
003300*                                                              *  00330019
003400*           THE ASSIGNMENT-CURSOR WILL SELECT ANY OPEN         *  00340019
003500*           ASSIGNMENTS WITH A START TIMESTAMP BEFORE          *  00350019
003600*           2004-01-05-09.30.00.000000.                        *  00360019
003700*                                                              *  00370019
003800*       ANY ASSIGNMENTS SELECTED WILL BE ENDED WITH A          *  00380019
003900*           STP_RSN_CDE = "T".                                 *  00390019
004000*                                                              *  00400019
004100*  DB2 ACCESS:                                                 *  00410019
004200*    TKRPRPM TABLE                                             *  00420019
004300*        SELECTS ROWS FOR DIFFERENT PARMS. THEY ARE:           *  00430019
004400*            SYS_PRC_FUNC_CDE = "DLCRST"                       *  00440019
004500*                NUMBER OF SECONDS FOR RESTARTING THIS TRANS-  *  00450019
004600*                ACTION.                                       *  00460019
004700*            SYS_PRC_FUNC_CDE = "DLAINT"                       *  00470019
004800*                NUMBER OF MINUTES AN ASSIGNMENT WOULD BE OPEN *  00480019
004900*                BEFORE IT WOULD BE CLOSED BY THIS PROGRAM.    *  00490019
005000*            SYS_PRC_FUNC_CDE = "DLAMAX"                       *  00500019
005100*                CARRIES THE MAXIMUM NUMBER OF MINUTES AN      *  00510019
005200*                ASSIGNMENT WOULD BE OPEN IF THERE HAS BEEN NO *  00520019
005300*                ACTIVITY AGAINST THE ASSIGNMENT.              *  00530019
005400*                                                              *  00540019
005500*    DLT_ASGMT (DLT00004) TABLE                                *  00550019
005600*               FETCHES                                        *  00560019
005700*                                                              *  00570019
005800*    DLT_DOOR_GP (DLT00001) TABLE                              *  00580019
005900*               SELECTS                                        *  00590019
006000*                                                              *  00600019
006100*    TSUCRCV TABLE                                             *  00610019
006200*               SELECTS                                        *  00620019
006300*                                                              *  00630019
006400****************************************************************  00640019
006500                                                                  00650019
006600 DATA DIVISION.                                                   00660019
006700 WORKING-STORAGE SECTION.                                         00670019
006800                                                                  00680019
006900 01  PV-CHARACTER-FIELDS.                                         00690019
007000     05  PV-CURRENT-DATE          PIC X(10)  VALUE SPACES.        00700019
007100     05  PV-CURRENT-TIMESTAMP     PIC X(26)  VALUE SPACES.        00710019
007200     05  PV-ADJUSTED-TIMESTAMP    PIC X(26)  VALUE SPACES.        00720019
007300     05  PV-ASGMT-TIMESTAMP       PIC X(26)  VALUE SPACES.        00730019
007400     05  PV-DLAINT-TIMESTAMP      PIC X(26)  VALUE SPACES.        00740019
007500     05  PV-DLAMAX-TIMESTAMP      PIC X(26)  VALUE SPACES.        00750019
007600     05  PV-TIMESTAMP             PIC X(26)  VALUE SPACES.        00760019
007700     05  PV-LOG-LINE              PIC X(100) VALUE SPACES.        00770019
007800     05  PV-BLANKS                PIC X(060) VALUE SPACES.        00780019
007900     05  PV-RESTART-TIME          PIC  S9(09)    VALUE +0         00790019
008000                                                  COMP SYNC.      00800019
008100                                                                  00810019
008200 01  PV-COMP-FIELDS.                                              00820019
008300     05  PV-CICS-RESPONSE         PIC S9(04) VALUE 0 COMP.        00830019
008400     05  PV-RETRY-COUNTER         PIC S9(04) VALUE 0 COMP.        00840019
008500     05  PV-DLCRST-FUNC-QTY       PIC S9(09) VALUE 0 COMP.        00850019
008600     05  PV-DLAINT-FUNC-QTY       PIC S9(09) VALUE 0 COMP.        00860019
008700     05  PV-DLAMAX-FUNC-QTY       PIC S9(09) VALUE 0 COMP.        00870019
008710     05  PV-DLSCMT-COMMIT-CDE     PIC  X(01) VALUE SPACE.         00871019
008800     05  PV-SD-WRK-AREA-DOOR-GROUP PIC S9(4) VALUE 0 COMP.        00880019
008900                                                                  00890019
009000     05  PV-DIVERT-COUNT          PIC S9(09) VALUE 0 COMP-3.      00900019
009100     05  PV-INTERVAL              PIC S9(09) VALUE 0 COMP-3.      00910019
009200     05  PV-DLAINT-COUNT          PIC S9(09) VALUE 0 COMP-3.      00920019
009300     05  PV-DLAINT-CLOSED         PIC S9(09) VALUE 0 COMP-3.      00930019
009400     05  PV-DLAMAX-CLOSED         PIC S9(09) VALUE 0 COMP-3.      00940019
009500     05  PV-ASGMNT-FETCHES        PIC S9(09) VALUE 0 COMP-3.      00950019
009600     05  PV-ASGMNT-FETCH-MAX      PIC S9(09) VALUE 3 COMP-3.      00960019
009700     05  PV-ASGMNT-LAST-USED-0    PIC S9(09) VALUE 0 COMP-3.      00970019
009800     05  PV-ASGMNT-LAST-USED-OTH  PIC S9(09) VALUE 0 COMP-3.      00980019
009900     05  PV-TEAM-SELECTS          PIC S9(09) VALUE 0 COMP-3.      00990019
010000     05  PV-SQLCODE               PIC  9(09) VALUE 0.             01000019
010100     05  PV-SEQ-NBR               PIC  9(09) VALUE 0.             01010019
010200     05  PV-WORK-1                PIC  9(09) VALUE 0.             01020019
010300     05  PV-WORK-2                PIC  9(09) VALUE 0.             01030019
010400     05  PV-WORK-3                PIC  9(09) VALUE 0.             01040019
010500                                                                  01050019
010600 01  PS-SWITCHES.                                                 01060019
010700     05  PS-END-OF-CURSOR-SW          PIC X(01)  VALUE 'N'.       01070019
010800         88  PS-END-OF-CURSOR                    VALUE 'Y'.       01080019
010900         88  PS-NOT-END-OF-CURSOR                VALUE 'N'.       01090019
011000     05  PS-DLCRST-FOUND-SW           PIC X(01)  VALUE 'N'.       01100019
011100         88  PS-DLCRST-FOUND                     VALUE 'Y'.       01110019
011200         88  PS-DLCRST-NOT-FOUND                 VALUE 'N'.       01120019
011300     05  PS-DLAINT-FOUND-SW           PIC X(01)  VALUE 'N'.       01130019
011400         88  PS-DLAINT-FOUND                     VALUE 'Y'.       01140019
011500         88  PS-DLAINT-NOT-FOUND                 VALUE 'N'.       01150019
011600     05  PS-DLAMAX-FOUND-SW           PIC X(01)  VALUE 'N'.       01160019
011700         88  PS-DLAMAX-FOUND                     VALUE 'Y'.       01170019
011800         88  PS-DLAMAX-NOT-FOUND                 VALUE 'N'.       01180019
011900                                                                  01190019
012000 01  PC-CONSTANTS.                                                01200019
012100     05  PC-MAX-RETRIES           PIC S9(04) VALUE +3 COMP.       01210019
012200     05  PC-A                     PIC X      VALUE 'A'.           01220019
012300     05  PC-N                     PIC X      VALUE 'N'.           01230019
012400     05  PC-Y                     PIC X      VALUE 'Y'.           01240019
012500     05  PC-AC                    PIC X(02)  VALUE 'AC'.          01250019
012600     05  PC-D408                  PIC X(04)  VALUE 'D408'.        01260019
012700     05  PC-DLKCS408              PIC X(08)  VALUE 'DLKCS408'.    01270019
012800     05  PC-DLCRST                PIC X(06)  VALUE 'DLCRST'.      01280019
012900     05  PC-DLAINT                PIC X(06)  VALUE 'DLAINT'.      01290019
013000     05  PC-DLAMAX                PIC X(06)  VALUE 'DLAMAX'.      01300019
013010     05  PC-DLSCMT                PIC X(06)  VALUE 'DLSCMT'.      01301019
013100     05  PC-ASTERISK-LINE         PIC X(40)  VALUE ALL '*'.       01310019
013200     05  PC-BLANKS                PIC X(40)  VALUE ALL ' '.       01320019
013300     05  PC-CURRENT-PROGRAM-NAME  PIC X(08)  VALUE 'DLKCS408'.    01330019
013400     05  PC-LOG-QUEUE-RESOURCE    PIC X(04)  VALUE 'CSSL'.        01340019
013500     05  PC-LOG-QUEUE             PIC X(04)  VALUE 'CSSL'.        01350019
013600     05  PC-DC-LABOR              PIC X(08)  VALUE 'DC LABOR'.    01360019
013700     05  PC-INDIRECT-LABOR        PIC X(20)  VALUE                01370019
013800                                             'INDIRECT LABOR'.    01380019
013900     05  PC-ISTOP                 PIC X(05)  VALUE 'ISTOP'.       01390019
014000                                                                  01400019
014100****************************************************************  01410019
014200*    DB2 INCLUDES                                              *  01420019
014300*  DLT00000 - DLT_DOOR_GP_TMPL                                 *  01430019
014400*  DLT00001 - DLT_DOOR_GP -  DOOR GROUP                        *  01440019
014500*  DLT00004 - DLT_ASGMT - ASSIGNMENT TABLE                     *  01450019
014600*  TKRPRPM  - KOHLS TO RETEK PROCESSING PARAMETERS             *  01460019
014700*  TSUCRDV  - CARTON DIVERT                                    *  01470019
014800*                                                              *  01480019
014900****************************************************************  01490019
015000                                                                  01500019
015100     EXEC SQL                                                     01510019
015200         INCLUDE DLT00000                                         01520019
015300     END-EXEC.                                                    01530019
015400                                                                  01540019
015500     EXEC SQL                                                     01550019
015600         INCLUDE DLT00001                                         01560019
015700     END-EXEC.                                                    01570019
015800                                                                  01580019
015900     EXEC SQL                                                     01590019
016000         INCLUDE DLT00004                                         01600019
016100     END-EXEC.                                                    01610019
016200                                                                  01620019
016300     EXEC SQL                                                     01630019
016400         INCLUDE TKRPRPM                                          01640019
016500     END-EXEC.                                                    01650019
016600                                                                  01660019
016700     EXEC SQL                                                     01670019
016800         INCLUDE TSUCRDV                                          01680019
016900     END-EXEC.                                                    01690019
017000                                                                  01700019
017100     EXEC SQL                                                     01710019
017200          INCLUDE SQLCA                                           01720019
017300     END-EXEC.                                                    01730019
017400                                                                  01740019
017500****************************************************************  01750019
017600*    COPYBOOK USED FOR CALLING DLKUP003                        *  01760019
017700****************************************************************  01770019
017800                                                                  01780019
017900     COPY DLWS007.                                                01790019
018000                                                                  01800019
018100     COPY DLWS011.                                                01810019
018200                                                                  01820019
018300****************************************************************  01830019
018400*    ABEND PROCESSING COPYBOOK                                 *  01840019
018500****************************************************************  01850019
018600                                                                  01860019
018700     COPY DPWS013.                                                01870019
018800                                                                  01880019
018900****************************************************************  01890019
019000*                                                              *  01900019
019100*                                                              *  01910019
019200****************************************************************  01920019
019300                                                                  01930019
019400     EXEC SQL                                                     01940019
019500        DECLARE ASSIGNMENT-CURSOR CURSOR WITH HOLD FOR            01950019
019600         SELECT                                                   01960019
019700                ASGMT_STRT_DTE                                    01970019
019800               ,ASGMT_NBR_TXT                                     01980019
019900               ,ASGMT_NBR_SEQ_NBR                                 01990019
020000               ,ASGMT_STRT_TM                                     02000019
020100               ,LAST_USD_SEQ_NBR                                  02010019
020200               ,WK_TYP_DESC                                       02020019
020300               ,WK_AREA_DESC                                      02030019
020400               ,DC_NBR                                            02040019
020500               ,(TIMESTAMP (ASGMT_STRT_DTE,                       02050019
020600                            ASGMT_STRT_TM))                       02060019
020700               ,(CURRENT TIMESTAMP - :PV-DLAINT-FUNC-QTY MINUTES) 02070019
020800               ,(CURRENT TIMESTAMP - :PV-DLAMAX-FUNC-QTY MINUTES) 02080019
020900                                                                  02090019
021000          FROM  DLT_ASGMT                                         02100019
021100                                                                  02110019
021200         WHERE (TIMESTAMP (ASGMT_STRT_DTE,                        02120019
021300                           ASGMT_STRT_TM)  <                      02130019
021400               (CURRENT TIMESTAMP - :PV-DLAINT-FUNC-QTY MINUTES)) 02140019
021500           AND  ASGMT_STP_RSN_CDE     = :PC-N                     02150019
021600                                                                  02160019
021700      ORDER BY  ASGMT_STRT_DTE                                    02170019
021800               ,ASGMT_NBR_TXT                                     02180019
021900               ,ASGMT_NBR_SEQ_NBR                                 02190019
022000                                                                  02200019
022100     END-EXEC.                                                    02210019
022200                                                                  02220019
022300 LINKAGE SECTION.                                                 02230019
022400                                                                  02240019
022500 PROCEDURE DIVISION.                                              02250019
022600                                                                  02260019
022700     PERFORM 1000-INITIALIZE.                                     02270019
022800                                                                  02280019
022900     PERFORM 2000-CHECK-ASSIGNMENTS.                              02290019
023000                                                                  02300019
023100     PERFORM 9000-TERMINATE.                                      02310019
023200                                                                  02320019
023300     GOBACK.                                                      02330019
023400                                                                  02340019
023500                                                                  02350019
023600****************************************************************  02360019
023700*                                                              *  02370019
023800*                                                              *  02380019
023900*                                                              *  02390019
024000****************************************************************  02400019
024100                                                                  02410019
024200 1000-INITIALIZE.                                                 02420019
024300                                                                  02430019
024400     PERFORM 8400-GET-TIMESTAMP.                                  02440019
024500                                                                  02450019
024600     PERFORM 8000-ENQUEUE-LOG.                                    02460019
024700                                                                  02470019
024800     STRING ' ' PC-DLKCS408                                       02480019
024900            ' STARTED AT '                                        02490019
025000             PV-CURRENT-TIMESTAMP (12:8)                          02500019
025100            ' ON '                                                02510019
025200             PV-CURRENT-TIMESTAMP (1:10)                          02520019
025300             DELIMITED BY SIZE                                    02530019
025400             INTO PV-LOG-LINE.                                    02540019
025500                                                                  02550019
025600     PERFORM 8100-WRITEQ-TD-LOG.                                  02560019
025700                                                                  02570019
025800                                                                  02580019
025900****************************************************************  02590019
026000*    RETRIEVE ALL OF THE PARMS, THEN OPEN THE CURSOR AND       *  02600019
026100*    FETCH THE ASSIGNMENTS.                                    *  02610019
026200*                                                              *  02620019
026300****************************************************************  02630019
026400                                                                  02640019
026500 2000-CHECK-ASSIGNMENTS.                                          02650019
026600                                                                  02660019
026700     PERFORM 3000-SELECT-DLCRST.                                  02670019
026800                                                                  02680019
026900     PERFORM 3200-START-NEXT-TRANSACTION.                         02690019
027000                                                                  02700019
027100     PERFORM 3400-SELECT-DLAINT.                                  02710019
027200                                                                  02720019
027300     PERFORM 3600-SELECT-DLSCMT.                                  02730019
027400                                                                  02740019
027500     PERFORM 3800-SELECT-DLAMAX.                                  02750019
027600                                                                  02760019
027700     PERFORM 4000-PROCESS-ASSIGNMENTS.                            02770019
027800                                                                  02780019
027900                                                                  02790019
028000****************************************************************  02800019
028100*    RETRIEVE PARM THAT TELLS THE NUMBER OF SECONDS FOR        *  02810019
028200*    RESTARTING THIS TRANSATION.                               *  02820019
028300*                                                              *  02830019
028400****************************************************************  02840019
028500                                                                  02850019
028600 3000-SELECT-DLCRST.                                              02860019
028700                                                                  02870019
028800     PERFORM                                                      02880019
028900         WITH TEST AFTER                                          02890019
029000         VARYING PV-RETRY-COUNTER                                 02900019
029100         FROM 1 BY 1                                              02910019
029200         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  02920019
029300            OR SQLCODE = ZERO                                     02930019
029400            OR DP013-DB2-ABEND                                    02940019
029500                                                                  02950019
029600         EXEC SQL                                                 02960019
029700             SELECT  FUNC_QTY                                     02970019
029800              INTO   :PV-DLCRST-FUNC-QTY                          02980019
029900                                                                  02990019
030000              FROM   TKRPRPM                                      03000019
030100                                                                  03010019
030200             WHERE   LOC_ID            = 90                       03020019
030300               AND   INTFC_SYS_CDE     = 'DLX'                    03030019
030400               AND   FUNC_PRC_STAT_CDE = :PC-AC                   03040019
030500               AND   SYS_PRC_FUNC_CDE  = :PC-DLCRST               03050019
030600               AND  (CURRENT DATE                                 03060019
030700                     BETWEEN DATE (FUNC_BEG_TMST) AND             03070019
030800                             DATE (FUNC_END_TMST))                03080019
030810             WITH UR                                              03081019
030900         END-EXEC                                                 03090019
031000                                                                  03100019
031100         EVALUATE TRUE                                            03110019
031200             WHEN SQLCODE = ZERO                                  03120019
031300                  SET PS-DLCRST-FOUND TO TRUE                     03130019
031400                  MOVE PV-DLCRST-FUNC-QTY TO PV-RESTART-TIME      03140019
031500             WHEN SQLCODE = -904                                  03150019
031600             WHEN SQLCODE = -911                                  03160019
031700             WHEN SQLCODE = -913                                  03170019
031800                  CONTINUE                                        03180019
031900                                                                  03190019
032000             WHEN SQLWARN0 NOT = SPACES                           03200019
032100             WHEN SQLCODE NOT = ZERO                              03210019
032200                  MOVE '3000-SELECT-DLCRST' TO DP013-PARAGRAPH    03220019
032300                  INITIALIZE DP013-MESSAGE-TABLE                  03230019
032400                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  03240019
032500                  MOVE SQLCA     TO DP013-SQLCA                   03250019
032600                  MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)      03260019
032700                  SET DP013-LINK-RETURN TO TRUE                   03270019
032800                  SET DP013-NO-ROLLBACK TO TRUE                   03280019
032900                  SET DP013-DB2-ABEND   TO TRUE                   03290019
033000                  PERFORM DP014-0000-PROCESS-ABEND                03300019
033100                                                                  03310019
033200         END-EVALUATE                                             03320019
033300     END-PERFORM.                                                 03330019
033400                                                                  03340019
033500     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         03350019
033600        MOVE '3000-SELECT-DLCRST' TO DP013-PARAGRAPH              03360019
033700        INITIALIZE DP013-MESSAGE-TABLE                            03370019
033800        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 03380019
033900                                DP013-MESSAGE-TEXT (1)            03390019
034000        MOVE SQLCA     TO DP013-SQLCA                             03400019
034100        MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)                03410019
034200        SET DP013-DB2-ABEND   TO TRUE                             03420019
034300        PERFORM DP014-0000-PROCESS-ABEND                          03430019
034400     END-IF.                                                      03440019
034500                                                                  03450019
034600****************************************************************  03460019
034700*    START NEXT D408 TO START IN NUMBER OF SECONDS RETRIEVED   *  03470019
034800*        FROM TKRPRPM TABLE.                                   *  03480019
034900****************************************************************  03490019
035000                                                                  03500019
035100 3200-START-NEXT-TRANSACTION.                                     03510019
035200                                                                  03520019
035300*    EXEC CICS                                                    03530019
035400*         START TRANSID (PC-D408)                                 03540019
035500*              INTERVAL (PV-DLCRST-FUNC-QTY)                      03550019
035600*    END-EXEC.                                                    03560019
035700                                                                  03570019
035800     IF PV-RESTART-TIME > 0                                       03580019
035900         EXEC CICS                                                03590019
036000             START TRANSID(PC-D408)                               03600019
036100                 AFTER SECONDS (PV-RESTART-TIME)                  03610019
036200         END-EXEC.                                                03620019
036300                                                                  03630019
036400                                                                  03640019
036500****************************************************************  03650019
036600*    RETRIEVE THE PARM THAT TELLS THE NUMBER OF MINUTES AN     *  03660019
036700*    ASSIGNMENT WOULD BE OPEN BEFORE THE ASSIGNMENT WOULD BE   *  03670019
036800*    CLOSED BY THIS PROGRAM                                    *  03680019
036900*                                                              *  03690019
037000****************************************************************  03700019
037100                                                                  03710019
037200 3400-SELECT-DLAINT.                                              03720019
037300                                                                  03730019
037400     PERFORM                                                      03740019
037500         WITH TEST AFTER                                          03750019
037600         VARYING PV-RETRY-COUNTER                                 03760019
037700         FROM 1 BY 1                                              03770019
037800         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  03780019
037900            OR SQLCODE = ZERO                                     03790019
038000            OR DP013-DB2-ABEND                                    03800019
038100                                                                  03810019
038200         EXEC SQL                                                 03820019
038300             SELECT  FUNC_QTY                                     03830019
038400              INTO   :PV-DLAINT-FUNC-QTY                          03840019
038500                                                                  03850019
038600              FROM   TKRPRPM                                      03860019
038700                                                                  03870019
038800             WHERE   LOC_ID            = 90                       03880019
038900               AND   INTFC_SYS_CDE     = 'DLX'                    03890019
039000               AND   FUNC_PRC_STAT_CDE = :PC-AC                   03900019
039100               AND   SYS_PRC_FUNC_CDE  = :PC-DLAINT               03910019
039200               AND  (CURRENT DATE                                 03920019
039300                     BETWEEN DATE (FUNC_BEG_TMST) AND             03930019
039400                             DATE (FUNC_END_TMST))                03940019
039410             WITH UR                                              03941019
039500         END-EXEC                                                 03950019
039600                                                                  03960019
039700         EVALUATE TRUE                                            03970019
039800             WHEN SQLCODE = ZERO                                  03980019
039900                  CONTINUE                                        03990019
040000                                                                  04000019
040100             WHEN SQLCODE = -904                                  04010019
040200             WHEN SQLCODE = -911                                  04020019
040300             WHEN SQLCODE = -913                                  04030019
040400                  CONTINUE                                        04040019
040500                                                                  04050019
040600             WHEN SQLWARN0 NOT = SPACES                           04060019
040700             WHEN SQLCODE NOT = ZERO                              04070019
040800                  MOVE '3400-SELECT-DLAINT' TO DP013-PARAGRAPH    04080019
040900                  INITIALIZE DP013-MESSAGE-TABLE                  04090019
041000                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  04100019
041100                  MOVE SQLCA     TO DP013-SQLCA                   04110019
041200                  MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)      04120019
041300                  SET DP013-LINK-RETURN TO TRUE                   04130019
041400                  SET DP013-NO-ROLLBACK TO TRUE                   04140019
041500                  SET DP013-DB2-ABEND   TO TRUE                   04150019
041600                  PERFORM DP014-0000-PROCESS-ABEND                04160019
041700                                                                  04170019
041800         END-EVALUATE                                             04180019
041900     END-PERFORM.                                                 04190019
042000                                                                  04200019
042100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         04210019
042200        MOVE '3400-SELECT-DLAINT' TO DP013-PARAGRAPH              04220019
042300        INITIALIZE DP013-MESSAGE-TABLE                            04230019
042400        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 04240019
042500                                DP013-MESSAGE-TEXT (1)            04250019
042600        MOVE SQLCA     TO DP013-SQLCA                             04260019
042700        MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)                04270019
042800        SET DP013-DB2-ABEND   TO TRUE                             04280019
042900        PERFORM DP014-0000-PROCESS-ABEND                          04290019
043000     END-IF.                                                      04300019
043100                                                                  04310019
043200****************************************************************  04320019
043300*    RETRIEVE THE PARM THAT TELLS THIS PROGRAM IF COMMITS      *  04330019
043400*    SHOULD BE DONE FOR EACH ROW FROM THE CURSOR BY THE        *  04340019
043500*    DLKUP003 PROGRAM.                                         *  04350019
043600*                                                              *  04360019
043700****************************************************************  04370019
043800                                                                  04380019
043900 3600-SELECT-DLSCMT.                                              04390019
044000                                                                  04400019
044100     MOVE SPACES TO KRPRPM-FUNC-TXT.                              04410019
044110     MOVE 'N'    TO KRPRPM-FUNC-TXT.                              04411020
044200                                                                  04420019
044300     PERFORM                                                      04430019
044400         WITH TEST AFTER                                          04440019
044500         VARYING PV-RETRY-COUNTER                                 04450019
044600         FROM 1 BY 1                                              04460019
044700         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  04470019
044800            OR SQLCODE = ZERO                                     04480019
044900            OR DP013-DB2-ABEND                                    04490019
045000                                                                  04500019
045100         EXEC SQL                                                 04510019
045200             SELECT  FUNC_TXT                                     04520019
045300              INTO   :KRPRPM-FUNC-TXT                             04530019
045400                                                                  04540019
045500              FROM   TKRPRPM                                      04550019
045600                                                                  04560019
045700             WHERE   LOC_ID            = 90                       04570019
045800               AND   INTFC_SYS_CDE     = 'DLX'                    04580019
045900               AND   FUNC_PRC_STAT_CDE = :PC-AC                   04590019
046000               AND   SYS_PRC_FUNC_CDE  = :PC-DLSCMT               04600019
046100               AND  (CURRENT DATE                                 04610019
046200                     BETWEEN DATE (FUNC_BEG_TMST) AND             04620019
046300                             DATE (FUNC_END_TMST))                04630019
046310             WITH UR                                              04631019
046400         END-EXEC                                                 04640019
046500                                                                  04650019
046600         EVALUATE TRUE                                            04660019
046700             WHEN SQLCODE = ZERO                                  04670019
046800                  MOVE KRPRPM-FUNC-TXT TO PV-DLSCMT-COMMIT-CDE    04680019
046900             WHEN SQLCODE = +100                                  04690019
047000             WHEN SQLCODE = -904                                  04700019
047100             WHEN SQLCODE = -911                                  04710019
047200             WHEN SQLCODE = -913                                  04720019
047300                  CONTINUE                                        04730019
047400                                                                  04740019
047500             WHEN SQLWARN0 NOT = SPACES                           04750019
047600             WHEN SQLCODE NOT = ZERO                              04760019
047700                  MOVE '3600-SELECT-DLSCMT' TO DP013-PARAGRAPH    04770019
047800                  INITIALIZE DP013-MESSAGE-TABLE                  04780019
047900                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  04790019
048000                  MOVE SQLCA     TO DP013-SQLCA                   04800019
048100                  MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)      04810019
048200                  SET DP013-LINK-RETURN TO TRUE                   04820019
048300                  SET DP013-NO-ROLLBACK TO TRUE                   04830019
048400                  SET DP013-DB2-ABEND   TO TRUE                   04840019
048500                  PERFORM DP014-0000-PROCESS-ABEND                04850019
048600                                                                  04860019
048700         END-EVALUATE                                             04870019
048800     END-PERFORM.                                                 04880019
048900                                                                  04890019
049000     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         04900019
049100        MOVE '3600-SELECT-DLSCMT' TO DP013-PARAGRAPH              04910019
049200        INITIALIZE DP013-MESSAGE-TABLE                            04920019
049300        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 04930019
049400                                DP013-MESSAGE-TEXT (1)            04940019
049500        MOVE SQLCA     TO DP013-SQLCA                             04950019
049600        MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)                04960019
049700        SET DP013-DB2-ABEND   TO TRUE                             04970019
049800        PERFORM DP014-0000-PROCESS-ABEND                          04980019
049900     END-IF.                                                      04990019
050000                                                                  05000019
050100****************************************************************  05010019
050200*    RETRIEVE THE PARM THAT TELLS THE NUMBER OF MINUTES AN     *  05020019
050300*    ASSIGNMENT WOULD BE OPEN IF THERE HAS BEEN NO ACTIVITY    *  05030019
050400*    AGAINST THE ASSIGNMENT (IF THE ASSIGNMENT HAS BEEN OPEN   *  05040019
050500*    FOR THE DLAINT MINUTES BUT THERE HAS BEEN NO ACTIVITY     *  05050019
050600*    AGAINST THE ASSIGNMENT (LAST_USD_SEQ_NBR = 0).            *  05060019
050700*                                                              *  05070019
050800****************************************************************  05080019
050900                                                                  05090019
051000 3800-SELECT-DLAMAX.                                              05100019
051100                                                                  05110019
051200     PERFORM                                                      05120019
051300         WITH TEST AFTER                                          05130019
051400         VARYING PV-RETRY-COUNTER                                 05140019
051500         FROM 1 BY 1                                              05150019
051600         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  05160019
051700            OR SQLCODE = ZERO                                     05170019
051800            OR SQLCODE = +100                                     05180019
051900            OR DP013-DB2-ABEND                                    05190019
052000                                                                  05200019
052100         EXEC SQL                                                 05210019
052200             SELECT  FUNC_QTY                                     05220019
052300              INTO   :PV-DLAMAX-FUNC-QTY                          05230019
052400                                                                  05240019
052500              FROM   TKRPRPM                                      05250019
052600                                                                  05260019
052700             WHERE   LOC_ID            = 90                       05270019
052800               AND   INTFC_SYS_CDE     = 'DLX'                    05280019
052900               AND   FUNC_PRC_STAT_CDE = :PC-AC                   05290019
053000               AND   SYS_PRC_FUNC_CDE  = :PC-DLAMAX               05300019
053100               AND  (CURRENT DATE                                 05310019
053200                     BETWEEN DATE (FUNC_BEG_TMST) AND             05320019
053300                             DATE (FUNC_END_TMST))                05330019
053310             WITH UR                                              05331019
053400         END-EXEC                                                 05340019
053500                                                                  05350019
053600         EVALUATE TRUE                                            05360019
053700             WHEN SQLCODE = ZERO                                  05370019
053800                  SET PS-DLAMAX-FOUND TO TRUE                     05380019
053900                                                                  05390019
054000             WHEN SQLCODE = -904                                  05400019
054100             WHEN SQLCODE = -911                                  05410019
054200             WHEN SQLCODE = -913                                  05420019
054300                  CONTINUE                                        05430019
054400                                                                  05440019
054500             WHEN SQLCODE = +100                                  05450019
054600                  SET PS-DLAMAX-NOT-FOUND TO TRUE                 05460019
054700                                                                  05470019
054800             WHEN SQLWARN0 NOT = SPACES                           05480019
054900             WHEN SQLCODE NOT = ZERO                              05490019
055000                  MOVE '3800-SELECT-DLAMAX' TO DP013-PARAGRAPH    05500019
055100                  INITIALIZE DP013-MESSAGE-TABLE                  05510019
055200                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  05520019
055300                  MOVE SQLCA     TO DP013-SQLCA                   05530019
055400                  MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)      05540019
055500                  SET DP013-LINK-RETURN TO TRUE                   05550019
055600                  SET DP013-NO-ROLLBACK TO TRUE                   05560019
055700                  SET DP013-DB2-ABEND   TO TRUE                   05570019
055800                  PERFORM DP014-0000-PROCESS-ABEND                05580019
055900                                                                  05590019
056000         END-EVALUATE                                             05600019
056100     END-PERFORM.                                                 05610019
056200                                                                  05620019
056300     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         05630019
056400        MOVE '3800-SELECT-DLAMAX' TO DP013-PARAGRAPH              05640019
056500        INITIALIZE DP013-MESSAGE-TABLE                            05650019
056600        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 05660019
056700                                DP013-MESSAGE-TEXT (1)            05670019
056800        MOVE SQLCA     TO DP013-SQLCA                             05680019
056900        MOVE 'TKRPRPM' TO DP013-DB2-TABLE-NAME (1)                05690019
057000        SET DP013-DB2-ABEND   TO TRUE                             05700019
057100        PERFORM DP014-0000-PROCESS-ABEND                          05710019
057200     END-IF.                                                      05720019
057300                                                                  05730019
057400****************************************************************  05740019
057500*                                                              *  05750019
057600*                                                              *  05760019
057700*                                                              *  05770019
057800****************************************************************  05780019
057900                                                                  05790019
058000 4000-PROCESS-ASSIGNMENTS.                                        05800019
058100                                                                  05810019
058200     SET PS-NOT-END-OF-CURSOR TO TRUE.                            05820019
058300     PERFORM 4200-OPEN-ASSIGNMENT-CURSOR.                         05830019
058400     PERFORM 4400-FETCH-ASSIGNMENT.                               05840019
058500                                                                  05850019
058600     PERFORM UNTIL (PS-END-OF-CURSOR)                             05860019
058700                                                                  05870019
058800         PERFORM 6000-CHECK-ASSIGNMENT                            05880019
058900                                                                  05890019
059000         PERFORM 4400-FETCH-ASSIGNMENT                            05900019
059100                                                                  05910019
059200     END-PERFORM.                                                 05920019
059300                                                                  05930019
059400     PERFORM 4600-CLOSE-ASSIGNMENT-CURSOR.                        05940019
059500                                                                  05950019
059600****************************************************************  05960019
059700*                                                              *  05970019
059800*                                                              *  05980019
059900****************************************************************  05990019
060000                                                                  06000019
060100 4200-OPEN-ASSIGNMENT-CURSOR.                                     06010019
060200                                                                  06020019
060300     PERFORM                                                      06030019
060400         WITH TEST AFTER                                          06040019
060500         VARYING PV-RETRY-COUNTER                                 06050019
060600         FROM 1 BY 1                                              06060019
060700         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  06070019
060800            OR SQLCODE = ZERO                                     06080019
060900            OR SQLCODE = +100                                     06090019
061000            OR DP013-DB2-ABEND                                    06100019
061100                                                                  06110019
061200         EXEC SQL                                                 06120019
061300              OPEN  ASSIGNMENT-CURSOR                             06130019
061400         END-EXEC                                                 06140019
061500                                                                  06150019
061600         EVALUATE TRUE                                            06160019
061700             WHEN SQLCODE = ZERO                                  06170019
061800                  CONTINUE                                        06180019
061900                                                                  06190019
062000             WHEN SQLCODE = -904                                  06200019
062100             WHEN SQLCODE = -913                                  06210019
062200             WHEN SQLCODE = -911                                  06220019
062300                  CONTINUE                                        06230019
062400                                                                  06240019
062500             WHEN SQLCODE = +100                                  06250019
062600                  CONTINUE                                        06260019
062700                                                                  06270019
062800             WHEN SQLWARN0 NOT = SPACES                           06280019
062900             WHEN SQLCODE NOT = ZERO                              06290019
063000                  MOVE '4200-OPEN-ASSIGNMENT-CURSOR' TO           06300019
063100                                    DP013-PARAGRAPH               06310019
063200                  INITIALIZE DP013-MESSAGE-TABLE                  06320019
063300                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  06330019
063400                  MOVE SQLCA     TO DP013-SQLCA                   06340019
063500                  MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)    06350019
063600                  SET DP013-LINK-RETURN TO TRUE                   06360019
063700                  SET DP013-NO-ROLLBACK TO TRUE                   06370019
063800                  SET DP013-DB2-ABEND   TO TRUE                   06380019
063900                  PERFORM DP014-0000-PROCESS-ABEND                06390019
064000         END-EVALUATE                                             06400019
064100     END-PERFORM.                                                 06410019
064200                                                                  06420019
064300     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         06430019
064400        MOVE '4200-OPEN-ASSIGNMENT-CURSOR' TO DP013-PARAGRAPH     06440019
064500        INITIALIZE DP013-MESSAGE-TABLE                            06450019
064600        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 06460019
064700                                DP013-MESSAGE-TEXT (1)            06470019
064800        MOVE SQLCA     TO DP013-SQLCA                             06480019
064900        MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)              06490019
065000        SET DP013-DB2-ABEND   TO TRUE                             06500019
065100        PERFORM DP014-0000-PROCESS-ABEND                          06510019
065200     END-IF.                                                      06520019
065300                                                                  06530019
065400****************************************************************  06540019
065500*                                                              *  06550019
065600*                                                              *  06560019
065700****************************************************************  06570019
065800                                                                  06580019
065900 4400-FETCH-ASSIGNMENT.                                           06590019
066000                                                                  06600019
066100     PERFORM                                                      06610019
066200         WITH TEST AFTER                                          06620019
066300         VARYING PV-RETRY-COUNTER                                 06630019
066400         FROM 1 BY 1                                              06640019
066500         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  06650019
066600            OR SQLCODE = ZERO                                     06660019
066700            OR SQLCODE = +100                                     06670019
066800            OR DP013-DB2-ABEND                                    06680019
066900                                                                  06690019
067000         EXEC SQL                                                 06700019
067100             FETCH  ASSIGNMENT-CURSOR                             06710019
067200                                                                  06720019
067300              INTO  :DLT00004-ASGMT-STRT-DTE                      06730019
067400                   ,:DLT00004-ASGMT-NBR-TXT                       06740019
067500                   ,:DLT00004-ASGMT-NBR-SEQ-NBR                   06750019
067600                   ,:DLT00004-ASGMT-STRT-TM                       06760019
067700                   ,:DLT00004-LAST-USD-SEQ-NBR                    06770019
067800                   ,:DLT00004-WK-TYP-DESC                         06780019
067900                   ,:DLT00004-WK-AREA-DESC                        06790019
068000                   ,:DLT00004-DC-NBR                              06800019
068100                   ,:PV-ASGMT-TIMESTAMP                           06810019
068200                   ,:PV-DLAINT-TIMESTAMP                          06820019
068300                   ,:PV-DLAMAX-TIMESTAMP                          06830019
068400                                                                  06840019
068500         END-EXEC                                                 06850019
068600                                                                  06860019
068700         EVALUATE TRUE                                            06870019
068800             WHEN SQLCODE = ZERO                                  06880019
068900                  ADD 1 TO PV-DLAINT-COUNT                        06890019
069000                  ADD 1 TO PV-ASGMNT-FETCHES                      06900019
069100                                                                  06910019
069200             WHEN SQLCODE = +100                                  06920019
069300                  SET PS-END-OF-CURSOR TO TRUE                    06930019
069400                                                                  06940019
069500             WHEN SQLCODE = -904                                  06950019
069600             WHEN SQLCODE = -911                                  06960019
069700             WHEN SQLCODE = -913                                  06970019
069800                  CONTINUE                                        06980019
069900                                                                  06990019
070000             WHEN SQLWARN0 NOT = SPACES                           07000019
070100             WHEN SQLCODE NOT = ZERO                              07010019
070200                  SET PS-END-OF-CURSOR TO TRUE                    07020019
070300                  MOVE '4400-FETCH-ASSIGNMENT' TO                 07030019
070400                                    DP013-PARAGRAPH               07040019
070500                  INITIALIZE DP013-MESSAGE-TABLE                  07050019
070600                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  07060019
070700                  MOVE SQLCA     TO DP013-SQLCA                   07070019
070800                  MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)    07080019
070900                  SET DP013-LINK-RETURN TO TRUE                   07090019
071000                  SET DP013-NO-ROLLBACK TO TRUE                   07100019
071100                  SET DP013-DB2-ABEND   TO TRUE                   07110019
071200                  PERFORM DP014-0000-PROCESS-ABEND                07120019
071300         END-EVALUATE                                             07130019
071400     END-PERFORM.                                                 07140019
071500                                                                  07150019
071600     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07160019
071700        MOVE '4400-FETCH-ASSIGNMENT' TO DP013-PARAGRAPH           07170019
071800        INITIALIZE DP013-MESSAGE-TABLE                            07180019
071900        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 07190019
072000                                DP013-MESSAGE-TEXT (1)            07200019
072100        MOVE SQLCA     TO DP013-SQLCA                             07210019
072200        MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)              07220019
072300        SET DP013-DB2-ABEND   TO TRUE                             07230019
072400        PERFORM DP014-0000-PROCESS-ABEND                          07240019
072500     END-IF.                                                      07250019
072600                                                                  07260019
072700                                                                  07270019
072800****************************************************************  07280019
072900*                                                              *  07290019
073000*                                                              *  07300019
073100****************************************************************  07310019
073200                                                                  07320019
073300 4600-CLOSE-ASSIGNMENT-CURSOR.                                    07330019
073400                                                                  07340019
073500     PERFORM                                                      07350019
073600         WITH TEST AFTER                                          07360019
073700         VARYING PV-RETRY-COUNTER                                 07370019
073800         FROM 1 BY 1                                              07380019
073900         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  07390019
074000            OR SQLCODE = ZERO                                     07400019
074100            OR SQLCODE = +100                                     07410019
074200            OR DP013-DB2-ABEND                                    07420019
074300                                                                  07430019
074400         EXEC SQL                                                 07440019
074500              CLOSE ASSIGNMENT-CURSOR                             07450019
074600         END-EXEC                                                 07460019
074700                                                                  07470019
074800         EVALUATE TRUE                                            07480019
074900             WHEN SQLCODE = ZERO                                  07490019
075000                  CONTINUE                                        07500019
075100                                                                  07510019
075200             WHEN SQLCODE = -904                                  07520019
075300             WHEN SQLCODE = -913                                  07530019
075400             WHEN SQLCODE = -911                                  07540019
075500                                                                  07550019
075600             WHEN SQLWARN0 NOT = SPACES                           07560019
075700             WHEN SQLCODE NOT = ZERO                              07570019
075800                  MOVE '4600-CLOSE-ASSIGNMENT-CURSOR' TO          07580019
075900                                    DP013-PARAGRAPH               07590019
076000                  INITIALIZE DP013-MESSAGE-TABLE                  07600019
076100                  MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)  07610019
076200                  MOVE SQLCA     TO DP013-SQLCA                   07620019
076300                  MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)    07630019
076400                  SET DP013-LINK-RETURN TO TRUE                   07640019
076500                  SET DP013-NO-ROLLBACK TO TRUE                   07650019
076600                  SET DP013-DB2-ABEND   TO TRUE                   07660019
076700                  PERFORM DP014-0000-PROCESS-ABEND                07670019
076800         END-EVALUATE                                             07680019
076900     END-PERFORM.                                                 07690019
077000                                                                  07700019
077100     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         07710019
077200        MOVE '4600-CLOSE-ASSIGNMENT-CURSOR' TO DP013-PARAGRAPH    07720019
077300        INITIALIZE DP013-MESSAGE-TABLE                            07730019
077400        MOVE 'MAX RETRIES EXCEEDED FOR SELECT' TO                 07740019
077500                                DP013-MESSAGE-TEXT (1)            07750019
077600        MOVE SQLCA     TO DP013-SQLCA                             07760019
077700        MOVE 'DLT_ASGMT' TO DP013-DB2-TABLE-NAME (1)              07770019
077800        SET DP013-DB2-ABEND   TO TRUE                             07780019
077900        PERFORM DP014-0000-PROCESS-ABEND                          07790019
078000     END-IF.                                                      07800019
078100                                                                  07810019
078200                                                                  07820019
078300****************************************************************  07830019
078400*    FOLLOWING CHECKS IF THERE WAS ANY ACTIVITY ON THE ASSIGN- *  07840019
078500*        MENT (DLT00004-LAST-USD-SEQ-NBR > 0).  IF THERE       *  07850019
078600*        WASN'T ANY ACTIVITY (DLT00004-LAST-USD-SEQ-NBR = 0)   *  07860019
078700*        CHECK IF THERE WERE ANY DIVERTED CARTONS (6400-).     *  07870019
078800*                                                              *  07880019
078900*    IF THERE WERE DIVERTED CARTONS, CALL DLKUP003 TO PUT OUT  *  07890019
079000*        THE DOOR SUMMARY AND ASSIGNMENT CLOSE BUSINESS        *  07900019
079100*        EVENTS OTHERWISE ONLY CALL DLKUP003 IF THE ASSIGN-    *  07910019
079200*        MENT TIMESTAMP IS LESS THAN THE DLAMAX-TIMESTAMP.     *  07920019
079300*                                                              *  07930019
079400****************************************************************  07940019
079500                                                                  07950019
079600 6000-CHECK-ASSIGNMENT.                                           07960019
079700                                                                  07970019
079800     IF DLT00004-LAST-USD-SEQ-NBR = 0                             07980019
079900**      ONLY CHECK FOR DIVERTS ON SHIPPING ASSIGNMENTS.           07990019
080000        IF DLT00004-WK-TYP-DESC = 'SHIP'                          08000019
080100           PERFORM 6400-COUNT-DIVERTS                             08010019
080200        ELSE                                                      08020019
080300**         FOR NON-SHIPPING ASSIGNMENTS, SET THE DIVERT COUNT     08030019
080400**             TO ZERO, SO IT DROPS INTO THE LOGIC BELOW.         08040019
080500           MOVE 0 TO PV-DIVERT-COUNT                              08050019
080600        END-IF                                                    08060019
080700                                                                  08070019
080800        IF PV-DIVERT-COUNT = 0                                    08080019
080900           ADD 1 TO PV-ASGMNT-LAST-USED-0                         08090019
081000           IF PV-ASGMT-TIMESTAMP < PV-DLAMAX-TIMESTAMP            08100019
081100              INITIALIZE DL007-ASGMT-COMMAREA                     08110019
081200              SET DL007-END-ASGMT            TO TRUE              08120019
081400              SET DL007-NO-LOG-TO-EAI-EXPORT TO TRUE              08140019
081500              SET DL007-STOP-TIME-EXP        TO TRUE              08150019
081510              MOVE PV-DLSCMT-COMMIT-CDE TO                        08151019
081520                   DL007-COMMIT-CDE                               08152019
081530*             STRING ' ' PC-DLKCS408                              08153022
081540*             ' COMMIT CODE:  '                                   08154022
081550*             PV-DLSCMT-COMMIT-CDE                                08155022
081580*             DELIMITED BY SIZE                                   08158022
081590*             INTO PV-LOG-LINE                                    08159022
081610*             PERFORM 8100-WRITEQ-TD-LOG                          08161022
081700              PERFORM 6800-CALL-DLKUP003                          08170019
081800          END-IF                                                  08180019
081900        ELSE                                                      08190019
082000           ADD 1 TO PV-ASGMNT-LAST-USED-OTH                       08200019
082100           INITIALIZE DL007-ASGMT-COMMAREA                        08210019
082200           SET DL007-END-COPY-ASGMT-WTEAM TO TRUE                 08220019
082400           SET DL007-LOG-TO-EAI-EXPORT    TO TRUE                 08240019
082500           SET DL007-STOP-TIME-EXP        TO TRUE                 08250019
082510           MOVE PV-DLSCMT-COMMIT-CDE TO                           08251019
082520                DL007-COMMIT-CDE                                  08252019
082700           PERFORM 6800-CALL-DLKUP003                             08270019
082800        END-IF                                                    08280019
082900     ELSE                                                         08290019
083000        ADD 1 TO PV-ASGMNT-LAST-USED-OTH                          08300019
083100        INITIALIZE DL007-ASGMT-COMMAREA                           08310019
083200        SET DL007-END-COPY-ASGMT-WTEAM TO TRUE                    08320019
083400        SET DL007-LOG-TO-EAI-EXPORT    TO TRUE                    08340019
083500        SET DL007-STOP-TIME-EXP        TO TRUE                    08350019
083510        MOVE PV-DLSCMT-COMMIT-CDE TO                              08351019
083520             DL007-COMMIT-CDE                                     08352019
083700        PERFORM 6800-CALL-DLKUP003                                08370019
083800                                                                  08380019
083900     END-IF.                                                      08390019
084000                                                                  08400019
084100****************************************************************  08410019
084200*    COUNTS THE NUMBER OF DIVERTED CARTONS.                    *  08420019
084300*                                                              *  08430019
084400*    SHOULD ONLY BE DONE FOR SHIPPING EVENTS.                  *  08440019
084500****************************************************************  08450019
084600                                                                  08460019
084700 6400-COUNT-DIVERTS.                                              08470019
084800                                                                  08480019
084900     STRING DLT00004-ASGMT-STRT-DTE                               08490019
085000            '-'                                                   08500019
085100            DLT00004-ASGMT-STRT-TM                                08510019
085200            '.000000'                                             08520019
085300            DELIMITED BY SIZE                                     08530019
085400            INTO PV-TIMESTAMP.                                    08540019
085500     MOVE DLT00004-WK-AREA-DESC  TO DL011-SHIP-DOORGRP-WRK-AREA.  08550019
085600     MOVE DL011-SD-WRK-AREA-DOOR-GROUP TO                         08560019
085700                                 PV-SD-WRK-AREA-DOOR-GROUP.       08570019
085800                                                                  08580019
085900     MOVE 0 TO PV-DIVERT-COUNT.                                   08590019
086000                                                                  08600019
086100     EXEC SQL                                                     08610019
086200             SELECT  DRVT.OPER_UNT_ID                             08620019
086300              INTO   :SUCRDV-OPER-UNT-ID                          08630019
086400                                                                  08640019
086500          FROM  DLT_DOOR_GP      GP                               08650019
086600               ,DLT_DOOR_GP_TMPL TMPL                             08660019
086700               ,TSUCRDV          DRVT                             08670019
086800                                                                  08680019
086900         WHERE  GP.DOOR_GP_NBR       = :PV-SD-WRK-AREA-DOOR-GROUP 08690019
087000           AND  TMPL.DOOR_GP_TMPL_ID = GP.DOOR_GP_TMPL_ID         08700019
087100           AND  TMPL.DC_NBR          = :DLT00004-DC-NBR           08710019
087200           AND  TMPL.ACTV_IND        = 'Y'                        08720019
087300           AND  DRVT.DOOR_ID         = GP.DOOR_ID                 08730019
087400           AND  DRVT.ACTV_CDE        = 'A'                        08740019
087500           AND  DRVT.OPER_UNT_ID     = TMPL.DC_NBR                08750019
087600           AND  DRVT.DIVERT_TMST     > :PV-TIMESTAMP              08760019
087700                                                                  08770019
087800     END-EXEC.                                                    08780019
087900                                                                  08790019
088000     EVALUATE TRUE                                                08800019
088100         WHEN SQLCODE = ZERO OR -811                              08810019
088200              MOVE 1 TO PV-DIVERT-COUNT                           08820019
088300                                                                  08830019
088400         WHEN SQLCODE = +100                                      08840019
088500              CONTINUE                                            08850019
088600                                                                  08860019
088700         WHEN OTHER                                               08870019
088800              MOVE '6400-COUNT-DIVERTS          ' TO              08880019
088900                                DP013-PARAGRAPH                   08890019
089000              INITIALIZE DP013-MESSAGE-TABLE                      08900019
089100              MOVE 'SELECT FAILED' TO DP013-MESSAGE-TEXT (1)      08910019
089200              MOVE SQLCA     TO DP013-SQLCA                       08920019
089300              MOVE 'DLT_DOOR_GP' TO DP013-DB2-TABLE-NAME (1)      08930019
089400              SET DP013-LINK-RETURN TO TRUE                       08940019
089500              SET DP013-NO-ROLLBACK TO TRUE                       08950019
089600              SET DP013-DB2-ABEND   TO TRUE                       08960019
089700              PERFORM DP014-0000-PROCESS-ABEND                    08970019
089800                                                                  08980019
089900     END-EVALUATE.                                                08990019
090000                                                                  09000019
090100****************************************************************  09010019
090200*    CREATES A NEW ASSIGNMENT, ENDS AN EXISTING ASSIGNMENT,    *  09020019
090300*        AND / OR COPIES AN ASSIGNMENT.                        *  09030019
090400****************************************************************  09040019
090500                                                                  09050019
090600 6800-CALL-DLKUP003.                                              09060019
090700                                                                  09070019
090800     MOVE DLT00004-ASGMT-STRT-DTE TO DL007-ECA-KEY-START-DTE.     09080019
090900     MOVE DLT00004-ASGMT-NBR-TXT  TO DL007-ECA-KEY-NBR-TXT.       09090019
091000     MOVE DLT00004-ASGMT-NBR-SEQ-NBR TO                           09100019
091100                                 DL007-ECA-KEY-NBR-SEQ-NBR.       09110019
091200     MOVE PC-DLKCS408 TO DL007-ECA-STOP-PGM-NM.                   09120019
091300     MOVE PC-DLKCS408 TO DL007-ORIG-CALLING-PGM-NM.               09130019
091400                                                                  09140019
091500     CALL DL007-USER-PGM USING DFHEIBLK                           09150019
091600                               DL007-COMMAREA                     09160019
091700                               DL007-ASGMT-COMMAREA.              09170019
091800                                                                  09180019
091900     IF DL007-SUCCESSFUL                                          09190019
092000        CONTINUE                                                  09200019
092100     ELSE                                                         09210019
092200        SET DL007-CALLED-MODULE-FAILURE TO TRUE                   09220019
092300        MOVE DL007-USER-PGM TO DL007-CALL-MOD-FAIL-NM             09230019
092400        MOVE DL007-RETURN-CODE TO DL007-CALL-MOD-FAIL-ERR-CDE     09240019
092500        PERFORM 7100-FORMAT-DLKUP003-ERROR                        09250019
092600     END-IF.                                                      09260019
092700                                                                  09270019
092800****************************************************************  09280019
092900*    FORMAT ERROR MESSAGE INFORMION ON CICS LOG.               *  09290019
093000*                                                              *  09300019
093100****************************************************************  09310019
093200                                                                  09320019
093300 7100-FORMAT-DLKUP003-ERROR.                                      09330019
093400                                                                  09340019
093500     MOVE DL007-ASGMT-SQLCODE TO PV-SQLCODE.                      09350019
093600                                                                  09360019
093700     STRING ' ' PC-DLKCS408                                       09370019
093800            ' ERROR CALLING DLKUP003 - '                          09380019
093900            ' RETURN CODE IS - '                                  09390019
094000             DL007-RETURN-CODE                                    09400019
094100            ' - PARA - '                                          09410019
094200             DL007-SQL-ERROR-PARA                                 09420019
094300            ' - SQLCODE - '                                       09430019
094400             PV-SQLCODE                                           09440019
094500             PC-BLANKS                                            09450019
094600             DELIMITED BY SIZE                                    09460019
094700             INTO PV-LOG-LINE.                                    09470019
094800                                                                  09480019
094900     PERFORM 8100-WRITEQ-TD-LOG.                                  09490019
095000                                                                  09500019
095100     STRING ' ' PC-DLKCS408                                       09510019
095200            ' PROCESS-ASGMT-CODE ---> '                           09520019
095300             DL007-PROCESS-ASGMT-CDE                              09530019
095400            ' - COMMIT-CDE ---> '                                 09540019
095500             DL007-COMMIT-CDE                                     09550019
095600            ' - CALL MOD ---> '                                   09560019
095700             DL007-CALL-MOD-FAIL-NM                               09570019
095800            ' - CALL ERR ---> '                                   09580019
095900             DL007-CALL-MOD-FAIL-ERR-CDE                          09590019
096000             PC-BLANKS                                            09600019
096100             DELIMITED BY SIZE                                    09610019
096200             INTO PV-LOG-LINE.                                    09620019
096300                                                                  09630019
096400     PERFORM 8100-WRITEQ-TD-LOG.                                  09640019
096500                                                                  09650019
096600     STRING ' ' PC-DLKCS408                                       09660019
096700            ' ECA-KEY-START-DTE ---> '                            09670019
096800             DL007-ECA-KEY-START-DTE                              09680019
096900            ' - ECA-KEY-NBR-TXT ---> '                            09690019
097000             DL007-ECA-KEY-NBR-TXT                                09700019
097100             PC-BLANKS                                            09710019
097200             DELIMITED BY SIZE                                    09720019
097300             INTO PV-LOG-LINE.                                    09730019
097400                                                                  09740019
097500     PERFORM 8100-WRITEQ-TD-LOG.                                  09750019
097600                                                                  09760019
097700     MOVE DL007-ECA-KEY-NBR-SEQ-NBR TO PV-SEQ-NBR.                09770019
097800     STRING ' ' PC-DLKCS408                                       09780019
097900            ' ECA-KEY-NBR-SEQ-NBR ---> '                          09790019
098000             PV-SEQ-NBR                                           09800019
098100             PC-BLANKS                                            09810019
098200             DELIMITED BY SIZE                                    09820019
098300             INTO PV-LOG-LINE.                                    09830019
098400                                                                  09840019
098500     PERFORM 8100-WRITEQ-TD-LOG.                                  09850019
098600                                                                  09860019
098700****************************************************************  09870019
098800*    ENQUEUE THE CICS LOG.                                     *  09880019
098900*                                                              *  09890019
099000****************************************************************  09900019
099100                                                                  09910019
099200 8000-ENQUEUE-LOG.                                                09920019
099300                                                                  09930019
099400     EXEC CICS                                                    09940019
099500          ENQ RESOURCE (PC-LOG-QUEUE-RESOURCE)                    09950019
099600     END-EXEC.                                                    09960019
099700                                                                  09970019
099800****************************************************************  09980019
099900*    WRITE TO THE CICS LOG.                                    *  09990019
100000*                                                              *  10000019
100100****************************************************************  10010019
100200                                                                  10020019
100300 8100-WRITEQ-TD-LOG.                                              10030019
100400                                                                  10040019
100500     EXEC CICS                                                    10050019
100600          WRITEQ TD                                               10060019
100700           QUEUE (PC-LOG-QUEUE)                                   10070019
100800            FROM (PV-LOG-LINE)                                    10080019
100900            RESP (PV-CICS-RESPONSE)                               10090019
101000     END-EXEC.                                                    10100019
101100                                                                  10110019
101200     IF PV-CICS-RESPONSE = DFHRESP (NORMAL)                       10120019
101300        CONTINUE                                                  10130019
101400     ELSE                                                         10140019
101500        SET DP013-CICS-ABEND    TO TRUE                           10150019
101600        SET DP013-LINK-RETURN   TO TRUE                           10160019
101700        SET DP013-NO-ROLLBACK   TO TRUE                           10170019
101800        MOVE '8100-WRITE-TD-LOG' TO DP013-PARAGRAPH               10180019
101900        INITIALIZE DP013-MESSAGE-TABLE                            10190019
102000        MOVE 'BAD RETURN CODE FROM WRITE TO CSSL' TO              10200019
102100                                    DP013-MESSAGE-TEXT (1)        10210019
102200        PERFORM DP014-0000-PROCESS-ABEND                          10220019
102300     END-IF.                                                      10230019
102400                                                                  10240019
102500****************************************************************  10250019
102600*    DEQUEUE THE CICS LOG                                      *  10260019
102700*                                                              *  10270019
102800****************************************************************  10280019
102900                                                                  10290019
103000 8300-DEQUEUE-LOG.                                                10300019
103100                                                                  10310019
103200     EXEC CICS                                                    10320019
103300          DEQ RESOURCE (PC-LOG-QUEUE-RESOURCE)                    10330019
103400     END-EXEC.                                                    10340019
103500                                                                  10350019
103600     EXEC CICS                                                    10360019
103700          RETURN                                                  10370019
103800     END-EXEC.                                                    10380019
103900                                                                  10390019
104000****************************************************************  10400019
104100*    GET CURRENT TIMESTAMP                                     *  10410019
104200*                                                              *  10420019
104300****************************************************************  10430019
104400                                                                  10440019
104500 8400-GET-TIMESTAMP.                                              10450019
104600                                                                  10460019
104700     EXEC SQL                                                     10470019
104800                                                                  10480019
104900         SET  :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           10490019
105000                                                                  10500019
105100     END-EXEC.                                                    10510019
105200                                                                  10520019
105300     EVALUATE TRUE                                                10530019
105400         WHEN SQLCODE = ZERO                                      10540019
105500              CONTINUE                                            10550019
105600                                                                  10560019
105700         WHEN OTHER                                               10570019
105800              CONTINUE                                            10580019
105900                                                                  10590019
106000      END-EVALUATE.                                               10600019
106100                                                                  10610019
106200****************************************************************  10620019
106300*                                                              *  10630019
106400*                                                              *  10640019
106500****************************************************************  10650019
106600                                                                  10660019
106700 9000-TERMINATE.                                                  10670019
106800                                                                  10680019
106900     PERFORM 8400-GET-TIMESTAMP.                                  10690019
107000                                                                  10700019
107100     STRING ' ' PC-DLKCS408                                       10710019
107200            ' ENDED AT '                                          10720019
107300             PV-CURRENT-TIMESTAMP (12:8)                          10730019
107400            ' ON '                                                10740019
107500             PV-CURRENT-TIMESTAMP (1:10)                          10750019
107600             PC-BLANKS                                            10760019
107700             DELIMITED BY SIZE                                    10770019
107800             INTO PV-LOG-LINE.                                    10780019
107900                                                                  10790019
108000     PERFORM 8100-WRITEQ-TD-LOG.                                  10800019
108100                                                                  10810019
108200     MOVE PV-ASGMNT-FETCHES       TO PV-WORK-1.                   10820019
108300     MOVE PV-ASGMNT-LAST-USED-0   TO PV-WORK-2.                   10830019
108400     MOVE PV-ASGMNT-LAST-USED-OTH TO PV-WORK-3.                   10840019
108500                                                                  10850019
108600     STRING ' ' PC-DLKCS408                                       10860019
108700            ' FETCHES --> '                                       10870019
108800             PV-WORK-1                                            10880019
108900            ' - LAST-USED-0 - '                                   10890019
109000             PV-WORK-2                                            10900019
109100            ' - LAST-USED-OTH - '                                 10910019
109200             PV-WORK-3                                            10920019
109300             PC-BLANKS                                            10930019
109400             DELIMITED BY SIZE                                    10940019
109500             INTO PV-LOG-LINE.                                    10950019
109600                                                                  10960019
109700     PERFORM 8100-WRITEQ-TD-LOG.                                  10970019
109800                                                                  10980019
109900     PERFORM 8300-DEQUEUE-LOG.                                    10990019
110000                                                                  11000019
110100                                                                  11010019
110200****************************************************************  11020019
110300*    ABEND PROCESSOR MODULE - FOR NON-ARCHITECTURE PROGRAMS.   *  11030019
110400*                                                              *  11040019
110500****************************************************************  11050019
110600                                                                  11060019
110700     COPY DPPD014.                                                11070019
110800                                                                  11080019
