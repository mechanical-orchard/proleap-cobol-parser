000100 IDENTIFICATION DIVISION.                                         00010024
000200 PROGRAM-ID.     APKUP033.                                        00020024
000300 AUTHOR.         MARILYN WILKINSON.                               00030024
000400*DATE-WRITTEN.   10/31/96.                                        00040024
000500*DATE-COMPILED.                                                   00050024
000600******************************************************************00060046
000700*    COBOL 2 WITH SQL                                            *00070046
000800*                                                                *00080046
000900*    AUTOMATIC WRITE OFF OF INVOICES CLEAN UP                    *00090046
001000*    TINVOIC -                                                   *00100046
001100*                                                                *00110046
001200* OUTPUT:                                                        *00120046
001300* 1.  REPORT OF WRITE OFF INVOICES THAT ARE 'EN','RC','IB',      *00130046
001400*                                           'OB','RL'            *00140046
001500*                                                                *00150046
001600******************************************************************00160046
001700* CHANGE LOG:                                                    *00170046
001800*                                                                *00180046
001900* 10/31/96    INITIAL VERSION.                                   *00190046
002000*                                                                *00200046
002100* 02/03/98   ROBIN BERNOSKI                WR/IR #: WR5703       *00210046
002200*            - REPLACED ++INCLUDES WITH COPY STATEMENTS.         *00220046
002300*                                                                *00230046
002400* 06/17/2002                                                     *00240046
002500*    ARK PO PROJECT PHASE 1.  RECOMPILE FROM PRODUCTION.         *00250046
002600* MADE BY: KEVIN CATLIN                WR#: 23500                *00260046
002700*                                                                *00270046
002800* 06/21/2002                                                     *00280046
002900*    ARK PO PROJECT PHASE 1.  REMOVE ALL REFERENCES TO           *00290046
003000*    TABLE TPAYREQ.                                              *00300046
003100* MADE BY: KEVIN CATLIN                WR#: 23500                *00310046
003200*                                                                *00320046
003300* 09/09/2002                                                     *00330046
003400*    ARK PO PROJECT PHASE 2.  REPLACED PAYT-REQ-SEQ-NBR          *00340046
003500*    WITH THE NEW UNIQUE INDEX CONSISTING OF PO NUMBER           *00350046
003600*    AND INVOICE ID IN PARAGRAPH B300-UPDATE-AUDIT.              *00360046
003700*    ALSO, ANY REFERENCES TO THE APWS900 COPY BOOK WAS           *00370046
003800*    REMOVED BECAUSE IT IS NO LONGER SUPPORTED.                  *00380046
003900* MADE BY : BRIAN HASSLINGER           WR#: 23500                *00390046
004000*                                                                *00400046
004100* 04/22/2004                                                     *00410046
004200*    INCREASED THE LENGTH OF VARIOUS W/S STORE FIELDS TO         *00420046
004300*    HOLD 4 DIGITS AS PART OF THE STORE CONSTRAINTS PROJECT.     *00430046
004400* MADE BY : MIKE BESKE                 WR#: 25805                *00440046
004500*                                                                *00450046
004600* DATE  03/11/2007                                               *00460046
004700*     CHANGE MADE: MATCH BY DC PROJECT                           *00470046
004800*     REMOVED ALL LOGIC RELATED TO TAUDINC TABLE.  ADDED         *00480046
004900*     CODE TO FETCH DC_NBR AND MTCH_LVL_CDE FROM TINVOIC AND     *00490046
005000*     DISPLAY THEM ON THE REPORT.                                *00500046
005100*     DELETE PARA B300-.                                         *00510046
005200*     MOD PARA C100-, R100-, W100-.                              *00520046
005300*     MADE BY: MIKE BESKE              WR/IR #: WR21578          *00530046
005400*                                                                *00540046
005410* DATE  11/04/2014                                               *00541046
005420*     CHANGES MADE: PO EXTENDED DIGIT CHANGES.                   *00542046
005430*     EXTENDED PO# FROM 7 TO 9.                                  *00543046
005440*     MADE BY: COGNIZANT               WR/IR #: CHG0094517       *00544046
005450*                                                                *00545046
005460* DATE  04/16/2020                                               *00546046
005470*     CHANGE MADE: RESTRUCTURED PROGRAM.  ADDED LOGIC TO EXAMINE *00547046
005480*     THE MATCH LEVEL CODE ON EACH INVOICE AND UPDATE MATCH LEVEL*00548046
005490*     TO 'P' IF IT IS NOT ALREADY THAT VALUE.  IF MATCH LEVEL IS *00549046
005491*     ALREADY 'P', UPDATE THE INVOICE STATUS TO 'DE' AS IS DONE  *00549146
005492*     IN PRIOR VERSION.  ADDED AN UPDATE COMMENT TO THE DETAIL   *00549246
005493*     REPORT LINE.                                               *00549346
005494*     MADE BY: NANCY EILBES            WR/IR #: CHG0242838       *00549446
005500******************************************************************00550046
005600                                                                  00560030
005700 ENVIRONMENT DIVISION.                                            00570030
005800                                                                  00580030
005900 INPUT-OUTPUT SECTION.                                            00590030
006000                                                                  00600030
006100 FILE-CONTROL.                                                    00610030
006200                                                                  00620030
006300     SELECT WRITE-OFF-RPT-FILE                                    00630030
006400         ASSIGN         TO UT-S-RPT01.                            00640030
006500                                                                  00650030
006600 DATA DIVISION.                                                   00660030
006700                                                                  00670030
006800 FILE SECTION.                                                    00680030
006900                                                                  00690030
007000 FD  WRITE-OFF-RPT-FILE                                           00700030
007100         LABEL RECORDS  ARE STANDARD                              00710030
007200         RECORDING MODE IS  F                                     00720030
007300         DATA RECORD    IS  REPORT-RECORD.                        00730030
007400                                                                  00740030
007500 01  REPORT-RECORD PIC X(132).                                    00750030
007600                                                                  00760030
007700 WORKING-STORAGE SECTION.                                         00770030
007800                                                                  00780030
007900 01  FILLER                        PIC X(25) VALUE                00790030
008000                             'WS FOR APKUP033 BEGINS==>'.         00800030
008100 01  PV-RECORDS-WRITTEN            PIC 9(09) VALUE ZEROS.         00810030
008200                                                                  00820030
008300 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00830030
008400                                             VALUE ZEROS.         00840030
008500     88 AP-DB2-ERROR               VALUE +4013.                   00850030
008600                                                                  00860030
008700 01  PC-CONSTANT-AREA.                                            00870030
008800     05  PC-SPACES                 PIC  X(12) VALUE SPACES.       00880030
008900                                                                  00890030
009000 01  PV-RETRY-COUNTER              PIC S9(4) COMP VALUE ZERO.     00900030
009100 01  PV-ABEND-FIELDS.                                             00910030
009200     05  PV-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP033'. 00920030
009300     05  PV-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00930030
009400     05  PV-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00940030
009500     05  PV-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00950030
009600     05  PV-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     00960030
009700     05  PV-ABEND-STRUCTURE-3         PIC X(8)  VALUE SPACES.     00970030
009800     05  PV-ABEND-STATUS              PIC XX    VALUE SPACES.     00980030
009900                                                                  00990030
010000 01  PV-SWITCHES.                                                 01000030
010100     05  INVOIC-DATA-SW               PIC X(03) VALUE 'NO '.      01010030
010200         88  MORE-INVOIC-DATA         VALUE 'YES'.                01020030
010300         88  NO-MORE-INVOIC-DATA      VALUE 'NO '.                01030030
010400                                                                  01040030
010500 01  PV-COMMENT-VALUES.                                           01050043
010600     05  PV-DE-STATUS            PIC X(35)   VALUE                01060043
010700         'INVOICE STATUS UPDATED TO DE'.                          01070043
010701     05  PV-MTCH-LEVEL           PIC X(35)   VALUE                01070143
010702         'INVOICE MATCH LEVEL UPDATED TO P'.                      01070243
010703     05  PV-RL-STATUS            PIC X(35)   VALUE                01070343
010704         'INVOICE IN RL STATUS - NO UPDATE'.                      01070443
010710                                                                  01071043
010720 01  PV-WORK-AREA.                                                01072043
010730     05  PV-MAX-LINES            PIC S9(03)  VALUE +60            01073043
010740                                             COMP-3.              01074043
010800     05  PV-LINE-COUNT           PIC S9(03)  VALUE +99            01080030
010900                                             COMP-3.              01090030
011000     05  PV-PAGE-COUNT           PIC S9(05)  VALUE ZEROS          01100030
011100                                             COMP-3.              01110030
011200     05  PV-GRO-COST-X.                                           01120030
011300         10  PV-GRO-COST         PIC -Z(08).99 VALUE ZEROS.       01130030
011400     05  PV-AUD-TAB-AMT REDEFINES PV-GRO-COST-X                   01140030
011500                                 PIC  X(12).                      01150030
011600     05  PV-STR-NBR              PIC  S9(4).                      01160030
011700     05  PV-DC-NBR               PIC  S9(4).                      01170031
011800                                                                  01180030
011900 01  RUN-TIME.                                                    01190030
012000     05  R-HR                    PIC 99.                          01200030
012100     05  R-MIN                   PIC 99.                          01210030
012200     05  R-SEC                   PIC 99.                          01220030
012300     05  R-TH                    PIC 99.                          01230030
012400*                                                                 01240030
012500 01  DATE-IN.                                                     01250030
012600     05 DATE-IN-YY               PIC XX.                          01260030
012700     05 DATE-IN-MM               PIC XX.                          01270030
012800     05 DATE-IN-DD               PIC XX.                          01280030
012900                                                                  01290030
013000 01  PV-JULIAN-DATE              PIC 9(05)  VALUE ZEROS.          01300030
013100 EJECT                                                            01310030
013200*---------------------------------------------------------------  01320030
013300*  SYSIBM SYSCOLUMNS DATA                                         01330030
013400*---------------------------------------------------------------  01340030
013500 EJECT                                                            01350030
013600     COPY DPWS132O.                                               01360030
013700 SKIP1                                                            01370030
013800 01  H2-HEADER2.                                                  01380030
013900     05  FILLER              PIC X(49)   VALUE SPACES.            01390030
014000     05  FILLER              PIC X(35)   VALUE                    01400030
014100         'WRITE-OFF INVOICES EXCEPTION REPORT'.                   01410030
014200     05  FILLER              PIC X(48)   VALUE SPACES.            01420030
014300 SKIP1                                                            01430030
014400 01  DH-DETAIL-HEAD1.                                             01440030
014500     05  FILLER              PIC X(25)   VALUE                    01450030
014600         'PO NUMBER    STORE NBR  I'.                             01460030
014700     05  FILLER              PIC X(25)   VALUE                    01470030
014800         'NVOICE ID               G'.                             01480030
014900     05  FILLER              PIC X(25)   VALUE                    01490030
015000         'ROSS COST AMT   STATUS  D'.                             01500035
015100     05  FILLER              PIC X(20)   VALUE                    01510043
015200         'C NBR   MATCH LVL   '.                                  01520043
015300     05  FILLER              PIC X(25)   VALUE                    01530030
015400         'UPDATE COMMENTS          '.                             01540043
015500     05  FILLER              PIC X(07)   VALUE                    01550030
015600         '       '.                                               01560030
015700                                                                  01570030
015800 01 DL-DETAIL-LINE.                                               01580030
015900     05  FILLER              PIC X(01)   VALUE SPACES.            01590030
016000     05  DTL-PO-NBR          PIC ZZZZZZZZ9 VALUE ZEROS.           01600042
016100     05  FILLER              PIC X(05)   VALUE SPACES.            01610040
016200     05  DTL-STR-NBR         PIC 9(04)   VALUE ZEROS.             01620030
016300     05  FILLER              PIC X(04)   VALUE SPACES.            01630030
016400     05  DTL-INVOICE-ID      PIC X(22)   VALUE SPACES.            01640030
016500     05  FILLER              PIC X(02)   VALUE SPACES.            01650030
016600     05  DTL-GRO-COST-AMT    PIC $$$$,$$$,$$$.99-.                01660030
016700     05  FILLER              PIC X(05)   VALUE SPACES.            01670030
016800     05  DTL-STATUS-CDE      PIC X(02)   VALUE SPACES.            01680030
016900     05  FILLER              PIC X(05)   VALUE SPACES.            01690034
017000     05  DTL-DC-NBR          PIC 9(04)   VALUE ZEROS.             01700031
017100     05  FILLER              PIC X(08)   VALUE SPACES.            01710034
017200     05  DTL-MTCH-LVL-CDE    PIC X(01)   VALUE SPACES.            01720031
017300     05  FILLER              PIC X(08)   VALUE SPACES.            01730043
017310     05  DTL-COMMENT         PIC X(35)   VALUE SPACES.            01731043
017320     05  FILLER              PIC X(02)   VALUE SPACES.            01732043
017400                                                                  01740031
017500 01  DL-NO-DATA-LINE.                                             01750031
017600     05  FILLER                  PIC   X(30)   VALUE              01760031
017700         'THERE ARE NO EXCEPTIONS TODAY '.                        01770031
017800     05  FILLER                  PIC   X(102)  VALUE SPACES.      01780031
017900                                                                  01790031
018000 01  DL-END-RPT-LINE.                                             01800031
018100     05  FILLER                  PIC   X(30)   VALUE              01810031
018200         '*****  END OF REPORT *****    '.                        01820031
018300     05  FILLER                  PIC   X(102)  VALUE SPACES.      01830031
018400/                                                                 01840031
018500*                                                                 01850031
018600******************************************************************01860031
018700     COPY DPWS004.                                                01870031
018800******************************************************************01880031
018900*                                                                 01890031
019000******************************************************************01900031
019100*  COMMUNICATIONS AREA2 FOR DB2                                   01910031
019200******************************************************************01920031
019300     COPY SQLCA2.                                                 01930031
019400******************************************************************01940031
019500     EXEC SQL                                                     01950031
019600          INCLUDE SQLCA                                           01960031
019700     END-EXEC.                                                    01970031
019800 EJECT                                                            01980031
019900******************************************************************01990031
020000*  DCLGEN FOR TINVOIC                                             02000031
020100******************************************************************02010031
020200     EXEC SQL                                                     02020031
020300          INCLUDE TINVOIC                                         02030031
020400     END-EXEC.                                                    02040031
020500 EJECT                                                            02050031
020600******************************************************************02060031
020700*  CURSOR TO PULL BACK WRITE OFF INVOICES THAT WERE NOT PROCESSED 02070031
020800******************************************************************02080031
020900     EXEC SQL                                                     02090031
021000       DECLARE WRITEOFF_CSR CURSOR FOR                            02100031
021100         SELECT                                                   02110031
021200               PO_NBR                                             02120031
021300              ,INVC_ID                                            02130031
021400              ,GRO_COST_AMT                                       02140031
021500              ,STR_NBR                                            02150031
021600              ,STATUS_CDE                                         02160031
021700              ,DC_NBR                                             02170031
021800              ,MTCH_LVL_CDE                                       02180031
021900         FROM                                                     02190031
022000             TINVOIC                                              02200031
022100         WHERE                                                    02210031
022200               INVC_TYP_CDE          = 'WO'                       02220031
022300           AND STATUS_CDE IN ('EN','RC','OB','IB','RL')           02230031
022400        ORDER BY                                                  02240031
022500               PO_NBR                                             02250031
022600             , STR_NBR                                            02260031
022700             , INVC_ID                                            02270031
022800     END-EXEC.                                                    02280031
022900 EJECT                                                            02290031
023000******************************************************************02300031
023100*LINKAGE SECTION.                                                 02310031
023200******************************************************************02320031
023300*                                                                 02330031
023400 PROCEDURE DIVISION.                                              02340031
023500                                                                  02350031
023600 A100-MAINLINE.                                                   02360031
023700                                                                  02370031
023800     PERFORM B100-HOUSEKEEPING.                                   02380043
023900                                                                  02390031
024000     PERFORM B200-PROCESSING                                      02400043
024100         UNTIL NO-MORE-INVOIC-DATA.                               02410031
024200                                                                  02420031
024400     PERFORM B300-END-OF-JOB.                                     02440043
024500                                                                  02450031
024600     GOBACK.                                                      02460031
024700        EJECT                                                     02470031
024730***************************************************************** 02473043
024740*    GET DATE, TIME, OPEN FILES, SET UP CONTROLS, ETC             02474043
024750***************************************************************** 02475043
024751 B100-HOUSEKEEPING.                                               02475143
024752                                                                  02475243
024770     ACCEPT PV-JULIAN-DATE FROM DAY.                              02477043
024780                                                                  02478043
024790     ACCEPT DATE-IN  FROM DATE.                                   02479043
024791     MOVE DATE-IN-MM                  TO DP132O-RUN-MONTH.        02479143
024792     MOVE DATE-IN-DD                  TO DP132O-RUN-DAY.          02479243
024793     MOVE DATE-IN-YY                  TO DP132O-RUN-YEAR.         02479343
024794*                                                                 02479443
024795     ACCEPT RUN-TIME FROM TIME.                                   02479543
024796     MOVE R-HR                        TO DP132O-RUN-HOUR.         02479643
024797     MOVE R-MIN                       TO DP132O-RUN-MINUTE.       02479743
024798     MOVE PV-ABEND-PROGRAM            TO DP132O-PROGRAM-NAME.     02479843
024799     MOVE 1                           TO DP132O-REPORT-NUMBER.    02479943
024800                                                                  02480043
024801     OPEN  OUTPUT  WRITE-OFF-RPT-FILE.                            02480143
024802                                                                  02480243
024803     SET MORE-INVOIC-DATA TO TRUE.                                02480343
024804     PERFORM Y100-OPEN-INVOIC-CSR.                                02480443
024805                                                                  02480543
024806     PERFORM R100-FETCH-INVOIC.                                   02480643
024807     IF NO-MORE-INVOIC-DATA                                       02480743
024808        PERFORM  W175-WRITE-NO-DATA-LINE.                         02480843
024809                                                                  02480943
024810                                                                  02481031
025100***************************************************************** 02510031
025200*  FOR EACH ROW IN CURSOR, DETERMINE IF THE INVOICE SHOULD BE     02520043
025210*  WRITTEN TO THE REPORT, HAVE MATCH LEVEL UPDATED TO 'P', OR     02521043
025220*  BE LEFT AS IS (RL STATUS).                                     02522043
025300***************************************************************** 02530031
025400 B200-PROCESSING.                                                 02540043
025410                                                                  02541043
025420     IF INVOIC-STATUS-CDE = 'RL'                                  02542045
025430        MOVE PV-RL-STATUS TO DTL-COMMENT                          02543045
025440        PERFORM W100-WRITE-OUTFILE                                02544045
025450     ELSE                                                         02545045
025700        IF INVOIC-MTCH-LVL-CDE = 'P'                              02570045
025720           MOVE PV-DE-STATUS TO DTL-COMMENT                       02572043
025730           PERFORM W100-WRITE-OUTFILE                             02573043
025800           PERFORM C100-UPDATE-STATUS                             02580043
025810        ELSE                                                      02581043
025820           MOVE PV-MTCH-LEVEL TO DTL-COMMENT                      02582045
025821           PERFORM W100-WRITE-OUTFILE                             02582145
025822           PERFORM C200-UPDATE-MATCH-LEVEL                        02582245
025823        END-IF                                                    02582343
025900     END-IF.                                                      02590036
026000                                                                  02600031
026100     PERFORM R100-FETCH-INVOIC.                                   02610031
026200                                                                  02620031
026210***************************************************************** 02621043
026220*     FINISH THE ERROR PROCESS, REPORT ON NECESSARY TOTALS,       02622043
026230*     AND CLOSE ALL FILES                                         02623043
026240***************************************************************** 02624043
026250 B300-END-OF-JOB.                                                 02625043
026260*                                                                 02626043
026270     IF PV-LINE-COUNT > PV-MAX-LINES                              02627043
026280         PERFORM W200-PRINT-HEADERS                               02628043
026290     END-IF.                                                      02629043
026291                                                                  02629143
026292     WRITE REPORT-RECORD FROM DL-END-RPT-LINE AFTER 1.            02629243
026293                                                                  02629343
026294     CLOSE WRITE-OFF-RPT-FILE.                                    02629443
026295     PERFORM Y200-CLOSE-INVOIC-CSR.                               02629543
026296                                                                  02629643
026297     DISPLAY '************************************************'.  02629743
026298     DISPLAY 'TOTAL REPORT RECORDS WRITTEN   = '                  02629843
026299              PV-RECORDS-WRITTEN.                                 02629943
026300     DISPLAY '************************************************'.  02630043
026301                                                                  02630143
026302     DISPLAY ' PROGRAM APKUP033 ENDS NORMALLY '.                  02630243
026303                                                                  02630343
026304     ACCEPT RUN-TIME FROM TIME.                                   02630443
026305     ACCEPT DATE-IN  FROM DATE.                                   02630543
026306                                                                  02630643
026307     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    02630743
026308     DISPLAY '************************************************'.  02630843
026309 EJECT                                                            02630943
026310***************************************************************** 02631043
026311*  FOR INVOICES THAT ARE ALREADY AT MATCH LEVEL 'P' AND HAVE NOT  02631143
026312*  BEEN MATCHED AND SET TO RL STATUS, UPDATE THE STATUS TO 'DE'   02631243
026313*  TO PREVENT FURTHER PROCESSING.                                 02631343
026314***************************************************************** 02631443
026320 C100-UPDATE-STATUS.                                              02632043
026400                                                                  02640031
026500     MOVE 'DE' TO INVOIC-STATUS-CDE.                              02650031
026600                                                                  02660031
026700     EXEC SQL                                                     02670031
026800         UPDATE TINVOIC                                           02680031
026900         SET   STATUS_CDE       = :INVOIC-STATUS-CDE              02690031
027000         WHERE PO_NBR           = :INVOIC-PO-NBR                  02700031
027100           AND INVC_ID          = :INVOIC-INVC-ID                 02710031
027200     END-EXEC.                                                    02720031
027300                                                                  02730031
027400     EVALUATE TRUE                                                02740031
027500         WHEN SQLCODE = ZEROS                                     02750031
027600              CONTINUE                                            02760031
027700         WHEN OTHER                                               02770031
027800             MOVE 'C100-UPDATE-STATUS' TO PV-ABEND-PARAGRAPH      02780043
028000             MOVE 'UNSUCCESSFUL UPDATE' TO PV-ABEND-OPERATION     02800043
028200             MOVE 'TINVOIC'      TO PV-ABEND-STRUCTURE-1          02820031
028500             PERFORM Z999-SQL-ERROR                               02850031
028600     END-EVALUATE.                                                02860031
028700                                                                  02870031
028701 EJECT                                                            02870143
028702***************************************************************** 02870243
028703*  FOR INVOICES THAT HAVE MATCH LEVEL OTHER THAN 'P', UPDATE THE  02870343
028704*  MATCH LEVEL TO 'P' SO THEY WILL HAVE ANOTHER OPPORTUNITY TO BE 02870443
028705*  MATCHED AT TOTAL PO LEVEL.                                     02870543
028706***************************************************************** 02870643
028710 C200-UPDATE-MATCH-LEVEL.                                         02871043
028720                                                                  02872043
028730     MOVE 'P' TO INVOIC-MTCH-LVL-CDE.                             02873043
028740                                                                  02874043
028750     EXEC SQL                                                     02875043
028760         UPDATE TINVOIC                                           02876043
028770            SET MTCH_LVL_CDE     = :INVOIC-MTCH-LVL-CDE           02877044
028780          WHERE PO_NBR           = :INVOIC-PO-NBR                 02878043
028790            AND INVC_ID          = :INVOIC-INVC-ID                02879043
028791     END-EXEC.                                                    02879143
028792                                                                  02879243
028793     EVALUATE TRUE                                                02879343
028794         WHEN SQLCODE = ZEROS                                     02879443
028795              CONTINUE                                            02879543
028796         WHEN OTHER                                               02879643
028797             MOVE 'C200-UPDATE-MATCH-LEVEL' TO PV-ABEND-PARAGRAPH 02879743
028799             MOVE 'UNSUCCESSFUL UPDATE' TO PV-ABEND-OPERATION     02879943
028801             MOVE 'TINVOIC'      TO PV-ABEND-STRUCTURE-1          02880143
028804             PERFORM Z999-SQL-ERROR                               02880443
028805     END-EVALUATE.                                                02880543
028806                                                                  02880643
031700***************************************************************** 03170031
031800*     FETCH INVOICE DATA                                          03180031
031900***************************************************************** 03190031
032100 R100-FETCH-INVOIC.                                               03210031
032200                                                                  03220043
032300     EXEC SQL                                                     03230031
032400         FETCH WRITEOFF_CSR                                       03240031
032500         INTO                                                     03250031
032600              :INVOIC-PO-NBR                                      03260031
032700            , :INVOIC-INVC-ID                                     03270031
032800            , :INVOIC-GRO-COST-AMT                                03280031
032900            , :INVOIC-STR-NBR                                     03290031
033000            , :INVOIC-STATUS-CDE                                  03300031
033100            , :INVOIC-DC-NBR                                      03310031
033200            , :INVOIC-MTCH-LVL-CDE                                03320031
033300     END-EXEC.                                                    03330031
033400                                                                  03340031
033500     EVALUATE TRUE                                                03350031
033600         WHEN SQLCODE = ZERO                                      03360031
033700         WHEN SQLCODE = -904                                      03370031
033800         WHEN SQLCODE = -913                                      03380031
033900              CONTINUE                                            03390031
034000         WHEN SQLCODE = +100                                      03400031
034100              SET NO-MORE-INVOIC-DATA TO TRUE                     03410031
034200         WHEN SQLWARN0 NOT = SPACES                               03420031
034300         WHEN SQLCODE  NOT = ZERO                                 03430031
034400           MOVE 'R100-FETCH-INVOIC '                              03440031
034500                         TO PV-ABEND-PARAGRAPH                    03450031
034600           MOVE 'UNSUCCESSFUL FETCH  INVOIC'                      03460031
034700                         TO PV-ABEND-OPERATION                    03470031
034800           MOVE 'TINVOIC ' TO PV-ABEND-STRUCTURE-1                03480031
034900           MOVE SPACES     TO PV-ABEND-STRUCTURE-2                03490031
035000                              PV-ABEND-STRUCTURE-3                03500031
035100           PERFORM Z999-SQL-ERROR                                 03510031
035200     END-EVALUATE.                                                03520031
035300                                                                  03530031
035400 EJECT                                                            03540031
035500*                                                                 03550031
035600 W100-WRITE-OUTFILE.                                              03560031
035700                                                                  03570031
035800     IF PV-LINE-COUNT > PV-MAX-LINES                              03580031
035900         PERFORM W200-PRINT-HEADERS                               03590031
036000     END-IF.                                                      03600031
036100                                                                  03610031
036200     MOVE  INVOIC-PO-NBR           TO DTL-PO-NBR.                 03620031
036300     MOVE  INVOIC-STR-NBR          TO PV-STR-NBR.                 03630031
036400     MOVE  PV-STR-NBR              TO DTL-STR-NBR.                03640031
036500     MOVE  INVOIC-INVC-ID          TO DTL-INVOICE-ID.             03650031
036600     MOVE  INVOIC-GRO-COST-AMT     TO DTL-GRO-COST-AMT.           03660031
036700     MOVE  INVOIC-STATUS-CDE       TO DTL-STATUS-CDE.             03670031
036800     MOVE  INVOIC-DC-NBR           TO PV-DC-NBR.                  03680031
036900     MOVE  PV-DC-NBR               TO DTL-DC-NBR.                 03690031
037000     MOVE  INVOIC-MTCH-LVL-CDE     TO DTL-MTCH-LVL-CDE.           03700031
037100                                                                  03710031
037200     WRITE REPORT-RECORD FROM DL-DETAIL-LINE.                     03720031
037300                                                                  03730031
037400     ADD 1 TO PV-RECORDS-WRITTEN                                  03740031
037500              PV-LINE-COUNT.                                      03750031
037600                                                                  03760031
037700 W175-WRITE-NO-DATA-LINE.                                         03770031
037800                                                                  03780031
037900     PERFORM W200-PRINT-HEADERS.                                  03790031
038000                                                                  03800031
038100     WRITE REPORT-RECORD FROM DL-NO-DATA-LINE AFTER 1.            03810031
038200                                                                  03820031
038300 W200-PRINT-HEADERS.                                              03830031
038400                                                                  03840031
038500     ADD 1                            TO PV-PAGE-COUNT.           03850031
038600     MOVE PV-PAGE-COUNT               TO DP132O-PAGE-NUMBER.      03860031
038700                                                                  03870031
038800     WRITE REPORT-RECORD FROM                                     03880031
038900                   DP132O-STANDRD-HEADER-132-COLS AFTER PAGE.     03890031
039000     WRITE REPORT-RECORD FROM H2-HEADER2 AFTER 1.                 03900031
039100                                                                  03910031
039200     WRITE REPORT-RECORD FROM DH-DETAIL-HEAD1 AFTER 2.            03920031
039300                                                                  03930031
039400     MOVE SPACES TO REPORT-RECORD.                                03940031
039500     WRITE REPORT-RECORD AFTER 1.                                 03950031
039600     MOVE 5  TO PV-LINE-COUNT.                                    03960031
039700                                                                  03970031
039800 EJECT                                                            03980031
039900***************************************************************** 03990031
040000*     OPEN WRITE-OFF INVOICE CURSOR                               04000043
040100***************************************************************** 04010031
040300 Y100-OPEN-INVOIC-CSR.                                            04030031
040310                                                                  04031043
040400     PERFORM WITH TEST AFTER                                      04040031
040500       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       04050043
040600       UNTIL   PV-RETRY-COUNTER > 3  OR                           04060043
040700               SQLCODE = ZERO                                     04070043
040800                                                                  04080043
040900       EXEC SQL                                                   04090043
041000          OPEN WRITEOFF_CSR                                       04100043
041100       END-EXEC                                                   04110043
041200                                                                  04120043
041300       EVALUATE TRUE                                              04130043
041400           WHEN SQLCODE = ZERO                                    04140043
041500           WHEN SQLCODE = -904                                    04150043
041600           WHEN SQLCODE = -913                                    04160043
041700                CONTINUE                                          04170043
041800                                                                  04180043
041900           WHEN SQLWARN0 NOT = SPACES                             04190043
042000           WHEN SQLCODE  NOT = ZERO                               04200043
042100                MOVE 'Y100-OPEN-INVOIC-CSR' TO PV-ABEND-PARAGRAPH 04210043
042300                MOVE 'UNSUCCESSFUL OPEN' TO PV-ABEND-OPERATION    04230043
042500                MOVE 'TINVOIC ' TO PV-ABEND-STRUCTURE-1           04250043
042800                PERFORM Z999-SQL-ERROR                            04280043
042900       END-EVALUATE                                               04290043
043000     END-PERFORM.                                                 04300031
043100                                                                  04310031
043200     IF PV-RETRY-COUNTER > 3                                      04320031
043300         MOVE 'Y100-OPEN-INVOIC-CSR' TO PV-ABEND-PARAGRAPH        04330043
043500         MOVE 'MAX RETRIES EXCEEDED ON OPEN' TO PV-ABEND-OPERATION04350043
043700         PERFORM Z999-SQL-ERROR.                                  04370031
043800                                                                  04380031
043900*                                                                 04390031
044000***************************************************************** 04400031
044100*     CLOSE PURCHASE ITEM CURSOR                                  04410031
044200***************************************************************** 04420031
044400 Y200-CLOSE-INVOIC-CSR.                                           04440031
044410                                                                  04441043
044500     PERFORM WITH TEST AFTER                                      04450031
044600       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       04460043
044700       UNTIL   PV-RETRY-COUNTER > 3  OR                           04470043
044800               SQLCODE = ZERO                                     04480043
044900                                                                  04490043
045000       EXEC SQL                                                   04500043
045100          CLOSE WRITEOFF_CSR                                      04510043
045200       END-EXEC                                                   04520043
045300                                                                  04530043
045400       EVALUATE TRUE                                              04540043
045500           WHEN SQLCODE = ZERO                                    04550043
045600           WHEN SQLCODE = +100                                    04560043
045700           WHEN SQLCODE = -904                                    04570043
045800           WHEN SQLCODE = -913                                    04580043
045900                CONTINUE                                          04590043
046000                                                                  04600043
046100           WHEN SQLWARN0 NOT = SPACES                             04610043
046200           WHEN SQLCODE  NOT = ZERO                               04620043
046300                MOVE 'Y200-CLOSE-INVOIC-CSR' TO PV-ABEND-PARAGRAPH04630043
046500                MOVE 'UNSUCCESSFUL CLOSE' TO PV-ABEND-OPERATION   04650043
046700                MOVE 'TINVOIC ' TO PV-ABEND-STRUCTURE-1           04670043
047000                PERFORM Z999-SQL-ERROR                            04700043
047100       END-EVALUATE                                               04710043
047200     END-PERFORM.                                                 04720031
047300                                                                  04730031
047400     IF PV-RETRY-COUNTER > 3                                      04740031
047500         MOVE 'Y200-CLOSE-INVOIC-CSR' TO PV-ABEND-PARAGRAPH       04750043
047700         MOVE 'MAX RETRIES EXCEEDED' TO PV-ABEND-OPERATION        04770043
047900         PERFORM Z999-SQL-ERROR.                                  04790031
048000                                                                  04800031
048100 EJECT                                                            04810031
051100***************************************************************** 05110031
051200*     PROCESS DB2 ABENDS                                          05120031
051300***************************************************************** 05130031
051310 Z999-SQL-ERROR.                                                  05131043
051400                                                                  05140043
051500     DISPLAY '*** DB2 ERROR '.                                    05150031
051600     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 05160031
051700     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               05170031
051800     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               05180031
051900     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             05190031
052000     IF PV-ABEND-STRUCTURE-2 > SPACES                             05200031
052100         DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2.         05210031
052200     IF PV-ABEND-STRUCTURE-3 > SPACES                             05220031
052300         DISPLAY '*** TABLE 3   = ' PV-ABEND-STRUCTURE-3.         05230031
052400                                                                  05240031
052500     MOVE +4013                    TO ABEND-CODE.                 05250031
052600                                                                  05260031
052700     COPY DPPD004.                                                05270031
052800     CALL 'ILBOABN0' USING ABEND-CODE.                            05280031
052900                                                                  05290031
