000100 IDENTIFICATION DIVISION.                                         00010003
000200 PROGRAM-ID.    AHKUT603.                                         00020003
000300 AUTHOR.        MIKE FRIESS.                                      00030003
000400 INSTALLATION.  KOHLS.                                            00040003
000500 DATE-WRITTEN   AUG, 2003.                                        00050003
000600 DATE-COMPILED.                                                   00060003
000700                                                                  00070003
000800* ************************************************************** *00080003
000900* * AHKUT603.  "ARCHIVE HISTORY" PROJECT.  EXTRACT PROGRAM.    * *00090003
001000* *                                                            * *00100003
001100* * PURPOSE:                                                   * *00110003
001200* * THIS PROGRAM CREATES AN EXTRACT FILE FROM: TSHIPMT.        * *00120003
001300* * THIS EXTRACT FILE CONSISTS OF ROWS ELIGIBLE TO BE:         * *00130003
001400* * 1) LOADED TO THE "ARCHIVE/HISTORY" VERSIONS OF THE TABLES. * *00140003
001500* * 2) DELETED FROM THE OPERATIONAL VERSIONS OF THE TABLES.    * *00150003
001600* *                                                            * *00160003
001700* * PROCESSING OVERVIEW:                                       * *00170003
001800* * THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,  * *00180003
001900* * 1) INCREMENT COUNT OF RECORDS READ.                        * *00190003
002000* * 2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE.            * *00200003
002100* *    2.A) IF NO MATCH(ES):                                   * *00210003
002200* *         2.A.1) PROCESSING CONTINUES                        * *00220003
002300* *         2.A.2) DO NOT PERFORM ERROR/REPORTING ROUTINES;    * *00230003
002400* *                THIS SYSTEM DOES NOT CLEANSE DATA NOR REPORT* *00240003
002500* *                ON UNCLEAN DATA.  IT SIMPLY MIGRATES        * *00250003
002600* *                CONDITIONS OCCURRING IN OPERATIONAL         * *00260003
002700* *                TABLES OVER TO THE ARCHIVE/HISTORY TABLES.  * *00270003
002800* *    2.B) IF MATCH(ES):                                      * *00280003
002900* *         2.B.1) INCREMENT COUNT OF ROW(S) FOUND.            * *00290003
003000* *         2.B.2) WRITE THESE ROW(S) TO THE EXTRACT FILE.     * *00300003
003100* *         2.B.3) INCREMENT COUNT OF RECORDS WRITTEN.         * *00310003
003200* *         2.B.4) DO NOT REMOVE THE ROW(S) FROM THE TABLE     * *00320003
003300* *                AT THIS TIME.  THEY WILL BE REMOVED IN OTHER* *00330003
003400* *                PROCESSING, AFTER HAVING BEEN LOADED TO THE * *00340003
003500* *                ARCHIVE/HISTORY TABLE.                      * *00350003
003600* * 3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *00360003
003700* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *00370003
003800* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *00380003
003900******************************************************************00390003
004000*                  C H A N G E    L O G                          *00400003
004100* 2012-02-17 CHRISTINE TWIEHAUS    WR40574                       *00410003
004200*            ADDED CARR_AUTH_ID                                  *00420003
004300******************************************************************00430003
004400 ENVIRONMENT DIVISION.                                            00440003
004500 CONFIGURATION SECTION.                                           00450003
004600 SOURCE-COMPUTER.        IBM-3090.                                00460003
004700 OBJECT-COMPUTER.        IBM-3090.                                00470003
004800                                                                  00480003
004900 INPUT-OUTPUT SECTION.                                            00490003
005000 FILE-CONTROL.                                                    00500003
005100                                                                  00510003
005200     SELECT IN-DRIVER-FILE                ASSIGN TO INP01.        00520003
005300     SELECT OUT-EXTRACT-FILE              ASSIGN TO OUT01.        00530003
005400                                                                  00540003
005500******************************************************************00550003
005600 DATA DIVISION.                                                   00560003
005700 FILE SECTION.                                                    00570003
005800                                                                  00580003
005900**** TSHPTPO:                                                     00590003
006000 FD  IN-DRIVER-FILE                                               00600003
006100     RECORDING MODE IS F                                          00610003
006200     LABEL RECORDS ARE STANDARD                                   00620003
006300     BLOCK CONTAINS 0 RECORDS.                                    00630003
006400 01  TSHPTPO-EXTRACT-DATA            PIC  X(300).                 00640003
006500                                                                  00650003
006600**** TSHIPMT:                                                     00660003
006700 FD  OUT-EXTRACT-FILE                                             00670003
006800     RECORDING MODE IS F                                          00680003
006900     LABEL RECORDS ARE STANDARD                                   00690003
007000     BLOCK CONTAINS 0 RECORDS.                                    00700003
007100 01  OUT-EXTRACT-RECORD              PIC  X(500).                 00710003
007200                                                                  00720003
007300                                                                  00730003
007400                                                                  00740003
007500 WORKING-STORAGE SECTION.                                         00750003
007600                                                                  00760003
007700 01  PC-PROGRAM-CONSTANTS.                                        00770003
007800     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT603'.  00780003
007900     05  PC-PGM-PROGRESS-DESC.                                    00790003
008000         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00800003
008100         10  PC-CONTINUING           PIC X(10) VALUE              00810003
008200                                               'CONTINUING'.      00820003
008300         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00830003
008400         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00840003
008500     05  PC-ABEND-INFO.                                           00850003
008600         10  PC-ABEND                PIC X(11) VALUE              00860003
008700                                               '** ABEND **'.     00870003
008800         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00880003
008900                                               '- PARA       : '. 00890003
009000         10  PC-ABEND-MSG-DISPLAY-PARA                            00900003
009100                                     PIC X(15) VALUE              00910003
009200                                               '  CALLED PARA: '. 00920003
009300         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00930003
009400                                               '  FOR ABEND# : '. 00940003
009500         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00950003
009600                                               '- ERROR IS   : '. 00960003
009700         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00970003
009800         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00980003
009900                                               '- ACTION     : '. 00990003
010000     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 5000.        01000003
010100     05  PV-NULL                     PIC S9(04) VALUE +0          01010003
010200                                                   COMP.          01020003
010300                                                                  01030003
010400 01  PS-PROGRAM-SWITCHES.                                         01040003
010500     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         01050003
010600         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         01060003
010700         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01070003
010800     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01080003
010900         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01090003
011000         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01100003
011100     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         01110003
011200         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         01120003
011300         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         01130003
011400                                                                  01140003
011500 01  PV-PROGRAM-VARIABLES.                                        01150003
011600     05  PV-LENGTH-TSHPTPO           PIC 9(09) VALUE ZERO.        01160003
011700     05  PV-IN-DRIVER-RECS-READ-CNT  PIC  9(9) VALUE 0.           01170003
011800     05  PV-RECS-WITH-MATCHES-CNT    PIC  9(9) VALUE 0.           01180003
011900     05  PV-TABLE-ROW-SELECT-CNT     PIC  9(9) VALUE 0.           01190003
012000     05  PV-EXTRACT-WRITTEN-CNT      PIC  9(9) VALUE 0.           01200003
012100                                                                  01210003
012200     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01220003
012300     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01230003
012400     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      01240003
012500     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01250003
012600     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01260003
012700     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01270003
012800                                                                  01280003
012900     05  PV-TMST                     PIC X(26) VALUE SPACES.      01290003
013000     05  PV-TIMESTAMP-DETAIL                                      01300003
013100         REDEFINES                                                01310003
013200         PV-TMST.                                                 01320003
013300         10  PV-TIMESTAMP-19.                                     01330003
013400             15  PV-TMS-DATE.                                     01340003
013500                 20  PV-TMS-YEAR.                                 01350003
013600                     25  PV-TMS-CC   PIC X(02).                   01360003
013700                     25  PV-TMS-YY   PIC X(02).                   01370003
013800                 20  FILLER          PIC X(01).                   01380003
013900                 20  PV-TMS-MONTH    PIC X(02).                   01390003
014000                 20  FILLER          PIC X(01).                   01400003
014100                 20  PV-TMS-DAY      PIC X(02).                   01410003
014200             15  FILLER              PIC X(01).                   01420003
014300             15  PV-TMS-HOUR         PIC X(02).                   01430003
014400             15  FILLER              PIC X(01).                   01440003
014500             15  PV-TMS-MINUTE       PIC X(02).                   01450003
014600             15  FILLER              PIC X(01).                   01460003
014700             15  PV-TMS-SECOND       PIC X(02).                   01470003
014800         10  FILLER                  PIC X(01).                   01480003
014900         10  PV-TMS-MSECOND          PIC X(06).                   01490003
015000                                                                  01500003
015100 01  DM-DISPLAY-MESSAGE.                                          01510003
015200     05  DM-01-10.                                                01520003
015300         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01530003
015400         10  FILLER                  PIC X(02) VALUE ': '.        01540003
015500     05  DM-11-80.                                                01550003
015600         10  FILLER                  PIC X(37) VALUE              01560003
015700                        'SELECT ROWS MATCH SHPTPO DRIVER FILE '.  01570003
015800         10  FILLER                  PIC X(30) VALUE              01580003
015900                        'CREATING TSHIPMT EXTRACT FILE.'.         01590003
016000         10  FILLER                  PIC X(01) VALUE SPACE.       01600003
016100         10  FILLER                  PIC X(01) VALUE ALL '*'.     01610003
016200     05  DM-81-120.                                               01620003
016300         10  FILLER                  PIC X(40) VALUE ALL '*'.     01630003
016400                                                                  01640003
016500 01  DP-DISPLAY-PROGRESS-MSG.                                     01650003
016600     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01660003
016700     05  FILLER                      PIC X(02) VALUE SPACE.       01670003
016800     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01680003
016900     05  FILLER                      PIC X(04) VALUE ' AT '.      01690003
017000     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01700003
017100     05  FILLER                      PIC X(02) VALUE '. '.        01710003
017200     05  FILLER                      PIC X(03) VALUE              01720003
017300                                         'IN:'.                   01730003
017400     05  DP-IN-CNT                   PIC Z,ZZZ,ZZ9                01740003
017500                                               VALUE ZERO.        01750003
017600     05  FILLER                      PIC X(02) VALUE ', '.        01760003
017700     05  FILLER                      PIC X(14) VALUE              01770003
017800                                         'ROWS SELECTED:'.        01780003
017900     05  DP-ROWS-SELECTED-CNT        PIC Z,ZZZ,ZZ9                01790003
018000                                               VALUE ZERO.        01800003
018100     05  FILLER                      PIC X(02) VALUE ', '.        01810003
018200     05  FILLER                      PIC X(04) VALUE              01820003
018300                                         'OUT:'.                  01830003
018400     05  DP-OUT-CNT                  PIC Z,ZZZ,ZZ9                01840003
018500                                               VALUE ZERO.        01850003
018600     05  FILLER                      PIC X(02) VALUE ', '.        01860003
018700     05  FILLER                      PIC X(08)                    01870003
018800                                     VALUE 'SHIP ID:'.            01880003
018900     05  DP-SHIPT-ID                 PIC 9(09) VALUE ZERO.        01890003
019000     05  FILLER                      PIC X(01) VALUE '.'.         01900003
019100                                                                  01910003
019200 01  ABEND-CODE                      PIC S9(04)                   01920003
019300                                               VALUE ZEROES       01930003
019400                                               COMP SYNC.         01940003
019500                                                                  01950003
019600*---------------------------------------------------------------* 01960003
019700*  DB2 FORMATTED MESSAGE AREA                                     01970003
019800*---------------------------------------------------------------* 01980003
019900     COPY DPWS004.                                                01990003
020000                                                                  02000003
020100*---------------------------------------------------------------* 02010003
020200*    DB2 AREA FOR TSHPTPO - USE COBOL VARIABLES FOR RECORD      * 02020003
020300*                           LAYOUT DRIVER FILE, INPUT.          * 02030003
020400*---------------------------------------------------------------* 02040003
020500     EXEC SQL                                                     02050003
020600          INCLUDE TSHPTPO                                         02060003
020700     END-EXEC.                                                    02070003
020800                                                                  02080003
020900*---------------------------------------------------------------* 02090003
021000*    DB2 AREA FOR TSHIPMT                                       * 02100003
021100*---------------------------------------------------------------* 02110003
021200     EXEC SQL                                                     02120003
021300          INCLUDE TSHIPMT                                         02130003
021400     END-EXEC.                                                    02140003
021500                                                                  02150003
021600*---------------------------------------------------------------* 02160003
021700*    DB2 AREA FOR COMMUNICATIONS                                * 02170003
021800*---------------------------------------------------------------* 02180003
021900     EXEC SQL                                                     02190003
022000          INCLUDE SQLCA                                           02200003
022100     END-EXEC.                                                    02210003
022200                                                                  02220003
022300*---------------------------------------------------------------* 02230003
022400*    DEFINE CURSOR FOR TSHIPMT :                                * 02240003
022500*    PULL ALL AVAILABLE COLUMNS, SO EXTRACT FILE WILL CONTAIN   * 02250003
022600*    ALL DATA TO POPULATE "ARCHIVE HISTORY" COPY OF THIS TABLE. * 02260003
022700*---------------------------------------------------------------* 02270003
022800     EXEC SQL                                                     02280003
022900          DECLARE TABLE-CURSOR CURSOR FOR                         02290003
023000           SELECT *                                               02300003
023100           FROM   TSHIPMT                                         02310003
023200          WHERE  SHIPT_ID = :SHPTPO-SHIPT-ID                      02320003
023300            AND  NOT EXISTS (SELECT SHIPT_ID                      02330003
023400                               FROM TSHPTPO                       02340003
023500                              WHERE SHIPT_ID = :SHPTPO-SHIPT-ID)  02350003
023600            FOR  FETCH ONLY                                       02360003
023700           WITH  UR                                               02370003
023800     END-EXEC.                                                    02380003
023900                                                                  02390003
024000                                                                  02400003
024100 PROCEDURE DIVISION.                                              02410003
024200********************                                              02420003
024300                                                                  02430003
024400 0000-PROGRAM-MAINLINE.                                           02440003
024500                                                                  02450003
024600     PERFORM 1000-INITIALIZE.                                     02460003
024700                                                                  02470003
024800     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02480003
024900     PERFORM 2000-PROCESS-DRIVER-FILE                             02490003
025000         UNTIL PS-IN-DRIVER-EOF.                                  02500003
025100                                                                  02510003
025200     PERFORM 6000-EOJ-ROUTINE.                                    02520003
025300     STOP RUN.                                                    02530003
025400                                                                  02540003
025500                                                                  02550003
025600* ************************************************************** *02560003
025700* * INITIALIZATIONS                                            * *02570003
025800* ************************************************************** *02580003
025900 1000-INITIALIZE.                                                 02590003
026000                                                                  02600003
026100     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02610003
026200     DISPLAY DM-DISPLAY-MESSAGE.                                  02620003
026300                                                                  02630003
026400     MOVE PC-BEGINNING              TO DP-STATUS-DESCRIPTION.     02640003
026500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02650003
026600                                                                  02660003
026700     COMPUTE PV-LENGTH-TSHPTPO = LENGTH OF DCLTSHPTPO.            02670003
026800                                                                  02680003
026900     PERFORM 9000-OPEN-IN-DRIVER-FILE.                            02690003
027000     PERFORM 9700-OPEN-OUT-EXTRACT-FILE.                          02700003
027100                                                                  02710003
027200                                                                  02720003
027300* ************************************************************** *02730003
027400* * 1) GET NEXT RECORD FROM DRIVER FILE, AND                   * *02740003
027500* *    1A- POPULATE KEY (WHERE CLAUSE) FOR TABLE CURSOR        * *02750003
027600* *    1B- OPEN TABLE CURSOR                                   * *02760003
027700* *    1C- LOOP THRU TABLE CURSOR TO EXTRACT ALL               * *02770003
027800* *        ROWS FOR THIS INPUT DRIVER RECORD                   * *02780003
027900* *    2) FOR EACH ROW,                                        * *02790003
028000* *       2A- INCREMENT COUNTS                                 * *02800003
028100* *       2B- WRITE EXTRACT RECORD                             * *02810003
028200* *    1D- CLOSE TABLE CURSOR                                  * *02820003
028300* ************************************************************** *02830003
028400 2000-PROCESS-DRIVER-FILE.                                        02840003
028500                                                                  02850003
028600     PERFORM 9050-READ-IN-DRIVER-FILE.                            02860003
028700     IF PS-IN-DRIVER-EOF                                          02870003
028800         CONTINUE                                                 02880003
028900     ELSE                                                         02890003
029000         PERFORM 2100-CHECK-PGM-PROGRESS                          02900003
029100         SET PS-TABLE-LOOP-NOT-DONE   TO TRUE                     02910003
029200         SET PS-CURSOR-HAS-NO-DATA    TO TRUE                     02920003
029300         PERFORM 9100-OPEN-TABLE-CURSOR                           02930003
029400         PERFORM 3000-EXTRACT-ROWS-FROM-TABLE                     02940003
029500             UNTIL PS-TABLE-LOOP-DONE                             02950003
029600         PERFORM 9190-CLOSE-TABLE-CURSOR                          02960003
029700     END-IF.                                                      02970003
029800                                                                  02980003
029900                                                                  02990003
030000* ************************************************************** *03000003
030100* *    EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *03010003
030200* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *03020003
030300* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *03030003
030400* ************************************************************** *03040003
030500 2100-CHECK-PGM-PROGRESS.                                         03050003
030600     DIVIDE    PV-IN-DRIVER-RECS-READ-CNT                         03060003
030700         BY        PC-HOW-OFTEN-TO-DISPLAY                        03070003
030800         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03080003
030900         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03090003
031000                                                                  03100003
031100     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03110003
031200         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03120003
031300         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03130003
031400     END-IF.                                                      03140003
031500                                                                  03150003
031600                                                                  03160003
031700* ************************************************************** *03170003
031800* * EXTRACT ROWS FROM TABLE, FOR THE CURRENT DRIVER RECORD     * *03180003
031900* ************************************************************** *03190003
032000 3000-EXTRACT-ROWS-FROM-TABLE.                                    03200003
032100                                                                  03210003
032200     INITIALIZE DCLTSHIPMT.                                       03220003
032300     PERFORM 9150-FETCH-TABLE-CURSOR.                             03230003
032400     IF PS-TABLE-LOOP-DONE                                        03240003
032500         CONTINUE                                                 03250003
032600     ELSE                                                         03260003
032700         PERFORM 9750-WRITE-EXTRACT-RECORD                        03270003
032800     END-IF.                                                      03280003
032900                                                                  03290003
033000                                                                  03300003
033100* ************************************************************** *03310003
033200* * DISPLAY END OF RUN MESSAGE, CLOSE THE OUTPUT FILES         * *03320003
033300* ************************************************************** *03330003
033400 6000-EOJ-ROUTINE.                                                03340003
033500                                                                  03350003
033600     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           03360003
033700     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         03370003
033800                                                                  03380003
033900     MOVE PC-ENDING                 TO DP-STATUS-DESCRIPTION.     03390003
034000     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03400003
034100                                                                  03410003
034200                                                                  03420003
034300* ************************************************************** *03430003
034400* * DISPLAY PROGRAM PROGRESS.                                  * *03440003
034500* ************************************************************** *03450003
034600 6200-DISPLAY-PGM-PROGRESS.                                       03460003
034700                                                                  03470003
034800     EXEC SQL                                                     03480003
034900          SET :PV-TMST = CURRENT TIMESTAMP                        03490003
035000     END-EXEC.                                                    03500003
035100                                                                  03510003
035200     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03520003
035300     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03530003
035400     MOVE PV-IN-DRIVER-RECS-READ-CNT                              03540003
035500                                    TO DP-IN-CNT.                 03550003
035600     MOVE PV-TABLE-ROW-SELECT-CNT   TO DP-ROWS-SELECTED-CNT.      03560003
035700     MOVE PV-EXTRACT-WRITTEN-CNT    TO DP-OUT-CNT.                03570003
035800     MOVE SHPTPO-SHIPT-ID           TO DP-SHIPT-ID.               03580003
035900                                                                  03590003
036000     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03600003
036100                                                                  03610003
036200                                                                  03620003
036300* ************************************************************** *03630003
036400* * FILE AND DB2 TABLE ACCESS PARAGRAPHS.                      * *03640003
036500* * 90XX- INPUT:  DRIVER FILE                                  * *03650003
036600* * 91XX- INPUT:  TABLE CURSOR                                 * *03660003
036700* * 97XX- OUTPUT: TABLE EXTRACT                                * *03670003
036800* ************************************************************** *03680003
036900                                                                  03690003
037000* ************************************************************** *03700003
037100* * OPEN  INPUT DRIVER FILE                                    * *03710003
037200* ************************************************************** *03720003
037300 9000-OPEN-IN-DRIVER-FILE.                                        03730003
037400     OPEN  INPUT  IN-DRIVER-FILE.                                 03740003
037500                                                                  03750003
037600                                                                  03760003
037700* ************************************************************** *03770003
037800* * READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT        * *03780003
037900* ************************************************************** *03790003
038000 9050-READ-IN-DRIVER-FILE.                                        03800003
038100     READ IN-DRIVER-FILE                                          03810003
038200          AT END                                                  03820003
038300              SET PS-IN-DRIVER-EOF TO TRUE.                       03830003
038400                                                                  03840003
038500     IF PS-IN-DRIVER-EOF                                          03850003
038600         CONTINUE                                                 03860003
038700     ELSE                                                         03870003
038800         ADD +1 TO PV-IN-DRIVER-RECS-READ-CNT                     03880003
038900         MOVE TSHPTPO-EXTRACT-DATA (1:PV-LENGTH-TSHPTPO)          03890003
039000                             TO DCLTSHPTPO                        03900003
039100     END-IF.                                                      03910003
039200                                                                  03920003
039300                                                                  03930003
039400* ************************************************************** *03940003
039500* * CLOSE INPUT DRIVER FILE                                    * *03950003
039600* ************************************************************** *03960003
039700 9090-CLOSE-IN-DRIVER-FILE.                                       03970003
039800     CLOSE IN-DRIVER-FILE.                                        03980003
039900                                                                  03990003
040000                                                                  04000003
040100* ************************************************************** *04010003
040200* * OPEN  TABLE CURSOR                                         * *04020003
040300* ************************************************************** *04030003
040400 9100-OPEN-TABLE-CURSOR.                                          04040003
040500     EXEC SQL                                                     04050003
040600          OPEN TABLE-CURSOR                                       04060003
040700     END-EXEC.                                                    04070003
040800                                                                  04080003
040900     EVALUATE TRUE                                                04090003
041000         WHEN SQLCODE = ZERO                                      04100003
041100              ADD +1 TO PV-RECS-WITH-MATCHES-CNT                  04110003
041200              SET PS-CURSOR-HAS-DATA TO TRUE                      04120003
041300         WHEN SQLCODE = +100                                      04130003
041400              SET PS-TABLE-LOOP-DONE TO TRUE                      04140003
041500         WHEN SQLWARN0 NOT EQUAL SPACE                            04150003
041600         WHEN SQLCODE  NOT EQUAL ZERO                             04160003
041700              MOVE '9100-OPEN-TABLE-CURSOR'                       04170003
041800                                 TO PV-PARAGRAPH-NAME             04180003
041900              MOVE 'OPEN TABLE CURSOR'                            04190003
042000                                 TO PV-DB2-OPERATION-MSG-1        04200003
042100              MOVE 'TSHIPMT'     TO PV-DB2-TABLE-NAME             04210003
042200              PERFORM 9999-DB2-ABEND                              04220003
042300     END-EVALUATE.                                                04230003
042400                                                                  04240003
042500                                                                  04250003
042600* ************************************************************** *04260003
042700* * FETCH TABLE CURSOR                                         * *04270003
042800* ************************************************************** *04280003
042810* 2012-02-17 WR40574 ADDED CARR-AUTH-ID BELOW                    *04281003
042900 9150-FETCH-TABLE-CURSOR.                                         04290003
043000     EXEC SQL                                                     04300003
043100         FETCH TABLE-CURSOR                                       04310003
043200          INTO                                                    04320003
043300             :SHIPMT-TRIP-ID:PV-NULL                              04330003
043400            ,:SHIPMT-SHIPT-ID:PV-NULL                             04340003
043500            ,:SHIPMT-CRT-SRC-CDE:PV-NULL                          04350003
043600            ,:SHIPMT-LAST-UPD-DTE:PV-NULL                         04360003
043700            ,:SHIPMT-LAST-UPD-TME:PV-NULL                         04370003
043800            ,:SHIPMT-LAST-UPD-UID:PV-NULL                         04380003
043900            ,:SHIPMT-PRO-SCAC-ID:PV-NULL                          04390003
044000            ,:SHIPMT-PRO-NBR:PV-NULL                              04400003
044100            ,:SHIPMT-BOL-NBR:PV-NULL                              04410003
044200            ,:SHIPMT-SHIPPER-NME:PV-NULL                          04420003
044300            ,:SHIPMT-SHIPT-TYP-CDE:PV-NULL                        04430003
044400            ,:SHIPMT-EXPTED-GRO-WGHT:PV-NULL                      04440003
044500            ,:SHIPMT-PKG-TYP-CDE:PV-NULL                          04450003
044600            ,:SHIPMT-EXPTED-PKG-QTY:PV-NULL                       04460003
044700            ,:SHIPMT-FRGT-CHG-AMT:PV-NULL                         04470003
044800            ,:SHIPMT-FRGT-TERMS-CDE:PV-NULL                       04480003
044900            ,:SHIPMT-EXPTED-PLT-QTY:PV-NULL                       04490003
045000            ,:SHIPMT-VEND-SHIP-DTE:PV-NULL                        04500003
045100            ,:SHIPMT-EST-AR-TMST:PV-NULL                          04510003
045200            ,:SHIPMT-ORIG-SCAC-ID:PV-NULL                         04520003
045300            ,:SHIPMT-LAST-UPD-PGM-ID:PV-NULL                      04530003
045400            ,:SHIPMT-CRE-USER-ID:PV-NULL                          04540003
045500            ,:SHIPMT-CARR-CART-CT:PV-NULL                         04550003
045600            ,:SHIPMT-CARR-LAST-UPD-DTE:PV-NULL                    04560003
045700            ,:SHIPMT-CARR-LAST-UPD-TIME:PV-NULL                   04570003
045800            ,:SHIPMT-VEND-CART-CT:PV-NULL                         04580003
045900            ,:SHIPMT-VEND-LAST-UPD-DTE:PV-NULL                    04590003
046000            ,:SHIPMT-VEND-LAST-UPD-TIME:PV-NULL                   04600003
046100            ,:SHIPMT-VEH-NBR:PV-NULL                              04610003
046200            ,:SHIPMT-AUTH-NBR:PV-NULL                             04620003
046300            ,:SHIPMT-AUTH-DTE:PV-NULL                             04630003
046400            ,:SHIPMT-CONFIRM-DTE:PV-NULL                          04640003
046500            ,:SHIPMT-CONFIRM-TIME:PV-NULL                         04650003
046600            ,:SHIPMT-COMPLETE-PRO-NBR:PV-NULL                     04660003
046700            ,:SHIPMT-COMPLETE-BOL-NBR:PV-NULL                     04670003
046800            ,:SHIPMT-PROCESSED-DTE:PV-NULL                        04680003
046900            ,:SHIPMT-INVC-NBR:PV-NULL                             04690003
046910            ,:SHIPMT-CARR-AUTH-ID                                 04691003
047000     END-EXEC.                                                    04700003
047100                                                                  04710003
047200     EVALUATE TRUE                                                04720003
047300         WHEN SQLCODE = ZERO                                      04730003
047400              ADD +1                 TO PV-TABLE-ROW-SELECT-CNT   04740003
047500              SET PS-CURSOR-HAS-DATA TO TRUE                      04750003
047600         WHEN SQLCODE = +100                                      04760003
047700              SET PS-TABLE-LOOP-DONE TO TRUE                      04770003
047800         WHEN SQLWARN0 NOT EQUAL SPACE                            04780003
047900         WHEN SQLCODE NOT EQUAL ZERO                              04790003
048000              MOVE '9150-FETCH-TABLE-CURSOR'                      04800003
048100                                 TO PV-PARAGRAPH-NAME             04810003
048200              MOVE 'FETCH TABLE CURSOR'                           04820003
048300                                 TO PV-DB2-OPERATION-MSG-1        04830003
048400              MOVE 'TSHIPMT'     TO PV-DB2-TABLE-NAME             04840003
048500              PERFORM 9999-DB2-ABEND                              04850003
048600     END-EVALUATE.                                                04860003
048700                                                                  04870003
048800                                                                  04880003
048900* ************************************************************** *04890003
049000* * CLOSE TABLE CURSOR                                         * *04900003
049100* ************************************************************** *04910003
049200 9190-CLOSE-TABLE-CURSOR.                                         04920003
049300     EXEC SQL                                                     04930003
049400          CLOSE TABLE-CURSOR                                      04940003
049500     END-EXEC.                                                    04950003
049600                                                                  04960003
049700     EVALUATE TRUE                                                04970003
049800         WHEN SQLCODE = ZERO                                      04980003
049900              CONTINUE                                            04990003
050000         WHEN SQLWARN0 NOT EQUAL SPACE                            05000003
050100         WHEN SQLCODE NOT EQUAL ZERO                              05010003
050200              MOVE '9190-CLOSE-TABLE-CURSOR'                      05020003
050300                                 TO PV-PARAGRAPH-NAME             05030003
050400              MOVE 'CLOSE TABLE CURSOR'                           05040003
050500                                 TO PV-DB2-OPERATION-MSG-1        05050003
050600              MOVE 'TSHIPMT'     TO PV-DB2-TABLE-NAME             05060003
050700              PERFORM 9999-DB2-ABEND                              05070003
050800     END-EVALUATE.                                                05080003
050900                                                                  05090003
051000                                                                  05100003
051100* ************************************************************** *05110003
051200* * OPEN OUTPUT EXTRACT FILE                                   * *05120003
051300* ************************************************************** *05130003
051400 9700-OPEN-OUT-EXTRACT-FILE.                                      05140003
051500     OPEN OUTPUT OUT-EXTRACT-FILE.                                05150003
051600                                                                  05160003
051700                                                                  05170003
051800* ************************************************************** *05180003
051900* * WRITE A RECORD TO THE TABLE EXTRACT FILE                   * *05190003
052000* ************************************************************** *05200003
052100 9750-WRITE-EXTRACT-RECORD.                                       05210003
052200     MOVE SPACES TO OUT-EXTRACT-RECORD                            05220003
052300     MOVE DCLTSHIPMT TO OUT-EXTRACT-RECORD                        05230003
052400     WRITE  OUT-EXTRACT-RECORD                                    05240003
052500     ADD +1 TO PV-EXTRACT-WRITTEN-CNT.                            05250003
052600                                                                  05260003
052700                                                                  05270003
052800* ************************************************************** *05280003
052900* * CLOSE OUTPUT EXTRACT FILE                                  * *05290003
053000* ************************************************************** *05300003
053100 9790-CLOSE-OUT-EXTRACT-FILE.                                     05310003
053200     CLOSE OUT-EXTRACT-FILE.                                      05320003
053300                                                                  05330003
053400                                                                  05340003
053500* ************************************************************** *05350003
053600* * DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *05360003
053700* * AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN          * *05370003
053800* * SQL ERROR OR WARNING CODE OCCURS.                          * *05380003
053900* ************************************************************** *05390003
054000 9999-DB2-ABEND.                                                  05400003
054100                                                                  05410003
054200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05420003
054300             ' 9999-DB2-ABEND'.                                   05430003
054400     DISPLAY PC-CURRENT-PROGRAM-NAME                              05440003
054500             ' ** ABEND           **'.                            05450003
054600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05460003
054700             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       05470003
054800     MOVE SHPTPO-SHIPT-ID  TO DP-SHIPT-ID.                        05480003
054900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05490003
055000             ' ** SHIPMENT ID     ** = ' DP-SHIPT-ID.             05500003
055100     DISPLAY PC-CURRENT-PROGRAM-NAME                              05510003
055200             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.       05520003
055300     DISPLAY PC-CURRENT-PROGRAM-NAME                              05530003
055400             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05540003
055500                                                                  05550003
055600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05560003
055700             ' ** SQLCODE         ** = ' SQLCODE.                 05570003
055800     MOVE SQLCODE TO PV-SQLCODE.                                  05580003
055900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05590003
056000             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05600003
056100                                                                  05610003
056200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05620003
056300             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05630003
056400                                                                  05640003
056500                                                                  05650003
056600*----------------------------------------------------------------*05660003
056700* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05670003
056800* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05680003
056900* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05690003
057000* FORMAT.                                                        *05700003
057100*----------------------------------------------------------------*05710003
057200     COPY DPPD004.                                                05720003
057300                                                                  05730003
057400     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05740003
057500     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05750003
057600     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           05760003
057700     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         05770003
057800                                                                  05780003
057900*----------------------------------------------------------------*05790003
058000* CALL ABEND                                                     *05800003
058100*----------------------------------------------------------------*05810003
058200     MOVE +4013                  TO ABEND-CODE.                   05820003
058300     CALL 'ILBOABN0' USING ABEND-CODE.                            05830003
058400*                                                                 05840003
