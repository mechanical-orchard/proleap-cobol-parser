000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
001100                                                                  00110000
001200 PROGRAM-ID.    SNKUP913.                                         00120000
001300 AUTHOR.        RON KRIER                                         00130000
001400 INSTALLATION.  KOHLS.                                            00140000
001500 DATE-WRITTEN   FEBRUARY, 2014.                                   00150000
001600 DATE-COMPILED.                                                   00160000
001700                                                                  00170000
001800******************************************************************00180000
001900*  THIS PROGRAM IS USED TO HELP BUILD TEST ASN DATA.              00190000
002000*                                                                 00200000
002100*  THE INPUT INTO THIS PROGRAM WILL BE FROM FILES OUT OF          00210000
002200*  SNKUT911 AND SNKUT912 THAT HAVE BEEN SORTED TOGETHER TO        00220000
002300*  CREATE A SINGLE ASN FILE THAT WILL NOW BE LOADED INTO THE      00230000
002400*  ASN REPOSITORY TABLES (SNT_DAT_CNTL AND SNT_DAT_XFER).         00240000
002500*                                                                 00250000
002600*  THIS PROGRAM WILL SECURE A CONTROL NUMBER THAT WILL BE         00260000
002700*  USED TO INSERT 1 ROW INTO THE SNT_DAT_CNTL TABLE AND ONE       00270000
002800*  TO MANY ROWS INTO THE SNT_DAT_XFER TABLE FOR THE ASN.          00280000
002900*                                                                 00290000
003000******************************************************************00300000
003100 ENVIRONMENT DIVISION.                                            00310000
003200******************************************************************00320000
003300                                                                  00330000
003400 CONFIGURATION SECTION.                                           00340000
003500                                                                  00350000
003600 SOURCE-COMPUTER.        IBM-3090.                                00360000
003700 OBJECT-COMPUTER.        IBM-3090.                                00370000
003800                                                                  00380000
003900 INPUT-OUTPUT SECTION.                                            00390000
004000                                                                  00400000
004100 FILE-CONTROL.                                                    00410000
004200                                                                  00420000
004300                                                                  00430000
004400     SELECT INPUT-FILE                                            00440000
004500         ASSIGN TO INP01.                                         00450000
004600                                                                  00460000
004700******************************************************************00470000
004800 DATA DIVISION.                                                   00480000
004900******************************************************************00490000
005000                                                                  00500000
005100 FILE SECTION.                                                    00510000
005200                                                                  00520000
005300 FD  INPUT-FILE                                                   00530000
005400     RECORDING MODE IS F                                          00540000
005500     LABEL RECORDS ARE STANDARD                                   00550000
005600     BLOCK CONTAINS 0 RECORDS.                                    00560000
005700                                                                  00570000
005800 01  INPUT-RECORD                     PIC   X(400).               00580000
005900*                                                                 00590000
006000******************************************************************00600000
006100 WORKING-STORAGE SECTION.                                         00610000
006200******************************************************************00620000
006300*                                                                 00630000
006400 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00640000
006500                                                   COMP SYNC.     00650000
006600                                                                  00660000
006620 01  WS-LOCAL-SERVER.                                             00662013
006630     05  WS-SUBSYS                   PIC X(04)  VALUE SPACES.     00663013
006640     05  FILLER                      PIC X(12)  VALUE SPACES.     00664013
006650                                                                  00665013
006700 01  PS-PROGRAM-SWITCHES.                                         00670000
006800     05  PS-EOF-INPUT-SW             PIC  X(01)    VALUE 'N'.     00680000
006900         88  PS-EOF-INPUT                          VALUE 'Y'.     00690000
007000         88  PS-MORE-INPUT                         VALUE 'N'.     00700000
007100                                                                  00710000
007200 01  PC-PROGRAM-CONSTANTS.                                        00720000
007300     05  PC-L                        PIC  X(01)    VALUE 'L'.     00730001
007400     05  PC-R                        PIC  X(01)    VALUE 'R'.     00740001
007410     05  PC-C                        PIC  X(01)    VALUE 'C'.     00741006
007500     05  PC-RANDOM-PGM               PIC  X(08)    VALUE          00750000
007600         'DPKUT902'.                                              00760000
007700     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00770000
007800                                                   COMP SYNC.     00780000
007900     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00790000
008000         'SNKUP913'.                                              00800000
008100     05  PC-CURRENT-OPERATING-COMPANY                             00810000
008200                                     PIC  X(02)    VALUE '03'.    00820000
008300     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +5       00830001
008400                                                   COMP SYNC.     00840000
008500     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  00850000
008600     05  PC-DEFAULT-TMST             PIC  X(26)    VALUE          00860001
008700                                    '0001-01-01-00.00.00.000000'. 00870001
008710     05  PC-90                       PIC S9(04)    COMP           00871013
008720                                                   VALUE 90.      00872013
008730     05  PC-A                        PIC  X(01)    VALUE 'A'.     00873013
008740     05  PC-Y                        PIC  X(01)    VALUE 'Y'.     00874013
008750     05  PC-RCV                      PIC  X(03)    VALUE 'RCV'.   00875013
008760     05  PC-KHL                      PIC  X(03)    VALUE 'KHL'.   00876013
008770     05  PC-PRDCHK                   PIC  X(06)    VALUE 'PRDCHK'.00877013
008780     05  PC-PARM-TEXT                PIC  X(25)    VALUE          00878013
008790         'LOWER LEVEL ONLY         '.                             00879013
008800                                                                  00880000
008900 01  PV-PROGRAM-VARIABLES.                                        00890000
009000     05  PV-ASN-TYPE                 PIC  X(01)    VALUE SPACES.  00900001
009100     05  PV-PREV-DC-NBR              PIC  9(04)    VALUE ZEROS.   00910001
009200     05  PV-PREV-TRAILER-NBR         PIC  9(08)    VALUE ZEROS.   00920001
009210     05  PV-PREV-ENT-ID              PIC  9(09)    VALUE ZERO.    00921009
009220     05  PV-PREV-STRUCTURE-CDE       PIC  X(04)    VALUE SPACES.  00922009
009300     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00930000
009400     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00940000
009500     05  PV-ABEND-MESSAGE            PIC  X(30)    VALUE SPACE.   00950000
009600     05  PV-RETRY-COUNTER            PIC S9(04)    VALUE +0       00960001
009700                                                   COMP SYNC.     00970001
009800     05  PV-ROW-COUNT                PIC S9(09)    VALUE +0       00980001
009900                                                   COMP-3.        00990001
010000     05  PV-INPUT-COUNTER            PIC S9(09)    VALUE ZERO     01000000
010100                                                   COMP SYNC.     01010000
010200     05  PV-INPUT-DISPLAY-COUNTER    PIC S9(09)    VALUE ZERO     01020000
010300                                                   COMP SYNC.     01030000
010400     05  PV-OUTPUT-COUNTER           PIC S9(09)    VALUE ZERO     01040000
010500                                                   COMP SYNC.     01050000
010600     05  PV-CNTL-INSERT-COUNTER      PIC S9(09)    VALUE ZERO     01060000
010700                                                   COMP SYNC.     01070000
010800     05  PV-XFER-INSERT-COUNTER      PIC S9(09)    VALUE ZERO     01080000
010900                                                   COMP SYNC.     01090000
011000     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01100000
011100                                                                  01110000
011200     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01120000
011300                                                   COMP-3.        01130000
011400     05  PV-RANDOM-NBR                PIC 9(09)     VALUE ZERO.   01140000
011500     05  PV-DISPLAY-FIELD             PIC ZZZZZZZZ9 VALUE ZERO.   01150000
011600                                                                  01160000
011700     05  PV-CURRENT-TIMESTAMP         PIC  X(26).                 01170000
011800     05  PV-CURR-TMST.                                            01180000
011900         10  PV-CURR-TMST-CC          PIC  9(02).                 01190001
012000         10  PV-CURR-TMST-YY          PIC  9(02).                 01200001
012100         10  FILLER                   PIC  X(01).                 01210000
012200         10  PV-CURR-TMST-MM          PIC  9(02).                 01220001
012300         10  FILLER                   PIC  X(01).                 01230000
012400         10  PV-CURR-TMST-DD          PIC  9(02).                 01240001
012500         10  FILLER                   PIC  X(01).                 01250000
012600         10  PV-CURR-TMST-HRS         PIC  9(02).                 01260001
012700         10  FILLER                   PIC  X(01).                 01270000
012800         10  PV-CURR-TMST-MIN         PIC  9(02).                 01280001
012900         10  FILLER                   PIC  X(01).                 01290000
013000         10  PV-CURR-TMST-SEC         PIC  9(02).                 01300001
013100         10  FILLER                   PIC  X(01).                 01310000
013200         10  PV-CURR-TMST-NSEC        PIC  9(06).                 01320001
013300                                                                  01330000
013400 01  PV-ABEND-FIELDS.                                             01340000
013500     05  PV-ABEND-CODE                PIC  S9(4) VALUE +0         01350000
013600                                                 COMP SYNC.       01360000
013700     05  PV-SQLCODE                   PIC  Z(08)9-.               01370000
013800     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    01380000
013900     05  PV-ABEND-OPERATION           PIC  X(50) VALUE SPACES.    01390000
014000     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    01400000
014100     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    01410000
014200     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01420000
014300     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01430000
014400     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01440000
014500     05  PV-DB2-TABLE-NAME-1          PIC  X(15) VALUE SPACE.     01450000
014600     05  PV-DB2-TABLE-NAME-2          PIC  X(15) VALUE SPACE.     01460000
014700     05  PV-DB2-TABLE-NAME-3          PIC  X(15) VALUE SPACE.     01470000
014800     05  PV-DB2-TABLE-NAME-4          PIC  X(15) VALUE SPACE.     01480000
014900                                                                  01490000
015000 01  PV-HOLD-TEXT.                                                01500001
015100     05  PVH-ASN-ID                   PIC  X(03)  VALUE SPACES.   01510001
015200     05  PVH-ASN-REMAINDER            PIC  X(347) VALUE ZEROS.    01520001
015300                                                                  01530001
015310 01  PV-INPUT.                                                    01531008
015320     05  FILLER                       PIC  X(01) VALUE SPACES.    01532008
015330     05  PVI-DC-NBR                   PIC  9(04) VALUE ZEROS.     01533008
015340     05  FILLER                       PIC  X(01) VALUE SPACES.    01534008
015350     05  PVI-TRAILER-NBR              PIC  9(08) VALUE ZEROS.     01535008
015360     05  FILLER                       PIC  X(01) VALUE SPACES.    01536008
015370     05  PVI-ENT-ID                   PIC  9(09) VALUE ZEROS.     01537008
015380     05  FILLER                       PIC  X(01) VALUE SPACES.    01538008
015390     05  PVI-STRUCTURE-CDE            PIC  X(04) VALUE ZEROS.     01539008
015391     05  FILLER                       PIC  X(01) VALUE SPACES.    01539108
015392     05  PVI-SEQ-NBR                  PIC  9(08) VALUE ZEROS.     01539208
015393     05  FILLER                       PIC  X(01) VALUE SPACES.    01539308
015394     05  PVI-ASN-DATA-RECORD          PIC  X(350).                01539408
015395     05  FILLER                       PIC  X(11) VALUE SPACE.     01539508
016400                                                                  01640000
016500 01  DK-DB-KEYS.                                                  01650000
016600     05 DK-PO-NBR                     PIC S9(09) COMP.            01660000
016700                                                                  01670000
016800*----------------------------------------------------------------*01680000
016900*  RANDOM NUMBER AREA                                             01690000
017000*----------------------------------------------------------------*01700000
017100     COPY DPWS902.                                                01710000
017200                                                                  01720000
017300******************************************************************01730000
017400*  DB2 FORMATTED MESSAGE AREA                                     01740000
017500******************************************************************01750000
017600     COPY DPWS004.                                                01760000
017700                                                                  01770000
017800******************************************************************01780000
017900*  ASN OUTPUT LAYOUT                                              01790000
018000******************************************************************01800000
018100     COPY SNRD005.                                                01810000
018200*                                                                 01820000
018300******************************************************************01830000
018400*  COMMUNICATIONS AREA FOR DB2                                    01840000
018500******************************************************************01850000
018600     EXEC SQL                                                     01860000
018700          INCLUDE SQLCA                                           01870000
018800     END-EXEC.                                                    01880000
018900                                                                  01890000
019000* DB2 TABLE DECLARATION                                           01900000
019100* (TKRPRPM - PARM TABLE)                                          01910013
019200     EXEC SQL                                                     01920000
019300         INCLUDE TKRPRPM                                          01930013
019400     END-EXEC.                                                    01940000
019401                                                                  01940113
019402* DB2 TABLE DECLARATION                                           01940213
019403* (TCOCNTL - COMPANY CONTROL TABLE)                               01940313
019404     EXEC SQL                                                     01940413
019405         INCLUDE TCOCNTL                                          01940513
019406     END-EXEC.                                                    01940613
019410                                                                  01941006
019420* DB2 TABLE DECLARATION                                           01942006
019430* (SNT_DAT_CNTL - ASN DATA TRANSFER CONTROL TABLE)                01943006
019440     EXEC SQL                                                     01944006
019450         INCLUDE SNT00000                                         01945006
019460     END-EXEC.                                                    01946006
019500                                                                  01950000
019600* DB2 TABLE DECLARATION                                           01960000
019700* (SNT_DAT_XFER - ASN DATA TRANSFER DETAIL TABLE)                 01970000
019800     EXEC SQL                                                     01980000
019900         INCLUDE SNT00001                                         01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020200                                                                  02020000
020300******************************************************************02030000
020400 PROCEDURE DIVISION.                                              02040000
020500******************************************************************02050000
020600                                                                  02060000
020700 0000-PROGRAM-MAINLINE.                                           02070000
020800******************************************************************02080000
020900* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     02090000
021000*      PROGRAM.                                                   02100000
021100******************************************************************02110000
021200                                                                  02120000
021300     PERFORM 1000-INITIALIZE.                                     02130000
021400                                                                  02140000
021500     IF PS-MORE-INPUT                                             02150000
021600         PERFORM 2000-PROCESS-INPUT                               02160000
021700            UNTIL PS-EOF-INPUT                                    02170000
021800     END-IF.                                                      02180000
021900                                                                  02190000
022000     IF  PV-CNTL-INSERT-COUNTER > 0                               02200003
022100         PERFORM 4400-END-OF-ASN                                  02210003
022110     END-IF.                                                      02211003
022120                                                                  02212003
022200     PERFORM 9000-EOJ-ROUTINE.                                    02220000
022300                                                                  02230000
022400     STOP RUN.                                                    02240000
022500                                                                  02250000
022600 1000-INITIALIZE.                                                 02260000
022700******************************************************************02270000
022800*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02280000
022900******************************************************************02290000
023000                                                                  02300000
023020     PERFORM 1100-GET-DB2-INSTANCE.                               02302013
023030     PERFORM 1200-CHECK-IF-PRODUCTION.                            02303013
023040                                                                  02304013
023100     OPEN INPUT INPUT-FILE.                                       02310000
023200     PERFORM 8000-READ-INPUT.                                     02320000
023300                                                                  02330000
023301******************************************************************02330113
023302*  GRAB THE DB2 INSTANCE THAT THE PROGRAM IS ACCESSING.           02330213
023303******************************************************************02330313
023310 1100-GET-DB2-INSTANCE.                                           02331013
023320                                                                  02332013
023330     MOVE '1100-GET-DB2-INSTANCE'                                 02333013
023340          TO PV-PARAGRAPH-NAME.                                   02334013
023350     MOVE 'GET DB2 INSTANCE'                                      02335013
023360          TO PV-DB2-OPERATION-ATTEMPTED.                          02336013
023370                                                                  02337013
023380     EXEC SQL                                                     02338013
023390         SELECT CURRENT SERVER INTO :WS-LOCAL-SERVER              02339013
023391             FROM SYSIBM.SYSDUMMY1 WITH UR                        02339113
023392     END-EXEC.                                                    02339213
023393                                                                  02339313
023394     EVALUATE TRUE                                                02339413
023395         WHEN SQLCODE = +0                                        02339513
023396             CONTINUE                                             02339613
023397         WHEN SQLWARN0 NOT = SPACES                               02339713
023398         WHEN SQLCODE < +0                                        02339813
023399         WHEN SQLCODE > +0                                        02339913
023400             PERFORM 9999-SQL-ABEND                               02340013
023402     END-EVALUATE.                                                02340213
023403                                                                  02340313
023404******************************************************************02340413
023405*  DO A CHECK TO ENSURE THAT THE PROGRAM IS NOT UPDATING          02340513
023406*  PRODUCTION DATA - THIS PROGRAM SHOULD NEVER RUN AGAINST        02340613
023407*  PRODUCTION.                                                    02340713
023408******************************************************************02340813
023409 1200-CHECK-IF-PRODUCTION.                                        02340913
023410                                                                  02341013
023411     MOVE '1200-CHECK-IF-PRODUCTION'                              02341113
023412          TO PV-PARAGRAPH-NAME.                                   02341213
023413     MOVE 'SELECT PRDCHK TKRPRPM '                                02341313
023414          TO PV-DB2-OPERATION-ATTEMPTED.                          02341413
023415                                                                  02341513
023416     EXEC SQL                                                     02341613
023417       SELECT FUNC_TXT                                            02341713
023418         INTO :KRPRPM-FUNC-TXT                                    02341813
023419       FROM   TKRPRPM                                             02341913
023420       WHERE  SYS_PRC_FUNC_CDE  = :PC-PRDCHK                      02342013
023421         AND  INTFC_SYS_CDE     = :PC-KHL                         02342113
023422         AND  LOC_ID            = :PC-90                          02342213
023423         AND  FUNC_TXT          = :PC-PARM-TEXT                   02342313
023424     END-EXEC                                                     02342413
023425                                                                  02342513
023426     EVALUATE TRUE                                                02342613
023427         WHEN SQLCODE = +0                                        02342713
023428             CONTINUE                                             02342813
023429         WHEN SQLCODE = +100                                      02342913
023430             DISPLAY '*******************************************'02343013
023431             DISPLAY '** ABEND - DO NOT RUN THIS SNKUP913 PROGRAM'02343116
023432             DISPLAY '** ABEND - AGAINST PRODUCTION'              02343213
023433             DISPLAY '** ABEND - THIS SHOULD ONLY EVER BE'        02343313
023434             DISPLAY '** ABEND - RUN AGAINST TEST DATA'           02343413
023435             DISPLAY '*******************************************'02343513
023436             DISPLAY '** ABEND - THIS RUN IS GOING AGAINST'       02343613
023437             DISPLAY '** ABEND - DB2 INSTANCE:  '                 02343713
023438                     WS-LOCAL-SERVER                              02343813
023439             DISPLAY '*******************************************'02343913
023440             PERFORM 9999-SQL-ABEND                               02344013
023441                                                                  02344113
023442         WHEN SQLWARN0 NOT = SPACES                               02344213
023443         WHEN SQLCODE < +0                                        02344313
023444         WHEN SQLCODE > +0                                        02344413
023445             PERFORM 9999-SQL-ABEND                               02344513
023446     END-EVALUATE.                                                02344613
023447                                                                  02344713
023450 2000-PROCESS-INPUT.                                              02345000
023500******************************************************************02350000
023600*  PROCESS THE FILE AND COMPARE THE FIELDS                        02360000
023700******************************************************************02370000
023800                                                                  02380000
023900     IF  PVI-DC-NBR      =  PV-PREV-DC-NBR                        02390000
024000     AND PVI-TRAILER-NBR =  PV-PREV-TRAILER-NBR                   02400000
024010     AND PVI-STRUCTURE-CDE        =  PV-PREV-STRUCTURE-CDE        02401010
024020     AND PVI-ENT-ID               =  PV-PREV-ENT-ID               02402009
024100         PERFORM 3200-PROCESS-XFER-DATA                           02410001
024200     ELSE                                                         02420000
024300         IF  PV-CNTL-INSERT-COUNTER > 0                           02430001
024400             PERFORM 4400-END-OF-ASN                              02440001
024500         END-IF                                                   02450001
024600         PERFORM 2400-PROCESS-CNTL-DATA                           02460001
024610         DISPLAY 'DC NUMBER     : ' PVI-DC-NBR                    02461004
024620         DISPLAY 'TRAILER NUMBER: ' PVI-TRAILER-NBR               02462004
024630         DISPLAY 'STRUCTURE CODE: ' PVI-STRUCTURE-CDE             02463011
024631         DISPLAY 'ENT ID        : ' PVI-ENT-ID                    02463112
024640         MOVE SNT00000-DAT-XFER-CNTL-ID TO PV-DISPLAY-FIELD       02464004
024641         DISPLAY 'CONTROL NUMBER: ' PV-DISPLAY-FIELD              02464104
024642         DISPLAY ' '                                              02464204
024700         PERFORM 3200-PROCESS-XFER-DATA                           02470001
024800         MOVE PVI-DC-NBR      TO PV-PREV-DC-NBR                   02480000
024900         MOVE PVI-TRAILER-NBR TO PV-PREV-TRAILER-NBR              02490000
024910         MOVE PVI-STRUCTURE-CDE        TO PV-PREV-STRUCTURE-CDE   02491010
024920         MOVE PVI-ENT-ID               TO PV-PREV-ENT-ID          02492009
025000     END-IF.                                                      02500000
025100                                                                  02510000
025200     PERFORM 8000-READ-INPUT.                                     02520000
025300                                                                  02530000
025400 2400-PROCESS-CNTL-DATA.                                          02540001
025500                                                                  02550000
025600     PERFORM 6000-GET-TIMESTAMP.                                  02560001
025700     MOVE PV-CURRENT-TIMESTAMP TO PV-CURR-TMST.                   02570001
025800     MOVE PV-CURR-TMST-NSEC TO SNT00000-DAT-XFER-CNTL-ID.         02580001
025900     PERFORM 2800-INSERT-CNTL.                                    02590001
026000                                                                  02600001
026100 2800-INSERT-CNTL.                                                02610001
026200                                                                  02620001
026300     MOVE '2800-INSERT-CNTL            ' TO PV-ABEND-PARAGRAPH.   02630001
026400                                                                  02640001
026500     PERFORM WITH TEST AFTER                                      02650001
026600       VARYING PV-RETRY-COUNTER FROM 1 BY 1                       02660001
026700         UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                  02670001
026800            OR SQLCODE = ZERO                                     02680001
026900                                                                  02690001
027000       EXEC SQL                                                   02700001
027100         INSERT INTO SNT_DAT_CNTL                                 02710001
027200             ( DAT_XFER_CNTL_ID                                   02720001
027300              ,CRE_TMST                                           02730001
027400              ,STAT_CDE                                           02740001
027500              ,END_PRC_TMST                                       02750001
027600              ,ASN_TYP_CDE                                        02760001
027700             )                                                    02770001
027800            VALUES                                                02780001
027900             (:SNT00000-DAT-XFER-CNTL-ID                          02790001
028000             ,:PV-CURRENT-TIMESTAMP                               02800001
028100             ,:PC-L                                               02810001
028200             ,:PC-DEFAULT-TMST                                    02820001
028300             ,:PC-R                                               02830001
028400             )                                                    02840001
028500       END-EXEC                                                   02850001
028600                                                                  02860001
028700     EVALUATE TRUE                                                02870001
028800       WHEN SQLCODE = ZEROS                                       02880001
028900            ADD +1 TO PV-CNTL-INSERT-COUNTER                      02890001
029000                      PV-ROW-COUNT                                02900001
029100       WHEN SQLCODE = -803                                        02910001
029200            ADD +1 TO PV-CURR-TMST-NSEC                           02920001
029300            MOVE PV-CURR-TMST-NSEC TO SNT00000-DAT-XFER-CNTL-ID   02930003
029400            DISPLAY 'TMST NSEC     = ' PV-CURR-TMST-NSEC          02940001
029500       WHEN SQLWARN0 NOT = SPACES                                 02950001
029600       WHEN SQLCODE < ZERO                                        02960001
029700       WHEN SQLCODE > ZERO                                        02970001
029800           MOVE '2800-INSERT-CNTL             '                   02980001
029900                               TO PV-PARAGRAPH-NAME               02990001
030000           MOVE 'INSERT TO CONTROL TABLE      '                   03000001
030100                               TO PV-DB2-OPERATION-ATTEMPTED      03010001
030200           PERFORM 9999-SQL-ABEND                                 03020001
030300     END-EVALUATE                                                 03030001
030400     END-PERFORM.                                                 03040001
030500                                                                  03050001
030600     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         03060001
030700       AND SQLCODE NOT = ZERO                                     03070001
030800         DISPLAY '***********************************************'03080001
030900         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO         *'03090001
031000         DISPLAY '** INSERT TO SNT_DAT_CNTL                     *'03100001
031100         DISPLAY '** PARAGRAPH = 2800-INSERT-CNTL               *'03110001
031200         DISPLAY '** PRC CNTL  = ' PV-CURRENT-TIMESTAMP           03120001
031300         DISPLAY '***********************************************'03130001
031400         PERFORM 9999-SQL-ABEND                                   03140001
031500     END-IF.                                                      03150001
031600                                                                  03160000
031700 3200-PROCESS-XFER-DATA.                                          03170001
031800                                                                  03180000
031900     MOVE PVI-ASN-DATA-RECORD TO PV-HOLD-TEXT                     03190001
032000                                 SNT00001-LOD-DAT-TXT-TEXT.       03200005
032100     MOVE 350                 TO SNT00001-LOD-DAT-TXT-LEN.        03210001
032200     MOVE PVH-ASN-ID          TO SNT00001-DAT-CTG-CDE.            03220001
032300     MOVE PVI-SEQ-NBR         TO SNT00001-PRC-LOD-SEQ-NBR.        03230001
032400     PERFORM 3600-INSERT-XFER.                                    03240001
032500                                                                  03250001
032600 3600-INSERT-XFER.                                                03260001
032700                                                                  03270001
032800     MOVE '3600-INSERT-XFER            ' TO PV-ABEND-PARAGRAPH.   03280001
032900                                                                  03290001
033000     EXEC SQL                                                     03300001
033100         INSERT INTO SNT_DAT_XFER                                 03310001
033200                (DAT_XFER_CNTL_ID                                 03320001
033300                ,PRC_LOD_SEQ_NBR                                  03330001
033400                ,DAT_CTG_CDE                                      03340001
033500                ,LOD_DAT_TXT                                      03350001
033600                )                                                 03360001
033700         VALUES                                                   03370001
033800                (:SNT00000-DAT-XFER-CNTL-ID                       03380001
033900                ,:SNT00001-PRC-LOD-SEQ-NBR                        03390001
034000                ,:SNT00001-DAT-CTG-CDE                            03400001
034100                ,:SNT00001-LOD-DAT-TXT                            03410001
034200                )                                                 03420001
034300     END-EXEC.                                                    03430001
034400                                                                  03440001
034500     EVALUATE TRUE                                                03450001
034600       WHEN SQLCODE = ZEROS                                       03460001
034700            ADD +1 TO PV-XFER-INSERT-COUNTER                      03470001
034800                      PV-ROW-COUNT                                03480001
034900       WHEN SQLWARN0 NOT = SPACES                                 03490001
035000       WHEN SQLCODE < ZERO                                        03500001
035100       WHEN SQLCODE > ZERO                                        03510001
035200           MOVE '3600-INSERT-XFER             '                   03520001
035300                               TO PV-PARAGRAPH-NAME               03530001
035400           MOVE 'INSERT TO DATA XFER TABLE  '                     03540001
035500                               TO PV-DB2-OPERATION-ATTEMPTED      03550001
035600           PERFORM 9999-SQL-ABEND                                 03560001
035700     END-EVALUATE.                                                03570001
035800                                                                  03580001
035900     IF  PV-ROW-COUNT > 9995                                      03590001
036000         PERFORM 4000-DB2-COMMIT                                  03600001
036100     END-IF.                                                      03610001
036200                                                                  03620001
036300******************************************************************03630001
036400* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     03640001
036500******************************************************************03650001
036600 4000-DB2-COMMIT.                                                 03660001
036700                                                                  03670001
036800     MOVE '4000-DB2-COMMIT             ' TO PV-ABEND-PARAGRAPH.   03680001
036900                                                                  03690001
037000     EXEC SQL                                                     03700001
037100         COMMIT                                                   03710001
037200     END-EXEC.                                                    03720001
037300                                                                  03730001
037400     EVALUATE TRUE                                                03740001
037500       WHEN SQLCODE = ZEROS                                       03750001
037600            MOVE +0 TO PV-ROW-COUNT                               03760001
037700       WHEN SQLWARN0 NOT = SPACES                                 03770001
037800       WHEN SQLCODE < ZERO                                        03780001
037900       WHEN SQLCODE > ZERO                                        03790001
038000           MOVE '4000-DB2-COMMIT              '                   03800001
038100                               TO PV-PARAGRAPH-NAME               03810001
038200           MOVE 'COMMIT OF DB2 DATA         '                     03820001
038300                               TO PV-DB2-OPERATION-ATTEMPTED      03830001
038400           PERFORM 9999-SQL-ABEND                                 03840001
038500     END-EVALUATE.                                                03850001
038600                                                                  03860001
038700 4400-END-OF-ASN.                                                 03870001
038800                                                                  03880001
038900     PERFORM 4800-UPDATE-CNTL.                                    03890001
039000     PERFORM 4000-DB2-COMMIT.                                     03900001
039100                                                                  03910001
039200 4800-UPDATE-CNTL.                                                03920002
039300                                                                  03930002
039400     MOVE '4800-UPDATE-CNTL            ' TO PV-ABEND-PARAGRAPH.   03940002
039500                                                                  03950002
039600     EXEC SQL                                                     03960002
039700         UPDATE SNT_DAT_CNTL                                      03970002
039800            SET STAT_CDE         = :PC-R                          03980007
039900          WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID     03990002
040000     END-EXEC.                                                    04000002
040100                                                                  04010002
040200     EVALUATE TRUE                                                04020002
040300       WHEN SQLCODE = ZEROS                                       04030002
040400            CONTINUE                                              04040002
040500       WHEN SQLWARN0 NOT = SPACES                                 04050002
040600       WHEN SQLCODE < ZERO                                        04060002
040700       WHEN SQLCODE > ZERO                                        04070002
040800           MOVE '4800-UPDATE-CNTL             '                   04080002
040900                               TO PV-PARAGRAPH-NAME               04090002
041000           MOVE 'UPDATE TO DATA CONTROL TABLE '                   04100002
041100                               TO PV-DB2-OPERATION-ATTEMPTED      04110002
041200           PERFORM 9999-SQL-ABEND                                 04120002
041300     END-EVALUATE.                                                04130002
041400                                                                  04140002
041500                                                                  04150000
041600 6000-GET-TIMESTAMP.                                              04160000
041700                                                                  04170000
041800     EXEC SQL                                                     04180000
041900          SELECT CURRENT TIMESTAMP                                04190000
042000          INTO  :PV-CURRENT-TIMESTAMP                             04200000
042100          FROM   TCOCNTL                                          04210000
042200          WHERE OPER_UNT_ID = 90                                  04220000
042300          WITH UR                                                 04230000
042400     END-EXEC.                                                    04240000
042500                                                                  04250000
042600     EVALUATE TRUE                                                04260000
042700         WHEN SQLCODE = ZERO                                      04270000
042800         WHEN SQLCODE = -811                                      04280000
042900              CONTINUE                                            04290000
043000         WHEN SQLWARN0 NOT = SPACE                                04300000
043100         WHEN SQLCODE NOT = ZERO                                  04310000
043200              MOVE '6000-GET-TIMESTAMP'                           04320000
043300                                  TO PV-PARAGRAPH-NAME            04330000
043400              MOVE 'SELECT TIMESTAMP FROM TCOCNTL          '      04340000
043500                                  TO PV-DB2-OPERATION-MESSAGE-1   04350000
043600              MOVE 'TCOCNTL'      TO PV-DB2-TABLE-NAME-1          04360000
043700              PERFORM 9999-SQL-ABEND                              04370000
043800     END-EVALUATE.                                                04380000
043900                                                                  04390000
044000 8000-READ-INPUT.                                                 04400000
044100******************************************************************04410000
044200*  READ THE INPUT FILE                                            04420000
044300******************************************************************04430000
044400     READ INPUT-FILE                                              04440000
044500          INTO PV-INPUT                                           04450000
044600          AT END                                                  04460000
044700             SET PS-EOF-INPUT TO TRUE.                            04470000
044800                                                                  04480000
044900     IF PS-EOF-INPUT                                              04490000
045000        CONTINUE                                                  04500000
045100     ELSE                                                         04510000
045200        ADD +1 TO PV-INPUT-COUNTER                                04520000
045300        ADD +1 TO PV-INPUT-DISPLAY-COUNTER                        04530000
045800     END-IF.                                                      04580000
045900                                                                  04590000
046000     IF  PV-INPUT-DISPLAY-COUNTER = 2000                          04600000
046100         MOVE PV-INPUT-COUNTER       TO PV-DISPLAY-FIELD          04610000
046200         DISPLAY 'READ INPUT RECORD: '                            04620000
046300                 PV-DISPLAY-FIELD                                 04630000
046400         MOVE ZEROS TO PV-INPUT-DISPLAY-COUNTER                   04640000
046500     END-IF.                                                      04650000
046600                                                                  04660000
046700 9000-EOJ-ROUTINE.                                                04670000
046800******************************************************************04680000
046900*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          04690000
047000******************************************************************04700000
047100     CLOSE INPUT-FILE.                                            04710000
047200                                                                  04720000
047210     MOVE PV-CNTL-INSERT-COUNTER TO PV-DISPLAY-COUNT.             04721002
047400     DISPLAY 'CNTL ROWS INSERTED:       ' PV-DISPLAY-COUNT.       04740002
047410     MOVE PV-XFER-INSERT-COUNTER TO PV-DISPLAY-COUNT.             04741002
047600     DISPLAY 'XFER ROWS INSERTED:       ' PV-DISPLAY-COUNT.       04760002
047700                                                                  04770000
047800                                                                  04780000
049400******************************************************************04940000
049500* ABEND PROCEDURE                                                *04950000
049600******************************************************************04960000
049700 9999-SQL-ABEND.                                                  04970000
049800     DISPLAY '** ABEND           ** = SQLABEND'.                  04980000
049900     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  04990000
050000     DISPLAY '** PARAGRAPH       ** = ' PV-ABEND-PARAGRAPH.       05000000
050100     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME-1.      05010000
050200     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME-2.      05020000
050300     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME-3.      05030000
050400     DISPLAY '** TABLE AFFECTED  ** = ' PV-DB2-TABLE-NAME-4.      05040000
050500     DISPLAY '** OPERATION       ** = ' PV-DB2-OPERATION-MESSAGE-105050000
050600     DISPLAY '**                 ** = ' PV-DB2-OPERATION-MESSAGE-205060000
050700     DISPLAY '** SQLCODE         ** = ' PV-SQLCODE.               05070000
050800     COPY DPPD004.                                                05080000
050900     MOVE +4013                  TO PV-ABEND-CODE.                05090000
051000     CALL 'ILBOABN0'   USING PV-ABEND-CODE.                       05100000
