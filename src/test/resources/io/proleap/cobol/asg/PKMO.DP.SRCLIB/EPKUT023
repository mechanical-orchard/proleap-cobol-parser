000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      EPKUT023.                                       00030000
000400 AUTHOR.          STEVEN NOWAK.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    07/15/09.                                       00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*            EXTRACT PLU - RESET PROMPT FOR PRICE                 00100000
001100*=================================================================00110000
001200* MODULE TYPE: COBOL2 DB2 BATCH                                   00120003
001300*                                                                 00130000
001400* THIS PROGRAM IDENTIFIES SKUS THAT HAD A WHITE TICKET PRICE      00140000
001500* CHANGE EXTRACTED DURING THE PREVIOUS PLU EXTRACT RUN.  THE      00150000
001600* PROMPT FOR PRICE INDICATOR WOULD HAVE BEEN SET ON FOR THESE     00160000
001700* SKUS, TO ALLOW ONE DAY TO MAKE THE PRICE CHANGE AT THE STORE.   00170000
001800* THIS PROGRAM WILL NOW SET THE PROMPT FOR PRICE INDICATOR OFF.   00180000
001900*                                                                 00190000
002000* THIS PROGRAM USES A CURSOR THAT WILL JOIN THE XST_SKU_LOC AND   00200000
002100* XST_SKU_LOC_ATTR TABLES.  IT WILL SELECT ALL SKUS THAT WOULD    00210000
002200* HAVE HAD A PRICE UPDATE EXTRACTED DURING THE PREVIOUS RUN, WHERE00220000
002300* THE STATUS IS NOT CLEARANCE (MEANING IT IS WHITE TICKET)        00230000
002400* AND THE PROMPT FOR PRICE INDICATOR IS CURRENTLY SET TO 'Y'.     00240000
002500* IT WILL WRITE OUT THIS RECORD SO ANOTHER PROGRAM CAN UPDATE THE 00250000
002600* PROMPT FOR PRICE INDICATOR TO 'N'.                              00260000
002700*                                                                 00270000
002800*========================== CHANGE LOG ===========================00280000
002900*  AUTH       BY          DATE                 DESCRIPTION        00290000
003000*=================================================================00300000
003100* WR36870   S. NOWAK    07-15-09   CREATE PROGRAM                 00310000
003200*                                                                 00320000
003300******************************************************************00330000
003400                                                                  00340000
003500 ENVIRONMENT DIVISION.                                            00350000
003600 CONFIGURATION SECTION.                                           00360000
003700                                                                  00370000
003800 SOURCE-COMPUTER. IBM-3090.                                       00380000
003900 OBJECT-COMPUTER. IBM-3090.                                       00390000
004000                                                                  00400000
004100 INPUT-OUTPUT SECTION.                                            00410000
004200 FILE-CONTROL.                                                    00420000
004300                                                                  00430000
004400     SELECT CNTL-FILE ASSIGN TO INP01.                            00440000
004500     SELECT XST-FILE  ASSIGN TO OUT01.                            00450000
004600                                                                  00460000
004700 DATA DIVISION.                                                   00470000
004800 FILE SECTION.                                                    00480000
004900                                                                  00490000
005000 FD  CNTL-FILE                                                    00500000
005100     RECORDING MODE IS F                                          00510000
005200     LABEL RECORDS ARE STANDARD                                   00520000
005300     RECORD CONTAINS 80 CHARACTERS                                00530000
005400     DATA RECORD IS CNTL-REC.                                     00540000
005500                                                                  00550000
005600 01  CNTL-REC                     PIC X(80).                      00560000
005700                                                                  00570000
005800 FD  XST-FILE                                                     00580000
005900     RECORDING MODE IS F                                          00590000
006000     LABEL RECORDS ARE STANDARD                                   00600000
006100     RECORD CONTAINS 33 CHARACTERS                                00610000
006200     DATA RECORD IS XST-REC.                                      00620000
006300                                                                  00630000
006400 01  XST-REC                      PIC X(33).                      00640000
006500                                                                  00650000
006600                                                                  00660000
006700***************************************************************** 00670000
006800*                       WORKING STORAGE                           00680000
006900***************************************************************** 00690000
007000 WORKING-STORAGE SECTION.                                         00700000
007100                                                                  00710000
007200 01  W-START                          PIC  X(50) VALUE            00720000
007300     ' *** WORKING STORAGE STARTS HERE FOR EPKUT023 *** '.        00730000
007400                                                                  00740000
007500***************************************************************** 00750000
007600*                         SWITCHES                                00760000
007700***************************************************************** 00770000
007800 01  PS-PROGRAM-SWITCHES.                                         00780000
007900     05  PS-END-OF-PROMPT-CURSOR-SW   PIC  X(01) VALUE 'N'.       00790000
008000         88  PS-END-OF-PROMPT-CURSOR             VALUE 'Y'.       00800000
008100         88  PS-MORE-PROMPT-CURSOR               VALUE 'N'.       00810000
008200                                                                  00820000
008300     05  PS-END-OF-CONTROL-FILE-SW    PIC  X(01) VALUE 'N'.       00830000
008400         88  PS-END-OF-CONTROL-FILE              VALUE 'Y'.       00840000
008500         88  PS-MORE-CONTROL-FILE                VALUE 'N'.       00850000
008600                                                                  00860000
008700******************************************************************00870000
008800*                       ACCUMULATORS                              00880000
008900******************************************************************00890000
009000 01  PA-PROGRAM-ACCUMS.                                           00900000
009100     05  PA-FETCHED                   PIC  9(09) VALUE ZEROS.     00910000
009200     05  PA-WRITTEN                   PIC  9(09) VALUE ZEROS.     00920000
009300                                                                  00930000
009400******************************************************************00940000
009500*                        CONSTANTS                                00950000
009600******************************************************************00960000
009700 01  PC-PROGRAM-CONSTANTS.                                        00970000
009800     05  PC-PGM-NAME                  PIC  X(08) VALUE 'EPKUT023'.00980000
009900     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3 COMP.   00990000
010000                                                                  01000000
010100******************************************************************01010000
010200*                        VARIABLES                                01020000
010300******************************************************************01030000
010400 01  PV-PROGRAM-VARIABLES.                                        01040000
010500     05  PV-SQL-SUB                   PIC S9(04) VALUE +0 COMP.   01050000
010600                                                                  01060000
010700     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     01070000
010800     05  PV-DB2-OPERATION-MSG         PIC  X(30) VALUE SPACE.     01080000
010900     05  PV-OPERATION-MSG-1           PIC  X(40) VALUE SPACES.    01090000
011000     05  PV-OPERATION-MSG-2           PIC  X(40) VALUE SPACES.    01100000
011100                                                                  01110000
011200     05  PV-INTR-UPC-ID               PIC S9(09) VALUE +0 COMP.   01120000
011300     05  PV-LOC-NBR                   PIC S9(04) VALUE +0 COMP.   01130000
011400     05  PV-TO-TIMESTAMP              PIC  X(26) VALUE SPACE.     01140000
011500                                                                  01150000
011600******************************************************************01160000
011700*               SYSTEM TIME AND DATE VARIABLES                    01170000
011800******************************************************************01180000
011900 01  SYS-DATE-TIME.                                               01190000
012000     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    01200000
012100     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    01210000
012200                                                                  01220000
012300 01  ST-BEG-TIME.                                                 01230000
012400     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     01240000
012500     05  FILLER                       PIC  X(01) VALUE ':'.       01250000
012600     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01260000
012700                                                                  01270000
012800 01  ST-END-TIME.                                                 01280000
012900     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01290000
013000     05  FILLER                       PIC  X(01) VALUE ':'.       01300000
013100     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01310000
013200                                                                  01320000
013300 01  SD-EDIT-DATE.                                                01330000
013400     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01340000
013500     05  FILLER                       PIC  X(01) VALUE '-'.       01350000
013600     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01360000
013700     05  FILLER                       PIC  X(01) VALUE '-'.       01370000
013800     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01380000
013900     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01390000
014000                                                                  01400000
014100******************************************************************01410000
014200*                        ERROR HANDLING                           01420000
014300******************************************************************01430000
014400 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01440000
014500                                                 COMP SYNC.       01450000
014600                                                                  01460000
014700     88  ABEND-4001-WRITE-ERROR                  VALUE +4001.     01470000
014800     88  ABEND-4002-READ-ERROR                   VALUE +4002.     01480000
014900     88  ABEND-4003-CTRL-CARD-ERROR              VALUE +4003.     01490000
015000     88  ABEND-4004-TABLE-ERROR                  VALUE +4004.     01500000
015100     88  ABEND-4005-OPEN-ERROR                   VALUE +4005.     01510000
015200     88  ABEND-4006-CLOSE-ERROR                  VALUE +4006.     01520000
015300     88  ABEND-4007-SEQUENCE-ERROR               VALUE +4007.     01530000
015400     88  ABEND-4008-DATA-ERROR                   VALUE +4008.     01540000
015500     88  ABEND-4009-KEY-DATA-ERROR               VALUE +4009.     01550000
015600     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01560000
015700     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     01570000
015800     88  ABEND-4020-MQ-ERROR                     VALUE +4020.     01580000
015900     88  ABEND-4444-FORCED-ABEND                 VALUE +4444.     01590000
016000                                                                  01600000
016100                                                                  01610000
016200******************************************************************01620000
016300* CONTROL CARD EPCC105 LAYOUT                                     01630000
016400******************************************************************01640000
016500     COPY EPWS105.                                                01650000
016600                                                                  01660000
016700******************************************************************01670000
016800* XST_SKU_LOC_ATTR REC LAYOUT                                     01680000
016900******************************************************************01690000
017000     COPY EPRD003.                                                01700000
017100                                                                  01710000
017200******************************************************************01720000
017300* WS FIELDS FOR SQLCA MESSAGE ROUTINE                             01730000
017400******************************************************************01740000
017500     COPY DPWS004.                                                01750000
017600                                                                  01760000
017700******************************************************************01770000
017800* DB2 ABEND COPYBOOK                                              01780000
017900******************************************************************01790000
018000     COPY DPWS900.                                                01800000
018100                                                                  01810000
018200******************************************************************01820000
018300* DB2 MESSAGE AREA                                                01830000
018400******************************************************************01840000
018500     COPY SQLCA2.                                                 01850000
018600                                                                  01860000
018700******************************************************************01870000
018800* DB2 COMMUNICATION AREA.                                         01880000
018900******************************************************************01890000
019000     EXEC SQL                                                     01900000
019100          INCLUDE SQLCA                                           01910000
019200     END-EXEC.                                                    01920000
019300                                                                  01930000
019400******************************************************************01940000
019500* DB2 TABLE XST00008 - SKU LOCATION TABLE(XST_SKU_LOC)            01950000
019600******************************************************************01960000
019700     EXEC SQL                                                     01970000
019800          INCLUDE XST00008                                        01980000
019900     END-EXEC.                                                    01990000
020000                                                                  02000000
020100******************************************************************02010000
020200* DB2 TABLE XST00041 - SKU LOCATION ATTRIBUTE TABLE               02020001
020300*                       (XST_SKU_LOC_ATTR)                        02030000
020400******************************************************************02040000
020500     EXEC SQL                                                     02050000
020600          INCLUDE XST00041                                        02060000
020700     END-EXEC.                                                    02070000
020800                                                                  02080000
020900******************************************************************02090000
021000* RESET PROMPT CURSOR WILL FETCH ALL SKU LOCATION ATTRIBUTE       02100000
021100* ROWS THAT HAVE THEIR PROMPT FOR PRICE INDICATOR SET TO YES,     02110000
021200* BUT NEED TO HAVE IT RESET TO NO.                                02120000
021300******************************************************************02130000
021400     EXEC SQL                                                     02140000
021500       DECLARE RESET-PROMPT-CSR CURSOR FOR                        02150002
021600         SELECT ATTR.INTR_UPC_ID                                  02160000
021700               ,ATTR.LOC_NBR                                      02170000
021800         FROM   XST_SKU_LOC      SKU                              02180000
021900               ,XST_SKU_LOC_ATTR ATTR                             02190000
022000         WHERE  SKU.INTR_UPC_ID         =  ATTR.INTR_UPC_ID       02200000
022100           AND  SKU.LOC_NBR             =  ATTR.LOC_NBR           02210000
022200           AND  ATTR.LAST_UPD_TMST      <= :PV-TO-TIMESTAMP       02220000
022300           AND  ATTR.LAST_UPD_TMST      >=                        02230000
022400                                 :CC-EPCC105-PREV-TIMESTAMP       02240000
022500           AND  SKU.LOC_SKU_STAT_CDE    <> '30'                   02250000
022600           AND  SKU.END_TMST            IS NULL                   02260000
022700           AND  ATTR.PRMPT_FOR_PRIC_IND = 'Y'                     02270000
022800         WITH UR                                                  02280000
022900     END-EXEC.                                                    02290000
023000                                                                  02300000
023100                                                                  02310000
023200                                                                  02320000
023300 PROCEDURE DIVISION.                                              02330000
023400******************************************************************02340000
023500* MAINLINE                                                        02350000
023600******************************************************************02360000
023700 0000-MAINLINE.                                                   02370000
023800                                                                  02380000
023900     PERFORM 1000-INITIALIZATION.                                 02390000
024000                                                                  02400000
024100     PERFORM 2000-PROCESS-CURSOR                                  02410000
024200       UNTIL PS-END-OF-PROMPT-CURSOR.                             02420000
024300                                                                  02430000
024400     PERFORM 6200-CLOSE-RESET-PROMPT-CSR.                         02440000
024500                                                                  02450000
024600     PERFORM 9900-END-OF-JOB-ROUTINE.                             02460000
024700                                                                  02470000
024800     GOBACK.                                                      02480000
024900                                                                  02490000
025000                                                                  02500000
025100******************************************************************02510000
025200* OPENS UP THE CONTROL CARD AND READS IT.  CHECKS FOR ERRORS.     02520000
025300******************************************************************02530000
025400 1000-INITIALIZATION.                                             02540000
025500                                                                  02550000
025600     INITIALIZE PV-INTR-UPC-ID,                                   02560000
025700                PV-LOC-NBR.                                       02570000
025800                                                                  02580000
025900     SET PS-MORE-PROMPT-CURSOR TO TRUE.                           02590000
026000                                                                  02600000
026100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 02610000
026200                                                                  02620000
026300     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            02630000
026400     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            02640000
026500                                                                  02650000
026600     MOVE SYS-DATE (1:2) TO SD-CENT.                              02660000
026700     MOVE SYS-DATE (3:2) TO SD-YEAR.                              02670000
026800     MOVE SYS-DATE (5:2) TO SD-MONTH.                             02680000
026900     MOVE SYS-DATE (7:2) TO SD-DAY.                               02690000
027000                                                                  02700000
027100     PERFORM 1200-PROCESS-CNTL-CARD.                              02710000
027200                                                                  02720000
027300     PERFORM 6000-OPEN-RESET-PROMPT-CSR.                          02730000
027400     PERFORM 6100-FETCH-RESET-PROMPT-CSR.                         02740000
027500                                                                  02750000
027600                                                                  02760000
027700******************************************************************02770000
027800* OPENS UP THE CONTROL CARD AND READS IT.  CHECKS FOR ERRORS.     02780000
027900******************************************************************02790000
028000 1200-PROCESS-CNTL-CARD.                                          02800000
028100                                                                  02810000
028200     INITIALIZE CC-EPCC105-CONTROL-CARD.                          02820000
028300                                                                  02830000
028400     OPEN  INPUT CNTL-FILE                                        02840000
028500          OUTPUT XST-FILE.                                        02850000
028600                                                                  02860000
028700     PERFORM 1210-READ-TIMESTAMP-CARD.                            02870000
028800                                                                  02880000
028900     MOVE '1000-INITIALIZATION' TO PV-PARAGRAPH-NAME.             02890000
029000     IF PS-END-OF-CONTROL-FILE                                    02900000
029100        DISPLAY 'MISSING CONTROL CARD!'                           02910000
029200        MOVE 'CONTROL CARD IS MISSING' TO PV-OPERATION-MSG-1      02920000
029300        SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                    02930000
029400        PERFORM 9000-ABEND                                        02940000
029500     END-IF.                                                      02950000
029600                                                                  02960000
029700     IF CC-EPCC105-PREV-TIMESTAMP    = SPACES OR                  02970000
029800        CC-EPCC105-CRNT-TIMESTAMP    = SPACES                     02980000
029900        DISPLAY 'INVALID CONTROL CARD'                            02990000
030000        DISPLAY 'PREVIOUS TIMESTAMP: ' CC-EPCC105-PREV-TIMESTAMP  03000000
030100        DISPLAY 'CURRENT  TIMESTAMP: ' CC-EPCC105-CRNT-TIMESTAMP  03010000
030200        MOVE 'CONTROL CARD IS INVALID' TO PV-OPERATION-MSG-1      03020000
030300        SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                    03030000
030400        PERFORM 9000-ABEND                                        03040000
030500     END-IF.                                                      03050000
030600                                                                  03060000
030700     MOVE CC-EPCC105-CRNT-TIMESTAMP TO PV-TO-TIMESTAMP.           03070000
030800                                                                  03080000
030900     CLOSE CNTL-FILE.                                             03090000
031000                                                                  03100000
031100                                                                  03110000
031200******************************************************************03120000
031300* READS IN THE TIMESTAMP(EPCC105) CONTROL CARD.                   03130000
031400******************************************************************03140000
031500 1210-READ-TIMESTAMP-CARD.                                        03150000
031600                                                                  03160000
031700     READ CNTL-FILE INTO CC-EPCC105-CONTROL-CARD                  03170000
031800         AT END SET PS-END-OF-CONTROL-FILE TO TRUE                03180000
031900     END-READ.                                                    03190000
032000                                                                  03200000
032100                                                                  03210000
032200******************************************************************03220000
032300* PROCESS THE UPC RECORDS                                         03230000
032400******************************************************************03240000
032500 2000-PROCESS-CURSOR.                                             03250000
032600                                                                  03260000
032700     PERFORM 2100-WRITE-PROMPT.                                   03270000
032800                                                                  03280000
032900     PERFORM 6100-FETCH-RESET-PROMPT-CSR.                         03290000
033000                                                                  03300000
033100                                                                  03310000
033200******************************************************************03320000
033300* WRITE THE PRMPT-FOR-PRIC-IND VALUE FOR THIS SKU/LOCATION.       03330000
033400******************************************************************03340000
033500 2100-WRITE-PROMPT.                                               03350000
033600                                                                  03360000
033700     MOVE XST00041-INTR-UPC-ID TO EP003-INTR-UPC-ID.              03370000
033800     MOVE XST00041-LOC-NBR     TO EP003-LOC-NBR.                  03380000
033900     MOVE SPACES               TO EP003-PRMPT-FOR-PRIC-IND.       03390000
034000     MOVE SPACES               TO EP003-LAST-UPD-TMST.            03400000
034100                                                                  03410000
034200     WRITE XST-REC FROM EP003-XST-REC.                            03420000
034300                                                                  03430000
034400     ADD 1 TO PA-WRITTEN.                                         03440000
034500                                                                  03450000
034600                                                                  03460000
034700******************************************************************03470000
034800* OPEN THE RESET PROMPT CURSOR.                                   03480000
034900******************************************************************03490000
035000 6000-OPEN-RESET-PROMPT-CSR.                                      03500000
035100                                                                  03510000
035200     MOVE '6000-OPEN-RESET-PROMPT-CSR' TO PV-PARAGRAPH-NAME.      03520000
035300                                                                  03530000
035400     PERFORM                                                      03540000
035500         WITH TEST AFTER                                          03550000
035600         VARYING PV-SQL-SUB                                       03560000
035700         FROM 1 BY 1                                              03570000
035800         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03580000
040300                   OR  SQLCODE = -904                             03581004
040300                   OR  SQLCODE = -911                             03582004
040300                   OR  SQLCODE = -913                             03583004
035900                   OR  SQLCODE = 0)                               03590000
036000                                                                  03600000
036100           EXEC SQL                                               03610000
036200              OPEN RESET-PROMPT-CSR                               03620000
036300           END-EXEC                                               03630000
036400                                                                  03640000
036500         EVALUATE TRUE                                            03650000
036600             WHEN SQLCODE = -904                                  03660000
036700             WHEN SQLCODE = -911                                  03670000
036800             WHEN SQLCODE = -913                                  03680000
036900             WHEN SQLCODE = 0                                     03690000
037000                 CONTINUE                                         03700000
037100                                                                  03710000
037200             WHEN SQLWARN0 NOT EQUAL SPACE                        03720000
037300             WHEN SQLCODE NOT EQUAL ZERO                          03730000
037400                  MOVE 'ERROR ON OPEN OF RESET PROMPT CURSOR'     03740000
037500                                     TO PV-DB2-OPERATION-MSG      03750000
037600                                                                  03760000
037700                  SET ABEND-4005-OPEN-ERROR TO TRUE               03770000
037800                  PERFORM 9100-SQL-ABEND                          03780000
037900         END-EVALUATE                                             03790000
038000     END-PERFORM.                                                 03800000
038100                                                                  03810000
038200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        03820000
038300         MOVE 'OPEN RETRIES EXCEEDED'                             03830000
038400                               TO  PV-DB2-OPERATION-MSG           03840000
038500                                                                  03850000
038600         SET ABEND-4005-OPEN-ERROR TO TRUE                        03860000
038700         PERFORM 9100-SQL-ABEND                                   03870000
038800     END-IF.                                                      03880000
038900                                                                  03890000
039000                                                                  03900000
039100******************************************************************03910000
039200* FETCH SKU LOCATION NEEDING IT'S PRMPT-FOR-PRIC-IND RESET.       03920000
039300******************************************************************03930000
039400 6100-FETCH-RESET-PROMPT-CSR.                                     03940000
039500                                                                  03950000
039600     MOVE '6100-FETCH-RESET-PROMPT-CSR' TO PV-PARAGRAPH-NAME.     03960000
039700                                                                  03970000
039800     PERFORM                                                      03980000
039900         WITH TEST AFTER                                          03990000
040000         VARYING PV-SQL-SUB                                       04000000
040100         FROM 1 BY 1                                              04010000
040200         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04020000
040300                   OR  SQLCODE = 0                                04030000
040300                   OR  SQLCODE = -904                             04031004
040300                   OR  SQLCODE = -911                             04032004
040300                   OR  SQLCODE = -913                             04033004
040400                   OR  SQLCODE = +100)                            04040000
040500                                                                  04050000
040600           EXEC SQL                                               04060000
040700              FETCH RESET-PROMPT-CSR                              04070000
040800              INTO  :XST00041-INTR-UPC-ID                         04080000
040900                   ,:XST00041-LOC-NBR                             04090000
041000           END-EXEC                                               04100000
041100                                                                  04110000
041200          EVALUATE TRUE                                           04120000
041300             WHEN SQLCODE = -904                                  04130000
041400             WHEN SQLCODE = -911                                  04140000
041500             WHEN SQLCODE = -913                                  04150000
041600                  CONTINUE                                        04160000
041700                                                                  04170000
041800             WHEN SQLCODE = ZERO                                  04180000
041900                  ADD 1 TO PA-FETCHED                             04190000
042000                                                                  04200000
042100                  MOVE XST00041-INTR-UPC-ID TO PV-INTR-UPC-ID     04210000
042200                  MOVE XST00041-LOC-NBR     TO PV-LOC-NBR         04220000
042300                                                                  04230000
042400             WHEN SQLCODE = +100                                  04240000
042500                  SET PS-END-OF-PROMPT-CURSOR TO TRUE             04250000
042600                                                                  04260000
042700             WHEN SQLWARN0 NOT EQUAL SPACE                        04270000
042800             WHEN SQLCODE NOT EQUAL ZERO                          04280000
042900                  MOVE 'ERROR ON FETCHING RESET PROMPT CURSOR'    04290000
043000                                     TO PV-DB2-OPERATION-MSG      04300000
043100                                                                  04310000
043200                  SET ABEND-4002-READ-ERROR TO TRUE               04320000
043300                  PERFORM 9100-SQL-ABEND                          04330000
043400          END-EVALUATE                                            04340000
043500     END-PERFORM.                                                 04350000
043600                                                                  04360000
043700                                                                  04370000
043800     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        04380000
043900         MOVE 'FETCH RETRIES EXCEEDED'                            04390000
044000                               TO  PV-DB2-OPERATION-MSG           04400000
044100                                                                  04410000
044200         SET ABEND-4002-READ-ERROR TO TRUE                        04420000
044300         PERFORM 9100-SQL-ABEND                                   04430000
044400     END-IF.                                                      04440000
044500                                                                  04450000
044600                                                                  04460000
044700******************************************************************04470000
044800* CLOSE THE RESET PROMPT CURSOR WHEN ALL SKU/LOCATIONS NEEDING    04480000
044900* TO BE RESET HAVE BEEN PROCESSED.                                04490000
045000******************************************************************04500000
045100 6200-CLOSE-RESET-PROMPT-CSR.                                     04510000
045200                                                                  04520000
045300     MOVE '6200-CLOSE-RESET-PROMPT-CSR' TO PV-PARAGRAPH-NAME.     04530000
045400                                                                  04540000
045500     PERFORM                                                      04550000
045600         WITH TEST AFTER                                          04560000
045700         VARYING PV-SQL-SUB                                       04570000
045800         FROM 1 BY 1                                              04580000
045900         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 04590000
040300                   OR  SQLCODE = -904                             04591004
040300                   OR  SQLCODE = -911                             04592004
040300                   OR  SQLCODE = -913                             04593004
046000                   OR  SQLCODE = 0)                               04600000
046100                                                                  04610000
046200           EXEC SQL                                               04620000
046300              CLOSE RESET-PROMPT-CSR                              04630000
046400           END-EXEC                                               04640000
046500                                                                  04650000
046600          EVALUATE TRUE                                           04660000
046700             WHEN SQLCODE = -904                                  04670000
046800             WHEN SQLCODE = -911                                  04680000
046900             WHEN SQLCODE = -913                                  04690000
047000             WHEN SQLCODE = 0                                     04700000
047100                  CONTINUE                                        04710000
047200                                                                  04720000
047300             WHEN SQLWARN0 NOT EQUAL SPACE                        04730000
047400             WHEN SQLCODE NOT EQUAL ZERO                          04740000
047500                  MOVE 'ERROR ON CLOSE OF RESET PROMPT CURSOR'    04750000
047600                                      TO PV-DB2-OPERATION-MSG     04760000
047700                                                                  04770000
047800                  SET ABEND-4006-CLOSE-ERROR TO TRUE              04780000
047900                  PERFORM 9100-SQL-ABEND                          04790000
048000          END-EVALUATE                                            04800000
048100     END-PERFORM.                                                 04810000
048200                                                                  04820000
048300     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        04830000
048400         MOVE 'CLOSE RETRIES EXCEEDED'                            04840000
048500                               TO  PV-DB2-OPERATION-MSG           04850000
048600                                                                  04860000
048700         SET ABEND-4006-CLOSE-ERROR TO TRUE                       04870000
048800         PERFORM 9100-SQL-ABEND                                   04880000
048900     END-IF.                                                      04890000
049000                                                                  04900000
049100                                                                  04910000
049200******************************************************************04920000
049300* ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                      04930000
049400******************************************************************04940000
049500 9000-ABEND.                                                      04950000
049600                                                                  04960000
049700     PERFORM 9900-END-OF-JOB-ROUTINE.                             04970000
049800                                                                  04980000
049900     DISPLAY '** ABEND           **'.                             04990000
050000     DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              05000000
050100     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05010000
050200     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05020000
050300     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05030000
050400                                                                  05040000
050500     CALL 'ILBOABN0' USING ABEND-CODE.                            05050000
050600                                                                  05060000
050700                                                                  05070000
050800******************************************************************05080000
050900* ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.    05090000
051000******************************************************************05100000
051100 9100-SQL-ABEND.                                                  05110000
051200                                                                  05120000
051300     PERFORM 9900-END-OF-JOB-ROUTINE.                             05130000
051400                                                                  05140000
051500     DISPLAY '** ABEND     **'.                                   05150000
051600     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    05160000
051700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05170000
051800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-MSG.           05180000
051900     DISPLAY '** SQLCODE   ** = ' SQLCODE.                        05190000
052000                                                                  05200000
052100******************************************************************05210000
052200* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     05220000
052300* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      05230000
052400******************************************************************05240000
052500     COPY DPPD004.                                                05250000
052600                                                                  05260000
052700     CALL 'ILBOABN0' USING ABEND-CODE.                            05270000
052800                                                                  05280000
052900                                                                  05290000
053000******************************************************************05300000
053100* PREFORMS TASK TERMINATION PROCESSING                            05310000
053200******************************************************************05320000
053300 9900-END-OF-JOB-ROUTINE.                                         05330000
053400                                                                  05340000
053500     CLOSE XST-FILE.                                              05350000
053600                                                                  05360000
053700     PERFORM 9999-CONTROLS.                                       05370000
053800                                                                  05380000
053900                                                                  05390000
054000******************************************************************05400000
054100* DISPLAY CONTROLS FROM THE PROGRAM                               05410000
054200******************************************************************05420000
054300 9999-CONTROLS.                                                   05430000
054400                                                                  05440000
054500     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 05450000
054600                                                                  05460000
054700     MOVE SYS-TIME (1:2) TO ST-END-HR.                            05470000
054800     MOVE SYS-TIME (3:2) TO ST-END-MN.                            05480000
054900                                                                  05490000
055000     DISPLAY '                    '.                              05500000
055100     DISPLAY '**********************'.                            05510000
055200     DISPLAY '   EPKUT023 CONTROLS  '.                            05520000
055300     DISPLAY '**********************'.                            05530000
055400     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         05540000
055500     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          05550000
055600     DISPLAY 'END TIME  = ' ST-END-TIME.                          05560000
055700     DISPLAY '======================'.                            05570000
055800     DISPLAY 'CNTL CARD PREV TIMESTAMP    = '                     05580000
055900                              CC-EPCC105-PREV-TIMESTAMP.          05590000
056000     DISPLAY 'CNTL CARD CURRENT TIMESTAMP = '                     05600000
056100                              CC-EPCC105-CRNT-TIMESTAMP.          05610000
056200     DISPLAY '                  '.                                05620000
056300     DISPLAY 'RECS FETCHED = ' PA-FETCHED.                        05630000
056400     DISPLAY '                  '.                                05640000
056500     DISPLAY 'RECS WRITTEN = ' PA-WRITTEN.                        05650000
056600     DISPLAY '                  '.                                05660000
056700                                                                  05670000
056800                                                                  05680000
