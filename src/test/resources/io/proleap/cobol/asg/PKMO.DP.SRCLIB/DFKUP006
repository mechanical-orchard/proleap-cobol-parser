000200 IDENTIFICATION DIVISION.                                         00010000
000500 PROGRAM-ID.             DFKUP006.                                00020004
000600 AUTHOR.                 DEANNA BRANTNER.                         00030000
000700 INSTALLATION.           KOHLS.                                   00040000
000800 DATE-WRITTEN            JUNE 30, 2008.                           00050000
000900 DATE-COMPILED.                                                   00060000
001000                                                                  00070000
001100******************************************************************00080000
001200*  THIS PROGRAM LOADS SALES DATA FROM DFT_ML_FINCL_SUM TO         00090006
001200*  DFT_ML_FINCL_SUMH ONCE A MONTH.                                00100000
001300*  DUE TO THE LARGE AMOUNT OF DATA BEING LOADED, THE UNIT OF WORK 00110000
001600*  WILL BE DAILY BECAUSE THERE IS A LIMIT IN DB2 OF THE NUMBER    00120000
001700*  OF ROWS YOU CAN MODIFY AT ONE TIME. DOING A COMMIT AFTER       00130000
001700*  EACH DAY SHOULD ALSO ELIMINATE THE POSSIBILITY OF A LOCK       00140000
001700*  ESCALLATION.                                                   00150000
001800*                                                                 00160000
002200***************************************************************** 00170000
COMMIT* 06/20/2022    JIM HUNTER      CHG0271378                        00171009
COMMIT* ADDING LOGIC TO PERFORM A COMMIT EVERY 2 SECONDS.               00171108
COMMIT* EXISITNG LOGIC TO COMMIT ON A CHANGE IN SALES DATE RESULTS IN   00171208
COMMIT* OVER 100,000 ROWS BEING INSERTED TO SUMH BETWEEN COMMITS.       00171309
COMMIT* FIND 'COMMIT' IN COLS 1 - 6 TO SEE CHANGES.                     00171409
COMMIT***************************************************************** 00172008
003300 ENVIRONMENT DIVISION.                                            00180000
003700 CONFIGURATION SECTION.                                           00190000
003900 SOURCE-COMPUTER.        IBM-3090.                                00200000
004000 OBJECT-COMPUTER.        IBM-3090.                                00210000
004100                                                                  00220000
004200 INPUT-OUTPUT SECTION.                                            00230000
004400 FILE-CONTROL.                                                    00240000
005700 DATA DIVISION.                                                   00250000
006000 FILE SECTION.                                                    00260000
006100                                                                  00270000
008500******************************************************************00280000
008600 WORKING-STORAGE SECTION.                                         00290000
008700******************************************************************00300000
008800 01  FILLER                            PIC X(50)  VALUE           00310000
008900     ' *** WORKING STORAGE STARTS HERE FOR DFKUP006 *** '.        00320004
009000                                                                  00330000
012100 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00340000
012200                                                  COMP SYNC.      00350000
012400     88  AC-DB2-ERROR                             VALUE +4013.    00360000
012500                                                                  00370000
012600 01  PS-PROGRAM-SWITCHES.                                         00380000
013000     05  PS-END-OF-SALE-CSR-SW         PIC X(01)  VALUE 'N'.      00390001
013100         88  PS-END-OF-SALE-CSR                   VALUE 'Y'.      00400001
013200         88  PS-NOT-END-OF-SALE-CSR               VALUE 'N'.      00410001
013800                                                                  00420000
013900 01  PC-CONSTANTS.                                                00430000
014200     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00440000
014300                                                   'DFKUP006'.    00450004
014400 01  PV-MISC-FIELDS.                                              00460000
014500     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   00470000
014600     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   00480000
014700     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   00490000
014800     05  PV-DB2-OPERATION            PIC  X(40)    VALUE SPACE.   00500000
014800     05  PV-DATE-HOLD                PIC  X(10)    VALUE SPACE.   00501001
COMMIT     05  PV-COMMIT-COUNT             PIC  9(9)     VALUE ZEROES.  00502007
COMMIT     05  PV-INSERTS-TO-SUMH          PIC  9(9)     VALUE ZEROES.  00502107
COMMIT     05  PV-COMMIT-TIMESTAMP         PIC X(26)     VALUE SPACES.  00502207
COMMIT     05  PV-CURRENT-TIMESTAMP        PIC X(26)     VALUE SPACES.  00502307
015600                                                                  00510000
015700******************************************************************00520000
015800*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            00530000
015900******************************************************************00540000
016000     COPY DPWS004.                                                00550000
016200******************************************************************00560000
016300*  DB2 COMMUNICATION AREA.                                        00570000
016400******************************************************************00580000
016500     EXEC SQL                                                     00590000
016600          INCLUDE SQLCA                                           00600000
016700     END-EXEC.                                                    00610000
016800******************************************************************00620000
016900*  DB2 TABLE DATE ATTRIBUTE                                       00630000
017000******************************************************************00640000
017100     EXEC SQL                                                     00650000
017200          INCLUDE TDTATTR                                         00660000
017300     END-EXEC.                                                    00670000
017400******************************************************************00680000
017500*  DB2 TABLE DFT_ML_FINCL_SUM                                     00690000
017600******************************************************************00700000
017700     EXEC SQL                                                     00710000
017800          INCLUDE DFT00002                                        00720000
017900     END-EXEC.                                                    00730000
017400******************************************************************00740000
017500*  DB2 TABLE DFT_ML_FINCL_SUMH                                    00750000
017600******************************************************************00760000
017700     EXEC SQL                                                     00770000
017800          INCLUDE DFT00009                                        00780000
017900     END-EXEC.                                                    00790000
                                                                        00791001
022200******************************************************************00800000
022300*  CURSOR TO RETRIEVE SALES FROM PREVIOUS FISCAL MONTH            00810001
022400******************************************************************00820000
022500     EXEC SQL                                                     00830000
022600        DECLARE SALE-CSR CURSOR WITH HOLD FOR                     00840001
066872           SELECT SLS_DTE,                                        00850001
066873                  STR_NBR,                                        00860001
066874                  DEPT_NBR,                                       00870001
066875                  DLY_DOL_AMT,                                    00880001
066876                  WTD_DOL_AMT,                                    00890001
066877                  MTD_DOL_AMT,                                    00900001
066878                  QTD_DOL_AMT,                                    00910001
066879                  S_T_D_DOL_AMT,                                  00920001
066880                  YTD_DOL_AMT                                     00930001
066892              FROM DFT_ML_FINCL_SUM                               00940008
066895         WHERE SLS_DTE BETWEEN :DTATTR-FSCL-MN-BEG-DTE            00950001
                 AND                 :DTATTR-FSCL-MN-END-DTE            00960001
066899       WITH UR                                                    00970001
066900     END-EXEC.                                                    00980001
066901                                                                  00990001
028500***************************************************************** 01000000
028800 PROCEDURE DIVISION.                                              01010000
029000******************************************************************01020000
029400 0000-MAINLINE.                                                   01030000
029500                                                                  01040000
029600     PERFORM 1000-INITIALIZE.                                     01050000
029700                                                                  01060000
029800     PERFORM 2000-PROCESS-SALE-CSR                                01070001
029900              UNTIL PS-END-OF-SALE-CSR.                           01080001
030000                                                                  01090000
030600     PERFORM 1700-CLOSE-SALE-CSR                                  01100001
030000                                                                  01110001
COMMIT     DISPLAY 'COMMITS TAKEN   = '  PV-COMMIT-COUNT                01111007
COMMIT     DISPLAY 'INSERTS TO SUMH = '  PV-INSERTS-TO-SUMH             01111107
030000                                                                  01112007
030800     STOP RUN.                                                    01120000
030900                                                                  01130000
031000******************************************************************01140000
031200*  RETRIEVE PREVIOUS FISCAL MONTH END DATE AND OPEN THE CURSOR.   01150000
031400******************************************************************01160000
031500 1000-INITIALIZE.                                                 01170000
031600                                                                  01180000
032100     PERFORM 1100-SELECT-PFM-DATE.                                01190001
032100     PERFORM 1200-SELECT-PFM-BEG-DATE.                            01200001
COMMIT     PERFORM 1400-GET-COMMIT-TIMESTAMP.                           01201007
032200     PERFORM 1500-OPEN-SALE-CSR.                                  01210001
032300                                                                  01220000
032400******************************************************************01231000
032600*   SELECT THE PFM_END_DTE FROM TDTATTR WHICH WILL BE USED        01240000
032700*   TO RETRIEVE FISCAL MONTH BEGIN DATE.                          01250001
032800******************************************************************01260000
032900 1100-SELECT-PFM-DATE.                                            01270001
033000                                                                  01280000
036900     EXEC SQL                                                     01290000
037000         SELECT PFM_END_DTE                                       01300000
037200           INTO :DTATTR-PFM-END-DTE                               01310000
037400           FROM TDTATTR                                           01320008
037500          WHERE KY_DTE = CURRENT DATE - 4 YEARS                   01330000
037600           WITH UR                                                01340000
037700     END-EXEC.                                                    01350000
037800                                                                  01360000
037900     EVALUATE TRUE                                                01370000
038000         WHEN SQLCODE = 0                                         01380000
038100             CONTINUE                                             01390000
038200         WHEN OTHER                                               01400000
038300             MOVE '1100-SELECT-PFM-DATE'      TO PV-PARAGRAPH-NAME01410001
038500             MOVE 'ERROR IN RETRIEVING DATE ' TO PV-DB2-OPERATION 01420000
038700             PERFORM 9100-SQL-ABEND                               01430000
038800     END-EVALUATE.                                                01440000
038900                                                                  01450000
034200     DISPLAY 'TDTATTR'                                            01460001
034300             ' - PFM-END-DTE  = ' DTATTR-PFM-END-DTE.             01470000
034400                                                                  01480000
032400******************************************************************01490001
032600*   SELECT THE FISCAL MONTH BEGIN AND END DATES WHICH WILL BE     01500001
032700*   USED IN THE CURSOR.                                           01510001
032800******************************************************************01520001
       1200-SELECT-PFM-BEG-DATE.                                        01530001
033000                                                                  01540001
036900     EXEC SQL                                                     01550001
037000         SELECT DISTINCT(FSCL_MN_BEG_DTE)                         01560002
037000              , FSCL_MN_END_DTE                                   01570001
037200           INTO :DTATTR-FSCL-MN-BEG-DTE                           01580001
037200              , :DTATTR-FSCL-MN-END-DTE                           01590001
037400           FROM TDTATTR                                           01600008
037500          WHERE FSCL_MN_END_DTE = :DTATTR-PFM-END-DTE             01610001
037600           WITH UR                                                01620001
037700     END-EXEC.                                                    01630001
037800                                                                  01640001
037900     EVALUATE TRUE                                                01650001
038000         WHEN SQLCODE = 0                                         01660001
038100             CONTINUE                                             01670001
038200         WHEN OTHER                                               01680001
038300             MOVE '1200-SELECT-PFM-BEG-DATE ' TO PV-PARAGRAPH-NAME01690001
038500             MOVE 'ERROR IN RETRIEVING DATE ' TO PV-DB2-OPERATION 01700001
038700             PERFORM 9100-SQL-ABEND                               01710001
038800     END-EVALUATE.                                                01720001
038900                                                                  01730001
034200     DISPLAY 'DFT_ML_FINCL_SUM'                                   01740001
037200             ' MONTH-BEGIN = '  DTATTR-FSCL-MN-BEG-DTE            01750001
037200             ' MONTH-END   = '  DTATTR-FSCL-MN-END-DTE.           01760001
034400                                                                  01770001
COMMIT******************************************************************01771007
COMMIT*  GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT CONTROL TABLE     01772007
COMMIT******************************************************************01773007
COMMIT 1300-GET-CURRENT-TIMESTAMP.                                      01774007
COMMIT                                                                  01775007
COMMIT     EXEC SQL                                                     01776007
COMMIT       SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP              01777007
COMMIT     END-EXEC.                                                    01778007
COMMIT                                                                  01779007
COMMIT     IF SQLCODE = 0                                               01779107
COMMIT         CONTINUE                                                 01779207
COMMIT     ELSE                                                         01779307
COMMIT         MOVE '1300-GET-CURRENT-TIMESTAMP '  TO PV-PARAGRAPH-NAME 01779407
COMMIT         MOVE 'ERROR ON SELECT OF TIMESTAMP ' TO PV-DB2-OPERATION 01779507
COMMIT         PERFORM 9100-SQL-ABEND                                   01779607
COMMIT     END-IF.                                                      01779707
COMMIT                                                                  01779807
COMMIT******************************************************************01780007
COMMIT*  GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT CONTROL TABLE     01780107
COMMIT******************************************************************01780207
COMMIT 1400-GET-COMMIT-TIMESTAMP.                                       01780307
COMMIT                                                                  01780407
COMMIT     EXEC SQL                                                     01780507
COMMIT       SET :PV-COMMIT-TIMESTAMP = CURRENT TIMESTAMP + 2 SECONDS   01780608
COMMIT     END-EXEC.                                                    01780707
COMMIT                                                                  01780807
COMMIT     IF SQLCODE = 0                                               01780907
COMMIT         CONTINUE                                                 01781007
COMMIT     ELSE                                                         01781207
COMMIT         MOVE '1400-GET-COMMIT-TIMESTAMP '   TO PV-PARAGRAPH-NAME 01781307
COMMIT         MOVE 'ERROR ON SELECT OF TIMESTAMP ' TO PV-DB2-OPERATION 01781407
COMMIT         PERFORM 9100-SQL-ABEND                                   01781507
COMMIT     END-IF.                                                      01781607
COMMIT                                                                  01781707
055500******************************************************************01782007
055600*      OPEN DATE CURSOR                                           01790000
055700******************************************************************01800000
055800 1500-OPEN-SALE-CSR.                                              01810001
055900                                                                  01820000
056000     EXEC SQL                                                     01830000
056100          OPEN SALE-CSR                                           01840001
056200     END-EXEC.                                                    01850000
056300                                                                  01860000
056400     EVALUATE TRUE                                                01870000
056500         WHEN SQLCODE = ZERO                                      01880000
056600              CONTINUE                                            01890000
056700         WHEN SQLWARN0 NOT EQUAL SPACE                            01900000
056800         WHEN SQLCODE NOT EQUAL ZERO                              01910000
056900             MOVE '1500-OPEN-SALE-CSR'        TO PV-PARAGRAPH-NAME01920001
057100             MOVE 'ERROR ON OPEN OF SALE-CSR' TO PV-DB2-OPERATION 01930001
057300             PERFORM 9100-SQL-ABEND                               01940000
057400     END-EVALUATE.                                                01950000
057500                                                                  01960000
057600******************************************************************01970000
057700* FETCH DATE CURSOR                                               01980000
057800******************************************************************01990000
057900 1600-FETCH-SALE-CSR.                                             02000001
058000                                                                  02010000
058100     EXEC SQL                                                     02020000
058200        FETCH SALE-CSR                                            02030001
066882          INTO   :DFT00002-SLS-DTE,                               02040001
066883                 :DFT00002-STR-NBR,                               02050001
066884                 :DFT00002-DEPT-NBR,                              02060001
066885                 :DFT00002-DLY-DOL-AMT,                           02070001
066886                 :DFT00002-WTD-DOL-AMT,                           02080001
066887                 :DFT00002-MTD-DOL-AMT,                           02090001
066888                 :DFT00002-QTD-DOL-AMT,                           02100001
066889                 :DFT00002-S-T-D-DOL-AMT,                         02110001
066890                 :DFT00002-YTD-DOL-AMT                            02120001
059400     END-EXEC.                                                    02130001
059500                                                                  02140000
059600     EVALUATE TRUE                                                02150000
059700         WHEN SQLCODE = ZERO                                      02160000
059800             CONTINUE                                             02170000
059900         WHEN SQLCODE = +100                                      02180000
060000             SET PS-END-OF-SALE-CSR TO TRUE                       02190001
060100         WHEN SQLWARN0 NOT EQUAL SPACE                            02200000
060200         WHEN SQLCODE NOT EQUAL ZERO                              02210000
060300             MOVE '1600-FETCH-SALE-CSR' TO PV-PARAGRAPH-NAME      02220001
060500             MOVE 'ERROR ON FETCH OF SALE-CSR' TO PV-DB2-OPERATION02230001
060700             PERFORM 9100-SQL-ABEND                               02240000
060800     END-EVALUATE.                                                02250000
038900                                                                  02260000
061000******************************************************************02300000
061100* CLOSE DATE CURSOR                                               02310000
061200******************************************************************02320000
061300 1700-CLOSE-SALE-CSR.                                             02330001
061400                                                                  02340000
061500     EXEC SQL                                                     02350000
061600          CLOSE SALE-CSR                                          02360001
061700     END-EXEC.                                                    02370000
061800                                                                  02380000
061900     EVALUATE TRUE                                                02390000
062000         WHEN SQLCODE = ZERO                                      02400000
062100              CONTINUE                                            02410000
062200         WHEN SQLWARN0 NOT EQUAL SPACE                            02420000
062300         WHEN SQLCODE NOT EQUAL ZERO                              02430000
062400             MOVE '1700-CLOSE-SALE-CSR'       TO PV-PARAGRAPH-NAME02440001
062600             MOVE 'ERROR ON CLOSE OF SALE-CSR' TO PV-DB2-OPERATION02450001
062800             PERFORM 9100-SQL-ABEND                               02460000
062900     END-EVALUATE.                                                02470000
063000                                                                  02480000
042000******************************************************************02490000
042200*     LOAD A DAY'S WORTH OF DATA AND COMMIT.                      02500000
042300******************************************************************02510000
042400 2000-PROCESS-SALE-CSR.                                           02520001
042500                                                                  02530000
043000     PERFORM 1600-FETCH-SALE-CSR.                                 02540001
042800     IF SQLCODE = 0                                               02540201
042600         PERFORM 3000-LOAD-DAYS-DATA                              02540303
042800**       IF DFT00002-SLS-DTE = PV-DATE-HOLD                       02541007
      **           CONTINUE                                             02542007
042800**       ELSE                                                     02543007
COMMIT         PERFORM 1300-GET-CURRENT-TIMESTAMP                       02543107
COMMIT         IF  PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP           02544007
                   PERFORM 8000-COMMIT                                  02544101
                   MOVE DFT00002-SLS-DTE  TO  PV-DATE-HOLD              02544201
COMMIT             DISPLAY  'COMMITTING FOR ' PV-CURRENT-TIMESTAMP      02544307
COMMIT             ADD +1   TO PV-COMMIT-COUNT                          02544407
COMMIT             PERFORM 1400-GET-COMMIT-TIMESTAMP                    02544607
042800         END-IF                                                   02545001
042800     END-IF.                                                      02580000
030700                                                                  02590000
153600******************************************************************02600000
153700*  LOAD DAILY SALES DATA                                          02610000
153800******************************************************************02620000
153900 3000-LOAD-DAYS-DATA.                                             02630001
154000                                                                  02640000
103209     EXEC SQL                                                     02650000
103210       INSERT INTO DFT_ML_FINCL_SUMH                              02660008
103211         VALUES                                                   02670000
103212           (:DFT00002-SLS-DTE                                     02680000
103213           ,:DFT00002-STR-NBR                                     02690000
103214           ,:DFT00002-DEPT-NBR                                    02700000
103215           ,:DFT00002-DLY-DOL-AMT                                 02710000
103216           ,:DFT00002-WTD-DOL-AMT                                 02720000
103217           ,:DFT00002-MTD-DOL-AMT                                 02730000
103218           ,:DFT00002-QTD-DOL-AMT                                 02740000
103219           ,:DFT00002-S-T-D-DOL-AMT                               02750000
103220           ,:DFT00002-YTD-DOL-AMT)                                02760000
103221     END-EXEC.                                                    02770000
155300                                                                  02780000
155400     EVALUATE TRUE                                                02790000
155500         WHEN SQLCODE = 0                                         02800000
COMMIT             ADD +1 TO PV-INSERTS-TO-SUMH                         02800107
155500         WHEN SQLCODE = -803                                      02801005
155600             CONTINUE                                             02810000
156000         WHEN OTHER                                               02820000
103227             DISPLAY 'SLS DATE= ' DFT00002-SLS-DTE                02821001
103228             DISPLAY 'STR NBR = ' DFT00002-STR-NBR                02822001
103229             DISPLAY 'DEPT NBR= ' DFT00002-DEPT-NBR               02823001
103230             DISPLAY 'DLY AMT=  ' DFT00002-DLY-DOL-AMT            02824001
103231             DISPLAY 'WTD AMT=  ' DFT00002-WTD-DOL-AMT            02825001
103232             DISPLAY 'MTD AMT=  ' DFT00002-MTD-DOL-AMT            02826001
103233             DISPLAY 'QTD AMT=  ' DFT00002-QTD-DOL-AMT            02827001
103234             DISPLAY 'STD AMT=  ' DFT00002-S-T-D-DOL-AMT          02828001
103235             DISPLAY 'YTD AMT= '  DFT00002-YTD-DOL-AMT            02829001
156100             MOVE '3000-LOAD-DAYS-DATA'       TO PV-PARAGRAPH-NAME02830001
156300             MOVE 'ERROR LOADING SALES DATA ' TO PV-DB2-OPERATION 02840001
156600             PERFORM 9100-SQL-ABEND                               02850000
156700     END-EVALUATE.                                                02860000
156800                                                                  02870000
153600******************************************************************02880000
153700* COMMIT UNIT OF WORK                                             02890000
153800******************************************************************02900000
       8000-COMMIT.                                                     02910000
154000                                                                  02920000
109640     EXEC SQL                                                     02930000
109650        COMMIT                                                    02940000
109660     END-EXEC.                                                    02950000
109670                                                                  02960000
109680     EVALUATE TRUE                                                02970000
109690        WHEN SQLCODE = 0                                          02980000
                 CONTINUE                                               02990000
109692        WHEN OTHER                                                03000000
156100             MOVE '8000-COMMIT'           TO PV-PARAGRAPH-NAME    03010000
156300             MOVE 'ERROR DELETING SALES'  TO PV-DB2-OPERATION     03020000
156600             PERFORM 9100-SQL-ABEND                               03030000
109701     END-EVALUATE.                                                03040000
109702                                                                  03050000
078700******************************************************************03060000
078800* 9100-SQL-ABEND                                                  03070000
078900*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.03080000
079000******************************************************************03090000
079100 9100-SQL-ABEND.                                                  03100000
079200     DISPLAY '** ABEND        **'.                                03110000
079300     DISPLAY '** PROGRAM      ** = ' PC-CURRENT-PROGRAM-NAME.     03120000
079400     DISPLAY '** PARAGRAPH    ** = ' PV-PARAGRAPH-NAME.           03130000
079500     DISPLAY '** OPERATION    ** = ' PV-DB2-OPERATION.            03140000
079600                                                                  03150000
079700******************************************************************03160000
079800* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     03170000
079900* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      03180000
080000******************************************************************03190000
080100     COPY DPPD004.                                                03200000
080200                                                                  03210000
080300     SET AC-DB2-ERROR TO TRUE.                                    03220000
080400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         03230000
080500                                                                  03240000
