000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.   DLKUP012.                                          00020000
000300 AUTHOR.       MIKE MACHNIK.                                      00030000
000400 INSTALLATION. KOHLS DEPARTMENT STORES.                           00040000
000500 DATE-WRITTEN. SEPTEMBER 2006.                                    00050000
000600 DATE-COMPILED.                                                   00060000
000700******************************************************************00070000
000800*             SHIPPING ASSIGNMENT THRESHOLD UPDATE                00080000
000900*                                                                 00090000
001000* THIS PROGRAM WILL USE THE EXTRACT FILE CREATED IN DLKUT023 AS   00100000
001100* INPUT TO UPDATE THE CORRESPONDING ROW IN DLT_ASGMT WITH THE     00110000
001200* VALUE OF 'SHIP1', 'SHIP2' OR 'SHIP3' IN COLUMN WK_TYP_DESC      00120000
001300* DEPENDING ON THRESHOLD VALUES IN TKRPRPM.                       00130000
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600******************************************************************00160000
001700 CONFIGURATION SECTION.                                           00170000
001800 SOURCE-COMPUTER.        IBM-3090.                                00180000
001900 OBJECT-COMPUTER.        IBM-3090.                                00190000
002000******************************************************************00200000
002100 INPUT-OUTPUT SECTION.                                            00210000
002200 FILE-CONTROL.                                                    00220000
002300                                                                  00230000
002400     SELECT SHIP-ASSIGN-EXTRACT-FILE ASSIGN TO INP01.             00240000
002500                                                                  00250000
002600 DATA DIVISION.                                                   00260000
002700 FILE SECTION.                                                    00270000
002800 FD  SHIP-ASSIGN-EXTRACT-FILE                                     00280000
002900     RECORDING MODE IS F                                          00290000
003000     LABEL RECORDS ARE STANDARD                                   00300000
003100     BLOCK CONTAINS 0 RECORDS.                                    00310000
003200                                                                  00320000
003300 01  SHIP-ASSIGN-EXTRACT-REC       PIC X(29).                     00330000
003400                                                                  00340000
003500 WORKING-STORAGE SECTION.                                         00350000
003600                                                                  00360000
003700                                                                  00370000
003800 01  PS-PROGRAM-SWITCHES.                                         00380000
003900     05  PS-END-OF-EXTRACT-SW        PIC X(01) VALUE 'N'.         00390000
004000         88  PS-END-OF-EXTRACT-YES             VALUE 'Y'.         00400000
004100         88  PS-END-OF-EXTRACT-NO              VALUE 'N'.         00410000
004200     05  PS-END-OF-CARTON-CSR-SW       PIC  X(01)    VALUE 'N'.   00420000
004300         88  PS-END-OF-CARTON-CSR-YES                VALUE 'Y'.   00430000
004400         88  PS-END-OF-CARTON-CSR-NO                 VALUE 'N'.   00440000
004500     05  PS-END-OF-DOOR-CSR-SW       PIC  X(01)      VALUE 'N'.   00450000
004600         88  PS-END-OF-DOOR-CSR-YES                  VALUE 'Y'.   00460000
004700         88  PS-END-OF-DOOR-CSR-NO                   VALUE 'N'.   00470000
004800     05  PS-CARTONS-SW               PIC  X(01)      VALUE 'N'.   00480000
004900         88  PS-CARTONS-FOUND                        VALUE 'Y'.   00490000
005000         88  PS-CARTONS-NOT-FOUND                    VALUE 'N'.   00500000
005100     05  PS-LAST-SEQ-SW              PIC  X(01)      VALUE 'N'.   00510000
005200         88  PS-LAST-SEQ-NBR-0                       VALUE 'Y'.   00520000
005300         88  PS-LAST-SEQ-NBR-NOT-0                   VALUE 'N'.   00530000
005400     05  PS-RUN-TYPE-SW                PIC  X(01)    VALUE ' '.   00540000
005500         88  PS-NORMAL-RUN                           VALUE '0'.   00550000
005600         88  PS-RESTART-RUN                          VALUE '9'.   00560000
005700                                                                  00570000
005800 01  PC-PROGRAM-CONSTANTS.                                        00580000
005900     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'DLKUP012'.  00590000
006000     05  PC-PGM-NAME                 PIC X(08) VALUE 'DLKUP012'.  00600000
006100     05  PC-JOB-NAME                 PIC X(08) VALUE SPACES.      00610000
006200                                                                  00620000
006300 01  PA-TOTALS.                                                   00630000
006400     05  PA-ASGMT-UPDATE-COUNT       PIC  9(9) VALUE 0.           00640000
006500     05  PA-COMMIT-COUNT             PIC  9(9) VALUE 0.           00650000
006600     05  PA-INPUT-COUNT              PIC  9(9) VALUE 0.           00660000
006700                                                                  00670000
006800 01  ABEND-CODE                      PIC S9(4) VALUE +0           00680000
006900                                               COMP SYNC.         00690000
007000                                                                  00700000
007100 01  PV-PROGRAM-VARIABLES.                                        00710000
007200     05  PV-THRESHOLD-LOW            PIC X(04) VALUE ZEROES.      00720000
007300     05  PV-THRESHOLD-ONE REDEFINES PV-THRESHOLD-LOW              00730000
007400                                     PIC 9(04).                   00740000
007500     05  PV-THRESHOLD-HI             PIC X(04) VALUE ZEROES.      00750000
007600     05  PV-THRESHOLD-TWO REDEFINES PV-THRESHOLD-HI               00760000
007700                                     PIC 9(04).                   00770000
007800     05  PV-AVG-DIVERT               PIC 9(7) COMP.               00780000
007900     05  PV-DOOR-COUNT               PIC 9(7) COMP.               00790000
008000     05  PV-CARTON-COUNT             PIC 9(7) COMP.               00800000
008100     05  PV-DOOR-GP-NBR              PIC S9(4) COMP.              00810000
008200     05  PV-DOOR-GP-X                PIC X(4)  VALUE ZEROES.      00820000
008300     05  PV-DOOR-GP-9 REDEFINES PV-DOOR-GP-X                      00830000
008400                                     PIC 9(4).                    00840000
008500     05  PV-LOC-CORP                 PIC S9(04) VALUE 90 COMP.    00850000
008600     05  PV-ASGMT-START-TMST         PIC X(26) VALUE SPACES.      00860000
008700     05  PV-PARAGRAPH                PIC X(48) VALUE SPACES.      00870000
008800     05  PV-HOLD-COMPLETION-CODE     PIC S9(9) BINARY.            00880000
008900     05  PV-HOLD-REASON              PIC S9(9) BINARY.            00890000
009000     05  PV-MSG-LENGTH               PIC S9(9) BINARY.            00900000
009100     05  SUB1                        PIC 9(7) VALUE 0.            00910000
009200     05  PV-DISPLAY-RECORD           PIC ZZZ,ZZ9.                 00920000
009300     05  PV-CURRENT-TMST             PIC X(26) VALUE SPACE.       00930000
009400     05  PV-RESTART-COUNT            PIC 9(09) VALUE 0.           00940000
009500     05  PC-MAX-RETRIES              PIC S9(03) VALUE 3 COMP-3.   00950000
009600     05  PC-RUN-IN-PROGRESS-CODE     PIC X(01)  VALUE '9'.        00960000
009700     05  PC-RUN-COMPLETE-CODE        PIC X(01)  VALUE '0'.        00970000
009800     05  PV-CKPT-STAT-CODE           PIC X(01)  VALUE SPACES.     00980000
009900                                                                  00990000
010000     05  PV-NUMERIC-SEVEN            PIC 9(07).                   01000000
010100     05  PV-DC-NBR                   PIC S9(4) COMP.              01010000
010200                                                                  01020000
010300 01  CC-CONTROL-CARD.                                             01030000
010400     05  CC-DC-NBR                    PIC X(04)  VALUE ZEROS.     01040000
010500     05  PV-CC-DC-NBR  REDEFINES CC-DC-NBR                        01050000
010600                                      PIC 9(4).                   01060000
010700     05  FILLER                       PIC X(5).                   01070000
010800     05  CC-JOB-NAME                  PIC X(6).                   01080000
010900     05  FILLER                       PIC X(65).                  01090000
011000                                                                  01100000
011100 01  PV-ABEND-VARIABLES.                                          01110000
011200     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP      01120000
011300                                                        SYNC.     01130000
011400     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP.     01140000
011500     05  PV-SQLCODE                  PIC S9(9).                   01150000
011600     05  PV-DISPLAY-SQLCODE          PIC -------999.              01160000
011700     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'DLKUP012'.  01170000
011800     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      01180000
011900     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      01190000
012000     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01200000
012100     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01210000
012200                                                                  01220000
012300 01  CKPT-RESTART-INFO.                                           01230000
012400     05 CKPT-ASGMT-UPDATE-COUNT  PIC 9(09)  VALUE 0.              01240000
012500     05 CKPT-COMMIT-COUNT        PIC 9(09)  VALUE 0.              01250000
012600     05 CKPT-INPUT-COUNT         PIC 9(09)  VALUE 0.              01260000
012700                                                                  01270000
012800******************************************************************01280000
012900*    EXTRACT FILE LAYOUT                                          01290000
013000******************************************************************01300000
013100     COPY DLRD011.                                                01310000
013200                                                                  01320000
013300******************************************************************01330000
013400*  COMMUNICATIONS AREA FOR DB2                                    01340000
013500******************************************************************01350000
013600     EXEC SQL                                                     01360000
013700         INCLUDE SQLCA                                            01370000
013800     END-EXEC.                                                    01380000
013900                                                                  01390000
014000******************************************************************01400000
014100*  DB2 FORMATTED MESSAGE AREA                                     01410000
014200******************************************************************01420000
014300     COPY DPWS004.                                                01430000
014400                                                                  01440000
014500******************************************************************01450000
014600*  ASSIGNMENT TABLE                                               01460000
014700*  DLT_ASGMT - DLT00004                                           01470000
014800******************************************************************01480000
014900     EXEC SQL                                                     01490000
015000         INCLUDE DLT00004                                         01500000
015100     END-EXEC.                                                    01510000
015200                                                                  01520000
015300******************************************************************01530000
015400*  DOOR GROUP TABLE                                               01540000
015500*  DLT_DOOR_GP DLT00001                                           01550000
015600******************************************************************01560000
015700     EXEC SQL                                                     01570000
015800         INCLUDE DLT00001                                         01580000
015900     END-EXEC.                                                    01590000
016000                                                                  01600000
016100******************************************************************01610000
016200*  TSUCRDV                                                        01620000
016300******************************************************************01630000
016400     EXEC SQL                                                     01640000
016500         INCLUDE TSUCRDV                                          01650000
016600     END-EXEC.                                                    01660000
016700                                                                  01670000
016800******************************************************************01680000
016900*  PARM TABLE                                                     01690000
017000*  TKRPRPM                                                        01700000
017100******************************************************************01710000
017200     EXEC SQL                                                     01720000
017300         INCLUDE TKRPRPM                                          01730000
017400     END-EXEC.                                                    01740000
017500                                                                  01750000
017600******************************************************************01760000
017700*  DOOR_GP_TMPL TABLE                                             01770000
017800*  DLT_DOOR_GP_TMPL                                               01780000
017900******************************************************************01790000
018000     EXEC SQL                                                     01800000
018100         INCLUDE DLT00000                                         01810000
018200     END-EXEC.                                                    01820000
018300                                                                  01830000
018400******************************************************************01840000
018500*  DB2 TABLE DECLARATION - CHECKPOINT RESTART INFO TBL(TCKRSTINF) 01850000
018600*  THIS TABLE IS USED TO STORE WORKING STORAGE INFORMATION FOR    01860000
018700*  CHECKPOINT RESTARTS.                                           01870000
018800******************************************************************01880000
018900     EXEC SQL                                                     01890000
019000         INCLUDE TCKRSTIN                                         01900000
019100     END-EXEC.                                                    01910000
019200                                                                  01920000
019300******************************************************************01930000
019400*  DB2 TABLE DECLARATION - CHECKPOINT RESTART CONTROL (TCKRSTCNTL)01940000
019500*  THIS TABLE IS USED FOR CHECKPOINT RESTARTS.                    01950000
019600******************************************************************01960000
019700     EXEC SQL                                                     01970000
019800         INCLUDE TCKRSTCN                                         01980000
019900     END-EXEC.                                                    01990000
020000******************************************************************02000000
020100* COBOL CURSOR DECLARATION                                        02010000
020200******************************************************************02020000
020300     EXEC SQL                                                     02030000
020400       DECLARE DOOR_CSR CURSOR  WITH HOLD FOR                     02040000
020500        SELECT GP.DOOR_ID                                         02050000
020600          FROM DLT_DOOR_GP GP,                                    02060000
020700               DLT_DOOR_GP_TMPL TMPL                              02070000
020800         WHERE GP.DOOR_GP_NBR = :PV-DOOR-GP-NBR                   02080000
020900           AND TMPL.DC_NBR = :PV-DC-NBR                           02090000
021000           AND TMPL.ACTV_IND = 'Y'                                02100000
021100           AND GP.DOOR_GP_TMPL_ID = TMPL.DOOR_GP_TMPL_ID          02110000
021200         ORDER BY 1                                               02120000
021300     END-EXEC.                                                    02130000
021400                                                                  02140000
021500******************************************************************02150000
021600* COBOL CURSOR DECLARATION                                        02160000
021700******************************************************************02170000
021800     EXEC SQL                                                     02180000
021900       DECLARE CARTON_CSR CURSOR FOR                              02190000
022000        SELECT CAR.SHIPT_UNT_ID                                   02200000
022100          FROM TSUCRDV CAR                                        02210000
022200         WHERE CAR.OPER_UNT_ID = :PV-DC-NBR                       02220000
022300           AND CAR.DOOR_ID = :SUCRDV-DOOR-ID                      02230000
022400           AND CAR.ACTV_CDE  = 'A'                                02240000
022500           AND CAR.DIVERT_TMST > :PV-ASGMT-START-TMST             02250000
022600           AND CAR.DIVERT_TMST <= :DLT00004-ASGMT-STP-TMST        02260000
022700         ORDER BY 1                                               02270000
022800     END-EXEC.                                                    02280000
022900                                                                  02290000
023000 PROCEDURE DIVISION.                                              02300000
023100                                                                  02310000
023200 0000-PROGRAM-MAINLINE.                                           02320000
023300                                                                  02330000
023400     PERFORM 1000-INITIALIZE.                                     02340000
023500                                                                  02350000
023600     PERFORM 2000-PROCESS-EXTRACT                                 02360000
023700        UNTIL PS-END-OF-EXTRACT-YES.                              02370000
023800                                                                  02380000
023900     PERFORM 8500-EOJ-ROUTINE.                                    02390000
024000                                                                  02400000
024100*  SET CKPT LOGIC TO END OF RUN STATUS CODE ( 0 )                 02410000
024200                                                                  02420000
024300     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02430000
024400     PERFORM 9804-UPDATE-TCKRSTCNTL.                              02440000
024500                                                                  02450000
024600     STOP RUN.                                                    02460000
024700                                                                  02470000
024800******************************************************************02480000
024900*                I N I T I A L I Z A T I O N                     *02490000
025000******************************************************************02500000
025100 1000-INITIALIZE.                                                 02510000
025200                                                                  02520000
025300*ACCEPT CC DC NBR                                                 02530000
025400*    ACCEPT CC-DC-NBR.                                            02540000
025500     ACCEPT CC-CONTROL-CARD.                                      02550000
025600                                                                  02560000
025700     MOVE PV-CC-DC-NBR TO PV-DC-NBR.                              02570000
025800     MOVE CC-JOB-NAME  TO PC-JOB-NAME                             02580000
025900                                                                  02590000
026000     DISPLAY 'INPUT DC CONTROL CARD => ' PV-CC-DC-NBR             02600000
026100                                    '  ' CC-JOB-NAME.             02610000
026200*    EVALUATE PV-CC-DC-NBR                                        02620000
026300*       WHEN 865                                                  02630000
026400*          MOVE 'DLK001' TO PC-JOB-NAME                           02640000
026500*       WHEN 860                                                  02650000
026600*          MOVE 'DLK002' TO PC-JOB-NAME                           02660000
026700*       WHEN 855                                                  02670000
026800*          MOVE 'DLK003' TO PC-JOB-NAME                           02680000
026900*       WHEN 840                                                  02690000
027000*          MOVE 'DLK004' TO PC-JOB-NAME                           02700000
027100*       WHEN 830                                                  02710000
027200*          MOVE 'DLK005' TO PC-JOB-NAME                           02720000
027300*       WHEN 810                                                  02730000
027400*          MOVE 'DLK006' TO PC-JOB-NAME                           02740000
027500*       WHEN 85                                                   02750000
027600*          MOVE 'DLK007' TO PC-JOB-NAME                           02760000
027700*       WHEN 875                                                  02770000
027800*          MOVE 'DLK008' TO PC-JOB-NAME                           02780000
027900*       WHEN 885                                                  02790000
028000*          MOVE 'DLK009' TO PC-JOB-NAME                           02800000
028100*    END-EVALUATE.                                                02810000
028200                                                                  02820000
028300     MOVE 0 TO PA-ASGMT-UPDATE-COUNT                              02830000
028400               PA-COMMIT-COUNT.                                   02840000
028500                                                                  02850000
028600     OPEN INPUT SHIP-ASSIGN-EXTRACT-FILE.                         02860000
028700*                                                                 02870000
028800*DETERMINE RUN TYPE                                               02880000
028900     PERFORM 9800-GET-CHECKPOINT-CNTL.                            02890000
029000     MOVE PV-CKPT-STAT-CODE  TO  PS-RUN-TYPE-SW.                  02900000
029100                                                                  02910000
029200     IF PS-RESTART-RUN                                            02920000
029300         PERFORM 9802-CHECKPOINT-RESTART                          02930000
029400         MOVE 0 TO PV-RESTART-COUNT                               02940000
029500         DISPLAY '***** R E S T A R T I N G ****'                 02950000
029600         DISPLAY '***** R E S T A R T I N G ****'                 02960000
029700         DISPLAY '***** R E S T A R T I N G ****'                 02970000
029800         DISPLAY '***** R E S T A R T I N G ****'                 02980000
029900         DISPLAY '***** R E S T A R T I N G ****'                 02990000
030000         DISPLAY '***** R E S T A R T I N G ****'                 03000000
030100     ELSE                                                         03010000
030200         MOVE PC-RUN-IN-PROGRESS-CODE    TO PV-CKPT-STAT-CODE     03020000
030300         PERFORM 9804-UPDATE-TCKRSTCNTL                           03030000
030400         PERFORM 9801-INITIALIZE-TCKRSTINF                        03040000
030500     END-IF.                                                      03050000
030600     IF PS-END-OF-EXTRACT-YES                                     03060000
030700        CONTINUE                                                  03070000
030800     ELSE                                                         03080000
030900        PERFORM 7000-READ-INPUT                                   03090000
031000     END-IF.                                                      03100000
031100******************************************************************03110000
031200*                                                                 03120000
031300******************************************************************03130000
031400 2000-PROCESS-EXTRACT.                                            03140000
031500                                                                  03150000
031600     PERFORM 8000-SELECT-ASGMT.                                   03160000
031700     IF PS-LAST-SEQ-NBR-NOT-0                                     03170000
031800        PERFORM 3000-CALC-AVG-DIVERTS                             03180000
031900        PERFORM 4000-SELECT-TKRPRPM                               03190000
032000        PERFORM 4200-CHECK-THRESHOLD                              03200000
032100                                                                  03210000
032200        PERFORM 8100-UPDATE-ASGMT                                 03220000
032300     END-IF.                                                      03230000
032400     PERFORM 9807-CKPT-LOGIC.                                     03240000
032500     PERFORM 7000-READ-INPUT.                                     03250000
032600                                                                  03260000
032700******************************************************************03270000
032800* CALCULATE AVERAGE DIVERTS                                       03280000
032900******************************************************************03290000
033000                                                                  03300000
033100 3000-CALC-AVG-DIVERTS.                                           03310000
033200     MOVE DLT00004-WK-AREA-DESC(8:4) TO PV-DOOR-GP-X.             03320000
033300     MOVE PV-DOOR-GP-9 TO PV-DOOR-GP-NBR.                         03330000
033400     MOVE 0 TO PV-CARTON-COUNT.                                   03340000
033500     MOVE 0 TO PV-DOOR-COUNT.                                     03350000
033600     SET PS-END-OF-DOOR-CSR-NO TO TRUE.                           03360000
033700     MOVE PV-CC-DC-NBR TO PV-DC-NBR.                              03370000
033800     PERFORM 3100-OPEN-DOOR-CSR.                                  03380000
033900     PERFORM 3200-FETCH-DOOR-CSR                                  03390000
034000        UNTIL PS-END-OF-DOOR-CSR-YES.                             03400000
034100     PERFORM 3300-CLOSE-DOOR-CSR.                                 03410000
034200     DISPLAY 'CARTON COUNT => ' PV-CARTON-COUNT.                  03420000
034300     DISPLAY 'DOOR COUNT => ' PV-DOOR-COUNT.                      03430000
034400     IF (PV-CARTON-COUNT = 0) OR (PV-DOOR-COUNT = 0)              03440000
034500        MOVE 0 TO PV-AVG-DIVERT                                   03450000
034600     ELSE                                                         03460000
034700        COMPUTE PV-AVG-DIVERT ROUNDED =                           03470000
034800           PV-CARTON-COUNT / PV-DOOR-COUNT                        03480000
034900        END-COMPUTE                                               03490000
035000     END-IF.                                                      03500000
035100******************************************************************03510000
035200* OPEN DOOR_CSR CURSOR                                            03520000
035300******************************************************************03530000
035400 3100-OPEN-DOOR-CSR.                                              03540000
035500      PERFORM                                                     03550000
035600          WITH TEST AFTER                                         03560000
035700          VARYING PV-RETRY-COUNTER                                03570000
035800          FROM 1 BY 1                                             03580000
035900          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              03590000
036000             OR  (SQLCODE = +100)                                 03600000
036100             OR  (SQLCODE = +0))                                  03610000
036200         EXEC SQL                                                 03620000
036300             OPEN DOOR_CSR                                        03630000
036400         END-EXEC                                                 03640000
036500                                                                  03650000
036600         EVALUATE TRUE                                            03660000
036700           WHEN SQLCODE = 0                                       03670000
                 WHEN SQLCODE = -904                                    03671003
                 WHEN SQLCODE = -913                                    03672003
                 WHEN SQLCODE = -911                                    03673003
036800               CONTINUE                                           03680000
036900           WHEN OTHER                                             03690000
037000             MOVE '3100-OPEN-DOOR-CRS'                            03700000
037100                                   TO PV-ABEND-PARAGRAPH          03710000
037200             MOVE 'OPEN DOOR-CSR ' TO PV-ABEND-OPERATION          03720000
037300             MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1        03730000
037400            MOVE 'OPEN CURSOR USING DLT_DOOR_GP/DLT_DOOR_GP_TMPL' 03740000
037500                                   TO PV-DB2-OPERATION-MESSAGE-1  03750000
037600             PERFORM 9900-DB2-ABEND                               03760000
037700         END-EVALUATE                                             03770000
037800      END-PERFORM.                                                03780000
037900      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   03790000
038000           SQLCODE NOT = ZERO                                     03800000
038100           DISPLAY '**************************************'       03810000
038200           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       03820000
038300           DISPLAY 'OPEN DOOR CURSOR    '                         03830000
038400           DISPLAY '**************************************'       03840000
038500           MOVE '3100-OPEN-DOOR-CSR'                              03850000
038600                                 TO PV-ABEND-PARAGRAPH            03860000
038700           MOVE 'OPEN DOOR'      TO PV-ABEND-OPERATION            03870000
038800           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          03880000
038900           MOVE 'OPEN CURSOR'    TO PV-DB2-OPERATION-MESSAGE-1    03890000
039000           PERFORM 9900-DB2-ABEND                                 03900000
039100       END-IF.                                                    03910000
039200******************************************************************03920000
039300* FETCH DOOR_CSR CURSOR                                           03930000
039400******************************************************************03940000
039500 3200-FETCH-DOOR-CSR.                                             03950000
039600      PERFORM                                                     03960000
039700          WITH TEST AFTER                                         03970000
039800          VARYING PV-RETRY-COUNTER                                03980000
039900          FROM 1 BY 1                                             03990000
040000          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              04000000
040100             OR  (SQLCODE = +100)                                 04010000
040200             OR  (SQLCODE = +0))                                  04020000
040300       EXEC SQL                                                   04030000
040400           FETCH DOOR_CSR                                         04040000
040500            INTO :DLT00001-DOOR-ID                                04050000
040600       END-EXEC                                                   04060000
040700                                                                  04070000
040800       EVALUATE TRUE                                              04080000
040900         WHEN SQLCODE = 0                                         04090000
041000             ADD 1 TO PV-DOOR-COUNT                               04100000
041100             STRING DLT00004-ASGMT-STRT-DTE                       04110000
041200                    '-'                                           04120000
041300                    DLT00004-ASGMT-STRT-TM                        04130000
041400                    '.000000'                                     04140000
041500                    DELIMITED BY SIZE                             04150000
041600                    INTO PV-ASGMT-START-TMST                      04160000
041700             END-STRING                                           04170000
041800                                                                  04180000
041900             DISPLAY 'DOOR ID => ' DLT00001-DOOR-ID               04190000
042000             MOVE DLT00001-DOOR-ID TO SUCRDV-DOOR-ID              04200000
042100             MOVE PV-CC-DC-NBR TO PV-DC-NBR                       04210000
042200             SET PS-END-OF-CARTON-CSR-NO TO TRUE                  04220000
042300             SET PS-CARTONS-NOT-FOUND TO TRUE                     04230000
042400             PERFORM 3400-OPEN-CARTON-CSR                         04240000
042500             PERFORM 3500-FETCH-CARTON-CSR                        04250000
042600                UNTIL PS-END-OF-CARTON-CSR-YES                    04260000
042700             PERFORM 3600-CLOSE-CARTON-CSR                        04270000
042800             IF PS-CARTONS-FOUND                                  04280000
042900                CONTINUE                                          04290000
043000             ELSE                                                 04300000
043100                COMPUTE PV-DOOR-COUNT = PV-DOOR-COUNT - 1         04310000
043200                END-COMPUTE                                       04320000
043300             END-IF                                               04330000
043400         WHEN SQLCODE = +100                                      04340000
043500             SET PS-END-OF-DOOR-CSR-YES TO TRUE                   04350000
               WHEN SQLCODE = -904                                      04351003
               WHEN SQLCODE = -913                                      04352003
               WHEN SQLCODE = -911                                      04353003
                    CONTINUE                                            04354003
043600         WHEN OTHER                                               04360000
043700          MOVE '3200-FETCH-DOOR-CSR'                              04370000
043800                                TO PV-ABEND-PARAGRAPH             04380000
043900          MOVE 'FETCH DOOR_CSR' TO PV-ABEND-OPERATION             04390000
044000          MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1           04400000
044100          MOVE 'FETCH CURSOR USING DLT_DOOR_GP/DLT_DOOR_GP_TMPL'  04410000
044200                                TO PV-DB2-OPERATION-MESSAGE-1     04420000
044300          PERFORM 9900-DB2-ABEND                                  04430000
044400       END-EVALUATE                                               04440000
044500       END-PERFORM.                                               04450000
044600                                                                  04460000
044700       IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                  04470000
044800            SQLCODE NOT = ZERO                                    04480000
044900            DISPLAY '**************************************'      04490000
045000            DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '      04500000
045100            DISPLAY 'FETCH DOOR CURSOR    '                       04510000
045200            DISPLAY '**************************************'      04520000
045300            MOVE '3200-FETCH-DOOR-CSR'                            04530000
045400                                  TO PV-ABEND-PARAGRAPH           04540000
045500            MOVE 'FETCH DOOR'     TO PV-ABEND-OPERATION           04550000
045600            MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1         04560000
045700            MOVE 'FETCH CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1   04570000
045800            PERFORM 9900-DB2-ABEND                                04580000
045900        END-IF.                                                   04590000
046000******************************************************************04600000
046100* CLOSE DOOR_CSR CURSOR                                           04610000
046200******************************************************************04620000
046300 3300-CLOSE-DOOR-CSR.                                             04630000
046400      PERFORM                                                     04640000
046500          WITH TEST AFTER                                         04650000
046600          VARYING PV-RETRY-COUNTER                                04660000
046700          FROM 1 BY 1                                             04670000
046800          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              04680000
046900             OR  (SQLCODE = +100)                                 04690000
047000             OR  (SQLCODE = +0))                                  04700000
047100       EXEC SQL                                                   04710000
047200           CLOSE DOOR_CSR                                         04720000
047300       END-EXEC                                                   04730000
047400                                                                  04740000
047500       EVALUATE TRUE                                              04750000
047600         WHEN SQLCODE = 0                                         04760000
               WHEN SQLCODE = -904                                      04761003
               WHEN SQLCODE = -913                                      04762003
               WHEN SQLCODE = -911                                      04763003
047700             CONTINUE                                             04770000
047800         WHEN OTHER                                               04780000
047900           MOVE '3300-CLOSE-DOOR-CSR'                             04790000
048000                                 TO PV-ABEND-PARAGRAPH            04800000
048100           MOVE 'CLOSE DOOR_CSR' TO PV-ABEND-OPERATION            04810000
048200           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          04820000
048300           MOVE 'CLOSE CURSOR USING DLT_DOOR_GP/DLT_DOOR_GP_TMPL' 04830000
048400                                 TO PV-DB2-OPERATION-MESSAGE-1    04840000
048500           PERFORM 9900-DB2-ABEND                                 04850000
048600       END-EVALUATE                                               04860000
048700      END-PERFORM.                                                04870000
048800      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   04880000
048900           SQLCODE NOT = ZERO                                     04890000
049000           DISPLAY '**************************************'       04900000
049100           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       04910000
049200           DISPLAY 'CLOSE DOOR CURSOR    '                        04920000
049300           DISPLAY '**************************************'       04930000
049400           MOVE '3300-CLOSE-DOOR-CSR'                             04940000
049500                                 TO PV-ABEND-PARAGRAPH            04950000
049600           MOVE 'CLOSE DOOR'     TO PV-ABEND-OPERATION            04960000
049700           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          04970000
049800           MOVE 'CLOSE CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1    04980000
049900           PERFORM 9900-DB2-ABEND                                 04990000
050000       END-IF.                                                    05000000
050100******************************************************************05010000
050200* OPEN CARTON_CSR CURSOR                                          05020000
050300******************************************************************05030000
050400 3400-OPEN-CARTON-CSR.                                            05040000
050500      PERFORM                                                     05050000
050600          WITH TEST AFTER                                         05060000
050700          VARYING PV-RETRY-COUNTER                                05070000
050800          FROM 1 BY 1                                             05080000
050900          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              05090000
051000             OR  (SQLCODE = +100)                                 05100000
051100             OR  (SQLCODE = +0))                                  05110000
051200       EXEC SQL                                                   05120000
051300           OPEN CARTON_CSR                                        05130000
051400       END-EXEC                                                   05140000
051500                                                                  05150000
051600       EVALUATE TRUE                                              05160000
051700         WHEN SQLCODE = ZERO                                      05170000
               WHEN SQLCODE = -904                                      05171003
               WHEN SQLCODE = -913                                      05172003
               WHEN SQLCODE = -911                                      05173003
051800             CONTINUE                                             05180000
051900         WHEN OTHER                                               05190000
052000             MOVE '3400-OPEN-CARTON-CURSOR'                       05200000
052100                                     TO PV-ABEND-PARAGRAPH        05210000
052200             MOVE 'OPEN CARTON-CSR ' TO PV-ABEND-OPERATION        05220000
052300             MOVE 'TSUCRDV'        TO PV-ABEND-STRUCTURE-1        05230000
052400             MOVE 'OPEN CURSOR USING TSUCRDV TABLE'               05240000
052500                                   TO PV-DB2-OPERATION-MESSAGE-1  05250000
052600             PERFORM 9900-DB2-ABEND                               05260000
052700       END-EVALUATE                                               05270000
052800      END-PERFORM.                                                05280000
052900      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   05290000
053000           SQLCODE NOT = ZERO                                     05300000
053100           DISPLAY '**************************************'       05310000
053200           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       05320000
053300           DISPLAY 'OPEN CARTON CURSOR    '                       05330000
053400           DISPLAY '**************************************'       05340000
053500           MOVE '3400-OPEN-CARTON-CSR'                            05350000
053600                                 TO PV-ABEND-PARAGRAPH            05360000
053700           MOVE 'OPEN CARTON'    TO PV-ABEND-OPERATION            05370000
053800           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          05380000
053900           MOVE 'OPEN CURSOR'    TO PV-DB2-OPERATION-MESSAGE-1    05390000
054000           PERFORM 9900-DB2-ABEND                                 05400000
054100       END-IF.                                                    05410000
054200                                                                  05420000
054300******************************************************************05430000
054400* FETCH CARTON_CSR CURSOR                                         05440000
054500******************************************************************05450000
054600 3500-FETCH-CARTON-CSR.                                           05460000
054700      PERFORM                                                     05470000
054800          WITH TEST AFTER                                         05480000
054900          VARYING PV-RETRY-COUNTER                                05490000
055000          FROM 1 BY 1                                             05500000
055100          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              05510000
055200             OR  (SQLCODE = +100)                                 05520000
055300             OR  (SQLCODE = +0))                                  05530000
055400       EXEC SQL                                                   05540000
055500           FETCH CARTON_CSR                                       05550000
055600            INTO :SUCRDV-SHIPT-UNT-ID                             05560000
055700       END-EXEC                                                   05570000
055800                                                                  05580000
055900       EVALUATE TRUE                                              05590000
056000         WHEN SQLCODE = 0                                         05600000
056100             ADD 1 TO PV-CARTON-COUNT                             05610000
056200             DISPLAY 'CARTON => ' SUCRDV-SHIPT-UNT-ID ' / '       05620000
056300                PV-CARTON-COUNT                                   05630000
056400             SET PS-CARTONS-FOUND TO TRUE                         05640000
056500         WHEN SQLCODE = +100                                      05650000
056600             SET PS-END-OF-CARTON-CSR-YES TO TRUE                 05660000
               WHEN SQLCODE = -904                                      05661003
               WHEN SQLCODE = -913                                      05662003
               WHEN SQLCODE = -911                                      05663003
                    CONTINUE                                            05664003
056700         WHEN OTHER                                               05670000
056800             MOVE '3500-FETCH-CARTON-CSR'                         05680000
056900                                    TO PV-ABEND-PARAGRAPH         05690000
057000             MOVE 'FETCH ASGMT_CSR' TO PV-ABEND-OPERATION         05700000
057100             MOVE 'TSUCRDV'        TO PV-ABEND-STRUCTURE-1        05710000
057200             MOVE 'FETCH CURSOR USING TSUCRDV TABLE'              05720000
057300                                   TO PV-DB2-OPERATION-MESSAGE-1  05730000
057400             PERFORM 9900-DB2-ABEND                               05740000
057500       END-EVALUATE                                               05750000
057600      END-PERFORM.                                                05760000
057700                                                                  05770000
057800      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   05780000
057900           SQLCODE NOT = ZERO                                     05790000
058000           DISPLAY '**************************************'       05800000
058100           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       05810000
058200           DISPLAY 'FETCH CARTON CURSOR    '                      05820000
058300           DISPLAY '**************************************'       05830000
058400           MOVE '3500-FETCH-CARTON-CSR'                           05840000
058500                                 TO PV-ABEND-PARAGRAPH            05850000
058600           MOVE 'FETCH CARTON'   TO PV-ABEND-OPERATION            05860000
058700           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          05870000
058800           MOVE 'FETCH CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1    05880000
058900           PERFORM 9900-DB2-ABEND                                 05890000
059000       END-IF.                                                    05900000
059100******************************************************************05910000
059200* CLOSE CARTON_CSR CURSOR                                         05920000
059300******************************************************************05930000
059400 3600-CLOSE-CARTON-CSR.                                           05940000
059500      PERFORM                                                     05950000
059600          WITH TEST AFTER                                         05960000
059700          VARYING PV-RETRY-COUNTER                                05970000
059800          FROM 1 BY 1                                             05980000
059900          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              05990000
060000             OR  (SQLCODE = +100)                                 06000000
060100             OR  (SQLCODE = +0))                                  06010000
060200       EXEC SQL                                                   06020000
060300           CLOSE CARTON_CSR                                       06030000
060400       END-EXEC                                                   06040000
060500                                                                  06050000
060600       EVALUATE TRUE                                              06060000
060700         WHEN SQLCODE = 0                                         06070000
               WHEN SQLCODE = -904                                      06071003
               WHEN SQLCODE = -913                                      06072003
               WHEN SQLCODE = -911                                      06073003
060800             CONTINUE                                             06080000
060900         WHEN OTHER                                               06090000
061000             MOVE '3600-CLOSE-CARTON-CSR'                         06100000
061100                                    TO PV-ABEND-PARAGRAPH         06110000
061200             MOVE 'CLOSE CARTON_CSR' TO PV-ABEND-OPERATION        06120000
061300             MOVE 'TSUCRDV'        TO PV-ABEND-STRUCTURE-1        06130000
061400             MOVE 'FETCH CURSOR USING TSUCRDV TABLE'              06140000
061500                                   TO PV-DB2-OPERATION-MESSAGE-1  06150000
061600             PERFORM 9900-DB2-ABEND                               06160000
061700       END-EVALUATE                                               06170000
061800      END-PERFORM.                                                06180000
061900      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   06190000
062000           SQLCODE NOT = ZERO                                     06200000
062100           DISPLAY '**************************************'       06210000
062200           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       06220000
062300           DISPLAY 'CLOSE CARTON CURSOR    '                      06230000
062400           DISPLAY '**************************************'       06240000
062500           MOVE '3600-CLOSE-CARTON-CSR'                           06250000
062600                                 TO PV-ABEND-PARAGRAPH            06260000
062700           MOVE 'CLOSE CARTON'   TO PV-ABEND-OPERATION            06270000
062800           MOVE 'JOIN'           TO PV-ABEND-STRUCTURE-1          06280000
062900           MOVE 'CLOSE CURSOR'   TO PV-DB2-OPERATION-MESSAGE-1    06290000
063000           PERFORM 9900-DB2-ABEND                                 06300000
063100       END-IF.                                                    06310000
063200******************************************************************06320000
063300* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     06330000
063400******************************************************************06340000
063500 3700-DB2-COMMIT.                                                 06350000
063600                                                                  06360000
063700     EXEC SQL                                                     06370000
063800         COMMIT                                                   06380000
063900     END-EXEC.                                                    06390000
064000                                                                  06400000
064100     EVALUATE TRUE                                                06410000
064200       WHEN SQLCODE = +0                                          06420000
064300           DISPLAY '*** COMMIT ***'                               06430000
064400           ADD 1 TO PA-COMMIT-COUNT                               06440000
064500       WHEN OTHER                                                 06450000
064600           MOVE '3700-DB2-COMMIT'                                 06460000
064700                                  TO PV-ABEND-PARAGRAPH           06470000
064800           MOVE 'COMMIT '         TO PV-ABEND-OPERATION           06480000
064900           PERFORM 9900-DB2-ABEND                                 06490000
065000     END-EVALUATE.                                                06500000
065100                                                                  06510000
065200******************************************************************06520000
065300*  GET THRESHOLDS FOR DC                                          06530000
065400******************************************************************06540000
065500 4000-SELECT-TKRPRPM.                                             06550000
065600                                                                  06560000
065700     MOVE PV-CC-DC-NBR TO KRPRPM-LOC-ID.                          06570000
065800      PERFORM                                                     06580000
065900          WITH TEST AFTER                                         06590000
066000          VARYING PV-RETRY-COUNTER                                06600000
066100          FROM 1 BY 1                                             06610000
066200          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              06620000
066300             OR  (SQLCODE = +100)                                 06630000
066400             OR  (SQLCODE = +0))                                  06640000
066500       EXEC SQL                                                   06650000
066600           SELECT FUNC_TXT                                        06660000
066700             INTO :KRPRPM-FUNC-TXT                                06670000
066800             FROM TKRPRPM                                         06680000
066900            WHERE LOC_ID            = :KRPRPM-LOC-ID              06690000
067000              AND INTFC_SYS_CDE     = 'DLX'                       06700000
067100              AND SYS_PRC_FUNC_CDE  = 'DLSHTH'                    06710000
067200              AND FUNC_PRC_STAT_CDE = 'AC'                        06720000
067300       END-EXEC                                                   06730000
067400                                                                  06740000
067500       EVALUATE TRUE                                              06750000
067600           WHEN SQLCODE = 0                                       06760000
067700               MOVE KRPRPM-FUNC-TXT(1:4) TO PV-THRESHOLD-LOW      06770000
067800               MOVE KRPRPM-FUNC-TXT(6:4) TO PV-THRESHOLD-HI       06780000
067900           WHEN SQLCODE = +100                                    06790000
068000               PERFORM 4100-TRY-TKRPRPM-AGAIN                     06800000
                 WHEN SQLCODE = -904                                    06801003
                 WHEN SQLCODE = -913                                    06802003
                 WHEN SQLCODE = -911                                    06803003
                      CONTINUE                                          06804003
068100           WHEN OTHER                                             06810000
068200               MOVE '4000-SELECT-TKRPRPM' TO PV-ABEND-PARAGRAPH   06820000
068300               MOVE 'SELECT'              TO PV-ABEND-OPERATION   06830000
068400               MOVE 'TKRPRPM'             TO PV-ABEND-STRUCTURE-1 06840000
068500               MOVE 'SELECT CURSOR USING TKRPRPM TABLE'           06850000
068600                                   TO PV-DB2-OPERATION-MESSAGE-1  06860000
068700               PERFORM 9900-DB2-ABEND                             06870000
068800       END-EVALUATE                                               06880000
068900      END-PERFORM.                                                06890000
069000                                                                  06900000
069100      IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                   06910000
069200          SQLCODE NOT = ZERO                                      06920000
069300           DISPLAY '**************************************'       06930000
069400           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       06940000
069500           DISPLAY 'TKRPRPM EXTRACT SELECT '                      06950000
069600           DISPLAY '**************************************'       06960000
069700           MOVE '4000-SELECT-TKRPRPM'                             06970000
069800                                 TO PV-ABEND-PARAGRAPH            06980000
069900           MOVE 'SELECT'         TO PV-ABEND-OPERATION            06990000
070000           MOVE 'TKRPRPM'        TO PV-ABEND-STRUCTURE-1          07000000
070100           MOVE 'SELECT CURSOR USING TKRPRPM TABLE'               07010000
070200                                 TO PV-DB2-OPERATION-MESSAGE-1    07020000
070300           PERFORM 9900-DB2-ABEND                                 07030000
070400      END-IF.                                                     07040000
070500******************************************************************07050000
070600*  GET THRESHOLDS FROM CORP IF DC THRESHOLDS DON'T EXIST          07060000
070700******************************************************************07070000
070800 4100-TRY-TKRPRPM-AGAIN.                                          07080000
070900      PERFORM                                                     07090000
071000          WITH TEST AFTER                                         07100000
071100          VARYING PV-RETRY-COUNTER                                07110000
071200          FROM 1 BY 1                                             07120000
071300          UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)              07130000
071400             OR  (SQLCODE = +100)                                 07140000
071500             OR  (SQLCODE = +0))                                  07150000
071600       EXEC SQL                                                   07160000
071700           SELECT FUNC_TXT                                        07170000
071800             INTO :KRPRPM-FUNC-TXT                                07180000
071900             FROM TKRPRPM                                         07190000
072000            WHERE LOC_ID            = :PV-LOC-CORP                07200000
072100              AND INTFC_SYS_CDE     = 'DLX'                       07210000
072200              AND SYS_PRC_FUNC_CDE  = 'DLSHTH'                    07220000
072300              AND FUNC_PRC_STAT_CDE = 'AC'                        07230000
072400       END-EXEC                                                   07240000
072500                                                                  07250000
072600       EVALUATE TRUE                                              07260000
072700           WHEN SQLCODE = 0                                       07270000
072800               DISPLAY '* CORP THRESHOLDS *'                      07280000
072900               MOVE KRPRPM-FUNC-TXT(1:4) TO PV-THRESHOLD-LOW      07290000
073000               MOVE KRPRPM-FUNC-TXT(6:4) TO PV-THRESHOLD-HI       07300000
                 WHEN SQLCODE = -904                                    07301003
                 WHEN SQLCODE = -913                                    07302003
                 WHEN SQLCODE = -911                                    07303003
                      CONTINUE                                          07304003
073100           WHEN OTHER                                             07310000
073200             MOVE '4100-TRY-TKRPRPM-AGAIN' TO PV-ABEND-PARAGRAPH  07320000
073300             MOVE 'SELECT'               TO PV-ABEND-OPERATION    07330000
073400             MOVE 'TKRPRPM'              TO PV-ABEND-STRUCTURE-1  07340000
073500             MOVE 'SELECT CURSOR USING TKRPRPM TABLE'             07350000
073600                                 TO PV-DB2-OPERATION-MESSAGE-1    07360000
073700             PERFORM 9900-DB2-ABEND                               07370000
073800       END-EVALUATE                                               07380000
073900      END-PERFORM.                                                07390000
074000       IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                  07400000
074100           SQLCODE NOT = ZERO                                     07410000
074200           DISPLAY '**************************************'       07420000
074300           DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '       07430000
074400           DISPLAY 'SELECT AGAIN TKRPRPM   '                      07440000
074500           DISPLAY '**************************************'       07450000
074600           MOVE '4100-TRY-TKRPRPM-AGAIN'                          07460000
074700                                 TO PV-ABEND-PARAGRAPH            07470000
074800           MOVE 'SELECT'         TO PV-ABEND-OPERATION            07480000
074900           MOVE 'TKRPRPM'        TO PV-ABEND-STRUCTURE-1          07490000
075000           MOVE 'SELECT CURSOR USING TKRPRPM TABLE'               07500000
075100                                 TO PV-DB2-OPERATION-MESSAGE-1    07510000
075200           PERFORM 9900-DB2-ABEND                                 07520000
075300       END-IF.                                                    07530000
075400******************************************************************07540000
075500*  CHECK RESULTS AGAINST THRESHOLDS                               07550000
075600******************************************************************07560000
075700 4200-CHECK-THRESHOLD.                                            07570000
075800     DISPLAY 'DIVERT AVG => ' PV-AVG-DIVERT.                      07580000
075900     DISPLAY 'THRESHOLD 1 => ' PV-THRESHOLD-ONE.                  07590000
076000     DISPLAY 'THRESHOLD 2 => ' PV-THRESHOLD-TWO.                  07600000
076100     IF PV-AVG-DIVERT > PV-THRESHOLD-TWO                          07610000
076200        MOVE 'SHIP1' TO DLT00004-WK-TYP-DESC                      07620000
076300     END-IF.                                                      07630000
076400     IF PV-AVG-DIVERT >= PV-THRESHOLD-ONE                         07640000
076500        IF PV-AVG-DIVERT <= PV-THRESHOLD-TWO                      07650000
076600           MOVE 'SHIP2' TO DLT00004-WK-TYP-DESC                   07660000
076700        END-IF                                                    07670000
076800     END-IF.                                                      07680000
076900     IF PV-AVG-DIVERT < PV-THRESHOLD-ONE                          07690000
077000        MOVE 'SHIP3' TO DLT00004-WK-TYP-DESC                      07700000
077100     END-IF.                                                      07710000
077200******************************************************************07720000
077300*  READ THE INPUT FILE                                            07730000
077400******************************************************************07740000
077500 7000-READ-INPUT.                                                 07750000
077600                                                                  07760000
077700     INITIALIZE DL011-SHIP-ASGMT-EXTRACT.                         07770000
077800                                                                  07780000
077900     READ SHIP-ASSIGN-EXTRACT-FILE INTO                           07790000
078000         DL011-SHIP-ASGMT-EXTRACT                                 07800000
078100         AT END    SET PS-END-OF-EXTRACT-YES TO TRUE.             07810000
078200                                                                  07820000
078300     IF PS-END-OF-EXTRACT-NO                                      07830000
078400        ADD 1 TO PA-INPUT-COUNT                                   07840000
078500        DISPLAY 'INPUT > ' DL011-SHIP-ASGMT-EXTRACT               07850000
078600     END-IF.                                                      07860000
078700                                                                  07870000
078800******************************************************************07880000
078900*  SELECT FROM DLT_ASGMT                                          07890000
079000******************************************************************07900000
079100 8000-SELECT-ASGMT.                                               07910000
079200                                                                  07920000
079300     SET PS-LAST-SEQ-NBR-NOT-0    TO TRUE.                        07930000
079400     MOVE DL011-ASGMT-STRT-DTE    TO DLT00004-ASGMT-STRT-DTE.     07940000
079500     MOVE DL011-ASGMT-NBR-TXT     TO DLT00004-ASGMT-NBR-TXT.      07950000
079600     MOVE DL011-ASGMT-NBR-SEQ-NBR TO DLT00004-ASGMT-NBR-SEQ-NBR.  07960000
079700     PERFORM                                                      07970000
079800        WITH TEST AFTER                                           07980000
079900        VARYING PV-RETRY-COUNTER                                  07990000
080000        FROM 1 BY 1                                               08000000
080100        UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)                08010000
080200          OR  (SQLCODE = +100)                                    08020000
080300          OR  (SQLCODE = +0))                                     08030000
080400       EXEC SQL                                                   08040000
080500           SELECT  ASGMT_STRT_DTE                                 08050000
080600                  ,ASGMT_NBR_TXT                                  08060000
080700                  ,ASGMT_NBR_SEQ_NBR                              08070000
080800                  ,ASGMT_STRT_TM                                  08080000
080900                  ,WK_TYP_DESC                                    08090000
081000                  ,WK_AREA_DESC                                   08100000
081100                  ,DC_NBR                                         08110000
081200                  ,CRE_BY_USR_ID                                  08120000
081300                  ,CRE_BY_PGM_NM                                  08130000
081400                  ,ASGMT_STP_TMST                                 08140000
081500                  ,ASGMT_STP_RSN_CDE                              08150000
081600                  ,STP_BY_PGM_NM                                  08160000
081700                  ,LAST_USD_SEQ_NBR                               08170000
081800           INTO  : DLT00004-ASGMT-STRT-DTE                        08180000
081900                ,: DLT00004-ASGMT-NBR-TXT                         08190000
082000                ,: DLT00004-ASGMT-NBR-SEQ-NBR                     08200000
082100                ,: DLT00004-ASGMT-STRT-TM                         08210000
082200                ,: DLT00004-WK-TYP-DESC                           08220000
082300                ,: DLT00004-WK-AREA-DESC                          08230000
082400                ,: DLT00004-DC-NBR                                08240000
082500                ,: DLT00004-CRE-BY-USR-ID                         08250000
082600                ,: DLT00004-CRE-BY-PGM-NM                         08260000
082700                ,: DLT00004-ASGMT-STP-TMST                        08270000
082800                ,: DLT00004-ASGMT-STP-RSN-CDE                     08280000
082900                ,: DLT00004-STP-BY-PGM-NM                         08290000
083000                ,: DLT00004-LAST-USD-SEQ-NBR                      08300000
083100             FROM DLT_ASGMT                                       08310000
083200            WHERE ASGMT_STRT_DTE    = :DLT00004-ASGMT-STRT-DTE    08320000
083300             AND ASGMT_NBR_TXT     = :DLT00004-ASGMT-NBR-TXT      08330000
083400             AND ASGMT_NBR_SEQ_NBR = :DLT00004-ASGMT-NBR-SEQ-NBR  08340000
083500       END-EXEC                                                   08350000
083600                                                                  08360000
083700     EVALUATE TRUE                                                08370000
083800         WHEN  SQLCODE = 0                                        08380000
083900            IF DLT00004-LAST-USD-SEQ-NBR = 0                      08390000
084000               SET PS-LAST-SEQ-NBR-0 TO TRUE                      08400000
084100               DISPLAY 'LAST-USD-SEQ-NBR = 0  / SHIP1'            08410000
084200               MOVE 'SHIP1' TO DLT00004-WK-TYP-DESC               08420000
084300               PERFORM 8100-UPDATE-ASGMT                          08430000
084400            END-IF                                                08440000
084500         WHEN SQLCODE = +100                                      08450000
084600             DISPLAY ' '                                          08460000
084700             DISPLAY '*******************************************'08470000
084800             DISPLAY '  DC ASGMT NOT FOUND '                      08480000
084900             DISPLAY '  ASGMT STRT DTE   : ' DL011-ASGMT-STRT-DTE 08490000
085000             DISPLAY '  ASGMT NBR TXT    : ' DL011-ASGMT-NBR-TXT  08500000
085100             DISPLAY '  ASGMT NBR SEQ NBR: '                      08510000
085200                                          DL011-ASGMT-NBR-SEQ-NBR 08520000
085300             DISPLAY '*******************************************'08530000
               WHEN SQLCODE = -904                                      08531003
               WHEN SQLCODE = -913                                      08532003
               WHEN SQLCODE = -911                                      08533003
                   CONTINUE                                             08534003
085400         WHEN OTHER                                               08540000
085500             MOVE '8000-SELECT-ASGMT '   TO PV-ABEND-PARAGRAPH    08550000
085600             MOVE 'SELECT'               TO PV-ABEND-OPERATION    08560000
085700             MOVE 'DLT00004'             TO PV-ABEND-STRUCTURE-1  08570000
085800             MOVE 'SELECT DLT-ASGMT TABLE'                        08580000
085900                                 TO PV-DB2-OPERATION-MESSAGE-1    08590000
086000             PERFORM 9900-DB2-ABEND                               08600000
086100     END-EVALUATE                                                 08610000
086200     END-PERFORM.                                                 08620000
086300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    08630000
086400          SQLCODE NOT = ZERO                                      08640000
086500          DISPLAY '**************************************'        08650000
086600          DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '        08660000
086700          DISPLAY 'SELECT DLT_ASGMT TABLE '                       08670000
086800          DISPLAY '**************************************'        08680000
086900          MOVE '8000-SELECT-ASGMT'                                08690000
087000                                TO PV-ABEND-PARAGRAPH             08700000
087100          MOVE 'SELECT'         TO PV-ABEND-OPERATION             08710000
087200          MOVE 'DLT00004'       TO PV-ABEND-STRUCTURE-1           08720000
087300          MOVE 'SELECT DLT-ASGMT TABLE'                           08730000
087400                                TO PV-DB2-OPERATION-MESSAGE-1     08740000
087500          PERFORM 9900-DB2-ABEND                                  08750000
087600      END-IF.                                                     08760000
087700******************************************************************08770000
087800*  SELECT FROM DLT_ASGMT                                          08780000
087900******************************************************************08790000
088000 8100-UPDATE-ASGMT.                                               08800000
088100     MOVE DL011-ASGMT-STRT-DTE    TO DLT00004-ASGMT-STRT-DTE.     08810000
088200     MOVE DL011-ASGMT-NBR-TXT     TO DLT00004-ASGMT-NBR-TXT.      08820000
088300     MOVE DL011-ASGMT-NBR-SEQ-NBR TO DLT00004-ASGMT-NBR-SEQ-NBR.  08830000
088400                                                                  08840000
088500*                                                                 08850000
088600     PERFORM                                                      08860000
088700         WITH TEST AFTER                                          08870000
088800         VARYING PV-RETRY-COUNTER                                 08880000
088900         FROM 1 BY 1                                              08890000
089000         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               08900000
089100            OR  (SQLCODE = +100)                                  08910000
089200            OR  (SQLCODE = +0))                                   08920000
089300                                                                  08930000
089400     EXEC SQL                                                     08940000
089500         UPDATE DLT_ASGMT                                         08950000
089600            SET WK_TYP_DESC = : DLT00004-WK-TYP-DESC              08960000
089700          WHERE ASGMT_STRT_DTE    = :DLT00004-ASGMT-STRT-DTE      08970000
089800            AND ASGMT_NBR_TXT     = :DLT00004-ASGMT-NBR-TXT       08980000
089900            AND ASGMT_NBR_SEQ_NBR = :DLT00004-ASGMT-NBR-SEQ-NBR   08990000
090000     END-EXEC                                                     09000000
090100                                                                  09010000
090200     EVALUATE TRUE                                                09020000
090300         WHEN  SQLCODE = 0                                        09030000
090400             DISPLAY DLT00004-ASGMT-STRT-DTE '/'                  09040000
090500                     DLT00004-ASGMT-NBR-TXT  '/'                  09050000
090600                     DLT00004-ASGMT-NBR-SEQ-NBR '/'               09060000
090700                     DLT00004-WK-TYP-DESC                         09070000
090800             ADD 1 TO PA-ASGMT-UPDATE-COUNT                       09080000
090900         WHEN  SQLCODE = +100                                     09090000
091000             DISPLAY ' '                                          09100000
091100             DISPLAY '*******************************************'09110000
091200             DISPLAY '  DC ASGMT NOT FOUND '                      09120000
091300             DISPLAY '  ASGMT STRT DTE   : ' DL011-ASGMT-STRT-DTE 09130000
091400             DISPLAY '  ASGMT NBR TXT    : ' DL011-ASGMT-NBR-TXT  09140000
091500             DISPLAY '  ASGMT NBR SEQ NBR: '                      09150000
091600                                          DL011-ASGMT-NBR-SEQ-NBR 09160000
091700             DISPLAY '*******************************************'09170000
               WHEN SQLCODE = -904                                      09171003
               WHEN SQLCODE = -913                                      09172003
               WHEN SQLCODE = -911                                      09173003
                   CONTINUE                                             09174003
091800         WHEN OTHER                                               09180000
091900             MOVE '8100-UPDATE-TKRPRPM ' TO PV-ABEND-PARAGRAPH    09190000
092000             MOVE 'UPDATE'               TO PV-ABEND-OPERATION    09200000
092100             MOVE 'DLT00004'             TO PV-ABEND-STRUCTURE-1  09210000
092200             MOVE 'UPDATE DLT-ASGMT TABLE'                        09220000
092300                                 TO PV-DB2-OPERATION-MESSAGE-1    09230000
092400             PERFORM 9900-DB2-ABEND                               09240000
092500     END-EVALUATE                                                 09250000
092600     END-PERFORM.                                                 09260000
092700     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    09270000
092800          SQLCODE NOT = ZERO                                      09280000
092900          DISPLAY '**************************************'        09290000
093000          DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '        09300000
093100          DISPLAY 'UPDATE DLT_ASGMT TABLE '                       09310000
093200          DISPLAY '**************************************'        09320000
093300          MOVE '8100-UPDATE-ASGMT'                                09330000
093400                                TO PV-ABEND-PARAGRAPH             09340000
093500          MOVE 'UPDATE'         TO PV-ABEND-OPERATION             09350000
093600          MOVE 'DLT00004'       TO PV-ABEND-STRUCTURE-1           09360000
093700          MOVE 'UPDATE DLT-ASGMT TABLE'                           09370000
093800                                TO PV-DB2-OPERATION-MESSAGE-1     09380000
093900          PERFORM 9900-DB2-ABEND                                  09390000
094000      END-IF.                                                     09400000
094100******************************************************************09410000
094200* EOJ DISPLAYS                                                    09420000
094300******************************************************************09430000
094400 8500-EOJ-ROUTINE.                                                09440000
094500                                                                  09450000
094600     CLOSE SHIP-ASSIGN-EXTRACT-FILE.                              09460000
094700                                                                  09470000
094800     DISPLAY '*******************************************'        09480000
094900     DISPLAY '      * DLKUP012 SUMMARY STATISTICS *      '        09490000
095000     DISPLAY ' '                                                  09500000
095100     DISPLAY '        ---------------------------        '        09510000
095200     DISPLAY '           THRESHOLD UPDATE                '        09520000
095300     DISPLAY '        ---------------------------        '        09530000
095400     DISPLAY ' '                                                  09540000
095500     DISPLAY ' TOTAL ASGMT UPDATES         :'                     09550000
095600                                    PA-ASGMT-UPDATE-COUNT.        09560000
095700     DISPLAY ' INPUT  COUNT                : ' PA-INPUT-COUNT.    09570000
095800     DISPLAY ' COMMIT COUNT                : ' PA-COMMIT-COUNT.   09580000
095900     DISPLAY ' '                                                  09590000
096000     DISPLAY '************  END OF DLKUP012  ***************'.    09600000
096100                                                                  09610000
096200******************************************************************09620000
096300* SELECT CHECKPOINT RESTART CONTROL VALUE TO SEE IF THIS RUN     *09630000
096400* IS NORMAL (0) OR A RESTART (9).                                *09640000
096500******************************************************************09650000
096600 9800-GET-CHECKPOINT-CNTL.                                        09660000
096700                                                                  09670000
096800     PERFORM WITH TEST AFTER                                      09680000
096900             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 09690000
097000             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         09700000
097100                     SQLCODE = ZERO                               09710000
097200                                                                  09720000
097300       EXEC SQL                                                   09730000
097400        SELECT CKPT_STAT_CODE                                     09740000
097500         INTO :PV-CKPT-STAT-CODE                                  09750000
097600         FROM TCKRSTCNTL                                          09760000
097700         WHERE JOB_NAME = :PC-JOB-NAME AND                        09770000
097800               PLAN_NAME = :PC-PGM-NAME                           09780000
097900       END-EXEC                                                   09790000
098000                                                                  09800000
098100       EVALUATE TRUE                                              09810000
                 WHEN SQLCODE = -904                                    09811003
                 WHEN SQLCODE = -913                                    09812003
                 WHEN SQLCODE = -911                                    09813003
                      CONTINUE                                          09814003
098200           WHEN SQLWARN0 NOT EQUAL SPACE                          09820000
098300           WHEN SQLCODE NOT EQUAL ZERO                            09830000
098400               DISPLAY '*****************************************'09840000
098500               DISPLAY '** ABEND                               **'09850000
098600               DISPLAY '** PROGRAM = DLKUP012                  **'09860000
098700               DISPLAY '** PARAGRAPH = 9800-GET-CHECKPOINT-CNTL**'09870000
098800               DISPLAY '** CHECKING IF RUN IS NORMAL OR RESTART**'09880000
098900               DISPLAY '*****************************************'09890000
099000               PERFORM 9900-DB2-ABEND                             09900000
099100       END-EVALUATE                                               09910000
099200     END-PERFORM.                                                 09920000
099300                                                                  09930000
099400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    09940000
099500         SQLCODE NOT = ZERO                                       09950000
099600         DISPLAY '****************************************'       09960000
099700         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       09970000
099800         DISPLAY '** SELECT TCKRSTCNTL                  **'       09980000
099900         DISPLAY '** PARAGRAPH = 9800-GET-CHECKPOINT-CNTL*'       09990000
100000         DISPLAY '****************************************'       10000000
100100         PERFORM 9900-DB2-ABEND                                   10010000
100200     END-IF.                                                      10020000
100300                                                                  10030000
100400******************************************************************10040000
100500* THIS WILL INITIALIZE THE WORKING STORAGE DESC TEXT THAT IS      10050000
100600* UPDATED DURING A NORMAL PROGRAM RUN AND USED TO RESTART IN CASE 10060000
100700* OF AN ABEND. THIS PARAGRAPH IS ONLY EXECUTED DURING A NORMAL RUN10070000
100800******************************************************************10080000
100900 9801-INITIALIZE-TCKRSTINF.                                       10090000
101000                                                                  10100000
101100     MOVE SPACES TO CKPT-RESTART-INFO.                            10110000
101200     PERFORM 9806-UPDATE-TCKRSTINF.                               10120000
101300                                                                  10130000
101400******************************************************************10140000
101500* CHECKPOINT-RESTART                                             *10150000
101600* RETRIEVE THE WORKING STORAGE FIELDS FROM THE DB2 TABLE, THEN   *10160000
101700* MOVE THE STORED ACCUMULATOR VALUES BACK TO WORKING STORAGE     *10170000
101800* BEFORE THE PROCESSING FOR THE RESTART CONTINUES. THIS IS DONE  *10180000
101900* SO THE REPORT STATISTICS IN THE SYSOUT ARE ACCURATE AFTER A    *10190000
102000* RESTART IS DONE, OTHERWISE THE SYSOUT WOULD ONLY REFLECT WHAT  *10200000
102100* WAS PROCESSED FROM THE RESTART POINT.                          *10210000
102200******************************************************************10220000
102300 9802-CHECKPOINT-RESTART.                                         10230000
102400                                                                  10240000
102500     PERFORM 9803-GET-CHECKPOINT-WK-STORG.                        10250000
102600     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     10260000
102700     PERFORM 7000-READ-INPUT                                      10270000
102800        VARYING SUB1 FROM 1 BY 1                                  10280000
102900        UNTIL SUB1 > CKPT-INPUT-COUNT OR                          10290000
103000              PS-END-OF-EXTRACT-YES                               10300000
103100*RE-LOAD THE STAT VARIABLES FROM TCKRSTINF WORK STORAGE           10310000
103200*SO THE PROPER STATISTICS WILL BE DISPLAYED UPON PGM COMPLETION.  10320000
103300                                                                  10330000
103400     MOVE CKPT-ASGMT-UPDATE-COUNT  TO PA-ASGMT-UPDATE-COUNT.      10340000
103500     MOVE CKPT-COMMIT-COUNT        TO PA-COMMIT-COUNT.            10350000
103600     MOVE CKPT-INPUT-COUNT         TO PA-INPUT-COUNT.             10360000
103700                                                                  10370000
103800******************************************************************10380000
103900*    SELECT CHECKPOINT RESTART WORKING STORAGE INFORMATION.       10390000
104000*    THIS FIELD ON THE DCLGEN IS LVC. IT HAS A LENGTH OF 4022.    10400000
104100******************************************************************10410000
104200 9803-GET-CHECKPOINT-WK-STORG.                                    10420000
104300                                                                  10430000
104400     PERFORM WITH TEST AFTER                                      10440000
104500             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 10450000
104600             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         10460000
104700                     SQLCODE = ZERO                               10470000
104800                                                                  10480000
104900       EXEC SQL                                                   10490000
105000        SELECT WORK_STRG_DESC                                     10500000
105100         INTO :TCKRSTINF-WORK-STRG-DESC                           10510000
105200         FROM TCKRSTINF                                           10520000
105300        WHERE JOB_NAME = :PC-JOB-NAME   AND                       10530000
105400              PLAN_NAME = :PC-PGM-NAME                            10540000
105500       END-EXEC                                                   10550000
105600                                                                  10560000
105700       EVALUATE TRUE                                              10570000
                 WHEN SQLCODE = -904                                    10571003
                 WHEN SQLCODE = -913                                    10572003
                 WHEN SQLCODE = -911                                    10573003
                      CONTINUE                                          10574003
105800           WHEN SQLWARN0 NOT EQUAL SPACE                          10580000
105900           WHEN SQLCODE NOT EQUAL ZERO                            10590000
106000             DISPLAY '******************************************' 10600000
106100             DISPLAY '* ABEND                                   ' 10610000
106200             DISPLAY '* PROGRAM = DLKUP012                      ' 10620000
106300             DISPLAY '* PARAGRAPH = 9803-GET-CHECKPOINT-WK-STORG' 10630000
106400             DISPLAY '* GETTING RESTART WORKING STORAGE INFO    ' 10640000
106500             DISPLAY '******************************************' 10650000
106600             PERFORM 9900-DB2-ABEND                               10660000
106700       END-EVALUATE                                               10670000
106800     END-PERFORM.                                                 10680000
106900                                                                  10690000
107000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    10700000
107100         SQLCODE NOT = ZERO                                       10710000
107200         DISPLAY '****************************************'       10720000
107300         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       10730000
107400         DISPLAY '** SELECT TCKRSTINF                   **'       10740000
107500         DISPLAY '** PARAGRAPH = 9803-GET-CHECKPOINT-WK-STORG'    10750000
107600         DISPLAY '****************************************'       10760000
107700         PERFORM 9900-DB2-ABEND                                   10770000
107800     END-IF.                                                      10780000
107900                                                                  10790000
108000******************************************************************10800000
108100*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *10810000
108200*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *10820000
108300******************************************************************10830000
108400 9804-UPDATE-TCKRSTCNTL.                                          10840000
108500                                                                  10850000
108600     PERFORM WITH TEST AFTER                                      10860000
108700             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 10870000
108800             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         10880000
108900                     SQLCODE = ZERO                               10890000
109000                                                                  10900000
109100       EXEC SQL                                                   10910000
109200         UPDATE TCKRSTCNTL                                        10920000
109300         SET CKPT_STAT_CODE   = :PV-CKPT-STAT-CODE                10930000
109400         WHERE JOB_NAME       = :PC-JOB-NAME AND                  10940000
109500               PLAN_NAME      = :PC-PGM-NAME                      10950000
109600       END-EXEC                                                   10960000
109700                                                                  10970000
109800       EVALUATE TRUE                                              10980000
                 WHEN SQLCODE = -904                                    10981003
                 WHEN SQLCODE = -913                                    10982003
                 WHEN SQLCODE = -911                                    10983003
                      CONTINUE                                          10984003
109900           WHEN SQLWARN0 NOT EQUAL SPACE                          10990000
110000           WHEN SQLCODE NOT EQUAL ZERO                            11000000
110100               DISPLAY '****************************************' 11010000
110200               DISPLAY '** ABEND                              **' 11020000
110300               DISPLAY '** PROGRAM = DLKUP012                 **' 11030000
110400               DISPLAY '** PARAGRAPH = 9804-UPDATE-TCKRSTCNTL **' 11040000
110500               DISPLAY '** UPDATING CKPT STAT CODE            **' 11050000
110600               DISPLAY '****************************************' 11060000
110700               PERFORM 9900-DB2-ABEND                             11070000
110800       END-EVALUATE                                               11080000
110900     END-PERFORM.                                                 11090000
111000                                                                  11100000
111100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    11110000
111200         SQLCODE NOT = ZERO                                       11120000
111300         DISPLAY '****************************************'       11130000
111400         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       11140000
111500         DISPLAY '** UPDATE TCKRSTCNTL                  **'       11150000
111600         DISPLAY '** PARAGRAPH = 9804-UPDATE-TCKRSTCNTL **'       11160000
111700         DISPLAY '****************************************'       11170000
111800         PERFORM 9900-DB2-ABEND                                   11180000
111900     END-IF.                                                      11190000
112000                                                                  11200000
112100******************************************************************11210000
112200* THE DATA FROM THESE FIELDS WILL BE STORED IN THE CHECKPOINT    *11220000
112300* RESTART INFO DESC.                                              11230000
112400******************************************************************11240000
112500 9805-SAVE-DATA-FOR-RESTART.                                      11250000
112600     MOVE PA-ASGMT-UPDATE-COUNT    TO CKPT-ASGMT-UPDATE-COUNT.    11260000
112700     MOVE PA-COMMIT-COUNT          TO CKPT-COMMIT-COUNT.          11270000
112800     MOVE PA-INPUT-COUNT           TO CKPT-INPUT-COUNT.           11280000
112900                                                                  11290000
113000******************************************************************11300000
113100*  UPDATES THE CHECKPOINT RESTART INFORMATION TABLE.  THIS        11310000
113200*  INFORMATION WOULD BE USED TO RESTART JOB IN CASE OF AN ABEND  *11320000
113300******************************************************************11330000
113400 9806-UPDATE-TCKRSTINF.                                           11340000
113500                                                                  11350000
113600     MOVE CKPT-RESTART-INFO    TO TCKRSTINF-WORK-STRG-DESC-TEXT.  11360000
113700     MOVE 4022                 TO TCKRSTINF-WORK-STRG-DESC-LEN.   11370000
113800                                                                  11380000
113900     PERFORM WITH TEST AFTER                                      11390000
114000             VARYING PV-RETRY-COUNTER FROM 1 BY 1                 11400000
114100             UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR         11410000
114200                     SQLCODE = ZERO                               11420000
114300                                                                  11430000
114400       EXEC SQL                                                   11440000
114500          UPDATE TCKRSTINF                                        11450000
114600           SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC       11460000
114700           WHERE JOB_NAME       = :PC-JOB-NAME AND                11470000
114800                 PLAN_NAME      = :PC-PGM-NAME                    11480000
114900       END-EXEC                                                   11490000
115000                                                                  11500000
115100       EVALUATE TRUE                                              11510000
115200           WHEN SQLCODE EQUAL ZERO                                11520000
                 WHEN SQLCODE = -904                                    11521003
                 WHEN SQLCODE = -913                                    11522003
                 WHEN SQLCODE = -911                                    11523003
115300              CONTINUE                                            11530000
115400           WHEN SQLWARN0 NOT EQUAL SPACE                          11540000
115500           WHEN SQLCODE NOT EQUAL ZERO                            11550000
115600               DISPLAY '*****************************************'11560000
115700               DISPLAY '** ABEND                                 '11570000
115800               DISPLAY '** PROGRAM = DLKUP012                    '11580000
115900               DISPLAY '** PARAGRAPH = 9806-UPDATE-TCKRSTINF     '11590000
116000               DISPLAY '** UNSUCCESSFUL UPDATE TCKRSTINF         '11600000
116100               DISPLAY '*****************************************'11610000
116200               PERFORM 9900-DB2-ABEND                             11620000
116300       END-EVALUATE                                               11630000
116400     END-PERFORM.                                                 11640000
116500                                                                  11650000
116600     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    11660000
116700         SQLCODE NOT = ZERO                                       11670000
116800         DISPLAY '****************************************'       11680000
116900         DISPLAY '** MAX RETRIES EXCEEDED ATTEMPTING TO **'       11690000
117000         DISPLAY '** UPDATE TO TCKRSTINF                **'       11700000
117100         DISPLAY '** PARAGRAPH = 9806-UPDATE-TCKRSTINF  **'       11710000
117200         DISPLAY '****************************************'       11720000
117300         PERFORM 9900-DB2-ABEND                                   11730000
117400     END-IF.                                                      11740000
117500******************************************************************11750000
117600* SAVE THE CURRENT SUMMARY STATISTICS TO BE USED TO RE-POPULATE  *11760000
117700* VARIABLES AFTER RESTART. UPDATE THE CHECKPOINT RESTART INFOR-  *11770000
117800* MATION WORKING STORAGE DESCRIPTION TEXT.                       *11780000
117900******************************************************************11790000
118000 9807-CKPT-LOGIC.                                                 11800000
118100                                                                  11810000
118200*SAVE CKPT DATA                                                   11820000
118300     PERFORM 9805-SAVE-DATA-FOR-RESTART.                          11830000
118400                                                                  11840000
118500*PLACE CKPT DATA IN RESTART TABLE                                 11850000
118600     PERFORM 9806-UPDATE-TCKRSTINF.                               11860000
118700                                                                  11870000
118800*COMMIT                                                           11880000
118900     PERFORM 3700-DB2-COMMIT.                                     11890000
119000                                                                  11900000
119100                                                                  11910000
119200******************************************************************11920000
119300* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      11930000
119400* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 11940000
119500******************************************************************11950000
119600 9900-DB2-ABEND.                                                  11960000
119700     PERFORM 8500-EOJ-ROUTINE.                                    11970000
119800     MOVE SQLCODE    TO PV-SQLCODE.                               11980000
119900     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       11990000
120000     DISPLAY '*** DB2 ERROR ***'.                                 12000000
120100     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               12010000
120200     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 12020000
120300     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               12030000
120400     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               12040000
120500     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       12050000
120600     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             12060000
120700                                                                  12070000
120800******************************************************************12080000
120900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    12090000
121000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         12100000
121100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     12110000
121200* FORMAT.                                                         12120000
121300******************************************************************12130000
121400     COPY DPPD004.                                                12140000
121500                                                                  12150000
121600     EXEC SQL                                                     12160000
121700         ROLLBACK                                                 12170000
121800     END-EXEC.                                                    12180000
121900                                                                  12190000
122000     DISPLAY '***********************'.                           12200000
122100     DISPLAY '* ROLLBACK * ROLLBACK *'.                           12210000
122200     DISPLAY '***********************'.                           12220000
122300                                                                  12230000
122400     MOVE +4013         TO PV-ABEND-CODE.                         12240000
122500     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         12250000
122600******************************************************************12260000
