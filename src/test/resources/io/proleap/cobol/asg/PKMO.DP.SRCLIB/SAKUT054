000100 IDENTIFICATION DIVISION.                                         00010013
000200                                                                  00020013
000300 PROGRAM-ID.      SAKUT054.                                       00030013
000400 AUTHOR.          STEVEN NOWAK.                                   00040013
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050013
000600 DATE-WRITTEN.    07/01/09.                                       00060013
000700 DATE-COMPILED.                                                   00070013
000800                                                                  00080013
000900******************************************************************00090013
001000*           PULL MASTER KEY FOR BLUE MARTINI PROCESSING           00100013
001100*=================================================================00110013
001200*  THIS PROGRAM WILL PROVIDE DATA ON A FILE FOR BLUE MARTINI      00120013
001300*  FOR ALL E-STORE SALE TRANSACTIONS RETURNED AT A BRICK AND      00130013
001400*  MORTAR STORE.                                                  00140013
001500*                                                                 00150013
001600*========================== CHANGE LOG ===========================00160013
001700*  AUTH      BY       DATE                 DESCRIPTION            00170013
001800*=================================================================00180013
001900* WR36527  TKMA409  07-01-09   CREATE PROGRAM                     00190013
002000*                                                                 00200013
002100******************************************************************00210013
002200* CHG#: CHG0053632                                                00220013
002300* ----------------                                                00230014
002400* CHANGE: INCLUDED SHIP FROM STORE TRANSACTION AS A PART OF       00240014
002500* OCF COMPANION CHANGE.                                           00250014
002600* WHO: COGNIZANT                                DATE:2013-06-28   00260014
002700******************************************************************00270014
002800* CHG#: CHG0145120                                                00280014
002900* ----------------                                                00290014
003000* CHANGE: MODIFIED PROGRAM TO FETCH MISSING TRANSACTIONS AND      00300014
003100* RETURN TRANSACTIONS WHERE TRN_TYP_CDE = 11,12 ONLY.             00310014
003200* CHANGES ARE TAGGED WITH C45120                                  00320014
003300* WHO: COGNIZANT                                DATE:2016-09-15   00330014
003400******************************************************************00340014
003500                                                                  00350013
003600 ENVIRONMENT DIVISION.                                            00360013
003700 CONFIGURATION SECTION.                                           00370013
003800                                                                  00380013
003900 SOURCE-COMPUTER.        IBM-3090.                                00390013
004000 OBJECT-COMPUTER.        IBM-3090.                                00400013
004100                                                                  00410013
004200 INPUT-OUTPUT SECTION.                                            00420013
004300 FILE-CONTROL.                                                    00430013
004400                                                                  00440013
004500     SELECT DATE-CARD-FILE ASSIGN TO INP01.                       00450013
004600                                                                  00460013
004700     SELECT ECOMM-FILE     ASSIGN TO OUT01.                       00470018
004800                                                                  00480013
004900 DATA DIVISION.                                                   00490013
005000 FILE SECTION.                                                    00500013
005100                                                                  00510013
005200 FD  DATE-CARD-FILE                                               00520013
005300     RECORDING MODE IS F                                          00530013
005400     BLOCK CONTAINS 0 RECORDS                                     00540013
005500     LABEL RECORDS ARE STANDARD.                                  00550013
005600                                                                  00560013
005700 01  DATE-CARD-REC                    PIC  X(80).                 00570013
005800                                                                  00580013
005900 FD  ECOMM-FILE                                                   00590018
006000     RECORDING MODE IS F                                          00600013
006100     BLOCK CONTAINS 0 RECORDS                                     00610013
006200     LABEL RECORDS ARE STANDARD.                                  00620013
006300                                                                  00630013
006400 01  ECOMM-REC                        PIC  X(26).                 00640018
006500                                                                  00650013
006600                                                                  00660013
006700******************************************************************00670013
006800*                       WORKING STORAGE                           00680013
006900******************************************************************00690013
007000 WORKING-STORAGE SECTION.                                         00700013
007100                                                                  00710013
007200 01  W-START                          PIC  X(50)    VALUE         00720013
007300     ' *** WORKING STORAGE STARTS HERE FOR SAKUT054 *** '.        00730013
007400                                                                  00740013
007500******************************************************************00750013
007600*                           SWITCHES                              00760013
007700******************************************************************00770013
007800 01  PS-PROGRAM-SWITCHES.                                         00780013
007900     05  PS-END-OF-CARD-FILE-SW       PIC  X(01)    VALUE 'N'.    00790013
008000         88  PS-END-OF-CARD-FILE                    VALUE 'Y'.    00800013
008100     05  PS-END-OF-MASTER-CURSOR-SW   PIC  X(01)    VALUE 'N'.    00810013
008200         88  PS-END-OF-MASTER-CURSOR                VALUE 'Y'.    00820013
008300                                                                  00830013
008400******************************************************************00840013
008500*                          CONSTANTS                              00850013
008600******************************************************************00860013
008700 01  PC-CONSTANTS.                                                00870013
008800     05  PC-JOB-NAME                  PIC  X(08)    VALUE         00880013
008900                                                    'SAK051  '.   00890013
009000     05  PC-PGM-NAME                  PIC  X(08)    VALUE         00900013
009100                                                    'SAKUT054'.   00910013
009200                                                                  00920013
009300     05  PC-ROW-NOT-FOUND             PIC S9(04)    VALUE +100    00930013
009400                                                    COMP SYNC.    00940013
009500                                                                  00950013
009600******************************************************************00960013
009700*                        ACCUMULATORS                             00970013
009800******************************************************************00980013
009900 01  PV-MISC-COUNT-FIELDS.                                        00990013
010000                                                                  01000013
010100     05  PV-MASTER-CURSOR-CNT         PIC  9(07)    VALUE ZERO.   01010013
010200                                                                  01020013
010300******************************************************************01030013
010400*                         VARIABLES                               01040013
010500******************************************************************01050013
010600 01  PV-DB2-VARIABLES.                                            01060013
010700                                                                  01070013
010800     05  PV-SQL                       PIC S9(04)    VALUE ZEROS.  01080013
010900     05  PV-PARAGRAPH-NAME            PIC  X(30)    VALUE SPACES. 01090013
011000     05  PV-DB2-TABLE-NAME            PIC  X(12)    VALUE SPACES. 01100013
011100     05  PV-DB2-OPERATION-MSG         PIC  X(60)    VALUE SPACES. 01110013
011200     05  PV-OPERATION-MSG-1           PIC  X(40)    VALUE SPACE.  01120013
011300     05  PV-OPERATION-MSG-2           PIC  X(40)    VALUE SPACE.  01130013
011400                                                                  01140013
011500******************************************************************01150013
011600*                          WORK AREA                              01160013
011700******************************************************************01170013
011800 01  PV-MISC-FIELDS.                                              01180013
011900                                                                  01190013
012000     05  PV-CURRENT-DAY-PARTN         PIC S9(04)    COMP          01200013
012100                                                    VALUE ZERO.   01210013
012200                                                                  01220013
012300******************************************************************01230013
012400*                       DATE/TIME                                 01240013
012500******************************************************************01250013
012600 01  PV-DATE-AND-TIME-FIELDS.                                     01260013
012700                                                                  01270013
012800     05  PV-POS-CCYY-MM-DD            PIC  X(10)    VALUE SPACE.  01280013
012900     05  FILLER REDEFINES PV-POS-CCYY-MM-DD.                      01290013
013000         10  PV-POS-CCYY              PIC  X(04).                 01300013
013100         10  FILLER                   PIC  X(01).                 01310013
013200         10  PV-POS-MM                PIC  X(02).                 01320013
013300         10  FILLER                   PIC  X(01).                 01330013
013400         10  PV-POS-DD                PIC  X(02).                 01340013
013500                                                                  01350013
013600******************************************************************01360013
013700*               SYSTEM TIME AND DATE VARIABLES                    01370013
013800******************************************************************01380013
013900 01  SYS-DATE-TIME.                                               01390013
014000     05  SYS-DATE                     PIC  X(08)    VALUE SPACES. 01400013
014100     05  SYS-TIME                     PIC  X(08)    VALUE SPACES. 01410013
014200                                                                  01420013
014300 01  ST-BEG-TIME.                                                 01430013
014400     05  ST-BEG-HR                    PIC  9(02)    VALUE ZEROS.  01440013
014500     05  FILLER                       PIC  X(01)    VALUE ':'.    01450013
014600     05  ST-BEG-MN                    PIC  9(02)    VALUE ZEROS.  01460013
014700                                                                  01470013
014800 01  ST-END-TIME.                                                 01480013
014900     05  ST-END-HR                    PIC  9(02)    VALUE ZEROS.  01490013
015000     05  FILLER                       PIC  X(01)    VALUE ':'.    01500013
015100     05  ST-END-MN                    PIC  9(02)    VALUE ZEROS.  01510013
015200                                                                  01520013
015300 01  SD-EDIT-DATE.                                                01530013
015400     05  SD-MONTH                     PIC  9(02)    VALUE ZEROS.  01540013
015500     05  FILLER                       PIC  X(01)    VALUE '-'.    01550013
015600     05  SD-DAY                       PIC  9(02)    VALUE ZEROS.  01560013
015700     05  FILLER                       PIC  X(01)    VALUE '-'.    01570013
015800     05  SD-CENT                      PIC  9(02)    VALUE ZEROS.  01580013
015900     05  SD-YEAR                      PIC  9(02)    VALUE ZEROS.  01590013
016000                                                                  01600013
016100***************************************************************** 01610013
016200* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    01620013
016300***************************************************************** 01630013
016400 01  CC-CONTROL-CARD.                                             01640013
016500                                                                  01650013
016600     05  CC-CONTROL-CARD-DISPLAY.                                 01660013
016700         10  CC-CONTROL-NAME          PIC  X(14)    VALUE SPACE.  01670013
016800             88  CC-VALID-CONTROL-NAME              VALUE         01680013
016900                 'P.O.S. DATE = '.                                01690013
017000         10  CC-POS-DATE-MMDDYY       PIC  9(06)    VALUE ZERO.   01700013
017100     05  FILLER                       PIC  X(60)    VALUE SPACE.  01710013
017200                                                                  01720013
017300******************************************************************01730013
017400*                        ERROR HANDLING                           01740013
017500******************************************************************01750013
017600 01  ABEND-CODE                       PIC S9(04)    VALUE ZEROS   01760013
017700                                                    COMP SYNC.    01770013
017800     88  ABEND-4001-WRITE-ERROR                     VALUE +4001.  01780013
017900     88  ABEND-4002-READ-ERROR                      VALUE +4002.  01790013
018000     88  ABEND-4003-CTRL-CARD-ERROR                 VALUE +4003.  01800013
018100     88  ABEND-4004-TABLE-ERROR                     VALUE +4004.  01810013
018200     88  ABEND-4005-OPEN-ERROR                      VALUE +4005.  01820013
018300     88  ABEND-4006-CLOSE-ERROR                     VALUE +4006.  01830013
018400     88  ABEND-4007-SEQUENCE-ERROR                  VALUE +4007.  01840013
018500     88  ABEND-4008-DATA-ERROR                      VALUE +4008.  01850013
018600     88  ABEND-4009-KEY-DATA-ERROR                  VALUE +4009.  01860013
018700     88  ABEND-4013-DB2-ERROR                       VALUE +4013.  01870013
018800     88  ABEND-4019-CAL-SUB-ERROR                   VALUE +4019.  01880013
018900     88  ABEND-4444-FORCED-ABEND                    VALUE +4444.  01890013
019000                                                                  01900013
019100                                                                  01910013
019200******************************************************************01920013
019300*  MASTER KEY RECORD LAYOUT                                       01930013
019400******************************************************************01940013
019500     COPY SARD012.                                                01950013
019600                                                                  01960013
019700******************************************************************01970013
019800*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01980013
019900******************************************************************01990013
020000     COPY DPWS500.                                                02000013
020100                                                                  02010013
020200******************************************************************02020013
020300*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            02030013
020400******************************************************************02040013
020500     COPY DPWS004.                                                02050013
020600                                                                  02060013
020700******************************************************************02070013
020800*  DB2 MESSAGE AREA                                               02080013
020900******************************************************************02090013
021000     COPY SQLCA2.                                                 02100013
021100                                                                  02110013
021200******************************************************************02120013
021300*  DB2 COMMUNICATION AREA.                                        02130013
021400******************************************************************02140013
021500     EXEC SQL                                                     02150013
021600          INCLUDE SQLCA                                           02160013
021700     END-EXEC.                                                    02170013
021800                                                                  02180013
021900******************************************************************02190013
022000*  DB2 TABLE TEPPART - PARTITION TABLE                            02200013
022100******************************************************************02210013
022200     EXEC SQL                                                     02220013
022300          INCLUDE TEPPART                                         02230013
022400     END-EXEC.                                                    02240013
022500                                                                  02250013
022600******************************************************************02260013
022700*  DB2 TABLE TEPTRN - TRANSACTION TABLE                           02270013
022800******************************************************************02280013
022900     EXEC SQL                                                     02290013
023000          INCLUDE TEPTRN                                          02300013
023100     END-EXEC.                                                    02310013
023200                                                                  02320013
023300******************************************************************02330013
023400*  DB2 TABLE TEPITM - TRANSACTION ITEM TABLE                      02340013
023500******************************************************************02350013
023600     EXEC SQL                                                     02360013
023700          INCLUDE TEPITM                                          02370013
023800     END-EXEC.                                                    02380013
023900                                                                  02390013
024000******************************************************************02400013
024100*  DB2 TABLE TEPIRT - ITEM RETURN INFORMATION TABLE               02410013
024200******************************************************************02420013
024300     EXEC SQL                                                     02430013
024400          INCLUDE TEPIRT                                          02440013
024500     END-EXEC.                                                    02450013
024600                                                                  02460013
024700******************************************************************02470013
024800*  DB2 TABLE TEPDKEY - CURRENT PROCESSING DAY KEYS                02480013
024900******************************************************************02490013
025000     EXEC SQL                                                     02500013
025100          INCLUDE TEPDKEY                                         02510013
025200     END-EXEC.                                                    02520013
025300                                                                  02530013
025400******************************************************************02540013
025500*  DB2 TABLE XST_LOC - STORE LOCATION TABLE                       02550013
025600******************************************************************02560013
025700     EXEC SQL                                                     02570013
025800          INCLUDE XST00001                                        02580013
025900     END-EXEC.                                                    02590013
026000                                                                  02600013
026100******************************************************************02610013
026200*  DB2 TABLE TEPECX - COSA-ECOMMERCE CROSS REFERENCE              02620013
026300******************************************************************02630013
026400     EXEC SQL                                                     02640013
026500          INCLUDE TEPECX                                          02650013
026600     END-EXEC.                                                    02660013
026700                                                                  02670013
026800******************************************************************02680013
026900******************************************************************02690013
027000*  CURSOR TO RETRIEVE KOHLS LATES/SALES CORRECTION TRANSACTIONS   02700013
027100*  AND CURRENT DAY TRANSACTIONS (UNION OF TWO "CURSORS" TO        02710013
027200*  PRODUCE ONE MASTER CURSOR) FOR RETURN TRANSACTIONS OF SALES    02720013
027300*  THAT ORIGINATED AT THE E-STORE.                                02730013
027400******************************************************************02740013
027500                                                                  02750013
027600     EXEC SQL                                                     02760013
027700       DECLARE MASTER-CURSOR CURSOR FOR                           02770013
027800*                                                                 02780013
027900**> LATE AND SALES CORRECTION TRANSACTIONS                        02790013
028000                                                                  02800013
028100          SELECT DISTINCT                                         02810013
028200                    TRN.PARTN_NBR                                 02820013
028300                   ,TRN.SLS_DTE                                   02830013
028400                   ,TRN.STR_NBR                                   02840013
028500                   ,TRN.RGST_ID                                   02850013
028600                   ,TRN.TRN_NBR                                   02860013
028700                   ,TRN.STRT_TM                                   02870013
028800                                                                  02880013
028900            FROM   TEPPART PRT                                    02890013
029000                  ,TEPTRN  TRN                                    02900013
029100                  ,TEPITM  ITM                                    02910013
029200                  ,TEPIRT  IRT                                    02920013
029300                  ,TEPDKEY KEE                                    02930013
029400                  ,XST_LOC LOC                                    02940013
029500                                                                  02950013
029600            WHERE  KEE.PRCG_DTE          = :PV-POS-CCYY-MM-DD     02960013
029700                                                                  02970013
029800              AND  KEE.SLS_DTE           = PRT.SLS_DTE            02980013
029900              AND  PRT.DB_STRUC_CDE      = 'O'                    02990013
030000              AND  PRT.STR_GP_CDE        = 'A'                    03000013
030100              AND  PRT.PARTN_NBR         = TRN.PARTN_NBR          03010013
030200                                                                  03020013
030300              AND  KEE.STR_NBR           = TRN.STR_NBR            03030013
030400              AND  KEE.RGST_ID           = TRN.RGST_ID            03040013
030500              AND  KEE.TRN_NBR           = TRN.TRN_NBR            03050013
030600              AND  KEE.STRT_TM           = TRN.STRT_TM            03060013
030700              AND  KEE.SLS_CORR_SEQ_NBR  = TRN.SLS_CORR_SEQ_NBR   03070013
030800                                                                  03080013
030900              AND  TRN.PARTN_NBR         = ITM.PARTN_NBR          03090013
031000              AND  TRN.STR_NBR           = ITM.STR_NBR            03100013
031100              AND  TRN.RGST_ID           = ITM.RGST_ID            03110013
031200              AND  TRN.TRN_NBR           = ITM.TRN_NBR            03120013
031300              AND  TRN.STRT_TM           = ITM.STRT_TM            03130013
031400              AND  TRN.SLS_CORR_SEQ_NBR  = ITM.SLS_CORR_SEQ_NBR   03140013
031500                                                                  03150013
031600              AND  ITM.PARTN_NBR         = IRT.PARTN_NBR          03160013
031700              AND  ITM.STR_NBR           = IRT.STR_NBR            03170013
031800              AND  ITM.RGST_ID           = IRT.RGST_ID            03180013
031900              AND  ITM.TRN_NBR           = IRT.TRN_NBR            03190013
032000              AND  ITM.STRT_TM           = IRT.STRT_TM            03200013
032100              AND  ITM.SLS_CORR_SEQ_NBR  = IRT.SLS_CORR_SEQ_NBR   03210013
032200              AND  ITM.LNE_ITM_SEQ_NBR   = IRT.LNE_ITM_SEQ_NBR    03220013
032300                                                                  03230013
032400              AND  ITM.LIV_RSLU_CDE      IN ('+', '-')            03240013
032500              AND  TRN.TRN_STAT_CDE      IN ('V', 'L')            03250013
032600              AND  TRN.VOID_ABRT_CDE     = 'N'                    03260013
032700              AND  TRN.TRN_TYP_CDE       IN ('11','12')           03270013
032800                                                                  03280013
032900              AND  IRT.ORIG_STR_NBR      = LOC.LOC_NBR            03290013
033000              AND  LOC.LOC_TYP_CDE       = 'DS'                   03300013
033100              AND ((LOC.E_BUS_IND         = 'Y')                  03310017
033200               OR (LOC.E_BUS_IND         = 'N'                    03320014
033300              AND  IRT.ORIG_RGST_ID BETWEEN 90 AND 99))           03330016
033400                                                                  03340013
033500       UNION                                                      03350013
033600                                                                  03360013
033700**> CURRENT DAY TRANSACTIONS                                      03370013
033800                                                                  03380013
033900          SELECT DISTINCT                                         03390013
034000                    TRN.PARTN_NBR                                 03400013
034100                   ,TRN.SLS_DTE                                   03410013
034200                   ,TRN.STR_NBR                                   03420013
034300                   ,TRN.RGST_ID                                   03430013
034400                   ,TRN.TRN_NBR                                   03440013
034500                   ,TRN.STRT_TM                                   03450013
034600                                                                  03460013
034700            FROM    TEPPART PRT                                   03470013
034800                   ,TEPTRN  TRN                                   03480013
034900                   ,TEPITM  ITM                                   03490013
035000                   ,TEPIRT  IRT                                   03500013
035100                   ,XST_LOC LOC                                   03510013
035200                                                                  03520013
035300            WHERE   PRT.PARTN_NBR         = :PV-CURRENT-DAY-PARTN 03530013
035400              AND   PRT.DB_STRUC_CDE      = 'O'                   03540013
035500              AND   PRT.STR_GP_CDE        = 'A'                   03550013
035600              AND   PRT.PARTN_NBR         = TRN.PARTN_NBR         03560013
035700                                                                  03570013
035800              AND   TRN.PARTN_NBR         = ITM.PARTN_NBR         03580013
035900              AND   TRN.STR_NBR           = ITM.STR_NBR           03590013
036000              AND   TRN.RGST_ID           = ITM.RGST_ID           03600013
036100              AND   TRN.TRN_NBR           = ITM.TRN_NBR           03610013
036200              AND   TRN.STRT_TM           = ITM.STRT_TM           03620013
036300              AND   TRN.SLS_CORR_SEQ_NBR  = ITM.SLS_CORR_SEQ_NBR  03630013
036400                                                                  03640013
036500              AND   ITM.PARTN_NBR         = IRT.PARTN_NBR         03650013
036600              AND   ITM.STR_NBR           = IRT.STR_NBR           03660013
036700              AND   ITM.RGST_ID           = IRT.RGST_ID           03670013
036800              AND   ITM.TRN_NBR           = IRT.TRN_NBR           03680013
036900              AND   ITM.STRT_TM           = IRT.STRT_TM           03690013
037000              AND   ITM.SLS_CORR_SEQ_NBR  = IRT.SLS_CORR_SEQ_NBR  03700013
037100              AND   ITM.LNE_ITM_SEQ_NBR   = IRT.LNE_ITM_SEQ_NBR   03710013
037200                                                                  03720013
037300              AND   TRN.VOID_ABRT_CDE     = 'N'                   03730013
037400              AND   TRN.TRN_STAT_CDE      = 'Z'                   03740013
037500              AND   TRN.TRN_TYP_CDE       IN ('11','12')          03750013
037600              AND   ITM.LIV_RSLU_CDE      IN ('+', '-')           03760013
037700              AND   IRT.ORIG_STR_NBR      = LOC.LOC_NBR           03770013
037800              AND   LOC.LOC_TYP_CDE       = 'DS'                  03780013
037900              AND ((LOC.E_BUS_IND         = 'Y')                  03790017
038000               OR  (LOC.E_BUS_IND         = 'N'                   03800014
038100              AND   IRT.ORIG_RGST_ID BETWEEN 90 AND 99))          03810017
038200                                                                  03820013
038300          ORDER BY 1, 2, 3, 4, 5                                  03830013
038400          WITH UR                                                 03840013
038500     END-EXEC.                                                    03850013
038600                                                                  03860013
038700 PROCEDURE DIVISION.                                              03870013
038800******************************************************************03880013
038900* MAINLINE                                                        03890013
039000******************************************************************03900013
039100 0000-MAINLINE.                                                   03910013
039200                                                                  03920013
039300     PERFORM 1000-INITIALIZE-PROGRAM.                             03930013
039400                                                                  03940013
039500     PERFORM 2000-OPEN-MASTER-CURSOR.                             03950013
039600     PERFORM 3000-FETCH-MASTER-CURSOR.                            03960013
039700                                                                  03970013
039800     PERFORM 4000-PROCESS-MASTER-CURSOR                           03980013
039900       UNTIL PS-END-OF-MASTER-CURSOR.                             03990013
040000                                                                  04000013
040100     PERFORM 5000-CLOSE-MASTER-CURSOR.                            04010013
040200                                                                  04020013
040300     PERFORM 9900-END-OF-JOB-ROUTINE.                             04030013
040400                                                                  04040013
040500     STOP RUN.                                                    04050013
040600                                                                  04060013
040700                                                                  04070013
040800******************************************************************04080013
040900* OPEN FILES, PROCESS CONTROL CARD, CONNECTS TO QMGR              04090013
041000******************************************************************04100013
041100 1000-INITIALIZE-PROGRAM.                                         04110013
041200                                                                  04120013
041300     OPEN INPUT  DATE-CARD-FILE.                                  04130013
041400     OPEN OUTPUT ECOMM-FILE.                                      04140018
041500                                                                  04150013
041600     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 04160013
041700                                                                  04170013
041800     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            04180013
041900     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            04190013
042000                                                                  04200013
042100     MOVE SYS-DATE (1:2) TO SD-CENT.                              04210013
042200     MOVE SYS-DATE (3:2) TO SD-YEAR.                              04220013
042300     MOVE SYS-DATE (5:2) TO SD-MONTH.                             04230013
042400     MOVE SYS-DATE (7:2) TO SD-DAY.                               04240013
042500                                                                  04250013
042600     PERFORM 1100-PROCESS-CONTROL-CARD.                           04260013
042700     PERFORM 1200-SLCT-CUR-DAY-PARTN.                             04270013
042800                                                                  04280013
042900                                                                  04290013
043000******************************************************************04300013
043100* READ CONTROL CARD TO GET POS DATE IN MMDDYY FORMAT.  CALL       04310013
043200* DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD PROCESS DATE.      04320013
043300******************************************************************04330013
043400 1100-PROCESS-CONTROL-CARD.                                       04340013
043500                                                                  04350013
043600     PERFORM 1110-READ-DATE-CARD-FILE.                            04360013
043700                                                                  04370013
043800     CLOSE DATE-CARD-FILE.                                        04380013
043900                                                                  04390013
044000     IF PS-END-OF-CARD-FILE                                       04400013
044100         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   04410013
044200         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  04420013
044300         SET ABEND-4003-CTRL-CARD-ERROR TO TRUE                   04430013
044400         PERFORM 9500-ABEND                                       04440013
044500     END-IF.                                                      04450013
044600                                                                  04460013
044700     DISPLAY '          '.                                        04470013
044800     DISPLAY PC-PGM-NAME                                          04480013
044900             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  04490013
045000                                                                  04500013
045100     PERFORM 1115-CONVERT-INPUT-DATE.                             04510013
045200                                                                  04520013
045300                                                                  04530013
045400******************************************************************04540013
045500* READ DATE CONTROL CARD                                          04550013
045600******************************************************************04560013
045700 1110-READ-DATE-CARD-FILE.                                        04570013
045800                                                                  04580013
045900     READ DATE-CARD-FILE INTO CC-CONTROL-CARD                     04590013
046000        AT END                                                    04600013
046100           SET PS-END-OF-CARD-FILE TO TRUE.                       04610013
046200                                                                  04620013
046300                                                                  04630013
046400******************************************************************04640013
046500* CALL KOHLS CALENDAR ROUTINE:                                    04650013
046600*     PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).                04660013
046700*   RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT).     04670013
046800******************************************************************04680013
046900 1115-CONVERT-INPUT-DATE.                                         04690013
047000                                                                  04700013
047100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              04710013
047200                                                                  04720013
047300     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   04730013
047400     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   04740013
047500     SET  DPG52-LK-DTE-GREG            TO TRUE.                   04750013
047600                                                                  04760013
047700     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    04770013
047800                                                                  04780013
047900     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    04790013
048000                                             DPG54 DPG55 DPG56.   04800013
048100     EVALUATE TRUE                                                04810013
048200         WHEN DPG54-SEVERE-ERROR                                  04820013
048300         WHEN DPG54-DATE-INVALID                                  04830013
048400             MOVE '1115-CONVERT-INPUT-DATE'                       04840013
048500                                   TO PV-PARAGRAPH-NAME           04850013
048600             MOVE 'ERROR CONVERTING INPUT CARD DATE'              04860013
048700                                   TO PV-OPERATION-MSG-1          04870013
048800             SET ABEND-4019-CAL-SUB-ERROR                         04880013
048900                                   TO TRUE                        04890013
049000             MOVE DPG54-ERROR-MESSAGE                             04900013
049100                                   TO PV-OPERATION-MSG-2          04910013
049200             PERFORM 9500-ABEND                                   04920013
049300     END-EVALUATE.                                                04930013
049400                                                                  04940013
049500     MOVE DPG55-DB2-ISO-DATE-FMT   TO PV-POS-CCYY-MM-DD.          04950013
049600                                                                  04960013
049700                                                                  04970013
049800******************************************************************04980013
049900* FIND PARTITION NUMBER THAT CORRESPONDS WITH CONTROL CARD DATE   04990013
050000******************************************************************05000013
050100 1200-SLCT-CUR-DAY-PARTN.                                         05010013
050200                                                                  05020013
050300     EXEC SQL                                                     05030013
050400          SELECT  PARTN_NBR                                       05040013
050500            INTO :PV-CURRENT-DAY-PARTN                            05050013
050600             FROM TEPPART                                         05060013
050700            WHERE SLS_DTE      = :PV-POS-CCYY-MM-DD               05070013
050800              AND DB_STRUC_CDE = 'O'                              05080013
050900              AND STR_GP_CDE = 'A'                                05090013
051000            WITH UR                                               05100013
051100     END-EXEC.                                                    05110013
051200                                                                  05120013
051300     EVALUATE TRUE                                                05130013
051400         WHEN SQLCODE = ZERO                                      05140013
051500             CONTINUE                                             05150013
051600                                                                  05160013
051700         WHEN OTHER                                               05170013
051800             MOVE SQLCODE TO PV-SQL                               05180013
051900                                                                  05190013
052000             DISPLAY '             '                              05200013
052100             DISPLAY 'SALES DATE = ' PV-POS-CCYY-MM-DD            05210013
052200                                                                  05220013
052300             MOVE '1200-SLCT-CUR-DAY-PARTN' TO PV-PARAGRAPH-NAME  05230013
052400             MOVE 'TEPPART'                 TO PV-DB2-TABLE-NAME  05240013
052500                                                                  05250013
052600             STRING 'ERROR ON READ OF TEPPART - SQLCODE = '       05260013
052700                PV-SQL DELIMITED BY SIZE INTO PV-DB2-OPERATION-MSG05270013
052800             END-STRING                                           05280013
052900                                                                  05290013
053000             SET ABEND-4002-READ-ERROR TO TRUE                    05300013
053100             PERFORM 9100-SQL-ABEND                               05310013
053200     END-EVALUATE.                                                05320013
053300                                                                  05330013
053400                                                                  05340013
053500***************************************************************** 05350013
053600* OPEN MASTER-CURSOR                                              05360013
053700***************************************************************** 05370013
053800 2000-OPEN-MASTER-CURSOR.                                         05380013
053900                                                                  05390013
054000     EXEC SQL                                                     05400013
054100          OPEN MASTER-CURSOR                                      05410013
054200     END-EXEC.                                                    05420013
054300                                                                  05430013
054400     EVALUATE TRUE                                                05440013
054500         WHEN SQLCODE = ZERO                                      05450013
054600              CONTINUE                                            05460013
054700                                                                  05470013
054800         WHEN SQLWARN0 NOT EQUAL SPACE                            05480013
054900         WHEN SQLCODE NOT EQUAL ZERO                              05490013
055000             MOVE '2000-OPEN-MASTER-CURSOR'                       05500013
055100                                   TO PV-PARAGRAPH-NAME           05510013
055200             MOVE 'ERROR ON OPEN OF MASTER-CURSOR'                05520013
055300                                   TO PV-DB2-OPERATION-MSG        05530013
055400                                                                  05540013
055500             SET ABEND-4005-OPEN-ERROR TO TRUE                    05550013
055600             PERFORM 9100-SQL-ABEND                               05560013
055700     END-EVALUATE.                                                05570013
055800                                                                  05580013
055900***************************************************************** 05590013
056000* FETCH MASTER-CURSOR                                             05600013
056100***************************************************************** 05610013
056200 3000-FETCH-MASTER-CURSOR.                                        05620013
056300                                                                  05630013
056400     EXEC SQL                                                     05640013
056500          FETCH MASTER-CURSOR                                     05650013
056600           INTO :EPTRN-PARTN-NBR                                  05660013
056700               ,:EPTRN-SLS-DTE                                    05670013
056800               ,:EPTRN-STR-NBR                                    05680013
056900               ,:EPTRN-RGST-ID                                    05690013
057000               ,:EPTRN-TRN-NBR                                    05700013
057100               ,:EPTRN-STRT-TM                                    05710013
057200     END-EXEC.                                                    05720013
057300                                                                  05730013
057400     EVALUATE TRUE                                                05740013
057500         WHEN SQLCODE = ZERO                                      05750013
057600             ADD 1 TO PV-MASTER-CURSOR-CNT                        05760013
057700                                                                  05770013
057800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          05780013
057900             SET PS-END-OF-MASTER-CURSOR TO TRUE                  05790013
058000                                                                  05800013
058100         WHEN SQLWARN0 NOT EQUAL SPACE                            05810013
058200         WHEN SQLCODE NOT EQUAL ZERO                              05820013
058300             MOVE '3000-FETCH-MASTER-CURSOR'                      05830013
058400                                   TO PV-PARAGRAPH-NAME           05840013
058500             MOVE 'ERROR ON FETCH OF MASTER-CURSOR'               05850013
058600                                   TO PV-DB2-OPERATION-MSG        05860013
058700                                                                  05870013
058800             SET ABEND-4002-READ-ERROR TO TRUE                    05880013
058900             PERFORM 9100-SQL-ABEND                               05890013
059000     END-EVALUATE.                                                05900013
059100                                                                  05910013
059200******************************************************************05920013
059300* MASTER CURSOR PROCESSING                                        05930013
059400******************************************************************05940013
059500 4000-PROCESS-MASTER-CURSOR.                                      05950013
059600                                                                  05960013
059700     PERFORM 4100-PROCESS-MASTER-KEY.                             05970013
059800                                                                  05980013
059900     PERFORM 3000-FETCH-MASTER-CURSOR.                            05990013
060000                                                                  06000013
060100***************************************************************** 06010013
060200* WRITE MASTER KEY TO ECOMM FILE                                  06020018
060300***************************************************************** 06030013
060400 4100-PROCESS-MASTER-KEY.                                         06040013
060500                                                                  06050013
060600     MOVE EPTRN-PARTN-NBR TO SA012-PARTN-NBR.                     06060013
060700     MOVE EPTRN-SLS-DTE   TO SA012-SLS-DTE.                       06070013
060800     MOVE EPTRN-STR-NBR   TO SA012-STR-NBR.                       06080013
060900     MOVE EPTRN-RGST-ID   TO SA012-RGST-ID.                       06090013
061000     MOVE EPTRN-TRN-NBR   TO SA012-TRN-NBR.                       06100013
061100     MOVE EPTRN-STRT-TM   TO SA012-STRT-TM.                       06110013
061200                                                                  06120013
061300     WRITE ECOMM-REC FROM SA012-BLUMART-REC.                      06130019
061400                                                                  06140013
061500***************************************************************** 06150013
061600* CLOSE MASTER-CURSOR.                                            06160013
061700***************************************************************** 06170013
061800 5000-CLOSE-MASTER-CURSOR.                                        06180013
061900                                                                  06190013
062000     EXEC SQL                                                     06200013
062100          CLOSE MASTER-CURSOR                                     06210013
062200     END-EXEC.                                                    06220013
062300                                                                  06230013
062400     EVALUATE TRUE                                                06240013
062500         WHEN SQLCODE = ZERO                                      06250013
062600              CONTINUE                                            06260013
062700                                                                  06270013
062800         WHEN SQLWARN0 NOT EQUAL SPACE                            06280013
062900         WHEN SQLCODE NOT EQUAL ZERO                              06290013
063000             MOVE '5000-CLOSE-MASTER-CURSOR'                      06300013
063100                                   TO PV-PARAGRAPH-NAME           06310013
063200             MOVE 'ERROR ON CLOSE OF MASTER CURSOR'               06320013
063300                                   TO PV-DB2-OPERATION-MSG        06330013
063400                                                                  06340013
063500             SET ABEND-4006-CLOSE-ERROR TO TRUE                   06350013
063600             PERFORM 9100-SQL-ABEND                               06360013
063700     END-EVALUATE.                                                06370013
063800                                                                  06380013
063900***************************************************************** 06390013
064000* ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.    06400013
064100***************************************************************** 06410013
064200 9100-SQL-ABEND.                                                  06420013
064300                                                                  06430013
064400     PERFORM 9900-END-OF-JOB-ROUTINE.                             06440013
064500                                                                  06450013
064600     DISPLAY '               '.                                   06460013
064700     DISPLAY '** ABEND     **'.                                   06470013
064800     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    06480013
064900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06490013
065000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-MSG.           06500013
065100     DISPLAY '** SQLCODE   ** = ' SQLCODE.                        06510013
065200                                                                  06520013
065300******************************************************************06530013
065400* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     06540013
065500* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      06550013
065600******************************************************************06560013
065700     COPY DPPD004.                                                06570013
065800                                                                  06580013
065900     CALL 'ILBOABN0' USING ABEND-CODE.                            06590013
066000                                                                  06600013
066100                                                                  06610013
066200***************************************************************** 06620013
066300* ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                      06630013
066400***************************************************************** 06640013
066500 9500-ABEND.                                                      06650013
066600                                                                  06660013
066700     PERFORM 9900-END-OF-JOB-ROUTINE.                             06670013
066800                                                                  06680013
066900     DISPLAY '                '.                                  06690013
067000     DISPLAY '** ABEND      **'.                                  06700013
067100     DISPLAY '** PROGRAM    ** = ' PC-PGM-NAME.                   06710013
067200     DISPLAY '** PARAGRAPH  ** = ' PV-PARAGRAPH-NAME.             06720013
067300     DISPLAY '** MSG 1      ** = ' PV-OPERATION-MSG-1.            06730013
067400     DISPLAY '** MSG 2      ** = ' PV-OPERATION-MSG-2.            06740013
067500                                                                  06750013
067600     CALL 'ILBOABN0' USING ABEND-CODE.                            06760013
067700                                                                  06770013
067800                                                                  06780013
067900******************************************************************06790013
068000* PREFORMS TASK TERMINATION PROCESSING                            06800013
068100******************************************************************06810013
068200 9900-END-OF-JOB-ROUTINE.                                         06820013
068300                                                                  06830013
068400     CLOSE ECOMM-FILE.                                            06840018
068500                                                                  06850013
068600     PERFORM 9999-CONTROLS.                                       06860013
068700                                                                  06870013
068800                                                                  06880013
068900******************************************************************06890013
069000* DISPLAY CONTROLS FROM THE PROGRAM                               06900013
069100******************************************************************06910013
069200 9999-CONTROLS.                                                   06920013
069300                                                                  06930013
069400     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 06940013
069500                                                                  06950013
069600     MOVE SYS-TIME (1:2) TO ST-END-HR.                            06960013
069700     MOVE SYS-TIME (3:2) TO ST-END-MN.                            06970013
069800                                                                  06980013
069900     DISPLAY '                    '.                              06990013
070000     DISPLAY '**********************'.                            07000013
070100     DISPLAY '   SAKUT054 CONTROLS  '.                            07010013
070200     DISPLAY '**********************'.                            07020013
070300     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         07030013
070400     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          07040013
070500     DISPLAY 'END TIME  = ' ST-END-TIME.                          07050013
070600     DISPLAY '======================'.                            07060013
070700     DISPLAY 'POS-CCYY-MM-DD    = ' PV-POS-CCYY-MM-DD.            07070013
070800     DISPLAY 'CURRENT-DAY-PARTN = ' PV-CURRENT-DAY-PARTN.         07080013
070900     DISPLAY '                  '.                                07090013
071000     DISPLAY 'MSTR CURSOR CNT = ' PV-MASTER-CURSOR-CNT.           07100013
071100     DISPLAY '                  '.                                07110013
071200                                                                  07120013
071300                                                                  07130013
