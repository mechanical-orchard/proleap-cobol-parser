000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.             DEKUT001.                                00050000
000600 AUTHOR.                 RICK TULLOCH.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           06-25-20.                                00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*       CREATE TRIGGER DATASETS FOR EACH BATCH OF STORED VALUE   *00120000
001210*  CARD EMBOSSING REQUESTS.  THIS IS BEING DONE TO OVERCOME NOT  *00121000
001220*  BEING ABLE TO DETECT A RENAMED DATASET FOR A DATASET TRIGGER  *00122000
001230*  IN DSERIES.                                                   *00123000
001231*                                                                *00123100
001232*       READ THROUGH THE EXISTING DATASET RENAME (ALTER)         *00123200
001233*  COMMANDS.  FOR EACH ALTER LINE, PARSE OUT THE DATASET NAME    *00123300
001234*  BEFORE THE RENAME, AND LOCATE THE STORED VALUE SYSTEM ID      *00123400
001235*  NODE OF THE DATASET NAME.  IF THE COMMAND LINE IS INVALID OR  *00123500
001236*  THE ORIGINAL DATASET NAME IS INVALID OR DOES NOT APPEAR       *00123600
001237*  CORRECT FOR THIS INTERFACE, THE PROGRAM WILL ABEND.  FOR      *00123700
001238*  EACH VALID DATASET FOUND, REPLACE THE STORED VALUE SYSID NODE *00123800
001239*  WITH THE DSERIES SYSTEM ID TO BUILD THE NEW TRIGGER DATASET   *00123900
001240*  NAME, AND THEN USE THE DYNAMIC ALLOCATION UTILITY TO          *00124000
001241*  ALLOCATE THE DATASET, AND THEN EXECUTE AN OPEN AND CLOSE TO   *00124100
001242*  CATALOG THE EMPTY DATASET THAT CAN BE DETECTED BY THE DATASET *00124200
001243*  TRIGGER EVENTS THAT WILL PROCESS EACH BATCH.                  *00124300
001244*                                                                *00124400
001245*       ALL DISPLAYS SHOULD BE REVIEWED IN THE CASE OF ANY       *00124500
001246*  ABENDS TO SEE IF ANY TRIGGER FILES WERE ALREADY CREATED AND   *00124600
001247*  DETECTED BY THE RELATED DSERIES EVENT.  IF ANY DATASETS WERE  *00124700
001248*  ALREADY CREATED BEFORE THE FAILURE, RERUNS WILL REQUIRE       *00124800
001249*  BUILDING A TEMPORARY RENAME COMMAND FILE THAT EXCLUDES THE    *00124900
001250*  COMMAND LINES FOR THAT DATASET                                *00125000
001251******************************************************************00125100
001252                                                                  00125200
001253******************************************************************00125300
001254 ENVIRONMENT DIVISION.                                            00125400
001255******************************************************************00125500
001256                                                                  00125600
001257 CONFIGURATION SECTION.                                           00125700
001258                                                                  00125800
001259 SOURCE-COMPUTER.        IBM-3090.                                00125900
001260 OBJECT-COMPUTER.        IBM-3090.                                00126000
001270                                                                  00127000
001280 INPUT-OUTPUT SECTION.                                            00128000
001290                                                                  00129000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT RENAME-COMMAND-FILE                                   00150000
001600         ASSIGN TO INP01.                                         00160000
001700                                                                  00170000
001800     SELECT SV-TRIGGER-FILE                                       00180000
001900         ASSIGN TO OUT01.                                         00190000
002000                                                                  00200000
002100******************************************************************00210000
002200 DATA DIVISION.                                                   00220000
002300******************************************************************00230000
002400                                                                  00240000
002500 FILE SECTION.                                                    00250000
002600                                                                  00260000
002700 FD  RENAME-COMMAND-FILE                                          00270000
002800     RECORDING MODE IS F                                          00280000
002900     LABEL RECORDS ARE STANDARD                                   00290000
003000     BLOCK CONTAINS 0 RECORDS                                     00300000
003100     RECORD CONTAINS 80 CHARACTERS                                00310000
003200     DATA RECORDS IS RC-RENAME-COMMAND-RECORD.                    00320000
003300                                                                  00330000
003400 01  RC-RENAME-COMMAND-RECORD    PIC X(80).                       00340000
003500                                                                  00350000
003510 FD  SV-TRIGGER-FILE                                              00351000
003520     RECORDING MODE IS F                                          00352000
003530     LABEL RECORDS ARE STANDARD                                   00353000
003540     BLOCK CONTAINS 0 RECORDS                                     00354000
003550     RECORD CONTAINS 80 CHARACTERS                                00355000
003560     DATA RECORDS IS ST-SV-TRIGGER-RECORD.                        00356000
003570                                                                  00357000
003580 01  ST-SV-TRIGGER-RECORD        PIC X(80).                       00358000
003590                                                                  00359000
003600 WORKING-STORAGE SECTION.                                         00360000
003700                                                                  00370000
003800*                                                                 00380000
003900*  PARAMETER LIST FOR THE DYNAMIC ALLOCATION ROUTINE              00390000
004000*                                                                 00400000
004100     COPY DPWS023.                                                00410000
004200                                                                  00420000
004300 01  ABEND-CODE                  PIC S9(04)   VALUE ZERO          00430000
004400                                              COMP SYNC.          00440000
004500     88  AC-WRITE-ERROR                       VALUE +4001.        00450000
004600     88  AC-INVLD-DATA-ON-DATASET-ERROR       VALUE +4008.        00460000
004700                                                                  00470000
004800 01  PS-PROGRAM-SWITCHES.                                         00480000
004900     05  PS-END-OF-RENAME-FILE-SW                                 00490000
005000                                 PIC X(1)     VALUE 'N'.          00500000
005100         88  PS-END-OF-RENAME-FILE            VALUE 'Y'.          00510000
005200                                                                  00520000
005300 01  PC-PROGRAM-CONSTANTS.                                        00530000
005400     05  PC-CURRENT-PROGRAM-NAME PIC X(8)     VALUE 'DEKUT001'.   00540000
005500     05  PC-QUOTE                PIC X(1)     VALUE QUOTE.        00550000
005600     05  PC-DSN-NODE-SEPARATOR   PIC X(1)     VALUE '.'.          00560000
005700     05  PC-OLD-DSN-SYSID        PIC X(4)     VALUE '.SV.'.       00570000
005800     05  PC-NEW-DSN-SYSID        PIC X(4)     VALUE '.DE.'.       00580000
005900     05  PC-SV-TRIGGER-FILE-DDNAME                                00590000
006000                                 PIC X(8)     VALUE 'OUT01'.      00600000
006100     05  PC-SV-TRIGGER-RECORD-COUNT                               00610000
006200                                 PIC 9(7)     VALUE 1.            00620000
006210                                                                  00621000
006220 01  PV-PROGRAM-VARIABLES.                                        00622000
006230     05  PV-TALLY                PIC S9(4)    VALUE ZEROS         00623000
006240                                              COMP SYNC.          00624000
006250     05  PV-MAXIMUM-NODE-LENGTH  PIC S9(4)    VALUE 8             00625000
006260                                              COMP SYNC.          00626000
006270     05  PV-SV-TRIGGER-FILE-DSN  PIC X(44)    VALUE SPACES.       00627000
006280                                                                  00628000
006290 01  UA-UNSTRING-AREA.                                            00629000
006300     05  UA-WORD-1               PIC X(80)    VALUE SPACES.       00630000
006400         88  UA-WORD-1-ALTER                  VALUE 'ALTER'.      00640000
006500     05  UA-WORD-2               PIC X(80)    VALUE SPACES.       00650000
006600     05  UA-OVERFLOW-POINTER     PIC S9(4)    VALUE ZEROS         00660000
006700                                              COMP SYNC.          00670000
006800     05  UA-OVERFLOW             PIC X(80)    VALUE SPACES.       00680000
006900     05  UA-DSN-INITIAL          PIC X(44)    VALUE SPACES.       00690000
007000         88  UA-DSN-INITIAL-QUOTE             VALUE SPACES.       00700000
007100     05  UA-DSN                  PIC X(44)    VALUE SPACES.       00710000
007200                                                                  00720000
007300******************************************************************00730000
007400 PROCEDURE DIVISION.                                              00740000
007500******************************************************************00750000
007600                                                                  00760000
007700 0000-MAINLINE.                                                   00770000
007800                                                                  00780000
007900     PERFORM 1000-INITIALIZE.                                     00790000
008000                                                                  00800000
008100     PERFORM 2000-PROCESS-RENAME-RECORD                           00810000
008200         UNTIL PS-END-OF-RENAME-FILE.                             00820000
008300                                                                  00830000
008400     PERFORM 9000-EOJ-ROUTINE.                                    00840000
008500                                                                  00850000
008600     GOBACK.                                                      00860000
008700                                                                  00870000
008800******************************************************************00880000
008900*  INITIALIZE FOR PROGRAM PROCESSING.                            *00890000
009000******************************************************************00900000
009100                                                                  00910000
009200 1000-INITIALIZE.                                                 00920000
009300     OPEN INPUT  RENAME-COMMAND-FILE.                             00930000
009400                                                                  00940000
009500     PERFORM 7000-READ-RENAME-FILE.                               00950000
009600*1000-EXIT.                                                       00960000
009700                                                                  00970000
009800******************************************************************00980000
009900*  PROCESS A RENAME COMMAND FILE RECORD.  WHEN AN ALTER VERB IS  *00990000
010000*  FOUND, PARSE OUT THE DATASET NAME FIELD, AND THEN PARSE IT    *01000000
010100*  OUT FROM BETWEEN THE QUOTES.  LOCATE THE FIRST DATASET NODE   *01010000
010200*  NAME SEPARATOR TO MAKE SURE THE HIGH LEVEL QUALIFIER THAT WAS *01020000
010300*  DETECTED IS POSSIBLY CORRECT BASED ON LENGTH.  TEST THE       *01030000
010400*  SECOND NODE OF THE DATASET NAME TO MAKE SURE IT IS FOR THE    *01040000
010500*  STORED VALUE SYSTEM ID.  IF SO, CREATE THE REPLACEMENT        *01050000
010600*  TRIGGER DATASET NAME BY REPLACING THE STORED VALUE SYSTEM ID  *01060000
010700*  WITH THE DSERIES SYSTEM ID, AND THEN CREATE A REPLACEMENT     *01070000
010800*  TRIGGER DATASET.                                              *01080000
010900******************************************************************01090000
011000                                                                  01100000
011100 2000-PROCESS-RENAME-RECORD.                                      01110000
011200     INITIALIZE UA-UNSTRING-AREA.                                 01120000
011300     MOVE +1 TO UA-OVERFLOW-POINTER.                              01130000
011400                                                                  01140000
011410     INITIALIZE PV-TALLY.                                         01141001
011420     INSPECT RC-RENAME-COMMAND-RECORD                             01142001
011430         TALLYING PV-TALLY                                        01143001
011440         FOR LEADING SPACES.                                      01144002
011480                                                                  01148002
011490     IF (PV-TALLY = (LENGTH OF RC-RENAME-COMMAND-RECORD))         01149004
011491         MOVE +1 TO PV-TALLY                                      01149104
011493     ELSE                                                         01149304
011494         ADD +1 TO PV-TALLY                                       01149404
011495     END-IF.                                                      01149504
011496                                                                  01149604
011500     UNSTRING RC-RENAME-COMMAND-RECORD(PV-TALLY:)                 01150002
011600         DELIMITED BY ALL SPACES                                  01160000
011700         INTO UA-WORD-1                                           01170000
011800              UA-WORD-2                                           01180000
011900         WITH POINTER UA-OVERFLOW-POINTER                         01190000
012000         ON OVERFLOW                                              01200000
012010             COMPUTE UA-OVERFLOW-POINTER =                        01201004
012020                       (PV-TALLY - 1 + UA-OVERFLOW-POINTER)       01202004
012100             MOVE RC-RENAME-COMMAND-RECORD                        01210000
012200                                         (UA-OVERFLOW-POINTER:) TO01220000
012300                       UA-OVERFLOW                                01230000
012400     END-UNSTRING.                                                01240000
012520                                                                  01252000
012600     IF (UA-WORD-1-ALTER)                                         01260000
012700         UNSTRING UA-WORD-2                                       01270000
012800             DELIMITED BY ALL PC-QUOTE                            01280000
012900             INTO UA-DSN-INITIAL                                  01290000
013000                  UA-DSN                                          01300000
013100         END-UNSTRING                                             01310000
013200         IF ((UA-DSN-INITIAL-QUOTE)                               01320000
013300                 AND (UA-DSN NOT = SPACES))                       01330000
013400             INITIALIZE PV-TALLY                                  01340000
013500             INSPECT UA-DSN                                       01350000
013600                 TALLYING PV-TALLY                                01360000
013700                 FOR CHARACTERS BEFORE INITIAL                    01370000
013800                                             PC-DSN-NODE-SEPARATOR01380000
013900             IF ((PV-TALLY = ZERO)                                01390000
014000                     OR (PV-TALLY > PV-MAXIMUM-NODE-LENGTH))      01400000
014100                 DISPLAY '** ABEND **'                            01410000
014200                 DISPLAY PC-CURRENT-PROGRAM-NAME  ' - INVALID '   01420000
014300                           'DSN PARSED FROM ALTER: ' UA-DSN       01430000
014400                 SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE       01440000
014500                 CALL 'ILBOABN0' USING ABEND-CODE                 01450000
014600             ELSE                                                 01460000
014700                 ADD +1 TO PV-TALLY                               01470000
014800                 IF (UA-DSN(PV-TALLY:(LENGTH OF PC-OLD-DSN-SYSID))01480000
014900                                         = PC-OLD-DSN-SYSID)      01490000
015000                   MOVE UA-DSN TO PV-SV-TRIGGER-FILE-DSN          01500000
015100                   MOVE PC-NEW-DSN-SYSID TO PV-SV-TRIGGER-FILE-DSN01510000
015200                           (PV-TALLY:(LENGTH OF PC-NEW-DSN-SYSID))01520000
015300                   PERFORM 3000-CREATE-TRIGGER-FILE               01530000
015400                 ELSE                                             01540000
015500                   DISPLAY '** ABEND **'                          01550000
015600                   DISPLAY PC-CURRENT-PROGRAM-NAME  ' - DSN FOR ' 01560000
015700                             'WRONG SYSTEM ID PARSED FROM ALTER: '01570000
015800                             UA-DSN                               01580000
015900                   SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE     01590000
016000                   CALL 'ILBOABN0' USING ABEND-CODE               01600000
016100                 END-IF                                           01610000
016200             END-IF                                               01620000
016300         ELSE                                                     01630000
016400             DISPLAY '** ABEND **'                                01640000
016500             DISPLAY PC-CURRENT-PROGRAM-NAME  ' - INVALID ALTER ' 01650000
016600                       'COMMAND DETECTED: '                       01660000
016700                       RC-RENAME-COMMAND-RECORD                   01670000
016800             SET AC-INVLD-DATA-ON-DATASET-ERROR TO TRUE           01680000
016900             CALL 'ILBOABN0' USING ABEND-CODE                     01690000
017000         END-IF                                                   01700000
017100     END-IF.                                                      01710000
017200                                                                  01720000
017300     PERFORM 7000-READ-RENAME-FILE.                               01730000
017400*2000-EXIT.                                                       01740000
017500                                                                  01750000
017600******************************************************************01760000
017700*  CREATE A REPLACEMENT TRIGGER DATASET.  USE THE DYNAMIC        *01770000
017800*  ALLOCATION UTILITY WITH FREE=CLOSE TO ALLOCATE THE DATASET TO *01780000
017900*  THE DDNAME FOR THE ALLOCATION.  IF SUCCESSFUL, OPEN THEN      *01790000
018000*  CLOSE THE FILE TO CREATE AN EMPTY DATASET THAT CAN BE         *01800000
018100*  DETECTED BY DSERIES DATASET TRIGGERS.                         *01810000
018110******************************************************************01811000
018111                                                                  01811100
018112 3000-CREATE-TRIGGER-FILE.                                        01811200
018113     DISPLAY PC-CURRENT-PROGRAM-NAME  ' - CREATING SV TRIGGER '   01811300
018114               'FILE ' PV-SV-TRIGGER-FILE-DSN.                    01811400
018115                                                                  01811500
018116     INITIALIZE DP023-DYNALC-PARMS.                               01811600
018117     MOVE PC-SV-TRIGGER-FILE-DDNAME TO DP023-DDNAME.              01811700
018118     MOVE PV-SV-TRIGGER-FILE-DSN TO DP023-DSNAME.                 01811800
018119     SET DP023-DISP-NEW TO TRUE.                                  01811900
018120     SET DP023-FREE-CLOSE-YES TO TRUE.                            01812000
018130     SET DP023-RECFM-FIXED-BLOCK TO TRUE.                         01813000
018131     MOVE LENGTH OF ST-SV-TRIGGER-RECORD TO DP023-RECSZ.          01813100
018132     MOVE PC-SV-TRIGGER-RECORD-COUNT TO DP023-RECOUNT.            01813200
018133                                                                  01813300
018134     SET DP023-DISABLE-DISPLAY-ABEND TO TRUE.                     01813400
018135                                                                  01813500
018136     PERFORM DP023-0000-DYNALC.                                   01813600
018137                                                                  01813700
018138     IF (DP023-LASTRC NOT = ZERO)                                 01813800
018139         DISPLAY '** ABEND **'                                    01813900
018140         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - ' DP023-DDNAME      01814000
018141                   ' NOT ALLOCATED FOR ' DP023-DSNAME             01814100
018142         DISPLAY PC-CURRENT-PROGRAM-NAME  ' - ' DP023-DYNALC      01814200
018143                   ' RETURN CODE ' DP023-RC (DP023-SUB) ': '      01814300
018144                   DP023-DESC (DP023-SUB)                         01814400
018145         SET AC-WRITE-ERROR TO TRUE                               01814500
018146         CALL 'ILBOABN0' USING ABEND-CODE                         01814600
018147     END-IF.                                                      01814700
018148                                                                  01814800
018149     OPEN OUTPUT SV-TRIGGER-FILE.                                 01814900
018150                                                                  01815000
018151     CLOSE SV-TRIGGER-FILE.                                       01815100
018152*3000-EXIT.                                                       01815200
018153                                                                  01815300
018154******************************************************************01815400
018155*  READ A RENAME CONTROL FILE RECORD.                            *01815500
018156******************************************************************01815600
018157                                                                  01815700
018158 7000-READ-RENAME-FILE.                                           01815800
018159     READ RENAME-COMMAND-FILE                                     01815900
018160         AT END                                                   01816000
018161             SET PS-END-OF-RENAME-FILE TO TRUE                    01816100
018162     END-READ.                                                    01816200
018163*7000-EXIT.                                                       01816300
018164                                                                  01816400
018165******************************************************************01816500
018166*  CLOSE ALL FILES.                                              *01816600
018167******************************************************************01816700
018168                                                                  01816800
018169 9000-EOJ-ROUTINE.                                                01816900
018170     CLOSE RENAME-COMMAND-FILE.                                   01817000
018180*9000-EXIT.                                                       01818000
018190                                                                  01819000
018200*                                                                 01820000
018300*  DYNAMIC ALLOCATION ROUTINE                                     01830000
018400*                                                                 01840000
018500     COPY DPPD023.                                                01850000
