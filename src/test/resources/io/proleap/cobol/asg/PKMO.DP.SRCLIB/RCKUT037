000100******************************************************************00010018
000200 IDENTIFICATION DIVISION.                                         00020018
000300******************************************************************00030018
000400                                                                  00040018
000500 PROGRAM-ID.    RCKUT037.                                         00050018
000600 AUTHOR.        MARY SARDINA.                                     00060018
000700 INSTALLATION.  KOHLS.                                            00070018
000800 DATE-WRITTEN   JANUARY, 1996.                                    00080018
000900 DATE-COMPILED.                                                   00090018
001000                                                                  00100018
001100******************************************************************00110018
001200*  THIS PROGRAM DELETES ROWS FROM THE RECEIPT DISTRIBUTION TABLE. 00120018
001300******************************************************************00130018
001400                                                                  00140018
001500******************************************************************00150018
001600 ENVIRONMENT DIVISION.                                            00160018
001700******************************************************************00170018
001800                                                                  00180018
001900 CONFIGURATION SECTION.                                           00190018
002000                                                                  00200018
002100 SOURCE-COMPUTER.        IBM-3090.                                00210018
002200 OBJECT-COMPUTER.        IBM-3090.                                00220018
002300                                                                  00230018
002400 INPUT-OUTPUT SECTION.                                            00240018
002500                                                                  00250018
002600 FILE-CONTROL.                                                    00260018
002700                                                                  00270018
002800                                                                  00280018
002900     SELECT TIMESTAMP-FILE                                        00290018
003000         ASSIGN TO IN01.                                          00300018
003100                                                                  00310018
003200******************************************************************00320018
003300 DATA DIVISION.                                                   00330018
003400******************************************************************00340018
003500                                                                  00350018
003600 FILE SECTION.                                                    00360018
003700                                                                  00370018
003800 FD  TIMESTAMP-FILE                                               00380018
003900     RECORDING MODE IS F                                          00390018
004000     LABEL RECORDS ARE STANDARD                                   00400018
004100     BLOCK CONTAINS 0 RECORDS.                                    00410018
004200                                                                  00420018
004300 01  TIMESTAMP-RECORD           PIC  X(50).                       00430018
004400                                                                  00440018
004500*                                                                 00450018
004600******************************************************************00460018
004700 WORKING-STORAGE SECTION.                                         00470018
004800******************************************************************00480018
004900*                                                                 00490018
005000*                                                                 00500018
005100*                                                                 00510018
005200*                                                                 00520018
005300******************************************************************00530018
005400*  RECORD LAYOUT FOR THE TIMESTAMP FILE.                          00540018
005500******************************************************************00550018
005600     COPY RCRD011.                                                00560021
005700*                                                                 00570018
005800******************************************************************00580018
005900*  DB2 FORMATTED MESSAGE AREA                                     00590018
006000******************************************************************00600018
006100     COPY DPWS004.                                                00610021
006200*                                                                 00620018
006300*                                                                 00630018
006400     COPY SQLCA2.                                                 00640021
006500*                                                                 00650018
006600******************************************************************00660018
006700*  COMMUNICATIONS AREA FOR DB2                                    00670018
006800******************************************************************00680018
006900*                                                                 00690018
007000     EXEC SQL                                                     00700018
007100          INCLUDE SQLCA                                           00710018
007200     END-EXEC.                                                    00720018
007300*                                                                 00730018
007400*                                                                 00740018
007500******************************************************************00750018
007600*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE RECEIVER AUDIT     00760018
007700*  TABLE                                                          00770018
007800******************************************************************00780018
007900     EXEC SQL                                                     00790018
008000          INCLUDE TAURECD                                         00800018
008100     END-EXEC.                                                    00810018
008200*                                                                 00820018
008300 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00830018
008400                                                   COMP SYNC.     00840018
008500                                                                  00850018
008600 01  PS-PROGRAM-SWITCHES.                                         00860018
008700     05  PS-USE-SHIPPED-ITEM-SW      PIC  X(01)    VALUE SPACE.   00870018
008800         88  PS-USE-SHIPPED-ITEM                   VALUE 'Y'.     00880018
008900     05  PS-EOF-AUDIT-RECD-CSR-SW    PIC  X(01)    VALUE SPACE.   00890018
009000         88  PS-EOF-AUDIT-RECD-CSR                 VALUE 'Y'.     00900018
009100                                                                  00910018
009200                                                                  00920018
009300 01  PC-PROGRAM-CONSTANTS.                                        00930018
009400     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00940018
009500                                                   COMP SYNC.     00950018
009600     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00960018
009700         'RCKUT037'.                                              00970018
009800     05  PC-CURRENT-OPERATING-COMPANY                             00980018
009900                                     PIC  X(02)    VALUE '03'.    00990018
010000     05  PC-MAX-RETRIES              PIC S9(04)    VALUE +3       01000018
010100                                                   COMP SYNC.     01010018
010200     05  PC-CURRENT-TIMESTAMP        PIC  X(26)    VALUE SPACES.  01020018
010300                                                                  01030018
010400                                                                  01040018
010500     05  PC-COMMIT-DEL-COUNT         PIC 9(09)     VALUE ZERO.    01050018
010600                                                                  01060018
010700     05  PC-COMMIT-HOLD              PIC 9(3)      VALUE 019.     01070018
010800     05  PC-U                        PIC X(1)      VALUE 'U'.     01080018
010900                                                                  01090018
011000 01  PV-PROGRAM-VARIABLES.                                        01100018
011100     05  PV-ITEM-NBR                 PIC  9(15)    VALUE ZERO.    01110018
011200     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01120018
011300     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01130018
           05  PV-SQLCA                    PIC  X(136)   VALUE SPACES.  01131022
011400     05  PV-OPEN-COUNTER             PIC S9(04)    VALUE ZERO     01140018
011500                                                   COMP SYNC.     01150018
011600     05  PV-CLOSE-COUNTER            PIC S9(04)    VALUE ZERO     01160018
011700                                                   COMP SYNC.     01170018
011800     05  PV-FETCH-COUNTER            PIC S9(04)    VALUE ZERO     01180018
011900                                                   COMP SYNC.     01190018
012000     05  PV-WRITE-COUNTER            PIC S9(04)    VALUE ZERO     01200018
012100                                                   COMP SYNC.     01210018
012200     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             01220018
012300                                                                  01230018
012400     05  PV-DB2-COUNT                PIC S9(09)    VALUE ZERO     01240018
012500                                                   COMP-3.        01250018
012600     05  PV-OPER-UNT-ID              PIC 9(04)     VALUE ZERO.    01260018
012700                                                                  01270018
012800     05  PV-RECD-SEQ-NBR             PIC 9(03)     VALUE ZERO.    01280018
012900                                                                  01290018
013000     05  PV-PO-NBR                   PIC S9(08)    VALUE ZERO.    01300018
013100                                                                  01310018
013200     05  PV-PO-LNE-NBR               PIC 9(03)     VALUE ZERO.    01320018
013300                                                                  01330018
013400     05  PV-DELETE-COUNTER           PIC S9(04)  VALUE +0         01340018
013500                                                    COMP SYNC.    01350018
013600     05  PV-DELETE-COUNT             PIC S9(04)  VALUE +0         01360018
013700                                                    COMP SYNC.    01370018
013800     05  PV-UPDATE-COUNT             PIC S9(04)  VALUE +0         01380018
013900                                                    COMP SYNC.    01390018
014000     05  PV-UPDATE-COUNTER           PIC S9(04)  VALUE +0         01400018
014100                                                    COMP SYNC.    01410018
014200     05  PV-COMMIT-COUNT             PIC S9(04)  VALUE +0         01420018
014300                                                    COMP SYNC.    01430018
014400     05  PV-COMMIT-COUNTER           PIC 9(03)     VALUE ZERO.    01440018
014500                                                                  01450018
014600 01  PV-COMMIT-INFO.                                              01460018
014700     05  FILLER                      PIC X(23) VALUE              01470018
014800        ' ORD /SEQ/TIMESTAMP: '.                                  01480018
014900     05  PV-COMMIT-KEY.                                           01490018
015000         10  PV-COMMIT-ORD-NBR       PIC X(09).                   01500018
015100         10  FILLER                  PIC X(01) VALUE SPACE.       01510018
015200         10  PV-COMMIT-SEQ-NBR       PIC X(09).                   01520018
015300         10  FILLER                  PIC X(01) VALUE SPACE.       01530018
015400         10  PV-COMMIT-TIMESTAMP     PIC X(26).                   01540018
015500     05  FILLER                      PIC X(12) VALUE              01550018
015600        ' AUDIT CDE: '.                                           01560018
015700     05  PV-AUDIT-CODE               PIC X(01).                   01570018
015800     05  FILLER                      PIC X(24) VALUE SPACE.       01580018
015900     05  FILLER                      PIC X(22) VALUE              01590018
016000        ' # RECS DELETED     : '.                                 01600018
016100     05  PV-RECS-DELETED-COUNT       PIC 9(7)  VALUE 0.           01610018
016200*                                                                 01620018
016300*                                                                 01630018
016400 01  SD-SYSTEM-DATE.                                              01640018
016500     05  SD-SYSTEM-DATE-YY           PIC  9(02)      VALUE ZERO.  01650018
016600     05  SD-SYSTEM-DATE-MM           PIC  9(02)      VALUE ZERO.  01660018
016700     05  SD-SYSTEM-DATE-DD           PIC  9(02)      VALUE ZERO.  01670018
016800                                                                  01680018
016900*                                                                 01690018
017000*  CURSOR DECLARATION FOR ALL EXCEPTION ACTIVITY ON THE           01700018
017100*  UPC CERTIFICATION ACTIVITY LOG TABLE                           01710018
017200*                                                                 01720018
017300                                                                  01730018
017400     EXEC SQL                                                     01740018
017500          DECLARE AUDIT_RECD_CURSOR CURSOR WITH HOLD FOR          01750018
017600           SELECT                                                 01760018
017700             ORD_NBR                                              01770018
017800            ,REC_SEQ_NBR                                          01780018
017900            ,UPD_TMST                                             01790018
018000            ,UPD_PGM_ID                                           01800018
018100            ,AUD_TYP_CDE                                          01810018
018200            ,ROW_UNLD_SW                                          01820018
018300            ,AUD_FUNC_CDE                                         01830018
018400             FROM TAURECD                                         01840018
018500            WHERE UPD_TMST = :PC-CURRENT-TIMESTAMP                01850018
018600               OR UPD_TMST < :PC-CURRENT-TIMESTAMP                01860018
018700            AND NOT ROW_UNLD_SW = :PC-U                           01870018
018800            FOR UPDATE OF ROW_UNLD_SW                             01880018
018900                                                                  01890018
019000     END-EXEC.                                                    01900018
019100                                                                  01910018
019200                                                                  01920018
019300******************************************************************01930018
019400 PROCEDURE DIVISION.                                              01940018
019500******************************************************************01950018
019600                                                                  01960018
019700 0000-PROGRAM-MAINLINE.                                           01970018
019800******************************************************************01980018
019900* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01990018
020000*      PROGRAM.                                                   02000018
020100******************************************************************02010018
020200                                                                  02020018
020300     PERFORM 1000-INITIALIZE.                                     02030018
020400     PERFORM 2000-PROCESS-AUDIT-RECEIVERS                         02040018
020500       UNTIL PS-EOF-AUDIT-RECD-CSR.                               02050018
020600     PERFORM 9000-EOJ-ROUTINE.                                    02060018
020700                                                                  02070018
020800     STOP RUN.                                                    02080018
020900*0000-EXIT.                                                       02090018
021000*                                                                 02100018
021100*                                                                 02110018
021200 1000-INITIALIZE.                                                 02120018
021300******************************************************************02130018
021400*  DO FIRST TIME PROGRAM INITIALIZATION TASKS.                    02140018
021500*    -- OPEN CURSOR                                               02150018
021600*    -- FETCH CURSOR                                              02160018
021700******************************************************************02170018
021800*                                                                 02180018
021900     ACCEPT SD-SYSTEM-DATE FROM DATE.                             02190018
022000* *  MOVE SD-SYSTEM-DATE-YY      TO DP105-DATE1M-YY.              02200018
022100* *  MOVE SD-SYSTEM-DATE-MM      TO DP105-DATE1M-MM.              02210018
022200* *  MOVE SD-SYSTEM-DATE-DD      TO DP105-DATE1M-DD.              02220018
022300*                                                                 02230018
022400     OPEN INPUT  TIMESTAMP-FILE.                                  02240018
022500                                                                  02250018
022600     PERFORM 1100-READ-TIMESTAMP-FILE.                            02260018
022700                                                                  02270018
022800     MOVE +0 TO PV-COMMIT-COUNTER                                 02280018
022900                                                                  02290018
023000     PERFORM 7000-OPEN-AUDIT-RECD-CURSOR.                         02300018
023100                                                                  02310018
023200     PERFORM 7100-FETCH-AUDIT-RECD-CURSOR.                        02320018
023300*1000-EXIT.                                                       02330018
023400*                                                                 02340018
023500                                                                  02350018
023600 1100-READ-TIMESTAMP-FILE.                                        02360018
023700******************************************************************02370018
023800*  READ   THE CONTROL CARD.                                       02380018
023900******************************************************************02390018
024000      READ TIMESTAMP-FILE INTO                                    02400018
024100          RC011-CONTROL-RECORD.                                   02410018
024200      MOVE RC011-CONTROL-TMST TO PC-CURRENT-TIMESTAMP.            02420018
024300     DISPLAY 'RCKUT037 CONTROL CARD -- ' RC011-CONTROL-TMST.      02430018
024400     DISPLAY 'TAURECD TABLE'.                                     02440018
024500*                                                                 02450018
024600*1100-EXIT.                                                       02460018
024700*                                                                 02470018
024800 2000-PROCESS-AUDIT-RECEIVERS.                                    02480018
024900******************************************************************02490018
025000*  PROCESS THE CERTIFICATION REQUESTS (LOOP THROUGH THE RESULTS   02500018
025100*  TABLE).  FORMAT THE OUTPUT RECORD.  WRITE THE RECORDS THAT     02510018
025200*  MEET THE CRITERIA.                                             02520018
025300******************************************************************02530018
025400                                                                  02540018
025500     IF AURECD-UPD-PGM-ID = 'RCKCS279' OR 'RCKCS280'              02550018
025520           OR 'RCKPV818' OR 'RCKPV819' OR 'RCKPV820' OR 'SUKPV702'02552020
025600         IF AURECD-AUD-FUNC-CDE = 'T'                             02560018
025700             PERFORM 8000-DELETE-AUDIT-RECD-RECORD                02570018
025800         ELSE                                                     02580018
025900             PERFORM 8100-UPDATE-AUDIT-RECD-RECORD                02590018
026000         END-IF                                                   02600018
026100     ELSE                                                         02610018
026200          PERFORM 8000-DELETE-AUDIT-RECD-RECORD                   02620018
026300     END-IF.                                                      02630018
026400                                                                  02640018
026500     ADD +1 TO PV-COMMIT-COUNTER.                                 02650018
026600                                                                  02660018
026700     IF PV-COMMIT-COUNTER > PC-COMMIT-HOLD                        02670018
026800         EXEC SQL                                                 02680018
026900            COMMIT                                                02690018
027000         END-EXEC                                                 02700018
027100                                                                  02710018
027200         IF SQLCODE NOT = +0                                      02720018
027300             DISPLAY '### COMMIT FAILED ! ###'                    02730018
027400             PERFORM 9100-SQL-ABEND                               02740018
027500         END-IF                                                   02750018
027600                                                                  02760018
027700         ADD PV-COMMIT-COUNTER           TO PV-COMMIT-COUNT       02770018
027800         MOVE AURECD-ORD-NBR             TO PV-COMMIT-ORD-NBR     02780018
027900         MOVE AURECD-REC-SEQ-NBR         TO PV-COMMIT-SEQ-NBR     02790018
028000         MOVE AURECD-UPD-TMST            TO PV-COMMIT-TIMESTAMP   02800018
028100         MOVE AURECD-AUD-TYP-CDE         TO PV-AUDIT-CODE         02810018
028200                                                                  02820018
028300         MOVE PV-COMMIT-COUNT    TO PV-RECS-DELETED-COUNT         02830018
028400         DISPLAY 'COMMIT TAKEN: ' PV-COMMIT-INFO                  02840018
028500                                                                  02850018
028600         MOVE +0 TO PV-COMMIT-COUNTER                             02860018
028700     END-IF.                                                      02870018
028800                                                                  02880018
028900     PERFORM 7100-FETCH-AUDIT-RECD-CURSOR.                        02890018
029000     EJECT                                                        02900018
029100*2000-EXIT.                                                       02910018
029200                                                                  02920018
029300*                                                                 02930018
029400 7000-OPEN-AUDIT-RECD-CURSOR.                                     02940018
029500******************************************************************02950018
029600*  OPEN THE CURSOR.                                               02960018
029700******************************************************************02970018
029800     PERFORM WITH TEST AFTER                                      02980018
029900       VARYING PV-OPEN-COUNTER FROM 1 BY 1                        02990018
030000         UNTIL (PV-OPEN-COUNTER > PC-MAX-RETRIES                  03000018
030100                OR                                                03010018
030200                SQLCODE = ZERO)                                   03020018
030300                                                                  03030018
030400         EXEC SQL                                                 03040018
030500              OPEN AUDIT_RECD_CURSOR                              03050018
030600         END-EXEC                                                 03060018
030700                                                                  03070018
030800         EVALUATE TRUE                                            03080018
030900             WHEN SQLCODE = -904                                  03090018
031000             WHEN SQLCODE = -911                                  03100018
031100                 CONTINUE                                         03110018
031200             WHEN SQLWARN0 NOT = SPACES                           03120018
031300             WHEN SQLCODE < ZERO                                  03130018
031400             WHEN SQLCODE > ZERO                                  03140018
031500                 MOVE '7000-OPEN-AUDIT-RECD-CURSOR    '           03150018
031600                                 TO PV-PARAGRAPH-NAME             03160018
031700                 MOVE 'OPEN THE AUDIT_RECD_CURSOR    '            03170018
031800                                 TO PV-DB2-OPERATION-ATTEMPTED    03180018
031900                 PERFORM 9100-SQL-ABEND                           03190018
032000             WHEN SQLCODE = ZERO                                  03200018
032100                 CONTINUE                                         03210018
032200         END-EVALUATE                                             03220018
032300     END-PERFORM.                                                 03230018
032400                                                                  03240018
032500     IF PV-OPEN-COUNTER > PC-MAX-RETRIES                          03250018
032600         MOVE '7000-OPEN-AUDIT-RECD-CURSOR   '                    03260018
032700                                 TO PV-PARAGRAPH-NAME             03270018
032800         MOVE 'OPEN MAX RETRIES EXCEEDED     '                    03280018
032900                                 TO PV-DB2-OPERATION-ATTEMPTED    03290018
033000         PERFORM 9100-SQL-ABEND                                   03300018
033100     END-IF.                                                      03310018
033200*7000-EXIT.                                                       03320018
033300*                                                                 03330018
033400*                                                                 03340018
033500 7100-FETCH-AUDIT-RECD-CURSOR.                                    03350018
033600******************************************************************03360018
033700*  FETCH THE ROW FROM THE RESULTS TABLE USING THE CURSOR.         03370018
033800******************************************************************03380018
033900     EXEC SQL                                                     03390018
034000          FETCH AUDIT_RECD_CURSOR                                 03400018
034100           INTO :AURECD-ORD-NBR,                                  03410018
034200                :AURECD-REC-SEQ-NBR,                              03420018
034300                :AURECD-UPD-TMST,                                 03430018
034400                :AURECD-UPD-PGM-ID,                               03440018
034500                :AURECD-AUD-TYP-CDE,                              03450018
034600                :AURECD-ROW-UNLD-SW,                              03460018
034700                :AURECD-AUD-FUNC-CDE                              03470018
034800     END-EXEC.                                                    03480018
034900                                                                  03490018
035000     EVALUATE TRUE                                                03500018
035100         WHEN SQLCODE = ZERO                                      03510018
035200             CONTINUE                                             03520018
035300         WHEN SQLCODE = +100                                      03530018
035400             SET PS-EOF-AUDIT-RECD-CSR                            03540018
035500                                 TO TRUE                          03550018
035600         WHEN SQLWARN0 NOT = SPACES                               03560018
035700         WHEN SQLCODE < ZERO                                      03570018
035800         WHEN SQLCODE > ZERO                                      03580018
035900             MOVE '7100-FETCH-AUDIT-RECD-CURSOR  '                03590018
036000                                 TO PV-PARAGRAPH-NAME             03600018
036100             MOVE 'FETCH THE AUDIT-RECD-CURSOR   '                03610018
036200                                 TO PV-DB2-OPERATION-ATTEMPTED    03620018
036300             PERFORM 9100-SQL-ABEND                               03630018
036400     END-EVALUATE.                                                03640018
036500*7100-EXIT.                                                       03650018
036600*                                                                 03660018
036700 8000-DELETE-AUDIT-RECD-RECORD.                                   03670018
036800******************************************************************03680018
036900*  DELETE THE ROW FORM THE RECEIVER AUDIT TABLE                   03690018
037000******************************************************************03700018
037100                                                                  03710018
037200     PERFORM                                                      03720018
037300         WITH TEST AFTER                                          03730018
037400         VARYING PV-DELETE-COUNTER                                03740018
037500         FROM 1 BY 1                                              03750018
037600         UNTIL (PV-DELETE-COUNTER > PC-MAX-RETRIES                03760018
037700                   OR SQLCODE = 0                                 03770018
037800                   OR SQLCODE = +100)                             03780018
037900                                                                  03790018
038000         EXEC SQL                                                 03800018
038100             DELETE                                               03810018
038200                 FROM  TAURECD                                    03820018
038300                 WHERE CURRENT OF AUDIT_RECD_CURSOR               03830018
038400         END-EXEC                                                 03840018
038500                                                                  03850018
038600         EVALUATE TRUE                                            03860018
038700             WHEN SQLCODE = 0                                     03870018
038800                 ADD +1           TO PV-DELETE-COUNT              03880018
038900             WHEN SQLCODE = -904                                  03890018
039000             WHEN SQLCODE = -913                                  03900018
039100             WHEN SQLCODE = +100                                  03910018
039200                 CONTINUE                                         03920018
039300             WHEN SQLCODE < 0                                     03930018
039400             WHEN SQLCODE > 0                                     03940018
039500             WHEN SQLWARN0 = 'W'                                  03950018
039600                 MOVE '8000-DELETE-AUDIT-RECD-REC'                03960018
039700                             TO PV-PARAGRAPH-NAME                 03970018
039800                 MOVE 'DELETE OF TAURECD'                         03980018
039900                             TO PV-DB2-OPERATION-ATTEMPTED        03990018
040000                 PERFORM 9100-SQL-ABEND                           04000018
040100         END-EVALUATE                                             04010018
040200     END-PERFORM.                                                 04020018
040300                                                                  04030018
040400     IF PV-DELETE-COUNTER > PC-MAX-RETRIES                        04040018
040500         MOVE '8000-DELETE-AUDIT-RECD-REC'                        04050018
040600             TO PV-PARAGRAPH-NAME                                 04060018
040700         MOVE 'DEADLOCK * DELETE TAURCEV'                         04070018
040800             TO PV-DB2-OPERATION-ATTEMPTED                        04080018
040900         PERFORM 9100-SQL-ABEND                                   04090018
041000     END-IF.                                                      04100018
041100                                                                  04110018
041200*8000-EXIT.                                                       04120018
041300*                                                                 04130018
041400*                                                                 04140018
041500 8100-UPDATE-AUDIT-RECD-RECORD.                                   04150018
041600     PERFORM                                                      04160018
041700         WITH TEST AFTER                                          04170018
041800         VARYING PV-UPDATE-COUNTER                                04180018
041900         FROM 1 BY 1                                              04190018
042000         UNTIL (PV-UPDATE-COUNTER > PC-MAX-RETRIES                04200018
042100                   OR SQLCODE = 0                                 04210018
042200                   OR SQLCODE = +100)                             04220018
042300                                                                  04230018
042400         EXEC SQL                                                 04240018
042500             UPDATE TAURECD                                       04250018
042600             SET ROW_UNLD_SW = :PC-U                              04260018
042700                 WHERE CURRENT OF AUDIT_RECD_CURSOR               04270018
042800         END-EXEC                                                 04280018
042900                                                                  04290018
043000         EVALUATE TRUE                                            04300018
043100             WHEN SQLCODE = 0                                     04310018
043200                 ADD +1           TO PV-UPDATE-COUNT              04320018
043300             WHEN SQLCODE = -904                                  04330018
043400             WHEN SQLCODE = -913                                  04340018
043500             WHEN SQLCODE = +100                                  04350018
043600                 CONTINUE                                         04360018
043700             WHEN SQLCODE < 0                                     04370018
043800             WHEN SQLCODE > 0                                     04380018
043900             WHEN SQLWARN0 = 'W'                                  04390018
044000                 MOVE '8100-UPDATE-AUDIT-RECD-REC'                04400018
044100                             TO PV-PARAGRAPH-NAME                 04410018
044200                 MOVE 'DELETE OF TAURECD'                         04420018
044300                             TO PV-DB2-OPERATION-ATTEMPTED        04430018
044400                 PERFORM 9100-SQL-ABEND                           04440018
044500         END-EVALUATE                                             04450018
044600     END-PERFORM.                                                 04460018
044700                                                                  04470018
044800     IF PV-UPDATE-COUNTER > PC-MAX-RETRIES                        04480018
044900         MOVE '8100-UPDATE-AUDIT-RECD-REC'                        04490018
045000             TO PV-PARAGRAPH-NAME                                 04500018
045100         MOVE 'DEADLOCK * UPDATE TAURECD'                         04510018
045200             TO PV-DB2-OPERATION-ATTEMPTED                        04520018
045300         PERFORM 9100-SQL-ABEND                                   04530018
045400     END-IF.                                                      04540018
045500                                                                  04550018
045600 9000-EOJ-ROUTINE.                                                04560018
045700******************************************************************04570018
045800*  CLOSE OUTPUT FILE.  CLOSE THE CURSOR.                          04580018
045900******************************************************************04590018
046000     CLOSE TIMESTAMP-FILE.                                        04600018
046100     DISPLAY 'TOTAL RECORDS UPDATED: '  PV-UPDATE-COUNT.          04610018
046200     DISPLAY 'TOTAL RECORDS DELETED: '  PV-DELETE-COUNT.          04620018
046300     PERFORM WITH TEST AFTER                                      04630018
046400       VARYING PV-CLOSE-COUNTER FROM 1 BY 1                       04640018
046500         UNTIL (PV-CLOSE-COUNTER > PC-MAX-RETRIES                 04650018
046600                OR                                                04660018
046700                SQLCODE = ZERO)                                   04670018
046800                                                                  04680018
046900         EXEC SQL                                                 04690018
047000              CLOSE AUDIT_RECD_CURSOR                             04700018
047100         END-EXEC                                                 04710018
047200                                                                  04720018
047300         EVALUATE TRUE                                            04730018
047400             WHEN SQLCODE = -904                                  04740018
047500             WHEN SQLCODE = -911                                  04750018
047600                 CONTINUE                                         04760018
047700             WHEN SQLWARN0 NOT = SPACES                           04770018
047800             WHEN SQLCODE < ZERO                                  04780018
047900             WHEN SQLCODE > ZERO                                  04790018
048000                 MOVE '9000-EOJ-ROUTINE               '           04800018
048100                                 TO PV-PARAGRAPH-NAME             04810018
048200                 MOVE 'CLOSE THE AUDIT_RECD_CURSOR    '           04820018
048300                                 TO PV-DB2-OPERATION-ATTEMPTED    04830018
048400                 PERFORM 9100-SQL-ABEND                           04840018
048500             WHEN SQLCODE = ZERO                                  04850018
048600                 CONTINUE                                         04860018
048700         END-EVALUATE                                             04870018
048800     END-PERFORM.                                                 04880018
048900                                                                  04890018
049000     IF PV-CLOSE-COUNTER > PC-MAX-RETRIES                         04900018
049100         MOVE '9000-EOJ-ROUTINE               '                   04910018
049200                                 TO PV-PARAGRAPH-NAME             04920018
049300         MOVE 'CLOSE MAX RETRIES EXCEEDED     '                   04930018
049400                                 TO PV-DB2-OPERATION-ATTEMPTED    04940018
049500         PERFORM 9100-SQL-ABEND                                   04950018
049600     END-IF.                                                      04960018
049700*9000-EXIT.                                                       04970018
049800*                                                                 04980018
049900*                                                                 04990018
050000 9100-SQL-ABEND.                                                  05000018
050100******************************************************************05010018
050200*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05020018
050300*  ERROR OR WARNING CODE OCCURS.                                  05030018
050400******************************************************************05040018
050500     DISPLAY '9100-SQL-ABEND'.                                    05050018
050600     DISPLAY '** ABEND     **'.                                   05060018
050700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        05070018
050800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05080018
050900     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     05090018
051000     DISPLAY '***'                                                05100018
051100     DISPLAY '*** LAST COMMIT TAKEN **' PV-COMMIT-INFO            05110018
051200     DISPLAY '***'                                                05120018
051300     DISPLAY '*** COMMITTED DELETE COUNTS FOLLOW: ***'            05130018
051400     DISPLAY '***'                                                05140018
           MOVE SQLCA TO PV-SQLCA                                       05141021
051500     EXEC SQL                                                     05150018
051600          ROLLBACK                                                05160018
051700     END-EXEC.                                                    05170018
           MOVE PV-SQLCA TO SQLCA                                       05171021
051800******************************************************************05180018
051900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    05190018
052000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         05200018
052100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     05210018
052200* FORMAT.                                                         05220018
052300******************************************************************05230018
052400     COPY DPPD004.                                                05240021
052500                                                                  05250018
052600     MOVE +4013                  TO ABEND-CODE.                   05260018
052700     CALL 'ILBOABN0' USING ABEND-CODE.                            05270018
052800*9100-EXIT.                                                       05280018
052900*9100-SQL-ABEND.                                                  05290018
053000******************************************************************05300018
053100*  ABEND ON DB2 ERROR.                                            05310018
053200******************************************************************05320018
053300*    MOVE SQLCODE                    TO SQLCODE2.                 05330018
053400*    MOVE SQLERRD(3)                 TO SQLERRD3.                 05340018
053500*                                                                 05350018
053600*    DISPLAY '** ABEND          **  IN RCKUT037'.                 05360018
053700*    DISPLAY '** SQLERROR       **'.                              05370018
053800*    DISPLAY '** SQLCODE        ** ' SQLCODE2.                    05380018
053900*    DISPLAY '** ROWS PROCESSED ** ' SQLERRD3.                    05390018
054000*    DISPLAY '** SQLERRM        ** ' SQLERRM.                     05400018
054100*    DISPLAY '** SQLERRMC       ** ' SQLERRMC.                    05410018
054200*                                                                 05420018
054300*    EXEC SQL                                                     05430018
054400*         ROLLBACK                                                05440018
054500*    END-EXEC.                                                    05450018
054600*                                                                 05460018
054700*    MOVE 4013                       TO ABEND-CODE.               05470018
054800*    CALL 'ILBOABN0' USING ABEND-CODE.                            05480018
054900*                                                                 05490018
055000*                                                                 05500018
