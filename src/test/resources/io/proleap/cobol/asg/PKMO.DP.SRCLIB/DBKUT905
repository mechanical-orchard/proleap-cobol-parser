       IDENTIFICATION DIVISION.                                         00010001
                                                                        00020001
       PROGRAM-ID.             DBKUT905.                                00030001
       AUTHOR.                 SIDNEY CHAN.                             00040001
       INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050001
       DATE-WRITTEN.           01-05-1993.                              00060001
       DATE-COMPILED.                                                   00070001
                                                                        00080001
       ENVIRONMENT DIVISION.                                            00090001
                                                                        00100001
       CONFIGURATION SECTION.                                           00110001
                                                                        00120001
       SOURCE-COMPUTER.    IBM.                                         00130001
       OBJECT-COMPUTER.    IBM.                                         00140001
                                                                        00150001
       INPUT-OUTPUT SECTION.                                            00160001
                                                                        00170001
       FILE-CONTROL.                                                    00180001
                                                                        00190001
           SELECT MODIFY-AGE-CTLCD                                      00200001
               ASSIGN TO INP01.                                         00210001
                                                                        00220001
           SELECT PKMO-MODIFY-CONTROL-FILE                              00230001
               ASSIGN TO OUT01.                                         00240001
                                                                        00250001
                                                                        00260001
       DATA DIVISION.                                                   00270001
                                                                        00280001
       FILE SECTION.                                                    00290001
       FD  MODIFY-AGE-CTLCD                                             00300001
           RECORDING MODE IS F                                          00310001
           BLOCK CONTAINS 0 RECORDS.                                    00320001
                                                                        00330001
       01  MODIFY-AGE-CTLCD-RECORD       PIC X(80).                     00340001
                                                                        00350001
       FD  PKMO-MODIFY-CONTROL-FILE                                     00360001
           RECORDING MODE IS F                                          00370001
           BLOCK CONTAINS 0 RECORDS.                                    00380001
                                                                        00390001
       01  PKMO-MODIFY-CONTROL-RECORD    PIC X(80).                     00400001
                                                                        00410001
                                                                        00420001
       WORKING-STORAGE SECTION.                                         00430001
                                                                        00440001
       01  ABEND-CODE                    PIC S9(04)  VALUE ZERO COMP.   00450001
                                                                        00460001
       01  WS-LOCAL-SERVER               PIC X(16)   VALUE SPACES.      00470001
                                                                        00480001
       01  WS-LOCAL-SERVER-BREAKOUT.                                    00490001
           05  FILLER                    PIC X(03) VALUE SPACES.        00500001
           05  WS-SUBSYS-ENV             PIC X(01) VALUE SPACES.        00510001
               88 PROD-SUBSYSTEM         VALUE 'P'.                     00520001
               88 TEST-SUBSYSTEM         VALUE 'T'.                     00530001
           05  FILLER                    PIC X(12) VALUE SPACES.        00540001
                                                                        00550001
       01  WS-MODIFY-AGE-CTLCD-RECORD.                                  00560001
           05  WS-MODIFY-AGE-CHAR        PIC XX    VALUE SPACES.        00570001
           05  FILLER                    PIC X(78) VALUE SPACES.        00581007
                                                                        00590001
       01  WS-PKMO-MODIFY-CONTROL-RECORD PIC X(80).                     00600001
                                                                        00610001
       01  WS-WORKING-STORAGE.                                          00620001
           05  WS-MODIFY-AGE             PIC S9(4) COMP VALUE 0.        00630001
           05  WS-NO-MORE-ROWS-SWITCH    PIC X(01) VALUE 'N'.           00640001
               88  WS-NO-MORE-ROWS       VALUE 'Y'.                     00650001
           05  WS-SYSCOPY-COUNT          PIC S9(9) COMP.                00660001
           05  WS-NOCOPYPEND-PARM        PIC X(10) VALUE SPACES.        00661008
           05  WS-DUMMY-VALUE            PIC X(01) VALUE SPACE.         00661111
                                                                        00661207
       01  DP004-DB2-ERROR-FIELDS.                                      00662007
           05  DP004-ASTERISK-LINE       PIC  X(80)  VALUE ALL '*'.     00663007
           05  DP004-MAX-MESSAGE-LINES   PIC S9(04)  VALUE +12          00664007
                                                     COMP SYNC.         00665007
           05  DP004-ERROR-LINE-LENGTH   PIC S9(09)  VALUE +75          00666007
                                                     COMP SYNC.         00667007
           05  DP004-FORMATTED-MESSAGE.                                 00740001
               10  FILLER                PIC S9(04)  VALUE +900         00750001
                                                     COMP SYNC.         00760001
               10  DP004-MESSAGE-LINE    OCCURS 12 TIMES                00770001
                                         INDEXED BY DP004-MSG-IDX       00780001
                                         PIC  X(75).                    00790001
                                                                        00800001
           EXEC SQL                                                     00810001
               INCLUDE SYSCOPY                                          00820001
           END-EXEC.                                                    00830001
                                                                        00840001
           EXEC SQL                                                     00850001
               DECLARE SYSCOPY_CURSOR CURSOR FOR                        00860001
                SELECT DISTINCT DBNAME,TSNAME                           00870001
                  FROM SYSIBM.SYSCOPY                                   00880001
                    WHERE OTYPE = 'T'                                   00890001
                WITH UR                                                 00900001
           END-EXEC.                                                    00910001
                                                                        00920001
           EXEC SQL                                                     00930001
               INCLUDE SQLCA                                            00940001
           END-EXEC.                                                    00950001
                                                                        00960001
                                                                        00970001
       PROCEDURE DIVISION.                                              00980001
                                                                        00990001
       0000-PROGRAM-MAINLINE SECTION.                                   01000001
                                                                        01010001
           PERFORM 1000-INITIALIZATION.                                 01020001
                                                                        01030001
           PERFORM 2000-OPEN-SYSCOPY-CSR.                               01040001
                                                                        01050001
           PERFORM 3000-FETCH-SYSCOPY                                   01060001
               UNTIL WS-NO-MORE-ROWS.                                   01070001
                                                                        01080001
           PERFORM 4000-FINAL-PROCESSING.                               01090001
                                                                        01100001
           GOBACK.                                                      01110001
                                                                        01120001
                                                                        01130001
       1000-INITIALIZATION.                                             01140001
      ***************************************************************** 01150001
      *** - OPEN FILES                                              *** 01160001
      *** - READ MODIFY AGE CONTROL CARD                            *** 01170001
      *** - GET DB2 SUBSYSTEM                                       *** 01180001
      ***************************************************************** 01190001
                                                                        01200001
           OPEN INPUT MODIFY-AGE-CTLCD                                  01210001
                OUTPUT PKMO-MODIFY-CONTROL-FILE.                        01220001
                                                                        01230001
           READ MODIFY-AGE-CTLCD INTO WS-MODIFY-AGE-CTLCD-RECORD        01240001
               AT END                                                   01250001
                   DISPLAY '** ABEND **         **'                     01260001
                   DISPLAY '** PROGRAM          ** = DBKUT905'          01270001
                   DISPLAY                                              01280001
                   '** PARAGRAPH NAME   ** = 1000-INITIALIZATION'       01290001
                   DISPLAY '** REASON           ** EMPTY INPUT CTLCD'   01300001
                   PERFORM 9999-ABEND.                                  01310001
                                                                        01320001
           IF WS-MODIFY-AGE-CHAR IS NUMERIC                             01330001
               MOVE WS-MODIFY-AGE-CHAR TO WS-MODIFY-AGE                 01340001
           ELSE                                                         01411002
               DISPLAY '** ABEND **         **'                         01412002
               DISPLAY '** PROGRAM          ** = DBKUT905'              01413002
               DISPLAY                                                  01414002
               '** PARAGRAPH NAME   ** = 1000-INITIALIZATION'           01415002
               DISPLAY '** REASON           ** INVALID AGE VALUE'       01416002
               PERFORM 9999-ABEND                                       01417002
           END-IF.                                                      01420001
                                                                        01430001
           CLOSE MODIFY-AGE-CTLCD.                                      01440001
                                                                        01450001
           EXEC SQL                                                     01460001
               SELECT CURRENT SERVER INTO :WS-LOCAL-SERVER              01470001
                   FROM SYSIBM.SYSDUMMY1 WITH UR                        01480001
           END-EXEC.                                                    01490001
                                                                        01500001
           IF SQLCODE = ZERO                                            01510001
             MOVE WS-LOCAL-SERVER TO WS-LOCAL-SERVER-BREAKOUT           01520001
           ELSE                                                         01530001
              DISPLAY '** ABEND **         **'                          01540001
              DISPLAY '** PROGRAM          ** = DBKUT905'               01550001
              DISPLAY                                                   01560001
                  '** PARAGRAPH NAME   ** = 1000-INITIALIZATION'        01570001
              DISPLAY                                                   01580001
                  '** DB2 OPERATION    ** = SELECT CURRENT SERVER'      01590001
              PERFORM 9000-SQL-ABEND                                    01600001
           END-IF.                                                      01610001
                                                                        01620001
           IF PROD-SUBSYSTEM OR TEST-SUBSYSTEM                          01630001
               CONTINUE                                                 01640001
           ELSE                                                         01650001
               DISPLAY '** ABEND **         **'                         01660001
               DISPLAY '** PROGRAM          ** = DBKUT905'              01670001
               DISPLAY                                                  01680001
               '** PARAGRAPH NAME   ** = 1000-INITIALIZATION'           01690001
               DISPLAY                                                  01700001
               '** REASON           ** INVALID DB2 SUBSYSTEM'           01710001
               DISPLAY WS-LOCAL-SERVER-BREAKOUT                         01720001
               PERFORM 9999-ABEND                                       01730001
           END-IF.                                                      01740001
                                                                        01750001
           IF TEST-SUBSYSTEM                                            01751007
               MOVE 'NOCOPYPEND' TO WS-NOCOPYPEND-PARM                  01751108
           END-IF.                                                      01751207
                                                                        01752007
                                                                        01760001
       2000-OPEN-SYSCOPY-CSR.                                           01770001
      ***************************************************************** 01780001
      *** - OPEN SYSCOPY_CURSOR                                     *** 01790001
      ***************************************************************** 01800001
                                                                        01810001
           EXEC SQL                                                     01820001
               OPEN SYSCOPY_CURSOR                                      01830001
           END-EXEC.                                                    01840001
                                                                        01850001
           IF  SQLCODE NOT = ZERO                                       01860001
               DISPLAY '** ABEND **         **'                         01870001
               DISPLAY '** PROGRAM          ** = DBKUT905'              01880001
               DISPLAY '** PARAGRAPH NAME   ** = 2000-OPEN-SYSCOPY-CSR' 01890001
               DISPLAY '** DB2 OPERATION    ** = OPEN SYSCOPY_CURSOR'   01900001
               PERFORM 9000-SQL-ABEND.                                  01910001
                                                                        01920001
                                                                        01930001
       3000-FETCH-SYSCOPY.                                              01940001
      ***************************************************************** 01950001
      *** - FETCH ROW FROM SYSCOPY_CURSOR                           *** 01960001
      *** - BRANCH TO PROCESSING BASED ON TEST OR PROD SUBSYSTEM    *** 01970001
      ***************************************************************** 01980001
                                                                        01990001
           EXEC SQL                                                     02000001
               FETCH SYSCOPY_CURSOR                                     02010001
               INTO  :SYSCOPY-DBNAME                                    02020001
                    ,:SYSCOPY-TSNAME                                    02030001
           END-EXEC.                                                    02040001
                                                                        02050001
           IF SQLCODE = +100                                            02060001
               MOVE 'Y' TO WS-NO-MORE-ROWS-SWITCH                       02070001
           ELSE                                                         02080001
               IF SQLCODE = ZERO                                        02090001
                   IF PROD-SUBSYSTEM                                    02100001
                       PERFORM 3100-PROD-CHECK                          02110001
                   ELSE                                                 02120001
                       PERFORM 3200-WRITE-MODIFY-STMTS                  02130001
                   END-IF                                               02150001
               ELSE                                                     02160001
                   DISPLAY '** ABEND **         **'                     02170001
                   DISPLAY '** PROGRAM          ** = DBKUT905'          02180001
                   DISPLAY '** PARAGRAPH NAME   ** = 3000-FETCH-SYSCOPY'02190001
                   DISPLAY                                              02200001
                         '** DB2 OPERATION    ** = FETCH SYSCOPY-CURSOR'02210001
                   PERFORM 9000-SQL-ABEND                               02220001
               END-IF                                                   02230001
           END-IF.                                                      02240001
                                                                        02251007
                                                                        02252007
       3100-PROD-CHECK.                                                 02260001
      ***************************************************************** 02270001
      ***                                                           *** 02270107
      *** - FOR THE DATABASE.TABLESPACE BEING PROCESSED CHECK IF A  *** 02271007
      ***   ROW EXISTS ON DBT_MODIFY_UTIL_XCP.  ENTRIES IN THIS     *** 02272007
      ***   TABLE REPRESENT OBJECTS THAT ARE TYPICALLY NOT BEING    *** 02273007
      ***   COPIED BUT HAVE SYSCOPY ROWS THAT SHOULD BE CLEANED UP. *** 02273107
      ***   THESE ARE TYPICALLY OBJECTS THAT ARE LOADED WITH        *** 02273207
      ***   NOCOPYPEND OR ARE MASS-DELETED.  MODIFY STATEMENTS      *** 02273309
      ***   WITH NOCOPYPEND WILL BE GENERATED FOR THESE OBJECTS.    *** 02273409
      ***                                                           *** 02273509
      *** - IF NOT FOUND ON DBT_MODIFY_UTIL_XCP VERIFY THAT AT      *** 02280007
      ***   LEAST ONE SYSCOPY ROW WITH ICTYPE = 'F' (FULL IMAGE     *** 02281007
      ***   COPY) OR 'R' (LOAD REPLACE LOG YES) WILL EXIST          *** 02290007
      ***   FOLLOWING DELETION OF ANY ROWS BY THE MODIFY UTILITY.   *** 02300007
      ***   THIS IS TO PREVENT A TABLE SPACE FROM BEING PLACED IN   *** 02330001
      ***   COPY-PENDING STATUS.                                    *** 02340001
      ***                                                           *** 02342007
      ***************************************************************** 02350001
                                                                        02360001
           PERFORM 3105-CHECK-XCP-TABLE.                                02361007
                                                                        02362007
           IF WS-NOCOPYPEND-PARM EQUAL SPACES                           02363008
               PERFORM 3110-CHECK-SYSCOPY-COUNT                         02364007
           END-IF.                                                      02365007
                                                                        02366007
                                                                        02367007
       3105-CHECK-XCP-TABLE.                                            02671007
                                                                        02672007
           EXEC SQL                                                     02672107
               SELECT '1'                                               02672207
                 INTO :WS-DUMMY-VALUE                                   02672307
                   FROM DBT_MODIFY_UTIL_XCP                             02672407
                     WHERE DBNAME = :SYSCOPY-DBNAME                     02672507
                       AND TSNAME = :SYSCOPY-TSNAME                     02672607
               WITH UR                                                  02673307
           END-EXEC.                                                    02673407
                                                                        02673507
           IF SQLCODE = ZERO                                            02673607
               MOVE 'NOCOPYPEND' TO WS-NOCOPYPEND-PARM                  02673708
               PERFORM 3200-WRITE-MODIFY-STMTS                          02673807
           ELSE                                                         02674007
               IF SQLCODE = +100                                        02674107
                   MOVE ' ' TO WS-NOCOPYPEND-PARM                       02674208
               ELSE                                                     02674407
                   DISPLAY '** ABEND **         **'                     02674507
                   DISPLAY '** PROGRAM          ** = DBKUT905'          02674607
                   DISPLAY                                              02674707
                   '** PARAGRAPH NAME   ** = 3105-CHECK-XCP-TABLE   **' 02674807
                   DISPLAY '** DB2 OPERATION    ** = SELECT 1'          02674910
                   PERFORM 9000-SQL-ABEND                               02675007
           END-IF.                                                      02675107
                                                                        02675207
                                                                        02675407
       3110-CHECK-SYSCOPY-COUNT.                                        02675507
                                                                        02675607
           EXEC SQL                                                     02675707
               SELECT COUNT(*)                                          02675807
                 INTO :WS-SYSCOPY-COUNT                                 02675907
                   FROM SYSIBM.SYSCOPY                                  02676007
                     WHERE DBNAME = :SYSCOPY-DBNAME                     02676107
                       AND TSNAME = :SYSCOPY-TSNAME                     02676207
                       AND ICTYPE IN ('F','R')                          02676307
                       AND ICBACKUP = '  '                              02676407
                       AND TIMESTAMP >                                  02676507
                             TIMESTAMP(                                 02676607
                               CURRENT TIMESTAMP - :WS-MODIFY-AGE DAYS  02676707
                                       )                                02676807
               WITH UR                                                  02676907
           END-EXEC.                                                    02677007
                                                                        02677107
           IF SQLCODE = ZERO                                            02677207
               IF WS-SYSCOPY-COUNT = 0                                  02677307
                   CONTINUE                                             02677407
               ELSE                                                     02677507
                   PERFORM 3200-WRITE-MODIFY-STMTS                      02677607
               END-IF                                                   02677707
           ELSE                                                         02677807
               DISPLAY '** ABEND **         **'                         02677907
               DISPLAY '** PROGRAM          ** = DBKUT905'              02678007
               DISPLAY                                                  02678107
               '** PARAGRAPH NAME  ** = 3110-CHECK-SYSCOPY-COUNT **'    02678207
               DISPLAY '** DB2 OPERATION    ** = SELECT COUNT(*)'       02678307
               PERFORM 9000-SQL-ABEND                                   02678407
           END-IF.                                                      02678507
                                                                        02678607
                                                                        02679007
       3200-WRITE-MODIFY-STMTS.                                         02680001
      ***************************************************************** 02690001
      *** - WRITE MODIFY UTILITY STATEMENTS.                        *** 02700001
      ***************************************************************** 02710001
                                                                        02720001
           MOVE SPACES TO WS-PKMO-MODIFY-CONTROL-RECORD.                02811013
           STRING 'MODIFY RECOVERY TABLESPACE ' DELIMITED BY SIZE       02812007
                  SYSCOPY-DBNAME                DELIMITED BY SPACE      02813007
                  '.'                           DELIMITED BY SIZE       02814007
                  SYSCOPY-TSNAME                DELIMITED BY SIZE       02815007
               INTO WS-PKMO-MODIFY-CONTROL-RECORD.                      02818007
                                                                        02819002
           WRITE PKMO-MODIFY-CONTROL-RECORD                             02820001
               FROM WS-PKMO-MODIFY-CONTROL-RECORD.                      02830001
                                                                        02831012
           MOVE SPACES TO WS-PKMO-MODIFY-CONTROL-RECORD.                02832013
           STRING '  DSNUM ALL DELETE AGE '     DELIMITED BY SIZE       02836012
                  WS-MODIFY-AGE-CHAR            DELIMITED BY SIZE       02837012
                  ' '                           DELIMITED BY SIZE       02838012
                  WS-NOCOPYPEND-PARM            DELIMITED BY SIZE       02839012
               INTO WS-PKMO-MODIFY-CONTROL-RECORD.                      02839112
                                                                        02839212
           WRITE PKMO-MODIFY-CONTROL-RECORD                             02839312
               FROM WS-PKMO-MODIFY-CONTROL-RECORD.                      02839412
                                                                        02840001
                                                                        02850001
       4000-FINAL-PROCESSING.                                           03040001
                                                                        03050001
           EXEC SQL                                                     03060001
             CLOSE SYSCOPY_CURSOR                                       03070001
           END-EXEC.                                                    03080001
                                                                        03090001
           IF  SQLCODE = ZERO                                           03100001
               CONTINUE                                                 03110001
           ELSE                                                         03120001
               DISPLAY '** ABEND **         **'                         03130001
               DISPLAY '** PROGRAM          ** = DBKUT905'              03140001
               DISPLAY '** PARAGRAPH NAME   ** = 4000-FINAL-PROCESSING' 03150001
               DISPLAY '** DB2 OPERATION    ** = CLOSE SYSCOPY_CURSOR'  03160001
               PERFORM 9000-SQL-ABEND.                                  03170001
                                                                        03180001
           CLOSE PKMO-MODIFY-CONTROL-FILE.                              03190001
                                                                        03200001
                                                                        03210001
       9000-SQL-ABEND.                                                  03220001
                                                                        03230001
           CALL 'DSNTIAR' USING SQLCA                                   03240001
                                DP004-FORMATTED-MESSAGE                 03250001
                                DP004-ERROR-LINE-LENGTH.                03260001
                                                                        03270001
           DISPLAY DP004-ASTERISK-LINE.                                 03280001
           PERFORM                                                      03290001
               VARYING DP004-MSG-IDX                                    03300001
               FROM 1 BY 1                                              03310001
               UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES            03320001
                   DISPLAY '**'                                         03330001
                           DP004-MESSAGE-LINE (DP004-MSG-IDX)           03340001
                           ' **'                                        03350001
           END-PERFORM.                                                 03360001
           DISPLAY DP004-ASTERISK-LINE.                                 03370001
                                                                        03380001
           MOVE +4013 TO ABEND-CODE.                                    03390001
           CALL 'ILBOABN0' USING ABEND-CODE.                            03400001
                                                                        03410001
       9999-ABEND.                                                      03420001
                                                                        03430001
           MOVE +4003 TO ABEND-CODE.                                    03440001
           CALL 'ILBOABN0' USING ABEND-CODE.                            03450001
