000100*----------------------------------------------------------       00010035
000200 IDENTIFICATION DIVISION.                                         00020036
000300*----------------------------------------------------------       00030036
000400 PROGRAM-ID.    XSKUT032.                                         00040036
000500 AUTHOR.        JOSEPH MENYAH.                                    00050036
000600 DATE-WRITTEN.  OCTOBER , 2002.                                   00060036
000700                                                                  00070036
000800*----------------------------------------------------------       00080036
000900*            PRICING EXCLUSIONS EXTRACT                           00090036
001000*----------------------------------------------------------       00100036
001100* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00110036
001400* EXTRACT FOR THE PRICING BUSINESS EVENT.                         00140021
001500*                                                                 00150021
001600*----------------------------------------------------------       00160021
001700* HISTORY LOG:                                                    00170021
001800*                                                                 00180021
001900*----------------------------------------------------------       00190021
002000* DATE: 03/24/2005                                                00191047
002100* WR/IR#: WR#27895                                                00192045
002200* PROGRAMMER: SCOTT BARTELT                                       00193045
002300* DESCRIPTION: STYLE LEVEL PROMOTIONS AND EXCLUSIONS WILL         00194045
002310*   NO LONGER INCLUDE THE "PARENT" MERCHANDISE INFORMATION.       00195045
002320*   PRIOR TO THIS CHANGE, THE EXCLUSION RECORDS ALWAYS HAD        00196045
002330*   THE DEPARTMENT NUMBER NO MATTER WHAT HIERARCHY THE            00197045
002340*   EXCLUSION WAS AT.                                             00198045
002400*                                                                 00240021
002410* DATE: MM/DD/YYYY                                                00241046
002420* WR/IR#:                                                         00242046
002430* PROGRAMMER:                                                     00243046
002440* DESCRIPTION:                                                    00244046
002490*                                                                 00249046
002500*----------------------------------------------------------       00250021
002600 ENVIRONMENT DIVISION.                                            00260021
002700*----------------------------------------------------------       00270021
002800 CONFIGURATION SECTION.                                           00280021
002900 SOURCE-COMPUTER. IBM-3090.                                       00290021
003000 OBJECT-COMPUTER. IBM-3090.                                       00300021
003100                                                                  00310021
003200 INPUT-OUTPUT SECTION.                                            00320021
003300                                                                  00330021
003400 FILE-CONTROL.                                                    00340021
003500                                                                  00350021
003600     SELECT DATE-RANGE-FILE                                       00360021
003700       ASSIGN TO INP01.                                           00370037
003800                                                                  00380021
003900     SELECT TMST-FILE                                             00390021
004000       ASSIGN TO INP02.                                           00400037
004100                                                                  00410021
004200     SELECT EXTRACT-FILE                                          00420021
004300       ASSIGN TO OUT01.                                           00430037
004310                                                                  00431037
004400*----------------------------------------------------------       00440021
004500 DATA DIVISION.                                                   00450021
004600*----------------------------------------------------------       00460021
004700 FILE SECTION.                                                    00470021
004800                                                                  00480021
004900 FD  EXTRACT-FILE                                                 00490021
005000     RECORDING MODE IS F                                          00500021
005100     LABEL RECORDS ARE OMITTED                                    00510021
005200     RECORD CONTAINS 128 CHARACTERS                               00520021
005300     DATA RECORD IS EXCLUSION-REC.                                00530021
005400 01  EXCLUSION-REC                             PIC  X(128).       00540037
005500                                                                  00550021
005600 FD  DATE-RANGE-FILE                                              00560021
005700     RECORDING MODE IS F                                          00570021
005800     LABEL RECORDS ARE OMITTED                                    00580021
005900     RECORD CONTAINS 80 CHARACTERS                                00590021
006000     BLOCK CONTAINS 0 RECORDS.                                    00600021
006100 01  DATE-RANGE-LINE                           PIC  X(080).       00610037
006200                                                                  00620021
006300 FD  TMST-FILE                                                    00630021
006400     RECORDING MODE IS F                                          00640021
006500     LABEL RECORDS ARE OMITTED                                    00650021
006600     RECORD CONTAINS 80 CHARACTERS                                00660021
006700     BLOCK CONTAINS 0 RECORDS.                                    00670021
006800 01  TMST-LINE                                 PIC  X(080).       00680037
006900                                                                  00690021
007000*---------------------------------------------------------        00700021
007200 WORKING-STORAGE SECTION.                                         00720021
007201*---------------------------------------------------------        00720137
007210                                                                  00721037
007211*----------------------------------------------------------       00721137
007212* AB- ABEND CODES                                                 00721237
007213*----------------------------------------------------------       00721337
007214 01  AB-ABEND-CODE                             PIC S9(004)        00721437
007215                                                VALUE ZERO        00721537
007216                                                COMP SYNC.        00721637
007217                                                                  00721737
007220*----------------------------------------------------------       00722037
007230* CC- CONTROL CARD FILE LAYOUTS.                                  00723037
007240*----------------------------------------------------------       00724037
007250 01  CC-DATE-RANGE-FILE.                                          00725037
007260   05  CC-START-DATE                           PIC  X(010).       00726037
007270   05  FILLER                                  PIC  X(001).       00727037
007280   05  CC-END-DATE                             PIC  X(010).       00728037
007290                                                                  00729037
007291 01  CC-TMST-FILE.                                                00729137
007292   05  CC-LAST-UPD-TMST                        PIC  X(019).       00729237
007293                                                                  00729337
007300*---------------------------------------------------------        00730021
007400* PC- PROGRAM CONSTANTS                                           00740021
007500*----------------------------------------------------------       00750021
007600 01  PC-PROGRAM-CONSTANTS.                                        00760021
007700   05  PC-PROGRAM-NAME                         PIC  X(008)        00770037
007710         VALUE 'XSKUT032'.                                        00771037
007800   05  PC-MAX-RETRIES                          PIC S9(004)        00780037
007810                                                VALUE +5          00781037
007820                                                COMP.             00782037
007900                                                                  00790021
008000*----------------------------------------------------------       00800021
008100* PS- PROGRAM SWITCHES                                            00810021
008200*----------------------------------------------------------       00820021
008300 01  PS-PROGRAM-SWITCHES.                                         00830021
008400   05  PS-EOF-EXTRACT-SW                       PIC  X(001)        00840037
008410                                                VALUE SPACE.      00841037
008500     88  PS-EOF-EXTRACT                         VALUE 'Y'.        00850037
008600     88  PS-NOT-EOF-EXTRACT                     VALUE 'N'.        00860037
008700   05  PS-DATE-RANGE-FILE-SW                   PIC  X(001)        00870037
008710                                                VALUE 'N'.        00871037
008800     88  PS-DATE-RANGE-FILE-END                 VALUE 'Y'.        00880037
008900     88  PS-DATE-RANGE-FILE-START               VALUE 'N'.        00890037
009000   05  PS-TMST-FILE-SW                         PIC  X(001)        00900037
009010                                                VALUE 'N'.        00901037
009100     88  PS-TMST-FILE-END                       VALUE 'Y'.        00910037
009200     88  PS-TMST-FILE-START                     VALUE 'N'.        00920037
009400   05  PS-EOF-EXCLUDE-SW                       PIC  X(001)        00940037
009410                                                VALUE SPACE.      00941037
009500     88  PS-EOF-EXCLUDE                         VALUE 'Y'.        00950037
009600     88  PS-NOT-EOF-EXCLUDE                     VALUE 'N'.        00960037
009800                                                                  00980037
009810*----------------------------------------------------------       00981021
009900* PV- PROGRAM VARIABLES                                           00990021
010000*----------------------------------------------------------       01000021
010900 01  PV-PROGRAM-VARIABLES.                                        01090037
011000   05  PV-RECORD-COUNT                         PIC  9(010)        01100037
011100                                                VALUE ZEROS.      01110037
011200   05  PV-SQL-SUB                              PIC S9(004)        01120037
011210                                                VALUE +0          01121037
011220                                                COMP.             01122037
013710   05  PV-PARAGRAPH-NAME                       PIC  X(030)        01371042
013720                                                VALUE SPACE.      01372042
013730   05  PV-DB2-OPERATION                        PIC  X(030)        01373042
013740                                                VALUE SPACE.      01374042
013900   05  PV-OPERATION-MSG-1                      PIC  X(040)        01390037
013910                                                VALUE SPACES.     01391037
013920   05  PV-OPERATION-MSG-2                      PIC  X(040)        01392042
013930                                                VALUE SPACES.     01393042
014100   05  PV-NULLS-INDICATORS.                                       01410037
014200     10  PV-DEPT-NBR-IND                       PIC S9(004)        01420037
014210                                                VALUE +0          01421037
014220                                                COMP.             01422037
014300     10  PV-MAJ-CL-NBR-IND                     PIC S9(004)        01430037
014310                                                VALUE +0          01431037
014320                                                COMP.             01432037
014400     10  PV-SUB-CL-NBR-IND                     PIC S9(004)        01440037
014410                                                VALUE +0          01441037
014420                                                COMP.             01442037
014500     10  PV-STYL-ID-IND                        PIC S9(004)        01450037
014510                                                VALUE +0          01451037
014520                                                COMP.             01452037
014600     10  PV-SKU-NBR-IND                        PIC S9(004)        01460037
014610                                                VALUE +0          01461037
014620                                                COMP.             01462037
014800   05  PV-TOTAL-RECORD.                                           01480037
014900     10  PV-BUSINESS-EVNT-ID                   PIC  9(003)        01490037
014910                                                VALUE ZEROS.      01491037
015000     10  PV-ACTION-CDE                         PIC  X(001)        01500037
015010                                                VALUE 'T'.        01501037
015100     10  PV-TOTAL-NBR-OF-RECS                  PIC  9(011)        01510037
015101                                                VALUE ZEROS.      01510137
015110                                                                  01511037
015200*----------------------------------------------------------       01520021
015300* PRICING EXCLUSION EVENT RECORD LAYOUT                           01530021
015400*----------------------------------------------------------       01540021
015500     COPY XSRD021.                                                01550021
015600                                                                  01560021
015610*----------------------------------------------------------       01561037
015800*  DB2 TABLE XST00026(XST_PROMO) - PROMOTION TABLE                01580021
015810*----------------------------------------------------------       01581037
016000     EXEC SQL                                                     01600021
016100       INCLUDE XST00026                                           01610037
016200     END-EXEC.                                                    01620021
016300                                                                  01630021
016310*----------------------------------------------------------       01631037
016500*  DB2 TABLE XST00028(XST_MDSE_LNE_SELN) -                        01650021
016510*----------------------------------------------------------       01651037
016700     EXEC SQL                                                     01670021
016800       INCLUDE XST00028                                           01680037
016900     END-EXEC.                                                    01690021
017000                                                                  01700021
017010*----------------------------------------------------------       01701037
017200*  DB2 TABLE XST00034(XST_EXCL_MDSE) - PRICING EXCLUSION          01720021
017210*----------------------------------------------------------       01721037
017400     EXEC SQL                                                     01740021
017500       INCLUDE XST00034                                           01750037
017600     END-EXEC.                                                    01760021
017700                                                                  01770021
017710*---------------------------------------------                    01771037
017720*  DB2 COMMUNICATION AREA.                                        01772037
017730*---------------------------------------------                    01773037
017740     EXEC SQL                                                     01774037
017750       INCLUDE SQLCA                                              01775037
017760     END-EXEC.                                                    01776037
017770                                                                  01777037
017800*----------------------------------------------------------       01780021
017900* DATE ROUTINE COPY MEMBERS                                       01790021
018000*----------------------------------------------------------       01800021
018100     COPY DPWS500.                                                01810021
018200                                                                  01820021
018300*----------------------------------------------------------       01830021
018400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01840021
018500*----------------------------------------------------------       01850021
018600     COPY DPWS004.                                                01860021
018700                                                                  01870021
019420*----------------------------------------------------------       01942037
019430* DB2 MESSAGE AREA                                                01943037
019440*----------------------------------------------------------       01944037
019500     COPY SQLCA2.                                                 01950021
019510                                                                  01951037
019520*----------------------------------------------------------       01952037
019700* EXTRACT CURSOR                                                  01970037
019710*----------------------------------------------------------       01971037
019900     EXEC SQL                                                     01990021
020000       DECLARE EXTRACT CURSOR FOR                                 02000021
020100         SELECT A.PROMO_INTFC_ID                                  02010037
020200               ,A.MDSE_LNE_ID                                     02020037
020300         FROM XST_MDSE_LNE_SELN  A                                02030037
020400             ,XST_PROMO          B                                02040037
020500         WHERE A.PROMO_ID              = B.PROMO_ID               02050037
020600           AND DATE(B.DFLT_END_TMST)  >= :CC-START-DATE           02060037
020800           AND DATE(B.DFLT_STRT_TMST) <= :CC-END-DATE             02080037
020910           AND B.SOR_LAST_UPD_TMST    <= :CC-LAST-UPD-TMST        02091037
021000       WITH UR                                                    02100037
021100     END-EXEC.                                                    02110021
021200                                                                  02120021
021210*----------------------------------------------------------       02121037
021400* EXCLUDE CURSOR                                                  02140037
021410*----------------------------------------------------------       02141037
021600     EXEC SQL                                                     02160021
021700       DECLARE EXCLUDE CURSOR FOR                                 02170021
021800         SELECT PROMO_INTFC_ID                                    02180037
021810               ,PROMO_INTFC_SUB_ID                                02181037
021900               ,MDSE_LNE_ID                                       02190037
022000               ,EXCL_MDSE_ID                                      02200037
022100               ,MAJ_CL_NBR                                        02210037
022200               ,SUB_CL_NBR                                        02220037
022300               ,STYL_ID                                           02230037
022400               ,SKU_NBR                                           02240037
022500               ,MDSE_HIER_CDE                                     02250037
022600               ,STAT_CDE                                          02260037
022700               ,DEPT_NBR                                          02270037
022800               ,SOR_LAST_UPD_TMST                                 02280037
022900         FROM XST_EXCL_MDSE                                       02290037
023000         WHERE PROMO_INTFC_ID = :XST00028-PROMO-INTFC-ID          02300037
023100           AND MDSE_LNE_ID    = :XST00028-MDSE-LNE-ID             02310037
023300       WITH UR                                                    02330037
023400     END-EXEC.                                                    02340021
023500                                                                  02350021
023600*----------------------------------------------------------       02360021
023700 PROCEDURE DIVISION.                                              02370021
023800*----------------------------------------------------------       02380021
023900 0000-MAINLINE.                                                   02390021
024000                                                                  02400021
024100     PERFORM 1000-INITIALIZATION.                                 02410021
024200                                                                  02420021
024300     PERFORM 2000-EXTRACT-DATA.                                   02430039
024500                                                                  02450021
024800     PERFORM 9999-WRAPUP.                                         02480021
024900                                                                  02490021
025000     GOBACK.                                                      02500021
025100                                                                  02510021
025200*0000-EXIT.                                                       02520021
025300 EJECT.                                                           02530021
025400                                                                  02540021
025500*----------------------------------------------------------       02550021
025600* 1000-INITIALIZATION.                                            02560021
025700*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            02570021
025800*     UPDATE OR INSERT A RECORD.                                  02580021
025900*----------------------------------------------------------       02590021
026000 1000-INITIALIZATION.                                             02600021
026100                                                                  02610021
026500     OPEN INPUT DATE-RANGE-FILE                                   02650021
026600                TMST-FILE.                                        02660037
026610                                                                  02661037
026700     OPEN OUTPUT EXTRACT-FILE.                                    02670037
026900                                                                  02690021
027000     PERFORM 1100-COMPUTE-STRT-DTE.                               02700039
027200                                                                  02720021
027700     INITIALIZE DCLXST00028.                                      02770021
027800     INITIALIZE DCLXST00026.                                      02780021
027900     INITIALIZE DCLXST00034.                                      02790021
028000                                                                  02800021
028100*1000-EXIT.                                                       02810037
028200 EJECT.                                                           02820021
028300                                                                  02830021
028310*----------------------------------------------------------       02831040
028320* 1100-COMPUTE-STRT-DTE.                                          02832041
028330*----------------------------------------------------------       02833041
028340 1100-COMPUTE-STRT-DTE.                                           02834041
028350                                                                  02835041
028360     READ DATE-RANGE-FILE INTO CC-DATE-RANGE-FILE                 02836041
028370       AT END                                                     02837041
028380         SET PS-DATE-RANGE-FILE-END TO TRUE                       02838041
028390     END-READ.                                                    02839041
028391                                                                  02839141
028392     IF PS-DATE-RANGE-FILE-END                                    02839241
028393       MOVE 'NO DATE RANGE FILE TO PROCESS'                       02839341
028394         TO PV-OPERATION-MSG-1                                    02839441
028395       PERFORM 9020-ABEND                                         02839541
028396     ELSE                                                         02839641
028397       DISPLAY 'CC-START-DATE = ' CC-START-DATE                   02839741
028398       DISPLAY 'CC-END-DATE   = ' CC-END-DATE                     02839841
028399     END-IF.                                                      02839941
028400                                                                  02840041
028401     READ TMST-FILE INTO CC-TMST-FILE                             02840141
028402       AT END                                                     02840241
028403         SET PS-TMST-FILE-END TO TRUE                             02840341
028404     END-READ.                                                    02840441
028405                                                                  02840541
028406     IF PS-TMST-FILE-END                                          02840641
028407       MOVE 'NO TMST FILE TO PROCESS'                             02840741
028408         TO PV-OPERATION-MSG-1                                    02840841
028409       PERFORM 9020-ABEND                                         02840941
028410     ELSE                                                         02841041
028411       DISPLAY 'CC-LAST-UPD-TMST = ' CC-LAST-UPD-TMST             02841141
028412     END-IF.                                                      02841241
028413                                                                  02841341
028414*1100-EXIT.                                                       02841441
028415 EJECT.                                                           02841541
028416                                                                  02841641
028460*----------------------------------------------------------       02846021
028500* 2000-EXTRACT-DATA.                                              02850021
029000*----------------------------------------------------------       02900021
029100 2000-EXTRACT-DATA.                                               02910021
029200                                                                  02920021
029201     PERFORM 2100-OPEN-EXTRACT-CSR.                               02920139
029202                                                                  02920239
029203     PERFORM                                                      02920339
029204       UNTIL PS-EOF-EXTRACT                                       02920439
029210                                                                  02921039
029300         PERFORM 2200-FETCH-EXTRACT                               02930039
029500                                                                  02950021
029600         IF PS-NOT-EOF-EXTRACT                                    02960039
029900           PERFORM 2300-OPEN-EXCLUDE-CSR                          02990039
030100                                                                  03010021
030200           IF PS-NOT-EOF-EXCLUDE                                  03020039
030210             PERFORM                                              03021039
030220               UNTIL PS-EOF-EXCLUDE                               03022039
030300                 PERFORM 2400-FETCH-EXCLUSION                     03030039
030410                 IF PS-NOT-EOF-EXCLUDE                            03041039
030500                   PERFORM 2500-FORMAT-EXTRACT-FILE               03050039
030510                   PERFORM 2600-WRITE-PRICING-EXTRCT              03051039
030520                 END-IF                                           03052039
030600             END-PERFORM                                          03060039
030610                                                                  03061039
030700             PERFORM 2700-CLOSE-EXCLUDE-CSR                       03070039
030900           END-IF                                                 03090039
031100         END-IF                                                   03110039
031110     END-PERFORM.                                                 03111039
031111                                                                  03111139
031120     PERFORM 2800-CLOSE-EXTRACT-CSR.                              03112039
031200                                                                  03120021
031300*2000-EXIT.                                                       03130021
031400 EJECT.                                                           03140021
031410                                                                  03141037
031420*----------------------------------------------------------       03142039
031430* 2100-OPEN-EXTRACT-CSR.                                          03143039
031440*----------------------------------------------------------       03144039
031450 2100-OPEN-EXTRACT-CSR.                                           03145039
031460                                                                  03146039
031470     PERFORM WITH TEST AFTER                                      03147039
031480       VARYING PV-SQL-SUB                                         03148039
031490       FROM 1 BY 1                                                03149039
031500       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   03150039
031600                   OR SQLCODE = +0)                               03160039
031700                                                                  03170039
031800         EXEC SQL                                                 03180039
031900           OPEN EXTRACT                                           03190039
032000         END-EXEC                                                 03200039
032100                                                                  03210039
032200         EVALUATE TRUE                                            03220039
032300           WHEN SQLCODE = -904                                    03230039
032400           WHEN SQLCODE = -911                                    03240039
032500           WHEN SQLCODE = -913                                    03250039
032501             CONTINUE                                             03250139
032510                                                                  03251039
032600           WHEN SQLCODE = +0                                      03260039
032710             SET PS-NOT-EOF-EXTRACT TO TRUE                       03271039
032800                                                                  03280039
032900           WHEN SQLWARN0 NOT EQUAL SPACE                          03290039
033000           WHEN SQLCODE NOT EQUAL ZERO                            03300039
033100             MOVE '2100-OPEN-EXTRACT-CSR'                         03310039
033200               TO PV-PARAGRAPH-NAME                               03320039
033300             MOVE 'ERROR ON OPEN OF EXTRACT CURSOR'               03330039
033400               TO PV-DB2-OPERATION                                03340039
033500             PERFORM 9010-SQL-ABEND-ROUTINE                       03350039
033600         END-EVALUATE                                             03360039
033700     END-PERFORM.                                                 03370039
033800                                                                  03380039
033900     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03390039
034000       MOVE '2100-OPEN-EXTRACT-CSR'                               03400039
034100         TO PV-PARAGRAPH-NAME                                     03410039
034200       MOVE 'OPEN RETRIES EXCEEDED'                               03420039
034300         TO PV-DB2-OPERATION                                      03430039
034400       PERFORM 9010-SQL-ABEND-ROUTINE                             03440039
034410     END-IF.                                                      03441039
034420                                                                  03442039
034430*2100-EXIT.                                                       03443039
034431 EJECT.                                                           03443139
034432                                                                  03443239
034440*----------------------------------------------------------       03444037
034451* 2200-FETCH-EXTRACT                                              03445139
034460*----------------------------------------------------------       03446037
035300 2200-FETCH-EXTRACT.                                              03530039
035400                                                                  03540021
035410     PERFORM WITH TEST AFTER                                      03541038
035420       VARYING PV-SQL-SUB FROM 1 BY 1                             03542038
035430       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   03543038
035440                 OR SQLCODE = +0                                  03544038
035450                 OR SQLCODE = +100)                               03545038
035460                                                                  03546038
035500         EXEC SQL                                                 03550038
035600           FETCH EXTRACT                                          03560038
035700             INTO :XST00028-PROMO-INTFC-ID                        03570038
035800                 ,:XST00028-MDSE-LNE-ID                           03580038
035900         END-EXEC                                                 03590038
035901                                                                  03590138
035910         EVALUATE TRUE                                            03591038
035920           WHEN SQLCODE = -904                                    03592038
035930           WHEN SQLCODE = -911                                    03593038
035940           WHEN SQLCODE = -913                                    03594038
035950           WHEN SQLCODE = +0                                      03595038
035960             CONTINUE                                             03596038
035961                                                                  03596138
035970           WHEN SQLCODE = +100                                    03597038
035990             SET PS-EOF-EXTRACT TO TRUE                           03599039
035991                                                                  03599138
035992           WHEN SQLWARN0 NOT EQUAL SPACE                          03599238
035993           WHEN SQLCODE NOT EQUAL ZERO                            03599338
035994             MOVE '2200-FETCH-EXTRACT'                            03599439
035996               TO PV-PARAGRAPH-NAME                               03599638
035997             MOVE 'ERROR ON FETCHING EXTRACT CURSOR'              03599738
035998               TO PV-DB2-OPERATION                                03599838
035999             PERFORM 9010-SQL-ABEND-ROUTINE                       03599938
036000         END-EVALUATE                                             03600038
036001     END-PERFORM.                                                 03600138
036002                                                                  03600238
036003     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03600338
036004       MOVE '2200-FETCH-EXTRACT'                                  03600439
036006         TO PV-PARAGRAPH-NAME                                     03600638
036007       MOVE 'FETCH RETRIES EXCEEDED'                              03600738
036008         TO PV-DB2-OPERATION                                      03600838
036009       PERFORM 9010-SQL-ABEND-ROUTINE                             03600938
036010     END-IF.                                                      03601038
037645                                                                  03764538
037646*2200-EXIT.                                                       03764639
037647 EJECT.                                                           03764737
037648                                                                  03764837
037649*----------------------------------------------------------       03764939
037650* 2300-OPEN-EXCLUDE-CSR.                                          03765039
037651*----------------------------------------------------------       03765139
037652 2300-OPEN-EXCLUDE-CSR.                                           03765239
037653                                                                  03765339
037654     PERFORM WITH TEST AFTER                                      03765439
037655       VARYING PV-SQL-SUB                                         03765539
037656       FROM 1 BY 1                                                03765639
037657       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   03765739
037658                   OR SQLCODE = +0)                               03765839
037659                                                                  03765939
037660         EXEC SQL                                                 03766039
037661           OPEN EXCLUDE                                           03766139
037662         END-EXEC                                                 03766239
037663                                                                  03766339
037664         EVALUATE TRUE                                            03766439
037665           WHEN SQLCODE = -904                                    03766539
037666           WHEN SQLCODE = -911                                    03766639
037667           WHEN SQLCODE = -913                                    03766739
037668             CONTINUE                                             03766839
037669                                                                  03766939
037670           WHEN SQLCODE = +0                                      03767039
037671             SET PS-NOT-EOF-EXCLUDE TO TRUE                       03767139
037672                                                                  03767239
037673           WHEN SQLWARN0 NOT EQUAL SPACE                          03767339
037674           WHEN SQLCODE NOT EQUAL ZERO                            03767439
037675             MOVE '2300-OPEN-EXCLUDE-CSR'                         03767539
037676               TO PV-PARAGRAPH-NAME                               03767639
037677             MOVE 'ERROR ON OPEN OF EXCLUDE CURSOR'               03767739
037678               TO PV-DB2-OPERATION                                03767839
037679             PERFORM 9010-SQL-ABEND-ROUTINE                       03767939
037680         END-EVALUATE                                             03768039
037681     END-PERFORM.                                                 03768139
037682                                                                  03768239
037683     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03768339
037684       MOVE '2300-OPEN-EXCLUDE-CSR'                               03768439
037685         TO PV-PARAGRAPH-NAME                                     03768539
037686       MOVE 'OPEN RETRIES EXCEEDED'                               03768639
037687         TO PV-DB2-OPERATION                                      03768739
037688       PERFORM 9010-SQL-ABEND-ROUTINE                             03768839
037689     END-IF.                                                      03768939
037690                                                                  03769039
037691*2300-EXIT.                                                       03769139
037692 EJECT.                                                           03769239
037693                                                                  03769339
037694*----------------------------------------------------------       03769437
037695* 2400-FETCH-EXCLUSION                                            03769539
037700*----------------------------------------------------------       03770037
038200 2400-FETCH-EXCLUSION.                                            03820039
038300                                                                  03830021
038310     PERFORM WITH TEST AFTER                                      03831039
038320       VARYING PV-SQL-SUB FROM 1 BY 1                             03832039
038330       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   03833039
038340                 OR SQLCODE = +0                                  03834039
038350                 OR SQLCODE = +100)                               03835039
038360                                                                  03836039
038400         EXEC SQL                                                 03840039
038500           FETCH EXCLUDE                                          03850039
038600             INTO :XST00034-PROMO-INTFC-ID                        03860039
038610                 ,:XST00034-PROMO-INTFC-SUB-ID                    03861039
038700                 ,:XST00034-MDSE-LNE-ID                           03870039
038800                 ,:XST00034-EXCL-MDSE-ID                          03880039
038900                 ,:XST00034-MAJ-CL-NBR:PV-MAJ-CL-NBR-IND          03890039
039000                 ,:XST00034-SUB-CL-NBR:PV-SUB-CL-NBR-IND          03900039
039100                 ,:XST00034-STYL-ID:PV-STYL-ID-IND                03910039
039200                 ,:XST00034-SKU-NBR:PV-SKU-NBR-IND                03920039
039300                 ,:XST00034-MDSE-HIER-CDE                         03930039
039400                 ,:XST00034-STAT-CDE                              03940039
039500                 ,:XST00034-DEPT-NBR:PV-DEPT-NBR-IND              03950039
039600                 ,:XST00034-SOR-LAST-UPD-TMST                     03960039
039700         END-EXEC                                                 03970039
039701                                                                  03970139
039710         EVALUATE TRUE                                            03971039
039720           WHEN SQLCODE = -904                                    03972039
039730           WHEN SQLCODE = -911                                    03973039
039740           WHEN SQLCODE = -913                                    03974039
039750           WHEN SQLCODE = +0                                      03975039
039760             CONTINUE                                             03976039
039770                                                                  03977039
039780           WHEN SQLCODE = +100                                    03978039
039781             SET PS-EOF-EXCLUDE TO TRUE                           03978139
039791                                                                  03979139
039792           WHEN SQLWARN0 NOT EQUAL SPACE                          03979239
039793           WHEN SQLCODE NOT EQUAL ZERO                            03979339
039794             MOVE '2400-FETCH-EXCLUSION'                          03979439
039796               TO PV-PARAGRAPH-NAME                               03979639
039797             MOVE 'ERROR ON FETCHING EXCLUDE CURSOR'              03979739
039798               TO PV-DB2-OPERATION                                03979839
039799             PERFORM 9010-SQL-ABEND-ROUTINE                       03979939
039800         END-EVALUATE                                             03980039
039801     END-PERFORM.                                                 03980139
039802                                                                  03980239
039803     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03980339
039804       MOVE '2400-FETCH-EXCLUSION'                                03980439
039806         TO PV-PARAGRAPH-NAME                                     03980639
039807       MOVE 'FETCH RETRIES EXCEEDED'                              03980739
039808         TO PV-DB2-OPERATION                                      03980839
039809       PERFORM 9010-SQL-ABEND-ROUTINE                             03980939
039810     END-IF.                                                      03981039
042001                                                                  04200137
042010*2400-EXIT.                                                       04201039
042020 EJECT.                                                           04202037
044800                                                                  04480021
044801*----------------------------------------------------------       04480137
044803* 2500-FORMAT-EXTRACT-FILE                                        04480339
044804*     FORMATS THE PRICING COPY BOOK.                              04480437
044805*----------------------------------------------------------       04480537
044850 2500-FORMAT-EXTRACT-FILE.                                        04485039
044851                                                                  04485137
044860     INITIALIZE XS021-PRICING-EXCLSNS-RECORD.                     04486023
044861                                                                  04486137
044870     MOVE XST00034-PROMO-INTFC-ID     TO XS021-PROMO-INTFC-ID.    04487037
044871     MOVE XST00034-PROMO-INTFC-SUB-ID TO XS021-PROMO-INTFC-SUB-ID.04487131
044880     MOVE XST00034-MDSE-LNE-ID        TO XS021-MDSE-LNE-ID.       04488037
044890     MOVE XST00034-EXCL-MDSE-ID       TO XS021-MDSE-LNE-EXCLN-ID. 04489037
044891                                                                  04489137
044892     IF PV-MAJ-CL-NBR-IND = -1                                    04489223
044893       MOVE ZEROS               TO XS021-MAJ-CL-NBR               04489337
044894     ELSE                                                         04489423
044895       MOVE XST00034-MAJ-CL-NBR TO XS021-MAJ-CL-NBR               04489537
044896     END-IF.                                                      04489623
044897                                                                  04489737
044898     IF PV-DEPT-NBR-IND = -1                                      04489823
044899       MOVE ZEROS             TO XS021-DEPT-NBR                   04489937
044900     ELSE                                                         04490023
044901       MOVE XST00034-DEPT-NBR TO XS021-DEPT-NBR                   04490137
044902     END-IF.                                                      04490223
044903                                                                  04490337
044904     IF PV-SUB-CL-NBR-IND = -1                                    04490423
044905       MOVE ZEROS               TO XS021-SUB-CL-NBR               04490537
044906     ELSE                                                         04490623
044907       MOVE XST00034-SUB-CL-NBR TO XS021-SUB-CL-NBR               04490737
044908     END-IF.                                                      04490823
044909                                                                  04490923
044910     IF PV-STYL-ID-IND = -1                                       04491023
044911       MOVE ZEROES           TO XS021-STYL-ID                     04491137
044912     ELSE                                                         04491223
044913       MOVE XST00034-STYL-ID TO XS021-STYL-ID                     04491337
044914     END-IF.                                                      04491423
044915                                                                  04491537
044916     IF PV-SKU-NBR-IND = -1                                       04491623
044917       MOVE ZEROS            TO XS021-SKU-NBR                     04491737
044918     ELSE                                                         04491823
044919       MOVE XST00034-SKU-NBR TO XS021-SKU-NBR                     04491937
044920     END-IF.                                                      04492023
044921                                                                  04492137
044922     MOVE XST00034-MDSE-HIER-CDE     TO XS021-MDSE-HIER-CDE.      04492237
044923     MOVE XST00034-STAT-CDE          TO XS021-STAT-CDE.           04492337
044925     MOVE XST00034-SOR-LAST-UPD-TMST TO XS021-LAST-UPD-TMST.      04492537
044926     MOVE 110                        TO XS021-BUSINESS-EVNT-ID.   04492637
044927     MOVE 'U'                        TO XS021-ACTION-CDE.         04492737
044928                                                                  04492823
044929*2500-EXIT.                                                       04492939
044930 EJECT.                                                           04493037
044931                                                                  04493123
044932*----------------------------------------------------------       04493237
044933* 2600-WRITE-PRICING-EXTRCT                                       04493339
044934*     WRITE EXTRACT FILE.                                         04493437
044935*----------------------------------------------------------       04493537
045300 2600-WRITE-PRICING-EXTRCT.                                       04530039
045310                                                                  04531037
045400     ADD 1 TO PV-RECORD-COUNT.                                    04540021
045500                                                                  04550021
045600     WRITE EXCLUSION-REC                                          04560037
045610       FROM XS021-PRICING-EXCLSNS-RECORD.                         04561037
045700                                                                  04570021
045710*2600-EXIT.                                                       04571039
045720 EJECT.                                                           04572037
046100                                                                  04610021
050910*----------------------------------------------------------       05091037
050921* 2700-CLOSE-EXCLUDE-CSR.                                         05092139
050930*----------------------------------------------------------       05093037
051400 2700-CLOSE-EXCLUDE-CSR.                                          05140039
051410                                                                  05141037
051420     PERFORM WITH TEST AFTER                                      05142039
051430       VARYING PV-SQL-SUB FROM 1 BY 1                             05143039
051440       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   05144039
051450                   OR SQLCODE = +0)                               05145039
051460                                                                  05146039
051500         EXEC SQL                                                 05150039
051600           CLOSE EXCLUDE                                          05160039
051700         END-EXEC                                                 05170039
051701                                                                  05170139
051710         EVALUATE TRUE                                            05171039
051720           WHEN SQLCODE = -904                                    05172039
051730           WHEN SQLCODE = -911                                    05173039
051740           WHEN SQLCODE = -913                                    05174039
051750           WHEN SQLCODE = +0                                      05175039
051760             CONTINUE                                             05176039
051770                                                                  05177039
051780           WHEN SQLWARN0 NOT EQUAL SPACE                          05178039
051790           WHEN SQLCODE NOT EQUAL ZERO                            05179039
051791             MOVE '2700-CLOSE-EXCLUDE-CSR'                        05179139
051793               TO PV-PARAGRAPH-NAME                               05179339
051794             MOVE 'ERROR ON CLOSE OF EXCLUDE CURSOR'              05179439
051795               TO PV-DB2-OPERATION                                05179539
051796             PERFORM 9010-SQL-ABEND-ROUTINE                       05179639
051797         END-EVALUATE                                             05179739
051798     END-PERFORM.                                                 05179839
051799                                                                  05179939
051800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05180039
051801       MOVE '2700-CLOSE-EXCLUDE-CSR'                              05180139
051803         TO PV-PARAGRAPH-NAME                                     05180339
051804       MOVE 'CLOSE RETRIES EXCEEDED'                              05180439
051805         TO PV-DB2-OPERATION                                      05180539
051806       PERFORM 9010-SQL-ABEND-ROUTINE                             05180642
051807     END-IF.                                                      05180739
053100                                                                  05310021
053110*2700-EXIT.                                                       05311039
053120 EJECT.                                                           05312037
053121                                                                  05312139
053130*----------------------------------------------------------       05313039
053140* 2800-CLOSE-EXTRACT-CSR.                                         05314039
053160*----------------------------------------------------------       05316039
053161 2800-CLOSE-EXTRACT-CSR.                                          05316139
053180                                                                  05318039
053190     PERFORM WITH TEST AFTER                                      05319039
053200       VARYING PV-SQL-SUB FROM 1 BY 1                             05320039
053300       UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                   05330039
053310                   OR SQLCODE = +0)                               05331039
053320                                                                  05332039
053330         EXEC SQL                                                 05333039
053340           CLOSE EXTRACT                                          05334039
053350         END-EXEC                                                 05335039
053360                                                                  05336039
053370         EVALUATE TRUE                                            05337039
053380           WHEN SQLCODE = -904                                    05338039
053390           WHEN SQLCODE = -911                                    05339039
053391           WHEN SQLCODE = -913                                    05339139
053392           WHEN SQLCODE = +0                                      05339239
053393             CONTINUE                                             05339339
053394                                                                  05339439
053395           WHEN SQLWARN0 NOT EQUAL SPACE                          05339539
053396           WHEN SQLCODE NOT EQUAL ZERO                            05339639
053397             MOVE '2800-CLOSE-EXTRACT-CSR'                        05339739
053398               TO PV-PARAGRAPH-NAME                               05339839
053399             MOVE 'ERROR ON CLOSE OF EXTRACT CURSOR'              05339939
053400               TO PV-DB2-OPERATION                                05340039
053401             PERFORM 9010-SQL-ABEND-ROUTINE                       05340139
053402         END-EVALUATE                                             05340239
053403     END-PERFORM.                                                 05340339
053404                                                                  05340439
053405     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05340539
053406       MOVE '2800-CLOSE-EXTRACT-CSR'                              05340639
053407         TO PV-PARAGRAPH-NAME                                     05340739
053408       MOVE 'CLOSE RETRIES EXCEEDED'                              05340839
053409         TO PV-DB2-OPERATION                                      05340939
053410       PERFORM 9010-SQL-ABEND-ROUTINE                             05341039
053411     END-IF.                                                      05341139
053412                                                                  05341239
053413*2800-EXIT.                                                       05341339
053414 EJECT.                                                           05341439
053415                                                                  05341539
053416*----------------------------------------------------------------*05341639
053417* 9010-SQL-ABEND-ROUTINE.                                         05341739
053418*     SQL ABEND ROUTINE.                                          05341839
053419*----------------------------------------------------------------*05341939
053420 9010-SQL-ABEND-ROUTINE.                                          05342039
053421                                                                  05342139
053422     DISPLAY '** ABEND     **'.                                   05342239
053423     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                05342339
053424     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05342439
053425     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               05342539
053426                                                                  05342639
053427     COPY DPPD004.                                                05342739
053428     MOVE +4013 TO AB-ABEND-CODE.                                 05342842
053429     CALL 'ILBOABN0' USING AB-ABEND-CODE.                         05342939
053430                                                                  05343039
053431*9010-EXIT.                                                       05343139
053432 EJECT.                                                           05343239
053445                                                                  05344539
053454*----------------------------------------------------------------*05345439
053460* 9020-ABEND                                                      05346039
053470*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  05347039
053480*----------------------------------------------------------------*05348039
053490 9020-ABEND.                                                      05349039
053500                                                                  05350039
053600     DISPLAY '** ABEND           **'.                             05360039
053700     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          05370039
053800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05380039
053900     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05390039
054000     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05400039
054100                                                                  05410039
054200     CALL 'ILBOABN0' USING AB-ABEND-CODE.                         05420039
054300                                                                  05430039
054400*9020-EXIT.                                                       05440039
054500 EJECT.                                                           05450039
054600                                                                  05460039
056900*----------------------------------------------------------       05690021
057000* 9999-WRAPUP.                                                    05700021
057100*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           05710021
057200*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           05720021
057300*     PROGRAM.                                                    05730021
057400*----------------------------------------------------------       05740021
057600 9999-WRAPUP.                                                     05760021
057610                                                                  05761037
057620     INITIALIZE XS021-PRICING-EXCLSNS-RECORD.                     05762039
057630                                                                  05763039
057640     MOVE 110             TO PV-BUSINESS-EVNT-ID.                 05764039
057650     MOVE PV-RECORD-COUNT TO PV-TOTAL-NBR-OF-RECS.                05765039
057660     MOVE 'T'             TO PV-ACTION-CDE.                       05766039
057670                                                                  05767039
057680     WRITE EXCLUSION-REC                                          05768039
057690       FROM PV-TOTAL-RECORD.                                      05769039
057691                                                                  05769139
057700     CLOSE DATE-RANGE-FILE                                        05770021
057800           TMST-FILE                                              05780021
057900           EXTRACT-FILE.                                          05790021
058000                                                                  05800021
058600*9999-EXIT.                                                       05860021
058700 EJECT.                                                           05870021
