000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.              TRKUT091.                               00020001
000300 AUTHOR.                  DENISE HAHN.                            00030000
000400 DATE-WRITTEN.            JANUARY 2021.                           00040001
000500 DATE-COMPILED.                                                   00050000
000600                                                                  00060000
000700******************************************************************00070000
000800* THIS PROGRAM WILL EXTRACT DATA FROM TVEHICL WHERE THE CURRENT  *00080000
000810* TRIP STATUS IS NOT 'ET','DP','DE' AND THERE ARE NO SHIPMENTS   *00081001
000820* ATTACHED TO THE TRIP.  (PARM FOR XDAYS TO LOOK BACK-TRIPRG )   *00082002
000830* WILL ALSO CHECK IF TSHIPST (SHIPMENT STATUS) IS SET TO ET      *00083000
000840* EXTRACT WILL BE USED BY TRKUP091 TO INSERT DE & ET ROWS INTO   *00084001
000850* TSHIPST & TTRIPST, TVEHICL WILL ALSO BE UPDATED.               *00085001
000860******************************************************************00086000
000870 ENVIRONMENT DIVISION.                                            00087000
000880 CONFIGURATION SECTION.                                           00088000
000890                                                                  00089000
000900 INPUT-OUTPUT SECTION.                                            00090000
000910 FILE-CONTROL.                                                    00091000
000920                                                                  00092000
000921     SELECT TRIP-FILE                                             00092100
000922        ASSIGN TO OUT01.                                          00092200
000923                                                                  00092300
000927 DATA DIVISION.                                                   00092700
000928 FILE SECTION.                                                    00092800
000929                                                                  00092900
000930 FD  TRIP-FILE                                                    00093000
000940     RECORDING MODE IS F                                          00094000
000950     LABEL RECORDS ARE STANDARD                                   00095000
000960     RECORD CONTAINS 125 CHARACTERS                               00096000
000970     DATA RECORD IS TRIP-RECORD.                                  00097000
000980                                                                  00098000
000990 01  TRIP-RECORD                 PIC X(125).                      00099000
001000                                                                  00100000
001100                                                                  00110000
002010 WORKING-STORAGE SECTION.                                         00201000
002020                                                                  00202000
002030                                                                  00203000
002040 01  PROGRAM-SWITCHES.                                            00204000
002050     05  PS-END-OF-TRIP-CSR-SW       PIC  X(01)  VALUE 'N'.       00205000
002060         88  PS-END-OF-TRIP-CSR-YES              VALUE 'Y'.       00206000
002070         88  PS-END-OF-TRIP-CSR-NO               VALUE 'N'.       00207000
002200     05  PS-ERROR-SW                 PIC  X(01)  VALUE 'N'.       00220000
002300         88  PS-ERROR-YES                        VALUE 'Y'.       00230000
002400         88  PS-ERROR-NO                         VALUE 'N'.       00240000
002500                                                                  00250000
002600 01  PV-ABEND-FIELDS.                                             00260000
002700     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'TRKUT091'.00270001
002800     05  PV-ABEND-CODE               PIC S9(04)  VALUE +0         00280000
002900                                                 COMP SYNC.       00290000
003000     05  PV-PARAGRAPH-NAME           PIC  X(30)  VALUE SPACES.    00300000
003100     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)  VALUE SPACES.    00310000
003200     05  PV-ABEND-PARAGRAPH          PIC  X(30)  VALUE SPACES.    00320000
003300     05  PV-ABEND-OPERATION          PIC  X(30)  VALUE SPACES.    00330000
003400     05  PV-DB2-OPER-ATTEMPTED       PIC  X(30)  VALUE SPACES.    00340000
003500     05  PV-DB2-OPERATION-MESSAGE-1  PIC  X(79)  VALUE SPACES.    00350000
003600     05  PV-DB2-OPERATION-MESSAGE-2  PIC  X(79)  VALUE SPACES.    00360000
003700     05  PV-DB2-OPERATION-MESSAGE-3  PIC  X(79)  VALUE SPACES.    00370000
003800     05  PV-DB2-OPERATION-MESSAGE-4  PIC  X(79)  VALUE SPACES.    00380000
003900     05  PV-SQLCODE                  PIC -Z(03)  VALUE ZERO.      00390000
004000     05  PV-NEW-STATUS-DTE           PIC  X(10)  VALUE SPACES.    00400004
004010     05  PV-DAYS-BACK-DISP           PIC  Z(09)  VALUE ZEROES.    00401006
004011     05  PV-DAYS-BACK                PIC S9(09)  VALUE ZEROES     00401106
004012                                                 COMP.            00401206
004020     05  PV-CURRENT-DATE             PIC  X(10)  VALUE SPACES.    00402006
004030     05  PV-CHECK-DATE               PIC  X(10)  VALUE SPACES.    00403006
004100                                                                  00410000
004200                                                                  00420000
004300 01  DK-DB2-KEYS.                                                 00430000
004400     05  DK-TRIP-ID                  PIC  S9(9) COMP VALUE ZEROES.00440000
004500 01  PROGRAM-VARIABLES.                                           00450000
004600     05  PV-TRIP-COUNT               PIC  9(09).                  00460000
004900     05  PV-NULL-IND-1               PIC S9(04)  VALUE ZEROS      00490000
005000                                                 COMP SYNC.       00500000
005100     05  PV-NULL-IND-2               PIC S9(04)  VALUE ZEROS      00510000
005200                                                 COMP SYNC.       00520000
005300     05  PV-DISP-TRIP                PIC  Z(10)  VALUE ZEROS.     00530000
005400     05  PV-DISP-OPER                PIC  Z(03)  VALUE ZERO.      00540000
005500                                                                  00550000
005600 01  ABEND-CODE                PIC S9(04)  VALUE +0 COMP SYNC.    00560000
005610     88 ABEND-4013                         VALUE +4013.           00561000
005620                                                                  00562000
005630***************************************************************** 00563000
005640*    TRIP FILE LAYOUT                                           * 00564000
005650***************************************************************** 00565000
005660     COPY TRRD074.                                                00566000
005670                                                                  00567000
005910***************************************************************** 00591000
005920*    SQL ABEND ROUTINE WORKING STORAGE                          * 00592000
005930***************************************************************** 00593000
005940     COPY DPWS004.                                                00594000
005950                                                                  00595000
005960     EXEC SQL                                                     00596000
005970        INCLUDE TVHTRIP                                           00597000
005980     END-EXEC.                                                    00598000
005990                                                                  00599000
006000     EXEC SQL                                                     00600000
006100        INCLUDE TTRIPST                                           00610000
006200     END-EXEC.                                                    00620000
006300                                                                  00630000
006400     EXEC SQL                                                     00640000
006500        INCLUDE TTRSTYP                                           00650000
006600     END-EXEC.                                                    00660000
006700                                                                  00670000
006800     EXEC SQL                                                     00680000
006900        INCLUDE TVEHICL                                           00690000
007000     END-EXEC.                                                    00700000
007100                                                                  00710000
007200     EXEC SQL                                                     00720000
007300        INCLUDE TSHIPMT                                           00730000
007400     END-EXEC.                                                    00740000
007500                                                                  00750000
007600     EXEC SQL                                                     00760006
007700        INCLUDE TKRPRPM                                           00770006
007800     END-EXEC.                                                    00780006
007900                                                                  00790006
008220     EXEC SQL                                                     00822000
008230        DECLARE TRIP_CSR CURSOR FOR                               00823000
008231         SELECT D.OWNER_SCAC_ID                                   00823103
008232              , D.VEH_NBR                                         00823203
008234              , D.CURR_TRIP_ID                                    00823403
008235              , D.CURR_OPER_UNT_ID                                00823503
008236              , D.CURR_STATUS_CDE                                 00823603
008237              , D.CURR_STATUS_DTE                                 00823703
008238              , D.CURR_STATUS_TME                                 00823803
008239              , A.TRIP_BEG_DTE                                    00823903
008240              , A.TRIP_BEG_TME                                    00824003
008241              , B.TRIP_STATUS_CDE                                 00824103
008242              , B.STATUS_DTE                                      00824203
008243              , B.STATUS_TME                                      00824303
008244              , B.STATUS_UID                                      00824403
008245              , B.OPER_UNT_ID                                     00824503
008246              , B.FCLTY_ID                                        00824603
008247              , B.STATUS_DTE + 1 DAY AS NEW_STATUS_DTE            00824705
008248           FROM TVHTRIP A                                         00824808
008249              , TTRIPST B                                         00824908
008250              , TTRSTYP C                                         00825003
008251              , TVEHICL D                                         00825108
008252         WHERE D.CURR_TRIP_ID     =  A.TRIP_ID                    00825203
008253           AND A.TRIP_ID          =  B.TRIP_ID                    00825303
008254           AND NOT A.VEH_NBR     IS NULL                          00825403
008255           AND B.TRIP_STATUS_CDE  =  C.TRIP_STATUS_CDE            00825503
008256           AND C.PRTY_CDE IN                                      00825603
008257               (SELECT MAX(CC.PRTY_CDE)                           00825703
008258                  FROM TTRIPST BB                                 00825808
008259                     , TTRSTYP CC                                 00825903
008260                 WHERE B.TRIP_ID  = BB.TRIP_ID                    00826003
008261                   AND BB.TRIP_STATUS_CDE = CC.TRIP_STATUS_CDE)   00826103
008262           AND NOT B.TRIP_STATUS_CDE IN ('DP','ET','DE')          00826203
008263           AND B.STATUS_DTE <= CURRENT DATE - :PV-DAYS-BACK DAYS  00826306
008264           AND NOT A.TRIP_ID IN                                   00826403
008265               (SELECT DISTINCT T.TRIP_ID                         00826503
008266                 FROM TVHTRIP T                                   00826608
008267                    , TTRIPST U                                   00826708
008268                    , TTRSTYP V                                   00826803
008269                    , TSHIPMT W                                   00826908
008270                    , TVEHICL Y                                   00827008
008271                WHERE Y.CURR_TRIP_ID  = T.TRIP_ID                 00827103
008272                  AND T.TRIP_ID  =  U.TRIP_ID                     00827203
008273                  AND U.TRIP_STATUS_CDE  =  V.TRIP_STATUS_CDE     00827303
008274                  AND V.PRTY_CDE IN                               00827403
008275                     (SELECT MAX(VV.PRTY_CDE)                     00827503
008276                        FROM TTRIPST UU                           00827608
008277                           , TTRSTYP VV                           00827703
008278                       WHERE U.TRIP_ID  = UU.TRIP_ID              00827803
008279                         AND UU.TRIP_STATUS_CDE =                 00827903
008280                                            VV.TRIP_STATUS_CDE    00828003
008281                     )                                            00828103
008282                  AND T.TRIP_ID  =  W.TRIP_ID                     00828203
008283               )                                                  00828303
008284         ORDER BY B.OPER_UNT_ID                                   00828403
008285                , D.CURR_STATUS_DTE                               00828503
008286                , D.CURR_STATUS_TME                               00828603
009204         WITH UR                                                  00920400
009205     END-EXEC.                                                    00920500
009206                                                                  00920600
009207                                                                  00920700
010240*   DB2 SQL COMMUNICATION AREA                                    01024000
010250     EXEC SQL                                                     01025000
010260          INCLUDE SQLCA                                           01026000
010270     END-EXEC.                                                    01027000
010280                                                                  01028000
010290                                                                  01029000
010300******************************************************************01030000
010400 PROCEDURE DIVISION.                                              01040000
010500******************************************************************01050000
010600* 0000-PROGRAM-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE     01060000
010700*      PROGRAM.                                                   01070000
010800******************************************************************01080000
010900 0000-PROGRAM-MAINLINE.                                           01090000
010901                                                                  01090106
010910     DISPLAY '************************************************'   01091006
010920     DISPLAY '** TRKUT091'                                        01092006
010930     DISPLAY '** '                                                01093006
011000                                                                  01100000
011100     OPEN OUTPUT TRIP-FILE.                                       01110003
011300                                                                  01130000
011301     PERFORM 0100-GET-DAYS-BACK.                                  01130106
011302     MOVE PV-DAYS-BACK  TO  PV-DAYS-BACK-DISP                     01130206
011303     DISPLAY '** PARM TRIPRG:  '  PV-DAYS-BACK-DISP               01130306
011305     DISPLAY '** CURRENT DATE: '  PV-CURRENT-DATE                 01130506
011306     DISPLAY '** EXTRACT DATE: '  PV-CHECK-DATE                   01130606
011307     DISPLAY '** '                                                01130706
011310                                                                  01131006
011400     PERFORM 8000-OPEN-TRIP-CSR.                                  01140006
011500     PERFORM 8010-FETCH-TRIP-CSR.                                 01150006
011600                                                                  01160000
011700     PERFORM 2000-PROCESS-TRIP                                    01170000
011800       UNTIL PS-END-OF-TRIP-CSR-YES.                              01180000
011900                                                                  01190000
012000     PERFORM 8020-CLOSE-TRIP-CSR.                                 01200000
012100                                                                  01210000
012400     DISPLAY '** '                                                01240000
012500     DISPLAY '** TRIP COUNT:  ' PV-TRIP-COUNT                     01250000
012700     DISPLAY '************************************************'   01270000
012800                                                                  01280000
012900     CLOSE TRIP-FILE.                                             01290003
013100                                                                  01310000
013200     STOP RUN.                                                    01320000
013300                                                                  01330000
013301***********************************************************       01330106
013302*                                                         *       01330206
013303***********************************************************       01330306
013310 0100-GET-DAYS-BACK.                                              01331006
013311                                                                  01331106
013312     EXEC SQL                                                     01331206
013313        SELECT FUNC_QTY                                           01331306
013314             , CURRENT DATE                                       01331406
013315             , CURRENT DATE - FUNC_QTY DAYS                       01331506
013316          INTO :PV-DAYS-BACK                                      01331606
013317             , :PV-CURRENT-DATE                                   01331706
013318             , :PV-CHECK-DATE                                     01331806
013319          FROM TKRPRPM                                            01331906
013332         WHERE LOC_ID             =  90                           01333206
013333           AND INTFC_SYS_CDE      = 'KHL'                         01333306
013334           AND SYS_PRC_FUNC_CDE   = 'TRIPRG'                      01333406
013335           AND FUNC_PRC_STAT_CDE  = 'AC'                          01333506
013336           AND FUNC_BEG_TMST     <= CURRENT TIMESTAMP             01333606
013337           AND FUNC_END_TMST     >= CURRENT TIMESTAMP             01333706
013338     END-EXEC.                                                    01333806
013339                                                                  01333906
013340     EVALUATE TRUE                                                01334006
013341         WHEN SQLCODE = ZERO                                      01334106
013342              CONTINUE                                            01334206
013343                                                                  01334306
013344         WHEN SQLCODE = +100                                      01334406
013345              MOVE 1000         TO  PV-DAYS-BACK                  01334506
013346         WHEN OTHER                                               01334606
013347             MOVE '0100-GET-DAYS-BACK '                           01334706
013348                                       TO PV-ABEND-PARAGRAPH      01334806
013349             MOVE 'CHECK DAYS BACK'    TO PV-ABEND-OPERATION      01334906
013350             PERFORM 9900-DB2-ABEND                               01335006
013351     END-EVALUATE.                                                01335106
013354                                                                  01335406
013360                                                                  01336006
013400***********************************************************       01340000
013500*                                                         *       01350000
013600***********************************************************       01360000
013700 2000-PROCESS-TRIP.                                               01370000
013800                                                                  01380000
013900     PERFORM 3000-WRITE-TRIP-RECORD.                              01390000
014000                                                                  01400000
015300     PERFORM 8010-FETCH-TRIP-CSR.                                 01530000
015400                                                                  01540000
015500                                                                  01550000
016114***********************************************************       01611400
016115*                                                         *       01611500
016116***********************************************************       01611600
016117 3000-WRITE-TRIP-RECORD.                                          01611700
016132                                                                  01613200
016133     INITIALIZE  TR074-RECORD.                                    01613300
016134     MOVE VEHICL-OWNER-SCAC-ID     TO TR074-OWNER-SCAC-ID.        01613403
016135     MOVE VEHICL-VEH-NBR           TO TR074-VEH-NBR.              01613503
016140     MOVE VEHICL-CURR-TRIP-ID      TO TR074-TRIP-ID.              01614003
016150     MOVE TRIPST-TRIP-STATUS-CDE   TO TR074-TRIP-STATUS-CDE.      01615000
016160     MOVE TRIPST-STATUS-DTE        TO TR074-TRIP-STATUS-DTE.      01616000
016170     MOVE TRIPST-STATUS-TME        TO TR074-TRIP-STATUS-TME.      01617000
016180     MOVE TRIPST-STATUS-UID        TO TR074-TRIP-STATUS-UID.      01618000
016190     MOVE TRIPST-OPER-UNT-ID       TO TR074-OPER-UNT-ID.          01619000
016200     MOVE TRIPST-FCLTY-ID          TO TR074-FCLTY-ID.             01620000
016400     MOVE VEHICL-CURR-TRIP-ID      TO TR074-VEH-TRIP-ID.          01640000
016500     MOVE PV-NEW-STATUS-DTE        TO TR074-NEW-STATUS-DTE.       01650004
016700                                                                  01670000
016800     WRITE TRIP-RECORD                                            01680000
016900      FROM TR074-RECORD.                                          01690000
017000                                                                  01700000
017100     MOVE  TR074-OPER-UNT-ID TO PV-DISP-OPER.                     01710000
017200     MOVE  TR074-TRIP-ID     TO PV-DISP-TRIP.                     01720000
017300                                                                  01730000
017400     DISPLAY 'OPER: '           PV-DISP-OPER                      01740000
017500             '  TRIP: '         PV-DISP-TRIP                      01750000
017600             '   '              TR074-OWNER-SCAC-ID               01760000
017700             '/'                TR074-VEH-NBR                     01770000
017800             '  ST: '           TR074-TRIP-STATUS-CDE             01780000
017900             '  '               TR074-TRIP-STATUS-DTE             01790000
018000             ' @ '              TR074-TRIP-STATUS-TME             01800000
018100             '  '               TR074-TRIP-STATUS-UID.            01810003
018300                                                                  01830000
018400     ADD +1                      TO PV-TRIP-COUNT.                01840000
018500                                                                  01850000
018600                                                                  01860000
020700***********************************************************       02070000
020800*                                                         *       02080000
020900***********************************************************       02090000
021000 8000-OPEN-TRIP-CSR.                                              02100000
021100                                                                  02110000
021200     EXEC SQL                                                     02120000
021300        OPEN TRIP_CSR                                             02130000
021400     END-EXEC.                                                    02140000
021500                                                                  02150000
021600     EVALUATE TRUE                                                02160000
021700         WHEN SQLCODE = ZERO                                      02170000
021800             CONTINUE                                             02180000
021900         WHEN OTHER                                               02190000
022000             MOVE '8000-OPEN-TRIP-CSR'                            02200000
022100                                       TO PV-ABEND-PARAGRAPH      02210000
022200             MOVE 'OPEN TRIP CURSOR'   TO PV-ABEND-OPERATION      02220000
022300             PERFORM 9900-DB2-ABEND                               02230000
022400     END-EVALUATE.                                                02240000
022500                                                                  02250000
022600                                                                  02260000
022700***********************************************************       02270000
022800*                                                         *       02280000
022900***********************************************************       02290000
023000 8010-FETCH-TRIP-CSR.                                             02300000
023100                                                                  02310000
023200     EXEC SQL                                                     02320000
023300        FETCH TRIP_CSR                                            02330000
023420        INTO :VEHICL-OWNER-SCAC-ID                                02342003
023430           , :VEHICL-VEH-NBR                                      02343003
023440           , :VEHICL-CURR-TRIP-ID                                 02344003
023450           , :VEHICL-CURR-OPER-UNT-ID                             02345003
023460           , :VEHICL-CURR-STATUS-CDE                              02346003
023470           , :VEHICL-CURR-STATUS-DTE                              02347003
023480           , :VEHICL-CURR-STATUS-TME                              02348003
023490           , :VHTRIP-TRIP-BEG-DTE                                 02349003
023500           , :VHTRIP-TRIP-BEG-TME                                 02350003
023600           , :TRIPST-TRIP-STATUS-CDE                              02360003
023700           , :TRIPST-STATUS-DTE                                   02370003
023800           , :TRIPST-STATUS-TME                                   02380003
023900           , :TRIPST-STATUS-UID                                   02390003
024000           , :TRIPST-OPER-UNT-ID                                  02400003
024100           , :TRIPST-FCLTY-ID                                     02410003
024200           , :PV-NEW-STATUS-DTE                                   02420004
024300     END-EXEC.                                                    02430000
024400                                                                  02440000
024500     EVALUATE TRUE                                                02450000
024600         WHEN SQLCODE = ZERO                                      02460000
024800              CONTINUE                                            02480003
025000                                                                  02500000
025100         WHEN SQLCODE = +100                                      02510000
025200             SET  PS-END-OF-TRIP-CSR-YES  TO TRUE                 02520000
025300         WHEN OTHER                                               02530000
025400             MOVE '8010-FETCH-TRIP-CSR'                           02540000
025500                                       TO PV-ABEND-PARAGRAPH      02550000
025600             MOVE 'FETCH TRIP CSR'     TO PV-ABEND-OPERATION      02560000
025700             PERFORM 9900-DB2-ABEND                               02570000
025800     END-EVALUATE.                                                02580000
025900                                                                  02590000
026000                                                                  02600000
026100***********************************************************       02610000
026200*                                                         *       02620000
026300***********************************************************       02630000
026400 8020-CLOSE-TRIP-CSR.                                             02640000
026500                                                                  02650000
026600     EXEC SQL                                                     02660000
026700        CLOSE TRIP_CSR                                            02670000
026800     END-EXEC.                                                    02680000
026900                                                                  02690000
027000     EVALUATE TRUE                                                02700000
027100         WHEN SQLCODE = ZERO                                      02710000
027200             CONTINUE                                             02720000
027300         WHEN OTHER                                               02730000
027400             MOVE '8020-CLOSE-TRIP-CSR'                           02740000
027500                                       TO PV-ABEND-PARAGRAPH      02750000
027600             MOVE 'CLOSE TRIP CSR'     TO PV-ABEND-OPERATION      02760000
027700             PERFORM 9900-DB2-ABEND                               02770000
027800     END-EVALUATE.                                                02780000
027900                                                                  02790000
028000                                                                  02800000
028494***********************************************************       02849400
028495*                                                         *       02849500
028496***********************************************************       02849600
028497 9900-DB2-ABEND.                                                  02849700
028498                                                                  02849800
028499     MOVE SQLCODE TO PV-SQLCODE.                                  02849900
028500     DISPLAY '*** DB2 ERROR '.                                    02850000
028600     DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                       02860000
028700     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 02870000
028800     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               02880000
028900     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               02890000
029000     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       02900000
029100     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.       02910000
029200     DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.       02920000
029300                                                                  02930000
029400     COPY DPPD004.                                                02940000
029500                                                                  02950000
029510     IF SQLCODE NOT = -911                                        02951000
029520         EXEC SQL                                                 02952000
029530              ROLLBACK                                            02953000
029540         END-EXEC                                                 02954000
029550     END-IF.                                                      02955000
029560                                                                  02956000
029570     MOVE +4013                  TO PV-ABEND-CODE.                02957000
029580     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02958000
029590                                                                  02959000
