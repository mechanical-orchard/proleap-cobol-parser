000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400*  BUILD TIMESTAMP RANGE FILE FOR PICKMADE EVENT PROCESSING       00040000
000500***************************************************************** 00050000
000600*                                                                 00060000
000700 PROGRAM-ID.    PCKUT120.                                         00070000
000800 AUTHOR.        RON KRIER.                                        00080000
000900 INSTALLATION.  KOHLS.                                            00090000
001000 DATE-WRITTEN   FEBRUARY 2024.                                    00100000
001100 DATE-COMPILED.                                                   00110000
001200                                                                  00120000
001300***************************************************************** 00130000
001400*  THIS PROGRAM WILL SET THE TIMESTAMP RANGE FOR USE IN         * 00140000
001500*  PROGRAMS NEEDING A TIMESTAMP RANGE TO PULL PICKMADE DATA FOR * 00150000
001510*  UPDATING UNITS TO THE UNITS WORKED APPLICATION.              * 00151000
001600*   FROM TIMESTAMP IS FROM THE PREVIOUS TIMESTAMP RANGE         * 00160000
001700*   TO   TIMESTAMP IS THE CURRENT TIMESTAMP MINUS X MINUTES     * 00170000
001710*        VIA PARM NAME P2WKMN                                   * 00171000
001800*                                                               * 00180000
001900***************************************************************** 00190000
003900 ENVIRONMENT DIVISION.                                            00390004
004000 INPUT-OUTPUT SECTION.                                            00400004
004100                                                                  00410004
004200 FILE-CONTROL.                                                    00420004
004300                                                                  00430004
004400     SELECT LAST-RUN-FILE                                         00440004
004500         ASSIGN TO INP01.                                         00450004
004600                                                                  00460004
004700     SELECT TIMESTAMP-FILE                                        00470004
004800         ASSIGN TO OUT01.                                         00480004
004900                                                                  00490004
005000     SELECT THIS-RUN-FILE                                         00500004
005100         ASSIGN TO OUT02.                                         00510004
005200                                                                  00520004
005300***************************************************************** 00530004
005400 DATA DIVISION.                                                   00540004
005500***************************************************************** 00550004
005600 FILE SECTION.                                                    00560004
005700                                                                  00570004
005800 FD  LAST-RUN-FILE                                                00580004
005900     RECORDING MODE IS F                                          00590004
006000     BLOCK CONTAINS 0 RECORDS                                     00600004
006100     LABEL RECORDS ARE STANDARD.                                  00610004
006200                                                                  00620004
006300 01  LAST-RUN-DATE-REC            PIC X(80).                      00630004
006400                                                                  00640004
006500 FD  TIMESTAMP-FILE                                               00650004
006600     RECORDING MODE IS F                                          00660004
006700     BLOCK CONTAINS 0 RECORDS                                     00670004
006800     LABEL RECORDS ARE STANDARD.                                  00680004
006900                                                                  00690004
007000 01  TIMESTAMP-RECORD             PIC X(80).                      00700004
007100                                                                  00710004
007200 FD  THIS-RUN-FILE                                                00720004
007300     RECORDING MODE IS F                                          00730004
007400     BLOCK CONTAINS 0 RECORDS                                     00740004
007500     LABEL RECORDS ARE STANDARD.                                  00750004
007600                                                                  00760004
007700 01  THIS-RUN-DATE-REC            PIC X(80).                      00770004
007800                                                                  00780004
007900                                                                  00790004
008000***************************************************************** 00800004
008100 WORKING-STORAGE SECTION.                                         00810004
008200                                                                  00820004
008300 01  PC-PROGRAM-CONSTANTS.                                        00830004
008400     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'PCKUT120'.00840004
008500                                                                  00850004
008600 01  PV-PROGRAM-VARIABLES.                                        00860004
008700     05  PV-CURR-TIMESTAMP            PIC X(26) VALUE SPACES.     00870004
008800     05  PV-FROM-TIMESTAMP            PIC X(26) VALUE SPACES.     00880004
008900     05  PV-TO-TIMESTAMP              PIC X(26) VALUE SPACES.     00890004
009000     05  PV-DISP-MIN                  PIC ZZZ9.                   00900004
009100                                                                  00910004
009200 01  PV-ABEND-FIELDS.                                             00920004
009300     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00930004
009400     05  PV-ABEND-TABLE               PIC  X(12) VALUE SPACES.    00940004
009500     05  PV-DB2-MESSAGE               PIC  X(50) VALUE SPACES.    00950004
009600     05  PV-ABEND-CODE                PIC S9(04) COMP SYNC        00960004
009700                                                 VALUE +0.        00970004
009800                                                                  00980004
009900 01  TIMESTAMP-REC-OUT.                                           00990004
010000     05  TR-FROM-TIMESTAMP            PIC X(26)   VALUE SPACES.   01000004
010100     05  FILLER                       PIC X(1)    VALUE SPACES.   01010004
010200     05  TR-TO-TIMESTAMP              PIC X(26)   VALUE SPACES.   01020004
010300     05  FILLER                       PIC X(27)   VALUE SPACES.   01030004
010400                                                                  01040004
010500                                                                  01050004
010600*----------------------------------------------------------------*01060004
010700*  TKRPRPM - PARM TABLE                                          *01070004
010800*----------------------------------------------------------------*01080004
010900     EXEC SQL                                                     01090004
011000          INCLUDE TKRPRPM                                         01100004
011100     END-EXEC.                                                    01110004
011200                                                                  01120004
011300*----------------------------------------------------------------*01130004
011400*   COMMUNICATION AREA FOR DB2                                   *01140004
011500*----------------------------------------------------------------*01150004
011600     EXEC SQL                                                     01160004
011700          INCLUDE SQLCA                                           01170004
011800     END-EXEC.                                                    01180004
011900                                                                  01190004
012000     COPY DPWS004.                                                01200004
012100                                                                  01210004
012200                                                                  01220004
012300***************************************************************** 01230004
012400 PROCEDURE DIVISION.                                              01240004
012500***************************************************************** 01250004
012600                                                                  01260004
012700     OPEN INPUT  LAST-RUN-FILE                                    01270004
012800          OUTPUT TIMESTAMP-FILE                                   01280004
012900          OUTPUT THIS-RUN-FILE.                                   01290004
013000                                                                  01300004
013100     DISPLAY '*'.                                                 01310004
013200     DISPLAY '* START - PCKUT120'.                                01320004
013300     DISPLAY '*'.                                                 01330004
013400                                                                  01340004
013500     PERFORM 1000-GET-CURRENT-TMST.                               01350004
013600                                                                  01360004
013700     PERFORM 1010-READ-LAST-RUN-DATE.                             01370004
013800                                                                  01380004
013900     DISPLAY '* FROM TIMESTAMP: ' PV-FROM-TIMESTAMP.              01390008
014000     DISPLAY '* TO TIMESTAMP  : ' PV-TO-TIMESTAMP.                01400008
014100     DISPLAY '*'.                                                 01410004
014200                                                                  01420004
014300     PERFORM 3000-WRITE-THIS-RUN-DATE.                            01430004
014400     PERFORM 3020-WRITE-TIMESTAMP.                                01440004
014500                                                                  01450004
014600     CLOSE LAST-RUN-FILE                                          01460004
014700           TIMESTAMP-FILE                                         01470004
014800           THIS-RUN-FILE.                                         01480004
014900                                                                  01490004
015000     GOBACK.                                                      01500004
015100                                                                  01510004
015200***************************************************************** 01520004
015300*  GET THE CURRENT TIMESTAMP                                      01530004
015400***************************************************************** 01540004
015500 1000-GET-CURRENT-TMST.                                           01550004
015600                                                                  01560004
015700     EXEC SQL                                                     01570004
015800         SELECT  FUNC_QTY                                         01580004
015900              ,  CURRENT TIMESTAMP                                01590004
016000              ,  CURRENT TIMESTAMP - FUNC_QTY MINUTES             01600004
016100           INTO :KRPRPM-FUNC-QTY                                  01610004
016200              , :PV-CURR-TIMESTAMP                                01620004
016300              , :PV-TO-TIMESTAMP                                  01630004
016400           FROM  TKRPRPM                                          01640004
016500         WHERE LOC_ID            = 90                             01650004
016600           AND INTFC_SYS_CDE     = 'KHL'                          01660004
016700           AND SYS_PRC_FUNC_CDE  = 'P2WKMN'                       01670004
016800           AND FUNC_PRC_STAT_CDE = 'AC'                           01680004
016900           AND FUNC_BEG_TMST    <=  CURRENT TIMESTAMP             01690004
017000           AND FUNC_END_TMST    >=  CURRENT TIMESTAMP             01700004
017100     END-EXEC.                                                    01710004
017200                                                                  01720004
017300     MOVE KRPRPM-FUNC-QTY  TO  PV-DISP-MIN.                       01730004
017400     DISPLAY '*'.                                                 01740004
017500     DISPLAY '* PARM P2WKMN MINUTES: ' PV-DISP-MIN.               01750008
017600     DISPLAY '*'.                                                 01760004
017700     DISPLAY '* SQL CURR TIMESTAMP: ' PV-CURR-TIMESTAMP           01770008
017800     DISPLAY '* SQL CURR - P2WKMN : ' PV-TO-TIMESTAMP             01780008
017900     DISPLAY '*'.                                                 01790004
018000                                                                  01800004
018100                                                                  01810004
018200***************************************************************** 01820004
018300*  READ THE DATASET WITH THE LAST RUN DATE IN IT                  01830004
018400***************************************************************** 01840004
018500 1010-READ-LAST-RUN-DATE.                                         01850004
018600                                                                  01860004
018700     READ LAST-RUN-FILE                                           01870004
018800            AT END                                                01880004
018900               MOVE 'MISSING LAST RUN DATE DATASET'               01890004
019000                                TO PV-DB2-MESSAGE                 01900004
019100               MOVE '1010-READ-LAST-RUN-DATE'                     01910004
019200                                TO PV-ABEND-PARAGRAPH             01920004
019300               MOVE 'INP01'     TO PV-ABEND-TABLE                 01930004
019400               PERFORM 9100-SQL-ABEND                             01940004
019500     END-READ.                                                    01950004
019600                                                                  01960004
019610     DISPLAY '* ZERO GEN INPUT FROM TIMESTAMP: '                  01961005
019620             LAST-RUN-DATE-REC(1:26).                             01962005
019630     DISPLAY '*'.                                                 01963005
019640                                                                  01964005
019700     MOVE LAST-RUN-DATE-REC(1:26)  TO PV-FROM-TIMESTAMP.          01970004
019800                                                                  01980004
019900                                                                  01990004
020000***************************************************************** 02000004
020100*  WRITE OUT THE DATASET WITH THE CURRENT RUN DATE, FOR NEXT RUN  02010004
020200***************************************************************** 02020004
020300 3000-WRITE-THIS-RUN-DATE.                                        02030004
020400                                                                  02040004
020500     MOVE PV-TO-TIMESTAMP       TO THIS-RUN-DATE-REC.             02050004
020600     WRITE THIS-RUN-DATE-REC.                                     02060004
020700                                                                  02070004
020710     DISPLAY '* NEW +1 GEN FILE VALUE: '                          02071006
020720             PV-TO-TIMESTAMP.                                     02072007
020730     DISPLAY '*'.                                                 02073006
020800                                                                  02080004
020900******************************************************************02090004
021000*  CREATE TIMESTAMP RANGE FILE                                    02100004
021100******************************************************************02110004
021200 3020-WRITE-TIMESTAMP.                                            02120004
021300                                                                  02130004
021400                                                                  02140004
021500     MOVE PV-FROM-TIMESTAMP     TO TR-FROM-TIMESTAMP.             02150004
021600     MOVE PV-TO-TIMESTAMP       TO TR-TO-TIMESTAMP.               02160004
021700                                                                  02170004
021800     WRITE TIMESTAMP-RECORD                                       02180004
021900      FROM TIMESTAMP-REC-OUT.                                     02190004
022000                                                                  02200004
022100     DISPLAY '* DATE RANGE FILE FOR EXTRACT: '                    02210006
022110             TIMESTAMP-REC-OUT.                                   02211006
022120     DISPLAY '*'.                                                 02212007
022200                                                                  02220004
022300                                                                  02230004
022400 9100-SQL-ABEND.                                                  02240004
022500******************************************************************02250004
022600*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    02260004
022700*  ERROR OR WARNING CODE OCCURS.                                  02270004
022800******************************************************************02280004
022900     DISPLAY '9100-SQL-ABEND'.                                    02290004
023000     DISPLAY '** ABEND     **'.                                   02300004
023100     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                02310004
023200     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02320004
023300     DISPLAY '** TABLE     ** = ' PV-ABEND-TABLE.                 02330004
023400     DISPLAY '** MESSAGE   ** = ' PV-DB2-MESSAGE.                 02340004
023500     COPY DPPD004.                                                02350004
023600                                                                  02360004
023700     MOVE +4013                  TO PV-ABEND-CODE.                02370004
023800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02380004
023900                                                                  02390004
