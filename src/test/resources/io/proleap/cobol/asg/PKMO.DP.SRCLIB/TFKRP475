      ******************************************************************00010015
       IDENTIFICATION DIVISION.                                         00020015
      ******************************************************************00030015
                                                                        00040015
       PROGRAM-ID.             TFKRP475.                                00050015
       AUTHOR.                 JACK KRAMER.                             00060015
       INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070015
       DATE-WRITTEN            MARCH 1997.                              00080015
       DATE-COMPILED.                                                   00090015
                                                                        00100015
      ******************************************************************00110015
      *    THIS PROGRAM PRODUCES A MONTHLY REPORT OF MISDIRECTED        00120015
      *  TRANSFERS SORTED BY TRANSFER NUMBER WITHIN DISTRIBUTION        00130015
      *  FACILITY.                                                      00140015
      ******************************************************************00150015
100404** 10/04/2004 CHANGED BY: RAY GRAF                                00160015
100404**     EXPAND STORE NUMBER. MAKE DOMAIN COMPLIANT.                00170015
      ***************************************************************** 00180015
100611** 10/06/2011 CHANGED BY: CHERI PARMLEY       WR#41089            00190015
100611*      INCREASED STORE TABLE SIZE - PROGRAM WAS OVERLAYING STORAGE00200015
100611*      AND NOT PRODUCING ANY OUTPUT BECAUSE OF IT.                00210015
      ******************************************************************00220015
       ENVIRONMENT DIVISION.                                            00230015
      ******************************************************************00240015
                                                                        00250015
       CONFIGURATION SECTION.                                           00260015
                                                                        00270015
       SOURCE-COMPUTER.        IBM-3090.                                00280015
       OBJECT-COMPUTER.        IBM-3090.                                00290015
                                                                        00300015
       INPUT-OUTPUT SECTION.                                            00310015
                                                                        00320015
       FILE-CONTROL.                                                    00330015
                                                                        00340015
           SELECT TRANSFER-REPORT-FILE                                  00350015
               ASSIGN TO RPT01.                                         00360015
                                                                        00370015
           SELECT PROCESS-DATES-FILE                                    00380015
               ASSIGN TO INP01.                                         00390011
                                                                        00400015
           SELECT MISDIRECT-FILE                                        00410015
               ASSIGN TO INP02                                          00420015
               FILE STATUS  IS PV-FILE-STATUS.                          00430015
      *                                                                 00440015
      ******************************************************************00450015
       DATA DIVISION.                                                   00460015
      ******************************************************************00470015
                                                                        00480015
       FILE SECTION.                                                    00490015
                                                                        00500015
       FD  TRANSFER-REPORT-FILE                                         00510015
           LABEL RECORDS ARE STANDARD                                   00520015
           RECORDING MODE IS F                                          00530015
           BLOCK CONTAINS 0 RECORDS                                     00540015
           RECORD CONTAINS 132 CHARACTERS                               00550015
           DATA RECORD IS TRANSFER-REPORT-RECORD.                       00560015
                                                                        00570015
       01  TRANSFER-REPORT-RECORD PIC X(132).                           00580015
                                                                        00590015
       FD  MISDIRECT-FILE                                               00600015
           RECORDING MODE IS F                                          00610015
           LABEL RECORDS ARE STANDARD                                   00620015
           BLOCK CONTAINS 0 RECORDS.                                    00630015
                                                                        00640015
       01  MISDIRECT-FILE-RECORD               PIC X(60).               00650015
                                                                        00660000
       FD  PROCESS-DATES-FILE                                           00670015
           LABEL RECORDS ARE STANDARD                                   00680000
           RECORDING MODE IS F                                          00690000
           BLOCK CONTAINS 0 RECORDS                                     00700000
           RECORD CONTAINS 16 CHARACTERS.                               00710015
       01  PROCESS-DATES-RECORD            PIC X(16).                   00720015
                                                                        00730015
      *                                                                 00740015
       WORKING-STORAGE SECTION.                                         00750015
                                                                        00760015
      *                                                                 00770015
      *  STANDARD REPORT HEADER FOR A 132 COLUMN REPORT                 00780015
           COPY DPWS132O.                                               00790015
                                                                        00800000
      *                                                                 00810000
      *  RECORD LAYOUT FOR THE PROCESS DATES FILE                       00820015
      *                                                                 00830000
           COPY TFRD029.                                                00840015
                                                                        00850000
      *---------------------------------------------------------------* 00860000
      * MISDIRECT TRANSFER RECORD                                       00870000
      *---------------------------------------------------------------* 00880000
           COPY TFRD032.                                                00890000
      *                                                                 00900015
      *----------------------------------------------------------------*00910015
      *  DATE VALIDATION CALLING PARAMETER LIST                        *00920015
      *----------------------------------------------------------------*00930015
           COPY DPWS500.                                                00940015
           EJECT                                                        00950015
      *---------------------------------------------------------------* 00960015
100404*    DB2 AREA FOR XST_LOC TABLE                                 * 00970015
      *---------------------------------------------------------------* 00980015
           EXEC SQL                                                     00990015
100404          INCLUDE XST00001                                        01000015
           END-EXEC.                                                    01010015
      *---------------------------------------------------------------* 01020015
      *    CURSOR TO BUILD INTERNAL STORE NAME TABLE                  * 01030015
      *---------------------------------------------------------------* 01040015
           EXEC SQL                                                     01050015
                DECLARE STORE_CSR CURSOR FOR                            01060015
                SELECT                                                  01070015
100404                LOC_NBR                                           01080015
100404               ,LOC_10_ABBR_NM                                    01090015
                FROM                                                    01100015
100404                XST_LOC                                           01110015
100404          WHERE LOC_TYP_CDE  IN ('DS', 'RV', 'DC')                01120015
           END-EXEC.                                                    01130015
                                                                        01140015
           EXEC SQL                                                     01150015
               INCLUDE SQLCA                                            01160015
           END-EXEC.                                                    01170015
      *                                                                 01180015
      *  EXTENSION TO THE SQL COMMUNICATIONS AREA FOR EDITING           01190015
      *  SQL CODES FOR DISPLAY                                          01200015
      *                                                                 01210015
           COPY SQLCA2.                                                 01220015
      *                                                                 01230015
       01  ABEND-CODE                  PIC S9(4)    VALUE ZERO          01240015
                                       COMP SYNC.                       01250015
                                                                        01260015
100611 01  NO-STRS                             PIC 9(04) VALUE ZERO.    01270015
       01  ST-STORE-TABLE.                                              01280015
100611     05  ST-STORE-ENTRIES  OCCURS 5000 TIMES INDEXED BY ST-INDX.  01290015
               10  ST-STORE-NBR                PIC 9(04).               01300015
               10  ST-STORE-NAME               PIC X(10).               01310015
                                                                        01320015
       01  PS-PROGRAM-SWITCHES.                                         01330015
           05  PS-FIRST-LINE-SW        PIC X(01)    VALUE 'Y'.          01340015
               88  PS-FIRST-LINE                    VALUE 'Y'.          01350015
               88  PS-NOT-FIRST-LINE                VALUE 'N'.          01360015
           05  PS-FIRST-TIME-SW        PIC X(01)    VALUE 'Y'.          01370015
               88  PS-FIRST-TIME                    VALUE 'Y'.          01380015
               88  PS-NOT-FIRST-TIME                VALUE 'N'.          01390015
           05  PS-END-OF-TRANSFER-SW   PIC X(01)    VALUE 'N'.          01400015
               88  PS-END-OF-TRANSFERS              VALUE 'Y'.          01410015
               88  PS-NOT-END-OF-TRANSFERS          VALUE 'N'.          01420015
           05  PS-ITEMS-READ-SW        PIC  X(01)   VALUE 'N'.          01430015
               88  PS-ITEMS-READ                    VALUE 'Y'.          01440015
               88  PS-NO-ITEMS-READ                 VALUE 'N'.          01450015
           05  PS-STORES-LEFT-SW       PIC  X(01)   VALUE 'Y'.          01460015
               88  PS-STORES-LEFT                   VALUE 'Y'.          01470015
               88  PS-NO-STORES-LEFT                VALUE 'N'.          01480015
                                                                        01490015
       01  PC-PROGRAM-CONSTANTS.                                        01500015
           05  PC-PROGRAM-NAME         PIC X(08)    VALUE 'TFKRP475'.   01510015
           05  PC-CALENDAR-PGM         PIC  X(08)  VALUE  'DPKUT500'.   01520015
           05  PC-TOTAL-LIT            PIC  X(05)  VALUE  'TOTAL'.      01530015
           05  PC-COMPANY-LIT          PIC  X(07)  VALUE  'COMPANY'.    01540015
           05  PC-COMPLETE             PIC  X(02)  VALUE  'CM'.         01550015
           05  PC-POSITIVE-RECEIPT     PIC  X(02)  VALUE  'PR'.         01560015
           05  PC-ACCEPTED             PIC  X(08)  VALUE 'ACCEPTED'.    01570015
           05  PC-REDIRECTED           PIC  X(11)  VALUE 'RE-DIRECTED'. 01580015
           05  PC-PAGE-MAX             PIC  S9(03) VALUE  +66.          01590015
           05  PC-MAX-RETRIES          PIC S9(3)   VALUE 3 COMP-3.      01600015
           05  PC-1-DAY                  PIC  S9(03) VALUE  +1  COMP-3. 01610015
                                                                        01620015
       01  PV-PROGRAM-VARIABLES.                                        01630015
           05  PV-RETRY-COUNT          PIC S9(4)    VALUE ZERO          01640015
                                       COMP SYNC.                       01650015
           05  PV-PAGE-COUNT           PIC 9(5)    VALUE ZERO.          01660015
           05  PV-LINE-COUNT           PIC S9(4)   VALUE ZERO.          01670015
           05  PV-STORE-NBR            PIC 9(04)   VALUE ZERO.          01680015
           05  PV-STORE-NAME           PIC X(10)   VALUE SPACE.         01690015
           05  PV-PARAGRAPH-NAME       PIC X(30)   VALUE SPACE.         01700015
           05  PV-DB2-OPERATION        PIC X(30)   VALUE SPACE.         01710015
           05  PV-XFER-NBR.                                             01720015
100404*        10 PV-FR-STR-NBR        PIC 9(03).                       01730015
100404         10 PV-FR-STR-NBR        PIC 9(04).                       01740015
               10                      PIC X(01)   VALUE '-'.           01750015
               10 PV-XFER-SEQ-NBR      PIC 9(06).                       01760015
           05  PV-DC-COUNT             PIC S9(08)    VALUE ZERO COMP-3. 01770015
           05  PV-DC-QTY               PIC S9(08)    VALUE ZERO COMP-3. 01780015
           05  PV-DC-RETAIL            PIC S9(09)V99 VALUE ZERO COMP-3. 01790015
           05  PV-CO-COUNT             PIC S9(08)    VALUE ZERO COMP-3. 01800015
           05  PV-CO-QTY               PIC S9(08)    VALUE ZERO COMP-3. 01810015
           05  PV-CO-RETAIL            PIC S9(09)V99 VALUE ZERO COMP-3. 01820015
           05  PV-FILE-STATUS          PIC  X(02)   VALUE SPACES.       01830015
               88  PV-FILE-SUCCESSFUL               VALUE '00'.         01840015
               88  PV-FILE-NOT-FOUND                VALUE '23'.         01850015
           05  PV-DATE.                                                 01860015
               10  PV-MONTH            PIC X(02)   VALUE SPACE.         01870015
               10                      PIC X(01)   VALUE '/'.           01880015
               10  PV-DAY              PIC X(02)   VALUE SPACE.         01890015
               10                      PIC X(01)   VALUE '/'.           01900015
               10  PV-CENTURY          PIC X(02)   VALUE SPACE.         01910015
               10  PV-YEAR             PIC X(02)   VALUE SPACE.         01920015
       01  HV-HOLD-VARIABLES.                                           01930015
100404*    05  HV-DC                   PIC  X(03)  VALUE SPACE.         01940015
100404     05  HV-DC                   PIC  9(04)  VALUE ZEROS.         01950015
           05  HV-DC-NAME10            PIC  X(10)  VALUE SPACE.         01960015
100404*    05  HV-FR-STR-NBR           PIC  9(03)  VALUE ZEROES.        01970015
100404     05  HV-FR-STR-NBR           PIC  9(05)  VALUE ZEROES.        01980015
           05  HV-XFER-SEQ-NBR         PIC  9(06)  VALUE ZEROES.        01990015
                                                                        02000015
       01  BLANK-LINE                  PIC X(132)   VALUE SPACES.       02010015
                                                                        02020015
       01  END-OF-REPORT-LINE.                                          02030015
           05  FILLER                  PIC X(52)    VALUE SPACES.       02040015
           05  FILLER                  PIC X(26)    VALUE               02050015
               '   *** END OF REPORT ***'.                              02060015
           05  FILLER                  PIC X(54)    VALUE SPACES.       02070015
                                                                        02080015
       01  NO-DATA-LINE.                                                02090015
           05  FILLER                  PIC X(35)    VALUE SPACES.       02100015
           05  FILLER                  PIC X(45)    VALUE               02110015
               '****  NO DATA TO PROCESS FOR THIS REPORT  ***'.         02120015
                                                                        02130015
       01  CD-CURRENT-DATE.                                             02140015
           05  CD-CURRENT-YEAR         PIC 9(2)     VALUE ZERO.         02150015
           05  CD-CURRENT-MONTH        PIC 9(2)     VALUE ZERO.         02160015
           05  CD-CURRENT-DAY          PIC 9(2)     VALUE ZERO.         02170015
                                                                        02180015
       01  CT-CURRENT-TIME.                                             02190015
           05  CT-CURRENT-HOUR         PIC 9(2)     VALUE ZERO.         02200015
           05  CT-CURRENT-MINUTE       PIC 9(2)     VALUE ZERO.         02210015
           05  FILLER                  PIC 9(4)     VALUE ZERO.         02220015
                                                                        02230015
       01  HL2-HEADING-LINE-2.                                          02240015
           05  FILLER                  PIC X(52)    VALUE SPACES.       02250015
           05  FILLER                  PIC X(28)    VALUE               02260015
               'MIS-DIRECTED TRANSFER REPORT'.                          02270015
           05  FILLER                  PIC X(52)    VALUE SPACES.       02280015
                                                                        02290015
       01  HL3-HEADING-LINE-3.                                          02300015
           05  FILLER                  PIC X(49)  VALUE SPACE.          02310015
           05  FILLER                  PIC X(11)    VALUE               02320015
               'FOR PERIOD'.                                            02330015
           05  HL3-FROM-DATE           PIC X(10)  VALUE SPACES.         02340015
           05  FILLER                  PIC X(04)  VALUE ' TO '.         02350015
           05  HL3-TO-DATE             PIC X(10)  VALUE SPACES.         02360015
                                                                        02370015
       01  HL4-HEADING-LINE-4.                                          02380015
100404*    05  HL4-DC                  PIC X(03)  VALUE SPACE.          02390015
100404     05  HL4-DC                  PIC 9(04)  VALUE ZEROS.          02400015
           05  FILLER                  PIC X(01)  VALUE SPACE.          02410015
           05  HL4-DC-NAME             PIC X(25)  VALUE SPACE.          02420015
                                                                        02430015
       01  HL5-HEADING-LINE-5.                                          02440015
           05  FILLER                  PIC X(75)  VALUE SPACE.          02450015
           05  FILLER                  PIC X(18)  VALUE 'ORIGINAL'.     02460015
           05  FILLER                  PIC X(12)  VALUE 'ACTUAL'.       02470015
                                                                        02480015
       01  HL6-HEADING-LINE-6.                                          02490015
           05  FILLER                  PIC X(07)  VALUE SPACE.          02500015
           05  FILLER                  PIC X(14)  VALUE 'TRANSFER'.     02510015
           05  FILLER                  PIC X(15)  VALUE 'COMPLETE'.     02520015
           05  FILLER                  PIC X(13)  VALUE 'TOTAL'.        02530015
           05  FILLER                  PIC X(12)  VALUE 'TOTAL'.        02540015
           05  FILLER                  PIC X(14)  VALUE 'RECEIVE'.      02550015
           05  FILLER                  PIC X(18)  VALUE 'RECEIVING'.    02560015
           05  FILLER                  PIC X(12)  VALUE 'LOCATION'.     02570015
                                                                        02580015
       01  HL7-HEADING-LINE-7.                                          02590015
           05  FILLER                  PIC X(07)  VALUE SPACE.          02600015
           05  FILLER                  PIC X(14)  VALUE ' NUMBER'.      02610015
           05  FILLER                  PIC X(15)  VALUE '  DATE'.       02620015
           05  FILLER                  PIC X(13)  VALUE 'UNITS'.        02630015
           05  FILLER                  PIC X(12)  VALUE 'RETAIL'.       02640015
           05  FILLER                  PIC X(14)  VALUE '  DATE'.       02650015
           05  FILLER                  PIC X(18)  VALUE 'LOCATION'.     02660015
           05  FILLER                  PIC X(18)  VALUE 'RECEIVED'.     02670015
           05  FILLER                  PIC X(12)  VALUE 'STATUS'.       02680015
                                                                        02690015
       01  DL1-DETAIL-LINE1.                                            02700015
           05  DL1-TOTAL-LIT           PIC X(06)  VALUE SPACE.          02710015
100404*    05  DL1-DOCUMENT            PIC X(10)  VALUE SPACES.         02720015
100404     05  DL1-DOCUMENT            PIC X(11)  VALUE SPACES.         02730015
100404*    05  FILLER                  PIC X(04)  VALUE SPACES.         02740015
100404     05  FILLER                  PIC X(03)  VALUE SPACES.         02750015
           05  DL1-COMPLETE-DATE       PIC X(10)  VALUE SPACES.         02760015
           05  FILLER REDEFINES DL1-COMPLETE-DATE.                      02770015
               10  DL1-COUNT           PIC ZZZ,ZZZ.                     02780015
               10                      PIC X(03).                       02790015
           05  FILLER                  PIC X(01)  VALUE SPACES.         02800015
           05  DL1-QTY                 PIC ZZ,ZZZ,ZZZ.                  02810015
           05  FILLER                  PIC X(01)  VALUE SPACES.         02820015
           05  DL1-RETAIL              PIC ZZZ,ZZZ,ZZ9.99               02830015
                                           BLANK WHEN ZERO.             02840015
           05  FILLER                  PIC X(04)  VALUE SPACES.         02850015
           05  DL1-RECEIVE-DATE        PIC X(10)  VALUE SPACES.         02860015
100404*    05  FILLER                  PIC X(04)  VALUE SPACES.         02870015
100404     05  FILLER                  PIC X(03)  VALUE SPACES.         02880015
100404*    05  DL1-TO-STR-NBR          PIC X(03)  VALUE SPACES.         02890015
100404     05  DL1-TO-STR-NBR          PIC 9(04)  VALUE ZEROES.         02900015
           05  FILLER                  PIC X(01)  VALUE SPACES.         02910015
           05  DL1-TO-STR-NAME         PIC X(10)  VALUE SPACES.         02920015
100404*    05  FILLER                  PIC X(04)  VALUE SPACES.         02930015
100404     05  FILLER                  PIC X(03)  VALUE SPACES.         02940015
100404*    05  DL1-RCV-STR-NBR         PIC X(03)  VALUE SPACES.         02950015
100404     05  DL1-RCV-STR-NBR         PIC 9(04)  VALUE ZEROES.         02960015
           05  FILLER                  PIC X(01)  VALUE SPACES.         02970015
           05  DL1-RCV-STR-NAME        PIC X(10)  VALUE SPACES.         02980015
           05  FILLER                  PIC X(04)  VALUE SPACES.         02990015
           05  DL1-STATUS              PIC X(11)  VALUE SPACES.         03000015
                                                                        03010015
      ******************************************************************03020015
       PROCEDURE DIVISION.                                              03030015
      ******************************************************************03040015
       0000-MAINLINE.                                                   03050015
           PERFORM 1000-INITIALIZE.                                     03060015
           PERFORM 2000-PROCESS-DATA.                                   03070015
                                                                        03080015
           IF PS-NO-ITEMS-READ                                          03090015
               PERFORM 8000-PRINT-HEADINGS                              03100015
               WRITE TRANSFER-REPORT-RECORD                             03110015
                   FROM NO-DATA-LINE                                    03120015
                   AFTER ADVANCING 2                                    03130015
           END-IF.                                                      03140015
                                                                        03150015
           WRITE TRANSFER-REPORT-RECORD                                 03160015
               FROM END-OF-REPORT-LINE                                  03170015
               AFTER ADVANCING 2.                                       03180015
                                                                        03190015
           DISPLAY 'NO STORES = ' NO-STRS.                              03200015
                                                                        03210015
           CLOSE TRANSFER-REPORT-FILE                                   03220015
                 MISDIRECT-FILE                                         03230015
                 PROCESS-DATES-FILE.                                    03240015
           STOP RUN.                                                    03250015
                                                                        03260015
      ******************************************************************03270015
      *  SET UP FOR PROGRAM PROCESSING BY OPENING FILES,                03280015
      *  FILLING THE FIELDS OF THE STANDARD REPORT HEADER.              03290015
      ******************************************************************03300015
                                                                        03310015
       1000-INITIALIZE.                                                 03320015
           PERFORM 1100-OPEN-STORE-CURSOR.                              03330015
           PERFORM 1200-READ-ITEMS-FROM-DB.                             03340015
           PERFORM 1400-CLOSE-STORE-CURSOR.                             03350015
           OPEN OUTPUT TRANSFER-REPORT-FILE                             03360015
                INPUT  MISDIRECT-FILE                                   03370015
                       PROCESS-DATES-FILE.                              03380015
           ACCEPT CD-CURRENT-DATE FROM DATE.                            03390015
           MOVE CD-CURRENT-YEAR TO DP132O-RUN-YEAR.                     03400015
           MOVE CD-CURRENT-MONTH TO DP132O-RUN-MONTH.                   03410015
           MOVE CD-CURRENT-DAY TO DP132O-RUN-DAY.                       03420015
                                                                        03430015
           MOVE 100 TO PV-LINE-COUNT.                                   03440015
                                                                        03450015
           ACCEPT CT-CURRENT-TIME FROM TIME.                            03460015
           MOVE CT-CURRENT-HOUR TO DP132O-RUN-HOUR.                     03470015
           MOVE CT-CURRENT-MINUTE TO DP132O-RUN-MINUTE.                 03480015
           MOVE 'TFKRP475' TO DP132O-PROGRAM-NAME.                      03490015
           MOVE 1 TO DP132O-REPORT-NUMBER.                              03500015
           READ PROCESS-DATES-FILE                                      03510015
               INTO TF029-PROCESS-DATES-RECORD                          03520015
           END-READ.                                                    03530000
           DISPLAY 'TF029-PROCESS-DATES-RECORD = '                      03540015
               TF029-PROCESS-DATES-RECORD.                              03550015
           MOVE TF029-PROCESS-START-MONTH    TO PV-MONTH.               03560015
           MOVE TF029-PROCESS-START-DAY      TO PV-DAY.                 03570015
           MOVE TF029-PROCESS-START-YEAR     TO PV-YEAR.                03580015
           MOVE TF029-PROCESS-START-CENTURY  TO PV-CENTURY.             03590015
           MOVE PV-DATE                      TO HL3-FROM-DATE.          03600015
           MOVE TF029-PROCESS-END-MONTH      TO PV-MONTH.               03610015
           MOVE TF029-PROCESS-END-DAY        TO PV-DAY.                 03620015
           MOVE TF029-PROCESS-END-YEAR       TO PV-YEAR.                03630015
           MOVE TF029-PROCESS-END-CENTURY    TO PV-CENTURY.             03640015
           MOVE PV-DATE                      TO HL3-TO-DATE.            03650015
      ******************************************************************03660015
      *  OPEN THE STORE CURSOR                                          03670015
      ******************************************************************03680015
       1100-OPEN-STORE-CURSOR.                                          03690015
                                                                        03700015
           PERFORM WITH TEST AFTER                                      03710015
               VARYING PV-RETRY-COUNT FROM 1 BY 1                       03720015
               UNTIL SQLCODE = 0 OR                                     03730015
                     PV-RETRY-COUNT > PC-MAX-RETRIES                    03740015
                   EXEC SQL                                             03750015
                        OPEN STORE_CSR                                  03760015
                   END-EXEC                                             03770015
                                                                        03780015
               EVALUATE TRUE                                            03790015
                   WHEN SQLCODE = +0                                    03800015
                       SET PS-STORES-LEFT TO TRUE                       03810015
                   WHEN SQLCODE = +100                                  03820015
                       SET PS-NO-STORES-LEFT TO TRUE                    03830015
                   WHEN SQLCODE = -904                                  03840015
                   WHEN SQLCODE = -911                                  03850015
                       CONTINUE                                         03860015
                   WHEN OTHER                                           03870015
                       DISPLAY '1100-OPEN-STORE-CURSOR'                 03880015
                       DISPLAY 'OPEN THE STORE CURSOR'                  03890015
                       PERFORM 9100-SQL-ERROR                           03900015
               END-EVALUATE                                             03910015
           END-PERFORM.                                                 03920015
                                                                        03930015
           IF PV-RETRY-COUNT > PC-MAX-RETRIES                           03940015
             DISPLAY '1100-OPEN-STORE-CURSOR'                           03950015
             DISPLAY 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO '          03960015
             DISPLAY 'OPEN THE STORE CURSOR'                            03970015
             PERFORM 9100-SQL-ERROR                                     03980015
           END-IF.                                                      03990015
       1200-READ-ITEMS-FROM-DB.                                         04000015
                                                                        04010015
           PERFORM                                                      04020015
               UNTIL (PS-NO-STORES-LEFT)                                04030015
                                                                        04040015
               PERFORM 1300-FETCH-STORE-CURSOR                          04050015
                                                                        04060015
               IF  PS-STORES-LEFT                                       04070015
100404             MOVE XST00001-LOC-NBR    TO ST-STORE-NBR (ST-INDX)   04080015
100404             MOVE XST00001-LOC-10-ABBR-NM                         04090015
                                            TO ST-STORE-NAME (ST-INDX)  04100015
                   SET ST-INDX              UP BY 1                     04110015
                                                                        04120015
100611             ADD 1 TO NO-STRS                                     04130015
                                                                        04140015
               END-IF                                                   04150015
           END-PERFORM.                                                 04160015
      *----------------------------------------------------------------*04170015
      *    FETCH THE STORE CURSOR                                      *04180015
      *----------------------------------------------------------------*04190015
                                                                        04200015
       1300-FETCH-STORE-CURSOR.                                         04210015
                                                                        04220015
           EXEC SQL                                                     04230015
               FETCH STORE_CSR                                          04240015
               INTO                                                     04250015
100404                :XST00001-LOC-NBR                                 04260015
100404              , :XST00001-LOC-10-ABBR-NM                          04270015
           END-EXEC                                                     04280015
                                                                        04290015
           EVALUATE TRUE                                                04300015
               WHEN SQLCODE = ZERO                                      04310015
                    CONTINUE                                            04320015
               WHEN SQLCODE = +100                                      04330015
                    SET PS-NO-STORES-LEFT  TO TRUE                      04340015
               WHEN OTHER                                               04350015
                    DISPLAY '1300-FETCH-STORE-CURSOR'                   04360015
100404              DISPLAY 'READ XST_LOC'                              04370015
                    PERFORM 9100-SQL-ERROR                              04380015
           END-EVALUATE.                                                04390015
                                                                        04400015
       EJECT                                                            04420015
      ******************************************************************04430015
      * CLOSE THE STORE CURSOR                                          04440015
      ******************************************************************04450015
       1400-CLOSE-STORE-CURSOR.                                         04460015
           EXEC SQL                                                     04470015
               CLOSE STORE_CSR                                          04480015
           END-EXEC.                                                    04490015
                                                                        04500015
      ******************************************************************04510015
      * PROCESS MISDIRECT TRANSFERS                                     04520015
      ******************************************************************04530015
       2000-PROCESS-DATA.                                               04540015
           PERFORM                                                      04560015
               UNTIL PS-END-OF-TRANSFERS                                04570015
                 PERFORM 2150-READ-TRANSFER                             04580015
                 IF PS-NOT-END-OF-TRANSFERS                             04590015
100611              PERFORM 3000-PROCESS-TRANSFER                       04600015
                 END-IF                                                 04610015
           END-PERFORM.                                                 04620015
           IF PS-ITEMS-READ                                             04630015
               PERFORM 5000-DC-TOTAL                                    04640015
               PERFORM 7000-COMPANY-TOTAL                               04650015
           END-IF.                                                      04660015
                                                                        04670015
       EJECT                                                            04680015
      *----------------------------------------------------------------*04690015
      *    READ THE MISDIRECT FILE                                     *04700015
      *----------------------------------------------------------------*04710015
       2150-READ-TRANSFER.                                              04720015
                                                                        04730015
           READ MISDIRECT-FILE                                          04740015
               INTO TF032-XFER-MISDIRECT-RECORD                         04750015
                   AT END                                               04760015
                       SET PS-END-OF-TRANSFERS   TO  TRUE               04770015
           END-READ.                                                    04780015
      *----------------------------------------------------------------*04790015
      *  PROCESS THE TRANSFER                                           04800015
      *----------------------------------------------------------------*04810015
       3000-PROCESS-TRANSFER.                                           04820015
           IF PS-FIRST-TIME                                             04830015
               PERFORM 6000-READ-DC-NAME                                04840015
               SET PS-NOT-FIRST-TIME        TO TRUE                     04850015
           END-IF.                                                      04860015
           IF TF032-DIST-FACILITY NOT = HV-DC                           04870015
               PERFORM 5000-DC-TOTAL                                    04880015
               PERFORM 6000-READ-DC-NAME                                04890015
           END-IF.                                                      04900015
           MOVE SPACES                     TO DL1-DETAIL-LINE1.         04910015
           IF PV-LINE-COUNT > PC-PAGE-MAX                               04920015
               PERFORM 8000-PRINT-HEADINGS                              04930015
           END-IF.                                                      04940015
           IF TF032-FROM-STR-NBR NOT = HV-FR-STR-NBR OR                 04950015
              TF032-XFER-SEQ-NBR NOT = HV-XFER-SEQ-NBR                  04960015
               ADD 1                        TO PV-DC-COUNT              04970015
               ADD  TF032-XFER-TOT-UNITS    TO PV-DC-QTY                04980015
               ADD  TF032-XFER-TOT-RETAIL   TO PV-DC-RETAIL             04990015
               MOVE TF032-FROM-STR-NBR      TO HV-FR-STR-NBR            05000015
               MOVE TF032-XFER-SEQ-NBR      TO HV-XFER-SEQ-NBR          05010015
               SET PS-FIRST-LINE            TO TRUE                     05020015
           END-IF.                                                      05030015
           IF PS-FIRST-LINE                                             05040015
               MOVE TF032-FROM-STR-NBR      TO PV-FR-STR-NBR            05050015
               MOVE TF032-XFER-SEQ-NBR      TO PV-XFER-SEQ-NBR          05060015
               MOVE PV-XFER-NBR             TO DL1-DOCUMENT             05070015
               MOVE TF032-XFER-TOT-UNITS    TO DL1-QTY                  05080015
               MOVE TF032-XFER-TOT-RETAIL   TO DL1-RETAIL               05090015
               MOVE TF032-COMPLETE-CC       TO PV-CENTURY               05100015
               MOVE TF032-COMPLETE-YY       TO PV-YEAR                  05110015
               MOVE TF032-COMPLETE-MM       TO PV-MONTH                 05120015
               MOVE TF032-COMPLETE-DD       TO PV-DAY                   05130015
               MOVE PV-DATE                 TO DL1-COMPLETE-DATE        05140015
               SET PS-NOT-FIRST-LINE        TO TRUE                     05150015
           END-IF.                                                      05160015
           MOVE TF032-RECEIVE-CC            TO PV-CENTURY.              05170015
           MOVE TF032-RECEIVE-YY            TO PV-YEAR.                 05180015
           MOVE TF032-RECEIVE-MM            TO PV-MONTH.                05190015
           MOVE TF032-RECEIVE-DD            TO PV-DAY.                  05200015
           MOVE PV-DATE                     TO DL1-RECEIVE-DATE.        05210015
           MOVE TF032-TO-STR-NBR            TO PV-STORE-NBR             05220015
                                               DL1-TO-STR-NBR.          05230015
           PERFORM 3100-FIND-STORE.                                     05240015
           MOVE PV-STORE-NAME               TO DL1-TO-STR-NAME.         05250015
           MOVE TF032-RECV-STR-NBR          TO PV-STORE-NBR             05260015
                                               DL1-RCV-STR-NBR.         05270015
           PERFORM 3100-FIND-STORE.                                     05280015
           MOVE PV-STORE-NAME               TO DL1-RCV-STR-NAME.        05290015
           IF TF032-XFER-STATUS = PC-POSITIVE-RECEIPT                   05300015
               MOVE PC-ACCEPTED             TO DL1-STATUS               05310015
           ELSE                                                         05320015
               MOVE PC-REDIRECTED           TO DL1-STATUS               05330015
           END-IF.                                                      05340015
           WRITE TRANSFER-REPORT-RECORD                                 05350015
               FROM DL1-DETAIL-LINE1                                    05360015
               AFTER ADVANCING 1.                                       05370015
           ADD 1                           TO PV-LINE-COUNT.            05380015
                                                                        05390015
      *----------------------------------------------------------------*05400015
      *    SEARCH THE INTERNAL STORE TABLE FOR THE STORE NAME          *05410015
      *----------------------------------------------------------------*05420015
       3100-FIND-STORE.                                                 05430015
           SET ST-INDX                 TO 1.                            05440015
           SEARCH ST-STORE-ENTRIES                                      05450015
             VARYING ST-INDX                                            05460015
               AT END                                                   05470015
                   MOVE '**********'            TO PV-STORE-NAME        05480015
               WHEN ST-STORE-NBR (ST-INDX) = PV-STORE-NBR               05490015
                   MOVE ST-STORE-NAME (ST-INDX) TO PV-STORE-NAME        05500015
           END-SEARCH.                                                  05510015
      *----------------------------------------------------------------*05520015
      *  PRINT DC TOTAL AND FIND NEW DC NAME.                           05530015
      *----------------------------------------------------------------*05540015
       5000-DC-TOTAL.                                                   05550015
           MOVE SPACES                     TO DL1-DETAIL-LINE1.         05560015
           MOVE PC-TOTAL-LIT               TO DL1-TOTAL-LIT.            05570015
           MOVE HV-DC-NAME10               TO DL1-DOCUMENT.             05580015
           MOVE PV-DC-COUNT                TO DL1-COUNT.                05590015
           MOVE PV-DC-QTY                  TO DL1-QTY.                  05600015
           MOVE PV-DC-RETAIL               TO DL1-RETAIL.               05610015
           WRITE TRANSFER-REPORT-RECORD                                 05620015
               FROM DL1-DETAIL-LINE1                                    05630015
               AFTER ADVANCING 2.                                       05640015
           ADD 2                           TO PV-LINE-COUNT.            05650015
           ADD PV-DC-COUNT                 TO PV-CO-COUNT.              05660015
           ADD PV-DC-QTY                   TO PV-CO-QTY.                05670015
           ADD PV-DC-RETAIL                TO PV-CO-RETAIL.             05680015
           MOVE ZEROES                     TO PV-DC-COUNT               05690015
                                              PV-DC-QTY                 05700015
                                              PV-DC-RETAIL.             05710015
           MOVE +90                        TO PV-LINE-COUNT.            05720015
       EJECT                                                            05730015
      *----------------------------------------------------------------*05740015
      *    GET THE STORE NAME & 10 CHAR. ABBREVIETED NAME FOR THE DC   *05750015
      *----------------------------------------------------------------*05760015
       6000-READ-DC-NAME.                                               05770015
100404     MOVE TF032-DIST-FACILITY  TO XST00001-LOC-NBR.               05780015
           PERFORM WITH TEST AFTER                                      05790015
               VARYING PV-RETRY-COUNT FROM 1 BY 1                       05800015
                 UNTIL PV-RETRY-COUNT > PC-MAX-RETRIES                  05810015
                    OR SQLCODE = ZERO                                   05820015
                    OR SQLCODE = +100                                   05830015
               EXEC SQL                                                 05840015
100404             SELECT LOC_NM                                        05850015
100404                   ,LOC_10_ABBR_NM                                05860015
100404                 INTO :XST00001-LOC-NM                            05870015
100404                     ,:XST00001-LOC-10-ABBR-NM                    05880015
100404                 FROM XST_LOC                                     05890015
100404                 WHERE LOC_NBR = :XST00001-LOC-NBR                05900015
               END-EXEC                                                 05910015
               EVALUATE TRUE                                            05920015
                   WHEN SQLCODE = ZERO                                  05930015
100404                 MOVE XST00001-LOC-10-ABBR-NM  TO HV-DC-NAME10    05940015
100404                 MOVE XST00001-LOC-NM          TO HL4-DC-NAME     05950015
                   WHEN SQLCODE = +100                                  05960015
                       MOVE 'INVALID DC'             TO HV-DC-NAME10    05970015
                                                        HL4-DC-NAME     05980015
                   WHEN SQLCODE = -904                                  05990015
                   WHEN SQLCODE = -913                                  06000015
                       CONTINUE                                         06010015
                   WHEN OTHER                                           06020015
                       DISPLAY '6000-READ-DC-NAME'                      06030015
                       DISPLAY 'READ THE STORE TABLE'                   06040015
                       PERFORM 9100-SQL-ERROR                           06050015
               END-EVALUATE                                             06060015
           END-PERFORM.                                                 06070015
                                                                        06080015
           IF PV-RETRY-COUNT > PC-MAX-RETRIES                           06090015
               DISPLAY '6000-READ-DC-NAME'                              06100015
               DISPLAY 'MAXIMUM RETRIES EXCEEDED ATTEMPTING TO '        06110015
               DISPLAY 'READ THE STORE TABLE'                           06120015
               PERFORM 9100-SQL-ERROR                                   06130015
           END-IF.                                                      06140015
           MOVE TF032-DIST-FACILITY          TO HL4-DC                  06150015
                                                HV-DC.                  06160015
      *----------------------------------------------------------------*06170015
      *  PRINT THE GRAND TOTAL                                          06180015
      *----------------------------------------------------------------*06190015
       7000-COMPANY-TOTAL.                                              06200015
           MOVE SPACES                     TO DL1-DETAIL-LINE1.         06210015
           MOVE PC-TOTAL-LIT               TO DL1-TOTAL-LIT.            06220015
           MOVE PC-COMPANY-LIT             TO DL1-DOCUMENT.             06230015
           MOVE PV-CO-COUNT                TO DL1-COUNT.                06240015
           MOVE PV-CO-QTY                  TO DL1-QTY.                  06250015
           MOVE PV-CO-RETAIL               TO DL1-RETAIL.               06260015
           WRITE TRANSFER-REPORT-RECORD                                 06270015
               FROM DL1-DETAIL-LINE1                                    06280015
               AFTER ADVANCING 3.                                       06290015
      ******************************************************************06300015
      *  PRINT REPORT HEADINGS.                                         06310015
      ******************************************************************06320015
       8000-PRINT-HEADINGS.                                             06330015
           SET PS-FIRST-LINE               TO TRUE.                     06340015
           IF PS-NO-ITEMS-READ                                          06350015
               SET PS-ITEMS-READ           TO TRUE                      06360015
           END-IF.                                                      06370015
           ADD 1 TO PV-PAGE-COUNT.                                      06380015
           MOVE 9             TO PV-LINE-COUNT.                         06390015
           MOVE PV-PAGE-COUNT TO DP132O-PAGE-NUMBER.                    06400015
           WRITE TRANSFER-REPORT-RECORD                                 06410015
               FROM DP132O-STANDRD-HEADER-132-COLS                      06420015
               AFTER ADVANCING PAGE.                                    06430015
           WRITE TRANSFER-REPORT-RECORD                                 06440015
               FROM HL2-HEADING-LINE-2                                  06450015
               AFTER ADVANCING 1.                                       06460015
           WRITE TRANSFER-REPORT-RECORD                                 06470015
               FROM HL3-HEADING-LINE-3                                  06480015
               AFTER ADVANCING 1.                                       06490015
           WRITE TRANSFER-REPORT-RECORD                                 06500015
               FROM HL4-HEADING-LINE-4                                  06510015
               AFTER ADVANCING 1.                                       06520015
           WRITE TRANSFER-REPORT-RECORD                                 06530015
               FROM HL5-HEADING-LINE-5                                  06540015
               AFTER ADVANCING 1.                                       06550015
           WRITE TRANSFER-REPORT-RECORD                                 06560015
               FROM HL6-HEADING-LINE-6                                  06570015
               AFTER ADVANCING 1.                                       06580015
           WRITE TRANSFER-REPORT-RECORD                                 06590015
               FROM HL7-HEADING-LINE-7                                  06600015
               AFTER ADVANCING 1.                                       06610015
           WRITE TRANSFER-REPORT-RECORD                                 06620015
               FROM BLANK-LINE                                          06630015
               AFTER ADVANCING 1.                                       06640015
                                                                        06650015
      ******************************************************************06660015
      *  PRINT REPORT HEADINGS - SUMMARY.                               06670015
      ******************************************************************06680015
      ******************************************************************06690015
      *  FORMAT A DB2 ERROR MESSAGE, RELEASE ALL LOCKS, AND ABEND THE  *06700015
      *  PROGRAM.                                                      *06710015
      ******************************************************************06720015
       9100-SQL-ERROR.                                                  06730015
           MOVE SQLCODE TO SQLCODE2.                                    06740015
           MOVE SQLERRD(3) TO SQLERRD3.                                 06750015
           DISPLAY '** ABEND **'.                                       06760015
           DISPLAY 'TFKRP475 - SQL ERROR'.                              06770015
           DISPLAY '       SQLCODE = ' SQLCODE2.                        06780015
           DISPLAY '      SQLWARN0 = ' SQLWARN0.                        06790015
           DISPLAY '      SQLWARN1 = ' SQLWARN1.                        06800015
           DISPLAY '      SQLWARN2 = ' SQLWARN2.                        06810015
           DISPLAY '      SQLWARN3 = ' SQLWARN3.                        06820015
           DISPLAY '      SQLWARN4 = ' SQLWARN4.                        06830015
           DISPLAY '      SQLWARN5 = ' SQLWARN5.                        06840015
           DISPLAY '      SQLWARN6 = ' SQLWARN6.                        06850015
           DISPLAY '      SQLWARN7 = ' SQLWARN7.                        06860015
           DISPLAY 'ROWS PROCESSED = ' SQLERRD3.                        06870015
           DISPLAY                    '** PARAGRAPH ** = '              06880015
                                       PV-PARAGRAPH-NAME.               06890015
           DISPLAY                    '** OPERATION ** = '              06900015
                                       PV-DB2-OPERATION.                06910015
                                                                        06920015
           EXEC SQL                                                     06930015
               COMMIT                                                   06940015
           END-EXEC.                                                    06950015
                                                                        06960015
           MOVE +4013 TO ABEND-CODE.                                    06970015
           CALL 'ILBOABN0' USING ABEND-CODE.                            06980015
                                                                        06990015
