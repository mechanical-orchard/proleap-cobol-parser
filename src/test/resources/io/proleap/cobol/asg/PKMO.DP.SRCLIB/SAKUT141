000100******************************************************************00010002
000200 IDENTIFICATION DIVISION.                                         00020002
000300*                                                                 00030002
000400*                                                                 00040002
000500 PROGRAM-ID.    SAKUT141.                                         00050002
000600 AUTHOR.        CHRIS CLARK.                                      00060002
000700 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00070002
000800 DATE-WRITTEN.  02/20/04.                                         00080002
000900 DATE-COMPILED.                                                   00090002
001000*                                                                 00100002
001100******************************************************************00110002
001200* THIS PROGRAM EXTRACTS THE SMALLEST AND LARGEST RETAIL AMOUNT   *00120002
001300* FOR EACH DEPARTMENT ON THE XS DOMAIN TABLES.  THE RETAIL AMOUNT*00130002
001310* RETURNED INCLUDES REGINAL CLEARANCE PRICING.  IT CREATES AN    *00140002
001400* OUTPUT RECORD FOR EACH DEPARTMENT WITH EACH OF THE TWO AMOUNTS.*00150002
001400* THIS PROGRAM WAS ORIGINALLY EPKUT034.                          *00150002
001500******************************************************************00160002
001600* HISTORY LOG:                                                    00170002
001700*                                                                 00180002
087742* DATE: 07/22/2014                                                00190002
087742* WR/IR#:                                                         00200002
087742* PROGRAMMER: COGNIZANT                                           00210002
087742* DESCRIPTION:                                                    00220002
087742* ADDED THE CONDITION "AND VND.STYL_ID = VND.STYL_ID" IN MIN-MAX  00230002
087742* CURSOR TO IMPROVE THE PERFORMANCE OF CPU TIME AS PER SUGGESTION 00240002
087742* FROM DBA.                                                       00250002
087742* FIND THE TAG 087742 FOR CHANGES.                                00260002
002200******************************************************************00270002
P48136* DATE: 09/29/2014                                                00190002
P48136* WR/IR#: CHG0096449,PRB0048136                                   00200002
P48136* PROGRAMMER: COGNIZANT                                           00210002
P48136* DESCRIPTION:                                                    00220002
P48136* ADDED THE WORK TABLE XSTW_VND_STYL_SKU IN THE MIN-MAX-CURSOR    00230002
P48136* INSTEAD OF XST_SKU AND XST_VND_STYL. MODIFIED THE LOGIC         00240002
002200******************************************************************00270002
243538* DATE: 06/01/2020                                                00190002
244693* WR/IR#: CHG0244693                                              00200002
244693* PROGRAMMER: GERMAN BANDA                                        00210002
244693* DESCRIPTION:                                                    00220002
244693* ADDED AND SKU.INTR_UPC_ID   = SKU.INTR_UPC_ID  TO THE CURSOR    00230002
244693* DBA ALSO ADDING NEW INDEX ON INTR_UPC_ID , BEG_TMST             00240002
244693* ON XST_SKU_LOC TO REDUCE CPU TIME.                              00250002
002200******************************************************************00270002
243538* DATE: 06/18/2020                                                00190002
244693* WR/IR#: CHG0??????                                              00200002
244693* PROGRAMMER: BARB SCHULTZ                                        00210002
244693* DESCRIPTION:                                                    00220002
244693* ORIGINALLY THIS PROGRAM WAS EPKUT034. NO CHANGES WERE DONE TO IT00230002
244693* BESIDES RENAMING IT.                                            00240002
002200******************************************************************00270002
002300 ENVIRONMENT DIVISION.                                            00280002
002400******************************************************************00290002
002500*                                                                 00300002
002600 CONFIGURATION SECTION.                                           00310002
002700*                                                                 00320002
002800 SOURCE-COMPUTER.  IBM-3090.                                      00330002
002900 OBJECT-COMPUTER.  IBM-3090.                                      00340002
003000*                                                                 00350002
003100 INPUT-OUTPUT SECTION.                                            00360002
003200*                                                                 00370002
003300 FILE-CONTROL.                                                    00380002
003400     SELECT DATE-CARD-FILE                                        00390002
003500         ASSIGN TO INP01.                                         00400002
                                                                                
003600     SELECT DEPT-EXTRACT-FILE                                     00410002
003700         ASSIGN TO OUT01.                                         00420002
003800*                                                                 00430002
003900******************************************************************00440002
004000 DATA DIVISION.                                                   00450002
004100******************************************************************00460002
004200*                                                                 00470002
004300 FILE SECTION.                                                    00480002
004400*                                                                 00490002
004500 FD  DATE-CARD-FILE                                               00500002
004600     RECORDING MODE IS F                                          00510002
004700     BLOCK CONTAINS 0 RECORDS                                     00520002
004800     LABEL RECORDS ARE STANDARD.                                  00530002
004900 01  DATE-CARD-RECORD              PIC X(80).                     00540002
005000                                                                  00550002
005100 FD  DEPT-EXTRACT-FILE                                            00560002
005200     RECORDING MODE IS F                                          00570002
005300     LABEL RECORDS ARE STANDARD                                   00580002
005400     RECORD CONTAINS 80 CHARACTERS                                00590002
005500     BLOCK CONTAINS 0 RECORDS                                     00600002
005600     DATA RECORD IS DEPT-EXTRACT-RECORD.                          00610002
005700 01  DEPT-EXTRACT-RECORD           PIC X(80).                     00620002
005800*                                                                 00630002
005900******************************************************************00640002
006000 WORKING-STORAGE SECTION.                                         00650002
006100******************************************************************00660002
006200 01  AC-ABEND-CODE                 PIC S9(04)    VALUE +0.        00670002
006300     88  AC-CONTROL-CARD-ERROR                   VALUE +4003.     00680002
006400     88  AC-DB2-ERROR                            VALUE +4013.     00690002
006500     88  AC-CALENDAR-ROUTINE-ERROR               VALUE +4019.     00700002
006600                                                                  00710002
006700 01  CC-CONTROL-CARD-DISPLAY.                                     00720002
006800     05  CC-DATE-CCYY-MM-DD.                                      00730002
006900         10 CC-DATE-DT-CCYY          PIC X(04)  VALUE SPACES.     00740002
007000         10 FILLER                   PIC X(01)  VALUE SPACES.     00750002
007100         10 CC-DATE-DT-MM            PIC X(02)  VALUE SPACES.     00760002
007200         10 FILLER                   PIC X(01)  VALUE SPACES.     00770002
007300         10 CC-DATE-DT-DD            PIC X(02)  VALUE SPACES.     00780002
007400     05  FILLER                      PIC X(70)  VALUE SPACES.     00790002
007500                                                                  00800002
007600* WORKING STORAGE FOR DPKUT500 INTERFACE                          00810002
007700     COPY DPWS500.                                                00820002
007800                                                                  00830002
007900*    ERROR MESSAGE AREA FOR DB2                                   00840002
008000     COPY DPWS004.                                                00850002
008100                                                                  00860002
008200******************************************************************00870002
008300* AREA FOR STORING SYSTEM DATE AND TIME                           00880002
008400******************************************************************00890002
008500                                                                  00900002
008600******************************************************************00910002
008700* PC- PROGRAM CONSTANTS                                           00920002
008800******************************************************************00930002
008900 01  PC-PROGRAM-CONSTANTS.                                        00940002
009000     05  PC-CURRENT-PROGRAM-NAME   PIC  X(08)    VALUE 'SAKUT141'.00950002
009100     05  PC-ROW-NOT-FOUND          PIC S9(04)    VALUE +100       00960002
009200                                                   COMP SYNC.     00970002
009300                                                                  00980002
009400******************************************************************00990002
009500* PV- PROGRAM VARIABLES                                           01000002
009600******************************************************************01010002
009700                                                                  01020002
009800 01  PROGRAM-VARIABLES.                                           01030002
009900     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01040002
010000     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01050002
010100     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01060002
010200     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01070002
010300     05  PV-DEPT-NBR.                                             01080002
010400         10  PV-DEPT-NBR-1           PIC S9(1)V     COMP-3.       01090002
010500         10  PV-DEPT-NBR-3           PIC S9(3)V     COMP-3.       01100002
010600     05  PV-MIN-UNT-RTL-AMT          PIC S9(7)V9(2) COMP-3.       01110002
010700     05  PV-MAX-UNT-RTL-AMT          PIC S9(7)V9(2) COMP-3.       01120002
010800                                                                  01130002
P48136     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO                
P48136                                                COMP-3.                   
P48136     05  PV-SQL-INSERT-COUNT      PIC 9(09)     VALUE ZERO                
P48136                                                COMP-3.                   
010800                                                                  01130002
010900     05  PV-START-TIMESTAMP-DET.                                  01140002
011000         10  PV-START-DATE            PIC  X(10)     VALUE SPACES.01150002
011100         10  FILLER                   PIC  X(01)     VALUE '-'.   01160002
011200         10  PV-START-HH              PIC  X(02)     VALUE '00'.  01170002
011300         10  FILLER                   PIC  X(01)     VALUE '.'.   01180002
011400         10  PV-START-MN              PIC  X(02)     VALUE '00'.  01190002
011500         10  FILLER                   PIC  X(01)     VALUE '.'.   01200002
011600         10  PV-START-SS              PIC  X(02)     VALUE '00'.  01210002
011700         10  FILLER                   PIC  X(01)     VALUE '.'.   01220002
011800         10  PV-START-TTTTTT          PIC  X(06)     VALUE        01230002
011900                                                     '000000'.    01240002
012000     05  PV-START-TIMESTAMP REDEFINES                             01250002
012100           PV-START-TIMESTAMP-DET                                 01260002
012200                                      PIC  X(26).                 01270002
012300                                                                  01280002
012400     05  PV-END-TIMESTAMP-DET.                                    01290002
012500         10  PV-END-DATE              PIC  X(10)     VALUE SPACES.01300002
012600         10  FILLER                   PIC  X(01)     VALUE '-'.   01310002
012700         10  PV-END-HH                PIC  X(02)     VALUE '23'.  01320002
012800         10  FILLER                   PIC  X(01)     VALUE '.'.   01330002
012900         10  PV-END-MN                PIC  X(02)     VALUE '59'.  01340002
013000         10  FILLER                   PIC  X(01)     VALUE '.'.   01350002
013100         10  PV-END-SS                PIC  X(02)     VALUE '59'.  01360002
013200         10  FILLER                   PIC  X(01)     VALUE '.'.   01370002
013300         10  PV-END-TTTTTT            PIC  X(06)     VALUE        01380002
013400                                                     '999999'.    01390002
013500     05  PV-END-TIMESTAMP REDEFINES                               01400002
013600           PV-END-TIMESTAMP-DET                                   01410002
013700                                      PIC  X(26).                 01420002
P48136     05  PV-TEMP-SELCT-CNT            PIC  9(20) VALUE ZEROS.             
013800                                                                  01430002
013900******************************************************************01440002
014000* PS- PROGRAM SWITCHES                                            01450002
014100******************************************************************01460002
014200 01  PS-PROGRAM-SWITCHES.                                         01470002
014300     05  PS-END-MIN-MAX-CURSOR-SW     PIC  X(01)    VALUE 'N'.    01480002
014400         88  PS-END-MIN-MAX-CURSOR-Y                VALUE 'Y'.    01490002
014500         88  PS-END-MIN-MAX-CURSOR-N                VALUE 'N'.    01500002
014600     05  PS-END-OF-CARD-FILE-SW       PIC  X(01)    VALUE 'N'.    01510002
014700         88  PS-END-OF-CARD-FILE                    VALUE 'Y'.    01520002
014800                                                                  01530002
014900 01  DE-DEPT-EXTRACT-RECORD.                                      01540002
015000     05  DE-DEPARTMENT                PIC  X(3)     VALUE SPACES. 01550002
015100     05  DE-MINIMUM-RETAIL-AMOUNT     PIC  9(5)V99  VALUE ZEROS   01560002
015200                                                    COMP-3.       01570002
015300     05  DE-MAXIMUM-RETAIL-AMOUNT     PIC  9(5)V99  VALUE ZEROS   01580002
015400                                                    COMP-3.       01590002
015500     05  FILLER                       PIC  X(69)    VALUE SPACES. 01600002
015600                                                                  01610002
015700******************************************************************01620002
015800*  DB2 COMMUNICATION AREA.                                        01630002
015900******************************************************************01640002
016000     EXEC SQL                                                     01650002
016100         INCLUDE SQLCA                                            01660002
016200     END-EXEC.                                                    01670002
016300                                                                  01680002
016400******************************************************************01690002
016500*  DB2 TABLE XST_SKU                                              01700002
016600******************************************************************01710002
016700     EXEC SQL                                                     01720002
016800         INCLUDE XST00010                                         01730002
016900     END-EXEC.                                                    01740002
017000                                                                  01750002
017100******************************************************************01760002
017200*  DB2 TABLE XST_SKU_LOC                                          01770002
017300******************************************************************01780002
017400     EXEC SQL                                                     01790002
017500         INCLUDE XST00008                                         01800002
017600     END-EXEC.                                                    01810002
017700                                                                  01820002
017800******************************************************************01830002
017900*  DB2 TABLE XST_VND_STYL                                         01840002
018000******************************************************************01850002
018100     EXEC SQL                                                     01860002
018200         INCLUDE XST00013                                         01870002
018300     END-EXEC.                                                    01880002
018400                                                                  01890002
P48136******************************************************************01891002
P48136*  DB2 TABLE XSTW_VND_STYL_SKU                                    01892002
P48136******************************************************************01893002
P48136     EXEC SQL                                                     01894002
P48136         INCLUDE XST00140                                         01895002
P48136     END-EXEC.                                                    01896002
P48136                                                                  01897002
018500******************************************************************01900002
018600*  CURSOR TO RETRIEVE MIN-MAX-CURSOR                              01910002
018610*      REGINAL CLEARANCE PRICING IS FACTORED INTO THE MIN/MAX     01920002
018620*      AMOUNTS RETURNED.                                          01930002
018700******************************************************************01940002
P48136     EXEC SQL                                                     01950002
P48136         DECLARE MIN-MAX-CURSOR CURSOR FOR                        01960002
P48136            SELECT SKU.DEPT_NBR                                   01970002
P48136                  ,MIN(LOC.UNT_RTL_AMT)                           01980002
P48136                  ,MAX(LOC.UNT_RTL_AMT)                           01990002
P48136              FROM XSTW_VND_STYL_SKU SKU                          02000002
P48136                  ,XST_SKU_LOC LOC                                02020002
P48136             WHERE SKU.INTR_UPC_ID   = LOC.INTR_UPC_ID            02050002
244693               AND SKU.INTR_UPC_ID   = SKU.INTR_UPC_ID                    
P48136               AND LOC.BEG_TMST    < :PV-START-TIMESTAMP          02060002
P48136               AND (LOC.END_TMST   > :PV-END-TIMESTAMP            02070002
P48136                OR LOC.END_TMST IS NULL)                          02080002
P48136          GROUP BY SKU.DEPT_NBR                                   02090002
P48136          WITH UR                                                 02100002
P48136     END-EXEC.                                                    02110002
020400                                                                  02120002
020500******************************************************************02130002
020600 PROCEDURE DIVISION.                                              02140002
020700******************************************************************02150002
020800*                                                                 02160002
020900***************************************************************** 02170002
021000 0000-MAINLINE-PARAGRAPH.                                         02180002
021100*     PROGRAM FLOW CONTROL.                                       02190002
021200***************************************************************** 02200002
021300                                                                  02210002
021400     PERFORM 1000-INITIALIZE.                                     02220002
021500                                                                  02230002
021600     PERFORM 2000-PROCESS-MIN-MAX-CURSOR.                         02240002
021700                                                                  02250002
021800     PERFORM 8500-CLOSE-FILES.                                    02260002
021900                                                                  02270002
022000     STOP RUN.                                                    02280002
022100                                                                  02290002
022200******************************************************************02300002
022300*  INITIALIZATION ROUTINE.                                        02310002
022400******************************************************************02320002
022500 1000-INITIALIZE.                                                 02330002
022600                                                                  02340002
022700     OPEN INPUT  DATE-CARD-FILE                                   02350002
022800          OUTPUT DEPT-EXTRACT-FILE.                               02360002
022900                                                                  02370002
023000     PERFORM 1100-PROCESS-CONTROL-CARD.                           02380002
023100                                                                  02390002
023200     MOVE CC-DATE-CCYY-MM-DD    TO PV-START-DATE                  02400002
023300                                   PV-END-DATE.                   02410002
023400                                                                  02420002
023500******************************************************************02430002
023600* 1100-PROCESS-CONTROL-CARD                                       02440002
023700******************************************************************02450002
023800 1100-PROCESS-CONTROL-CARD.                                       02460002
023900                                                                  02470002
024000     PERFORM 1110-READ-DATE-CARD-FILE.                            02480002
024100     CLOSE DATE-CARD-FILE.                                        02490002
024200     IF PS-END-OF-CARD-FILE                                       02500002
024300         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   02510002
024400         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  02520002
024500         SET AC-CONTROL-CARD-ERROR TO TRUE                        02530002
024600         PERFORM 9999-ABEND                                       02540002
024700     END-IF.                                                      02550002
024800     DISPLAY PC-CURRENT-PROGRAM-NAME                              02560002
024900             ' - CONTROL CARD = (' CC-CONTROL-CARD-DISPLAY  ')'.  02570002
025000                                                                  02580002
025100     PERFORM 1115-CONVERT-INPUT-DATE.                             02590002
025200                                                                  02600002
025300     DISPLAY CC-DATE-CCYY-MM-DD.                                  02610002
025400                                                                  02620002
025500******************************************************************02630002
025600* 1110-READ-DATE-CARD-FILE                                        02640002
025700*     READ DATE CONTROL CARD.                                     02650002
025800******************************************************************02660002
025900 1110-READ-DATE-CARD-FILE.                                        02670002
026000     READ DATE-CARD-FILE INTO CC-CONTROL-CARD-DISPLAY             02680002
026100        AT END                                                    02690002
026200           SET PS-END-OF-CARD-FILE TO TRUE.                       02700002
026300                                                                  02710002
026400******************************************************************02720002
026500 1115-CONVERT-INPUT-DATE.                                         02730002
026600*     CALL KOHLS CALENDAR ROUTINE:                                02740002
026700*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            02750002
026800*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 02760002
026900******************************************************************02770002
027000                                                                  02780002
027100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              02790002
027200                                                                  02800002
027300     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   02810002
027400     SET  DPG51-INCREMENT-DATE         TO TRUE.                   02820002
027500     MOVE 1 TO DPG51-INCR-DECR-DAYS-9.                            02830002
027600     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   02840002
027700     MOVE CC-DATE-CCYY-MM-DD           TO DPG52-LK-DATE-INPUT.    02850002
027800     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    02860002
027900                                             DPG54 DPG55 DPG56.   02870002
028000     EVALUATE TRUE                                                02880002
028100         WHEN DPG54-SEVERE-ERROR                                  02890002
028200         WHEN DPG54-DATE-INVALID                                  02900002
028300             MOVE '1115-CONVERT-INPUT-DATE'                       02910002
028400                                           TO PV-PARAGRAPH-NAME   02920002
028500             MOVE 'ERROR CONVERTING INPUT CARD DATE'              02930002
028600                                           TO PV-OPERATION-MSG-1  02940002
028700             SET AC-CALENDAR-ROUTINE-ERROR TO TRUE                02950002
028800             MOVE DPG54-ERROR-MESSAGE      TO PV-OPERATION-MSG-2  02960002
028900             PERFORM 9999-ABEND                                   02970002
029000     END-EVALUATE.                                                02980002
029100     MOVE DPG55-DB2-ISO-DATE-FMT       TO CC-DATE-CCYY-MM-DD.     02990002
029200 EJECT                                                            03000002
029300******************************************************************03010002
029400* 2000-PROCESS-MIN-MAX-CURSOR                                     03020002
029500*     - OPEN THE CURSOR                                           03030002
029600*     - FETCH AND PROCESS RECORDS                                 03040002
029700*     - CLOSE THE CURSOR                                          03050002
029800******************************************************************03060002
029900 2000-PROCESS-MIN-MAX-CURSOR.                                     03070002
030000                                                                  03080002
P48136     PERFORM 2050-INSERT-XSTW-VND-STYL-SKU.                       03090002
030100     PERFORM 2100-OPEN-MIN-MAX-CURSOR.                            03091002
030200     PERFORM 2200-FETCH-MIN-MAX-CURSOR                            03100002
030300         UNTIL PS-END-MIN-MAX-CURSOR-Y.                           03110002
030400     PERFORM 2300-CLOSE-MIN-MAX-CURSOR.                           03120002
030500                                                                          
P48136******************************************************************03140002
P48136*XSTW-VND-STYL-SKU WORK TABLE SHOULD HAVE SOME RECORDS TO PROCESS 03150002
P48136*IN EACH RUN.IF IT IS EMPTY IN ANY OF THE RUN,IT MIGHT BE AN      03160002
P48136*ISSUE WITH WORK TABLE,SO PROGRAM THROW 4008 RC FOR FURTHER CHECK.03160002
P48136******************************************************************03170002
P48136     DISPLAY 'RECS SQL INSERT COUNT IN XSTW=' PV-SQL-INSERT-COUNT.        
P48136     DISPLAY 'RECS SELECT COUNT IN XSTW=' PV-TEMP-SELCT-CNT.              
           IF  PV-TEMP-SELCT-CNT = 0                                            
P48136      DISPLAY 'SELECT COUNT FROM WORK TABLE SHOULD BE GREATER',           
P48136      DISPLAY 'THAN ZERO,IF RETURNS ZERO,THIS MIGHT BE SOME',             
P48136      DISPLAY 'ISSUE WITH TEMP WORK TABLE,HENCE FORCE ABENDING',          
P48136      DISPLAY 'JOB FOR RESEARCH,TRY TO RERUN OR CONTACT DB2DBA'           
P48136      MOVE 4008 TO RETURN-CODE                                            
P48136     END-IF.                                                              
030500                                                                  03130002
P48136******************************************************************03140002
P48136* 2050-INSERT-XSTW-VND-STYL-SKU.                                  03150002
P48136*     DELETE AND INSERT ROWS INTO XSTW-VND-STYL-SKU               03160002
P48136******************************************************************03170002
P48136 2050-INSERT-XSTW-VND-STYL-SKU.                                   03180002
P48136                                                                  03190002
P48136     EXEC SQL                                                     03200002
P48136         DELETE FROM XSTW_VND_STYL_SKU                            03201002
P48136     END-EXEC.                                                    03220002
P48136                                                                  03230002
P48136     EVALUATE TRUE                                                03240002
P48136         WHEN SQLCODE = ZERO                                      03250002
P48136              CONTINUE                                            03260002
P48136         WHEN SQLCODE = PC-ROW-NOT-FOUND                                  
P48136         DISPLAY 'NO ROWS TO DELETE IN XSTW_VND_STYL_SKU '                
P48136              CONTINUE                                            03260002
P48136         WHEN SQLWARN0 NOT EQUAL SPACE                            03270002
P48136         WHEN SQLCODE NOT EQUAL ZERO                              03280002
P48136             MOVE '2050-INSERT-XSTW-VND-STYL-SKU'                 03290002
P48136                                   TO PV-PARAGRAPH-NAME           03300002
P48136             MOVE 'ERROR ON DELETE FROM XSTW-VND-STYL-SKU'        03310002
P48136                                   TO PV-DB2-OPERATION            03320002
P48136             PERFORM 9100-SQL-ABEND                               03330002
P48136     END-EVALUATE.                                                03340002
P48136                                                                  03340102
P48136     EXEC SQL                                                     03341002
P48136         INSERT INTO XSTW_VND_STYL_SKU                            03342002
P48136         SELECT DISTINCT                                          03343002
P48136                SKU.INTR_UPC_ID                                   03344002
P48136               ,VND.DEPT_NBR                                      03345002
P48136         FROM   XST_SKU SKU                                       03346002
P48136               ,XST_VND_STYL VND                                  03347002
P48136         WHERE SKU.STYL_ID = VND.STYL_ID                          03348002
P48136           AND VND.STYL_ID = VND.STYL_ID                          03349002
P48136         ORDER BY SKU.INTR_UPC_ID                                 03349102
P48136                 ,VND.DEPT_NBR                                    03349202
P48136     END-EXEC.                                                    03349302
P48136                                                                  03349402
P48136     EVALUATE TRUE                                                03349502
P48136         WHEN SQLCODE = ZERO                                      03349602
P48136         MOVE SQLERRD(3) TO PV-SQLERRD3                                   
P48136         ADD PV-SQLERRD3 TO PV-SQL-INSERT-COUNT                           
P48136              CONTINUE                                            03349702
P48136         WHEN SQLCODE = PC-ROW-NOT-FOUND                                  
P48136         DISPLAY 'NO ROWS TO INSERT IN XSTW_VND_STYL_SKU '                
P48136              CONTINUE                                            03260002
P48136         WHEN SQLWARN0 NOT EQUAL SPACE                            03349802
P48136         WHEN SQLCODE NOT EQUAL ZERO                              03349902
P48136             MOVE '2050-INSERT-XSTW-VND-STYL-SKU'                 03350002
P48136                                   TO PV-PARAGRAPH-NAME           03350102
P48136             MOVE 'ERROR ON INSERT INTO XSTW-VND-STYL-SKU'        03350202
P48136                                   TO PV-DB2-OPERATION            03350302
P48136             PERFORM 9100-SQL-ABEND                               03350402
P48136     END-EVALUATE.                                                03350502
P48136                                                                  03350603
P48136     EXEC SQL                                                     03350703
P48136         COMMIT                                                   03350803
P48136     END-EXEC.                                                    03350903
P48136 EJECT                                                            03351002
032800                                                                  03360002
030600******************************************************************03361002
030700* 2100-OPEN-MIN-MAX-CURSOR.                                       03362002
030800*     OPEN MIN MAX CURSOR                                         03363002
030900******************************************************************03364002
031000 2100-OPEN-MIN-MAX-CURSOR.                                        03365002
031100                                                                  03366002
031200     EXEC SQL                                                     03367002
031300          OPEN MIN-MAX-CURSOR                                     03368002
031400     END-EXEC.                                                    03369002
031500                                                                  03369102
031600     EVALUATE TRUE                                                03369202
031700         WHEN SQLCODE = ZERO                                      03369302
031800              CONTINUE                                            03369402
031900         WHEN SQLWARN0 NOT EQUAL SPACE                            03369502
032000         WHEN SQLCODE NOT EQUAL ZERO                              03369602
032100             MOVE '2100-OPEN-MIN-MAX-CURSOR'                      03369702
032200                                   TO PV-PARAGRAPH-NAME           03369802
032300             MOVE 'ERROR ON OPEN OF MIN-MAX-CURSOR'               03369902
032400                                   TO PV-DB2-OPERATION            03370002
032500             PERFORM 9100-SQL-ABEND                               03370102
032600     END-EVALUATE.                                                03370202
032700 EJECT                                                            03370302
032800                                                                  03370402
032900******************************************************************03371002
033000* 2200-FETCH-MIN-MAX-CURSOR                                       03380002
033100******************************************************************03390002
033200 2200-FETCH-MIN-MAX-CURSOR.                                       03400002
033300                                                                  03410002
033400     EXEC SQL                                                     03420002
033500          FETCH MIN-MAX-CURSOR                                    03430002
033600           INTO :XST00013-DEPT-NBR                                03440002
033700               ,:PV-MIN-UNT-RTL-AMT                               03450002
033800               ,:PV-MAX-UNT-RTL-AMT                               03460002
033900     END-EXEC.                                                    03470002
034000                                                                  03480002
034100     EVALUATE TRUE                                                03490002
034200         WHEN SQLCODE = ZERO                                      03500002
P48136         ADD +1 TO PV-TEMP-SELCT-CNT                                      
034300             PERFORM 3000-PROCESS-DEPT-DATA                       03510002
034400         WHEN SQLCODE = PC-ROW-NOT-FOUND                          03520002
034500             SET PS-END-MIN-MAX-CURSOR-Y  TO TRUE                 03530002
034600         WHEN SQLWARN0 NOT EQUAL SPACE                            03540002
034700         WHEN SQLCODE NOT EQUAL ZERO                              03550002
034800             MOVE '2200-FETCH-MIN-MAX-CURSOR'                     03560002
034900                                   TO PV-PARAGRAPH-NAME           03570002
035000             MOVE 'ERROR ON FETCH OF MIN-MAX-CURSOR'              03580002
035100                                   TO PV-DB2-OPERATION            03590002
035200             PERFORM 9100-SQL-ABEND                               03600002
035300     END-EVALUATE.                                                03610002
035400 EJECT                                                            03620002
035500                                                                  03630002
035600******************************************************************03640002
035700* 2300-CLOSE-MIN-MAX-CURSOR                                       03650002
035800*   -CLOSE THE CURSOR                                             03660002
035900******************************************************************03670002
036000 2300-CLOSE-MIN-MAX-CURSOR.                                       03680002
036100                                                                  03690002
036200     EXEC SQL                                                     03700002
036300          CLOSE MIN-MAX-CURSOR                                    03710002
036400     END-EXEC.                                                    03720002
036500                                                                  03730002
036600     EVALUATE TRUE                                                03740002
036700         WHEN SQLCODE = ZERO                                      03750002
036800              CONTINUE                                            03760002
036900         WHEN SQLWARN0 NOT EQUAL SPACE                            03770002
037000         WHEN SQLCODE NOT EQUAL ZERO                              03780002
037100             MOVE '2300-CLOSE-MIN-MAX-CURSOR'                     03790002
037200                                   TO PV-PARAGRAPH-NAME           03800002
037300             MOVE 'ERROR ON CLOSE OF MIN-MAX-CURSOR'              03810002
037400                                   TO PV-DB2-OPERATION            03820002
037500             PERFORM 9100-SQL-ABEND                               03830002
037600     END-EVALUATE.                                                03840002
037700 EJECT                                                            03850002
037800                                                                  03860002
037900******************************************************************03870002
038000* 3000-PROCESS-DEPT-DATA                                          03880002
038100******************************************************************03890002
038200 3000-PROCESS-DEPT-DATA.                                          03900002
038300                                                                  03910002
038400     MOVE XST00013-DEPT-NBR        TO PV-DEPT-NBR.                03920002
038500     MOVE PV-DEPT-NBR-3            TO DE-DEPARTMENT.              03930002
038600     MOVE PV-MIN-UNT-RTL-AMT       TO DE-MINIMUM-RETAIL-AMOUNT.   03940002
038700     MOVE PV-MAX-UNT-RTL-AMT       TO DE-MAXIMUM-RETAIL-AMOUNT.   03950002
038800                                                                  03960002
038900     PERFORM 8000-WRITE-RECORD.                                   03970002
039000                                                                  03980002
039100******************************************************************03990002
039200 8000-WRITE-RECORD.                                               04000002
039300******************************************************************04010002
039400                                                                  04020002
039500     WRITE DEPT-EXTRACT-RECORD                                    04030002
039600           FROM DE-DEPT-EXTRACT-RECORD.                           04040002
039700                                                                  04050002
039800     INITIALIZE DEPT-EXTRACT-RECORD                               04060002
039900                DE-DEPT-EXTRACT-RECORD.                           04070002
040000                                                                  04080002
040100******************************************************************04090002
040200 8500-CLOSE-FILES.                                                04100002
040300******************************************************************04110002
040400     CLOSE DEPT-EXTRACT-FILE.                                     04120002
040500                                                                  04130002
040600******************************************************************04140002
040700* 9100-SQL-ABEND                                                  04150002
040800*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.04160002
040900******************************************************************04170002
041000 9100-SQL-ABEND.                                                  04180002
041100     DISPLAY '** ABEND     **'.                                   04190002
041200     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04200002
041300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04210002
041400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               04220002
041500                                                                  04230002
041600******************************************************************04240002
041700* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     04250002
041800* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      04260002
041900******************************************************************04270002
042000     COPY DPPD004.                                                04280002
042100                                                                  04290002
042200     SET AC-DB2-ERROR TO TRUE.                                    04300002
042300     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04310002
042400                                                                  04320002
042500******************************************************************04330002
042600* 9999-ABEND                                                      04340002
042700*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  04350002
042800******************************************************************04360002
042900 9999-ABEND.                                                      04370002
043000     DISPLAY '** ABEND           **'.                             04380002
043100     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  04390002
043200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        04400002
043300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       04410002
043400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       04420002
043500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04430002
