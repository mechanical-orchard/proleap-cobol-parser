000500******************************************************************00010000
000600 IDENTIFICATION DIVISION.                                         00020000
000700******************************************************************00030000
000800 PROGRAM-ID.   SNKUP105.                                          00040000
000900 AUTHOR.       AL PETERS.                                         00050000
001000 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060000
001100 DATE-WRITTEN. MARCH 2006.                                        00070000
001200 DATE-COMPILED.                                                   00080000
001300******************************************************************00090000
001400*                   PO RECYCLE PROGRAM                            00100000
001500*                                                                 00110000
001600* THIS PROGRAM READS RECORDS FROM THE INPUT REPOSITORY TABLES     00120000
001700* (SNT_DAT_CNTL & SNT_DAT_XFER) USING A CURSOR CHECKING FOR ASNS  00130000
001800* ON "HOLD" STATUS.                                               00140000
001900*                                                                 00150000
002000* WHEN A ROW IS FOUND ON THE CONTROL TABLE, THE PROGRAM WILL OPEN 00160000
002100* A SECOND CURSOR TO READ THE DETAIL ROWS, LOOKING FOR 'PRF' (PO) 00170000
002200* ROWS.                                                           00180000
002300*                                                                 00190000
002400* FOR EACH PO, TPURCHS WILL NEED TO BE CHECKED TO VALIDATE THE    00200000
002500* EXISTENCE OF THE PO.  IF ALL POS ON THE ASN ARE IN TPURCHS THE  00210000
002600* ASN STATUS WILL BE CHNGED TO "READY", AND DB2 COMMITS REQUESTED.00220000
002800******************************************************************00230000
002900*  CHANGE LOG                                                   * 00240000
069538***************************************************************** 00250000
069538*  CHANGED 07/07/14 BY DAVID FELLENZ                            * 00260024
069538*   CHG0081355      - REMOVE CALL TO SUBPROGRAM SNKUT150 TO     * 00270024
069538*                     CALL ORACLE FOR A PO NUMBER LOOKUP.       * 00280000
069538*                     INSTEAD DO THE LOOKUP FROM THIS PROGRAM   * 00290000
069538*                     USING DB2 TABLE TPURCHS.                  * 00300000
003000***************************************************************** 00310000
C94517*  CHANGED 01/02/2015    BY COGNIZANT       WR: CHG0094517        00320025
C94517*                                                                 00330025
C94517* EXTENDED PO# FROM 7 TO 8 DIGITS WHERE NEEDED.                   00340025
C94517*-----------------------------------------------------------------00350025
263627* CHANGED 11/04/2021    BY JIM HUNTER      WR: CHG0263627         00352032
263627* CHANGE CALL OF DPKUT100 TO CALL DP010I-NUMERIC-EDIT-ROUTINE     00353032
263627* MAKING THE CALL DYNAMIC VS STATIC.                              00354032
263627*----------------------------------------------------------------*00355032
003000***************************************************************** 00360000
002900 ENVIRONMENT DIVISION.                                            00370000
003000******************************************************************00380000
003100 CONFIGURATION SECTION.                                           00390000
003200 SOURCE-COMPUTER.        IBM-3090.                                00400000
003300 OBJECT-COMPUTER.        IBM-3090.                                00410000
003400******************************************************************00420000
003500 INPUT-OUTPUT SECTION.                                            00430000
003600 FILE-CONTROL.                                                    00440000
005400******************************************************************00450000
005500 DATA DIVISION.                                                   00460000
005600 FILE SECTION.                                                    00470000
007000******************************************************************00480000
007100 WORKING-STORAGE SECTION.                                         00490000
007200                                                                  00500000
069538*01  WS-ORACLE-TRANSFER-AREA.                                     00510000
069538*    05  WS-ORACLE-PO                PIC 9(8).                    00520000
069538*    05  WS-ORACLE-SUPPLIER          PIC 9(10).                   00530000
069538*    05  WS-ORACLE-RC                PIC 9(1).                    00540000
069538*                                                                 00550000
069538*01  WS-ORA-RETURN-CDE               PIC X(1)  VALUE SPACE.       00560000
069538 01  PW-PROGRAM-WORKAREA.                                         00570000
C94517     05  PW-PO-NBR-N                  PIC S9(8)       COMP.       00580025
069538                                                                  00590000
C94517 01  WS-VALUE1-8.                                                 00600029
C94517     05  FILLER                       PIC X(01) VALUE SPACE.      00610029
C94517     05  WS-VALUE2-8                  PIC X(07) VALUE SPACE.      00620029
C94517                                                                  00630029
069538 01  WS-WORKAREA.                                                 00640000
C94517     05  WS-PO-NBR                    PIC 9(8).                   00650025
069538     05  WS-DAT-XFER-CNTL-ID          PIC 9(9).                   00660000
069538     05  WS-VEND                      PIC 9(10).                  00670015
069538     05  WS-VEND-X REDEFINES WS-VEND                              00680015
069538                                      PIC X(10).                  00690015
069538     05  WS-ENT-ID                    PIC 9(09) VALUE ZEROES.     00700016
007270                                                                  00710000
007300 01  PS-PROGRAM-SWITCHES.                                         00720000
008000     05  PS-END-OF-CNTL-CSR-SW       PIC X(01) VALUE 'N'.         00730000
008100         88  PS-END-OF-CNTL-CSR-YES            VALUE 'Y'.         00740000
008200         88  PS-END-OF-CNTL-CSR-NO             VALUE 'N'.         00750000
008300     05  PS-END-OF-XFER-CSR-SW       PIC X(01) VALUE 'N'.         00760000
008400         88  PS-END-OF-XFER-CSR-YES            VALUE 'Y'.         00770000
008500         88  PS-END-OF-XFER-CSR-NO             VALUE 'N'.         00780000
008600     05  PS-PO-IN-DB2-SW             PIC X(01) VALUE 'N'.         00790000
008700         88  PS-PO-IN-DB2-YES                  VALUE 'Y'.         00800000
008800         88  PS-PO-IN-DB2-NO                   VALUE 'N'.         00810000
069538     05  PS-VND-IN-DB2-SW            PIC X(01) VALUE 'N'.         00820022
069538         88  PS-VND-IN-DB2-YES                 VALUE 'Y'.         00830022
069538         88  PS-VND-IN-DB2-NO                  VALUE 'N'.         00840022
008900                                                                  00850000
009000 01  PC-PROGRAM-CONSTANTS.                                        00860000
009100     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'SNKUP105'.  00870000
069538*    05  PC-SNKUT150                 PIC X(08) VALUE 'SNKUT150'.  00880000
009200     05  PC-MAX-RETRIES              PIC S9(3) VALUE +5 COMP-3.   00890000
009300     05  PC-R                        PIC X(01) VALUE 'R'.         00900000
009400                                                                  00910000
009500 01  PA-PROGRAM-ACCUMULATORS.                                     00920000
009600     05  PA-TOTALS.                                               00930000
009700         10  PA-TOTAL-ASNS-READ      PIC S9(7) VALUE +0 COMP-3.   00940000
009800         10  PA-TOTAL-PRFS-READ      PIC S9(7) VALUE +0 COMP-3.   00950000
009900         10  PA-TOTAL-ASNS-UPDATED   PIC S9(7) VALUE +0 COMP-3.   00960000
010000                                                                  00970000
010100 01  ABEND-CODE                      PIC S9(4) VALUE +0           00980000
010200                                               COMP SYNC.         00990000
010300                                                                  01000000
010400 01  PV-PROGRAM-VARIABLES.                                        01010000
010500     05  PV-PARAGRAPH                PIC X(48) VALUE SPACES.      01020000
010600     05  PV-HOLD-COMPLETION-CODE     PIC S9(9) BINARY.            01030000
010700     05  PV-HOLD-REASON              PIC S9(9) BINARY.            01040000
010800     05  PV-MSG-LENGTH               PIC S9(9) BINARY.            01050000
010900     05  PV-DISPLAY-RECORD           PIC ZZZ,ZZ9.                 01060000
011100     05  PV-CURRENT-TMST             PIC X(26) VALUE SPACE.       01070000
011101                                                                  01080000
C94517     05  PV-NUMERIC-EIGHT            PIC 9(08).                   01090027
011200                                                                  01100000
011700 01  PV-ABEND-VARIABLES.                                          01110000
011710     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP      01120000
011720                                                        SYNC.     01130000
011800     05  PV-RETRY-COUNTER            PIC S9(4) VALUE +0 COMP.     01140000
011900     05  PV-SQLCODE                  PIC S9(9).                   01150000
012000     05  PV-DISPLAY-SQLCODE          PIC -------999.              01160000
012100     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'SNKUP105'.  01170000
012200     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      01180000
012300     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      01190000
012400     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01200000
012500     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01210000
012600                                                                  01220000
012700******************************************************************01230000
012800*  WORK AREA PASSED IN CALL TO DPKUT500 - CALENDAR ROUTINE        01240000
012900******************************************************************01250000
013000     COPY DPWS500.                                                01260000
013100                                                                  01270000
013200******************************************************************01280000
013300*  DB2 FORMATTED MESSAGE AREA                                     01290000
013400******************************************************************01300000
013500     COPY DPWS004.                                                01310000
013600                                                                  01320000
013610******************************************************************01330000
013620*    NUMERIC EDIT ROUTINE                                         01340000
013630******************************************************************01350000
013640     COPY DPWS010I.                                               01360000
013650                                                                  01370000
013700******************************************************************01380000
013800*  COMMUNICATIONS AREA FOR DB2                                    01390000
013900******************************************************************01400000
014000     EXEC SQL                                                     01410000
014100         INCLUDE SQLCA                                            01420000
014200     END-EXEC.                                                    01430000
014300                                                                  01440000
014400******************************************************************01450000
014500*  DB2 TABLE DECLARATION                                          01460000
014600*  (SNT_DAT_CNTL - ASN DATA TRANSFER CONTROL TABLE)               01470000
014700******************************************************************01480000
014800     EXEC SQL                                                     01490000
014900         INCLUDE SNT00000                                         01500000
015000     END-EXEC.                                                    01510000
015100                                                                  01520000
015200******************************************************************01530000
015300*  DB2 TABLE DECLARATION                                          01540000
015400*  (SNT_DAT_XFER - ASN DATA TRANSFER DETAIL TABLE)                01550000
015500******************************************************************01560000
015600     EXEC SQL                                                     01570000
015700         INCLUDE SNT00001                                         01580000
015800     END-EXEC.                                                    01590000
015900                                                                  01600000
069538******************************************************************01610000
069538*  DB2 TABLE DECLARATION                                          01620000
069538*  (TPURCHS - PURCHASE TABLE)                                     01630000
069538******************************************************************01640000
069538     EXEC SQL                                                     01650000
069538         INCLUDE TPURCHS                                          01660000
069538     END-EXEC.                                                    01670000
069538                                                                  01680000
069538******************************************************************01690015
069538*  DB2 TABLE DECLARATION                                          01700015
069538*  DCLGEN TABLE(XLT_VND)                                          01710015
069538******************************************************************01720015
069538     EXEC SQL                                                     01730015
069538         INCLUDE XLT00035                                         01740015
069538     END-EXEC.                                                    01750015
016806                                                                  01760001
016000******************************************************************01770000
016100* COBOL CURSOR DELCARATION TO READ THE ASN CONTROL TABLE         *01780000
016200******************************************************************01790000
016300     EXEC SQL                                                     01800000
016400       DECLARE CNTL-CSR CURSOR WITH HOLD FOR                      01810000
016500        SELECT DAT_XFER_CNTL_ID                                   01820000
016600             , CRE_TMST                                           01830000
016700             , STAT_CDE                                           01840000
016800             , END_PRC_TMST                                       01850000
016900             , ASN_TYP_CDE                                        01860000
017000          FROM SNT_DAT_CNTL                                       01870000
017100         WHERE STAT_CDE  = 'H'                                    01880000
017200     END-EXEC.                                                    01890000
017300                                                                  01900000
017400******************************************************************01910000
017500* COBOL CURSOR DELCARATION TO READ THE ASN DETAIL TABLE          *01920000
017600******************************************************************01930000
017700     EXEC SQL                                                     01940000
017800       DECLARE XFER-CSR CURSOR FOR                                01950000
017900        SELECT DAT_XFER_CNTL_ID                                   01960000
018000             , PRC_LOD_SEQ_NBR                                    01970000
018100             , DAT_CTG_CDE                                        01980000
018200             , LOD_DAT_TXT                                        01990000
018300          FROM SNT_DAT_XFER                                       02000000
018400         WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID      02010000
018500           AND DAT_CTG_CDE      = 'PRF'                           02020000
018600     END-EXEC.                                                    02030000
018700                                                                  02040000
021500****************************************************************  02050000
031700 LINKAGE SECTION.                                                 02060000
031800                                                                  02070000
032000 PROCEDURE DIVISION.                                              02080000
032100****************************************************************  02090000
032200 0000-PROGRAM-MAINLINE.                                           02100000
032300     DISPLAY '************ START OF SNKUP105 ***************'     02110000
032400                                                                  02120000
032500     PERFORM 1000-INITIALIZE.                                     02130000
032600                                                                  02140000
032700     PERFORM 2000-PROCESS-HOLDS.                                  02150000
032800                                                                  02160000
032900     PERFORM 9000-EOJ-ROUTINE.                                    02170000
033000                                                                  02180000
033100     DISPLAY ' '.                                                 02190000
033200     DISPLAY '************  END OF SNKUP105  ***************'     02200000
033300     STOP RUN.                                                    02210000
033400                                                                  02220000
033500******************************************************************02230000
033600*                                                                *02240000
033700*                I N I T I A L I Z A T I O N                     *02250000
033800*                                                                *02260000
033900******************************************************************02270000
034000 1000-INITIALIZE.                                                 02280000
034100                                                                  02290000
034200*INIT COUNTERS.                                                   02300000
034300     INITIALIZE PA-TOTAL-ASNS-READ                                02310000
034400                PA-TOTAL-PRFS-READ                                02320000
034500                PA-TOTAL-ASNS-UPDATED.                            02330000
034600                                                                  02340000
034700                                                                  02350000
034800*GET CURRENT TIMESTAMP.                                           02360000
034900     PERFORM 1100-SET-CURRENT-TMST.                               02370000
035000                                                                  02380000
036000******************************************************************02390000
036100 1100-SET-CURRENT-TMST.                                           02400000
036200     MOVE '1100-SET-CURRENT-TMST'   TO PV-PARAGRAPH.              02410000
036300                                                                  02420000
036400     EXEC SQL                                                     02430000
036500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02440000
036600     END-EXEC.                                                    02450000
036700                                                                  02460000
036800     EVALUATE TRUE                                                02470000
036900       WHEN SQLCODE = ZERO                                        02480000
037000           DISPLAY ' CURRENT TIMESTAMP = ' PV-CURRENT-TMST        02490000
037100                                                                  02500000
037200       WHEN OTHER                                                 02510000
037300           MOVE '1000-INITIALIZATION' TO PV-ABEND-PARAGRAPH       02520000
037400           MOVE 'GET DB2 TMST'        TO PV-ABEND-OPERATION       02530000
037500           PERFORM 9900-DB2-ABEND                                 02540000
037600     END-EVALUATE.                                                02550000
037700                                                                  02560000
050600******************************************************************02570000
050700*                                                                *02580000
050800*      P R O C E S S   A S N   I N P U T   R E C O R D S         *02590000
050900*                                                                *02600000
051000******************************************************************02610000
051100 2000-PROCESS-HOLDS.                                              02620000
051200***  DISPLAY '2000-PROCESS-HOLDS'.                                02630000
051300                                                                  02640000
051400     PERFORM 2100-OPEN-CNTL-CURSOR.                               02650000
051500                                                                  02660000
051600     PERFORM 2200-FETCH-CNTL-CURSOR.                              02670000
051700                                                                  02680000
051800     IF PS-END-OF-CNTL-CSR-YES                                    02690000
051900         DISPLAY ' '                                              02700000
052000         DISPLAY '*************************************'          02710000
052100         DISPLAY '**         NO "HELD" ASNS          **'          02720000
052200         DISPLAY '**      FOUND ON SNT_DAT_CNTL      **'          02730000
052300         DISPLAY '*************************************'          02740000
052400         DISPLAY ' '                                              02750000
052500     END-IF.                                                      02760000
052600                                                                  02770000
052700*****************                                                 02780000
052800*PROCESS "HOLDS"*                                                 02790000
052900*****************                                                 02800000
053000     PERFORM                                                      02810000
053100       UNTIL PS-END-OF-CNTL-CSR-YES                               02820000
053200                                                                  02830000
053300*INCREMENT COUNTER OF CNTL RECORDS READ.                          02840000
053400         ADD +1 TO PA-TOTAL-ASNS-READ                             02850000
053500                                                                  02860000
053600*INITIALIZE FLAG FOR DB2 PO EXISTENCE TO TRUE.                    02870000
053700         SET PS-PO-IN-DB2-YES TO TRUE                             02880000
053800                                                                  02890000
069538*INITIALIZE FLAG FOR DB2 VND EXISTENCE TO TRUE.                   02900022
069538         SET PS-VND-IN-DB2-YES TO TRUE                            02910022
069538                                                                  02920022
053900*PROCESS 'XFER' RECORDS ASSOCIATED WITH THE 'CNTL' RECORD.        02930000
054000         PERFORM 3000-PROCESS-XFER-RECORDS                        02940000
054100                                                                  02950000
054200*IF POS EXIST, UPDATE 'CNTL' RECORD AND DO COMMITS (DB2).         02960000
054300         IF PS-PO-IN-DB2-YES                                      02970015
069538            AND PS-VND-IN-DB2-YES                                 02980022
054400             PERFORM 2400-UPDATE-CNTL                             02990000
054600             PERFORM 2800-DB2-COMMIT                              03000000
054800         END-IF                                                   03010000
054900                                                                  03020000
055000*GET NEXT 'CNTL' RECORD.                                          03030000
055100         PERFORM 2200-FETCH-CNTL-CURSOR                           03040000
055200                                                                  03050000
055300     END-PERFORM.                                                 03060000
055400                                                                  03070000
055500*CLOSE THE 'CNTL' CURSOR.                                         03080000
055600     PERFORM 2500-CLOSE-CNTL-CURSOR.                              03090000
055700                                                                  03100000
055800******************************************************************03110000
055900 2100-OPEN-CNTL-CURSOR.                                           03120000
056000                                                                  03130000
056100     EXEC SQL                                                     03140000
056200         OPEN CNTL-CSR                                            03150000
056300     END-EXEC.                                                    03160000
056400                                                                  03170000
056500     EVALUATE TRUE                                                03180000
056600       WHEN SQLCODE = ZERO                                        03190000
056700           SET PS-END-OF-CNTL-CSR-NO TO TRUE                      03200000
056800                                                                  03210000
056900       WHEN OTHER                                                 03220000
057000           MOVE '2100-OPEN-CNTL-CURSOR'                           03230000
057100                                 TO PV-ABEND-PARAGRAPH            03240000
057200           MOVE 'OPEN CNTL-CSR ' TO PV-ABEND-OPERATION            03250000
057300           PERFORM 9900-DB2-ABEND                                 03260000
057400     END-EVALUATE.                                                03270000
057500                                                                  03280000
057600******************************************************************03290000
057700 2200-FETCH-CNTL-CURSOR.                                          03300000
057800                                                                  03310000
057900     EXEC SQL                                                     03320000
058000         FETCH CNTL-CSR                                           03330000
058100          INTO :SNT00000-DAT-XFER-CNTL-ID                         03340000
058200             , :SNT00000-CRE-TMST                                 03350000
058300             , :SNT00000-STAT-CDE                                 03360000
058400             , :SNT00000-END-PRC-TMST                             03370000
058500             , :SNT00000-ASN-TYP-CDE                              03380000
058600     END-EXEC.                                                    03390000
058700                                                                  03400000
058800     EVALUATE TRUE                                                03410000
058900       WHEN SQLCODE = +100                                        03420000
059000           SET PS-END-OF-CNTL-CSR-YES TO TRUE                     03430000
059100                                                                  03440000
059200       WHEN SQLCODE = ZERO                                        03450000
059300           CONTINUE                                               03460000
059400                                                                  03470000
059500       WHEN OTHER                                                 03480000
059600           MOVE '2200-FETCH-CNTL-CURSOR'                          03490000
059700                                  TO PV-ABEND-PARAGRAPH           03500000
059800           MOVE 'FETCH CNTL-CSR ' TO PV-ABEND-OPERATION           03510000
059900           PERFORM 9900-DB2-ABEND                                 03520000
060000     END-EVALUATE.                                                03530000
060100                                                                  03540000
060200******************************************************************03550000
060300 2400-UPDATE-CNTL.                                                03560000
060400     DISPLAY ' 2400-UPDATE-CNTL - ' SNT00000-DAT-XFER-CNTL-ID.    03570000
060500                                                                  03580000
060600     EXEC SQL                                                     03590000
060700         UPDATE SNT_DAT_CNTL                                      03600000
060800            SET STAT_CDE         = :PC-R                          03610000
060900          WHERE DAT_XFER_CNTL_ID = :SNT00000-DAT-XFER-CNTL-ID     03620000
061000     END-EXEC.                                                    03630000
061100                                                                  03640000
061200     EVALUATE TRUE                                                03650000
061300       WHEN SQLCODE = ZERO                                        03660000
061400           ADD +1 TO PA-TOTAL-ASNS-UPDATED                        03670000
061500                                                                  03680000
061600       WHEN OTHER                                                 03690000
061700           MOVE '2400-UPDATE-CNTL'    TO PV-ABEND-PARAGRAPH       03700000
061800           MOVE 'UPDATE SNT_DAT_CNTL' TO PV-ABEND-OPERATION       03710000
061900           MOVE DCLSNT00000 TO PV-DB2-OPERATION-MESSAGE-1         03720000
062000           PERFORM 9900-DB2-ABEND                                 03730000
062100     END-EVALUATE.                                                03740000
062200                                                                  03750000
062300******************************************************************03760000
062400 2500-CLOSE-CNTL-CURSOR.                                          03770000
062500                                                                  03780000
062600     EXEC SQL                                                     03790000
062700         CLOSE CNTL-CSR                                           03800000
062800     END-EXEC.                                                    03810000
062900                                                                  03820000
063000     EVALUATE TRUE                                                03830000
063100       WHEN SQLCODE = ZERO                                        03840000
063200           CONTINUE                                               03850000
063300                                                                  03860000
063400       WHEN OTHER                                                 03870000
063500           MOVE '2500-CLOSE-CNTL-CURSOR'                          03880000
063600                                  TO PV-ABEND-PARAGRAPH           03890000
063700           MOVE 'CLOSE CNTL-CSR ' TO PV-ABEND-OPERATION           03900000
063800           PERFORM 9900-DB2-ABEND                                 03910000
063900     END-EVALUATE.                                                03920000
064000                                                                  03930000
064100******************************************************************03940000
064200 2800-DB2-COMMIT.                                                 03950000
064300                                                                  03960000
064400     EXEC SQL                                                     03970000
064500         COMMIT                                                   03980000
064600     END-EXEC.                                                    03990000
064700                                                                  04000000
064800     EVALUATE TRUE                                                04010000
064900       WHEN SQLCODE = ZERO                                        04020000
065000           CONTINUE                                               04030000
065100                                                                  04040000
065200       WHEN OTHER                                                 04050000
065300           MOVE '2800-DB2-COMMIT'    TO PV-ABEND-PARAGRAPH        04060000
065400           MOVE 'COMMIT LOAD TABLES' TO PV-ABEND-OPERATION        04070000
065500           PERFORM 9900-DB2-ABEND                                 04080000
065600     END-EVALUATE.                                                04090000
065700                                                                  04100000
065800******************************************************************04110000
065900******************************************************************04120000
066000 3000-PROCESS-XFER-RECORDS.                                       04130000
066100                                                                  04140000
066200     PERFORM 3100-OPEN-XFER-CURSOR.                               04150000
066300                                                                  04160000
066400     PERFORM                                                      04170000
066500       UNTIL PS-END-OF-XFER-CSR-YES                               04180000
066600                                                                  04190000
066700          PERFORM 3200-PROCESS-XFER-ROWS                          04200000
066800                                                                  04210000
066900     END-PERFORM.                                                 04220000
067000                                                                  04230000
067100     PERFORM 3300-CLOSE-XFER-CURSOR.                              04240000
067200                                                                  04250000
067300******************************************************************04260000
067400 3100-OPEN-XFER-CURSOR.                                           04270000
067500                                                                  04280000
067600     EXEC SQL                                                     04290000
067700         OPEN XFER-CSR                                            04300000
067800     END-EXEC.                                                    04310000
067900                                                                  04320000
068000     EVALUATE TRUE                                                04330000
068100       WHEN SQLCODE = ZERO                                        04340000
068200           SET PS-END-OF-XFER-CSR-NO TO TRUE                      04350000
068300                                                                  04360000
068400       WHEN OTHER                                                 04370000
068500           MOVE '3100-OPEN-XFER-CURSOR'                           04380000
068600                                     TO PV-ABEND-PARAGRAPH        04390000
068700           MOVE 'OPEN XFER-CSR '     TO PV-ABEND-OPERATION        04400000
068800           PERFORM 9900-DB2-ABEND                                 04410000
068900     END-EVALUATE.                                                04420000
069000                                                                  04430000
069100******************************************************************04440000
069200 3200-PROCESS-XFER-ROWS.                                          04450000
069300                                                                  04460000
069400     EXEC SQL                                                     04470000
069500         FETCH XFER-CSR                                           04480000
069600          INTO :SNT00001-DAT-XFER-CNTL-ID                         04490000
069700             , :SNT00001-PRC-LOD-SEQ-NBR                          04500000
069800             , :SNT00001-DAT-CTG-CDE                              04510000
069900             , :SNT00001-LOD-DAT-TXT                              04520000
070000     END-EXEC.                                                    04530000
070100                                                                  04540000
070200     EVALUATE TRUE                                                04550000
070300       WHEN SQLCODE = +100                                        04560000
070400           SET PS-END-OF-XFER-CSR-YES TO TRUE                     04570000
070500                                                                  04580000
070600       WHEN SQLCODE = ZERO                                        04590000
070700           ADD +1 TO PA-TOTAL-PRFS-READ                           04600000
070800           PERFORM 3210-NUMERIC-PO-CHECK                          04610000
070810           PERFORM 3220-CHECK-FOR-DB2-PO                          04620000
070900                                                                  04630000
071000       WHEN OTHER                                                 04640000
071100           MOVE '3200-PROCESS-XFER-ROWS' TO PV-ABEND-PARAGRAPH    04650000
071200           MOVE 'FETCH XFER ROW'         TO PV-ABEND-OPERATION    04660000
071300           PERFORM 9900-DB2-ABEND                                 04670000
071400     END-EVALUATE.                                                04680000
071500                                                                  04690000
071600******************************************************************04700000
071700 3210-NUMERIC-PO-CHECK.                                           04710000
071800                                                                  04720000
071810     INITIALIZE DP010I-UNEDITED-FIELD.                            04730000
C94517     INITIALIZE PV-NUMERIC-EIGHT.                                 04740029
JIM        DISPLAY ' VALUE BEFORE SNT00001-LOD-DAT-TXT='                04750029
JIM                               SNT00001-LOD-DAT-TXT.                 04760029
071800                                                                  04770029
C94517     IF SNT00001-LOD-DAT-TXT(13:1) = SPACE                        04780031
JIM           DISPLAY ' LENGTH=7'                                       04790031
C94517        INITIALIZE WS-VALUE2-8                                    04800030
C94517        MOVE SNT00001-LOD-DAT-TXT(6:7) TO WS-VALUE2-8             04810030
C94517        MOVE WS-VALUE1-8               TO DP010I-UNEDITED-FIELD   04820029
C94517     ELSE                                                         04830029
JIM           DISPLAY ' LENGTH=8'                                       04840031
C94517        MOVE SNT00001-LOD-DAT-TXT(6:8) TO DP010I-UNEDITED-FIELD   04850029
C94517     END-IF.                                                      04860029
071800                                                                  04870029
JIM        DISPLAY ' VALUE AFTER DP010I-UNEDITED-FIELD='                04880029
JIM                              DP010I-UNEDITED-FIELD.                 04890029
C94517     PERFORM 5000-NUMERIC-EIGHT.                                  04900029
072000                                                                  04910000
072010 3220-CHECK-FOR-DB2-PO.                                           04920000
072011                                                                  04930000
069538******************************************************************04940000
069538* THE PO NUMBER IS FOUND IN SNT00001 AFTER 'PRF' IN               04950000
069538*     LOD_DAT_TXT.                                                04960000
069538*                                                                 04970000
C94517* IN THE MOVE STATEMENT THE REASON 6:8 IS USED IS BECAUSE OF THE  04980028
069538*  VARIABLE LENGTH FIELDS.                                        04990000
C94517*   (MOVE SNT00001-LOD-DAT-TXT(6:8) TO PW-PO-NBR-N.)              05000025
069538*                                                                 05010000
069538* DCLGEN                                                          05020000
069538*    10 SNT00001-LOD-DAT-TXT.                                     05030000
069538*        49 SNT00001-LOD-DAT-TXT-LEN       PIC S9(4) COMP.        05040000
069538*        49 SNT00001-LOD-DAT-TXT-TEXT      PIC X(350).            05050000
069538*                                                                 05060000
069538*  THUS, LEN FIELD FOR 2 + PRF FOR 3 = 5.                         05070000
069538*                                                                 05080000
069538* DAT_XFER_CNTL_ID | PRC_LOD_SEQ_NBR | DAT_CTG_CDE | LOD_DAT_TXT  05090000
069538* ---------------- | --------------- | ----------- | -----------  05100000
C94517*          225294  |              10 |          N1 | PRF81529000  05110025
069538*                                                                 05120000
069538******************************************************************05130000
069538*    INITIALIZE WS-ORACLE-TRANSFER-AREA.                          05140000
069538*    MOVE PV-NUMERIC-EIGHT TO WS-ORACLE-PO.                       05150027
069538*    CALL PC-SNKUT150 USING WS-ORACLE-TRANSFER-AREA.              05160000
069538*    MOVE WS-ORACLE-RC     TO WS-ORA-RETURN-CDE.                  05170000
069538     INITIALIZE PW-PO-NBR-N.                                      05180000
JIM   **   MOVE SNT00001-LOD-DAT-TXT(6:8) TO PW-PO-NBR-N.               05190029
JIM        MOVE PV-NUMERIC-EIGHT          TO PW-PO-NBR-N.               05200029
069538     MOVE SNT00001-DAT-XFER-CNTL-ID TO WS-DAT-XFER-CNTL-ID.       05210000
069538     MOVE PW-PO-NBR-N               TO WS-PO-NBR.                 05220000
JIM        DISPLAY 'PW-PO-NBR-N = ' PW-PO-NBR-N.                        05230029
069538                                                                  05240000
069538     EXEC SQL                                                     05250000
069538             SELECT PO_NBR                                        05260000
069538                  , ENT_ID                                        05270015
069538             INTO                                                 05280003
069538                  :PURCHS-PO-NBR                                  05290003
069538                , :PURCHS-ENT-ID                                  05300020
069538             FROM TPURCHS                                         05310018
069538             WHERE PO_NBR = :PW-PO-NBR-N                          05320018
069538                AND  VER_STATUS_CDE = 'A'                         05330018
069538             WITH UR                                              05340018
069538         END-EXEC                                                 05350018
069538                                                                  05360018
069538         EVALUATE TRUE                                            05370018
069538           WHEN SQLCODE = ZERO                                    05380018
069538                INITIALIZE DCLXLT00035                            05390015
069538                PERFORM 6000-GET-XLT-VND                          05400015
069538           WHEN SQLCODE = -811                                    05410003
069538                DISPLAY ' SQLCODE =     ' SQLCODE                 05420003
069538                CONTINUE                                          05430003
069538                                                                  05440003
069538           WHEN SQLCODE = +100                                    05450003
069538                SET PS-PO-IN-DB2-NO TO TRUE                       05460003
069538                DISPLAY '=================================='      05470003
069538                DISPLAY '*** PO NOT FOUND ON DB2 TABLE ***'       05480003
069538                DISPLAY 'DB2 RETURN CODE: ' SQLCODE               05490003
069538                DISPLAY 'CNTL# / PO = ' WS-DAT-XFER-CNTL-ID       05500000
069538                           ' / ' WS-PO-NBR                        05510000
069538                                                                  05520000
069538           WHEN OTHER                                             05530000
069538               MOVE '3220-CHECK-FOR-DB2-PO' TO PV-ABEND-PARAGRAPH 05540000
069538               MOVE 'SELECT PO FROM TPURCHS' TO PV-ABEND-OPERATION05550000
069538               PERFORM 9900-DB2-ABEND                             05560000
069538                                                                  05570000
069538         END-EVALUATE.                                            05580000
261300                                                                  05590000
072900******************************************************************05600000
073000 3300-CLOSE-XFER-CURSOR.                                          05610000
073100                                                                  05620000
073200     EXEC SQL                                                     05630000
073300         CLOSE XFER-CSR                                           05640000
073400     END-EXEC.                                                    05650000
073500                                                                  05660000
073600     EVALUATE TRUE                                                05670000
073700       WHEN SQLCODE = ZERO                                        05680000
073800           CONTINUE                                               05690000
073900                                                                  05700000
074000       WHEN OTHER                                                 05710000
074100           MOVE '3300-CLOSE-XFER-CURSOR' TO PV-ABEND-PARAGRAPH    05720000
074200           MOVE 'CLOSE XFER-CSR '        TO PV-ABEND-OPERATION    05730000
074300           PERFORM 9900-DB2-ABEND                                 05740000
074400     END-EVALUATE.                                                05750000
074500                                                                  05760000
089100******************************************************************05770000
C94517 5000-NUMERIC-EIGHT.                                              05780027
C94517                                                                  05790027
C94517     MOVE 8 TO DP010I-MAXIMUM-DIGITS                              05800027
089103     MOVE 0 TO DP010I-MAXIMUM-DECIMALS                            05810000
089104     SET DP010I-NEGATIVE-NOT-ALLOWED TO TRUE                      05820000
263627     CALL DP010I-NUMERIC-EDIT-ROUTINE                             05831032
263627          USING DP010I-NUMERIC-EDIT-AREA                          05832032
089106     IF DP010I-ERROR-DETECTED                                     05840000
C94517         MOVE ZEROES TO PV-NUMERIC-EIGHT                          05850027
089108     ELSE                                                         05860000
C94517         MOVE DP010I-NUMERIC-FIELD TO PV-NUMERIC-EIGHT            05870027
089110     END-IF.                                                      05880000
089111                                                                  05890000
069538 6000-GET-XLT-VND.                                                05900015
069538******************************************************************05910015
069538*  CHECK XLT_VND TABLE TO MAKE SURE THIS IS A VALID VENDOR.       05920023
069538******************************************************************05930015
069538     EXEC SQL                                                     05940015
069538        SELECT                                                    05950015
069538               ENT_ID                                             05960015
069538             , VND_NBR                                            05970015
069538           INTO                                                   05980015
069538                :XLT00035-ENT-ID                                  05990015
069538              , :XLT00035-VND-NBR                                 06000015
069538           FROM XLT_VND                                           06010015
069538           WHERE ENT_ID = :PURCHS-ENT-ID                          06020020
069538     END-EXEC.                                                    06030018
069538                                                                  06040018
069538     EVALUATE TRUE                                                06050018
069538       WHEN SQLCODE = 0                                           06060018
069538           MOVE XLT00035-VND-NBR TO WS-VEND-X                     06070015
069538           MOVE XLT00035-ENT-ID TO WS-ENT-ID                      06080017
069538                                                                  06090020
069538       WHEN SQLCODE = +100                                        06100020
069538           SET PS-VND-IN-DB2-NO TO TRUE                           06110020
069538           MOVE XLT00035-VND-NBR TO WS-VEND-X                     06120020
069538           MOVE XLT00035-ENT-ID TO WS-ENT-ID                      06130020
069538           DISPLAY '=================================='           06140020
069538           DISPLAY '*** VND NOT FOUND ON DB2 TABLE ***'           06150020
069538           DISPLAY 'DB2 RETURN CODE: ' SQLCODE                    06160020
069538           DISPLAY ' VND# / ENT ID = ' WS-VEND-X                  06170020
069538                           ' / ' WS-ENT-ID                        06180020
069538                                                                  06190020
069538       WHEN OTHER                                                 06200020
069538           DISPLAY '**************************************'       06210020
069538           DISPLAY '** ABEND                             *'       06220020
069538           DISPLAY '** PROGRAM = SNKUP105                *'       06230020
069538           DISPLAY '** PARAGRAPH = 6000-GET-XLT-VND'              06240020
069538           DISPLAY '** SELECT XLT_VND                    *'       06250020
069538           DISPLAY '**************************************'       06260020
069538           PERFORM 9900-DB2-ABEND                                 06270020
069538     END-EVALUATE.                                                06280020
069538******************************************************************06290020
089120******************************************************************06300000
089200*                   E O J   P R O C E S S I N G                  *06310000
089300******************************************************************06320000
089400 9000-EOJ-ROUTINE.                                                06330000
089500                                                                  06340000
090300*END-OF-JOB SYSOUT DISPLAYS.                                      06350000
090400     DISPLAY ' '.                                                 06360000
090500     DISPLAY '*************************************'.             06370000
090600     DISPLAY '   * SNKUP105 SUMMARY STATISTICS *    '.            06380000
090700     DISPLAY ' '.                                                 06390000
090800     DISPLAY '   ------------------------------ '.                06400000
090900     DISPLAY '         PO RECYCLE RESULTS       '.                06410000
091000     DISPLAY '   ------------------------------ '.                06420000
091100     MOVE PA-TOTAL-ASNS-READ            TO PV-DISPLAY-RECORD.     06430000
091200     DISPLAY ' NUMBER OF ASNS ON HOLD  = ' PV-DISPLAY-RECORD.     06440000
091300     MOVE PA-TOTAL-PRFS-READ            TO PV-DISPLAY-RECORD.     06450000
091400     DISPLAY ' NUMBER OF PO# CHECKED   = ' PV-DISPLAY-RECORD.     06460000
091500     DISPLAY ' '.                                                 06470000
091600     MOVE PA-TOTAL-ASNS-UPDATED         TO PV-DISPLAY-RECORD.     06480000
091700     DISPLAY ' NUMBER OF ASNS RELEASED = ' PV-DISPLAY-RECORD.     06490000
091800     DISPLAY '*************************************'.             06500000
091900                                                                  06510000
093800******************************************************************06520000
093900* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      06530000
094000* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 06540000
094100******************************************************************06550000
094200 9900-DB2-ABEND.                                                  06560000
094300                                                                  06570000
094400     MOVE SQLCODE    TO PV-SQLCODE.                               06580000
094500     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       06590000
094600     DISPLAY '*** DB2 ERROR ***'.                                 06600000
094700     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               06610000
094800     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 06620000
094900     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               06630000
095000     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               06640000
095100     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       06650000
095200     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             06660000
095300                                                                  06670000
095400******************************************************************06680000
095500* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06690000
095600* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06700000
095700* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06710000
095800* FORMAT.                                                         06720000
095900******************************************************************06730000
096000     COPY DPPD004.                                                06740000
096100                                                                  06750000
096200     IF SQLCODE NOT = -911                                        06760000
096300         EXEC SQL                                                 06770000
096400             ROLLBACK                                             06780000
096500         END-EXEC                                                 06790000
096600     END-IF.                                                      06800000
096700                                                                  06810000
096800     MOVE +4013         TO PV-ABEND-CODE.                         06820000
096900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06830000
097000******************************************************************06840000
