       IDENTIFICATION DIVISION.                                         00010000
                                                                        00020000
       PROGRAM-ID.    XMKUP900                                          00030000
       AUTHOR.        ERIN SEARL.                                       00040000
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
       DATE-WRITTEN.  1-29-08.                                          00060000
       DATE-COMPILED.                                                   00070000
                                                                        00080000
      ******************************************************************00090000
      *           XMKUP900 - LOAD XXT_BOM_SKU_ATTR                      00100000
      *                      DB2 TABLE UPDATE                           00110000
      ******************************************************************00120000
      ******************************************************************00130000
      *    WR/PITS#     DATE        DESCRIPTION                        *00140000
      *    --------   --------     ---------------------------------   *00150000
      *    W32898     04/15/2008   ORIGINAL DEVELOPMENT                 00160002
      *    W32898                  B.GRAHAM - STRATAGEM                 00170000
      *    W32898     04/16/2008   ORIGINAL DEVELOPMENT FIX CHECKPOINT  00171002
      *    W32898                  B.GRAHAM - STRATAGEM                 00172002
      ******************************************************************00180000
                                                                        00190000
       ENVIRONMENT DIVISION.                                            00200000
                                                                        00210000
       CONFIGURATION SECTION.                                           00220000
       SOURCE-COMPUTER.        IBM-3090.                                00230000
       OBJECT-COMPUTER.        IBM-3090.                                00240000
       INPUT-OUTPUT SECTION.                                            00250000
       FILE-CONTROL.                                                    00260000
           SELECT SKU-ATTR-EXTR-FILE                                    00270000
               ASSIGN TO INP01.                                         00280000
                                                                        00290000
                                                                        00300000
       DATA DIVISION.                                                   00310000
       FILE SECTION.                                                    00320000
                                                                        00330000
       FD  SKU-ATTR-EXTR-FILE                                           00340000
           LABEL RECORDS ARE STANDARD                                   00350000
           RECORDING MODE IS F                                          00360000
           BLOCK CONTAINS 0 RECORDS.                                    00370000
       01  SKU-ATTR-EXTR-REC           PIC X(100).                      00380000
      *                                                                 00390000
                                                                        00400000
       WORKING-STORAGE SECTION.                                         00410000
                                                                        00420000
       01  FILLER                      PIC X(28)   VALUE                00430000
                'BEGINNING OF WORKING STORAGE'.                         00440000
                                                                        00450000
       01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00460000
                                                                        00470000
       01  PC-PROGRAM-CONSTANTS.                                        00480000
           05  PC-JOB-NAME             PIC  X(06)    VALUE 'XMK505'.    00490000
           05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'XMKUP900'.  00500000
           05  PC-COMMIT-FRQNCY-QTY    PIC  9(09)    VALUE  9990.       00501005
                                                                        00510000
      *                                                                 00520000
       01  PS-PROGRAM-SWITCHES.                                         00530000
           05  PS-AT-END-SKU-EXTR-SW        PIC X(01)     VALUE 'N'.    00540000
               88  PS-AT-END-SKU-EXTR-NO                  VALUE 'N'.    00550000
               88  PS-AT-END-SKU-EXTR-YES                 VALUE 'Y'.    00560000
                                                                        00570000
      *                                                                 00580000
       01  PROGRAM-VARIABLES.                                           00590000
      *                                                                 00600000
           05  PV-PARAGRAPH-NAME         PIC  X(30) VALUE SPACES.       00610000
           05  PV-ABEND-MESSAGE          PIC  X(75) VALUE SPACES.       00620000
           05  PV-OPERATION-ATTEMPTED    PIC  X(50) VALUE SPACES.       00630000
                                                                        00640000
       01  PA-PROGRAM-ACCUMULATORS.                                     00650000
           05  PA-RECORD-COUNTS.                                        00660000
               10  PA-INPUT-COUNT        PIC  9(09)  VALUE ZEROES.      00670000
               10  PA-UPDATE-COUNT       PIC  9(09)  VALUE ZEROES.      00680000
               10  PA-INSERT-COUNT       PIC  9(09)  VALUE ZEROES.      00690000
               10  PA-RECS-THIS-COMMIT-COUNT                            00710003
                                         PIC  9(09)  VALUE ZEROES.      00720000
               10  PA-TOTAL-COUNT        PIC  9(09)  VALUE ZEROES.      00730000
                                                                        00740000
      *                                                                 00750000
      ******************************************************************00760000
      * IMRD064 - SNAPSHOT RECORD LAYOUT                                00770000
      ******************************************************************00780000
           COPY IMRD064.                                                00790000
      *                                                                 00800000
      ******************************************************************00810000
      *  DB2 ERROR MESSAGES FORMAT AREA.                                00820000
      ******************************************************************00830000
           COPY DPWS004.                                                00840000
      *                                                                 00850000
      ******************************************************************00860000
      *  USED FOR DB2 ERRORS                                            00870000
      ******************************************************************00880000
           EXEC SQL                                                     00890000
               INCLUDE SQLCA                                            00900000
           END-EXEC.                                                    00910000
      *                                                                 00920000
      ******************************************************************00930000
      *  XMT_BOM_SKU_ATTR TABLE                                         00940000
      ******************************************************************00950000
           EXEC SQL                                                     00960000
               INCLUDE XMT00023                                         00970000
           END-EXEC.                                                    00980000
      *                                                                 00990000
      *                                                                 01220000
                                                                        01230000
      *-------------------*                                             01240000
       PROCEDURE DIVISION.                                              01250000
      *-------------------*                                             01260000
                                                                        01270000
       0000-XMKUP900.                                                   01280000
                                                                        01290000
           PERFORM 1000-INITIALIZATION.                                 01300000
      *                                                                 01310000
           IF PS-AT-END-SKU-EXTR-NO                                     01320000
               PERFORM 2000-PROCESS-INPUT                               01330000
                    UNTIL PS-AT-END-SKU-EXTR-YES.                       01340000
      *                                                                 01350000
           PERFORM 8000-EOJ-ROUTINE.                                    01360000
                                                                        01370000
           STOP RUN.                                                    01380000
                                                                        01390000
      ******************************************************************01400000
      * OPEN INPUT FILE , INITIALIZE COUNTERS                           01410003
      ******************************************************************01430000
      *                                                                 01440000
       1000-INITIALIZATION.                                             01450000
                                                                        01460003
           OPEN INPUT SKU-ATTR-EXTR-FILE.                               01470000
                                                                        01480000
                                                                        01830000
      ******************************************************************01840000
      * PROCESS THE SKU-ATTR-EXTR-REC. (INSERT OR UPDATE)               01850000
      * INSERT IS THE NORMAL EXPECTED PROCESSING PATH                   01860000
      ******************************************************************01870000
       2000-PROCESS-INPUT.                                              01880000
                                                                        01890000
           PERFORM 4000-READ-SKU-ATTR-EXTR-FILE.                        01891007
                                                                        01892007
           IF PS-AT-END-SKU-EXTR-NO                                     01893007
               PERFORM 3000-INSERT-TABLE-ROW                            01900007
               PERFORM 3200-COMMIT-CHECK                                01920007
           END-IF.                                                      01930007
                                                                        01950000
                                                                        01960000
      ******************************************************************01970000
      * INSERT IMRD064 RECORD TO THE TABLE                              01980000
      * INSERT IS THE NORMAL EXPECTED PROCESSING PATH                   01990000
      ******************************************************************02000000
                                                                        02010000
       3000-INSERT-TABLE-ROW.                                           02020000
                                                                        02030000
                                                                        02040000
      *    DISPLAY 'IM064-FSCL-BOM-DATE ' IM064-FSCL-BOM-DATE.          02041007
           EXEC SQL                                                     02050000
               INSERT INTO XMT_BOM_SKU_ATTR                             02060000
                      (SKU_NBR                                          02070000
                      ,FSCL_BOM_DATE                                    02080000
                      ,DEPT_NBR                                         02090000
                      ,MAJ_CL_NBR                                       02100000
                      ,SUB_CL_NBR                                       02110000
                      ,ENT_ID                                           02120000
                      ,LBL_SEQ_NBR                                      02130000
                      ,INTR_UPC_ID                                      02140000
                      ,ITM_NBR                                          02150000
                      ,STYL_ID                                          02160000
                      ,VS_NBR                                           02170000
                      ,VS_ID)                                           02180000
               VALUES (  :IM064-SKU-NBR                                 02190000
                       , :IM064-FSCL-BOM-DATE                           02200000
                       , :IM064-DEPT-NBR                                02210000
                       , :IM064-MAJ-CL-NBR                              02220000
                       , :IM064-SUB-CL-NBR                              02230000
                       , :IM064-ENT-ID                                  02240000
                       , :IM064-LBL-SEQ-NBR                             02250000
                       , :IM064-INTR-UPC-ID                             02260000
                       , :IM064-ITM-NBR                                 02270000
                       , :IM064-STYL-ID                                 02280000
                       , :IM064-VS-NBR                                  02290000
                       , :IM064-VS-ID)                                  02300000
           END-EXEC.                                                    02310000
      *                                                                 02320000
           EVALUATE SQLCODE                                             02330000
               WHEN 0                                                   02340000
                   ADD 1 TO PA-INSERT-COUNT                             02350000
               WHEN -803                                                02360000
                   PERFORM 3100-UPDATE-TABLE-ROW                        02370000
               WHEN OTHER                                               02380000
                   DISPLAY '*** -BAD INSERT TO XMT_BOM_SKU_ATTR ***'    02390000
                   MOVE '3000-INSERT-TABLE-ROW' TO PV-PARAGRAPH-NAME    02400000
                   MOVE 'INSERT TO XMT_BOM_SKU_ATTR'                    02410000
                                          TO PV-OPERATION-ATTEMPTED     02420000
                   DISPLAY 'INPUT COUNT AT ABEND ' PA-INPUT-COUNT       02430000
                   PERFORM 9999-SQL-ABEND                               02440000
           END-EVALUATE.                                                02450000
                                                                        02460000
       3100-UPDATE-TABLE-ROW.                                           02470000
                                                                        02480000
           EXEC SQL                                                     02490000
               UPDATE XMT_BOM_SKU_ATTR                                  02500000
                   SET SKU_NBR         = :IM064-SKU-NBR                 02510000
                      ,FSCL_BOM_DATE   = :IM064-FSCL-BOM-DATE           02520000
                      ,DEPT_NBR        = :IM064-DEPT-NBR                02530000
                      ,MAJ_CL_NBR      = :IM064-MAJ-CL-NBR              02540000
                      ,SUB_CL_NBR      = :IM064-SUB-CL-NBR              02550000
                      ,ENT_ID          = :IM064-ENT-ID                  02560000
                      ,LBL_SEQ_NBR     = :IM064-LBL-SEQ-NBR             02570000
                      ,INTR_UPC_ID     = :IM064-INTR-UPC-ID             02580000
                      ,ITM_NBR         = :IM064-ITM-NBR                 02590000
                      ,STYL_ID         = :IM064-STYL-ID                 02600000
                      ,VS_NBR          = :IM064-VS-NBR                  02610000
                      ,VS_ID           = :IM064-VS-ID                   02620000
                   WHERE SKU_NBR       = :IM064-SKU-NBR                 02630000
                     AND FSCL_BOM_DATE = :IM064-FSCL-BOM-DATE           02640000
           END-EXEC.                                                    02650000
                                                                        02660000
           EVALUATE SQLCODE                                             02670000
               WHEN 0                                                   02680000
                   ADD 1 TO PA-UPDATE-COUNT                             02690000
               WHEN OTHER                                               02700000
                   DISPLAY '*** -BAD UPDATE TO XMT_BOM_SKU_ATTR ***'    02710000
                   MOVE '3100-UPDATE-TABLE-ROW' TO PV-PARAGRAPH-NAME    02720000
                   DISPLAY 'INPUT COUNT AT ABEND ' PA-INPUT-COUNT       02730000
                   PERFORM 9999-SQL-ABEND                               02740000
           END-EVALUATE.                                                02750000
                                                                        02760000
                                                                        02770000
      ******************************************************************02780000
      * TAKE CHECKPOINT BASED UPON RECORD COUNT IN CHKPT TABLE          02790000
      * COMMIT INSERTS/UPDATES                                          02800000
      ******************************************************************02810000
                                                                        02820000
       3200-COMMIT-CHECK.                                               02830003
                                                                        02840000
           ADD 1 TO PA-RECS-THIS-COMMIT-COUNT.                          02850003
                                                                        02860000
           IF PA-RECS-THIS-COMMIT-COUNT =                               02870003
                                   PC-COMMIT-FRQNCY-QTY                 02871005
               PERFORM 3250-DO-COMMIT                                   02880003
               MOVE ZEROS TO PA-RECS-THIS-COMMIT-COUNT                  02890003
           END-IF.                                                      02900000
                                                                        02910000
                                                                        02920000
       3250-DO-COMMIT.                                                  02930003
                                                                        02940000
                                                                        03200000
           EXEC SQL                                                     03210000
               COMMIT                                                   03220000
           END-EXEC.                                                    03230000
                                                                        03240000
           IF SQLCODE = 0                                               03250000
               DISPLAY 'COMMIT TAKEN AT INPUT RECORD #'                 03260003
                        PA-INPUT-COUNT                                  03270003
           ELSE                                                         03280000
               MOVE 'COMMIT             '    TO PV-OPERATION-ATTEMPTED  03290000
               MOVE  '3250-DO-COMMIT '                                  03300003
                                             TO PV-PARAGRAPH-NAME       03310000
               PERFORM 9999-SQL-ABEND                                   03320000
           END-IF.                                                      03330000
                                                                        03340000
      *                                                                 03350000
      ******************************************************************03360000
      * READS THE SKU-ATTR-EXTR-FILE USING IMRD064 LAYOUT               03370000
      ******************************************************************03380000
       4000-READ-SKU-ATTR-EXTR-FILE.                                    03390000
                                                                        03400000
           READ SKU-ATTR-EXTR-FILE INTO IM064-BOM-SKU-ATTR-EXTR-REC     03410000
              AT END                                                    03420000
                SET PS-AT-END-SKU-EXTR-YES TO TRUE.                     03430000
                                                                        03440000
           IF PS-AT-END-SKU-EXTR-NO                                     03450000
               ADD 1 TO PA-INPUT-COUNT.                                 03460000
      *                                                                 03470000
      *                                                                 03480000
                                                                        04170000
      *                                                                 04190000
      *                                                                 04200000
       8000-EOJ-ROUTINE.                                                04210000
      *                                                                 04220000
                                                                        04250000
      *                                                                 04260000
           DISPLAY SPACES.                                              04270000
           DISPLAY 'INPUT RECORDS PROCESSED  ', PA-INPUT-COUNT.         04280000
           DISPLAY 'ROWS UPDATED             ', PA-UPDATE-COUNT.        04290000
           DISPLAY 'ROWS INSERTED            ', PA-INSERT-COUNT.        04300000
           DISPLAY SPACES.                                              04310000
                                                                        04320000
           COMPUTE PA-TOTAL-COUNT = PA-INSERT-COUNT +                   04330000
                                    PA-UPDATE-COUNT.                    04340000
                                                                        04350000
           IF PA-TOTAL-COUNT = PA-INPUT-COUNT                           04360000
               DISPLAY 'PROGRAM IN BALANCE '                            04370000
           ELSE                                                         04380000
               DISPLAY 'PROGRAM OUT OF BALANCE'                         04390000
           END-IF.                                                      04400000
                                                                        04410000
           CLOSE SKU-ATTR-EXTR-FILE.                                    04420000
                                                                        04430000
                                                                        04440000
                                                                        04450000
      ******************************************************************04460000
      *  STANDARD DB2 ERROR ABEND ROUTINE                               04470000
      *  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             04480000
      ******************************************************************04490000
       9999-SQL-ABEND.                                                  04500000
                                                                        04510000
           MOVE +4013                 TO ABEND-CODE.                    04520000
           DISPLAY '**  ABEND     **'.                                  04530000
           DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              04540000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            04550000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       04560000
                                                                        04570000
      *    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         04580000
      *    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        04590000
                                                                        04600000
           COPY DPPD004.                                                04610000
           CALL 'ILBOABN0'  USING ABEND-CODE.                           04620000
