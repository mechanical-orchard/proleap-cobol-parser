000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400                                                                  00040001
000500 PROGRAM-ID.             TXKUT101.                                00050001
000600 AUTHOR.                 JOE GARETTO.                             00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN.           FEBRUARY 2017.                           00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100******************************************************************00110001
001200*  THIS PROGRAM COMPARES THE TAX RATE ON INPUT COSA TRANSACTIONS *00120001
001300*  FOR INSTORE BOPUS AND POC PURCHASES AGAINST THE TAX RATE      *00130001
001400*  FOUND ON TAX MAINTENANCE.                                     *00140001
001500******************************************************************00150001
001600*  08/16/17  JOE GARDETTO CHG0175504                             *00160001
001700*  INTIAL PROGRAM CREATED.                                       *00170001
001800******************************************************************00180001
001900*  09/06/2017                                                     00190001
002000*     CHANGES TO FIX TOTAL TRAN/ITEM COUNTER. EXCEPTIONS WERE     00200001
002100*     BEING COUNTED TWICE. MOVED ALL PV FIELDS UNDER              00210001
002200*     PV-PROGRAM-VARIABLES.                                       00220001
002300*  MADE BY: JOE GARDETTO                WR#:CHG0177071           *00230001
002400******************************************************************00240001
002500*  02/17/2018                                                     00250001
002600*     CHANGES TO IGNORE TRAN/ITEMS WHERE TAX RATE IS ZERO DUE TO  00260001
002700*     LOW SUBJECT TO TAX AMT CAUSING ZERO TAX.                    00270001
002800*  MADE BY: JOE GARDETTO                WR#:CHG0190554           *00280001
002900******************************************************************00290001
003000*  03/01/2018                                                     00300001
003100*     ADDING 'BOS' TO THE PROGRAM. USING THE 'OTH' COLUMN ON THE  00310001
003200*     FILES FOR 'BOS'.                                            00320001
003300*  MADE BY: BARB SCHULTZ                WR#:CHG0188487           *00330001
003400******************************************************************00340001
003500*  08/06/2018                                                     00350001
003600*     CHANGES TO FIX ISSUES WITH PROGRAM RUNNING TO LONG.         00360001
003700*  MADE BY: JOE GARDETTO                WR#:CHG0205117           *00370001
003800******************************************************************00380001
003900*  04/30/2019                                                     00390001
004000*     CHANGES TO FIX ISSUES WITH TRESHOLD LOGIC FOR NY AND MA.    00400001
004100*     REPLACED STORE 1133 WITH 1568 FOR PIF/PUF FEE LOGIC.        00410001
004200*  MADE BY: JOE GARDETTO                WR#:CHG0222915           *00420001
004300******************************************************************00430001
004400*  03/04/2020                                                     00440001
004500*     CHANGES TO FIX ISSUES WITH FALSE POSITIVES.                 00450001
004600*     ADDED CODE TO CALC ACTUAL PRICE FOR MA ORDERS TO CHECK      00460001
004700*     AGAINST THE THRESHOLD.                                      00470001
004800*  MADE BY: SCOTT KRUSCHKA              WR#:CHG0240521           *00480001
004900******************************************************************00490001
005000*  06/23/2020                                                    *00500001
005100*     MADE SOME CHANGES TO THREE SQL STATEMENTS IN PARAGRAPHS    *00510001
005200*     7000-..., 7010-..., AND 7020-... TO MAKE THE PROGRAM RUN   *00520001
005300*     FASTER.  THESE WERE DONE TO TOM PETERSON'S RECOMMEDATION.  *00530001
005400*  MADE BY: BARB SCHULTZ                WR#:CHG0245444           *00540001
005500******************************************************************00550001
005600*  07/01/2020                                                    *00560002
005700*     CHANGES TO FIX ISSUES WITH NOT REPORTING TRANSACTIONS THAT *00570001
005800*     WERE TAXED AT 0% THAT SHOULD HAVE BEEN TAXED.              *00580001
005900*                                                                *00590001
006000*  MADE BY: SCOTT KRUSCHKA              WR#:CHG0245778           *00600002
006100******************************************************************00610001
006200 ENVIRONMENT DIVISION.                                            00620001
006300                                                                  00630001
006400 INPUT-OUTPUT SECTION.                                            00640001
006500                                                                  00650001
006600 FILE-CONTROL.                                                    00660001
006700                                                                  00670001
006800     SELECT DATE-CNTL-FILE                                        00680001
006900         ASSIGN TO INP01.                                         00690001
007000                                                                  00700001
007100     SELECT TAX-RATE-DETAIL                                       00710001
007200         ASSIGN TO OUT01.                                         00720001
007300                                                                  00730001
007400     SELECT TAX-RATE-STATS                                        00740001
007500         ASSIGN TO OUT02.                                         00750001
007600                                                                  00760001
007700     SELECT TAX-RATE-EMAIL                                        00770001
007800         ASSIGN TO OUT03.                                         00780001
007900                                                                  00790001
008000******************************************************************00800001
008100 DATA DIVISION.                                                   00810001
008200******************************************************************00820001
008300                                                                  00830001
008400 FILE SECTION.                                                    00840001
008500                                                                  00850001
008600 FD  DATE-CNTL-FILE                                               00860001
008700     RECORDING MODE IS F                                          00870001
008800     LABEL RECORDS ARE STANDARD                                   00880001
008900     BLOCK CONTAINS 0 RECORDS                                     00890001
009000     RECORD CONTAINS 80 CHARACTERS                                00900001
009100     DATA RECORD IS DATE-CNTL-RECORD.                             00910001
009200                                                                  00920001
009300 01  DATE-CNTL-RECORD         PIC X(80).                          00930001
009400                                                                  00940001
009500 FD  TAX-RATE-DETAIL                                              00950001
009600     RECORDING MODE IS F                                          00960001
009700     LABEL RECORDS ARE STANDARD                                   00970001
009800     BLOCK CONTAINS 0 RECORDS                                     00980001
009900     RECORD CONTAINS 150 CHARACTERS                               00990001
010000     DATA RECORD IS TAX-RATE-DETAIL-REC.                          01000001
010100                                                                  01010001
010200 01  TAX-RATE-DETAIL-REC PIC X(150).                              01020001
010300                                                                  01030001
010400 FD  TAX-RATE-STATS                                               01040001
010500     RECORDING MODE IS F                                          01050001
010600     LABEL RECORDS ARE STANDARD                                   01060001
010700     BLOCK CONTAINS 0 RECORDS                                     01070001
010800     RECORD CONTAINS 60 CHARACTERS                                01080001
010900     DATA RECORD IS TAX-RATE-STATS-REC.                           01090001
011000                                                                  01100001
011100 01  TAX-RATE-STATS-REC     PIC X(60).                            01110001
011200                                                                  01120001
011300 FD  TAX-RATE-EMAIL                                               01130001
011400     RECORDING MODE IS F                                          01140001
011500     LABEL RECORDS ARE STANDARD                                   01150001
011600     BLOCK CONTAINS 0 RECORDS                                     01160001
011700     RECORD CONTAINS 80 CHARACTERS                                01170001
011800     DATA RECORD IS TAX-RATE-EMAIL-REC.                           01180001
011900                                                                  01190001
012000 01  TAX-RATE-EMAIL-REC     PIC X(80).                            01200001
012100                                                                  01210001
012200 WORKING-STORAGE SECTION.                                         01220001
012300                                                                  01230001
012400 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01240001
012500                                                  COMP SYNC.      01250001
012600     88  ABEND-4003-INVALID-CNTL-CARD             VALUE +4003.    01260001
012700     88  ABEND-4004-TABLE-OVERFLOW                VALUE +4004.    01270001
012800     88  ABEND-4013-DB2-ERROR                     VALUE +4013.    01280001
012900                                                                  01290001
013000 01  PS-PROGRAM-SWITCHES.                                         01300001
013100     05  PS-NULL-IND6            PIC S9(4) COMP VALUE ZERO.       01310001
013200         88 PS-IND6-IS-NULL             VALUE -1.                 01320001
013300     05  PS-NULL-IND7            PIC S9(4) COMP VALUE ZERO.       01330001
013400     05  PS-TRAN-IND                  PIC X(1) VALUE ' '.         01340001
013500         88  PS-SFS                            VALUE 'S'.         01350001
013600         88  PS-BPS                            VALUE 'B'.         01360001
013700         88  PS-POC                            VALUE 'P'.         01370001
013800         88  PS-BOS                            VALUE 'O'.         01380001
013900         88  PS-OTH                            VALUE 'N'.         01390001
014000     05  PS-END-OF-DATE-CNTL-FILE-SW                              01400001
014100                                 PIC X(1)     VALUE 'N'.          01410001
014200         88  PS-NOT-END-OF-DATE-CNTL-FILE     VALUE 'N'.          01420001
014300         88  PS-END-OF-DATE-CNTL-FILE         VALUE 'Y'.          01430001
014400     05  PS-TCNT-STORE-FOUND-SW                                   01440001
014500                                 PIC X(1)     VALUE 'N'.          01450001
014600         88  PS-TCNT-STORE-FOUND-NO           VALUE 'N'.          01460001
014700         88  PS-TCNT-STORE-FOUND-YES          VALUE 'Y'.          01470001
014800     05  PS-END-OF-FEES-CURSOR-SW                                 01480001
014900                                 PIC X(1)     VALUE SPACE.        01490001
015000         88  PS-END-OF-FEES-CURSOR          VALUE 'Y'.            01500001
015100         88  PS-NOT-END-OF-FEES-CURSOR      VALUE 'N'.            01510001
015200     05  PS-END-OF-LID-CURSOR-SW PIC X(1)     VALUE SPACE.        01520001
015300         88  PS-END-OF-LID-CURSOR           VALUE 'Y'.            01530001
015400         88  PS-NOT-END-OF-LID-CURSOR       VALUE 'N'.            01540001
015500     05  PS-END-OF-POC-BPS-CURSOR-SW                              01550001
015600                                 PIC X(1)     VALUE SPACE.        01560001
015700         88  PS-END-OF-POC-BPS-CURSOR         VALUE 'Y'.          01570001
015800         88  PS-NOT-END-OF-POC-BPS-CURSOR     VALUE 'N'.          01580001
015900     05  PS-TXM-FT-RATE-FOUND-SW   PIC X(1)   VALUE 'N'.          01590001
016000         88  PS-TXM-FT-RATE-FOUND-NO          VALUE 'N'.          01600001
016100         88  PS-TXM-FT-RATE-FOUND-YES         VALUE 'Y'.          01610001
016200     05  PS-TXM-RATE-FOUND-SW   PIC X(1)      VALUE 'N'.          01620001
016300         88  PS-TXM-RATE-FOUND-NO             VALUE 'N'.          01630001
016400         88  PS-TXM-RATE-FOUND-YES            VALUE 'Y'.          01640001
016500                                                                  01650001
016600 01  PC-PROGRAM-CONSTANTS.                                        01660001
016700     05  PC-CURRENT-PROGRAM-NAME PIC X(8)   VALUE 'TXKUT101'.     01670001
016800     05  PC-STORE-1568-FEE       PIC S9V9(05) VALUE .01.          01680001
016900     05  PC-MA-TRESHOLD-TXMAINT  PIC S999V9(02) VALUE 500.00.     01690001
017000     05  PC-MA-TRESHOLD-TAXWARE  PIC S999V9(02) VALUE 175.00.     01700001
017100                                                                  01710001
017200 01  PV-PROGRAM-VARIABLES.                                        01720001
017300     05  PV-PREV-XST00001-ST-CDE PIC  X(2).                       01730001
017400     05  PV-PREV-EPITM-STR-NBR   PIC   9(4).                      01740001
017500     05  PV-PREV-EPITM-SKU-NBR   PIC S9(8)V COMP-3.               01750001
017600     05  PV-PREV-TXT00008-PRD-TX-CDE           PIC   X(1).        01760001
017700     05  PV-PRODUCT-CODE         PIC X(05).                       01770001
017800     05  PV-DSPLY-STR-NBR        PIC 9(04).                       01780001
017900     05  PV-DSPLY-PARTITION      PIC 9(04).                       01790001
018000     05  PV-DSPLY-RGST-ID        PIC 9(04).                       01800001
018100     05  PV-DSPLY-TRN-NBR        PIC 9(04).                       01810001
018200     05  PV-TAX-RT-PCT-CHR.                                       01820001
018300         10  PV-TAX-RT-PCT       PIC  S9V9(05).                   01830001
018400     05  PV-TM-TAX-RT-PCT-CHR.                                    01840001
018500         10  PV-TM-TAX-RT-PCT    PIC  S9V9(05).                   01850001
018600     05  PV-TAX-RT-PCT-DIFF-CHR.                                  01860001
018700         10  PV-TAX-RT-DIFF-PCT  PIC S9V9(05).                    01870001
018800     05  PV-BLENDED-TAX-RT-PCT-CHR.                               01880001
018900         10  PV-BLENDED-TAX-RT-PCT  PIC S9V9(05).                 01890001
019000     05  PV-PROCESSING-DATE      PIC X(10).                       01900001
019100     05  PV-PREV-PROCESSING-DATE PIC X(10).                       01910001
019200     05  PV-POS-SALES-DATE       PIC X(10).                       01920001
019300     05  PV-EPLID-LID-AMT        PIC S9(7)V99 VALUE ZERO.         01930001
019400     05  PV-EPLID-LID-PCT        PIC 9(1)V9(5) VALUE ZERO.        01940001
019500     05  PV-EPLID-PRORATED-AMT   PIC S9(7)V99 VALUE ZERO.         01950001
019600     05  PV-ACTUAL-PRICE-CHRGD   PIC S9(7)V99 VALUE ZERO.         01960001
019700     05  PV-PCT-AMT-OFF          PIC S9(7)V99 VALUE ZERO.         01970001
019800     05 PV-TAX-MAINT-RT-PCT     PIC  S9(1)V9(5) COMP-3.           01980001
019900     05 PV-FULL-TAX-RATE        PIC S9(1)V9(5) COMP-3 VALUE ZERO. 01990001
020000     05 PV-TEMP-TX-RT-PCT       PIC S9(1)V9(5) COMP-3 VALUE ZERO. 02000001
020100     05 PV-TEMP-BLW-THRS-TX-RT-PCT                                02010001
020200                                PIC S9(1)V9(5) COMP-3 VALUE ZERO. 02020001
020300     05 PV-TAX-AMT              PIC S9(5)V9(5) COMP-3.            02030001
020400                                                                  02040001
020500 01  PV-MISC-ABEND-FIELDS.                                        02050001
020600     05  PV-PARAGRAPH-NAME     PIC  X(30)  VALUE SPACE.           02060001
020700     05  PV-OPERATION-MSG-1    PIC  X(40)  VALUE SPACE.           02070001
020800     05  PV-OPERATION-MSG-2    PIC  X(40)  VALUE SPACE.           02080001
020900     05  PV-DB2-OPERATION      PIC  X(40)  VALUE SPACE.           02090001
021000                                                                  02100001
021100 01  PV-TAX-RT-DETAIL-REC.                                        02110001
021200     05  PV-TRD-SORT-ORDER       PIC X(1) VALUE '2'.              02120001
021300     05  PV-TRD-STR-NBR          PIC 9(4).                        02130001
021400     05  FILLER                  PIC X(1) VALUE ','.              02140001
021500     05  PV-TRD-ST-CDE           PIC X(02).                       02150001
021600     05  FILLER                  PIC X(1) VALUE ','.              02160001
021700     05  PV-TRD-ZIP-CDE          PIC X(05).                       02170001
021800     05  FILLER                  PIC X(1) VALUE ','.              02180001
021900     05  PV-TRD-GEO-CDE          PIC X(02).                       02190001
022000     05  FILLER                  PIC X(1) VALUE ','.              02200001
022100     05  PV-TRD-PROD-TAX-CODE    PIC X(01).                       02210001
022200     05  FILLER                  PIC X(1) VALUE ','.              02220001
022300     05  PV-TRD-PRODUCT-CODE     PIC X(05).                       02230001
022400     05  FILLER                  PIC X(1) VALUE ','.              02240001
022500     05  PV-TRD-TAX-RT-PCT       PIC -9.9(05).                    02250001
022600     05  FILLER                  PIC X(1) VALUE ','.              02260001
022700     05  PV-TRD-TM-TAX-RT-PCT    PIC -9.9(05).                    02270001
022800     05  FILLER                  PIC X(1) VALUE ','.              02280001
022900     05  PV-TRD-TAX-RT-DIFF-PCT  PIC -9.9(05).                    02290001
023000     05  FILLER                  PIC X(1) VALUE ','.              02300001
023100     05  PV-TRD-PROCESS-DTE      PIC X(10).                       02310001
023200     05  FILLER                  PIC X(1) VALUE ','.              02320001
023300     05  PV-ECOMMERCE-ORD-NBR    PIC X(10).                       02330001
023400     05  FILLER                  PIC X(1) VALUE ','.              02340001
023500     05  PV-TRD-PARTITION        PIC 9(04).                       02350001
023600     05  FILLER                  PIC X(1) VALUE ','.              02360001
023700     05  PV-TRD-RGST-ID          PIC 9(4).                        02370001
023800     05  FILLER                  PIC X(1) VALUE ','.              02380001
023900     05  PV-TRD-TRN-NBR          PIC 9(4).                        02390001
024000     05  FILLER                  PIC X(1) VALUE ','.              02400001
024100     05  PV-TRD-START-TIME       PIC X(08).                       02410001
024200     05  FILLER                  PIC X(1) VALUE ','.              02420001
024300     05  PV-TRD-SLS-CORR-SEQ-NBR PIC 9(04).                       02430001
024400     05  FILLER                  PIC X(1) VALUE ','.              02440001
024500     05  PV-TRD-LNE-ITM-SEQ-NBR  PIC 9(04).                       02450001
024600     05  FILLER                  PIC X(1) VALUE ','.              02460001
024700     05  PV-TRAN-INDICATOR-CDE   PIC X(03).                       02470001
024800     05  FILLER                  PIC X(1) VALUE ','.              02480001
024900     05  PV-TRD-SKU-NBR          PIC X(08).                       02490001
025000     05  FILLER                  PIC X(1) VALUE ','.              02500001
025100     05  PV-TRD-SBJCT-TO-TX-AMT  PIC -----9.99.                   02510001
025200     05  FILLER                  PIC X(03) VALUE SPACE.           02520001
025300                                                                  02530001
025400 01  PV-TAX-RT-DETAIL-REC-HDR.                                    02540001
025500     05  FILLER                  PIC X(6) VALUE '1STORE'.         02550001
025600     05  FILLER                  PIC X(1) VALUE ','.              02560001
025700     05  FILLER                  PIC X(5) VALUE 'STATE'.          02570001
025800     05  FILLER                  PIC X(1) VALUE ','.              02580001
025900     05  FILLER                  PIC X(3) VALUE 'ZIP'.            02590001
026000     05  FILLER                  PIC X(1) VALUE ','.              02600001
026100     05  FILLER                  PIC X(2) VALUE 'GC'.             02610001
026200     05  FILLER                  PIC X(1) VALUE ','.              02620001
026300     05  FILLER                  PIC X(10) VALUE 'PRD TX CDE'.    02630001
026400     05  FILLER                  PIC X(1) VALUE ','.              02640001
026500     05  FILLER                  PIC X(7) VALUE 'PRD CDE'.        02650001
026600     05  FILLER                  PIC X(1) VALUE ','.              02660001
026700     05  FILLER                  PIC X(9) VALUE 'STR TX RT'.      02670001
026800     05  FILLER                  PIC X(1) VALUE ','.              02680001
026900     05  FILLER                  PIC X(8) VALUE 'TM TX RT'.       02690001
027000     05  FILLER                  PIC X(1) VALUE ','.              02700001
027100     05  FILLER                  PIC X(8) VALUE 'VARIANCE'.       02710001
027200     05  FILLER                  PIC X(1) VALUE ','.              02720001
027300     05  FILLER                  PIC X(8) VALUE 'SLS DTE'.        02730001
027400     05  FILLER                  PIC X(1) VALUE ','.              02740001
027500     05  FILLER                  PIC X(7) VALUE 'ORD NBR'.        02750001
027600     05  FILLER                  PIC X(1) VALUE ','.              02760001
027700     05  FILLER                  PIC X(5) VALUE 'PARTN'.          02770001
027800     05  FILLER                  PIC X(1) VALUE ','.              02780001
027900     05  FILLER                  PIC X(4) VALUE 'RGST'.           02790001
028000     05  FILLER                  PIC X(1) VALUE ','.              02800001
028100     05  FILLER                  PIC X(4) VALUE 'TRAN'.           02810001
028200     05  FILLER                  PIC X(1) VALUE ','.              02820001
028300     05  FILLER                  PIC X(6) VALUE 'SLS TM'.         02830001
028400     05  FILLER                  PIC X(1) VALUE ','.              02840001
028500     05  FILLER                  PIC X(4) VALUE 'CORR'.           02850001
028600     05  FILLER                  PIC X(1) VALUE ','.              02860001
028700     05  FILLER                  PIC X(6) VALUE 'LN NBR'.         02870001
028800     05  FILLER                  PIC X(1) VALUE ','.              02880001
028900     05  FILLER                  PIC X(7) VALUE 'TRN TYP'.        02890001
029000     05  FILLER                  PIC X(1) VALUE ','.              02900001
029100     05  FILLER                  PIC X(7) VALUE 'SKU NBR'.        02910001
029200     05  FILLER                  PIC X(1) VALUE ','.              02920001
029300     05  FILLER                  PIC X(11) VALUE 'TAXABLE AMT'.   02930001
029400     05  FILLER                  PIC X(1) VALUE SPACE.            02940001
029500                                                                  02950001
029600 01  PV-TAX-RT-STATS-REC.                                         02960001
029700     05  PV-STS-SORT-ORDER       PIC X(1) VALUE '2'.              02970001
029800     05  PV-STS-STR-NBR          PIC 9(4).                        02980001
029900     05  FILLER                  PIC X(1) VALUE ','.              02990001
030000     05  PV-STS-TOT-BPS-TRANS    PIC 9(07).                       03000001
030100     05  FILLER                  PIC X(1) VALUE ','.              03010001
030200     05  PV-STS-TOT-BPS-ERRORS   PIC 9(07).                       03020001
030300     05  FILLER                  PIC X(1) VALUE ','.              03030001
030400     05  PV-STS-TOT-POC-TRANS    PIC 9(07).                       03040001
030500     05  FILLER                  PIC X(1) VALUE ','.              03050001
030600     05  PV-STS-TOT-POC-ERRORS   PIC 9(07).                       03060001
030700     05  FILLER                  PIC X(1) VALUE ','.              03070001
030800     05  PV-STS-TOT-BOS-TRANS    PIC 9(07).                       03080001
030900     05  FILLER                  PIC X(1) VALUE ','.              03090001
031000     05  PV-STS-TOT-BOS-ERRORS   PIC 9(07).                       03100001
031100                                                                  03110001
031200 01  PV-TAX-RT-STATS-REC-HDR.                                     03120001
031300     05  FILLER                  PIC X(6) VALUE '1STORE'.         03130001
031400     05  FILLER                  PIC X(1) VALUE ','.              03140001
031500     05  FILLER                  PIC X(7) VALUE 'BPS TRN'.        03150001
031600     05  FILLER                  PIC X(1) VALUE ','.              03160001
031700     05  FILLER                  PIC X(7) VALUE 'BPS ERR'.        03170001
031800     05  FILLER                  PIC X(1) VALUE ','.              03180001
031900     05  FILLER                  PIC X(7) VALUE 'POC TRN'.        03190001
032000     05  FILLER                  PIC X(1) VALUE ','.              03200001
032100     05  FILLER                  PIC X(7) VALUE 'POC ERR'.        03210001
032200     05  FILLER                  PIC X(1) VALUE ','.              03220001
032300     05  FILLER                  PIC X(7) VALUE 'BOS TRN'.        03230001
032400     05  FILLER                  PIC X(1) VALUE ','.              03240001
032500     05  FILLER                  PIC X(7) VALUE 'BOS ERR'.        03250001
032600                                                                  03260001
032700 01  PV-TAX-RT-EMAIL-REC.                                         03270001
032800     05  PV-EMAIL-STR-NBR        PIC 9(4).                        03280001
032900     05  FILLER                  PIC X(6) VALUE SPACE.            03290001
033000     05  PV-EMAIL-TOT-BPS-TRANS  PIC 999999.                      03300001
033100     05  FILLER                  PIC X(2) VALUE SPACE.            03310001
033200     05  FILLER                  PIC X(2) VALUE '**'.             03320001
033300     05  FILLER                  PIC X(2) VALUE SPACE.            03330001
033400     05  PV-EMAIL-TOT-BPS-ERRORS PIC 999999.                      03340001
033500     05  FILLER                  PIC X(2) VALUE SPACE.            03350001
033600     05  FILLER                  PIC X(2) VALUE '**'.             03360001
033700     05  FILLER                  PIC X(2) VALUE SPACE.            03370001
033800     05  PV-EMAIL-TOT-POC-TRANS  PIC 999999.                      03380001
033900     05  FILLER                  PIC X(2) VALUE SPACE.            03390001
034000     05  FILLER                  PIC X(2) VALUE '**'.             03400001
034100     05  FILLER                  PIC X(2) VALUE SPACE.            03410001
034200     05  PV-EMAIL-TOT-POC-ERRORS PIC 999999.                      03420001
034300     05  FILLER                  PIC X(2) VALUE SPACE.            03430001
034400     05  FILLER                  PIC X(2) VALUE '**'.             03440001
034500     05  FILLER                  PIC X(2) VALUE SPACE.            03450001
034600     05  PV-EMAIL-TOT-BOS-TRANS  PIC 999999.                      03460001
034700     05  FILLER                  PIC X(2) VALUE SPACE.            03470001
034800     05  FILLER                  PIC X(2) VALUE '**'.             03480001
034900     05  FILLER                  PIC X(2) VALUE SPACE.            03490001
035000     05  PV-EMAIL-TOT-BOS-ERRORS PIC 999999.                      03500001
035100                                                                  03510001
035200 01  PV-TAX-RT-EMAIL-REC-HDR1    PIC X(01) VALUE SPACE.           03520001
035300                                                                  03530001
035400 01  PV-TAX-RT-EMAIL-REC-HDR2.                                    03540001
035500     05  FILLER                  PIC X(31) VALUE                  03550001
035600               'TAX RATE EXCEPTIONS - SLS DTE: '.                 03560001
035700     05  PV-EMAIL-SLS-DATE-MM          PIC  9(02) VALUE ZERO.     03570001
035800     05  FILLER                        PIC  X(01) VALUE '-'.      03580001
035900     05  PV-EMAIL-SLS-DATE-DD          PIC  9(02) VALUE ZERO.     03590001
036000     05  FILLER                        PIC  X(01) VALUE '-'.      03600001
036100     05  PV-EMAIL-SLS-DATE-CCYY        PIC  9(04) VALUE ZERO.     03610001
036200     05  FILLER                        PIC X(14) VALUE            03620001
036300                                       '  RUN DTE/TM: '.          03630001
036400     05  PV-EMAIL-CURR-DATE-MM         PIC  9(02) VALUE ZERO.     03640001
036500     05  FILLER                        PIC  X(01) VALUE '-'.      03650001
036600     05  PV-EMAIL-CURR-DATE-DD         PIC  9(02) VALUE ZERO.     03660001
036700     05  FILLER                        PIC  X(01) VALUE '-'.      03670001
036800     05  PV-EMAIL-CURR-DATE-CCYY       PIC  9(04) VALUE ZERO.     03680001
036900     05  FILLER                        PIC  X(01) VALUE '-'.      03690001
037000     05  PV-EMAIL-CURR-TIME-HH         PIC  9(02) VALUE ZERO.     03700001
037100     05  FILLER                        PIC  X(01) VALUE ':'.      03710001
037200     05  PV-EMAIL-CURR-TIME-MM         PIC  9(02) VALUE ZERO.     03720001
037300                                                                  03730001
037400 01  PV-TAX-RT-EMAIL-REC-HDR3.                                    03740001
037500     05  FILLER                  PIC X(5)  VALUE 'STORE'.         03750001
037600     05  FILLER                  PIC X(5)  VALUE SPACE.           03760001
037700     05  FILLER                  PIC X(5)  VALUE 'BOPUS'.         03770001
037800     05  FILLER                  PIC X(7)  VALUE SPACE.           03780001
037900     05  FILLER                  PIC X(5)  VALUE 'BOPUS'.         03790001
038000     05  FILLER                  PIC X(7)  VALUE SPACE.           03800001
038100     05  FILLER                  PIC X(3)  VALUE 'POC'.           03810001
038200     05  FILLER                  PIC X(10) VALUE SPACE.           03820001
038300     05  FILLER                  PIC X(3)  VALUE 'POC'.           03830001
038400     05  FILLER                  PIC X(10) VALUE SPACE.           03840001
038500     05  FILLER                  PIC X(3)  VALUE 'BOS'.           03850001
038600     05  FILLER                  PIC X(9)  VALUE SPACE.           03860001
038700     05  FILLER                  PIC X(3)  VALUE 'BOS'.           03870001
038800     05  FILLER                  PIC X(4)  VALUE SPACE.           03880001
038900                                                                  03890001
039000 01  PV-TAX-RT-EMAIL-REC-HDR4.                                    03900001
039100     05  FILLER                  PIC X(3) VALUE 'NBR'.            03910001
039200     05  FILLER                  PIC X(7) VALUE SPACE.            03920001
039300     05  FILLER                  PIC X(5) VALUE 'TRANS'.          03930001
039400     05  FILLER                  PIC X(7) VALUE SPACE.            03940001
039500     05  FILLER                  PIC X(6) VALUE 'ERRORS'.         03950001
039600     05  FILLER                  PIC X(6) VALUE SPACE.            03960001
039700     05  FILLER                  PIC X(5) VALUE 'TRANS'.          03970001
039800     05  FILLER                  PIC X(7) VALUE SPACE.            03980001
039900     05  FILLER                  PIC X(6) VALUE 'ERRORS'.         03990001
040000     05  FILLER                  PIC X(7) VALUE SPACE.            04000001
040100     05  FILLER                  PIC X(5) VALUE 'TRANS'.          04010001
040200     05  FILLER                  PIC X(6) VALUE SPACE.            04020001
040300     05  FILLER                  PIC X(6) VALUE 'ERRORS'.         04030001
040400     05  FILLER                  PIC X(10) VALUE SPACE.           04040001
040500                                                                  04050001
040600                                                                  04060001
040700 01  PA-PROGRAM-ACCUMULATORS.                                     04070001
040800     05  PA-EPLIS-FEE-RT        PIC S9(1)V9(5) COMP-3 VALUE ZERO. 04080001
040900                                                                  04090001
041000 01  PV-DATE-AND-TIME-FIELDS.                                     04100001
041100     05  PV-CURR-DATE-CCYYMMDD.                                   04110001
041200         10  PV-CURR-DATE-CCYY       PIC  9(04).                  04120001
041300         10  PV-CURR-DATE-MM         PIC  9(02).                  04130001
041400         10  PV-CURR-DATE-DD         PIC  9(02).                  04140001
041500     05  PV-CURR-TIME.                                            04150001
041600         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    04160001
041700         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    04170001
041800         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    04180001
041900******************************************************************04190001
042000* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    04200001
042100******************************************************************04210001
042200 01  CC-CONTROL-CARD.                                             04220001
042300     05  CC-CONTROL-CARD-DISPLAY.                                 04230001
042400         10  CC-CONTROL-NAME     PIC X(14)    VALUE               04240001
042500                                              'P.O.S. DATE = '.   04250001
042600         10  CC-POS-DATE-MMDDYY.                                  04260001
042700             15  CC-POS-DATE-MM  PIC 9(2)     VALUE ZERO.         04270001
042800             15  CC-POS-DATE-DD  PIC 9(2)     VALUE ZERO.         04280001
042900             15  CC-POS-DATE-YY  PIC 9(2)     VALUE ZERO.         04290001
043000     05  FILLER                  PIC X(60)    VALUE SPACE.        04300001
043100                                                                  04310001
043200 01  PV-SUBSCRIPTS                   COMP.                        04320001
043300     05  PV-TCNT-IDX                 PIC S9(5)   VALUE ZERO.      04330001
043400     05  PV-TCNT-IDX-MAX             PIC S9(5)   VALUE +1500.     04340001
043500                                                                  04350001
043600 01  EC-STORE-TRAN-CNT-TBL.                                       04360001
043700     05  EC-STORE-TRAN-CNT-TBL-ENTRIES OCCURS 1500 TIMES.         04370001
043800         10  EC-TCNT-STR-NBR        PIC S9(4) COMP.               04380001
043900         10  EC-TCNT-BPS-CNTR       PIC 9(9)  COMP-3 VALUE ZERO.  04390001
044000         10  EC-TCNT-BPS-E-CNTR     PIC 9(9)  COMP-3 VALUE ZERO.  04400001
044100         10  EC-TCNT-POC-CNTR       PIC 9(9)  COMP-3 VALUE ZERO.  04410001
044200         10  EC-TCNT-POC-E-CNTR     PIC 9(9)  COMP-3 VALUE ZERO.  04420001
044300         10  EC-TCNT-BOS-CNTR       PIC 9(9)  COMP-3 VALUE ZERO.  04430001
044400         10  EC-TCNT-BOS-E-CNTR     PIC 9(9)  COMP-3 VALUE ZERO.  04440001
044500         10  EC-TCNT-OTH-CNTR       PIC 9(9)  COMP-3 VALUE ZERO.  04450001
044600         10  EC-TCNT-OTH-E-CNTR     PIC 9(9)  COMP-3 VALUE ZERO.  04460001
044700                                                                  04470001
044800******************************************************************04480001
044900* RECORD LAYOUT FOR STANDARD REPORT HEADINGS.                    *04490001
045000******************************************************************04500001
045100     COPY DPWS132O.                                               04510001
045200                                                                  04520001
045300******************************************************************04530001
045400*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             04540001
045500******************************************************************04550001
045600     COPY DPWS500.                                                04560001
045700                                                                  04570001
045800******************************************************************04580001
045900*  DB2 ERROR ROUTINE (DSNTIAR) RECORD LAYOUT                      04590001
046000******************************************************************04600001
046100     COPY DPWS004.                                                04610001
046200                                                                  04620001
046300*---------------------------------------------------------        04630001
046400*  DB2 TABLE DB2PDBA.TTXRTLO - TAX RATES FOR STORE TAX GROUPS     04640001
046500*---------------------------------------------------------        04650001
046600     EXEC SQL                                                     04660001
046700           INCLUDE TTXRTLO                                        04670001
046800     END-EXEC.                                                    04680001
046900                                                                  04690001
047000******************************************************************04700001
047100*    DB2 TABLE TXT_PRD                                            04710001
047200******************************************************************04720001
047300     EXEC SQL                                                     04730001
047400         INCLUDE TXT00007                                         04740001
047500     END-EXEC.                                                    04750001
047600*                                                                 04760001
047700******************************************************************04770001
047800*    DB2 TABLE TXT_PRD_EXC                                        04780001
047900******************************************************************04790001
048000     EXEC SQL                                                     04800001
048100         INCLUDE TXT00008                                         04810001
048200     END-EXEC.                                                    04820001
048300*                                                                 04830001
048400                                                                  04840001
048500******************************************************************04850001
048600*  COSA TRANSACTION TABLE                                         04860001
048700******************************************************************04870001
048800     EXEC SQL                                                     04880001
048900         INCLUDE TEPTRN                                           04890001
049000     END-EXEC.                                                    04900001
049100                                                                  04910001
049200******************************************************************04920001
049300*  COSA ITEM TABLE                                                04930001
049400******************************************************************04940001
049500     EXEC SQL                                                     04950001
049600         INCLUDE TEPITM                                           04960001
049700     END-EXEC.                                                    04970001
049800                                                                  04980001
049900******************************************************************04990001
050000*  COSA LINE ITEM DISCOUNT TABLE                                  05000001
050100******************************************************************05010001
050200     EXEC SQL                                                     05020001
050300         INCLUDE TEPLID                                           05030001
050400     END-EXEC.                                                    05040001
050500                                                                  05050001
050600******************************************************************05060001
050700*  COSA EMPLOYEE DISCOUNT TABLE                                   05070001
050800******************************************************************05080001
050900     EXEC SQL                                                     05090001
051000         INCLUDE TEPEID                                           05100001
051100     END-EXEC.                                                    05110001
051200                                                                  05120001
051300******************************************************************05130001
051400*  COSA SERVICE FEE TABLE                                         05140001
051500******************************************************************05150001
051600     EXEC SQL                                                     05160001
051700         INCLUDE TEPLIS                                           05170001
051800     END-EXEC.                                                    05180001
051900                                                                  05190001
052000******************************************************************05200001
052100*  COSA ORDER TABLE                                               05210001
052200******************************************************************05220001
052300     EXEC SQL                                                     05230001
052400         INCLUDE TEPORD                                           05240001
052500     END-EXEC.                                                    05250001
052600                                                                  05260001
052700******************************************************************05270001
052800* PARTITION TABLE                                                 05280001
052900******************************************************************05290001
053000     EXEC SQL                                                     05300001
053100         INCLUDE TEPPART                                          05310001
053200     END-EXEC.                                                    05320001
053300                                                                  05330001
053400******************************************************************05340001
053500* XS DOMAIN LOCATION TABLE.  XST_LOC                              05350001
053600******************************************************************05360001
053700     EXEC SQL                                                     05370001
053800         INCLUDE XST00001                                         05380001
053900     END-EXEC.                                                    05390001
054000                                                                  05400001
054100******************************************************************05410001
054200* XS LOCATION ATTRIBUTE TABLE   XST_LOC_ATTR                      05420001
054300******************************************************************05430001
054400     EXEC SQL                                                     05440001
054500         INCLUDE XST00025                                         05450001
054600     END-EXEC.                                                    05460001
054700******************************************************************05470001
054800*    XS SKU TABLE                                                *05480001
054900******************************************************************05490001
055000     EXEC SQL                                                     05500001
055100         INCLUDE XST00010                                         05510001
055200     END-EXEC.                                                    05520001
055300                                                                  05530001
055400                                                                  05540001
055500******************************************************************05550001
055600*  DB2 AREA FOR COMMUNICATIONS                                    05560001
055700******************************************************************05570001
055800     EXEC SQL                                                     05580001
055900         INCLUDE SQLCA                                            05590001
056000     END-EXEC.                                                    05600001
056100                                                                  05610001
056200******************************************************************05620001
056300*  CURSOR TO RETRIEVE SPECIAL SERVICE FEES FOR THE TRANSACTION.   05630001
056400******************************************************************05640001
056500     EXEC SQL                                                     05650001
056600       DECLARE FEES-CSR CURSOR FOR                                05660001
056700         SELECT LIS.SOR_FEE_ID                                    05670001
056800               ,LIS.FEE_RT                                        05680001
056900           FROM TEPLIS LIS                                        05690001
057000          WHERE LIS.PARTN_NBR = :EPTRN-PARTN-NBR                  05700001
057100            AND LIS.STR_NBR = :EPITM-STR-NBR                      05710001
057200            AND LIS.RGST_ID = :EPITM-RGST-ID                      05720001
057300            AND LIS.TRN_NBR = :EPITM-TRN-NBR                      05730001
057400            AND LIS.STRT_TM = :EPITM-STRT-TM                      05740001
057500            AND LIS.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR    05750001
057600            AND LIS.LNE_ITM_SEQ_NBR = :EPITM-LNE-ITM-SEQ-NBR      05760001
057700        WITH UR                                                   05770001
057800     END-EXEC.                                                    05780001
057900                                                                  05790001
058000******************************************************************05800001
058100*  CURSOR TO RETRIEVE LINE ITEM DISCOUNTS FOR THE TRANSACTION.    05810001
058200******************************************************************05820001
058300     EXEC SQL                                                     05830001
058400       DECLARE LID-CSR CURSOR FOR                                 05840001
058500         SELECT LID.LID_TYP_CDE                                   05850001
058600               ,LID.LID_AMT                                       05860001
058700               ,LID.LID_PCT                                       05870001
058800           FROM TEPLID LID                                        05880001
058900          WHERE LID.PARTN_NBR = :EPTRN-PARTN-NBR                  05890001
059000            AND LID.STR_NBR = :EPITM-STR-NBR                      05900001
059100            AND LID.RGST_ID = :EPITM-RGST-ID                      05910001
059200            AND LID.TRN_NBR = :EPITM-TRN-NBR                      05920001
059300            AND LID.STRT_TM = :EPITM-STRT-TM                      05930001
059400            AND LID.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR    05940001
059500            AND LID.LNE_ITM_SEQ_NBR = :EPITM-LNE-ITM-SEQ-NBR      05950001
059600            AND LID.LID_TYP_CDE IN ('D','E','I','P','Q','R','S')  05960001
059700        WITH UR                                                   05970001
059800     END-EXEC.                                                    05980001
059900                                                                  05990001
060000******************************************************************06000001
060100*  CURSOR TO GET ALL POC AND BOPUS TRANSACTIONS                   06010001
060200******************************************************************06020001
060300     EXEC SQL                                                     06030001
060400         DECLARE POC-BPS-TRN-CSR CURSOR FOR                       06040001
060500             SELECT PRT.PARTN_NBR                                 06050001
060600                   ,TRN.TRN_DTE                                   06060001
060700                   ,TRN.POS_CPBL_LVL_NBR                          06070001
060800                   ,ITM.STR_NBR                                   06080001
060900                   ,ITM.RGST_ID                                   06090001
061000                   ,ITM.TRN_NBR                                   06100001
061100                   ,ITM.STRT_TM                                   06110001
061200                   ,ITM.SLS_CORR_SEQ_NBR                          06120001
061300                   ,ITM.LNE_ITM_SEQ_NBR                           06130001
061400                   ,LOC.GEO_CDE                                   06140001
061500                   ,ITM.SLD_QTY                                   06150001
061600                   ,ITM.CUST_CHRGD_AMT                            06160001
061700                   ,ITM.SBJCT_TO_TX_AMT                           06170001
061800                   ,ITM.TX_RT_PCT                                 06180001
061900                   ,ITM.TX_AMT                                    06190001
062000                   ,ITM.SKU_NBR                                   06200001
062100                   ,ITM.TXBL_IND                                  06210001
062200              ,COALESCE(ITM.TX_PRD_CDE_DESC, SKU.TX_PRD_CDE_DESC) 06220001
062300                   ,LOC2.ST_CDE                                   06230001
062400                   ,LOC2.ZIP_10_CDE                               06240001
062500                   ,TRN.OMNI_CHNL_FFLMT_TYP_CDE                   06250001
062600                   ,COALESCE(ORD.ORD_NBR, ' ')                    06260001
062700             FROM TEPPART PRT                                     06270001
062800                 ,TEPITM ITM                                      06280001
062900                 ,XST_SKU SKU                                     06290001
063000                 ,XST_LOC_ATTR LOC                                06300001
063100                 ,XST_LOC LOC2                                    06310001
063200                 ,TEPTRN TRN LEFT JOIN                            06320001
063300                  TEPORD ORD                                      06330001
063400              ON  TRN.PARTN_NBR = ORD.PARTN_NBR                   06340001
063500              AND TRN.STR_NBR   = ORD.STR_NBR                     06350001
063600              AND TRN.RGST_ID   = ORD.RGST_ID                     06360001
063700              AND TRN.TRN_NBR   = ORD.TRN_NBR                     06370001
063800              AND TRN.STRT_TM   = ORD.STRT_TM                     06380001
063900              AND TRN.SLS_CORR_SEQ_NBR = ORD.SLS_CORR_SEQ_NBR     06390001
064000            WHERE PRT.SLS_DTE = :PV-POS-SALES-DATE                06400001
064100              AND TRN.PARTN_NBR = PRT.PARTN_NBR                   06410001
064200              AND ITM.PARTN_NBR = TRN.PARTN_NBR                   06420001
064300              AND ITM.STR_NBR   = TRN.STR_NBR                     06430001
064400***           AND TRN.STR_NBR   = 574                             06440001
064500              AND ITM.RGST_ID   = TRN.RGST_ID                     06450001
064600              AND ITM.TRN_NBR   = TRN.TRN_NBR                     06460001
064700              AND ITM.STRT_TM   = TRN.STRT_TM                     06470001
064800              AND ITM.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR     06480001
064900              AND TRN.STR_NBR = LOC.LOC_NBR                       06490001
065000              AND TRN.STR_NBR = LOC2.LOC_NBR                      06500001
065100***           AND LOC2.ST_CDE = 'MA'                              06510001
065200              AND ((COALESCE(ORD.ORD_NBR, ' ') > ' '              06520001
065300              AND TRN.OMNI_CHNL_FFLMT_TYP_CDE IN ('BPS','BOS'))   06530001
065400              OR (COALESCE(ORD.ORD_NBR, ' ')  = ' '               06540001
065500              AND COALESCE(TRN.OMNI_CHNL_FFLMT_TYP_CDE, ' ') = ' '06550001
065600              AND TRN.POS_CPBL_LVL_NBR = 200))                    06560001
065700              AND TRN_TYP_CDE IN (01,02)                          06570001
065800              AND TRN.VOID_ABRT_CDE = 'N'                         06580001
065900              AND TRN.TRN_STAT_CDE = 'Z'                          06590001
066000              AND ITM.LIV_RSLU_CDE = '+'                          06600001
066100              AND ITM.SBJCT_TO_TX_AMT > 0                         06610001
066200              AND NOT EXISTS (SELECT TX_EXMPT_ID                  06620001
066300                 FROM TEPTAX TAXE                                 06630001
066400               WHERE TAXE.PARTN_NBR        = TRN.PARTN_NBR        06640001
066500                 AND TAXE.STR_NBR          = TRN.STR_NBR          06650001
066600                 AND TAXE.RGST_ID          = TRN.RGST_ID          06660001
066700                 AND TAXE.TRN_NBR          = TRN.TRN_NBR          06670001
066800                 AND TAXE.STRT_TM          = TRN.STRT_TM          06680001
066900                 AND TAXE.SLS_CORR_SEQ_NBR = TRN.SLS_CORR_SEQ_NBR)06690001
067000              AND ITM.SKU_NBR = SKU.SKU_NBR                       06700001
067100            ORDER BY ITM.STR_NBR                                  06710001
067200                    ,SKU.TX_PRD_CDE_DESC                          06720001
067300                    ,ITM.SKU_NBR                                  06730001
067400             WITH UR                                              06740001
067500     END-EXEC.                                                    06750001
067600                                                                  06760001
067700******************************************************************06770001
067800 PROCEDURE DIVISION.                                              06780001
067900******************************************************************06790001
068000 0000-MAINLINE.                                                   06800001
068100                                                                  06810001
068200     PERFORM 1000-INITIALIZE.                                     06820001
068300     PERFORM 7320-FETCH-POC-BPS-CURSOR.                           06830001
068400     INITIALIZE EC-STORE-TRAN-CNT-TBL.                            06840001
068500                                                                  06850001
068600     PERFORM 2000-PROCESS-COSA-TRANS.                             06860001
068700                                                                  06870001
068800     PERFORM 9000-EOJ-ROUTINE.                                    06880001
068900     GOBACK.                                                      06890001
069000                                                                  06900001
069100******************************************************************06910001
069200* OPEN ALL FILES.                                                *06920001
069300* GET THE DATE CONTROL CARD.                                     *06930001
069400* CONVERT THE DATE ON THE CONTROL CARD TO DB2 DATE FORMAT.       *06940001
069500* GET INTERNAL UPC FOR SPECIAL SERVICE ITEMS.                    *06950001
069600* FIND THE COSA PARTITION NUMBER FOR THE PROCESSING DATE.        *06960001
069700******************************************************************06970001
069800 1000-INITIALIZE.                                                 06980001
069900     PERFORM 1100-OPEN-FILES.                                     06990001
070000                                                                  07000001
070100                                                                  07010001
070200     PERFORM 1200-READ-DATE-CC-CARD.                              07020001
070300                                                                  07030001
070400     PERFORM 1300-CONVERT-INPUT-DATE.                             07040001
070500     PERFORM 1400-FORMAT-REPORT-HEADINGS.                         07050001
070600                                                                  07060001
070700     MOVE  DPG55-DB2-ISO-DATE-FMT TO PV-POS-SALES-DATE.           07070001
070800                                                                  07080001
070900     PERFORM 7310-OPEN-POC-BPS-CURSOR.                            07090001
071000                                                                  07100001
071100     WRITE TAX-RATE-DETAIL-REC FROM                               07110001
071200           PV-TAX-RT-DETAIL-REC-HDR                               07120001
071300     END-WRITE.                                                   07130001
071400     WRITE TAX-RATE-STATS-REC FROM                                07140001
071500           PV-TAX-RT-STATS-REC-HDR                                07150001
071600     END-WRITE.                                                   07160001
071700                                                                  07170001
071800     WRITE TAX-RATE-EMAIL-REC FROM                                07180001
071900           PV-TAX-RT-EMAIL-REC-HDR1                               07190001
072000     END-WRITE.                                                   07200001
072100     WRITE TAX-RATE-EMAIL-REC FROM                                07210001
072200           PV-TAX-RT-EMAIL-REC-HDR2                               07220001
072300     END-WRITE.                                                   07230001
072400     WRITE TAX-RATE-EMAIL-REC FROM                                07240001
072500           PV-TAX-RT-EMAIL-REC-HDR3                               07250001
072600     END-WRITE.                                                   07260001
072700     WRITE TAX-RATE-EMAIL-REC FROM                                07270001
072800           PV-TAX-RT-EMAIL-REC-HDR4                               07280001
072900     END-WRITE.                                                   07290001
073000                                                                  07300001
073100                                                                  07310001
073200******************************************************************07320001
073300* OPEN THE CONTROL CARD FILE AS INPUT.                           *07330001
073400* OPEN THE EXTRACT FILE AS OUTPUT.                               *07340001
073500* OPEN THE STORE GEO CODE FILE AS INPUT AND CHECK THE VSAM RETURN*07350001
073600* CODE.                                                          *07360001
073700******************************************************************07370001
073800 1100-OPEN-FILES.                                                 07380001
073900     OPEN INPUT  DATE-CNTL-FILE                                   07390001
074000          OUTPUT TAX-RATE-DETAIL                                  07400001
074100                 TAX-RATE-STATS                                   07410001
074200                 TAX-RATE-EMAIL.                                  07420001
074300                                                                  07430001
074400******************************************************************07440001
074500* READ THE DATE CONTROL CARD AND CLOSE THE FILE.                 *07450001
074600* IF THE DATE CONTROL CARD WAS NOT FOUND, ABEND THE PROGRAM.     *07460001
074700******************************************************************07470001
074800 1200-READ-DATE-CC-CARD.                                          07480001
074900                                                                  07490001
075000     READ DATE-CNTL-FILE INTO CC-CONTROL-CARD                     07500001
075100        AT END                                                    07510001
075200           SET PS-END-OF-DATE-CNTL-FILE TO TRUE.                  07520001
075300                                                                  07530001
075400     DISPLAY 'TXKUT101 CONTROL CARD: ' CC-CONTROL-CARD.           07540001
075500                                                                  07550001
075600     CLOSE DATE-CNTL-FILE.                                        07560001
075700                                                                  07570001
075800     IF PS-END-OF-DATE-CNTL-FILE                                  07580001
075900        DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME            07590001
076000        DISPLAY 'DATE CONTROL CARD EMPTY'                         07600001
076100        CALL 'ILBOABN0' USING AC-ABEND-CODE                       07610001
076200     END-IF.                                                      07620001
076300                                                                  07630001
076400******************************************************************07640001
076500*     CALL KOHLS CALENDAR ROUTINE:                                07650001
076600*         PASS: CONTROL CARD POS DATE (MMDDYY FORMAT).            07660001
076700*       RETURN: ACTUAL CALENDAR DB2 ISO DATE (CCYY-MM-DD FORMAT). 07670001
076800******************************************************************07680001
076900 1300-CONVERT-INPUT-DATE.                                         07690001
077000                                                                  07700001
077100     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              07710001
077200                                                                  07720001
077300     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   07730001
077400     SET  DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                   07740001
077500     SET  DPG52-LK-DTE-GREG            TO TRUE.                   07750001
077600     MOVE CC-POS-DATE-MMDDYY           TO DPG52-LK-DATE-INPUT.    07760001
077700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    07770001
077800                                             DPG54 DPG55 DPG56.   07780001
077900     IF DPG54-SEVERE-ERROR                                        07790001
078000            DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME        07800001
078100            DISPLAY 'DATE CONTROL CARD INVALID'                   07810001
078200            SET ABEND-4003-INVALID-CNTL-CARD TO TRUE              07820001
078300            CALL 'ILBOABN0' USING AC-ABEND-CODE                   07830001
078400     END-IF.                                                      07840001
078500                                                                  07850001
078600     DISPLAY 'EXECUTION DATE USED = ' DPG55-DB2-ISO-DATE-FMT.     07860001
078700                                                                  07870001
078800 1400-FORMAT-REPORT-HEADINGS.                                     07880001
078900                                                                  07890001
079000     MOVE FUNCTION CURRENT-DATE (1:8) TO PV-CURR-DATE-CCYYMMDD.   07900001
079100     ACCEPT PV-CURR-TIME            FROM TIME.                    07910001
079200     MOVE DPG55-DB2-ISO-DATE-MO TO PV-EMAIL-SLS-DATE-MM.          07920001
079300     MOVE DPG55-DB2-ISO-DATE-DY TO PV-EMAIL-SLS-DATE-DD.          07930001
079400     MOVE DPG55-DB2-ISO-DATE-YR TO PV-EMAIL-SLS-DATE-CCYY.        07940001
079500     MOVE PV-CURR-DATE-MM       TO PV-EMAIL-CURR-DATE-MM.         07950001
079600     MOVE PV-CURR-DATE-DD       TO PV-EMAIL-CURR-DATE-DD.         07960001
079700     MOVE PV-CURR-DATE-CCYY     TO PV-EMAIL-CURR-DATE-CCYY.       07970001
079800     MOVE PV-CURR-TIME-HH       TO PV-EMAIL-CURR-TIME-HH.         07980001
079900     MOVE PV-CURR-TIME-MM       TO PV-EMAIL-CURR-TIME-MM.         07990001
080000                                                                  08000001
080100 2000-PROCESS-COSA-TRANS.                                         08010001
080200     PERFORM UNTIL PS-END-OF-POC-BPS-CURSOR                       08020001
080300         IF EPITM-STR-NBR = EC-TCNT-STR-NBR(PV-TCNT-IDX)          08030001
080400             EVALUATE TRUE                                        08040001
080500                  WHEN PS-SFS                                     08050001
080600                      ADD 1 TO EC-TCNT-OTH-CNTR(PV-TCNT-IDX)      08060001
080700                  WHEN PS-BPS                                     08070001
080800                      ADD 1 TO EC-TCNT-BPS-CNTR(PV-TCNT-IDX)      08080001
080900                  WHEN PS-BOS                                     08090001
081000                      ADD 1 TO EC-TCNT-BOS-CNTR(PV-TCNT-IDX)      08100001
081100                  WHEN PS-POC                                     08110001
081200                      ADD 1 TO EC-TCNT-POC-CNTR(PV-TCNT-IDX)      08120001
081300                  WHEN PS-OTH                                     08130001
081400                      ADD 1 TO EC-TCNT-OTH-CNTR(PV-TCNT-IDX)      08140001
081500             END-EVALUATE                                         08150001
081600         ELSE                                                     08160001
081700             PERFORM 2005-ADD-TO-TRAN-COUNT                       08170001
081800         END-IF                                                   08180001
081900                                                                  08190001
082000         MOVE EPTRN-TRN-DTE TO PV-PROCESSING-DATE                 08200001
082100                                                                  08210001
082200         IF XST00001-ST-CDE = PV-PREV-XST00001-ST-CDE AND         08220001
082300            EPITM-SKU-NBR = PV-PREV-EPITM-SKU-NBR                 08230001
082400            CONTINUE                                              08240001
082500         ELSE                                                     08250001
082600             PERFORM 7010-GET-PRODUCT-CODE                        08260001
082700             MOVE XST00001-ST-CDE TO PV-PREV-XST00001-ST-CDE      08270001
082800             MOVE EPITM-SKU-NBR   TO PV-PREV-EPITM-SKU-NBR        08280001
082900         END-IF                                                   08290001
083000                                                                  08300001
083100         IF TXT00008-PRD-TX-CDE > SPACES                          08310001
083200             IF PV-PROCESSING-DATE  = PV-PREV-PROCESSING-DATE AND 08320001
083300                EPITM-STR-NBR       = PV-PREV-EPITM-STR-NBR   AND 08330001
083400                TXT00008-PRD-TX-CDE = PV-PREV-TXT00008-PRD-TX-CDE 08340001
083500                 CONTINUE                                         08350001
083600             ELSE                                                 08360001
083700                 PERFORM 7000-GET-TM-TAX-RATE                     08370001
083800                 IF XST00001-ST-CDE = 'MA' AND                    08380001
083900                    TXT00008-PRD-TX-CDE = '2' AND                 08390001
084000                    TXRTLO-THRS-DOL-AMT = PC-MA-TRESHOLD-TXMAINT  08400001
084100                     MOVE PC-MA-TRESHOLD-TAXWARE                  08410001
084200                                       TO TXRTLO-THRS-DOL-AMT     08420001
084300                 END-IF                                           08430001
084400                 MOVE PV-PROCESSING-DATE                          08440001
084500                                       TO PV-PREV-PROCESSING-DATE 08450001
084600                 MOVE EPITM-STR-NBR    TO PV-PREV-EPITM-STR-NBR   08460001
084700                 MOVE TXT00008-PRD-TX-CDE                         08470001
084800                                   TO PV-PREV-TXT00008-PRD-TX-CDE 08480001
084900             END-IF                                               08490001
085000                                                                  08500001
085100             IF PS-TXM-RATE-FOUND-NO                              08510001
085200                 IF TXT00008-PRD-TX-CDE = 0                       08520001
085300                     SET PS-TXM-RATE-FOUND-YES TO TRUE            08530001
085400                     MOVE 0 TO PV-TEMP-TX-RT-PCT                  08540001
085500                     MOVE 0 TO PV-TEMP-BLW-THRS-TX-RT-PCT         08550001
085600                 END-IF                                           08560001
085700             ELSE                                                 08570001
085800                 IF TXT00008-PRD-TX-CDE = 0                       08580001
085900                     MOVE 0 TO PV-TEMP-TX-RT-PCT                  08590001
086000                     MOVE 0 TO PV-TEMP-BLW-THRS-TX-RT-PCT         08600001
086100                 ELSE                                             08610001
086200                     IF (TXRTLO-TX-TYP-CDE = 'TH'                 08620001
086300                        AND TXRTLO-ABV-THRS-FTX-IND = 'F')        08630001
086400                         MOVE PV-FULL-TAX-RATE                    08640001
086500                                        TO PV-TEMP-TX-RT-PCT      08650001
086600                         MOVE TXRTLO-BLW-THRS-TX-RT-PCT           08660001
086700                                    TO PV-TEMP-BLW-THRS-TX-RT-PCT 08670001
086800                     ELSE                                         08680001
086900                         MOVE TXRTLO-TX-RT-PCT                    08690001
087000                                        TO PV-TEMP-TX-RT-PCT      08700001
087100                         MOVE TXRTLO-BLW-THRS-TX-RT-PCT           08710001
087200                                    TO PV-TEMP-BLW-THRS-TX-RT-PCT 08720001
087300                     END-IF                                       08730001
087400                 END-IF                                           08740001
087500             END-IF                                               08750001
087600                                                                  08760001
087700             IF PS-TXM-RATE-FOUND-YES                             08770001
087800                 PERFORM 2006-CHECK-FOR-THREASHOLD                08780001
087900                 IF EPITM-TX-RT-PCT = PV-TAX-MAINT-RT-PCT         08790001
088000                     CONTINUE                                     08800001
088100                 ELSE                                             08810001
088200                     PERFORM 2010-CHECK-TAX-RATE                  08820001
088300                 END-IF                                           08830001
088400             ELSE                                                 08840001
088500                 MOVE EPITM-STR-NBR   TO PV-DSPLY-STR-NBR         08850001
088600                 MOVE EPTRN-PARTN-NBR TO PV-DSPLY-PARTITION       08860001
088700                 MOVE EPITM-RGST-ID   TO PV-DSPLY-RGST-ID         08870001
088800                 MOVE EPITM-TRN-NBR   TO PV-DSPLY-TRN-NBR         08880001
088900                 DISPLAY 'TM TAX RATE NOT FOUND: '                08890001
089000                          PV-DSPLY-STR-NBR ' '                    08900001
089100                          XST00001-ST-CDE                         08910001
089200                          XST00001-ZIP-10-CDE ' '                 08920001
089300                          EPTRN-TRN-DTE ' '                       08930001
089400                          PV-DSPLY-PARTITION ' '                  08940001
089500                          PV-DSPLY-RGST-ID ' '                    08950001
089600                          PV-DSPLY-TRN-NBR ' '                    08960001
089700                          TXT00007-PRD-TX-CDE ' '                 08970001
089800                          TXT00008-PRD-TX-CDE ' '                 08980001
089900                          EPITM-SKU-NBR ' '                       08990001
090000                          EPITM-TX-PRD-CDE-DESC-TEXT              09000001
090100             END-IF                                               09010001
090200         ELSE                                                     09020001
090300             DISPLAY 'PRODUCT CODE NOT FOUND: '                   09030001
090400                      EPITM-STR-NBR ' '                           09040001
090500                      XST00001-ST-CDE                             09050001
090600                      XST00001-ZIP-10-CDE ' '                     09060001
090700                      EPTRN-TRN-DTE ' '                           09070001
090800                      PV-DSPLY-PARTITION ' '                      09080001
090900                      PV-DSPLY-RGST-ID ' '                        09090001
091000                      PV-DSPLY-TRN-NBR ' '                        09100001
091100                      EPITM-SKU-NBR ' '                           09110001
091200                      EPITM-TX-PRD-CDE-DESC-TEXT                  09120001
091300         END-IF                                                   09130001
091400         PERFORM 7320-FETCH-POC-BPS-CURSOR                        09140001
091500     END-PERFORM.                                                 09150001
091600                                                                  09160001
091700     PERFORM 4000-WRITE-BPS-POC-STATS-FILE.                       09170001
091800                                                                  09180001
091900 2005-ADD-TO-TRAN-COUNT.                                          09190001
092000     SET PS-TCNT-STORE-FOUND-NO TO TRUE.                          09200001
092100     MOVE +1 TO PV-TCNT-IDX.                                      09210001
092200     PERFORM UNTIL PV-TCNT-IDX = PV-TCNT-IDX-MAX                  09220001
092300                OR PS-TCNT-STORE-FOUND-YES                        09230001
092400        IF EPITM-STR-NBR = EC-TCNT-STR-NBR(PV-TCNT-IDX)           09240001
092500            SET PS-TCNT-STORE-FOUND-YES TO TRUE                   09250001
092600        ELSE                                                      09260001
092700            IF EC-TCNT-STR-NBR(PV-TCNT-IDX) = ZEROS               09270001
092800                MOVE EPITM-STR-NBR TO EC-TCNT-STR-NBR(PV-TCNT-IDX)09280001
092900                SET PS-TCNT-STORE-FOUND-YES TO TRUE               09290001
093000            ELSE                                                  09300001
093100                CONTINUE                                          09310001
093200            END-IF                                                09320001
093300        END-IF                                                    09330001
093400        IF PS-TCNT-STORE-FOUND-YES                                09340001
093500            EVALUATE TRUE                                         09350001
093600                WHEN PS-SFS                                       09360001
093700                    ADD 1 TO EC-TCNT-OTH-CNTR(PV-TCNT-IDX)        09370001
093800                WHEN PS-BPS                                       09380001
093900                    ADD 1 TO EC-TCNT-BPS-CNTR(PV-TCNT-IDX)        09390001
094000                WHEN PS-BOS                                       09400001
094100                    ADD 1 TO EC-TCNT-BOS-CNTR(PV-TCNT-IDX)        09410001
094200                WHEN PS-POC                                       09420001
094300                    ADD 1 TO EC-TCNT-POC-CNTR(PV-TCNT-IDX)        09430001
094400                WHEN PS-OTH                                       09440001
094500                    ADD 1 TO EC-TCNT-OTH-CNTR(PV-TCNT-IDX)        09450001
094600            END-EVALUATE                                          09460001
094700        END-IF                                                    09470001
094800        ADD +1 TO PV-TCNT-IDX                                     09480001
094900                                                                  09490001
095000        IF PV-TCNT-IDX > PV-TCNT-IDX-MAX                          09500001
095100           DISPLAY '******************************************'   09510001
095200           DISPLAY '** ABEND EC-STORE-TRAN-CNT-TBL OVERFLOW **'   09520001
095300           DISPLAY '** PROGRAM = TXKUT101                   **'   09530001
095400           DISPLAY '** STORE NBR = ' EPITM-STR-NBR         '**'   09540001
095500           DISPLAY '******************************************'   09550001
095600           DISPLAY DPG54-ERROR-MESSAGE                            09560001
095700           SET ABEND-4004-TABLE-OVERFLOW TO TRUE                  09570001
095800           PERFORM 9910-ABEND                                     09580001
095900        END-IF                                                    09590001
096000     END-PERFORM.                                                 09600001
096100                                                                  09610001
096200 2006-CHECK-FOR-THREASHOLD.                                       09620001
096300     IF TXRTLO-THRS-DOL-AMT > 0                                   09630001
096400         EVALUATE TRUE                                            09640001
096500            WHEN XST00001-ST-CDE = 'NY'                           09650001
096600                IF EPITM-SBJCT-TO-TX-AMT / EPITM-SLD-QTY          09660001
096700                         < TXRTLO-THRS-DOL-AMT                    09670001
096800                    MOVE PV-TEMP-BLW-THRS-TX-RT-PCT TO            09680001
096900                                          PV-TAX-MAINT-RT-PCT     09690001
097000                ELSE                                              09700001
097100                    MOVE PV-TEMP-TX-RT-PCT TO PV-TAX-MAINT-RT-PCT 09710001
097200                END-IF                                            09720001
097300            WHEN XST00001-ST-CDE = 'MA'                           09730001
097400                PERFORM 2030-ACTUAL-PRICE-PAID                    09740001
097500                IF PV-ACTUAL-PRICE-CHRGD / EPITM-SLD-QTY          09750001
097600                         <= TXRTLO-THRS-DOL-AMT                   09760001
097700                    MOVE PV-TEMP-BLW-THRS-TX-RT-PCT TO            09770001
097800                                          PV-TAX-MAINT-RT-PCT     09780001
097900                ELSE                                              09790001
098000                    MOVE PV-TEMP-TX-RT-PCT TO PV-TAX-MAINT-RT-PCT 09800001
098100                END-IF                                            09810001
098200            WHEN OTHER                                            09820001
098300                IF EPITM-SBJCT-TO-TX-AMT / EPITM-SLD-QTY          09830001
098400                         <= TXRTLO-THRS-DOL-AMT                   09840001
098500                    MOVE PV-TEMP-BLW-THRS-TX-RT-PCT TO            09850001
098600                                          PV-TAX-MAINT-RT-PCT     09860001
098700                ELSE                                              09870001
098800                    MOVE PV-TEMP-TX-RT-PCT TO PV-TAX-MAINT-RT-PCT 09880001
098900                END-IF                                            09890001
099000         END-EVALUATE                                             09900001
099100     ELSE                                                         09910001
099200         MOVE PV-TEMP-TX-RT-PCT TO PV-TAX-MAINT-RT-PCT            09920001
099300     END-IF.                                                      09930001
099400                                                                  09940001
099500 2010-CHECK-TAX-RATE.                                             09950001
099600* IF TAX RATE IS ZERO CHECK IF TAX EXEMPT OR IF TAX AMT           09960001
099700* GREATER THAT ZERO. IF SO SKIP THE TRANSACTION                   09970001
099800* SEE TRAN: 2017-01-09 STORE=1018,REG=91,TRAN=9201                09980001
099900* EXAMPLE WHERE TRANSACTION IS DEEPLY DISCOUNTED AND ONE          09990001
100000* ITEM ENDED UP WITH A ZERO RATE ON TEPITM.                       10000001
100100* 01-07-18 ALSO CHECK IF (SUBJECT TO TAX AMT * EXPECTED RATE)     10010001
100200* IS LESS THAN .01 FOR TAX. IF IT IS, SKIP THE TRANSACTION.       10020001
100300                                                                  10030001
100400     COMPUTE PV-TAX-AMT =                                         10040001
100500             EPITM-SBJCT-TO-TX-AMT * PV-TAX-MAINT-RT-PCT          10050001
100600                                                                  10060001
100700     IF EPITM-TX-RT-PCT = 0 AND                                   10070001
100800        (EPITM-TXBL-IND = 'N' AND                                 10080001
100900         EPITM-TX-AMT > 0 AND                                     10090001
101000         PV-TAX-AMT < .01)                                        10100001
101100         CONTINUE                                                 10110001
101200     ELSE                                                         10120001
101300         PERFORM 2020-CHECK-FOR-FEES                              10130001
101400     END-IF.                                                      10140001
101500                                                                  10150001
101600 2020-CHECK-FOR-FEES.                                             10160001
101700     MOVE ZEROS TO PA-EPLIS-FEE-RT                                10170001
101800                   PV-BLENDED-TAX-RT-PCT.                         10180001
101900     PERFORM 7210-OPEN-FEES-CURSOR.                               10190001
102000     SET PS-NOT-END-OF-FEES-CURSOR TO TRUE.                       10200001
102100     PERFORM 7220-FETCH-FEES-CURSOR.                              10210001
102200     PERFORM UNTIL PS-END-OF-FEES-CURSOR                          10220001
102300         COMPUTE PA-EPLIS-FEE-RT =                                10230001
102400                 PA-EPLIS-FEE-RT + EPLIS-FEE-RT                   10240001
102500         PERFORM 7220-FETCH-FEES-CURSOR                           10250001
102600     END-PERFORM.                                                 10260001
102700     PERFORM 7230-CLOSE-FEES-CURSOR.                              10270001
102800                                                                  10280001
102900     MOVE PV-TAX-MAINT-RT-PCT TO PV-TM-TAX-RT-PCT.                10290001
103000************************************************************      10300001
103100* IF A FEE IS PRESENT THE RATE NEEDS TO BE RECALCULATED           10310001
103200* WITH THE FEE TO GET THE BLENDED RATE. FORMULA FOR GETTING       10320001
103300* THE BLENDED RATE IS (RATE+FEE)+(RATE*FEE) = BLENDED RATE        10330001
103400************************************************************      10340001
103500     IF PA-EPLIS-FEE-RT > 0                                       10350001
103600         COMPUTE PV-BLENDED-TAX-RT-PCT =                          10360001
103700            (EPITM-TX-RT-PCT + PA-EPLIS-FEE-RT) +                 10370001
103800            (EPITM-TX-RT-PCT * PA-EPLIS-FEE-RT)                   10380001
103900         MOVE PV-BLENDED-TAX-RT-PCT TO PV-TAX-RT-PCT              10390001
104000         COMPUTE PV-TAX-RT-DIFF-PCT =                             10400001
104100             PV-BLENDED-TAX-RT-PCT - PV-TAX-MAINT-RT-PCT          10410001
104200     ELSE                                                         10420001
104300         IF EPITM-STR-NBR = 1568                                  10430001
104400***** IF THIS IS A TRANSACTION FOR STORE 1568 DO THE FOLLOWING    10440001
104500***** SPECIAL CALCULATION TO GET THE BLENDED RATE. THE FEE IS     10450001
104600***** NOT STORED IN COSA SO IT IS HARDCODED HERE.                 10460001
104700             MOVE PC-STORE-1568-FEE TO PA-EPLIS-FEE-RT            10470001
104800             COMPUTE PV-BLENDED-TAX-RT-PCT =                      10480001
104900                ((EPITM-TX-RT-PCT  - PC-STORE-1568-FEE) +         10490001
105000                  PA-EPLIS-FEE-RT) +                              10500001
105100                ((EPITM-TX-RT-PCT  - PC-STORE-1568-FEE) *         10510001
105200                  PA-EPLIS-FEE-RT)                                10520001
105300             MOVE PV-BLENDED-TAX-RT-PCT TO PV-TAX-RT-PCT          10530001
105400             COMPUTE PV-TAX-RT-DIFF-PCT =                         10540001
105500                 PV-BLENDED-TAX-RT-PCT - PV-TAX-MAINT-RT-PCT      10550001
105600***** EXCLUDED VARIANCES LESS THAN 0.003, MOSAIC RECALCUALTES     10560001
105700***** THE RATE FOR SOME OF THE FEE LOCATIONS WHICH CAUSES         10570001
105800***** SLIGHT VARIANCES SO IT IS NOT ALWAYS POSSIBLE TO GET AN     10580001
105900***** EXACT MATCH WITH TAX MAINTENANCE.                           10590001
106000             IF PV-TAX-RT-DIFF-PCT < .003                         10600001
106100                 MOVE 0 TO PV-TAX-RT-DIFF-PCT                     10610001
106200             END-IF                                               10620001
106300         ELSE                                                     10630001
106400             MOVE EPITM-TX-RT-PCT       TO PV-TAX-RT-PCT          10640001
106500             COMPUTE PV-TAX-RT-DIFF-PCT =                         10650001
106600                 EPITM-TX-RT-PCT  - PV-TAX-MAINT-RT-PCT           10660001
106700         END-IF                                                   10670001
106800     END-IF.                                                      10680001
106900     IF PV-TAX-RT-DIFF-PCT < 0                                    10690001
107000         COMPUTE PV-TAX-RT-DIFF-PCT =                             10700001
107100           PV-TAX-RT-DIFF-PCT * -01                               10710001
107200     END-IF.                                                      10720001
107300                                                                  10730001
107400***** EXCLUDED VARIANCES LESS THAN OR EQUAL TO 0.00010            10740001
107500***** UNTIL TRUNCATION ISSUE IS FIXED BY ATG                      10750001
107600***** >>>>>>>>                                  <<<<<<<           10760001
107700***** >>>>>>>>                                  <<<<<<<           10770001
107800     IF PV-TAX-RT-DIFF-PCT > 0.00010                              10780001
107900******   PERFORM 2700-SRCH-FOR-PROD-CD                            10790001
108000         PERFORM 2800-WRITE-TAX-RT-DTL-REC                        10800001
108100     END-IF.                                                      10810001
108200***** >>>>>>>>                                  <<<<<<<           10820001
108300***** >>>>>>>>                                  <<<<<<<           10830001
108400                                                                  10840001
108500 2030-ACTUAL-PRICE-PAID.                                          10850001
108600     MOVE ZEROS TO PV-ACTUAL-PRICE-CHRGD                          10860001
108700                   PV-PCT-AMT-OFF                                 10870001
108800                   PV-EPLID-LID-AMT                               10880001
108900                   PV-EPLID-LID-PCT                               10890001
109000                   PV-EPLID-PRORATED-AMT.                         10900001
109100                                                                  10910001
109200     PERFORM 7110-OPEN-LID-CURSOR.                                10920001
109300     SET PS-NOT-END-OF-LID-CURSOR TO TRUE.                        10930001
109400     PERFORM 7120-FETCH-LID-CURSOR.                               10940001
109500                                                                  10950001
109600     PERFORM UNTIL PS-END-OF-LID-CURSOR                           10960001
109700         EVALUATE TRUE                                            10970001
109800             WHEN EPLID-LID-TYP-CDE = "D" OR "E"                  10980001
109900                 MOVE EPLID-LID-AMT TO PV-EPLID-LID-AMT           10990001
110000             WHEN EPLID-LID-TYP-CDE = "I" OR "P" OR "Q" OR "S"    11000001
110100                 MOVE EPLID-LID-PCT TO PV-EPLID-LID-PCT           11010001
110200             WHEN EPLID-LID-TYP-CDE = "R"                         11020001
110300                 ADD  EPLID-LID-AMT TO PV-EPLID-PRORATED-AMT      11030001
110400         END-EVALUATE                                             11040001
110500         PERFORM 7120-FETCH-LID-CURSOR                            11050001
110600     END-PERFORM.                                                 11060001
110700                                                                  11070001
110800     PERFORM 7130-CLOSE-LID-CURSOR.                               11080001
110900                                                                  11090001
111000     PERFORM 7030-GET-EMPLOYEE-DISCOUNT.                          11100001
111100                                                                  11110001
111200     COMPUTE PV-PCT-AMT-OFF =                                     11120001
111300     (EPITM-CUST-CHRGD-AMT + PV-EPLID-LID-AMT) * PV-EPLID-LID-PCT.11130001
111400     COMPUTE PV-ACTUAL-PRICE-CHRGD =                              11140001
111500        EPITM-CUST-CHRGD-AMT + PV-EPLID-LID-AMT -                 11150001
111600        PV-PCT-AMT-OFF + PV-EPLID-PRORATED-AMT +                  11160001
111700        EPEID-EMP-DISC-AMT.                                       11170001
111800                                                                  11180001
111900 2800-WRITE-TAX-RT-DTL-REC.                                       11190001
112000     MOVE EPITM-STR-NBR          TO PV-TRD-STR-NBR.               11200001
112100     MOVE XST00001-ST-CDE        TO PV-TRD-ST-CDE.                11210001
112200     MOVE XST00001-ZIP-10-CDE    TO PV-TRD-ZIP-CDE.               11220001
112300     MOVE XST00025-GEO-CDE       TO PV-TRD-GEO-CDE.               11230001
112400     MOVE TXT00008-PRD-TX-CDE    TO PV-TRD-PROD-TAX-CODE.         11240001
112500     MOVE EPITM-TX-PRD-CDE-DESC-TEXT TO PV-TRD-PRODUCT-CODE.      11250001
112600     MOVE PV-TAX-RT-PCT          TO PV-TRD-TAX-RT-PCT.            11260001
112700     MOVE PV-TM-TAX-RT-PCT       TO PV-TRD-TM-TAX-RT-PCT.         11270001
112800     MOVE PV-TAX-RT-DIFF-PCT     TO PV-TRD-TAX-RT-DIFF-PCT.       11280001
112900     MOVE EPTRN-TRN-DTE          TO PV-TRD-PROCESS-DTE.           11290001
113000     MOVE EPORD-ORD-NBR-TEXT     TO PV-ECOMMERCE-ORD-NBR.         11300001
113100     MOVE EPTRN-PARTN-NBR        TO PV-TRD-PARTITION.             11310001
113200     MOVE EPITM-RGST-ID          TO PV-TRD-RGST-ID.               11320001
113300     MOVE EPITM-TRN-NBR          TO PV-TRD-TRN-NBR.               11330001
113400     MOVE EPITM-STRT-TM          TO PV-TRD-START-TIME.            11340001
113500     MOVE EPITM-SLS-CORR-SEQ-NBR TO PV-TRD-SLS-CORR-SEQ-NBR.      11350001
113600     MOVE EPITM-LNE-ITM-SEQ-NBR  TO PV-TRD-LNE-ITM-SEQ-NBR.       11360001
113700     MOVE EPITM-SBJCT-TO-TX-AMT  TO PV-TRD-SBJCT-TO-TX-AMT.       11370001
113800     EVALUATE TRUE                                                11380001
113900         WHEN PS-SFS                                              11390001
114000             MOVE 'SFS'              TO PV-TRAN-INDICATOR-CDE     11400001
114100         WHEN PS-BPS                                              11410001
114200             MOVE 'BPS'              TO PV-TRAN-INDICATOR-CDE     11420001
114300         WHEN PS-BOS                                              11430001
114400             MOVE 'BOS'              TO PV-TRAN-INDICATOR-CDE     11440001
114500         WHEN PS-POC                                              11450001
114600***          IF EPTRN-POS-CPBL-LVL-NBR = 200                      11460001
114700                 MOVE 'POC'          TO PV-TRAN-INDICATOR-CDE     11470001
114800***          END-IF                                               11480001
114900     END-EVALUATE.                                                11490001
115000     MOVE EPITM-SKU-NBR          TO PV-TRD-SKU-NBR.               11500001
115100                                                                  11510001
115200     WRITE TAX-RATE-DETAIL-REC FROM                               11520001
115300           PV-TAX-RT-DETAIL-REC                                   11530001
115400     END-WRITE.                                                   11540001
115500                                                                  11550001
115600     IF PV-BLENDED-TAX-RT-PCT NOT ZERO                            11560001
115700         DISPLAY 'BLENDED RATE(R+F)+(R*F): '                      11570001
115800                  PV-TRD-STR-NBR ' '                              11580001
115900                  PV-TRD-PROD-TAX-CODE ' '                        11590001
116000                  PV-TRD-PRODUCT-CODE ' '                         11600001
116100                  EPITM-TX-RT-PCT  ' '                            11610001
116200                  PA-EPLIS-FEE-RT ' '                             11620001
116300                  PV-TRD-TAX-RT-PCT ' '                           11630001
116400     END-IF.                                                      11640001
116500                                                                  11650001
116600     SET PS-TCNT-STORE-FOUND-NO TO TRUE.                          11660001
116700     MOVE +1 TO PV-TCNT-IDX.                                      11670001
116800     PERFORM UNTIL PV-TCNT-IDX = PV-TCNT-IDX-MAX                  11680001
116900                OR PS-TCNT-STORE-FOUND-YES                        11690001
117000        IF EPITM-STR-NBR = EC-TCNT-STR-NBR(PV-TCNT-IDX)           11700001
117100            SET PS-TCNT-STORE-FOUND-YES TO TRUE                   11710001
117200        ELSE                                                      11720001
117300            IF EC-TCNT-STR-NBR(PV-TCNT-IDX) = ZEROS               11730001
117400                MOVE EPITM-STR-NBR TO EC-TCNT-STR-NBR(PV-TCNT-IDX)11740001
117500                SET PS-TCNT-STORE-FOUND-YES TO TRUE               11750001
117600            ELSE                                                  11760001
117700                CONTINUE                                          11770001
117800            END-IF                                                11780001
117900        END-IF                                                    11790001
118000        IF PS-TCNT-STORE-FOUND-YES                                11800001
118100            EVALUATE TRUE                                         11810001
118200                WHEN PS-SFS                                       11820001
118300                    ADD 1 TO EC-TCNT-OTH-E-CNTR(PV-TCNT-IDX)      11830001
118400                WHEN PS-BPS                                       11840001
118500                    ADD 1 TO EC-TCNT-BPS-E-CNTR(PV-TCNT-IDX)      11850001
118600                WHEN PS-BOS                                       11860001
118700                    ADD 1 TO EC-TCNT-BOS-E-CNTR(PV-TCNT-IDX)      11870001
118800                WHEN PS-POC                                       11880001
118900                    IF EPTRN-POS-CPBL-LVL-NBR = 200               11890001
119000                        ADD 1 TO EC-TCNT-POC-E-CNTR(PV-TCNT-IDX)  11900001
119100                    END-IF                                        11910001
119200            END-EVALUATE                                          11920001
119300        END-IF                                                    11930001
119400        ADD +1 TO PV-TCNT-IDX                                     11940001
119500     END-PERFORM.                                                 11950001
119600                                                                  11960001
119700 4000-WRITE-BPS-POC-STATS-FILE.                                   11970001
119800     SET PS-TCNT-STORE-FOUND-NO TO TRUE                           11980001
119900     MOVE +1 TO PV-TCNT-IDX.                                      11990001
120000     PERFORM UNTIL PV-TCNT-IDX = PV-TCNT-IDX-MAX                  12000001
120100                OR EC-TCNT-STR-NBR(PV-TCNT-IDX) = ZEROS           12010001
120200         MOVE EC-TCNT-STR-NBR(PV-TCNT-IDX)                        12020001
120300                                        TO PV-STS-STR-NBR         12030001
120400                                           PV-EMAIL-STR-NBR       12040001
120500         MOVE EC-TCNT-BPS-CNTR(PV-TCNT-IDX)                       12050001
120600                                        TO PV-STS-TOT-BPS-TRANS   12060001
120700                                           PV-EMAIL-TOT-BPS-TRANS 12070001
120800         MOVE EC-TCNT-BPS-E-CNTR(PV-TCNT-IDX)                     12080001
120900                                        TO PV-STS-TOT-BPS-ERRORS  12090001
121000                                           PV-EMAIL-TOT-BPS-ERRORS12100001
121100         MOVE EC-TCNT-POC-CNTR(PV-TCNT-IDX)                       12110001
121200                                        TO PV-STS-TOT-POC-TRANS   12120001
121300                                           PV-EMAIL-TOT-POC-TRANS 12130001
121400         MOVE EC-TCNT-POC-E-CNTR(PV-TCNT-IDX)                     12140001
121500                                        TO PV-STS-TOT-POC-ERRORS  12150001
121600                                           PV-EMAIL-TOT-POC-ERRORS12160001
121700         MOVE EC-TCNT-BOS-CNTR(PV-TCNT-IDX)                       12170001
121800                                        TO PV-STS-TOT-BOS-TRANS   12180001
121900                                           PV-EMAIL-TOT-BOS-TRANS 12190001
122000         MOVE EC-TCNT-BOS-E-CNTR(PV-TCNT-IDX)                     12200001
122100                                        TO PV-STS-TOT-BOS-ERRORS  12210001
122200                                           PV-EMAIL-TOT-BOS-ERRORS12220001
122300         WRITE TAX-RATE-STATS-REC FROM                            12230001
122400               PV-TAX-RT-STATS-REC                                12240001
122500         END-WRITE                                                12250001
122600                                                                  12260001
122700         IF EC-TCNT-BPS-E-CNTR(PV-TCNT-IDX) > 0 OR                12270001
122800            EC-TCNT-POC-E-CNTR(PV-TCNT-IDX) > 0 OR                12280001
122900            EC-TCNT-BOS-E-CNTR(PV-TCNT-IDX) > 0                   12290001
123000            PERFORM 5000-WRITE-BPS-POC-EMAIL-FILE                 12300001
123100         END-IF                                                   12310001
123200         ADD +1 TO PV-TCNT-IDX                                    12320001
123300     END-PERFORM.                                                 12330001
123400                                                                  12340001
123500 5000-WRITE-BPS-POC-EMAIL-FILE.                                   12350001
123600     WRITE TAX-RATE-EMAIL-REC FROM                                12360001
123700           PV-TAX-RT-EMAIL-REC                                    12370001
123800     END-WRITE.                                                   12380001
123900                                                                  12390001
124000 7000-GET-TM-TAX-RATE.                                            12400001
124100     SET PS-TXM-RATE-FOUND-NO    TO TRUE.                         12410001
124200     SET PS-TXM-FT-RATE-FOUND-NO TO TRUE.                         12420001
124300                                                                  12430001
124400     PERFORM 7020-GET-TM-FT-TAX-RATE.                             12440001
124500                                                                  12450001
124600     EXEC SQL                                                     12460001
124700       SELECT TXM.TX_TYP_CDE                                      12470001
124800             ,TXM.ABV_THRS_FTX_IND                                12480001
124900             ,TXM.TX_RT_PCT                                       12490001
125000             ,TXM.THRS_DOL_AMT                                    12500001
125100             ,TXM.BLW_THRS_TX_RT_PCT                              12510001
125200            INTO :TXRTLO-TX-TYP-CDE                               12520001
125300                ,:TXRTLO-ABV-THRS-FTX-IND                         12530001
125400                ,:TXRTLO-TX-RT-PCT                                12540001
125500                ,:TXRTLO-THRS-DOL-AMT                             12550001
125600                ,:TXRTLO-BLW-THRS-TX-RT-PCT                       12560001
125700            FROM TTXRTLO TXM                                      12570001
125800      WHERE TXM.TX_GP_ITM_ID = :TXT00008-PRD-TX-CDE               12580001
125900        AND TXM.EFF_BEG_DTE = (SELECT MAX(R.EFF_BEG_DTE)          12590001
126000                               FROM TTXRTLO R                     12600001
126100                              WHERE R.STR_NBR = TXM.STR_NBR       12610001
126200                                AND R.TX_GP_ITM_ID =              12620001
126300                                            TXM.TX_GP_ITM_ID      12630001
126400                                AND R.TX_TYP_CDE =                12640001
126500                                            TXM.TX_TYP_CDE        12650001
126600                                AND R.EFF_BEG_DTE <=              12660001
126700                                  :PV-PROCESSING-DATE)            12670001
126800        AND TXM.STR_NBR = :EPITM-STR-NBR                          12680001
126900       WITH UR                                                    12690001
127000     END-EXEC.                                                    12700001
127100                                                                  12710001
127200     EVALUATE SQLCODE                                             12720001
127300         WHEN ZERO                                                12730001
127400             SET PS-TXM-RATE-FOUND-YES TO TRUE                    12740001
127500         WHEN +100                                                12750001
127600             CONTINUE                                             12760001
127700         WHEN OTHER                                               12770001
127800             MOVE '7000-GET-TM-TAX-RATE' TO PV-PARAGRAPH-NAME     12780001
127900             MOVE 'ERROR SELECT FROM TTXRTLO'                     12790001
128000                                            TO PV-DB2-OPERATION   12800001
128100             PERFORM 9200-SQL-ABEND                               12810001
128200     END-EVALUATE.                                                12820001
128300                                                                  12830001
128400                                                                  12840001
128500 7010-GET-PRODUCT-CODE.                                           12850001
128600     MOVE SPACES TO PV-PRODUCT-CODE                               12860001
128700                    TXT00007-PRD-TX-CDE                           12870001
128800                    TXT00008-PRD-TX-CDE.                          12880001
128900                                                                  12890001
129000     EXEC SQL                                                     12900001
129100       SELECT SKU.TX_PRD_CDE_DESC                                 12910001
129200             ,PRD.PRD_TX_CDE                                      12920001
129300             ,COALESCE(PRDE.PRD_TX_CDE, PRD.PRD_TX_CDE)           12930001
129400       INTO :PV-PRODUCT-CODE                                      12940001
129500           ,:TXT00007-PRD-TX-CDE                                  12950001
129600           ,:TXT00008-PRD-TX-CDE                                  12960001
129700       FROM XST_SKU SKU                                           12970001
129800           ,TXT_PRD PRD                                           12980001
129900            LEFT OUTER JOIN                                       12990001
130000            TXT_PRD_EXC PRDE                                      13000001
130100         ON PRD.TX_PRD_NBR = PRDE.TX_PRD_NBR                      13010001
130200        AND PRDE.ST_PROV_CDE = :XST00001-ST-CDE                   13020001
130300        AND  EFF_BEG_DTE <= :PV-PROCESSING-DATE                   13030001
130400        AND  EFF_END_DTE >= :PV-PROCESSING-DATE                   13040001
130500      WHERE SKU.SKU_NBR = :EPITM-SKU-NBR                          13050001
130600        AND INTEGER(SKU.TX_PRD_CDE_DESC) = PRD.TX_PRD_NBR         13060001
130700        AND SKU.TX_PRD_CDE_DESC > ' '                             13070001
130800        WITH UR                                                   13080001
130900     END-EXEC.                                                    13090001
131000                                                                  13100001
131100     EVALUATE SQLCODE                                             13110001
131200         WHEN ZERO                                                13120001
131300             CONTINUE                                             13130001
131400         WHEN +100                                                13140001
131500             MOVE SPACES TO PV-PRODUCT-CODE                       13150001
131600         WHEN OTHER                                               13160001
131700             DISPLAY 'XST00001-ST-CDE    ' XST00001-ST-CDE        13170001
131800             DISPLAY 'PV-PROCESSING-DATE ' PV-PROCESSING-DATE     13180001
131900             DISPLAY 'EPITM-SKU-NBR      ' EPITM-SKU-NBR          13190001
132000             MOVE '7000-GET-PRODUCT-CODE' TO PV-PARAGRAPH-NAME    13200001
132100             MOVE 'ERROR SELECT FROM XST_SKU TABLE'               13210001
132200                                            TO PV-DB2-OPERATION   13220001
132300             PERFORM 9200-SQL-ABEND                               13230001
132400     END-EVALUATE.                                                13240001
132500                                                                  13250001
132600 7020-GET-TM-FT-TAX-RATE.                                         13260001
132700     EXEC SQL                                                     13270001
132800         SELECT T.TX_RT_PCT                                       13280001
132900           INTO :TXRTLO-TX-RT-PCT                                 13290001
133000             FROM XST_LOC A,                                      13300001
133100                  TTXRTLO T,                                      13310001
133200                  TSTATE S                                        13320001
133300            WHERE A.LOC_NBR = T.STR_NBR                           13330001
133400              AND S.STATE_CODE = A.ST_CDE                         13340001
133500              AND A.LOC_TYP_CDE = 'DS'                            13350001
133600              AND T.EFF_BEG_DTE =                                 13360001
133700                        (SELECT MAX(R.EFF_BEG_DTE)                13370001
133800                           FROM TTXRTLO R                         13380001
133900                          WHERE R.STR_NBR = T.STR_NBR             13390001
134000                            AND R.TX_GP_ITM_ID =                  13400001
134100                                        T.TX_GP_ITM_ID            13410001
134200                            AND R.TX_TYP_CDE =                    13420001
134300                                        T.TX_TYP_CDE              13430001
134400                            AND R.EFF_BEG_DTE <=                  13440001
134500                                     :PV-PROCESSING-DATE)         13450001
134600              AND T.TX_TYP_CDE = 'FT'                             13460001
134700              AND A.LOC_NBR = :EPITM-STR-NBR                      13470001
134800           WITH UR                                                13480001
134900     END-EXEC.                                                    13490001
135000                                                                  13500001
135100     EVALUATE SQLCODE                                             13510001
135200         WHEN ZERO                                                13520001
135300             SET PS-TXM-FT-RATE-FOUND-YES TO TRUE                 13530001
135400             MOVE TXRTLO-TX-RT-PCT TO PV-FULL-TAX-RATE            13540001
135500         WHEN +100                                                13550001
135600             SET PS-TXM-FT-RATE-FOUND-NO TO TRUE                  13560001
135700             MOVE ZERO             TO PV-FULL-TAX-RATE            13570001
135800         WHEN OTHER                                               13580001
135900             MOVE '7020-GET-TM-FT-TAX-RATE' TO PV-PARAGRAPH-NAME  13590001
136000             MOVE 'ERROR SELECT FROM TTXRTLO'                     13600001
136100                                            TO PV-DB2-OPERATION   13610001
136200             PERFORM 9200-SQL-ABEND                               13620001
136300     END-EVALUATE.                                                13630001
136400                                                                  13640001
136500 7030-GET-EMPLOYEE-DISCOUNT.                                      13650001
136600     EXEC SQL                                                     13660001
136700         SELECT EID.EMP_DISC_AMT                                  13670001
136800           INTO :EPEID-EMP-DISC-AMT                               13680001
136900           FROM TEPEID EID                                        13690001
137000          WHERE EID.PARTN_NBR = :EPTRN-PARTN-NBR                  13700001
137100            AND EID.STR_NBR = :EPITM-STR-NBR                      13710001
137200            AND EID.RGST_ID = :EPITM-RGST-ID                      13720001
137300            AND EID.TRN_NBR = :EPITM-TRN-NBR                      13730001
137400            AND EID.STRT_TM = :EPITM-STRT-TM                      13740001
137500            AND EID.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR    13750001
137600            AND EID.LNE_ITM_SEQ_NBR = :EPITM-LNE-ITM-SEQ-NBR      13760001
137700        WITH UR                                                   13770001
137800     END-EXEC.                                                    13780001
137900                                                                  13790001
138000     EVALUATE SQLCODE                                             13800001
138100         WHEN ZERO                                                13810001
138200             CONTINUE                                             13820001
138300         WHEN +100                                                13830001
138400             MOVE 0 TO EPEID-EMP-DISC-AMT                         13840001
138500         WHEN OTHER                                               13850001
138600             MOVE '7030-GET-EMPLOYEE-DISCOUNT'                    13860001
138700                                            TO PV-PARAGRAPH-NAME  13870001
138800             MOVE 'ERROR SELECT FROM TEPEID'                      13880001
138900                                            TO PV-DB2-OPERATION   13890001
139000             PERFORM 9200-SQL-ABEND                               13900001
139100     END-EVALUATE.                                                13910001
139200                                                                  13920001
139300                                                                  13930001
139400 7110-OPEN-LID-CURSOR.                                            13940001
139500                                                                  13950001
139600     EXEC SQL                                                     13960001
139700         OPEN LID-CSR                                             13970001
139800     END-EXEC.                                                    13980001
139900                                                                  13990001
140000     EVALUATE SQLCODE                                             14000001
140100         WHEN ZERO                                                14010001
140200             CONTINUE                                             14020001
140300         WHEN OTHER                                               14030001
140400             MOVE '7110-OPEN-LID-CURSOR' TO PV-PARAGRAPH-NAME     14040001
140500             MOVE 'ERROR ON OPENING LID CURSOR '                  14050001
140600                                            TO PV-DB2-OPERATION   14060001
140700             PERFORM 9200-SQL-ABEND                               14070001
140800     END-EVALUATE.                                                14080001
140900                                                                  14090001
141000 7120-FETCH-LID-CURSOR.                                           14100001
141100                                                                  14110001
141200     EXEC SQL                                                     14120001
141300         FETCH LID-CSR                                            14130001
141400           INTO :EPLID-LID-TYP-CDE                                14140001
141500               ,:EPLID-LID-AMT                                    14150001
141600               ,:EPLID-LID-PCT                                    14160001
141700     END-EXEC.                                                    14170001
141800                                                                  14180001
141900     EVALUATE SQLCODE                                             14190001
142000         WHEN ZERO                                                14200001
142100             CONTINUE                                             14210001
142200         WHEN +100                                                14220001
142300             SET PS-END-OF-LID-CURSOR  TO TRUE                    14230001
142400         WHEN OTHER                                               14240001
142500             MOVE '7120-FETCH-LID-CURSOR' TO PV-PARAGRAPH-NAME    14250001
142600             MOVE 'ERROR ON FETCHING LID CURSOR '                 14260001
142700                                          TO PV-DB2-OPERATION     14270001
142800             PERFORM 9200-SQL-ABEND                               14280001
142900     END-EVALUATE.                                                14290001
143000                                                                  14300001
143100 7130-CLOSE-LID-CURSOR.                                           14310001
143200                                                                  14320001
143300     EXEC SQL                                                     14330001
143400         CLOSE LID-CSR                                            14340001
143500     END-EXEC.                                                    14350001
143600                                                                  14360001
143700     EVALUATE SQLCODE                                             14370001
143800         WHEN ZERO                                                14380001
143900             CONTINUE                                             14390001
144000         WHEN OTHER                                               14400001
144100             MOVE '7130-CLOSE-LID-CURSOR' TO PV-PARAGRAPH-NAME    14410001
144200             MOVE 'ERROR ON CLOSING LID CURSOR '                  14420001
144300                                          TO PV-DB2-OPERATION     14430001
144400             PERFORM 9200-SQL-ABEND                               14440001
144500     END-EVALUATE.                                                14450001
144600                                                                  14460001
144700                                                                  14470001
144800 7210-OPEN-FEES-CURSOR.                                           14480001
144900                                                                  14490001
145000     EXEC SQL                                                     14500001
145100         OPEN FEES-CSR                                            14510001
145200     END-EXEC.                                                    14520001
145300                                                                  14530001
145400     EVALUATE SQLCODE                                             14540001
145500         WHEN ZERO                                                14550001
145600             CONTINUE                                             14560001
145700         WHEN OTHER                                               14570001
145800             MOVE '7210-OPEN-FEES-CURSOR' TO PV-PARAGRAPH-NAME    14580001
145900             MOVE 'ERROR ON OPENING FEES CURSOR '                 14590001
146000                                            TO PV-DB2-OPERATION   14600001
146100             PERFORM 9200-SQL-ABEND                               14610001
146200     END-EVALUATE.                                                14620001
146300                                                                  14630001
146400 7220-FETCH-FEES-CURSOR.                                          14640001
146500                                                                  14650001
146600     EXEC SQL                                                     14660001
146700         FETCH FEES-CSR                                           14670001
146800           INTO :EPLIS-SOR-FEE-ID                                 14680001
146900               ,:EPLIS-FEE-RT                                     14690001
147000     END-EXEC.                                                    14700001
147100                                                                  14710001
147200     EVALUATE SQLCODE                                             14720001
147300         WHEN ZERO                                                14730001
147400             CONTINUE                                             14740001
147500         WHEN +100                                                14750001
147600             SET PS-END-OF-FEES-CURSOR  TO TRUE                   14760001
147700         WHEN OTHER                                               14770001
147800             MOVE '7220-FETCH-FEES-CURSOR' TO PV-PARAGRAPH-NAME   14780001
147900             MOVE 'ERROR ON FETCHING FEES CURSOR '                14790001
148000                                             TO PV-DB2-OPERATION  14800001
148100             PERFORM 9200-SQL-ABEND                               14810001
148200     END-EVALUATE.                                                14820001
148300                                                                  14830001
148400 7230-CLOSE-FEES-CURSOR.                                          14840001
148500                                                                  14850001
148600     EXEC SQL                                                     14860001
148700         CLOSE FEES-CSR                                           14870001
148800     END-EXEC.                                                    14880001
148900                                                                  14890001
149000     EVALUATE SQLCODE                                             14900001
149100         WHEN ZERO                                                14910001
149200             CONTINUE                                             14920001
149300         WHEN OTHER                                               14930001
149400             MOVE '7230-CLOSE-FEES-CURSOR' TO PV-PARAGRAPH-NAME   14940001
149500             MOVE 'ERROR ON CLOSING FEES CURSOR '                 14950001
149600                                             TO PV-DB2-OPERATION  14960001
149700             PERFORM 9200-SQL-ABEND                               14970001
149800     END-EVALUATE.                                                14980001
149900                                                                  14990001
150000 7310-OPEN-POC-BPS-CURSOR.                                        15000001
150100                                                                  15010001
150200     EXEC SQL                                                     15020001
150300         OPEN POC-BPS-TRN-CSR                                     15030001
150400     END-EXEC.                                                    15040001
150500                                                                  15050001
150600     EVALUATE SQLCODE                                             15060001
150700         WHEN ZERO                                                15070001
150800             CONTINUE                                             15080001
150900         WHEN OTHER                                               15090001
151000             MOVE '7310-OPEN-POC-BPS-CURSOR' TO PV-PARAGRAPH-NAME 15100001
151100             MOVE 'ERROR ON OPENING POC-BPS CURSOR '              15110001
151200                                            TO PV-DB2-OPERATION   15120001
151300             PERFORM 9200-SQL-ABEND                               15130001
151400     END-EVALUATE.                                                15140001
151500                                                                  15150001
151600 7320-FETCH-POC-BPS-CURSOR.                                       15160001
151700     MOVE ZERO TO PS-NULL-IND7.                                   15170001
151800     MOVE SPACES TO EPORD-ORD-NBR-TEXT                            15180001
151900                    EPITM-TX-PRD-CDE-DESC-TEXT                    15190001
152000     EXEC SQL                                                     15200001
152100         FETCH POC-BPS-TRN-CSR                                    15210001
152200           INTO :EPTRN-PARTN-NBR                                  15220001
152300               ,:EPTRN-TRN-DTE                                    15230001
152400               ,:EPTRN-POS-CPBL-LVL-NBR                           15240001
152500               ,:EPITM-STR-NBR                                    15250001
152600               ,:EPITM-RGST-ID                                    15260001
152700               ,:EPITM-TRN-NBR                                    15270001
152800               ,:EPITM-STRT-TM                                    15280001
152900               ,:EPITM-SLS-CORR-SEQ-NBR                           15290001
153000               ,:EPITM-LNE-ITM-SEQ-NBR                            15300001
153100               ,:XST00025-GEO-CDE                                 15310001
153200               ,:EPITM-SLD-QTY                                    15320001
153300               ,:EPITM-CUST-CHRGD-AMT                             15330001
153400               ,:EPITM-SBJCT-TO-TX-AMT                            15340001
153500               ,:EPITM-TX-RT-PCT                                  15350001
153600               ,:EPITM-TX-AMT                                     15360001
153700               ,:EPITM-SKU-NBR                                    15370001
153800               ,:EPITM-TXBL-IND                                   15380001
153900               ,:EPITM-TX-PRD-CDE-DESC:PS-NULL-IND7               15390001
154000               ,:XST00001-ST-CDE                                  15400001
154100               ,:XST00001-ZIP-10-CDE                              15410001
154200               ,:EPTRN-OMNI-CHNL-FFLMT-TYP-CDE:PS-NULL-IND6       15420001
154300               ,:EPORD-ORD-NBR                                    15430001
154400               ,:EPITM-TXBL-IND                                   15440001
154500     END-EXEC.                                                    15450001
154600                                                                  15460001
154700     EVALUATE SQLCODE                                             15470001
154800         WHEN ZERO                                                15480001
154900             IF PS-NULL-IND7 = -1                                 15490001
155000                 MOVE SPACES TO EPITM-TX-PRD-CDE-DESC-TEXT        15500001
155100             END-IF                                               15510001
155200             IF PS-IND6-IS-NULL                                   15520001
155300               IF EPTRN-POS-CPBL-LVL-NBR = 200                    15530001
155400                 SET PS-POC TO TRUE                               15540001
155500               ELSE                                               15550001
155600                 SET PS-OTH TO TRUE                               15560001
155700               END-IF                                             15570001
155800             ELSE                                                 15580001
155900                 EVALUATE TRUE                                    15590001
156000                     WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SFS'  15600001
156100                           SET PS-SFS TO TRUE                     15610001
156200                     WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'BPS'  15620001
156300                           SET PS-BPS TO TRUE                     15630001
156400                     WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'SDD'  15640001
156500                           SET PS-SFS TO TRUE                     15650001
156600                     WHEN  EPTRN-OMNI-CHNL-FFLMT-TYP-CDE = 'BOS'  15660001
156700                           SET PS-BOS TO TRUE                     15670001
156800                     WHEN  OTHER                                  15680001
156900                           IF EPTRN-POS-CPBL-LVL-NBR = 200        15690001
157000                              SET PS-POC TO TRUE                  15700001
157100                           ELSE                                   15710001
157200                              SET PS-OTH TO TRUE                  15720001
157300                           END-IF                                 15730001
157400                 END-EVALUATE                                     15740001
157500             END-IF                                               15750001
157600         WHEN +100                                                15760001
157700             SET PS-END-OF-POC-BPS-CURSOR TO TRUE                 15770001
157800         WHEN OTHER                                               15780001
157900             MOVE '7320-FETCH-POC-BPS-CURSOR' TO PV-PARAGRAPH-NAME15790001
158000             MOVE 'ERROR ON FETCHING POC-BPS CURSOR '             15800001
158100                                             TO PV-DB2-OPERATION  15810001
158200             PERFORM 9200-SQL-ABEND                               15820001
158300     END-EVALUATE.                                                15830001
158400                                                                  15840001
158500 7330-CLOSE-POC-BPS-CURSOR.                                       15850001
158600                                                                  15860001
158700     EXEC SQL                                                     15870001
158800         CLOSE POC-BPS-TRN-CSR                                    15880001
158900     END-EXEC.                                                    15890001
159000                                                                  15900001
159100     EVALUATE SQLCODE                                             15910001
159200         WHEN ZERO                                                15920001
159300             CONTINUE                                             15930001
159400         WHEN OTHER                                               15940001
159500             MOVE '7330-CLOSE-POC-BPS-CURSOR' TO PV-PARAGRAPH-NAME15950001
159600             MOVE 'ERROR ON CLOSING POC-BPS CURSOR '              15960001
159700                                             TO PV-DB2-OPERATION  15970001
159800             PERFORM 9200-SQL-ABEND                               15980001
159900     END-EVALUATE.                                                15990001
160000                                                                  16000001
160100                                                                  16010001
160200******************************************************************16020001
160300*  WRITE THE REPORT TOTAL LINES AND CLOSE ALL FILES.             *16030001
160400******************************************************************16040001
160500 9000-EOJ-ROUTINE.                                                16050001
160600     PERFORM 7330-CLOSE-POC-BPS-CURSOR.                           16060001
160700                                                                  16070001
160800     CLOSE TAX-RATE-DETAIL                                        16080001
160900           TAX-RATE-STATS                                         16090001
161000           TAX-RATE-EMAIL.                                        16100001
161100                                                                  16110001
161200                                                                  16120001
161300******************************************************************16130001
161400* 9200-SQL-ABEND                                                  16140001
161500*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.16150001
161600******************************************************************16160001
161700 9200-SQL-ABEND.                                                  16170001
161800                                                                  16180001
161900     DISPLAY '** ABEND        **'.                                16190001
162000     DISPLAY '** PROGRAM      ** = ' PC-CURRENT-PROGRAM-NAME.     16200001
162100     DISPLAY '** PARAGRAPH    ** = ' PV-PARAGRAPH-NAME.           16210001
162200     DISPLAY '** OPERATION    ** = ' PV-DB2-OPERATION.            16220001
162300                                                                  16230001
162400                                                                  16240001
162500******************************************************************16250001
162600* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     16260001
162700* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      16270001
162800******************************************************************16280001
162900     COPY DPPD004.                                                16290001
163000                                                                  16300001
163100     SET ABEND-4013-DB2-ERROR TO TRUE.                            16310001
163200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         16320001
163300                                                                  16330001
163400                                                                  16340001
163500************************************************************      16350001
163600*  ABEND - PERFORMS A NON-                                        16360001
163700************************************************************      16370001
163800 9910-ABEND.                                                      16380001
163900                                                                  16390001
164000     DISPLAY '** ABEND           **'.                             16400001
164100     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME   16410001
164200     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        16420001
164300     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       16430001
164400     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       16440001
164500     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         16450001
164600                                                                  16460001
