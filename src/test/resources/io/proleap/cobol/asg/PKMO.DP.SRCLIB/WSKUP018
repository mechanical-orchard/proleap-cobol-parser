000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400 PROGRAM-ID.   WSKUP018.                                          00040000
000500 AUTHOR.       JOE LAROSA.                                        00050000
000600 INSTALLATION. KOHLS DEPARTMENT STORES.                           00060000
000700 DATE-WRITTEN. MARCH 2007.                                        00070000
000800 DATE-COMPILED.                                                   00080000
000900******************************************************************00090000
001000*       WMOS INBOUND TRANSACTION REPOSITORY PURGE PROGRAM         00100000
001100*                                                                 00110000
001200* THIS PROGRAM READS A FILE OF TRANSACTIONS FROM THE DB2          00120028
001300* DOWNLOAD REPOSITORY TABLE (WST_DAT_CNTL) THAT ARE OVER XX       00130028
001400* DAYS OLD, AND DELETES THE CORRESPONDING ROWS FROM THE           00140028
001410* WST_DAT_CNTL AND WST_DAT_XFER TABLES.                           00141028
001500*                                                                 00150000
002000* NOTE: PURGE DATES ARE GOTTEN FROM PARM TABLE AND MAY VARY.      00200004
002100******************************************************************00210000
002200 ENVIRONMENT DIVISION.                                            00220000
002300******************************************************************00230000
002400 CONFIGURATION SECTION.                                           00240000
002500 SOURCE-COMPUTER.        IBM-3090.                                00250000
002600 OBJECT-COMPUTER.        IBM-3090.                                00260000
002700                                                                  00270000
002800 INPUT-OUTPUT SECTION.                                            00280000
002900 FILE-CONTROL.                                                    00290000
002910                                                                  00291029
002920     SELECT INPUT-FILE ASSIGN TO INP01.                           00292029
002930                                                                  00293029
003000******************************************************************00300000
003100 DATA DIVISION.                                                   00310000
003200******************************************************************00320000
003300 FILE SECTION.                                                    00330000
003310                                                                  00331029
003320 FD  INPUT-FILE                                                   00332029
003330     RECORDING MODE F                                             00333029
003340     BLOCK CONTAINS 0 RECORDS                                     00334029
003350     LABEL RECORDS ARE OMITTED.                                   00335029
003360 01  INPUT-REC                        PIC X(46).                  00336029
003400                                                                  00340000
003500 WORKING-STORAGE SECTION.                                         00350000
003600 01  PS-PROGRAM-SWITCHES.                                         00360000
003700     05  PS-INPUT-FILE-EOF-SW        PIC X(01) VALUE 'N'.         00370012
003800         88  PS-INPUT-FILE-EOF-YES             VALUE 'Y'.         00380012
003900         88  PS-INPUT-FILE-EOF-NO              VALUE 'N'.         00390012
005200                                                                  00520000
005300 01  PC-PROGRAM-CONSTANTS.                                        00530000
005400     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'WSKUP018'.  00540000
005600                                                                  00560000
005700 01  PA-PROGRAM-ACCUMULATORS.                                     00570000
005800     05  PA-CNT-CMPLTD               PIC S9(09) COMP-3 VALUE 0.   00580029
006402     05  PA-CNT-OTHER                PIC S9(09) COMP-3 VALUE 0.   00640214
006403     05  PA-CNT-TOTAL                PIC S9(09) COMP-3 VALUE 0.   00640314
006404     05  PA-CNT-ERROR-DTL            PIC S9(09) COMP-3 VALUE 0.   00640414
006405     05  PA-CNT-ERROR-HDR            PIC S9(09) COMP-3 VALUE 0.   00640514
006406     05  PA-CNT-DEL-DTL-CMPLTD       PIC S9(09) COMP-3 VALUE 0.   00640614
006407     05  PA-CNT-DEL-DTL-OTHER        PIC S9(09) COMP-3 VALUE 0.   00640714
006408     05  PA-CNT-DEL-HDR-CMPLTD       PIC S9(09) COMP-3 VALUE 0.   00640814
006409     05  PA-CNT-DEL-HDR-OTHER        PIC S9(09) COMP-3 VALUE 0.   00640914
006500                                                                  00650000
006600 01  PV-PROGRAM-VARIABLES.                                        00660000
006700     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9-.            00670014
007200                                                                  00720000
010800                                                                  01080000
010900 01  PV-ABEND-VARIABLES.                                          01090000
011000     05  PV-ABEND-CODE               PIC S9(4) VALUE +0 COMP SYNC.01100000
011200     05  PV-SQLCODE                  PIC S9(9).                   01120014
011300     05  PV-DISPLAY-SQLCODE          PIC -------999.              01130000
011400     05  PV-ABEND-PROGRAM            PIC X(08) VALUE 'WSKUP018'.  01140000
011500     05  PV-ABEND-PARAGRAPH          PIC X(25) VALUE SPACES.      01150000
011600     05  PV-ABEND-OPERATION          PIC X(20) VALUE SPACES.      01160000
011700     05  PV-ABEND-STRUCTURE-1        PIC X(08) VALUE SPACES.      01170000
011800     05  PV-DB2-OPERATION-MESSAGE-1  PIC X(79) VALUE SPACES.      01180000
011900                                                                  01190000
011970                                                                  01197012
012500******************************************************************01250000
012600*  INPUT RECORD LAYOUT                                            01260023
012700******************************************************************01270000
012800     COPY WSRD051.                                                01280023
012900                                                                  01290000
012910******************************************************************01291023
012920*  DB2 FORMATTED MESSAGE AREA                                     01292023
012930******************************************************************01293023
012940     COPY DPWS004.                                                01294023
012950                                                                  01295023
013000******************************************************************01300000
013100*  COMMUNICATIONS AREA FOR DB2                                    01310000
013200******************************************************************01320000
013300     EXEC SQL                                                     01330000
013400         INCLUDE SQLCA                                            01340000
013500     END-EXEC.                                                    01350000
013600                                                                  01360000
013700******************************************************************01370000
013800*  DB2 TABLE DECLARATION - WMOS INBOUND REPOSITORY CONTROL        01380000
013900*      TABLE (WST_DAT_CNTL)                                       01390000
014000******************************************************************01400000
014100     EXEC SQL                                                     01410000
014200         INCLUDE WST00003                                         01420000
014300     END-EXEC.                                                    01430000
014400                                                                  01440000
014500******************************************************************01450000
014600*  DB2 TABLE DECLARATION - WMOS INBOUND REPOSITORY TRANSACTIONS   01460000
014700*      TABLE (WST_DAT_XFER)                                       01470000
014800******************************************************************01480000
014900     EXEC SQL                                                     01490000
015000         INCLUDE WST00004                                         01500000
015100     END-EXEC.                                                    01510000
015200                                                                  01520000
022400                                                                  02240000
022500******************************************************************02250000
022600 LINKAGE SECTION.                                                 02260000
022700******************************************************************02270000
022800                                                                  02280000
022900                                                                  02290000
023000/*****************************************************************02300000
023100 PROCEDURE DIVISION.                                              02310000
023200******************************************************************02320000
023300 0000-PROGRAM-MAINLINE.                                           02330000
023400     DISPLAY '************ START OF WSKUP018 ***************'     02340000
023500                                                                  02350000
023600     PERFORM 1000-INITIALIZE.                                     02360000
023700                                                                  02370000
023800*PROCESS TRANSACTIONS.                                            02380011
023900     PERFORM 2000-PROCESS-RECORDS.                                02390011
023910                                                                  02391011
024400*EOJ ROUTINE.                                                     02440000
024500     PERFORM 9000-EOJ-ROUTINE.                                    02450000
024600                                                                  02460000
024700*STOP                                                             02470000
024800     DISPLAY ' '.                                                 02480000
024900     DISPLAY '************  END OF WSKUP018  ***************'     02490000
025000     STOP RUN.                                                    02500000
025100                                                                  02510000
025200******************************************************************02520000
025300*                                                                *02530000
025400*                I N I T I A L I Z A T I O N                     *02540000
025500*                                                                *02550000
025600******************************************************************02560000
025700 1000-INITIALIZE.                                                 02570000
025800                                                                  02580000
025810     OPEN INPUT INPUT-FILE.                                       02581011
025820                                                                  02582011
025900*INIT COUNTERS.                                                   02590000
026000     INITIALIZE PA-CNT-CMPLTD                                     02600012
026100                PA-CNT-OTHER                                      02610012
026200                PA-CNT-TOTAL                                      02620012
026210                PA-CNT-ERROR-DTL                                  02621014
026220                PA-CNT-ERROR-HDR                                  02622014
026300                PA-CNT-DEL-DTL-CMPLTD                             02630014
026310                PA-CNT-DEL-DTL-OTHER                              02631014
026400                PA-CNT-DEL-HDR-CMPLTD                             02640014
026410                PA-CNT-DEL-HDR-OTHER.                             02641014
026700                                                                  02670000
042200******************************************************************04220000
042400*      PROCESS RECORDS                                           *04240011
042600******************************************************************04260000
042700 2000-PROCESS-RECORDS.                                            04270011
042701                                                                  04270111
042702     READ INPUT-FILE INTO WS051-INBN-REPOSITORY-RECORD            04270225
042703        AT END                                                    04270311
042704           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    04270412
042705                                                                  04270511
042706     PERFORM 2100-DELETE-RECORDS                                  04270612
042707         UNTIL PS-INPUT-FILE-EOF-YES.                             04270715
042708                                                                  04270812
042709                                                                  04270912
042710******************************************************************04271012
042711*      DELETE THE RECORDS FROM THE TABLES                        *04271112
042712******************************************************************04271212
042713 2100-DELETE-RECORDS.                                             04271312
042714                                                                  04271412
042715     IF WS051-STAT-CDE = 'CMPLTD'                                 04271523
042716         ADD 1                     TO PA-CNT-CMPLTD               04271612
042717     ELSE                                                         04271712
042718         ADD 1                     TO PA-CNT-OTHER                04271812
042719     END-IF.                                                      04271912
042720                                                                  04272012
042724     PERFORM 3210-DELETE-XFER-ROW.                                04272414
042725     PERFORM 2400-DELETE-CNTL.                                    04272514
042726                                                                  04272614
042727*COMMIT THE DATA.                                                 04272712
042728     IF PA-CNT-TOTAL > 1000                                       04272812
042729         PERFORM 2800-COMMIT                                      04272912
042730         MOVE PA-CNT-TOTAL          TO PV-DISPLAY-COUNT           04273029
042731         DISPLAY ' COMMIT COUNT = '    PV-DISPLAY-COUNT           04273129
042732         MOVE 0                    TO PA-CNT-TOTAL                04273212
042733     END-IF.                                                      04273312
042734                                                                  04273412
042735     READ INPUT-FILE INTO WS051-INBN-REPOSITORY-RECORD            04273523
042736        AT END                                                    04273612
042737           SET PS-INPUT-FILE-EOF-YES  TO TRUE.                    04273712
042738                                                                  04273812
042740                                                                  04274012
055000                                                                  05500000
055100******************************************************************05510000
055200 2400-DELETE-CNTL.                                                05520000
055300                                                                  05530000
055400     EXEC SQL                                                     05540000
055500         DELETE FROM WST_DAT_CNTL                                 05550000
055600          WHERE PRC_CNTL_TMST = :WS051-PRC-CNTL-TMST              05560023
055700            AND TRN_TYP_CDE   = :WS051-TRN-TYP-CDE                05570023
055800            AND PRC_GP_ID     = :WS051-PRC-GP-ID                  05580023
055900            AND LOC_NBR       = :WS051-LOC-NBR                    05590023
056000     END-EXEC.                                                    05600000
056100                                                                  05610000
056200     EVALUATE TRUE                                                05620000
056300       WHEN SQLCODE = ZERO                                        05630000
056410           IF WS051-STAT-CDE = 'CMPLTD'                           05641023
056420               ADD 1                  TO PA-CNT-DEL-HDR-CMPLTD    05642014
056430           ELSE                                                   05643014
056440               ADD 1                  TO PA-CNT-DEL-HDR-OTHER     05644014
056450           END-IF                                                 05645014
      * COUNT NUMBER OF ROWS DELETED TO DETERMINE WHEN TO COMMIT        05646030
                 ADD SQLERRD(3)         TO PA-CNT-TOTAL                 05647030
056500                                                                  05650000
056510       WHEN SQLCODE = +100                                        05651021
056520           CONTINUE                                               05652021
056600       WHEN OTHER                                                 05660000
056610           ADD 1                      TO PA-CNT-ERROR-HDR         05661014
056700           MOVE '2400-DELETE-CNTL'    TO PV-ABEND-PARAGRAPH       05670000
056800           MOVE 'DELETE WST_DAT_CNTL' TO PV-ABEND-OPERATION       05680000
056900           MOVE DCLWST00004 TO PV-DB2-OPERATION-MESSAGE-1         05690000
057000           PERFORM 9900-DB2-ABEND                                 05700000
057100     END-EVALUATE.                                                05710000
057200                                                                  05720000
059100******************************************************************05910000
059200 2800-COMMIT.                                                     05920000
059300                                                                  05930000
059400     EXEC SQL                                                     05940000
059500         COMMIT                                                   05950000
059600     END-EXEC.                                                    05960000
059700                                                                  05970000
059800     EVALUATE TRUE                                                05980000
059900       WHEN SQLCODE = ZERO                                        05990000
060000           CONTINUE                                               06000000
060100                                                                  06010000
060200       WHEN OTHER                                                 06020000
060300           MOVE '2800-COMMIT'        TO PV-ABEND-PARAGRAPH        06030000
060400           MOVE 'COMMIT LOAD TABLES' TO PV-ABEND-OPERATION        06040000
060500           PERFORM 9900-DB2-ABEND                                 06050000
060600     END-EVALUATE.                                                06060000
060700                                                                  06070000
066200******************************************************************06620000
066300 3210-DELETE-XFER-ROW.                                            06630000
066400                                                                  06640000
067100     EXEC SQL                                                     06710012
067200         DELETE FROM WST_DAT_XFER                                 06720012
067330          WHERE PRC_CNTL_TMST = :WS051-PRC-CNTL-TMST              06733023
067340            AND TRN_TYP_CDE   = :WS051-TRN-TYP-CDE                06734023
067350            AND PRC_GP_ID     = :WS051-PRC-GP-ID                  06735023
067400     END-EXEC.                                                    06740012
067500                                                                  06750000
067600     EVALUATE TRUE                                                06760012
067700         WHEN SQLCODE = ZERO                                      06770012
067900             IF WS051-STAT-CDE = 'CMPLTD'                         06790023
068000                 ADD SQLERRD(3)         TO PA-CNT-DEL-DTL-CMPLTD  06800022
068100             ELSE                                                 06810014
068200                 ADD SQLERRD(3)         TO PA-CNT-DEL-DTL-OTHER   06820022
068300             END-IF                                               06830014
      * COUNT NUMBER OF ROWS DELETED TO DETERMINE WHEN TO COMMIT        06840030
                   ADD SQLERRD(3)         TO PA-CNT-TOTAL               06850030
068700                                                                  06870000
068710         WHEN SQLCODE = +100                                      06871020
068800         WHEN SQLCODE = -911                                      06880012
068900         WHEN SQLCODE = -913                                      06890012
069000             CONTINUE                                             06900014
069100                                                                  06910000
069200         WHEN OTHER                                               06920012
069210             ADD 1                       TO PA-CNT-ERROR-DTL      06921020
069300             MOVE '3210-DELETE-XFER-ROW' TO PV-ABEND-PARAGRAPH    06930012
069400             MOVE 'DELETE WST_DAT_XFER'  TO PV-ABEND-OPERATION    06940012
069500             MOVE DCLWST00003    TO PV-DB2-OPERATION-MESSAGE-1    06950012
069600             PERFORM 9900-DB2-ABEND                               06960012
069700     END-EVALUATE.                                                06970012
096900                                                                  09690000
097000******************************************************************09700000
097100*                                                                *09710000
097200*                   E O J   P R O C E S S I N G                  *09720000
097300*                                                                *09730000
097400******************************************************************09740000
097500 9000-EOJ-ROUTINE.                                                09750000
097600                                                                  09760000
097610     PERFORM 2800-COMMIT.                                         09761014
097620                                                                  09762014
097700     DISPLAY ' '.                                                 09770000
097800     DISPLAY '*******************************************'.       09780000
097900     DISPLAY '      * WSKUP018 SUMMARY STATISTICS *      '.       09790000
098000     DISPLAY ' '.                                                 09800000
098100     DISPLAY '      -------------------------------      '.       09810000
098200     DISPLAY '       LOAD REPOSITORY PURGE RESULTS       '.       09820000
098300     DISPLAY '      -------------------------------      '.       09830000
098310     DISPLAY SPACES.                                              09831014
098400     MOVE PA-CNT-CMPLTD                   TO PV-DISPLAY-COUNT.    09840014
098500     DISPLAY ' CMPLTD HEADERS         ='     PV-DISPLAY-COUNT.    09850022
098600                                                                  09860014
098610     MOVE PA-CNT-OTHER                    TO PV-DISPLAY-COUNT.    09861014
098620     DISPLAY ' OTHER HEADERS          ='     PV-DISPLAY-COUNT.    09862022
098630                                                                  09863014
098700     MOVE PA-CNT-DEL-DTL-CMPLTD           TO PV-DISPLAY-COUNT.    09870014
098800     DISPLAY ' DELETED DTL FOR CMPLTD ='     PV-DISPLAY-COUNT.    09880022
098900                                                                  09890014
098910     MOVE PA-CNT-DEL-DTL-OTHER            TO PV-DISPLAY-COUNT.    09891014
098920     DISPLAY ' DELETED DTL FOR OTHER  ='     PV-DISPLAY-COUNT.    09892022
098921                                                                  09892114
098922     MOVE PA-CNT-ERROR-DTL                TO PV-DISPLAY-COUNT.    09892214
098923     DISPLAY ' ERRORS ON DETAIL DEL   ='     PV-DISPLAY-COUNT.    09892322
098930                                                                  09893014
098931     MOVE PA-CNT-ERROR-HDR                TO PV-DISPLAY-COUNT.    09893114
098932     DISPLAY ' ERRORS ON HEADER DEL   ='     PV-DISPLAY-COUNT.    09893222
098933                                                                  09893314
098940     DISPLAY SPACES.                                              09894014
099700     DISPLAY '*******************************************'.       09970000
099800                                                                  09980000
099810     CLOSE INPUT-FILE.                                            09981011
099820                                                                  09982011
099900******************************************************************09990000
100000* 9900-DB2-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      10000000
100100* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 10010000
100200******************************************************************10020000
100300 9900-DB2-ABEND.                                                  10030000
100400                                                                  10040000
100500     MOVE SQLCODE    TO PV-SQLCODE.                               10050000
100600     MOVE PV-SQLCODE TO PV-DISPLAY-SQLCODE.                       10060000
100700     DISPLAY '*** DB2 ERROR ***'.                                 10070000
100800     DISPLAY '*** SQLCODE   = ' PV-DISPLAY-SQLCODE.               10080000
100900     DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                 10090000
101000     DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.               10100000
101100     DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.               10110000
101200     DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.       10120000
101300     DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.             10130000
101400                                                                  10140000
101500******************************************************************10150000
101600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    10160000
101700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         10170000
101800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     10180000
101900* FORMAT.                                                         10190000
102000******************************************************************10200000
102100     COPY DPPD004.                                                10210000
102200                                                                  10220000
102300     IF SQLCODE NOT = -911                                        10230000
102400         EXEC SQL                                                 10240000
102500             ROLLBACK                                             10250000
102600         END-EXEC                                                 10260000
102700     END-IF.                                                      10270000
102800                                                                  10280000
102900     MOVE +4013         TO PV-ABEND-CODE.                         10290000
103000     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         10300000
103100******************************************************************10310000
103200******************************************************************10320000
