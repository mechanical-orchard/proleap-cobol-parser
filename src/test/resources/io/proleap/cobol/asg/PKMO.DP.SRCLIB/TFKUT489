      ******************************************************************00010027
       IDENTIFICATION DIVISION.                                         00020027
      ******************************************************************00030027
                                                                        00040027
       PROGRAM-ID.             TFKUT489.                                00050027
       AUTHOR.                 JACK KRAMER.                             00060027
       INSTALLATION.           KOHLS.                                   00070027
       DATE-WRITTEN            APRIL, 1997.                             00080027
       DATE-COMPILED.                                                   00090027
                                                                        00100027
      ******************************************************************00110027
      *      THIS PROGRAM READS THE PROCESSING DATES FILE TO DETERMINE  00120027
      *  BEGINNING AND ENDING DATES, THEN READS RECEIVED TRANSFERS FOR  00130027
      *  THE SPECIFIED TIME PERIOD AND CREATES AN OUTPUT RECEIVED       00140027
      *  TRANSFER FILE TO BE PASSED TO THE RECEIVED TRANSFER REPORT.    00150027
      ******************************************************************00160027
111703* 11/17/2003 - RAY GRAF                                           00161028
111703*   SORT1/SORT2 TRANSFER TYPES.                                   00162029
      ******************************************************************00163028
100404** 10/04/2004 CHANGED BY: RAY GRAF                                00164030
100404**     RECOMPILE DUE TO TFRD034 COPYBOOK CHANGES.                 00165030
      ***************************************************************** 00166030
022812** 02/28/2012 CHANGED BY: CHERI PARMLEY           PRJ#3403        00168032
022812**     RECOMPILE DUE TO TTFITEM AND TTFITRC TABLE CHANGES         00169031
      ***************************************************************** 00169131
                                                                        00170027
      ******************************************************************00180027
       ENVIRONMENT DIVISION.                                            00190027
      ******************************************************************00200027
                                                                        00210027
       CONFIGURATION SECTION.                                           00220027
                                                                        00230027
       SOURCE-COMPUTER.        IBM-3090.                                00240027
       OBJECT-COMPUTER.        IBM-3090.                                00250027
                                                                        00260027
       INPUT-OUTPUT SECTION.                                            00270027
                                                                        00280027
       FILE-CONTROL.                                                    00290027
                                                                        00300027
           SELECT PROCESS-DATES-FILE                                    00310027
               ASSIGN TO INP01.                                         00320027
                                                                        00330027
           SELECT RECEIVED-XFER-FILE                                    00340027
               ASSIGN TO OUT01.                                         00350027
                                                                        00360027
      ******************************************************************00370027
       DATA DIVISION.                                                   00380027
      ******************************************************************00390027
                                                                        00400027
       FILE SECTION.                                                    00410027
                                                                        00420027
       FD  PROCESS-DATES-FILE                                           00430027
           RECORDING MODE IS F                                          00440027
           LABEL RECORDS ARE STANDARD                                   00450027
           BLOCK CONTAINS 0 RECORDS.                                    00460027
                                                                        00470027
       01  PROCESS-DATES-RECORD                PIC  X(16).              00480027
                                                                        00490027
       FD  RECEIVED-XFER-FILE                                           00500027
           RECORDING MODE IS F                                          00510027
           LABEL RECORDS ARE STANDARD                                   00520027
           BLOCK CONTAINS 0 RECORDS.                                    00530027
                                                                        00540027
       01  RECEIVED-XFER-RECORD                PIC  X(80).              00550027
                                                                        00560027
      ******************************************************************00570027
       WORKING-STORAGE SECTION.                                         00580027
      ******************************************************************00590027
                                                                        00600027
      *                                                                 00610027
      *  RECORD LAYOUT FOR THE PROCESS DATES FILE                       00620027
      *                                                                 00630027
           COPY TFRD029.                                                00640027
                                                                        00650027
      *                                                                 00660027
      *  RECORD LAYOUT FOR THE RECEIVED TRANSFERS FILE                  00670027
      *                                                                 00680027
           COPY TFRD034.                                                00690027
      *                                                                 00700027
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM      00710027
      *  TABLE                                                          00720027
      *                                                                 00730027
           EXEC SQL                                                     00740027
               INCLUDE TTFITEM                                          00750027
           END-EXEC.                                                    00760027
                                                                        00770027
      *                                                                 00780027
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER STATUS    00790027
      *  TABLE                                                          00800027
      *                                                                 00810027
           EXEC SQL                                                     00820027
               INCLUDE TTFSTAT                                          00830027
           END-EXEC.                                                    00840027
                                                                        00850027
      *                                                                 00860027
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER TABLE     00870027
      *                                                                 00880027
           EXEC SQL                                                     00890027
               INCLUDE TTFMSTR                                          00900027
           END-EXEC.                                                    00910027
                                                                        00920027
      *                                                                 00930027
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER RECEIPT   00940027
      *                                                                 00950027
           EXEC SQL                                                     00960027
               INCLUDE TTFRCPT                                          00970027
           END-EXEC.                                                    00980027
                                                                        00990027
      *                                                                 01000027
      *  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE TRANSFER ITEM RCPT 01010027
      *                                                                 01020027
           EXEC SQL                                                     01030027
               INCLUDE TTFITRC                                          01040027
           END-EXEC.                                                    01050027
                                                                        01060027
      *                                                                 01070027
      *  COMMUNICATIONS AREA FOR DB2                                    01080027
      *                                                                 01090027
           EXEC SQL                                                     01100027
               INCLUDE SQLCA                                            01110027
           END-EXEC.                                                    01120027
                                                                        01130027
      *                                                                 01140027
      *  COPY BOOK FOR THE CALENDAR ROUTINE                             01150027
      *                                                                 01160027
           COPY DPWS500.                                                01170027
                                                                        01180027
      *                                                                 01190027
      *  DB2 FORMATTED ERROR MESSAGE                                    01200027
      *                                                                 01210027
           COPY DPWS004.                                                01220027
                                                                        01230027
       01  ABEND-CODE                          PIC S9(04)  VALUE +0     01240027
                                                           COMP SYNC.   01250027
                                                                        01260027
       01  PC-PROGRAM-CONSTANTS.                                        01270027
           05  PC-MAX-RETRIES                  PIC S9(3)    VALUE 3     01280027
                                                            COMP-3.     01290027
           05  PC-PROGRAM-NAME           PIC  X(08)  VALUE  'TFKUT489'. 01300027
111703*    05  PC-DEFECTIVES-DAMAGES           PIC  X(02)  VALUE '01'.  01310028
111703     05  PC-DEFECTIVES-DAMAGES-SORT1     PIC  X(02)  VALUE '00'.  01311029
111703     05  PC-DEFECTIVES-DAMAGES-SORT2     PIC  X(02)  VALUE '01'.  01312029
           05  PC-CALLBACK                     PIC  X(02)  VALUE '02'.  01320027
           05  PC-STOCK-BALANCE-CORPORATE      PIC  X(02)  VALUE '03'.  01330027
           05  PC-STOCK-BALANCE-STORE          PIC  X(02)  VALUE '04'.  01340027
           05  PC-CUSTOMER                     PIC  X(02)  VALUE '05'.  01350027
           05  PC-ASM-RECEIPT                  PIC  X(02)  VALUE 'AR'.  01360027
           05  PC-POS-RECEIPT                  PIC  X(02)  VALUE 'PR'.  01370027
           05  PC-VOIDED                       PIC  X(02)  VALUE 'VD'.  01380027
           05  PC-YES                          PIC  X(01)  VALUE  'Y'.  01390027
                                                                        01400027
       01  PS-PROGRAM-SWITCHES.                                         01410027
           05  PS-END-OF-RECV-XFER-DATA-IND    PIC  X(01)  VALUE 'N'.   01420027
               88  PS-MORE-RECV-XFER-DATA                  VALUE 'N'.   01430027
               88  PS-END-OF-RECV-XFER-DATA                VALUE 'Y'.   01440027
           05  PS-END-OF-VOID-XFER-DATA-IND    PIC  X(01)  VALUE 'N'.   01450027
               88  PS-MORE-VOID-XFER-DATA                  VALUE 'N'.   01460027
               88  PS-END-OF-VOID-XFER-DATA                VALUE 'Y'.   01470027
                                                                        01480027
       01  PV-PROGRAM-VARIABLES.                                        01490027
           05  PV-XFER-QTY              PIC S9(07)    VALUE +0 COMP-3.  01500027
           05  PV-XFER-PRICE            PIC S9(09)V99 VALUE +0 COMP-3.  01510027
           05  PV-XFER-QTY-IND          PIC S9(04)  VALUE +0            01520027
                                                    COMP SYNC.          01530027
           05  PV-XFER-PRICE-IND               PIC S9(04)  VALUE +0     01540027
                                                           COMP SYNC.   01550027
           05  PV-RETRY-COUNTER                PIC S9(4)   VALUE ZERO   01560027
                                                           COMP SYNC.   01570027
           05  PV-PARAGRAPH-NAME               PIC  X(30)  VALUE SPACE. 01580027
           05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE. 01590027
           05  PV-BEG-TIMESTAMP.                                        01600027
               10  PV-BEG-CC                   PIC  X(02)  VALUE SPACE. 01610027
               10  PV-BEG-YY                   PIC  X(02)  VALUE SPACE. 01620027
               10  FILLER                      PIC  X(01)  VALUE '-'.   01630027
               10  PV-BEG-MM                   PIC  X(02)  VALUE SPACE. 01640027
               10  FILLER                      PIC  X(01)  VALUE '-'.   01650027
               10  PV-BEG-DD                   PIC  X(02)  VALUE SPACE. 01660027
               10  FILLER                      PIC  X(16)  VALUE        01670027
                   '-00.00.00.000000'.                                  01680027
           05  PV-BEG-TMST  REDEFINES  PV-BEG-TIMESTAMP                 01690027
                                               PIC  X(26).              01700027
           05  PV-END-TIMESTAMP.                                        01710027
               10  PV-END-CC                   PIC  X(02)  VALUE SPACE. 01720027
               10  PV-END-YY                   PIC  X(02)  VALUE SPACE. 01730027
               10  FILLER                      PIC  X(01)  VALUE '-'.   01740027
               10  PV-END-MM                   PIC  X(02)  VALUE SPACE. 01750027
               10  FILLER                      PIC  X(01)  VALUE '-'.   01760027
               10  PV-END-DD                   PIC  X(02)  VALUE SPACE. 01770027
               10  FILLER                      PIC  X(16)  VALUE        01780027
                   '-23.59.59.999999'.                                  01790027
           05  PV-END-TMST  REDEFINES  PV-END-TIMESTAMP                 01800027
                                               PIC  X(26).              01810027
                                                                        01820027
      *                                                                 01830027
      * CURSOR TO RETRIEVE ALL RECEIVED TRANSFERS WITHIN A FISCAL MONTH 01840027
      *                                                                 01850027
           EXEC SQL                                                     01860027
              DECLARE  RECV_CSR CURSOR FOR                              01870027
               SELECT  M.XFER_DKEY_ID                                   01880027
                      ,M.FR_STR_NBR                                     01890027
                      ,M.XFER_SEQ_NBR                                   01900027
                      ,S.XFER_STAT_TMST                                 01910027
                      ,S.XFER_STAT_CDE                                  01920027
                      ,R.STR_NBR                                        01930027
                      ,R.BYP_DTL_CK_IND                                 01940027
                      ,R.RCVR_INIT_1ST_NM                               01950027
                      ,R.RCVR_LAST_NM                                   01960027
                 FROM  TTFMSTR M                                        01970027
                      ,TTFSTAT S                                        01980027
                      ,TTFRCPT R                                        01990027
                 WHERE  S.XFER_DKEY_ID      = M.XFER_DKEY_ID        AND 02000027
                        R.XFER_DKEY_ID      = M.XFER_DKEY_ID        AND 02010027
                        R.RCV_XFER_BEG_TMST = S.XFER_STAT_TMST      AND 02020027
                        (M.CMPT_XFER_BEG_TMST BETWEEN :PV-BEG-TMST      02030027
                                                          AND           02040027
                                                      :PV-END-TMST) AND 02050027
111703*                 XFER_TYP_CDE IN (:PC-DEFECTIVES-DAMAGES,        02060028
111703                  XFER_TYP_CDE IN (:PC-DEFECTIVES-DAMAGES-SORT1,  02061029
111703                                   :PC-DEFECTIVES-DAMAGES-SORT2,  02070029
                                         :PC-CALLBACK,                  02071028
                                         :PC-STOCK-BALANCE-CORPORATE,   02080027
                                         :PC-STOCK-BALANCE-STORE,       02090027
                                         :PC-CUSTOMER)              AND 02100027
                 S.XFER_STAT_TMST =                                     02110027
                       (SELECT MAX(XFER_STAT_TMST)                      02120027
                        FROM   TTFSTAT                                  02130027
                        WHERE  XFER_DKEY_ID   = M.XFER_DKEY_ID      AND 02140027
                               XFER_STAT_CDE  IN (:PC-ASM-RECEIPT,      02150027
                                                  :PC-POS-RECEIPT)) AND 02160027
                 NOT EXISTS                                             02170027
                       (SELECT XFER_DKEY_ID                             02180027
                       FROM   TTFSTAT                                   02190027
                       WHERE  XFER_DKEY_ID    = S.XFER_DKEY_ID      AND 02200027
                              XFER_STAT_CDE   = :PC-VOIDED              02210027
                       GROUP BY      XFER_DKEY_ID)                      02220027
           END-EXEC.                                                    02230027
      *                                                                 02240027
      * CURSOR TO RETRIEVE ALL VOIDED TRANSFERS WITHIN A FISCAL MONTH   02250027
      *                                                                 02260027
           EXEC SQL                                                     02270027
              DECLARE  VOID_CSR CURSOR FOR                              02280027
               SELECT  M.XFER_DKEY_ID                                   02290027
                      ,M.FR_STR_NBR                                     02300027
                      ,M.XFER_SEQ_NBR                                   02310027
                      ,M.TO_STR_NBR                                     02320027
                      ,S.XFER_STAT_TMST                                 02330027
                      ,S.XFER_STAT_CDE                                  02340027
                 FROM  TTFMSTR M                                        02350027
                      ,TTFSTAT S                                        02360027
                 WHERE  S.XFER_DKEY_ID      = M.XFER_DKEY_ID        AND 02370027
                        (M.CMPT_XFER_BEG_TMST BETWEEN :PV-BEG-TMST      02380027
                                                          AND           02390027
                                                      :PV-END-TMST) AND 02400027
111703*                 XFER_TYP_CDE IN (:PC-DEFECTIVES-DAMAGES,        02410028
111703                  XFER_TYP_CDE IN (:PC-DEFECTIVES-DAMAGES-SORT1,  02411029
111703                                   :PC-DEFECTIVES-DAMAGES-SORT2,  02412029
                                         :PC-CALLBACK,                  02420027
                                         :PC-STOCK-BALANCE-CORPORATE,   02430027
                                         :PC-STOCK-BALANCE-STORE,       02440027
                                         :PC-CUSTOMER)              AND 02450027
                 S.XFER_STAT_TMST =                                     02460027
                       (SELECT MAX(XFER_STAT_TMST)                      02470027
                        FROM   TTFSTAT                                  02480027
                        WHERE  XFER_DKEY_ID   = M.XFER_DKEY_ID      AND 02490027
                               XFER_STAT_CDE  = :PC-VOIDED)             02500027
           END-EXEC.                                                    02510027
                                                                        02520027
      ******************************************************************02530027
       PROCEDURE DIVISION.                                              02540027
      ******************************************************************02550027
                                                                        02560027
      ******************************************************************02570027
      *  0000-MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM    02580027
      ******************************************************************02590027
       0000-PROGRAM-MAINLINE.                                           02600027
           PERFORM 1000-INITIALIZE.                                     02610027
                                                                        02620027
           PERFORM 2000-CREATE-RECV-XFER-FILE.                          02630027
                                                                        02640027
           PERFORM 9000-EOJ-ROUTINE.                                    02650027
                                                                        02660027
           STOP RUN.                                                    02670027
      *                                                                 02680027
      ******************************************************************02690027
      *  1000-INITIALIZE - OPENS ALL FILES, READS THE PROCESSING DATES  02700027
      *  FILE AND MOVES THE PROCESSING DATES TO THE BEGIN AND END       02710027
      *  TIMESTAMP FIELDS.                                              02720027
      ******************************************************************02730027
       1000-INITIALIZE.                                                 02740027
           OPEN OUTPUT RECEIVED-XFER-FILE                               02750027
                INPUT  PROCESS-DATES-FILE.                              02760027
                                                                        02770027
           PERFORM 7000-READ-PROCESS-DATES-FILE.                        02780027
           DISPLAY 'TF029-PROCESS-DATES-RECORD = '                      02790027
               TF029-PROCESS-DATES-RECORD.                              02800027
           MOVE TF029-PROCESS-START-MONTH    TO PV-BEG-MM.              02810027
           MOVE TF029-PROCESS-START-DAY      TO PV-BEG-DD.              02820027
           MOVE TF029-PROCESS-START-YEAR     TO PV-BEG-YY.              02830027
           MOVE TF029-PROCESS-START-CENTURY  TO PV-BEG-CC.              02840027
           MOVE TF029-PROCESS-END-MONTH      TO PV-END-MM.              02850027
           MOVE TF029-PROCESS-END-DAY        TO PV-END-DD.              02860027
           MOVE TF029-PROCESS-END-YEAR       TO PV-END-YY.              02870027
           MOVE TF029-PROCESS-END-CENTURY    TO PV-END-CC.              02880027
      *                                                                 02890027
      ******************************************************************02900027
      * 2000-CREATE-RECV-XFER-FILE - PROCESS THE RECEIVED TRANSFER      02910027
      * CURSOR AND WRITE THE OUTPUT DATA.                               02920027
      ******************************************************************02930027
       2000-CREATE-RECV-XFER-FILE.                                      02940027
           PERFORM 2010-OPEN-RECV-XFER-CSR.                             02950027
           PERFORM 2050-FETCH-RECV-XFER-CSR.                            02960027
                                                                        02970027
           PERFORM 2020-FILL-RECV-XFER-RECORD                           02980027
               UNTIL PS-END-OF-RECV-XFER-DATA.                          02990027
                                                                        03000027
           PERFORM 2030-CLOSE-RECV-XFER-CSR.                            03010027
                                                                        03020027
           PERFORM 3010-OPEN-VOID-XFER-CSR.                             03030027
           PERFORM 3050-FETCH-VOID-XFER-CSR.                            03040027
                                                                        03050027
           PERFORM 3020-FILL-VOID-XFER-RECORD                           03060027
               UNTIL PS-END-OF-VOID-XFER-DATA.                          03070027
                                                                        03080027
           PERFORM 3030-CLOSE-VOID-XFER-CSR.                            03090027
      *                                                                 03100027
       2010-OPEN-RECV-XFER-CSR.                                         03110027
           EXEC SQL                                                     03120027
               OPEN RECV_CSR                                            03130027
           END-EXEC.                                                    03140027
                                                                        03150027
           EVALUATE TRUE                                                03160027
               WHEN SQLCODE = ZERO                                      03170027
                   CONTINUE                                             03180027
               WHEN SQLWARN0 NOT = SPACES                               03190027
               WHEN SQLCODE < ZERO                                      03200027
               WHEN SQLCODE > ZERO                                      03210027
                   MOVE '2010-OPEN-RECV-XFER-CSR'                       03220027
                       TO PV-PARAGRAPH-NAME                             03230027
                   MOVE 'OPEN THE RECV_CSR'                             03240027
                       TO PV-DB2-OPERATION-ATTEMPTED                    03250027
                   PERFORM 9100-SQL-ABEND                               03260027
           END-EVALUATE.                                                03270027
      *                                                                 03280027
       2020-FILL-RECV-XFER-RECORD.                                      03290027
           INITIALIZE TF034-RECEIVED-XFER-RECORD.                       03300027
                                                                        03310027
           MOVE TFRCPT-STR-NBR              TO  TF034-RECV-STR-NBR.     03320027
           MOVE TFMSTR-FR-STR-NBR           TO  TF034-FROM-STR-NBR.     03330027
           MOVE TFMSTR-XFER-SEQ-NBR         TO  TF034-XFER-SEQ-NBR.     03340027
           MOVE TFSTAT-XFER-STAT-TMST (1:2) TO  TF034-XFER-RECV-CC.     03350027
           MOVE TFSTAT-XFER-STAT-TMST (3:2) TO  TF034-XFER-RECV-YY.     03360027
           MOVE TFSTAT-XFER-STAT-TMST (6:2) TO  TF034-XFER-RECV-MM.     03370027
           MOVE TFSTAT-XFER-STAT-TMST (9:2) TO  TF034-XFER-RECV-DD.     03380027
           EVALUATE TFSTAT-XFER-STAT-CDE                                03390027
               WHEN PC-ASM-RECEIPT                                      03400027
                   PERFORM 4000-GET-ASSUMPTIVE-TOTALS                   03410027
                   SET TF034-AR              TO TRUE                    03420027
               WHEN OTHER                                               03430027
                   PERFORM 5000-GET-RECEIPT-TOTALS                      03440027
                   EVALUATE TFRCPT-BYP-DTL-CK-IND                       03450027
                       WHEN PC-YES                                      03460027
                           SET TF034-PR-AND-NO-DTL-CHK TO TRUE          03470027
                           MOVE TFRCPT-RCVR-INIT-1ST-NM     TO          03480027
                                       TF034-RECV-BY-1ST-INIT-NAME      03490027
                           MOVE TFRCPT-RCVR-LAST-NM         TO          03500027
                                       TF034-RECV-BY-LAST-NAME          03510027
                       WHEN OTHER                                       03520027
                           SET TF034-PR-AND-DTL-CHK    TO TRUE          03530027
                   END-EVALUATE                                         03540027
           END-EVALUATE.                                                03550027
           MOVE PV-XFER-QTY                 TO  TF034-XFER-TOT-UNITS.   03560027
           MOVE PV-XFER-PRICE               TO  TF034-XFER-TOT-RETAIL.  03570027
                                                                        03580027
           PERFORM 8000-WRITE-RECV-XFER-FILE.                           03590027
                                                                        03600027
           PERFORM 2050-FETCH-RECV-XFER-CSR.                            03610027
      *                                                                 03620027
       2030-CLOSE-RECV-XFER-CSR.                                        03630027
           EXEC SQL                                                     03640027
               CLOSE RECV_CSR                                           03650027
           END-EXEC.                                                    03660027
                                                                        03670027
           EVALUATE TRUE                                                03680027
               WHEN SQLWARN0 NOT = SPACES                               03690027
               WHEN SQLCODE < ZERO                                      03700027
               WHEN SQLCODE > ZERO                                      03710027
                   MOVE '2030-CLOSE-RECV-XFER-CSR'                      03720027
                       TO PV-PARAGRAPH-NAME                             03730027
                   MOVE 'CLOSE THE RECV_CSR'                            03740027
                       TO PV-DB2-OPERATION-ATTEMPTED                    03750027
                   PERFORM 9100-SQL-ABEND                               03760027
               WHEN SQLCODE = ZERO                                      03770027
                   CONTINUE                                             03780027
           END-EVALUATE.                                                03790027
      *                                                                 03800027
       2050-FETCH-RECV-XFER-CSR.                                        03810027
           INITIALIZE DCLTTFMSTR                                        03820027
                      DCLTTFSTAT                                        03830027
                      DCLTTFRCPT.                                       03840027
                                                                        03850027
           EXEC SQL                                                     03860027
               FETCH  RECV_CSR                                          03870027
                INTO  :TFMSTR-XFER-DKEY-ID                              03880027
                     ,:TFMSTR-FR-STR-NBR                                03890027
                     ,:TFMSTR-XFER-SEQ-NBR                              03900027
                     ,:TFSTAT-XFER-STAT-TMST                            03910027
                     ,:TFSTAT-XFER-STAT-CDE                             03920027
                     ,:TFRCPT-STR-NBR                                   03930027
                     ,:TFRCPT-BYP-DTL-CK-IND                            03940027
                     ,:TFRCPT-RCVR-INIT-1ST-NM                          03950027
                     ,:TFRCPT-RCVR-LAST-NM                              03960027
           END-EXEC.                                                    03970027
                                                                        03980027
           EVALUATE TRUE                                                03990027
               WHEN SQLCODE = ZERO                                      04000027
                   CONTINUE                                             04010027
               WHEN SQLCODE = +100                                      04020027
                   SET PS-END-OF-RECV-XFER-DATA   TO  TRUE              04030027
               WHEN SQLWARN0 NOT = SPACES                               04040027
               WHEN SQLCODE < ZERO                                      04050027
               WHEN SQLCODE > ZERO                                      04060027
                   MOVE '2050-FETCH-RECV-XFER-CSR'                      04070027
                       TO PV-PARAGRAPH-NAME                             04080027
                   MOVE 'FETCH THE RECV_CSR'                            04090027
                       TO PV-DB2-OPERATION-ATTEMPTED                    04100027
                   PERFORM 9100-SQL-ABEND                               04110027
           END-EVALUATE.                                                04120027
      *                                                                 04130027
       3010-OPEN-VOID-XFER-CSR.                                         04140027
           EXEC SQL                                                     04150027
               OPEN VOID_CSR                                            04160027
           END-EXEC.                                                    04170027
                                                                        04180027
           EVALUATE TRUE                                                04190027
               WHEN SQLCODE = ZERO                                      04200027
                   CONTINUE                                             04210027
               WHEN SQLWARN0 NOT = SPACES                               04220027
               WHEN SQLCODE < ZERO                                      04230027
               WHEN SQLCODE > ZERO                                      04240027
                   MOVE '3010-OPEN-VOID-XFER-CSR'                       04250027
                       TO PV-PARAGRAPH-NAME                             04260027
                   MOVE 'OPEN THE VOID_CSR'                             04270027
                       TO PV-DB2-OPERATION-ATTEMPTED                    04280027
                   PERFORM 9100-SQL-ABEND                               04290027
           END-EVALUATE.                                                04300027
      *                                                                 04310027
       3020-FILL-VOID-XFER-RECORD.                                      04320027
           INITIALIZE TF034-RECEIVED-XFER-RECORD.                       04330027
                                                                        04340027
           MOVE TFMSTR-TO-STR-NBR           TO  TF034-RECV-STR-NBR.     04350027
           MOVE TFMSTR-FR-STR-NBR           TO  TF034-FROM-STR-NBR.     04360027
           MOVE TFMSTR-XFER-SEQ-NBR         TO  TF034-XFER-SEQ-NBR.     04370027
           MOVE TFSTAT-XFER-STAT-TMST (1:2) TO  TF034-XFER-RECV-CC.     04380027
           MOVE TFSTAT-XFER-STAT-TMST (3:2) TO  TF034-XFER-RECV-YY.     04390027
           MOVE TFSTAT-XFER-STAT-TMST (6:2) TO  TF034-XFER-RECV-MM.     04400027
           MOVE TFSTAT-XFER-STAT-TMST (9:2) TO  TF034-XFER-RECV-DD.     04410027
           PERFORM 4000-GET-ASSUMPTIVE-TOTALS.                          04420027
           SET TF034-VOIDED                 TO TRUE.                    04430027
           MOVE PV-XFER-QTY                 TO  TF034-XFER-TOT-UNITS.   04440027
           MOVE PV-XFER-PRICE               TO  TF034-XFER-TOT-RETAIL.  04450027
                                                                        04460027
           PERFORM 8000-WRITE-RECV-XFER-FILE.                           04470027
                                                                        04480027
           PERFORM 3050-FETCH-VOID-XFER-CSR.                            04490027
      *                                                                 04500027
       3030-CLOSE-VOID-XFER-CSR.                                        04510027
           EXEC SQL                                                     04520027
               CLOSE VOID_CSR                                           04530027
           END-EXEC.                                                    04540027
                                                                        04550027
           EVALUATE TRUE                                                04560027
               WHEN SQLWARN0 NOT = SPACES                               04570027
               WHEN SQLCODE < ZERO                                      04580027
               WHEN SQLCODE > ZERO                                      04590027
                   MOVE '3030-CLOSE-VOID-XFER-CSR'                      04600027
                       TO PV-PARAGRAPH-NAME                             04610027
                   MOVE 'CLOSE THE VOID_CSR'                            04620027
                       TO PV-DB2-OPERATION-ATTEMPTED                    04630027
                   PERFORM 9100-SQL-ABEND                               04640027
               WHEN SQLCODE = ZERO                                      04650027
                   CONTINUE                                             04660027
           END-EVALUATE.                                                04670027
      *                                                                 04680027
       3050-FETCH-VOID-XFER-CSR.                                        04690027
           INITIALIZE DCLTTFMSTR                                        04700027
                      DCLTTFSTAT.                                       04710027
                                                                        04720027
           EXEC SQL                                                     04730027
               FETCH  VOID_CSR                                          04740027
                INTO  :TFMSTR-XFER-DKEY-ID                              04750027
                     ,:TFMSTR-FR-STR-NBR                                04760027
                     ,:TFMSTR-XFER-SEQ-NBR                              04770027
                     ,:TFMSTR-TO-STR-NBR                                04780027
                     ,:TFSTAT-XFER-STAT-TMST                            04790027
                     ,:TFSTAT-XFER-STAT-CDE                             04800027
           END-EXEC.                                                    04810027
                                                                        04811027
           EVALUATE TRUE                                                04812027
               WHEN SQLCODE = ZERO                                      04813027
                   CONTINUE                                             04814027
               WHEN SQLCODE = +100                                      04815027
                   SET PS-END-OF-VOID-XFER-DATA   TO  TRUE              04816027
               WHEN SQLWARN0 NOT = SPACES                               04817027
               WHEN SQLCODE < ZERO                                      04818027
               WHEN SQLCODE > ZERO                                      04819027
                   MOVE '3050-FETCH-RECV-XFER-CSR'                      04819127
                       TO PV-PARAGRAPH-NAME                             04819227
                   MOVE 'FETCH THE VOID_CSR'                            04819327
                       TO PV-DB2-OPERATION-ATTEMPTED                    04819427
                   PERFORM 9100-SQL-ABEND                               04819527
           END-EVALUATE.                                                04819627
      *                                                                 04820027
      *----------------------------------------------------------------*04830027
      *  GET THE TOTAL XFER QTY & PRICE.                               *04840027
      *----------------------------------------------------------------*04850027
       4000-GET-ASSUMPTIVE-TOTALS.                                      04860027
           PERFORM WITH TEST AFTER                                      04870027
               VARYING PV-RETRY-COUNTER FROM 1 BY 1                     04880027
                 UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                04890027
                    OR SQLCODE = ZERO                                   04900027
                    OR SQLCODE = +100                                   04910027
               EXEC SQL                                                 04920027
                   SELECT SUM(XFER_PRIC_AMT * XFER_QTY)                 04930027
                         ,SUM(XFER_QTY)                                 04940027
                       INTO :PV-XFER-PRICE                              04950027
                            :PV-XFER-PRICE-IND                          04960027
                           ,:PV-XFER-QTY                                04970027
                            :PV-XFER-QTY-IND                            04980027
                       FROM TTFITEM                                     04990027
                       WHERE XFER_DKEY_ID  = :TFMSTR-XFER-DKEY-ID       05000027
               END-EXEC                                                 05010027
               EVALUATE TRUE                                            05020027
                   WHEN SQLCODE = ZERO                                  05030027
                   WHEN SQLCODE = +100                                  05040027
                   WHEN SQLCODE = -904                                  05050027
                   WHEN SQLCODE = -913                                  05060027
                       CONTINUE                                         05070027
                   WHEN SQLWARN0 NOT = SPACES                           05080027
                   WHEN SQLCODE < ZERO                                  05090027
                   WHEN SQLCODE > ZERO                                  05100027
                       MOVE '4000-GET-ASSUMPTIVE-TOTALS'                05110027
                                         TO PV-PARAGRAPH-NAME           05120027
                       MOVE 'SUMMARIZE DATA FROM TTFITEM'               05130027
                                         TO PV-DB2-OPERATION-ATTEMPTED  05140027
                       PERFORM 9100-SQL-ABEND                           05150027
               END-EVALUATE                                             05160027
           END-PERFORM.                                                 05170027
           IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        05180027
               MOVE '4000-GET-ASSUMPTIVE-TOTALS'                        05190027
                                         TO PV-PARAGRAPH-NAME           05200027
               MOVE 'MAXIMUM RETRIES EXCEEDED READING TOTALS'           05210027
                                         TO PV-DB2-OPERATION-ATTEMPTED  05220027
               PERFORM 9100-SQL-ABEND                                   05230027
           END-IF.                                                      05240027
           IF PV-XFER-PRICE-IND < 0                                     05250027
               MOVE ZEROES               TO PV-XFER-PRICE               05260027
           END-IF.                                                      05270027
           IF PV-XFER-QTY-IND < 0                                       05280027
               MOVE ZEROES               TO PV-XFER-QTY                 05290027
           END-IF.                                                      05300027
      *----------------------------------------------------------------*05310027
      *  GET THE TOTAL RECEIVED QTY AND PRICE.                         *05320027
      *----------------------------------------------------------------*05330027
       5000-GET-RECEIPT-TOTALS.                                         05340027
           PERFORM WITH TEST AFTER                                      05350027
               VARYING PV-RETRY-COUNTER FROM 1 BY 1                     05360027
                 UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                05370027
                    OR SQLCODE = ZERO                                   05380027
                    OR SQLCODE = +100                                   05390027
               EXEC SQL                                                 05400027
                   SELECT SUM(RCVD_XFER_PRIC_AMT * RCVD_XFER_QTY)       05410027
                         ,SUM(RCVD_XFER_QTY)                            05420027
                       INTO :PV-XFER-PRICE                              05430027
                            :PV-XFER-PRICE-IND                          05440027
                           ,:PV-XFER-QTY                                05450027
                            :PV-XFER-QTY-IND                            05460027
                       FROM TTFITRC                                     05470027
                       WHERE XFER_DKEY_ID  = :TFMSTR-XFER-DKEY-ID       05480027
               END-EXEC                                                 05490027
               EVALUATE TRUE                                            05500027
                   WHEN SQLCODE = ZERO                                  05510027
                   WHEN SQLCODE = +100                                  05520027
                   WHEN SQLCODE = -904                                  05530027
                   WHEN SQLCODE = -913                                  05540027
                       CONTINUE                                         05550027
                   WHEN SQLWARN0 NOT = SPACES                           05560027
                   WHEN SQLCODE < ZERO                                  05570027
                   WHEN SQLCODE > ZERO                                  05580027
                       MOVE '5000-GET-RECEIPT-TOTALS'                   05590027
                                         TO PV-PARAGRAPH-NAME           05600027
                       MOVE 'SUMMARIZE DATA FROM TTFITRC'               05610027
                                         TO PV-DB2-OPERATION-ATTEMPTED  05620027
                       PERFORM 9100-SQL-ABEND                           05630027
               END-EVALUATE                                             05640027
           END-PERFORM.                                                 05650027
           IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        05660027
               MOVE '5000-GET-RECEIPT-TOTALS'                           05670027
                                         TO PV-PARAGRAPH-NAME           05680027
               MOVE 'MAXIMUM RETRIES EXCEEDED READING TOTALS'           05690027
                                         TO PV-DB2-OPERATION-ATTEMPTED  05700027
               PERFORM 9100-SQL-ABEND                                   05710027
           END-IF.                                                      05720027
           IF PV-XFER-PRICE-IND < 0                                     05730027
               MOVE ZEROES               TO PV-XFER-PRICE               05740027
           END-IF.                                                      05750027
           IF PV-XFER-QTY-IND < 0                                       05760027
               MOVE ZEROES               TO PV-XFER-QTY                 05770027
           END-IF.                                                      05780027
      *----------------------------------------------------------------*05790027
      *  READ THE PROCESS DATES FILE FOR BEGIN AND END DATES           *05800027
      *----------------------------------------------------------------*05810027
       7000-READ-PROCESS-DATES-FILE.                                    05820027
           READ PROCESS-DATES-FILE                                      05830027
               INTO TF029-PROCESS-DATES-RECORD                          05840027
           END-READ.                                                    05850027
      *                                                                 05860027
       8000-WRITE-RECV-XFER-FILE.                                       05870027
           WRITE RECEIVED-XFER-RECORD                                   05880027
               FROM TF034-RECEIVED-XFER-RECORD                          05890027
           END-WRITE.                                                   05900027
      *                                                                 05910027
       9000-EOJ-ROUTINE.                                                05920027
           CLOSE RECEIVED-XFER-FILE                                     05930027
                 PROCESS-DATES-FILE.                                    05940027
      *                                                                 05950027
      ******************************************************************05960027
      *  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    05970027
      *  ERROR OR WARNING CODE OCCURS.                                  05980027
      ******************************************************************05990027
       9100-SQL-ABEND.                                                  06000027
           DISPLAY '** ABEND     **'.                                   06010027
           DISPLAY '** PROGRAM   ** = TFKUT489'.                        06020027
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06030027
           DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     06040027
                                                                        06050027
      ******************************************************************06060027
      * THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    06070027
      * MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         06080027
      * 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     06090027
      * FORMAT.                                                         06100027
      ******************************************************************06110027
           COPY DPPD004.                                                06120027
                                                                        06130027
           MOVE +4013  TO  ABEND-CODE.                                  06140027
           CALL 'ILBOABN0' USING ABEND-CODE.                            06150027
