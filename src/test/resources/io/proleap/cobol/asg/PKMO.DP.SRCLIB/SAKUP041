000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.      SAKUP041.                                       00030000
000400 AUTHOR.          DAVID WELLER.                                   00040000
000500 INSTALLATION.    KOHLS DEPARTMENT STORES.                        00050000
000600 DATE-WRITTEN.    08/23/13.                                       00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*  MODULE TYPE:   COBOL2 DB2 BATCH.                               00100000
001100*                                                                 00110000
001200*  DESCRIPTION: PROGRAM UPDATES THE TSAADSU TABLE WITH THE DATA   00120000
001300*               PULLED IN PROGRAM SAKUT114                        00130000
001400*                                                                 00140000
C53632*========================== CHANGE LOG ===========================00150000
C53632*  AUTH        BY           DATE    DESCRIPTION                   00160006
C53632*=================================================================00170000
C53632* CHG53632    TKMA602     08-23-13  CREATE PROGRAM                00180006
C53632*                                                                 00190000
260107* CHG0260107  JIM HUNTER  08-19-21  ADD COPYBOOK DPWS991 TO MAKE  00191006
260107*                                   THE CALL TO DPKUT901 DYNAMIC. 00192006
C53632*                                                                 00193008
PAYVEN* CHG0289270  JIM HUNTER  06-01-23  FIXING THE DOUBLE COUNTING OF 00194008
PAYVEN*                                   INSERTS FOUND WHILE DOING     00195008
PAYVEN*                                   PAYPAL AND VENMO TESTING.     00196008
C53632******************************************************************00200000
002100                                                                  00210000
002200 ENVIRONMENT DIVISION.                                            00220000
002300 CONFIGURATION SECTION.                                           00230000
002400                                                                  00240000
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250000
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260000
002700                                                                  00270000
002800 INPUT-OUTPUT SECTION.                                            00280000
002900 FILE-CONTROL.                                                    00290000
003000                                                                  00300000
003100 DATA DIVISION.                                                   00310000
003200 FILE SECTION.                                                    00320000
003300                                                                  00330000
003400                                                                  00340000
003500***************************************************************** 00350000
003600*                       WORKING STORAGE                           00360000
003700***************************************************************** 00370000
003800 WORKING-STORAGE SECTION.                                         00380000
003900                                                                  00390000
004000 01  W-START                          PIC  X(40)                  00400000
004100     VALUE 'SAKUP041 - WORKING STORAGE BEGINS HERE'.              00410000
004200                                                                  00420000
004300                                                                  00430000
004400***************************************************************** 00440000
004500*                         SWITCHES                                00450000
004600***************************************************************** 00460000
004700 01  PROGRAM-SWITCHES.                                            00470000
004800     05  PS-RESTART-REQUIRED-SW       PIC  X(01) VALUE 'N'.       00480000
004900         88  PS-RESTART-REQUIRED                 VALUE 'Y'.       00490000
005000         88  PS-RESTART-NOT-REQUIRED             VALUE 'N'.       00500000
005100                                                                  00510000
005200******************************************************************00520000
005300*                       ACCUMULATORS                              00530000
005400******************************************************************00540000
005500 01  PROGRAM-ACCUM.                                               00550000
005600     05  PA-READ                      PIC  9(11) VALUE ZEROS.     00560000
005700                                                                  00570000
005800******************************************************************00580000
005900*                           CONSTANTS                             00590000
006000******************************************************************00600000
006100 01  PROGRAM-CONSTANTS.                                           00610000
006200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00620000
006300                                                 COMP SYNC.       00630000
006400     05  PC-MAX-DEADLOCKS             PIC S9(04) VALUE +3         00640000
006500                                                 COMP SYNC.       00650000
006600                                                                  00660000
006700     05  PC-CKPT-JOB-NAME             PIC  X(08) VALUE 'SAK135  '.00670005
006800     05  PC-CKPT-PLAN-NAME            PIC  X(08) VALUE 'SAKUP041'.00680000
006900     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'SAKUP041'.00690000
007000                                                                  00700000
007100     05  PC-TRAN-PRES-FUNC-CODES.                                 00710000
007200         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05) VALUE 'OPEN '.   00720000
007300         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05) VALUE 'TRANS'.   00730000
007400         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05) VALUE 'RSTRT'.   00740000
007500         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05) VALUE 'CLOSE'.   00750000
007600                                                                  00760000
007700     05  PC-MINUS-ONE                 PIC S9(01) VALUE -1.        00770000
007800     05  PC-SYSTEM                    PIC  X(08) VALUE 'SYSTEM  '.00780000
007900                                                                  00790000
008000******************************************************************00800000
008100*                          VARIABLES                              00810000
008200******************************************************************00820000
008300 01  PROGRAM-VARIABLES.                                           00830000
008400     05  PV-SQL-SUB                   PIC  9(03) VALUE ZERO.      00840000
008500     05  PV-DEADLOCK-COUNTER          PIC  9(03) VALUE ZERO.      00850000
008600     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00860000
008700     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30) VALUE SPACE.     00870000
008800     05  PV-OPERATION-MSG             PIC  X(35) VALUE SPACE.     00880000
008900     05  PV-RET-CODE                  PIC  9(04) VALUE ZEROS.     00890000
009000                                                                  00900000
009100******************************************************************00910000
009200*               SYSTEM TIME AND DATE VARIABLES                    00920000
009300******************************************************************00930000
009400 01  SYS-DATE-TIME.                                               00940000
009500     05  SYS-DATE                     PIC  X(08) VALUE SPACES.    00950000
009600     05  SYS-TIME                     PIC  X(08) VALUE SPACES.    00960000
009700                                                                  00970000
009800 01  ST-BEG-TIME.                                                 00980000
009900     05  ST-BEG-HR                    PIC  9(02) VALUE ZEROS.     00990000
010000     05  FILLER                       PIC  X(01) VALUE ':'.       01000000
010100     05  ST-BEG-MN                    PIC  9(02) VALUE ZEROS.     01010000
010200                                                                  01020000
010300 01  ST-END-TIME.                                                 01030000
010400     05  ST-END-HR                    PIC  9(02) VALUE ZEROS.     01040000
010500     05  FILLER                       PIC  X(01) VALUE ':'.       01050000
010600     05  ST-END-MN                    PIC  9(02) VALUE ZEROS.     01060000
010700                                                                  01070000
010800 01  SD-EDIT-DATE.                                                01080000
010900     05  SD-MONTH                     PIC  9(02) VALUE ZEROS.     01090000
011000     05  FILLER                       PIC  X(01) VALUE '-'.       01100000
011100     05  SD-DAY                       PIC  9(02) VALUE ZEROS.     01110000
011200     05  FILLER                       PIC  X(01) VALUE '-'.       01120000
011300     05  SD-CENT                      PIC  9(02) VALUE ZEROS.     01130000
011400     05  SD-YEAR                      PIC  9(02) VALUE ZEROS.     01140000
011500                                                                  01150000
011600******************************************************************01160000
011700*                        ERROR HANDLING                           01170000
011800******************************************************************01180000
011900 01  ABEND-CODE                       PIC S9(04) VALUE ZEROS      01190000
012000                                                 COMP SYNC.       01200000
012100     88  ABEND-4002-READ-ERROR                   VALUE +4002.     01210000
012200     88  ABEND-4013-DB2-ERROR                    VALUE +4013.     01220000
012300     88  ABEND-4019-CAL-SUB-ERROR                VALUE +4019.     01230000
012400                                                                  01240000
012500                                                                  01250000
012600******************************************************************01260000
012700*  TSAADSU - STORE TOTALS RECORD LAYOUT                           01270000
012800******************************************************************01280000
012900     COPY SARD007.                                                01290000
013000                                                                  01300000
013100******************************************************************01310000
013200*  DB2 FORMATTED ERROR MESSAGE                                    01320000
013300******************************************************************01330000
013400     COPY DPWS004.                                                01340000
013500                                                                  01350000
013600******************************************************************01360000
013700*  SQL COMMUNICATIONS WORK AREA                                   01370000
013800******************************************************************01380000
013900     COPY SQLCA2.                                                 01390000
014000                                                                  01400000
014100******************************************************************01410000
014200*  COMMUNICATIONS AREA FOR DB2                                    01420000
014300******************************************************************01430000
014400     EXEC SQL                                                     01440000
014500         INCLUDE SQLCA                                            01450000
014600     END-EXEC.                                                    01460000
014700                                                                  01470000
014800******************************************************************01480000
014900*  DB2 TABLE TSAADSU - STORE TOTALS TABLE                         01490000
015000******************************************************************01500000
015100     EXEC SQL                                                     01510000
015200          INCLUDE TSAADSU                                         01520000
015300     END-EXEC.                                                    01530000
015400                                                                  01540000
015500******************************************************************01550000
015600*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA             01560000
015700******************************************************************01570000
260107     COPY DPWS991.                                                01580006
015800                                                                  01581006
015800     COPY DPLS001.                                                01582006
015900     05  WORK-STORAGE-PASSED.                                     01590000
016000******************************************************************01600000
016100*PA - PROGRAM ACCUMULATORS                                        01610000
016200******************************************************************01620000
016300         10  PROGRAM-ACCUMULATORS.                                01630000
016400             15  PA-ROWS-INSERTED PIC S9(11)           VALUE ZERO 01640000
016500                                                       COMP-3.    01650000
016600                                                                  01660000
016400             15  PA-ROWS-UPDATED  PIC S9(11)           VALUE ZERO 01661001
016500                                                       COMP-3.    01662001
016600                                                                  01663001
044600                                                                  01665003
016700 01  FILLER                          PIC X(4096)  VALUE SPACE.    01670000
016800                                                                  01680000
016900                                                                  01690000
017000                                                                  01700000
017100 PROCEDURE DIVISION.                                              01710000
017200******************************************************************01720000
017300* MAINLINE-PROCESSING                                             01730000
017400******************************************************************01740000
017500                                                                  01750000
017600     PERFORM A100-INITIALIZE.                                     01760000
017700                                                                  01770000
017800     PERFORM B100-PROCESS-UPDATE-RECORDS                          01780000
017900       UNTIL DP001-PREP-TRANS-EOF.                                01790000
018000                                                                  01800000
018100     PERFORM Z990-EOJ-ROUTINE.                                    01810000
018200                                                                  01820000
018300     GOBACK.                                                      01830000
018400                                                                  01840000
018500                                                                  01850000
018600******************************************************************01860000
018700* PREFORMS TASK INITIATION                                        01870000
018800******************************************************************01880000
018900 A100-INITIALIZE.                                                 01890000
019000                                                                  01900000
019100     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 01910000
019200                                                                  01920000
019300     MOVE SYS-TIME (1:2) TO ST-BEG-HR.                            01930000
019400     MOVE SYS-TIME (3:2) TO ST-BEG-MN.                            01940000
019500                                                                  01950000
019600     MOVE SYS-DATE (1:2) TO SD-CENT.                              01960000
019700     MOVE SYS-DATE (3:2) TO SD-YEAR.                              01970000
019800     MOVE SYS-DATE (5:2) TO SD-MONTH.                             01980000
019900     MOVE SYS-DATE (7:2) TO SD-DAY.                               01990000
020000                                                                  02000000
020100     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              02010000
020200                                                                  02020000
020300     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02030000
020400                                                                  02040000
020500                                                                  02050000
020600******************************************************************02060000
020700* PROCESS UPDATE RECORDS                                          02070000
020800******************************************************************02080000
020900 B100-PROCESS-UPDATE-RECORDS.                                     02090000
021000                                                                  02100000
021100     SET PS-RESTART-NOT-REQUIRED TO TRUE.                         02110000
021200                                                                  02120000
021300     PERFORM C100-UPDATE-FIELDS.                                  02130000
021200                                                                  02130103
027000     IF SQLCODE = +100                                            02131003
027000         PERFORM C300-TSAADSU-INSERT                              02133003
027000     END-IF.                                                      02134003
021400                                                                  02140000
021500*----------------------------------------------------------------*02150000
021600*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02160000
021700*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02170000
021800*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02180000
021900*----------------------------------------------------------------*02190000
022000     IF  PS-RESTART-REQUIRED                                      02200000
022100         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02210000
022200     ELSE                                                         02220000
022300         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02230000
022400     END-IF.                                                      02240000
022500                                                                  02250000
022600     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      02260000
022700                                                                  02270000
022800     ADD 1 TO PA-READ.                                            02280000
022900                                                                  02290000
023000                                                                  02300000
023100******************************************************************02310000
023200* UPDATES THE TSAADSU FIELDS                                      02320000
023300******************************************************************02330000
023400 C100-UPDATE-FIELDS.                                              02340000
023500                                                                  02350000
023600     MOVE SA007-SLS-DTE        TO SAADSU-SLS-DTE.                 02360000
023700     MOVE SA007-STR-NBR        TO SAADSU-STR-NBR.                 02370000
023800     MOVE SA007-SUM-CTG-CDE    TO SAADSU-SUM-CTG-CDE.             02380000
023900     MOVE SA007-ORIG-AMT       TO SAADSU-ORIG-AMT.                02390000
024000     MOVE SA007-ADJ-AMT        TO SAADSU-ADJ-AMT.                 02400000
024100     MOVE SA007-ADJ-IND        TO SAADSU-ADJ-IND.                 02410000
024200                                                                  02420000
024300     PERFORM WITH TEST AFTER                                      02430000
024400         VARYING PV-SQL-SUB                                       02440000
024500         FROM 1 BY 1                                              02450000
024600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02460000
024700                OR SQLCODE = -911                                 02470000
024700                OR SQLCODE = +100                                 02471001
024800                OR SQLCODE = 0)                                   02480000
024900                                                                  02490000
025000         EXEC SQL                                                 02500000
025100             UPDATE TSAADSU                                       02510002
025100              SET ORIG_AMT = ORIG_AMT + :SAADSU-ORIG-AMT          02511002
025200                , ADJ_AMT  = ADJ_AMT + :SAADSU-ADJ-AMT            02520002
025200             WHERE SLS_DTE     = :SAADSU-SLS-DTE                  02521001
025200               AND STR_NBR     = :SAADSU-STR-NBR                  02522001
025400               AND SUM_CTG_CDE = :SAADSU-SUM-CTG-CDE              02540001
026500         END-EXEC                                                 02650000
026600                                                                  02660000
026700         EVALUATE TRUE                                            02670000
026800             WHEN SQLCODE = 0                                     02680000
026900                 ADD +1 TO PA-ROWS-UPDATED                        02690003
027000                                                                  02700000
027000             WHEN SQLCODE = +100                                  02702001
PAYVEN                 CONTINUE                                         02702108
027000                                                                  02705001
027100             WHEN SQLCODE = -911                                  02710000
027200                 ADD +1 TO PV-DEADLOCK-COUNTER                    02720000
027300                                                                  02730000
027400                 DISPLAY '                   '                    02740000
027500                 DISPLAY 'DEADLOCK INCOUNTERED -911'              02750000
027600                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER02760000
027700                                                                  02770000
027800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        02780000
027900                     MOVE 'C100-UPDATE-FIELDS'                    02790000
028000                                      TO PV-PARAGRAPH-NAME        02800000
028100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        02810000
028200                                      TO PV-DB2-OPER-ATTEMPTED    02820000
028300                     PERFORM Z200-SQL-ABEND                       02830000
028400                                                                  02840000
028500                 ELSE                                             02850000
028600                     SET PS-RESTART-REQUIRED TO TRUE              02860000
028700                 END-IF                                           02870000
028800                                                                  02880000
028900             WHEN OTHER                                           02890000
029000                 DISPLAY '                   '                    02900000
029100                 DISPLAY 'SQLCODE = ' SQLCODE                     02910000
029200                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     02920000
029300                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      02930000
029400                 DISPLAY '                   '                    02940000
029500                 DISPLAY 'UPDATE ABENDED ON: '                    02950000
029600                 DISPLAY 'SLS-DTE  = ' SAADSU-SLS-DTE             02960000
029700                 DISPLAY 'STR-NBR  = ' SAADSU-STR-NBR             02970000
029800                 DISPLAY 'SUM-CTG  = ' SAADSU-SUM-CTG-CDE         02980000
029900                 DISPLAY 'ORIG-AMT = ' SAADSU-ORIG-AMT            02990000
030000                 DISPLAY 'ADJ-AMT  = ' SAADSU-ADJ-AMT             03000000
030100                 DISPLAY 'ADJ-IND  = ' SAADSU-ADJ-IND             03010000
030200                                                                  03020000
030300                 MOVE 'C100-UPDATE-FIELDS'                        03030000
030400                                        TO PV-PARAGRAPH-NAME      03040000
030500                 MOVE 'TSAADSU INSERT'                            03050000
030600                                        TO PV-DB2-OPER-ATTEMPTED  03060000
030700                                                                  03070000
030800                 PERFORM Z200-SQL-ABEND                           03080000
030900         END-EVALUATE                                             03090000
031000     END-PERFORM.                                                 03100000
031100                                                                  03110000
031100******************************************************************03110101
023200* INSERT THE TSAADSU FIELDS                                       03110203
031100******************************************************************03110301
031100                                                                  03110501
027000 C300-TSAADSU-INSERT.                                             03111001
031200                                                                  03120000
031300     IF PV-SQL-SUB > PC-MAX-RETRIES                               03130000
031400         MOVE 'C300-TSAADSU-INSERT'     TO PV-PARAGRAPH-NAME      03140003
031500         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  03150000
031600         PERFORM Z200-SQL-ABEND                                   03160000
031700     END-IF.                                                      03170000
031800                                                                  03180000
024300     PERFORM WITH TEST AFTER                                      03181001
024400         VARYING PV-SQL-SUB                                       03182001
024500         FROM 1 BY 1                                              03183001
024600         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03184001
024700                OR SQLCODE = -911                                 03185001
024800                OR SQLCODE = 0)                                   03187001
024900                                                                  03188001
025000         EXEC SQL                                                 03189001
025100             INSERT  INTO TSAADSU                                 03189101
025200                  (  SLS_DTE                                      03189201
025300                  ,  STR_NBR                                      03189301
025400                  ,  SUM_CTG_CDE                                  03189401
025500                  ,  ORIG_AMT                                     03189501
025600                  ,  ADJ_AMT                                      03189601
025700                  ,  ADJ_IND)                                     03189701
025800              VALUES                                              03189801
025900                  (  :SAADSU-SLS-DTE                              03189901
026000                  ,  :SAADSU-STR-NBR                              03190001
026100                  ,  :SAADSU-SUM-CTG-CDE                          03190101
026200                  ,  :SAADSU-ORIG-AMT                             03190201
026300                  ,  :SAADSU-ADJ-AMT                              03190301
026400                  ,  :SAADSU-ADJ-IND)                             03190401
026500         END-EXEC                                                 03190501
026600                                                                  03190601
026700         EVALUATE TRUE                                            03190701
026800             WHEN SQLCODE = 0                                     03190801
026900                 ADD +1 TO PA-ROWS-INSERTED                       03190901
027000                                                                  03191001
027100             WHEN SQLCODE = -911                                  03191101
027200                 ADD +1 TO PV-DEADLOCK-COUNTER                    03191201
027300                                                                  03191301
027400                 DISPLAY '                   '                    03191401
027500                 DISPLAY 'DEADLOCK INCOUNTERED -911'              03191501
027600                 DISPLAY 'DEADLOCK-COUNTER = ' PV-DEADLOCK-COUNTER03191601
027700                                                                  03191701
027800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03191801
027900                     MOVE 'C300-INSERT-FIELDS'                    03191901
028000                                      TO PV-PARAGRAPH-NAME        03192001
028100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03192101
028200                                      TO PV-DB2-OPER-ATTEMPTED    03192201
028300                     PERFORM Z200-SQL-ABEND                       03192301
028400                                                                  03192401
028500                 ELSE                                             03192501
028600                     SET PS-RESTART-REQUIRED TO TRUE              03192601
028700                 END-IF                                           03192701
028800                                                                  03192801
028900             WHEN OTHER                                           03192901
029000                 DISPLAY '                   '                    03193001
029100                 DISPLAY 'SQLCODE = ' SQLCODE                     03193101
029200                 DISPLAY 'DP001-FUNC-CODE = ' DP001-FUNC-CODE     03193201
029300                 DISPLAY 'DP001-RET-CODE  = ' DP001-RET-CODE      03193301
029400                 DISPLAY '                   '                    03193401
029500                 DISPLAY 'INSERT ABENDED ON: '                    03193501
029600                 DISPLAY 'SLS-DTE  = ' SAADSU-SLS-DTE             03193601
029700                 DISPLAY 'STR-NBR  = ' SAADSU-STR-NBR             03193701
029800                 DISPLAY 'SUM-CTG  = ' SAADSU-SUM-CTG-CDE         03193801
029900                 DISPLAY 'ORIG-AMT = ' SAADSU-ORIG-AMT            03193901
030000                 DISPLAY 'ADJ-AMT  = ' SAADSU-ADJ-AMT             03194001
030100                 DISPLAY 'ADJ-IND  = ' SAADSU-ADJ-IND             03194101
030200                                                                  03194201
030300                 MOVE 'C300-INSERT-FIELDS'                        03194301
030400                                        TO PV-PARAGRAPH-NAME      03194401
030500                 MOVE 'TSAADSU INSERT'                            03194501
030600                                        TO PV-DB2-OPER-ATTEMPTED  03194601
030700                                                                  03194701
030800                 PERFORM Z200-SQL-ABEND                           03194801
030900         END-EVALUATE                                             03194901
031000     END-PERFORM.                                                 03195001
031100                                                                  03195101
031200                                                                  03195201
031300     IF PV-SQL-SUB > PC-MAX-RETRIES                               03195301
031400         MOVE 'C300-INSERT-FIELDS'      TO PV-PARAGRAPH-NAME      03195401
031500         MOVE 'VERIFY RETRIES EXCEEDED' TO PV-DB2-OPER-ATTEMPTED  03195501
031600         PERFORM Z200-SQL-ABEND                                   03195601
031700     END-IF.                                                      03195701
031800                                                                  03195801
031900                                                                  03196001
032000******************************************************************03200000
032100* BUILD THE COMMUNICATION AREA FOR A CALL TO THE TRANSACTION      03210000
032200* PRESENTATION MODULE                                             03220000
032300******************************************************************03230000
032400 X100-BUILD-COMM-AREA-TRAN-PRES.                                  03240000
032500                                                                  03250000
032600     MOVE LENGTH OF                                               03260000
032700          WORK-STORAGE-PASSED TO DP001-WORK-STRG-LENGTH.          03270000
032800     MOVE PC-CKPT-JOB-NAME    TO DP001-JOB-NAME.                  03280000
032900     MOVE PC-CKPT-PLAN-NAME   TO DP001-PLAN-NAME.                 03290000
033000                                                                  03300000
033100     PERFORM X200-CALL-TRANS-PRES-MODULE.                         03310000
033200                                                                  03320000
033300     MOVE DP001-TRANS-RECORD  TO SA007-TSAADSU-REC.               03330000
033400                                                                  03340000
033500     IF  DP001-CKPT-TAKEN                                         03350000
033700         DISPLAY '*** CHECKPOINT TAKEN ON REC: '                  03360000
033800                                       PA-ROWS-INSERTED '  '      03370000
033900                                       SAADSU-SUM-CTG-CDE         03380000
033910         DISPLAY '                             '                  03390000
034000         INITIALIZE PV-DEADLOCK-COUNTER                           03400000
034100     END-IF.                                                      03410000
034200                                                                  03420000
034300                                                                  03430000
034400******************************************************************03440000
034500* VERIFY THE RETURN CODE ON THE CALLED MODULE                     03450000
034600******************************************************************03460000
034700 X200-CALL-TRANS-PRES-MODULE.                                     03470000
034800                                                                  03480000
034900     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         03490000
035000                                                                  03500000
035100     IF  DP001-GOOD-RET-CODE                                      03510000
035200     OR  DP001-CKPT-TAKEN                                         03520000
035300     OR  DP001-RESTART                                            03530000
035400         CONTINUE                                                 03540000
035500                                                                  03550000
035600     ELSE                                                         03560000
035700         MOVE 'X200-CALL-TRANS-PRES-MODULE' TO PV-PARAGRAPH-NAME  03570000
035800         MOVE '** BAD CALL TO TRANS PREP MODULE **'               03580000
035900                                            TO PV-OPERATION-MSG   03590000
036000         MOVE DP001-RET-CODE                TO PV-RET-CODE        03600000
036100                                                                  03610000
036200         SET ABEND-4019-CAL-SUB-ERROR TO TRUE                     03620000
036300                                                                  03630000
036400         PERFORM Z100-ABEND                                       03640000
036500     END-IF.                                                      03650000
036600                                                                  03660000
036700                                                                  03670000
036800******************************************************************03680000
036900* NON-DB2 ABEND                                                   03690000
037000******************************************************************03700000
037100 Z100-ABEND.                                                      03710000
037200                                                                  03720000
037300     PERFORM Z999-CONTROLS.                                       03730000
037400                                                                  03740000
037500     DISPLAY '                     '.                             03750000
037600     DISPLAY '** ABEND           **'.                             03760000
037700     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          03770000
037800     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        03780000
037900     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG.         03790000
038000     DISPLAY '** RETURN CODE     ** = ' PV-RET-CODE.              03800000
038100                                                                  03810000
038200     CALL 'ILBOABN0' USING ABEND-CODE.                            03820000
038300                                                                  03830000
038400                                                                  03840000
038500******************************************************************03850000
038600* ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING      03860000
038700* CODE OCCURS.                                                    03870000
038800******************************************************************03880000
038900 Z200-SQL-ABEND.                                                  03890000
039000                                                                  03900000
039100     PERFORM Z999-CONTROLS.                                       03910000
039200                                                                  03920000
039300     DISPLAY '** ABEND     **'.                                   03930000
039400     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                03940000
039500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03950000
039600     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          03960000
039700                                                                  03970000
039800******************************************************************03980000
039900* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    03990000
040000* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04000000
040100* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04010000
040200* FORMAT.                                                         04020000
040300******************************************************************04030000
040400     COPY DPPD004.                                                04040000
040500                                                                  04050000
040600     SET ABEND-4013-DB2-ERROR TO TRUE.                            04060000
040700                                                                  04070000
040800     CALL 'ILBOABN0' USING ABEND-CODE.                            04080000
040900                                                                  04090000
041000                                                                  04100000
041100******************************************************************04110000
041200* PREFORMS TASK TERMINATION PROCESSING                            04120000
041300******************************************************************04130000
041400 Z990-EOJ-ROUTINE.                                                04140000
041500                                                                  04150000
041600     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             04160000
041700                                                                  04170000
041800     PERFORM X100-BUILD-COMM-AREA-TRAN-PRES.                      04180000
041900                                                                  04190000
042000     PERFORM Z999-CONTROLS.                                       04200000
042100                                                                  04210000
042200                                                                  04220000
042300******************************************************************04230000
042400* DISPLAY CONTROLS FROM THE PROGRAM                               04240000
042500******************************************************************04250000
042600 Z999-CONTROLS.                                                   04260000
042700                                                                  04270000
042800     MOVE FUNCTION CURRENT-DATE TO SYS-DATE-TIME.                 04280000
042900                                                                  04290000
043000     MOVE SYS-TIME (1:2) TO ST-END-HR.                            04300000
043100     MOVE SYS-TIME (3:2) TO ST-END-MN.                            04310000
043200                                                                  04320000
043300     DISPLAY '                    '.                              04330000
043400     DISPLAY '**********************'.                            04340000
043500     DISPLAY '   SAKUP041 CONTROLS  '.                            04350000
043600     DISPLAY '**********************'.                            04360000
043700     DISPLAY 'RUN DATE  = ' SD-EDIT-DATE.                         04370000
043800     DISPLAY 'BEG TIME  = ' ST-BEG-TIME.                          04380000
043900     DISPLAY 'END TIME  = ' ST-END-TIME.                          04390000
044000     DISPLAY '======================'.                            04400000
044100     DISPLAY 'RECORDS READ  = ' PA-READ.                          04410000
044200     DISPLAY '                '.                                  04420000
044300     DISPLAY 'ROWS UPDATED  = ' PA-ROWS-UPDATED.                  04430003
044400     DISPLAY '                '.                                  04440000
044300     DISPLAY 'ROWS INSERTED = ' PA-ROWS-INSERTED.                 04441003
044400     DISPLAY '                '.                                  04442003
044500                                                                  04450000
044700******************************************************************04470000
044800* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04480000
044900* MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION  04490000
045000* MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.         04500000
045100******************************************************************04510000
045200     COPY DPPD001.                                                04520000
045300                                                                  04530000
045400                                                                  04540000
