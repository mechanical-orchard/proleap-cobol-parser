       IDENTIFICATION DIVISION.                                         00000100
       PROGRAM-ID.    MLKUT423.                                         00000200
       AUTHOR.        PAUL KEBER - STRATAGEM.                           00000300
       INSTALLATION.  KOHLS DEPARTMENT STORES.                          00000400
       DATE-WRITTEN.  12-04-98.                                         00000500
       DATE-COMPILED.                                                   00000600
      ******************************************************************00000700
      *      MLKUT423 - TMNSCLS EXTRACT BY DEPARTMENT/STORE FOR EXCEL   00000803
      ******************************************************************00000900
      *                                                                 00001000
      *  THIS PROGRAM WILL CREATE AN EXTRACT FILE OF TMNSCLS DB2 TABLE  00001100
      *  AMOUNTS FOR EACH DEPARTMENT/STORE COMBINATION FOR THE CURRENT  00001200
      *  MONTH.  IT WILL BE USED AS INPUT TO A JOB WHICH WILL CREATE    00001503
      *  EXCEL FORMAT FILES.                                            00001603
      *                                                                 00001703
      ******************** HISTORY OF CHANGES **************************00001808
      *                                                                *00001908
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00002008
      * -------  ----------  ----------------------------------------  *00002108
      * LY0701   07-20-2001  FIX CURSOR TO ONLY EXTRACT ACTIVE DEPTS   *00002208
      * W26603   03-24-2004  INCREASED PV AMT FIELDS TO REFLECT MLRD117*00002312
      *                      CHANGES.  ADDED WITH UR TO DB2 READS.     *00002412
      ******************************************************************00003003
                                                                        00240000
       ENVIRONMENT DIVISION.                                            00250000
       CONFIGURATION SECTION.                                           00260000
       SOURCE-COMPUTER. IBM-3090.                                       00270000
       OBJECT-COMPUTER. IBM-3090.                                       00280000
                                                                        00290000
       INPUT-OUTPUT SECTION.                                            00300000
       FILE-CONTROL.                                                    00310000
                                                                        00320000
           SELECT TMNSCLS-FILE                                          00330002
               ASSIGN TO OUT01.                                         00340000
                                                                        00350000
       DATA DIVISION.                                                   00360000
       FILE SECTION.                                                    00370000
                                                                        00380000
       FD  TMNSCLS-FILE                                                 00390002
           RECORDING MODE IS F.                                         00400000
                                                                        00410000
       01  TMNSCLS-RECORD              PIC X(85).                       00420002
                                                                        00430000
       EJECT                                                            00440000
                                                                        00450000
       WORKING-STORAGE SECTION.                                         00460000
                                                                        00470000
       01  PS-PROGRAM-SWITCHES.                                         00560000
           05  PS-END-OF-DATA-SW       PIC X     VALUE 'N'.             00600000
               88  PS-END-OF-DATA                VALUE 'Y'.             00610000
               88  PS-NOT-END-OF-DATA            VALUE 'N'.             00620000
                                                                        00630000
       01  PV-PROGRAM-VARIABLES.                                        00640000
           05  PV-TMNSCLS-WRITTEN      PIC S9(9)    VALUE +0 COMP-3.    00660002
           05  PV-C-MO-TMNSCLS-FETCHED PIC S9(9)    VALUE +0 COMP-3.    00670002
W26603     05  PV-NET-XFER-RTL-AMT     PIC S9(11)V99 VALUE +0 COMP-3.   00680012
W26603     05  PV-RCPT-NET-RTL-AMT     PIC S9(11)V99 VALUE +0 COMP-3.   00690012
W26603     05  PV-RCPT-NET-COST-AMT    PIC S9(11)V99 VALUE +0 COMP-3.   00700012
                                                                        00760000
       01 ABEND-AREAS.                                                  01300000
           05 ABEND-CODE               PIC S9(04)  VALUE ZERO           01310000
                                                   COMP SYNC.           01320000
               88  AC-BAD-DATA                     VALUE +4003.         01330000
               88  AC-DB2-ERROR                    VALUE +4013.         01340000
           05  AA-ABEND-LIT            PIC X(40)   VALUE                01350000
                 '*****       ABEND'.                                   01360000
           05  AA-PROGRAM-LIT          PIC X(40)   VALUE                01370000
                   '*****   PROGRAM: MLKUT423'.                         01380001
           05  AA-PARAGRAPH-LIT.                                        01390000
               10  FILLER              PIC X(17)   VALUE                01400000
                   '***** PARAGRAPH: '.                                 01410000
               10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        01420000
           05  AA-MESSAGE-LINE.                                         01430000
               10  FILLER              PIC X(06)   VALUE '*****'.       01440000
               10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        01450000
           05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                01460000
                   '*****    DB2 ERROR'.                                01470000
           05  AA-DB2-OPERATION-LIT.                                    01480000
               10  FILLER              PIC X(17)   VALUE                01490000
                   '***** OPERATION: '.                                 01500000
               10  AA-DB2-OPERATION.                                    01510000
                   15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        01520000
                   15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        01530000
           05  AA-DB2-TABLE-1          PIC X(08)   VALUE SPACES.        01540000
           05  AA-DB2-TABLE-2          PIC X(08)   VALUE SPACES.        01550000
           05  AA-DB2-TABLE-3          PIC X(08)   VALUE SPACES.        01560000
           05  AA-DB2-TABLE-4          PIC X(08)   VALUE SPACES.        01570000
                                                                        01580000
       EJECT                                                            01590000
                                                                        01600000
      *    RECORD LAYOUT FOR THE OUTPUT TMNSCLS EXTRACT FILE.           01610002
                                                                        01620000
           COPY MLRD117.                                                01621002
                                                                        02160000
       EJECT                                                            02170002
                                                                        02180000
      *---------------------------------------------------------------* 02190000
      *    DB2 TABLE DEFINITIONS                                      * 02200000
      *---------------------------------------------------------------* 02210000
                                                                        02220000
      *---------------------------------------------------------------* 02220102
      *    INCLUDE FOR ML DEPARTMENT/SUBCLASS TABLE                   * 02220202
      *---------------------------------------------------------------* 02221002
           EXEC SQL                                                     02250000
               INCLUDE TMNSCLS                                          02260002
           END-EXEC.                                                    02270000
                                                                        02280000
      *---------------------------------------------------------------* 02280102
      *    INCLUDE FOR ML CONTROL TABLE                               * 02280202
      *---------------------------------------------------------------* 02280302
           EXEC SQL                                                     02310000
               INCLUDE TMLCNTL                                          02320002
           END-EXEC.                                                    02330000
                                                                        02520000
LY0701*---------------------------------------------------------------* 02521009
LY0701*    INCLUDE FOR MBS DEPARTMENT TABLE                           * 02522009
LY0701*---------------------------------------------------------------* 02523009
LY0701     EXEC SQL                                                     02524009
LY0701         INCLUDE TMDSEAR                                          02525009
LY0701     END-EXEC.                                                    02526009
LY0701                                                                  02527009
LY0701*---------------------------------------------------------------* 02528009
      *    SQL COMMUNICATIONS AREA DCLGEN                               02530000
                                                                        02540000
           EXEC SQL                                                     02550000
               INCLUDE SQLCA                                            02560000
           END-EXEC.                                                    02570000
                                                                        02580000
      *    ERROR MESSAGE AREA FOR DB2                                   02590000
                                                                        02600000
           COPY DPWS004.                                                02610000
                                                                        02620000
       EJECT                                                            02630000
                                                                        02640000
      ******************************************************************02650000
      *  SQL DB2 TMNSCLS CURSOR DECLARATION                             02660002
      ******************************************************************02670000
           EXEC SQL                                                     02680000
               DECLARE TMNSCLS_CURSOR CURSOR FOR                        02690002
                   SELECT A.DEPT_NBR                                    02700007
                         ,STR_NBR                                       02710002
                         ,SUM(MKDN_RTL_AMT)                             02720002
                         ,SUM(XFER_IN_RTL_AMT - XFER_OUT_RTL_AMT)       02730002
                         ,SUM(RCPT_RTL_AMT + MKUP_RTL_AMT +             02740005
                              PADJ_RTL_AMT)                             02741005
                         ,SUM(RCPT_NET_COST_AMT + PADJ_NET_COST_AMT)    02750006
                         ,SUM(END_INV_RTL_AMT)                          02751002
LY0701             FROM  TMNSCLS A                                      02760007
LY0701                  ,TMDSEAR B                                      02761007
                   WHERE FSCL_MN_NBR     = :MLCNTL-OPN-FSCL-MN-NBR      02780111
                     AND FSCL_MN_END_DTE = :MLCNTL-OPN-FSCL-MN-DTE      02780211
LY0701               AND A.DEPT_NBR      = B.DEPT_NBR                   02780310
LY0701               AND OPERCO_NBR      = '03'                         02780410
LY0701               AND MDSELV_CDE      = 'DPT'                        02781007
LY0701               AND CURRENT DATE BETWEEN STRT_DTE AND END_DTE      02783011
LY0701             GROUP BY A.DEPT_NBR,                                 02790007
                            STR_NBR                                     02791002
               FOR FETCH ONLY                                           02800000
W26603         WITH UR                                                  02801012
           END-EXEC.                                                    02810000
                                                                        02820000
       EJECT                                                            02830000
                                                                        02840000
      ******************************************************************02850000
       PROCEDURE DIVISION.                                              02860000
      ******************************************************************02870000
                                                                        02880000
      ******************************************************************02890000
       0000-MAINLINE-MLKUT423.                                          02900001
      ******************************************************************02910000
      *                                                                 02920000
           PERFORM 1000-INITIALIZATION.                                 02930000
                                                                        02940000
           PERFORM 2000-MAIN-PROCESS                                    02950000
               UNTIL PS-END-OF-DATA.                                    02960000
                                                                        02970000
           PERFORM 8000-EOJ.                                            02980000
                                                                        02990000
           GOBACK.                                                      03000000
                                                                        03010000
       EJECT                                                            03020000
                                                                        03030000
      ******************************************************************03040000
       1000-INITIALIZATION.                                             03050000
      ******************************************************************03060000
      *                                                                 03070000
           OPEN OUTPUT TMNSCLS-FILE.                                    03080002
                                                                        03090000
           PERFORM 7000-SELECT-TMLCNTL.                                 03100002
                                                                        03110000
           DISPLAY ' '.                                                 03160000
           DISPLAY '*** OPEN FISCAL DATES USED ARE:  '                  03170000
           DISPLAY '      MNSCLS-OPN-FSCL-MN-DTE = '                    03180002
             MLCNTL-OPN-FSCL-MN-DTE.                                    03190002
           DISPLAY '      MNSCLS-OPN-FSCL-MN-NBR = '                    03200002
             MLCNTL-OPN-FSCL-MN-NBR.                                    03210002
                                                                        03220000
           PERFORM 7100-OPEN-TMNSCLS-CURSOR.                            03330002
           PERFORM 7110-FETCH-TMNSCLS.                                  03331002
                                                                        03340000
       EJECT                                                            03350000
                                                                        03360000
      ******************************************************************03370000
       2000-MAIN-PROCESS.                                               03380000
      ******************************************************************03390000
      *                                                                 03400000
           PERFORM 5000-CREATE-OUTPUT.                                  03421002
           PERFORM 7110-FETCH-TMNSCLS.                                  03430002
                                                                        03440000
       EJECT                                                            03600000
                                                                        03610000
      ******************************************************************03700000
       5000-CREATE-OUTPUT.                                              03710000
      ******************************************************************03720000
      *                                                                 03730000
           MOVE MNSCLS-STR-NBR         TO ML117-STR-NBR                 03750002
           MOVE MNSCLS-DEPT-NBR        TO ML117-DEPT-NBR                03750102
           MOVE MNSCLS-MKDN-RTL-AMT    TO ML117-MKDN-RTL-AMT            03751002
           MOVE PV-NET-XFER-RTL-AMT    TO ML117-NET-XFER-RTL-AMT        03752002
           MOVE PV-RCPT-NET-RTL-AMT    TO ML117-RCPT-NET-RTL-AMT        03753005
           ADD  PV-NET-XFER-RTL-AMT    TO ML117-RCPT-NET-RTL-AMT        03753105
           MOVE PV-RCPT-NET-COST-AMT   TO ML117-RCPT-NET-COST-AMT       03754106
           MOVE MNSCLS-END-INV-RTL-AMT TO ML117-END-INV-RTL-AMT         03755002
                                                                        03780000
           WRITE TMNSCLS-RECORD        FROM ML117-REC.                  03970002
           ADD 1                       TO PV-TMNSCLS-WRITTEN.           03980002
                                                                        03990000
       EJECT                                                            04000000
                                                                        06010000
      ******************************************************************06020000
       7000-SELECT-TMLCNTL.                                             06030002
      ******************************************************************06040000
      *                                                                 06050000
           EXEC SQL                                                     06060000
               SELECT OPN_FSCL_MN_DTE,                                  06070000
                      OPN_FSCL_MN_NBR                                   06080000
               INTO  :MLCNTL-OPN-FSCL-MN-DTE,                           06090002
                     :MLCNTL-OPN-FSCL-MN-NBR                            06100002
               FROM TMLCNTL                                             06110002
W26603         WITH UR                                                  06111012
           END-EXEC.                                                    06120000
                                                                        06130000
           EVALUATE TRUE                                                06140000
               WHEN SQLCODE = ZERO                                      06150000
                   CONTINUE                                             06160000
               WHEN OTHER                                               06170000
                   MOVE '7000-SELECT-TMLCNTL'                           06180002
                                       TO AA-PARAGRAPH-NAME             06190000
                   MOVE 'TMLCNTL ROW NOT FOUND'                         06200002
                                       TO AA-MESSAGE                    06210000
                   MOVE 'SELECT'       TO AA-DB2-OPERATION              06220000
                   PERFORM 9901-SQL-ERROR                               06230000
           END-EVALUATE.                                                06240000
                                                                        06250000
       EJECT                                                            06260000
                                                                        06560000
      ******************************************************************06570000
       7100-OPEN-TMNSCLS-CURSOR.                                        06580002
      ******************************************************************06590000
      *                                                                 06600000
           EXEC SQL                                                     06610000
               OPEN TMNSCLS_CURSOR                                      06620002
           END-EXEC.                                                    06630000
                                                                        06640000
           EVALUATE TRUE                                                06650000
               WHEN SQLCODE = ZERO                                      06660000
                   CONTINUE                                             06670000
               WHEN OTHER                                               06680000
                   MOVE '7100-OPEN-CURSOR-TMNSCLS'                      06690002
                                       TO AA-PARAGRAPH-NAME             06700000
                   MOVE 'TMNSCLS TABLE ERROR'                           06710002
                                       TO AA-MESSAGE                    06720000
                   MOVE 'OPEN CURSOR'  TO AA-DB2-OPERATION              06730000
                   PERFORM 9901-SQL-ERROR                               06740000
           END-EVALUATE.                                                06750000
                                                                        06760000
       EJECT                                                            06770000
                                                                        06780000
      ******************************************************************06790000
       7110-FETCH-TMNSCLS.                                              06800002
      ******************************************************************06810000
      *                                                                 06820000
           EXEC SQL                                                     06830000
               FETCH TMNSCLS_CURSOR                                     06840002
                INTO :MNSCLS-DEPT-NBR                                   06850002
                    ,:MNSCLS-STR-NBR                                    06860002
                    ,:MNSCLS-MKDN-RTL-AMT                               06870002
                    ,:PV-NET-XFER-RTL-AMT                               06880002
                    ,:PV-RCPT-NET-RTL-AMT                               06890005
                    ,:PV-RCPT-NET-COST-AMT                              06891006
                    ,:MNSCLS-END-INV-RTL-AMT                            06900002
           END-EXEC.                                                    06910000
                                                                        06920000
           EVALUATE TRUE                                                06930000
               WHEN SQLCODE = ZERO                                      06940000
                   ADD 1               TO PV-C-MO-TMNSCLS-FETCHED       06950002
               WHEN SQLCODE = +100                                      06960000
                   SET PS-END-OF-DATA  TO TRUE                          06970002
               WHEN OTHER                                               06990000
                   MOVE '7110-FETCH-TMNSCLS'                            07000002
                                       TO AA-PARAGRAPH-NAME             07010000
                   MOVE 'TMNSCLS TABLE ERROR'                           07020002
                                       TO AA-MESSAGE                    07030000
                   MOVE 'FETCH'        TO AA-DB2-OPERATION              07040000
                   PERFORM 9901-SQL-ERROR                               07050000
           END-EVALUATE.                                                07060000
                                                                        07070000
       EJECT                                                            07080000
                                                                        07090000
      ******************************************************************07100000
       7120-CLOSE-TMNSCLS-CURSOR.                                       07110002
      ******************************************************************07120000
      *                                                                 07130000
           EXEC SQL                                                     07140000
               CLOSE TMNSCLS_CURSOR                                     07150002
           END-EXEC.                                                    07160000
                                                                        07170000
           EVALUATE TRUE                                                07180000
               WHEN SQLCODE = ZERO                                      07190000
                   CONTINUE                                             07200000
               WHEN OTHER                                               07210000
                   MOVE '7120-CLOSE-TMNSCLS-CURSOR'                     07220002
                                       TO AA-PARAGRAPH-NAME             07230000
                   MOVE 'TMNSCLS TABLE ERROR'                           07240002
                                       TO AA-MESSAGE                    07250000
                   MOVE 'CLOSE CURSOR' TO AA-DB2-OPERATION              07260000
                   PERFORM 9901-SQL-ERROR                               07270000
           END-EVALUATE.                                                07280000
                                                                        07290000
       EJECT                                                            08730000
                                                                        08740000
      ******************************************************************08750000
       8000-EOJ.                                                        08760000
      ******************************************************************08770000
      *                                                                 08780000
           PERFORM 7120-CLOSE-TMNSCLS-CURSOR.                           08790002
                                                                        08800000
           CLOSE TMNSCLS-FILE.                                          08830002
                                                                        08840000
           PERFORM 9100-DISPLAY-TOTALS.                                 08850000
                                                                        08860000
       EJECT                                                            08870000
                                                                        08880000
      ******************************************************************08890000
       9100-DISPLAY-TOTALS.                                             08900000
      ******************************************************************08910000
      *                                                                 08920000
           DISPLAY ' '.                                                 08930000
           DISPLAY '*--------------------------------------------*'.    08940000
           DISPLAY '*                                            *'.    08950000
           DISPLAY '*         **MLKUT423 COUNTS**                *'.    08960001
           DISPLAY '* '                                                 08970000
                   PV-C-MO-TMNSCLS-FETCHED                              08980002
                   ' CURRENT MONTH TMNSCLS ROWS READ  *'.               08990004
           DISPLAY '* '                                                 09000000
                   PV-TMNSCLS-WRITTEN                                   09130002
                   ' RECORDS WRITTEN                  *'.               09140000
           DISPLAY '*                                            *'.    09150000
           DISPLAY '*--------------------------------------------*'.    09160000
                                                                        09170000
       EJECT                                                            09180000
                                                                        09190000
                                                                        09200000
      ******************************************************************09210000
       9901-SQL-ERROR.                                                  09220000
      ******************************************************************09230000
      *                                                                 09240000
           CLOSE TMNSCLS-FILE.                                          09250002
                                                                        09260000
           DISPLAY AA-ABEND-LIT.                                        09270000
           DISPLAY AA-DB2-ERROR-LIT.                                    09280000
           DISPLAY AA-PROGRAM-LIT.                                      09290000
           DISPLAY AA-PARAGRAPH-LIT.                                    09300000
           DISPLAY AA-MESSAGE-LINE.                                     09310000
           DISPLAY AA-DB2-OPERATION-LIT.                                09320000
           SET AC-DB2-ERROR TO TRUE.                                    09330000
           MOVE +4013                  TO ABEND-CODE.                   09340000
                                                                        09350000
           COPY DPPD004.                                                09360000
           CALL 'ILBOABN0' USING ABEND-CODE.                            09370000
                                                                        09380000
