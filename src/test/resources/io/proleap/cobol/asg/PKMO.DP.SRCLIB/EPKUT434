000100*----------------------------------------------------------------*00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300*----------------------------------------------------------------*00030000
000400 PROGRAM-ID.    EPKUT434.                                         00040000
000500 AUTHOR.        COGNIZANT.                                        00050061
000600 DATE-WRITTEN.  15 JUNE 2012.                                     00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900*----------------------------------------------------------------*00090000
001000* ** CREATE OFFERS FULL FILE REFRESH STORE LIST CONTROL FILE **  *00100000
001100*              **   OFFER RESEND **                              *00110000
001200*----------------------------------------------------------------*00120000
001300*  THIS PROGRAM HAS BEEN CLONED FROM THE PROGRAM EPKUT200.        00130000
001301*  IT WILL READ THE INPUT FILE CONTAINING THE SOURCE STORE, OFFER 00130153
001302*  ID AND TARGET STORE.                                           00130200
001303*  IT CREATES A BATCH CONTROL FILE WITH STORE NUMBERS,            00130300
001400*  AND THE ASSOCIATED STORE GROUP TYPE CODES AND STORE GROUP IDS  00140000
001410*  FOR ALL THE TARGET STORE FROM THE SOURCE STORE RECORDS.        00141053
001500*  THIS FILE WILL BE USED LATER BY THE EXTRACT PROGRAM (EPKUT435) 00150000
001600*  TO EXTRACT ALL THE OFFERS FOR THAT STORE.                      00160000
001700*                                                                 00170000
001701* SERVICE DELIVERY WILL INPUT THE FOLLOWING INTO THE INPUT FILE: *00180053
001702*   1) THE SOURCE STORE FROM WHICH TO PULL THE OFFER DATA FROM   *00190053
001703*   2) THE OFFER ID THAT NEEDED FOR THE MISSING STORES           *00200053
001704*   3) THE TARGET STORE(S) TO WHICH THE OFFER DATA WILL BE       *00210053
001705*      SENT TO.                                                  *00220053
001706* EDITTING WILL TAKE PLACE TO ENSURE THAT:                       *00230053
001707*   1) THE 'FROM' AND 'TO' STORES ARE ALL NUMERIC                *00240053
001800*   2) ALL STORES ARE VALID PER THE STORE LOCATION TABLE.        *00250053
001900*   3) ALLOWED IF SAME SOURCE STORE AND TARGET STORE.            *00260053
002000* IF ANY ERRORS ARE FOUND, DISPLAYS WILL BE WRITTEN TO SYSOUT    *00270053
002100* AND PROCESSING WILL STOP - NO OUTPUT RECORDS WILL BE WRITTEN.  *00280053
002200* IF NO ERRORS ARE FOUND, STORE GROUP TYPE CODE AND STR GRP ID   *00290053
002300* WILL BE FETCHED FROM THE SOURCE AND WRITTEN ONCE FOR EACH      *00300053
002301* TARGET STORE                                                   *00310053
002302*  IT WILL ALSO CREATE THE UPDATED INPUT WITH SOURCE STORE AND   *00320053
002303*  TARGET STORE FOR EACH STRGP ID AND STR GP TYPE CDE FETCHED    *00330053
002304*  FROM THE SOURCE STORE.                                        *00330153
002305*  IT ALSO USES AN ADVANCE DAYS CONTROL CARD TO DETERMINE WHETHER 00330200
002306*  TO INCLUDE NEW STORES WHICH WILL BE OPENED WITHIN THE DATE     00330300
002400*  RANGE.                                                         00330400
002500*----------------------------------------------------------------*00330500
002600* HISTORY LOG:                                                    00330600
002700*----------------------------------------------------------------*00330700
002800* DATE:        15 JUNE 2012                                       00330800
002900* WR/IR#:      CRQ000000032161                                    00330962
003000* PROGRAMMER:  COGNIZANT.                                         00331061
003100* DESCRIPTION: INITIAL PROGRAM CREATION                           00331100
003200                                                                  00331200
003300*----------------------------------------------------------------*00331300
003400* DATE:                                                           00340000
003500* WR/IR#:                                                         00350000
003600* PROGRAMMER:                                                     00360000
003700* DESCRIPTION:                                                    00370000
003800*                                                                 00380000
003900*----------------------------------------------------------------*00390000
004000 ENVIRONMENT DIVISION.                                            00400000
004100*----------------------------------------------------------------*00410000
004200 CONFIGURATION SECTION.                                           00420000
004300 SOURCE-COMPUTER. IBM-3090.                                       00430000
004400 OBJECT-COMPUTER. IBM-3090.                                       00440000
004500                                                                  00450000
004600 INPUT-OUTPUT SECTION.                                            00460000
004700                                                                  00470000
004800 FILE-CONTROL.                                                    00480000
004900                                                                  00490000
004901     SELECT STORE-INPUT-FILE                  ASSIGN TO INP01.    00500053
004902                                                                  00500153
005000     SELECT CONTROL-CARD-BATCH-DATE           ASSIGN TO INP02.    00500201
005100                                                                  00510000
005200     SELECT CONTROL-CARD-ADV-DAYS             ASSIGN TO INP03.    00510153
005300                                                                  00510200
005400     SELECT REFRESH-STORE-CARD-FILE           ASSIGN TO OUT01.    00520000
005500                                                                  00530002
005501     SELECT STORE-OUTPUT-FILE                 ASSIGN TO OUT02.    00530153
005502                                                                  00530202
005600*----------------------------------------------------------------*00540000
005700 DATA DIVISION.                                                   00550000
005800*----------------------------------------------------------------*00560000
005900 FILE SECTION.                                                    00570000
005901 FD  STORE-INPUT-FILE                                             00580053
005902     LABEL RECORDS ARE STANDARD                                   00590053
005903     RECORDING MODE IS F                                          00600053
005904     BLOCK CONTAINS 0 RECORDS                                     00610053
005905     RECORD CONTAINS 80 CHARACTERS                                00620053
005906     DATA RECORD IS STORE-INPUT-RECORD-IN.                        00630053
005907                                                                  00640053
005908 01  STORE-INPUT-RECORD               PIC X(80).                  00650053
005909                                                                  00650153
006000 FD  CONTROL-CARD-BATCH-DATE                                      00650201
006100     RECORDING MODE IS F                                          00650300
006200     BLOCK CONTAINS 0 RECORDS                                     00650400
006300     LABEL RECORDS ARE STANDARD.                                  00650500
006400                                                                  00650600
006500 01  CONTROL-BATCH-DATE-RECORD        PIC X(080).                 00650701
006600                                                                  00650800
006700 FD  CONTROL-CARD-ADV-DAYS                                        00650901
006800     RECORDING MODE IS F                                          00651000
006900     BLOCK CONTAINS 0 RECORDS                                     00651100
007000     LABEL RECORDS ARE STANDARD.                                  00651200
007100                                                                  00651300
007200 01  CONTROL-ADV-DAYS-RECORD          PIC X(080).                 00651401
007300                                                                  00651500
007400 FD  REFRESH-STORE-CARD-FILE                                      00651601
007500     RECORDING MODE IS F                                          00660000
007600     LABEL RECORDS ARE STANDARD                                   00670000
007700     BLOCK CONTAINS 0 RECORDS.                                    00680000
007800                                                                  00690000
007900 01  REFRESH-STORE-CARD-RECORD        PIC X(080).                 00700001
008000                                                                  00710000
008001 FD  STORE-OUTPUT-FILE                                            00720053
008002     LABEL RECORDS ARE STANDARD                                   00730053
008003     RECORDING MODE IS F                                          00740053
008004     BLOCK CONTAINS 0 RECORDS                                     00750053
008005     RECORD CONTAINS 80 CHARACTERS                                00760053
008006     DATA RECORD IS STORE-OUTPUT-RECORD-OUT.                      00770053
008007                                                                  00780053
008008 01  STORE-OUTPUT-RECORD              PIC X(80).                  00780153
008100                                                                  00780200
008200*----------------------------------------------------------------*00780300
008300                                                                  00780400
008400 WORKING-STORAGE SECTION.                                         00780500
008500                                                                  00780600
008600*----------------------------------------------------------------*00780700
008700 01 FILLER                            PIC  X(27) VALUE            00910000
008800        'WORKING STORAGE STARTS HERE'.                            00920000
008900                                                                  00920153
009000*----------------------------------------------------------------*00920200
009100* COPYBOOK FOR INPUT BATCH DATE CONTROL CARD EPCC812             *00920300
009200*----------------------------------------------------------------*00920400
009300     COPY EPRD257 REPLACING 'EP257-' BY 'EP812-'.                 00920500
009400                                                                  00920600
009500*----------------------------------------------------------------*00920700
009600* COPYBOOK FOR INPUT NEW STORE ADVANCE DAYS CONTROL CARD EPCC258.*00920800
009700*----------------------------------------------------------------*00920900
009800     COPY EPRD258.                                                00921000
009900                                                                  00921100
010000*----------------------------------------------------------------*00921200
010100* COPYBOOK FOR OUTPUT BATCH REFRESH STORES FILE                  *00921300
010200*----------------------------------------------------------------*00921400
010300     COPY EPRD250.                                                00921500
010400                                                                  00921600
010500*----------------------------------------------------------------*01060000
010600* PC- PROGRAM CONSTANTS                                          *01070000
010700*----------------------------------------------------------------*01080000
010800 01  PC-PROGRAM-CONSTANTS.                                        01090000
010900     05  FILLER                       PIC  X(23) VALUE            01090153
011000        'COPYBOOK DATA ENDS HERE'.                                01090200
011100     05  PC-PROGRAM-NAME              PIC  X(08) VALUE 'EPKUT434'.01100000
011200     05  PC-MAX-RETRIES               PIC  9(01) VALUE 5.         01110000
011300     05  PC-NO-REFRESHES-FOUND        PIC  X(49) VALUE            01130000
011400             'NO STORE GRP TYP CODE AND STR GRP ID FOUND       '. 01140000
011500                                                                  01150000
011600*-----------------------------------------------------------      01160053
011700* PC- PROGRAM COUNTERS                                            01170053
011800*-----------------------------------------------------------      01180053
011900 01  PC-PROGRAM-COUNTERS.                                         01190053
012000     05  PC-CNT-READ-RECS             PIC 9(09) VALUE 0.          01200053
012200     05  PC-CNT-REFRESH-CSR-FETCHES   PIC 9(09) VALUE 0.          01220053
012200     05  PC-CNT-REFRESH-CSR-FETCHES1  PIC 9(09) VALUE 0.          01221055
012300     05  PC-CNT-OUT-RECS              PIC 9(09) VALUE 0.          01230053
012300     05  PC-CNT-OUT-RECS1             PIC 9(09) VALUE 0.          01231055
012400     05  PC-CNT-ALL-RECS              PIC 9(09) VALUE 0.          01240053
012500                                                                  01240153
012600*----------------------------------------------------------------*01240200
012700* PS- PROGRAM SWITCHES                                           *01240300
012800*----------------------------------------------------------------*01240400
012900 01  PS-PROGRAM-SWITCHES.                                         01240500
013000     05  PS-BATCH-DTE-CNTL-EOF-SW     PIC  X(01) VALUE 'N'.       01240602
013100         88  PS-EOF-BATCH-DTE-CNTL-FILE          VALUE 'Y'.       01240702
013200         88  PS-NOT-EOF-BATCH-DTE-CNTL-FILE      VALUE 'N'.       01240802
013201     05  PS-ADV-DAYS-CNTL-EOF-SW      PIC  X(01) VALUE 'N'.       01240902
013202         88  PS-EOF-ADV-DAYS-CNTL-FILE           VALUE 'Y'.       01241002
013203         88  PS-NOT-EOF-ADV-DAYS-CNTL-FILE       VALUE 'N'.       01242002
013300     05  PS-END-OF-REFRESH-CSR-SW     PIC  X(01) VALUE 'N'.       01260002
013400         88  PS-END-OF-REFRESH-CSR               VALUE 'Y'.       01270002
013500         88  PS-NOT-END-OF-REFRESH-CSR           VALUE 'N'.       01280002
013900     05  PS-DATE-ROUTINE-SW             PIC X(01) VALUE 'N'.      01290053
014000         88  PS-DATE-FOUND                        VALUE 'Y'.      01300053
014100         88  PS-DATE-NOT-FOUND                    VALUE 'N'.      01310053
014101     05  PS-ERROR-SW                  PIC X(01)  VALUE 'N'.       01320053
014102         88  PS-ERROR-FOUND                      VALUE 'Y'.       01330053
014103         88  PS-NO-ERROR-FOUND                   VALUE 'N'.       01340053
014104     05  PS-END-OF-INPUT-SW           PIC X(01)  VALUE 'N'.       01350053
014105         88  PS-END-OF-INPUT                     VALUE 'Y'.       01360053
014106         88  PS-NOT-END-OF-INPUT                 VALUE 'N'.       01370053
014107     05  PS-END-OF-TARGET-SW          PIC X(01)  VALUE 'N'.       01380053
014108         88  PS-END-OF-TARGET                    VALUE 'Y'.       01390053
014109         88  PS-NOT-END-OF-TARGET                VALUE 'N'.       01400053
014110     05  PS-RECORD-SW                 PIC X(01)  VALUE ' '.       01410053
014111         88  PS-SOURCE-STORE                     VALUE 'S'.       01420053
014112         88  PS-TARGET-STORE                     VALUE 'T'.       01430053
014113     05  PS-PROCESSED-SW              PIC X(01)  VALUE 'N'.       01440053
014114         88  PS-PROCESSED-ALL                    VALUE 'Y'.       01440153
014200                                                                  01440202
014201*-----------------------------------------------------------      01440353
014202* PA PROGRAM ACCUMULATORS                                        *01440453
014203*-----------------------------------------------------------      01440553
014204 01  PA-PROGRAM-ACCUMULATORS.                                     01440653
014205     05  PA-INPUT-RECS-READ      PIC S9(7)  COMP-3   VALUE ZEROES.01440753
014206     05  PA-TARGET-STORE-COUNT   PIC S9(7)  COMP-3   VALUE ZEROES.01440853
014207     05  PA-ERROR-COUNT          PIC S9(7)  COMP-3   VALUE ZEROES.01440953
014300*--------------------------------------------------------------*  01441002
014400* PV- PROGRAM VARIABLES                                           01441102
014500*--------------------------------------------------------------*  01441202
014600 01  PV-PROGRAM-VARIABLES.                                        01441302
014700     05  PV-SQL-SUB                   PIC S9(04) VALUE 0  COMP.   01441402
014800     05  PV-SAVE-STR-NBR              PIC  9(05) VALUE 0.         01441502
015200     05  PV-DAYS-AHEAD                PIC  9(05) VALUE 0.         01441653
015300     05  PV-SAVE-ADDED-DAYS           PIC  X(05) VALUE SPACES.    01441753
015400     05  PV-BATCH-DATE                PIC  X(10) VALUE SPACES.    01510002
015500     05  PV-NEW-OPEN-DATE             PIC  X(10) VALUE SPACES.    01510153
015501     05  PV-OFFER-ID                  PIC  X(10) VALUE SPACES.    01510202
015502     05  PV-SOURCE-STORE              PIC  X(04) VALUE SPACES.    01510353
015503     05  PV-ARRAY-COUNT               PIC S9(07) COMP-3           01510453
015504                                                 VALUE 1.         01510553
015505     05  PV-TARGET-STORE-TABLE OCCURS 1000 TIMES.                 01510653
015506         10  PV-TARGET-STORE          PIC  X(04) VALUE ZEROS.     01510753
015507     05  PV-TARGET-STORE-SUB          PIC  9(05) VALUE ZEROS.     01510853
015508     05  PV-SUB                       PIC  9(05) VALUE ZEROS.     01510953
015509     05  PV-SYSOUT-SUB                PIC  9(05) VALUE ZEROS.     01511053
015510     05  PV-STORE-5.                                              01512053
015511         10  PV-STORE-5-1             PIC  X(01) VALUE '0'.       01513053
015512         10  PV-STORE-4               PIC  X(04).                 01514053
015513     05  PV-DISPLAY-SQLCODE           PIC  9(04) VALUE ZEROES.    01515053
015700                                                                  02040002
015701*--------------------------------------------------------------*  02050053
015702*    INPUT CONTROL CARD RECORD                                   *02060053
015703*    FIRST RECORD SHOULD CONTAIN THE SOURCE STORE AND PROMO ID   *02070053
015704*    FOR THE PROMOTION RECORDS TO BE COPIED.                     *02080053
015705*    THE REST OF THE RECORDS SHOULD CONTAIN ONLY THE STORES      *02090053
015706*    THAT THE DATA WILL BE SENT TO - 1 STORE PER RECORD.         *02090153
015707*--------------------------------------------------------------*  02090202
015708                                                                  02090353
015709 01  INPUT-RECORD.                                                02090453
015710     05  INPUT-STORE                 PIC  X(04)  VALUE ZEROES.    02090553
015711     05  FILLER                      PIC  X(01)  VALUE SPACES.    02090653
015712     05  INPUT-OFFER-ID              PIC  X(10)  VALUE ZEROES.    02090753
015713     05  FILLER                      PIC  X(65)  VALUE SPACES.    02090853
015714                                                                  02090953
015715 01  OUT-RECORD-UPD.                                              02091053
015716     05  OUT-STORE                   PIC  X(04)  VALUE ZEROES.    02092053
015717     05  FILLER                      PIC  X(01)  VALUE SPACES.    02093053
015718     05  OUT-OFFER-ID                PIC  X(10)  VALUE ZEROES.    02094053
015719     05  FILLER                      PIC  X(01)  VALUE SPACES.    02095053
015720     05  OUT-STR-GP-TYP-CDE          PIC  X(05)  VALUE SPACES.    02096060
015721     05  FILLER                      PIC  X(01)  VALUE SPACES.    02097053
015722     05  OUT-STR-GRP-ID              PIC  X(05)  VALUE SPACES.    02098060
015723     05  FILLER                      PIC  X(53)  VALUE SPACES.    02099053
015724                                                                  02100053
015725                                                                  02110053
015726 01  SYSOUT-OFFER-REQUEST-RECORD.                                 02120054
015727     05  FILLER                      PIC  X(15)                   02130053
015728                                     VALUE 'OFFER ID      '.      02140053
015729     05  SYSOUT-OFFER-ID             PIC  X(10)  VALUE ZEROES.    02150054
015730     05  FILLER                      PIC  X(09)  VALUE SPACES.    02160053
015731     05  SYSOUT-OFFR-ID-ERROR-MSG    PIC  X(47)  VALUE SPACES.    02170054
015732*        NON-NUMERIC                                              02180053
015733                                                                  02190053
015734 01  SYSOUT-HEADER-1.                                             02200053
015735     05  SYSOUT-HDR1-STORE-TYPE  PIC  X(14)  VALUE 'STORE TYPE'.  02210053
015736     05  SYSOUT-HDR1-STORE-NBR   PIC  X(05)  VALUE 'STORE'.       02220053
015737     05  FILLER                  PIC  X(02)  VALUE SPACES.        02230053
015738     05  SYSOUT-HDR1-ERROR-MSG   PIC  X(52)  VALUE 'ERROR'.       02240053
015739                                                                  02250053
015740 01  SYSOUT-HEADER-2.                                             02260053
015741     05  SYSOUT-HDR2-STORE-TYPE  PIC  X(14)  VALUE '------------'.02270053
015742     05  SYSOUT-HDR2-STORE-NBR   PIC  X(05)  VALUE '-----'.       02280053
015743     05  FILLER                  PIC  X(02)  VALUE SPACES.        02290053
015744     05  SYSOUT-HDR2-MEDIA-TYPE  PIC  X(07)  VALUE '-----'.       02300053
015745                                                                  02310053
015746 01  SYSOUT-RECORD-TABLE.                                         02320053
015747     05  SYSOUT-STORE-RECORDS OCCURS 1000 TIMES.                  02330053
015748         10  SYSOUT-FIELD-NAME       PIC  X(15)  VALUE SPACES.    02340053
015749         10  SYSOUT-STORE            PIC  X(04)  VALUE ZEROES.    02350053
015750         10  FILLER                  PIC  X(02)  VALUE SPACES.    02360053
015760         10  SYSOUT-STORE-ERROR-MSG  PIC  X(52)  VALUE SPACES.    02360153
015800*--------------------------------------------------------------*  02360202
015900* DATE ROUTINE COPY MEMBERS                                       02360302
016000*--------------------------------------------------------------*  02360402
016100     COPY DPWS500.                                                02360502
016200                                                                  02360602
016300*--------------------------------------------------------------*  02360702
016400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         02360802
016500*--------------------------------------------------------------*  02360902
016600     COPY DPWS004.                                                02361002
016700                                                                  02361102
016800*--------------------------------------------------------------*  02361202
016900* DB2 ABEND COPYBOOK                                              02361302
017000*--------------------------------------------------------------*  02361402
017100     COPY DPWS900.                                                02361502
017200                                                                  02361602
017300*--------------------------------------------------------------*  02361702
017400* DB2 MESSAGE AREA                                                02361802
017500*--------------------------------------------------------------*  02361902
017600     COPY SQLCA2.                                                 02362002
017700                                                                  02362102
017800*----------------------------------------------------------------*02362200
017900* PV- PROGRAM STATUS                                             *02362300
018000*----------------------------------------------------------------*02362400
018100 01  PV-PROGRAM-STATUS.                                           02362500
018200     05  PV-PARAGRAPH-NAME            PIC  X(40) VALUE SPACES.    02362600
018300     05  PV-DB2-OPERATION             PIC  X(50) VALUE SPACES.    02362700
018400     05  PV-OPERATION-MSG-1           PIC  X(40) VALUE SPACES.    02362800
018500     05  PV-OPERATION-MSG-2           PIC  X(40) VALUE SPACES.    02362900
018600 01  FILLER                          REDEFINES                    02363000
018700     PV-PROGRAM-STATUS                PIC  X(170).                02363100
018800                                                                  02363200
018900 01  AC-ABEND-CODE                    PIC S9(04) VALUE +0 COMP.   02363300
019000     88  AC-4003-CONTROL-CARD-ERROR              VALUE +4003.     02363400
019100     88  AC-4008-CONTROL-CARD-EMPTY              VALUE +4008.     02363500
019200     88  AC-4013-DB2-ERROR                       VALUE +4013.     02363600
019300     88  AC-4019-CALENDAR-ROUTINE-ERROR          VALUE +4019.     02363700
019400                                                                  02363800
019500*--------------------------------------------------------------*  02400002
019600* DB2 COMMUNICATIONS AREA                                         02410002
019700*--------------------------------------------------------------*  02420002
019800     EXEC SQL                                                     02430002
019900       INCLUDE SQLCA                                              02440002
020000     END-EXEC.                                                    02450002
020100                                                                  02460002
020900*--------------------------------------------------------------*  02540002
021000* DB2 TABLE XST00001(XST_LOC) - LOCATION TABLE                    02550002
021100*--------------------------------------------------------------*  02560002
021200     EXEC SQL                                                     02570002
021300       INCLUDE XST00001                                           02580002
021400     END-EXEC.                                                    02590002
021500                                                                  02600002
021600*--------------------------------------------------------------*  02680002
021700* DB2 TABLE XST00023(XST_STR_GP_MBSHP) - STORE GROUP              02690002
021800*                                        MEMBERSHIP TABLE         02700002
021900*--------------------------------------------------------------*  02710002
022000     EXEC SQL                                                     02720002
022100       INCLUDE XST00023                                           02730002
022200     END-EXEC.                                                    02740002
022300                                                                  02750002
022400*--------------------------------------------------------------*  02750153
022500* DB2 TABLE XST00025(XST_LOC_ATTR) - LOCATION ATTRIBUTE TABLE     02750202
022600*--------------------------------------------------------------*  02750302
022700     EXEC SQL                                                     02750402
022800       INCLUDE XST00025                                           02750502
022900     END-EXEC.                                                    02750602
023000                                                                  02750702
023100*-----------------------------------------------------------      02750853
023200* OFFER-REFRESH-CSR WILL FIND ALL THE STORES THAT NEED            02750953
023300* A FULL FILE REFRESH.                                            02751053
023400*-----------------------------------------------------------      02752053
023500     EXEC SQL                                                     02753053
023600       DECLARE OFFER-REFRESH-CSR CURSOR FOR                       02754053
023700            SELECT  MBSHP.STR_NBR                                 02755053
023800                   ,MBSHP.STR_GP_TYP_CDE                          02756053
023900                   ,MBSHP.STR_GP_ID                               02757053
024300              FROM  XST_STR_GP_MBSHP  MBSHP                       02758053
024600             WHERE  MBSHP.STR_NBR       =  :XST00023-STR-NBR      02759053
025800               AND  MBSHP.EFF_BEG_DTE   <= :PV-BATCH-DATE         02760053
025900               AND (MBSHP.EFF_END_DTE   >= :PV-BATCH-DATE         02770053
026000                OR  MBSHP.EFF_END_DTE   IS NULL)                  02780053
026100             ORDER BY MBSHP.STR_NBR                               02790053
026200                     ,MBSHP.STR_GP_TYP_CDE                        02800053
026300                     ,MBSHP.STR_GP_ID                             02810053
026400           WITH UR                                                02820053
026500     END-EXEC.                                                    02830053
026600                                                                  02840053
026700 LINKAGE SECTION.                                                 02850053
026800                                                                  02860053
026900*----------------------------------------------------------       02870053
027000 PROCEDURE DIVISION.                                              02880053
027100*----------------------------------------------------------       02890053
027200 0000-MAINLINE.                                                   02900053
027300                                                                  02910053
027400     PERFORM 1000-INITIALIZATION.                                 02920053
027500                                                                  02930053
027600     PERFORM 2000-PROCESS-STORES                                  02940053
027700         UNTIL PS-PROCESSED-ALL.                                  02950053
027800                                                                  02960053
028000                                                                  02970053
028100     PERFORM 9999-WRAPUP.                                         02980053
028200                                                                  02990053
028300     GOBACK.                                                      03000053
028400                                                                  03010053
028500*0000-EXIT.                                                       03020053
028600*----------------------------------------------------------       03030053
028700* 1000-INITIALIZATION.                                            03040053
028800*     INITIALIZATION AREA - INITIALIZES ALL VARIABLES, OPENS      03050053
028900*     FILES, READS INPUT FILES, AND DOES AN INITIAL FETCH         03060053
029000*     OF THE MERCHANDISE CURSOR.                                  03070053
029100*----------------------------------------------------------       03080053
029200 1000-INITIALIZATION.                                             03090053
029300     MOVE '1000-INITIALIZATION       ' TO PV-PARAGRAPH-NAME.      03100053
029400                                                                  03110053
029401     DISPLAY '****************************************'.          03120053
029402     DISPLAY '**          EPKUT434 STARTED          **'.          03130053
029403     DISPLAY '****************************************'.          03140053
030900                                                                  03150053
030901     INITIALIZE  EP250-CC-CONTROL-CARD                            03160053
030902                 EP812-CC-CONTROL-CARD.                           03170053
030903     INITIALIZE  PS-PROGRAM-SWITCHES                              03180053
030904                 PC-PROGRAM-COUNTERS                              03190053
030905                 PV-SAVE-STR-NBR.                                 03200053
030906     INITIALIZE  PS-PROCESSED-SW                                  03210053
030907                 PS-RECORD-SW.                                    03220053
030908                                                                  03230053
030909     OPEN INPUT  STORE-INPUT-FILE                                 03240053
030910                 CONTROL-CARD-BATCH-DATE                          03250053
030911                 CONTROL-CARD-ADV-DAYS                            03260053
030912          OUTPUT REFRESH-STORE-CARD-FILE                          03270053
030913                 STORE-OUTPUT-FILE.                               03280053
030914                                                                  03280153
030915     SET  PS-NOT-EOF-BATCH-DTE-CNTL-FILE TO TRUE.                 03280202
030916     SET  PS-NOT-EOF-ADV-DAYS-CNTL-FILE  TO TRUE.                 03280302
030917     SET  PS-NOT-END-OF-INPUT            TO TRUE.                 03280402
030918                                                                  03280553
030919** READ BATCH DATE CONTROL CARD                                   03280653
030920     PERFORM 8000-READ-BATCH-DATE-CNTL-CARD.                      03280753
030921                                                                  03280853
030922     DISPLAY '** INPUT BATCH DATE: ' EP812-CC-CRNT-DTE            03280953
030923             '            **'.                                    03281053
030924     DISPLAY '****************************************'.          03282053
030925                                                                  03283053
031800     PERFORM 1100-VALIDATE-BATCH-DATE.                            03284053
031900                                                                  03285053
033100     MOVE EP812-CC-CRNT-DTE      TO PV-BATCH-DATE.                03286053
033200                                                                  03287053
033201** READ NEW STORE DAYS IN ADVANCE CONTROL CARD                    03288053
033202     PERFORM 8100-READ-ADV-DAYS-CNTL-CARD.                        03289053
033203                                                                  03290053
033204     DISPLAY '** INPUT ADVANCE DAYS: ' EP258-DAYS-TILL-STORE-OPN  03300053
033205             '            **'.                                    03310053
033206     DISPLAY '****************************************'.          03320053
033207                                                                  03330053
033300*    OBTAIN DATE FOR NEW STORE OPEN CRITERION                     03340053
033400     IF  EP258-DAYS-TILL-STORE-OPN NUMERIC                        03350053
033410         MOVE EP258-DAYS-TILL-STORE-OPN TO PV-DAYS-AHEAD          03360053
033500         MOVE PV-DAYS-AHEAD         TO PV-SAVE-ADDED-DAYS         03370053
033600         PERFORM 1200-GET-DATE                                    03380053
033601     ELSE                                                         03390053
033602         MOVE '1000-INITIALIZE           ' TO PV-PARAGRAPH-NAME   03400053
033603         MOVE 'ADVANCE DAYS VALUE INVALID' TO PV-OPERATION-MSG-1  03410053
036700         SET   AC-4003-CONTROL-CARD-ERROR  TO TRUE                03420053
036701         PERFORM 9800-ABEND                                       03430053
036702     END-IF.                                                      03440053
036703                                                                  03450053
036704     PERFORM 1300-READ-STORE-INPUT.                               03460053
036705*    SET HARD-CODED TEXT VALUES FOR OUTFILE                       03470053
036706     MOVE  ' STORE NBR: '     TO  EP250-CC-STORE-NAME.            03480053
036707     MOVE  ' STR GP TYP CD: ' TO  EP250-CC-STORE-GRP-TYP.         03490053
036708     MOVE  ' STR GP ID: '     TO  EP250-CC-STORE-GRP-ID.          03500053
036709     PERFORM 1400-VALIDATE-INPUT-RECORDS                          03510053
036710         UNTIL PS-END-OF-TARGET OR                                03520053
036711               PS-END-OF-INPUT.                                   03530053
036712                                                                  03540053
036713                                                                  03550053
036714*1000-EXIT.                                                       03560053
036715******************************************************************03570053
036716* 1100-VALIDATE-BATCH-DATE.                                       03580053
036717*     VALIDATE THE DATE INPUT BY CALLING THE KOHLS CALENDAR       03590053
036718*     ROUTINE AND CHECKING TO SEE WHETHER IT THROWS AN ERROR.     03600053
036719******************************************************************03610053
036720 1100-VALIDATE-BATCH-DATE.                                        03620053
036721                                                                  03630053
036722     IF  EP812-CC-CRNT-DTE  = SPACES                              03640053
036723         DISPLAY 'INVALID CONTROL CARD'                           03650053
036724         DISPLAY 'BATCH DATE: ' EP812-CC-CRNT-DTE                 03660053
036725         MOVE '1100-VALIDATE-BATCH-DATE' TO PV-PARAGRAPH-NAME     03670053
036726         MOVE 'CONTROL CARD IS INVALID'  TO PV-OPERATION-MSG-1    03680053
036727         SET  AC-4003-CONTROL-CARD-ERROR TO TRUE                  03690053
036800         PERFORM 9800-ABEND                                       03700053
036900     END-IF.                                                      03710053
037000                                                                  03720053
037001     PERFORM 6000-VALIDATE-DATE-INPUT.                            03730053
037002                                                                  03740053
037003*1100-EXIT.                                                       03750053
039000******************************************************************03760053
039100* 1200-GET-DATE.                                                  03770053
039200*     ADDS THE NUMBER OF DAYS FROM CONTROL CARD 2 TO              03780053
039300*     TODAY'S DATE.                                               03790053
039400******************************************************************03800053
039500 1200-GET-DATE.                                                   03810053
039600                                                                  03820053
040400     PERFORM 6100-DATE-ROUTINE.                                   03830053
040410                                                                  03840053
040500     IF PS-DATE-FOUND                                             03850053
040600        MOVE DPG55-DB2-ISO-DATE-FMT TO PV-NEW-OPEN-DATE           03860053
040700        DISPLAY 'NEW DATE:' PV-NEW-OPEN-DATE                      03870053
040800     END-IF.                                                      03880053
040900                                                                  03890053
041000*1200-EXIT.                                                       03900053
041001******************************************************************03910053
041002* 1300-READ-STORE-INPUT.                                          03920053
041003*     READ INPUT STORE FILE WITH STORES TO PROCESS                03930053
041004******************************************************************03940053
041005 1300-READ-STORE-INPUT.                                           03950053
041006                                                                  03960053
041007     READ STORE-INPUT-FILE   INTO INPUT-RECORD                    03970053
041008        AT END                                                    03980053
041009           SET PS-END-OF-INPUT       TO TRUE                      03990053
041010     END-READ.                                                    04000053
041011                                                                  04010053
041012     IF PS-NOT-END-OF-INPUT                                       04020053
041013         ADD +1     TO PA-INPUT-RECS-READ                         04030053
041014         IF INPUT-OFFER-ID NOT EQUAL TO SPACES                    04040053
041015            SET PS-SOURCE-STORE     TO TRUE                       04050053
041016            IF PA-TARGET-STORE-COUNT > 0                          04060053
041017                SET PS-END-OF-TARGET    TO TRUE                   04070053
041018            END-IF                                                04080053
041019         ELSE                                                     04090053
041020            SET PS-TARGET-STORE     TO TRUE                       04100053
041021         END-IF                                                   04110053
041022         IF PA-INPUT-RECS-READ > 1000                             04120053
041023             DISPLAY 'LIMIT OF 1,000 INPUT RECORDS EXCEEDED'      04130053
041024             DISPLAY 'PROGRAM IS ENDING.'                         04140053
041025             SET PS-ERROR-FOUND     TO TRUE                       04150053
041026             SET PS-END-OF-INPUT    TO TRUE                       04160053
041027             ADD +1                 TO PA-ERROR-COUNT             04170053
041028         END-IF                                                   04180053
041029     END-IF.                                                      04190053
041030                                                                  04200053
041031*1300-EXIT.                                                       04210053
041032 EJECT.                                                           04220053
041033******************************************************************04230053
041034* - EDIT INPUT RECORDS FOR ERRORS                                *04240053
041035******************************************************************04250053
041036 1400-VALIDATE-INPUT-RECORDS.                                     04260053
041037     IF PS-SOURCE-STORE                                           04270053
041038         MOVE INPUT-OFFER-ID      TO PV-OFFER-ID                  04280053
041039                                     SYSOUT-OFFER-ID              04290053
041040         IF INPUT-OFFER-ID        NOT NUMERIC                     04300053
041041             MOVE 'OFFER ID IS NOT NUMERIC'                       04310053
041042                                  TO SYSOUT-OFFR-ID-ERROR-MSG     04320053
041043             SET PS-ERROR-FOUND   TO TRUE                         04330053
041044             ADD +1               TO PA-ERROR-COUNT               04340053
041045         END-IF                                                   04350053
041046         MOVE 'SOURCE STORE  '    TO SYSOUT-FIELD-NAME (1)        04360053
041047                                                                  04370053
041048         MOVE INPUT-STORE         TO PV-SOURCE-STORE              04380053
041049                                     SYSOUT-STORE (1)             04390053
041050     ELSE                                                         04400053
041051         ADD +1                   TO PV-ARRAY-COUNT               04410053
041052         ADD +1                   TO PA-TARGET-STORE-COUNT        04420053
041053         MOVE 'TARGET STORE  '                                    04430053
041054           TO SYSOUT-FIELD-NAME (PV-ARRAY-COUNT)                  04440053
041055         MOVE INPUT-STORE TO SYSOUT-STORE (PV-ARRAY-COUNT)        04450053
041056                          PV-TARGET-STORE (PA-TARGET-STORE-COUNT) 04460053
041057         PERFORM VARYING PV-SUB FROM 1 BY 1                       04470053
041058           UNTIL PV-SUB >= PA-TARGET-STORE-COUNT                  04480053
041059             IF PV-TARGET-STORE (PA-TARGET-STORE-COUNT) =         04490053
041060                PV-TARGET-STORE (PV-SUB)                          04500053
041061                DISPLAY 'MORE THAN ONCE'                          04510053
041062                MOVE 'TARGET STORE LISTED MORE THAN ONCE'         04520053
041063                  TO SYSOUT-STORE-ERROR-MSG (PV-ARRAY-COUNT)      04530053
041064                SET PS-ERROR-FOUND   TO TRUE                      04540053
041065**              STOP LOOKING WHEN FIRST DUP IS FOUND              04550053
041066                MOVE PA-TARGET-STORE-COUNT TO PV-SUB              04560053
041067                ADD +1               TO PA-ERROR-COUNT            04570053
041068             END-IF                                               04580053
041069         END-PERFORM                                              04590053
041070     END-IF.                                                      04600053
041071                                                                  04610053
041072     IF INPUT-STORE NOT NUMERIC                                   04620053
041073         MOVE 'STORE NUMBER IS NOT NUMERIC'                       04630053
041074           TO SYSOUT-STORE-ERROR-MSG (PV-ARRAY-COUNT)             04640053
041075         SET PS-ERROR-FOUND       TO TRUE                         04650053
041076         ADD +1                   TO PA-ERROR-COUNT               04660053
041077     ELSE                                                         04670053
041078         PERFORM 1500-CHECK-FOR-VALID-STORE                       04680053
041079     END-IF.                                                      04690053
041080                                                                  04700053
041081     PERFORM 1300-READ-STORE-INPUT.                               04710053
041082                                                                  04720053
041083                                                                  04730053
041084*1400-EXIT.                                                       04740053
041085 EJECT.                                                           04750053
041086******************************************************************04760053
041087*1500-CHECK-FOR-VALID-STORE.                                    * 04770053
041088* - VALIDATE THE STORE FROM THE INPUT FILE                      * 04780053
041089* - INVALID STORE WILL NOT BE PROCESSED                         * 04790053
041090******************************************************************04800053
041091 1500-CHECK-FOR-VALID-STORE.                                      04810053
041092                                                                  04820053
041093     MOVE INPUT-STORE   TO XST00001-LOC-NBR.                      04830053
041094                                                                  04840053
041095     EXEC SQL                                                     04850053
041096          SELECT  LOC.LOC_NBR                                     04860053
041097            INTO :XST00001-LOC-NBR                                04870053
041098            FROM  XST_LOC           LOC                           04880053
041099                 ,XST_LOC_ATTR      ATTR                          04890053
041100           WHERE  LOC.LOC_NBR         =  :XST00001-LOC-NBR        04900053
041101             AND  LOC.LOC_NBR         =  ATTR.LOC_NBR             04910053
041102             AND  LOC.LOC_TYP_CDE     =  'DS'                     04920053
041103             AND (ATTR.POS_CAP_LVL_ID =  5                        04930053
041104              OR  ATTR.POS_CAP_LVL_ID >  11)                      04940053
041105             AND ((LOC.OPN_DTE        >  :PV-BATCH-DATE           04950053
041106             AND (LOC.OPN_DTE         <= :PV-NEW-OPEN-DATE        04960053
041107             AND  LOC.CLO_DTE         >= :PV-NEW-OPEN-DATE))      04970053
041108              OR (LOC.OPN_DTE         <= :PV-BATCH-DATE           04980053
041109             AND  LOC.CLO_DTE         >= :PV-BATCH-DATE))         04990053
041110           WITH UR                                                05000053
041111     END-EXEC.                                                    05010053
041112     EVALUATE TRUE                                                05020053
041113         WHEN SQLCODE = +0                                        05030053
041114             CONTINUE                                             05040053
041115         WHEN SQLCODE = +100                                      05050053
041116             MOVE 'INVALID STORE NUMBER'                          05060053
041117               TO SYSOUT-STORE-ERROR-MSG (PV-ARRAY-COUNT)         05070053
041118             SET PS-ERROR-FOUND TO TRUE                           05080053
041119             ADD +1             TO PA-ERROR-COUNT                 05090053
041120         WHEN OTHER                                               05100053
041121             MOVE SQLCODE       TO PV-DISPLAY-SQLCODE             05110053
041122             STRING 'ERROR IN 1500-CHECK-FOR-VALID-STORE'         05120053
041123                                            DELIMITED BY SIZE     05130053
041124                    ' SQLCODE = '           DELIMITED BY SIZE     05140053
041125                     PV-DISPLAY-SQLCODE     DELIMITED BY SIZE     05150053
041126               INTO SYSOUT-STORE-ERROR-MSG (PV-ARRAY-COUNT)       05160053
041127             SET PS-ERROR-FOUND TO TRUE                           05170053
041128             ADD +1             TO PA-ERROR-COUNT                 05180053
041129     END-EVALUATE.                                                05190053
041130                                                                  05200053
041131*1500-EXIT.                                                       05210053
041132 EJECT.                                                           05220053
041133******************************************************************05220153
041200* 2000-PROCESS-STORES.                                            05220202
041300*      PROCESS THE SOURCE AND TARGET STORE FROM THE INPUT FILE    05220302
041400******************************************************************05220453
041500 2000-PROCESS-STORES.                                             05220502
041501                                                                  05220653
041502      IF PA-ERROR-COUNT = 0                                       05220753
041503         MOVE PV-SOURCE-STORE  TO XST00023-STR-NBR                05220853
041504         PERFORM 7100-OPEN-OFFER-REFRESH-CSR                      05220953
041505         PERFORM 7200-FETCH-OFFER-REFRESH-CSR                     05221053
041506                                                                  05222053
041507         IF PS-END-OF-REFRESH-CSR                                 05223053
041508            DISPLAY PC-NO-REFRESHES-FOUND                         05224053
041509            DISPLAY 'NO DATA FOR THIS SOURCE STORE'               05225053
041510         END-IF                                                   05226053
041511         PERFORM 2100-PROCESS-REFRESH-CURSOR                      05227053
041512           UNTIL PS-END-OF-REFRESH-CSR                            05228053
041513         PERFORM 7300-CLOSE-OFFER-REFRESH-CSR                     05229053
041514      END-IF                                                      05230053
041515      PERFORM 5000-DISPLAY-STATS                                  05240053
041516                                                                  05250053
041517      IF PS-END-OF-INPUT                                          05260053
041518         SET PS-PROCESSED-ALL   TO TRUE                           05270053
041519      ELSE                                                        05280053
041520         PERFORM 5100-INITIALIZE                                  05290053
041521      END-IF                                                      05300053
041522                                                                  05310053
041523     PERFORM 1400-VALIDATE-INPUT-RECORDS                          05320053
041524         UNTIL PS-END-OF-TARGET OR                                05330053
041525               PS-END-OF-INPUT.                                   05340053
041526                                                                  05350053
043000*2000-EXIT.                                                       05360053
043001******************************************************************05360153
043002* 2100-PROCESS-REFRESH-CURSOR.                                    05360202
043003*      PROCESS THE REFRESH STORE LIST CURSOR.                     05360302
043004******************************************************************05360453
043005 2100-PROCESS-REFRESH-CURSOR.                                     05360502
043006     MOVE '2100-PROCESS-REFRESH-CURSOR' TO PV-PARAGRAPH-NAME.     05360602
043007                                                                  05360702
043008     MOVE PV-SOURCE-STORE         TO  OUT-STORE                   05360853
043009     MOVE PV-OFFER-ID             TO  OUT-OFFER-ID                05360953
043010     MOVE XST00023-STR-GP-TYP-CDE TO  EP250-CC-STR-GP-TYP-CDE     05361002
043011     MOVE EP250-CC-STR-GP-TYP-CDE TO  OUT-STR-GP-TYP-CDE          05361160
043012     MOVE XST00023-STR-GP-ID      TO  EP250-CC-STR-GRP-ID         05361202
043013     MOVE EP250-CC-STR-GRP-ID     TO  OUT-STR-GRP-ID              05361360
043014                                                                  05361402
043015     PERFORM 3000-BUILD-TARGET-STORE-RECS.                        05361553
043016     PERFORM 3100-BUILD-UPDATED-INPUT.                            05361653
043017                                                                  05361753
043018     PERFORM 7200-FETCH-OFFER-REFRESH-CSR.                        05361853
043019                                                                  05361953
043020*2100-EXIT.                                                       05362053
052050***************************************************************** 05363053
052060* - BUILD 1 TARGET STORE RECORD FOR EACH TARGET STORE READ        05364053
052070*   FROM THE INPUT FILE, BY OVERLAYING THE SOURCE STORE NUMBER    05365053
052080*   WITH THE TARGET STORE NUMBER.                                 05366053
052090***************************************************************** 05367053
052100 3000-BUILD-TARGET-STORE-RECS.                                    05368053
052200     PERFORM                                                      05369053
052300       VARYING PV-TARGET-STORE-SUB                                05370053
052400         FROM 1 BY 1 UNTIL                                        05380053
052500           PV-TARGET-STORE-SUB > PA-TARGET-STORE-COUNT            05390053
052600             MOVE PV-TARGET-STORE (PV-TARGET-STORE-SUB)           05400053
052700               TO PV-STORE-4                                      05410053
052800             MOVE PV-STORE-5     TO EP250-CC-STR-NBR              05420053
                   IF EP250-CC-STR-GP-TYP-CDE = 5000                    05421054
                      MOVE PV-STORE-5  TO EP250-CC-STR-GRP-ID           05422053
                   END-IF                                               05423053
052802             PERFORM 8200-WRITE-STR-RFRSH-CNTL-REC                05430053
052803     END-PERFORM.                                                 05440053
052804                                                                  05450053
052805*3000-EXIT.                                                       05460053
052806***************************************************************** 05470053
052807* - BUILD UPDARGET STORE RECORD FOR EACH TARGET STORE READ        05480053
052808*   FROM THE INPUT FILE, BY OVERLAYING THE SOURCE STORE NUMBER    05490053
052809*   WITH THE TARGET STORE NUMBER.                                 05500053
052810***************************************************************** 05510053
052820 3100-BUILD-UPDATED-INPUT.                                        05520053
052830                                                                  05530053
052840     PERFORM 8300-WRITE-UPDATED-INPUT                             05540053
052850     MOVE SPACES TO OUT-OFFER-ID                                  05550053
052860                    OUT-STR-GP-TYP-CDE                            05560053
052870                    OUT-STR-GRP-ID                                05570053
052871                                                                  05580053
052872     PERFORM                                                      05590053
052873       VARYING PV-TARGET-STORE-SUB                                05600053
052874         FROM 1 BY 1 UNTIL                                        05610053
052875           PV-TARGET-STORE-SUB > PA-TARGET-STORE-COUNT            05620053
052876             MOVE PV-TARGET-STORE (PV-TARGET-STORE-SUB)           05630053
052877               TO PV-STORE-4                                      05640053
052878             MOVE PV-STORE-4  TO OUT-STORE                        05650053
052879             PERFORM 8300-WRITE-UPDATED-INPUT                     05660053
052880     END-PERFORM.                                                 05670053
052881                                                                  05680053
052882*3100-EXIT.                                                       05690053
052883*----------------------------------------------------------       05700053
052884* - DISPLAY THE NUMBER OF RECORDS READ, WRITTEN AND IN ERROR.    *05710053
052885* - DISPLAY SYSOUT LINE FOR EACH INPUT RECORD READ.              *05720053
052886*----------------------------------------------------------       05730053
052887 5000-DISPLAY-STATS.                                              05740053
052888                                                                  05750053
052889     DISPLAY ' '.                                                 05760053
052890     DISPLAY 'JOB TOTALS'                                         05770053
052891     DISPLAY '----------'                                         05780053
052892     DISPLAY 'INPUT RECORD COUNT       = ' PA-INPUT-RECS-READ.    05790053
052893     DISPLAY 'TARGET STORE COUNT       = ' PA-TARGET-STORE-COUNT. 05800053
052894     DISPLAY 'ERROR COUNT              = ' PA-ERROR-COUNT.        05810053
052895     DISPLAY ' '.                                                 05820053
052896     DISPLAY 'DETAILS'                                            05830053
052900     DISPLAY '-------'                                            05840053
053000     DISPLAY SYSOUT-OFFER-REQUEST-RECORD.                         05850054
053100     DISPLAY ' '.                                                 05860053
053200     DISPLAY SYSOUT-HEADER-1.                                     05870053
053300     DISPLAY SYSOUT-HEADER-2.                                     05880053
053400     PERFORM                                                      05890053
053500       VARYING PV-SYSOUT-SUB FROM 1 BY 1                          05900053
053600         UNTIL PV-SYSOUT-SUB > PV-ARRAY-COUNT                     05910053
053700            OR PV-SYSOUT-SUB > 1000                               05920053
053800           DISPLAY SYSOUT-STORE-RECORDS (PV-SYSOUT-SUB)           05930053
053900     END-PERFORM.                                                 05940053
054000                                                                  05950055
054100     DISPLAY ' '.                                                 05960053
068800     DISPLAY 'NUMBER OF STORE / STORE GROUP RECS FETCHED: '       05961055
068900                                  PC-CNT-REFRESH-CSR-FETCHES1.    05962056
069000     DISPLAY 'NUMBER OF STORE GRP DRIVER RECS WRITTEN   : '       05963055
069100                                  PC-CNT-OUT-RECS1.               05964056
054100     DISPLAY '-------'.                                           05965055
054101                                                                  05970053
054102*5000-EXIT.                                                       05980053
054103 EJECT.                                                           05990053
054104                                                                  06000053
054105*----------------------------------------------------------       06010053
054106* - INITIALIZE THE VARIABLE FOR PROCESSING THE NEXT SET OF        06020053
054107*   SOURCE STORE AND TARGET STORES IN THE INPUT FILE              06030053
054108*----------------------------------------------------------       06040053
054109 5100-INITIALIZE.                                                 06050053
054110                                                                  06060053
054120     PERFORM                                                      06070053
054130       VARYING PV-SYSOUT-SUB FROM 1 BY 1                          06080053
054140         UNTIL PV-SYSOUT-SUB > PV-ARRAY-COUNT                     06090053
054150            OR PV-SYSOUT-SUB > 1000                               06100053
054160           INITIALIZE SYSOUT-STORE-RECORDS (PV-SYSOUT-SUB)        06110053
054170           INITIALIZE PV-TARGET-STORE (PV-SYSOUT-SUB)             06120053
054180     END-PERFORM.                                                 06130053
054190                                                                  06140053
054200     INITIALIZE PV-OFFER-ID                                       06150053
054300                PA-TARGET-STORE-COUNT                             06160053
054400                PA-ERROR-COUNT                                    06170053
054500                PV-ARRAY-COUNT                                    06180053
054600                PS-ERROR-SW                                       06190053
054700                PS-END-OF-TARGET-SW                               06200055
                      PC-CNT-OUT-RECS1                                  06200155
                      PC-CNT-REFRESH-CSR-FETCHES1.                      06201055
054800     SET PS-SOURCE-STORE            TO TRUE.                      06210053
054801     SET PS-NOT-END-OF-REFRESH-CSR  TO TRUE.                      06220053
054802     MOVE 1 TO PV-ARRAY-COUNT.                                    06230053
054803                                                                  06240053
054804*5100-EXIT.                                                       06250053
054805 EJECT.                                                           06260053
054806******************************************************************06270053
054807* 6000-VALIDATE-DATE-INPUT.                                       06280053
054808*     VALIDATE THE DATE INPUT BY CALLING THE KOHLS CALENDAR       06290053
054809*     ROUTINE AND CHECKING TO SEE WHETHER IT THROWS AN ERROR.     06300053
054810******************************************************************06310053
054811 6000-VALIDATE-DATE-INPUT.                                        06320053
054812                                                                  06330053
054813     INITIALIZE DPG51 DPG52 DPG53                                 06340053
054814                DPG54 DPG55 DPG56.                                06350053
054815                                                                  06360053
054816     SET  DPG51-ACTUAL-CALENDAR-ONLY TO TRUE.                     06370053
054817     SET  DPG52-LK-DTE-ISO-FMT       TO TRUE.                     06380053
054818     MOVE EP812-CC-CRNT-DTE          TO DPG52-LK-DATE-INPUT.      06390053
054819                                                                  06400053
054820     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06410053
054821                                             DPG54 DPG55 DPG56.   06420053
054822     EVALUATE TRUE                                                06430053
054823         WHEN DPG54-NO-ERROR                                      06440053
054824             DISPLAY ' '                                          06450053
054825             DISPLAY 'INPUT BATCH DATE OK > ' EP812-CC-CRNT-DTE   06460053
054826         WHEN OTHER                                               06470053
054827             DISPLAY ' '                                          06480053
054828             DISPLAY '** ABEND ** IN ' PC-PROGRAM-NAME            06490053
054829             DISPLAY '** INVALID BATCH DATE PASSED IN CC '        06500053
054830             DISPLAY '** 6000-VALIDATE-DATE-INPUT'                06510053
054831             DISPLAY '** ERROR MESSAGE = '                        06520053
054832                               DPG54-ERROR-MESSAGE                06530053
054833             DISPLAY '** CALENDAR TYPE = ' DPG51-CALENDAR-TYPE    06540053
054834             DISPLAY '** DATE FORMAT = ' DPG52-LK-DATE-FORMAT-CODE06550053
054835             DISPLAY '** INPUT DATE  = ' DPG52-LK-DATE-INPUT      06560053
054836             MOVE '6000-VALIDATE-DATE-INPUT'                      06570053
054837                                  TO PV-PARAGRAPH-NAME            06580053
054838             MOVE 'ERROR VALIDATING CONTROL CARD INPUT DATE'      06590053
054839                                  TO PV-OPERATION-MSG-1           06600053
054840             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      06610053
054841             SET AC-4019-CALENDAR-ROUTINE-ERROR TO TRUE           06620053
054842             PERFORM 9800-ABEND                                   06630053
054843     END-EVALUATE.                                                06640053
054844                                                                  06650053
054845*6000-EXIT.                                                       06660053
054846******************************************************************06670053
054847* 6100-DATE-ROUTINE.                                              06680053
054848*     CALLS KOHL'S DATE ROUTINE.                                  06690053
054849******************************************************************06700053
054850 6100-DATE-ROUTINE.                                               06710053
054851                                                                  06720053
054852     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              06730053
054853                                                                  06740053
054854     MOVE PV-BATCH-DATE                TO DPG52-LK-DATE-INPUT.    06750053
054855     SET  DPG51-ACTUAL-CALENDAR-ONLY   TO TRUE.                   06760053
054856     SET  DPG52-LK-DTE-ISO-FMT         TO TRUE.                   06770053
054857     SET  DPG51-INCREMENT-DATE         TO TRUE.                   06780053
054858     MOVE PV-SAVE-ADDED-DAYS           TO DPG51-INCR-DECR-DAYS-X. 06790053
054859     SET PS-DATE-NOT-FOUND TO TRUE.                               06800053
054860                                                                  06810053
054861     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06820053
054862                                             DPG54 DPG55 DPG56.   06830053
054863                                                                  06840053
054864     EVALUATE TRUE                                                06850053
054865         WHEN DPG54-NO-ERROR                                      06860053
054866             DISPLAY ' '                                          06870053
054867             DISPLAY 'RETRIEVING NEW CALCULATED DATE'             06880053
054868             DISPLAY 'DPKUT500 DATE RETRIEVED:'                   06890053
054869                DPG55-DB2-ISO-DATE-FMT                            06900053
054870             SET PS-DATE-FOUND TO TRUE                            06910053
054871         WHEN OTHER                                               06920053
054872             DISPLAY ' '                                          06930053
054873             DISPLAY '** ABEND ** IN ' PC-PROGRAM-NAME            06940053
054874             DISPLAY '** INVALID RETURN FROM CALENDAR ROUTINE'    06950053
054875                       ' TO GET NEW CALCULATED DATE'              06960053
054876             DISPLAY '** ERROR MESSAGE = '                        06970053
054877                               DPG54-ERROR-MESSAGE                06980053
054878             DISPLAY '** CALENDAR TYPE = ' DPG51-CALENDAR-TYPE    06990053
054879             DISPLAY '** DATE FORMAT = ' DPG52-LK-DATE-FORMAT-CODE07000053
054880             DISPLAY '** INPUT DATE  = ' DPG52-LK-DATE-INPUT      07010053
054881                      ', DECREMENT FLAG = '                       07020053
054882                                  DPG51-INCREMENT-DECREMENT-FLAG  07030053
054883                      ', DECREMENT DAYS = ' DPG51-INCR-DECR-DAYS-X07040053
054884             MOVE '6100-DATE-ROUTINE'  TO PV-PARAGRAPH-NAME       07050053
054885             MOVE 'ERROR CALCULATING END DATE'                    07060053
054886                                       TO PV-OPERATION-MSG-1      07070053
054887             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      07080053
054888             SET  AC-4019-CALENDAR-ROUTINE-ERROR TO TRUE          07090053
054889             PERFORM 9800-ABEND                                   07100053
054890     END-EVALUATE.                                                07110053
054891                                                                  07120053
054892*6100-EXIT.                                                       07130053
054893******************************************************************07130153
054894* 7100-OPEN-OFFER-REFRESH-CSR.                                    07130202
054895*       - OPEN THE REFRESH STORE LIST CURSOR.  THE OPEN WILL BE   07130302
054896*         ATTEMPTED UP TO PC-MAX-RETRIES TIMES.                   07130402
054897******************************************************************07130553
054898 7100-OPEN-OFFER-REFRESH-CSR.                                     07130602
054899     MOVE '7100-OPEN-OFFER-REFRESH-CSR' TO PV-PARAGRAPH-NAME.     07130702
054900                                                                  07130802
054901     PERFORM                                                      07130902
054902         WITH TEST AFTER                                          07131002
054903         VARYING PV-SQL-SUB                                       07131102
054904         FROM 1 BY 1                                              07131202
054905         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07131302
054906                   OR  SQLCODE = 0)                               07131402
054907                                                                  07131502
054908         EXEC SQL                                                 07131602
054909           OPEN OFFER-REFRESH-CSR                                 07131702
054910         END-EXEC                                                 07131802
054911                                                                  07131902
054912         EVALUATE TRUE                                            07132002
054913           WHEN SQLCODE = -904                                    07132102
054914           WHEN SQLCODE = -911                                    07132202
054915           WHEN SQLCODE = -913                                    07132302
054916             CONTINUE                                             07132402
054917                                                                  07132502
054918           WHEN SQLCODE = 0                                       07132602
054919             SET PS-NOT-END-OF-REFRESH-CSR TO TRUE                07132702
054920                                                                  07132802
054921           WHEN SQLWARN0 NOT EQUAL SPACE                          07132902
054922           WHEN SQLCODE NOT EQUAL ZERO                            07133002
054923             MOVE 'ERROR ON OPEN OF REFRESH CURSOR'               07133102
054924                                TO PV-DB2-OPERATION               07133202
054925             PERFORM 9900-SQL-ABEND-ROUTINE                       07133302
054926                                                                  07133402
054927         END-EVALUATE                                             07133502
054928     END-PERFORM.                                                 07133602
054929                                                                  07133702
054930     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07133802
054931       MOVE 'OPEN RETRIES EXCEEDED'   TO  PV-DB2-OPERATION        07133902
054932       PERFORM 9900-SQL-ABEND-ROUTINE                             07134002
054933     END-IF.                                                      07134102
054934                                                                  07134202
054935*7100-EXIT.                                                       07134302
054936***********************************************************       07134453
054937* 7200-FETCH-OFFER-REFRESH-CSR.                                   07134502
054938*     - FETCH THE OFFERS REFRESH STORE LIST RECORDS.              07134602
054939***********************************************************       07134753
054940 7200-FETCH-OFFER-REFRESH-CSR.                                    07134802
054941     MOVE '7200-FETCH-OFFER-REFRESH-CSR' TO PV-PARAGRAPH-NAME.    07134902
054942                                                                  07135002
054943     PERFORM                                                      07136053
054944         WITH TEST AFTER                                          07137053
054945         VARYING PV-SQL-SUB                                       07138053
054946         FROM 1 BY 1                                              07139053
054947         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07140053
054948                   OR  SQLCODE = 0                                07150053
054949                   OR  SQLCODE = +100)                            07160053
054950                                                                  07170053
054951           EXEC SQL                                               07180053
054952              FETCH OFFER-REFRESH-CSR                             07190053
054953              INTO  :XST00023-STR-NBR                             07200053
054954                   ,:XST00023-STR-GP-TYP-CDE                      07210053
054955                   ,:XST00023-STR-GP-ID                           07220053
054956           END-EXEC                                               07230053
054957                                                                  07240053
054958          EVALUATE TRUE                                           07250053
054959             WHEN SQLCODE = -904                                  07260053
054960             WHEN SQLCODE = -911                                  07270053
054961             WHEN SQLCODE = -913                                  07280053
054962                  CONTINUE                                        07290053
054963             WHEN SQLCODE = ZERO                                  07300053
054964                  ADD 1 TO PC-CNT-REFRESH-CSR-FETCHES             07310053
054964                  ADD 1 TO PC-CNT-REFRESH-CSR-FETCHES1            07311055
054965             WHEN SQLCODE = +100                                  07320053
054966                  SET PS-END-OF-REFRESH-CSR TO TRUE               07330053
054967             WHEN SQLWARN0 NOT EQUAL SPACE                        07340053
054968             WHEN SQLCODE NOT EQUAL ZERO                          07350053
054969                  MOVE 'ERROR ON FETCHING REFRESH CURSOR'         07360053
054970                                     TO PV-DB2-OPERATION          07370053
054971                  DISPLAY 'SQLCODE= ' SQLCODE                     07380053
054972                  PERFORM 9900-SQL-ABEND-ROUTINE                  07390053
054973          END-EVALUATE                                            07400053
055000     END-PERFORM.                                                 07410053
055100                                                                  07420053
055200     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        07430053
055300         MOVE 'FETCH RETRIES EXCEEDED'                            07440053
055400                               TO  PV-DB2-OPERATION               07450053
055500         PERFORM 9900-SQL-ABEND-ROUTINE                           07460053
055600     END-IF.                                                      07460153
055700                                                                  07460202
055800*7200-EXIT.                                                       07460302
055900***********************************************************       07460453
056000* 7300-CLOSE-REFRESH-CURSOR.                                      07460502
056100*       - CLOSE THE REFRESH STORE LIST CURSOR.  THE CLOSE WILL    07460602
056200*         BE ATTEMPTED UP TO PC-MAX-RETRIES TIMES.                07460702
056300***********************************************************       07460853
056400 7300-CLOSE-OFFER-REFRESH-CSR.                                    07460902
056500     MOVE '7300-CLOSE-OFFER-REFRESH-CSR' TO PV-PARAGRAPH-NAME.    07461002
056600                                                                  07461102
056700     PERFORM                                                      07461202
056800         WITH TEST AFTER                                          07461302
056900         VARYING PV-SQL-SUB                                       07461402
057000         FROM 1 BY 1                                              07461502
057100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 07461602
057200                   OR  SQLCODE = 0)                               07461702
057300                                                                  07461802
057400         EXEC SQL                                                 07461902
057500           CLOSE OFFER-REFRESH-CSR                                07462002
057600         END-EXEC                                                 07462102
057700                                                                  07462202
057800         EVALUATE TRUE                                            07462302
057900           WHEN SQLCODE = -904                                    07462402
058000           WHEN SQLCODE = -911                                    07462502
058100           WHEN SQLCODE = -913                                    07462602
058200             CONTINUE                                             07462702
058300                                                                  07462802
058400           WHEN SQLCODE = 0                                       07462902
058500             CONTINUE                                             07463002
058600                                                                  07463102
058700           WHEN SQLWARN0 NOT EQUAL SPACE                          07463202
058800           WHEN SQLCODE NOT EQUAL ZERO                            07463302
058900             MOVE 'ERROR ON CLOSE OF REFRESH CURSOR'              07463402
059000                                TO PV-DB2-OPERATION               07463502
059100             PERFORM 9900-SQL-ABEND-ROUTINE                       07463602
059200         END-EVALUATE                                             07463702
059300     END-PERFORM.                                                 07463802
059400                                                                  07463902
059500     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         07464002
059600       MOVE 'CLOSE RETRIES EXCEEDED'  TO  PV-DB2-OPERATION        07464102
059700       PERFORM 9900-SQL-ABEND-ROUTINE                             07464202
059800     END-IF.                                                      07464302
059900                                                                  07464402
060000*7300-EXIT.                                                       07464502
060100***********************************************************       07464653
060200* 8000-READ-BATCH-DATE-CNTL-CARD                                  07464753
060300*     READ INPUT BATCH DATE CONTROL CARD - TODAY'S DATE           07464853
060400***********************************************************       07464953
060500 8000-READ-BATCH-DATE-CNTL-CARD.                                  07465053
060600                                                                  07466053
060700     READ CONTROL-CARD-BATCH-DATE INTO EP812-CC-CONTROL-CARD      07467053
060800        AT END SET PS-EOF-BATCH-DTE-CNTL-FILE TO TRUE             07468053
060900            NOT AT END ADD 1 TO PC-CNT-READ-RECS                  07469053
061000     END-READ.                                                    07470053
061100                                                                  07480053
061101** ABEND IF BATCH DATE CONTROL CARD IS EMPTY                      07490053
061102     IF PS-EOF-BATCH-DTE-CNTL-FILE                                07500053
061103        MOVE '8000-READ-BATCH-DATE-CNTL-CARD' TO PV-PARAGRAPH-NAME07510053
061104        MOVE 'BATCH DATE CARD IS EMPTY  '    TO PV-OPERATION-MSG-107520053
061105        SET   AC-4008-CONTROL-CARD-EMPTY     TO TRUE              07530053
061106        PERFORM 9800-ABEND                                        07540053
061107     END-IF.                                                      07550053
061108                                                                  07560053
061200*8000-EXIT.                                                       07570053
061300***********************************************************       07580053
061400* 8100-READ-ADV-DAYS-CNTL-CARD                                    07590053
061500*     READ NEW STORE LEAD DAYS CONTROL CARD.                      07600053
061600*     THIS GETS THE NUMBER OF DAYS FOR WHICH A NEW                07610053
061700*     STORE SHOULD BE ADDED TO THE DISTRIBUTION LIST.             07620053
061800***********************************************************       07630053
061900 8100-READ-ADV-DAYS-CNTL-CARD.                                    07640053
062000                                                                  07650053
062100     READ CONTROL-CARD-ADV-DAYS INTO EP258-ADVDAYS-TO-SND-RECORD  07660053
062200        AT END SET PS-EOF-ADV-DAYS-CNTL-FILE TO TRUE              07670053
062300            NOT AT END ADD 1 TO PC-CNT-READ-RECS                  07680053
062400     END-READ.                                                    07690053
062500                                                                  07700053
062501** ABEND IF NEW STORE DAYS IN ADVANCE CONTROL CARD IS EMPTY       07710053
062502     IF  PS-EOF-ADV-DAYS-CNTL-FILE                                07720053
062503         MOVE '8100-READ-ADV-DAYS-CNTL-CARD' TO PV-PARAGRAPH-NAME 07730053
062504         MOVE 'ADVANCE DAYS CARD IS EMPTY'   TO PV-OPERATION-MSG-107740053
062505         SET  AC-4008-CONTROL-CARD-EMPTY     TO TRUE              07750053
062506         PERFORM 9800-ABEND                                       07760053
062507     END-IF.                                                      07770053
062508                                                                  07780053
062600*8100-EXIT.                                                       07790053
062700***********************************************************       07800053
062800* 8200-WRITE-STR-RFRSH-CNTL-REC.                                  07810053
062900*     WRITES THE FULL FILE EXTRACT STORE GROUP DRIVER RECORD      07820053
063000*     OUT TO THE DRIVER FILE.                                     07830053
063100***********************************************************       07840053
063200 8200-WRITE-STR-RFRSH-CNTL-REC.                                   07850053
063300                                                                  07860053
063400     WRITE REFRESH-STORE-CARD-RECORD                              07870053
063500         FROM EP250-CC-CONTROL-CARD.                              07880053
063600                                                                  07890053
063700     ADD 1 TO PC-CNT-OUT-RECS                                     07900053
                    PC-CNT-OUT-RECS1                                    07901055
063800              PC-CNT-ALL-RECS.                                    07910053
063900                                                                  07920053
064000*8200-EXIT.                                                       07930053
064001***********************************************************       07940053
064002* 8300-WRITE-UPDATED-INPUT.                                       07950053
064003***********************************************************       07960053
064004 8300-WRITE-UPDATED-INPUT.                                        07970053
064005                                                                  07980053
064006     WRITE STORE-OUTPUT-RECORD                                    07990053
064007         FROM OUT-RECORD-UPD.                                     08000053
064008                                                                  08010053
064009                                                                  08020053
064010*8300-EXIT.                                                       08030053
064100***********************************************************       08040053
064200* 9800-ABEND.                                                     08050053
064300*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  08060053
064400***********************************************************       08070053
064500 9800-ABEND.                                                      08080053
064600                                                                  08090053
064700     DISPLAY '** ABEND           **'.                             08100053
064800     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          08110053
064900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        08120053
065000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       08130053
065100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       08140053
065200     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         08150053
065300                                                                  08160053
065400*9800-EXIT.                                                       08170053
065500***********************************************************       08180053
065600* 9900-SQL-ABEND-ROUTINE.                                         08190053
065700*     SQL ABEND ROUTINE.                                          08200053
065800***********************************************************       08210053
065900 9900-SQL-ABEND-ROUTINE.                                          08220053
066000                                                                  08230053
066100     SET AC-4013-DB2-ERROR TO TRUE.                               08240053
066200     DISPLAY '** ABEND     **'.                                   08250053
066300     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                08260053
066400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              08270053
066500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               08280053
066600                                                                  08290053
066700     COPY DPPD004.                                                08300053
066800     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         08310053
066900                                                                  08320053
067000*9900-EXIT.                                                       08330053
067100***********************************************************       08340053
067200* 9999-WRAPUP.                                                    08350053
067300*     END OF PROGRAM ROUTINE.  CLOSES ALL FILES AND DISPLAYS      08360053
067400*     ANY DATA FROM THE PROGRAM.                                  08370053
067500***********************************************************       08380053
067600 9999-WRAPUP.                                                     08390053
067700                                                                  08400053
067800     CLOSE CONTROL-CARD-BATCH-DATE                                08410053
067900           CONTROL-CARD-ADV-DAYS                                  08420053
068000           REFRESH-STORE-CARD-FILE                                08430053
068001           STORE-INPUT-FILE                                       08440053
068002           STORE-OUTPUT-FILE.                                     08450053
068100                                                                  08460053
068200     DISPLAY ' '.                                                 08470053
068300     DISPLAY '*********************************************'.     08480053
068400     DISPLAY 'PROGRAM NAME: ' PC-PROGRAM-NAME.                    08490053
068500     DISPLAY '*********************************************'.     08500053
068800     DISPLAY 'NUMBER OF STORE / STORE GROUP RECS FETCHED: '       08530053
068900                                  PC-CNT-REFRESH-CSR-FETCHES.     08540053
069000     DISPLAY 'NUMBER OF STORE GRP DRIVER RECS WRITTEN: '          08550053
069100                                  PC-CNT-OUT-RECS.                08560053
069200     DISPLAY 'ALL RECS WRITTEN: ' PC-CNT-ALL-RECS.                08570053
069300     DISPLAY '*********************************************'.     08580053
069400                                                                  08590053
069500*9999-EXIT.                                                       08600053
069600**********************  END OF PROGRAM  **********************    08610053
