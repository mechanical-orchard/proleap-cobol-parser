000100*----------------------------------------------------------       00010003
000200 IDENTIFICATION DIVISION.                                         00020003
000300*----------------------------------------------------------       00030003
000400 PROGRAM-ID.    XSKUP032.                                         00040003
000500 AUTHOR.        ALEXIS KEIKER.                                    00050003
000600 DATE-WRITTEN.  OCTOBER 1, 2002.                                  00060003
000700                                                                  00070003
000800*----------------------------------------------------------       00080003
000900*            PRICE VERSION BUSINESS EVENT LOADER                  00090003
001000*----------------------------------------------------------       00100003
001010* THIS PROGRAM WILL PERFORM THE NECESSARY BUSINESS EVENT          00101008
001020* LOAD FOR THE PRICE VERSION BUSINESS EVENT.  THIS PROGRAM IS     00102008
001030* A MODULE AND WILL BE CALLED BY ANOTHER PROGRAM(XSKUT034).       00103015
001040* THERE ARE 5 PARAMETERS PASSED IN THIS PROGRAM.  ONE WILL        00104008
001050* BE THE ACTUAL PRICE VERSION BUSINESS EVENT RECORD, MAXIMUM      00105008
001060* FUTURE OFFSET DATE IN CCYYMMDD, A LOAD SQL RETURN CODE FIELD,   00106008
001070* A PROGRAM STATUS CODE, AND A LOAD SEVERITY LEVEL.  THIS PROGRAM 00107008
001080* WILL EITHER UPDATE OR INSERT A RECORD TO THE XST_PROMO_PRIC_VER 00108008
001090* (PRICE VERSION TABLE).  THIS PROGRAM WILL ALWAYS SEND           00109008
001091* BACK A LOAD SQL RETURN CODE, A PROGRAM STATUS CODE AND A        00109108
001092* LOAD SEVERITY CODE.  IF THE PROGRAM DOES NOT UPDATE OR          00109208
001093* INSERT THE RECORD CORRECTLY IT WILL SELECT THE CORRECT          00109308
001094* ERROR CODES, FIND THE LOAD SEVERITY LEVEL, AND EXIT OUT OF      00109408
001095* THE PROGRAM.                                                    00109508
001100*                                                                 00110003
001101*          SQL CODES - LOAD SQL RETURN CODE                       00110109
001102*             - THIS IS THE LAST SQL RETURN CODE RECEIVED         00110203
001103*               FROM A DATABASE ACTION.                           00110303
001104*                                                                 00110403
001105*          PROGRAM CODES - PROGRAM STATUS CODE                    00110509
001106*           - 00 - ALL DATABASE ACTION WAS SUCCESSFUL AND         00110603
001107*                  WORKED ACCORDING TO THE MESSAGE TYPE.          00110703
001108*           - 01 - AN 'ADD' RECORD WAS TURNED INTO AN             00110803
001109*                  UPDATE AND THE BUSINESS EVENT WAS FOUND        00110903
001110*                  TO BE THE ONE NEEDED ON THE DATABASE.          00111003
001111*           - 02 - AN 'ADD' RECORD WAS TURNED INTO AN UPDATE      00111103
001112*                  AND THE BUSINESS EVENT WAS FOUND TO BE         00111203
001113*                  THE ONE NOT NEEDED ON THE DATABASE.            00111303
001114*           - 03 - AN 'UPDATE' RECORD WAS TURNED INTO AN ADD.     00111403
001115*           - 04 - AN 'UPDATE' RECORD WAS BYPASSED BECAUSE THE    00111515
001116*                  RECORD CURRENTLY ON THE DATABASE WAS THE       00111615
001117*                  MOST RECENT DATA.                              00111715
001118*           - 05 - THE DATABASE ACTION WAS NOT SUCCESSFUL DUE     00111815
001119*                  TO THE RETURNED SQL CODE.                      00111903
001120*           - 06 - UNEXPECTED ACTION CODE RECEIVED.               00112015
001121*                                                                 00112103
001122*          ERROR CODES - LOAD SEVERITY LEVEL                      00112203
001123*            THIS CODE IS FOUND BY TAKING THE MAXIMUM OFFSET      00112308
001124*            DATE AND COMPARING IT TO THE PROMOTION START         00112408
001125*            DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN       00112508
001126*            THE PROMOTION START DATE THE LOAD IS NOT CRITICAL,   00112608
001127*            OTHERWISE IT IS CRITICAL TO THE SYSTEM.              00112708
001128*            THE PROMOTION START DATE IS FOUND BY SELECTING IT    00112808
001129*            FROM XST_PROMO (PROMOTION TABLE).                    00112908
001130*           - 00 - THE LOAD OF THE DATA WAS SUCCESSFUL AND        00113008
001131*                  THEREFORE THE SEVERITY OF THE LOAD DID         00113108
001132*                  NOT NEED TO BE DETERMINED.                     00113208
001133*           - 01 - THE LOAD IS CRITICAL TO A SYSTEM AND           00113303
001134*                  THEREFORE MUST BE RESOLVED ASAP.               00113403
001135*           - 02 - THE LOAD IS NOT CRITICAL AND THEREFORE CAN     00113503
001136*                  WAIT UNTIL A LATER TIME TO BE RESOLVED.        00113603
001137*                                                                 00113703
001138*----------------------------------------------------------       00113803
001139* HISTORY LOG:                                                    00113903
001140*                                                                 00114003
001141*----------------------------------------------------------       00114103
001142* DATE:                                                           00114203
001143* WR/IR#:                                                         00114303
001144* PROGRAMMER:                                                     00114403
001145* DESCRIPTION:                                                    00114503
001146*                                                                 00114603
001147*----------------------------------------------------------       00114703
001148 ENVIRONMENT DIVISION.                                            00114803
001149*----------------------------------------------------------       00114903
001150 CONFIGURATION SECTION.                                           00115003
001151 SOURCE-COMPUTER. IBM-3090.                                       00115103
001152 OBJECT-COMPUTER. IBM-3090.                                       00115203
001153                                                                  00115303
001154 INPUT-OUTPUT SECTION.                                            00115403
001160                                                                  00116003
001170 FILE-CONTROL.                                                    00117003
001180                                                                  00118003
001190*----------------------------------------------------------       00119003
001200 DATA DIVISION.                                                   00120003
001300*----------------------------------------------------------       00130003
001400 FILE SECTION.                                                    00140003
001500                                                                  00150003
001600                                                                  00160003
001700*----------------------------------------------------------       00170024
001800                                                                  00180003
001900 WORKING-STORAGE SECTION.                                         00190003
002000*----------------------------------------------------------       00200024
002100* PC- PROGRAM CONSTANTS                                           00210003
002200*----------------------------------------------------------       00220003
002300 01  PC-PROGRAM-CONSTANTS.                                        00230003
002400     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XSKUP032'. 00240003
002500     05  PC-MAX-RETRIES               PIC S9(04) VALUE +5 COMP.   00250003
002600                                                                  00260003
002700*----------------------------------------------------------       00270003
002800* PS- PROGRAM SWITCHES                                            00280003
002900*----------------------------------------------------------       00290003
003000 01  PS-PROGRAM-SWITCHES.                                         00300003
003100     05  PS-PROCESS-CONTINUE-SW       PIC X(01)  VALUE 'Y'.       00310003
003200         88  PS-PROCESS-CONTINUE                 VALUE 'Y'.       00320003
003300         88  PS-PROCESS-COMPLETE                 VALUE 'N'.       00330003
003400                                                                  00340003
003500*----------------------------------------------------------       00350003
003600* PV- PROGRAM VARIABLES                                           00360003
003700*----------------------------------------------------------       00370003
003800 01 PV-PROGRAM-VARIABLES.                                         00380003
003900    05  PV-SQL-SUB                    PIC S9(4)  VALUE +0 COMP.   00390003
004000    05  PV-MAX-OFFSET-DTE             PIC 9(08)  VALUE 0.         00400003
004010    05  PV-SQL-CODE                   PIC S9(4)  VALUE +0.        00401006
004020    05  PV-ACT-STRT-TMST              PIC X(26)  VALUE SPACES.    00402017
004100    05  PV-LAST-UPD-TMST              PIC X(26)  VALUE SPACES.    00410003
004220    05  PV-ACTION-CODE                PIC X(01).                  00422003
004230        88  PV-INSERT-DATA                       VALUE 'I'.       00423003
004240        88  PV-UPDATE-DATA                       VALUE 'U'.       00424003
004250    05  PV-LD-STATUS-CDE              PIC X(02).                  00425003
004260        88  PV-NO-ERROR                          VALUE '00'.      00426007
004270        88  PV-CRITICAL-ERROR                    VALUE '01'.      00427003
004280        88  PV-NOT-CRITICAL-ERROR                VALUE '02'.      00428003
004290    05  PV-PGM-STATUS-CDE             PIC X(02).                  00429003
004300        88  PV-SUCCESS-CDE                       VALUE '00'.      00430003
004400        88  PV-UPDATE-NEED                       VALUE '01'.      00440003
004500        88  PV-UPDATE-NOT-NEED                   VALUE '02'.      00450003
004600        88  PV-ADD-CDE                           VALUE '03'.      00460003
004610        88  PV-UPDATE-BYPASS                     VALUE '04'.      00461015
004700        88  PV-NO-SUCCESS-CDE                    VALUE '05'.      00470015
004800        88  PV-UNEXPECT-CDE                      VALUE '06'.      00480015
004900                                                                  00490003
004910    05  PV-PROMO-STRT-DTE-TM.                                     00491016
004920        10  PV-PROMO-STRT-DTE.                                    00492016
004930            15  PV-PROMO-DTE-TM-CCYY      PIC X(04).              00493016
004940            15  FILLER                    PIC X(01).              00494016
004950            15  PV-PROMO-DTE-TM-MM        PIC X(02).              00495016
004960            15  FILLER                    PIC X(01).              00496016
004970            15  PV-PROMO-DTE-TM-DD        PIC X(02).              00497016
004980        10  PV-PROMO-STRT-TM              PIC X(16).              00498016
004990                                                                  00499016
005000    05  PV-PRC-VER-STRT-DTE-NBR.                                  00500003
005100        10  PV-PRC-VER-DTE-CCYY           PIC 9(04).              00510003
005200        10  PV-PRC-VER-DTE-MM             PIC 9(02).              00520003
005300        10  PV-PRC-VER-DTE-DD             PIC 9(02).              00530003
005400                                                                  00540003
005500    05  PV-PRC-VER-STRT-DTE.                                      00550004
005700        15  PV-PRC-VER-DTE-CH-CCYY        PIC X(04).              00570004
005800        15  FILLER                        PIC X(01).              00580004
005900        15  PV-PRC-VER-DTE-CH-MM          PIC X(02).              00590004
006000        15  FILLER                        PIC X(01).              00600004
006100        15  PV-PRC-VER-DTE-CH-DD          PIC X(02).              00610004
006300                                                                  00630003
007300*----------------------------------------------------------       00730003
007400* PRICE VERSION BUSINESS EVENT RECORD LAYOUT                      00740003
007500*----------------------------------------------------------       00750003
007600     COPY XSRD017.                                                00760003
007700                                                                  00770003
008300*----------------------------------------------------------       00830003
008400* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         00840003
008500*----------------------------------------------------------       00850003
008600     COPY DPWS004.                                                00860003
008700                                                                  00870003
008800*----------------------------------------------------------       00880024
008900*  DB2 COMMUNICATION AREA.                                        00890003
009000*----------------------------------------------------------       00900024
009100     EXEC SQL                                                     00910003
009200          INCLUDE SQLCA                                           00920003
009300     END-EXEC.                                                    00930003
009400                                                                  00940003
009410*----------------------------------------------------------       00941024
009420*  DB2 TABLE XST00026(XST_PROMO) - PROMOTION TABLE                00942006
009430*----------------------------------------------------------       00943024
009440     EXEC SQL                                                     00944006
009450          INCLUDE XST00026                                        00945006
009460     END-EXEC.                                                    00946006
009470                                                                  00947006
009500*----------------------------------------------------------       00950024
009600*  DB2 TABLE XST00032(XST_PROMO_PRIC_VER) - PRICE VERSION TABLE   00960003
009700*----------------------------------------------------------       00970024
009800     EXEC SQL                                                     00980003
009900          INCLUDE XST00032                                        00990003
010000     END-EXEC.                                                    01000003
010100                                                                  01010003
010200 LINKAGE SECTION.                                                 01020003
010300                                                                  01030003
010400*----------------------------------------------------------       01040003
010500* FILE INFORMATION BEING PASSED TO AND FROM THIS MODULE.          01050003
010600*----------------------------------------------------------       01060003
010700 01 LV-LINKAGE-VARIABLES.                                         01070003
010800    05  LV-PRC-VER-BUS-REC         PIC X(300).                    01080003
010900    05  LV-MAX-OFFSET-DTE          PIC X(08).                     01090003
011000    05  LV-LD-SQL-RETURN-CDE       PIC S9(4).                     01100003
011100    05  LV-PGM-STATUS-CDE          PIC X(02).                     01110003
011200    05  LV-LD-SEVERITY-LVL         PIC X(02).                     01120003
011300                                                                  01130003
011400                                                                  01140003
011500*----------------------------------------------------------       01150003
011600 PROCEDURE DIVISION USING LV-LINKAGE-VARIABLES.                   01160003
011700*----------------------------------------------------------       01170003
011800 0000-MAINLINE.                                                   01180003
011900                                                                  01190003
012000     PERFORM 1000-INITIALIZATION.                                 01200003
012100                                                                  01210003
012200     PERFORM 2000-PROCESS-MESSAGE                                 01220003
012300             UNTIL PS-PROCESS-COMPLETE.                           01230003
012400                                                                  01240003
012500     PERFORM 9999-WRAPUP.                                         01250003
012600                                                                  01260003
012700     EXIT PROGRAM.                                                01270025
012800                                                                  01280003
012900*0000-EXIT.                                                       01290003
013000 EJECT.                                                           01300003
013100                                                                  01310003
013200*----------------------------------------------------------       01320003
013300* 1000-INITIALIZATION.                                            01330003
013400*     INTIALIZES OR MOVES ANY VARIABLES BEFORE IT WILL            01340003
013500*     UPDATE OR INSERT A RECORD.                                  01350003
013600*----------------------------------------------------------       01360003
013700 1000-INITIALIZATION.                                             01370003
013800                                                                  01380003
013900     INITIALIZE DCLXST00032.                                      01390003
013910     INITIALIZE PV-SQL-CODE.                                      01391006
014000     MOVE LV-PRC-VER-BUS-REC   TO XS017-PRICE-VERSION-RECORD.     01400021
014100     MOVE XS017-ACTION-CDE     TO PV-ACTION-CODE.                 01410003
014600     SET PV-NO-ERROR           TO TRUE.                           01460003
014700     SET PV-SUCCESS-CDE        TO TRUE.                           01470003
014800     SET PS-PROCESS-CONTINUE   TO TRUE.                           01480003
014900                                                                  01490003
014910     IF LV-MAX-OFFSET-DTE = SPACES                                01491003
014920        INITIALIZE PV-MAX-OFFSET-DTE                              01492003
014930     ELSE                                                         01493003
014940        MOVE LV-MAX-OFFSET-DTE    TO PV-MAX-OFFSET-DTE            01494003
014950     END-IF.                                                      01495003
014960                                                                  01496003
014980     PERFORM 1100-POPULATE-DCLGEN.                                01498003
014990                                                                  01499003
015000*1000-EXIT.                                                       01500003
015100 EJECT.                                                           01510003
015200                                                                  01520003
015300*----------------------------------------------------------       01530003
015400* 1100-POPULATE-DCLGEN.                                           01540003
015500*     POPULATES THE PRICE VERSION TABLE VARIABLES.                01550023
015700*----------------------------------------------------------       01570003
015800 1100-POPULATE-DCLGEN.                                            01580003
015900                                                                  01590003
016200     MOVE XS017-PROMO-PRIC-VER-ID                                 01620014
016201                                TO XST00032-PROMO-PRIC-VER-ID.    01620114
016220     MOVE XS017-PROMO-ID        TO XST00032-PROMO-ID.             01622014
016300     MOVE XS017-PRIC-VER-ABBR-NM                                  01630003
016400                                TO XST00032-PRIC-VER-ABBR-NM.     01640003
016500     MOVE XS017-STAT-CDE        TO XST00032-STAT-CDE.             01650003
016700     MOVE XS017-LAST-UPD-TMST   TO XST00032-SOR-LAST-UPD-TMST.    01670015
017300                                                                  01730003
017400*1100-EXIT.                                                       01740003
017500 EJECT.                                                           01750003
017600                                                                  01760003
017700*----------------------------------------------------------       01770003
017800* 2000-PROCESS-MESSAGE.                                           01780003
017900*     THIS CHECKS THE ACTION TO SEE WHETHER THE RECORD            01790003
018000*     SHOULD BE INSERTED INTO THE PRICE VERSION TABLE OR UPDATED. 01800003
018100*     IF SOMETHING IS WRONG WITH THE ACTION CODE IT WILL          01810003
018200*     PROCESS AN ERROR AND EXIT THE PROGRAM.                      01820003
018300*----------------------------------------------------------       01830003
018400 2000-PROCESS-MESSAGE.                                            01840003
018500                                                                  01850003
018600     EVALUATE TRUE                                                01860003
018700        WHEN PV-INSERT-DATA                                       01870003
018800             PERFORM 2100-INSERT-DATA                             01880003
018900        WHEN PV-UPDATE-DATA                                       01890003
019000             PERFORM 2200-UPDATE-DATA                             01900003
019100        WHEN OTHER                                                01910003
019200             SET PS-PROCESS-COMPLETE TO TRUE                      01920003
019300             SET PV-UNEXPECT-CDE     TO TRUE                      01930003
019400             PERFORM 9000-LOAD-SEVERITY-ERROR                     01940003
019500     END-EVALUATE.                                                01950003
019600                                                                  01960003
019700*2000-EXIT.                                                       01970003
019800 EJECT.                                                           01980003
019900                                                                  01990003
020000*------------------------------------------------------           02000003
020100* 2100-INSERT-DATA.                                               02010003
020200*     INSERT THE PRICE VERSION RECORD.                            02020003
020300*------------------------------------------------------           02030003
020400 2100-INSERT-DATA.                                                02040003
020500                                                                  02050003
020600     PERFORM                                                      02060003
020700         WITH TEST AFTER                                          02070003
020800         VARYING PV-SQL-SUB                                       02080003
020900         FROM 1 BY 1                                              02090003
021000         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 02100003
021100                   OR  SQLCODE NOT = -904 AND -911 AND -913)      02110011
021400                                                                  02140003
021500         EXEC SQL                                                 02150003
021600             INSERT INTO XST_PROMO_PRIC_VER                       02160003
021700                                      (PROMO_PRIC_VER_ID          02170003
021710                                      ,PROMO_ID                   02171013
021800                                      ,PRIC_VER_ABBR_NM           02180003
021900                                      ,STAT_CDE                   02190003
022000                                      ,LAST_UPD_TMST              02200015
022100                                      ,SOR_LAST_UPD_TMST)         02210015
022700             VALUES                                               02270003
022800                (:XST00032-PROMO-PRIC-VER-ID                      02280003
022810                ,:XST00032-PROMO-ID                               02281013
022900                ,:XST00032-PRIC-VER-ABBR-NM                       02290003
023000                ,:XST00032-STAT-CDE                               02300003
023010                ,CURRENT TIMESTAMP                                02301015
023100                ,:XST00032-SOR-LAST-UPD-TMST)                     02310015
023450         END-EXEC                                                 02345003
023460                                                                  02346003
023461         MOVE SQLCODE TO PV-SQL-CODE                              02346111
023462                                                                  02346211
023470         EVALUATE TRUE                                            02347003
023480             WHEN SQLCODE = -904                                  02348003
023490             WHEN SQLCODE = -911                                  02349003
023500             WHEN SQLCODE = -913                                  02350003
023600                  CONTINUE                                        02360003
023700             WHEN SQLCODE = 0                                     02370003
023800                  SET PS-PROCESS-COMPLETE TO TRUE                 02380003
023900             WHEN SQLCODE = -803                                  02390003
024000                  PERFORM 2300-SELECT-DATA                        02400015
024010                  MOVE -803 TO SQLCODE                            02401022
024100             WHEN OTHER                                           02410003
024200                  SET PS-PROCESS-COMPLETE TO TRUE                 02420003
024300                  SET PV-NO-SUCCESS-CDE TO TRUE                   02430003
024400                  PERFORM 9000-LOAD-SEVERITY-ERROR                02440003
024410                  MOVE +0 TO SQLCODE                              02441022
024500         END-EVALUATE                                             02450003
024600     END-PERFORM.                                                 02460003
024720                                                                  02472006
024800     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         02480003
024900        SET PS-PROCESS-COMPLETE TO TRUE                           02490003
025000        SET PV-NO-SUCCESS-CDE TO TRUE                             02500003
025100        PERFORM 9000-LOAD-SEVERITY-ERROR                          02510003
025200     END-IF.                                                      02520003
025300                                                                  02530003
025400*2100-EXIT.                                                       02540003
025500 EJECT.                                                           02550003
025600                                                                  02560003
032100*------------------------------------------------------           03210003
032200* 2200-UPDATE-DATA.                                               03220003
032300*     UPDATE THE PRICE VERSION RECORD.                            03230003
032400*------------------------------------------------------           03240003
032500 2200-UPDATE-DATA.                                                03250003
032600                                                                  03260003
032700     PERFORM                                                      03270003
032800         WITH TEST AFTER                                          03280003
032900         VARYING PV-SQL-SUB                                       03290003
033000         FROM 1 BY 1                                              03300003
033100         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03310003
033200                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03320011
033500                                                                  03350003
033600         EXEC SQL                                                 03360003
033700             UPDATE XST_PROMO_PRIC_VER                            03370005
033800             SET  PROMO_PRIC_VER_ID                               03380003
033810                                    = :XST00032-PROMO-PRIC-VER-ID,03381015
033820                  PROMO_ID          = :XST00032-PROMO-ID,         03382015
033900                  PRIC_VER_ABBR_NM  = :XST00032-PRIC-VER-ABBR-NM, 03390015
034000                  STAT_CDE          = :XST00032-STAT-CDE,         03400015
034100                  LAST_UPD_TMST     = CURRENT TIMESTAMP,          03410015
034200                  SOR_LAST_UPD_TMST = :XST00032-SOR-LAST-UPD-TMST 03420015
034810            WHERE PROMO_PRIC_VER_ID                               03481015
034820                                    = :XST00032-PROMO-PRIC-VER-ID 03482015
034821              AND SOR_LAST_UPD_TMST <= :XST00032-SOR-LAST-UPD-TMST03482119
034830         END-EXEC                                                 03483003
034840                                                                  03484003
034841         MOVE SQLCODE TO PV-SQL-CODE                              03484111
034842                                                                  03484211
034850         EVALUATE TRUE                                            03485003
034860             WHEN SQLCODE = -904                                  03486003
034870             WHEN SQLCODE = -911                                  03487003
034880             WHEN SQLCODE = -913                                  03488003
034890                  CONTINUE                                        03489003
034900             WHEN SQLCODE = 0                                     03490003
035000                  SET PS-PROCESS-COMPLETE TO TRUE                 03500003
035100             WHEN SQLCODE = +100                                  03510003
035200                  PERFORM 2300-SELECT-DATA                        03520015
035300                  MOVE +100 TO SQLCODE                            03530022
035400             WHEN OTHER                                           03540003
035500                  SET PS-PROCESS-COMPLETE TO TRUE                 03550003
035600                  SET PV-NO-SUCCESS-CDE TO TRUE                   03560003
035700                  PERFORM 9000-LOAD-SEVERITY-ERROR                03570003
035710                  MOVE +0 TO SQLCODE                              03571022
035800         END-EVALUATE                                             03580003
035900     END-PERFORM.                                                 03590003
036020                                                                  03602006
036100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03610003
036200        SET PS-PROCESS-COMPLETE TO TRUE                           03620003
036300        SET PV-NO-SUCCESS-CDE TO TRUE                             03630003
036400        PERFORM 9000-LOAD-SEVERITY-ERROR                          03640003
036500     END-IF.                                                      03650003
036600                                                                  03660003
036700*2200-EXIT.                                                       03670003
036800 EJECT.                                                           03680003
036900                                                                  03690003
036910*------------------------------------------------------           03691015
036920* 2300-SELECT-DATA.                                               03692015
036930*     SELECT THE TIMESTAMP IN THE PRICE VERSION RECORD.           03693015
036940*------------------------------------------------------           03694015
036950 2300-SELECT-DATA.                                                03695015
036960                                                                  03696015
036970     PERFORM                                                      03697015
036980         WITH TEST AFTER                                          03698015
036990         VARYING PV-SQL-SUB                                       03699015
036991         FROM 1 BY 1                                              03699115
036992         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03699215
036993                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03699315
036994                                                                  03699415
036995         EXEC SQL                                                 03699515
036996             SELECT  SOR_LAST_UPD_TMST                            03699615
036997               INTO :PV-LAST-UPD-TMST                             03699715
036998               FROM  XST_PROMO_PRIC_VER                           03699815
036999              WHERE  PROMO_PRIC_VER_ID                            03699915
037000                                 = :XST00032-PROMO-PRIC-VER-ID    03700015
037001         END-EXEC                                                 03700115
037002                                                                  03700215
037003         MOVE SQLCODE TO PV-SQL-CODE                              03700315
037004                                                                  03700415
037005         EVALUATE TRUE                                            03700515
037006             WHEN SQLCODE = -904                                  03700615
037007             WHEN SQLCODE = -911                                  03700715
037008             WHEN SQLCODE = -913                                  03700815
037009                  CONTINUE                                        03700915
037010             WHEN SQLCODE = 0                                     03701015
037012                  IF PV-UPDATE-DATA                               03701215
037013                     SET PS-PROCESS-COMPLETE TO TRUE              03701315
037014                     SET PV-UPDATE-BYPASS TO TRUE                 03701415
037015                  ELSE                                            03701515
037016                     PERFORM 2350-TMST-COMPARE                    03701624
037017                  END-IF                                          03701715
037018             WHEN SQLCODE = +100                                  03701815
037019                  SET PV-INSERT-DATA TO TRUE                      03701915
037020                  SET PV-ADD-CDE TO TRUE                          03702015
037021             WHEN OTHER                                           03702115
037022                  SET PS-PROCESS-COMPLETE TO TRUE                 03702215
037023                  SET PV-NO-SUCCESS-CDE TO TRUE                   03702315
037024                  PERFORM 9000-LOAD-SEVERITY-ERROR                03702415
037025                  MOVE +0 TO SQLCODE                              03702522
037026         END-EVALUATE                                             03702615
037027     END-PERFORM.                                                 03702715
037028                                                                  03702815
037029     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03702915
037030        SET PS-PROCESS-COMPLETE TO TRUE                           03703015
037031        SET PV-NO-SUCCESS-CDE TO TRUE                             03703115
037032        PERFORM 9000-LOAD-SEVERITY-ERROR                          03703215
037033     END-IF.                                                      03703315
037034                                                                  03703415
037035*2300-EXIT.                                                       03703515
037036 EJECT.                                                           03703615
037037                                                                  03703715
037038*--------------------------------------------------------         03703815
037039* 2350-TMST-COMPARE.                                              03703924
037040*     COMPARE DATE OF EXISTING ROW TO MESSAGE RECORD              03704024
037041*     AND UPDATE IF MESSAGE HAS A NEWER TIMESTAMP.                03704124
037042*--------------------------------------------------------         03704215
037043 2350-TMST-COMPARE.                                               03704324
037044                                                                  03704415
037045     IF XS017-LAST-UPD-TMST >= PV-LAST-UPD-TMST                   03704515
037046        SET PV-UPDATE-DATA      TO TRUE                           03704615
037047        SET PV-UPDATE-NEED      TO TRUE                           03704715
037048     ELSE                                                         03704815
037049        SET PS-PROCESS-COMPLETE TO TRUE                           03704915
037050        SET PV-UPDATE-NOT-NEED  TO TRUE                           03705015
037051     END-IF.                                                      03705115
037052                                                                  03705215
037053*2350-EXIT.                                                       03705315
037054 EJECT.                                                           03705415
037055                                                                  03705515
037060*----------------------------------------------------------       03706003
037100* 9000-LOAD-SEVERITY-ERROR.                                       03710003
037200*     THIS PROCEDURE IS CALLED IF THE RECORD WAS NOT UPDATED      03720003
037300*     OR INSERTED INTO THE PRICE VERSION TABLE.  COMPARES THE     03730003
037400*     MAXIMUM OFFSET DATE TO THE PRICE VERSION BUSINESS EVENT     03740003
037500*     START DATE.  IF THE MAXIMUM OFFSET DATE IS LESS THAN THE    03750003
037600*     PRICE VERSION START DATE THE ERROR IS UNCRITICAL,           03760003
037700*     OTHERWISE IT IS CRITICAL.                                   03770003
037800*----------------------------------------------------------       03780003
037900 9000-LOAD-SEVERITY-ERROR.                                        03790003
038000                                                                  03800003
038010     INITIALIZE DCLXST00026.                                      03801006
038020                                                                  03802006
038021     MOVE XS017-PROMO-ID  TO XST00026-PROMO-ID.                   03802114
038023                                                                  03802306
038024     PERFORM 9010-SELECT-STRT-DATE.                               03802406
038025                                                                  03802506
038100     IF PV-PRC-VER-STRT-DTE = SPACES                              03810004
038200        MOVE ZEROES TO PV-PRC-VER-STRT-DTE-NBR                    03820004
038300     ELSE                                                         03830003
038400        PERFORM 9100-FORMAT-DATE-INFO                             03840003
038500     END-IF.                                                      03850003
038600                                                                  03860003
038700     IF (PV-MAX-OFFSET-DTE < PV-PRC-VER-STRT-DTE-NBR) AND         03870004
038800       (PV-MAX-OFFSET-DTE NOT = ZEROES) AND                       03880003
038900       (PV-PRC-VER-STRT-DTE-NBR NOT = ZEROES)                     03890004
039000        SET PV-NOT-CRITICAL-ERROR TO TRUE                         03900003
039100     ELSE                                                         03910003
039200        SET PV-CRITICAL-ERROR TO TRUE                             03920003
039300     END-IF.                                                      03930003
039400                                                                  03940003
039500*9000-EXIT.                                                       03950003
039600 EJECT.                                                           03960003
039700                                                                  03970003
039710*------------------------------------------------------           03971006
039720* 9010-SELECT-STRT-DATE.                                          03972004
039730*     SELECT THE START DATE OF THE PROMOTION.                     03973024
039740*------------------------------------------------------           03974004
039750 9010-SELECT-STRT-DATE.                                           03975004
039760                                                                  03976004
039770     PERFORM                                                      03977004
039780         WITH TEST AFTER                                          03978004
039790         VARYING PV-SQL-SUB                                       03979004
039791         FROM 1 BY 1                                              03979104
039792         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 03979204
039793                   OR  SQLCODE NOT = -904 AND -911 AND -913)      03979311
039796                                                                  03979604
039797         EXEC SQL                                                 03979704
039798             SELECT  ACTL_STRT_TMST                               03979818
039799               INTO :PV-ACT-STRT-TMST                             03979917
039800               FROM  XST_PROMO                                    03980004
039801              WHERE  PROMO_ID   = :XST00026-PROMO-ID              03980104
039803              WITH UR                                             03980314
039804         END-EXEC                                                 03980404
039805                                                                  03980504
039806         EVALUATE TRUE                                            03980604
039807             WHEN SQLCODE = -904                                  03980704
039808             WHEN SQLCODE = -911                                  03980804
039809             WHEN SQLCODE = -913                                  03980904
039810                  CONTINUE                                        03981004
039811             WHEN SQLCODE = 0                                     03981104
039813                  MOVE PV-ACT-STRT-TMST TO PV-PROMO-STRT-DTE-TM   03981317
039814                  MOVE PV-PROMO-STRT-DTE TO PV-PRC-VER-STRT-DTE   03981416
039815             WHEN OTHER                                           03981504
039816                  MOVE SPACES TO PV-PRC-VER-STRT-DTE              03981604
039817         END-EVALUATE                                             03981704
039818     END-PERFORM.                                                 03981804
039819                                                                  03981904
039820     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         03982004
039822        MOVE SPACES TO PV-PRC-VER-STRT-DTE                        03982204
039824     END-IF.                                                      03982404
039825                                                                  03982504
039826     INITIALIZE PV-SQL-SUB.                                       03982612
039827                                                                  03982712
039828*9010-EXIT.                                                       03982804
039829 EJECT.                                                           03982904
039830                                                                  03983004
039840*----------------------------------------------------------       03984003
039900* 9100-FORMAT-DATE-INFO.                                          03990003
040000*     FORMATS THE DATE FOR COMPARING.                             04000003
040100*----------------------------------------------------------       04010003
040200 9100-FORMAT-DATE-INFO.                                           04020003
040300                                                                  04030003
040400     MOVE PV-PRC-VER-DTE-CH-CCYY TO PV-PRC-VER-DTE-CCYY.          04040004
040500     MOVE PV-PRC-VER-DTE-CH-MM   TO PV-PRC-VER-DTE-MM.            04050004
040600     MOVE PV-PRC-VER-DTE-CH-DD   TO PV-PRC-VER-DTE-DD.            04060004
040700                                                                  04070003
040800*9100-EXIT.                                                       04080003
040900 EJECT.                                                           04090003
041000                                                                  04100003
041100*----------------------------------------------------------       04110003
041200* 9999-WRAPUP.                                                    04120003
041300*     MOVES ALL ERROR CODES TO THE LINKAGE VARIABLES TO           04130003
041400*     BE PASSED BACK TO THE CALLING PROGRAM.  EXITS THE           04140003
041500*     PROGRAM.                                                    04150003
041600*----------------------------------------------------------       04160003
041700 9999-WRAPUP.                                                     04170003
041800                                                                  04180003
041900     MOVE PV-PGM-STATUS-CDE TO LV-PGM-STATUS-CDE.                 04190003
042000     MOVE PV-SQL-CODE       TO LV-LD-SQL-RETURN-CDE.              04200004
042100     MOVE PV-LD-STATUS-CDE  TO LV-LD-SEVERITY-LVL.                04210003
042200                                                                  04220003
042300*9999-EXIT.                                                       04230003
042400 EJECT.                                                           04240003
042500                                                                  04250003
