000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         AHKUP038.                                    00020000
000300 AUTHOR.             NANCY EILBES.                                00030000
000400 DATE-WRITTEN.       APRIL 2000.                                  00040000
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000700*    COBOL 2 WITH SQL                                       *     00070000
000800*                                                           *     00080000
000900*   AHKUP038 - ARCHIVE HISTORY DATA DELETION - TPLNSHP      *     00090000
001000*                                                           *     00100000
001100*   PROGRAM OVERVIEW:                                       *     00110000
001200*                                                           *     00120000
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TPLNSHP.  *     00130000
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140000
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150000
001600*                                                           *     00160000
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170000
001800*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00180000
001900*  THESE COLUMNS ARE PO_NBR, DONT_SHIP_BEF_DTE,             *     00190000
002000*  CAN_IFNOT_SHIP_DTE.                                      *     00200000
002100*                                                           *     00210000
002200*  !!!!!NOTE!!!!!  THE LOGIC IN THIS PROGRAM IS SLIGHTLY    *     00220000
002300*  DIFFERENT THAN THE OTHER DELETION PROGRAMS.  WHILE THE   *     00230000
002400*  INPUT FILE WILL BE SORTED BY THE FULL CLUSTERING INDEX,  *     00240000
002500*  THE DELETE SQL WILL USE ONLY THE PO NUMBER.  THIS MEANS  *     00250000
002600*  THAT THE DELETE STATEMENT MAY DELETE MULTIPLE ROWS, AND  *     00260000
002700*  THE READ OF THE INPUT IS SET UP TO READ UNTIL THE NEXT   *     00270000
002800*  PO IS FOUND, INSTEAD OF PROCESSING EACH RECORD.          *     00280000
002900*                                                           *     00290000
003000*   INPUT:                                                  *     00300000
003100*                                                           *     00310000
003200*     1. TPLNSHP DELETION FILE  COPYBOOK DCLTPLNSHP         *     00320000
003300*                                                           *     00330000
003400*   DB2 TABLES:                                             *     00340000
003500*                                                           *     00350000
003600*        TPLNSHP - PO PLAN SHIPMENT TABLE                   *     00360000
003700*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00370000
003800*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00380000
003900*                                                           *     00390000
004000*************************************************************     00400000
P5207 * DATE: 11/18/2013 CHANGE MADE BY: COGNIZANT(SHEBENA)       *     00410020
P5207 * CHANGE MADE: MODIFIED THE PROGRAM TO REMOVE THE           *     00411020
P5207 *              PO_IN_RMS_IND CHECK BEFORE DELETE.           *     00412020
P5207 * CHANGE TAG - P5207, CR NO - CHG0081355                    *     00413021
004200*************************************************************     00420000
004300 EJECT                                                            00430000
004400 ENVIRONMENT DIVISION.                                            00440000
004500 CONFIGURATION SECTION.                                           00450000
004600 SOURCE-COMPUTER.        IBM-370.                                 00460000
004700 OBJECT-COMPUTER.        IBM-370.                                 00470000
004800                                                                  00480000
004900 INPUT-OUTPUT SECTION.                                            00490000
005000 FILE-CONTROL.                                                    00500000
005100     SELECT TPLNSHP-EXTRACT-FILE ASSIGN TO INP01.                 00510000
005200                                                                  00520000
005300 DATA DIVISION.                                                   00530000
005400 FILE SECTION.                                                    00540000
005500 FD  TPLNSHP-EXTRACT-FILE                                         00550000
005600     RECORDING MODE IS F                                          00560000
005700     LABEL RECORDS ARE STANDARD                                   00570000
005800     BLOCK CONTAINS 0 RECORDS                                     00580000
005900     RECORD CONTAINS 184 CHARACTERS                               00590000
006000     DATA RECORD IS TPLNSHP-EXTRACT-DATA.                         00600000
006100 01  TPLNSHP-EXTRACT-DATA       PIC X(184).                       00610000
006200                                                                  00620000
006300                                                                  00630000
006400 EJECT                                                            00640000
006500 WORKING-STORAGE SECTION.                                         00650000
006600                                                                  00660000
006700 01  FILLER                       PIC X(58)     VALUE             00670000
006800     '************WORKING STORAGE STARTS HERE*******************'.00680000
006900                                                                  00690000
007000 01  PV-PROGRAM-VARIABLES.                                        00700000
007100     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'AHKUP038'. 00710000
007200     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00720000
007300     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00730000
007400     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00740000
007500                                                                  00750000
007600     05  PV-TPLNSHP-INPUT-COUNT   PIC 9(09)     VALUE ZERO        00760000
007700                                                COMP-3.           00770000
007800     05  PV-TPLNSHP-DELETE-COUNT  PIC 9(09)     VALUE ZERO        00780000
007900                                                COMP-3.           00790000
008000     05  PV-SQL-DELETE-COUNT      PIC 9(09)     VALUE ZERO        00800000
008100                                                COMP-3.           00810000
008200     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00820000
008300                                                COMP-3.           00830000
008400     05  PV-DISP-PO-NBR           PIC X(09)    VALUE SPACES.      00840000
008500     05  PV-PROCESSED-PO          PIC S9(9) VALUE ZERO COMP.      00850000
008700     05  PV-SAVE-PO-NBR           PIC S9(09) COMP                 00870000
008800                                               VALUE ZEROES.      00880000
008900 01  PC-PROGRAM-CONSTANTS.                                        00890000
009000     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00900000
009100                                                COMP SYNC.        00910000
009200     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00920000
009300     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00930000
009400     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00940000
009500                                                                  00950000
009600 01  PS-PROGRAM-SWITCHES.                                         00960000
009700     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00970000
009800         88  COMMITS-TAKEN                      VALUE 'T'.        00980000
009900         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00990000
010000     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        01000000
010100         88  MORE-EXTRACT                       VALUE 'M'.        01010000
010200         88  END-OF-EXTRACT                     VALUE 'E'.        01020000
010300     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        01030000
010400         88  NORMAL-RUN                         VALUE '0'.        01040000
010500         88  RESTART-RUN                        VALUE '9'.        01050000
010900                                                                  01090000
011000 01  WS-COUNTER.                                                  01100000
011100     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01110000
011200     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01120000
011300                                                                  01130000
011400 01  CKPT-RESTART-INFO.                                           01140000
011500     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01150000
011600                                                                  01160000
011700*----------------------------------------------------------------*01170000
011800*  ABEND DATA AREAS                                              *01180000
011900*----------------------------------------------------------------*01190000
012000 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01200000
012100                                             COMP SYNC.           01210000
012200     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01220000
012300     88  AC-BAD-DATA                         VALUE +4008.         01230000
012400     88  AC-DB2-ERROR                        VALUE +4013.         01240000
012500     88  AC-DATE-ERROR                       VALUE +4019.         01250000
012600                                                                  01260000
012700                                                                  01270000
012800 01  ABEND-AREAS.                                                 01280000
012900     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01290000
013000             '*****       ABEND'.                                 01300000
013100     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01310000
013200             '*****   PROGRAM: AHKUP038'.                         01320000
013300     05  AA-PARAGRAPH-LIT.                                        01330000
013400         10  FILLER              PIC  X(17)  VALUE                01340000
013500             '***** PARAGRAPH: '.                                 01350000
013600         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01360000
013700     05  AA-MESSAGE-LINE-1.                                       01370000
013800         10  FILLER              PIC  X(06)  VALUE '*****'.       01380000
013900         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01390000
014000     05  AA-MESSAGE-LINE-2.                                       01400000
014100         10  FILLER              PIC  X(06)  VALUE '*****'.       01410000
014200         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01420000
014300     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01430000
014400             '*****    DB2 ERROR'.                                01440000
014500     05  AA-DB2-OPERATION-LIT.                                    01450000
014600         10  FILLER              PIC  X(17)  VALUE                01460000
014700             '***** OPERATION: '.                                 01470000
014800         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01480000
014900     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01490000
015000     EJECT                                                        01500000
015100                                                                  01510000
015200     COPY DPWS004.                                                01520000
015300     EJECT                                                        01530000
015400*----------------------------------------------------------------*01540000
015500*      TPLNSHP TABLE LAYOUT                                       01550000
015600*----------------------------------------------------------------*01560000
015700         EXEC SQL                                                 01570000
015800             INCLUDE TPLNSHP                                      01580000
015900         END-EXEC.                                                01590000
016000                                                                  01600000
016100*----------------------------------------------------------------*01610000
016200*      TPURCHS TABLE LAYOUT                                       01620000
016300*----------------------------------------------------------------*01630000
016400         EXEC SQL                                                 01640000
016500             INCLUDE TPURCHS                                      01650000
016600         END-EXEC.                                                01660000
016700                                                                  01670000
016800*----------------------------------------------------------------*01680000
016900*      TCKRSTCNTL TABLE LAYOUT                                    01690000
017000*----------------------------------------------------------------*01700000
017100         EXEC SQL                                                 01710000
017200             INCLUDE TCKRSTCN                                     01720000
017300         END-EXEC.                                                01730000
017400                                                                  01740000
017500*----------------------------------------------------------------*01750000
017600*      TCKRSTINF TABLE LAYOUT                                     01760000
017700*----------------------------------------------------------------*01770000
017800         EXEC SQL                                                 01780000
017900             INCLUDE TCKRSTIN                                     01790000
018000         END-EXEC.                                                01800000
018100 EJECT                                                            01810000
018200*----------------------------------------------------------------*01820000
018300*  DB2 COMMUNICATION AREA                                         01830000
018400*----------------------------------------------------------------*01840000
018500*                                                                 01850000
018600     EXEC SQL                                                     01860000
018700         INCLUDE SQLCA                                            01870000
018800     END-EXEC.                                                    01880000
018900                                                                  01890000
019000*----------------------------------------------------------------*01900000
019100*  DB2 COMMUNICATION AREA2                                        01910000
019200*----------------------------------------------------------------*01920000
019300*                                                                 01930000
019400     COPY SQLCA2.                                                 01940000
019500     EJECT                                                        01950000
019600 PROCEDURE DIVISION.                                              01960000
019700 A100-MAINLINE-ROUTINE.                                           01970000
019800                                                                  01980000
019900     PERFORM B100-INITIALIZATION.                                 01990000
020000                                                                  02000000
020100     PERFORM B200-TPLNSHP-EXTRACT-PROCESS                         02010000
020200       UNTIL END-OF-EXTRACT.                                      02020000
020300                                                                  02030000
020400     PERFORM B300-EOJ-PROCESSING.                                 02040000
020500                                                                  02050000
020600     GOBACK.                                                      02060000
020700 EJECT                                                            02070000
020800 B100-INITIALIZATION.                                             02080000
020900                                                                  02090000
021000     EXEC SQL                                                     02100000
021100         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 02110000
021200     END-EXEC.                                                    02120000
021300                                                                  02130000
021400     PERFORM X300-GET-CHECKPOINT-CNTL.                            02140000
021500     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02150000
021600                                                                  02160000
021700     OPEN INPUT TPLNSHP-EXTRACT-FILE.                             02170000
021800                                                                  02180000
021900     IF RESTART-RUN                                               02190000
022000         PERFORM X200-CHECKPOINT-RESTART                          02200000
022100     ELSE                                                         02210000
022200         PERFORM R100-READ-EXTRACT-FILE                           02220000
022300     END-IF.                                                      02230000
022400                                                                  02240000
022500     PERFORM X500-SET-CHECKPOINT-TIME.                            02250000
022600                                                                  02260000
022700                                                                  02270000
022800     EJECT                                                        02280000
022900 B200-TPLNSHP-EXTRACT-PROCESS.                                    02290000
023000                                                                  02300000
023100     MOVE PLNSHP-PO-NBR             TO PV-DISP-PO-NBR             02310000
023200                                       PV-PROCESSED-PO.           02320000
023300     IF PLNSHP-PO-NBR NOT = PV-SAVE-PO-NBR                        02330000
023400         MOVE PLNSHP-PO-NBR TO PV-SAVE-PO-NBR                     02340000
023600     END-IF.                                                      02360000
023700                                                                  02370000
023900     PERFORM D100-DELETE-TPLNSHP                                  02390019
024100                                                                  02410000
024200     PERFORM X100-CHECKPOINT-CHECK.                               02420000
024300                                                                  02430000
024400     PERFORM R100-READ-EXTRACT-FILE                               02440000
024500       UNTIL PLNSHP-PO-NBR > PV-PROCESSED-PO                      02450000
024600          OR END-OF-EXTRACT.                                      02460000
024700     EJECT                                                        02470000
024800                                                                  02480000
024900                                                                  02490000
025000 B300-EOJ-PROCESSING.                                             02500000
025100                                                                  02510000
025200     DISPLAY '** AHKUP038 SUMMARY **'.                            02520000
025300     DISPLAY '** TPLNSHP INPUT COUNT = ' PV-TPLNSHP-INPUT-COUNT.  02530000
025400     DISPLAY '** TPLNSHP DELETE COUNT = ' PV-TPLNSHP-DELETE-COUNT.02540000
025500     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02550000
025600                                                                  02560000
025700     CLOSE  TPLNSHP-EXTRACT-FILE.                                 02570000
025800                                                                  02580000
025900     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02590000
026000     PERFORM X600-UPDATE-TCKRSTCNTL.                              02600000
026100                                                                  02610000
026200     EJECT                                                        02620000
032600*                                                                 03260000
032700*----------------------------------------------------------------*03270000
032800*    DELETES FROM THE TPLNSHP TABLE.  CASCADE DELETE WILL ALSO   *03280000
032900*    CAUSE ROWS TO BE DELETED FROM TMIITEM, TVNDINV AND TEXINVC  *03290000
033000*    TABLES.                                                     *03300000
033100*----------------------------------------------------------------*03310000
033200 D100-DELETE-TPLNSHP.                                             03320000
033300                                                                  03330000
033400     MOVE 'D100-DELETE-TPLNSHP' TO PV-CURRENT-PARAGRAPH.          03340000
033500                                                                  03350000
033600     PERFORM WITH TEST AFTER                                      03360000
033700        VARYING PC-RETRY-COUNT FROM 1 BY 1                        03370000
033800          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     03380000
033900             OR SQLCODE = ZERO                                    03390000
034000                                                                  03400000
034100         EXEC SQL                                                 03410000
034200              DELETE                                              03420000
034300                FROM TPLNSHP                                      03430000
034400               WHERE PO_NBR  = :PLNSHP-PO-NBR                     03440000
034500         END-EXEC                                                 03450000
034600                                                                  03460000
034700         EVALUATE TRUE                                            03470000
034800             WHEN SQLCODE = ZERO                                  03480000
034900                 ADD 1 TO PV-TPLNSHP-DELETE-COUNT                 03490000
035000                 MOVE SQLERRD(3) TO PV-SQLERRD3                   03500000
035100                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           03510000
035200                                                                  03520000
035300             WHEN SQLCODE = -904                                  03530000
035400             WHEN SQLCODE = -913                                  03540000
035500             WHEN SQLCODE = +100                                  03550000
035600                  CONTINUE                                        03560000
035700                                                                  03570000
035800             WHEN SQLWARN0 NOT = SPACES                           03580000
035900             WHEN SQLCODE  NOT = ZERO                             03590000
036000                 MOVE PV-CURRENT-PARAGRAPH                        03600000
036100                                     TO AA-PARAGRAPH-NAME         03610000
036200                 DISPLAY '******** PO NUMBER:'                    03620000
036300                          PV-DISP-PO-NBR                          03630000
036400                 MOVE SPACES TO AA-MESSAGE-1                      03640000
036500                                AA-MESSAGE-2                      03650000
036600                 MOVE 'UNSUCCESSFUL DELETE'                       03660000
036700                                     TO AA-DB2-OPERATION          03670000
036800                 MOVE 'TPLNSHP'      TO AA-DB2-TABLE              03680000
036900                 PERFORM Z999-DB2-ABEND                           03690000
037000         END-EVALUATE                                             03700000
037100     END-PERFORM.                                                 03710000
037200                                                                  03720000
037300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03730000
037400         MOVE PV-CURRENT-PARAGRAPH                                03740000
037500                             TO AA-PARAGRAPH-NAME                 03750000
037600         DISPLAY '******** PO NUMBER:'                            03760000
037700                          PV-DISP-PO-NBR                          03770000
037800         MOVE SPACES TO AA-MESSAGE-1                              03780000
037900                        AA-MESSAGE-2                              03790000
038000         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03800000
038100                             TO AA-DB2-OPERATION                  03810000
038200         MOVE 'TPLNSHP'      TO AA-DB2-TABLE                      03820000
038300         PERFORM Z999-DB2-ABEND                                   03830000
038400     END-IF.                                                      03840000
038500                                                                  03850000
038600     EJECT                                                        03860000
038700 R100-READ-EXTRACT-FILE.                                          03870000
038800                                                                  03880000
038900     READ TPLNSHP-EXTRACT-FILE                                    03890000
039000          INTO DCLTPLNSHP                                         03900000
039100          AT END SET END-OF-EXTRACT TO TRUE.                      03910000
039200                                                                  03920000
039300     IF MORE-EXTRACT                                              03930000
039400         ADD 1 TO PV-TPLNSHP-INPUT-COUNT                          03940000
039500     END-IF.                                                      03950000
039600                                                                  03960000
039700                                                                  03970000
039800     EJECT                                                        03980000
039900*----------------------------------------------------------------*03990000
040000*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04000000
040100*----------------------------------------------------------------*04010000
040200 X100-CHECKPOINT-CHECK.                                           04020000
040300                                                                  04030000
040400     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        04040000
040500                                                                  04050000
040600     EXEC SQL                                                     04060000
040700       SET :WS-TMST = CURRENT TIMESTAMP                           04070000
040800     END-EXEC.                                                    04080000
040900                                                                  04090000
041000     IF SQLCODE = +0                                              04100000
041100         CONTINUE                                                 04110000
041200     ELSE                                                         04120000
041300         MOVE PV-CURRENT-PARAGRAPH                                04130000
041400                             TO AA-PARAGRAPH-NAME                 04140000
041500         MOVE SPACES TO AA-MESSAGE-1                              04150000
041600                        AA-MESSAGE-2                              04160000
041700         MOVE 'BAD SET COMMAND'                                   04170000
041800                             TO AA-DB2-OPERATION                  04180000
041900         MOVE SPACES             TO AA-DB2-TABLE                  04190000
042000         PERFORM Z999-DB2-ABEND                                   04200000
042100     END-IF.                                                      04210000
042200                                                                  04220000
042300     IF WS-TMST > WS-HOLD-TMST                                    04230000
042400         IF NO-COMMITS-TAKEN                                      04240000
042500             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         04250000
042600             PERFORM X600-UPDATE-TCKRSTCNTL                       04260000
042700             SET COMMITS-TAKEN TO TRUE                            04270000
042800         END-IF                                                   04280000
042900         PERFORM X700-UPDATE-TCKRSTINF                            04290000
043000         PERFORM Y100-COMMIT                                      04300000
043100         PERFORM X500-SET-CHECKPOINT-TIME                         04310000
043200     END-IF.                                                      04320000
043300                                                                  04330000
043400 EJECT                                                            04340000
043500*----------------------------------------------------------------*04350000
043600*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *04360000
043700*----------------------------------------------------------------*04370000
043800 X200-CHECKPOINT-RESTART.                                         04380000
043900                                                                  04390000
044000     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      04400000
044100                                                                  04410000
044200     PERFORM X400-GET-CHECKPOINT-INFO.                            04420000
044300     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     04430000
044400                                                                  04440000
044500     DISPLAY '** AHKUP038 CHECKPOINT RESTART **'                  04450000
044600     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             04460000
044700              CR-EXTRACT-RECS-WORKED.                             04470000
044800     DISPLAY '***********************************************'    04480000
044900                                                                  04490000
045000     PERFORM R100-READ-EXTRACT-FILE                               04500000
045100         CR-EXTRACT-RECS-WORKED TIMES.                            04510000
045200     PERFORM R100-READ-EXTRACT-FILE.                              04520000
045300 EJECT                                                            04530000
045400*----------------------------------------------------------------*04540000
045500*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04550000
045600*----------------------------------------------------------------*04560000
045700 X300-GET-CHECKPOINT-CNTL.                                        04570000
045800                                                                  04580000
045900     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04590000
046000                                                                  04600000
046100     PERFORM WITH TEST AFTER                                      04610000
046200             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04620000
046300             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04630000
046400                     SQLCODE = ZERO                               04640000
046500                                                                  04650000
046600             EXEC SQL                                             04660000
046700              SELECT CKPT_STAT_CODE                               04670000
046800               INTO :PV-CKPT-STAT-CODE                            04680000
046900               FROM TCKRSTCNTL                                    04690000
047000               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04700000
047100             END-EXEC                                             04710000
047200                                                                  04720000
047300             EVALUATE TRUE                                        04730000
047400                 WHEN SQLCODE = ZERO                              04740000
047500                 WHEN SQLCODE = -904                              04750000
047600                 WHEN SQLCODE = -913                              04760000
047700                      CONTINUE                                    04770000
047800                                                                  04780000
047900                 WHEN SQLWARN0 NOT = SPACES                       04790000
048000                 WHEN SQLCODE  NOT = ZERO                         04800000
048100                     MOVE PV-CURRENT-PARAGRAPH                    04810000
048200                                         TO AA-PARAGRAPH-NAME     04820000
048300                     DISPLAY '******** PLAN_NAME:'                04830000
048400                              PV-PROGRAM-NAME                     04840000
048500                     MOVE SPACES TO AA-MESSAGE-1                  04850000
048600                                    AA-MESSAGE-2                  04860000
048700                     MOVE 'UNSUCCESSFUL SELECT'                   04870000
048800                                         TO AA-DB2-OPERATION      04880000
048900                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04890000
049000                     PERFORM Z999-DB2-ABEND                       04900000
049100             END-EVALUATE                                         04910000
049200     END-PERFORM.                                                 04920000
049300                                                                  04930000
049400     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04940000
049500         MOVE PV-CURRENT-PARAGRAPH                                04950000
049600                             TO AA-PARAGRAPH-NAME                 04960000
049700         DISPLAY '******** PLAN_NAME:'                            04970000
049800                  PV-PROGRAM-NAME                                 04980000
049900         MOVE SPACES TO AA-MESSAGE-1                              04990000
050000                        AA-MESSAGE-2                              05000000
050100         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05010000
050200                             TO AA-DB2-OPERATION                  05020000
050300         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05030000
050400         PERFORM Z999-DB2-ABEND                                   05040000
050500     END-IF.                                                      05050000
050600                                                                  05060000
050700 EJECT                                                            05070000
050800*----------------------------------------------------------------*05080000
050900*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *05090000
051000*----------------------------------------------------------------*05100000
051100 X400-GET-CHECKPOINT-INFO.                                        05110000
051200                                                                  05120000
051300     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     05130000
051400                                                                  05140000
051500     PERFORM WITH TEST AFTER                                      05150000
051600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05160000
051700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05170000
051800                     SQLCODE = ZERO                               05180000
051900                                                                  05190000
052000             EXEC SQL                                             05200000
052100              SELECT WORK_STRG_DESC                               05210000
052200               INTO :TCKRSTINF-WORK-STRG-DESC                     05220000
052300               FROM TCKRSTINF                                     05230000
052400               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05240000
052500             END-EXEC                                             05250000
052600                                                                  05260000
052700             EVALUATE TRUE                                        05270000
052800                 WHEN SQLCODE = ZERO                              05280000
052900                 WHEN SQLCODE = -904                              05290000
053000                 WHEN SQLCODE = -913                              05300000
053100                      CONTINUE                                    05310000
053200                                                                  05320000
053300                 WHEN SQLWARN0 NOT = SPACES                       05330000
053400                 WHEN SQLCODE  NOT = ZERO                         05340000
053500                     MOVE PV-CURRENT-PARAGRAPH                    05350000
053600                                         TO AA-PARAGRAPH-NAME     05360000
053700                     DISPLAY '******** PLAN_NAME:'                05370000
053800                              PV-PROGRAM-NAME                     05380000
053900                     MOVE SPACES TO AA-MESSAGE-1                  05390000
054000                                    AA-MESSAGE-2                  05400000
054100                     MOVE 'UNSUCCESSFUL SELECT'                   05410000
054200                                         TO AA-DB2-OPERATION      05420000
054300                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          05430000
054400                     PERFORM Z999-DB2-ABEND                       05440000
054500             END-EVALUATE                                         05450000
054600     END-PERFORM.                                                 05460000
054700                                                                  05470000
054800     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05480000
054900         MOVE PV-CURRENT-PARAGRAPH                                05490000
055000                             TO AA-PARAGRAPH-NAME                 05500000
055100         DISPLAY '******** PLAN_NAME:'                            05510000
055200                  PV-PROGRAM-NAME                                 05520000
055300         MOVE SPACES TO AA-MESSAGE-1                              05530000
055400                        AA-MESSAGE-2                              05540000
055500         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05550000
055600                             TO AA-DB2-OPERATION                  05560000
055700         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05570000
055800         PERFORM Z999-DB2-ABEND                                   05580000
055900     END-IF.                                                      05590000
056000                                                                  05600000
056100 EJECT                                                            05610000
056200*----------------------------------------------------------------*05620000
056300*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05630000
056400*----------------------------------------------------------------*05640000
056500 X500-SET-CHECKPOINT-TIME.                                        05650000
056600                                                                  05660000
056700     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05670000
056800                                                                  05680000
056900     PERFORM WITH TEST AFTER                                      05690000
057000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05700000
057100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05710000
057200                     SQLCODE = ZERO                               05720000
057300                                                                  05730000
057400             EXEC SQL                                             05740000
057500              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05750000
057600               INTO :WS-HOLD-TMST                                 05760000
057700               FROM TCKRSTCNTL                                    05770000
057800               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05780000
057900             END-EXEC                                             05790000
058000                                                                  05800000
058100             EVALUATE TRUE                                        05810000
058200                 WHEN SQLCODE = ZERO                              05820000
058300                 WHEN SQLCODE = -904                              05830000
058400                 WHEN SQLCODE = -913                              05840000
058500                      CONTINUE                                    05850000
058600                                                                  05860000
058700                 WHEN SQLWARN0 NOT = SPACES                       05870000
058800                 WHEN SQLCODE  NOT = ZERO                         05880000
058900                     MOVE PV-CURRENT-PARAGRAPH                    05890000
059000                                         TO AA-PARAGRAPH-NAME     05900000
059100                     DISPLAY '******** PLAN_NAME:'                05910000
059200                              PV-PROGRAM-NAME                     05920000
059300                     MOVE SPACES TO AA-MESSAGE-1                  05930000
059400                                    AA-MESSAGE-2                  05940000
059500                     MOVE 'UNSUCCESSFUL SELECT'                   05950000
059600                                         TO AA-DB2-OPERATION      05960000
059700                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05970000
059800                     PERFORM Z999-DB2-ABEND                       05980000
059900             END-EVALUATE                                         05990000
060000     END-PERFORM.                                                 06000000
060100                                                                  06010000
060200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06020000
060300         MOVE PV-CURRENT-PARAGRAPH                                06030000
060400                             TO AA-PARAGRAPH-NAME                 06040000
060500         DISPLAY '******** PLAN_NAME:'                            06050000
060600                  PV-PROGRAM-NAME                                 06060000
060700         MOVE SPACES TO AA-MESSAGE-1                              06070000
060800                        AA-MESSAGE-2                              06080000
060900         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    06090000
061000                             TO AA-DB2-OPERATION                  06100000
061100         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06110000
061200         PERFORM Z999-DB2-ABEND                                   06120000
061300     END-IF.                                                      06130000
061400                                                                  06140000
061500 EJECT                                                            06150000
061600*----------------------------------------------------------------*06160000
061700*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *06170000
061800*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *06180000
061900*----------------------------------------------------------------*06190000
062000 X600-UPDATE-TCKRSTCNTL.                                          06200000
062100                                                                  06210000
062200     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       06220000
062300                                                                  06230000
062400     PERFORM WITH TEST AFTER                                      06240000
062500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06250000
062600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06260000
062700                     SQLCODE = ZERO                               06270000
062800                                                                  06280000
062900             EXEC SQL                                             06290000
063000                 UPDATE TCKRSTCNTL                                06300000
063100                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          06310000
063200                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06320000
063300             END-EXEC                                             06330000
063400                                                                  06340000
063500             EVALUATE TRUE                                        06350000
063600                 WHEN SQLCODE = ZERO                              06360000
063700                 WHEN SQLCODE = -904                              06370000
063800                 WHEN SQLCODE = -913                              06380000
063900                      CONTINUE                                    06390000
064000                                                                  06400000
064100                 WHEN SQLWARN0 NOT = SPACES                       06410000
064200                 WHEN SQLCODE  NOT = ZERO                         06420000
064300                     MOVE PV-CURRENT-PARAGRAPH                    06430000
064400                                         TO AA-PARAGRAPH-NAME     06440000
064500                     DISPLAY '******** PLAN_NAME:'                06450000
064600                              PV-PROGRAM-NAME                     06460000
064700                     MOVE SPACES TO AA-MESSAGE-1                  06470000
064800                                    AA-MESSAGE-2                  06480000
064900                     MOVE 'UNSUCCESSFUL UPDATE'                   06490000
065000                                         TO AA-DB2-OPERATION      06500000
065100                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06510000
065200                     PERFORM Z999-DB2-ABEND                       06520000
065300             END-EVALUATE                                         06530000
065400     END-PERFORM.                                                 06540000
065500                                                                  06550000
065600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06560000
065700         MOVE PV-CURRENT-PARAGRAPH                                06570000
065800                             TO AA-PARAGRAPH-NAME                 06580000
065900         DISPLAY '******** PLAN_NAME:'                            06590000
066000                  PV-PROGRAM-NAME                                 06600000
066100         MOVE SPACES TO AA-MESSAGE-1                              06610000
066200                        AA-MESSAGE-2                              06620000
066300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06630000
066400                             TO AA-DB2-OPERATION                  06640000
066500         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06650000
066600         PERFORM Z999-DB2-ABEND                                   06660000
066700     END-IF.                                                      06670000
066800                                                                  06680000
066900     EJECT                                                        06690000
067000*----------------------------------------------------------------*06700000
067100*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06710000
067200*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06720000
067300*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06730000
067400*----------------------------------------------------------------*06740000
067500 X700-UPDATE-TCKRSTINF.                                           06750000
067600                                                                  06760000
067700     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06770000
067800                                                                  06780000
067900     MOVE PV-TPLNSHP-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06790000
068000     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06800000
068100     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06810000
068200                                                                  06820000
068300     PERFORM WITH TEST AFTER                                      06830000
068400             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06840000
068500             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06850000
068600                     SQLCODE = ZERO                               06860000
068700                                                                  06870000
068800             EXEC SQL                                             06880000
068900                 UPDATE TCKRSTINF                                 06890000
069000                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06900000
069100                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06910000
069200             END-EXEC                                             06920000
069300                                                                  06930000
069400             EVALUATE TRUE                                        06940000
069500                 WHEN SQLCODE = ZERO                              06950000
069600                 WHEN SQLCODE = -904                              06960000
069700                 WHEN SQLCODE = -913                              06970000
069800                      CONTINUE                                    06980000
069900                                                                  06990000
070000                 WHEN SQLWARN0 NOT = SPACES                       07000000
070100                 WHEN SQLCODE  NOT = ZERO                         07010000
070200                     MOVE PV-CURRENT-PARAGRAPH                    07020000
070300                                         TO AA-PARAGRAPH-NAME     07030000
070400                     DISPLAY '******** PLAN_NAME:'                07040000
070500                              PV-PROGRAM-NAME                     07050000
070600                     MOVE SPACES TO AA-MESSAGE-1                  07060000
070700                                    AA-MESSAGE-2                  07070000
070800                     MOVE 'UNSUCCESSFUL UPDATE'                   07080000
070900                                         TO AA-DB2-OPERATION      07090000
071000                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          07100000
071100                     PERFORM Z999-DB2-ABEND                       07110000
071200             END-EVALUATE                                         07120000
071300     END-PERFORM.                                                 07130000
071400                                                                  07140000
071500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             07150000
071600         MOVE PV-CURRENT-PARAGRAPH                                07160000
071700                             TO AA-PARAGRAPH-NAME                 07170000
071800         DISPLAY '******** PLAN_NAME:'                            07180000
071900                  PV-PROGRAM-NAME                                 07190000
072000         MOVE SPACES TO AA-MESSAGE-1                              07200000
072100                        AA-MESSAGE-2                              07210000
072200         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    07220000
072300                             TO AA-DB2-OPERATION                  07230000
072400         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      07240000
072500         PERFORM Z999-DB2-ABEND                                   07250000
072600     END-IF.                                                      07260000
072700                                                                  07270000
072800 EJECT                                                            07280000
072900                                                                  07290000
073000*----------------------------------------------------------------*07300000
073100*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *07310000
073200*----------------------------------------------------------------*07320000
073300 Y100-COMMIT.                                                     07330000
073400                                                                  07340000
073500     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               07350000
073600                                                                  07360000
073700     EXEC SQL                                                     07370000
073800         COMMIT                                                   07380000
073900     END-EXEC.                                                    07390000
074000                                                                  07400000
074100     EVALUATE TRUE                                                07410000
074200         WHEN SQLCODE = ZEROS                                     07420000
074300             CONTINUE                                             07430000
074400         WHEN OTHER                                               07440000
074500             MOVE PV-CURRENT-PARAGRAPH                            07450000
074600                                 TO AA-PARAGRAPH-NAME             07460000
074700             MOVE SPACES TO AA-MESSAGE-1                          07470000
074800                            AA-MESSAGE-2                          07480000
074900             MOVE 'UNSUCCESSFUL COMMIT'                           07490000
075000                                 TO AA-DB2-OPERATION              07500000
075100             MOVE SPACES         TO AA-DB2-TABLE                  07510000
075200             PERFORM Z999-DB2-ABEND                               07520000
075300     END-EVALUATE.                                                07530000
075400 EJECT                                                            07540000
075500 Z999-DB2-ABEND.                                                  07550000
075600                                                                  07560000
075700     DISPLAY AA-ABEND-LIT.                                        07570000
075800     DISPLAY AA-DB2-ERROR-LIT.                                    07580000
075900     DISPLAY AA-PROGRAM-LIT.                                      07590000
076000     DISPLAY AA-PARAGRAPH-LIT.                                    07600000
076100     DISPLAY AA-DB2-OPERATION-LIT.                                07610000
076200     DISPLAY AA-DB2-TABLE.                                        07620000
076300     SET AC-DB2-ERROR TO TRUE.                                    07630000
076400                                                                  07640000
076500     COPY DPPD004.                                                07650000
076600                                                                  07660000
076700     CALL 'ILBOABN0' USING ABEND-CODE.                            07670000
