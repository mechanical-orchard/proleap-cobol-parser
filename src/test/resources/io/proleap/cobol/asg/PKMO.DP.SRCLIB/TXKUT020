000100******************************************************************00001000
000200 IDENTIFICATION DIVISION.                                         00002000
000300******************************************************************00003000
000400                                                                  00004000
000500 PROGRAM-ID.             TXKUT020.                                00005000
000600 AUTHOR.                 BARB SCHULTZ.                            00006000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00007000
000800 DATE-WRITTEN.           AUGUST 2020.                             00008000
000900 DATE-COMPILED.                                                   00009000
001000                                                                  00009100
001100***************************************************************** 00009200
001200* THIS PROGRAM CREATES A FILE OF ALL MARKETPLACE SALES AND RETURNS00009300
001300* INCLUDING THE ZIPCODE.                                          00009400
001400***************************************************************** 00009500
001500* DATE: 09-24-2020                       WR#: CHG0249229          00009600
001600* WHO: BARB SCHULTZ                                               00009700
001700* WHY: ADDED THE CALENDAR ROUTINE TO GET THE FISCAL MONTH START   00009800
001700*      DATE.  THE ENDING DATE IS PICKED UP FROM CONTROL CARD      00009900
001700*      TXCC070.                                                   00010000
001800******************************************************************00010100
250775* DATE: 11-02-2020                       WR#: CHG0250775          00010200
250775* WHO: BARB SCHULTZ                                               00010300
250775* WHY: ADDED LOGIC FOR RETURNS. NEEDED TO LOOK UP THE ORIGINAL    00010400
250775*      SALE FOR THE RETURN.                                       00010500
250775******************************************************************00010600
BARB  * DATE: 01-06-2021                       WR#: CHG0253107          00010711
BARB  * WHO: BARB SCHULTZ                                               00010810
BARB  * WHY: ADDED LOGIC FOR -310 ON A RETURN IN PARAGRAPH              00010910
BARB  *      7820-GET-OPERATING-SHIP-INFO TO USE THE NON-RECEIPTED      00011010
BARB  *      RETURN LOGIC.                                              00011110
BARB  ******************************************************************00011210
001900***************************************************************** 00011310
002000 ENVIRONMENT DIVISION.                                            00011410
002100***************************************************************** 00011510
002200                                                                  00011610
002300 CONFIGURATION SECTION.                                           00011710
002400                                                                  00011810
002500 SOURCE-COMPUTER.        IBM-3090.                                00011910
002600                                                                  00012010
002700 OBJECT-COMPUTER.        IBM-3090.                                00012110
002800                                                                  00012210
002900 INPUT-OUTPUT SECTION.                                            00012310
003000                                                                  00012410
003100 FILE-CONTROL.                                                    00012510
003200                                                                  00012610
003300     SELECT POS-DATE-CARD-FILE                                    00012710
003400         ASSIGN TO INP01.                                         00012810
003500                                                                  00012910
003600     SELECT TAX-FILE                                              00013010
003700         ASSIGN TO OUT01.                                         00013110
003800                                                                  00013210
003900******************************************************************00013310
004000 DATA DIVISION.                                                   00013410
004100******************************************************************00013510
004200                                                                  00013610
004300 FILE SECTION.                                                    00013710
004400                                                                  00013810
004500 FD  POS-DATE-CARD-FILE                                           00013910
004600     RECORDING MODE IS F                                          00014010
004700     BLOCK CONTAINS 0 RECORDS                                     00014110
004800     LABEL RECORDS ARE STANDARD.                                  00014210
004900                                                                  00014310
005000 01  POS-DATE-CARD-RECORD            PIC X(80).                   00014410
005100                                                                  00014510
005200 FD  TAX-FILE                                                     00014610
005300     RECORDING MODE IS F                                          00014710
005400     BLOCK CONTAINS 0  RECORDS.                                   00014810
005500                                                                  00014910
005600 01  TAX-RECORD                     PIC X(155).                   00015010
005700                                                                  00015110
005800******************************************************************00015210
005900 WORKING-STORAGE SECTION.                                         00015310
006000******************************************************************00015410
006100 01  FILLER                            PIC X(50)  VALUE           00015510
006200     ' *** WORKING STORAGE STARTS HERE FOR TXKUT020 *** '.        00015610
006300                                                                  00015710
006400******************************************************************00015810
006500* RECORD LAYOUT FOR INPUT DATE CARD (POS DATE)                    00015910
006600******************************************************************00016010
006700 01  CC-CONTROL-CARD.                                             00016110
006800     05  CC-CONTROL-CARD-DISPLAY.                                 00016210
006900         10  CC-BEGIN-DATE       PIC X(10)    VALUE SPACES.       00016310
007000         10  FILLER              PIC X        VALUE SPACE.        00016410
007100         10  CC-END-DATE         PIC X(10)    VALUE ZERO.         00016510
007200     05  FILLER                  PIC X(59)    VALUE SPACE.        00016610
007300                                                                  00016710
007300 01  DATE-CONTROL-CARD.                                           00016810
007300     05  CC-MTH-ENDING-DATE-ISO.                                  00016910
007300         10  CC-MTH-ENDING-CC    PIC X(02).                       00017010
007300         10  CC-MTH-ENDING-YY    PIC X(02).                       00017110
007300         10  FILLER              PIC X(01).                       00017210
007300         10  CC-MTH-ENDING-MM    PIC X(02).                       00017310
007300         10  FILLER              PIC X(01).                       00017410
007300         10  CC-MTH-ENDING-DD    PIC X(02).                       00017510
007300     05  FILLER                  PIC X(70).                       00017610
007800                                                                  00017710
007900 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00017810
008000                                                  COMP SYNC.      00017910
008100     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    00018010
008200     88  AC-TABLE-OVERFLOW                        VALUE +4004.    00018110
008300     88  AC-CONVERSION-ERROR                      VALUE +4008.    00018210
008400     88  AC-DB2-ERROR                             VALUE +4013.    00018310
008500     88  AC-TXKUT032-ERROR                        VALUE +4014.    00018410
008600     88  AC-TXKUT033-ERROR                        VALUE +4015.    00018510
008700     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    00018610
008800                                                                  00018710
008900 01  ABEND-CODE                        PIC S9(04) VALUE ZERO      00018810
009000                                                  COMP SYNC.      00018910
009100 01  PS-PROGRAM-SWITCHES.                                         00019010
009100     05  PS-END-OF-ITEM                PIC X(01)  VALUE 'N'.      00019110
009100         88  PS-END-OF-ITEM-YES                   VALUE 'Y'.      00019210
009100         88  PS-END-OF-ITEM-NO                    VALUE 'N'.      00019310
250775     05  PS-END-OF-TEPITM-MISS-CSR-SW  PIC X(01)  VALUE 'N'.      00019410
250775         88  PS-END-OF-TEPITM-MISS-CSR            VALUE 'Y'.      00019510
250775         88  PS-NOT-END-OF-TEPITM-MISS-CSR        VALUE 'N'.      00019610
250775     05  PS-END-OF-TEPITM-CSR-SW       PIC X(01)  VALUE 'N'.      00019710
250775         88  PS-END-OF-TEPITM-CSR                 VALUE 'Y'.      00019810
250775         88  PS-NOT-END-OF-TEPITM-CSR             VALUE 'N'.      00019910
250775     05  PS-TEPECX-EXISTS-SW        PIC S9 COMP-3 VALUE ZERO.     00020010
250775         88  PS-TEPECX-EXISTS-YES                 VALUE 1.        00020110
250775         88  PS-TEPECX-EXISTS-NO                  VALUE ZERO.     00020210
250775     05  RESEND-OF-ECOM-TABLE-SWITCH PIC X(1)     VALUE 'N'.      00020310
250775         88  PS-NOT-END-OF-ECOM-TABLE             VALUE 'N'.      00020410
250775         88  PS-END-OF-ECOM-TABLE                 VALUE 'Y'.      00020510
250775     05  PS-ORIG-SALES-DATE-SW         PIC X(01)  VALUE 'N'.      00020610
250775         88  PS-ORIG-SALES-DATE-FOUND             VALUE 'Y'.      00020710
250775         88  PS-ORIG-SALES-DATE-NOT-FOUND         VALUE 'N'.      00020810
250775     05  PS-END-OF-ZIP-TABLE-SWITCH PIC X(1)      VALUE 'N'.      00020910
250775         88  PS-NOT-END-OF-ZIP-TABLE              VALUE 'N'.      00021010
250775         88  PS-END-OF-ZIP-TABLE                  VALUE 'Y'.      00021110
009900     05  PS-FIRST-TIME-SW              PIC X(01)  VALUE 'Y'.      00021210
010000         88  PS-FIRST-TIME                        VALUE 'Y'.      00021310
010100         88  PS-FIRST-TIME-NO                     VALUE 'N'.      00021410
010200     05  PS-END-OF-CARD-FILE           PIC X(01)  VALUE 'N'.      00021510
010300         88  PS-END-OF-CARD-FILE-YES              VALUE 'Y'.      00021610
250775 05  PS-ECOMMERCE-STORE-SW                                        00021710
250775                              PIC X(1)     VALUE SPACE.           00021810
250775     88  PS-ECOMMERCE-STORE                VALUE 'Y'.             00021910
250775     88  PS-NOT-ECOMMERCE-STORE            VALUE 'N'.             00022010
250775 05  PS-ECOMMERCE-RETURN-SW   PIC X(1)     VALUE SPACE.           00022110
250775     88  PS-ECOMMERCE-RETURN               VALUE 'Y'.             00022210
250775     88  PS-NOT-ECOMMERCE-RETURN           VALUE 'N'.             00022310
250775 05  PS-RECEIPTED-RETURN-SW   PIC X(1)     VALUE SPACE.           00022410
250775     88  PS-RECEIPTED-RETURN               VALUE 'Y'.             00022510
250775     88  PS-NON-RECEIPTED-RETURN           VALUE 'N'.             00022610
010400                                                                  00022710
010500 01  PC-CONSTANTS.                                                00022810
250775     05  PC-SPACES                   PIC  X(10)    VALUE SPACES.  00022910
010600     05  PC-NOT-FOUND                PIC S9(04)    VALUE +100.    00023010
010700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00023110
010800                                     'TXKUT020'.                  00023210
010900     05  PC-REPORT-NBR-1             PIC  9(1)     VALUE 1.       00023310
011000     05  PC-ZIP-MAX                  PIC S9(5)     COMP           00023410
011010                                                 VALUE +99999.    00023510
011100     05  PC-DPKUT052                 PIC  X(8)   VALUE 'DPKUT052'.00023610
011200                                                                  00023710
011300******************************************************************00023810
011400* 1K52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.                 00023910
011500******************************************************************00024010
011600 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              00024110
011700     05  LK52-CONVERSION-TYPE        PIC  X(01).                  00024210
011800         88  EBCDIC-TO-ASCII                     VALUE '1'.       00024310
011900         88  ASCII-TO-EBCDIC                     VALUE '2'.       00024410
012000     05  LK52-LENGTH                 PIC S9(03)  COMP-3.          00024510
012100     05  LK52-FROM-AREA              PIC  X(50)  VALUE SPACES.    00024610
012200     05  LK52-TO-AREA                PIC  X(50)  VALUE SPACES.    00024710
012300     05  LK52-RETURN-CODE            PIC  X(02)  VALUE '00'.      00024810
012400         88  GOOD-LK52-RET-CODE                  VALUE '00'.      00024910
012500                                                                  00025010
012600 01  PV-MISC-FIELDS.                                              00025110
012700     05  PV-LINE-SPACING             PIC  9        VALUE 1.       00025210
012800     05  PV-LINE-CNT                 PIC  9(03)    VALUE ZERO.    00025310
012900     05  PV-PAGE-CNT                 PIC  9(04)    VALUE ZERO.    00025410
013100     05  PV-LINE-SEQ-NBR             PIC  9(03)    VALUE ZERO.    00025510
013200     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   00025610
013300     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   00025710
013400     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   00025810
013500     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   00025910
013600     05  PV-SUBTOTAL                 PIC  9(7).99- VALUE ZERO.    00026010
250775     05  PV-ORIG-PARTN-NBR           PIC  S9(4) COMP.             00026110
250775     05  PV-ORIG-ZIP-5-CDE           PIC  X(24)    VALUE SPACES.  00026210
250775     05  PV-ORIG-GEOG-CDE            PIC  X(02)    VALUE SPACES.  00026310
250775     05  PV-SAVE-GEOG-CDE            PIC  X(02)    VALUE SPACES.  00026410
250775     05  PV-ORIG-TX-RT-PCT           PIC S9V9(04) COMP-3          00026510
250775                                                   VALUE ZERO.    00026610
250775     05  PV-ORIG-TX-AMT              PIC S9(7)V99 COMP-3          00026710
250775                                                   VALUE ZERO.    00026810
250775     05  PV-TAX-RATE-PCT       PIC  S9(1)V9(5) COMP-3 VALUE ZERO. 00026910
013700     05  PV-ZIP-CODE                 PIC  X(05)    VALUE SPACES.  00027010
013710     05  PV-SAVE-ZIP-5-CDE           PIC  X(24)    VALUE SPACES.  00027110
013800     05  PV-ZIP-LENGTH               PIC  9(09)    VALUE ZEROES.  00027210
013900     05  PV-INPUT-TEXT               PIC  X(24)    VALUE SPACES.  00027310
014000     05  PV-OUTPUT-TEXT              PIC  X(18)    VALUE SPACES.  00027410
014100     05  PV-ENCR-ZIP-CODE            PIC  X(24)    VALUE SPACES.  00027510
250775     05  PV-SHIP-ST-CODE             PIC  X(02)    VALUE SPACES.  00027610
014200     05  PV-SHIP-ZIP-CODE            PIC  X(05)    VALUE SPACES.  00027710
250775     05  PV-SHIP-GEO-CODE            PIC  X(02)    VALUE SPACES.  00027810
250775     05  PV-SAVE-ZIP-CDE             PIC  X(05) VALUE SPACES.     00027910
250775     05  PV-SAVE-ZIP-CODE            PIC  X(05) VALUE SPACES.     00028010
250775     05  PV-SAVE-ST-CODE             PIC  X(02) VALUE SPACES.     00028110
250775     05  PV-SKU                      PIC  9(08) VALUE ZERO.       00028210
250775     05  PV-SKU-C                    PIC S9(08) VALUE ZERO COMP-3.00028310
250775     05  PV-SKU-NBR                  PIC S9(08) VALUE ZERO COMP-3.00028410
014700     05  PV-TX-AMT                   PIC S9(7)V99  VALUE ZERO.    00028510
250775     05  PV-ORD-DTE                  PIC X(10)     VALUE SPACES.  00028610
250775     05  PV-ROUND-IND                PIC X.                       00028710
061800     05  PV-TEPSHP-CHRG-AMT          PIC S9(7)V99  VALUE ZERO     00028810
061800                                                   COMP-3.        00028910
061800     05  PV-TEPSHP-TX-RT-PCT         PIC S9(3)V9(5) VALUE ZERO    00029010
061800                                                   COMP-3.        00029110
014710     05  PV-TEPSHP-ZIP-5-CDE         PIC X(24)     VALUE SPACES.  00029210
014800     05  PV-TEPSHP-TX-AMT            PIC S9(7)V99  VALUE ZERO     00029310
014900                                                   COMP-3.        00029410
015010     05  PV-TEPSHP-GEOG-CDE          PIC  X(02)    VALUE SPACES.  00029510
250775     05  PV-SHP-CSR-SETUP-FIELDS.                                 00029610
250775         10 PV-SHP-PARTN-NBR          PIC  S9(4) COMP.            00029710
250775         10 PV-SHP-STR-NBR            PIC  S9(4) COMP.            00029810
250775         10 PV-SHP-RGST-ID            PIC  S9(4) COMP.            00029910
250775         10 PV-SHP-TRN-NBR            PIC  S9(4) COMP.            00030010
250775         10 PV-SHP-STRT-TM            PIC   X(8).                 00030110
250775         10 PV-TRN-DTE                PIC   X(10)                 00030210
250775                                      VALUE '9999-09-09'.         00030310
250775     05  PV-ORIG-TRN-DTE             PIC  X(10)    VALUE SPACES.  00030410
250775     05  PV-SLS-DTE-WRK              PIC  X(10)    VALUE SPACES.  00030510
250775     05  PV-BUS-LOC-IND              PIC  X(01)    VALUE 'Y'.     00030610
016300     05  PV-HOLD-STR-NBR             PIC  9(04)    VALUE ZERO.    00030710
016400     05  PV-HOLD-PARTN-NBR           PIC  9(04)    VALUE ZERO.    00030810
250775     05  PV-ORD-PARTN-NBR            PIC S9(04)     COMP.         00030910
016500     05  PV-HOLD-TRN-TYP-CDE         PIC  X(02)    VALUE SPACES.  00031010
250775     05  PV-WORK-PARTN-NBR           PIC 9(4)      VALUE ZERO.    00031110
250775     05  PV-WORK-STR-NBR             PIC S9(04) COMP VALUE ZERO.  00031210
250775     05  PV-WORK-STR-NBR-D           PIC  9(04)      VALUE ZERO.  00031310
250775     05  PV-WORK-SLS-DTE             PIC X(10)     VALUE SPACES.  00031410
BARB       05  PV-WORK-LNE-ITM-SEQ-NBR     PIC  9(4)     VALUE ZERO.    00031510
250775     05  PV-WORK-RGST-ID             PIC 9(4)      VALUE ZERO.    00031610
250775     05  PV-WORK-TRN-NBR             PIC 9(4)      VALUE ZERO.    00031710
250775     05  PV-WORK-STRT-TM             PIC X(8)      VALUE SPACES.  00031810
BARB       05  PV-WORK-SLS-CORR-SEQ-NBR    PIC  9(4)     VALUE ZERO.    00031910
250775     05  PV-RT-ORIG-SLS-DTE          PIC   X(10)   VALUE SPACES.  00032010
250775     05  PV-RT-ORIG-STR-NBR          PIC  S9(4) COMP VALUE ZERO.  00032110
250775     05  PV-RT-ORIG-RGST-ID          PIC  S9(4) COMP VALUE ZERO.  00032210
250775     05  PV-RT-ORIG-TRN-NBR          PIC  S9(4) COMP VALUE ZERO.  00032310
250775     05  PV-RT-ORIG-STRT-TM          PIC   X(8)    VALUE SPACES.  00032410
250775     05  PV-RT-ORIG-LNE-ITM-NBR      PIC  S9(4) COMP VALUE ZERO.  00032510
250775     05  PV-SAVE-PARTN-NBR           PIC 9(3)      VALUE ZERO.    00032610
250775     05  PV-SAVE-STR-NBR             PIC S9(04) COMP VALUE ZERO.  00032710
250775     05  PV-SAVE-SLS-DTE             PIC X(10)     VALUE SPACES.  00032810
250775     05  PV-SAVE-LNE-ITM-NBR         PIC  9(4)     VALUE ZERO.    00032910
250775     05  PV-SAVE-RGST-ID             PIC 9(4)      VALUE ZERO.    00033010
250775     05  PV-SAVE-TRN-NBR             PIC 9(4)      VALUE ZERO.    00033110
250775     05  PV-SAVE-STRT-TM             PIC X(8)      VALUE SPACES.  00033210
016700     05  PV-BEG-CCYY-MM-DD           PIC  X(10)    VALUE SPACE.   00033310
016800     05  FILLER REDEFINES PV-BEG-CCYY-MM-DD.                      00033410
016900         10  PV-BEG-CCYY             PIC  X(04).                  00033510
017000         10  FILLER                  PIC  X(01).                  00033610
017100         10  PV-BEG-MM               PIC  X(02).                  00033710
017200         10  FILLER                  PIC  X(01).                  00033810
017300         10  PV-BEG-DD               PIC  X(02).                  00033910
017400     05  PV-END-CCYY-MM-DD           PIC  X(10)    VALUE SPACE.   00034010
017500     05  FILLER REDEFINES PV-END-CCYY-MM-DD.                      00034110
017600         10  PV-END-CCYY             PIC  X(04).                  00034210
017700         10  FILLER                  PIC  X(01).                  00034310
017800         10  PV-END-MM               PIC  X(02).                  00034410
017900         10  FILLER                  PIC  X(01).                  00034510
018000         10  PV-END-DD               PIC  X(02).                  00034610
018100     05  PV-SALES-DATE.                                           00034710
018200         10  PV-SALES-MM             PIC  X(02)   VALUE SPACE.    00034810
018300         10  FILLER                  PIC  X(01)    VALUE '/'.     00034910
018400         10  PV-SALES-DD             PIC  X(02)    VALUE SPACE.   00035010
018500         10  FILLER                  PIC  X(01)    VALUE '/'.     00035110
018600         10  PV-SALES-CCYY           PIC  X(04)    VALUE SPACE.   00035210
018700     05  PV-CURR-DATE-CCYYMMDD.                                   00035310
018800         10  PV-CURR-DATE-CCYY       PIC  9(04).                  00035410
018900         10  PV-CURR-DATE-MM         PIC  9(02).                  00035510
019000         10  PV-CURR-DATE-DD         PIC  9(02).                  00035610
019100     05  PV-CURR-TIME.                                            00035710
019200         10  PV-CURR-TIME-HH         PIC  9(02)    VALUE ZERO.    00035810
019300         10  PV-CURR-TIME-MM         PIC  9(02)    VALUE ZERO.    00035910
019400         10  PV-CURR-TIME-SSHH       PIC  9(04)    VALUE ZERO.    00036010
019500                                                                  00036110
250775 01  PV-POS-CCYY-MM-DD.                                           00036210
250775     05  PV-POS-CC                   PIC X(02)     VALUE SPACES.  00036310
250775     05  PV-POS-YY                   PIC X(02)     VALUE SPACES.  00036410
250775     05  FILLER                      PIC X(01)     VALUE SPACES.  00036510
250775     05  PV-POS-MM                   PIC X(02)     VALUE SPACES.  00036610
250775     05  FILLER                      PIC X(01)     VALUE SPACES.  00036710
250775     05  PV-POS-DD                   PIC X(02)     VALUE SPACES.  00036810
016500                                                                  00036910
019600******************************************************************00037010
019700*  PV-ZIP-CODE-TABLE - TO STORE THE ENCRYPTED AND ITS             00037110
019800*                      CORRESPONDING DECRYPTED CLEAR ZIP-CODE.    00037210
019900******************************************************************00037310
020000 01  PV-ZIP-CODE-TABLE.                                           00037410
020100     05  PV-ZIP-CODE-TABLE-ENTRIES OCCURS 99999 TIMES             00037510
020200                                     INDEXED BY ZP-IDX, ZP-IDX2.  00037610
020300         10  ENCRYPT-ZIP         PIC  X(24).                      00037710
020400         10  DECRYPT-ZIP         PIC  X(5).                       00037810
020500                                                                  00037910
250775 01  EC-ECOM-STORE-TABLE.                                         00038010
250775     05  EC-ECOM-STORE-TABLE-ENTRIES OCCURS 2000 TIMES            00038110
250775                                     INDEXED BY EC-IDX, EC-IDX2.  00038210
250775         10  EC-STR-NBR          PIC S9(4) COMP.                  00038310
250775         10  EC-BUS-LOC-IND      PIC  X(1).                       00038410
250775         10  EC-ST-CDE           PIC  X(2).                       00038510
250775         10  EC-ZIP-CODE         PIC  X(5).                       00038610
250775         10  EC-GEO-CODE         PIC  X(2).                       00038710
250775         10  EC-GEO-FOUND-IND    PIC  X(1).                       00038810
250775         10  EC-ROUND-IND        PIC  X(1).                       00038910
020500                                                                  00039010
020600******************************************************************00039110
020700*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA        00039210
020800******************************************************************00039310
020900     COPY DPWS022.                                                00039410
021000                                                                  00039510
021100******************************************************************00039610
021200*  LAYOUT FOR THE PARAMETERS NEEDED TO INVOKE PROTEGRITY MODULE  *00039710
021300******************************************************************00039810
021400     COPY PTYCCSIP.                                               00039910
021500                                                                  00040010
021600******************************************************************00040110
021700*  LAYOUT FOR THE WORKING VARIABLES TO INVOKE PROTEGRITY MODULE  *00040210
021800******************************************************************00040310
021900     COPY DPWS031.                                                00040410
022000                                                                  00040510
022000******************************************************************00040610
022000* WORKING STORAGE SECTION FOR CALENDAR ROUTINE                    00040710
022000******************************************************************00040810
022000     COPY DPWS500.                                                00040910
022000                                                                  00041010
022100***************************************************************** 00041110
022200*  TAX EXTRACT RECORD LAYOUT                                      00041210
022300***************************************************************** 00041310
022400     COPY TXRD020.                                                00041410
022500                                                                  00041510
022600******************************************************************00041610
022700*  WS FIELDS FOR SQLCA MESSAGE ROUTINE                            00041710
022800******************************************************************00041810
022900     COPY DPWS004.                                                00041910
023000                                                                  00042010
023100******************************************************************00042110
023200*  DB2 COMMUNICATION AREA.                                        00042210
023300******************************************************************00042310
023400     EXEC SQL                                                     00042410
023500          INCLUDE SQLCA                                           00042510
023600     END-EXEC.                                                    00042610
023700                                                                  00042710
023800******************************************************************00042810
023900*  DB2 TABLE TEPPART - COSA-PARTITIONING TABLE                    00042910
024000******************************************************************00043010
024100     EXEC SQL                                                     00043110
024200          INCLUDE TEPPART                                         00043210
024300     END-EXEC.                                                    00043310
024400                                                                  00043410
250775******************************************************************00043510
250775*  DB2 TABLE TEPECX                                               00043610
250775******************************************************************00043710
250775     EXEC SQL                                                     00043810
250775          INCLUDE TEPECX                                          00043910
250775     END-EXEC.                                                    00044010
025100                                                                  00044110
024500******************************************************************00044210
024600*  DB2 TABLE TEPORD - COSA ORDER TABLE                            00044310
024700******************************************************************00044410
024800     EXEC SQL                                                     00044510
024900          INCLUDE TEPORD                                          00044610
025000     END-EXEC.                                                    00044710
025100                                                                  00044810
025200******************************************************************00044910
025300*  DB2 TABLE TEPTRN - COSA-TRANSACTION TABLE                      00045010
025400******************************************************************00045110
025500     EXEC SQL                                                     00045210
025600          INCLUDE TEPTRN                                          00045310
025700     END-EXEC.                                                    00045410
025800                                                                  00045510
025900******************************************************************00045610
026000*  DB2 TABLE TEPITM - COSA-ITEM TABLE                             00045710
026100******************************************************************00045810
026200     EXEC SQL                                                     00045910
026300          INCLUDE TEPITM                                          00046010
026400     END-EXEC.                                                    00046110
026500                                                                  00046210
250775******************************************************************00046310
250775*  DB2 TABLE ITEM RETURN INFO TABLE                               00046410
250775******************************************************************00046510
250775     EXEC SQL                                                     00046610
250775          INCLUDE TEPIRT                                          00046710
250775     END-EXEC.                                                    00046810
250775******************************************************************00046910
250775*  DB2 TABLE TSTATE                                               00047010
250775******************************************************************00047110
250775     EXEC SQL                                                     00047210
250775          INCLUDE TSTATE                                          00047310
250775     END-EXEC.                                                    00047410
026500                                                                  00047510
028000******************************************************************00047610
028100*  COSA SHIP TABLE                                                00047710
028200******************************************************************00047810
028300     EXEC SQL                                                     00047910
028400         INCLUDE TEPSHP                                           00048010
028500     END-EXEC.                                                    00048110
028600                                                                  00048210
028700******************************************************************00048310
028800*  COSA IPS TABLE                                                 00048410
028900******************************************************************00048510
029000     EXEC SQL                                                     00048610
029100         INCLUDE TEPIPS                                           00048710
029200     END-EXEC.                                                    00048810
029300                                                                  00048910
250775******************************************************************00049010
250775*  DB2 TABLE XST_LOC_ATTR                                         00049110
250775******************************************************************00049210
250775     EXEC SQL                                                     00049310
250775          INCLUDE XST00025                                        00049410
250775     END-EXEC.                                                    00049510
030100                                                                  00049610
029400******************************************************************00049710
029500*  DB2 TABLE XST_LOC - STORE INFORMATION TABLE.                   00049810
029600*      WILL USE TO IDENTIFY E-STORE(S) AND ZIP CODE               00049910
029700******************************************************************00050010
029800     EXEC SQL                                                     00050110
029900          INCLUDE XST00001                                        00050210
030000     END-EXEC.                                                    00050310
030100                                                                  00050410
030200******************************************************************00050510
030300*  ITEM CURSOR                                                    00050610
030400******************************************************************00050710
030500     EXEC SQL                                                     00050810
030600       DECLARE ITEM-CURSOR CURSOR FOR                             00050910
030700            SELECT C.PARTN_NBR                                    00051010
030800                 , C.STR_NBR                                      00051110
030900                 , C.RGST_ID                                      00051210
031000                 , C.TRN_NBR                                      00051310
031100                 , C.STRT_TM                                      00051410
031200                 , C.SLS_CORR_SEQ_NBR                             00051510
031300                 , C.LNE_ITM_SEQ_NBR                              00051610
031400                 , C.DEPT_NBR                                     00051710
031500                 , C.SLD_QTY                                      00051810
031600                 , C.SBJCT_TO_TX_AMT                              00051910
250775                 , C.NET_CHRGD_AMT                                00052010
031700                 , C.MDSE_ID                                      00052110
031800                 , C.TX_AMT                                       00052210
031900                 , B.TRN_TYP_CDE                                  00052310
032000                 , B.TRN_STAT_CDE                                 00052410
032100                 , B.TRN_DTE                                      00052510
032200                 , D.ZIP_10_CDE                                   00052610
032300                 , D.E_BUS_IND                                    00052710
032400             FROM TEPPART A                                       00052810
032500                , TEPTRN  B                                       00052910
032600                , TEPITM  C                                       00053010
032700                , XST_LOC D                                       00053110
032800            WHERE A.PARTN_NBR        = B.PARTN_NBR                00053210
032900              AND A.PARTN_NBR        = C.PARTN_NBR                00053310
033000              AND B.STR_NBR          = D.LOC_NBR                  00053410
033100              AND B.STR_NBR          = C.STR_NBR                  00053510
033200              AND B.RGST_ID          = C.RGST_ID                  00053610
033300              AND B.TRN_NBR          = C.TRN_NBR                  00053710
033400              AND B.STRT_TM          = C.STRT_TM                  00053810
033500              AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR         00053910
033600              AND A.SLS_DTE BETWEEN :CC-BEGIN-DATE                00054010
033700                                AND :CC-END-DATE                  00054110
033800              AND A.DB_STRUC_CDE     = 'O'                        00054210
033900              AND B.VOID_ABRT_CDE    = 'N'                        00054310
034000              AND B.TRN_STAT_CDE    IN ('V', 'Z', 'R', 'L')       00054410
034100              AND B.TRN_TYP_CDE     IN ('01', '02', '11', '12')   00054510
034300              AND C.DEPT_NBR         =  '985'                     00054610
034400              AND C.LIV_RSLU_CDE     IN ('+', '-', 'R')           00054710
034500          ORDER BY C.STR_NBR                                      00054810
034600                 , C.RGST_ID                                      00054910
034700                 , C.TRN_NBR                                      00055010
034800                 , C.LNE_ITM_SEQ_NBR                              00055110
034900                 , B.TRN_TYP_CDE                                  00055210
035000          WITH UR                                                 00055310
035100     END-EXEC.                                                    00055410
250775******************************************************************00055510
250775* CURSOR TO RETREIVE ZIP CODE AND GEO CODE FOR A LINE ITEM       *00055610
250775* USING THE ITEM NUMBER ON A RETURNED ITEM.  THIS IS REQUIRED    *00055710
250775* FOR EMPLOYEE RETURN TRANSACTIONS.                              *00055810
250775******************************************************************00055910
250775     EXEC SQL                                                     00056010
250775         DECLARE TEPITM-CSR CURSOR FOR                            00056110
250775             SELECT A.TRN_DTE                                     00056210
250775                   ,B.TX_RT_PCT                                   00056310
250775                   ,B.TX_AMT                                      00056410
250775                   ,B.SKU_NBR                                     00056510
250775                   ,D.ZIP_5_CDE                                   00056610
250775                   ,D.TX_GEOG_CDE                                 00056710
250775             FROM TEPTRN  A                                       00056810
250775                 ,TEPITM  B                                       00056910
250775                 ,TEPIPS  C                                       00057010
250775                 ,TEPSHP  D                                       00057110
250775             WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR        00057210
250775               AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR       00057310
250775               AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID       00057410
250775               AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR       00057510
250775               AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM       00057610
250775               AND B.UPC_NBR          = :EPITM-UPC-NBR            00057710
250775               AND B.LIV_RSLU_CDE    IN ('+', '-')                00057810
250775               AND A.PARTN_NBR        = B.PARTN_NBR               00057910
250775               AND A.STR_NBR          = B.STR_NBR                 00058010
250775               AND A.RGST_ID          = B.RGST_ID                 00058110
250775               AND A.TRN_NBR          = B.TRN_NBR                 00058210
250775               AND A.STRT_TM          = B.STRT_TM                 00058310
250775               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        00058410
250775               AND B.PARTN_NBR        = C.PARTN_NBR               00058510
250775               AND B.STR_NBR          = C.STR_NBR                 00058610
250775               AND B.RGST_ID          = C.RGST_ID                 00058710
250775               AND B.TRN_NBR          = C.TRN_NBR                 00058810
250775               AND B.STRT_TM          = C.STRT_TM                 00058910
250775               AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR        00059010
250775               AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR         00059110
250775               AND C.PARTN_NBR        = D.PARTN_NBR               00059210
250775               AND C.STR_NBR          = D.STR_NBR                 00059310
250775               AND C.RGST_ID          = D.RGST_ID                 00059410
250775               AND C.TRN_NBR          = D.TRN_NBR                 00059510
250775               AND C.STRT_TM          = D.STRT_TM                 00059610
250775               AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        00059710
250775               AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR          00059810
250775             WITH UR                                              00059910
250775     END-EXEC.                                                    00060010
250775                                                                  00060110
250775******************************************************************00060210
250775* CURSOR TO RETREIVE ZIP CODE AND GEO CODE FOR A LINE ITEM       *00060310
250775* USING THE ITEM NUMBER ON A RETURNED ITEM.  THIS IS REQUIRED    *00060410
250775* FOR EMPLOYEE RETURN TRANSACTIONS.                              *00060510
250775******************************************************************00060610
250775     EXEC SQL                                                     00060710
250775         DECLARE TEPITM-MISS-CSR CURSOR FOR                       00060810
250775             SELECT A.TRN_DTE                                     00060910
250775                   ,B.TX_RT_PCT                                   00061010
250775                   ,B.TX_AMT                                      00061110
250775                   ,B.SKU_NBR                                     00061210
250775                   ,D.ZIP_5_CDE                                   00061310
250775                   ,D.TX_GEOG_CDE                                 00061410
250775             FROM TEPTRN  A                                       00061510
250775                 ,TEPITM  B                                       00061610
250775                 ,TEPSHP  D                                       00061710
250775             WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR        00061810
250775               AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR       00061910
250775               AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID       00062010
250775               AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR       00062110
250775               AND B.LIV_RSLU_CDE    IN ('+', '-')                00062210
250775               AND A.PARTN_NBR        = B.PARTN_NBR               00062310
250775               AND A.STR_NBR          = B.STR_NBR                 00062410
250775               AND A.RGST_ID          = B.RGST_ID                 00062510
250775               AND A.TRN_NBR          = B.TRN_NBR                 00062610
250775               AND A.STRT_TM          = B.STRT_TM                 00062710
250775               AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR        00062810
250775               AND B.PARTN_NBR        = D.PARTN_NBR               00062910
250775               AND B.STR_NBR          = D.STR_NBR                 00063010
250775               AND B.RGST_ID          = D.RGST_ID                 00063110
250775               AND B.TRN_NBR          = D.TRN_NBR                 00063210
250775               AND B.STRT_TM          = D.STRT_TM                 00063310
250775               AND B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR        00063410
250775             WITH UR                                              00063510
250775     END-EXEC.                                                    00063610
250775                                                                  00063710
043500******************************************************************00063810
043600 PROCEDURE DIVISION.                                              00063910
043700******************************************************************00064010
043800 0000-MAINLINE-PARAGRAPH.                                         00064110
043900                                                                  00064210
044000     PERFORM 1000-PROCESS-CONTROL-CARD.                           00064310
044100                                                                  00064410
044200     PERFORM 3000-OPEN-ITEM.                                      00064510
044300                                                                  00064610
044400     PERFORM 3200-FETCH-ITEM.                                     00064710
044500                                                                  00064810
044600     PERFORM 3300-PROCESS-ITEM                                    00064910
044700        UNTIL PS-END-OF-ITEM-YES.                                 00065010
044800                                                                  00065110
044900     PERFORM 3700-CLOSE-ITEM.                                     00065210
045000                                                                  00065310
045100     CLOSE POS-DATE-CARD-FILE                                     00065410
045200           TAX-FILE.                                              00065510
045300                                                                  00065610
045400     STOP RUN.                                                    00065710
045500                                                                  00065810
045600******************************************************************00065910
045700*     OPEN FILES. READ CONTROL CARD TO GET POS DATE IN MMDDYY     00066010
045800*     FORMAT. CALL DATE ROUTINE TO CONVERT DATE TO A CCYY-MM-DD   00066110
045900*     PROCESS DATE.                                               00066210
046000******************************************************************00066310
046100                                                                  00066410
046200 1000-PROCESS-CONTROL-CARD.                                       00066510
046300                                                                  00066610
046400     OPEN INPUT  POS-DATE-CARD-FILE                               00066710
046500          OUTPUT TAX-FILE.                                        00066810
046600                                                                  00066910
046700     READ POS-DATE-CARD-FILE INTO DATE-CONTROL-CARD               00067010
046800        AT END                                                    00067110
046900           SET PS-END-OF-CARD-FILE-YES TO TRUE.                   00067210
047000                                                                  00067310
047100     IF PS-END-OF-CARD-FILE-YES                                   00067410
047200         MOVE '1000-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   00067510
047300         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  00067610
047400         SET AC-CONTROL-CARD-ERROR TO TRUE                        00067710
047500         PERFORM 9999-ABEND                                       00067810
047600     END-IF.                                                      00067910
047700                                                                  00068010
047700     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         00068110
047700     SET DPG51-DO-NOT-INCR-DECR-DATE  TO TRUE.                    00068210
047700     SET DPG51-FISCAL-454-CALENDAR    TO TRUE.                    00068310
047700     SET DPG52-LK-DTE-ISO-FMT         TO TRUE.                    00068410
047700                                                                  00068510
047700     MOVE CC-MTH-ENDING-DATE-ISO      TO DPG52-LK-DATE-INPUT.     00068610
047700                                                                  00068710
047700     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    00068810
047700                                             DPG54 DPG55 DPG56.   00068910
047700     IF  DPG54-SEVERE-ERROR                                       00069010
047700        DISPLAY '*********************************'               00069110
047700        DISPLAY '** ABEND FROM CALL SUB         **'               00069210
047700        DISPLAY '** PROGRAM = TXKRP012          **'               00069310
047700        DISPLAY '** DATE = ' CC-CONTROL-CARD  ' **'               00069410
047700        DISPLAY '*********************************'               00069510
047700        DISPLAY DPG54-ERROR-MESSAGE                               00069610
047700        SET AC-CONTROL-CARD-ERROR TO TRUE                         00069710
047700        PERFORM 9999-ABEND                                        00069810
047700     ELSE                                                         00069910
047700        IF  DPG54-DATE-INVALID                                    00070010
047700           DISPLAY '****************************'                 00070110
047700           DISPLAY '** ABEND INVALID END DATE **'                 00070210
047700           DISPLAY '** PROGRAM = TXKRP012     **'                 00070310
047700           DISPLAY '** DATE = ' CC-CONTROL-CARD '**'              00070410
047700           DISPLAY '****************************'                 00070510
047700           DISPLAY DPG54-ERROR-MESSAGE                            00070610
047700           SET AC-CONTROL-CARD-ERROR TO TRUE                      00070710
047700           PERFORM 9999-ABEND                                     00070810
047700        END-IF                                                    00070910
047700     END-IF.                                                      00071010
047700                                                                  00071110
047700     IF DPG55-ALPHA-WEEK-DAY-SATURDAY                             00071210
047700        CONTINUE                                                  00071310
047700     ELSE                                                         00071410
047700        DISPLAY '** ABEND **'                                     00071510
047700        DISPLAY '** PROGRAM   ** = SAKRP100'                      00071610
047700        DISPLAY '** PARAGRAPH ** = 1000-PROCESS-CONTROL-CARD'     00071710
047700        DISPLAY 'BAD INPUT DATE: '                                00071810
047700                        CC-MTH-ENDING-DATE-ISO                    00071910
047700        DISPLAY 'INPUT DATE IS NOT A WEEK ENDING DATE'            00072010
047700        SET AC-CONTROL-CARD-ERROR TO TRUE                         00072110
047700        CALL 'ILBOABN0' USING AC-ABEND-CODE                       00072210
047700     END-IF.                                                      00072310
047700                                                                  00072410
047700     MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO CC-BEGIN-DATE.            00072510
047700     MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO CC-END-DATE.              00072610
047700                                                                  00072710
047700     DISPLAY '**********************************************'     00072810
047700     DISPLAY PC-CURRENT-PROGRAM-NAME                              00072910
047700         ' - CALENDAR = (' CC-CONTROL-CARD-DISPLAY  ')'.          00073010
047700                                                                  00073110
047700     DISPLAY PC-CURRENT-PROGRAM-NAME                              00073210
047700         ' - DATE CONTROL CARD = ' DATE-CONTROL-CARD ')'.         00073310
047700     DISPLAY '**********************************************'     00073410
047700                                                                  00073510
048100     PERFORM 1200-FORMAT-DATE.                                    00073610
048200                                                                  00073710
048300     INITIALIZE PV-ZIP-CODE-TABLE                                 00073810
NEW 00                EC-ECOM-STORE-TABLE.                              00073910
048400                                                                  00074010
048410     MOVE PC-CURRENT-PROGRAM-NAME TO DP031-PROGRAM-NAME.          00074110
048420                                                                  00074210
048440     SET ZP-IDX2 TO 1.                                            00074310
048450                                                                  00074410
048500******************************************************************00074510
048600*     GET CURRENT DATE AND TIME FROM SYSTEM.                      00074610
048700******************************************************************00074710
048800                                                                  00074810
048900 1200-FORMAT-DATE.                                                00074910
049000                                                                  00075010
049100     MOVE FUNCTION CURRENT-DATE (1:8) TO PV-CURR-DATE-CCYYMMDD.   00075110
049200     ACCEPT PV-CURR-TIME FROM TIME.                               00075210
049300                                                                  00075310
049400     MOVE CC-BEGIN-DATE               TO PV-BEG-CCYY-MM-DD.       00075410
049500     MOVE CC-END-DATE                 TO PV-END-CCYY-MM-DD.       00075510
049600                                                                  00075610
049700******************************************************************00075710
049800* OPEN ITEM CURSOR                                                00075810
049900******************************************************************00075910
050000                                                                  00076010
050100 3000-OPEN-ITEM.                                                  00076110
050200                                                                  00076210
050300     EXEC SQL                                                     00076310
050400          OPEN ITEM-CURSOR                                        00076410
050500     END-EXEC.                                                    00076510
050600                                                                  00076610
050700     IF NOT SQLCODE = ZERO                                        00076710
050800        MOVE SQLCODE                 TO PV-DB2-OPERATION          00076810
050900        PERFORM 9800-SQL-ABEND                                    00076910
051000     END-IF.                                                      00077010
051100                                                                  00077110
051200******************************************************************00077210
051300* FETCH ITEM CURSOR                                               00077310
051400******************************************************************00077410
051500                                                                  00077510
051600 3200-FETCH-ITEM.                                                 00077610
051700                                                                  00077710
051800     EXEC SQL                                                     00077810
051900          FETCH ITEM-CURSOR                                       00077910
052000           INTO :EPITM-PARTN-NBR                                  00078010
052100              , :EPITM-STR-NBR                                    00078110
052200              , :EPITM-RGST-ID                                    00078210
052300              , :EPITM-TRN-NBR                                    00078310
052400              , :EPITM-STRT-TM                                    00078410
052500              , :EPITM-SLS-CORR-SEQ-NBR                           00078510
052600              , :EPITM-LNE-ITM-SEQ-NBR                            00078610
052700              , :EPITM-DEPT-NBR                                   00078710
052800              , :EPITM-SLD-QTY                                    00078810
052900              , :EPITM-SBJCT-TO-TX-AMT                            00078910
250775              , :EPITM-NET-CHRGD-AMT                              00079010
053000              , :EPITM-MDSE-ID                                    00079110
053100              , :EPITM-TX-AMT                                     00079210
053200              , :EPTRN-TRN-TYP-CDE                                00079310
053300              , :EPTRN-TRN-STAT-CDE                               00079410
053400              , :EPTRN-TRN-DTE                                    00079510
053500              , :XST00001-ZIP-10-CDE                              00079610
053600              , :XST00001-E-BUS-IND                               00079710
053700     END-EXEC.                                                    00079810
053800                                                                  00079910
053900     EVALUATE TRUE                                                00080010
054000        WHEN SQLCODE = ZERO                                       00080110
054100             CONTINUE                                             00080210
054200        WHEN SQLCODE = PC-NOT-FOUND                               00080310
250775             SET PS-END-OF-ITEM-YES      TO TRUE                  00080410
054400        WHEN OTHER                                                00080510
250775             MOVE '3200-FETCH-ITEM'      TO PV-PARAGRAPH-NAME     00080610
250775             MOVE SQLCODE                TO PV-DB2-OPERATION      00080710
250775             MOVE EPITM-PARTN-NBR        TO EPTRN-PARTN-NBR       00080810
250775             MOVE EPITM-STR-NBR          TO EPTRN-STR-NBR         00080910
250775             MOVE EPITM-RGST-ID          TO EPTRN-RGST-ID         00081010
250775             MOVE EPITM-TRN-NBR          TO EPTRN-TRN-NBR         00081110
250775             MOVE EPITM-STRT-TM          TO EPTRN-STRT-TM         00081210
250775             MOVE EPITM-SLS-CORR-SEQ-NBR TO EPTRN-SLS-CORR-SEQ-NBR00081310
054700             PERFORM 9800-SQL-ABEND                               00081410
054800     END-EVALUATE.                                                00081510
054900                                                                  00081610
055000     IF PS-FIRST-TIME                                             00081710
055100         MOVE EPITM-PARTN-NBR     TO PV-HOLD-PARTN-NBR            00081810
055200         MOVE EPITM-STR-NBR       TO PV-HOLD-STR-NBR              00081910
055300         MOVE EPTRN-TRN-TYP-CDE   TO PV-HOLD-TRN-TYP-CDE          00082010
055400         MOVE 'N' TO PS-FIRST-TIME-SW                             00082110
055500     END-IF.                                                      00082210
055600                                                                  00082310
055700******************************************************************00082410
055800* PROCESS ITEM DETAIL LINE                                        00082510
055900******************************************************************00082610
056000                                                                  00082710
056100 3300-PROCESS-ITEM.                                               00082810
056200                                                                  00082910
056300     MOVE EPITM-PARTN-NBR        TO PV-HOLD-PARTN-NBR             00083010
056400                                    TX020-PARTN-NBR.              00083110
056500     MOVE EPITM-STR-NBR          TO PV-HOLD-STR-NBR.              00083210
056600     MOVE EPTRN-TRN-TYP-CDE      TO PV-HOLD-TRN-TYP-CDE.          00083310
056700                                                                  00083410
056800     MOVE EPITM-STR-NBR          TO TX020-STR-NBR.                00083510
056900     MOVE EPITM-RGST-ID          TO TX020-RGST-ID.                00083610
057000     MOVE EPITM-TRN-NBR          TO TX020-TRN-NBR.                00083710
057100     MOVE EPITM-STRT-TM          TO TX020-START-TIME.             00083810
057200     MOVE EPITM-SLS-CORR-SEQ-NBR TO TX020-SLS-CORR-SEQ-NBR.       00083910
057300     MOVE EPITM-LNE-ITM-SEQ-NBR  TO TX020-LNE-ITM-SEQ-NBR.        00084010
057400     MOVE EPTRN-TRN-TYP-CDE      TO TX020-TRN-TYP-CDE.            00084110
250775     IF EPTRN-TRN-TYP-CDE = '11' OR '12'                          00084210
250775         PERFORM 7500-GET-ORIG-TRANS-INFO                         00084310
250775         PERFORM 4110-ECOMM-RETURN-PROCESSING                     00084410
250775     END-IF.                                                      00084510
057500     MOVE EPITM-MDSE-ID          TO TX020-MDSE-ID.                00084610
057600     MOVE EPITM-SLD-QTY          TO TX020-SLD-QTY.                00084710
058000     MOVE EPITM-TX-AMT           TO TX020-TX-AMT.                 00084810
250775     MOVE EPITM-DEPT-NBR         TO TX020-DEPT-NBR.               00084910
058110                                                                  00085010
250775     IF EPITM-SBJCT-TO-TX-AMT = 0                                 00085110
250775        MOVE EPITM-NET-CHRGD-AMT    TO TX020-TAXABLE-AMT          00085210
250775     ELSE                                                         00085310
250775        MOVE EPITM-SBJCT-TO-TX-AMT  TO TX020-TAXABLE-AMT          00085410
250775     END-IF.                                                      00085510
                                                                        00085610
250775     IF EPTRN-TRN-TYP-CDE = '01' OR '02'                          00085710
250775        PERFORM 3550-SELECT-TEPSHP-AMT                            00085810
250775        MOVE PV-TEPSHP-CHRG-AMT     TO TX020-SHP-CHRG-AMT         00085910
250775        MOVE PV-TEPSHP-TX-RT-PCT    TO TX020-SHP-TX-RT-PCT        00086010
250775        MOVE PV-TEPSHP-TX-AMT       TO TX020-SHP-TX-AMT           00086110
250775        IF PV-SAVE-ZIP-5-CDE = PV-TEPSHP-ZIP-5-CDE                00086210
250775           CONTINUE                                               00086310
250775        ELSE                                                      00086410
250775           MOVE PV-TEPSHP-ZIP-5-CDE    TO PV-SAVE-ZIP-5-CDE       00086510
250775                                          PV-ENCR-ZIP-CODE        00086610
250775           PERFORM 8400-PROCESS-ZIP-CDE                           00086710
250775           MOVE PV-ZIP-CODE         TO TX020-ZIP-CDE              00086810
250775        END-IF                                                    00086910
250775     ELSE                                                         00087010
250775        MOVE ZERO                   TO TX020-SHP-TX-AMT           00087110
250775                                       TX020-SHP-TX-RT-PCT        00087210
250775                                       TX020-SHP-TX-AMT           00087310
250775     END-IF.                                                      00087410
058110                                                                  00087510
058411     MOVE SPACES                 TO TX020-ST-CDE.                 00087610
058420                                                                  00087710
058500     MOVE PV-TEPSHP-GEOG-CDE     TO TX020-GEO-CDE.                00087810
058510     PERFORM 7900-GET-ECOMMERCE-ORDER-NBR.                        00087910
250775     IF SQLCODE = +100                                            00088010
250775         MOVE SPACES             TO TX020-ORDER-NUMBER            00088110
250775     ELSE                                                         00088210
058600        MOVE EPORD-ORD-NBR       TO TX020-ORDER-NUMBER            00088310
250775     END-IF.                                                      00088410
058700     MOVE EPTRN-TRN-DTE          TO TX020-ORDER-DTE.              00088510
058800                                                                  00088610
059300*    DISPLAY 'OTHER EPITM-TX-AMT '                                00088710
059400*                   EPITM-TX-AMT.                                 00088810
059500*    DISPLAY 'OTHER EPSHP-TX-AMT '                                00088910
059600*                   EPSHP-TX-AMT.                                 00089010
059900*    DISPLAY 'OTHER PV-TX-AMT '                                   00089110
060000*                   PV-TX-AMT.                                    00089210
060100                                                                  00089310
060200     PERFORM 3600-WRITE-ITEM.                                     00089410
060300                                                                  00089510
060400     PERFORM 3200-FETCH-ITEM.                                     00089610
060500                                                                  00089710
060600     MOVE ZERO  TO PV-TX-AMT                                      00089810
060700                   PV-TEPSHP-TX-AMT.                              00089910
060710     MOVE SPACES TO PV-TEPSHP-ZIP-5-CDE.                          00090010
060800                                                                  00090110
060900******************************************************************00090210
061000* GET THE TX AMT FROM TEPSHP FOR MARKETPLACE ITEMS SOLD.  NEED    00090310
061100* TEPIPS TO KNOW WHICH LINE ITEM IS THE SHIPPING TAX.             00090410
061200******************************************************************00090510
061300                                                                  00090610
061400 3550-SELECT-TEPSHP-AMT.                                          00090710
061500                                                                  00090810
061600     EXEC SQL                                                     00090910
061700        SELECT SHP.SHIP_CHRG_AMT                                  00091010
061700             , SHP.TX_RT_PCT                                      00091110
061700             , SHP.TX_AMT                                         00091210
061710             , SHP.ZIP_5_CDE                                      00091310
061720             , SHP.TX_GEOG_CDE                                    00091410
061800        INTO :PV-TEPSHP-CHRG-AMT                                  00091510
061800            ,:PV-TEPSHP-TX-RT-PCT                                 00091610
061800            ,:PV-TEPSHP-TX-AMT                                    00091710
061810            ,:PV-TEPSHP-ZIP-5-CDE                                 00091810
061820            ,:PV-TEPSHP-GEOG-CDE                                  00091910
061900        FROM TEPSHP SHP                                           00092010
062000           , TEPIPS IPS                                           00092110
062100           , TEPITM ITM                                           00092210
062200        WHERE SHP.PARTN_NBR         =:EPITM-PARTN-NBR             00092310
062300          AND SHP.STR_NBR           =:EPITM-STR-NBR               00092410
062400          AND SHP.RGST_ID           =:EPITM-RGST-ID               00092510
062500          AND SHP.TRN_NBR           =:EPITM-TRN-NBR               00092610
062600          AND SHP.STRT_TM           =:EPITM-STRT-TM               00092710
062700          AND SHP.SLS_CORR_SEQ_NBR  =:EPITM-SLS-CORR-SEQ-NBR      00092810
062800          AND SHP.PARTN_NBR         = IPS.PARTN_NBR               00092910
062900          AND SHP.PARTN_NBR         = ITM.PARTN_NBR               00093010
063000          AND SHP.STR_NBR           = IPS.STR_NBR                 00093110
063100          AND SHP.STR_NBR           = ITM.STR_NBR                 00093210
063200          AND SHP.RGST_ID           = IPS.RGST_ID                 00093310
063300          AND SHP.RGST_ID           = ITM.RGST_ID                 00093410
063400          AND SHP.TRN_NBR           = IPS.TRN_NBR                 00093510
063500          AND SHP.TRN_NBR           = ITM.TRN_NBR                 00093610
063600          AND SHP.STRT_TM           = IPS.STRT_TM                 00093710
063700          AND SHP.STRT_TM           = ITM.STRT_TM                 00093810
063800          AND SHP.SLS_CORR_SEQ_NBR  = IPS.SLS_CORR_SEQ_NBR        00093910
063900          AND SHP.SLS_CORR_SEQ_NBR  = ITM.SLS_CORR_SEQ_NBR        00094010
064000          AND IPS.LNE_ITM_SEQ_NBR   = ITM.LNE_ITM_SEQ_NBR         00094110
064100          AND SHP.PLND_SHIPT_NBR    = IPS.PLND_SHIPT_NBR          00094210
064200*         AND SHP.SHIP_CHRG_AMT    ^= 0                           00094310
034300          AND ITM.DEPT_NBR          = '985'                       00094410
064300          WITH UR                                                 00094510
064400     END-EXEC.                                                    00094610
064500                                                                  00094710
064600     EVALUATE TRUE                                                00094810
064700        WHEN SQLCODE = ZERO                                       00094910
064800             CONTINUE                                             00095010
064810        WHEN SQLCODE = -811                                       00095110
064820             CONTINUE                                             00095210
064900        WHEN SQLCODE = +100                                       00095310
065000             CONTINUE                                             00095410
065100        WHEN SQLCODE = -305                                       00095510
065200             CONTINUE                                             00095610
065300        WHEN OTHER                                                00095710
065400             MOVE '3550-SELECT-TEPSHP-AMT'   TO PV-PARAGRAPH-NAME 00095810
065500             MOVE SQLCODE                    TO PV-DB2-OPERATION  00095910
065510             MOVE  EPITM-PARTN-NBR           TO EPTRN-PARTN-NBR   00096010
065520             MOVE  EPITM-STR-NBR             TO EPTRN-STR-NBR     00096110
065530             MOVE  EPITM-RGST-ID             TO EPTRN-RGST-ID     00096210
065540             MOVE  EPITM-TRN-NBR             TO EPTRN-TRN-NBR     00096310
065600             PERFORM 9800-SQL-ABEND                               00096410
065700     END-EVALUATE.                                                00096510
065800                                                                  00096610
065900******************************************************************00096710
066000 3600-WRITE-ITEM.                                                 00096810
066100******************************************************************00096910
066200                                                                  00097010
066300     WRITE TAX-RECORD FROM TX020-MARKETPLACE-RECORD.              00097110
066400                                                                  00097210
066500******************************************************************00097310
066600 3700-CLOSE-ITEM.                                                 00097410
066700******************************************************************00097510
066800                                                                  00097610
066900     EXEC SQL                                                     00097710
067000          CLOSE ITEM-CURSOR                                       00097810
067100     END-EXEC.                                                    00097910
067200                                                                  00098010
067300     IF NOT SQLCODE = ZERO                                        00098110
067400        MOVE '3700-CLOSE-ITEM'        TO PV-PARAGRAPH-NAME        00098210
067500        MOVE SQLCODE                  TO PV-DB2-OPERATION         00098310
067600        PERFORM 9800-SQL-ABEND                                    00098410
067700     END-IF.                                                      00098510
066800                                                                  00098610
250775******************************************************************00098710
250775* GET THE TAX RATE AND AMOUNT FROM THE ITEM TABLE.               *00098810
250775* IF THE RETURN IS A RECEIPTED RETURN GET THE ORIGINAL           *00098910
250775* TRANSACTION INFORMATION.                                       *00099010
250775******************************************************************00099110
250775 4110-ECOMM-RETURN-PROCESSING.                                    00099210
250775                                                                  00099310
250775     IF PS-RECEIPTED-RETURN                                       00099410
250775         PERFORM 7800-GET-RETURN-INFO                             00099510
250775     END-IF.                                                      00099610
250775                                                                  00099710
250775******  IF THE ORIGINAL TRANSACTION IS NOT FOUND IN PARA 7800-    00099810
250775******  PROCESS THE RETURN LIKE A NON RECEIPTED RETURN.           00099910
250775                                                                  00100010
250775     IF PS-NON-RECEIPTED-RETURN                                   00100110
250775         PERFORM 8100-SEARCH-FOR-STORE-INFO                       00100210
250775*        MOVE PV-POS-CCYY-MM-DD TO PV-ORD-DTE                     00100310
250775     END-IF.                                                      00100410
250775                                                                  00100510
250775******************************************************************00100610
250775*  GET THE ORIGINAL TRANSACTION FOR THE RETURN.  GET THE STORE   *00100710
250775*  INFORMATION FOR THE ORIGINAL TRANSACTION.                     *00100810
250775******************************************************************00100910
250775 7500-GET-ORIG-TRANS-INFO.                                        00101010
250775                                                                  00101110
250775     PERFORM 7510-GET-ORIG-TRANSACTION.                           00101210
250775     IF PS-NON-RECEIPTED-RETURN                                   00101310
250775         MOVE EPTRN-STR-NBR              TO PV-WORK-STR-NBR       00101410
BARB  *        DISPLAY ' PS-NON-RECEIPTED-RETURN ' PV-WORK-STR-NBR      00101510
250775     ELSE                                                         00101610
250775         MOVE EPIRT-ORIG-STR-NBR         TO PV-WORK-STR-NBR       00101900
250775                                            PV-RT-ORIG-STR-NBR    00102000
250775                                            PV-WORK-STR-NBR-D     00102100
250775         MOVE EPIRT-ORIG-SLS-DTE         TO PV-WORK-SLS-DTE       00102200
250775                                            PV-RT-ORIG-SLS-DTE    00102300
250775         MOVE EPIRT-ORIG-RGST-ID         TO PV-WORK-RGST-ID       00102400
250775                                            PV-RT-ORIG-RGST-ID    00102500
250775         MOVE EPIRT-ORIG-TRN-NBR         TO PV-WORK-TRN-NBR       00102600
250775                                            PV-RT-ORIG-TRN-NBR    00102700
250775         MOVE EPIRT-ORIG-STRT-TM         TO PV-WORK-STRT-TM       00102800
250775                                            PV-RT-ORIG-STRT-TM    00102900
BARB           MOVE EPIRT-ORIG-LNE-ITM-NBR   TO PV-WORK-LNE-ITM-SEQ-NBR 00103010
250775                                           PV-RT-ORIG-LNE-ITM-NBR 00103100
250775         PERFORM 7530-GET-ORIG-PARTN-NBR                          00103200
250775         IF  PS-NON-RECEIPTED-RETURN                              00103300
250775             SET PS-ORIG-SALES-DATE-NOT-FOUND TO TRUE             00103400
250775             PERFORM 7531-GET-ORIG-SALES-DATE                     00103500
250775             IF PS-ORIG-SALES-DATE-FOUND                          00103600
250775                   MOVE EPIRT-ORIG-SLS-DTE TO PV-TRN-DTE          00103700
250775                   MOVE PV-SLS-DTE-WRK TO EPIRT-ORIG-SLS-DTE      00103800
250775                   SET PS-RECEIPTED-RETURN     TO TRUE            00103900
250775                   PERFORM 7530-GET-ORIG-PARTN-NBR                00104000
250775             END-IF                                               00104100
250775         END-IF                                                   00104200
250775     END-IF.                                                      00104300
250775                                                                  00104400
250775***************************************************************** 00104500
250775*  GET THE ORIGINAL TRANSACTION INFORMATION FROM TEPIRT         * 00104600
250775***************************************************************** 00104700
250775 7510-GET-ORIG-TRANSACTION.                                       00104800
250775                                                                  00104900
250775     EXEC SQL                                                     00105000
250775         SELECT ORIG_SLS_DTE                                      00106000
250775               ,ORIG_STR_NBR                                      00107000
250775               ,ORIG_RGST_ID                                      00107100
250775               ,ORIG_TRN_NBR                                      00107200
250775               ,ORIG_STRT_TM                                      00107300
250775               ,ORIG_LNE_ITM_NBR                                  00107400
250775         INTO  :EPIRT-ORIG-SLS-DTE                                00107500
250775              ,:EPIRT-ORIG-STR-NBR                                00107600
250775              ,:EPIRT-ORIG-RGST-ID                                00107700
250775              ,:EPIRT-ORIG-TRN-NBR                                00107800
250775              ,:EPIRT-ORIG-STRT-TM                                00107900
250775              ,:EPIRT-ORIG-LNE-ITM-NBR                            00108000
250775         FROM TEPIRT A                                            00108100
250775         WHERE PARTN_NBR          = :EPITM-PARTN-NBR              00108200
250775           AND STR_NBR            = :EPITM-STR-NBR                00108300
250775           AND RGST_ID            = :EPITM-RGST-ID                00108400
250775           AND TRN_NBR            = :EPITM-TRN-NBR                00108500
250775           AND A.STRT_TM          = :EPITM-STRT-TM                00108600
250775           AND A.SLS_CORR_SEQ_NBR = :EPITM-SLS-CORR-SEQ-NBR       00108700
250775           AND A.LNE_ITM_SEQ_NBR  = :EPITM-LNE-ITM-SEQ-NBR        00108800
250775           WITH UR                                                00108900
250775     END-EXEC.                                                    00109000
250775                                                                  00109100
250775     EVALUATE SQLCODE                                             00109200
250775         WHEN ZERO                                                00109300
250775             SET PS-RECEIPTED-RETURN     TO TRUE                  00109400
BARB               MOVE EPITM-PARTN-NBR TO PV-WORK-PARTN-NBR            00109510
BARB               MOVE EPITM-STR-NBR   TO PV-WORK-STR-NBR              00109610
BARB               MOVE EPITM-RGST-ID   TO PV-WORK-RGST-ID              00109710
BARB               MOVE EPITM-TRN-NBR   TO PV-WORK-TRN-NBR              00109810
BARB               MOVE EPITM-STRT-TM   TO PV-WORK-STRT-TM              00109910
BARB  *            DISPLAY 'EPITM-PARTN-NBR ' PV-WORK-PARTN-NBR         00110010
BARB  *            DISPLAY 'EPITM-STR-NBR ' PV-WORK-STR-NBR             00110110
BARB  *            DISPLAY 'EPITM-RGST-ID ' PV-WORK-RGST-ID             00110210
BARB  *            DISPLAY 'EPITM-TRN-NBR ' PV-WORK-TRN-NBR             00110310
BARB  *            DISPLAY 'EPITM-STRT-TM ' PV-WORK-STRT-TM             00110410
250775         WHEN +100                                                00111300
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00111400
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00111500
250775         WHEN OTHER                                               00111600
250775             MOVE '7510-GET-ORIG-TRANSACTION'                     00111700
250775                                            TO PV-PARAGRAPH-NAME  00111800
250775             MOVE 'ERROR ON GETTING RETURN CURSOR '               00111900
250775                                            TO PV-DB2-OPERATION   00112000
250775             MOVE SQLCODE                TO PV-DB2-OPERATION      00112100
250775             MOVE EPITM-PARTN-NBR TO PV-WORK-PARTN-NBR            00112200
250775             MOVE EPITM-STR-NBR   TO PV-WORK-STR-NBR              00112300
250775             MOVE EPITM-RGST-ID   TO PV-WORK-RGST-ID              00112400
250775             MOVE EPITM-TRN-NBR   TO PV-WORK-TRN-NBR              00112500
250775             MOVE EPITM-STRT-TM   TO PV-WORK-STRT-TM              00112600
250775             DISPLAY 'EPITM-PARTN-NBR ' PV-WORK-PARTN-NBR         00112700
250775             DISPLAY 'EPITM-STR-NBR ' PV-WORK-STR-NBR             00112800
250775             DISPLAY 'EPITM-RGST-ID ' PV-WORK-RGST-ID             00112900
250775             DISPLAY 'EPITM-TRN-NBR ' PV-WORK-TRN-NBR             00113000
250775             DISPLAY 'EPITM-STRT-TM ' PV-WORK-STRT-TM             00113100
250775             PERFORM 9800-SQL-ABEND                               00113200
250775     END-EVALUATE.                                                00113300
250775                                                                  00113400
250775***************************************************************** 00113500
250775*  GET THE ORIGINAL PARTITION NUMBER FOR A RETURN PROCESSED AT  * 00113600
250775*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 00113700
250775*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              00113800
250775***************************************************************** 00113900
250775 7530-GET-ORIG-PARTN-NBR.                                         00114000
250775                                                                  00114100
250775     EXEC SQL                                                     00114200
250775         SELECT  P.PARTN_NBR                                      00114300
250775                ,TRN_DTE                                          00114400
250775         INTO    :PV-ORIG-PARTN-NBR                               00114500
250775                ,:PV-TRN-DTE                                      00114600
250775         FROM TEPTRN T                                            00114700
250775            , TEPPART P                                           00114800
250775         WHERE P.SLS_DTE      = :EPIRT-ORIG-SLS-DTE               00114900
250775           AND T.PARTN_NBR    = P.PARTN_NBR                       00115000
250775           AND T.STR_NBR      = :EPIRT-ORIG-STR-NBR               00115100
250775           AND T.RGST_ID      = :EPIRT-ORIG-RGST-ID               00115200
250775           AND T.TRN_NBR      = :EPIRT-ORIG-TRN-NBR               00115300
250775           AND T.SLS_CORR_SEQ_NBR =                               00115400
250775              ( SELECT MAX(SLS_CORR_SEQ_NBR)                      00115500
250775                    FROM TEPTRN S                                 00115600
250775                WHERE S.PARTN_NBR = T.PARTN_NBR                   00115700
250775                  AND S.STR_NBR   = T.STR_NBR                     00115800
250775                  AND S.RGST_ID   = T.RGST_ID                     00115900
250775                  AND S.TRN_NBR   = T.TRN_NBR                     00116000
250775                  AND S.STRT_TM   = T.STRT_TM)                    00116100
250775         WITH UR                                                  00116200
250775     END-EXEC.                                                    00116300
250775                                                                  00116400
250775     EVALUATE SQLCODE                                             00116500
250775         WHEN ZERO                                                00116600
250775             MOVE PV-ORIG-PARTN-NBR TO PV-WORK-PARTN-NBR          00116700
250775*            CONTINUE                                             00116800
250775         WHEN -811                                                00116900
BARB  *            DISPLAY EPIRT-ORIG-SLS-DTE ' '                       00117010
BARB  *                    'MORE THAN ONE PARTITION FOR PROCESSING DAY' 00117110
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00117200
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00117300
250775         WHEN +100                                                00117400
BARB  *            DISPLAY 'NONRECEIPTED RETURN'                        00117510
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00117600
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00117700
250775         WHEN OTHER                                               00117800
250775             MOVE 'PARAGRAPH 7530-GET-ORIG-PARTN-NBR'             00117900
250775                                         TO PV-PARAGRAPH-NAME     00118000
250775             MOVE SQLCODE                TO PV-DB2-OPERATION      00118100
250775             PERFORM 9800-SQL-ABEND                               00118200
250775     END-EVALUATE.                                                00118300
250775                                                                  00118400
250775***************************************************************** 00118500
250775*  GET THE ORIGINAL PARTITION NUMBER FOR A RETURN PROCESSED AT  * 00118600
250775*  A BRICK AND MORTAR STORE. THE ORIGINAL SALES DATE ON TEPIRT  * 00118700
250775*  IS THE DATE THE ORDER WAS PROCESSED THROUGH COSA.              00118800
250775***************************************************************** 00118900
250775 7531-GET-ORIG-SALES-DATE.                                        00119000
250775                                                                  00119100
250775     EXEC SQL                                                     00119200
250775         SELECT  E.SLS_DTE                                        00119300
250775         INTO    :PV-SLS-DTE-WRK                                  00119400
250775         FROM TEPECX E, TEPPART P                                 00119500
250775         WHERE P.SLS_DTE = :EPIRT-ORIG-SLS-DTE                    00119600
250775         AND E.ORD_PARTN_NBR= P.PARTN_NBR                         00119700
250775         AND E.STR_NBR      = :EPIRT-ORIG-STR-NBR                 00119800
250775         AND E.RGST_ID      = :EPIRT-ORIG-RGST-ID                 00119900
250775         AND E.TRN_NBR      = :EPIRT-ORIG-TRN-NBR                 00120000
250775         WITH UR                                                  00120100
250775     END-EXEC.                                                    00120200
250775                                                                  00120300
250775     EVALUATE SQLCODE                                             00120400
250775         WHEN ZERO                                                00120500
250775             SET PS-ORIG-SALES-DATE-FOUND   TO TRUE               00120600
250775         WHEN -811                                                00120700
BARB  *            DISPLAY EPIRT-ORIG-SLS-DTE ' '                       00120810
BARB  *                    'MORE THAN ONE PARTITION FOR PROCESSING DAY' 00120910
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00121000
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00121100
250775         WHEN +100                                                00121200
250775             SET PS-ORIG-SALES-DATE-NOT-FOUND   TO TRUE           00121300
250775         WHEN OTHER                                               00121400
250775             MOVE 'PARAGRAPH 7531-GET-ORIG-SALES-DATE'            00121500
250775                                            TO PV-PARAGRAPH-NAME  00121600
250775             MOVE SQLCODE                   TO PV-DB2-OPERATION   00121700
250775             PERFORM 9800-SQL-ABEND                               00121800
250775     END-EVALUATE.                                                00121900
250775                                                                  00122000
250775***************************************************************** 00122100
250775 7538-TEPECX-PART-FETCH.                                          00122200
250775***************************************************************** 00122300
250775                                                                  00122400
250775     EXEC SQL                                                     00122500
250775         SELECT  PARTN_NBR                                        00122600
250775         INTO    :PV-ORD-PARTN-NBR                                00122700
250775         FROM TEPPART                                             00122800
250775         WHERE SLS_DTE = :PV-TRN-DTE                              00122900
250775         WITH UR                                                  00123000
250775     END-EXEC.                                                    00123100
250775                                                                  00123200
250775     EVALUATE SQLCODE                                             00123300
250775         WHEN ZERO                                                00123400
250775             CONTINUE                                             00123500
250775         WHEN -811                                                00123600
BARB  *            DISPLAY EPIRT-ORIG-SLS-DTE ' '                       00123710
BARB  *                    'MORE THAN ONE PARTITION FOR PROCESSING DAY' 00123810
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00123900
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00124000
250775         WHEN +100                                                00124100
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00124200
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00124300
250775         WHEN OTHER                                               00124400
250775             MOVE 'PARAGRAPH 7538-TEPECX-PART-FETCH '             00124500
250775                                            TO PV-PARAGRAPH-NAME  00124600
250775             MOVE SQLCODE                   TO PV-DB2-OPERATION   00124700
250775             PERFORM 9800-SQL-ABEND                               00124800
250775     END-EVALUATE.                                                00124900
250775                                                                  00125000
250775***************************************************************** 00125100
250775*  LOOK FOR A TEPECX ROW FOR THE ORIGINAL TRANSACTION.          * 00125200
250775*  IF A ROW IS FOUND, THEN THE ORIGINAL TRANSACTION WAS AN ECOM * 00125300
250775*  TRANSACTION, ELSE, IT WAS NOT.                               * 00125400
250775***************************************************************** 00125500
250775 7540-CHECK-FOR-TEPECX.                                           00125600
250775                                                                  00125700
250775     EXEC SQL                                                     00125800
250775          SELECT  1                                               00125900
250775          INTO    :PS-TEPECX-EXISTS-SW                            00126000
250775          FROM TEPECX                                             00126100
250775         WHERE ORD_PARTN_NBR =  :PV-ORD-PARTN-NBR                 00126200
250775           AND STR_NBR       =  :EPIRT-ORIG-STR-NBR               00126300
250775           AND RGST_ID       =  :EPIRT-ORIG-RGST-ID               00126400
250775           AND TRN_NBR       =  :EPIRT-ORIG-TRN-NBR               00126500
250775         WITH UR                                                  00126600
250775     END-EXEC.                                                    00126700
250775                                                                  00126800
250775     EVALUATE SQLCODE                                             00126900
250775         WHEN ZERO                                                00127000
250775         WHEN -811                                                00127100
250775             CONTINUE                                             00127200
250775         WHEN +100                                                00127300
250775             CONTINUE                                             00127400
250775         WHEN OTHER                                               00127500
250775             MOVE 'PARAGRAPH 7540-CHECK-FOR-TEPECX'               00127600
250775                                            TO PV-PARAGRAPH-NAME  00127700
250775             MOVE SQLCODE                   TO PV-DB2-OPERATION   00127800
250775             PERFORM 9800-SQL-ABEND                               00127900
250775     END-EVALUATE.                                                00128000
250775                                                                  00128100
250775***************************************************************** 00128200
250775* NOTE:  THE ORIG-LNE-ITM-SEQ-NBR ON TEPIRT IS ONLY SET WHEN    * 00128300
250775* A GIFT RECEIPT WAS GENERATED WITH THE TRANSACTION.  IF        * 00128400
250775* ORIG-LNE-ITN-SEQ-NBR IS ZERO, GET THE ITEM FROM TEPITM.       * 00128500
250775*                                                               * 00128600
250775***************************************************************** 00128700
250775 7800-GET-RETURN-INFO.                                            00128800
250775                                                                  00128900
250775     IF EPIRT-ORIG-LNE-ITM-NBR > ZERO                             00129000
250775         PERFORM 7820-GET-OPERATING-SHIP-INFO                     00129100
250775         IF PS-NON-RECEIPTED-RETURN                               00129200
250775            PERFORM  7821-GET-OPERATING-SHIP-MISS                 00129300
250775         END-IF                                                   00129400
250775     ELSE                                                         00129500
250775       SET PS-NOT-END-OF-TEPITM-CSR TO TRUE                       00129601
250775       PERFORM 7860-OPEN-TEPITM-CSR                               00129701
BARB         IF SQLCODE = -310                                          00129810
BARB            PERFORM 7820-GET-OPERATING-SHIP-INFO                    00129910
BARB            IF PS-NON-RECEIPTED-RETURN                              00130010
BARB               PERFORM  7821-GET-OPERATING-SHIP-MISS                00130110
BARB            END-IF                                                  00130210
BARB         ELSE                                                       00130310
250775          PERFORM 7871-FETCH-TEPITM-CSR                           00130401
250775          IF PS-NOT-END-OF-TEPITM-CSR                             00130501
250775             MOVE PV-ORIG-ZIP-5-CDE  TO PV-ENCR-ZIP-CODE          00130600
250775             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    00130700
250775                 PERFORM 8400-PROCESS-ZIP-CDE                     00130800
250775                 MOVE PV-ZIP-CODE    TO PV-SAVE-ZIP-5-CDE         00130900
250775                                        TX020-ZIP-CDE             00131000
250775             ELSE                                                 00131100
250775                 MOVE SPACES         TO PV-SAVE-ZIP-5-CDE         00131200
250775             END-IF                                               00131300
250775             MOVE PV-ORIG-GEOG-CDE   TO PV-SAVE-GEOG-CDE          00131400
250775             PERFORM 7870-PROCESS-TEPITM-CSR                      00131500
250775                 UNTIL PS-END-OF-TEPITM-CSR                       00131600
250775          ELSE                                                    00131701
250775           SET PS-NOT-END-OF-TEPITM-MISS-CSR TO TRUE              00131800
250775           PERFORM 7883-OPEN-TEPITM-MISS-CSR                      00131900
250775           PERFORM 7884-FETCH-TEPITM-MISS-CSR                     00132000
250775           IF PS-NOT-END-OF-TEPITM-MISS-CSR                       00132100
250775             MOVE PV-ORIG-ZIP-5-CDE  TO PV-ENCR-ZIP-CODE          00132200
250775             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    00132300
250775                 PERFORM 8400-PROCESS-ZIP-CDE                     00132400
250775                 MOVE PV-ZIP-CODE    TO PV-SAVE-ZIP-5-CDE         00132500
250775                                        TX020-ZIP-CDE             00132600
250775             ELSE                                                 00132700
250775                 MOVE SPACES         TO PV-SAVE-ZIP-5-CDE         00132800
250775             END-IF                                               00132900
250775             MOVE PV-ORIG-GEOG-CDE   TO PV-SAVE-GEOG-CDE          00133000
250775             PERFORM 7885-PROCESS-TEPITM-MISS-CSR                 00133100
250775                 UNTIL PS-END-OF-TEPITM-MISS-CSR                  00133200
250775           ELSE                                                   00133300
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00133400
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00133500
250775           END-IF                                                 00133600
250775            PERFORM 7886-CLOSE-TEPITM-MISS-CSR                    00133700
250775         END-IF                                                   00133800
250775         PERFORM 7880-CLOSE-TEPITM-CSR                            00133900
BARB         END-IF                                                     00134010
250775     END-IF.                                                      00134101
250775*    MOVE PV-ORIG-TRN-DTE  TO PV-ORD-DTE.                         00134201
250775                                                                  00134301
250775***************************************************************   00134401
250775* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   00134501
250775***************************************************************   00134601
250775 7820-GET-OPERATING-SHIP-INFO.                                    00134701
250775                                                                  00134801
250775     MOVE PV-WORK-PARTN-NBR TO PV-ORIG-PARTN-NBR.                 00134901
250775     MOVE PV-WORK-STR-NBR TO PV-RT-ORIG-STR-NBR.                  00135001
250775     MOVE PV-WORK-RGST-ID TO PV-RT-ORIG-RGST-ID.                  00135101
250775     MOVE PV-WORK-TRN-NBR TO PV-RT-ORIG-TRN-NBR.                  00135201
250775     MOVE PV-WORK-STRT-TM TO PV-RT-ORIG-STRT-TM.                  00135301
BARB       MOVE PV-WORK-LNE-ITM-SEQ-NBR TO  PV-RT-ORIG-LNE-ITM-NBR.     00135410
250775     EXEC SQL                                                     00135501
250775       SELECT  B.TX_RT_PCT                                        00135601
250775              ,B.TX_AMT                                           00135701
250775              ,B.SKU_NBR                                          00135801
250775              ,D.ZIP_5_CDE                                        00135901
250775              ,D.TX_GEOG_CDE                                      00136001
250775        INTO  :PV-ORIG-TX-RT-PCT                                  00136101
250775             ,:PV-ORIG-TX-AMT                                     00136201
250775             ,:PV-SKU-C                                           00136301
250775             ,:EPSHP-ZIP-5-CDE                                    00136401
250775             ,:EPSHP-TX-GEOG-CDE                                  00136501
250775        FROM TEPITM  B                                            00136601
250775            ,TEPIPS  C                                            00136701
250775            ,TEPSHP  D                                            00136801
250775        WHERE B.PARTN_NBR        = :PV-ORIG-PARTN-NBR             00136901
250775          AND B.STR_NBR          = :PV-RT-ORIG-STR-NBR            00137001
250775          AND B.RGST_ID          = :PV-RT-ORIG-RGST-ID            00137101
250775          AND B.TRN_NBR          = :PV-RT-ORIG-TRN-NBR            00137201
250775          AND B.STRT_TM          = :PV-RT-ORIG-STRT-TM            00137301
250775          AND B.PARTN_NBR        = C.PARTN_NBR                    00137401
250775          AND B.STR_NBR          = C.STR_NBR                      00137501
250775          AND B.RGST_ID          = C.RGST_ID                      00137601
250775          AND B.TRN_NBR          = C.TRN_NBR                      00137701
250775          AND B.STRT_TM          = C.STRT_TM                      00138000
250775          AND B.SLS_CORR_SEQ_NBR = C.SLS_CORR_SEQ_NBR             00139000
250775          AND B.LNE_ITM_SEQ_NBR  = C.LNE_ITM_SEQ_NBR              00139100
250775          AND C.PARTN_NBR        = D.PARTN_NBR                    00139200
250775          AND C.STR_NBR          = D.STR_NBR                      00139300
250775          AND C.RGST_ID          = D.RGST_ID                      00139400
250775          AND C.TRN_NBR          = D.TRN_NBR                      00139500
250775          AND C.STRT_TM          = D.STRT_TM                      00139600
250775          AND C.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR             00139700
250775          AND C.PLND_SHIPT_NBR   = D.PLND_SHIPT_NBR               00139800
250775          WITH UR                                                 00139900
250775     END-EXEC.                                                    00140000
250775                                                                  00140100
250775     EVALUATE SQLCODE                                             00140200
250775         WHEN ZERO                                                00140300
250775         WHEN -811                                                00140400
250775             SET  PS-RECEIPTED-RETURN   TO TRUE                   00140500
250775             MOVE SPACES             TO PV-SHIP-ST-CODE           00140600
250775             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          00140700
250775                                        PV-SAVE-ZIP-5-CDE         00140800
250775             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    00140900
250775                 PERFORM 8400-PROCESS-ZIP-CDE                     00141000
250775                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          00141100
250775                                        TX020-ZIP-CDE             00141200
250775             ELSE                                                 00141300
250775                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          00141400
250775             END-IF                                               00141500
250775             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          00141600
250775             MOVE PV-SKU-C           TO PV-SKU                    00141700
250775         WHEN +100                                                00141800
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00141900
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00142000
250775         WHEN OTHER                                               00143000
250775             MOVE '7820-GET-OPERATING-SHIP-INFO'                  00143100
250775                                            TO PV-PARAGRAPH-NAME  00143200
250775             MOVE 'ERROR SELECTING FROM TEPSHP'                   00143300
250775                                            TO PV-DB2-OPERATION   00143400
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00143500
250775             PERFORM 9800-SQL-ABEND                               00143600
250775     END-EVALUATE.                                                00143700
250775                                                                  00143800
250775***************************************************************   00143900
250775* GET GEO CODE AND ZIP CODE FROM THE OPERATIONAL SHIP TABLE.  *   00144000
250775***************************************************************   00144100
250775 7821-GET-OPERATING-SHIP-MISS.                                    00144200
250775                                                                  00144300
250775     EXEC SQL                                                     00144400
250775       SELECT  A.TRN_DTE                                          00144500
250775              ,B.TX_RT_PCT                                        00144600
250775              ,B.TX_AMT                                           00144700
250775              ,B.SKU_NBR                                          00144800
250775              ,D.ZIP_5_CDE                                        00144900
250775              ,D.TX_GEOG_CDE                                      00145000
250775        INTO  :PV-ORIG-TRN-DTE                                    00145100
250775             ,:PV-ORIG-TX-RT-PCT                                  00145200
250775             ,:PV-ORIG-TX-AMT                                     00145300
250775             ,:PV-SKU-C                                           00145400
250775             ,:EPSHP-ZIP-5-CDE                                    00145500
250775             ,:EPSHP-TX-GEOG-CDE                                  00145600
250775        FROM TEPTRN  A                                            00145700
250775            ,TEPITM  B                                            00145800
250775            ,TEPSHP  D                                            00145900
250775            ,TEPPART P                                            00146000
250775            ,TEPECX  E                                            00146100
250775        WHERE A.PARTN_NBR        = :PV-ORIG-PARTN-NBR             00146200
250775          AND A.STR_NBR          = :EPIRT-ORIG-STR-NBR            00146300
250775          AND A.RGST_ID          = :EPIRT-ORIG-RGST-ID            00146400
250775          AND A.TRN_NBR          = :EPIRT-ORIG-TRN-NBR            00146500
250775          AND A.STRT_TM          = :EPIRT-ORIG-STRT-TM            00146600
250775          AND B.SKU_NBR          = :PV-SKU-NBR                    00146700
250775          AND A.PARTN_NBR        = B.PARTN_NBR                    00146800
250775          AND A.STR_NBR          = B.STR_NBR                      00146900
250775          AND A.RGST_ID          = B.RGST_ID                      00147000
250775          AND A.TRN_NBR          = B.TRN_NBR                      00147100
250775          AND A.STRT_TM          = B.STRT_TM                      00147200
250775          AND A.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR             00147300
250775          AND A.STR_NBR          = E.STR_NBR                      00147400
250775          AND A.RGST_ID          = E.RGST_ID                      00147500
250775          AND A.TRN_NBR          = E.TRN_NBR                      00147600
250775          AND A.STRT_TM          = E.STRT_TM                      00147700
250775          AND B.PARTN_NBR        = D.PARTN_NBR                    00147800
250775          AND B.STR_NBR          = D.STR_NBR                      00147900
250775          AND B.RGST_ID          = D.RGST_ID                      00148000
250775          AND B.TRN_NBR          = D.TRN_NBR                      00148100
250775          AND B.STRT_TM          = D.STRT_TM                      00148200
250775          AND B.SLS_CORR_SEQ_NBR = D.SLS_CORR_SEQ_NBR             00148300
250775          AND E.ORD_PARTN_NBR    = :PV-ORD-PARTN-NBR              00148400
250775          AND P.SLS_DTE          = E.SLS_DTE                      00148500
250775          WITH UR                                                 00148600
250775     END-EXEC.                                                    00148700
250775                                                                  00148800
250775     EVALUATE SQLCODE                                             00148900
250775         WHEN ZERO                                                00149000
250775         WHEN -811                                                00149100
250775             SET  PS-RECEIPTED-RETURN   TO TRUE                   00149200
250775             MOVE SPACES             TO PV-SHIP-ST-CODE           00149300
250775             MOVE EPSHP-ZIP-5-CDE    TO PV-ENCR-ZIP-CODE          00149400
250775             IF  PV-ENCR-ZIP-CODE NOT = SPACES                    00149500
250775                 PERFORM 8400-PROCESS-ZIP-CDE                     00149600
250775                 MOVE PV-ZIP-CODE    TO PV-SHIP-ZIP-CODE          00149700
250775                                        TX020-ZIP-CDE             00149800
250775             ELSE                                                 00149900
250775                 MOVE SPACES         TO PV-SHIP-ZIP-CODE          00150000
250775             END-IF                                               00150100
250775             MOVE EPSHP-TX-GEOG-CDE  TO PV-SHIP-GEO-CODE          00150200
250775             MOVE PV-SKU-C           TO PV-SKU                    00150300
250775         WHEN +100                                                00150400
250775             SET PS-NON-RECEIPTED-RETURN TO TRUE                  00150500
250775             MOVE EPTRN-STR-NBR          TO PV-WORK-STR-NBR       00150600
250775         WHEN OTHER                                               00150700
250775             MOVE '7821-GET-OPERATING-SHIP-INFO-MISS'             00150800
250775                                            TO PV-PARAGRAPH-NAME  00150900
250775             MOVE 'ERROR SELECTING FROM TEPSHP'                   00151000
250775                                            TO PV-DB2-OPERATION   00151100
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00151200
250775             PERFORM 9800-SQL-ABEND                               00151300
250775     END-EVALUATE.                                                00151400
250775                                                                  00151500
250775***************************************************************   00151600
250775*  OPEN TEPITM CURSOR.                                        *   00151700
250775***************************************************************   00151800
250775 7860-OPEN-TEPITM-CSR.                                            00151900
250775                                                                  00152000
250775     EXEC SQL                                                     00152100
250775         OPEN TEPITM-CSR                                          00152200
250775     END-EXEC.                                                    00152300
250775                                                                  00152400
250775     EVALUATE SQLCODE                                             00152500
250775         WHEN ZERO                                                00152600
250775             CONTINUE                                             00152700
BARB           WHEN -310                                                00152810
BARB               MOVE PV-ORIG-PARTN-NBR TO PV-WORK-PARTN-NBR          00153210
BARB               MOVE EPIRT-ORIG-STR-NBR   TO PV-WORK-STR-NBR         00154610
BARB                                       PV-WORK-STR-NBR-D            00154710
BARB               MOVE EPIRT-ORIG-RGST-ID   TO PV-WORK-RGST-ID         00154810
BARB               MOVE EPIRT-ORIG-TRN-NBR   TO PV-WORK-TRN-NBR         00154910
BARB               MOVE EPIRT-ORIG-STRT-TM   TO PV-WORK-STRT-TM         00155010
BARB               MOVE EPIRT-SLS-CORR-SEQ-NBR TO                       00155110
BARB                                          PV-WORK-SLS-CORR-SEQ-NBR  00155210
BARB               MOVE EPIRT-ORIG-SLS-DTE   TO PV-WORK-SLS-DTE         00155410
BARB               MOVE EPIRT-SLS-CORR-SEQ-NBR TO                       00155510
BARB                                          PV-WORK-SLS-CORR-SEQ-NBR  00155610
BARB               MOVE EPITM-LNE-ITM-SEQ-NBR TO PV-WORK-LNE-ITM-SEQ-NBR00155710
BARB  *            DISPLAY '-310  '                                     00155810
BARB  *            DISPLAY 'PV-ORIG-PARTN-NBR ' PV-WORK-PARTN-NBR       00155910
BARB  *            DISPLAY 'EPIRT-ORIG-STR-NBR ' PV-WORK-STR-NBR        00156010
BARB  *            DISPLAY 'EPIRT-ORIG-RGST-ID ' PV-WORK-RGST-ID        00156110
BARB  *            DISPLAY 'EPIRT-ORIG-TRN-NBR ' PV-WORK-TRN-NBR        00156210
BARB  *            DISPLAY 'EPIRT-ORIG-STRT-TM ' PV-WORK-STRT-TM        00156310
BARB  *            DISPLAY 'EPIRT-ORIG-SLS-DTE ' PV-WORK-SLS-DTE        00156410
BARB  *            DISPLAY 'EPITM-LNE-ITM-SEQ-NBR '                     00156510
BARB  *                      PV-WORK-LNE-ITM-SEQ-NBR                    00156610
250775         WHEN OTHER                                               00156900
BARB               MOVE '7860-OPEN-TEPITM-CSR'    TO PV-PARAGRAPH-NAME  00157010
250775             MOVE 'ERROR OPENING TEPITM CURSOR '                  00157100
250775                                            TO PV-DB2-OPERATION   00157200
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00157300
250775             PERFORM 9800-SQL-ABEND                               00157400
250775     END-EVALUATE.                                                00157500
250775                                                                  00157600
250775***************************************************************   00157700
250775*  THE TEPITM CURSOR FETCHES ALL LINE ITEMS ON THE ORIGINAL   *   00157800
250775*  TRANSACTION THAT ARE THE SAME ITEM THAT WAS RETURNED.      *   00157900
250775*  USE THE ZIP CODE AND GEO CODE ON THE FIRST ITEM FOUND THAT *   00158000
250775*  HAS THE SAME TAX RATE.  IF THERE IS NO MATCHING TAX RATE   *   00158100
250775*  USE ZIP CODE AND GEO CODE ON THE FIRST LINE ITEM.          *   00158200
250775***************************************************************   00158300
250775 7870-PROCESS-TEPITM-CSR.                                         00158400
250775                                                                  00158500
250775     IF PV-ORIG-TX-RT-PCT = PV-TAX-RATE-PCT                       00158600
250775         MOVE SPACES            TO PV-SHIP-ST-CODE                00158700
250775         MOVE PV-ORIG-ZIP-5-CDE TO PV-ENCR-ZIP-CODE               00158800
250775         IF  PV-ENCR-ZIP-CODE NOT = SPACES                        00158900
250775             PERFORM 8400-PROCESS-ZIP-CDE                         00159000
250775             MOVE PV-ZIP-CODE   TO PV-SHIP-ZIP-CODE               00159100
250775                                   TX020-ZIP-CDE                  00159200
250775         ELSE                                                     00159300
250775             MOVE SPACES        TO PV-SHIP-ZIP-CODE               00159400
250775         END-IF                                                   00159500
250775         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               00159600
250775         SET PS-END-OF-TEPITM-CSR TO TRUE                         00159700
250775     ELSE                                                         00159800
250775         PERFORM 7871-FETCH-TEPITM-CSR                            00159900
250775     END-IF.                                                      00160000
250775                                                                  00160100
250775***************************************************************   00160200
250775*  FETCH TEPITM CURSOR.                                       *   00160300
250775***************************************************************   00160400
250775 7871-FETCH-TEPITM-CSR.                                           00160500
250775                                                                  00160600
250775     EXEC SQL                                                     00160700
250775         FETCH TEPITM-CSR                                         00160800
250775          INTO :PV-ORIG-TRN-DTE                                   00160900
250775              ,:PV-ORIG-TX-RT-PCT                                 00161000
250775              ,:PV-ORIG-TX-AMT                                    00161100
250775              ,:PV-SKU-C                                          00161200
250775              ,:PV-ORIG-ZIP-5-CDE                                 00161300
250775              ,:PV-ORIG-GEOG-CDE                                  00161400
250775     END-EXEC.                                                    00161500
250775                                                                  00161600
250775     EVALUATE SQLCODE                                             00161700
250775         WHEN ZERO                                                00161800
250775             CONTINUE                                             00161900
250775         WHEN +100                                                00162000
250775             SET PS-END-OF-TEPITM-CSR TO TRUE                     00162100
250775             MOVE SPACES            TO  PV-SHIP-ST-CODE           00162200
250775             MOVE PV-SAVE-ZIP-5-CDE TO  PV-SHIP-ZIP-CODE          00162300
250775             MOVE PV-SAVE-GEOG-CDE  TO  PV-SHIP-GEO-CODE          00162400
250775             MOVE PV-SKU-C          TO  PV-SKU                    00162500
250775         WHEN OTHER                                               00162600
250775             MOVE '7861-FETCH-TEPITM-CSR'   TO PV-PARAGRAPH-NAME  00162700
250775             MOVE 'ERROR FETCHING TEPITM CURSOR '                 00162800
250775                                            TO PV-DB2-OPERATION   00162900
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00163000
250775             PERFORM 9800-SQL-ABEND                               00163100
250775     END-EVALUATE.                                                00163200
250775                                                                  00163300
250775***************************************************************   00163400
250775*  CLOSE TEPITM CURSOR.                                       *   00163500
250775***************************************************************   00163600
250775 7880-CLOSE-TEPITM-CSR.                                           00163700
250775                                                                  00163800
250775     EXEC SQL                                                     00163900
250775         CLOSE TEPITM-CSR                                         00164000
250775     END-EXEC.                                                    00164100
250775                                                                  00164200
250775     EVALUATE SQLCODE                                             00164300
250775         WHEN ZERO                                                00164400
250775             CONTINUE                                             00164500
250775         WHEN OTHER                                               00164600
250775             MOVE '7870-CLOSE-TEPITM-CSR'   TO PV-PARAGRAPH-NAME  00164700
250775             MOVE 'ERROR CLOSING TEPITM CURSOR '                  00164800
250775                                            TO PV-DB2-OPERATION   00164900
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00165000
250775             PERFORM 9800-SQL-ABEND                               00165100
250775     END-EVALUATE.                                                00165200
250775                                                                  00165300
250775***************************************************************   00165400
250775*  OPEN TEPITM CURSOR.                                        *   00165500
250775***************************************************************   00165600
250775 7883-OPEN-TEPITM-MISS-CSR.                                       00165700
250775                                                                  00165800
250775     EXEC SQL                                                     00165900
250775         OPEN TEPITM-MISS-CSR                                     00166000
250775     END-EXEC.                                                    00166100
250775                                                                  00166200
250775     EVALUATE SQLCODE                                             00166300
250775         WHEN ZERO                                                00166400
250775             CONTINUE                                             00166500
250775         WHEN OTHER                                               00166600
250775             MOVE '7883-OPEN-TEPITM-MISS-CSR'                     00166700
250775                                            TO PV-PARAGRAPH-NAME  00166800
250775             MOVE 'ERROR OPENING TEPITM MISS CURSOR '             00166900
250775                                            TO PV-DB2-OPERATION   00167000
250775             MOVE SQLCODE                   TO PV-DB2-OPERATION   00167100
250775             PERFORM 9800-SQL-ABEND                               00167200
250775     END-EVALUATE.                                                00167300
250775                                                                  00167400
250775***************************************************************   00167500
250775*  FETCH TEPITM MISS CURSOR                                       00167600
250775***************************************************************   00167700
250775 7884-FETCH-TEPITM-MISS-CSR.                                      00167800
250775                                                                  00167900
250775     EXEC SQL                                                     00168000
250775         FETCH TEPITM-MISS-CSR                                    00168100
250775          INTO :PV-ORIG-TRN-DTE                                   00168200
250775              ,:PV-ORIG-TX-RT-PCT                                 00168300
250775              ,:PV-ORIG-TX-AMT                                    00168400
250775              ,:PV-SKU-C                                          00168500
250775              ,:PV-ORIG-ZIP-5-CDE                                 00168600
250775              ,:PV-ORIG-GEOG-CDE                                  00168700
250775     END-EXEC.                                                    00168800
250775                                                                  00168900
250775     EVALUATE SQLCODE                                             00169000
250775         WHEN ZERO                                                00169100
250775             CONTINUE                                             00169200
250775         WHEN +100                                                00169300
250775             SET PS-END-OF-TEPITM-MISS-CSR TO TRUE                00169400
250775             MOVE SPACES            TO  PV-SHIP-ST-CODE           00169500
250775             MOVE PV-SAVE-ZIP-5-CDE TO  PV-SHIP-ZIP-CODE          00169600
250775             MOVE PV-SAVE-GEOG-CDE  TO  PV-SHIP-GEO-CODE          00169700
250775             MOVE PV-SKU-C          TO  PV-SKU                    00169800
250775         WHEN OTHER                                               00169900
250775             MOVE '7884-FETCH-TEPITM-MISS-CSR'                    00170000
250775                                            TO PV-PARAGRAPH-NAME  00170100
250775             MOVE 'ERROR FETCHING TEPITM CURSOR '                 00170200
250775                                            TO PV-DB2-OPERATION   00170300
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00170400
250775             PERFORM 9800-SQL-ABEND                               00170500
250775     END-EVALUATE.                                                00170600
250775                                                                  00170700
250775***************************************************************   00170800
250775*  THE TEPITM CURSOR FETCHES ALL LINE ITEMS ON THE ORIGINAL   *   00170900
250775*  TRANSACTION THAT ARE THE SAME ITEM THAT WAS RETURNED.      *   00171000
250775*  USE THE ZIP CODE AND GEO CODE ON THE FIRST ITEM FOUND THAT *   00171100
250775*  HAS THE SAME TAX RATE.  IF THERE IS NO MATCHING TAX RATE   *   00171200
250775*  USE ZIP CODE AND GEO CODE ON THE FIRST LINE ITEM.          *   00171300
250775***************************************************************   00171400
250775 7885-PROCESS-TEPITM-MISS-CSR.                                    00171500
250775                                                                  00171600
250775     IF PV-ORIG-TX-RT-PCT = PV-TAX-RATE-PCT                       00171700
250775         MOVE SPACES            TO PV-SHIP-ST-CODE                00171800
250775         MOVE PV-ORIG-ZIP-5-CDE TO PV-ENCR-ZIP-CODE               00171900
250775         IF  PV-ENCR-ZIP-CODE NOT = SPACES                        00172000
250775             PERFORM 8400-PROCESS-ZIP-CDE                         00172100
250775             MOVE PV-ZIP-CODE   TO PV-SHIP-ZIP-CODE               00172200
250775                                   TX020-ZIP-CDE                  00172300
250775         ELSE                                                     00172400
250775             MOVE SPACES        TO PV-SHIP-ZIP-CODE               00172500
250775         END-IF                                                   00172600
250775         MOVE PV-ORIG-GEOG-CDE  TO PV-SHIP-GEO-CODE               00172700
250775         SET PS-END-OF-TEPITM-MISS-CSR TO TRUE                    00172800
250775     ELSE                                                         00172900
250775         PERFORM 7884-FETCH-TEPITM-MISS-CSR                       00173000
250775     END-IF.                                                      00173100
250775                                                                  00173200
250775***************************************************************   00173300
250775*  CLOSE TEPITM MISS CURSOR.                                  *   00173400
250775***************************************************************   00173500
250775 7886-CLOSE-TEPITM-MISS-CSR.                                      00173600
250775                                                                  00173700
250775     EXEC SQL                                                     00173800
250775         CLOSE TEPITM-MISS-CSR                                    00173900
250775     END-EXEC.                                                    00174000
250775                                                                  00174100
250775     EVALUATE SQLCODE                                             00174200
250775         WHEN ZERO                                                00174300
250775             CONTINUE                                             00174400
250775         WHEN OTHER                                               00174500
250775             MOVE '7886-CLOSE-TEPITM-MISS-CSR'                    00174600
250775                                            TO PV-PARAGRAPH-NAME  00174700
250775             MOVE 'ERROR CLOSING TEPITM MISS CURSOR '             00174800
250775                                            TO PV-DB2-OPERATION   00174900
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00175000
250775             PERFORM 9800-SQL-ABEND                               00175100
250775     END-EVALUATE.                                                00175200
250775                                                                  00175300
067900***************************************************************** 00175400
068000*  GET THE ECOMMERCE ORDER NUMBER                               * 00175500
068100***************************************************************** 00175600
068200 7900-GET-ECOMMERCE-ORDER-NBR.                                    00175700
068300                                                                  00175800
068400     MOVE SPACES TO EPORD-ORD-NBR-TEXT.                           00175900
068500                                                                  00176000
068600     EXEC SQL                                                     00176100
068700           SELECT ORD_NBR                                         00176200
068800           INTO :EPORD-ORD-NBR                                    00176300
068900           FROM TEPORD                                            00176400
069000           WHERE PARTN_NBR        = :EPITM-PARTN-NBR              00176500
069100             AND STR_NBR          = :EPITM-STR-NBR                00176600
069200             AND RGST_ID          = :EPITM-RGST-ID                00176700
069300             AND TRN_NBR          = :EPITM-TRN-NBR                00176800
069400             AND STRT_TM          = :EPITM-STRT-TM                00176900
069500             AND SLS_CORR_SEQ_NBR = :EPTRN-SLS-CORR-SEQ-NBR       00177000
069600           WITH UR                                                00177100
069700     END-EXEC.                                                    00177200
069800                                                                  00177300
069900     EVALUATE TRUE                                                00177400
070000        WHEN SQLCODE = ZERO                                       00177500
070100             CONTINUE                                             00177600
070200        WHEN SQLCODE = +100                                       00177700
070300             CONTINUE                                             00177800
070400        WHEN OTHER                                                00177900
070500             MOVE '7900-GET-ECOMMERCE-ORDER-NBR'                  00178000
070600                                             TO PV-PARAGRAPH-NAME 00178100
070700             MOVE SQLCODE                    TO PV-DB2-OPERATION  00178200
070800             PERFORM 9800-SQL-ABEND                               00178300
070900     END-EVALUATE.                                                00178400
071000                                                                  00178500
250775******************************************************************00178600
250775*  CHECK TABLE WHEN CHANGE IN STORE NUMBER TO SEE IF ECOMMERCE    00178700
250775*  STORE BEFORE GETTING INFORMATION FROM XST_LOC.                 00178800
250775******************************************************************00178900
250775 8100-SEARCH-FOR-STORE-INFO.                                      00179000
250775                                                                  00179100
250775     SET EC-IDX                    TO 1.                          00179200
250775     SET PS-NOT-END-OF-ECOM-TABLE  TO TRUE.                       00179300
250775     SEARCH EC-ECOM-STORE-TABLE-ENTRIES VARYING EC-IDX            00179400
250775         AT END                                                   00179500
250775             SET PS-END-OF-ECOM-TABLE      TO TRUE                00179600
250775         WHEN PV-WORK-STR-NBR = EC-STR-NBR (EC-IDX)               00179700
250775             MOVE  PV-WORK-STR-NBR TO PV-WORK-STR-NBR-D           00179800
250775             MOVE EC-BUS-LOC-IND  (EC-IDX) TO PV-BUS-LOC-IND      00179900
250775             MOVE EC-ST-CDE       (EC-IDX) TO PV-SHIP-ST-CODE     00180000
250775                                              PV-SAVE-ST-CODE     00180100
250775             MOVE EC-ZIP-CODE     (EC-IDX) TO PV-SHIP-ZIP-CODE    00180200
250775                                              PV-SAVE-ZIP-CDE     00180300
BARB  *            DISPLAY 'PV-SAVE-ZIP-CDE ' PV-SAVE-ZIP-CDE           00180410
250775             MOVE EC-GEO-CODE     (EC-IDX) TO PV-SHIP-GEO-CODE    00180500
250775             MOVE EC-ROUND-IND    (EC-IDX) TO PV-ROUND-IND        00180600
250775     END-SEARCH.                                                  00180700
250775                                                                  00180800
250775****************************************************************  00180900
250775*  OPEN THE ECOMMERCE INDICATOR CURSOR                            00181000
250775****************************************************************  00181100
250775 8200-GET-STORE-INFO.                                             00181200
250775                                                                  00181300
250775                                                                  00181400
250775     EXEC SQL                                                     00181500
250775       SELECT A.ZIP_10_CDE                                        00181600
250775             ,A.ST_CDE                                            00181700
250775             ,A.E_BUS_IND                                         00181800
250775             ,B.ST_TX_RND_MTHD_CDE                                00181900
250775             ,COALESCE(C.GEO_CDE, '00')                           00182000
250775             ,COALESCE(C.TX_ALT_ZIP_10_CDE, :PC-SPACES)           00182100
250775        INTO :XST00001-ZIP-10-CDE                                 00182200
250775            ,:XST00001-ST-CDE                                     00182300
250775            ,:XST00001-E-BUS-IND                                  00182400
250775            ,:TSTATE-ST-TX-RND-MTHD-CDE                           00182500
250775            ,:XST00025-GEO-CDE                                    00182600
250775            ,:XST00025-TX-ALT-ZIP-10-CDE                          00182700
250775       FROM XST_LOC A                                             00182800
250775          , TSTATE  B                                             00182900
250775          , XST_LOC_ATTR C                                        00183000
250775       WHERE A.ST_CDE  =   B.STATE_CODE                           00183100
250775         AND A.LOC_NBR =   C.LOC_NBR                              00183200
250775         AND A.LOC_NBR =  :PV-WORK-STR-NBR                        00183300
250775       WITH UR                                                    00183400
250775     END-EXEC.                                                    00183500
250775                                                                  00183600
250775     EVALUATE SQLCODE                                             00183700
250775         WHEN ZERO                                                00183800
250775             MOVE PV-WORK-STR-NBR  TO EC-STR-NBR (EC-IDX2)        00183900
250775             MOVE XST00001-ZIP-10-CDE (1:5)                       00184000
250775                                   TO EC-ZIP-CODE (EC-IDX2)       00184100
250775                                      PV-SHIP-ZIP-CODE            00184200
250775                                      PV-SAVE-ZIP-CDE             00184300
250775             MOVE XST00001-ST-CDE  TO EC-ST-CDE (EC-IDX2)         00184400
250775                                      PV-SHIP-ST-CODE             00184500
250775                                      PV-SAVE-ST-CODE             00184600
250775             MOVE XST00001-E-BUS-IND                              00184700
250775                                   TO EC-BUS-LOC-IND (EC-IDX2)    00184800
250775                                      PV-BUS-LOC-IND              00184900
250775             MOVE TSTATE-ST-TX-RND-MTHD-CDE                       00185000
250775                                   TO EC-ROUND-IND   (EC-IDX2)    00185100
250775                                      PV-ROUND-IND                00185200
250775             IF XST00025-GEO-CDE = SPACES                         00185300
250775                MOVE 'N'         TO EC-GEO-FOUND-IND (EC-IDX2)    00185400
250775                MOVE '00'        TO EC-GEO-CODE (EC-IDX2)         00185500
250775                                    PV-SHIP-GEO-CODE              00185600
250775             ELSE                                                 00185700
250775                MOVE XST00025-GEO-CDE TO EC-GEO-CODE (EC-IDX2)    00185800
250775                                         PV-SHIP-GEO-CODE         00185900
250775                                         PV-SAVE-GEOG-CDE         00186000
250775             END-IF                                               00186100
250775                                                                  00186200
250775             IF XST00025-TX-ALT-ZIP-10-CDE = SPACES               00186300
250775               CONTINUE                                           00186400
250775             ELSE                                                 00186500
250775               IF XST00025-TX-ALT-ZIP-10-CDE (1:5) NUMERIC        00186600
250775                 MOVE XST00025-TX-ALT-ZIP-10-CDE                  00186700
250775                                   TO EC-ZIP-CODE (EC-IDX2)       00186800
250775                                      PV-SHIP-ZIP-CODE            00186900
250775               END-IF                                             00187000
250775             END-IF                                               00187100
250775                                                                  00187200
250775             MOVE 'Y'            TO EC-GEO-FOUND-IND (EC-IDX2)    00187300
250775             SET EC-IDX2 UP BY 1                                  00187400
250775         WHEN OTHER                                               00187500
250775             MOVE '8200-GET-STORE-INFO'     TO PV-PARAGRAPH-NAME  00187600
250775             MOVE 'ERROR ON GETTING STORE INFO FROM XST_LOC'      00187700
250775                                            TO PV-DB2-OPERATION   00187800
250775             DISPLAY 'STORE NUMBER IS ' PV-WORK-STR-NBR           00187904
250775             MOVE SQLCODE                 TO PV-DB2-OPERATION     00188000
250775             PERFORM 9800-SQL-ABEND                               00188100
250775     END-EVALUATE.                                                00188200
071000                                                                  00188300
071100******************************************************************00188400
071200* SEARCH THE ZIP CODE                                            *00188500
071300******************************************************************00188600
071400 8400-PROCESS-ZIP-CDE.                                            00188700
071500                                                                  00188804
071600     SET ZP-IDX                      TO 1.                        00188900
071700     SET PS-NOT-END-OF-ZIP-TABLE     TO TRUE.                     00189000
071800                                                                  00189100
071900     SEARCH PV-ZIP-CODE-TABLE-ENTRIES VARYING ZP-IDX              00189200
072000         AT END                                                   00189300
072100             SET PS-END-OF-ZIP-TABLE TO TRUE                      00189400
072200             PERFORM 8500-UNPROTECT-ZIP                           00189500
072300         WHEN PV-ENCR-ZIP-CODE = ENCRYPT-ZIP (ZP-IDX)             00189600
072400             MOVE DECRYPT-ZIP (ZP-IDX) TO PV-ZIP-CODE             00189700
072500     END-SEARCH.                                                  00189800
072600                                                                  00189900
072700******************************************************************00190000
072800*     DECRYPT THE ZIP CODE                                       *00190100
072900******************************************************************00190200
073000 8500-UNPROTECT-ZIP.                                              00190300
073100                                                                  00190400
073200     PERFORM 8600-BASE64-BINARY.                                  00190500
073300     PERFORM 8700-DECYRPT-ZIP.                                    00190600
073400     PERFORM 8800-ASCII-EBCDIC.                                   00190700
073500     MOVE PV-ENCR-ZIP-CODE     TO ENCRYPT-ZIP (ZP-IDX2).          00190800
073600     MOVE PV-ZIP-CODE          TO DECRYPT-ZIP (ZP-IDX2).          00190900
073700     SET ZP-IDX2 UP BY 1.                                         00191000
073800                                                                  00191100
073900     IF ZP-IDX2 > PC-ZIP-MAX                                      00191200
074000         DISPLAY '** ABEND ** ' PC-CURRENT-PROGRAM-NAME           00191300
074100         DISPLAY 'INTERNAL ZIP TABLE OVERFLOW'                    00191400
074200         DISPLAY 'INCREASE THE ZIP TABLE SIZE MORE THAN 99999'    00191500
074300         SET AC-TABLE-OVERFLOW TO TRUE                            00191600
074400         CALL 'ILBOABN0' USING AC-ABEND-CODE                      00191700
074500     END-IF.                                                      00191800
074600                                                                  00191900
074700******************************************************************00192000
074800*     8600-BASE64-BINARY                                         *00192100
074900*  ==> PROCESSES:                                                *00192200
075000*     - CONVERTS THE DATA FROM BASE64 TO BINARY FORMAT           *00192300
075100******************************************************************00192400
075200 8600-BASE64-BINARY.                                              00192500
075300                                                                  00192600
075400     INITIALIZE PV-INPUT-TEXT                                     00192700
075500                PV-OUTPUT-TEXT                                    00192800
075600                PV-ZIP-LENGTH.                                    00192900
075700                                                                  00193000
075900     MOVE PV-ENCR-ZIP-CODE           TO PV-INPUT-TEXT.            00193100
076100     INSPECT PV-ENCR-ZIP-CODE TALLYING PV-ZIP-LENGTH              00193200
076200             FOR CHARACTERS BEFORE INITIAL SPACE.                 00193300
076300                                                                  00193400
076500     MOVE PV-ZIP-LENGTH              TO DP022-INLEN.              00193500
076600     MOVE 18                         TO DP022-OUTLEN-IN.          00193600
076700                                                                  00193700
076800     CALL  DP022-MGCXR2B   USING DP022-PARMS,                     00193800
076900                                 PV-INPUT-TEXT,                   00193900
077000                                 PV-OUTPUT-TEXT.                  00194000
077001                                                                  00194100
077002     IF RETURN-CODE NOT EQUAL 0                                   00194200
077003        DISPLAY 'ERROR WHILE CONVERTING BASE64 TO BINARY'         00194300
077004        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  00194400
077005        DISPLAY 'ENCRYPTED ZIP   - ' PV-ENCR-ZIP-CODE             00194500
077006        SET AC-CONVERSION-ERROR      TO TRUE                      00194600
077007        CALL 'ILBOABN0' USING AC-ABEND-CODE                       00194700
077008     END-IF.                                                      00194800
077009                                                                  00194900
078900                                                                  00195000
079000******************************************************************00195100
079100*     8700-DECYRPT-ZIP                                           *00195200
079200*  ==> PROCESSES:                                                *00195300
079300*     - CALLS THE PROTEGRITY MODULE TO DECRYPT THE ZIP CODE      *00195400
079400*       RETURNED ZIP CODE VALUE WILL BE IN ASCII FORMAT          *00195500
079500******************************************************************00195600
079600 8700-DECYRPT-ZIP.                                                00195700
079700                                                                  00195800
079800     INITIALIZE CSI-PARAMETERS                                    00195900
079900                DP031-PROTEG-PGM-PARAMETERS.                      00196000
080000                                                                  00196100
080100     MOVE 'ZIP-CODE'                 TO DP031-FIELD.              00196200
080200     SET CSI-DECRYPT-FUNCTION        TO TRUE.                     00196300
080300     SET DP031-CUST-INFO             TO TRUE.                     00196400
080400     MOVE DP022-OUTLEN-OUT           TO CSI-CIPHER-TEXT-LENGTH.   00196500
080500     MOVE 5                          TO CSI-CLEAR-TEXT-LENGTH.    00196600
080600     MOVE PV-OUTPUT-TEXT             TO DP031-CIPHER-TEXT.        00196700
080700                                                                  00196800
080800     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      00196900
080900                                                                  00197000
081000     IF CSI-RETURN-CODE NOT = ZERO                                00197100
081100        DISPLAY 'ENCRYPTED ZIP      - ' PV-ENCR-ZIP-CODE          00197200
081200        DISPLAY 'INPUT ZIP LENGTH   - ' PV-ZIP-LENGTH             00197300
081300        PERFORM DP031-9999-ABEND                                  00197400
081400     END-IF.                                                      00197500
081500                                                                  00197600
081600******************************************************************00197700
081700*     8800-ASCII-EBCDIC                                          *00197800
081800*  ==> PROCESSES:                                                *00197900
081900*     - CONVERTS THE DATA FROM ASCII TO EBCDIC FORMAT            *00198000
082000******************************************************************00198100
082100 8800-ASCII-EBCDIC.                                               00198200
082200                                                                  00198300
082300     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA.                   00198400
082400                                                                  00198500
082500     SET  ASCII-TO-EBCDIC       TO TRUE.                          00198600
082600     MOVE DP031-CLEAR-TEXT      TO LK52-FROM-AREA.                00198700
082700     MOVE CSI-CLEAR-TEXT-LENGTH TO LK52-LENGTH.                   00198800
082800                                                                  00198900
082900     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            00199000
083000                                  LK52-LENGTH                     00199100
083100                                  LK52-FROM-AREA                  00199200
083200                                  LK52-TO-AREA                    00199300
083300                                  LK52-RETURN-CODE.               00199400
083400     IF GOOD-LK52-RET-CODE                                        00199500
083500        MOVE LK52-TO-AREA            TO PV-ZIP-CODE               00199600
083600     ELSE                                                         00199700
083700        DISPLAY 'ERROR WHILE CONVERTING ASCII TO EBCDIC'          00199800
083800        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             00199900
083900        DISPLAY 'ENCRYPTED ZIP   - ' PV-ENCR-ZIP-CODE             00200000
084000        SET AC-CONVERSION-ERROR      TO TRUE                      00200100
084100        CALL 'ILBOABN0' USING AC-ABEND-CODE                       00200200
084200     END-IF.                                                      00200300
084300                                                                  00200400
084400******************************************************************00200500
084500 9800-SQL-ABEND.                                                  00200600
084600*     ABEND PROGRAM WHEN AN SQL ERROR CODE OR WARNING CODE OCCURS.00200700
084700******************************************************************00200800
084800     DISPLAY '** ABEND     **'.                                   00200900
084900     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        00201000
085000     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              00201100
085100     DISPLAY '** SQLCODE   ** = ' PV-DB2-OPERATION.               00201200
085200     DISPLAY '** PARTITION ** = ' EPTRN-PARTN-NBR                 00201300
085300     DISPLAY '** STORE     ** = ' EPTRN-STR-NBR                   00201400
085400     DISPLAY '** REGISTER  ** = ' EPTRN-RGST-ID                   00201500
085500     DISPLAY '** TRANSACT  ** = ' EPTRN-TRN-NBR                   00201600
085600                                                                  00201700
085700******************************************************************00201800
085800* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     00201900
085900* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      00202000
086000******************************************************************00202100
086100     COPY DPPD004.                                                00202200
086200                                                                  00202300
086300     SET AC-DB2-ERROR TO TRUE.                                    00202400
086400     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         00202500
086500                                                                  00202600
086600******************************************************************00202700
086700*9999-ABEND.                                                      00202800
086800*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  00202900
086900******************************************************************00203000
087000 9999-ABEND.                                                      00203100
087100     DISPLAY '** ABEND           **'.                             00203200
087200     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  00203300
087300     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        00203400
087400     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       00203500
087500     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       00203600
087600     DISPLAY '** PARTITION       ** = ' EPITM-PARTN-NBR           00203700
087700     DISPLAY '** STORE           ** = ' EPITM-STR-NBR             00203800
087800     DISPLAY '** REGISTER        ** = ' EPITM-RGST-ID             00203900
087900     DISPLAY '** TRANSACTION     ** = ' EPITM-TRN-NBR             00204000
088000     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         00204100
088100                                                                  00204200
088200***************************************************************** 00204300
088300*  COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE     * 00204400
088400*  PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION              * 00204500
088500***************************************************************** 00204600
088600     COPY DPPD031.                                                00204700
089100                                                                  00205000
