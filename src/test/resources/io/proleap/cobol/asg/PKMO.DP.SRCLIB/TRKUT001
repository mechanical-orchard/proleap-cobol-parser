000100 IDENTIFICATION DIVISION.                                         00010004
000200 PROGRAM-ID.    TRKUT001.                                         00020004
000300 AUTHOR.        THOMAS J. RUSKA. G&R.                             00030004
000400 INSTALLATION.  KOHLS.                                            00040004
000500 DATE-WRITTEN.  10/19/93.                                         00050004
000600 DATE-COMPILED.                                                   00060004
000700******************************************************************00070004
000800* THIS PROGRAM WILL EXTRACT PURCHASE ORDER INFORMATION FOR        00080004
000900* EDI TRANSMISSION.                                               00090004
001000******************************************************************00100004
001300* CHANGE HISTORY                                                 *00102018
001300*     MADE BY: PRITHIVIRAJ SUBRAMANIAN (COGNIZANT)               *00103018
001300*     DATE:    11/21/2014                                        *00104023
001300*                                                                *00105018
001300*      CHANGES THRU OUT THE PROGRAM TO INCREASE THE SIZE OF PO#  *00106018
001300*      FROM 7 DIGITS TO 8 DIGITS. TAGGED WITH *PS 11/21/2014     *00107020
001000******************************************************************00107118
001100 ENVIRONMENT DIVISION.                                            00110004
001200 CONFIGURATION SECTION.                                           00120004
001300 SOURCE-COMPUTER. IBM-3090.                                       00130004
001400 OBJECT-COMPUTER. IBM-3090.                                       00140004
001500 INPUT-OUTPUT SECTION.                                            00150004
001600 FILE-CONTROL.                                                    00160004
001700                                                                  00170004
001800     SELECT EXTRACT-FILE                                          00180004
001900         ASSIGN TO OUT01.                                         00190004
002000                                                                  00200004
002100/                                                                 00210004
002200******************************************************************00220004
002300 DATA DIVISION.                                                   00230004
002400******************************************************************00240004
002500 FILE SECTION.                                                    00250004
002600                                                                  00260004
002700 FD  EXTRACT-FILE                                                 00270004
002800     RECORDING MODE IS F                                          00280004
002900     LABEL RECORDS ARE STANDARD                                   00290004
003000* PS 11/21/2014 CHANGE STARTS                                     00300020
003000     RECORD CONTAINS 50 CHARACTERS                                00301020
003100     BLOCK CONTAINS 0 RECORDS.                                    00310004
003200 01  EXTRACT-RECORD                   PIC X(50).                  00320020
003000* PS 11/21/2014 CHANGE STARTS                                     00321020
003300                                                                  00330004
003400/                                                                 00340004
003500 WORKING-STORAGE SECTION.                                         00350004
003600                                                                  00360004
003700 01  SD-SYSTEM-DATE.                                              00370004
003800     05  SD-SYSTEM-YY                 PIC 9(02)  VALUE ZEROES.    00380004
003900     05  SD-SYSTEM-MM                 PIC 9(02)  VALUE ZEROES.    00390004
004000     05  SD-SYSTEM-DD                 PIC 9(02)  VALUE ZEROES.    00400004
004100                                                                  00410004
004200 01  ST-SYSTEM-TIME.                                              00420004
004300     05  ST-SYSTEM-HH                 PIC 9(02)  VALUE ZEROES.    00430004
004400     05  ST-SYSTEM-MM                 PIC 9(02)  VALUE ZEROES.    00440004
004500     05  FILLER                       PIC 9(04)  VALUE ZEROES.    00450004
004600                                                                  00460004
004700 01  PA-PROGRAM-ACCUMULATORS.                                     00470004
004800     05  PA-PO-EXTRACT-CNT            PIC S9(07) VALUE +0         00480004
004900                                                 COMP-3.          00490004
005000                                                                  00500004
005100 01  PC-PROGRAM-CONTROLS.                                         00510004
005200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08)  VALUE 'TRKUT001'.00520004
005300     05  PC-MAX-RETRIES               PIC S9(04) VALUE  +3        00530004
005400                                                 COMP.            00540004
005500                                                                  00550004
005600 01  PS-PROGRAM-SWITCHES.                                         00560004
005700     05  PS-PROCESS-COMPLETE-SW       PIC X(01)  VALUE 'N'.       00570004
005800         88  PS-PROCESS-COMPLETE                 VALUE 'Y'.       00580004
005900     05  PS-EOF-TPURCHS-SW            PIC X(01)  VALUE 'N'.       00590004
006000         88  PS-EOF-TPURCHS-CSR                  VALUE 'Y'.       00600004
006100                                                                  00610004
006200 01  PV-PROGRAM-VARIABLES.                                        00620004
006300     05  PV-ABEND-PARAGRAPH           PIC X(30)  VALUE SPACES.    00630004
006400     05  PV-DB2-OPERATION-ATTEMPTED   PIC X(30)  VALUE SPACES.    00640004
006500     05  PV-RETRY-COUNTER             PIC S9(04) VALUE +0         00650004
006600                                                 COMP SYNC.       00660004
006700     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00670004
006800                                                 COMP.            00680004
006900                                                                  00690004
007000 01  PW-PROGRAM-WORKAREA.                                         00700004
007100     05  PW-DB2-DATE-USA              PIC X(10).                  00710004
007200     05  PW-DB2-DATE-R  REDEFINES PW-DB2-DATE-USA.                00720004
007300         10  PW-DB2-DATE-MM           PIC X(02).                  00730004
007400         10  FILLER                   PIC X(01).                  00740004
007500         10  PW-DB2-DATE-DD           PIC X(02).                  00750004
007600         10  FILLER                   PIC X(01).                  00760004
007700         10  PW-DB2-DATE-CC           PIC X(02).                  00770004
007800         10  PW-DB2-DATE-YY           PIC X(02).                  00780004
007900                                                                  00790004
008000     05  PW-REFORMAT-CCYY-MM-DD.                                  00800004
008100         10  PW-REF-CC                PIC X(02).                  00810004
008200         10  PW-REF-YY                PIC X(02).                  00820004
008300         10  FILLER                   PIC X(01).                  00830004
008400         10  PW-REF-MM                PIC X(02).                  00840004
008500         10  FILLER                   PIC X(01).                  00850004
008600         10  PW-REF-DD                PIC X(02).                  00860004
008700                                                                  00870004
008800     05  PW-EXTRACT-DATE              PIC X(06).                  00880004
008900     05  PW-EXTRACT-DATE-N REDEFINES                              00890004
009000         PW-EXTRACT-DATE              PIC 9(06).                  00900004
009100                                                                  00910004
010100/                                                                 01010004
009300*PS 11/21/2014 CHANGE STARTS                                      01011020
010200******************************************************************01020004
010300*  COPY BOOK FOR SHIP INFO RECORD                                 01030020
010400******************************************************************01040004
010500     COPY TRRD010.                                                01050020
010000                                                                  01060020
010700/                                                                 01070004
009300*PS 11/21/2014 CHANGE ENDS                                        01070120
010200******************************************************************01071020
010300*  COPY BOOK FOR DB2 FORMATTED MESSAGE AREA                       01072020
010400******************************************************************01073020
010500     COPY DPWS004.                                                01074020
010600                                                                  01075020
010700/                                                                 01076020
010800******************************************************************01080004
010900*  COMMUNICATIONS AREA FOR DB2                                    01090004
011000******************************************************************01100004
011100     EXEC SQL                                                     01110004
011200          INCLUDE SQLCA                                           01120004
011300     END-EXEC.                                                    01130004
011400                                                                  01140004
011500/                                                                 01150004
011600******************************************************************01160004
011700*  DCLGEN FOR PURCHASE ORDER HEADER                               01170004
011800******************************************************************01180004
011900     EXEC SQL                                                     01190004
012000          INCLUDE TPURCHS                                         01200004
012100     END-EXEC.                                                    01210004
012200                                                                  01220004
012300/                                                                 01230004
012400******************************************************************01240004
012500*  DCLGEN FOR PURCHASE ORDER LINE ITEM                            01250004
012600******************************************************************01260004
012700     EXEC SQL                                                     01270004
012800          INCLUDE TPURITM                                         01280004
012900     END-EXEC.                                                    01290004
013000                                                                  01300004
013100/                                                                 01310004
013200******************************************************************01320004
013300*  DCLGEN FOR PLANNED SHIPMENTS                                   01330004
013400******************************************************************01340004
013500     EXEC SQL                                                     01350004
013600          INCLUDE TPLNSHP                                         01360004
013700     END-EXEC.                                                    01370004
013800                                                                  01380004
013900/                                                                 01390004
014000******************************************************************01400004
014100**  CURSOR USED TO LIST ACTIVE PO'S                               01410004
014200******************************************************************01420004
014300     EXEC SQL                                                     01430004
014400          DECLARE TPURCHS-CSR CURSOR FOR                          01440004
014500           SELECT A.PO_NBR                                        01450004
014600                 ,A.STATUS_CDE                                    01460004
014700                 ,A.DEPT_NBR                                      01470004
014800                 ,CHAR(B.DONT_SHIP_BEF_DTE,USA)                   01480004
014900                 ,CHAR(B.CAN_IFNOT_SHIP_DTE,USA)                  01490004
015000                 ,CHAR(B.EXT_CAN_DTE,USA)                         01500004
015100            FROM TPURCHS A                                        01510004
015200                ,TPLNSHP B                                        01520004
015300             WHERE A.VER_STATUS_CDE = 'A'                         01530004
015400               AND B.VER_STATUS_CDE = 'A'                         01540004
015500               AND A.STATUS_CDE IN ('AC','AP','CA','CM')          01550004
015600               AND A.PO_NBR = B.PO_NBR                            01560004
015700           ORDER BY A.PO_NBR                                      01570004
015800     END-EXEC.                                                    01580004
015900                                                                  01590004
016000/                                                                 01600004
016100 PROCEDURE DIVISION.                                              01610004
016200                                                                  01620004
016300******************************************************************01630004
016400*  CONTROLS THE MAIN PROCESSING OF THE PROGRAM.                   01640004
016500******************************************************************01650004
016600 0000-MAINLINE.                                                   01660004
016700                                                                  01670004
016800     PERFORM 1000-INITIALIZE.                                     01680004
016900                                                                  01690004
017000     PERFORM 2000-CREATE-EXTRACT                                  01700004
017100       UNTIL PS-EOF-TPURCHS-CSR.                                  01710004
017200                                                                  01720004
017300     DISPLAY 'TOTAL PO EXTRACT RECORDS WRITTEN: '                 01730004
017400              PA-PO-EXTRACT-CNT.                                  01740004
017500                                                                  01750004
017600     CLOSE EXTRACT-FILE.                                          01760004
017700                                                                  01770004
017800     STOP RUN.                                                    01780004
017900                                                                  01790004
018000/                                                                 01800004
018100******************************************************************01810004
018200*  - OPEN FILE                                                    01820004
018300*  - OPEN CURSOR ON TPURCHS TABLE                                 01830004
018400*  - FETCH FIRST ROW                                              01840004
018500******************************************************************01850004
018600 1000-INITIALIZE.                                                 01860004
018700                                                                  01870004
018800     OPEN OUTPUT EXTRACT-FILE.                                    01880004
018900                                                                  01890004
019000     PERFORM 7000-OPEN-TPURCHS-CSR.                               01900004
019100                                                                  01910004
019200     PERFORM 7010-FETCH-TPURCHS-CSR.                              01920004
019300                                                                  01930004
019400/                                                                 01940004
019500******************************************************************01950004
019600*  - CREATE EXTRACT                                               01960004
019700******************************************************************01970004
019800 2000-CREATE-EXTRACT.                                             01980004
019900                                                                  01990004
020000     PERFORM 7100-GET-MIN-AD-DATE.                                02000004
020100                                                                  02010004
020200     PERFORM 2010-BUILD-EXTRACT.                                  02020004
020300                                                                  02030004
020400     PERFORM 7010-FETCH-TPURCHS-CSR.                              02040004
020500                                                                  02050004
020600/                                                                 02060004
020700******************************************************************02070004
020800*  - BUILD EXTRACT                                                02080004
020900******************************************************************02090004
021000 2010-BUILD-EXTRACT.                                              02100004
021100                                                                  02110004
021400*PS 11/21/2014 CHANGE STARTS                                      02111020
021200     MOVE SPACES                 TO TR010-SHIP-INFO-PREV-REC.     02120120
021400     MOVE PURCHS-PO-NBR          TO TR010-PREV-POANUMBR           02140120
021400*PS 11/21/2014 CHANGE ENDS                                        02141020
021500                                                                  02150004
021600     EVALUATE TRUE                                                02160004
021700        WHEN PURCHS-STATUS-CDE = 'AC' OR 'AP'                     02170004
021400*PS 11/21/2014 CHANGE STARTS                                      02171020
021800            MOVE '3'             TO TR010-PREV-POAPRSIN           02180120
021400*PS 11/21/2014 CHANGE ENDS                                        02181020
021900                                                                  02190004
022000        WHEN PURCHS-STATUS-CDE = 'CA'                             02200004
021400*PS 11/21/2014 CHANGE STARTS                                      02201020
022100            MOVE '4'             TO TR010-PREV-POAPRSIN           02210120
021400*PS 11/21/2014 CHANGE ENDS                                        02211020
022200                                                                  02220004
022300        WHEN PURCHS-STATUS-CDE = 'CP'                             02230004
021400*PS 11/21/2014 CHANGE STARTS                                      02231020
022400            MOVE '5'             TO TR010-PREV-POAPRSIN           02240120
021400*PS 11/21/2014 CHANGE ENDS                                        02241020
022500     END-EVALUATE.                                                02250004
022600                                                                  02260004
021400*PS 11/21/2014 CHANGE STARTS                                      02261020
022700     MOVE PURCHS-DEPT-NBR        TO TR010-PREV-POADPTNO-N.        02270120
021400*PS 11/21/2014 CHANGE ENDS                                        02271020
022800                                                                  02280004
022900     IF  PLNSHP-DONT-SHIP-BEF-DTE = '01/01/0001'                  02290004
021400*PS 11/21/2014 CHANGE STARTS                                      02291020
023000         MOVE ZEROES             TO TR010-PREV-POASHPDT           02301020
021400*PS 11/21/2014 CHANGE ENDS                                        02302020
023100     ELSE                                                         02310004
023200         MOVE PLNSHP-DONT-SHIP-BEF-DTE                            02320004
023300                                 TO PW-DB2-DATE-USA               02330004
023400         STRING PW-DB2-DATE-MM DELIMITED BY SIZE                  02340004
023500                PW-DB2-DATE-DD DELIMITED BY SIZE                  02350004
023600                PW-DB2-DATE-YY DELIMITED BY SIZE                  02360004
023700                               INTO PW-EXTRACT-DATE               02370004
021400*PS 11/21/2014 CHANGE STARTS                                      02371020
023800         MOVE PW-EXTRACT-DATE-N  TO TR010-PREV-POASHPDT           02380120
021400*PS 11/21/2014 CHANGE ENDS                                        02381020
023900     END-IF.                                                      02390004
024000                                                                  02400004
024100     IF  PLNSHP-CAN-IFNOT-SHIP-DTE = '01/01/0001'                 02410004
021400*PS 11/21/2014 CHANGE STARTS                                      02411020
024200         MOVE ZEROES             TO TR010-PREV-POACANDT           02420120
021400*PS 11/21/2014 CHANGE ENDS                                        02421020
024300     ELSE                                                         02430004
024400         MOVE PLNSHP-CAN-IFNOT-SHIP-DTE                           02440004
024500                                 TO PW-DB2-DATE-USA               02450004
024600         STRING PW-DB2-DATE-MM DELIMITED BY SIZE                  02460004
024700                PW-DB2-DATE-DD DELIMITED BY SIZE                  02470004
024800                PW-DB2-DATE-YY DELIMITED BY SIZE                  02480004
024900                               INTO PW-EXTRACT-DATE               02490004
021400*PS 11/21/2014 CHANGE STARTS                                      02491020
025000         MOVE PW-EXTRACT-DATE-N  TO TR010-PREV-POACANDT           02500120
021400*PS 11/21/2014 CHANGE ENDS                                        02501020
025100     END-IF.                                                      02510004
025200                                                                  02520004
025300     IF  PLNSHP-EXT-CAN-DTE = '01/01/0001'                        02530004
021400*PS 11/21/2014 CHANGE STARTS                                      02531020
025400         MOVE ZEROES             TO TR010-PREV-POACANEX           02540120
021400*PS 11/21/2014 CHANGE ENDS                                        02541020
025500     ELSE                                                         02550004
025600         MOVE PLNSHP-EXT-CAN-DTE TO PW-DB2-DATE-USA               02560004
025700         STRING PW-DB2-DATE-MM DELIMITED BY SIZE                  02570004
025800                PW-DB2-DATE-DD DELIMITED BY SIZE                  02580004
025900                PW-DB2-DATE-YY DELIMITED BY SIZE                  02590004
026000                               INTO PW-EXTRACT-DATE               02600004
021400*PS 11/21/2014 CHANGE STARTS                                      02601020
026100         MOVE PW-EXTRACT-DATE-N  TO TR010-PREV-POACANEX           02610120
021400*PS 11/21/2014 CHANGE ENDS                                        02611020
026200     END-IF.                                                      02620004
026300                                                                  02630004
026400     IF  PURITM-AD-EVNT-DTE = SPACES                              02640004
021400*PS 11/21/2014 CHANGE STARTS                                      02641020
026500         MOVE ZEROES             TO TR010-PREV-POAADVDT           02650120
021400*PS 11/21/2014 CHANGE ENDS                                        02651020
026600     ELSE                                                         02660004
026700         MOVE PURITM-AD-EVNT-DTE TO PW-DB2-DATE-USA               02670004
026800         STRING PW-DB2-DATE-MM DELIMITED BY SIZE                  02680004
026900                PW-DB2-DATE-DD DELIMITED BY SIZE                  02690004
027000                PW-DB2-DATE-YY DELIMITED BY SIZE                  02700004
027100                               INTO PW-EXTRACT-DATE               02710004
021400*PS 11/21/2014 CHANGE STARTS                                      02711020
027200         MOVE PW-EXTRACT-DATE-N  TO TR010-PREV-POAADVDT           02720120
021400*PS 11/21/2014 CHANGE ENDS                                        02721020
027300     END-IF.                                                      02730004
027400                                                                  02740004
021400*PS 11/21/2014 CHANGE STARTS                                      02741020
027500     WRITE EXTRACT-RECORD FROM TR010-SHIP-INFO-PREV-REC.          02751020
021400*PS 11/21/2014 CHANGE ENDS                                        02752020
027600                                                                  02760004
027700     ADD +1                      TO PA-PO-EXTRACT-CNT.            02770004
027800                                                                  02780004
027900/                                                                 02790004
028000******************************************************************02800004
028100*  - OPEN THE TPURCHS CURSOR                                      02810004
028200******************************************************************02820004
028300 7000-OPEN-TPURCHS-CSR.                                           02830004
028400                                                                  02840004
028500     PERFORM                                                      02850004
028600         WITH TEST AFTER                                          02860004
028700         VARYING PV-RETRY-COUNTER                                 02870004
028800         FROM 1 BY 1                                              02880004
028900         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               02890004
029000            OR  (SQLCODE = +0))                                   02900004
029100                                                                  02910004
029200         EXEC SQL                                                 02920004
029300             OPEN TPURCHS-CSR                                     02930004
029400         END-EXEC                                                 02940004
029500                                                                  02950004
029600         EVALUATE TRUE                                            02960004
029700             WHEN SQLCODE = +0                                    02970004
029800             WHEN SQLCODE = -904                                  02980004
029900             WHEN SQLCODE = -913                                  02990004
030000                  CONTINUE                                        03000004
030100             WHEN SQLWARN0 NOT = SPACE                            03010004
030200             WHEN SQLCODE  NOT = +0                               03020004
030300                  MOVE '7000-OPEN-TPURCHS-CSR'                    03030004
030400                                 TO PV-ABEND-PARAGRAPH            03040004
030500                  MOVE 'OPEN ON TPURCHS CURSOR'                   03050004
030600                                 TO PV-DB2-OPERATION-ATTEMPTED    03060004
030700                  PERFORM 9000-SQL-ABEND                          03070004
030800          END-EVALUATE                                            03080004
030900     END-PERFORM.                                                 03090004
031000                                                                  03100004
031100     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        03110004
031200         MOVE '7000-OPEN-TPURCHS-CSR'                             03120004
031300                                 TO PV-ABEND-PARAGRAPH            03130004
031400         MOVE 'MAX RETRIES EXCEEDED'                              03140004
031500                                 TO PV-DB2-OPERATION-ATTEMPTED    03150004
031600         PERFORM 9000-SQL-ABEND                                   03160004
031700     END-IF.                                                      03170004
031800                                                                  03180004
031900/                                                                 03190004
032000******************************************************************03200004
032100*  - FETCH A ROW FROM THE TPURCHS CURSOR                          03210004
032200******************************************************************03220004
032300 7010-FETCH-TPURCHS-CSR.                                          03230004
032400                                                                  03240004
032500     EXEC SQL                                                     03250004
032600          FETCH TPURCHS-CSR                                       03260004
032700           INTO :PURCHS-PO-NBR                                    03270004
032800               ,:PURCHS-STATUS-CDE                                03280004
032900               ,:PURCHS-DEPT-NBR                                  03290004
033000               ,:PLNSHP-DONT-SHIP-BEF-DTE                         03300004
033100               ,:PLNSHP-CAN-IFNOT-SHIP-DTE                        03310004
033200               ,:PLNSHP-EXT-CAN-DTE                               03320004
033300     END-EXEC.                                                    03330004
033400                                                                  03340004
033500     EVALUATE TRUE                                                03350004
033600         WHEN SQLCODE = +0                                        03360004
033700              CONTINUE                                            03370004
033800                                                                  03380004
033900         WHEN SQLCODE = +100                                      03390004
034000              SET PS-EOF-TPURCHS-CSR TO TRUE                      03400004
034100                                                                  03410004
034200         WHEN SQLWARN0 NOT = SPACE                                03420004
034300         WHEN SQLCODE  NOT = +0                                   03430004
034400              MOVE '7010-FETCH-TPURCHS-CSR'                       03440004
034500                                 TO PV-ABEND-PARAGRAPH            03450004
034600              MOVE 'FETCH ON TPURCHS CURSOR'                      03460004
034700                                 TO PV-DB2-OPERATION-ATTEMPTED    03470004
034800              PERFORM 9000-SQL-ABEND                              03480004
034900     END-EVALUATE.                                                03490004
035000                                                                  03500004
035100/                                                                 03510004
035200******************************************************************03520004
035300*  - RETREIVE THE LOWEST AD DATE FROM THE LINE ITEM TABLE         03530004
035400******************************************************************03540004
035500 7100-GET-MIN-AD-DATE.                                            03550004
035600                                                                  03560004
035700     PERFORM                                                      03570004
035800         WITH TEST AFTER                                          03580004
035900         VARYING PV-RETRY-COUNTER                                 03590004
036000         FROM 1 BY 1                                              03600004
036100         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES)               03610004
036200            OR  (SQLCODE = +0)                                    03620004
036300            OR  (SQLCODE = -305))                                 03630004
036400                                                                  03640004
036500        EXEC SQL                                                  03650004
036600            SELECT  MIN(AD_EVNT_DTE)                              03660004
036700              INTO  :PURITM-AD-EVNT-DTE                           03670004
036800              FROM  TPURITM                                       03680004
036900             WHERE  PO_NBR         = :PURCHS-PO-NBR               03690004
037000               AND  VER_STATUS_CDE = 'A'                          03700004
037100        END-EXEC                                                  03710004
037200                                                                  03720004
037300        EVALUATE TRUE                                             03730004
037400            WHEN SQLCODE = +0                                     03740004
037500                 IF  PURITM-AD-EVNT-DTE = '0001-01-01'            03750005
037600                     MOVE SPACES TO PURITM-AD-EVNT-DTE            03760004
037700                 ELSE                                             03770004
037800                     MOVE PURITM-AD-EVNT-DTE                      03780004
037900                                 TO PW-REFORMAT-CCYY-MM-DD        03790004
038000                     MOVE PW-REF-CC TO PW-DB2-DATE-CC             03800004
038100                     MOVE PW-REF-YY TO PW-DB2-DATE-YY             03810004
038200                     MOVE PW-REF-MM TO PW-DB2-DATE-MM             03820004
038300                     MOVE PW-REF-DD TO PW-DB2-DATE-DD             03830004
038400                     MOVE PW-DB2-DATE-R TO PURITM-AD-EVNT-DTE     03840004
038500                 END-IF                                           03850004
038600                                                                  03860004
038700            WHEN SQLCODE = -305                                   03870004
038800                 MOVE SPACES     TO PURITM-AD-EVNT-DTE            03880004
038900                                                                  03890004
039000            WHEN SQLWARN0 NOT = SPACE                             03900004
039100            WHEN SQLCODE  NOT = +0                                03910004
039200                 MOVE '7100-GET-MIN-AD-DATE'                      03920004
039300                                 TO PV-ABEND-PARAGRAPH            03930004
039400                 MOVE 'SELECT ON TPURITM'                         03940004
039500                                 TO PV-DB2-OPERATION-ATTEMPTED    03950004
039600                 PERFORM 9000-SQL-ABEND                           03960004
039700        END-EVALUATE                                              03970004
039800     END-PERFORM.                                                 03980004
039900                                                                  03990004
040000     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES                        04000004
040100         MOVE '7100-GET-MIN-AD-DATE'                              04010004
040200                                 TO PV-ABEND-PARAGRAPH            04020004
040300         MOVE 'MAX RETRIES EXCEEDED'                              04030004
040400                                 TO PV-DB2-OPERATION-ATTEMPTED    04040004
040500         PERFORM 9000-SQL-ABEND                                   04050004
040600     END-IF.                                                      04060004
040700                                                                  04070004
040800/                                                                 04080004
040900******************************************************************04090004
041000*  - ERROR ROUTINE FOR DB2 ABENDS                                 04100004
041100******************************************************************04110004
041200 9000-SQL-ABEND.                                                  04120004
041300                                                                  04130004
041400     DISPLAY '9000-SQL-ABEND'.                                    04140004
041500     DISPLAY '** ABEND     **'.                                   04150004
041600     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04160004
041700     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             04170004
041800     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     04180004
041900                                                                  04190004
042000/                                                                 04200004
042100******************************************************************04210004
042200* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04220004
042300* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04230004
042400* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04240004
042500* FORMAT.                                                         04250004
042600******************************************************************04260004
042700     COPY DPPD004.                                                04270004
042800                                                                  04280004
042900     IF  SQLCODE NOT = -911                                       04290004
043000         EXEC SQL                                                 04300004
043100              COMMIT                                              04310004
043200         END-EXEC                                                 04320004
043300     END-IF.                                                      04330004
043400                                                                  04340004
043500     MOVE +4013                  TO PV-ABEND-CODE.                04350004
043600     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         04360004
