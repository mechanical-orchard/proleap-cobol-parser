000100******************************************************************00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300******************************************************************00030000
000400                                                                  00040000
000500 PROGRAM-ID.   SUKUP033.                                          00050000
000600 AUTHOR.       AYAN SARKAR.                                       00060000
000700 INSTALLATION. KOHLS DEPARTMENT STORES.                           00070000
000800 DATE-WRITTEN. NOV, 2016.                                         00080000
000900 DATE-COMPILED.                                                   00090000
001000                                                                  00100000
001100******************************************************************00110000
001200*THIS PROGRAM TAKES THE OTBND_TRIP_ID (WHICH HAS MULTIPLE 'SO'   *00120000
001300*RECORDS) AS INPUT AND DELETE THE RECORDS OTHER THAN LATEST ONE  *00130000
001310*FROM TSUOBTS TABLE.                                             *00131000
001400******************************************************************00140000
001500 ENVIRONMENT DIVISION.                                            00150000
001600******************************************************************00160000
001700                                                                  00170000
001800 CONFIGURATION SECTION.                                           00180000
001900                                                                  00190000
002000 SOURCE-COMPUTER.        IBM-3090.                                00200000
002100 OBJECT-COMPUTER.        IBM-3090.                                00210000
002200                                                                  00220000
002210 INPUT-OUTPUT SECTION.                                            00221000
002220 FILE-CONTROL.                                                    00222000
002230     SELECT INP-TRIP-FILE        ASSIGN TO INP01.                 00223000
002240                                                                  00224000
002250 DATA DIVISION.                                                   00225000
002260 FILE SECTION.                                                    00226000
002270 FD  INP-TRIP-FILE                                                00227000
002280     RECORDING MODE IS F                                          00228000
002290     LABEL RECORDS ARE STANDARD                                   00229000
002291     BLOCK CONTAINS 0 RECORDS.                                    00229100
002294 01  INP-TRIP-RECORDS           PIC X(40).                        00229400
002300*                                                                 00230000
002700******************************************************************00270000
002800 WORKING-STORAGE SECTION.                                         00280000
002900******************************************************************00290000
007500                                                                  00750000
007600 01  ABEND-CODE                    PIC S9(04) VALUE +0            00760000
007700                                                   COMP SYNC.     00770000
007800 01  PS-PROGRAM-SWITCHES.                                         00780000
007900     05  PS-END-OF-TRIP-CSR-SW     PIC X(01)  VALUE 'N'.          00790000
008000         88  PS-END-OF-TRIP-CSR               VALUE 'Y'.          00800000
008100         88  PS-END-OF-TRIP-CSR-NO            VALUE 'N'.          00810000
008110     05  PS-END-OF-TRIP-FILE-SW    PIC X(01)  VALUE 'N'.          00811000
008120         88  PS-END-OF-TRIP-FILE              VALUE 'Y'.          00812000
008130         88  PS-END-OF-TRIP-FILE-NO           VALUE 'N'.          00813000
008200                                                                  00820000
008300 01  PC-PROGRAM-CONSTANTS.                                        00830000
008400     05  PC-PGM-NAME               PIC X(08)  VALUE 'SUKUP033'.   00840000
008600                                                                  00860000
008700 01 PV-PROGRAM-VARIABLES.                                         00870000
008800     05  PV-ABEND-PARAGRAPH        PIC X(35)  VALUE SPACES.       00880000
008900     05  PV-DB2-OPN-ATTEMPTED      PIC X(35)  VALUE SPACES.       00890000
009000     05  PV-SQLCODE                PIC S9(9)  VALUE +0.           00900000
009100     05  PV-DISP-SQLCODE           PIC ZZZZZZ9-.                  00910000
009200     05  PV-TOT-RECS-READ          PIC 9(09)  VALUE ZEROES.       00920000
009210     05  PV-TOT-RECS-FETCHED       PIC 9(09)  VALUE ZEROES.       00921000
009300     05  PV-TOT-RECS-DELETED       PIC 9(09)  VALUE ZEROES.       00930000
009310     05  PV-INPUT-TRIP-RECS.                                      00931000
009320         10  PV-INP-TRIP-ID        PIC S9(9) COMP                 00932000
009330                                              VALUE ZEROES.       00933000
009340         10  PV-INP-TRIP-TMST      PIC X(26).                     00934000
009350         10  FILLER                PIC X(05)  VALUE SPACES.       00935000
009400     05  PV-DISP-TRIP-DETAIL.                                     00940000
009410         10  FILLER                PIC X(08)  VALUE 'TRIP-ID:'.   00941000
009420         10  PV-TRIP-ID            PIC 9(09)  VALUE ZEROES.       00942000
009430         10  FILLER                PIC X(06)  VALUE ' STAT:'.     00943000
009440         10  PV-TRIP-STAT          PIC X(02)  VALUE SPACES.       00944000
009450         10  FILLER                PIC X(06)  VALUE ' TMST:'.     00945000
009460         10  PV-TRIP-TMST          PIC X(26)  VALUE SPACES.       00946000
009470         10  FILLER                PIC X(06)  VALUE ' OPER:'.     00947000
009480         10  PV-OPER-ID            PIC 9(04)  VALUE ZEROES.       00948000
009500                                                                  00950000
009501******************************************************************00950100
009502*  COMMUNICATIONS AREA FOR DB2                                   *00950200
009503******************************************************************00950300
009504     EXEC SQL                                                     00950400
009505          INCLUDE SQLCA                                           00950500
009506     END-EXEC.                                                    00950600
009507                                                                  00950700
009508******************************************************************00950800
009509*  DB2 TABLE DECLARATION - TSUOBTS                               *00950900
009510******************************************************************00951000
009511     EXEC SQL                                                     00951100
009512          INCLUDE TSUOBTS                                         00951200
009513     END-EXEC.                                                    00951300
009514                                                                  00951400
009515******************************************************************00951500
009516*    CURSOR TO SELECT TRIP DETAILS                               *00951600
009517******************************************************************00951700
009518     EXEC SQL                                                     00951800
009519        DECLARE TRIP_CSR CURSOR WITH HOLD FOR                     00951900
009521            SELECT  OTBND_TRIP_ID                                 00952100
009522                  , TRIP_STAT_CDE                                 00952200
009523                  , OTBND_STAT_TMST                               00952300
009524                  , STAT_OPER_UNT_ID                              00952400
009525              FROM                                                00952500
009526                    TSUOBTS                                       00952600
009527             WHERE                                                00952700
009528                    OTBND_TRIP_ID   = :PV-INP-TRIP-ID             00952800
009529               AND  TRIP_STAT_CDE   = 'SO'                        00952900
009530               AND  OTBND_STAT_TMST < :PV-INP-TRIP-TMST           00953000
009531     END-EXEC.                                                    00953100
009532                                                                  00953200
009533******************************************************************00953300
009534*  WORK AREA FOR SQL ERROR ROUTINE 'DSNTIAR'                     *00953400
009535******************************************************************00953500
009536     COPY DPWS004.                                                00953600
009540*                                                                 00954000
009600 LINKAGE SECTION.                                                 00960000
009610******************************************************************00961000
009700 PROCEDURE DIVISION.                                              00970000
009800******************************************************************00980000
010100 0000-PROGRAM-MAINLINE.                                           01010000
010200                                                                  01020000
010300     PERFORM 1000-INITIALIZE.                                     01030000
010400     PERFORM 2000-PROCESS-INPUT-TRIP-FILE                         01040000
010410       UNTIL PS-END-OF-TRIP-FILE.                                 01041000
010500     PERFORM 8000-EOJ-ROUTINE.                                    01050000
010600                                                                  01060000
010700     STOP RUN.                                                    01070000
010800*                                                                 01080000
011100******************************************************************01110000
011200 1000-INITIALIZE.                                                 01120000
011210******************************************************************01121000
011300*                                                                 01130000
011400     DISPLAY 'START OF PROGRAM : ' PC-PGM-NAME.                   01140000
011500                                                                  01150000
011600     INITIALIZE DCLTSUOBTS                                        01160000
011800                PV-PROGRAM-VARIABLES.                             01180000
011900                                                                  01190000
012010     SET PS-END-OF-TRIP-FILE-NO   TO TRUE.                        01201000
012100                                                                  01210000
012101     OPEN INPUT INP-TRIP-FILE.                                    01210100
012102                                                                  01210200
012110     PERFORM 1100-READ-INPUT-TRIP-FILE.                           01211000
012200*                                                                 01220000
012500******************************************************************01250000
012600 1100-READ-INPUT-TRIP-FILE.                                       01260000
012610******************************************************************01261000
012611*                                                                 01261100
012612     READ INP-TRIP-FILE                                           01261200
012613     INTO PV-INPUT-TRIP-RECS                                      01261300
012614       AT END                                                     01261400
012615          SET PS-END-OF-TRIP-FILE TO TRUE.                        01261500
012616                                                                  01261600
012617     IF PS-END-OF-TRIP-FILE-NO                                    01261700
012618        ADD +1                    TO PV-TOT-RECS-READ             01261800
012619        SET PS-END-OF-TRIP-CSR-NO TO TRUE                         01261900
012623     END-IF.                                                      01262300
012624*                                                                 01262400
012625******************************************************************01262500
012630 2000-PROCESS-INPUT-TRIP-FILE.                                    01263000
012640******************************************************************01264000
012700*                                                                 01270000
012800     PERFORM 2100-OPEN-TRIP-CSR.                                  01280000
013000     PERFORM 2200-FETCH-TRIP-CSR                                  01300000
013100       UNTIL PS-END-OF-TRIP-CSR.                                  01310000
013300     PERFORM 2300-CLOSE-TRIP-CSR.                                 01330000
013401*                                                                 01340100
013403     PERFORM 4000-COMMIT.                                         01340300
013404*                                                                 01340400
013410     PERFORM 1100-READ-INPUT-TRIP-FILE.                           01341000
013500*                                                                 01350000
013600******************************************************************01360000
013900 2100-OPEN-TRIP-CSR.                                              01390000
013910******************************************************************01391000
014000*                                                                 01400000
014100     EXEC SQL                                                     01410000
014200          OPEN TRIP_CSR                                           01420000
014300     END-EXEC.                                                    01430000
014400                                                                  01440000
014500     EVALUATE TRUE                                                01450000
014600         WHEN SQLCODE = 0                                         01460000
014700             CONTINUE                                             01470000
014800         WHEN OTHER                                               01480000
014900             MOVE '2100-OPEN-TRIP-CSR'    TO PV-ABEND-PARAGRAPH   01490000
015100             MOVE 'OPEN TRIP_CSR'         TO PV-DB2-OPN-ATTEMPTED 01510000
015300             PERFORM 9100-SQL-ABEND                               01530000
015400     END-EVALUATE.                                                01540000
015600*                                                                 01560000
015700******************************************************************01570000
016000 2200-FETCH-TRIP-CSR.                                             01600000
016010******************************************************************01601000
016100*                                                                 01610000
016500     EXEC SQL                                                     01650000
016600          FETCH TRIP_CSR                                          01660000
016700           INTO :SUOBTS-OTBND-TRIP-ID                             01670000
016800               ,:SUOBTS-TRIP-STAT-CDE                             01680000
016900               ,:SUOBTS-OTBND-STAT-TMST                           01690000
016910               ,:SUOBTS-STAT-OPER-UNT-ID                          01691000
017000     END-EXEC.                                                    01700000
017100                                                                  01710000
017200     EVALUATE TRUE                                                01720000
017300         WHEN SQLCODE = 0                                         01730000
017400             ADD +1                       TO PV-TOT-RECS-FETCHED  01740000
017410             MOVE SUOBTS-OTBND-TRIP-ID    TO PV-TRIP-ID           01741000
017420             MOVE SUOBTS-OTBND-STAT-TMST  TO PV-TRIP-TMST         01742000
017430             MOVE SUOBTS-TRIP-STAT-CDE    TO PV-TRIP-STAT         01743000
017440             MOVE SUOBTS-STAT-OPER-UNT-ID TO PV-OPER-ID           01744000
017450             DISPLAY PV-DISP-TRIP-DETAIL                          01745000
017500             PERFORM 3000-DELETE-TRIP                             01750000
017600         WHEN SQLCODE = +100                                      01760000
017700             SET PS-END-OF-TRIP-CSR       TO TRUE                 01770000
017900         WHEN OTHER                                               01790000
018000             MOVE '2200-FETCH-TRIP-CSR'   TO PV-ABEND-PARAGRAPH   01800000
018200             MOVE 'FETCH TRIP_CSR'        TO PV-DB2-OPN-ATTEMPTED 01820000
018400           PERFORM 9100-SQL-ABEND                                 01840000
018500     END-EVALUATE.                                                01850000
018700*                                                                 01870000
018800******************************************************************01880000
019100 2300-CLOSE-TRIP-CSR.                                             01910000
019110******************************************************************01911000
019120*                                                                 01912000
019300     EXEC SQL                                                     01930000
019400          CLOSE TRIP_CSR                                          01940000
019500     END-EXEC.                                                    01950000
019600                                                                  01960000
019700     EVALUATE TRUE                                                01970000
019800         WHEN SQLCODE = 0                                         01980000
019900            CONTINUE                                              01990000
020200         WHEN OTHER                                               02020000
020300             MOVE '2300-CLOSE-TRIP-CSR'   TO PV-ABEND-PARAGRAPH   02030000
020500             MOVE 'CLOSE TRIP_CSR'        TO PV-DB2-OPN-ATTEMPTED 02050000
020700             PERFORM 9100-SQL-ABEND                               02070000
020800     END-EVALUATE.                                                02080000
021020*                                                                 02102000
021100******************************************************************02110000
021400 3000-DELETE-TRIP.                                                02140000
021410******************************************************************02141000
021420*                                                                 02142000
021600     EXEC SQL                                                     02160000
021700         DELETE                                                   02170000
021800           FROM TSUOBTS                                           02180000
021900          WHERE OTBND_TRIP_ID    = :SUOBTS-OTBND-TRIP-ID          02190000
022000            AND TRIP_STAT_CDE    = :SUOBTS-TRIP-STAT-CDE          02200000
022100            AND OTBND_STAT_TMST  = :SUOBTS-OTBND-STAT-TMST        02210000
022110            AND STAT_OPER_UNT_ID = :SUOBTS-STAT-OPER-UNT-ID       02211000
022200     END-EXEC.                                                    02220000
022300                                                                  02230000
022400     EVALUATE TRUE                                                02240000
022500         WHEN SQLCODE = 0                                         02250000
022510            ADD +1                 TO PV-TOT-RECS-DELETED         02251000
022600         WHEN SQLCODE = +100                                      02260000
023300            CONTINUE                                              02330000
023400         WHEN OTHER                                               02340000
023500             MOVE '3000-DELETE-TRIP'                              02350000
023600                                   TO PV-ABEND-PARAGRAPH          02360000
023700             MOVE 'DELETE TSUOBTS' TO PV-DB2-OPN-ATTEMPTED        02370000
023900           PERFORM 9100-SQL-ABEND                                 02390000
024000     END-EVALUATE.                                                02400000
024100*                                                                 02410000
024400******************************************************************02440000
024700 4000-COMMIT.                                                     02470000
024710******************************************************************02471000
024720*                                                                 02472000
024900     EXEC SQL                                                     02490000
025000         COMMIT                                                   02500000
025100     END-EXEC.                                                    02510000
025200                                                                  02520000
025300     EVALUATE TRUE                                                02530000
025400         WHEN SQLCODE = 0                                         02540000
025500            CONTINUE                                              02550000
025700         WHEN OTHER                                               02570000
025800             MOVE '4000-COMMIT'    TO PV-ABEND-PARAGRAPH          02580000
025900             MOVE 'COMMIT'         TO PV-DB2-OPN-ATTEMPTED        02590000
026000           PERFORM 9100-SQL-ABEND                                 02600000
026100     END-EVALUATE.                                                02610000
026300*                                                                 02630000
026400******************************************************************02640000
026500* DISPLAYS PROGRAM STATISTICS                                    *02650000
026600******************************************************************02660000
026700 8000-EOJ-ROUTINE.                                                02670000
026800                                                                  02680000
027900     CLOSE INP-TRIP-FILE.                                         02790000
028000     DISPLAY 'RECORDS READ     : ' PV-TOT-RECS-READ.              02800000
028001     DISPLAY 'RECORDS FETCHED  : ' PV-TOT-RECS-FETCHED.           02800100
028010     DISPLAY 'RECORDS DELETED  : ' PV-TOT-RECS-DELETED.           02801000
028100     DISPLAY 'END OF PROGRAM   : ' PC-PGM-NAME.                   02810000
028200*                                                                 02820000
028300******************************************************************02830000
028400* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *02840000
028500* ERROR OR WARNING CODE OCCURS.                                  *02850000
028600******************************************************************02860000
028700 9100-SQL-ABEND.                                                  02870000
028800                                                                  02880000
028810     MOVE SQLCODE                    TO PV-SQLCODE.               02881000
028820     MOVE PV-SQLCODE                 TO PV-DISP-SQLCODE.          02882000
028830                                                                  02883000
028900     DISPLAY '9100-SQL-ABEND'.                                    02890000
029000     DISPLAY '** ABEND     **'.                                   02900000
029100     DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    02910000
029200     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02920000
029300     DISPLAY '** OPERATION ** = ' PV-DB2-OPN-ATTEMPTED.           02930000
029310     DISPLAY '** SQLCODE   ** = ' PV-DISP-SQLCODE.                02931000
029400     COPY DPPD004.                                                02940000
029500     MOVE +4013                      TO ABEND-CODE.               02950000
029600     CALL 'ILBOABN0' USING ABEND-CODE.                            02960000
029700                                                                  02970000
