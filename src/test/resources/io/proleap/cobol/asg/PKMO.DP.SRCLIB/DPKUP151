000100 IDENTIFICATION DIVISION.                                         00010008
000200 PROGRAM-ID.    DPKUP151.                                         00020008
000300 AUTHOR.        JILL JUEL.                                        00030008
000400 DATE-WRITTEN.  DECEMBER 1998.                                    00040008
000500 DATE-COMPILED.                                                   00050008
000600***************************************************************** 00051015
001100*                  COBOL II WITH SQL                            * 00056015
001200***************************************************************** 00057015
001300**********     GET NEXT DOCUMENT NUMBER ROUTINE        ********** 00070008
001400***************************************************************** 00080008
001500*  THIS PROGRAM IS A SUB ROUTINE THAT WILL UPDATE AND GET THE   * 00090008
001600*  NEXT AVAILABLE AP DOCUMENT NUMBER.                           * 00100008
001700*  ** NOTE THERE ARE INSPECT STATEMENTS THAT USE THE NUMBER     *         
001800*  ** 16 AS A CONSTANT FOR THE LENGTH OF THE DOCUMENT NUMBER.   *         
001900***************************************************************** 00110008
002000*                                                               * 00120008
002100* DB2 TABLES:                                                   * 00130008
002200*  1. AP CONTROL TABLE                 (TAPCNTL)                * 00140008
002300*  2. ADJUSTMENT JOURNAL HEADER TABLE  (TADJRNL)                * 00141016
002400***************************************************************** 00150008
      * CHANGE LOG:                                                   *         
      * 10/13/1999                                                    *         
      *   ADDED LOGIC TO DO A COMMIT IF THE CALLING PROGRAM SETS THE  *         
      *   SWITCH TO DO SO. ROUTINE Y300-DB2-COMMIT.                   *         
      * MADE BY: JILL JUEL                            WR: 5998        *         
      *                                                               *         
      * 10/18/1999                                                    *         
      *   REMOVED CODE THAT WAS ONLY USED BY CICS PROGRAMS AND        *         
      *   CREATED A CICS VERSION OF THIS PROGRAM, APKUP151.           *         
      * MADE BY: JILL JUEL                            WR: 5998        *         
      *                                                               *         
      *****************************************************************         
002500 ENVIRONMENT DIVISION.                                            00160008
002900                                                                  00200008
003000 DATA DIVISION.                                                   00210008
003100                                                                  00220008
003400*************************                                         00250008
003500 WORKING-STORAGE SECTION.                                         00260008
003600*************************                                         00270008
003700 01  PC-PROGRAM-CONSTANTS.                                        00280008
003800     05  PC-PROGRAM-NAME         PIC X(08) VALUE 'DPKUP151'.      00290008
003900     05  PC-MAX-RETRIES-DOC-NBR  PIC S9(04) VALUE +10             00300008
004000                                                COMP.             00310008
004100 01  PV-PROGRAM-VARIABLES.                                        00320008
004200     05 PV-RETRY-COUNTER         PIC S9(04)  VALUE +0             00330008
004300                                             COMP SYNC.           00340008
004400     05 PV-NEXT-DOC-NBR          PIC  9(16).                      00350030
004500     05 PV-NEW-DOC-NBR           PIC  9(16).                      00360030
004600     05 PV-CURR-DOC-NBR          PIC  9(16).                      00360130
004700     05 PV-END-SPACE-CNT         PIC S9(04)  VALUE +0             00360226
004800                                             COMP SYNC.           00360326
004900     05 PV-BEG-ZERO-CNT          PIC S9(04)  VALUE +0             00360430
005000                                             COMP SYNC.           00360528
005100                                                                  00361016
005700 01  ERROR-MESSAGES.                                              00380008
005800     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                00390008
005900             '*****   PROGRAM: DPKUP151'.                         00400008
006000     05  AA-PARAGRAPH-LIT.                                        00410008
006100         10  FILLER              PIC  X(17)  VALUE                00420008
006200             '***** PARAGRAPH: '.                                 00430008
006300         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        00440008
006400     05  AA-MESSAGE-LINE.                                         00450008
006500         10  FILLER              PIC  X(06)  VALUE '*****'.       00460008
006600         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        00470008
006700     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                00480008
006800             '*****    DB2 ERROR'.                                00490008
006900     05  AA-DB2-OPERATION-LIT.                                    00500008
007000         10  FILLER              PIC  X(17)  VALUE                00510008
007100             '***** OPERATION: '.                                 00520008
007200         10  AA-DB2-OPERATION.                                    00530008
007300             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        00540008
007400             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        00550008
007500     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        00560008
007600     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        00570008
007700     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        00580008
007800 EJECT                                                            00590008
007900                                                                  00600008
008000*--------------------------------------------------------------*  00610008
008100*  DPWS004 CONTAINS THE FIELDS NECESSARY TO CALL THE SQLCA     *  00620008
008200*  MESSAGE MODULE 'DSNTIAR' AND DISPLAY THE FORMATTED RESULTS. *  00630008
008300*--------------------------------------------------------------*  00640008
008400     COPY DPWS004.                                                00650008
008500 EJECT                                                            00660008
008600                                                                  00670008
008700*--------------------------------------------------------------*  00680008
008800*  COMMUNICATIONS AREA2 FOR DB2                                *  00690008
008900*--------------------------------------------------------------*  00700008
009000*    COPY SQLCA2.                                                 00710014
009100                                                                  00720008
009200*--------------------------------------------------------------*  00730008
009300*     SQL COMMUNICATIONS AREA DCLGEN                           *  00740008
009400*--------------------------------------------------------------*  00750008
009500     EXEC SQL                                                     00760008
009600         INCLUDE SQLCA                                            00770008
009700     END-EXEC.                                                    00780008
009800 EJECT                                                            00790008
009900                                                                  00800008
010000*--------------------------------------------------------------*  00810008
010100*  AP CONTROL TABLE                                            *  00820008
010200*--------------------------------------------------------------*  00830008
010300     EXEC SQL                                                     00840008
010400          INCLUDE TAPCNTL                                         00850008
010500     END-EXEC.                                                    00860008
010600                                                                  00861016
010700*--------------------------------------------------------------*  00862016
010800*  ADJUSTMENT HEADER TABLE                                     *  00863016
010900*--------------------------------------------------------------*  00864016
011000     EXEC SQL                                                     00865016
011100          INCLUDE TADJRNL                                         00866016
011200     END-EXEC.                                                    00867016
011300 EJECT                                                            00870008
011400                                                                  00880008
011500*--------------------------------------------------------------*  00890008
011600*  THIS IS THE UPDATE CURSOR FOR GETTING THE NEXT AVAILABLE    *  00900008
011700*  DOCUMENT NUMBER.  THIS CURSOR IS NEEDED IN ORDER TO "LOCK"  *  00910008
011800*  THE ROW SO NO COLLISIONS WILL OCCUR ON THE INSERT.          *  00920008
011900*--------------------------------------------------------------*  00930008
012000     EXEC SQL                                                     00940008
012100       DECLARE UPD_CSR CURSOR FOR                                 00950008
012200         SELECT NEXT_AP_DOC_NBR                                   00960008
012300           FROM TAPCNTL                                           00970008
012400            FOR UPDATE OF NEXT_AP_DOC_NBR                         00980008
012500     END-EXEC.                                                    00990008
012600 EJECT                                                            01000008
012700                                                                  01010008
012800 LINKAGE SECTION.                                                 01020008
012900                                                                  01030008
013000     COPY APWS151.                                                01040008
013100                                                                  01050008
013200***************************************************               01060008
013300 PROCEDURE DIVISION USING WS151-DOC-NBR-PARAMETERS.               01070008
013400***************************************************               01080008
013500 A100-MAIN-ROUTINE.                                               01090008
013600                                                                  01091034
013700     PERFORM Y100-OPEN-UPD-CSR.                                   01100008
013800                                                                  01100134
013900     IF WS151-SUCCESSFUL-CALL                                     01101020
014000        PERFORM R100-FETCH-UPD-CSR                                01110020
014100                                                                  01111020
014200** INSPECT THE NEXT AP DOCUMENT NUMBER CHARACTER FIELD TO COUNT           
014300** FOR SPACES THAT ARE TRAILING.                                          
014400        INITIALIZE PV-END-SPACE-CNT                               01111131
014500        INSPECT APCNTL-NEXT-AP-DOC-NBR                            01112025
014600            TALLYING PV-END-SPACE-CNT FOR ALL SPACES              01113026
014700                                                                  01120008
014800** MOVE THE NEXT AP DOCUMENT NUMBER CHARACTER FIELD (SPACES               
014900** EXCLUDED) TO THE NUMERIC PV-NEW-DOC-NBR FIELD FOR INCREMENTING.        
015000** WHILE THE DOCUMENT NUMBER WILL BE STORED ON THE DB2 TABLES AS          
015100** A CHARACTER FIELD, IT WILL NEED TO BE A NUMERIC FIELD IN THIS          
015200** MODULE FOR CALCULATION PURPOSES.                                       
015300        MOVE APCNTL-NEXT-AP-DOC-NBR (1 : 16 - PV-END-SPACE-CNT)   01121026
015400             TO PV-NEW-DOC-NBR                                    01122025
015700        INITIALIZE PV-BEG-ZERO-CNT                                01132133
015800        INSPECT PV-NEW-DOC-NBR                                    01132228
015900                TALLYING PV-BEG-ZERO-CNT FOR LEADING ZEROS        01132330
016000        MOVE PV-NEW-DOC-NBR TO PV-CURR-DOC-NBR                    01132530
016100        MOVE PV-NEW-DOC-NBR (PV-BEG-ZERO-CNT + 1 :                01132630
016200                             16 - PV-BEG-ZERO-CNT) TO             01132730
016300                             ADJRNL-DOC-NBR                       01132828
016500        ADD +1 TO PV-NEW-DOC-NBR                                  01140021
016700     END-IF.                                                      01142220
016800                                                                  01143016
016900     MOVE ADJRNL-DOC-NBR   TO WS151-NEXT-DOC-NBR.                 01144028
017000     ADD +1 TO PV-CURR-DOC-NBR GIVING PV-NEXT-DOC-NBR.            01145132
017100** INSPECT THE NUMERIC NEXT DOCUMENT NUMBER FIELD TO COUNT FOR            
017200** LEADING ZEROS.  THE LEADING ZEROS WILL NOT BE INCLUDED WHEN            
017300** THE NEXT AVAILABLE DOCUMENT NUMBER IS STORED ON THE DB2 TABLES.        
017400     INITIALIZE PV-BEG-ZERO-CNT.                                  01146031
017500     INSPECT PV-NEXT-DOC-NBR                                      01147031
017600       TALLYING PV-BEG-ZERO-CNT FOR LEADING ZEROS.                01148031
017700     MOVE PV-NEXT-DOC-NBR (PV-BEG-ZERO-CNT + 1 :                  01149031
017800                           16 - PV-BEG-ZERO-CNT) TO               01149131
017900                              APCNTL-NEXT-AP-DOC-NBR.             01149231
018000                                                                  01170008
018100     PERFORM U100-UPDATE-TAPCNTL.                                 01180008
018200     PERFORM Y200-CLOSE-UPD-CSR.                                  01190008
           IF WS151-COMMIT                                                      
              PERFORM Y300-DB2-COMMIT                                           
           END-IF.                                                              
018300     GOBACK.                                                      01200008
018400 EJECT                                                            01210008
018500                                                                  01220008
018600*--------------------------------------------------------------*  01230008
018700*  FETCHS THE NEXT AVAILABLE AP DOCUMENT NUMBER                *  01240008
018800*--------------------------------------------------------------*  01250008
018900 R100-FETCH-UPD-CSR.                                              01260008
019000     EXEC SQL                                                     01270008
019100         FETCH UPD_CSR                                            01280008
019200          INTO :APCNTL-NEXT-AP-DOC-NBR                            01290008
019300     END-EXEC.                                                    01300008
019400     EVALUATE TRUE                                                01310008
019500         WHEN SQLCODE = +0                                        01320008
019600             MOVE SPACES                   TO WS151-ERROR-MESSAGE 01321011
019700             SET WS151-SUCCESSFUL-CALL     TO TRUE                01322011
020000         WHEN SQLCODE = +100                                      01350008
020100             MOVE 'ERROR FETCHING UPD-CSR' TO WS151-ERROR-MESSAGE 01352011
020200             SET WS151-ERRORS-FOUND        TO TRUE                01353011
020900     END-EVALUATE.                                                01420008
021000     MOVE SQLCODE                          TO WS151-SQLCODE.      01421011
021100 EJECT                                                            01430008
021200                                                                  01440008
024500*--------------------------------------------------------------*  01452008
024600*  UPDATES THE DOC NBR ON TAPCNTL TABLE                        *  01460008
024700*--------------------------------------------------------------*  01470008
024800 U100-UPDATE-TAPCNTL.                                             01480008
024900     EXEC SQL                                                     01490008
025000         UPDATE TAPCNTL                                           01500008
025100         SET NEXT_AP_DOC_NBR = :APCNTL-NEXT-AP-DOC-NBR            01510008
025200         WHERE NEXT_AP_DOC_NBR > ' '                              01520008
025300     END-EXEC.                                                    01530008
025400     EVALUATE TRUE                                                01540008
025500         WHEN SQLCODE = +0                                        01550008
025600             MOVE SPACES                 TO WS151-ERROR-MESSAGE   01550111
025700             SET WS151-SUCCESSFUL-CALL   TO TRUE                  01551012
025800         WHEN SQLCODE = -904                                      01560008
025900         WHEN SQLCODE = -913                                      01570008
026000             CONTINUE                                             01580008
026100         WHEN SQLWARN0 NOT = SPACES                               01590008
026200         WHEN SQLCODE < +0                                        01600008
026300         WHEN SQLCODE > +0                                        01610008
026400             MOVE 'ERROR UPDATE TAPCNTL' TO WS151-ERROR-MESSAGE   01611011
026500             SET WS151-ERRORS-FOUND      TO TRUE                  01612011
027200     END-EVALUATE.                                                01680008
027300     MOVE SQLCODE                        TO WS151-SQLCODE.        01681011
027400     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES-DOC-NBR                01690008
027500         MOVE ZERO                       TO WS151-SQLCODE         01690111
027600         MOVE 'TAPCNTL TABLE BUSY'       TO WS151-ERROR-MESSAGE   01690211
027700         SET WS151-ERRORS-FOUND          TO TRUE                  01691011
028500     END-IF.                                                      01770008
028600 EJECT                                                            01780008
028700                                                                  01790008
028800*--------------------------------------------------------------*  01800008
028900*  OPENS THE UPDATE CURSOR                                     *  01810008
029000*--------------------------------------------------------------*  01820008
029100 Y100-OPEN-UPD-CSR.                                               01830008
029200     PERFORM                                                      01840008
029300        WITH TEST AFTER                                           01850008
029400          VARYING PV-RETRY-COUNTER                                01860008
029500             FROM 1 BY 1                                          01870008
029600            UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES-DOC-NBR)    01880008
029700                   OR (SQLCODE = ZERO))                           01890008
029800                                                                  01900008
029900          EXEC SQL                                                01910008
030000              OPEN UPD_CSR                                        01920008
030100          END-EXEC                                                01930008
030200          EVALUATE TRUE                                           01940008
030300              WHEN SQLCODE = ZERO                                 01950008
030400                  SET WS151-SUCCESSFUL-CALL TO TRUE               01960012
030500              WHEN SQLCODE NOT ZERO                               01970008
030600                  MOVE 'ERROR OPENING UPD-CSR'                    01971011
030700                                           TO WS151-ERROR-MESSAGE 01972011
030800                  SET WS151-ERRORS-FOUND   TO TRUE                01973011
031500          END-EVALUATE                                            02040008
031600     END-PERFORM.                                                 02050008
031700     MOVE SQLCODE                          TO WS151-SQLCODE.      02051011
031800 EJECT                                                            02060008
031900                                                                  02070008
032000*--------------------------------------------------------------*  02080008
032100*  CLOSES THE UPDATE CURSOR                                    *  02090008
032200*--------------------------------------------------------------*  02100008
032300 Y200-CLOSE-UPD-CSR.                                              02110008
032400     EXEC SQL                                                     02120008
032500          CLOSE UPD_CSR                                           02130008
032600     END-EXEC.                                                    02140008
032700     EVALUATE TRUE                                                02150008
032800         WHEN SQLCODE = ZERO                                      02160008
032900             SET WS151-SUCCESSFUL-CALL     TO TRUE                02170012
033000         WHEN OTHER                                               02180008
033100             MOVE 'ERROR CLOSING UPD-CSR'  TO WS151-ERROR-MESSAGE 02181011
033200             SET WS151-ERRORS-FOUND        TO TRUE                02182011
033900     END-EVALUATE.                                                02250008
034000     MOVE SQLCODE                          TO WS151-SQLCODE.      02251011
034100 EJECT                                                            02260008
                                                                        02270008
      *--------------------------------------------------------------*  02270008
      *  DOES A COMMIT                                               *  02270008
      *--------------------------------------------------------------*  02270008
        Y300-DB2-COMMIT.                                                02270008
            EXEC SQL                                                    02270008
                COMMIT                                                  02270008
            END-EXEC.                                                   02270008
            EVALUATE TRUE                                               02270008
               WHEN SQLCODE = ZEROS                                     02270008
                   SET WS151-SUCCESSFUL-CALL     TO TRUE                02270008
               WHEN OTHER                                               02270008
                   MOVE 'UNSUCCESSFUL COMMIT'    TO WS151-ERROR-MESSAGE 02270008
                   SET WS151-ERRORS-FOUND        TO TRUE                02270008
            END-EVALUATE.                                               02270008
            MOVE SQLCODE                          TO WS151-SQLCODE.             
       EJECT.                                                           02270008
