000100 TITLE 'SELECT VIOLATION EXTRACTS'.                                       
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    SUKUT069.                                                 
000400 AUTHOR.        DENNIS STEFFEN.                                           
000500 DATE-WRITTEN.  MARCH 2002.                                               
000600 ENVIRONMENT DIVISION.                                                    
000700 INPUT-OUTPUT SECTION.                                                    
000800                                                                          
000900 FILE-CONTROL.                                                            
001000     SELECT OLD-AUDIT-EXTRACT-FILE      ASSIGN TO INP01.                  
001100     SELECT NEW-AUDIT-EXTRACT-FILE      ASSIGN TO OUT01.                  
001200                                                                          
001300 DATA DIVISION.                                                           
001400 FILE SECTION.                                                            
001500                                                                          
001600                                                                          
001700 FD  OLD-AUDIT-EXTRACT-FILE                                               
001800     RECORDING MODE IS F                                                  
001900     LABEL RECORDS ARE STANDARD                                           
002000     RECORD CONTAINS 150                                                  
002100     BLOCK CONTAINS 0 RECORDS                                             
002200     DATA RECORD IS OLD-AUDIT-EXTRACT-RECORD.                             
002300 01  OLD-AUDIT-EXTRACT-RECORD         PIC X(150).                         
002400                                                                          
002500 FD  NEW-AUDIT-EXTRACT-FILE                                               
002600     RECORDING MODE IS F                                                  
002700     LABEL RECORDS ARE STANDARD                                           
002800     RECORD CONTAINS 150                                                  
002900     BLOCK CONTAINS 0 RECORDS                                             
003000     DATA RECORD IS NEW-AUDIT-EXTRACT-RECORD.                             
003100 01  NEW-AUDIT-EXTRACT-RECORD         PIC X(150).                         
003200                                                                          
003300 WORKING-STORAGE SECTION.                                                 
003400                                                                          
003500 01  PV-ABEND-CODE                    PIC S9(04)   VALUE ZERO             
003600                                                   COMP SYNC.             
003700                                                                          
003800 01  PS-PROGRAM-SWITCHES.                                                 
003900     05  PS-END-EXTRACT-SW            PIC X(1)   VALUE 'N'.               
004000         88  PS-END-EXTRACT                      VALUE 'Y'.               
004300                                                                          
004400                                                                          
004500 01  PV-PROGRAM-VARIABLES.                                                
004700                                                                          
004800     05  PV-PARAGRAPH-NAME            PIC X(30)   VALUE SPACES.           
004900     05  PV-ERROR-MESSAGE-1           PIC X(60)   VALUE SPACES.           
005000     05  PV-ERROR-MESSAGE-2           PIC X(60)   VALUE SPACES.           
005010     05  PV-TMST                      PIC X(26)   VALUE SPACES.           
005100     05  PV-SQLCODE                   PIC 9(9)    VALUE ZERO.             
005700     05  PV-DISP-NBR                  PIC Z(8)9.                          
006200     05  PV-AUDIT-DURATION            PIC S9(9) COMP-3 VALUE ZERO.        
006300                                                                          
006400 01  PV-COUNTERS COMP-3.                                                  
006500     05  PV-READ-COUNT                PIC S9(9)    VALUE ZERO.            
006600     05  PV-WRITE-COUNT               PIC S9(9)    VALUE ZERO.            
006700     05  PV-SKIP-COUNT                PIC S9(9)    VALUE ZERO.            
006800                                                                          
006900 01  PC-PROGRAM-CONSTANTS.                                                
007000     05  PC-PROGRAM-NAME              PIC X(08)  VALUE 'SUKUT069'.        
                                                                                
007300 01  PV-ABEND-FIELDS.                                                     
007400     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'SUKUT069'.        
007500     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.            
007600     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.            
007700     05  PV-ABEND-STRUCTURE-1         PIC X(15)  VALUE SPACES.            
007800     05  PV-ABEND-STRUCTURE-2         PIC X(15)  VALUE SPACES.            
007900     05  PV-ABEND-STRUCTURE-3         PIC X(15)  VALUE SPACES.            
008000     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.            
008100     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.            
008200     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.            
008300     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.            
008400     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.            
008500                                                                          
008600/                                                                         
008700*    VENDOR VIOLATION EXTRACT                                             
008900     COPY SURD033.                                                        
009000                                                                          
009400*    DATE CONTROL CARD                                                    
009500     COPY SURD032.                                                        
009700/                                                                         
010300*  USED FOR DB2 ERROR MESSAGE BUILDING                                    
010400     COPY DPWS004.                                                        
010500                                                                          
010600*   DB2 SQL COMMUNICATION AREA                                            
010700     EXEC SQL                                                             
010800          INCLUDE SQLCA                                                   
010900     END-EXEC.                                                            
011000/                                                                         
011100 PROCEDURE DIVISION.                                                      
011200                                                                          
011300     PERFORM 1000-INIT.                                                   
011400                                                                          
011500     PERFORM 2000-PROCESS UNTIL PS-END-EXTRACT.                           
011600                                                                          
011700     PERFORM 9000-TERMINATE.                                              
011800                                                                          
011900     GOBACK.                                                              
012000                                                                          
012100 1000-INIT.                                                               
012200                                                                          
012300     OPEN INPUT  OLD-AUDIT-EXTRACT-FILE                                   
012400          OUTPUT NEW-AUDIT-EXTRACT-FILE                                   
012500                                                                          
012600     ACCEPT SU032-DATE-CONTROL-REC FROM SYSIN                             
012601     DISPLAY SPACES                                                       
012602     DISPLAY 'DATE CONTROL RECORD:'                                       
012603     DISPLAY SU032-DATE-CONTROL-REC                                       
012604                                                                          
012610     EXEC SQL                                                             
012620         SET :PV-TMST = CURRENT TIMESTAMP                                 
012630     END-EXEC                                                             
012700                                                                          
012800     PERFORM 8000-READ-OLD-AUDIT-REC.                                     
012900                                                                          
013000 2000-PROCESS.                                                            
013100                                                                          
013221     EVALUATE TRUE                                                        
013230     WHEN SU033-WEEK-END-DATE <  SU032-FROM-DATE                          
013240     WHEN SU033-WEEK-END-DATE >  SU032-TO-DATE                            
013241         ADD 1                        TO PV-SKIP-COUNT                    
013260     WHEN OTHER                                                           
013400         PERFORM 8100-WRITE-EXTRACT-REC                                   
013410     END-EVALUATE.                                                        
013500                                                                          
013600     PERFORM 8000-READ-OLD-AUDIT-REC.                                     
013700/                                                                         
026100 8000-READ-OLD-AUDIT-REC.                                                 
026200                                                                          
026300     READ OLD-AUDIT-EXTRACT-FILE INTO                                     
026400           SU033-RECORD                                                   
026500     AT END                                                               
026600         SET PS-END-EXTRACT           TO TRUE                             
026700     NOT AT END                                                           
026800         ADD 1                        TO PV-READ-COUNT                    
026900     END-READ.                                                            
027000                                                                          
027100 8100-WRITE-EXTRACT-REC.                                                  
027200                                                                          
027300     ADD 1                         TO PV-WRITE-COUNT                      
027400                                                                          
027500     WRITE NEW-AUDIT-EXTRACT-RECORD FROM SU033-RECORD.                    
027600/                                                                         
027700 9000-TERMINATE.                                                          
027800                                                                          
027900     CLOSE OLD-AUDIT-EXTRACT-FILE                                         
028000           NEW-AUDIT-EXTRACT-FILE                                         
028100                                                                          
028200     DISPLAY '************************'.                                  
028300     DISPLAY '******* SUKUT069 *******'.                                  
028400     DISPLAY '************************'.                                  
028500     DISPLAY SPACES                                                       
028600                                                                          
028700     MOVE PV-READ-COUNT               TO PV-DISP-NBR                      
028800     DISPLAY 'OLD AUDIT EXTRACTS READ      = ' PV-DISP-NBR                
028900                                                                          
029000     MOVE PV-WRITE-COUNT              TO PV-DISP-NBR                      
029100     DISPLAY 'SELECTED EXTRACTS WRITTEN    = ' PV-DISP-NBR                
029110     MOVE PV-SKIP-COUNT               TO PV-DISP-NBR                      
029120     DISPLAY 'RECORDS SKIPPED              = ' PV-DISP-NBR                
029200                                                                          
029300     DISPLAY SPACES                                                       
029400     DISPLAY '************************'.                                  
029500                                                                          
029600*9900-DB2-ABEND.                                                          
029700*                                                                         
029800*    MOVE SQLCODE TO PV-SQLCODE.                                          
029900*    DISPLAY '*** DB2 ERROR '.                                            
030000*    DISPLAY '*** SQLCODE   = ' PV-SQLCODE.                               
030100*    DISPLAY '*** PROGRAM   = ' PV-ABEND-PROGRAM.                         
030200*    DISPLAY '*** PARAGRAPH = ' PV-ABEND-PARAGRAPH.                       
030300*    DISPLAY '*** OPERATION = ' PV-ABEND-OPERATION.                       
030400*    DISPLAY '*** MESSAGE   = ' PV-DB2-OPERATION-MESSAGE-1.               
030500*    DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-2.               
030600*    DISPLAY '***           = ' PV-DB2-OPERATION-MESSAGE-3.               
030700*    DISPLAY '*** TABLE 1   = ' PV-ABEND-STRUCTURE-1.                     
031000*    DISPLAY '*** TABLE 2   = ' PV-ABEND-STRUCTURE-2                      
031200*                                                                         
031300*                                                                         
031400*    COPY DPPD004.                                                        
031500*                                                                         
031600*    MOVE +4013                  TO PV-ABEND-CODE.                        
031700*    CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
031800                                                                          
031900*9200-ABEND.                                                              
032000******************************************************************        
032100*  PERFORMS A NON-SQL ABEND FOR THE PROGRAM                               
032200******************************************************************        
032300*    DISPLAY '***************************'.                               
032400*    DISPLAY '**       ABEND           **'.                               
032500*    DISPLAY '**  IN PROGRAM SUKUT069  **'.                               
032600*    DISPLAY '***************************'.                               
032700*    DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.                
032800*    DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-1.               
032900*    DISPLAY '**                 ** = ' PV-ERROR-MESSAGE-2.               
033000*                                                                         
033100*    MOVE +4014                  TO PV-ABEND-CODE.                        
033200*    CALL 'ILBOABN0' USING PV-ABEND-CODE.                                 
033300                                                                          
