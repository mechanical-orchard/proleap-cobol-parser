000100******************************************************************00010007
000200 IDENTIFICATION DIVISION.                                         00020007
000300******************************************************************00030007
000400                                                                  00040007
000500 PROGRAM-ID.             SVKUT001.                                00050007
000600 AUTHOR.                 DAVE MUSKAT - COMPUWARE.                 00060007
000700 INSTALLATION.           KOHLS.                                   00070007
000800 DATE-WRITTEN            NOVEMBER 1998.                           00080007
000900 DATE-COMPILED.                                                   00090007
001000                                                                  00100007
001100******************************************************************00110007
001200*   THIS PROGRAM READS AN INPUT FILE OF STORED VALUE (SV) CARD    00120007
001300*   DATA EXTRACTED FROM DB2 TABLE SVT_KOHLS_CRD_TXN.  THE EXTRACT 00130007
001400*   FILE CONTAINS BOTH "ISSUANCE" RECORDS AND "TENDER" RECORDS FOR00140007
001500*   EACH STORED VALUE CARD PRESENT ON THE DATABASE.               00150007
001600*                                                                 00160007
001700*   EACH CARD IS REPRESENTED ON THE FILE BY ONE "ISSUANCE" RECORD 00170007
001800*   CONTAINING THE POSITIVE DOLLAR AMOUNT OF THE CARD AT THE TIME 00180007
001900*   IT WAS ISSUED. IF ANY TENDER ACTIVITY HAS OCCURED ON THE CARD,00190007
002000*   EACH SUCH TRANSACTION IS REPRESENTED ON THE FILE BY A "TENDER"00200007
002100*   RECORD CONTAINING THE NEGATIVE DOLLAR AMOUNT TENDERED DURING  00210007
002200*   THE TRANSACTION.  THE EXTRACT FILE IS ORDERED SO THAT A CARD'S00220007
002300*   "ISSUANCE" RECORD WILL BE READ BEFORE ANY OF ITS "TENDER"     00230007
002400*   RECORDS.                                                      00240007
002500*                                                                 00250007
002600*   FOR EACH "ISSUANCE" RECORD READ, THIS PROGRAM QUERIES DB2     00260007
002700*   FOR ADDITIONAL DATA SUCH AS TYPE OF CARD AND CARD STATUS.     00270007
002800*                                                                 00280007
002900*   FOR EACH INPUT RECORD READ, AN OUTPUT ACTIVITY RECORD IS      00290007
003000*   WRITTEN CONTAINING DATA FROM BOTH THE INPUT RECORD AND DB2.   00300007
003100*   THE OUTPUT RECORDS WILL BE USED BY PROGRAMS THAT PRODUCE      00310007
003200*   STORED VALUE AGING REPORTS.                                   00320007
003300*                                                                 00330007
003400*   A CONTROL CARD IS READ CONTAINING THE FISCAL MONTH-ENDING     00340007
003500*   DATE.  CALENDAR ROUTINE DPKUT500 IS CALLED TO VERIFY THE DATE 00350007
003600*   AS A VALID FISCAL MONTH-END DATE.                             00360007
003700******************************************************************00370007
002100*----------------------------------------------------------------*00380007
069303* CHANGE ID     : CHG0069303                                      00390007
069303* AUTHOR        : COGNIZANT                                       00400007
069303* DATE  CHANGED : 2013-01-06                                      00410007
069303* CHANGES MADE  : CHANGED THE TABLE OCCURRENCE FROM 100 TO 300    00420007
069303*                 FOR TABLE PV-ISSUE-TABLE                        00430007
069303*----------------------------------------------------------------*00440007
069303* CHANGE ID     : CHG0260667                                      00441008
069303* AUTHOR        : SRINIVASAN SIVARAJ                              00442008
069303* DATE  CHANGED : 2021-08-30                                      00443008
069303* CHANGES MADE  : CHANGED THE TABLE OCCURRENCE FROM 999 TO 9999   00444008
069303*                 FOR TABLE PV-ISSUE-TABLE                        00445008
069303*----------------------------------------------------------------*00446008
003800 ENVIRONMENT DIVISION.                                            00450007
003900                                                                  00460007
004000 CONFIGURATION SECTION.                                           00470007
004100                                                                  00480007
004200 SOURCE-COMPUTER.        IBM-3090.                                00490007
004300 OBJECT-COMPUTER.        IBM-3090.                                00500007
004400                                                                  00510007
004500 INPUT-OUTPUT SECTION.                                            00520007
004600                                                                  00530007
004700 FILE-CONTROL.                                                    00540007
004800                                                                  00550007
004900     SELECT EXTRACT-FILE                                          00560007
005000         ASSIGN TO INP01.                                         00570007
005100                                                                  00580007
005200     SELECT DATE-CARD-FILE                                        00590007
005300         ASSIGN TO INP02.                                         00600007
005400                                                                  00610007
005500     SELECT STOCK-FILE                                            00620007
005600         ASSIGN TO INP03.                                         00630007
005700                                                                  00640007
005800     SELECT ACTIVITY-FILE                                         00650007
005900         ASSIGN TO OUT01.                                         00660007
006000                                                                  00670007
006100******************************************************************00680007
006200 DATA DIVISION.                                                   00690007
006300******************************************************************00700007
006400                                                                  00710007
006500 FILE SECTION.                                                    00720007
006600                                                                  00730007
006700 FD  EXTRACT-FILE                                                 00740007
006800     RECORDING MODE IS F                                          00750007
006900     BLOCK CONTAINS 0 RECORDS                                     00760007
007000     LABEL RECORDS ARE STANDARD.                                  00770007
007100                                                                  00780007
007200 01  EXTRACT-RECORD                         PIC X(45).            00790007
007300                                                                  00800007
007400 FD  DATE-CARD-FILE                                               00810007
007500     RECORDING MODE IS F                                          00820007
007600     BLOCK CONTAINS 0 RECORDS                                     00830007
007700     LABEL RECORDS ARE STANDARD.                                  00840007
007800                                                                  00850007
007900 01  DATE-CARD-RECORD                       PIC X(80).            00860007
008000                                                                  00870007
008100 FD  STOCK-FILE                                                   00880007
008200     RECORDING MODE IS F                                          00890007
008300     BLOCK CONTAINS 0 RECORDS                                     00900007
008400     LABEL RECORDS ARE STANDARD.                                  00910007
008500                                                                  00920007
008600 01  STOCK-RECORD                           PIC X(47).            00930007
008700                                                                  00940007
008800 FD  ACTIVITY-FILE                                                00950007
008900     RECORDING MODE IS F                                          00960007
009000     BLOCK CONTAINS 0 RECORDS                                     00970007
009100     LABEL RECORDS ARE STANDARD.                                  00980007
009200                                                                  00990007
009300 01  ACTIVITY-RECORD                        PIC X(125).           01000007
009400******************************************************************01010007
009500 WORKING-STORAGE SECTION.                                         01020007
009600******************************************************************01030007
009700  01  FILLER                           PIC X(50) VALUE            01040007
009800      ' *** WORKING STORAGE STARTS HERE FOR SVKUT001 *** '.       01050007
009900                                                                  01060007
010000******************************************************************01070007
010100* RECORD LAYOUT FOR INPUT EXTRACT FILE                            01080007
010200******************************************************************01090007
010300     COPY SVRD034.                                                01100007
010400******************************************************************01110007
010500* RECORD LAYOUT FOR INPUT DATE CARD (FISCAL MONTH-END DATE)       01120007
010600******************************************************************01130007
010700  01  CC-CONTROL-CARD.                                            01140007
010800      05  CC-REPORT-TYPE               PIC X(01) VALUE SPACE.     01150007
010900      05  CC-MONTH-END-CCYY-MM-DD      PIC X(10) VALUE SPACES.    01160007
011000      05  FILLER                       PIC X(69) VALUE SPACES.    01170007
011100                                                                  01180007
011200******************************************************************01190007
011300* RECORD LAYOUT FOR STOCK RECORD                                  01200007
011400******************************************************************01210007
011500     COPY SVRD013.                                                01220007
011600******************************************************************01230007
011700* RECORD LAYOUT FOR OUTPUT ACTIVITY FILE                          01240007
011800******************************************************************01250007
011900     COPY SVRD036.                                                01260007
012000******************************************************************01270007
012100*  PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)             01280007
012200******************************************************************01290007
012300     COPY DPWS500.                                                01300007
012400                                                                  01310007
012500 01  ABEND-CODE                          PIC S9(04)  VALUE ZERO   01320007
012600                                                     COMP SYNC.   01330007
012700     88  AC-CONTROL-CARD-ERROR                       VALUE +4003. 01340007
012800     88  AC-TABLE-OVERFLOW                           VALUE +4004. 01350007
012900     88  AC-INVALID-DATA-ERROR                       VALUE +4008. 01360007
013000     88  AC-CALENDAR-ROUTINE-ERROR                   VALUE +4019. 01370007
013100                                                                  01380007
013200 01  PV-PROGRAM-VARIABLES.                                        01390007
013300     05  PV-PARAGRAPH-NAME               PIC  X(30)  VALUE SPACE. 01400007
013400     05  PV-DB2-OPERATION-ATTEMPTED      PIC  X(30)  VALUE SPACE. 01410007
013500     05  PV-OPERATION-MSG-1              PIC  X(40)  VALUE SPACE. 01420007
013600     05  PV-OPERATION-MSG-2              PIC  X(40)  VALUE SPACE. 01430007
013700     05  PV-CRD-NBR                      PIC S9(12)  COMP-3       01440007
013800                                                     VALUE ZERO.  01450007
013900     05  PV-ACTVY-TYP-CDE                PIC S9(01)  COMP-3       01460007
014000                                                     VALUE ZERO.  01470007
014100     05  PV-APP-AUTH-AMT                 PIC S9(07)V9(02)         01480007
014200                                                     COMP-3       01490007
014300                                                     VALUE ZERO.  01500007
014400     05  PV-ISSUE-TIMESTAMP              PIC  X(26)  VALUE SPACE. 01510007
014500     05  PV-ISSUE-STR-NBR                PIC S9(04)  COMP         01520007
014600                                                     VALUE ZERO.  01530007
014700     05  PV-TENDER-TIMESTAMP             PIC  X(26)  VALUE SPACE. 01540007
014800     05  PV-CRD-STAT-CDE                 PIC  X(02)  VALUE SPACE. 01550007
014900     05  PV-CRD-TYP-CDE                  PIC S9(01)  VALUE ZERO   01560007
015000                                                     COMP-3.      01570007
015100     05  PV-CRD-STK-TYP-ID               PIC  X(08)  VALUE SPACE. 01580007
015200     05  PV-CRD-STK-TYP-DESC             PIC  X(25)  VALUE SPACE. 01590007
015300     05  PV-TRN-VOID-IND                 PIC  X(01)  VALUE SPACE. 01600007
015400     05  PV-INPUT-CNT                    PIC S9(09)  COMP-3       01610007
015500                                                     VALUE ZERO.  01620007
015600     05  PV-OUTPUT-CNT                   PIC S9(09)  COMP-3       01630007
015700                                                     VALUE ZERO.  01640007
015800     05  PV-BALANCE-NEEDED               PIC S9(04)V99 COMP-3     01650007
015900                                                     VALUE ZERO.  01660007
016000     05  PV-HOLD-BALANCE-NEEDED          PIC S9(04)V99 COMP-3     01670007
016100                                                     VALUE ZERO.  01680007
016200     05  PV-ISSUE-CNT                    PIC S9(09)  COMP-3       01690007
016300                                                     VALUE ZERO.  01700007
016400     05  PV-TND-CNT                      PIC S9(09)  COMP-3       01710007
016500                                                     VALUE ZERO.  01720007
016600     05  PV-FEE-CNT                      PIC S9(09)  COMP-3       01730007
016700                                                     VALUE ZERO.  01740007
016800     05  PV-FISCAL-MONTH-END-DATE.                                01750007
016900         10  PV-FISCAL-CCYY-MM-DD        PIC X(10).               01760007
017000         10  FILLER                      PIC X(16)   VALUE        01770007
017100                                               '-99.99.99.999999'.01780007
017200                                                                  01790007
017300     05  PV-ACTVY-STAT-CDE               PIC S9(01)  COMP-3       01800007
017400                                                     VALUE ZERO.  01810007
017500     05  PV-TENDER-STR-NBR               PIC S9(04)  COMP         01820007
017600                                                     VALUE ZERO.  01830007
017700     05  PV-SUB                          PIC S9(03)  VALUE ZERO.  01840007
017800     05  PV-BAL-SUB1                     PIC S9(04)  VALUE ZERO.  01850007
017900     05  PV-BAL-SUB2                     PIC S9(03)  VALUE ZERO.  01860007
018000     05  PV-MAX-STORE                    PIC  9(01)  VALUE ZERO.  01870007
018100     05  PV-STORE-NBR                    PIC S9(04)  COMP         01880007
018200                                                     VALUE ZERO.  01890007
018300     05  PV-ECOMM-STORES OCCURS 5 TIMES.                          01900007
018400         10   PV-ECOMM-STR               PIC S9(04)  COMP         01910007
018500                                                     VALUE ZERO.  01920007
018600     05  PV-ISSUE-TABLE.                                          01930007
069303         10  PV-ISS-TBL OCCURS 9999 TIMES.                        01940007
018800             15  PV-CRD-NUMBER           PIC 9(12).               01950007
018900             15  PV-ISSUE-TIMESTMP       PIC X(26).               01960007
019000             15  PV-ISSUE-STORE          PIC 9(05).               01970007
019100             15  PV-ISSUE-AMOUNT         PIC S9(09)V99.           01980007
019200             15  PV-ISSUE-BALANCE        PIC S9(09)V99.           01990007
019300                                                                  02000007
019400 01  PS-PROGRAM-SWITCHES.                                         02010007
019500     05  PS-END-OF-CARD-FILE-SW          PIC X(01)   VALUE 'N'.   02020007
019600         88  PS-END-OF-CARD-FILE                     VALUE 'Y'.   02030007
019700     05  PS-END-OF-EXTRACT-FILE-SW       PIC X(01)   VALUE 'N'.   02040007
019800         88  PS-END-OF-EXTRACT-FILE                  VALUE 'Y'.   02050007
019900     05  PS-SUB-ISSUE-SW                 PIC X(01)   VALUE 'N'.   02060007
020000         88  PS-SUB-ISSUE                            VALUE 'Y'.   02070007
020100         88  PS-NOT-SUB-ISSUE                        VALUE 'N'.   02080007
020200     05  PS-STOCK-FOUND-SW               PIC X(01)   VALUE 'N'.   02090007
020300         88  PS-STOCK-NOT-FOUND                      VALUE 'N'.   02100007
020400         88  PS-STOCK-FOUND                          VALUE 'Y'.   02110007
020500     05  PS-WRITE-SW                     PIC X(01)   VALUE 'N'.   02120007
020600         88  PS-DONT-WRITE                           VALUE 'N'.   02130007
020700         88  PS-WRITE                                VALUE 'Y'.   02140007
020800     05  PS-END-OF-STOCK-SW              PIC X(01)   VALUE 'N'.   02150007
020900         88  PS-END-OF-STOCK                         VALUE 'Y'.   02160007
021000     05  PS-END-OF-XSTR-CSR-SW           PIC X(01)   VALUE 'N'.   02170007
021100         88  PS-NOT-END-OF-XSTR-CSR                  VALUE 'N'.   02180007
021200         88  PS-END-OF-XSTR-CSR                      VALUE 'Y'.   02190007
021300     05  PS-ECOMM-STR-SW                 PIC X(01)   VALUE 'N'.   02200007
021400         88  PS-ECOMM-STR                            VALUE 'Y'.   02210007
021500         88  PS-NOT-ECOMM-STR                        VALUE 'N'.   02220007
021600     05  PS-ZERO-BALANCE-SW              PIC X(01)   VALUE 'N'.   02230007
021700         88  PS-ZERO-BALANCE                         VALUE 'Y'.   02240007
021800         88  PS-NOT-ZERO-BALANCE                     VALUE 'N'.   02250007
021900     05  PS-ZERO-MONEY-NEEDED-SW         PIC X(01)   VALUE 'N'.   02260007
022000         88  PS-ZERO-MONEY-NEEDED                    VALUE 'Y'.   02270007
022100         88  PS-DONOT-ZERO-MONEY-NEEDED              VALUE 'N'.   02280007
022200     05  PS-NO-MORE-ISSUE-SW             PIC X(01)   VALUE 'N'.   02290007
022300         88  PS-NO-MORE-ISSUE                        VALUE 'Y'.   02300007
022400         88  PS-MORE-ISSUE                           VALUE 'N'.   02310007
022500                                                                  02320007
022600 01  PC-PROGRAM-CONSTANTS.                                        02330007
022700     05 PC-CURRENT-PROGRAM-NAME          PIC X(08)   VALUE        02340007
022800                                                     'SVKUT001'.  02350007
022900******************************************************************02360007
023000*  COPYBOOK OF MERCHANDISE CARD CONSTANTS                         02370007
023100******************************************************************02380007
023200     COPY SVWS004.                                                02390007
023300                                                                  02400007
023400******************************************************************02410007
023500*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *02420007
023600******************************************************************02430007
023700     COPY DPWS004.                                                02440007
023800                                                                  02450007
023900******************************************************************02460007
024000*       KOHL'S DOMAIN LOCATION TABLE                             *02470007
024100******************************************************************02480007
024200     EXEC SQL                                                     02490007
024300         INCLUDE XST00001                                         02500007
024400     END-EXEC.                                                    02510007
024500                                                                  02520007
024600******************************************************************02530007
024700*    STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA              *02540007
024800******************************************************************02550007
024900     EXEC SQL                                                     02560007
025000         INCLUDE SQLCA                                            02570007
025100     END-EXEC.                                                    02580007
025200                                                                  02590007
025300     COPY SQLCA2.                                                 02600007
025400                                                                  02610007
025500******************************************************************02620007
025600*    CURSOR TO EXTRACT ALL ECOMMERCE STORE NUMBERS FROM LOC TABLE*02630007
025700******************************************************************02640007
025800     EXEC SQL                                                     02650007
025900        DECLARE XSTR-CSR CURSOR FOR                               02660007
026000            SELECT LOC_NBR                                        02670007
026100              FROM XST_LOC                                        02680007
026200             WHERE E_BUS_IND   = 'Y'                              02690007
026300               AND LOC_TYP_CDE = 'DS'                             02700007
026400            WITH UR                                               02710007
026500     END-EXEC.                                                    02720007
026600                                                                  02730007
026700 PROCEDURE DIVISION.                                              02740007
026800******************************************************************02750007
026900*  0000-MAINLINE  -  MAIN LINE OF THE PROGRAM                     02760007
027000*                                                                 02770007
027100******************************************************************02780007
027200 0000-MAINLINE.                                                   02790007
027300                                                                  02800007
027400     PERFORM 1000-INITIALIZE-PROGRAM.                             02810007
027500     PERFORM 2000-PROCESS-EXTRACT-RECORDS                         02820007
027600         UNTIL PS-END-OF-EXTRACT-FILE.                            02830007
027700                                                                  02840007
027800     CLOSE ACTIVITY-FILE                                          02850007
027900           STOCK-FILE                                             02860007
028000           EXTRACT-FILE.                                          02870007
028100                                                                  02880007
028200     DISPLAY 'RECORDS READ     -  ' PV-INPUT-CNT.                 02890007
028300     DISPLAY 'RECORDS WRITTEN  -  ' PV-OUTPUT-CNT.                02900007
028400                                                                  02910007
028500     STOP RUN.                                                    02920007
028600                                                                  02930007
028700******************************************************************02940007
028800* 1000-INITIALIZE-PROGRAM                                         02950007
028900* OPEN FILES, GET CONTROL CARD, DO PRIME READ OF EXTRACT FILE.    02960007
029000******************************************************************02970007
029100 1000-INITIALIZE-PROGRAM.                                         02980007
029200                                                                  02990007
029300     OPEN INPUT  DATE-CARD-FILE                                   03000007
029400          INPUT  EXTRACT-FILE                                     03010007
029500          INPUT  STOCK-FILE                                       03020007
029600          OUTPUT ACTIVITY-FILE.                                   03030007
029700                                                                  03040007
029800     PERFORM 1100-PROCESS-CONTROL-CARD.                           03050007
029900     PERFORM 1200-OPEN-XSTR-CSR.                                  03060007
030000     PERFORM 1210-FETCH-XSTR-CSR UNTIL PS-END-OF-XSTR-CSR.        03070007
030100     PERFORM 1220-CLOSE-XSTR-CSR.                                 03080007
030200     PERFORM 7000-READ-EXTRACT-FILE.                              03090007
030300     INITIALIZE SV013-STOCK-RECORD.                               03100007
030400                                                                  03110007
030500******************************************************************03120007
030600* 1100-PROCESS-CONTROL-CARD                                       03130007
030700* READ DATE CONTROL CARD AND VALIDATE FISCAL MONTH-END DATE.      03140007
030800* IF VALID, FORMAT FISCAL MONTH-END DATE TIMESTAMP FOR COMPARISON.03150007
030900******************************************************************03160007
031000                                                                  03170007
031100 1100-PROCESS-CONTROL-CARD.                                       03180007
031200                                                                  03190007
031300     PERFORM 1110-READ-DATE-CARD-FILE.                            03200007
031400     CLOSE DATE-CARD-FILE.                                        03210007
031500     IF PS-END-OF-CARD-FILE                                       03220007
031600         MOVE '1100-PROCESS-CONTROL-CARD'  TO PV-PARAGRAPH-NAME   03230007
031700         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  03240007
031800         SET AC-CONTROL-CARD-ERROR TO TRUE                        03250007
031900         PERFORM 9999-ABEND                                       03260007
032000     END-IF.                                                      03270007
032100                                                                  03280007
032200     PERFORM 1120-VALIDATE-CONTROL-CARD.                          03290007
032300                                                                  03300007
032400     MOVE CC-MONTH-END-CCYY-MM-DD TO PV-FISCAL-CCYY-MM-DD.        03310007
032500                                                                  03320007
032600******************************************************************03330007
032700* 1110-READ-DATE-CARD-FILE                                        03340007
032800* READ DATE CONTROL CARD.                                         03350007
032900******************************************************************03360007
033000                                                                  03370007
033100 1110-READ-DATE-CARD-FILE.                                        03380007
033200     READ DATE-CARD-FILE INTO CC-CONTROL-CARD                     03390007
033300        AT END                                                    03400007
033400           SET PS-END-OF-CARD-FILE TO TRUE.                       03410007
033500                                                                  03420007
033600******************************************************************03430007
033700* 1120-VALIDATE-CONTROL-CARD                                      03440007
033800* CALL KOHLS CALENDAR ROUTINE TO VERIFY THE CONTROL CARD DATA     03450007
033900* IS A VALID FISCAL MONTH-END DATE.                               03460007
034000******************************************************************03470007
034100                                                                  03480007
034200 1120-VALIDATE-CONTROL-CARD.                                      03490007
034300                                                                  03500007
034400     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              03510007
034500                                                                  03520007
034600     SET DPG51-FISCAL-454-CALENDAR     TO TRUE.                   03530007
034700     SET DPG51-DO-NOT-INCR-DECR-DATE   TO TRUE.                   03540007
034800                                                                  03550007
034900     MOVE CC-MONTH-END-CCYY-MM-DD      TO DPG52-LK-DATE-INPUT.    03560007
035000     SET DPG52-LK-DTE-ISO-FMT          TO TRUE.                   03570007
035100                                                                  03580007
035200     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03590007
035300                                             DPG54 DPG55 DPG56.   03600007
035400     EVALUATE TRUE                                                03610007
035500         WHEN DPG54-SEVERE-ERROR                                  03620007
035600         WHEN DPG54-DATE-INVALID                                  03630007
035700             MOVE '1120-VALIDATE-CONTROL-CARD'                    03640007
035800                                       TO PV-PARAGRAPH-NAME       03650007
035900             MOVE 'INVALID CONTROL FISCAL DATE'                   03660007
036000                                       TO PV-OPERATION-MSG-1      03670007
036100             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      03680007
036200             SET AC-CONTROL-CARD-ERROR TO TRUE                    03690007
036300             PERFORM 9999-ABEND                                   03700007
036400     END-EVALUATE.                                                03710007
036500                                                                  03720007
036600******************************************************************03730007
036700*    OPEN THE XST00001 CURSOR                                    *03740007
036800******************************************************************03750007
036900 1200-OPEN-XSTR-CSR.                                              03760007
037000     EXEC SQL                                                     03770007
037100         OPEN XSTR-CSR                                            03780007
037200     END-EXEC.                                                    03790007
037300     EVALUATE TRUE                                                03800007
037400        WHEN SQLCODE = ZERO                                       03810007
037500             CONTINUE                                             03820007
037600        WHEN OTHER                                                03830007
037700             MOVE '1200-OPEN-XSTR-CSR'                            03840007
037800                               TO PV-PARAGRAPH-NAME               03850007
037900             MOVE 'OPEN E STORE CURSOR - '                        03860007
038000                               TO PV-DB2-OPERATION-ATTEMPTED      03870007
038100             PERFORM Z900-SQL-ABEND                               03880007
038200     END-EVALUATE.                                                03890007
038300                                                                  03900007
038400******************************************************************03910007
038500*      1210-FETCH-XSTR-CSR                                       *03920007
038600* ==>  PROCESSES:                                                *03930007
038700*      - CHECK THE LOCATION DOMAIN TABLE FOR ECOMMERCE STORES    *03940007
038800******************************************************************03950007
038900 1210-FETCH-XSTR-CSR.                                             03960007
039000     EXEC SQL                                                     03970007
039100         FETCH XSTR-CSR                                           03980007
039200         INTO :XST00001-LOC-NBR                                   03990007
039300     END-EXEC.                                                    04000007
039400                                                                  04010007
039500     EVALUATE SQLCODE                                             04020007
039600         WHEN ZERO                                                04030007
039700             ADD +1 TO PV-SUB                                     04040007
039800             MOVE XST00001-LOC-NBR  TO PV-ECOMM-STR(PV-SUB)       04050007
039900         WHEN +100                                                04060007
040000             SET PS-END-OF-XSTR-CSR TO TRUE                       04070007
040100             MOVE PV-SUB            TO PV-MAX-STORE               04080007
040200         WHEN OTHER                                               04090007
040300             MOVE '1210-FETCH-XSTR-CSR'                           04100007
040400                                    TO PV-PARAGRAPH-NAME          04110007
040500             MOVE 'FETCH E STORE CURSOR - '                       04120007
040600                                    TO PV-DB2-OPERATION-ATTEMPTED 04130007
040700             PERFORM Z900-SQL-ABEND                               04140007
040800     END-EVALUATE.                                                04150007
040900                                                                  04160007
041000******************************************************************04170007
041100*      1220-CLOSE-XSTR-CSR                                       *04180007
041200* ==>  PROCESSES:                                                *04190007
041300*      - CLOSE THE E STORE CURSOR                                *04200007
041400******************************************************************04210007
041500 1220-CLOSE-XSTR-CSR.                                             04220007
041600     EXEC SQL                                                     04230007
041700         CLOSE XSTR-CSR                                           04240007
041800     END-EXEC.                                                    04250007
041900                                                                  04260007
042000     EVALUATE TRUE                                                04270007
042100         WHEN SQLCODE = ZERO                                      04280007
042200             CONTINUE                                             04290007
042300         WHEN OTHER                                               04300007
042400             MOVE '1220-CLOSE-XSTR-CSR'                           04310007
042500                                TO PV-PARAGRAPH-NAME              04320007
042600             MOVE 'CLOSE E STORE CURSOR - '                       04330007
042700                                TO PV-DB2-OPERATION-ATTEMPTED     04340007
042800             PERFORM Z900-SQL-ABEND                               04350007
042900     END-EVALUATE.                                                04360007
043000                                                                  04370007
043100******************************************************************04380007
043200* 2000-PROCESS-EXTRACT-RECORDS - MAIN PROCESS MODULE              04390007
043300* DETERMINE TYPE OF EXTRACT RECORD, PROCESS EXTRACT RECORD,       04400007
043400* CONTROL WRITING OF ACTIVITY RECORD, READ NEXT INPUT RECORD.     04410007
043500******************************************************************04420007
043600 2000-PROCESS-EXTRACT-RECORDS.                                    04430007
043700                                                                  04440007
043800     IF SV034-TRN-AUTH-TMST > PV-FISCAL-MONTH-END-DATE            04450007
043900         NEXT SENTENCE                                            04460007
044000     ELSE                                                         04470007
044100         PERFORM 2100-PULL-ACTIVITY-DATA                          04480007
044200         IF PS-WRITE                                              04490007
044300             PERFORM 3000-FORMAT-ACTIVITY-RECORD                  04500007
044400             PERFORM 8000-WRITE-ACTIVITY-RECORD                   04510007
044500         END-IF                                                   04520007
044600                                                                  04530007
044700     END-IF.                                                      04540007
044800                                                                  04550007
044900     PERFORM 7000-READ-EXTRACT-FILE.                              04560007
045000                                                                  04570007
045100******************************************************************04580007
045200* 2100-PULL-ACTIVITY-DATA                                         04590007
045300* DETERMINE TYPE OF ACTIVITY THE EXTRACT RECORD REPRESENTS.       04600007
045400* PROCESS EXTRACT RECORD AS AN ISSUE OR TENDER RECORD.            04610007
045500******************************************************************04620007
045600 2100-PULL-ACTIVITY-DATA.                                         04630007
045700                                                                  04640007
045800     IF SV034-CRD-NBR = PV-CRD-NBR                                04650007
045900         CONTINUE                                                 04660007
046000     ELSE                                                         04670007
046100         INITIALIZE PV-ISSUE-TABLE                                04680007
046200         MOVE SPACES TO PV-ISSUE-TIMESTAMP                        04690007
046300         MOVE ZERO   TO  PV-ISSUE-CNT                             04700007
046400                         PV-TND-CNT                               04710007
046500                         PV-FEE-CNT                               04720007
046600                         PV-BAL-SUB1                              04730007
046700                         PV-ISSUE-STR-NBR                         04740007
046800     END-IF.                                                      04750007
046900                                                                  04760007
047000     MOVE SV034-CRD-NBR               TO PV-CRD-NBR.              04770007
047100                                                                  04780007
047200     EVALUATE TRUE                                                04790007
047300        WHEN SV034-ACTVY-TYP-CDE = SV004-ISSUE-KMRC-ACT-TYP-N     04800007
047400        WHEN SV034-ACTVY-TYP-CDE = SV004-ISSUE-GIFT-CRD-ACT-TYP-N 04810007
047500            IF SV034-APP-AUTH-AMT < 0                             04820007
047600            AND SV034-TRN-VOID-IND = 'Y'                          04830007
047700                SET PS-DONT-WRITE TO TRUE                         04840007
047800            ELSE                                                  04850007
047900                IF PV-CRD-NBR = SV013-CRD-NBR                     04860007
048000                    MOVE SV013-CRD-STK-TYP-ID                     04870007
048100                                            TO PV-CRD-STK-TYP-ID  04880007
048200                    MOVE SV013-CRD-STK-TYP-DESC                   04890007
048300                                            TO PV-CRD-STK-TYP-DESC04900007
048400                    MOVE SV013-CRD-STAT-CDE TO PV-CRD-STAT-CDE    04910007
048500                    MOVE SV013-CRD-TYP-CDE  TO PV-CRD-TYP-CDE     04920007
048600                ELSE                                              04930007
048700                    SET PS-STOCK-NOT-FOUND TO TRUE                04940007
048800                    PERFORM 2200-GET-CARD-TYPE-DATA               04950007
048900                        UNTIL PS-STOCK-FOUND                      04960007
049000                           OR PS-END-OF-STOCK                     04970007
049100                    IF PS-STOCK-NOT-FOUND                         04980007
049200                        MOVE '2100-PULL-ACTIVITY-DATA'            04990007
049300                                     TO PV-PARAGRAPH-NAME         05000007
049400                        MOVE 'GET STOCK TYPE'                     05010007
049500                                     TO PV-OPERATION-MSG-1        05020007
049600                        SET AC-INVALID-DATA-ERROR TO TRUE         05030007
049700                        DISPLAY 'CARD-NUMBER IS ' PV-CRD-NBR      05040007
049800                        PERFORM 9999-ABEND                        05050007
049900                    END-IF                                        05060007
050000                END-IF                                            05070007
050100                ADD +1 TO PV-BAL-SUB1                             05080007
069303                IF PV-BAL-SUB1 > 9999                             05090007
050300                    MOVE '2100-PULL-ACTIVITY-DATA'                05100007
050400                                  TO PV-PARAGRAPH-NAME            05110007
050500                    MOVE 'ISSUE TABLE OVERFLOW      '             05120007
050600                                  TO PV-OPERATION-MSG-1           05130007
050700                    SET AC-TABLE-OVERFLOW TO TRUE                 05140007
050800                    PERFORM 9999-ABEND                            05150007
050900                END-IF                                            05160007
051000                MOVE SV034-CRD-NBR                                05170007
051100                                  TO PV-CRD-NUMBER(PV-BAL-SUB1)   05180007
051200                MOVE SV034-ACTVY-TYP-CDE TO PV-ACTVY-TYP-CDE      05190007
051300                IF SV034-TRN-VOID-IND = 'Y'                       05200007
051400                   MOVE ZERO                TO PV-APP-AUTH-AMT    05210007
051500                ELSE                                              05220007
051600                   MOVE SV034-APP-AUTH-AMT  TO PV-APP-AUTH-AMT    05230007
051700                END-IF                                            05240007
051800                MOVE SV034-TRN-AUTH-TMST  TO PV-ISSUE-TIMESTAMP   05250007
051900                                   PV-ISSUE-TIMESTMP(PV-BAL-SUB1) 05260007
052000                MOVE SV034-STR-NBR        TO PV-ISSUE-STR-NBR     05270007
052100                                       PV-ISSUE-STORE(PV-BAL-SUB1)05280007
052200                                             PV-STORE-NBR         05290007
052300                MOVE ZEROES               TO PV-TENDER-STR-NBR    05300007
052400                MOVE SPACES               TO PV-TENDER-TIMESTAMP  05310007
052500                MOVE SV034-TRN-VOID-IND   TO PV-TRN-VOID-IND      05320007
052600                MOVE PV-APP-AUTH-AMT                              05330007
052700                                  TO PV-ISSUE-AMOUNT(PV-BAL-SUB1) 05340007
052800                                     PV-ISSUE-BALANCE(PV-BAL-SUB1)05350007
052900                ADD +1                TO PV-ISSUE-CNT             05360007
053000                MOVE +1               TO PV-SUB                   05370007
053100                MOVE SV034-ACTVY-STAT-CDE TO PV-ACTVY-STAT-CDE    05380007
053200                SET PS-NOT-ECOMM-STR      TO TRUE                 05390007
053300                PERFORM 4000-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE05400007
053400                                          OR PS-ECOMM-STR         05410007
053500            END-IF                                                05420007
053600        WHEN SV034-ACTVY-TYP-CDE = SV004-TENDER-ACT-TYP-N         05430007
053700            IF SV034-TRN-VOID-IND = 'Y'                           05440007
053800                SET PS-DONT-WRITE TO TRUE                         05450007
053900            ELSE                                                  05460007
054000                IF PV-CRD-NBR = SV013-CRD-NBR                     05470007
054100                    MOVE SV013-CRD-STK-TYP-ID                     05480007
054200                                            TO PV-CRD-STK-TYP-ID  05490007
054300                    MOVE SV013-CRD-STK-TYP-DESC                   05500007
054400                                            TO PV-CRD-STK-TYP-DESC05510007
054500                    MOVE SV013-CRD-STAT-CDE TO PV-CRD-STAT-CDE    05520007
054600                    MOVE SV013-CRD-TYP-CDE  TO PV-CRD-TYP-CDE     05530007
054700                ELSE                                              05540007
054800                    SET PS-STOCK-NOT-FOUND TO TRUE                05550007
054900                    PERFORM 2200-GET-CARD-TYPE-DATA               05560007
055000                        UNTIL PS-STOCK-FOUND                      05570007
055100                           OR PS-END-OF-STOCK                     05580007
055200                    IF PS-STOCK-NOT-FOUND                         05590007
055300                        MOVE '2100-PULL-ACTIVITY-DATA'            05600007
055400                                     TO PV-PARAGRAPH-NAME         05610007
055500                        MOVE 'GET STOCK TYPE'                     05620007
055600                                     TO PV-OPERATION-MSG-1        05630007
055700                        SET AC-INVALID-DATA-ERROR TO TRUE         05640007
055800                        DISPLAY 'CARD-NUMBER IS ' PV-CRD-NBR      05650007
055900                        PERFORM 9999-ABEND                        05660007
056000                    END-IF                                        05670007
056100                END-IF                                            05680007
056200                ADD +1                    TO PV-TND-CNT           05690007
056300                MOVE SV034-ACTVY-TYP-CDE  TO PV-ACTVY-TYP-CDE     05700007
056400                MOVE SV034-APP-AUTH-AMT   TO PV-APP-AUTH-AMT      05710007
056500                MOVE SV034-TRN-AUTH-TMST  TO PV-TENDER-TIMESTAMP  05720007
056600                MOVE SV034-TRN-VOID-IND   TO PV-TRN-VOID-IND      05730007
056700                MOVE SV034-ACTVY-STAT-CDE TO PV-ACTVY-STAT-CDE    05740007
056800                MOVE SV034-STR-NBR        TO PV-TENDER-STR-NBR    05750007
056900                                             PV-STORE-NBR         05760007
057000                COMPUTE PV-BALANCE-NEEDED =                       05770007
057100                   SV034-APP-AUTH-AMT * -1                        05780007
057200                SET PS-NOT-SUB-ISSUE     TO TRUE                  05790007
057300                PERFORM 5000-PROCESS-TENDER-FEE                   05800007
057400                   VARYING PV-BAL-SUB2 FROM 1 BY 1                05810007
057500                   UNTIL PV-CRD-NUMBER(PV-BAL-SUB2) = ZERO OR     05820007
057600                   PS-SUB-ISSUE OR                                05830007
057700                   PV-BAL-SUB2 > 100                              05840007
057800                IF PV-ISSUE-TIMESTAMP = SPACES                    05850007
057900                    MOVE PV-TENDER-TIMESTAMP TO PV-ISSUE-TIMESTAMP05860007
058000                    MOVE PV-TENDER-STR-NBR   TO PV-ISSUE-STR-NBR  05870007
058100                END-IF                                            05880007
058200                SET PS-NOT-ECOMM-STR      TO TRUE                 05890007
058300                MOVE +1                   TO PV-SUB               05900007
058400                PERFORM 4000-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE05910007
058500                                          OR PS-ECOMM-STR         05920007
058600            END-IF                                                05930007
058700        WHEN SV034-ACTVY-TYP-CDE = SV004-SRV-FEE-ACT-TYP-N        05940007
058800            IF PV-CRD-NBR = SV013-CRD-NBR                         05950007
058900               MOVE SV013-CRD-STK-TYP-ID                          05960007
059000                                        TO PV-CRD-STK-TYP-ID      05970007
059100                MOVE SV013-CRD-STK-TYP-DESC                       05980007
059200                                        TO PV-CRD-STK-TYP-DESC    05990007
059300                MOVE SV013-CRD-STAT-CDE TO PV-CRD-STAT-CDE        06000007
059400                MOVE SV013-CRD-TYP-CDE  TO PV-CRD-TYP-CDE         06010007
059500            ELSE                                                  06020007
059600                SET PS-STOCK-NOT-FOUND TO TRUE                    06030007
059700                PERFORM 2200-GET-CARD-TYPE-DATA                   06040007
059800                    UNTIL PS-STOCK-FOUND                          06050007
059900                       OR PS-END-OF-STOCK                         06060007
060000                IF PS-STOCK-NOT-FOUND                             06070007
060100                    MOVE '2100-PULL-ACTIVITY-DATA'                06080007
060200                                        TO PV-PARAGRAPH-NAME      06090007
060300                    MOVE 'GET STOCK TYPE'                         06100007
060400                                        TO PV-OPERATION-MSG-1     06110007
060500                    SET AC-INVALID-DATA-ERROR TO TRUE             06120007
060600                    DISPLAY 'CARD-NUMBER IS ' PV-CRD-NBR          06130007
060700                    PERFORM 9999-ABEND                            06140007
060800                END-IF                                            06150007
060900            END-IF                                                06160007
061000            MOVE SV034-ACTVY-TYP-CDE TO PV-ACTVY-TYP-CDE          06170007
061100            MOVE SV034-APP-AUTH-AMT  TO PV-APP-AUTH-AMT           06180007
061200            MOVE SV034-TRN-AUTH-TMST TO PV-TENDER-TIMESTAMP       06190007
061300            MOVE SV034-TRN-VOID-IND  TO PV-TRN-VOID-IND           06200007
061400            MOVE SV034-STR-NBR       TO PV-TENDER-STR-NBR         06210007
061500            ADD +1                   TO PV-FEE-CNT                06220007
061600            COMPUTE PV-BALANCE-NEEDED =                           06230007
061700                   SV034-APP-AUTH-AMT * -1                        06240007
061800            SET PS-NOT-SUB-ISSUE     TO TRUE                      06250007
061900            PERFORM 5000-PROCESS-TENDER-FEE                       06260007
062000               VARYING PV-BAL-SUB2 FROM 1 BY 1                    06270007
062100                   UNTIL PV-CRD-NUMBER(PV-BAL-SUB2) = ZERO OR     06280007
062200                         PS-SUB-ISSUE OR                          06290007
062300                         PV-BAL-SUB2 > 100                        06300007
062400            IF PV-ISSUE-TIMESTAMP = SPACES                        06310007
062500                MOVE PV-TENDER-TIMESTAMP TO PV-ISSUE-TIMESTAMP    06320007
062600                MOVE PV-TENDER-STR-NBR   TO PV-ISSUE-STR-NBR      06330007
062700            END-IF                                                06340007
062800     END-EVALUATE.                                                06350007
062900                                                                  06360007
063000******************************************************************06370007
063100* 2200-GET-CARD-TYPE-DATA                                         06380007
063200* GET STATUS CODE, TYPE CODE, AND TYPE OF CARD STOCK FOR THE      06390007
063300* CURRENT STORED VALUE CARD.                                      06400007
063400******************************************************************06410007
063500 2200-GET-CARD-TYPE-DATA.                                         06420007
063600                                                                  06430007
063700     READ STOCK-FILE INTO SV013-STOCK-RECORD                      06440007
063800         AT END                                                   06450007
063900             SET PS-END-OF-STOCK TO TRUE.                         06460007
064000                                                                  06470007
064100     IF SV013-CRD-NBR = PV-CRD-NBR                                06480007
064200         MOVE SV013-CRD-STAT-CDE TO PV-CRD-STAT-CDE               06490007
064300         MOVE SV013-CRD-TYP-CDE TO PV-CRD-TYP-CDE                 06500007
064400         MOVE SV013-CRD-STK-TYP-ID TO PV-CRD-STK-TYP-ID           06510007
064500         MOVE SV013-CRD-STK-TYP-DESC TO PV-CRD-STK-TYP-DESC       06520007
064600         SET PS-STOCK-FOUND     TO TRUE                           06530007
064700     END-IF.                                                      06540007
064800                                                                  06550007
064900******************************************************************06560007
065000* 3000-FORMAT-ACTIVITY-RECORD                                     06570007
065100* TAKE THE VARIABLE FIELDS SET IN THE ABOVE PARAGRAPHS AND MOVE   06580007
065200* THEM TO THE OUTPUT ACTIVITY RECORD FIELDS.                      06590007
065300******************************************************************06600007
065400 3000-FORMAT-ACTIVITY-RECORD.                                     06610007
065500                                                                  06620007
065600     MOVE SPACES               TO  SV036-RECORD.                  06630007
065700     MOVE PV-CRD-NBR           TO  SV036-CRD-NBR.                 06640007
065800     MOVE PV-ACTVY-TYP-CDE     TO  SV036-ACTVY-TYP-CDE.           06650007
065900     MOVE PV-APP-AUTH-AMT      TO  SV036-APP-AUTH-AMT.            06660007
066000     MOVE PV-ISSUE-TIMESTAMP   TO  SV036-ISSUE-TIMESTAMP.         06670007
066100     MOVE PV-TENDER-TIMESTAMP  TO  SV036-TENDER-TIMESTAMP.        06680007
066200     MOVE PV-CRD-STAT-CDE      TO  SV036-CRD-STAT-CDE.            06690007
066300     MOVE PV-CRD-TYP-CDE       TO  SV036-CRD-TYP-CDE.             06700007
066400     MOVE PV-CRD-STK-TYP-ID    TO  SV036-CRD-STK-TYP-ID.          06710007
066500     MOVE PV-CRD-STK-TYP-DESC  TO  SV036-CRD-STK-TYP-DESC.        06720007
066600     MOVE PV-ISSUE-STR-NBR     TO  SV036-ISSUE-STR-NBR.           06730007
066700     MOVE PV-TRN-VOID-IND      TO  SV036-TRN-VOID-IND.            06740007
066800     MOVE PV-ACTVY-STAT-CDE    TO  SV036-ACTVY-STAT-CDE.          06750007
066900     MOVE PV-TENDER-STR-NBR    TO  SV036-TENDR-STR-NBR.           06760007
067000     MOVE PS-ECOMM-STR-SW      TO  SV036-E-BUS-IND.               06770007
067100     MOVE SV034-ST-CDE         TO  SV036-ST-CDE.                  06780007
067200     MOVE PV-ISSUE-CNT         TO  SV036-ISSUE-CNT.               06790007
067300     MOVE PV-TND-CNT           TO  SV036-TND-CNT.                 06800007
067400     MOVE PV-FEE-CNT           TO  SV036-FEE-CNT.                 06810007
067500                                                                  06820007
067600******************************************************************06830007
067700*     4000-ECOMM-STR                                             *06840007
067800* ==> PROCESSES:                                                 *06850007
067900*     - SEARCHES THROUGH THE ECOMMERCE STORE TABLE               *06860007
068000******************************************************************06870007
068100 4000-ECOMM-STR.                                                  06880007
068200     IF PV-STORE-NBR = PV-ECOMM-STR (PV-SUB)                      06890007
068300         SET PS-ECOMM-STR TO TRUE                                 06900007
068400     END-IF.                                                      06910007
068500     ADD +1 TO PV-SUB.                                            06920007
068600                                                                  06930007
068700******************************************************************06940007
068800*     - IF THE BALANCE ON AN ISSUE IS GREATER THAN THE TENDER    *06950007
068900*         SUBTRACT THE TENDER FROM THE BALANCE                   *06960007
069000*         MOVE THE TIMESTAMP TO THE OUTPUT ISSUE TIMESTAMP       *06970007
069100*     - IF THE BALANCE ON AN ISSUE IS LESS THAN THE TENDER       *06980007
069200*         IF THE BALANCE IS GREATER THAN ZERO BUT LESS THAN      *06990007
069300*            THE TENDER, PERFORM 5500-.... WHICH WRITES OUT      *07000007
069400*            A TENDER RECORD WITH WHATEVER IS LEFT ON THE ISSUE  *07010007
069500******************************************************************07020007
069600 5000-PROCESS-TENDER-FEE.                                         07030007
069700                                                                  07040007
069800     IF PV-CRD-NBR = PV-CRD-NUMBER (PV-BAL-SUB2)                  07050007
069900        IF PV-ISSUE-BALANCE(PV-BAL-SUB2) = 0                      07060007
070000            CONTINUE                                              07070007
070100        ELSE                                                      07080007
070200            IF PV-ISSUE-BALANCE(PV-BAL-SUB2) >= PV-BALANCE-NEEDED 07090007
070300                COMPUTE PV-ISSUE-BALANCE(PV-BAL-SUB2)             07100007
070400                                   = PV-ISSUE-BALANCE(PV-BAL-SUB2)07110007
070500                                   - PV-BALANCE-NEEDED            07120007
070600                SET PS-SUB-ISSUE   TO TRUE                        07130007
070700                MOVE PV-ISSUE-TIMESTMP(PV-BAL-SUB2)               07140007
070800                                   TO PV-ISSUE-TIMESTAMP          07150007
070900                MOVE PV-ISSUE-STORE(PV-BAL-SUB2)                  07160007
071000                                   TO PV-ISSUE-STR-NBR            07170007
071100            ELSE                                                  07180007
071200                PERFORM 5500-HANDLE-SPLIT-TNDR                    07190007
071300            END-IF                                                07200007
071400        END-IF                                                    07210007
071500     END-IF.                                                      07220007
071600                                                                  07230007
071700******************************************************************07240007
071800* 5500-HANDLE-SPLIT-TNDR                                         *07250007
071900* ==> WRITES OUT A TENDER RECORD WITH THE PORTION OF DOLLARS     *07260007
072000*     LEFT ON THE ISSUE.  THIS IS A SPLIT OF A TENDER FROM TWO   *07270007
072100*     OR MORE ISSUES.                                            *07280007
072200******************************************************************07290007
072300 5500-HANDLE-SPLIT-TNDR.                                          07300007
072400                                                                  07310007
072500     COMPUTE PV-HOLD-BALANCE-NEEDED                               07320007
072600           = PV-BALANCE-NEEDED                                    07330007
072700           - PV-ISSUE-BALANCE(PV-BAL-SUB2).                       07340007
072800                                                                  07350007
072900     COMPUTE PV-APP-AUTH-AMT                                      07360007
073000           = PV-ISSUE-BALANCE(PV-BAL-SUB2)                        07370007
073100           * -1.                                                  07380007
073200                                                                  07390007
073300     MOVE PV-ISSUE-TIMESTMP(PV-BAL-SUB2) TO PV-ISSUE-TIMESTAMP.   07400007
073400     MOVE PV-ISSUE-STORE(PV-BAL-SUB2)    TO PV-ISSUE-STR-NBR.     07410007
073500                                                                  07420007
073600     PERFORM 3000-FORMAT-ACTIVITY-RECORD.                         07430007
073700     PERFORM 8000-WRITE-ACTIVITY-RECORD.                          07440007
073800                                                                  07450007
073900     MOVE 0 TO PV-ISSUE-BALANCE(PV-BAL-SUB2).                     07460007
074000     MOVE PV-HOLD-BALANCE-NEEDED TO PV-BALANCE-NEEDED.            07470007
074100                                                                  07480007
074200     COMPUTE PV-APP-AUTH-AMT                                      07490007
074300           = PV-HOLD-BALANCE-NEEDED                               07500007
074400           * -1.                                                  07510007
074500                                                                  07520007
074600******************************************************************07530007
074700* 7000-READ-EXTRACT-FILE                                         *07540007
074800* ==> READS EXTRACT FILE                                         *07550007
074900******************************************************************07560007
075000 7000-READ-EXTRACT-FILE.                                          07570007
075100     READ EXTRACT-FILE INTO SV034-RECORD                          07580007
075200        AT END                                                    07590007
075300           SET PS-END-OF-EXTRACT-FILE TO TRUE.                    07600007
075400                                                                  07610007
075500     IF NOT PS-END-OF-EXTRACT-FILE                                07620007
075600         ADD +1 TO PV-INPUT-CNT                                   07630007
075700     END-IF.                                                      07640007
075800                                                                  07650007
075900     SET PS-WRITE TO TRUE.                                        07660007
076000                                                                  07670007
076100******************************************************************07680007
076200* 8000-WRITE-ACTIVITY-RECORD                                     *07690007
076300*                                                                *07700007
076400******************************************************************07710007
076500 8000-WRITE-ACTIVITY-RECORD.                                      07720007
076600                                                                  07730007
076700     WRITE ACTIVITY-RECORD                                        07740007
076800         FROM SV036-RECORD.                                       07750007
076900     ADD +1 TO PV-OUTPUT-CNT.                                     07760007
077000                                                                  07770007
077100******************************************************************07780007
077200* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           07790007
077300******************************************************************07800007
077400 9999-ABEND.                                                      07810007
077500     DISPLAY '** ABEND           **'.                             07820007
077600     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  07830007
077700     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07840007
077800     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       07850007
077900     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       07860007
078000     CALL 'ILBOABN0' USING ABEND-CODE.                            07870007
078100                                                                  07880007
078200******************************************************************07890007
078300*     Z900-SQL-ABEND                                             *07900007
078400* ==> PROCESSES:                                                 *07910007
078500*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *07920007
078600******************************************************************07930007
078700 Z900-SQL-ABEND.                                                  07940007
078800                                                                  07950007
078900     DISPLAY 'Z900-SQL-ABEND'.                                    07960007
079000     DISPLAY '**  ABEND     **'.                                  07970007
079100     DISPLAY '**  PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.       07980007
079200     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             07990007
079300     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    08000007
079400                                                                  08010007
079500******************************************************************08020007
079600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *08030007
079700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *08040007
079800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *08050007
079900* FORMAT.                                                        *08060007
080000******************************************************************08070007
080100     COPY DPPD004.                                                08080007
080200                                                                  08090007
080300     MOVE +4013 TO ABEND-CODE.                                    08100007
080400     CALL 'ILBOABN0' USING ABEND-CODE.                            08110007
