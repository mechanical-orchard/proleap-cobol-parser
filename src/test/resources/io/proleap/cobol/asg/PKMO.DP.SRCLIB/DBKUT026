00001 ******************************************************************00010023
00002  IDENTIFICATION DIVISION.                                         00020023
00003 ******************************************************************00030018
00004                                                                   00040023
00005  PROGRAM-ID.             DBKUT026.                                00050023
00006  AUTHOR.                 BRAD DORN.                               00060023
00007  INSTALLATION.           KOHLS.                                   00070023
00008  DATE-WRITTEN            AUGUST 2003.                             00080023
00009  DATE-COMPILED.                                                   00090023
00010                                                                   00100023
00011 ******************************************************************00110023
      ***-----------------------------------------------------------*** 00120023
      ***  IMPORTANT!!!                                             *** 00130023
      ***  ------------                                             *** 00140023
      ***  WHENEVER THIS PROGRAM IS TURNED OVER TO PRODUCTION, A    *** 00150023
      ***  BIND TO THE OTHER NON-DB2P PRODUCTION SUBSYSTEMS IS      *** 00160023
      ***  REQUIRED.  JCL CAN BE FOUND IN TKMD.DB2.CNTL(BIND904).   *** 00170023
      ***-----------------------------------------------------------*** 00180023
00012 * THIS PROGRAM READS IN LISTCAT FILES ON DB2 PARTITIONED          00190023
00012 * TABLESPACE AND INDEX DATASETS.  HI-USED RBA IS EXTRACTED        00200023
00012 * FOR EACH DATASET.  THE MAXIMUM ALLOWABLE DATASET SIZE IS        00210024
00012 * CALCULATED AND A FILE IS CREATED THAT WILL BE USED BY           00220023
00013 * DBKRP015 TO GENERATE A REPORT.                                  00230023
00013 *                                                                 00240023
00013 * THE REPORT CAN BE FILTERED BY PERCENT FILLED.  A CUTOFF VALUE   00250023
00013 * IS INPUT INTO THE PROGRAM.  ANY 'PERCENT FILLED' VALUE GREATER  00260023
00013 * THAN OR EQUAL TO THIS CUTOFF VALUE WILL BE INCLUDED ON THE      00270023
00013 * REPORT.                                                         00280023
00017 ******************************************************************00290023
00018                                                                   00300023
00019 ******************************************************************00310023
00020  ENVIRONMENT DIVISION.                                            00320023
00021 ******************************************************************00330023
00022                                                                   00340023
00023  CONFIGURATION SECTION.                                           00350023
00024                                                                   00360023
00025  SOURCE-COMPUTER.        IBM-3090.                                00370023
00026  OBJECT-COMPUTER.        IBM-3090.                                00380023
00027                                                                   00390023
00028  INPUT-OUTPUT SECTION.                                            00400023
00029                                                                   00410023
00030  FILE-CONTROL.                                                    00420023
00031                                                                   00430023
00032      SELECT INPUT-TS-LISTCAT         ASSIGN TO INP01.             00440023
00032      SELECT INPUT-IX-LISTCAT         ASSIGN TO INP02.             00450023
00033      SELECT OUTPUT-FILE              ASSIGN TO OUT01.             00460023
00035                                                                   00470023
00036 ******************************************************************00480023
00037  DATA DIVISION.                                                   00490023
00038 ******************************************************************00500023
00039                                                                   00510023
00040  FILE SECTION.                                                    00520023
00041                                                                   00530023
00042  FD  INPUT-TS-LISTCAT                                             00540023
00043      RECORDING MODE IS V                                          00550023
00044      LABEL RECORDS ARE STANDARD                                   00560023
00045      BLOCK CONTAINS 0 RECORDS.                                    00570023
00046                                                                   00580023
00047  01  INPUT-TS-LISTCAT-REC            PIC  X(121).                 00590023
00048                                                                   00600023
00042  FD  INPUT-IX-LISTCAT                                             00610023
00043      RECORDING MODE IS V                                          00620023
00044      LABEL RECORDS ARE STANDARD                                   00630023
00045      BLOCK CONTAINS 0 RECORDS.                                    00640023
00046                                                                   00650023
00047  01  INPUT-IX-LISTCAT-REC            PIC  X(121).                 00660023
00048                                                                   00670023
00049  FD  OUTPUT-FILE                                                  00680023
00050      RECORDING MODE IS F                                          00690023
00051      LABEL RECORDS ARE STANDARD                                   00700023
00052      BLOCK CONTAINS 0 RECORDS.                                    00710023
00053                                                                   00720023
00054  01  OUTPUT-FILE-REC                 PIC  X(056).                 00730023
00055                                                                   00740023
00064 ******************************************************************00750023
00065  WORKING-STORAGE SECTION.                                         00760023
00066 ******************************************************************00770023
00073                                                                   00780023
00074  01  WS-MISC.                                                     00790023
           05  WS-ABEND-CODE             PIC  9(04)  COMP VALUE 0.      00800023
           05  WS-BYTES-IN-GIG           PIC  9(10)  COMP               00810023
                                                     VALUE 1073741824.  00820023
00069      05  WS-DATASET-FIELD1         PIC  X(06)  VALUE SPACES.      00830023
00069      05  WS-DATASET-FIELD2         PIC  X(06)  VALUE SPACES.      00840023
00069      05  WS-DATASET-FIELD3         PIC  X(08)  VALUE SPACES.      00850023
00069      05  WS-DATASET-FIELD4         PIC  X(08)  VALUE SPACES.      00860023
00069      05  WS-DATASET-FIELD5         PIC  X(05)  VALUE SPACES.      00870023
00069      05  WS-DATASET-FIELD6         PIC  X(04)  VALUE SPACES.      00880023
           05  WS-HI-USED-RBA            PIC  9(15)  COMP VALUE 0.      00890023
00069      05  WS-INPUT-EOF-SW           PIC  X(01)  VALUE 'N'.         00900023
           05  WS-PCTFULL-CUTOFF         PIC  999    VALUE 0.           00910023
           05  WS-PCT-FULL               PIC  999    COMP VALUE 0.      00920023
00069      05  WS-PREVIOUS-DBNAME        PIC  X(08)  VALUE SPACES.      00930023
00069      05  WS-PREVIOUS-IXSPACE       PIC  X(08)  VALUE SPACES.      00940023
00069      05  WS-PREVIOUS-TSPACE        PIC  X(08)  VALUE SPACES.      00950023
00078                                                                   00960023
00079  01  WS-INPUT-RECORD.                                             00970023
           05  FILLER                    PIC X(121)    VALUE SPACES.    00980023
00078                                                                   00990023
00079  01  WS-IN-DATASET-RECORD  REDEFINES WS-INPUT-RECORD.             01000023
           05  IN-DATASET-BYTES-1-17     PIC X(17).                     01010023
           05  IN-DATASET-NAME           PIC X(42).                     01020023
           05  FILLER                    PIC X(62).                     01030023
00080                                                                   01040023
00079  01  WS-IN-HI-USED-RECORD  REDEFINES WS-INPUT-RECORD.             01050023
           05  FILLER                    PIC X(37).                     01060023
           05  IN-HI-USED-BYTES-38-45    PIC X(08).                     01070023
           05  IN-HI-USED-BYTES-46-61    PIC X(16).                     01080023
           05  FILLER                    PIC X(60).                     01090023
00080                                                                   01100023
00079  01  WS-OUTPUT-RECORD.                                            01110023
           05  OUT-DATASET-NAME          PIC X(42)     VALUE SPACES.    01120023
           05  OUT-MAX-GIG               PIC S9(09)    COMP   VALUE 0.  01130026
           05  OUT-USED-GIG              PIC 9(09)V99  COMP   VALUE 0.  01140023
           05  OUT-PCT-FULL              PIC 9V99      COMP   VALUE 0.  01150023
00080                                                                   01160023
       01  DP004-DB2-ERROR-FIELDS.                                      01170023
           05  DP004-ASTERISK-LINE       PIC  X(80)  VALUE ALL '*'.     01180023
           05  DP004-MAX-MESSAGE-LINES   PIC S9(04)  VALUE +12          01190023
                                                     COMP SYNC.         01200023
           05  DP004-ERROR-LINE-LENGTH   PIC S9(09)  VALUE +75          01210023
                                                     COMP SYNC.         01220023
           05  DP004-FORMATTED-MESSAGE.                                 01230023
               10  FILLER                PIC S9(04)  VALUE +900         01240023
                                                     COMP SYNC.         01250023
               10  DP004-MESSAGE-LINE    OCCURS 12 TIMES                01260023
                                         INDEXED BY DP004-MSG-IDX       01270023
                                         PIC  X(75).                    01280023
                                                                        01290023
           EXEC SQL                                                     01300023
               INCLUDE SYSINDEX                                         01310023
           END-EXEC.                                                    01320023
                                                                        01330023
           EXEC SQL                                                     01340023
               INCLUDE SYSTABLE                                         01350023
           END-EXEC.                                                    01360023
                                                                        01370023
           EXEC SQL                                                     01380023
               INCLUDE SYSTABSP                                         01390023
           END-EXEC.                                                    01400023
                                                                        01410023
00131      EXEC SQL                                                     01420023
00132          INCLUDE SQLCA                                            01430023
00133      END-EXEC.                                                    01440023
00134                                                                   01450023
00135 ******************************************************************01460023
00136  LINKAGE SECTION.                                                 01470023
00137 ******************************************************************01480023
00138                                                                   01490023
00139 ******************************************************************01500023
00140  PROCEDURE DIVISION.                                              01510023
00141 ******************************************************************01520023
00142                                                                   01530023
00143  0000-PROGRAM-MAINLINE SECTION.                                   01540023
00144                                                                   01550023
00145      PERFORM 1000-INITIALIZATION.                                 01560023
00144                                                                   01570023
00152      PERFORM 2000-PROCESS-TS-FILE.                                01580023
00144                                                                   01590023
00152      PERFORM 3000-PROCESS-IX-FILE.                                01600023
00144                                                                   01610023
00153      PERFORM 4000-END-OF-JOB.                                     01620024
00146                                                                   01630023
00154      GOBACK.                                                      01640023
00155                                                                   01650023
00204                                                                   01660023
00205  1000-INITIALIZATION.                                             01670023
00206                                                                   01680023
00207      OPEN INPUT  INPUT-TS-LISTCAT                                 01690023
                       INPUT-IX-LISTCAT                                 01700023
00208           OUTPUT OUTPUT-FILE.                                     01710023
00209                                                                   01720023
           ACCEPT WS-PCTFULL-CUTOFF.                                    01730023
00214                                                                   01740023
00271                                                                   01750023
00215 ******************************************************************01760023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          01770023
00218 * - DECLARE A GLOBAL TEMPORARY TABLE TO HOLD MAXIMUM DATASET SIZE 01780023
00218 *   FOR TABLESPACES.  THIS TABLE WILL BE REFERENCED WHEN THE INDEX01790023
00218 *   LISTCAT FILE IS PROCESSED (INDEXES USE THE SAME SIZE AS THE   01800023
00218 *   TABLESPACE THEY POINT TO).                                    01810024
00218 * - CREATE AN INDEX ON THE GLOBAL TEMPORARY TABLE.                01811024
00218 * - PERFORM AN INITIAL READ ON THE TABLESPACE LISTCAT FILE.       01820023
00222 ******************************************************************01830023
00223                                                                   01840023
00224  2000-PROCESS-TS-FILE.                                            01850023
00225                                                                   01860023
           EXEC SQL                                                     01870023
               DECLARE GLOBAL TEMPORARY TABLE GTT                       01880023
                   ( DBNAME              CHAR(08)    NOT NULL,          01890023
                     TSNAME              CHAR(08)    NOT NULL,          01900023
                     MAX_GIG_SIZE        INTEGER     NOT NULL )         01910024
                 ON COMMIT PRESERVE ROWS                                01920023
           END-EXEC.                                                    01930023
                                                                        01940023
           IF SQLCODE NOT EQUAL ZERO                                    01950023
00284          MOVE +4013      TO WS-ABEND-CODE                         01951027
00285          DISPLAY '*****************************************'      01952027
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      01953027
00287          DISPLAY '***                                   ***'      01954027
00288          DISPLAY '*** BAD SQL CALL - DECLARE GTT        ***'      01955027
00288          DISPLAY '*** 2000-PROCESS-TS-FILE              ***'      01956027
00289          DISPLAY '*****************************************'      01957027
00290          PERFORM 9999-SQL-ABEND                                   01958027
           END-IF.                                                      02010023
                                                                        02020023
           EXEC SQL                                                     02030023
               CREATE UNIQUE INDEX SESSION.IGTT0                        02040023
                   ON SESSION.GTT                                       02050023
                    (DBNAME          ASC,                               02060023
                     TSNAME          ASC)                               02070023
                USING STOGROUP STGM000                                  02080023
                      PRIQTY   720                                      02090023
                      SECQTY   720                                      02100023
                  BUFFERPOOL BP2                                        02110023
           END-EXEC.                                                    02120023
                                                                        02130023
           IF SQLCODE NOT EQUAL ZERO                                    02140023
00284          MOVE +4013      TO WS-ABEND-CODE                         02141027
00285          DISPLAY '*****************************************'      02142027
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      02143027
00287          DISPLAY '***                                   ***'      02144027
00288          DISPLAY '*** BAD SQL CALL - CREATE INDEX       ***'      02145027
00288          DISPLAY '*** 2000-PROCESS-TS-FILE              ***'      02146027
00289          DISPLAY '*****************************************'      02147027
               PERFORM 9999-SQL-ABEND                                   02190027
           END-IF.                                                      02200023
                                                                        02210023
00167      PERFORM 2100-READ-TS-FILE.                                   02220023
00214                                                                   02230023
00270      IF WS-INPUT-EOF-SW = 'Y'                                     02240023
00363          MOVE +4013      TO WS-ABEND-CODE                         02250023
00364          DISPLAY '*****************************************'      02260023
00365          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      02270023
00366          DISPLAY '***                                   ***'      02280023
00367          DISPLAY '*** EMPTY TABLESPACE LISTCAT FILE     ***'      02290023
00288          DISPLAY '*** 2000-PROCESS-TS-FILE.             ***'      02300023
00368          DISPLAY '*****************************************'      02310023
00369          PERFORM 9999-NONSQL-ABEND                                02320023
00370      END-IF.                                                      02330023
00371                                                                   02340023
00152      PERFORM 2200-PROCESS-TS-RECORD                               02350023
00170          UNTIL WS-INPUT-EOF-SW IS EQUAL TO 'Y'.                   02360023
00153                                                                   02370023
00153                                                                   02380023
00215 ******************************************************************02390023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          02400023
00218 * - READ THE INPUT FILE CONTAINING TABLESPACE LISTCAT OUTPUT.     02410023
00222 ******************************************************************02420023
00223                                                                   02430023
00267  2100-READ-TS-FILE.                                               02440023
00268                                                                   02450023
00269      READ INPUT-TS-LISTCAT INTO WS-INPUT-RECORD                   02460023
00270          AT END MOVE 'Y' TO WS-INPUT-EOF-SW.                      02470023
00271                                                                   02480023
00271                                                                   02490023
00215 ******************************************************************02500023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          02510023
00218 * - PARSE THE INPUT RECORDS FOR EITHER A RECORD CONTAINING        02520023
00218 *   THE DATASET NAME OR A RECORD CONTAINING HI-USED-RBA.          02530023
00218 *   PERFORM THE APPROPRIATE PARAGRAPH IF FOUND.                   02540023
00218 * - READ THE NEXT TABLESPACE LISTCAT RECORD.                      02550023
00222 ******************************************************************02560023
00223                                                                   02570023
00224  2200-PROCESS-TS-RECORD.                                          02580023
00225                                                                   02590023
           IF IN-DATASET-BYTES-1-17 = '0DATA ---------- '               02600023
               PERFORM 2300-PROCESS-DATASET-REC                         02610023
           ELSE                                                         02620023
               IF IN-HI-USED-BYTES-38-45 = 'HI-U-RBA'                   02630023
                   PERFORM 5000-PROCESS-HI-USED-REC                     02640024
               END-IF                                                   02650023
           END-IF.                                                      02660023
                                                                        02670023
00167      PERFORM 2100-READ-TS-FILE.                                   02680023
00214                                                                   02690023
00214                                                                   02700023
00215 ******************************************************************02710023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          02720023
00218 * - EXTRACT THE DATASET NAME FROM THE LISTCAT RECORD              02730018
00218 * - EXECUTE LOGIC TO DETERMINE THE MAXIMUM ALLOWED DATASET        02740024
00218 *   SIZE UPON CHANGE IN DATABASE/TABLESPACE.                      02750024
00222 ******************************************************************02770023
00223                                                                   02780023
00224  2300-PROCESS-DATASET-REC.                                        02790023
00225                                                                   02800023
           MOVE IN-DATASET-NAME TO OUT-DATASET-NAME.                    02810023
                                                                        02820023
           UNSTRING IN-DATASET-NAME                                     02830023
              DELIMITED BY '.'                                          02840023
           INTO WS-DATASET-FIELD1                                       02850023
                WS-DATASET-FIELD2                                       02860023
                WS-DATASET-FIELD3                                       02870023
                WS-DATASET-FIELD4                                       02880023
                WS-DATASET-FIELD5                                       02890023
                WS-DATASET-FIELD6                                       02900023
           END-UNSTRING.                                                02910023
                                                                        02920023
           IF WS-DATASET-FIELD3 = WS-PREVIOUS-DBNAME                    02930023
               AND WS-DATASET-FIELD4 = WS-PREVIOUS-TSPACE               02940023
                   NEXT SENTENCE                                        02950023
           ELSE                                                         02960023
               PERFORM 2310-CALCULATE-MAX-SIZE                          02970023
               MOVE WS-DATASET-FIELD3 TO WS-PREVIOUS-DBNAME             02980023
               MOVE WS-DATASET-FIELD4 TO WS-PREVIOUS-TSPACE.            02990023
                                                                        03000023
                                                                        03010023
00215 ******************************************************************03020023
00216 * THIS PARAGRAPH CALCULATES THE MAXIMUM SIZE FOR A PARTITION.     03030023
00218 * THE VALUE IS SAVED IN THE GLOBAL TEMPORARY TABLE.               03040024
00222 ******************************************************************03050023
00223                                                                   03060023
00224  2310-CALCULATE-MAX-SIZE.                                         03070023
00225                                                                   03080023
           EXEC SQL                                                     03090023
             SELECT PARTITIONS,TYPE,DSSIZE                              03100023
               INTO :SYSTABSP-PARTITIONS,                               03110023
                    :SYSTABSP-TYPE,                                     03120023
                    :SYSTABSP-DSSIZE                                    03130023
                  FROM SYSIBM.SYSTABLESPACE                             03140023
               WHERE DBNAME = :WS-DATASET-FIELD3                        03150023
                 AND NAME = :WS-DATASET-FIELD4   WITH UR                03160023
00281      END-EXEC.                                                    03170023
00282                                                                   03180023
00283      IF  SQLCODE NOT = ZERO                                       03190023
00284          MOVE +4013      TO WS-ABEND-CODE                         03200023
00285          DISPLAY '*****************************************'      03210023
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      03220023
00287          DISPLAY '***                                   ***'      03230023
00288          DISPLAY '*** BAD SQL CALL - SYSTABLESPACE      ***'      03240023
00288          DISPLAY '*** 2310-CALCULATE-MAX-SIZE           ***'      03250023
00289          DISPLAY '*****************************************'      03260023
00290          PERFORM 9999-SQL-ABEND                                   03270023
00291      END-IF.                                                      03280023
00206                                                                   03290023
00206      IF SYSTABSP-DSSIZE > 0                                       03300023
               COMPUTE OUT-MAX-GIG = SYSTABSP-DSSIZE / 1048576          03310023
           ELSE                                                         03320023
      * AS OF DB2 V10 DSSIZE = 0 FOR DSNDB01.DBD01/SPT01                03320128
               IF WS-DATASET-FIELD3 = 'DSNDB01'                         03321028
                   AND (WS-DATASET-FIELD4 = 'DBD01'                     03322030
                          OR WS-DATASET-FIELD4 = 'SPT01')               03322130
                       MOVE 64 TO OUT-MAX-GIG                           03323028
               ELSE                                                     03324028
                   IF SYSTABSP-TYPE = 'L'                               03330028
                       MOVE 4 TO OUT-MAX-GIG                            03340028
                   ELSE                                                 03350028
                       IF SYSTABSP-PARTITIONS <= 16                     03360028
                           MOVE 4 TO OUT-MAX-GIG                        03370028
                       ELSE                                             03380028
                           IF SYSTABSP-PARTITIONS <= 32                 03390028
                               MOVE 2 TO OUT-MAX-GIG                    03400028
                           ELSE                                         03410028
                               IF SYSTABSP-PARTITIONS <= 64             03420028
                                   MOVE 1 TO OUT-MAX-GIG                03430028
                               ELSE                                     03440028
                                   IF SYSTABSP-PARTITIONS <= 254        03450028
                                       MOVE 4 TO OUT-MAX-GIG            03460028
                                   ELSE                                 03470028
                                       PERFORM 2320-CHECK-PAGE-SIZE.    03480028
                                                                        03490023
           EXEC SQL                                                     03500023
               INSERT                                                   03510023
                INTO SESSION.GTT                                        03520023
                   ( DBNAME                                             03530023
                    ,TSNAME                                             03540024
                    ,MAX_GIG_SIZE )                                     03550025
                VALUES                                                  03560023
                    ( :WS-DATASET-FIELD3                                03570023
                     ,:WS-DATASET-FIELD4                                03580023
                     ,:OUT-MAX-GIG )                                    03590023
           END-EXEC.                                                    03600023
                                                                        03610023
00283      IF  SQLCODE NOT = ZERO                                       03620023
00284          MOVE +4013      TO WS-ABEND-CODE                         03630023
00285          DISPLAY '*****************************************'      03640023
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      03650023
00287          DISPLAY '***                                   ***'      03660023
00288          DISPLAY '*** BAD SQL CALL ON INSERT TO GTT     ***'      03670023
00288          DISPLAY '*** 2310-CALCULATE-MAX-SIZE           ***'      03680023
00289          DISPLAY '*****************************************'      03690023
00290          PERFORM 9999-SQL-ABEND                                   03700023
00291      END-IF.                                                      03710023
00206                                                                   03720023
00261                                                                   03730023
00215 ******************************************************************03740023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          03750023
00218 * - WHEN NUMBER OF PARTITIONS IS GREATER THAN 254 CHECK THE       03760018
00218 *   PAGE SIZE TO DETERMINE THE MAXIMUM PARTITION SIZE.            03770018
00222 ******************************************************************03780023
00276                                                                   03790023
00260  2320-CHECK-PAGE-SIZE.                                            03800023
00278                                                                   03810023
00206      IF SYSTABSP-PGSIZE = 4                                       03820023
               MOVE 4 TO OUT-MAX-GIG                                    03830023
           ELSE                                                         03840023
               IF SYSTABSP-PGSIZE = 8                                   03850023
                   MOVE 8 TO OUT-MAX-GIG                                03860023
               ELSE                                                     03870023
                   IF SYSTABSP-PGSIZE = 16                              03880023
                       MOVE 16 TO OUT-MAX-GIG                           03890023
                   ELSE                                                 03900023
                       MOVE 32 TO OUT-MAX-GIG.                          03910023
                                                                        03920023
                                                                        03930023
00215 ******************************************************************03940023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          03950023
00218 * - PERFORM AN INITIAL READ ON THE INDEX LISTCAT FILE.            03960023
00222 ******************************************************************03970023
00223                                                                   03980023
00224  3000-PROCESS-IX-FILE.                                            03990023
00225                                                                   04000023
           MOVE 'N' TO WS-INPUT-EOF-SW.                                 04010023
           MOVE SPACES TO WS-PREVIOUS-DBNAME.                           04011024
                                                                        04020023
00167      PERFORM 3100-READ-IX-FILE.                                   04030023
00214                                                                   04040023
00270      IF WS-INPUT-EOF-SW = 'Y'                                     04050023
00363          MOVE +4013      TO WS-ABEND-CODE                         04060023
00364          DISPLAY '*****************************************'      04070023
00365          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      04080023
00366          DISPLAY '***                                   ***'      04090023
00367          DISPLAY '*** EMPTY INDEX LISTCAT FILE          ***'      04100023
00288          DISPLAY '*** 3000-PROCESS-IX-FILE.             ***'      04110023
00368          DISPLAY '*****************************************'      04120023
00369          PERFORM 9999-NONSQL-ABEND                                04130023
00370      END-IF.                                                      04140023
00371                                                                   04150023
00152      PERFORM 3200-PROCESS-IX-RECORD                               04160023
00170          UNTIL WS-INPUT-EOF-SW IS EQUAL TO 'Y'.                   04170023
00153                                                                   04180023
00153                                                                   04190023
00215 ******************************************************************04200023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          04210023
00218 * - READ THE INPUT FILE CONTAINING INDEX LISTCAT OUTPUT.          04220024
00222 ******************************************************************04230023
00223                                                                   04240023
00267  3100-READ-IX-FILE.                                               04250023
00268                                                                   04260023
00269      READ INPUT-IX-LISTCAT INTO WS-INPUT-RECORD                   04270023
00270          AT END MOVE 'Y' TO WS-INPUT-EOF-SW.                      04280023
00271                                                                   04290023
00225                                                                   04300023
00215 ******************************************************************04310023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          04320023
00218 * - PARSE THE INPUT RECORDS FOR EITHER A RECORD CONTAINING        04330023
00218 *   THE DATASET NAME OR A RECORD CONTAINING HI-USED-RBA.          04340023
00218 *   PERFORM THE APPROPRIATE PARAGRAPH IF FOUND.                   04350023
00218 * - READ THE NEXT INDEX LISTCAT RECORD.                           04360023
00222 ******************************************************************04370023
00223                                                                   04380023
00224  3200-PROCESS-IX-RECORD.                                          04390023
00225                                                                   04400023
           IF IN-DATASET-BYTES-1-17 = '0DATA ---------- '               04410023
               PERFORM 3300-PROCESS-DATASET-REC                         04420023
           ELSE                                                         04430023
               IF IN-HI-USED-BYTES-38-45 = 'HI-U-RBA'                   04440023
                   PERFORM 5000-PROCESS-HI-USED-REC                     04450024
               END-IF                                                   04460023
           END-IF.                                                      04470023
                                                                        04480023
00167      PERFORM 3100-READ-IX-FILE.                                   04490023
00214                                                                   04500023
00214                                                                   04510023
00215 ******************************************************************04520023
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          04530023
00218 * - EXTRACT THE DATASET NAME FROM THE LISTCAT RECORD              04540023
00218 * - PERFORM LOGIC TO GET THE MAXIMUM DATASET SIZE UPON A CHANGE   04550024
00218 *   IN DATABASE/INDEXSPACE.                                       04560024
00222 ******************************************************************04580023
00223                                                                   04590023
00224  3300-PROCESS-DATASET-REC.                                        04600023
00225                                                                   04610023
           MOVE IN-DATASET-NAME TO OUT-DATASET-NAME.                    04620023
                                                                        04630023
           UNSTRING IN-DATASET-NAME                                     04640023
              DELIMITED BY '.'                                          04650023
           INTO WS-DATASET-FIELD1                                       04660023
                WS-DATASET-FIELD2                                       04670023
                WS-DATASET-FIELD3                                       04680023
                WS-DATASET-FIELD4                                       04690023
                WS-DATASET-FIELD5                                       04700023
                WS-DATASET-FIELD6                                       04710023
           END-UNSTRING.                                                04720023
                                                                        04730023
           IF WS-DATASET-FIELD3 = WS-PREVIOUS-DBNAME                    04740023
               AND WS-DATASET-FIELD4 = WS-PREVIOUS-IXSPACE              04750023
                   NEXT SENTENCE                                        04760023
           ELSE                                                         04770023
               PERFORM 3310-GET-MAX-SIZE                                04780023
               MOVE WS-DATASET-FIELD3 TO WS-PREVIOUS-DBNAME             04790023
               MOVE WS-DATASET-FIELD4 TO WS-PREVIOUS-IXSPACE.           04800023
                                                                        04810023
                                                                        04820023
00215 ******************************************************************04830023
00216 * THIS PARAGRAPH GETS THE MAXIMUM SIZE FOR AN INDEX PARTITION     04840023
00218 * BASED ON ITS CORRESPONDING TABLESPACE.                          04850023
00222 ******************************************************************04860023
00223                                                                   04870023
00224  3310-GET-MAX-SIZE.                                               04880023
00225                                                                   04890023
           MOVE SPACES TO SYSTBL-TSNAME-TEXT.                           04900029
                                                                        04910023
           EXEC SQL                                                     04920023
             SELECT TBL.TSNAME                                          04930025
               INTO :SYSTBL-TSNAME                                      04940029
                  FROM SYSIBM.SYSTABLES  TBL,                           04950023
                       SYSIBM.SYSINDEXES IX                             04960025
               WHERE IX.DBNAME       = :WS-DATASET-FIELD3               04970023
                 AND IX.INDEXSPACE   = :WS-DATASET-FIELD4               04980023
                 AND IX.TBCREATOR    = TBL.CREATOR                      04990025
                 AND IX.TBNAME       = TBL.NAME   WITH UR               05000025
00281      END-EXEC.                                                    05010023
00282                                                                   05020023
00283      IF  SQLCODE NOT = ZERO                                       05030023
00284          MOVE +4013      TO WS-ABEND-CODE                         05040023
00285          DISPLAY '*****************************************'      05050023
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      05060023
00287          DISPLAY '***                                   ***'      05070023
00288          DISPLAY '***BAD SQL CALL - SYSTABLES/SYSINDEXES***'      05080023
00288          DISPLAY '*** 3310-GET-MAX-SIZE                 ***'      05090023
00289          DISPLAY '*****************************************'      05100023
00290          PERFORM 9999-SQL-ABEND                                   05110023
00291      END-IF.                                                      05120023
00206                                                                   05130023
           EXEC SQL                                                     05140023
             SELECT MAX_GIG_SIZE                                        05150023
               INTO :OUT-MAX-GIG                                        05160023
                  FROM SESSION.GTT                                      05170023
               WHERE DBNAME = :WS-DATASET-FIELD3                        05180023
                 AND TSNAME = :SYSTBL-TSNAME                            05190029
00281      END-EXEC.                                                    05200023
00282                                                                   05210023
00283      IF  SQLCODE NOT = ZERO                                       05220023
00284          MOVE +4013      TO WS-ABEND-CODE                         05230023
00285          DISPLAY '*****************************************'      05240023
00286          DISPLAY '*** PROGRAM ERROR - DBKUT026          ***'      05250023
00287          DISPLAY '***                                   ***'      05260023
00288          DISPLAY '*** BAD SQL CALL - GLOBAL TEMP TABLE  ***'      05270023
00288          DISPLAY '*** 3310-GET-MAX-SIZE                 ***'      05280023
00289          DISPLAY '*****************************************'      05290023
00290          PERFORM 9999-SQL-ABEND                                   05300023
00291      END-IF.                                                      05310023
00206                                                                   05320023
00261                                                                   05330023
00410 ******************************************************************05580023
00411 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          05590023
00413 * - CLOSE THE INPUT AND OUTPUT FILES                              05600023
00414 ******************************************************************05610023
00415                                                                   05620023
00416  4000-END-OF-JOB.                                                 05630024
00417                                                                   05640023
00422      CLOSE INPUT-TS-LISTCAT                                       05650023
00422            INPUT-IX-LISTCAT                                       05660023
00423            OUTPUT-FILE.                                           05670023
00424                                                                   05680023
00424                                                                   05690023
00215 ******************************************************************05691024
00216 * THIS PARAGRAPH PERFORMS THE FOLLOWING:                          05692024
00218 * - EXTRACT THE HI-USED RBA FIELD FROM THE LISTCAT RECORD         05693024
00218 * - CALCULATE THE PERCENT USED OF AVAILABLE SPACE IN THE DATASET  05694024
00218 * - SET FIELDS ON OUTPUT RECORD                                   05695024
00218 * - WRITE OUTPUT RECORD (IF PCT FILLED >= REPORT CUTOFF VALUE)    05696024
00222 ******************************************************************05697024
00276                                                                   05698024
00260  5000-PROCESS-HI-USED-REC.                                        05699024
00278                                                                   05699124
           INSPECT IN-HI-USED-BYTES-46-61                               05699224
               REPLACING ALL '-' BY '0'.                                05699324
           MOVE IN-HI-USED-BYTES-46-61 TO WS-HI-USED-RBA.               05699424
           DIVIDE WS-HI-USED-RBA BY WS-BYTES-IN-GIG                     05699524
               GIVING OUT-USED-GIG ROUNDED.                             05699624
           DIVIDE OUT-USED-GIG BY OUT-MAX-GIG                           05699724
               GIVING OUT-PCT-FULL ROUNDED.                             05699824
                                                                        05699924
           COMPUTE WS-PCT-FULL = OUT-PCT-FULL * 100.                    05700024
           IF WS-PCT-FULL >= WS-PCTFULL-CUTOFF                          05700124
               WRITE OUTPUT-FILE-REC FROM WS-OUTPUT-RECORD              05700224
           END-IF.                                                      05700324
00261                                                                   05700424
00371                                                                   05700524
00425 ************************************************************      05701023
00426 * THIS PARAGRAPH PERFORMS DB2 ABEND PROCESSING.            *      05710023
00428 ************************************************************      05720023
00429                                                                   05730023
00430  9999-SQL-ABEND.                                                  05740023
00431                                                                   05750023
00432      CALL 'DSNTIAR' USING SQLCA                                   05760023
00433                           DP004-FORMATTED-MESSAGE                 05770023
00434                           DP004-ERROR-LINE-LENGTH.                05780023
00435                                                                   05790023
00436      DISPLAY DP004-ASTERISK-LINE.                                 05800023
00437                                                                   05810023
00438      PERFORM                                                      05820023
00439          VARYING DP004-MSG-IDX                                    05830023
00440          FROM 1 BY 1                                              05840023
00441          UNTIL DP004-MSG-IDX > DP004-MAX-MESSAGE-LINES            05850023
00442              DISPLAY '**'                                         05860023
00443                      DP004-MESSAGE-LINE (DP004-MSG-IDX)           05870023
00444                      ' **'                                        05880023
00445      END-PERFORM.                                                 05890023
00446                                                                   05900023
00447      DISPLAY DP004-ASTERISK-LINE.                                 05910023
00448                                                                   05920023
00449      CALL 'ILBOABN0' USING WS-ABEND-CODE.                         05930023
00450                                                                   05940023
00450                                                                   05950023
00425 ************************************************************      05960023
00426 * THIS PARAGRAPH PERFORMS NON-DB2 ABEND PROCESSING.        *      05970023
00428 ************************************************************      05980023
00429                                                                   05990023
00430  9999-NONSQL-ABEND.                                               06000023
00448                                                                   06010023
00449      CALL 'ILBOABN0' USING WS-ABEND-CODE.                         06020023
00431                                                                   06030023
