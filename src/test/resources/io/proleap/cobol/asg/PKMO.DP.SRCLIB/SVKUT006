000100***************************************************************** 00010018
000200 IDENTIFICATION DIVISION.                                         00020018
000300***************************************************************** 00030018
000400                                                                  00040018
000500 PROGRAM-ID.             SVKUT006.                                00050018
000600 AUTHOR.                 BARB ERTL - SAFENET CONSULTING.          00060018
000700 INSTALLATION.           KOHLS.                                   00070018
000800 DATE-WRITTEN            AUGUST 2000.                             00080018
000900 DATE-COMPILED.                                                   00090018
001000                                                                  00100018
001100***************************************************************** 00110018
001200* * * *>>>   THIS PROGRAM MUST BE COMPILED COBOL/390   <<<* * * * 00120018
001300***************************************************************** 00130018
001400*                                                                 00140018
001500*  THIS PROGRAM WILL CREATE A FILE TO BE SENT TO THE STORE        00150018
001600*  SERVERS TO CREATE/UPDATE STORED VALUE CARD INFORMATION.        00160018
001700*                                                                 00170018
001800*  THE INPUT SVT_KOHLS_CRD_ACCT AND SVT_KOHLS_CRD_TXN TABLES      00180018
001900*  ARE USED TO GATHER THE INFORMATION TO CREATE AN OUTPUT         00190018
002000*  FILE TO SEND TO THE STORE SERVERS.                             00200018
002100*                                                                 00210018
002200*  AN INPUT FILE IS CREATED WITH FASTUNLOAD FOR ALL CARDS WITH    00220018
002300*  ACTIVITY YESTERDAY.  THIS FILE CONTAINS ONLY THE CARD NUMBER.  00230018
002400******************************************************************00240018
002500*  CHANGED 03/31/02 BY BARB ERTL                                  00250018
002600*   WR22603    - MULTI-CHANNEL GIFT CARD PROJECT                  00260018
002700*                CHANGE TO USE NEW STORED VALUE TABLES.           00270018
 02800***************************************************************** 00280036
      ******************************************************************00281036
      * CHANGE DATE: 05/17/2016                                         00282036
      * CHANGE MADE: RECOMPILE FOR SVWS004 AND SVRD022                  00283036
      * MADE BY    : ACCENTURE                   CHANGE# CHG0141575     00284037
      ******************************************************************00285036
002900***************************************************************** 00290018
003000***************************************************************** 00300018
003100 ENVIRONMENT DIVISION.                                            00310018
003200***************************************************************** 00320018
003300                                                                  00330018
003400 CONFIGURATION SECTION.                                           00340018
003500                                                                  00350018
003600 SOURCE-COMPUTER.        IBM-3090.                                00360018
003700 OBJECT-COMPUTER.        IBM-3090.                                00370018
003800                                                                  00380018
003900 INPUT-OUTPUT SECTION.                                            00390018
004000                                                                  00400018
004100 FILE-CONTROL.                                                    00410018
004200                                                                  00420018
004300     SELECT YEAR-PARAMETER-FILE                                   00430018
004400         ASSIGN TO INP01.                                         00440018
004500                                                                  00450018
004600     SELECT SV-ACTIVITY-FILE                                      00460018
004700         ASSIGN TO INP02.                                         00470018
004800                                                                  00480018
005110     SELECT SV-CARD-SQLS-FILE                                     00511029
005120         ASSIGN TO OUT01.                                         00512034
005130                                                                  00513029
005200******************************************************************00520018
005300 DATA DIVISION.                                                   00530018
005400******************************************************************00540018
005500                                                                  00550018
005600 FILE SECTION.                                                    00560018
005700                                                                  00570018
005800 FD  YEAR-PARAMETER-FILE                                          00580018
005900     RECORDING MODE IS F                                          00590018
006000     BLOCK CONTAINS 0 RECORDS                                     00600018
006100     LABEL RECORDS ARE STANDARD.                                  00610018
006200                                                                  00620018
006300 01  YEAR-PARAMETER-RCD              PIC X(80).                   00630018
006400                                                                  00640018
006500 FD  SV-ACTIVITY-FILE                                             00650018
006600     RECORDING MODE IS F                                          00660018
006700     BLOCK CONTAINS 0 RECORDS                                     00670018
006800     LABEL RECORDS ARE STANDARD.                                  00680018
006900                                                                  00690018
007000 01  ACTIVITY-RECORD                 PIC X(07).                   00700018
007100                                                                  00710018
007610 FD  SV-CARD-SQLS-FILE                                            00761029
007620     RECORDING MODE IS F                                          00762029
007630     BLOCK CONTAINS 0 RECORDS                                     00763029
007640     LABEL RECORDS ARE STANDARD.                                  00764029
007650                                                                  00765029
007660 01  SV-CARD-SQLS-RECORD             PIC  X(41).                  00766031
007670                                                                  00767029
007800******************************************************************00780018
007900 WORKING-STORAGE SECTION.                                         00790018
008000******************************************************************00800018
008100 01  FILLER                            PIC X(50)  VALUE           00810018
008200     ' *** WORKING STORAGE STARTS HERE FOR SVKUT006 *** '.        00820018
008300                                                                  00830018
008400******************************************************************00840018
008500* RECORD LAYOUT FOR ACTIVITY RECORD                               00850018
008600******************************************************************00860018
008700  01  SV-ACTIVITY.                                                00870018
008800      05  SV-CARD-NBR                  PIC S9(12) VALUE ZEROES    00880018
008900                                                  COMP-3.         00890018
009000                                                                  00900018
009100 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      00910018
009200                                                  COMP SYNC.      00920018
009300     88  AC-CONTROL-CARD-ERROR                    VALUE +4003.    00930018
009400     88  AC-TABLE-OVERFLOW-ERROR                  VALUE +4004.    00940018
009600     88  AC-DB2-ERROR                             VALUE +4013.    00960018
009700     88  AC-CALENDAR-ROUTINE-ERROR                VALUE +4019.    00970018
009800                                                                  00980034
009900 01  PS-PROGRAM-SWITCHES.                                         00990018
010000     05  PS-END-OF-BALANCE-SW          PIC X(01)  VALUE 'N'.      01000018
010100         88  PS-END-OF-BALANCE                    VALUE 'Y'.      01010018
010200         88  PS-NOT-END-OF-BALANCE                VALUE 'N'.      01020018
010300     05  PS-END-OF-ACTIVITY-SW         PIC X(01)  VALUE 'N'.      01030018
010400         88  PS-END-OF-ACTIVITY                   VALUE 'Y'.      01040018
010500                                                                  01050018
010600 01  PC-CONSTANTS.                                                01060018
010700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          01070018
010800                                                   'SVKUT006'.    01080018
011000 01  PV-MISC-FIELDS.                                              01100018
011100     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACE.   01110018
011200     05  PV-OPERATION-MSG-1          PIC  X(40)    VALUE SPACE.   01120018
011300     05  PV-OPERATION-MSG-2          PIC  X(40)    VALUE SPACE.   01130018
011400     05  PV-DB2-OPERATION            PIC  X(30)    VALUE SPACE.   01140018
011500     05  PV-SAVE-CARD-NBR            PIC S9(12)    VALUE ZERO     01150018
011600                                          COMP-3.                 01160018
011610* ----------------------------------------------------------------01161030
011620*  COUNTERS AND ACCUMULATORS                                      01162030
011630* ----------------------------------------------------------------01163030
011640 01  PV-PC-COUNTERS.                                              01164030
011650     05  PV-PC-ACTIVITY-CARDS-READ     PIC  9(09)  VALUE ZERO.    01165030
011660     05  PV-PC-TRANSACTIONS-FETCHED    PIC  9(09)  VALUE ZERO.    01166030
011680     05  PV-PC-SQLS-CARD-RCDS-WRITTEN  PIC  9(09)  VALUE ZERO.    01168030
011690                                                                  01169030
011800******************************************************************01180018
011900*  WS FIELDS FOR SVPD001                                          01190018
012000******************************************************************01200018
012100     COPY SVWS001.                                                01210033
012200******************************************************************01220018
012300*  DB2 TABLE DB2PDBA.SVT_KOHLS_CRD_ACCT                           01230018
012400*                  - KOHLS MERCHANDISE CARD TABLE                 01240018
012500******************************************************************01250018
012600     EXEC SQL                                                     01260032
012700          INCLUDE SVT00001                                        01270032
012800     END-EXEC.                                                    01280032
012900******************************************************************01290018
013000*  DB2 TABLE DB2PDBA.SVT_KOHLS_CRD_TXN                            01300018
013100*                  - KOHLS MERCHANDISE CARD ACTIVITY TABLE        01310018
013200******************************************************************01320018
013300     EXEC SQL                                                     01330018
013400          INCLUDE SVT00002                                        01340018
013500     END-EXEC.                                                    01350018
013600******************************************************************01360018
013700*  BALANCE CURSOR - SVT_KOHLS_CRD_TXN                             01370019
013800******************************************************************01380018
013900     EXEC SQL                                                     01390018
014000       DECLARE BALANCE-CSR CURSOR FOR                             01400018
014100           SELECT TRN_VOID_IND                                    01410018
014200                 ,STR_NBR                                         01420018
014300                 ,APP_AUTH_AMT                                    01430018
014400                 ,ST_CDE                                          01440021
014500           FROM   SVT_KOHLS_CRD_TXN                               01450019
014600           WHERE  CRD_NBR = :SV-CARD-NBR                          01460018
014700           WITH UR                                                01470018
014800     END-EXEC.                                                    01480018
014900***************************************************************** 01490018
015000* PROCEDURE DIVISION.                                           * 01500018
015100***************************************************************** 01510018
015200 PROCEDURE DIVISION.                                              01520018
015300                                                                  01530018
015400 0000-MAINLINE-PROCESSING.                                        01540018
015500                                                                  01550018
015600     PERFORM 1000-INITIALIZE-PROGRAM.                             01560018
015700     PERFORM 2100-READ-ACTIVITY.                                  01570018
015800                                                                  01580018
015900     PERFORM 2000-CREATE-FILE                                     01590018
016000       UNTIL PS-END-OF-ACTIVITY.                                  01600018
016100                                                                  01610018
016110     PERFORM 9990-DISPLAY-TOTALS.                                 01611029
016120                                                                  01612029
016200     CLOSE SV-ACTIVITY-FILE                                       01620018
016220           SV-CARD-SQLS-FILE.                                     01622029
016400                                                                  01640018
016500     GOBACK.                                                      01650018
016600                                                                  01660034
016700******************************************************************01670018
016800* 1000-INITIALIZE-PROGRAM                                         01680018
016900* OPEN FILES, GET CONTROL CARD, FORMAT GLOBAL REPORT HEADINGS.    01690018
017000* INITIALIZE TABLE 2.                                             01700018
017100******************************************************************01710018
017200 1000-INITIALIZE-PROGRAM.                                         01720018
017300                                                                  01730018
017400     OPEN INPUT  SV-ACTIVITY-FILE                                 01740018
017500          OUTPUT SV-CARD-SQLS-FILE.                               01750034
017600                                                                  01760018
017700     PERFORM SV001-1000-INITIALIZE.                               01770021
017800                                                                  01780018
017900     PERFORM SV001-2000-LOAD-STORE-TABLE.                         01790021
018000                                                                  01800018
018100******************************************************************01810018
018200* 2000-CREATE-FILE                                                01820018
018300*                                                                 01830018
018400******************************************************************01840018
018500 2000-CREATE-FILE.                                                01850018
018600                                                                  01860018
018700     IF PS-END-OF-ACTIVITY                                        01870018
018800         CONTINUE                                                 01880018
018900     ELSE                                                         01890018
019000         PERFORM 3000-PROCESS-ACTIVITY                            01900018
019100             UNTIL PS-END-OF-ACTIVITY                             01910018
019200     END-IF.                                                      01920018
019300                                                                  01930018
019400******************************************************************01940018
019500* 2100-READ-ACTIVITY                                              01950018
019600* READ ACTIVITY FILE                                              01960018
019700******************************************************************01970018
019800 2100-READ-ACTIVITY.                                              01980018
019900                                                                  01990018
020000     READ SV-ACTIVITY-FILE INTO SV-ACTIVITY                       02000018
020100        AT END                                                    02010018
020200           SET PS-END-OF-ACTIVITY TO TRUE.                        02020018
020300                                                                  02030018
020400******************************************************************02040018
020500* 3000-PROCESS-ACTIVITY                                           02050018
020600*                                                                 02060018
020700******************************************************************02070018
020800 3000-PROCESS-ACTIVITY.                                           02080018
020900                                                                  02090018
021000     IF SV-CARD-NBR = PV-SAVE-CARD-NBR                            02100018
021100         CONTINUE                                                 02110018
021200     ELSE                                                         02120018
021210         ADD +1 TO PV-PC-ACTIVITY-CARDS-READ                      02121030
021300         PERFORM 3100-PROCESS-CARD                                02130018
021400     END-IF.                                                      02140018
021500                                                                  02150018
021600     PERFORM 2100-READ-ACTIVITY.                                  02160018
021700                                                                  02170018
021800******************************************************************02180018
021900* 3100-PROCESS-CARD                                               02190018
022000*                                                                 02200018
022100******************************************************************02210018
022200 3100-PROCESS-CARD.                                               02220018
022300                                                                  02230018
022400     MOVE SV-CARD-NBR TO PV-SAVE-CARD-NBR.                        02240018
022500                                                                  02250018
022600     PERFORM 3200-READ-FOR-STATUS.                                02260018
022700                                                                  02270018
022800     SET SV001-PS-STORE-NOT-FOUND TO TRUE.                        02280022
022900     INITIALIZE SVWS001-CARD-METRO-TABLE.                         02290018
023000     MOVE ZERO              TO SV001-PV-CARD-METRO-SUB.           02300022
023100     MOVE SVT00001-STR-NBR  TO SV001-PV-ADD-STORE.                02310022
023200     MOVE SPACES            TO SV001-PV-STATE-CDE.                02320022
023300     MOVE ZERO              TO SV001-PV-STORE-SUB.                02330022
023400                                                                  02340018
023500     PERFORM SV001-3000-CHECK-STORE                               02350021
023600         UNTIL SV001-PS-STORE-FOUND                               02360022
023700            OR SV001-PV-STORE-SUB > SV001-PC-STORE-LIMIT.         02370022
023800                                                                  02380018
023900     SET PS-NOT-END-OF-BALANCE TO TRUE.                           02390018
024000     MOVE ZERO                 TO SV001-PV-CARD-BALANCE.          02400022
024100                                                                  02410018
024200     PERFORM 6600-OPEN-BALANCE-CURSOR.                            02420018
024300     PERFORM 6700-FETCH-BALANCE-CURSOR.                           02430018
024400                                                                  02440018
024500     PERFORM 4000-PROCESS-BALANCE                                 02450018
024600         UNTIL PS-END-OF-BALANCE.                                 02460018
024700                                                                  02470018
024800     PERFORM 6800-CLOSE-BALANCE-CURSOR.                           02480018
024900                                                                  02490018
025000     IF SV001-PV-CARD-BALANCE > ZERO                              02500024
025100         MOVE 'Y' TO SVT00008-CRD-RPLNT-IND                       02510024
025200         PERFORM 7000-WRITE-RECORD                                02520024
025300     ELSE                                                         02530024
025400         PERFORM 6900-READ-STOCK-INFO                             02540024
025500         PERFORM 7000-WRITE-RECORD                                02550024
025600     END-IF.                                                      02560024
025700                                                                  02570018
025800******************************************************************02580018
025900* 3200-READ-FOR-STATUS                                            02590018
025910*     - ADD CRD-PIN-NBR, CRD-TYP-CDE, CRD-SPCTY-TYP-CDE TO SELECT 02591029
026000******************************************************************02600018
026100 3200-READ-FOR-STATUS.                                            02610018
026200     EXEC SQL                                                     02620018
026300          SELECT CRD_STAT_CDE                                     02630018
026400                ,STR_NBR                                          02640018
026500                ,CRD_PROD_YR                                      02650027
026600                ,SHIPT_REQ_NBR                                    02660027
026610                ,CRD_PIN_NBR                                      02661029
026620                ,CRD_TYP_CDE                                      02662029
026630                ,CRD_SPCTY_TYP_CDE                                02663029
026700           INTO :SVT00001-CRD-STAT-CDE                            02670018
026800               ,:SVT00001-STR-NBR                                 02680018
026900               ,:SVT00001-CRD-PROD-YR                             02690027
027000               ,:SVT00001-SHIPT-REQ-NBR                           02700028
027010               ,:SVT00001-CRD-PIN-NBR                             02701029
027020               ,:SVT00001-CRD-TYP-CDE                             02702029
027030               ,:SVT00001-CRD-SPCTY-TYP-CDE                       02703029
027100           FROM SVT_KOHLS_CRD_ACCT                                02710018
027200          WHERE CRD_NBR = :SV-CARD-NBR                            02720018
027300     WITH UR                                                      02730018
027400     END-EXEC.                                                    02740018
027500                                                                  02750018
027600     EVALUATE TRUE                                                02760018
027700         WHEN SQLCODE = ZERO                                      02770018
027800             CONTINUE                                             02780018
027900         WHEN SQLWARN0 NOT EQUAL SPACE                            02790018
028000         WHEN SQLCODE NOT EQUAL ZERO                              02800018
028100             MOVE '3200-READ-FOR-STATUS'                          02810018
028200                                            TO PV-PARAGRAPH-NAME  02820018
028300             MOVE 'ERROR ON READ OF SVT_KOHLS_CRD_ACCT'           02830018
028400                                            TO PV-DB2-OPERATION   02840018
028500             PERFORM 9100-SQL-ABEND                               02850018
028600     END-EVALUATE.                                                02860018
028700                                                                  02870018
028800******************************************************************02880018
028900* 4000-PROCESS-BALANCE                                            02890018
029000*                                                                 02900018
029100******************************************************************02910018
029200 4000-PROCESS-BALANCE.                                            02920018
029300                                                                  02930018
029400     IF SVT00002-TRN-VOID-IND = 'Y'                               02940018
029500         CONTINUE                                                 02950018
029600     ELSE                                                         02960018
029700         ADD SVT00002-APP-AUTH-AMT TO SV001-PV-CARD-BALANCE       02970022
029800     END-IF.                                                      02980018
029900                                                                  02990018
030000     SET SV001-PS-STORE-NOT-FOUND TO TRUE.                        03000022
030100     MOVE SVT00002-STR-NBR  TO SV001-PV-ADD-STORE.                03010022
030200     MOVE SVT00002-ST-CDE   TO SV001-PV-STATE-CDE.                03020022
030300     MOVE ZERO              TO SV001-PV-STORE-SUB.                03030022
030400                                                                  03040018
030500     PERFORM SV001-3000-CHECK-STORE                               03050021
030600         UNTIL SV001-PS-STORE-FOUND                               03060022
030700            OR SV001-PV-STORE-SUB > SV001-PC-STORE-LIMIT.         03070022
030800                                                                  03080018
030900     IF SV001-PS-STORE-NOT-FOUND                                  03090024
031000         IF SV001-PV-STATE-CDE = SPACES                           03100024
031100             CONTINUE                                             03110026
031200         ELSE                                                     03120027
031300             PERFORM SV001-3100-FIND-METRO-BY-STATE               03130027
031400             VARYING SV001-PV-STATE-SUB FROM 1 BY 1               03140027
031500               UNTIL SV001-PV-STATE-SUB > SV001-PV-STORE-MAX      03150027
031600         END-IF                                                   03160027
031700     END-IF.                                                      03170027
031800                                                                  03180027
031900     PERFORM 6700-FETCH-BALANCE-CURSOR.                           03190018
032000                                                                  03200018
032100                                                                  03210018
032200******************************************************************03220018
032300* 6600-OPEN-BALANCE-CURSOR                                        03230018
032400*                                                                 03240018
032500******************************************************************03250018
032600 6600-OPEN-BALANCE-CURSOR.                                        03260018
032700     EXEC SQL                                                     03270018
032800          OPEN BALANCE-CSR                                        03280018
032900     END-EXEC.                                                    03290018
033000                                                                  03300018
033100     EVALUATE TRUE                                                03310018
033200         WHEN SQLCODE = ZERO                                      03320018
033300              CONTINUE                                            03330018
033400         WHEN SQLWARN0 NOT EQUAL SPACE                            03340018
033500         WHEN SQLCODE NOT EQUAL ZERO                              03350018
033600             MOVE '6600-OPEN-BALANCE-CURSOR '                     03360018
033700                                            TO PV-PARAGRAPH-NAME  03370018
033800             MOVE 'ERROR ON OPEN OF BALANCE-CSR '                 03380018
033900                                            TO PV-DB2-OPERATION   03390018
034000             PERFORM 9100-SQL-ABEND                               03400018
034100     END-EVALUATE.                                                03410018
034200                                                                  03420018
034300******************************************************************03430018
034400* 6700-FETCH-BALANCE-CURSOR                                       03440018
034500******************************************************************03450018
034600 6700-FETCH-BALANCE-CURSOR.                                       03460018
034700     EXEC SQL                                                     03470018
034800          FETCH BALANCE-CSR                                       03480018
034900           INTO :SVT00002-TRN-VOID-IND                            03490018
035000               ,:SVT00002-STR-NBR                                 03500018
035100               ,:SVT00002-APP-AUTH-AMT                            03510018
035200               ,:SVT00002-ST-CDE                                  03520021
035300     END-EXEC.                                                    03530018
035400                                                                  03540018
035500     EVALUATE TRUE                                                03550018
035600         WHEN SQLCODE = ZERO                                      03560018
035610             ADD +1 TO PV-PC-TRANSACTIONS-FETCHED                 03561030
035800         WHEN SQLCODE = +100                                      03580018
035900             SET PS-END-OF-BALANCE TO TRUE                        03590018
036000         WHEN SQLWARN0 NOT EQUAL SPACE                            03600018
036100         WHEN SQLCODE NOT EQUAL ZERO                              03610018
036200             MOVE '6700-FETCH-BALANCE-CURSOR'                     03620018
036300                                            TO PV-PARAGRAPH-NAME  03630018
036400             MOVE 'ERROR ON FETCH OF BALANCE-CSR'                 03640018
036500                                            TO PV-DB2-OPERATION   03650018
036600             PERFORM 9100-SQL-ABEND                               03660018
036700     END-EVALUATE.                                                03670018
036800                                                                  03680018
036900******************************************************************03690018
037000* 6800-CLOSE-BALANCE-CURSOR                                       03700018
037100*                                                                 03710018
037200******************************************************************03720018
037300 6800-CLOSE-BALANCE-CURSOR.                                       03730018
037400                                                                  03740018
037500     EXEC SQL                                                     03750018
037600          CLOSE BALANCE-CSR                                       03760018
037700     END-EXEC.                                                    03770018
037800                                                                  03780018
037900     EVALUATE TRUE                                                03790018
038000         WHEN SQLCODE = ZERO                                      03800018
038100              CONTINUE                                            03810018
038200         WHEN SQLWARN0 NOT EQUAL SPACE                            03820018
038300         WHEN SQLCODE NOT EQUAL ZERO                              03830018
038400             MOVE '6800-CLOSE-BALANCE-CURSOR'                     03840018
038500                                            TO PV-PARAGRAPH-NAME  03850018
038600             MOVE 'ERROR ON CLOSE OF BALANCE-CSR'                 03860018
038700                                            TO PV-DB2-OPERATION   03870018
038800             PERFORM 9100-SQL-ABEND                               03880018
038900     END-EVALUATE.                                                03890018
039000                                                                  03900027
039100******************************************************************03910027
039200* 6900-READ-STOCK-INFO                                            03920027
039300******************************************************************03930027
039400 6900-READ-STOCK-INFO.                                            03940027
039500     EXEC SQL                                                     03950027
039600          SELECT A.PRE_DNNTD_CRD_AMT                              03960027
039700                ,B.CRD_RPLNT_IND                                  03970027
039800           INTO :SVT00000-PRE-DNNTD-CRD-AMT                       03980027
039900               ,:SVT00008-CRD-RPLNT-IND                           03990027
040000           FROM SVT_CRD_PROD A,                                   04000027
040100                SVT_CRD_STK_DNMNTN B                              04010027
040200          WHERE A.CRD_TYP_CDE       =  B.CRD_TYP_CDE              04020027
040300            AND A.CRD_STK_TYP_ID    =  B.CRD_STK_TYP_ID           04030027
040400            AND A.PRE_DNNTD_CRD_AMT =  B.PRE_DNNTD_CRD_AMT        04040027
040500            AND A.CRD_PROD_YR       = :SVT00001-CRD-PROD-YR       04050027
040600            AND A.SHIPT_REQ_NBR     = :SVT00001-SHIPT-REQ-NBR     04060027
040700           WITH UR                                                04070027
040800     END-EXEC.                                                    04080027
040900                                                                  04090027
041000     EVALUATE TRUE                                                04100027
041100         WHEN SQLCODE = ZERO                                      04110027
041200             CONTINUE                                             04120027
041300         WHEN SQLWARN0 NOT EQUAL SPACE                            04130027
041400         WHEN SQLCODE NOT EQUAL ZERO                              04140027
041500             MOVE '6900-READ-STOCK-INFO'                          04150027
041600                                            TO PV-PARAGRAPH-NAME  04160027
041700             MOVE 'ERROR ON READ OF SVT_CRD_PROD   '              04170027
041800                                            TO PV-DB2-OPERATION   04180027
041900             PERFORM 9100-SQL-ABEND                               04190027
042000     END-EVALUATE.                                                04200027
042100                                                                  04210027
042200******************************************************************04220018
042300* 7000-WRITE-RECORD                                               04230018
042400* WRITE RECORDS FOR CARD TO BE SENT TO STORES                     04240018
042500******************************************************************04250018
042600 7000-WRITE-RECORD.                                               04260018
042700                                                                  04270018
042710     INITIALIZE SV060-CARD-RCD.                                   04271034
043000                                                                  04300018
043210     MOVE 'CHG'               TO SV060-FUL-CHG.                   04321034
043300     IF SVT00008-CRD-RPLNT-IND = 'Y' AND                          04330024
043400        SVT00001-CRD-STAT-CDE = 'AV'                              04340024
043510         SET SV060-ACTION-ADD       TO TRUE                       04351029
043600         MOVE SV001-PV-CARD-BALANCE TO SV060-SVC-BAL-AMT          04360034
043700     ELSE                                                         04370018
043810         SET SV060-ACTION-DELETE    TO TRUE                       04381029
043900         MOVE ZERO                  TO SV060-SVC-BAL-AMT          04390034
044000     END-IF                                                       04400018
044100                                                                  04410018
044200     MOVE SV-CARD-NBR         TO SV060-SVC-NBR.                   04420034
044400                                                                  04440018
044410*    POPULATE ADDITIONAL FIELDS FOR SQL SERVER OFF-LINE FILE.     04441029
044420*    MOVE SVT00001-CRD-PIN-NBR       TO SV060-SVC-PIN-NBR.        04442029
044430     MOVE SVT00001-CRD-TYP-CDE       TO SV060-SVC-TYP-CDE.        04443029
044440     MOVE SVT00001-CRD-SPCTY-TYP-CDE TO SV060-SVC-SPCTY-TYP-CDE.  04444029
044450                                                                  04445029
044500     SET SV001-PS-NOT-END-OF-METRO TO TRUE.                       04450022
044600     MOVE ZERO TO SV001-PV-CARD-METRO-SUB.                        04460022
044700     MOVE SPACES TO SV060-EXC-STORE.                              04470034
044800                                                                  04480018
044900     PERFORM SV001-5000-GET-METRO-AREA                            04490021
045000         UNTIL SV001-PS-END-OF-METRO                              04500022
045100            OR SV001-PV-CARD-METRO-SUB GREATER THAN               04510022
045200               SV001-PC-METRO-TABLE-LIMIT.                        04520022
045300                                                                  04530018
045400******************************************************************04540018
045500* COPYBOOK FOR PROCEDURE STATEMENTS USED IN CREATING STORED VALUE 04550018
045600* RECORDS TO BE SENT TO STORES FOR OFFLINES.                      04560018
045700******************************************************************04570018
045800     COPY SVPD001.                                                04580033
045820                                                                  04582033
045900******************************************************************04590018
046000* 9100-SQL-ABEND - PERFORMS THE ABEND FOR THE PROGRAM IN THE      04600018
046100* EVENT THAT AN SQL ERROR OR WARNING CODE OCCURS.                 04610018
046200******************************************************************04620018
046300 9100-SQL-ABEND.                                                  04630018
046310     PERFORM 9990-DISPLAY-TOTALS.                                 04631030
046400     DISPLAY '** ABEND     **'.                                   04640018
046500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04650018
046600     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04660018
046700     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               04670018
046800                                                                  04680018
046900******************************************************************04690018
047000* COPY BOOK CONTAINING PROCEDURE DIVISION STATEMENTS REQUIRED     04700018
047100* TO UTILIZE SQLCA MESSAGE DISPLAY MODULE 'DSNTIAR' FOLLOWS.      04710018
047200******************************************************************04720018
047300     COPY DPPD004.                                                04730024
047400                                                                  04740018
047500     SET AC-DB2-ERROR TO TRUE.                                    04750018
047600     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04760018
047700                                                                  04770018
047710******************************************************************04771030
047720* 9990-DISPLAY-TOTALS.                                            04772030
047730*  DISPLAY TOTALS AT END OF JOB.                                  04773030
047740******************************************************************04774030
047750 9990-DISPLAY-TOTALS.                                             04775030
047760                                                                  04776030
047770     DISPLAY '*************************************'.             04777030
047780     DISPLAY 'ACTIVITY CARDS READ ==> ' PV-PC-ACTIVITY-CARDS-READ.04778030
047791     DISPLAY 'TRANSACTIONS FETCHED => ' PV-PC-TRANSACTIONS-FETCHED04779130
047793     DISPLAY 'SV001 SQLS RCDS OUT ==> ' SV001-PV-SV060-WRITE-CNT. 04779330
047794     DISPLAY 'STORE FETCH COUNT ====> ' SV001-PV-STORE-FETCH-CNT. 04779430
047795     DISPLAY '*************************************'.             04779530
047796                                                                  04779630
047800******************************************************************04780018
047900* 9999-ABEND - PERFORMS A NON-SQL-ABEND                           04790018
048000******************************************************************04800018
048100 9999-ABEND.                                                      04810018
048200     DISPLAY '** ABEND           **'.                             04820018
048300     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME.  04830018
048400     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        04840018
048500     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       04850018
048600     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       04860018
048700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04870018
