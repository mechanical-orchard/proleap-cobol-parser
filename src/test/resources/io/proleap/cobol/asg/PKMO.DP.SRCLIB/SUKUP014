000100***************************************************************** 00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300***************************************************************** 00030001
000400*                                                                 00040001
000500 PROGRAM-ID.             SUKUP014.                                00050001
000600 AUTHOR.                 DENISE HAHN.                             00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN.           AUGUST 2003.                             00080014
000900 DATE-COMPILED.                                                   00090001
001000*                                                                 00100001
001100***************************************************************** 00110001
001200* THIS PROGRAM WILL BE USED TO DELETE ROWS FROM THE OUTBOUND      00120001
001300* CARTON DATABASE (SUT_OTBND_CART), UPDATE FINANCIAL ADJUSTMENT   00130001
001310* DATABASE (SUT_FINCL_ADJ) TO CLEAR OUT THE SML NUMBERS BEING     00131001
001320* PURGED.                                                         00132003
001400***************************************************************** 00140001
001500 ENVIRONMENT DIVISION.                                            00150001
001600***************************************************************** 00160001
001700 CONFIGURATION SECTION.                                           00170001
001800 SOURCE-COMPUTER.                        IBM-3090.                00180001
001900 OBJECT-COMPUTER.                        IBM-3090.                00190001
002000 INPUT-OUTPUT SECTION.                                            00200001
002100 FILE-CONTROL.                                                    00210001
002200                                                                  00220001
002300     SELECT EXTRACT-FILE                                          00230001
002400         ASSIGN TO INP01.                                         00240001
002500/                                                                 00250001
002600***************************************************************** 00260001
002700 DATA DIVISION.                                                   00270001
002800***************************************************************** 00280001
002900 FILE SECTION.                                                    00290001
003000                                                                  00300001
003100 FD  EXTRACT-FILE                                                 00310001
003200     RECORDING MODE IS F                                          00320001
003300     LABEL RECORDS ARE STANDARD                                   00330001
003400     BLOCK CONTAINS 0 RECORDS.                                    00340001
003500 01  EXTRACT-RECORD                   PIC X(100).                 00350002
003600/                                                                 00360001
003700***************************************************************** 00370001
003800 WORKING-STORAGE SECTION.                                         00380001
003900***************************************************************** 00390001
004000                                                                  00400001
004100 01  PS-SWITCHES.                                                 00410001
004200     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00420001
004300         88  PS-END-OF-INPUT                    VALUE 'Y'.        00430001
004400         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00440001
004500                                                                  00450001
004600 01  PV-VARIABLES.                                                00460001
004700     05  PV-COUNT                     PIC  9(09) VALUE ZERO.      00470010
004710     05  PV-COMMIT-CNT                PIC  9(09) VALUE ZERO.      00471010
004800     05  PV-READ-CNT                  PIC  9(09) VALUE ZERO.      00480008
004900     05  PV-FINCL-ADJ-CNT             PIC  9(09) VALUE ZERO.      00490008
005300     05  PV-OTBND-DELETE-CNT          PIC  9(09) VALUE ZERO.      00530008
005400     05  PV-OTBND-DUPLCT-CNT          PIC  9(09) VALUE ZERO.      00540008
005401     05  PV-SKIP-CNT                  PIC  9(09) VALUE ZERO.      00540109
005402     05  PV-DISPLAY-CNT-PRC-MSG       PIC  9(09) VALUE ZERO.      00540215
005410     05  PV-OTBND-NOT-FND-CNT         PIC  9(09) VALUE ZERO.      00541008
005500     05  PV-DISPLAY-CNT               PIC  ZZZ,ZZZ,ZZ9.           00550005
005600     05  PV-PREVIOUS-SML              PIC  9(18) VALUE ZERO.      00560008
008600                                                                  00860001
008700******************************************************************00870001
008800 01  PV-ABEND-FIELDS.                                             00880001
008900     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00890001
009000                                                 COMP SYNC.       00900001
009100     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP014'.00910001
009200     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00920001
009300     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    00930001
009400     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    00940005
009500     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    00950005
009600     05  PV-ABEND-STRUCTURE-3         PIC  X(08) VALUE SPACES.    00960005
009700     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00970001
009800     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00980001
009900     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00990001
009910     05  PV-DB2-FUNCTION              PIC  X(50) VALUE SPACES.    00991005
010000/                                                                 01000001
010100 01  PC-CONSTANTS.                                                01010001
010200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP014'. 01020001
010500     05  PC-COMMIT-HOLD               PIC 9(3)  VALUE 100.        01050010
010510     05  PC-COUNT-HOLD                PIC 9(9)  VALUE 100000.     01051010
010600                                                                  01060002
010700******************************************************************01070001
010800*  LAYOUT FOR EXTRACT FILE                                        01080002
010900******************************************************************01090001
011000     COPY SURD049.                                                01100002
011100*                                                                 01110001
012200******************************************************************01220001
012300*  DB2 FORMATTED MESSAGE AREA                                     01230001
012400******************************************************************01240001
012500     COPY DPWS004.                                                01250001
012600                                                                  01260002
013200******************************************************************01320001
013300*   DB2 SQL COMMUNICATION AREA                                    01330001
013400******************************************************************01340001
013500     EXEC SQL                                                     01350001
013600         INCLUDE SQLCA                                            01360001
013700     END-EXEC.                                                    01370001
013800*                                                                 01380001
013900     COPY SQLCA2.                                                 01390001
014000*                                                                 01400001
014100******************************************************************01410001
014200*   FINANCIAL ADJUSTMENT DATABASE - SUT_FINCL_ADJ                 01420002
014300******************************************************************01430001
014400*                                                                 01440001
014500     EXEC SQL                                                     01450001
014600         INCLUDE SUT00030                                         01460002
014700     END-EXEC.                                                    01470001
014800*                                                                 01480001
014810******************************************************************01481003
014820*   SU-OUTBOUND CARTON DATABASE - SUT_OTBND_CART                  01482003
014830******************************************************************01483003
014840*                                                                 01484003
014850     EXEC SQL                                                     01485003
014860         INCLUDE SUT00024                                         01486003
014870     END-EXEC.                                                    01487003
014880*                                                                 01488003
014890******************************************************************01489012
014891*   SU-OUTBOUND CARTON DATABASE - SUT_PRC_MSG_CNTL                01489112
014892******************************************************************01489212
014893*                                                                 01489312
014894     EXEC SQL                                                     01489412
014895         INCLUDE SUT00094                                         01489512
014896     END-EXEC.                                                    01489612
014897*                                                                 01489712
014900******************************************************************01490001
015000 PROCEDURE DIVISION.                                              01500001
015100******************************************************************01510001
015200 0000-MAINLINE.                                                   01520001
015300                                                                  01530001
015400     PERFORM 1000-INITIALIZE.                                     01540001
015500                                                                  01550001
015600     PERFORM 2000-PROCESS-EXTRACT                                 01560001
015700         UNTIL PS-END-OF-INPUT.                                   01570001
015800                                                                  01580001
015900     PERFORM 9000-EOJ.                                            01590001
016000                                                                  01600001
016100      GOBACK.                                                     01610001
016200                                                                  01620001
016300******************************************************************01630001
016400*  INITIALIZATION TASKS.                                          01640001
016500*    -- OPEN INPUT FILE                                           01650001
016600*    -- READ FILE                                                 01660001
016700******************************************************************01670001
016800 1000-INITIALIZE.                                                 01680001
016900                                                                  01690001
017000     OPEN INPUT  EXTRACT-FILE.                                    01700001
017100                                                                  01710001
017200     PERFORM 2100-READ-EXTRACT.                                   01720001
017300/                                                                 01730001
017400******************************************************************01740001
017500 2000-PROCESS-EXTRACT.                                            01750001
017600******************************************************************01760001
017700*                                                                 01770001
017701     IF  PV-COUNT  <  PC-COUNT-HOLD                               01770110
017702         CONTINUE                                                 01770210
017703     ELSE                                                         01770310
017704         MOVE PV-READ-CNT  TO  PV-DISPLAY-CNT                     01770410
017705         DISPLAY 'READ:  '     PV-DISPLAY-CNT                     01770510
017706         MOVE  ZEROES  TO      PV-COUNT                           01770610
017707     END-IF.                                                      01770710
017708                                                                  01770810
017710     IF  SU049-SML  =  PV-PREVIOUS-SML                            01771008
017720         ADD  1    TO  PV-OTBND-DUPLCT-CNT                        01772008
017730     ELSE                                                         01773008
017740     IF  SU049-PURGE-NO                                           01774008
017750         ADD  1    TO  PV-SKIP-CNT                                01775008
017760     ELSE                                                         01776008
017800         PERFORM 8000-UPDATE-FINCL-ADJ-RECS                       01780008
017810         PERFORM 8100-DELETE-OTBND-CART                           01781008
017811         IF SQLCODE = -532                                        01781112
017820            PERFORM 8200-DELETE-PROCESS-MSG                       01782012
017821            PERFORM 8100-DELETE-OTBND-CART                        01782112
017822         END-IF                                                   01782212
017823         ADD +1 TO PV-COMMIT-CNT                                  01782308
017824     END-IF                                                       01782408
017825     END-IF.                                                      01782508
017830                                                                  01783008
017840     MOVE SU049-SML  TO  PV-PREVIOUS-SML.                         01784008
017850                                                                  01785008
018000                                                                  01800001
018100     IF PV-COMMIT-CNT > PC-COMMIT-HOLD                            01810002
018200         PERFORM 2200-COMMIT-DELETE                               01820001
018300     END-IF.                                                      01830001
018400                                                                  01840001
018500     PERFORM 2100-READ-EXTRACT.                                   01850001
018600*                                                                 01860001
018700******************************************************************01870001
018800*  READ NEXT INPUT FILE RECORD.                                   01880001
018900******************************************************************01890001
019000 2100-READ-EXTRACT.                                               01900001
019100                                                                  01910001
019200     READ EXTRACT-FILE INTO SU049-EXTRACT-RECORD                  01920005
019300        AT END                                                    01930001
019400           SET PS-END-OF-INPUT TO TRUE                            01940001
019500        NOT AT END                                                01950001
019600           ADD +1                   TO PV-READ-CNT                01960002
019610                                       PV-COUNT                   01961011
019700     END-READ.                                                    01970001
019800*                                                                 01980001
019900******************************************************************01990001
020000* COMMIT THE DELETE FROM ERROR TABLE                              02000001
020100******************************************************************02010001
020200 2200-COMMIT-DELETE.                                              02020001
020300                                                                  02030001
020400      EXEC SQL                                                    02040001
020500         COMMIT                                                   02050001
020600      END-EXEC                                                    02060001
020700                                                                  02070001
020900      MOVE +0 TO PV-COMMIT-CNT.                                   02090002
021000                                                                  02100001
021100*                                                                 02110001
021200******************************************************************02120001
021300* CLEAR OUT THE SML NUMBER ON THE FINANCIAL ADJUSTMENT DATABASE   02130002
021310* FOR THE CARTON BEING DELETED.                                   02131002
021400******************************************************************02140001
021500 8000-UPDATE-FINCL-ADJ-RECS.                                      02150002
021600                                                                  02160001
021700     EXEC SQL                                                     02170001
021900          UPDATE SUT_FINCL_ADJ                                    02190005
022000             SET SHIPT_UNT_ID  =  NULL                            02200007
022010           WHERE SHIPT_UNT_ID  = :SU049-SML                       02201005
022600     END-EXEC.                                                    02260001
022700                                                                  02270001
022800     EVALUATE TRUE                                                02280001
022900         WHEN SQLCODE = 0                                         02290001
023000              ADD +1           TO PV-FINCL-ADJ-CNT                02300002
023100         WHEN SQLCODE = +100                                      02310001
023200              CONTINUE                                            02320002
023300         WHEN SQLCODE < 0                                         02330001
023400         WHEN SQLCODE > 0                                         02340001
023500         WHEN SQLWARN0 = 'W'                                      02350001
023600             MOVE '8000-UPDATE-FINCL-ADJ-RECS'                    02360002
023700                         TO PV-ABEND-PARAGRAPH                    02370005
023800             MOVE 'UPDATE SUT_FINCL_ADJ'                          02380002
023900                         TO PV-DB2-FUNCTION                       02390001
024000             PERFORM 9200-SQL-ABEND                               02400001
024100     END-EVALUATE.                                                02410001
024200                                                                  02420002
024201                                                                  02420102
024210******************************************************************02421002
024220* DELETE THE OUTBOUND DATABASE                                    02422002
024230******************************************************************02423002
024240 8100-DELETE-OTBND-CART.                                          02424002
024250                                                                  02425002
024260     EXEC SQL                                                     02426002
024270          DELETE                                                  02427005
024280            FROM  SUT_OTBND_CART                                  02428005
024290           WHERE SHIPT_UNT_ID  = :SU049-SML                       02429005
024296     END-EXEC.                                                    02429602
024297                                                                  02429702
024298     EVALUATE TRUE                                                02429802
024299         WHEN SQLCODE = 0                                         02429902
024300             ADD +1           TO PV-OTBND-DELETE-CNT              02430005
024301         WHEN SQLCODE = +100                                      02430102
024302             ADD +1           TO PV-OTBND-NOT-FND-CNT             02430205
024303         WHEN SQLCODE = -532                                      02430312
024304             CONTINUE                                             02430412
024307         WHEN SQLCODE < 0                                         02430712
024308         WHEN SQLCODE > 0                                         02430812
024309         WHEN SQLWARN0 = 'W'                                      02430912
024310             MOVE '8100-DELETE-OTBND-CART  '                      02431012
024311                         TO PV-ABEND-PARAGRAPH                    02431112
024312             MOVE 'DELETE OF SUT_OTBND_CART '                     02431212
024313                         TO PV-DB2-FUNCTION                       02431312
024314             PERFORM 9200-SQL-ABEND                               02431412
024315     END-EVALUATE.                                                02431512
024316/                                                                 02431612
024317******************************************************************02431712
024318* DELETE PROCESS MESSAGE CARTON                                   02431812
024319******************************************************************02431912
024320 8200-DELETE-PROCESS-MSG.                                         02432012
024321                                                                  02432112
024322     EXEC SQL                                                     02432212
024323          DELETE                                                  02432312
024324            FROM  SUT_PRC_MSG_CNTL                                02432412
024325           WHERE SHIPT_UNT_ID  = :SU049-SML                       02432512
024326     END-EXEC.                                                    02432612
024327                                                                  02432712
024328     EVALUATE TRUE                                                02432812
024329         WHEN SQLCODE = 0                                         02432912
024330              ADD +1 TO PV-DISPLAY-CNT-PRC-MSG                    02433015
024331              DISPLAY 'PROCESS MSG CRTN  '                        02433116
024332              DISPLAY '*** SML         = ' SU049-DISPLAY-SML      02433216
024333         WHEN SQLCODE = +100                                      02433316
024334             CONTINUE                                             02433412
024335         WHEN SQLCODE < 0                                         02433512
024336         WHEN SQLCODE > 0                                         02433612
024337         WHEN SQLWARN0 = 'W'                                      02433712
024338             MOVE '8200-DELETE-PROCESS-MSG '                      02433812
024339                         TO PV-ABEND-PARAGRAPH                    02433912
024340             MOVE 'DELETE OF SUT_PRC_MSG_CNTL '                   02434012
024341                         TO PV-DB2-FUNCTION                       02434112
024342             PERFORM 9200-SQL-ABEND                               02434212
024343     END-EVALUATE.                                                02434312
024344/                                                                 02434412
024350******************************************************************02435012
024400*CLOSE INPUT FILE.                                                02440001
024500******************************************************************02450001
024600 9000-EOJ.                                                        02460001
024700*                                                                 02470001
024800     CLOSE EXTRACT-FILE.                                          02480001
024900                                                                  02490001
025000     MOVE PV-READ-CNT           TO PV-DISPLAY-CNT.                02500005
025100     DISPLAY 'READ:              ' PV-DISPLAY-CNT.                02510005
025200     MOVE PV-FINCL-ADJ-CNT      TO PV-DISPLAY-CNT.                02520005
025300     DISPLAY 'FINCL-ADJ UPDATES: ' PV-DISPLAY-CNT.                02530005
025400     MOVE PV-OTBND-DELETE-CNT   TO PV-DISPLAY-CNT.                02540005
025500     DISPLAY 'OTBND-CART DELETE: ' PV-DISPLAY-CNT.                02550005
025510     MOVE PV-OTBND-DUPLCT-CNT   TO PV-DISPLAY-CNT.                02551005
025520     DISPLAY 'OTBND-CART DUPLCT: ' PV-DISPLAY-CNT.                02552005
025530     MOVE PV-OTBND-NOT-FND-CNT  TO PV-DISPLAY-CNT.                02553005
025540     DISPLAY 'OTBND-CART NOT FD: ' PV-DISPLAY-CNT.                02554005
025550     MOVE PV-SKIP-CNT           TO PV-DISPLAY-CNT.                02555008
025560     DISPLAY 'SKIP COUNT:        ' PV-DISPLAY-CNT.                02556008
025561     MOVE PV-DISPLAY-CNT-PRC-MSG TO PV-DISPLAY-CNT.               02556115
025570     DISPLAY 'PRC MSG COUNT:     ' PV-DISPLAY-CNT.                02557015
025600                                                                  02560003
025700******************************************************************02570001
025800 9200-SQL-ABEND.                                                  02580001
025900******************************************************************02590001
026000                                                                  02600001
026100     MOVE SQLCODE                     TO SQLCODE2.                02610001
026200     MOVE SQLERRD(3)                  TO SQLERRD3.                02620001
026300                                                                  02630001
026400     DISPLAY '** ABEND **         ** = SQLERROR'.                 02640001
026500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02650001
026600     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02660005
026700     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02670001
026800     DISPLAY '*** SML         = ' SU049-DISPLAY-SML.              02680006
026900     DISPLAY '*** POR         = ' SU049-DISPLAY-PO.               02690006
027000     DISPLAY '*** RECEIVER    = ' SU049-DISPLAY-RCVR.             02700006
027100                                                                  02710001
027200     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02720001
027300     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02730001
027400     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02740001
027500     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02750001
027600                                                                  02760001
027700                                                                  02770001
027800     MOVE +4013                       TO PV-ABEND-CODE.           02780001
027900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02790001
028000                                                                  02800001
