000100 IDENTIFICATION DIVISION.                                         00010009
000200                                                                  00020009
000300 PROGRAM-ID.             VLKUT041.                                00030009
000400 AUTHOR.                 DAN HINTZ.                               00040009
000500 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00050009
000600 DATE-WRITTEN.           NOVEMBER 2007.                           00060009
000700 DATE-COMPILED.                                                   00070009
000800                                                                  00080009
000900*                                                                 00090009
001000*  PROGRAM NARRATIVE:                                             00100009
001100*  THIS PROGRAM WILL READ AN EXTRACT FILE THAT CONTAINS ITEM      00110009
001200*  DATA AND ADD UNIT COST AND RETAIL COST AMOUNT INFORMATION      00120009
001300*  TO EACH RECORD IN THE FILE. THIS UPDATED EXTRACT FILE WILL     00130009
001400*  GET SENT TO COMPLIANCE NETWORKS.                               00140009
001500*                                                                 00150009
001600*  AN ITEM EXTRACT FILE IS ALSO CREATED THAT IS SENT TO GENCO.    00160009
001700*  THE ONLY DIFFERENCE FOR GENCO IS THE WAY RETAIL COST IS        00170009
001800*  CALCULATED.  IF GROUP PRICING EXISTS FOR THE ITEM, THE RETAIL  00180009
001900*  COST IS CALCULATED BY TAKING RETAIL COST DIVIDED BY GROUP QTY. 00190009
002000*  OTHERWISE, THE RETAIL COST ON XLV_SKU_STR FOR THAT ITEM IS     00200009
002100*  USED.                                                          00210009
002200*                                                                 00220009
002300*                                                                 00230009
002400 ENVIRONMENT DIVISION.                                            00240009
002500                                                                  00250009
002600 CONFIGURATION SECTION.                                           00260009
002700                                                                  00270009
002800 SOURCE-COMPUTER.                        IBM-3090.                00280009
002900 OBJECT-COMPUTER.                        IBM-3090.                00290009
003000                                                                  00300009
003100 INPUT-OUTPUT SECTION.                                            00310009
003200                                                                  00320009
003300 FILE-CONTROL.                                                    00330009
003400                                                                  00340009
003500     SELECT  VL-ITEM-IN-FILE                                      00350009
003600         ASSIGN TO INP01.                                         00360009
003700                                                                  00370009
003800     SELECT  VL-ITEM-OUT-FILE                                     00380009
003900         ASSIGN TO OUT01.                                         00390009
004000                                                                  00400009
004100     SELECT  GENCO-ITEM-FILE                                      00410009
004200         ASSIGN TO OUT02.                                         00420009
004300                                                                  00430011
004400*CHG101105 - START                                                00440019
004500     SELECT  ERROR-FILE                                           00450009
004600         ASSIGN TO OUT03.                                         00460009
004700*CHG101105 - END                                                  00470019
004800                                                                  00480009
004900******************************************************************00490009
005000 DATA DIVISION.                                                   00500009
005100******************************************************************00510009
005200                                                                  00520009
005300 FILE SECTION.                                                    00530009
005400*                                                                 00540009
005500 FD  VL-ITEM-IN-FILE                                              00550009
005600     RECORDING MODE IS F                                          00560009
005700     LABEL RECORDS ARE STANDARD                                   00570009
005800     BLOCK CONTAINS 0 RECORDS.                                    00580009
005900 01  VL-ITEM-IN-RECORD                PIC  X(278).                00590009
006000*                                                                 00600009
006100 FD  VL-ITEM-OUT-FILE                                             00610009
006200     RECORDING MODE IS F                                          00620009
006300     LABEL RECORDS ARE STANDARD                                   00630009
006400     BLOCK CONTAINS 0 RECORDS.                                    00640009
006500 01  VL-ITEM-OUT-RECORD               PIC  X(296).                00650009
006600*                                                                 00660009
006700 FD  GENCO-ITEM-FILE                                              00670009
006800     RECORDING MODE IS F                                          00680009
006900     LABEL RECORDS ARE STANDARD                                   00690009
007000     BLOCK CONTAINS 0 RECORDS.                                    00700009
007100 01  GENCO-ITEM-RECORD                PIC  X(296).                00710009
007200*                                                                 00720009
007300*CHG101105 - START                                                00730019
007400 FD  ERROR-FILE                                                   00740009
007500     RECORDING MODE IS F                                          00750009
007600     LABEL RECORDS ARE STANDARD                                   00760009
007700     BLOCK CONTAINS 0 RECORDS.                                    00770009
007800 01  ERROR-UPC-RECORD                 PIC  9(10).                 00780009
007900*CHG101105 - END                                                  00790019
008000*                                                                 00800009
008100 WORKING-STORAGE SECTION.                                         00810009
008200*                                                                 00820009
008300***************************************************************** 00830009
008400*    PROGRAM CONSTANTS                                            00840009
008500***************************************************************** 00850009
008600 01  PC-CONSTANTS.                                                00860009
008700     05  PC-CURRENT-PGM-VLKUT041      PIC  X(08) VALUE 'VLKUT041'.00870009
008800     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3         00880009
008900                                                 COMP SYNC.       00890009
009000                                                                  00900009
009100***************************************************************** 00910009
009200*    PROGRAM SWITCHES                                             00920009
009300***************************************************************** 00930009
009400 01  PS-SWITCHES.                                                 00940009
009500     05  PS-END-EXT-FILE-IN-SW        PIC  X(01) VALUE 'N'.       00950009
009600         88  PS-END-EXT-FILE-IN                  VALUE 'Y'.       00960009
009700         88  PS-NOT-END-EXT-FILE-IN              VALUE 'N'.       00970009
009800     05  PS-GROUP-RETAIL-SW           PIC  X(01) VALUE 'N'.       00980009
009900         88  PS-GROUP-RETAIL                     VALUE 'Y'.       00990009
010000         88  PS-GROUP-RETAIL-NO                  VALUE 'N'.       01000009
010100                                                                  01010009
010200***************************************************************** 01020009
010300*    PROGRAM VARIABLES                                            01030009
010400***************************************************************** 01040009
010500 01  PV-VARIABLES.                                                01050009
010600     05  PV-RETRY-COUNT               PIC S9(04) VALUE +0         01060009
010700                                                 COMP SYNC.       01070009
010800     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       01080009
010900                                                 COMP SYNC.       01090009
011000     05  PV-CURR-INTR-UPC-ID          PIC S9(09) VALUE ZERO       01100009
011100                                                 COMP SYNC.       01110009
011200*CHG101105 - START                                                01120019
011300     05  PV-CURR-INTR-UPC-ID-OP       PIC -9(10) VALUE ZERO.      01130011
011400*CHG101105 - END                                                  01140019
011500     05  PV-PARAGRAPH                 PIC  X(30) VALUE SPACES.    01150009
011600     05  PV-DB2-FUNCTION              PIC  X(30) VALUE SPACES.    01160009
011700     05  PV-ABEND-TABLE-1             PIC  X(20) VALUE SPACES.    01170009
011800     05  PV-ERROR-MSG                 PIC  X(60) VALUE SPACES.    01180009
011900     05  PV-EXT-FILE-RECS-READ        PIC  9(09) VALUE ZERO.      01190009
012000     05  PV-EXT-FILE-RECS-WRITTEN     PIC  9(09) VALUE ZERO.      01200009
012100     05  PV-GENCO-RECS-WRITTEN        PIC  9(09) VALUE ZERO.      01210009
012200*CHG101105 - START                                                01220019
012300     05  PV-ERROR-RECS-WRITTEN        PIC  9(09) VALUE ZERO.      01230009
012400*CHG101105 - END                                                  01240019
012500     05  PV-GRP-RTL-AMT               PIC S9(09)V99 VALUE ZERO.   01250009
012600     05  PV-CALC-COUNT                PIC  9(09) VALUE ZERO.      01260009
012700     05  PV-RUN-DATE-CN               PIC  X(08) VALUE SPACES.    01270009
012800     05  PV-RUN-TIME-CN               PIC  X(06) VALUE SPACES.    01280009
012900                                                                  01290009
013000                                                                  01300009
013100***  ITEM FILE LAYOUT (INPUT)                                     01310009
013200     COPY VLRD033.                                                01320009
013300                                                                  01330009
013400***  ITEM FILE LAYOUT (OUTPUT)                                    01340009
013500     COPY VLRD052.                                                01350009
013600                                                                  01360009
013700***  DB2 ABEND COPYBOOK                                           01370009
013800     COPY DPWS004.                                                01380009
013900                                                                  01390009
014000     EXEC SQL                                                     01400009
014100         INCLUDE SQLCA                                            01410009
014200     END-EXEC.                                                    01420009
014300                                                                  01430009
014400     COPY SQLCA2.                                                 01440009
014500                                                                  01450009
014600*---------------------------------------------------------------* 01460009
014700*    DCLGEN FOR VENDOR LOGISTICS DOMAIN SKU STORE TABLE VIEW    * 01470009
014800*    (XLV_SKU_STR)                                              * 01480009
014900*---------------------------------------------------------------* 01490009
015000     EXEC SQL                                                     01500009
015100         INCLUDE XLV00002                                         01510009
015200     END-EXEC.                                                    01520009
015300*CHG101105 - START                                                01530019
015400*---------------------------------------------------------------* 01540009
015500*    DCLGEN FOR TUPCPLS AND TMITGPL                             * 01550009
015600*---------------------------------------------------------------* 01560009
015700     EXEC SQL                                                     01570009
015800         INCLUDE TUPCPLS                                          01580009
015900     END-EXEC.                                                    01590009
016000                                                                  01600009
016100     EXEC SQL                                                     01610009
016200         INCLUDE TMITGPL                                          01620009
016300     END-EXEC.                                                    01630009
016400*CHG101105 - END                                                  01640019
016500                                                                  01650009
016600                                                                  01660009
016700 LINKAGE SECTION.                                                 01670009
016800                                                                  01680009
016900 PROCEDURE DIVISION.                                              01690009
017000***************************************************************** 01700009
017100*  MAINLINE LOGIC FOR PROGRAM                                     01710009
017200***************************************************************** 01720009
017300 0000-MAINLINE.                                                   01730009
017400     PERFORM 1000-INITIALIZE.                                     01740009
017500                                                                  01750009
017600     PERFORM 2000-PROCESS-ITEM-EXTRACT-REC                        01760009
017700         UNTIL PS-END-EXT-FILE-IN.                                01770009
017800                                                                  01780009
017900     PERFORM 9000-EOJ.                                            01790009
018000                                                                  01800009
018100     STOP RUN.                                                    01810009
018200                                                                  01820009
018300***************************************************************** 01830009
018400*  INITIALIZATION PARAGRAPH                                       01840009
018500***************************************************************** 01850009
018600 1000-INITIALIZE.                                                 01860009
018700     OPEN  INPUT VL-ITEM-IN-FILE                                  01870009
018800          OUTPUT VL-ITEM-OUT-FILE                                 01880009
018900                 GENCO-ITEM-FILE                                  01890009
019000*CHG101105 - START                                                01900019
019100                 ERROR-FILE.                                      01910009
019200*CHG101105 - END                                                  01920019
019300                                                                  01930009
019400******* DATE IS CONTAINED IN CURRENT-DATE IN POSITION 1 FOR 8     01940009
019500******* TIME IS CONTAINED IN CURRENT-DATE IN POSITION 9 FOR 8     01950009
019600     MOVE FUNCTION CURRENT-DATE(1:8) TO PV-RUN-DATE-CN.           01960009
019700     MOVE FUNCTION CURRENT-DATE(9:8) TO PV-RUN-TIME-CN.           01970009
019800                                                                  01980009
019900     DISPLAY '******  RUN DATE  => '  PV-RUN-DATE-CN.             01990009
020000     DISPLAY '******  RUN TIME  => '  PV-RUN-TIME-CN.             02000009
020100                                                                  02010009
020200     PERFORM 7000-READ-ITEM-EXTRACT-REC.                          02020009
020300                                                                  02030009
020400                                                                  02040009
020500***************************************************************** 02050009
020600* PROCESS DATA FROM THE INPUT EXTRACT RECORD AND WRITE IT TO      02060009
020700* THE OUTPUT RECORD.                                              02070009
020800***************************************************************** 02080009
020900 2000-PROCESS-ITEM-EXTRACT-REC.                                   02090009
021000     MOVE VL033-ACD-INDICATOR     TO VL052-ACD-INDICATOR.         02100009
021100     MOVE VL033-SKU-NBR           TO VL052-SKU-NBR.               02110009
021200     MOVE VL033-UPC-NBR           TO VL052-UPC-NBR.               02120009
021300     MOVE VL033-STYL-ID           TO VL052-STYL-ID.               02130009
021400     MOVE VL033-STYL-DESC         TO VL052-STYL-DESC.             02140009
021500     MOVE VL033-NRF-CLOR-CDE      TO VL052-NRF-CLOR-CDE.          02150009
021600     MOVE VL033-CSTM-CLOR-DESC    TO VL052-CSTM-CLOR-DESC.        02160009
021700     MOVE VL033-KOHLS-SIZE-CDE    TO VL052-KOHLS-SIZE-CDE.        02170009
021800     MOVE VL033-SIZE-DESC         TO VL052-SIZE-DESC.             02180009
021900                                                                  02190009
022000* PERFORM THE LOOKUP OF THE UNIT AND RETAIL COST INFO ONLY WHEN   02200009
022100* THE INTR_UPC_ID CHANGES BETWEEN INPUT RECORDS.                  02210009
022200     IF  VL033-INTR-UPC-ID NOT = PV-CURR-INTR-UPC-ID              02220009
022300         MOVE VL033-INTR-UPC-ID   TO PV-CURR-INTR-UPC-ID          02230009
022400         PERFORM 2100-GET-UNIT-RETAIL-COST-INFO                   02240009
022500     END-IF.                                                      02250009
022600                                                                  02260009
022700     MOVE SPACES                  TO VL052-RTL-COST-SIGN.         02270009
022800     MOVE XLV00002-UNT-RTL-AMT    TO VL052-RTL-COST-AMT.          02280009
022900     MOVE SPACES                  TO VL052-UNT-COST-SIGN.         02290009
023000     MOVE VL033-UNT-COST-1ST-AMT  TO VL052-UNT-COST-AMT.          02300009
023100     MOVE VL033-UPC-TYPE          TO VL052-UPC-TYPE.              02310009
023200     MOVE VL033-PREPK-IND         TO VL052-PREPK-IND.             02320009
023300     MOVE VL033-VS-NBR            TO VL052-VS-NBR.                02330009
023400     MOVE VL033-BUY-UM            TO VL052-BUY-UM.                02340009
023500     MOVE VL033-SELL-UM           TO VL052-SELL-UM.               02350009
023600     MOVE VL033-SKU-LEAD-TIME     TO VL052-SKU-LEAD-TIME.         02360009
023700     MOVE VL033-STATUS-FLAG       TO VL052-STATUS-FLAG.           02370009
023800     MOVE VL033-PRO-NMFC          TO VL052-PRO-NMFC.              02380009
023900     MOVE VL033-DEPT-NBR          TO VL052-DEPT-NBR.              02390009
024000     MOVE VL033-MAJ-CL-NBR        TO VL052-MAJ-CL-NBR.            02400009
024100     MOVE VL033-SUB-CL-NBR        TO VL052-SUB-CL-NBR.            02410009
024200     MOVE VL033-SKU-STAT-CDE      TO VL052-SKU-STAT-CDE.          02420009
024300     MOVE VL033-ENT-ID            TO VL052-ENT-ID.                02430009
024400     MOVE VL033-SKU-STAT-DESC     TO VL052-SKU-STAT-DESC.         02440009
024500     MOVE VL033-PRIMARY-UPC-FL    TO VL052-PRIMARY-UPC-FL.        02450009
024600     MOVE VL033-ANCHOR-CONSTANT   TO VL052-ANCHOR-CONSTANT.       02460009
024700                                                                  02470009
024800     PERFORM 8000-WRITE-OUTPUT.                                   02480009
024900                                                                  02490009
025000     PERFORM 7000-READ-ITEM-EXTRACT-REC.                          02500009
025100                                                                  02510009
025200                                                                  02520009
025300******************************************************************02530009
025400* FETCH THE RETAIL COST AND UNIT COST INFORMATION.                02540009
025500******************************************************************02550009
025600 2100-GET-UNIT-RETAIL-COST-INFO.                                  02560009
025700     SET PS-GROUP-RETAIL-NO        TO TRUE.                       02570009
025800     INITIALIZE DCLXLV00002.                                      02580009
025900                                                                  02590009
026000     PERFORM                                                      02600009
026100         WITH TEST AFTER                                          02610009
026200         VARYING PV-RETRY-COUNT                                   02620009
026300         FROM 1 BY 1                                              02630009
026400         UNTIL ((PV-RETRY-COUNT > PC-MAX-RETRIES)                 02640009
026500                   OR (SQLCODE = ZERO) OR (SQLCODE = +100)        02650009
026600*CHG101105 - START                                                02660019
026700                   OR (SQLCODE = -811))                           02670009
026800*CHG101105 - END                                                  02680019
026900         EXEC SQL                                                 02690009
027000             SELECT                                               02700009
027100                    UNT_RTL_AMT                                   02710009
027200                  , GP_QTY                                        02720009
027300                  , GP_AMT                                        02730009
027400               INTO                                               02740009
027500                    :XLV00002-UNT-RTL-AMT                         02750009
027600                  , :XLV00002-GP-QTY                              02760009
027700                  , :XLV00002-GP-AMT                              02770009
027800               FROM                                               02780009
027900                    XLV_SKU_STR                                   02790009
028000               WHERE                                              02800009
028100                    INTR_UPC_ID = :PV-CURR-INTR-UPC-ID            02810009
028200                 AND                                              02820009
028300                    STR_NBR     = 0                               02830009
028400*CHG101105 - START                                                02840019
028500               WITH UR                                            02850014
028600*CHG101105 - END                                                  02860019
028700         END-EXEC                                                 02870009
028800                                                                  02880009
028900         EVALUATE TRUE                                            02890009
029000             WHEN SQLCODE = +0                                    02900009
029100                 IF XLV00002-GP-QTY > 1                           02910009
029200                     SET PS-GROUP-RETAIL   TO TRUE                02920009
029300                     COMPUTE PV-GRP-RTL-AMT ROUNDED =             02930009
029400                         XLV00002-GP-AMT / XLV00002-GP-QTY        02940009
029500                     ADD 1                 TO PV-CALC-COUNT       02950009
029600                 END-IF                                           02960009
029700             WHEN SQLCODE = -904                                  02970009
029800             WHEN SQLCODE = -911                                  02980009
029900             WHEN SQLCODE = -913                                  02990009
030000                 CONTINUE                                         03000009
030100             WHEN SQLCODE = +100                                  03010009
030200                 MOVE ZERO            TO XLV00002-UNT-RTL-AMT     03020009
030300                                         XLV00002-UNT-COST-AMT    03030009
030400*CHG101105 - START                                                03040019
030500             WHEN SQLCODE = -811                                  03050009
030600                 PERFORM 2200-GET-UNT-RET-CST-BASE-TAB            03060009
030700                 PERFORM 8500-WRITE-ERROR-RECORD                  03070009
030800*CHG101105 - END                                                  03080019
030900             WHEN SQLWARN0 NOT EQUAL SPACE                        03090009
031000             WHEN SQLCODE NOT EQUAL ZERO                          03100009
031100                 DISPLAY '** ABEND **'                            03110009
031200                 DISPLAY '** PROGRAM = VLKUT041 **'               03120009
031300                 DISPLAY '** PARAGRAPH = **'                      03130009
031400                 DISPLAY '** 2100-GET-UNIT-RETAIL-COST-INFO **'   03140009
031500                 DISPLAY '** SKU NBR: ' VL033-SKU-NBR             03150009
031600                 DISPLAY '** INTL UPC ID: ' PV-CURR-INTR-UPC-ID   03160009
031700                 MOVE 'FETCH INFO'    TO PV-ERROR-MSG             03170009
031800                 MOVE 'XLV_SKU_STR'   TO PV-ABEND-TABLE-1         03180009
031900                 PERFORM 9200-SQL-ERROR                           03190009
032000         END-EVALUATE                                             03200009
032100     END-PERFORM.                                                 03210009
032200                                                                  03220009
032300     IF  PV-RETRY-COUNT > PC-MAX-RETRIES                          03230009
032400         DISPLAY '** ABEND **'                                    03240009
032500         DISPLAY '** PROGRAM = VLKUT041 **'                       03250009
032600         DISPLAY '** PARAGRAPH = **'                              03260009
032700         DISPLAY '** 2100-GET-UNIT-RETAIL-COST-INFO **'           03270009
032800         DISPLAY '** SKU NBR: ' VL033-SKU-NBR                     03280009
032900         DISPLAY '** INTL UPC ID: ' PV-CURR-INTR-UPC-ID           03290009
033000         MOVE 'FETCH INFO'      TO PV-ERROR-MSG                   03300009
033100         MOVE 'XLV_SKU_STR'     TO PV-ABEND-TABLE-1               03310009
033200         PERFORM 9200-SQL-ERROR                                   03320009
033300     END-IF.                                                      03330009
033400                                                                  03340009
033500                                                                  03350009
033600*CHG101105 - START                                                03360019
033700******************************************************************03370009
033800* FETCH THE RETAIL COST AND UNIT COST INFORMATION FROM TUPCPLS    03380009
033900* AND TMITGPL IF -811 IS ENCOUNTERED IN XLV_SKU_STR TABLE         03390009
034000******************************************************************03400009
034100 2200-GET-UNT-RET-CST-BASE-TAB.                                   03410009
034200                                                                  03420009
034300         EXEC SQL                                                 03430009
034400             SELECT                                               03440009
034500                    VT1.UNT_RTL_AMT                               03450009
034600                  , COALESCE(GP.MITGPL_QTY,1) AS GP_QTY           03460009
034700                  , COALESCE(GP.GP_AMT,VT1.UNT_RTL_AMT) AS GP_AMT 03470009
034800               INTO                                               03480009
034900                    :XLV00002-UNT-RTL-AMT                         03490009
035000                  , :XLV00002-GP-QTY                              03500009
035100                  , :XLV00002-GP-AMT                              03510009
035200               FROM                                               03520009
035300                    (                                             03530009
035400                     SELECT                                       03540009
035500                          UPC.UNT_RTL_AMT                         03550009
035600                        , UPC.MEITGP_NBR                          03560009
035700                     FROM                                         03570009
035800                          TUPCPLS UPC                             03580009
035900                     WHERE                                        03590009
036000                          UPC.OPERCO_NBR = '03'                   03600009
036100                      AND UPC.EFF_BEG_TMST < CURRENT TIMESTAMP    03610009
036200                      AND (UPC.EFF_END_TMST > CURRENT TIMESTAMP   03620009
036300                           OR                                     03630009
036400                           UPC.EFF_END_TMST IS NULL)              03640009
036500                      AND UPC.UPC_ID = :PV-CURR-INTR-UPC-ID       03650009
036600                      AND UPC.STR_NBR = 0                         03660009
036700                      AND UPC.CRE_TMST                            03670009
036800                           IN (SELECT                             03680009
036900                                MAX(A.CRE_TMST)                   03690009
037000                               FROM                               03700009
037100                                TUPCPLS A                         03710009
037200                               WHERE                              03720009
037300                                   A.OPERCO_NBR = '03'            03730009
037400                               AND A.EFF_BEG_TMST                 03740009
037500                                              < CURRENT TIMESTAMP 03750009
037600                               AND (A.EFF_END_TMST                03760009
037700                                              > CURRENT TIMESTAMP 03770009
037800                                    OR                            03780009
037900                                    A.EFF_END_TMST IS NULL)       03790009
038000                               AND A.UPC_ID = :PV-CURR-INTR-UPC-ID03800009
038100                               AND A.STR_NBR = 0                  03810009
038200                              )                                   03820009
038300                    ) AS VT1                                      03830009
038400                    LEFT OUTER JOIN                               03840009
038500                         TMITGPL GP ON                            03850009
038600                             GP.OPERCO_NBR = '03'                 03860009
038700                         AND GP.ADLOC_ID = '   '                  03870009
038800                         AND GP.MEITGP_NBR = VT1.MEITGP_NBR       03880009
038900             WITH UR                                              03890017
039000         END-EXEC                                                 03900009
039100                                                                  03910009
039200         EVALUATE TRUE                                            03920009
039300             WHEN SQLCODE = +0                                    03930009
039400                 IF XLV00002-GP-QTY > 1                           03940009
039500                     SET PS-GROUP-RETAIL   TO TRUE                03950009
039600                     COMPUTE PV-GRP-RTL-AMT ROUNDED =             03960009
039700                         XLV00002-GP-AMT / XLV00002-GP-QTY        03970009
039800                     ADD 1                 TO PV-CALC-COUNT       03980009
039900                 END-IF                                           03990009
040000             WHEN SQLCODE = +100                                  04000009
040300             WHEN SQLWARN0 NOT EQUAL SPACE                        04030009
040400             WHEN SQLCODE NOT EQUAL ZERO                          04040009
040500               DISPLAY '** ABEND **'                              04050009
040600               DISPLAY '** PROGRAM = VLKUT041 **'                 04060009
040700               DISPLAY '** PARAGRAPH = **'                        04070009
040800               DISPLAY '** 2200-GET-UNT-RET-CST-BASE-TABLE **'    04080009
040900               DISPLAY '** SKU NBR: ' VL033-SKU-NBR               04090009
041000               DISPLAY '** INTL UPC ID: ' PV-CURR-INTR-UPC-ID     04100009
041100               MOVE 'FETCH INFO'        TO PV-ERROR-MSG           04110009
041200               MOVE 'TUPCPLS & TMITGPL' TO PV-ABEND-TABLE-1       04120009
041300               PERFORM 9200-SQL-ERROR                             04130009
041400         END-EVALUATE.                                            04140009
041500                                                                  04150009
041600                                                                  04160009
041700*CHG101105 - END                                                  04170019
041800******************************************************************04180009
041900* READ A RECORD FROM THE INPUT ITEM EXTRACT FILE.                 04190009
042000******************************************************************04200009
042100 7000-READ-ITEM-EXTRACT-REC.                                      04210009
042200                                                                  04220009
042300     READ VL-ITEM-IN-FILE                                         04230009
042400         INTO VL033-ITEM-RECORD                                   04240009
042500            AT END                                                04250009
042600               SET PS-END-EXT-FILE-IN                             04260009
042700                          TO TRUE.                                04270009
042800                                                                  04280009
042900     IF  PS-NOT-END-EXT-FILE-IN                                   04290009
043000         ADD 1            TO PV-EXT-FILE-RECS-READ                04300009
043100     END-IF.                                                      04310009
043200                                                                  04320009
043300                                                                  04330009
043400***************************************************************** 04340009
043500*  WRITE OUTPUT FILE AND GENCO FILE                               04350009
043600***************************************************************** 04360009
043700 8000-WRITE-OUTPUT.                                               04370009
043800     WRITE VL-ITEM-OUT-RECORD FROM VL052-ITEM-RECORD.             04380009
043900                                                                  04390009
044000     ADD 1                TO PV-EXT-FILE-RECS-WRITTEN.            04400009
044100                                                                  04410009
044200     IF PS-GROUP-RETAIL                                           04420009
044300         MOVE PV-GRP-RTL-AMT        TO VL052-RTL-COST-AMT         04430009
044400         IF PV-GRP-RTL-AMT < 0                                    04440009
044500             MOVE '-'               TO VL052-RTL-COST-SIGN        04450009
044600         END-IF                                                   04460009
044700     END-IF.                                                      04470009
044800     WRITE GENCO-ITEM-RECORD FROM VL052-ITEM-RECORD.              04480009
044900                                                                  04490009
045000     ADD 1                TO PV-GENCO-RECS-WRITTEN.               04500009
045100                                                                  04510009
045200                                                                  04520009
045300*CHG101105 - START                                                04530019
045400***************************************************************** 04540009
045500*  WRITE ERROR FILE                                               04550009
045600***************************************************************** 04560009
045700 8500-WRITE-ERROR-RECORD.                                         04570009
045800     INITIALIZE ERROR-UPC-RECORD                                  04580012
045900                PV-CURR-INTR-UPC-ID-OP.                           04590012
046000     MOVE PV-CURR-INTR-UPC-ID TO PV-CURR-INTR-UPC-ID-OP.          04600011
046100                                                                  04610009
046200     WRITE ERROR-UPC-RECORD  FROM PV-CURR-INTR-UPC-ID-OP.         04620011
046300                                                                  04630009
046400     ADD 1                TO PV-ERROR-RECS-WRITTEN.               04640009
046500                                                                  04650009
046600                                                                  04660009
046700*CHG101105 - END                                                  04670019
046800***************************************************************** 04680009
046900*  END OF JOB PROCESSING                                          04690009
047000***************************************************************** 04700009
047100 9000-EOJ.                                                        04710009
047200     DISPLAY 'RECORDS READ ======>  ' PV-EXT-FILE-RECS-READ.      04720009
047300     DISPLAY 'RECORDS WRITTEN ===>  ' PV-EXT-FILE-RECS-WRITTEN.   04730009
047400     DISPLAY 'GENCO RECORDS WRITTEN ===>  ' PV-GENCO-RECS-WRITTEN.04740009
047500     DISPLAY 'CALCULATED RTL AMOUNTS ==>  ' PV-CALC-COUNT.        04750009
047600*CHG101105 - START                                                04760019
047700     DISPLAY 'ERROR RECORDS WRITTEN ==>  ' PV-ERROR-RECS-WRITTEN. 04770009
047800*CHG101105 - END                                                  04780019
047900                                                                  04790009
048000     CLOSE VL-ITEM-IN-FILE                                        04800009
048100           VL-ITEM-OUT-FILE                                       04810009
048200           GENCO-ITEM-FILE                                        04820009
048300*CHG101105 - START                                                04830019
048400           ERROR-FILE.                                            04840009
048500*CHG101105 - END                                                  04850019
048600                                                                  04860009
048700                                                                  04870009
048800***************************************************************** 04880009
048900*  PARAGRAPH EXECUTED WHEN SERIOUS DB2 ERROR OCCURRED             04890009
049000***************************************************************** 04900009
049100 9200-SQL-ERROR.                                                  04910009
049200     CLOSE VL-ITEM-IN-FILE                                        04920009
049300           VL-ITEM-OUT-FILE                                       04930009
049400           GENCO-ITEM-FILE                                        04940009
049500*CHG101105 - START                                                04950019
049600           ERROR-FILE.                                            04960009
049700*CHG101105 - END                                                  04970019
049800                                                                  04980009
049900     MOVE SQLCODE                     TO SQLCODE2.                04990009
050000     MOVE SQLERRD(3)                  TO SQLERRD3.                05000009
050100                                                                  05010009
050200     DISPLAY '** ABEND **         ** = SQLERROR'.                 05020009
050300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PGM-VLKUT041.        05030009
050400     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH.                   05040009
050500     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                05050009
050600     DISPLAY '**           ** = ' PV-ABEND-TABLE-1.               05060009
050700     DISPLAY '**           ** = ' PV-ERROR-MSG                    05070009
050800                                                                  05080009
050900     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                05090009
051000     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                05100009
051100     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 05110009
051200     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                05120009
051300                                                                  05130009
051400     COPY DPPD004.                                                05140009
051500                                                                  05150009
051600     MOVE +4013                       TO PV-ABEND-CODE.           05160009
051700     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05170009
051800                                                                  05180009
051900*************  END OF VLKUT041  ********************************  05190009
