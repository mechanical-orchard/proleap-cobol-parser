000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         TMKUP635.                                    00020008
000300 AUTHOR.             PAUL JORGENSEN.                              00030008
000400 DATE-WRITTEN.       JUNE 2009.                                   00040008
000500 DATE-COMPILED.                                                   00050000
000600*************************************************************     00060000
000800*                                                           *     00080000
000900*   TMKUP635 - DELETE ORPHAN NOTIFICATION NUMBERED ROWS     *     00090008
001000*              FROM TIMTBKY                                 *     00100008
001100*   PROGRAM OVERVIEW:                                       *     00110000
001300*  THIS PROGRAM READS IN AN EXTRACT FILE OF NOTIFICATION    *     00130008
001400*  NUMBERS THAT EXIST ON TIMTBKY BUT NOT ON TTRBNTF AND     *     00140009
001500*  DELETES THEM FROM TIMTBKY.                               *     00150008
001600*                                                           *     00160000
003400*************************************************************     00340000
003500*                                                           *     00350000
003800 ENVIRONMENT DIVISION.                                            00380000
003900 CONFIGURATION SECTION.                                           00390000
004000 SOURCE-COMPUTER.        IBM-370.                                 00400000
004100 OBJECT-COMPUTER.        IBM-370.                                 00410000
004200                                                                  00420000
004300 INPUT-OUTPUT SECTION.                                            00430000
004400 FILE-CONTROL.                                                    00440000
004500     SELECT TIMTBKY-EXTRACT-FILE ASSIGN TO INP01.                 00450008
004600                                                                  00460000
004700 DATA DIVISION.                                                   00470000
004800 FILE SECTION.                                                    00480000
004900 FD  TIMTBKY-EXTRACT-FILE                                         00490008
005000     RECORDING MODE IS F                                          00500000
005100     LABEL RECORDS ARE STANDARD                                   00510000
005200     BLOCK CONTAINS 0 RECORDS                                     00520000
005300     RECORD CONTAINS 4 CHARACTERS                                 00530018
005400     DATA RECORD IS TIMTBKY-EXTRACT-DATA.                         00540009
005500 01  TIMTBKY-EXTRACT-RECORD     PIC X(04).                        00550018
005700                                                                  00570000
005900 WORKING-STORAGE SECTION.                                         00590000
006000                                                                  00600000
006100 01  FILLER                       PIC X(58)     VALUE             00610000
006200     '************WORKING STORAGE STARTS HERE*******************'.00620000
006300                                                                  00630000
006400 01  PV-PROGRAM-VARIABLES.                                        00640000
006500     05  PV-PROGRAM-NAME          PIC  X(08)    VALUE 'TMKUP635'. 00650008
006600     05  PV-CKPT-STAT-CODE        PIC X(01)     VALUE SPACE.      00660000
006700     05  PV-CURRENT-PARAGRAPH     PIC X(50)     VALUE SPACES.     00670000
006800     05  PV-CURRENT-TMST          PIC X(26)     VALUE SPACES.     00680000
006900                                                                  00690000
007000     05  PV-COMMIT-COUNT          PIC S9(09)    VALUE ZERO        00700010
007100                                                COMP-3.           00710000
007000     05  PV-TIMTBKY-INPUT-COUNT   PIC S9(09)    VALUE ZERO        00711010
007100                                                COMP-3.           00712010
007200     05  PV-TIMTBKY-DELETE-COUNT  PIC S9(09)    VALUE ZERO        00720009
007300                                                COMP-3.           00730000
007400     05  PV-SQL-DELETE-COUNT      PIC S9(09)    VALUE ZERO        00740000
007500                                                COMP-3.           00750000
007600     05  PV-SQLERRD3              PIC S9(09)    VALUE ZERO        00760000
007700                                                COMP-3.           00770000
008010     05  PV-NOTIFY-NBR            PIC X(11)    VALUE SPACES.      00801011
008100 01  PC-PROGRAM-CONSTANTS.                                        00810000
008200     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00820000
008300                                                COMP SYNC.        00830000
008400     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00840000
008500     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00850000
008600     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00860000
008700                                                                  00870000
008800 01  PS-PROGRAM-SWITCHES.                                         00880000
008900     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00890000
009000         88  COMMITS-TAKEN                      VALUE 'T'.        00900000
009100         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00910000
009200     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00920000
009300         88  MORE-EXTRACT                       VALUE 'M'.        00930000
009400         88  END-OF-EXTRACT                     VALUE 'E'.        00940000
009500     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00950000
009600         88  NORMAL-RUN                         VALUE '0'.        00960000
009700         88  RESTART-RUN                        VALUE '9'.        00970000
009800                                                                  00980000
009900 01  WS-COUNTER.                                                  00990000
010000     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01000000
010100     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01010000
010200                                                                  01020000
010300 01  CKPT-RESTART-INFO.                                           01030000
010400     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01040000
010500                                                                  01050000
010600*----------------------------------------------------------------*01060000
010700*  ABEND DATA AREAS                                              *01070000
010800*----------------------------------------------------------------*01080000
010900 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01090000
011000                                             COMP SYNC.           01100000
011100     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01110000
011200     88  AC-BAD-DATA                         VALUE +4008.         01120000
011300     88  AC-DB2-ERROR                        VALUE +4013.         01130000
011400     88  AC-DATE-ERROR                       VALUE +4019.         01140000
011500                                                                  01150000
011600                                                                  01160000
011700 01  ABEND-AREAS.                                                 01170000
011800     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01180000
011900             '*****       ABEND'.                                 01190000
012000     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01200000
012100             '*****   PROGRAM: TMKUP635'.                         01210008
012200     05  AA-PARAGRAPH-LIT.                                        01220000
012300         10  FILLER              PIC  X(17)  VALUE                01230000
012400             '***** PARAGRAPH: '.                                 01240000
012500         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01250000
012600     05  AA-MESSAGE-LINE-1.                                       01260000
012700         10  FILLER              PIC  X(06)  VALUE '*****'.       01270000
012800         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01280000
012900     05  AA-MESSAGE-LINE-2.                                       01290000
013000         10  FILLER              PIC  X(06)  VALUE '*****'.       01300000
013100         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01310000
013200     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01320000
013300             '*****    DB2 ERROR'.                                01330000
013400     05  AA-DB2-OPERATION-LIT.                                    01340000
013500         10  FILLER              PIC  X(17)  VALUE                01350000
013600             '***** OPERATION: '.                                 01360000
013700         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01370000
013800     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01380000
013900     EJECT                                                        01390000
014000                                                                  01400000
014100*----------------------------------------------------------------*01410000
014200*      TIMTBKY PURGE FILE                                         01420021
014300*----------------------------------------------------------------*01430000
014400*                                                                 01440000
014500     COPY TMRD010.                                                01450021
014600*                                                                 01460021
014700     COPY DPWS004.                                                01470000
014800*                                                                 01480021
014900*----------------------------------------------------------------*01490000
015000*      TIMTBKY TABLE LAYOUT                                       01500009
015100*----------------------------------------------------------------*01510000
015200         EXEC SQL                                                 01520000
015300             INCLUDE TIMTBKY                                      01530009
015400         END-EXEC.                                                01540000
015500                                                                  01550000
015600*----------------------------------------------------------------*01560000
015700*      TCKRSTCNTL TABLE LAYOUT                                    01570000
015800*----------------------------------------------------------------*01580000
015900         EXEC SQL                                                 01590000
016000             INCLUDE TCKRSTCN                                     01600000
016100         END-EXEC.                                                01610000
016200                                                                  01620000
016300*----------------------------------------------------------------*01630000
016400*      TCKRSTINF TABLE LAYOUT                                     01640000
016500*----------------------------------------------------------------*01650000
016600         EXEC SQL                                                 01660000
016700             INCLUDE TCKRSTIN                                     01670000
016800         END-EXEC.                                                01680000
016900 EJECT                                                            01690000
017000*----------------------------------------------------------------*01700000
017100*  DB2 COMMUNICATION AREA                                         01710000
017200*----------------------------------------------------------------*01720000
017300*                                                                 01730000
017400     EXEC SQL                                                     01740000
017500         INCLUDE SQLCA                                            01750000
017600     END-EXEC.                                                    01760000
017700                                                                  01770000
017800*----------------------------------------------------------------*01780000
017900*  DB2 COMMUNICATION AREA2                                        01790000
018000*----------------------------------------------------------------*01800000
018100*                                                                 01810000
018200     COPY SQLCA2.                                                 01820000
018300     EJECT                                                        01830000
018400 PROCEDURE DIVISION.                                              01840000
018500 A100-MAINLINE-ROUTINE.                                           01850000
018600                                                                  01860000
018700     PERFORM 1000-INITIALIZATION.                                 01870009
018800                                                                  01880000
018900     PERFORM 2000-TIMTBKY-EXTRACT-PROCESS                         01890009
019000       UNTIL END-OF-EXTRACT.                                      01900000
019100                                                                  01910000
019200     PERFORM 3000-EOJ-PROCESSING.                                 01920009
019300                                                                  01930000
019400     STOP RUN.                                                    01940009
019500                                                                  01950009
019600 1000-INITIALIZATION.                                             01960009
019700                                                                  01970000
019800     EXEC SQL                                                     01980000
019900         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01990000
020000     END-EXEC.                                                    02000000
020100                                                                  02010000
020500     OPEN INPUT TIMTBKY-EXTRACT-FILE.                             02050009
020600                                                                  02060000
021000     PERFORM 7000-READ-EXTRACT-FILE.                              02100012
021500                                                                  02150000
021700 2000-TIMTBKY-EXTRACT-PROCESS.                                    02170009
021800                                                                  02180000
021900     MOVE TM010-NOTIF-NBR TO IMTBKY-NOTIF-NBR                     02191022
022500                                                                  02250000
022600     PERFORM 4000-DELETE-TIMTBKY.                                 02260009
022700                                                                  02270000
023000     PERFORM 7000-READ-EXTRACT-FILE.                              02300009
                                                                        02310010
           IF PV-COMMIT-COUNT > 500                                     02320017
                PERFORM 8000-COMMIT                                     02321010
                MOVE 1 TO PV-COMMIT-COUNT                               02321111
           END-IF.                                                      02322010
023300                                                                  02330000
023400 3000-EOJ-PROCESSING.                                             02340009
023500                                                                  02350000
023600     DISPLAY '** TMKUP635 SUMMARY **'.                            02360008
023700     DISPLAY '** TIMTBKY INPUT COUNT  = ' PV-TIMTBKY-INPUT-COUNT. 02370020
023800     DISPLAY '** TIMTBKY DELETE COUNT = ' PV-TIMTBKY-DELETE-COUNT.02380009
023900     DISPLAY '** SQL DELETE COUNT     = ' PV-SQL-DELETE-COUNT.    02390020
024000                                                                  02400000
024100     CLOSE  TIMTBKY-EXTRACT-FILE.                                 02410009
024200                                                                  02420000
024700*----------------------------------------------------------------*02470000
024800*    DELETES FROM THE TIMTBKY TABLE.                              02480011
025000*----------------------------------------------------------------*02500000
025100 4000-DELETE-TIMTBKY.                                             02510009
025200                                                                  02520000
025300     MOVE '4000-DELETE-TIMTBKY' TO PV-CURRENT-PARAGRAPH.          02530009
025400                                                                  02540000
025500     PERFORM WITH TEST AFTER                                      02550000
025600        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02560000
025700          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02570000
025800             OR SQLCODE = ZERO                                    02580000
025800             OR SQLCODE = +100                                    02581016
025900                                                                  02590000
026000         EXEC SQL                                                 02600000
026100              DELETE                                              02610000
026200                FROM TIMTBKY                                      02620009
026300               WHERE NOTIF_NBR         = :IMTBKY-NOTIF-NBR        02630009
026600         END-EXEC                                                 02660000
026700                                                                  02670000
026800         EVALUATE TRUE                                            02680000
026900             WHEN SQLCODE = ZERO                                  02690000
027000                 ADD 1 TO PV-TIMTBKY-DELETE-COUNT                 02700009
027100                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02710000
027200                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02720000
027300                                                                  02730000
027400             WHEN SQLCODE = -904                                  02740000
027500             WHEN SQLCODE = -913                                  02750000
027600                  CONTINUE                                        02760000
027700                                                                  02770000
027800             WHEN SQLCODE = +100                                  02780000
                        CONTINUE                                        02781013
027900*                MOVE PV-CURRENT-PARAGRAPH                        02790011
028000*                                    TO AA-PARAGRAPH-NAME         02800011
028100*                DISPLAY '******** NOTIFY NBR:'                   02810011
028200*                         PV-NOTIFY-NBR                           02820011
028700*                MOVE 'ROW NOT ON TABLE ********'                 02870011
028800*                         TO AA-MESSAGE-1                         02880011
028900*                MOVE SPACES TO AA-MESSAGE-2                      02890011
029000*                MOVE 'UNSUCCESSFUL DELETE'                       02900011
029100*                         TO AA-DB2-OPERATION                     02910011
029200*                MOVE 'TIMTBKY'  TO AA-DB2-TABLE                  02920011
029300*                PERFORM 9999-DB2-ABEND                           02930013
029500             WHEN SQLCODE  NOT = ZERO                             02950000
029600                 MOVE PV-CURRENT-PARAGRAPH                        02960000
029700                                     TO AA-PARAGRAPH-NAME         02970000
029710                 DISPLAY '******** NOTIFY NBR:'                   02971004
029720                          PV-NOTIFY-NBR                           02972005
030400                 MOVE SPACES TO AA-MESSAGE-1                      03040000
030500                                AA-MESSAGE-2                      03050000
030600                 MOVE 'UNSUCCESSFUL DELETE'                       03060000
030700                                     TO AA-DB2-OPERATION          03070000
030800                 MOVE 'TIMTBKY'      TO AA-DB2-TABLE              03080009
030900                 PERFORM 9999-DB2-ABEND                           03090013
031000         END-EVALUATE                                             03100000
031100     END-PERFORM.                                                 03110000
031200                                                                  03120000
031300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03130000
031400         MOVE PV-CURRENT-PARAGRAPH                                03140000
031500                             TO AA-PARAGRAPH-NAME                 03150000
031510         DISPLAY '******** NOTIFY NBR:'                           03151004
031520                          PV-NOTIFY-NBR                           03152005
032200         MOVE SPACES TO AA-MESSAGE-1                              03220000
032300                        AA-MESSAGE-2                              03230000
032400         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03240000
032500                             TO AA-DB2-OPERATION                  03250000
032600         MOVE 'TIMTBKY'      TO AA-DB2-TABLE                      03260009
032700         PERFORM 9999-DB2-ABEND                                   03270013
032800     END-IF.                                                      03280000
032900                                                                  03290000
033100 7000-READ-EXTRACT-FILE.                                          03310009
033200                                                                  03320000
033300     READ TIMTBKY-EXTRACT-FILE                                    03330009
                INTO TM010-TIMTBKY-PURGE-RECORD                         03340019
033500          AT END SET END-OF-EXTRACT TO TRUE.                      03350000
033600                                                                  03360000
033700     IF MORE-EXTRACT                                              03370000
033800         ADD 1 TO PV-TIMTBKY-INPUT-COUNT                          03380009
                        PV-COMMIT-COUNT                                 03381010
033900     END-IF.                                                      03390000
034000                                                                  03400000
034100                                                                  03410000
067300                                                                  06730000
067400*----------------------------------------------------------------*06740000
067500*    ISSUES AN SQL COMMIT WORK AFTER 500 RECORDS HAVE BEEN READ  *06750010
067600*----------------------------------------------------------------*06760000
067700 8000-COMMIT.                                                     06770010
067800                                                                  06780000
067900     MOVE '8000-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06790010
068000                                                                  06800000
068100     EXEC SQL                                                     06810000
068200         COMMIT                                                   06820000
068300     END-EXEC.                                                    06830000
068400                                                                  06840000
068500     EVALUATE TRUE                                                06850000
068600         WHEN SQLCODE = ZEROS                                     06860000
068700             CONTINUE                                             06870000
068800         WHEN OTHER                                               06880000
068900             MOVE PV-CURRENT-PARAGRAPH                            06890000
069000                                 TO AA-PARAGRAPH-NAME             06900000
069100             MOVE SPACES TO AA-MESSAGE-1                          06910000
069200                            AA-MESSAGE-2                          06920000
069300             MOVE 'UNSUCCESSFUL COMMIT'                           06930000
069400                                 TO AA-DB2-OPERATION              06940000
069500             MOVE SPACES         TO AA-DB2-TABLE                  06950000
069600             PERFORM 9999-DB2-ABEND                               06960013
069700     END-EVALUATE.                                                06970000
069800 EJECT                                                            06980000
069900 9900-PROCESS-ABEND.                                              06990009
070000                                                                  07000000
070100     DISPLAY '*** ABEND'.                                         07010000
070200     DISPLAY '*** PROGRAM   = TMKUP635'.                          07020008
070300     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07030000
070400     DISPLAY AA-MESSAGE-LINE-1.                                   07040000
070500     DISPLAY AA-MESSAGE-LINE-2.                                   07050000
070600     COPY DPPD004.                                                07060000
070700     CALL 'ILBOABN0' USING ABEND-CODE.                            07070000
070800                                                                  07080000
070900                                                                  07090000
071000                                                                  07100000
071100 9999-DB2-ABEND.                                                  07110009
071200                                                                  07120000
071300     DISPLAY AA-ABEND-LIT.                                        07130000
071400     DISPLAY AA-DB2-ERROR-LIT.                                    07140000
071500     DISPLAY AA-PROGRAM-LIT.                                      07150000
071600     DISPLAY AA-PARAGRAPH-LIT.                                    07160000
071700     DISPLAY AA-DB2-OPERATION-LIT.                                07170000
071800     DISPLAY AA-DB2-TABLE.                                        07180000
071900     SET AC-DB2-ERROR TO TRUE.                                    07190000
072000                                                                  07200000
072100     COPY DPPD004.                                                07210000
072200                                                                  07220000
072300     CALL 'ILBOABN0' USING ABEND-CODE.                            07230000
