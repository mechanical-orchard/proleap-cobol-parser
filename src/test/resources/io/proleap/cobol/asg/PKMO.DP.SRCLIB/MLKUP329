000100 IDENTIFICATION DIVISION.                                         00010000
000200                                                                  00020000
000300 PROGRAM-ID.    MLKUP329.                                         00030000
000400 AUTHOR.        PAUL KEBER - STRATAGEM.                           00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  6-28-99.                                          00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*     MLKUP329 - WEEKLY DEPARTMENT PLAN TABLE UPDATE PROGRAM     *00100000
001100******************************************************************00110000
001200*     THIS PROGRAM WILL MAINTAIN THE WEEKLY DEPARTMENT PLAN DB2  *00120000
001300* TABLE WITH THE CURRENT WEEK'S DATA.  THE TABLE IS READ USING   *00130000
001400* THE TABLE KEY FROM EACH INPUT FILE RECORD.  IF THE ROW IS      *00140000
001500* FOUND, THE ROW IS UPDATED WITH DATA FROM THE INPUT FILE RECORD.*00150000
001600* IF THE ROW IS NOT FOUND, A NEW ROW IS INSERTED ON THE DB2      *00160000
001700* TABLE (TWKDPLN).  COMMITS ARE TAKEN EVERY TEN SECONDS, AND     *00170000
001800* CHECKPOINT RESTART LOGIC IS INCORPORATED.                      *00180000
001900*                                                                *00190000
      *    WR/PITS#     DATE        DESCRIPTION                        *00200000
      *    --------   --------     ---------------------------------   *00210000
      *    WR21517    09/25/2000   COMBINED LEDGER PHASE 6             *00221006
31355 *    WR31355    11/17/2000   ROD JANSSEN                         *00222011
31355 *    E-Commerce Combined Ledger Report Modification.......       *00223011
31355 *                                                                *00224011
002000******************************************************************00228000
002100                                                                  00229000
002200                                                                  00230000
002300 ENVIRONMENT DIVISION.                                            00240000
002400                                                                  00250000
002500 CONFIGURATION SECTION.                                           00260000
002600 SOURCE-COMPUTER.        IBM-3090.                                00270000
002700 OBJECT-COMPUTER.        IBM-3090.                                00280000
002800 INPUT-OUTPUT SECTION.                                            00290000
002900 FILE-CONTROL.                                                    00300000
003000     SELECT EXTRACT-FILE                                          00310000
003100         ASSIGN TO INP01.                                         00320000
003200                                                                  00330000
003300                                                                  00340000
003400 DATA DIVISION.                                                   00350000
003500 FILE SECTION.                                                    00360000
003600                                                                  00370000
003700 FD  EXTRACT-FILE                                                 00380000
003800     LABEL RECORDS ARE STANDARD                                   00390000
003900     RECORDING MODE IS F                                          00400000
004000     BLOCK CONTAINS 0 RECORDS.                                    00410000
004100 01  EXTRACT-RECORD              PIC X(64).                       00420004
004200*                                                                 00430000
004300                                                                  00440000
004400                                                                  00450000
004500 WORKING-STORAGE SECTION.                                         00460000
004600                                                                  00470000
004700 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00480000
004800                                                                  00490000
004900 01  PC-PROGRAM-CONSTANTS.                                        00500000
005300     05  PC-MAX-DEADLOCKS        PIC S9(04)    VALUE +3 COMP.     00501000
005000     05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK237'.    00510000
005100     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP329'.  00520000
005400                                                                  00550000
005500 01  PC-PROGRAM-COUNTER.                                          00560000
005600     05  PC-UPDATE-CNT           PIC  9(09).                      00570000
005600     05  PC-DISPLAY-CNT          PIC  9(09).                      00580000
005800                                                                  00590000
005900 01  PE-PROGRAM-ERROR-MESSAGES.                                   00600000
006000     05  PE-MSG-01                       PIC X(50) VALUE          00610000
006100          'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00620000
006200     05  PE-MSG-02                       PIC X(50) VALUE          00630000
006300          'ATTEMPT TO UPDATE ROW ON TABLE TWKDPLN FAILED    '.    00640000
006400     05  PE-MSG-03                       PIC X(50) VALUE          00650000
006500          'ATTEMPT TO INSERT ROW ON TABLE TWKDPLN FAILED    '.    00660000
006600     05  PE-MSG-04                       PIC X(50) VALUE          00670000
006700          'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00680000
006800     05  PE-MSG-05                       PIC X(50) VALUE          00690000
006900          'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00700000
007000     05  PE-MSG-06                       PIC X(50) VALUE          00710000
007100          'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00720000
007200     05  PE-MSG-07                       PIC X(50) VALUE          00730000
007300          'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00740000
007400     05  PE-MSG-08                       PIC X(50) VALUE          00750000
007500          'AFTER DEADLOCK ERROR, AN UPDATE OR INSERT FAILED'.     00760000
007600     05  PE-MSG-09                       PIC X(50) VALUE          00770000
007700          'CHECKPNT RESTART FAILED UPON FIRST INSERT/UPDATE'.     00780000
007800     05  PE-MSG-10                       PIC X(50) VALUE          00790000
007900          'UPDATE OF STATUS CODE ON TCKRSTCNTL UNSUCCESSFUL'.     00800000
008000     05  PE-MSG-11                       PIC X(50) VALUE          00810000
008100          'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     00820000
008200*                                                                 00870000
008300 01  PS-PROGRAM-SWITCHES.                                         00880000
008400     05  PS-INPUT-FILE-EOF-SW         PIC  X        VALUE 'N'.    00890000
008500         88  PS-MORE-INPUT-RECORDS                  VALUE 'N'.    00900000
008600         88  PS-NO-MORE-INPUT-RECORDS               VALUE 'Y'.    00910000
008700     05  PS-EMPTY-FILE-SW             PIC  X        VALUE 'N'.    00920000
008800         88  PS-EMPTY-INPUT-FILE                    VALUE 'Y'.    00930000
008900     05  PS-FIRST-COMMIT-SW           PIC X         VALUE 'N'.    00940000
009000         88  PS-FIRST-COMMIT                        VALUE 'Y'.    00950000
009100     05  PS-DEADLOCK-RESTART-SW       PIC X         VALUE 'N'.    00960000
009200         88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00970000
009300     05  PS-PROCESSING-OPTIONS        PIC X         VALUE 'P'.    00980000
009400         88  PS-UPDATE-WKDPLN-ROW                   VALUE 'U'.    00990000
009500         88  PS-INSERT-WKDPLN-ROW                   VALUE 'I'.    01010000
009600*                                                                 01030000
009700*                                                                 01040000
009800 01  PROGRAM-VARIABLES.                                           01050000
009900     05  PV-COUNT                        PIC S9(09) VALUE +0 COMP.01061000
009900     05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0 COMP.01062000
010000     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 01071000
010100     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 01080000
010200     05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 01090000
010300     05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 01100000
010400     05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 01110000
010500     05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   01120000
010600*                                                                 01122000
010700*                                                                 01123000
010800 01  PA-PROGRAM-ACCUMULATORS.                                     01124000
010900     05  PA-RECORD-COUNTS.                                        01125000
011000         10  PA-INPUT-COUNT              PIC  9(9)  VALUE ZEROES. 01126000
011200         10  PA-UPD-TWKDPLN-COUNT        PIC  9(9)  VALUE ZEROES. 01127000
011200         10  PA-INS-TWKDPLN-COUNT        PIC  9(9)  VALUE ZEROES. 01129000
011300         10  PA-SEL-TWKDPLN-COUNT        PIC  9(9)  VALUE ZEROES. 01140000
011400         10  PA-COMMIT-COUNT             PIC  9(9)  VALUE ZEROES. 01170000
011500*                                                                 01180000
011600 01  PD-PROGRAM-DISPLAYS.                                         01190000
011700     05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01200000
013800*                                                                 01370000
013900******************************************************************01380000
014000* MLRD126 - M/L WEEKLY DEPARTMENT PLAN DATABASE UPDATE TXN        01390000
014100******************************************************************01400000
31355      COPY MLRD126.                                                01410011
014300*                                                                 01420000
014400******************************************************************01430000
014500*  DB2 ERROR MESSAGES FORMAT AREA.                                01440000
014600******************************************************************01450000
014700     COPY DPWS004.                                                01460000
014800*                                                                 01470000
014900******************************************************************01480000
015000*  USED FOR DB2 ERRORS                                            01490000
015100******************************************************************01500000
015200     EXEC SQL                                                     01510000
015300         INCLUDE SQLCA                                            01520000
015400     END-EXEC.                                                    01530000
015500*                                                                 01540000
015600******************************************************************01550000
015700*  M/L WEEKLY DEPARTMENT PLAN TABLE                               01560000
015800******************************************************************01570000
015900     EXEC SQL                                                     01580000
21517          INCLUDE TWKDPLN                                          01590007
016100     END-EXEC.                                                    01600000
015500*                                                                 01610000
016300***************************************************************** 01688000
016400* DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01689000
016500***************************************************************** 01690000
016600     EXEC SQL                                                     01700000
016700         INCLUDE TCKRSTCN                                         01710000
016800     END-EXEC.                                                    01720000
016900*                                                                 01730000
017000     EXEC SQL                                                     01740000
017100         INCLUDE TCKRSTIN                                         01750000
017200     END-EXEC.                                                    01760000
017300*                                                                 01770000
017400******************************************************************01780000
017500* CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *01790000
017600******************************************************************01800000
017700 01  CR-CHECKPOINT-RESTART-AREA.                                  01810000
017800     05  CR-AREA-LEN                  PIC S9(04) VALUE +62 COMP.  01820000
017900     05  CR-CHECKPOINT-RESTART-VAR.                               01830000
31355          10  CR-PREV-DTL-KEY          PIC  X(16) VALUE SPACES.    01840011
018100         10  FILLER REDEFINES CR-PREV-DTL-KEY.                    01850000
018200             15  CR-FISCAL-WK-NBR     PIC  X(02).                 01860000
018300             15  CR-FISCAL-WK-END-DTE PIC  X(10).                 01870000
018400             15  CR-DEPT-NBR          PIC  X(03).                 01880000
31355              15  CR-CHNL-CDE          PIC  X(01).                 01890011
018700         10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    01910000
018800         10  CR-TWKDPLN-COMMIT-COUNT  PIC  9(09) VALUE ZEROES.    01920000
018900         10  CR-UPD-TWKDPLN-COUNT     PIC  9(09) VALUE ZEROES.    01930000
018900         10  CR-INS-TWKDPLN-COUNT     PIC  9(09) VALUE ZEROES.    01950000
019100         10  CR-SEL-TWKDPLN-COUNT     PIC  9(09) VALUE ZEROES.    01970000
019200*                                                                 01982000
019300 01  CK-CHECKPOINT-SAVE-AREA.                                     01983000
31355      05  CK-SAVE-PREV-KEY         PIC  X(16) VALUE SPACES.        01984011
019500     05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       01985000
019600         10  CK-FISCAL-WK-NBR     PIC  X(02).                     01986000
019700         10  CK-FISCAL-WK-END-DTE PIC  X(10).                     01987000
019800         10  CK-DEPT-NBR          PIC  X(03).                     01988000
31355          10  CK-CHNL-CDE          PIC  X(01).                     01989011
020100*                                                                 02000000
020400*                                                                 02010000
020500*-------------------*                                             02020000
020600 PROCEDURE DIVISION.                                              02030000
020700*-------------------*                                             02040000
020800                                                                  02050000
020900 0000-MAIN-MODULE.                                                02060000
021000                                                                  02070000
021100     PERFORM 1000-INITIALIZATION.                                 02080000
021200*                                                                 02090000
021300     PERFORM 2000-PROCESS-INPUT                                   02100000
021400          UNTIL PS-NO-MORE-INPUT-RECORDS.                         02110000
021500*                                                                 02120000
021600     PERFORM 8000-EOJ-ROUTINE.                                    02130000
021700                                                                  02140000
021800     STOP RUN.                                                    02150000
021900*                                                                 02160000
022000*                                                                 02170000
022100*                                                                 02180000
022200******************************************************************02190000
022300* OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 02200000
022400* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      02210000
022500******************************************************************02220000
022600*                                                                 02230000
022700 1000-INITIALIZATION.                                             02240000
022800*                                                                 02250000
022900     OPEN INPUT EXTRACT-FILE.                                     02260000
023000*                                                                 02270000
023100     PERFORM 7400-INIT-CHECKPOINT-SELECT.                         02280000
023200*                                                                 02290000
023300* CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02300000
023400     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02310000
023500         PERFORM 7500-SELECT-RESTART-INFO                         02320000
023600         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    02330000
023700                                       CR-CHECKPOINT-RESTART-VAR  02340000
023800         MOVE CR-PREV-DTL-KEY         TO CK-SAVE-PREV-KEY         02350000
023900* MOVE RESTART COUNTS TO PA-FIELDS FOR ACCURATE DISPLAY AT EOJ    02360000
024000         MOVE CR-UPD-TWKDPLN-COUNT    TO PA-UPD-TWKDPLN-COUNT     02370000
024000         MOVE CR-INS-TWKDPLN-COUNT    TO PA-INS-TWKDPLN-COUNT     02390000
024200         MOVE CR-SEL-TWKDPLN-COUNT    TO PA-SEL-TWKDPLN-COUNT     02410000
024300         MOVE CR-TWKDPLN-COMMIT-COUNT TO PA-COMMIT-COUNT          02440000
024400     ELSE                                                         02450000
024500         SET PS-FIRST-COMMIT TO TRUE                              02460000
024600     END-IF.                                                      02470000
024700*                                                                 02480000
024800     DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                      02490000
024900             TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'.             02500000
025000*                                                                 02510000
025100     PERFORM 4000-READ-EXTRACT-FILE UNTIL                         02520000
025200         PA-INPUT-COUNT > CR-INPUT-READ-COUNT                     02530000
025300      OR PS-NO-MORE-INPUT-RECORDS.                                02540000
025400*                                                                 02550000
025500     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02560000
025600         DISPLAY 'FISCAL WEEK NBR      ' ML126-FSCL-WK-NBR        02570000
025700         DISPLAY 'FISCAL WEEK END DATE ' ML126-FSCL-WK-END-DTE    02580000
025800         DISPLAY 'DEPARTMENT NBR       ' ML126-DEPT-NBR           02590000
31355          DISPLAY 'CHANNEL CODE         ' ML126-CHNL-CDE           02600011
026100         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              02620000
026200                  PA-INPUT-COUNT                                  02630000
026300     END-IF.                                                      02640000
026400                                                                  02650000
026500     IF PS-NO-MORE-INPUT-RECORDS                                  02660000
026600         IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       02670000
026700             CONTINUE                                             02680000
026800         ELSE                                                     02690000
026900             DISPLAY '** NO RECORDS ON INPUT FILE **'             02700000
027000     ELSE                                                         02710000
027100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        02720000
027200     END-IF.                                                      02730000
027300*                                                                 02740000
027400*                                                                 02750000
027500******************************************************************02760000
027600* PROCESS THE INPUT EXTRACT FILE - UPDATE OR INSERT AS NEEDED     02770000
027700******************************************************************02780000
027800 2000-PROCESS-INPUT.                                              02790000
027900*                                                                 02800000
028000     MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          02810000
028100*                                                                 02820000
028600     MOVE ML126-FSCL-WK-NBR     TO WKDPLN-FSCL-WK-NBR.            02821000
028600     MOVE ML126-FSCL-WK-END-DTE TO WKDPLN-FSCL-WK-END-DTE.        02821100
028600     MOVE ML126-DEPT-NBR        TO WKDPLN-DEPT-NBR.               02821200
31355      MOVE ML126-CHNL-CDE        TO WKDPLN-CHNL-CDE.               02821311
028600     MOVE ML126-SLS-RTL-AMT     TO WKDPLN-SLS-RTL-AMT.            02821400
028600     MOVE ML126-MKDN-RTL-AMT    TO WKDPLN-MKDN-RTL-AMT.           02822000
028600     MOVE ML126-RCPT-RTL-AMT    TO WKDPLN-RCPT-RTL-AMT.           02823000
028600     MOVE ML126-SHNK-RTL-AMT    TO WKDPLN-SHNK-RTL-AMT.           02825005
028600     MOVE ML126-END-INV-RTL-AMT TO WKDPLN-END-INV-RTL-AMT.        02826005
21517      MOVE ML126-PADJ-RTL-AMT    TO WKDPLN-PADJ-RTL-AMT.           02827009
028100*                                                                 02829200
028200     PERFORM 6000-SELECT-WKDPLN-ROW.                              02830000
028300*                                                                 02840000
028400     IF PS-PROGRAM-DEADLOCKED                                     02850000
028500         CONTINUE                                                 02860000
028600     ELSE                                                         02870000
028700         EVALUATE TRUE                                            02880000
028800             WHEN PS-UPDATE-WKDPLN-ROW                            02890000
028900                 PERFORM 6100-UPDATE-WKDPLN-ROW                   02900000
029000             WHEN PS-INSERT-WKDPLN-ROW                            02910000
029100                 PERFORM 6200-INSERT-WKDPLN-ROW                   02920000
029600         END-EVALUATE                                             02930000
029700     END-IF.                                                      02940000
028300*                                                                 02950000
029900     IF PS-PROGRAM-DEADLOCKED                                     03059200
030000         CONTINUE                                                 03059300
030100     ELSE                                                         03059400
030200         PERFORM 7700-COMMIT-PROCESSING                           03059500
030300         PERFORM 4000-READ-EXTRACT-FILE                           03059600
029700     END-IF.                                                      03059700
030400*                                                                 03059800
034200*                                                                 03420000
034300******************************************************************03430000
034400* READS THE CONDENSED FILE INTO THE TWKDPLN LAYOUT                03440000
034500******************************************************************03450000
034600 4000-READ-EXTRACT-FILE.                                          03460000
034700     READ EXTRACT-FILE INTO ML126-WEEKLY-PLN-EXTRACT-REC          03470001
034800         AT END MOVE 'Y' TO PS-INPUT-FILE-EOF-SW.                 03480000
034900*                                                                 03490000
035000     IF PS-NO-MORE-INPUT-RECORDS                                  03500000
035100         MOVE ML126-FSCL-WK-NBR         TO CR-FISCAL-WK-NBR       03510000
035200         MOVE ML126-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   03520000
035300         MOVE ML126-DEPT-NBR            TO CR-DEPT-NBR            03530000
31355          MOVE ML126-CHNL-CDE            TO CR-CHNL-CDE            03540011
035600         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    03560000
067900         MOVE PA-UPD-TWKDPLN-COUNT      TO CR-UPD-TWKDPLN-COUNT   03561000
067900         MOVE PA-INS-TWKDPLN-COUNT      TO CR-INS-TWKDPLN-COUNT   03562000
068100         MOVE PA-SEL-TWKDPLN-COUNT      TO CR-SEL-TWKDPLN-COUNT   03563000
035700*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  03570000
035800         MOVE CR-CHECKPOINT-RESTART-AREA TO                       03580000
035900                                       TCKRSTINF-WORK-STRG-DESC   03590000
036000         EXEC SQL                                                 03600000
036100           UPDATE TCKRSTINF                                       03610000
036200              SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      03620000
036300            WHERE JOB_NAME   = :PC-JOB-NAME                       03630000
036400              AND PLAN_NAME  = :PC-PROGRAM-NAME                   03640000
036500         END-EXEC                                                 03650000
036600         IF SQLCODE = 0                                           03660000
036700             CONTINUE                                             03670000
036800         ELSE                                                     03680000
036900             MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  03690000
037000             MOVE '* 4000-READ-EXTRACT-FILE *' TO                 03700000
037100                  PV-PARAGRAPH-NAME                               03710000
037200             PERFORM 9999-SQL-ABEND                               03720000
037300         END-IF                                                   03730000
037400     ELSE                                                         03740000
037500         ADD 1                         TO PA-INPUT-COUNT          03750000
                                                PC-UPDATE-CNT           03760000
               IF PC-UPDATE-CNT > 100000                                03770000
                    ADD 1                    TO PC-DISPLAY-CNT          03780000
038000              DISPLAY 'UPDATE COUNT: ' PC-DISPLAY-CNT             03790000
                    MOVE +0                  TO PC-UPDATE-CNT           03800000
038100         END-IF                                                   03810000
038200     END-IF.                                                      03820000
038300*                                                                 03830000
038300*                                                                 03840000
038400******************************************************************03850000
038500* SELECT A ROW FROM THE WEEKLY DEPT PLAN TABLE THAT MATCHES  INPUT03860000
038600*  KEY SQLCODE FROM 'SELECT' IS EVALUATED IN 2000-PROCESS-INPUT   03870000
038700******************************************************************03880000
038800 6000-SELECT-WKDPLN-ROW.                                          03890000
038900*                                                                 03900000
039000     EXEC SQL                                                     03910000
039100         SELECT 1                                                 03920000
040100           INTO :PV-COUNT                                         04020000
041100         FROM TWKDPLN                                             04120000
041200        WHERE   FSCL_WK_NBR         = :WKDPLN-FSCL-WK-NBR         04130000
041300          AND   FSCL_WK_END_DTE     = :WKDPLN-FSCL-WK-END-DTE     04140000
041400          AND   DEPT_NBR            = :WKDPLN-DEPT-NBR            04150000
31355           AND   CHNL_CDE            = :WKDPLN-CHNL-CDE            04160011
041700     END-EXEC.                                                    04180000
041800*                                                                 04190000
041900     EVALUATE SQLCODE                                             04200000
042000         WHEN 0                                                   04210000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     04220000
042100             SET PS-UPDATE-WKDPLN-ROW    TO TRUE                  04230000
042200             ADD +1                      TO PA-SEL-TWKDPLN-COUNT  04240000
042300         WHEN +100                                                04250000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     04260000
042400             SET PS-INSERT-WKDPLN-ROW    TO TRUE                  04270000
042500         WHEN -911                                                04280000
042600             ADD +1             TO PV-DEADLOCK-COUNT              04290000
042700             DISPLAY 'DEADLOCK -911 IN 6000-SELECT-WKDPLN-ROW'    04300000
042800             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04310000
042900                 MOVE '6000-SELECT-WKDPLN-ROW'                    04320000
043000                                           TO PV-PARAGRAPH-NAME   04330000
043100                 PERFORM 9000-DEADLOCK-ERROR                      04340000
043200             ELSE                                                 04350000
043300                 PERFORM 7999-RESTART-PROCESS                     04360000
043400             END-IF                                               04370000
043500         WHEN OTHER                                               04380000
043600             MOVE '6000-SELECT-WKDPLN-ROW' TO PV-PARAGRAPH-NAME   04390000
043700             MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             04400000
043800             PERFORM 9999-SQL-ABEND                               04410000
043900     END-EVALUATE.                                                04420000
044000*                                                                 04430000
044100*                                                                 04440000
044200***************************************************************** 04450000
044300* THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO AND    04460000
044400* DEPARTMENT.  CURRENT TABLE VALUES ARE UPDATED WITH THE VALUES   04470000
044500* FROM THE INPUT RECORD.                                          04480000
044600***************************************************************** 04490000
044700 6100-UPDATE-WKDPLN-ROW.                                          04500000
044800*                                                                 04510000
044900*                                                                 04520000
045200     EXEC SQL                                                     04550000
045300         UPDATE TWKDPLN                                           04560000
045400             SET SLS_RTL_AMT        = :WKDPLN-SLS-RTL-AMT         04570000
045500               , MKDN_RTL_AMT       = :WKDPLN-MKDN-RTL-AMT        04580000
045600               , RCPT_RTL_AMT       = :WKDPLN-RCPT-RTL-AMT        04590000
045800               , SHNK_RTL_AMT       = :WKDPLN-SHNK-RTL-AMT        04610000
045900               , END_INV_RTL_AMT    = :WKDPLN-END-INV-RTL-AMT     04620000
21517                , PADJ_RTL_AMT       = :WKDPLN-PADJ-RTL-AMT        04630008
046400        WHERE   FSCL_WK_NBR         = :WKDPLN-FSCL-WK-NBR         04670000
046500          AND   FSCL_WK_END_DTE     = :WKDPLN-FSCL-WK-END-DTE     04680000
046600          AND   DEPT_NBR            = :WKDPLN-DEPT-NBR            04690000
31355           AND   CHNL_CDE            = :WKDPLN-CHNL-CDE            04700011
046900     END-EXEC.                                                    04720000
047000*                                                                 04730000
047100     EVALUATE SQLCODE                                             04740000
047200         WHEN 0                                                   04750000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              04760000
049300             ADD 1              TO PA-UPD-TWKDPLN-COUNT           04770000
047400         WHEN -911                                                04780000
047500             ADD +1             TO PV-DEADLOCK-COUNT              04790000
047600             DISPLAY 'DEADLOCK -911 IN 6100-UPDATE-WKDPLN-ROW'    04800000
047700             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04810000
047800                 MOVE '6100-UPDATE-WKDPLN-ROW'                    04820000
047900                                TO PV-PARAGRAPH-NAME              04830000
048000                 PERFORM 9000-DEADLOCK-ERROR                      04840000
048100             ELSE                                                 04850000
048200                 PERFORM 7999-RESTART-PROCESS                     04860000
048300             END-IF                                               04870000
048400         WHEN OTHER                                               04880000
048500             MOVE '6100-UPDATE-WKDPLN-ROW'                        04890000
047900                                TO PV-PARAGRAPH-NAME              04900000
048600             MOVE PE-MSG-02     TO PV-OPERATION-ATTEMPTED         04910000
048700             PERFORM 9999-SQL-ABEND                               04920000
048800     END-EVALUATE.                                                04930000
048900*                                                                 04940000
049600*                                                                 04950000
049700***************************************************************** 04960000
049800* THERE WAS NO MATCHING ROW ON THE WEEKLY DEPT PLAN TABLE.      * 04970000
049900* - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 04980000
050000***************************************************************** 04990000
050100 6200-INSERT-WKDPLN-ROW.                                          05000000
050200*                                                                 05010000
050300*                                                                 05020000
050400     EXEC SQL                                                     05030000
050500         INSERT INTO TWKDPLN                                      05040000
050600             (   FSCL_WK_NBR                                      05050000
050700               , FSCL_WK_END_DTE                                  05060000
050800               , DEPT_NBR                                         05070000
31355                , CHNL_CDE                                         05080011
051100               , SLS_RTL_AMT                                      05100000
051200               , MKDN_RTL_AMT                                     05110000
051300               , RCPT_RTL_AMT                                     05120000
051500               , SHNK_RTL_AMT                                     05131000
21517                , END_INV_RTL_AMT                                  05132010
21517                , PADJ_RTL_AMT )                                   05133008
052100         VALUES                                                   05137000
052200             (   :WKDPLN-FSCL-WK-NBR                              05138000
052300               , :WKDPLN-FSCL-WK-END-DTE                          05139000
052400               , :WKDPLN-DEPT-NBR                                 05139100
31355                , :WKDPLN-CHNL-CDE                                 05139211
052700               , :WKDPLN-SLS-RTL-AMT                              05139400
052800               , :WKDPLN-MKDN-RTL-AMT                             05139500
052900               , :WKDPLN-RCPT-RTL-AMT                             05139600
053100               , :WKDPLN-SHNK-RTL-AMT                             05139800
21517                , :WKDPLN-END-INV-RTL-AMT                          05139910
21517                , :WKDPLN-PADJ-RTL-AMT )                           05140008
053700     END-EXEC.                                                    05140400
053800*                                                                 05140500
053900     EVALUATE SQLCODE                                             05140600
054000         WHEN 0                                                   05140700
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              05140800
056100             ADD 1              TO PA-INS-TWKDPLN-COUNT           05140900
054200         WHEN -911                                                05141000
054300             ADD +1             TO PV-DEADLOCK-COUNT              05142000
054400             DISPLAY 'DEADLOCK -911 IN 6200-INSERT-WKDPLN-ROW'    05143000
054500             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              05144000
054600                 MOVE '6200-INSERT-WKDPLN-ROW' TO                 05145000
054700                                              PV-PARAGRAPH-NAME   05146000
054800                 PERFORM 9000-DEADLOCK-ERROR                      05147000
054900             ELSE                                                 05148000
055000                 PERFORM 7999-RESTART-PROCESS                     05149000
055100             END-IF                                               05150000
055200         WHEN OTHER                                               05160000
055300             MOVE '6200-INSERT-WKDPLN-ROW' TO PV-PARAGRAPH-NAME   05170000
055400             MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED05180000
055500             PERFORM 9999-SQL-ABEND                               05190000
055600     END-EVALUATE.                                                05200000
055700*                                                                 05707900
056400*                                                                 05708000
056500******************************************************************05709000
056600* 7300-GET-COMMIT-TIMESTAMP.                                     *05710000
056700* PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *05720000
056800*            CONTROL TABLE                                       *05730000
056900******************************************************************05740000
057000 7300-GET-COMMIT-TIMESTAMP.                                       05750000
057100                                                                  05760000
057200     EXEC SQL                                                     05770000
057300* CHECKPOINT TAKEN BASED ON CHEKPOINT RESTART CICSP1 PANEL        05780000
057400       SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       05790000
057500         INTO :PV-COMMIT-TIMESTAMP                                05800000
057600         FROM TCKRSTCNTL                                          05810000
057700        WHERE JOB_NAME  = :PC-JOB-NAME                            05820000
057800          AND PLAN_NAME = :PC-PROGRAM-NAME                        05830000
057900     END-EXEC.                                                    05840000
058000                                                                  05850000
060900     IF SQLCODE = 0                                               05860000
061000         CONTINUE                                                 05870000
061100     ELSE                                                         05880000
00             MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME    05890000
00             MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     05900000
00             PERFORM 9999-SQL-ABEND                                   05910000
058900     END-IF.                                                      05920000
059000*                                                                 05930000
059100*                                                                 05940000
059200******************************************************************05950000
059300* 7400-INIT-CHECKPOINT-SELECT                                    *05960000
059400* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *05970000
059500*            IF WE ARE IN A RESTART CONDITION.                   *05980000
059600******************************************************************05990000
059700 7400-INIT-CHECKPOINT-SELECT.                                     06000000
059800                                                                  06010000
059900     EXEC SQL                                                     06020000
060000       SELECT  CKPT_STAT_CODE                                     06030000
060100              ,CKPT_FRQNCY_QTY                                    06040000
060200         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         06050000
060300              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        06060000
060400         FROM  TCKRSTCNTL                                         06070000
060500        WHERE  JOB_NAME  = :PC-JOB-NAME                           06080000
060600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       06090000
060700     END-EXEC.                                                    06100000
060800                                                                  06110000
060900     IF SQLCODE = 0                                               06120000
061000         CONTINUE                                                 06130000
061100     ELSE                                                         06140000
061200         MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  06150000
061300         MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     06160000
061400         PERFORM 9999-SQL-ABEND                                   06170000
061500     END-IF.                                                      06180000
061600*                                                                 06190000
061700*                                                                 06200000
061800******************************************************************06210000
061900* 7500-SELECT-RESTART-INFO                                       *06220000
062000* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *06230000
062100*            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *06240000
062200******************************************************************06250000
062300 7500-SELECT-RESTART-INFO.                                        06260000
062400                                                                  06270000
062500     EXEC SQL                                                     06280000
062600       SELECT  WORK_STRG_DESC                                     06290000
062700         INTO  :TCKRSTINF-WORK-STRG-DESC                          06300000
062800         FROM  TCKRSTINF                                          06310000
062900        WHERE  JOB_NAME  = :PC-JOB-NAME                           06320000
063000          AND  PLAN_NAME = :PC-PROGRAM-NAME                       06330000
063100     END-EXEC.                                                    06340000
063200                                                                  06350000
063300     IF SQLCODE = 0                                               06360000
063400         CONTINUE                                                 06370000
063500     ELSE                                                         06380000
063600         MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   06390000
063700         PERFORM 9999-SQL-ABEND                                   06400000
063800     END-IF.                                                      06410000
063900*                                                                 06420000
064000*                                                                 06430000
064100******************************************************************06440000
064200* 7600-SET-CURRENT-TIMESTAMP.                                    *06450000
064300* PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *06460000
064400******************************************************************06470000
064500 7600-SET-CURRENT-TIMESTAMP.                                      06480000
064600                                                                  06490000
064700     EXEC SQL                                                     06500000
064800          SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           06510000
064900     END-EXEC.                                                    06520000
065000*                                                                 06530000
065100     IF SQLCODE = 0                                               06540000
065200         CONTINUE                                                 06550000
065300     ELSE                                                         06560000
065400         MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 06570000
065500         PERFORM 9999-SQL-ABEND                                   06580000
065600     END-IF.                                                      06590000
065700*                                                                 06600000
065800*                                                                 06610000
065900******************************************************************06620000
066000* 7700-COMMIT-PROCESSING.                                        *06630000
066100* PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *06640000
066200*          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*06650000
066300******************************************************************06660000
066400 7700-COMMIT-PROCESSING.                                          06670000
066500     MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     06680000
066600                                                                  06690000
066700     PERFORM 7600-SET-CURRENT-TIMESTAMP.                          06700000
066800*                                                                 06710000
066900     IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                06720000
067000*        PREPARE COMMIT RECORD FOR UPDATE                         06730000
067100         ADD 1                          TO PA-COMMIT-COUNT        06740000
067200         MOVE ML126-FSCL-WK-NBR         TO CR-FISCAL-WK-NBR       06750000
067300         MOVE ML126-FSCL-WK-END-DTE     TO CR-FISCAL-WK-END-DTE   06760000
067400         MOVE ML126-DEPT-NBR            TO CR-DEPT-NBR            06770000
31355          MOVE ML126-CHNL-CDE            TO CR-CHNL-CDE            06780011
067700         MOVE PA-COMMIT-COUNT           TO CR-TWKDPLN-COMMIT-COUNT06800000
067800         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    06810000
067900         MOVE PA-UPD-TWKDPLN-COUNT      TO CR-UPD-TWKDPLN-COUNT   06820000
067900         MOVE PA-INS-TWKDPLN-COUNT      TO CR-INS-TWKDPLN-COUNT   06840000
068100         MOVE PA-SEL-TWKDPLN-COUNT      TO CR-SEL-TWKDPLN-COUNT   06860000
068200*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  06860300
068300         MOVE CR-CHECKPOINT-RESTART-AREA TO                       06860400
068400                                       TCKRSTINF-WORK-STRG-DESC   06860500
068500         IF PS-FIRST-COMMIT                                       06860600
068600             MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                06860700
068700             PERFORM 7900-UPDATE-CHECKPOINT-STATUS                06860800
068800             MOVE 'N' TO PS-FIRST-COMMIT-SW                       06860900
068900         END-IF                                                   06861000
069000         PERFORM 7800-COMMIT-CHANGES                              06862000
069100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        06863000
069200     END-IF.                                                      06864000
069300*                                                                 06865000
069400*                                                                 06866000
069500******************************************************************06867000
069600* 7800-COMMIT-CHANGES.                                            06868000
069700* PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      06869000
069800*            TAKE A COMMIT.                                       06870000
069900*  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    06880000
070000******************************************************************06890000
070100 7800-COMMIT-CHANGES.                                             06900000
070200                                                                  06910000
070300     EXEC SQL                                                     06920000
070400       UPDATE TCKRSTINF                                           06930000
070500          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          06940000
070600        WHERE JOB_NAME       = :PC-JOB-NAME                       06950000
070700          AND PLAN_NAME      = :PC-PROGRAM-NAME                   06960000
070800     END-EXEC.                                                    06970000
070900                                                                  06980000
071000     IF SQLCODE = 0                                               06990000
071100         CONTINUE                                                 07000000
071200     ELSE                                                         07010000
071300         MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED07020000
071400         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     07030000
071500         PERFORM 9999-SQL-ABEND                                   07040000
071600     END-IF.                                                      07050000
071700                                                                  07060000
071800     EXEC SQL                                                     07070000
071900         COMMIT                                                   07080000
072000     END-EXEC.                                                    07090000
072100                                                                  07100000
072200     IF SQLCODE = 0                                               07110000
072300         CONTINUE                                                 07120000
072400     ELSE                                                         07130000
072500         MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED07140000
072600         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     07150000
072700         PERFORM 9999-SQL-ABEND                                   07160000
072800     END-IF.                                                      07170000
072900*                                                                 07180000
073000*                                                                 07190000
073100******************************************************************07200000
073200* 7900-UPDATE-CHECKPOINT-STATUS                                   07210000
073300* PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   07220000
073400*                                                                 07230000
073500******************************************************************07240000
073600 7900-UPDATE-CHECKPOINT-STATUS.                                   07250000
073700                                                                  07260000
073800     EXEC SQL                                                     07270000
073900       UPDATE  TCKRSTCNTL                                         07280000
074000          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        07290000
074100        WHERE  JOB_NAME  = :PC-JOB-NAME                           07300000
074200          AND  PLAN_NAME = :PC-PROGRAM-NAME                       07310000
074300     END-EXEC.                                                    07320000
074400                                                                  07330000
074500     IF SQLCODE = 0                                               07340000
074600         CONTINUE                                                 07350000
074700     ELSE                                                         07360000
074800         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME07370000
074900         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED07380000
075000         PERFORM 9999-SQL-ABEND                                   07390000
075100     END-IF.                                                      07400000
075200                                                                  07410000
075300     EJECT                                                        07420000
075400*                                                                 07430000
075500*                                                                 07440000
075600******************************************************************07450000
075700* PROGRAM RESTART DUE TO A DEADLOCK AGAINST TWKDPLN ROW FOR UPDATE07460000
075800*  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  07470000
075900******************************************************************07480000
076000 7999-RESTART-PROCESS.                                            07490000
076100*                                                                 07500000
076200     SET PS-PROGRAM-DEADLOCKED TO TRUE.                           07510000
076300*                                                                 07520000
076400     CLOSE EXTRACT-FILE.                                          07530000
076500*                                                                 07540000
076600     PERFORM 7500-SELECT-RESTART-INFO.                            07550000
076700*                                                                 07560000
076800     DISPLAY '**** RESTART **** '.                                07570000
076900     MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 07580000
077000     DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   07590000
077100*                                                                 07600000
077200*-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      07610000
077300*-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        07620000
077400*-- RESTART INFORMATION IS NOT CLEARED OUT.                       07630000
077500     IF PS-FIRST-COMMIT                                           07640000
077600         INITIALIZE TCKRSTINF-WORK-STRG-DESC                      07650000
077700         DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     07660000
077800                ' BEGINNING'                                      07670000
077900     ELSE                                                         07680000
078000         DISPLAY 'TCKRSTINF-LAST CKPT '                           07690000
078100                  TCKRSTINF-WORK-STRG-DESC (1:62)                 07700000
078200***    INFO ON LAST CHECKPOINT TAKEN IS IN                        07710000
078300***    CR-CHECKPOINT-RESTART-AREA.                                07720000
078400         MOVE TCKRSTINF-WORK-STRG-DESC TO                         07730000
078500               CR-CHECKPOINT-RESTART-AREA                         07740000
078600         DISPLAY 'CHECKPOINT RESTART INFORMATION:'                07750000
078700         DISPLAY 'WEEK NBR        ' CR-FISCAL-WK-NBR              07760000
078800         DISPLAY 'WEEK END DATE   ' CR-FISCAL-WK-END-DTE          07770000
078900         DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   07780000
31355          DISPLAY 'CHANNEL CODE    ' CR-CHNL-CDE                   07790011
079200         DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           07810000
079300     END-IF.                                                      07820000
079400*                                                                 07830000
079500     OPEN INPUT EXTRACT-FILE.                                     07840000
079600     MOVE ZEROES                          TO PA-INPUT-COUNT.      07850000
079700*                                                                 07860000
079800*POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          07870000
079900     PERFORM 4000-READ-EXTRACT-FILE                               07880000
080000         UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               07890000
080100           OR PS-NO-MORE-INPUT-RECORDS.                           07900000
080200     IF PS-NO-MORE-INPUT-RECORDS                                  07910000
080300         DISPLAY 'END OF INPUT FILE ON RESTART'                   07920000
080400     ELSE                                                         07930000
080500         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              07940000
080600                  PA-INPUT-COUNT                                  07950000
080700         DISPLAY 'FISCAL WEEK NBR       ' ML126-FSCL-WK-NBR       07960000
080800         DISPLAY 'FISCAL WEEK END DATE  ' ML126-FSCL-WK-END-DTE   07970000
080900         DISPLAY 'DEPARTMENT NBR        ' ML126-DEPT-NBR          07980000
31355          DISPLAY 'CHANNEL CODE          ' ML126-CHNL-CDE          07990011
081200     END-IF.                                                      08010000
081300*                                                                 08020000
081400*RE-ESTABLISH COUNTS FOR PROCESSED INPUT (FROM CHECKPOINT RECORD) 08030000
081500     MOVE CR-UPD-TWKDPLN-COUNT    TO PA-UPD-TWKDPLN-COUNT.        08040000
081500     MOVE CR-INS-TWKDPLN-COUNT    TO PA-INS-TWKDPLN-COUNT.        08060000
081700     MOVE CR-SEL-TWKDPLN-COUNT    TO PA-SEL-TWKDPLN-COUNT.        08080000
081800     MOVE CR-TWKDPLN-COMMIT-COUNT TO PA-COMMIT-COUNT.             08110000
081900*                                                                 08120000
082000*                                                                 08130000
082100******************************************************************08140000
082200*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *08150000
082300******************************************************************08160000
082400 8000-EOJ-ROUTINE.                                                08170000
082500*                                                                 08180000
082600     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       08190000
082700     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       08200000
082800*                                                                 08210000
082900     DISPLAY '                                             '.     08220000
083000     DISPLAY 'INPUT RECORDS   ', PA-INPUT-COUNT.                  08230000
083100     DISPLAY 'SELECT TWKDPLN  ', PA-SEL-TWKDPLN-COUNT.            08240000
083200     DISPLAY 'UPDATE TWKDPLN  ', PA-UPD-TWKDPLN-COUNT.            08250000
083300     DISPLAY 'INSERT TWKDPLN  ', PA-INS-TWKDPLN-COUNT.            08260000
083400     DISPLAY '                                             '.     08310000
083500     DISPLAY 'COMMITS TAKEN   ', PA-COMMIT-COUNT.                 08320000
083600*                                                                 08330000
083700     CLOSE EXTRACT-FILE.                                          08340000
083800*                                                                 08350000
083900*                                                                 08360000
084000******************************************************************08370000
084100*  PERFORMED BY 6100-UPDATE AND 7200-INSERT                       08380000
084200*  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   08390000
084300******************************************************************08400000
084400 9000-DEADLOCK-ERROR.                                             08410000
084500*                                                                 08420000
084600         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     08430000
084700         PERFORM 9999-SQL-ABEND.                                  08440000
084800*                                                                 08450000
084900******************************************************************08460000
085000*  STANDARD DB2 ERROR ABEND ROUTINE                               08470000
085100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             08480000
085200******************************************************************08490000
085300 9999-SQL-ABEND.                                                  08500000
085400                                                                  08510000
085500     MOVE +4013                 TO ABEND-CODE.                    08520000
085600     MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            08530000
085700     DISPLAY '**  ABEND     **'.                                  08540000
085800     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              08550000
085900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            08560000
086000     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       08570000
086100     DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           08580000
086200                                                                  08590000
086300     EXEC SQL                                                     08600000
086400          ROLLBACK                                                08610000
086500     END-EXEC.                                                    08620000
086600                                                                  08630000
086700*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         08640000
086800*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        08650000
086900                                                                  08660000
087000     COPY DPPD004.                                                08670000
087100     CALL 'ILBOABN0'  USING ABEND-CODE.                           08680000
