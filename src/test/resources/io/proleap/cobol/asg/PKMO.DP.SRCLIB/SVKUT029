000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         SVKUT029.                                    00020000
000300 AUTHOR.             KARI SUTTON.                                 00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       JULY 1996.                                   00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900* SVKUT029 - TRANSACTION MATCHING PROGRAM.                       *00090000
001000*  RENAMED FROM RDKUT004.                                        *00100000
001100*                                                                *00110000
001200* THIS PROGRAM DOES A FILE COMPARISON BETWEEN THE KMC ACTIVITY   *00120000
001300* TABLE EXTRACT AND THE KMC ACTIVITY EXTRACT FROM THE DAILY POS  *00130000
001400* FILE.                                                          *00140000
001500*                                                                *00150000
001600* INPUT FILES:   DAILY-SVT00002-ACTIVITY     DDNAME = INP01      *00160000
001700*                DAILY-POS-ACTIVITY          DDNAME = INP02      *00170000
001800*                CONTROL DATE FILE           DDNAME = INP03      *00180000
001900*                                                                *00190000
002000* OUTPUT FILES:  KMC-POSTING-FILE            DDNAME = OUT01      *00200000
002100*                AUDIT-REPORT-FILE           DDNAME = OUT02      *00210000
002200*---------------------------------------------------------------* 00220000
002210*  11/17/2009  MOVED THE TRN-STAT-CDE TO THE OUTPUT FILES.      * 00221000
002220*  MADE BY: BARB SCHULTZ                WR#: WR37510            * 00222000
002221*  05/03/2011  CHANGED LRECL ON TOTAL FILE FROM 276 TO 312.     * 00222100
002222*  MADE BY: NANCY EILBES                WR#: PKE7685            * 00222200
002221*  07/25/2011  CHANGED PV-ECOMM-STORES TO OCCUR 99 TIMES.       * 00222300
002222*  MADE BY: BARB SCHULTZ                WR#: WR38972            * 00222400
002221*  06/04/2014  RECOMPILED TO ADD OMNI-CHNL-FFLMT-TYP-CDE ON     * 00222500
002221*  SVRD021.  I ALSO HAD TO INCREASE THE LENGTH OF SVRD021 FOR   * 00222600
002221*  THIS.                                                        * 00222700
002222*  MADE BY: BARB SCHULTZ                WR#: CHG0094005         * 00222804
W3540C*---------------------------------------------------------------* 00222907
P10237*  06/15/2015  COSA DATA SECURITY PROJECT.                      * 00223007
P10237*     CHANGES MADE TO CONVERT THE DL# FROM SVT_KOHLS_CRD_TXN    * 00223107
P10237*  TABLE TO ASCII FORMAT, THEN ENCRYPT THIS ASCII VALUE USING   * 00223207
P10237*  PROTEGRITY MODULE AND THEN CONVERT THE ENCRYPTED DL# FROM    * 00223307
P10237*  BINARY TO BASE-64 FORMAT AND CHANGES TO ACCOMMODATE THE      * 00223407
P10237*  ENCRYPTED DL#.                                               * 00223507
P10237*  MADE BY: COGNIZANT                   WR#: CHG0104429         * 00223607
002230******************************************************************00223707
P12431*  08/27/2018  MODIFIED THE PROGRAM TO HANDLE NEWLY ADDED       * 00223827
P12431*  ORD_NBR FIELD IN THE SVT TABLES.                             * 00223927
P12431*  MADE BY: COGNIZANT                   WR#: CHG0208643         * 00224027
002230******************************************************************00224127
002240 ENVIRONMENT DIVISION.                                            00224227
002250******************************************************************00224300
002260 CONFIGURATION SECTION.                                           00225000
002270                                                                  00226000
002280 SOURCE-COMPUTER.    IBM-3090.                                    00227000
002290 OBJECT-COMPUTER.    IBM-3090.                                    00228000
002300                                                                  00229000
002400 INPUT-OUTPUT SECTION.                                            00230000
002500                                                                  00240000
002600 FILE-CONTROL.                                                    00250000
002700                                                                  00260000
002800     SELECT DAILY-SVT00002-ACTIVITY   ASSIGN TO INP01.            00270000
002900     SELECT DAILY-POS-ACTIVITY        ASSIGN TO INP02.            00280000
003000     SELECT CONTROL-DATE-FILE         ASSIGN TO INP03.            00290000
003100     SELECT KMC-POSTING-FILE          ASSIGN TO OUT01.            00300000
003200     SELECT AUDIT-REPORT-FILE         ASSIGN TO OUT02.            00310000
003300     SELECT TOTAL-FILE                ASSIGN TO OUT03.            00320000
003400     SELECT TOTAL-DETAIL-FILE         ASSIGN TO OUT04.            00330000
003500                                                                  00340000
003600******************************************************************00350000
003700 DATA DIVISION.                                                   00360000
003800******************************************************************00370000
003900                                                                  00380000
004000 FILE SECTION.                                                    00390000
004100                                                                  00400000
004200 FD  DAILY-SVT00002-ACTIVITY                                      00410000
004300     RECORDING MODE IS F                                          00420000
004400     BLOCK CONTAINS 0 RECORDS                                     00430000
004500     LABEL RECORDS ARE OMITTED.                                   00440000
004600                                                                  00450000
P12431 01  DAILY-SVT00002-RECORD       PIC  X(198).                     00461027
004800                                                                  00470000
004900 FD  DAILY-POS-ACTIVITY                                           00480000
005000     RECORDING MODE IS F                                          00490000
005100     BLOCK CONTAINS 0 RECORDS                                     00500000
005200     LABEL RECORDS ARE OMITTED.                                   00510000
005300                                                                  00520000
P12431 01  DAILY-POS-ACTIVITY-RECORD PIC X(179).                        00531027
005500                                                                  00540000
005600 FD  CONTROL-DATE-FILE                                            00550000
005700     RECORDING MODE IS F                                          00560000
005800     BLOCK CONTAINS 0 RECORDS                                     00570000
005900     LABEL RECORDS ARE OMITTED.                                   00580000
006000                                                                  00590000
006100 01  CONTROL-DATE-RECORD         PIC X(80).                       00600000
006200                                                                  00610000
006300 FD  KMC-POSTING-FILE                                             00620000
006400     RECORDING MODE IS F                                          00630000
006500     BLOCK CONTAINS 0 RECORDS                                     00640000
006600     LABEL RECORDS ARE OMITTED.                                   00650000
006700                                                                  00660000
P12431 01  KMC-POSTING-RECORD          PIC  X(198).                     00671027
006900                                                                  00680000
007000 FD  AUDIT-REPORT-FILE                                            00690000
007100     RECORDING MODE IS F                                          00700000
007200     BLOCK CONTAINS 0 RECORDS                                     00710000
007300     LABEL RECORDS ARE OMITTED.                                   00720000
007400                                                                  00730000
P12431 01  AUDIT-REPORT-RECORD         PIC  X(198).                     00741027
007600                                                                  00750000
007700 FD  TOTAL-FILE                                                   00760000
007800     RECORDING MODE IS F                                          00770000
007900     BLOCK CONTAINS 0 RECORDS                                     00780000
008000     LABEL RECORDS ARE OMITTED.                                   00790000
008100                                                                  00800000
008200 01  TOTAL-RECORD                PIC  X(312).                     00810000
008300                                                                  00820000
008400 FD  TOTAL-DETAIL-FILE                                            00830000
008500     RECORDING MODE IS F                                          00840000
008600     BLOCK CONTAINS 0 RECORDS                                     00850000
008700     LABEL RECORDS ARE OMITTED.                                   00860000
008800                                                                  00870000
P12431 01  TOTAL-DETAIL-RECORD         PIC  X(437).                     00881027
009000                                                                  00890000
009100 WORKING-STORAGE SECTION.                                         00900000
009200                                                                  00910000
009300 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00920000
009400 01  WS-ABEND-ROUTINE            PIC X(08)      VALUE 'ILBOABN0'. 00930021
009500                                                                  00940000
009600 01  CR-CONTROL-RECORD.                                           00950000
009700     05  CR-CONTROL-DATE              PIC  X(10)    VALUE SPACES. 00960000
009800     05  FILLER                       PIC  X(70)    VALUE SPACES. 00970000
009900                                                                  00980000
010000******************************************************************00990000
010100*    PC-PROGRAM CONSTANTS                                        *01000000
010200******************************************************************01010000
010300 01  PC-PROGRAM-CONSTANTS.                                        01020000
010400     05  PC-PROGRAM-NAME          PIC  X(08)    VALUE 'SVKUT029'. 01030000
P10237     05  PC-DPKUT052              PIC  X(08)    VALUE 'DPKUT052'. 01031017
010500     05  PC-JOB-NAME              PIC  X(08)    VALUE 'SVK065  '. 01040000
010600     05  PC-UPDATE-RECORD         PIC  X(01)    VALUE 'U'.        01050000
010700     05  PC-INSERT-RECORD         PIC  X(01)    VALUE 'I'.        01060000
010800     05  PC-NUMBER-DAYS-TO-CHECK  PIC  9(01)    VALUE 7.          01070000
010900     05  PC-ONE                   PIC  9(01)    VALUE 1.          01080000
011000     05  PC-PEPLSOFT              PIC  X(08)    VALUE 'PSFTFIRB'. 01090000
011100                                                                  01100000
011200******************************************************************01110000
011300*    PV-PROGRAM VARIABLES                                        *01120000
011400******************************************************************01130000
011500 01  PV-PROGRAM-VARIABLES.                                        01140000
011600     05  PV-PARAGRAPH-NAME       PIC  X(30)     VALUE SPACES.     01150000
011700     05  PV-DB2-OPERATION-ATTEMPTED PIC X(30)   VALUE SPACES.     01160000
011800     05  PV-SELECT               PIC  X(01)     VALUE SPACE.      01170000
011900     05  PV-TENDER-ACT-TYP       PIC S9(01)     VALUE ZERO        01180000
012000                                                COMP-3.           01190000
012100     05  PV-POS-CUTOFF-DATE      PIC  X(10)     VALUE SPACES.     01200000
012200     05  PV-POS-DATE             PIC  X(10)     VALUE SPACES.     01210000
012300     05  PV-DATE-COUNTER         PIC  9(01)     VALUE ZERO.       01220000
P12431     05  PV-HOLD-SV022-RECORD    PIC  X(198)    VALUE SPACES.     01231027
012500     05  PV-SAVE-SV022-RECORD.                                    01240006
012600         10 PV-SAVE-SV022-CRD-TYP PIC S9(01)V   COMP-3.           01250000
012700         10 PV-SAVE-SV022-CRD-NBR PIC S9(12)V   COMP-3.           01260000
012800         10 PV-SAVE-SV022-POS-DTE PIC X(10).                      01270000
012900         10 PV-SAVE-SV022-STR-NBR PIC S9(04)    COMP.             01280000
013000         10 PV-SAVE-SV022-TRMNLNO PIC S9(04)    COMP.             01290000
013100         10 PV-SAVE-SV022-TRN-NBR PIC S9(04)    COMP.             01300000
013200         10 PV-SAVE-SV022-APP-AMT PIC S9(07)V99 COMP-3.           01310000
013300         10 PV-SAVE-SV022-ORG-AMT PIC S9(07)V99 COMP-3.           01320000
013400         10 PV-SAVE-SV022-TRNVOID PIC X(01).                      01330000
013500         10 PV-SAVE-SV022-TRNRCDE PIC S9(01)V  COMP-3.            01340000
P10237         10 FILLER                PIC X(21).                      01350006
013700         10 PV-SAVE-SV022-ACT-STA PIC S9(01)V  COMP-3.            01360000
013800         10 PV-SAVE-SV022-ACT-TYP PIC S9(01)V  COMP-3.            01370000
013900         10 PV-SAVE-SV022-POS-OPR PIC S9(11)V  COMP-3.            01380000
014000         10 PV-SAVE-SV022-APP-USR PIC X(08).                      01390000
014100         10 PV-SAVE-SV022-OVRTNDR PIC X(01).                      01400000
014200         10 PV-SAVE-SV022-TRN-AUTH-TMST PIC X(26).                01410000
P10237         10 FILLER                      PIC X(05).                01420006
P10237         10 PV-SAVE-SV022-DRV-LIC       PIC X(48).                01421006
P12431         10 PV-SAVE-SV022-ORD-NBR       PIC X(40).                01421127
P10237         10 FILLER                      PIC X(05).                01422006
014400     05  PV-SV022-APP-AUTH-AMT   PIC S9(07)V99 COMP-3.            01430000
014500     05  PV-CURRENT-TIMESTAMP    PIC  X(26)     VALUE SPACES.     01440000
014600     05  PV-HOLD-OVERTENDER-CRD-NBR                               01450000
014700                                 PIC S9(12)     VALUE ZEROES      01460000
014800                                                COMP-3.           01470000
014900     05  PV-CARD-BALANCE         PIC S9(07)V9(02)                 01480000
015000                                                VALUE ZEROES      01490000
015100                                                COMP-3.           01500000
015200     05  PV-SUB                  PIC 9(2)       VALUE ZERO.       01510020
015300     05  PV-MAX-STORE            PIC 9(2)       VALUE ZERO.       01520020
015400     05  PV-STORE-NBR            PIC S9(4) COMP VALUE ZERO.       01530000
015500     05  PV-ECOMM-STORES OCCURS 99 TIMES.                         01540000
015600         10  PV-ECOMM-STR   PIC S9(4) COMP      VALUE ZERO.       01550000
P10237     05  PV-ASCII                PIC  X(21).                      01551006
P10237     05  PV-DL-LENGTH            PIC  9(09)     VALUE ZEROES.     01552017
P10237     05  PV-INPUT-TEXT           PIC  X(34).                      01553010
P10237     05  PV-OUTPUT-TEXT          PIC  X(48)     VALUE SPACES.     01554010
P12431     05  PV-ORD-NBR-NULL-IND     PIC S9(4) COMP VALUE +0.         01555027
015700                                                                  01560000
015800******************************************************************01570000
015900*    PS-PROGRAM SWITCHES                                         *01580000
016000******************************************************************01590000
016100 01  PS-PROGRAM-SWITCHES.                                         01600000
016200     05  PS-FOUND-PTNDR-TRANS-SW        PIC X(01)   VALUE 'N'.    01610000
016300         88  PS-NOT-FOUND-PTNDR-TRANS               VALUE 'N'.    01620000
016400         88  PS-FOUND-PTNDR-TRANS                   VALUE 'Y'.    01630000
016500     05  PS-END-OF-PTNDR-CSR-SW         PIC  X(01)  VALUE 'N'.    01640000
016600         88  PS-NOT-END-OF-PTNDR-CSR                VALUE 'N'.    01650000
016700         88  PS-END-OF-PTNDR-CSR                    VALUE 'Y'.    01660000
016800                                                                  01670000
016900     05  PS-FOUND-GISSU-TRANS-SW        PIC X(01)   VALUE 'N'.    01680000
017000         88  PS-NOT-FOUND-GISSU-TRANS               VALUE 'N'.    01690000
017100         88  PS-FOUND-GISSU-TRANS                   VALUE 'Y'.    01700000
017200     05  PS-END-OF-GISSU-CSR-SW         PIC  X(01)  VALUE 'N'.    01710000
017300         88  PS-NOT-END-OF-GISSU-CSR                VALUE 'N'.    01720000
017400         88  PS-END-OF-GISSU-CSR                    VALUE 'Y'.    01730000
017500                                                                  01740000
017600     05  PS-FOUND-GVOID-TRANS-SW        PIC X(01)   VALUE 'N'.    01750000
017700         88  PS-NOT-FOUND-GVOID-TRANS               VALUE 'N'.    01760000
017800         88  PS-FOUND-GVOID-TRANS                   VALUE 'Y'.    01770000
017900     05  PS-END-OF-GVOID-CSR-SW         PIC  X(01)  VALUE 'N'.    01780000
018000         88  PS-NOT-END-OF-GVOID-CSR                VALUE 'N'.    01790000
018100         88  PS-END-OF-GVOID-CSR                    VALUE 'Y'.    01800000
018200                                                                  01810000
018300     05  PS-FOUND-VISSU-TRANS-SW        PIC X(01)   VALUE 'N'.    01820000
018400         88  PS-NOT-FOUND-VISSU-TRANS               VALUE 'N'.    01830000
018500         88  PS-FOUND-VISSU-TRANS                   VALUE 'Y'.    01840000
018600     05  PS-END-OF-VISSU-CSR-SW         PIC  X(01)  VALUE 'N'.    01850000
018700         88  PS-NOT-END-OF-VISSU-CSR                VALUE 'N'.    01860000
018800         88  PS-END-OF-VISSU-CSR                    VALUE 'Y'.    01870000
018900     05  PS-END-OF-XSTR-CSR-SW          PIC  X(01)  VALUE 'N'.    01880000
019000         88  PS-NOT-END-OF-XSTR-CSR                 VALUE 'N'.    01890000
019100         88  PS-END-OF-XSTR-CSR                     VALUE 'Y'.    01900000
019200     05  PS-END-OF-SVT00002-FILE-SW  PIC  X(01) VALUE 'N'.        01910000
019300         88  PS-END-OF-SVT00002-FILE            VALUE 'Y'.        01920000
019400     05  PS-END-OF-DAILY-POS-SW      PIC  X(01) VALUE 'N'.        01930000
019500         88  PS-END-OF-DAILY-POS-FILE           VALUE 'Y'.        01940000
019600     05  PS-END-OF-CONTROL-FILE-SW      PIC  X(01)   VALUE 'N'.   01950000
019700         88  PS-END-OF-CONTROL-FILE                  VALUE 'Y'.   01960000
019800     05  PS-MISSING-SVT00002-SW      PIC  X(01) VALUE 'N'.        01970000
019900         88  PS-MISSING-SVT00002-TRAN-FOUND     VALUE 'Y'.        01980000
020000         88  PS-MISS-SVT00002-TRAN-NOT-FND      VALUE 'N'.        01990000
020100     05  PS-WROTE-OVERTENDER-MSG-SW  PIC  X(01) VALUE 'N'.        02000000
020200         88  PS-WROTE-OVERTENDER-MSG            VALUE 'Y'.        02010000
020300         88  PS-OVERTENDER-MSG-NOT-WRITTEN      VALUE 'N'.        02020000
020400     05  PS-KMC-REC-SAVED-SW         PIC  X(01) VALUE 'N'.        02030000
020500         88  PS-KMC-REC-SAVED-YES               VALUE 'Y'.        02040000
020600         88  PS-KMC-REC-SAVED-NO                VALUE 'N'.        02050000
020700     05  PS-KMC-REC-SAVED-MATCH-SW   PIC  X(01) VALUE 'N'.        02060000
020800         88  PS-KMC-REC-SAVED-MATCH             VALUE 'Y'.        02070000
020900         88  PS-KMC-REC-SAVED-NO-MATCH          VALUE 'N'.        02080000
021000     05  PS-ECOMM-STR-SW             PIC  X(01) VALUE 'N'.        02090000
021100         88  PS-ECOMM-STR                       VALUE 'Y'.        02100000
021200         88  PS-NOT-ECOMM-STR                   VALUE 'N'.        02110000
021300                                                                  02120000
021400******************************************************************02130000
021500*    PA-PROGRAM ACCUMULATORS                                     *02140000
021600******************************************************************02150000
021700 01  PA-PROGRAM-ACCUMULATORS.                                     02160000
021800     05  PA-SALES-ACTIVITY-RECS-READ    PIC S9(11)   COMP-3       02170000
021900                                                     VALUE ZEROES.02180000
022000     05  PA-SVT00002-ACTIVITY-RECS-READ PIC S9(11)   COMP-3       02190000
022100                                                     VALUE ZEROES.02200000
022200     05  PA-UPDATE-RECORDS-WRITTEN      PIC S9(11)   COMP-3       02210000
022300                                                     VALUE ZEROES.02220000
022400     05  PA-AUDIT-RECORDS-WRITTEN       PIC S9(11)   COMP-3       02230000
022500                                                     VALUE ZEROES.02240000
022600                                                                  02250000
P10237******************************************************************02250110
P10237*    LK52- EBCDIC/ASCII DATA FORMAT CONVERSION AREA.             *02250210
P10237******************************************************************02250310
P10237 01  LK52-DPKUT052-SUBRTN-WORK-AREA.                              02250410
P10237     05  LK52-CONVERSION-TYPE           PIC  X(01).               02250514
P10237         88  EBCDIC-TO-ASCII                         VALUE '1'.   02250616
P10237         88  ASCII-TO-EBCDIC                         VALUE '2'.   02250716
P10237     05  LK52-LENGTH                    PIC S9(03)   COMP-3.      02250814
P10237     05  LK52-FROM-AREA                 PIC  X(50)   VALUE SPACES.02250914
P10237     05  LK52-TO-AREA                   PIC  X(50)   VALUE SPACES.02251014
P10237     05  LK52-RETURN-CODE               PIC  X(02)   VALUE '00'.  02251114
P10237         88  GOOD-LK52-RET-CODE                      VALUE '00'.  02251216
P10237                                                                  02261006
022700******************************************************************02262000
022800*    DATE ROUTINE COPY MEMBERS                                   *02270000
022900******************************************************************02280000
023000     COPY DPWS500.                                                02290000
023100                                                                  02300000
023200******************************************************************02310000
023300*  KMC UPDATE POSTING RECORD LAYOUT                              *02320000
023400******************************************************************02330000
023500     COPY SVRD018.                                                02340000
023600                                                                  02350000
023700******************************************************************02360000
023800*  KMC DAILY EXTRACT RECORD LAYOUT FROM POS                      *02370000
023900******************************************************************02380000
024000     COPY SVRD021.                                                02390005
024100                                                                  02400000
024200******************************************************************02410000
024300*  KMC DAILY EXTRACT RECORD LAYOUT FROM SVT_KOHLS_CRD_TXN        *02420000
024400******************************************************************02430000
024500     COPY SVRD022.                                                02440000
024600                                                                  02450000
024700******************************************************************02460000
024800*  KMC AUDIT REPORT RECORD LAYOUT                                *02470000
024900******************************************************************02480000
025000     COPY SVRD019.                                                02490005
025100                                                                  02500000
025200******************************************************************02510000
025300*  TOTAL RECORD LAYOUT                                           *02520000
025400******************************************************************02530000
025500     COPY SVRD043.                                                02540000
025600                                                                  02550000
025700******************************************************************02560000
025800*  DETAILS OF THE TOTAL RECORD LAYOUT                            *02570000
025900******************************************************************02580000
026000     COPY SVRD044.                                                02590000
026100                                                                  02600000
026200******************************************************************02610000
026300** WORKING STORAGE FOR CONVERSION TO CARD NUMBER                 *02620000
026400******************************************************************02630000
026500     COPY SVWS007.                                                02640000
026600******************************************************************02650000
026700*  KOHLS STORED VALUE CARD CONSTANTS                             *02660000
026800******************************************************************02670000
026900     COPY SVWS004.                                                02680000
027000                                                                  02690000
027100******************************************************************02700000
027200*    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004     *02710000
027300******************************************************************02720000
027400     COPY DPWS004.                                                02730000
027500                                                                  02740000
P10237******************************************************************02740110
P10237*  VARIABLES TO CONVERT FROM BASE64 TO BINARY & VICE VERSA       *02740210
P10237******************************************************************02740310
P10237     COPY DPWS022.                                                02740410
P10237                                                                  02740510
P10237******************************************************************02741006
P10237* LAYOUT THAT DEFINES THE PARAMETERS NEEDED TO INVOKE PROTEGRITY *02742006
P10237* MODULE                                                         *02743006
P10237******************************************************************02744006
P10237     COPY PTYCCSIP.                                               02745006
P10237                                                                  02746006
P10237******************************************************************02747006
P10237* LAYOUT THAT DEFINES THE WORKING VARIABLES TO INVOKE PROTEGRITY *02748006
P10237* MODULE                                                         *02749006
P10237******************************************************************02749106
P10237     COPY DPWS031.                                                02749217
P10237                                                                  02749306
027600******************************************************************02750000
027700*    SV-KOHL'S STORED VALUE CARD TABLE                           *02760000
027800******************************************************************02770000
027900     EXEC SQL                                                     02780000
028000         INCLUDE SVT00001                                         02790000
028100     END-EXEC.                                                    02800000
028200                                                                  02810000
028300******************************************************************02820000
028400*    SV-KOHL'S STORED VALUE CARD ACTIVITY TABLE                  *02830000
028500******************************************************************02840000
028600     EXEC SQL                                                     02850000
028700         INCLUDE SVT00002                                         02860000
028800     END-EXEC.                                                    02870000
028900                                                                  02880000
029000******************************************************************02890000
029100*       KOHL'S COSA-PARTITIONING TABLE                           *02900000
029200******************************************************************02910000
029300     EXEC SQL                                                     02920000
029400         INCLUDE TEPPART                                          02930000
029500     END-EXEC.                                                    02940000
029600                                                                  02950000
029700******************************************************************02960000
029800*       KOHL'S COSA-TRANSACTION TABLE                            *02970000
029900******************************************************************02980000
030000     EXEC SQL                                                     02990000
030100         INCLUDE TEPTRN                                           03000000
030200     END-EXEC.                                                    03010000
030300                                                                  03020000
030400******************************************************************03030000
030500*       KOHL'S COSA-TENDER TABLE                                 *03040000
030600******************************************************************03050000
030700     EXEC SQL                                                     03060000
030800         INCLUDE TEPTND                                           03070000
030900     END-EXEC.                                                    03080000
031000                                                                  03090000
031100******************************************************************03100000
031200*       KOHL'S COSA-ITEM TABLE                                   *03110000
031300******************************************************************03120000
031400     EXEC SQL                                                     03130000
031500         INCLUDE TEPITM                                           03140000
031600     END-EXEC.                                                    03150000
031700                                                                  03160000
031800******************************************************************03170000
031900*       KOHL'S DOMAIN LOCATION TABLE                             *03180000
032000******************************************************************03190000
032100     EXEC SQL                                                     03200000
032200         INCLUDE XST00001                                         03210000
032300     END-EXEC.                                                    03220000
032400                                                                  03230000
032500******************************************************************03240000
032600*    STANDARD LAYOUT FOR THE SQL COMMUNCATIONS AREA              *03250000
032700******************************************************************03260000
032800     EXEC SQL                                                     03270000
032900         INCLUDE SQLCA                                            03280000
033000     END-EXEC.                                                    03290000
033100                                                                  03300000
033200     COPY SQLCA2.                                                 03310000
033300                                                                  03320000
033400*---------------------------------------------------------------* 03330000
033500*    CURSOR TO EXTRACT TNDR_ID FROM COSA TENDER TABLE           * 03340000
033600*---------------------------------------------------------------* 03350000
033700                                                                  03360000
033800     EXEC SQL                                                     03370000
033900         DECLARE PTNDR-CSR CURSOR                                 03380000
034000          FOR SELECT                                              03390000
034100                TNDR_ID                                           03400000
034200               ,TNDR_ID_LEN_NBR                                   03410000
034300          FROM                                                    03420000
034400                TEPPART P                                         03430000
034500              , TEPTND  N                                         03440000
034600          WHERE                                                   03450000
034700                P.SLS_DTE     =   :SV022-POS-DTE                  03460000
034800            AND N.TRN_NBR     =   :SV022-TRN-NBR                  03470000
034900            AND P.PARTN_NBR   =  N.PARTN_NBR                      03480000
035000            AND N.STR_NBR     =   :SV022-STR-NBR                  03490000
035100            AND N.RGST_ID     =   :SV022-TRMNL-NBR                03500000
035200            AND TNDR_TYP_CDE  IN ('02','13')                      03510000
035300            AND TNDR_AMT      =   :EPTND-TNDR-AMT                 03520000
035400           WITH UR                                                03530000
035500     END-EXEC.                                                    03540000
035600*---------------------------------------------------------------* 03550000
035700*    CURSOR TO EXTRACT MDSE_ID FROM COSA TENDER TABLE           * 03560000
035800*---------------------------------------------------------------* 03570000
035900                                                                  03580000
036000     EXEC SQL                                                     03590000
036100         DECLARE GISSU-CSR CURSOR                                 03600000
036200          FOR SELECT                                              03610000
036300                MDSE_ID                                           03620000
036400          FROM                                                    03630000
036500                TEPPART P                                         03640000
036600              , TEPITM  I                                         03650000
036700          WHERE                                                   03660000
036800                P.SLS_DTE     =   :SV022-POS-DTE                  03670000
036900            AND P.PARTN_NBR   =  I.PARTN_NBR                      03680000
037000            AND STR_NBR       =   :SV022-STR-NBR                  03690000
037100            AND RGST_ID       =   :SV022-TRMNL-NBR                03700000
037200            AND TRN_NBR       =   :SV022-TRN-NBR                  03710000
037300            AND DEPT_NBR      =   '983'                           03720000
037400            AND CUST_CHRGD_AMT =   :SV022-APP-AUTH-AMT            03730000
037500           WITH UR                                                03740000
037600     END-EXEC.                                                    03750000
037700*---------------------------------------------------------------* 03760000
037800*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 03770000
037900*---------------------------------------------------------------* 03780000
038000                                                                  03790000
038100     EXEC SQL                                                     03800000
038200         DECLARE GVOID-CSR CURSOR                                 03810000
038300          FOR SELECT                                              03820000
038400                TNDR_ID                                           03830000
038500               ,TNDR_ID_LEN_NBR                                   03840000
038600          FROM                                                    03850000
038700                TEPPART P                                         03860000
038800              , TEPTND  N                                         03870000
038900          WHERE                                                   03880000
039000                P.SLS_DTE     =   :SV022-POS-DTE                  03890000
039100            AND P.PARTN_NBR   =  N.PARTN_NBR                      03900000
039200            AND N.STR_NBR     =   :SV022-STR-NBR                  03910000
039300            AND N.RGST_ID     =   :SV022-TRMNL-NBR                03920000
039400            AND N.TRN_NBR     =   :SV022-TRN-NBR                  03930000
039500            AND TNDR_TYP_CDE  IN  ('02', '13')                    03940000
039600            AND TNDR_VOID_IND =   :SV004-VOID-TRANS               03950000
039700            AND TNDR_AMT      = 0                                 03960000
039800           WITH UR                                                03970000
039900     END-EXEC.                                                    03980000
040000*---------------------------------------------------------------* 03990000
040100*    CURSOR TO EXTRACT MDSE_ID VOID FROM COSA TENDER TABLE      * 04000000
040200*---------------------------------------------------------------* 04010000
040300                                                                  04020000
040400     EXEC SQL                                                     04030000
040500         DECLARE VISSU-CSR CURSOR                                 04040000
040600          FOR SELECT                                              04050000
040700                MDSE_ID                                           04060000
040800          FROM                                                    04070000
040900                TEPPART P                                         04080000
041000              , TEPITM  I                                         04090000
041100          WHERE                                                   04100000
041200                P.SLS_DTE     =   :SV022-POS-DTE                  04110000
041300            AND P.PARTN_NBR   =  I.PARTN_NBR                      04120000
041400            AND STR_NBR       =   :SV022-STR-NBR                  04130000
041500            AND RGST_ID       =   :SV022-TRMNL-NBR                04140000
041600            AND TRN_NBR       =   :SV022-TRN-NBR                  04150000
041700            AND DEPT_NBR      =   '983'                           04160000
041800            AND CUST_CHRGD_AMT = 0                                04170000
041900           WITH UR                                                04180000
042000     END-EXEC.                                                    04190000
042100                                                                  04200000
042200*---------------------------------------------------------------* 04210000
042300*    CURSOR TO EXTRACT ALL ECOMMERCE STORE NUMBERS FROM XST00001* 04220000
042400*---------------------------------------------------------------* 04230000
042500                                                                  04240000
042600     EXEC SQL                                                     04250000
042700        DECLARE XSTR-CSR CURSOR                                   04260000
042800        FOR SELECT LOC_NBR                                        04270000
042900              FROM XST_LOC                                        04280000
043000            WHERE  E_BUS_IND    = 'Y'                             04290000
043100              AND  LOC_TYP_CDE  = 'DS'                            04300000
043200     END-EXEC.                                                    04310000
043300                                                                  04320000
043400 PROCEDURE DIVISION.                                              04330000
043500******************************************************************04340000
043600 A100-MAINLINE.                                                   04350000
043700******************************************************************04360000
043800     PERFORM B100-INITIALIZE.                                     04370000
043900                                                                  04380000
044000     PERFORM B200-COMPARE-SVT00002-FILES                          04390000
044100         UNTIL PS-END-OF-SVT00002-FILE                            04400000
044200            OR PS-END-OF-DAILY-POS-FILE.                          04410000
044300                                                                  04420000
044400     IF PS-END-OF-SVT00002-FILE                                   04430000
044500         PERFORM B300-PROCESS-REST-POS-FILE                       04440000
044600             UNTIL PS-END-OF-DAILY-POS-FILE                       04450000
044700     ELSE                                                         04460000
044800         PERFORM B400-PROCESS-REST-SVT0002-FILE                   04470000
044900             UNTIL PS-END-OF-SVT00002-FILE                        04480000
045000     END-IF.                                                      04490000
045100                                                                  04500000
045200     PERFORM B500-EOJ-ROUTINE.                                    04510000
045300                                                                  04520000
045400     GOBACK.                                                      04530000
045500                                                                  04540000
045600******************************************************************04550000
045700*     B100-INITIALIZE                                            *04560000
045800* ==> PROCESSES:                                                 *04570000
045900*     - OPENS THE FILES                                          *04580000
046000*     - READS THE FIRST RECORD FROM THE                          *04590000
046100*     - SVT_KOHLS_CRD_TXN AND THE POS *                           04600000
046200*       EXTRACT FILES                                            *04610000
046300* ==> PERFORMED FROM: A100-MAINLINE                              *04620000
046400******************************************************************04630000
046500 B100-INITIALIZE.                                                 04640000
046600                                                                  04650000
046700     OPEN INPUT  DAILY-SVT00002-ACTIVITY                          04660000
046800                 DAILY-POS-ACTIVITY                               04670000
046900                 CONTROL-DATE-FILE.                               04680000
047000     OPEN OUTPUT KMC-POSTING-FILE                                 04690000
047100                 AUDIT-REPORT-FILE                                04700000
047200                 TOTAL-DETAIL-FILE                                04710000
047300                 TOTAL-FILE.                                      04720000
047400                                                                  04730000
047500     READ CONTROL-DATE-FILE INTO CR-CONTROL-RECORD                04740000
047600         AT END                                                   04750000
047700             SET PS-END-OF-CONTROL-FILE TO TRUE.                  04760000
047800                                                                  04770000
047900     IF PS-END-OF-CONTROL-FILE                                    04780000
048000         DISPLAY ' '                                              04790000
048100         DISPLAY '** ABEND     **'                                04800000
048200         DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME            04810000
048300         DISPLAY '** PARAGRAPH **  = B100-INITIALIZE      '       04820000
048400         DISPLAY '** CONTROL DATE FILE IS EMPTY  '                04830000
048500         DISPLAY ' '                                              04840000
048600         MOVE +4002 TO ABEND-CODE                                 04850000
048700         CALL WS-ABEND-ROUTINE USING ABEND-CODE                   04860000
048800     ELSE                                                         04870000
048900         DISPLAY PC-PROGRAM-NAME ' CONTROL DATE:  '               04880000
049000                 CR-CONTROL-DATE                                  04890000
049100     END-IF.                                                      04900000
049200                                                                  04910000
P10237     MOVE PC-PROGRAM-NAME TO DP031-PROGRAM-NAME.                  04911017
049300     INITIALIZE SV043-RECORD.                                     04920000
049400     PERFORM B110-OPEN-XSTR-CSR.                                  04930000
049500     PERFORM B112-FETCH-XSTR-CSR UNTIL PS-END-OF-XSTR-CSR.        04940000
049600     PERFORM B114-CLOSE-XSTR-CSR.                                 04950000
049700     PERFORM Y100-READ-SVT00002-ACTIVITY.                         04960000
049800     PERFORM Y200-READ-POS-ACTIVITY.                              04970000
049900                                                                  04980000
050000*----------------------------------------------------------------*04990000
050100* OPEN THE XST00001 CURSOR                                       *05000000
050200*----------------------------------------------------------------*05010000
050300 B110-OPEN-XSTR-CSR.                                              05020000
050400     EXEC SQL                                                     05030000
050500         OPEN XSTR-CSR                                            05040000
050600     END-EXEC.                                                    05050000
050700     EVALUATE TRUE                                                05060000
050800        WHEN SQLCODE = ZERO                                       05070000
050900             CONTINUE                                             05080000
051000        WHEN OTHER                                                05090000
051100             MOVE 'B110-OPEN-XSTR-CSR'                            05100000
051200                               TO PV-PARAGRAPH-NAME               05110000
051300             MOVE 'OPEN E STORE CURSOR - '                        05120000
051400                               TO PV-DB2-OPERATION-ATTEMPTED      05130000
051500             PERFORM Z900-SQL-ABEND                               05140000
051600     END-EVALUATE.                                                05150000
051700                                                                  05160000
051800******************************************************************05170000
051900*     B112-FETCH-XSTR-CSR                                        *05180000
052000* ==> PROCESSES:                                                 *05190000
052100*     - CHECK THE LOCATION DOMAIN TABLE FOR ECOMMERCE STORES     *05200000
052200******************************************************************05210000
052300 B112-FETCH-XSTR-CSR.                                             05220000
052400     EXEC SQL                                                     05230000
052500          FETCH XSTR-CSR                                          05240000
052600          INTO :XST00001-LOC-NBR                                  05250000
052700     END-EXEC.                                                    05260000
052800                                                                  05270000
052900     EVALUATE SQLCODE                                             05280000
053000         WHEN ZERO                                                05290000
053100             ADD +1 TO PV-SUB                                     05300000
053200             MOVE XST00001-LOC-NBR TO PV-ECOMM-STR(PV-SUB)        05310000
053300         WHEN +100                                                05320000
053400             SET PS-END-OF-XSTR-CSR   TO TRUE                     05330000
053500             MOVE PV-SUB              TO PV-MAX-STORE             05340000
053600         WHEN OTHER                                               05350000
053700             MOVE 'B112-FETCH-XSTR-CSR'                           05360000
053800                               TO PV-PARAGRAPH-NAME               05370000
053900             MOVE 'FETCH E STORE CURSOR - '                       05380000
054000                               TO PV-DB2-OPERATION-ATTEMPTED      05390000
054100             PERFORM Z900-SQL-ABEND                               05400000
054200     END-EVALUATE.                                                05410000
054300                                                                  05420000
054400******************************************************************05430000
054500*     B114-CLOSE-XSTR-CSR                                        *05440000
054600* ==> PROCESSES:                                                 *05450000
054700*     - CLOSE THE E STORE CURSOR                                 *05460000
054800******************************************************************05470000
054900 B114-CLOSE-XSTR-CSR.                                             05480000
055000     EXEC SQL                                                     05490000
055100         CLOSE XSTR-CSR                                           05500000
055200     END-EXEC.                                                    05510000
055300                                                                  05520000
055400     EVALUATE TRUE                                                05530000
055500         WHEN SQLCODE = ZERO                                      05540000
055600            CONTINUE                                              05550000
055700         WHEN OTHER                                               05560000
055800             MOVE 'B114-CLOSE-XSTR-CSR'                           05570000
055900                               TO PV-PARAGRAPH-NAME               05580000
056000             MOVE 'CLOSE E STORE CURSOR - '                       05590000
056100                               TO PV-DB2-OPERATION-ATTEMPTED      05600000
056200             PERFORM Z900-SQL-ABEND                               05610000
056300     END-EVALUATE.                                                05620000
056400                                                                  05630000
056500*----------------------------------------------------------------*05640000
056600* OPEN THE POS-TNDR CURSOR                                       *05650000
056700*----------------------------------------------------------------*05660000
056800                                                                  05670000
056900 B120-OPEN-PTNDR-CSR.                                             05680000
057000     EXEC SQL                                                     05690000
057100         OPEN PTNDR-CSR                                           05700000
057200     END-EXEC.                                                    05710000
057300     EVALUATE TRUE                                                05720000
057400        WHEN SQLCODE = ZERO                                       05730000
057500             CONTINUE                                             05740000
057600        WHEN OTHER                                                05750000
057700             MOVE 'B120-OPEN-PTNDR-CSR'                           05760000
057800                               TO PV-PARAGRAPH-NAME               05770000
057900             MOVE 'OPEN POS TNDR CURSOR - '                       05780000
058000                               TO PV-DB2-OPERATION-ATTEMPTED      05790000
058100             PERFORM Z900-SQL-ABEND                               05800000
058200     END-EVALUATE.                                                05810000
058300*----------------------------------------------------------------*05820000
058400* OPEN THE GISSU CURSOR                                          *05830000
058500* CURSOR TO EXTRACT MDSE_ID FROM COSA TENDER TABLE               *05840000
058600*----------------------------------------------------------------*05850000
058700                                                                  05860000
058800 B140-OPEN-GISSU-CSR.                                             05870000
058900     EXEC SQL                                                     05880000
059000         OPEN GISSU-CSR                                           05890000
059100     END-EXEC.                                                    05900000
059200     EVALUATE TRUE                                                05910000
059300        WHEN SQLCODE = ZERO                                       05920000
059400             CONTINUE                                             05930000
059500        WHEN OTHER                                                05940000
059600             MOVE 'B140-OPEN-GISSU-CSR'                           05950000
059700                               TO PV-PARAGRAPH-NAME               05960000
059800             MOVE 'OPEN GFT ISSU CURSOR - '                       05970000
059900                               TO PV-DB2-OPERATION-ATTEMPTED      05980000
060000             PERFORM Z900-SQL-ABEND                               05990000
060100     END-EVALUATE.                                                06000000
060200*----------------------------------------------------------------*06010000
060300* OPEN THE GVOID CURSOR                                          *06020000
060400*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 06030000
060500*----------------------------------------------------------------*06040000
060600                                                                  06050000
060700 B170-OPEN-GVOID-CSR.                                             06060000
060800     EXEC SQL                                                     06070000
060900         OPEN GVOID-CSR                                           06080000
061000     END-EXEC.                                                    06090000
061100     EVALUATE TRUE                                                06100000
061200        WHEN SQLCODE = ZERO                                       06110000
061300             CONTINUE                                             06120000
061400        WHEN OTHER                                                06130000
061500             MOVE 'B170-OPEN-GVOID-CSR'                           06140000
061600                               TO PV-PARAGRAPH-NAME               06150000
061700             MOVE 'OPEN GFT VOID CURSOR - '                       06160000
061800                               TO PV-DB2-OPERATION-ATTEMPTED      06170000
061900             PERFORM Z900-SQL-ABEND                               06180000
062000     END-EVALUATE.                                                06190000
062100*----------------------------------------------------------------*06200000
062200* OPEN THE POS-TNDR CURSOR                                       *06210000
062300*----------------------------------------------------------------*06220000
062400                                                                  06230000
062500 B180-OPEN-VISSU-CSR.                                             06240000
062600     EXEC SQL                                                     06250000
062700         OPEN VISSU-CSR                                           06260000
062800     END-EXEC.                                                    06270000
062900     EVALUATE TRUE                                                06280000
063000        WHEN SQLCODE = ZERO                                       06290000
063100             CONTINUE                                             06300000
063200        WHEN OTHER                                                06310000
063300             MOVE 'B180-OPEN-VISSU-CSR'                           06320000
063400                               TO PV-PARAGRAPH-NAME               06330000
063500             MOVE 'OPEN VOID ISS CURSOR - '                       06340000
063600                               TO PV-DB2-OPERATION-ATTEMPTED      06350000
063700             PERFORM Z900-SQL-ABEND                               06360000
063800     END-EVALUATE.                                                06370000
063900******************************************************************06380000
064000*     B200-COMPARE-SVT00002-FILES.                               *06390000
064100* ==> PROCESSES:                                                 *06400000
064200*     - COMPARES INFORMATION FROM BOTH EXTRACT FILES TO SEE IF   *06410000
064300*       THERE IS A MATCH.  IF A MATCH IS FOUND AN UPDATE RECORD  *06420000
064400*       IS WRITTEN AND A RECORD IS READ FROM BOTH EXTRACT FILES. *06430000
064500*     - IF THE POS RECORD IS MISSING, AN AUDIT RECORD IS WRITTEN *06440000
064600*       AND ANOTHER POS RECORD IS READ.                          *06450000
064700*     - IF THE SVT00002 RECORD IS MISSING, THE                   *06460000
064800*     - SVT_KOHLS_CRD_TXN TABLE IS *                              06470000
064900*       QUERIED FOR THE PREVIOUS PC-NUMBER-DAYS-TO-CHECK TO SEE  *06480000
065000*       IF A MATCH CAN BE FOUND.   IF A MATCH IS FOUND, AN       *06490000
065100*       UPDATE RECORD IS WRITTEN.  IF A MATCH IS NOT FOUND, AN   *06500000
065200*       AUDIT RECORD IS WRITTEN.  IN EITHER CASE ANOTHER         *06510000
065300*        SVT00002 RECORD IS READ.                                *06520000
065400*     - **** NOTE:  REVERSAL CODE SHOULD BE ADDED TO COMPARISON  *06530000
065500*                   WHEN POS EXTRACT IS CHANGED TO PASS THIS     *06540000
065600*                   VALUE.                                       *06550000
065700* ==> PERFORMED FROM: A100-MAINLINE                              *06560000
065800******************************************************************06570000
065900 B200-COMPARE-SVT00002-FILES.                                     06580000
066000                                                                  06590000
066100     IF SV022-CRD-NBR = SV021-CRD-NBR                             06600000
066200       IF SV022-STR-NBR = SV021-STR-NBR                           06610000
066300         IF SV022-TRMNL-NBR = SV021-TRMNL-NBR                     06620000
066400           IF SV022-TRN-NBR = SV021-TRN-NBR                       06630000
066500             IF SV022-ACTVY-TYP-CDE = SV021-ACTVY-TYP-CDE         06640000
066600               IF SV022-APP-AUTH-AMT  = SV021-APP-AUTH-AMT        06650000
066700                 IF SV022-TRN-VOID-IND  = SV021-TRN-VOID-IND      06660000
066800                     PERFORM D100-MATCH-PROCESS                   06670000
066900                     PERFORM Y200-READ-POS-ACTIVITY               06680000
067000                     PERFORM Y100-READ-SVT00002-ACTIVITY          06690000
067100                 ELSE                                             06700000
067200                     IF SV022-TRN-VOID-IND  > SV021-TRN-VOID-IND  06710000
067300                         PERFORM C600-CHECK-FOR-ORIG-POS-VOID     06720000
067400                     ELSE                                         06730000
067500                         PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN     06740000
067600                         IF PS-MISSING-SVT00002-TRAN-FOUND        06750000
067700                             PERFORM Y100-READ-SVT00002-ACTIVITY  06760000
067800                         END-IF                                   06770000
067900                         PERFORM Y200-READ-POS-ACTIVITY           06780000
068000                     END-IF                                       06790000
068100                 END-IF                                           06800000
068200               ELSE                                               06810000
068300                   IF SV022-APP-AUTH-AMT > SV021-APP-AUTH-AMT     06820000
068400                       PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN       06830000
068500                       PERFORM Y200-READ-POS-ACTIVITY             06840000
068600                   ELSE                                           06850000
068700                       PERFORM C100-MISSING-POS-RECORD            06860000
068800                       IF PS-KMC-REC-SAVED-NO                     06870000
068900                           PERFORM Y100-READ-SVT00002-ACTIVITY    06880000
069000                       ELSE                                       06890000
069100                           SET PS-KMC-REC-SAVED-NO TO TRUE        06900000
069200                       END-IF                                     06910000
069300                   END-IF                                         06920000
069400               END-IF                                             06930000
069500             ELSE                                                 06940000
069600                 IF SV022-ACTVY-TYP-CDE > SV021-ACTVY-TYP-CDE     06950000
069700                     PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN         06960000
069800                     PERFORM Y200-READ-POS-ACTIVITY               06970000
069900                 ELSE                                             06980000
070000                     PERFORM C100-MISSING-POS-RECORD              06990000
070100                     IF PS-KMC-REC-SAVED-NO                       07000000
070200                         PERFORM Y100-READ-SVT00002-ACTIVITY      07010000
070300                     ELSE                                         07020000
070400                         SET PS-KMC-REC-SAVED-NO TO TRUE          07030000
070500                     END-IF                                       07040000
070600                 END-IF                                           07050000
070700             END-IF                                               07060000
070800           ELSE                                                   07070000
070900               IF SV022-TRN-NBR > SV021-TRN-NBR                   07080000
071000                   PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN           07090000
071100                   PERFORM Y200-READ-POS-ACTIVITY                 07100000
071200               ELSE                                               07110000
071300                   PERFORM C100-MISSING-POS-RECORD                07120000
071400                   IF PS-KMC-REC-SAVED-NO                         07130000
071500                       PERFORM Y100-READ-SVT00002-ACTIVITY        07140000
071600                   ELSE                                           07150000
071700                       SET PS-KMC-REC-SAVED-NO TO TRUE            07160000
071800                   END-IF                                         07170000
071900               END-IF                                             07180000
072000           END-IF                                                 07190000
072100         ELSE                                                     07200000
072200             IF SV022-TRMNL-NBR > SV021-TRMNL-NBR                 07210000
072300                 PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN             07220000
072400                 PERFORM Y200-READ-POS-ACTIVITY                   07230000
072500             ELSE                                                 07240000
072600                 PERFORM C100-MISSING-POS-RECORD                  07250000
072700                 IF PS-KMC-REC-SAVED-NO                           07260000
072800                     PERFORM Y100-READ-SVT00002-ACTIVITY          07270000
072900                 ELSE                                             07280000
073000                     SET PS-KMC-REC-SAVED-NO TO TRUE              07290000
073100                 END-IF                                           07300000
073200             END-IF                                               07310000
073300         END-IF                                                   07320000
073400       ELSE                                                       07330000
073500           IF SV022-STR-NBR > SV021-STR-NBR                       07340000
073600               PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN               07350000
073700               PERFORM Y200-READ-POS-ACTIVITY                     07360000
073800           ELSE                                                   07370000
073900               PERFORM C100-MISSING-POS-RECORD                    07380000
074000               IF PS-KMC-REC-SAVED-NO                             07390000
074100                   PERFORM Y100-READ-SVT00002-ACTIVITY            07400000
074200               ELSE                                               07410000
074300                   SET PS-KMC-REC-SAVED-NO TO TRUE                07420000
074400               END-IF                                             07430000
074500           END-IF                                                 07440000
074600       END-IF                                                     07450000
074700     ELSE                                                         07460000
074800         IF SV022-CRD-NBR > SV021-CRD-NBR                         07470000
074900             PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN                 07480000
075000             PERFORM Y200-READ-POS-ACTIVITY                       07490000
075100         ELSE                                                     07500000
075200             PERFORM C100-MISSING-POS-RECORD                      07510000
075300             IF PS-KMC-REC-SAVED-NO                               07520000
075400                 PERFORM Y100-READ-SVT00002-ACTIVITY              07530000
075500             ELSE                                                 07540000
075600                 SET PS-KMC-REC-SAVED-NO TO TRUE                  07550000
075700             END-IF                                               07560000
075800         END-IF                                                   07570000
075900     END-IF.                                                      07580000
076000                                                                  07590000
076100******************************************************************07600000
076200*     B300-PROCESS-REST-POS-FILE                                 *07610000
076300* ==> PROCESSES:                                                 *07620000
076400*     - PROCESSES THE REST OF THE POS EXTRACT RECORDS.           *07630000
076500*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING               *07640000
076600*     - SVT00002 RECORD.                                         *07650000
076700* ==> PERFORMED FROM: A100-MAINLINE                              *07660000
076800******************************************************************07670000
076900 B300-PROCESS-REST-POS-FILE.                                      07680000
077000                                                                  07690000
077100     PERFORM C000-CHECK-SVT-KOHLS-CRD-TXN.                        07700000
077200     PERFORM Y200-READ-POS-ACTIVITY.                              07710000
077300                                                                  07720000
077400******************************************************************07730000
077500*     B400-PROCESS-REST-SVT0002-FILE                            * 07740000
077600* ==> PROCESSES:                                                 *07750000
077700*     - PROCESSES THE REST OF THE SVT00002 EXTRACT RECORDS.      *07760000
077800*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING POS RECORD.   *07770000
077900* ==> PERFORMED FROM: A100-MAINLINE                              *07780000
078000******************************************************************07790000
078100 B400-PROCESS-REST-SVT0002-FILE.                                  07800000
078200                                                                  07810000
078300     PERFORM C100-MISSING-POS-RECORD.                             07820000
078400     IF PS-KMC-REC-SAVED-NO                                       07830000
078500          PERFORM Y100-READ-SVT00002-ACTIVITY                     07840000
078600     ELSE                                                         07850000
078700          SET PS-KMC-REC-SAVED-NO TO TRUE                         07860000
078800     END-IF.                                                      07870000
078900                                                                  07880000
079000******************************************************************07890000
079100*     B500-EOJ-ROUTINE                                           *07900000
079200* ==> PROCESSES:                                                 *07910000
079300*     - CLOSES THE FILES.                                        *07920000
079400*     - DISPLAYS THE PROGRAM COUNTS TO SYSOUT.                   *07930000
079500* ==> PERFORMED FROM: A100-MAINLINE                              *07940000
079600******************************************************************07950000
079700 B500-EOJ-ROUTINE.                                                07960000
079800                                                                  07970000
079900     WRITE TOTAL-RECORD FROM SV043-RECORD.                        07980000
080000                                                                  07990000
080100     CLOSE DAILY-SVT00002-ACTIVITY                                08000000
080200           DAILY-POS-ACTIVITY                                     08010000
080300           CONTROL-DATE-FILE                                      08020000
080400           KMC-POSTING-FILE                                       08030000
080500           AUDIT-REPORT-FILE                                      08040000
080600           TOTAL-DETAIL-FILE                                      08050000
080700           TOTAL-FILE.                                            08060000
080800                                                                  08070000
080900     DISPLAY ' '.                                                 08080000
081000     DISPLAY 'MESSAGES FOR PROGRAM ' PC-PROGRAM-NAME.             08090000
081100     DISPLAY 'NUMBER OF SVT00002 EXTRACT RECORDS READ:       '    08100000
081200             PA-SVT00002-ACTIVITY-RECS-READ.                      08110000
081300     DISPLAY 'NUMBER OF DAILY SALES EXTRACT RECORDS READ:  '      08120000
081400             PA-SALES-ACTIVITY-RECS-READ.                         08130000
081500     DISPLAY 'NUMBER OF UPDATE/INSERT RECORDS WRITTEN:     '      08140000
081600             PA-UPDATE-RECORDS-WRITTEN.                           08150000
081700     DISPLAY 'NUMBER OF AUDIT REPORT RECORDS WRITTEN:      '      08160000
081800             PA-AUDIT-RECORDS-WRITTEN.                            08170000
081900     DISPLAY ' '.                                                 08180000
082000                                                                  08190000
082100*----------------------------------------------------------------*08200000
082200* CLOSE THE POS-TNDR CURSOR                                      *08210000
082300*----------------------------------------------------------------*08220000
082400                                                                  08230000
082500 B520-CLOSE-PTNDR-CSR.                                            08240000
082600     EXEC SQL                                                     08250000
082700         CLOSE PTNDR-CSR                                          08260000
082800     END-EXEC.                                                    08270000
082900                                                                  08280000
083000     EVALUATE TRUE                                                08290000
083100         WHEN SQLCODE = ZERO                                      08300000
083200            CONTINUE                                              08310000
083300         WHEN OTHER                                               08320000
083400             MOVE 'B520-CLOSE-PTNDR-CSR'                          08330000
083500                               TO PV-PARAGRAPH-NAME               08340000
083600             MOVE 'CLOSE POS TNDR CURSOR - '                      08350000
083700                               TO PV-DB2-OPERATION-ATTEMPTED      08360000
083800             PERFORM Z900-SQL-ABEND                               08370000
083900     END-EVALUATE.                                                08380000
084000                                                                  08390000
084100*----------------------------------------------------------------*08400000
084200* CLOSE THE GISSU CURSOR                                         *08410000
084300* CURSOR TO EXTRACT MDSE_ID FROM COSA TENDER TABLE               *08420000
084400*----------------------------------------------------------------*08430000
084500                                                                  08440000
084600 B540-CLOSE-GISSU-CSR.                                            08450000
084700     EXEC SQL                                                     08460000
084800         CLOSE GISSU-CSR                                          08470000
084900     END-EXEC.                                                    08480000
085000                                                                  08490000
085100     EVALUATE TRUE                                                08500000
085200         WHEN SQLCODE = ZERO                                      08510000
085300            CONTINUE                                              08520000
085400         WHEN OTHER                                               08530000
085500             MOVE 'B540-CLOSE-GISSU-CSR'                          08540000
085600                               TO PV-PARAGRAPH-NAME               08550000
085700             MOVE 'CLOSE GFT ISSU CURSOR - '                      08560000
085800                               TO PV-DB2-OPERATION-ATTEMPTED      08570000
085900             PERFORM Z900-SQL-ABEND                               08580000
086000     END-EVALUATE.                                                08590000
086100                                                                  08600000
086200*----------------------------------------------------------------*08610000
086300* CLOSE THE GVOID CURSOR                                         *08620000
086400*    CURSOR TO EXTRACT TNDR_ID VOID FROM COSA TENDER TABLE      * 08630000
086500*----------------------------------------------------------------*08640000
086600                                                                  08650000
086700 B570-CLOSE-GVOID-CSR.                                            08660000
086800     EXEC SQL                                                     08670000
086900         CLOSE GVOID-CSR                                          08680000
087000     END-EXEC.                                                    08690000
087100                                                                  08700000
087200     EVALUATE TRUE                                                08710000
087300         WHEN SQLCODE = ZERO                                      08720000
087400            CONTINUE                                              08730000
087500         WHEN OTHER                                               08740000
087600             MOVE 'B570-CLOSE-GVOID-CSR'                          08750000
087700                               TO PV-PARAGRAPH-NAME               08760000
087800             MOVE 'CLOSE GFT VOID CURSOR - '                      08770000
087900                               TO PV-DB2-OPERATION-ATTEMPTED      08780000
088000             PERFORM Z900-SQL-ABEND                               08790000
088100     END-EVALUATE.                                                08800000
088200                                                                  08810000
088300*----------------------------------------------------------------*08820000
088400* CLOSE THE POS-TNDR CURSOR                                      *08830000
088500*----------------------------------------------------------------*08840000
088600                                                                  08850000
088700 B580-CLOSE-VISSU-CSR.                                            08860000
088800     EXEC SQL                                                     08870000
088900         CLOSE VISSU-CSR                                          08880000
089000     END-EXEC.                                                    08890000
089100                                                                  08900000
089200     EVALUATE TRUE                                                08910000
089300         WHEN SQLCODE = ZERO                                      08920000
089400            CONTINUE                                              08930000
089500         WHEN OTHER                                               08940000
089600             MOVE 'B580-CLOSE-VISSU-CSR'                          08950000
089700                               TO PV-PARAGRAPH-NAME               08960000
089800             MOVE 'CLOSE VOID ISS CURSOR - '                      08970000
089900                               TO PV-DB2-OPERATION-ATTEMPTED      08980000
090000             PERFORM Z900-SQL-ABEND                               08990000
090100     END-EVALUATE.                                                09000000
090200                                                                  09010000
090300******************************************************************09020000
090400 C000-CHECK-SVT-KOHLS-CRD-TXN.                                    09030000
090500     SET PS-MISS-SVT00002-TRAN-NOT-FND TO TRUE.                   09040000
090600     MOVE SV021-POS-DTE TO PV-POS-DATE.                           09050000
090700     PERFORM C200-CALCULATE-CUTOFF-DATE.                          09060000
090800     PERFORM C300-LOOK-FOR-MISSING-TRANS                          09070000
090900         VARYING PV-DATE-COUNTER FROM 1 BY 1                      09080000
091000         UNTIL PS-MISSING-SVT00002-TRAN-FOUND                     09090000
091100            OR PV-POS-DATE < PV-POS-CUTOFF-DATE                   09100000
091200            OR PV-DATE-COUNTER > PC-NUMBER-DAYS-TO-CHECK.         09110000
091300     IF PS-MISSING-SVT00002-TRAN-FOUND                            09120000
091400         PERFORM C400-FOUND-MATCH-PROCESS                         09130000
091500     ELSE                                                         09140000
091600        PERFORM C500-MISSING-SVT00002-RECORD                      09150000
091700     END-IF.                                                      09160000
091800******************************************************************09170000
091900*     C100-MISSING-POS-RECORD                                    *09180000
092000* ==> PROCESSES:                                                 *09190000
092100*     - CHECK THE POS DATE ON THE KMRC RECORD.  WHEN IT IS LESS  *09200000
092200*       THAN THE CONTROL DATE, LOOK FOR THE TRANSACTION ON THE   *09210000
092300*       COSA TABLES USING THE POS DATE.  IF IT IS FOUND WRITE    *09220000
092400*       THE TRANSACTION TO THE UPDATE FILE OTHERWISE WRITE IT    *09230000
092500*       TO THE AUDIT FILE.                                       *09240000
092600*     - IF AN ISSUANCE COMES FROM THE ON-LINE ISSUANCE OF CARDS  *09250000
092700*       THEY WILL NOT BE FOUND ON THE POS FILE.  THESE CARDS     *09260000
092800*       WILL HAVE AN APPROVAL USER ID OF RDUCRD, WHICH IS THE    *09270000
092900*       MNEMONIC.  WE DONT WANT TO FLAG THESE CARDS AS HAVING A  *09280000
093000*       MISSING POS TRANSACTION, SO THEY WILL BE PASSED TO THE   *09290000
093100*       UPDATE PROGRAM AS AN OK TRANSACTION.  THE ACTIVITY STATUS*09300000
093200*       WILL BE CHANGED TO VERIFIED.                             *09310000
093300*     - WRITES OUT AN AUDIT RECORD FOR THE MISSING POS RECORD    *09320000
093400*       AND FLAGS IT AS A VOID OR NORMAL TRANSACTION             *09330000
093500*     - CHECKS FOR AN OVERRIDDEN DOLLAR AMOUNT                   *09340000
093600*     - CHECKS FOR AN OVERTENDERED BALANCE FOR THE DAY           *09350000
093700* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *09360000
093800*                      B400-PROCESS-REST-SVT0002-FILE           * 09370000
093900******************************************************************09380000
094000 C100-MISSING-POS-RECORD.                                         09390000
094100                                                                  09400000
094200     SET PS-KMC-REC-SAVED-NO       TO TRUE.                       09410000
094300     COMPUTE EPTND-TNDR-AMT =                                     09420000
094400             SV022-APP-AUTH-AMT * -1                              09430000
094500     END-COMPUTE.                                                 09440000
094600                                                                  09450000
094700     IF SV022-POS-DTE = CR-CONTROL-DATE                           09460000
094800         SET PS-KMC-REC-SAVED-NO-MATCH TO TRUE                    09470000
094900         PERFORM C110-CHECK-FOR-VOID                              09480000
095000     ELSE                                                         09490000
095100         SET PS-KMC-REC-SAVED-MATCH    TO TRUE                    09500000
095200         IF SV022-CRD-TYP-CDE = 1                                 09510000
095300             SET PS-NOT-FOUND-PTNDR-TRANS  TO TRUE                09520000
095400             SET PS-NOT-END-OF-PTNDR-CSR   TO TRUE                09530000
095500                                                                  09540000
095600             PERFORM B120-OPEN-PTNDR-CSR                          09550000
095700             PERFORM C120-FETCH-PTNDR-CSR                         09560000
095800               UNTIL PS-FOUND-PTNDR-TRANS                         09570000
095900                  OR PS-END-OF-PTNDR-CSR                          09580000
096000             PERFORM B520-CLOSE-PTNDR-CSR                         09590000
096100         ELSE                                                     09600000
096200             IF SV022-ACTVY-TYP-CDE = 3                           09610000
096300                 SET PS-NOT-FOUND-PTNDR-TRANS  TO TRUE            09620000
096400                 SET PS-NOT-END-OF-PTNDR-CSR   TO TRUE            09630000
096500                 PERFORM B120-OPEN-PTNDR-CSR                      09640000
096600                 PERFORM C120-FETCH-PTNDR-CSR                     09650000
096700                   UNTIL PS-FOUND-PTNDR-TRANS                     09660000
096800                      OR PS-END-OF-PTNDR-CSR                      09670000
096900                 PERFORM B520-CLOSE-PTNDR-CSR                     09680000
097000             ELSE                                                 09690000
097100                 SET PS-NOT-FOUND-GISSU-TRANS  TO TRUE            09700000
097200                 SET PS-NOT-END-OF-GISSU-CSR   TO TRUE            09710000
097300                 PERFORM B140-OPEN-GISSU-CSR                      09720000
097400                 PERFORM C140-FETCH-GISSU-CSR                     09730000
097500                   UNTIL PS-FOUND-GISSU-TRANS                     09740000
097600                      OR PS-END-OF-GISSU-CSR                      09750000
097700                 PERFORM B540-CLOSE-GISSU-CSR                     09760000
097800             END-IF                                               09770000
097900         END-IF                                                   09780000
098000     END-IF.                                                      09790000
098100                                                                  09800000
098200                                                                  09810000
098300     IF PS-KMC-REC-SAVED-NO-MATCH                                 09820000
098400         IF PS-KMC-REC-SAVED-YES                                  09830000
098500             MOVE SV022-KMCACT-EXTRACT-RECORD                     09840000
098600               TO PV-HOLD-SV022-RECORD                            09850000
098700             MOVE PV-SAVE-SV022-RECORD                            09860000
098800               TO SV022-KMCACT-EXTRACT-RECORD                     09870000
098900         END-IF                                                   09880000
099000                                                                  09890000
099100         MOVE +1 TO PV-SUB                                        09900000
099200         SET PS-NOT-ECOMM-STR TO TRUE                             09910000
099300         MOVE SV022-STR-NBR TO PV-STORE-NBR                       09920000
099400         PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE       09930000
099500                                                                  09940000
099600         IF ((SV022-APPR-USER-ID = SV004-ISSUE-MNEMONIC AND       09950000
099700              PS-NOT-ECOMM-STR)                                   09960000
099800             OR SV022-APPR-USER-ID = PC-PEPLSOFT)                 09970000
099900             PERFORM D100-MATCH-PROCESS                           09980000
100000         ELSE                                                     09990000
100100             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         10000000
100200                 SET SV019-MISSING-POS-TRANS TO TRUE              10010000
100300             ELSE                                                 10020000
100400                 SET SV019-MISSING-POS-VOID TO TRUE               10030000
100500             END-IF                                               10040000
100600                                                                  10050000
100700             PERFORM Z200-MOVE-KMC-TO-AUDIT                       10060000
100800             PERFORM Z300-WRITE-AUDIT-RECORD                      10070000
100900                                                                  10080000
101000             PERFORM E100-CHECK-OVERRIDDEN-DOLLAR                 10090000
101100             PERFORM E200-CHECK-OVERTENDERED-BALNCE               10100000
101200         END-IF                                                   10110000
101300         IF PS-KMC-REC-SAVED-YES                                  10120000
101400             MOVE PV-HOLD-SV022-RECORD                            10130000
101500               TO SV022-KMCACT-EXTRACT-RECORD                     10140000
101600         END-IF                                                   10150000
101700     END-IF.                                                      10160000
101800                                                                  10170000
101900******************************************************************10180000
102000*     C110-CHECK-FOR-VOID                                        *10190000
102100* ==> PROCESSES:                                                 *10200000
102200*     - CHECK TO SEE IF THE TRANSACTION WAS AN ABORT ON THE COSA *10210000
102300*       TRANSACTION TABLE.                                       *10220000
102400*     - IF IT IS AN ABORT CHECK WHETHER THE NEXT KMRC RECORD IS  *10230000
102500*       A MATCHING VOID.  IF IT IS WRITE THE RECORD TO THE       *10240000
102600*       UPDATE FILE.                                             *10250000
102700* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *10260000
102800******************************************************************10270000
102900 C110-CHECK-FOR-VOID.                                             10280000
103000                                                                  10290000
103100     EXEC SQL                                                     10300000
103200         SELECT TRN_NBR                                           10310000
103300           INTO :EPTRN-TRN-NBR                                    10320000
103400           FROM TEPPART P                                         10330000
103500              , TEPTRN T                                          10340000
103600          WHERE P.SLS_DTE = :SV022-POS-DTE                        10350000
103700            AND P.PARTN_NBR = T.PARTN_NBR                         10360000
103800            AND STR_NBR = :SV022-STR-NBR                          10370000
103900            AND RGST_ID = :SV022-TRMNL-NBR                        10380000
104000            AND TRN_NBR = :SV022-TRN-NBR                          10390000
104100            AND VOID_ABRT_CDE = 'A'                               10400000
104200           WITH UR                                                10410000
104300     END-EXEC.                                                    10420000
104400                                                                  10430000
104500     EVALUATE TRUE                                                10440000
104600         WHEN SQLCODE = +0                                        10450000
104700         WHEN SQLCODE = -811                                      10460000
104800             MOVE SV022-KMCACT-EXTRACT-RECORD                     10470000
104900                 TO PV-SAVE-SV022-RECORD                          10480000
105000             SET PS-KMC-REC-SAVED-YES TO TRUE                     10490000
105100             PERFORM Y100-READ-SVT00002-ACTIVITY                  10500000
105200             COMPUTE PV-SV022-APP-AUTH-AMT =                      10510000
105300                       (SV022-APP-AUTH-AMT * (-1))                10520000
105400             IF SV022-CRD-TYP-CDE = PV-SAVE-SV022-CRD-TYP AND     10530000
105500                SV022-CRD-NBR     = PV-SAVE-SV022-CRD-NBR AND     10540000
105600                SV022-POS-DTE     = PV-SAVE-SV022-POS-DTE AND     10550000
105700                SV022-STR-NBR     = PV-SAVE-SV022-STR-NBR AND     10560000
105800                SV022-TRMNL-NBR   = PV-SAVE-SV022-TRMNLNO AND     10570000
105900                SV022-TRN-NBR     = PV-SAVE-SV022-TRN-NBR AND     10580000
106000                PV-SV022-APP-AUTH-AMT =                           10590000
106100                                    PV-SAVE-SV022-APP-AMT         10600000
106200                 IF SV022-TRN-VOID-IND NOT =                      10610000
106300                                    PV-SAVE-SV022-TRNVOID         10620000
106400                     SET PS-KMC-REC-SAVED-MATCH TO TRUE           10630000
106500                     SET PS-KMC-REC-SAVED-NO    TO TRUE           10640000
106600                     PERFORM D100-MATCH-PROCESS                   10650000
106700                 END-IF                                           10660000
106800             END-IF                                               10670000
106900         WHEN SQLCODE = +100                                      10680000
107000             CONTINUE                                             10690000
107100         WHEN OTHER                                               10700000
107200             MOVE 'C100-MISSING-POS-RECORD       '                10710000
107300                               TO PV-PARAGRAPH-NAME               10720000
107400             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                10730000
107500                               TO PV-DB2-OPERATION-ATTEMPTED      10740000
107600             PERFORM Z900-SQL-ABEND                               10750000
107700     END-EVALUATE.                                                10760000
107800                                                                  10770000
107900******************************************************************10780000
108000*     C120-FETCH-PTNDR-CSR                                       *10790000
108100* ==> PROCESSES:                                                 *10800000
108200*     - CHECK THE COSA TENDER TABLE TO SEE IF A MATCH IS FOUND   *10810000
108300*       FOR THE TRANSACTION.                                     *10820000
108400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *10830000
108500******************************************************************10840000
108600 C120-FETCH-PTNDR-CSR.                                            10850000
108700                                                                  10860000
108800     EXEC SQL                                                     10870000
108900          FETCH PTNDR-CSR                                         10880000
109000          INTO                                                    10890000
109100                :EPTND-TNDR-ID                                    10900000
109200               ,:EPTND-TNDR-ID-LEN-NBR                            10910000
109300     END-EXEC.                                                    10920000
109400                                                                  10930000
109500     EVALUATE TRUE                                                10940000
109600         WHEN SQLCODE = ZERO                                      10950000
109700              PERFORM C190-TNDR-ID-CONVERSION                     10960000
109800              IF SV007-CARD-NBR = SV022-CRD-NBR                   10970000
109900                 SET PS-FOUND-PTNDR-TRANS  TO TRUE                10980000
110000                 PERFORM D100-MATCH-PROCESS                       10990000
110100              END-IF                                              11000000
110200         WHEN SQLCODE = +100                                      11010000
110300             SET PS-END-OF-PTNDR-CSR   TO TRUE                    11020000
110400             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         11030000
110500                 SET SV019-MISSING-POS-TRANS TO TRUE              11040000
110600                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   11050000
110700                 PERFORM Z300-WRITE-AUDIT-RECORD                  11060000
110800             ELSE                                                 11070000
110900                 SET PS-NOT-FOUND-GVOID-TRANS  TO TRUE            11080000
111000                 SET PS-NOT-END-OF-GVOID-CSR   TO TRUE            11090000
111100                 PERFORM B170-OPEN-GVOID-CSR                      11100000
111200                 PERFORM C170-FETCH-GVOID-CSR                     11110000
111300                   UNTIL PS-FOUND-GVOID-TRANS                     11120000
111400                      OR PS-END-OF-GVOID-CSR                      11130000
111500                 PERFORM B570-CLOSE-GVOID-CSR                     11140000
111600             END-IF                                               11150000
111700         WHEN OTHER                                               11160000
111800             MOVE 'C120-FETCH-PTNDR-CSR     '                     11170000
111900                               TO PV-PARAGRAPH-NAME               11180000
112000             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                11190000
112100                               TO PV-DB2-OPERATION-ATTEMPTED      11200000
112200             PERFORM Z900-SQL-ABEND                               11210000
112300     END-EVALUATE.                                                11220000
112400                                                                  11230000
112500******************************************************************11240000
112600*     C140-FETCH-GISSU-CSR.                                      *11250000
112700* ==> PROCESSES:                                                 *11260000
112800*     - CHECK TO SEE IF THE GIFT CARD ISSUE TRANSACTION IS FOUND *11270000
112900*       ON THE TEPITM TABLE.                                     *11280000
113000* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD.                  *11290000
113100******************************************************************11300000
113200 C140-FETCH-GISSU-CSR.                                            11310000
113300                                                                  11320000
113400     EXEC SQL                                                     11330000
113500          FETCH GISSU-CSR                                         11340000
113600          INTO                                                    11350000
113700                :EPITM-MDSE-ID                                    11360000
113800     END-EXEC.                                                    11370000
113900                                                                  11380000
114000     EVALUATE TRUE                                                11390000
114100         WHEN SQLCODE = ZERO                                      11400000
114200              MOVE EPITM-MDSE-ID TO SV007-CARD-NUMBER-IN          11410000
114300              MOVE 0             TO SV007-CARD-NUMBER-LENGTH      11420000
114400              PERFORM SV007-FORMAT-CARD                           11430000
114500              IF SV007-CARD-NBR = SV022-CRD-NBR                   11440000
114600                 SET PS-FOUND-GISSU-TRANS  TO TRUE                11450000
114700                 PERFORM D100-MATCH-PROCESS                       11460000
114800              END-IF                                              11470000
114900         WHEN SQLCODE = +100                                      11480000
115000             SET PS-END-OF-GISSU-CSR   TO TRUE                    11490000
115100             IF SV022-TRN-VOID-IND = SV004-NOT-VOID-TRANS         11500000
115200                 SET SV019-MISSING-POS-TRANS TO TRUE              11510000
115300                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   11520000
115400                 PERFORM Z300-WRITE-AUDIT-RECORD                  11530000
115500             ELSE                                                 11540000
115600                 SET PS-NOT-FOUND-VISSU-TRANS  TO TRUE            11550000
115700                 SET PS-NOT-END-OF-VISSU-CSR   TO TRUE            11560000
115800                 PERFORM B180-OPEN-VISSU-CSR                      11570000
115900                 PERFORM C180-FETCH-VISSU-CSR                     11580000
116000                   UNTIL PS-FOUND-VISSU-TRANS                     11590000
116100                      OR PS-END-OF-VISSU-CSR                      11600000
116200                 PERFORM B580-CLOSE-VISSU-CSR                     11610000
116300             END-IF                                               11620000
116400         WHEN OTHER                                               11630000
116500             MOVE 'C140-FETCH-GISSU-CSR'                          11640000
116600                               TO PV-PARAGRAPH-NAME               11650000
116700             MOVE 'READ TEPPART/TEPTRN 4 VOID TRN'                11660000
116800                               TO PV-DB2-OPERATION-ATTEMPTED      11670000
116900             PERFORM Z900-SQL-ABEND                               11680000
117000     END-EVALUATE.                                                11690000
117100                                                                  11700000
117200******************************************************************11710000
117300*     C170-FETCH-GVOID-CSR                                       *11720000
117400* ==> PROCESSES:                                                 *11730000
117500*     - CHECK THE COSA TENDER TABLE TO SEE IF THERE IS A VOID    *11740000
117600*       FOR THE CARD AND TRANSACTION.                            *11750000
117700* ==> PERFORMED FROM:  C120-CHECK-FOR-GFT-CRD-TENDER.            *11760000
117800******************************************************************11770000
117900 C170-FETCH-GVOID-CSR.                                            11780000
118000                                                                  11790000
118100     EXEC SQL                                                     11800000
118200          FETCH GVOID-CSR                                         11810000
118300          INTO                                                    11820000
118400                :EPTND-TNDR-ID                                    11830000
118500               ,:EPTND-TNDR-ID-LEN-NBR                            11840000
118600     END-EXEC.                                                    11850000
118700                                                                  11860000
118800     EVALUATE TRUE                                                11870000
118900         WHEN SQLCODE = ZERO                                      11880000
119000              PERFORM C190-TNDR-ID-CONVERSION                     11890000
119100              IF SV007-CARD-NBR = SV022-CRD-NBR                   11900000
119200                 SET PS-FOUND-GVOID-TRANS  TO TRUE                11910000
119300                 PERFORM D100-MATCH-PROCESS                       11920000
119400              END-IF                                              11930000
119500         WHEN SQLCODE = +100                                      11940000
119600             SET PS-END-OF-GVOID-CSR   TO TRUE                    11950000
119700             SET SV019-MISSING-POS-VOID TO TRUE                   11960000
119800             PERFORM Z200-MOVE-KMC-TO-AUDIT                       11970000
119900             PERFORM Z300-WRITE-AUDIT-RECORD                      11980000
120000         WHEN OTHER                                               11990000
120100             MOVE 'C170-FETCH-GVOID-CSROID       '                12000000
120200                               TO PV-PARAGRAPH-NAME               12010000
120300             MOVE 'SELECT JOINED TEPPART/TEPTND'                  12020000
120400                               TO PV-DB2-OPERATION-ATTEMPTED      12030000
120500             PERFORM Z900-SQL-ABEND                               12040000
120600     END-EVALUATE.                                                12050000
120700                                                                  12060000
120800******************************************************************12070000
120900*     C180-FETCH-VISSU-CSR.                                      *12080000
121000* ==> PROCESSES:                                                 *12090000
121100*     - CHECK IF THE GIFT CARD EXISTS ON THE TRANSACTION WITH A  *12100000
121200*       AMOUNT OF ZERO.                                          *12110000
121300* ==> PERFORMED FROM:  C140-CHECK-FOR-GIFT-CARD.                 *12120000
121400******************************************************************12130000
121500 C180-FETCH-VISSU-CSR.                                            12140000
121600                                                                  12150000
121700     EXEC SQL                                                     12160000
121800          FETCH VISSU-CSR                                         12170000
121900          INTO                                                    12180000
122000                :EPITM-MDSE-ID                                    12190000
122100     END-EXEC.                                                    12200000
122200                                                                  12210000
122300     EVALUATE TRUE                                                12220000
122400         WHEN SQLCODE = ZERO                                      12230000
122500              MOVE EPITM-MDSE-ID TO SV007-CARD-NUMBER-IN          12240000
122600              MOVE 0             TO SV007-CARD-NUMBER-LENGTH      12250000
122700              PERFORM SV007-FORMAT-CARD                           12260000
122800              IF SV007-CARD-NBR = SV022-CRD-NBR                   12270000
122900                 SET PS-FOUND-VISSU-TRANS  TO TRUE                12280000
123000                 PERFORM D100-MATCH-PROCESS                       12290000
123100              END-IF                                              12300000
123200         WHEN SQLCODE = +100                                      12310000
123300                 SET PS-END-OF-VISSU-CSR   TO TRUE                12320000
123400                 SET SV019-MISSING-POS-VOID  TO TRUE              12330000
123500                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   12340000
123600                 PERFORM Z300-WRITE-AUDIT-RECORD                  12350000
123700         WHEN OTHER                                               12360000
123800             MOVE 'C180-FETCH-VISSU-CSR'                          12370000
123900                               TO PV-PARAGRAPH-NAME               12380000
124000             MOVE 'SELECT JOINED TEPPARTN/TEPITM'                 12390000
124100                               TO PV-DB2-OPERATION-ATTEMPTED      12400000
124200             PERFORM Z900-SQL-ABEND                               12410000
124300     END-EVALUATE.                                                12420000
124400                                                                  12430000
124500******************************************************************12440000
124600* EXTRACT TENDER ID FOR CARD NUMBER CONVERSION                   *12450000
124700******************************************************************12460000
124800 C190-TNDR-ID-CONVERSION.                                         12470000
124900                                                                  12480000
125000     IF EPTND-TNDR-ID-LEN-NBR = 16                                12490000
125100         MOVE EPTND-TNDR-ID(2:15) TO SV007-CARD-NUMBER-IN         12500000
125200     ELSE                                                         12510000
125300         MOVE EPTND-TNDR-ID(1:EPTND-TNDR-ID-LEN-NBR)              12520000
125400                                  TO SV007-CARD-NUMBER-IN         12530000
125500     END-IF.                                                      12540000
125600                                                                  12550000
125700     MOVE EPTND-TNDR-ID-LEN-NBR TO SV007-CARD-NUMBER-LENGTH.      12560000
125800                                                                  12570000
125900     PERFORM SV007-FORMAT-CARD.                                   12580000
126000                                                                  12590000
126100******************************************************************12600000
126200*     C200-CALCULATE-CUTOFF-DATE                                 *12610000
126300* ==> PROCESSES:                                                 *12620000
126400*     - SUBTRACTS PC-NUMBER-DAYS-TO-CHECK FROM THE POINT OF SALE *12630000
126500*       DATE TO GET THE CUTOFF DATE                              *12640000
126600* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *12650000
126700******************************************************************12660000
126800 C200-CALCULATE-CUTOFF-DATE.                                      12670000
126900                                                                  12680000
127000     INITIALIZE DPG51 DPG52 DPG53                                 12690000
127100                DPG54 DPG55 DPG56.                                12700000
127200                                                                  12710000
127300     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     12720000
127400     SET DPG51-DECREMENT-DATE        TO TRUE.                     12730000
127500     MOVE PC-NUMBER-DAYS-TO-CHECK    TO DPG51-INCR-DECR-DAYS-9.   12740000
127600                                                                  12750000
127700     MOVE SV021-POS-DTE              TO DPG52-LK-DATE-INPUT.      12760000
127800     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     12770000
127900                                                                  12780000
128000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          12790000
128100                                             DPG53 DPG54          12800000
128200                                             DPG55 DPG56          12810000
128300                                                                  12820000
128400     EVALUATE TRUE                                                12830000
128500         WHEN DPG54-SEVERE-ERROR                                  12840000
128600         WHEN DPG54-DATE-INVALID                                  12850000
128700             DISPLAY ' '                                          12860000
128800             DISPLAY '** ABEND     **'                            12870000
128900             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        12880000
129000             DISPLAY '** PARAGRAPH **  = C200-CALCULATE-CUTOFF'   12890000
129100             DISPLAY '** BAD CALL TO CALENDAR MODULE '            12900000
129200                 DP500-KOHLS-CALENDAR-ROUTINE                     12910000
129300             DISPLAY DPG54-ERROR-MESSAGE                          12920000
129400             DISPLAY ' '                                          12930000
129500             MOVE +4019 TO ABEND-CODE                             12940000
129600             CALL WS-ABEND-ROUTINE USING ABEND-CODE               12950000
129700     END-EVALUATE.                                                12960000
129800                                                                  12970000
129900     MOVE DPG55-DB2-ISO-DATE-FMT  TO PV-POS-CUTOFF-DATE.          12980000
130000                                                                  12990000
130100******************************************************************13000000
130200*     C300-LOOK-FOR-MISSING-TRANS                                *13010000
130300* ==> PROCESSES:                                                 *13020000
130400*     - DOES AN INQUIRY AGAINST THE KMC ACTIVITY TABLE           *13030000
130500*     -  (SVT_KOHLS_CRD_TXN) *                                    13040000
130600*       WITH THE INFORMATION FROM THE POS EXTRACT FILE.  THE     *13050000
130700*       TRANSACTION WAS MISSING FROM THE SVT00002 EXTRACT.       *13060000
130800*     - **** NOTE:  REVERSAL CODE SHOULD BE ADDED TO THE WHERE   *13070000
130900*                   CLAUSE WHEN THE POS EXTRACT IS CHANGED TO    *13080000
131000*                   PASS THIS VALUE.                             *13090000
131100* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *13100000
131200******************************************************************13110000
131300 C300-LOOK-FOR-MISSING-TRANS.                                     13120000
P12431     MOVE +0       TO PV-ORD-NBR-NULL-IND.                        13121027
P12431     MOVE SPACES   TO SVT00002-ORD-NBR-TEXT.                      13122027
131400                                                                  13130000
131500     EXEC SQL                                                     13140000
131600         SELECT  POS_DTE                                          13150000
131700                ,DRV_LIC_NBR                                      13160000
131800                ,TRN_RVRSL_CDE                                    13170000
131900                ,TRN_VOID_IND                                     13180000
132000                ,ACTVY_STAT_CDE                                   13190000
132100                ,POS_OPRT_ID                                      13200000
P12431                ,ORD_NBR                                          13201027
132200                ,APVL_USR_ID                                      13210000
132300                ,TRN_AUTH_TMST                                    13220000
132400           INTO  :SVT00002-POS-DTE                                13230000
132500                ,:SVT00002-DRV-LIC-NBR                            13240000
132600                ,:SVT00002-TRN-RVRSL-CDE                          13250000
132700                ,:SVT00002-TRN-VOID-IND                           13260000
132800                ,:SVT00002-ACTVY-STAT-CDE                         13270000
132900                ,:SVT00002-POS-OPRT-ID                            13280000
P12431                ,:SVT00002-ORD-NBR :PV-ORD-NBR-NULL-IND           13281027
133000                ,:SVT00002-APVL-USR-ID                            13290000
133100                ,:SVT00002-TRN-AUTH-TMST                          13300000
133200           FROM  SVT_KOHLS_CRD_TXN                                13310000
133300          WHERE  CRD_NBR      = :SV021-CRD-NBR                    13320000
133400            AND POS_DTE       = :PV-POS-DATE                      13330000
133500            AND ACTVY_TYP_CDE = :SV021-ACTVY-TYP-CDE              13340000
133600            AND STR_NBR       = :SV021-STR-NBR                    13350000
133700            AND POS_TRMNL_NBR = :SV021-TRMNL-NBR                  13360000
133800            AND POS_TRN_NBR   = :SV021-TRN-NBR                    13370000
133900            AND APP_AUTH_AMT  = :SV021-APP-AUTH-AMT               13380000
134000            AND ORIG_AUTH_AMT = :SV021-ORIG-AUTH-AMT              13390000
134100            AND TRN_VOID_IND  = :SV021-TRN-VOID-IND               13400000
134200     END-EXEC.                                                    13410000
134300                                                                  13420000
134400     EVALUATE TRUE                                                13430000
134500         WHEN SQLCODE = 0                                         13440000
134600         WHEN SQLCODE = -811                                      13450000
134700             SET PS-MISSING-SVT00002-TRAN-FOUND TO TRUE           13460000
134800         WHEN SQLCODE = +100                                      13470000
134900             PERFORM D200-SUBTRACT-DAY-POS-DATE                   13480000
135000         WHEN OTHER                                               13490000
135100             MOVE 'C300-LOOK-FOR-MISSING-TRANS   '                13500000
135200                               TO PV-PARAGRAPH-NAME               13510000
135300             MOVE 'SELECT ON SVT_KOHLS_CRD_TXN             '      13520000
135400                               TO PV-DB2-OPERATION-ATTEMPTED      13530000
135500             PERFORM Z900-SQL-ABEND                               13540000
135600     END-EVALUATE.                                                13550000
135700                                                                  13560000
135800******************************************************************13570000
135900*     C400-FOUND-MATCH-PROCESS                                   *13580000
136000* ==> PROCESSES:                                                 *13590000
136100*     - MOVES THE CURRENT RD015 (THE SVT00002) EXTRACT RECORD TO *13600000
136200*       A HOLD RECORD                                            *13610000
136300*     - INITIALIZES THE RD015 RECORD AND THEN MOVES THE DATA FOR *13620000
136400*       THE SVT00002 RECORD THAT WAS FOUND ON THE TABLE TO THE   *13630000
136500*       RD015 RECORD.  THIS IS DONE SO THAT THE EXISTING LOGIC   *13640000
136600*       COULD BE USED TO PROCESS THE MATCH.                      *13650000
136700*     - WHEN THE MATCH PROCESSING IS DONE THE RD015 RECORD IS    *13660000
136800*       INITIALIZED AND THE ORIGINAL RD015 INFORMATION IS MOVED  *13670000
136900*       BACK FROM THE HOLD RECORD.                               *13680000
137000* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *13690000
137100******************************************************************13700000
137200 C400-FOUND-MATCH-PROCESS.                                        13710000
137300                                                                  13720000
137400     INITIALIZE PV-HOLD-SV022-RECORD.                             13730000
137500     MOVE SV022-KMCACT-EXTRACT-RECORD TO PV-HOLD-SV022-RECORD.    13740000
137600     INITIALIZE SV022-KMCACT-EXTRACT-RECORD.                      13750000
137700                                                                  13760000
137800     MOVE SV021-CRD-TYP-CDE     TO SV022-CRD-TYP-CDE.             13770000
137900     MOVE SV021-CRD-NBR         TO SV022-CRD-NBR.                 13780000
138000     MOVE SVT00002-POS-DTE      TO SV022-POS-DTE.                 13790000
138100     MOVE SV021-STR-NBR         TO SV022-STR-NBR.                 13800000
138200     MOVE SV021-TRMNL-NBR       TO SV022-TRMNL-NBR.               13810000
138300     MOVE SV021-TRN-NBR         TO SV022-TRN-NBR.                 13820000
138400     MOVE SV021-TRN-STAT-CDE    TO SV022-TRN-STAT-CDE.            13830000
138500     MOVE SV021-APP-AUTH-AMT    TO SV022-APP-AUTH-AMT.            13840000
138600     MOVE SV021-ORIG-AUTH-AMT   TO SV022-ORIG-AUTH-AMT.           13850000
138700     MOVE SVT00002-TRN-VOID-IND TO SV022-TRN-VOID-IND.            13860000
138800     MOVE SVT00002-TRN-RVRSL-CDE TO SV022-TRN-RVRSL-CDE.          13870000
P10237     IF SVT00002-DRV-LIC-NBR NOT = SPACES                         13881006
P10237        PERFORM C410-EBCDIC-ASCII                                 13882006
P10237        PERFORM C420-ENCRYPT-DL                                   13883008
P10237        PERFORM C430-BINARY-BASE64                                13884006
P10237        MOVE PV-OUTPUT-TEXT      TO SV022-DRV-LIC-NBR             13885010
P10237     ELSE                                                         13886006
P10237        MOVE SPACES              TO SV022-DRV-LIC-NBR             13887006
P10237     END-IF.                                                      13888006
139000     MOVE SVT00002-ACTVY-STAT-CDE TO SV022-ACTVY-STAT-CDE.        13890000
139100     MOVE SV021-ACTVY-TYP-CDE   TO SV022-ACTVY-TYP-CDE.           13900000
139200     MOVE SVT00002-POS-OPRT-ID  TO SV022-POS-OPER-ID.             13910000
P12431     IF PV-ORD-NBR-NULL-IND < +0                                  13911027
P12431        MOVE SPACES                TO SV022-ORD-NBR               13912027
P12431     ELSE                                                         13913027
P12431        MOVE SVT00002-ORD-NBR-TEXT TO SV022-ORD-NBR               13914027
P12431     END-IF.                                                      13920027
139300     MOVE SVT00002-APVL-USR-ID   TO SV022-APPR-USER-ID.           13921025
139400     MOVE SVT00002-TRN-AUTH-TMST TO SV022-TRN-AUTH-TMST.          13930000
139500                                                                  13940000
139600     EXEC SQL                                                     13950000
139700         SELECT  SUM(APP_AUTH_AMT)                                13960000
139800           INTO  :PV-CARD-BALANCE                                 13970000
139900           FROM  SVT_KOHLS_CRD_TXN                                13980000
140000          WHERE  CRD_NBR = :SV021-CRD-NBR                         13990000
140100     END-EXEC.                                                    14000000
140200                                                                  14010000
140300     EVALUATE TRUE                                                14020000
140400         WHEN SQLCODE = +0                                        14030000
140500             IF PV-CARD-BALANCE NEGATIVE                          14040000
140600                 SET SV022-OVERTENDERED TO TRUE                   14050000
140700             ELSE                                                 14060000
140800                 SET SV022-NOT-OVER     TO TRUE                   14070000
140900             END-IF                                               14080000
141000         WHEN OTHER                                               14090000
141100             MOVE 'C400-FOUND-MATCH-PROCESS      '                14100000
141200                               TO PV-PARAGRAPH-NAME               14110000
141300             MOVE 'SUMMATION OF APPROVED AUTH AMT'                14120000
141400                               TO PV-DB2-OPERATION-ATTEMPTED      14130000
141500             PERFORM Z900-SQL-ABEND                               14140000
141600     END-EVALUATE.                                                14150000
141700                                                                  14160000
141800     PERFORM D100-MATCH-PROCESS.                                  14170000
141900                                                                  14180000
142000     INITIALIZE SV022-KMCACT-EXTRACT-RECORD.                      14190000
142100     MOVE PV-HOLD-SV022-RECORD TO SV022-KMCACT-EXTRACT-RECORD.    14200000
142200                                                                  14210000
P10237******************************************************************14211006
P10237*     C410-EBCDIC-ASCII                                          *14212006
P10237* ==> PROCESSES:                                                 *14213006
P10237*     - CONVERTS THE DATA FROM EBCDIC TO ASCII FORMAT            *14214006
P10237* ==> PERFORMED FROM: C400-FOUND-MATCH-PROCESS                   *14215006
P10237******************************************************************14216006
P10237 C410-EBCDIC-ASCII.                                               14217006
P10237     INITIALIZE LK52-DPKUT052-SUBRTN-WORK-AREA                    14218010
P10237                PV-ASCII                                          14219010
P10237                PV-DL-LENGTH.                                     14219110
P10237                                                                  14219210
P10237     INSPECT FUNCTION REVERSE(SVT00002-DRV-LIC-NBR)               14219515
P10237          TALLYING PV-DL-LENGTH FOR LEADING SPACES.               14219615
P10237     COMPUTE PV-DL-LENGTH = 21 - PV-DL-LENGTH.                    14219715
P10237     SET  EBCDIC-TO-ASCII       TO TRUE.                          14219810
P10237     MOVE SVT00002-DRV-LIC-NBR  TO LK52-FROM-AREA.                14219910
P10237     MOVE PV-DL-LENGTH          TO LK52-LENGTH.                   14220010
P10237                                                                  14220110
P10237     CALL PC-DPKUT052       USING LK52-CONVERSION-TYPE            14220217
P10237                                  LK52-LENGTH                     14220310
P10237                                  LK52-FROM-AREA                  14220410
P10237                                  LK52-TO-AREA                    14220510
P10237                                  LK52-RETURN-CODE.               14220610
P10237     IF GOOD-LK52-RET-CODE                                        14220710
P10237        MOVE LK52-TO-AREA       TO PV-ASCII                       14220811
P10237     ELSE                                                         14220906
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO ASCII'             14221117
P10237        DISPLAY 'RETURN CODE     - ' LK52-RETURN-CODE             14221219
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       14221317
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             14221417
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         14221517
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 14221617
P10237        MOVE +4008 TO ABEND-CODE                                  14221717
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          14221821
P10237     END-IF.                                                      14221917
P10237                                                                  14222017
P10237******************************************************************14222117
P10237*     C420-ENCRYPT-DL                                            *14222217
P10237* ==> PROCESSES:                                                 *14222317
P10237*     - CALLS THE PROTEGRITY MODULE TO ENCRYPT THE DL#           *14222417
P10237*     - RETURNED DL# WILL BE IN BINARY FORMAT                    *14222517
P10237* ==> PERFORMED FROM: C400-FOUND-MATCH-PROCESS                   *14222617
P10237******************************************************************14222717
P10237 C420-ENCRYPT-DL.                                                 14222817
P10237     INITIALIZE CSI-PARAMETERS                                    14222917
P10237                DP031-PROTEG-PGM-PARAMETERS.                      14223017
P10237     MOVE 'DRIVER-LICENSE'        TO DP031-FIELD.                 14223117
P10237     SET CSI-ENCRYPT-FUNCTION     TO TRUE.                        14223217
P10237     SET DP031-IDNBR              TO TRUE.                        14223317
P10237     MOVE LK52-LENGTH             TO CSI-CLEAR-TEXT-LENGTH.       14223417
P10237     MOVE 34                      TO CSI-CIPHER-TEXT-LENGTH.      14223517
P10237     MOVE PV-ASCII                TO DP031-CLEAR-TEXT.            14223617
P10237     PERFORM DP031-1000-PROTG-ENCRYP-DECRYP.                      14223717
P10237     IF CSI-RETURN-CODE NOT = ZERO                                14223817
P10237        DISPLAY 'ABEND IN THE FOLLOWING RECORD'                   14223917
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       14224017
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             14224117
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         14224217
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 14224317
P10237        PERFORM DP031-9999-ABEND                                  14224417
P10237     END-IF.                                                      14224517
P10237                                                                  14224617
P10237******************************************************************14224717
P10237*     C430-BINARY-BASE64                                         *14224817
P10237* ==> PROCESSES:                                                 *14224917
P10237*     - CONVERTS THE DATA FROM BINARY TO BASE64 FORMAT           *14225017
P10237* ==> PERFORMED FROM:  C400-FOUND-MATCH-PROCESS                  *14225117
P10237******************************************************************14225217
P10237 C430-BINARY-BASE64.                                              14225317
P10237     INITIALIZE PV-INPUT-TEXT                                     14225417
P10237                PV-OUTPUT-TEXT.                                   14225517
P10237     MOVE DP031-CIPHER-TEXT      TO PV-INPUT-TEXT.                14225617
P10237     MOVE CSI-CIPHER-TEXT-LENGTH TO DP022-INLEN.                  14225717
P10237     MOVE 48                     TO DP022-OUTLEN-IN.              14225817
P10237     CALL  DP022-MGCXB2R  USING DP022-PARMS,                      14225917
P10237                                PV-INPUT-TEXT,                    14226017
P10237                                PV-OUTPUT-TEXT.                   14226117
P10237     IF RETURN-CODE NOT EQUAL 0                                   14226217
P10237        DISPLAY 'ERROR WHILE CONVERTING DL# TO BASE64'            14226417
P10237        DISPLAY 'RETURN CODE     - ' RETURN-CODE                  14226519
P10237        DISPLAY 'TRN-AUTH-TMST   - ' SVT00002-TRN-AUTH-TMST       14226617
P10237        DISPLAY 'POS-DATE        - ' SVT00002-POS-DTE             14226717
P10237        DISPLAY 'POS-OPRT-ID     - ' SVT00002-POS-OPRT-ID         14226817
P10237        DISPLAY 'INPUT DL LENGTH - ' PV-DL-LENGTH                 14226917
P10237        MOVE +4008 TO ABEND-CODE                                  14227018
P10237        CALL 'ILBOABN0' USING ABEND-CODE                          14227121
P10237     END-IF.                                                      14227217
P10237                                                                  14227317
142300******************************************************************14228017
142400*     C500-MISSING-SVT00002-RECORD                               *14230000
142500* ==> PROCESSES:                                                 *14240000
142600*     - IF THE POS RECORD IS A VOID AN INSERT RECORD IS WRITTEN  *14250000
142700*       TO THE UPDATE FILE AND A RECORD IS WRITTEN TO THE AUDIT  *14260000
142800*       FILE (ONLY IF THERE IS NOT A TENDER RECORD ASSOCIATED    *14270000
142900*       WITH THE CARD).  IF THE CARD IS NOT FOUND ON THE         *14280000
143000*       SVT_KOHLS_CRD_ACCT,                                       14290000
143100*       AN INSERT RECORD IS NOT WRITTEN.  IT IS FLAGGED ON THE   *14300000
143200*       AUDIT REPORT AS AN UNKNOWN CARD ID.                      *14310000
143300*     - IF THE POS RECORD IS A NORMAL TRANSACTION A RECORD IS    *14320000
143400*       WRITTEN TO THE AUDIT FILE.                               *14330000
143500* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *14340000
143600*                      B300-PROCESS-REST-POS-FILE                *14350000
143700******************************************************************14360000
143800 C500-MISSING-SVT00002-RECORD.                                    14370000
143900                                                                  14380000
144000     IF SV021-TRN-VOID                                            14390000
144100                                                                  14400000
144200         IF (SV021-ACTVY-TYP-CDE = SV004-ISSUE-KMRC-ACT-TYP       14410000
144300         OR  SV021-ACTVY-TYP-CDE = SV004-ISSUE-GIFT-CRD-ACT-TYP)  14420000
144400             PERFORM D300-CHECK-FOR-TENDER                        14430000
144500         ELSE                                                     14440000
144600             PERFORM D400-CHECK-CARD-ON-SVT-ACCT                  14450000
144700         END-IF                                                   14460000
144800                                                                  14470000
144900     ELSE                                                         14480000
145000         SET SV019-MISSING-KMC-TRANS      TO TRUE                 14490000
145100     END-IF.                                                      14500000
145200                                                                  14510000
145300     PERFORM Z100-MOVE-POS-TO-AUDIT.                              14520000
145400     PERFORM Z300-WRITE-AUDIT-RECORD.                             14530000
145500                                                                  14540000
145600******************************************************************14550000
145700*     C600-CHECK-FOR-ORIG-POS-VOID                               *14560000
145800* ==> PROCESSES:                                                 *14570000
145900*     - THIS CHECK IS NEEDED BECAUSE THE VOID INDICATOR IS NOT   *14580000
146000*       CHANGED ON THE ORIGINAL TRANSACTION ON THE POS EXTRACT   *14590000
146100*       RECORD, BUT IT IS ON THE                                 *14600000
146200*       SVT_KOHLS_CRD_TXN TABLE AS DESCRIBED *                    14610000
146300*       BELOW                                                    *14620000
146400*     - THERE ARE TWO PARTS TO A VOID ON THE                     *14630000
146500*     - SVT_KOHLS_CRD_TXN TABLE: *                                14640000
146600*       1)  THE ORIGINAL TRANSACTION HAS THE VOID INDICATOR SET  *14650000
146700*           TO A Y, BUT THE REVERSAL CODE REMAINS A ZERO.        *14660000
146800*       1)  THE REVERSING TRANSACTION FOR THE VOID, HAS THE VOID *14670000
146900*           INDICATOR SET TO A Y, THE REVERSAL CODE IS A 1, AND  *14680000
147000*           THE AMOUNTS ARE OPPOSITE THE AMOUNTS ON THE ORIGINAL *14690000
147100*           TRANSACTION.                                         *14700000
147200* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *14710000
147300******************************************************************14720000
147400 C600-CHECK-FOR-ORIG-POS-VOID.                                    14730000
147500                                                                  14740000
147600     IF SV022-TRN-VOID-IND = SV004-VOID-TRANS AND                 14750000
147700        SV022-TRN-RVRSL-CDE = SV004-REV-CDE-NORMAL AND            14760000
147800        SV021-TRN-VOID-IND = SV004-NOT-VOID-TRANS                 14770000
147900         PERFORM D100-MATCH-PROCESS                               14780000
148000         PERFORM Y200-READ-POS-ACTIVITY                           14790000
148100         PERFORM Y100-READ-SVT00002-ACTIVITY                      14800000
148200     ELSE                                                         14810000
148300         PERFORM C100-MISSING-POS-RECORD                          14820000
148400         IF PS-KMC-REC-SAVED-NO                                   14830000
148500            PERFORM Y100-READ-SVT00002-ACTIVITY                   14840000
148600         ELSE                                                     14850000
148700            SET PS-KMC-REC-SAVED-NO TO TRUE                       14860000
148800         END-IF                                                   14870000
148900     END-IF.                                                      14880000
149000                                                                  14890000
149100                                                                  14900000
149200******************************************************************14910000
149300*     D100-MATCH-PROCESS                                         *14920000
149400* ==> PROCESSES:                                                 *14930000
149500*     - IF THE ACTIVITY STATUS WAS AUTHORIZED A RECORD IS WRITTEN*14940000
149600*       TO UPDATE THE STATUS TO BE VERIFIED.                     *14950000
149700*     - IF THE ACTIVITY STATUS WAS NOT AUTHORIZED OR IS ALREADY  *14960000
149800*       A VERIFIED AN AUDIT RECORD IS WRITTEN TO INDICATE THIS.  *14970000
149900* ==> PERFORMED FROM:  B200-COMPARE-SVT00002-FILES               *14980000
150000*                      C100-MISSING-POS-RECORD                   *14990000
150100*                      C400-FOUND-MATCH-PROCESS                  *15000000
150200******************************************************************15010000
150300 D100-MATCH-PROCESS.                                              15020000
150400                                                                  15030000
150500     IF PS-KMC-REC-SAVED-YES                                      15040000
150600         EVALUATE TRUE                                            15050000
150700           WHEN PV-SAVE-SV022-ACT-STA =                           15060000
150800                SV004-STAT-AUTH-RECEIVED-CD                       15070000
150900               PERFORM Z260-MOVE-SAVED-KMC-TO-POSTING             15080000
151000               PERFORM Z400-WRITE-UPDATE-RECORD                   15090000
151100               PERFORM E100-CHECK-OVERRIDDEN-DOLLAR               15100000
151200               PERFORM E200-CHECK-OVERTENDERED-BALNCE             15110000
151300           WHEN PV-SAVE-SV022-ACT-STA = SV004-STAT-NO-AUTH-CD     15120000
151400             IF PV-SAVE-SV022-APP-USR = SPACES                    15130000
151500                 SET SV019-VERIFIED-DUPLICATE TO TRUE             15140000
151600                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   15150000
151700                 PERFORM Z300-WRITE-AUDIT-RECORD                  15160000
151800             ELSE                                                 15170000
151900                 PERFORM Z260-MOVE-SAVED-KMC-TO-POSTING           15180000
152000                 PERFORM Z400-WRITE-UPDATE-RECORD                 15190000
152100                 PERFORM E100-CHECK-OVERRIDDEN-DOLLAR             15200000
152200                 PERFORM E200-CHECK-OVERTENDERED-BALNCE           15210000
152300             END-IF                                               15220000
152400                                                                  15230000
152500           WHEN PV-SAVE-SV022-ACT-STA = SV004-STAT-VERIFIED-CD    15240000
152600               SET SV019-VERIFIED-DUPLICATE TO TRUE               15250000
152700               PERFORM Z200-MOVE-KMC-TO-AUDIT                     15260000
152800               PERFORM Z300-WRITE-AUDIT-RECORD                    15270000
152900         END-EVALUATE                                             15280000
153000     END-IF.                                                      15290000
153100                                                                  15300000
153200     EVALUATE TRUE                                                15310000
153300         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-AUTH-RECEIVED-CD  15320000
153400             PERFORM Z250-MOVE-KMC-TO-POSTING                     15330000
153500             PERFORM Z400-WRITE-UPDATE-RECORD                     15340000
153600             PERFORM E100-CHECK-OVERRIDDEN-DOLLAR                 15350000
153700             PERFORM E200-CHECK-OVERTENDERED-BALNCE               15360000
153800         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-NO-AUTH-CD        15370000
153900             IF SV022-APPR-USER-ID = SPACES                       15380000
154000                 SET SV019-VERIFIED-DUPLICATE TO TRUE             15390000
154100                 PERFORM Z200-MOVE-KMC-TO-AUDIT                   15400000
154200                 PERFORM Z300-WRITE-AUDIT-RECORD                  15410000
154300             ELSE                                                 15420000
154400                 PERFORM Z250-MOVE-KMC-TO-POSTING                 15430000
154500                 PERFORM Z400-WRITE-UPDATE-RECORD                 15440000
154600                 PERFORM E100-CHECK-OVERRIDDEN-DOLLAR             15450000
154700                 PERFORM E200-CHECK-OVERTENDERED-BALNCE           15460000
154800             END-IF                                               15470000
154900                                                                  15480000
155000         WHEN SV022-ACTVY-STAT-CDE = SV004-STAT-VERIFIED-CD       15490000
155100             SET SV019-VERIFIED-DUPLICATE TO TRUE                 15500000
155200             PERFORM Z200-MOVE-KMC-TO-AUDIT                       15510000
155300             PERFORM Z300-WRITE-AUDIT-RECORD                      15520000
155400     END-EVALUATE.                                                15530000
155500                                                                  15540000
155600******************************************************************15550000
155700*     D200-SUBTRACT-DAY-POS-DATE                                 *15560000
155800* ==> PROCESSES:                                                 *15570000
155900*     - SUBTRACTS A DAYS FROM THE VARIABLE PV-POS-DATE.          *15580000
156000* ==> PERFORMED FROM:  C300-LOOK-FOR-MISSING-TRANS               *15590000
156100******************************************************************15600000
156200 D200-SUBTRACT-DAY-POS-DATE.                                      15610000
156300                                                                  15620000
156400     INITIALIZE DPG51 DPG52 DPG53                                 15630000
156500                DPG54 DPG55 DPG56.                                15640000
156600                                                                  15650000
156700     SET DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                     15660000
156800     SET DPG51-DECREMENT-DATE        TO TRUE.                     15670000
156900     MOVE PC-ONE                     TO DPG51-INCR-DECR-DAYS-9.   15680000
157000                                                                  15690000
157100     MOVE PV-POS-DATE                TO DPG52-LK-DATE-INPUT.      15700000
157200     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     15710000
157300                                                                  15720000
157400     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52          15730000
157500                                             DPG53 DPG54          15740000
157600                                             DPG55 DPG56.         15750000
157700                                                                  15760000
157800     EVALUATE TRUE                                                15770000
157900         WHEN DPG54-SEVERE-ERROR                                  15780000
158000         WHEN DPG54-DATE-INVALID                                  15790000
158100             DISPLAY ' '                                          15800000
158200             DISPLAY '** ABEND     **'                            15810000
158300             DISPLAY '** PROGRAM   **  = ' PC-PROGRAM-NAME        15820000
158400             DISPLAY '** PARAGRAPH **  = D200-SUBTRACT-DAY-POS'   15830000
158500             DISPLAY '** BAD CALL TO CALENDAR MODULE '            15840000
158600                 DP500-KOHLS-CALENDAR-ROUTINE                     15850000
158700             DISPLAY DPG54-ERROR-MESSAGE                          15860000
158800             DISPLAY ' '                                          15870000
158900             MOVE +4019 TO ABEND-CODE                             15880000
159000             CALL WS-ABEND-ROUTINE USING ABEND-CODE               15890000
159100     END-EVALUATE.                                                15900000
159200                                                                  15910000
159300     MOVE DPG55-DB2-ISO-DATE-FMT  TO PV-POS-DATE.                 15920000
159400                                                                  15930000
159500******************************************************************15940000
159600*     D300-CHECK-FOR-TENDER                                      *15950000
159700* ==> PROCESSES:                                                 *15960000
159800*     - DOES A SELECT ON THE                                     *15970000
159900*     - SVT_KOHLS_CRD_TXN TABLE TO SEE IF A TENDER *              15980000
160000*       EXISTS FOR A SPECIFIC CARD                               *15990000
160100*     - IF A TENDER EXISTS FOR THE CARD, AN UPDATE/INSERT RECORD *16000000
160200*       IS NOT WRITTEN FOR PROGRAM SVKUP014, BUT AN AUDIT RECORD *16010000
160300*       IS WRITTEN INDICATING THAT LP SHOULD INVESTIGATE         *16020000
160400*     - IF A TENDER DOES NOT EXIST OR THE TENDERS HAVE ALL BEEN  *16030000
160500*       VOIDED, AND THE CARD ID IS FOUND ON THE                  *16040000
160600*       SVT_KOHLS_CRD_ACCT,                                       16050000
160700*       AN UPDATE/INSERT RECORD IS WRITTEN FOR SVKUP014          *16060000
160800*       AND AN AUDIT RECORD IS WRITTEN STATING THAT THERE WAS    *16070000
160900*       A MISSING KMRC VOID.                                     *16080000
161000*     - IF THE CARD ID IS NOT FOUND ON THE TKMCTBL,              *16090000
161100*       SVT_KOHLS_CRD_ACCT, AN AUDIT                              16100000
161200*       RECORD IS WRITTEN STATING THAT THERE IS AN UNKNOWN CARD  *16110000
161300*       ID.                                                      *16120000
161400* ==> PERFORMED FROM:  C500-MISSING-SVT00002-RECORD              *16130000
161500******************************************************************16140000
161600 D300-CHECK-FOR-TENDER.                                           16150000
161700                                                                  16160000
161800     MOVE SV004-TENDER-ACT-TYP  TO PV-TENDER-ACT-TYP.             16170000
161900                                                                  16180000
162000     EXEC SQL                                                     16190000
162100         SELECT  '1'                                              16200000
162200           INTO  :PV-SELECT                                       16210000
162300           FROM  SVT_KOHLS_CRD_TXN                                16220000
162400          WHERE  CRD_NBR      = :SV021-CRD-NBR                    16230000
162500            AND ACTVY_TYP_CDE = :PV-TENDER-ACT-TYP                16240000
162600            AND TRN_VOID_IND  = :SV004-NOT-VOID-TRANS             16250000
162700     END-EXEC.                                                    16260000
162800                                                                  16270000
162900     EVALUATE TRUE                                                16280000
163000         WHEN SQLCODE = 0                                         16290000
163100             SET SV019-MISSING-KMC-VOID-W-TNDR TO TRUE            16300000
163200                                                                  16310000
163300         WHEN SQLCODE = -811                                      16320000
163400             SET SV019-MISSING-KMC-VOID-W-TNDR TO TRUE            16330000
163500                                                                  16340000
163600         WHEN SQLCODE = +100                                      16350000
163700             PERFORM D400-CHECK-CARD-ON-SVT-ACCT                  16360000
163800                                                                  16370000
163900         WHEN OTHER                                               16380000
164000             MOVE 'D300-CHECK-FOR-TENDER         '                16390000
164100                               TO PV-PARAGRAPH-NAME               16400000
164200             MOVE 'SELECT ON SVT_KOHLS_CRD_TXN             '      16410000
164300                               TO PV-DB2-OPERATION-ATTEMPTED      16420000
164400             PERFORM Z900-SQL-ABEND                               16430000
164500                                                                  16440000
164600     END-EVALUATE.                                                16450000
164700                                                                  16460000
164800******************************************************************16470000
164900*     D400-CHECK-CARD-ON-SVT-ACCT                      *          16480000
165000* ==> PROCESSES:                                                 *16490000
165100*     - VERIFY THE CARD ID THAT IS NOT FOUND ON THE              *16500000
165200*     - SVT_KOHLS_CRD_TXN IS *                                    16510000
165300*       ON THE SVT_KOHLS_CRD_ACCT.                               *16520000
165400*     - IF THE CARD ID IS NOT ON THE TKMCTBL,                     16530000
165500*       SVT_KOHLS_CRD_ACCT, IT IS AN UNKNOWN *                    16540000
165600*       CARD ID AND WILL BE FLAGGED THAT WAY ON THE AUDIT REPORT.*16550000
165700* ==> PERFORMED FROM:  C500-MISSING-SVT00002-RECORD              *16560000
165800*                      D300-CHECK-FOR-TENDER                     *16570000
165900******************************************************************16580000
166000 D400-CHECK-CARD-ON-SVT-ACCT.                                     16590000
166100                                                                  16600000
166200     EXEC SQL                                                     16610000
166300         SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP            16620000
166400     END-EXEC.                                                    16630000
166500                                                                  16640000
166600     EXEC SQL                                                     16650000
166700         SELECT  CRD_NBR                                          16660000
166800           INTO :SVT00002-CRD-NBR                                 16670000
166900           FROM  SVT_KOHLS_CRD_ACCT                               16680000
167000          WHERE  CRD_NBR = :SV021-CRD-NBR                         16690000
167100     END-EXEC.                                                    16700000
167200                                                                  16710000
167300     EVALUATE TRUE                                                16720000
167400         WHEN SQLCODE = 0                                         16730000
167500             SET SV019-MISSING-KMC-VOID TO TRUE                   16740000
167600             MOVE PC-INSERT-RECORD      TO SV018-RECORD-TYPE      16750000
167700             MOVE SV004-STAT-NO-AUTH-CD TO SV018-UPDATED-ACTIVITY 16760000
167800             MOVE SV021-CRD-TYP-CDE     TO SV018-CRD-TYP-CDE      16770000
167900             MOVE SV021-CRD-NBR         TO SV018-KMC-CRD-NBR      16780000
168000             MOVE SV021-POS-DTE         TO SV018-POS-DATE         16790000
168100             MOVE SV021-STR-NBR         TO SV018-STORE-NBR        16800000
168200             MOVE SV021-TRMNL-NBR       TO SV018-TERMINAL-NBR     16810000
168300             MOVE SV021-TRN-NBR         TO SV018-TRANSACTION-NBR  16820000
168400             MOVE SV021-APP-AUTH-AMT    TO SV018-APPROVED-TRAN-AMT16830000
168500             MOVE SV021-ORIG-AUTH-AMT   TO SV018-ORIGINAL-AUTH-AMT16840000
168600             MOVE SV021-TRN-STAT-CDE    TO SV018-TRN-STAT-CDE     16850000
168700             MOVE SV004-VOID-TRANS      TO SV018-TRANS-VOID-IND   16860000
168800             MOVE SV004-REV-CDE-REVERSAL TO SV018-REVERSAL-IND    16870000
168900             MOVE SV021-DRV-LIC-NBR     TO SV018-DRIVERS-LICENSE  16880000
169000             MOVE SV021-ACTVY-TYP-CDE   TO SV018-TRANS-TYPE       16890000
169100             MOVE SV021-POS-OPER-ID     TO SV018-POS-OPERATOR-ID  16900000
169200             MOVE SV021-APPR-USER-ID    TO SV018-APPROVAL-USER-ID 16910000
169300             MOVE PV-CURRENT-TIMESTAMP  TO SV018-TRN-AUTH-TMST    16920000
169400                                                                  16930000
169500             PERFORM Z400-WRITE-UPDATE-RECORD                     16940000
169600                                                                  16950000
169700         WHEN SQLCODE = +100                                      16960000
169800             SET SV019-UNKNOWN-CARD-ID  TO TRUE                   16970000
169900                                                                  16980000
170000         WHEN OTHER                                               16990000
170100             MOVE 'D400-CHECK-CARD-ON-SVT-ACCT    '               17000000
170200                               TO PV-PARAGRAPH-NAME               17010000
170300             MOVE 'SELECT ON SVT_KOHLS_CRD_ACCT             '     17020000
170400                               TO PV-DB2-OPERATION-ATTEMPTED      17030000
170500             PERFORM Z900-SQL-ABEND                               17040000
170600                                                                  17050000
170700     END-EVALUATE.                                                17060000
170800******************************************************************17070000
170900*     E100-CHECK-OVERRIDDEN-DOLLAR                               *17080000
171000* ==> PROCESSES:                                                 *17090000
171100*     - IF THE APPROVED AUTHORIZATION AMOUNT IS GREATER THAN THE *17100000
171200*       ORIGINAL AUTHORIZATION AMOUNT THE AMOUNT HAS BEEN        *17110000
171300*       OVERRIDDEN AND AN AUDIT RECORD IS WRITTEN.               *17120000
171400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD                   *17130000
171500*                      D100-MATCH-PROCESS                        *17140000
171600******************************************************************17150000
171700 E100-CHECK-OVERRIDDEN-DOLLAR.                                    17160000
171800                                                                  17170000
171900     IF SV022-APP-AUTH-AMT NOT = SV022-ORIG-AUTH-AMT              17180000
172000         SET SV019-AMOUNT-OVERRIDDEN TO TRUE                      17190000
172100         PERFORM Z200-MOVE-KMC-TO-AUDIT                           17200000
172200         PERFORM Z300-WRITE-AUDIT-RECORD                          17210000
172300     END-IF.                                                      17220000
172400                                                                  17230000
172500******************************************************************17240000
172600*     E200-CHECK-OVERTENDERED-BALNCE                             *17250000
172700* ==> PROCESSES:                                                 *17260000
172800*     - IF THE CARD BALANCE FOR THE DAY IS NEGATIVE AN AUDIT     *17270000
172900*       RECORD IS WRITTEN.  THE EXTRACT PROGRAM FOR TABLE        *17280000
173000*       SVT_KOHLS_CRD_TXN*                                        17290000
173100*       (RDKUT003) DOES A SUM ON THE CARD NUMBER AND THEN SETS   *17300000
173200*       A SWITCH INDICATING WHETHER THE BALANCE IS OVERTENDERED  *17310000
173300*       OR NOT.                                                  *17320000
173400* ==> PERFORMED FROM:  C100-MISSING-POS-RECORD                   *17330000
173500*                      D100-MATCH-PROCESS                        *17340000
173600******************************************************************17350000
173700 E200-CHECK-OVERTENDERED-BALNCE.                                  17360000
173800                                                                  17370000
173900     IF SV022-OVERTENDERED                                        17380000
174000         IF SV022-CRD-NBR = PV-HOLD-OVERTENDER-CRD-NBR            17390000
174100             CONTINUE                                             17400000
174200         ELSE                                                     17410000
174300             MOVE SV022-CRD-NBR TO PV-HOLD-OVERTENDER-CRD-NBR     17420000
174400             SET SV019-CARD-OVERTENDERED TO TRUE                  17430000
174500             PERFORM Z200-MOVE-KMC-TO-AUDIT                       17440000
174600             PERFORM Z300-WRITE-AUDIT-RECORD                      17450000
174700         END-IF                                                   17460000
174800     END-IF.                                                      17470000
174900*----------------------------------------------------------------*17480000
175000**  CONVERSION OF CARD NUMBER                                    *17490000
175100*----------------------------------------------------------------*17500000
175200     COPY SVPD007.                                                17510000
175300******************************************************************17520000
175400*     Y100-READ-SVT00002-ACTIVITY                                *17530000
175500* ==> PROCESSES:                                                 *17540000
175600* ==> PERFORMED FROM: B100-INITIALIZE                            *17550000
175700*                     B200-COMPARE-SVT00002-FILES                *17560000
175800*                     B400-PROCESS-REST-SVT0002-FILE            * 17570000
175900*                     C100-MISSING-POS-RECORD                    *17580000
176000******************************************************************17590000
176100 Y100-READ-SVT00002-ACTIVITY.                                     17600000
176200                                                                  17610000
176300     READ DAILY-SVT00002-ACTIVITY                                 17620000
176400                               INTO SV022-KMCACT-EXTRACT-RECORD   17630000
176500         AT END                                                   17640000
176600             SET PS-END-OF-SVT00002-FILE TO TRUE.                 17650000
176700                                                                  17660000
176800     IF PS-END-OF-SVT00002-FILE                                   17670000
176900       CONTINUE                                                   17680000
177000     ELSE                                                         17690000
177100       ADD +1 TO PA-SVT00002-ACTIVITY-RECS-READ                   17700000
177200       IF SV022-ACTVY-STAT-CDE = 1 AND                            17710000
177300                 SV022-POS-DTE = CR-CONTROL-DATE                  17720000
177400         IF SV022-CRD-TYP-CDE = 1                                 17730000
177500            IF SV022-ACTVY-TYP-CDE = 1                            17740000
177600               ADD SV022-APP-AUTH-AMT TO                          17750000
177700                       SV043-TOT-AUTH-ISSUE-K                     17760000
177800                       SV043-TOT-COMP-ISSUE-K                     17770000
177900               MOVE SV022-APP-AUTH-AMT TO                         17780000
178000                    SV044-TOT-AUTH-ISSUE-K                        17790000
178100            ELSE                                                  17800000
178200                IF SV022-ACTVY-TYP-CDE = 3                        17810000
178300                   ADD SV022-APP-AUTH-AMT TO                      17820000
178400                       SV043-TOT-AUTH-TND-K                       17830000
178500                       SV043-TOT-COMP-TND-K                       17840000
178600                   MOVE SV022-APP-AUTH-AMT TO                     17850000
178700                       SV044-TOT-AUTH-TND-K                       17860000
178800                END-IF                                            17870000
178900            END-IF                                                17880000
179000         ELSE                                                     17890000
179100          IF SV022-CRD-TYP-CDE = 2                                17900000
179200            IF SV022-ACTVY-TYP-CDE = 3                            17910000
179300                  ADD SV022-APP-AUTH-AMT TO                       17920000
179400                      SV043-TOT-AUTH-TND-G                        17930000
179500                      SV043-TOT-COMP-TND-G                        17940000
179600                  MOVE SV022-APP-AUTH-AMT TO                      17950000
179700                       SV044-TOT-AUTH-TND-G                       17960000
179800            ELSE                                                  17970000
179900               IF SV022-ACTVY-TYP-CDE = 2                         17980000
180000                  ADD SV022-APP-AUTH-AMT TO                       17990000
180100                      SV043-TOT-AUTH-ISSUE-G                      18000000
180200                      SV043-TOT-COMP-ISSUE-G                      18010000
180300*           ROLLING TOTALS                                        18020000
180400                  MOVE SV043-TOT-AUTH-ISSUE-G TO                  18030000
180500                       SV044-TOT-AUTH-ISSUE-G                     18040000
180600               END-IF                                             18050000
180700            END-IF                                                18060000
180800          END-IF                                                  18070000
180900         END-IF                                                   18080000
181000         MOVE SV022-STR-NBR         TO SV044-STORE-NBR            18090000
181100         MOVE SV022-POS-DTE         TO SV044-POS-DATE             18100000
181200         MOVE SV022-TRMNL-NBR       TO SV044-TERMINAL-NBR         18110000
181300         MOVE SV022-TRN-NBR         TO SV044-TRANSACTION-NBR      18120000
181400         MOVE SV022-CRD-NBR         TO SV044-KMC-CRD-NBR          18130000
181500         MOVE SV022-DRV-LIC-NBR     TO SV044-DRIVERS-LICENSE      18140000
181600         MOVE SV022-APP-AUTH-AMT    TO SV044-APPROVED-TRAN-AMT    18150000
181700         MOVE SV022-ORIG-AUTH-AMT   TO SV044-ORIGINAL-AUTH-AMT    18160000
181800         MOVE SV022-POS-OPER-ID     TO SV044-OPERATOR-ID          18170000
P12431         MOVE SV022-ORD-NBR         TO SV044-ORD-NBR              18171027
181900         MOVE SV022-APPR-USER-ID    TO SV044-USER-ID              18180000
182000         MOVE SV022-TRN-VOID-IND    TO SV044-TRANS-VOID-IND       18190000
182100         MOVE SV022-TRN-RVRSL-CDE   TO SV044-REVERSAL-IND         18200000
182200         MOVE SV022-ACTVY-TYP-CDE   TO SV044-TRANS-TYPE           18210000
182300         MOVE ZERO                  TO SV044-ERROR-TYPE           18220000
182400         MOVE SV022-CRD-TYP-CDE     TO SV044-CRD-TYP-CDE          18230000
182500         WRITE TOTAL-DETAIL-RECORD                                18240000
182600                 FROM SV044-TOTAL-DETAIL-OUT                      18250000
182700       END-IF                                                     18260000
182800     END-IF.                                                      18270000
182900                                                                  18280000
183000******************************************************************18290000
183100*     Y200-READ-POS-ACTIVITY                                     *18300000
183200* ==> PROCESSES:                                                 *18310000
183300* ==> PERFORMED FROM: B100-INITIALIZE                            *18320000
183400*                     B200-COMPARE-SVT00002-FILES                *18330000
183500*                     B300-PROCESS-REST-POS-FILE                 *18340000
183600******************************************************************18350000
183700 Y200-READ-POS-ACTIVITY.                                          18360000
183800                                                                  18370000
183900     READ DAILY-POS-ACTIVITY INTO SV021-POS-ACTIVITY-RECORD       18380000
184000         AT END                                                   18390000
184100             SET PS-END-OF-DAILY-POS-FILE TO TRUE.                18400000
184200                                                                  18410000
184300     IF PS-END-OF-DAILY-POS-FILE                                  18420000
184400         CONTINUE                                                 18430000
184500     ELSE                                                         18440000
184600         ADD +1 TO PA-SALES-ACTIVITY-RECS-READ                    18450000
184700     END-IF.                                                      18460000
184800                                                                  18470000
184900******************************************************************18480000
185000*     Z100-MOVE-POS-TO-AUDIT                                     *18490000
185100* ==> PROCESSES:                                                 *18500000
185200* ==> PERFORMED FROM:                                            *18510000
185300******************************************************************18520000
185400 Z100-MOVE-POS-TO-AUDIT.                                          18530000
185500                                                                  18540000
185600     MOVE SV021-CRD-NBR           TO SV019-KMC-CRD-NBR            18550000
185700     MOVE SV021-CRD-TYP-CDE       TO SV019-CRD-TYP-CDE            18560000
185800     MOVE SV021-POS-DTE           TO SV019-POS-DATE               18570000
185900     MOVE SV021-STR-NBR           TO SV019-STORE-NBR.             18580000
186000     MOVE SV021-TRMNL-NBR         TO SV019-TERMINAL-NBR.          18590000
186100     MOVE SV021-TRN-NBR           TO SV019-TRANSACTION-NBR.       18600000
186200     MOVE SV021-APP-AUTH-AMT      TO SV019-APPROVED-TRAN-AMT.     18610000
186300     MOVE SV021-ORIG-AUTH-AMT     TO SV019-ORIGINAL-AUTH-AMT.     18620000
186400                                                                  18630000
186500     IF SV021-TRN-VOID-IND = SV004-VOID-TRANS                     18640000
186600         MOVE SV004-VOID-DISPLAY  TO SV019-TRANS-VOID-IND         18650000
186700     ELSE                                                         18660000
186800         MOVE SV021-TRN-VOID-IND  TO SV019-TRANS-VOID-IND         18670000
186900     END-IF.                                                      18680000
187000                                                                  18690000
187100     MOVE SV021-TRN-RVRSL-CDE     TO SV019-REVERSAL-IND.          18700000
187200     MOVE SV021-DRV-LIC-NBR       TO SV019-DRIVERS-LICENSE.       18710000
187300     MOVE SV021-ACTVY-TYP-CDE     TO SV019-TRANS-TYPE.            18720000
187400     MOVE SV021-POS-OPER-ID       TO SV019-OPERATOR-ID.           18730000
187500     MOVE SV021-APPR-USER-ID      TO SV019-USER-ID.               18740000
187600     MOVE SV021-TRN-STAT-CDE      TO SV019-TRN-STAT-CDE.          18750000
187700     MOVE SPACES                  TO SV019-TRN-AUTH-TMST.         18760000
187700     MOVE SV021-OMNI-CHNL-FFLMT   TO SV019-OMNI-CHNL-FFLMT.       18761001
187800                                                                  18770000
187900******************************************************************18780000
188000*     Z200-MOVE-KMC-TO-AUDIT                                     *18790000
188100* ==> PROCESSES:                                                 *18800000
188200* ==> PERFORMED FROM:                                            *18810000
188300******************************************************************18820000
188400 Z200-MOVE-KMC-TO-AUDIT.                                          18830000
188500                                                                  18840000
188600     MOVE SV022-CRD-NBR           TO SV019-KMC-CRD-NBR            18850000
188700     MOVE SV022-CRD-TYP-CDE       TO SV019-CRD-TYP-CDE            18860000
188800     MOVE SV022-POS-DTE           TO SV019-POS-DATE               18870000
188900     MOVE SV022-STR-NBR           TO SV019-STORE-NBR.             18880000
189000     MOVE SV022-TRMNL-NBR         TO SV019-TERMINAL-NBR.          18890000
189100     MOVE SV022-TRN-NBR           TO SV019-TRANSACTION-NBR.       18900000
189200     MOVE SV021-TRN-STAT-CDE      TO SV019-TRN-STAT-CDE.          18910000
189300     MOVE SV022-APP-AUTH-AMT      TO SV019-APPROVED-TRAN-AMT.     18920000
189400     MOVE SV022-ORIG-AUTH-AMT     TO SV019-ORIGINAL-AUTH-AMT.     18930000
189500                                                                  18940000
189600     IF SV022-TRN-VOID-IND = SV004-VOID-TRANS                     18950000
189700         MOVE SV004-VOID-DISPLAY  TO SV019-TRANS-VOID-IND         18960000
189800     ELSE                                                         18970000
189900         MOVE SV022-TRN-VOID-IND  TO SV019-TRANS-VOID-IND         18980000
190000     END-IF.                                                      18990000
190100                                                                  19000000
190200     MOVE SV022-TRN-RVRSL-CDE     TO SV019-REVERSAL-IND.          19010000
190300     MOVE SV022-DRV-LIC-NBR       TO SV019-DRIVERS-LICENSE.       19020000
190400     MOVE SV022-ACTVY-TYP-CDE     TO SV019-TRANS-TYPE.            19030000
190500     MOVE SV022-POS-OPER-ID       TO SV019-OPERATOR-ID.           19040000
P12431     MOVE SV022-ORD-NBR           TO SV019-ORD-NBR.               19041027
190600     MOVE SV022-APPR-USER-ID      TO SV019-USER-ID.               19050000
190700     MOVE SV022-TRN-AUTH-TMST     TO SV019-TRN-AUTH-TMST.         19060000
187700     MOVE SPACES                  TO SV019-OMNI-CHNL-FFLMT.       19061002
190800                                                                  19070000
190900******************************************************************19080000
191000*     Z250-MOVE-KMC-TO-POSTING                                   *19090000
191100* ==> PROCESSES:                                                 *19100000
191200* ==> PERFORMED FROM: D100-MATCH-PROCESS                         *19110000
191300******************************************************************19120000
191400 Z250-MOVE-KMC-TO-POSTING.                                        19130000
191500                                                                  19140000
191600     MOVE PC-UPDATE-RECORD        TO SV018-RECORD-TYPE.           19150000
191700     MOVE SV004-STAT-VERIFIED-CD  TO SV018-UPDATED-ACTIVITY.      19160000
191800                                                                  19170000
191900     MOVE SV022-CRD-TYP-CDE       TO SV018-CRD-TYP-CDE.           19180000
192000     MOVE SV022-CRD-NBR           TO SV018-KMC-CRD-NBR.           19190000
192100     MOVE SV022-POS-DTE           TO SV018-POS-DATE.              19200000
192200     MOVE SV022-STR-NBR           TO SV018-STORE-NBR.             19210000
192300     MOVE SV022-TRMNL-NBR         TO SV018-TERMINAL-NBR.          19220000
192400     MOVE SV022-TRN-NBR           TO SV018-TRANSACTION-NBR.       19230000
192500     MOVE SV022-APP-AUTH-AMT      TO SV018-APPROVED-TRAN-AMT.     19240000
192600     MOVE SV022-ORIG-AUTH-AMT     TO SV018-ORIGINAL-AUTH-AMT.     19250000
192700     MOVE SV022-TRN-VOID-IND      TO SV018-TRANS-VOID-IND.        19260000
192800     MOVE SV022-TRN-RVRSL-CDE     TO SV018-REVERSAL-IND.          19270000
192900     MOVE SV022-DRV-LIC-NBR       TO SV018-DRIVERS-LICENSE.       19280000
193000     MOVE SV022-ACTVY-TYP-CDE     TO SV018-TRANS-TYPE.            19290000
193100     MOVE SV022-POS-OPER-ID       TO SV018-POS-OPERATOR-ID.       19300000
P12431     MOVE SV022-ORD-NBR           TO SV018-ORD-NBR.               19301027
193200     MOVE SV022-APPR-USER-ID      TO SV018-APPROVAL-USER-ID.      19310000
193300     MOVE SV022-TRN-AUTH-TMST     TO SV018-TRN-AUTH-TMST.         19320000
193400                                                                  19330000
193500******************************************************************19340000
193600*     Z260-MOVE-SAVED-KMC-TO-POSTING                             *19350000
193700* ==> PROCESSES:                                                 *19360000
193800* ==> PERFORMED FROM: D100-MATCH-PROCESS                         *19370000
193900******************************************************************19380000
194000 Z260-MOVE-SAVED-KMC-TO-POSTING.                                  19390000
194100     MOVE PC-UPDATE-RECORD        TO SV018-RECORD-TYPE.           19400000
194200     MOVE SV004-STAT-VERIFIED-CD  TO SV018-UPDATED-ACTIVITY.      19410000
194300     MOVE PV-SAVE-SV022-CRD-TYP   TO SV018-CRD-TYP-CDE.           19420000
194400     MOVE PV-SAVE-SV022-CRD-NBR   TO SV018-KMC-CRD-NBR.           19430000
194500     MOVE PV-SAVE-SV022-POS-DTE   TO SV018-POS-DATE.              19440000
194600     MOVE PV-SAVE-SV022-STR-NBR   TO SV018-STORE-NBR.             19450000
194700     MOVE PV-SAVE-SV022-TRMNLNO   TO SV018-TERMINAL-NBR.          19460000
194800     MOVE PV-SAVE-SV022-TRN-NBR   TO SV018-TRANSACTION-NBR.       19470000
194900     MOVE PV-SAVE-SV022-APP-AMT   TO SV018-APPROVED-TRAN-AMT.     19480000
195000     MOVE PV-SAVE-SV022-ORG-AMT   TO SV018-ORIGINAL-AUTH-AMT.     19490000
195100     MOVE PV-SAVE-SV022-TRNVOID   TO SV018-TRANS-VOID-IND.        19500000
195200     MOVE PV-SAVE-SV022-TRNRCDE   TO SV018-REVERSAL-IND.          19510000
195300     MOVE PV-SAVE-SV022-DRV-LIC   TO SV018-DRIVERS-LICENSE.       19520000
195400     MOVE PV-SAVE-SV022-ACT-TYP   TO SV018-TRANS-TYPE.            19530000
195500     MOVE PV-SAVE-SV022-POS-OPR   TO SV018-POS-OPERATOR-ID.       19540000
P12431     MOVE PV-SAVE-SV022-ORD-NBR   TO SV018-ORD-NBR.               19541027
195600     MOVE PV-SAVE-SV022-APP-USR   TO SV018-APPROVAL-USER-ID.      19550000
195700     MOVE PV-SAVE-SV022-TRN-AUTH-TMST TO SV018-TRN-AUTH-TMST.     19560000
195800                                                                  19570000
195900******************************************************************19580000
196000*     Z300-WRITE-AUDIT-RECORD                                    *19590000
196100* ==> PROCESSES:                                                 *19600000
196200* ==> PERFORMED FROM:                                            *19610000
196300******************************************************************19620000
196400 Z300-WRITE-AUDIT-RECORD.                                         19630000
196500                                                                  19640000
196600     INITIALIZE SV044-TOTAL-DETAIL-OUT.                           19650000
196700     MOVE +1 TO PV-SUB.                                           19660000
196800     SET PS-NOT-ECOMM-STR TO TRUE.                                19670000
196900     MOVE SV019-STORE-NBR TO PV-STORE-NBR.                        19680000
197000     PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE.          19690000
197100                                                                  19700000
197200*    NOT FULFILLED TOTALS - UNMATCHED                             19710000
197300     IF PS-ECOMM-STR                                              19720000
197400       IF SV019-CRD-TYP-CDE = 1                                   19730000
197500         IF SV019-TRANS-TYPE = 3                                  19740000
197600           PERFORM Z310-ECOMM-KMRC-TENDER                         19750000
197700         ELSE                                                     19760000
197800           IF SV019-TRANS-TYPE = 1                                19770000
197900             PERFORM Z320-ECOMM-KMRC-ISSUE                        19780000
198000           END-IF                                                 19790000
198100         END-IF                                                   19800000
198200       ELSE                                                       19810000
198300         IF SV019-CRD-TYP-CDE = 2                                 19820000
198400           IF SV019-TRANS-TYPE = 3                                19830000
198500             PERFORM Z330-ECOMM-GIFTCARD-TENDER                   19840000
198600           ELSE                                                   19850000
198700             IF SV019-TRANS-TYPE = 2                              19860000
198800               PERFORM Z340-ECOMM-GIFTCARD-ISSUE                  19870000
198900             END-IF                                               19880000
199000           END-IF                                                 19890000
199100         END-IF                                                   19900000
199200       END-IF                                                     19910000
199300     END-IF.                                                      19920000
199400                                                                  19930000
199500     WRITE AUDIT-REPORT-RECORD                                    19940000
199600         FROM SV019-AUDIT-REPORT-RECORD.                          19950000
199700     ADD +1 TO PA-AUDIT-RECORDS-WRITTEN.                          19960000
199800                                                                  19970000
199900******************************************************************19980000
200000*    UNMATCHED ECOMMERCE KMRC TENDERS                            *19990000
200100******************************************************************20000000
200200 Z310-ECOMM-KMRC-TENDER.                                          20010000
200300     IF SV019-POS-DATE = CR-CONTROL-DATE                          20020000
200400       IF SV019-TRANS-VOID-IND = 'N'                              20030000
200500         ADD SV019-APPROVED-TRAN-AMT TO                           20040000
200600             SV043-ECOMM-DOL-TNDNT-K                              20050000
200700         ADD +1 TO SV043-ECOMM-CNT-TNDNT-K                        20060000
200800         MOVE SV019-APPROVED-TRAN-AMT TO                          20070000
200900              SV044-ECOMM-DOL-TNDNT-K                             20080000
201000       ELSE                                                       20090000
201100         ADD SV019-APPROVED-TRAN-AMT TO                           20100000
201200             SV043-ECOMM-DOL-TNDVNT-K                             20110000
201300         ADD +1 TO SV043-ECOMM-CNT-TNDVNT-K                       20120000
201400         MOVE SV019-APPROVED-TRAN-AMT TO                          20130000
201500              SV044-ECOMM-DOL-TNDVNT-K                            20140000
201600       END-IF                                                     20150000
201700     ELSE                                                         20160000
201800       IF SV019-POS-DATE < CR-CONTROL-DATE                        20170000
201900         IF SV019-TRANS-VOID-IND = 'N'                            20180000
202000           ADD SV019-APPROVED-TRAN-AMT TO                         20190000
202100               SV043-ECOMM-DOL-TNDNTP-K                           20200000
202200           ADD +1 TO SV043-ECOMM-CNT-TNDNTP-K                     20210000
202300           MOVE SV019-APPROVED-TRAN-AMT TO                        20220000
202400                SV044-ECOMM-DOL-TNDNTP-K                          20230000
202500         ELSE                                                     20240000
202600           ADD SV019-APPROVED-TRAN-AMT TO                         20250000
202700               SV043-ECOMM-DOL-TNDVNTP-K                          20260000
202800           ADD +1 TO SV043-ECOMM-CNT-TNDVNTP-K                    20270000
202900           MOVE SV019-APPROVED-TRAN-AMT TO                        20280000
203000                SV044-ECOMM-DOL-TNDVNTP-K                         20290000
203100         END-IF                                                   20300000
203200       END-IF                                                     20310000
203300     END-IF.                                                      20320000
203400******************************************************************20330000
203500*    UNMATCHED ECOMMERCE KMRC ISSUES                             *20340000
203600******************************************************************20350000
203700 Z320-ECOMM-KMRC-ISSUE.                                           20360000
203800     IF SV019-POS-DATE = CR-CONTROL-DATE                          20370000
203900       IF SV019-TRANS-VOID-IND = 'N'                              20380000
204000         ADD SV019-APPROVED-TRAN-AMT TO                           20390000
204100             SV043-ECOMM-DOL-ISSNT-K                              20400000
204200         ADD +1 TO SV043-ECOMM-CNT-ISSNT-K                        20410000
204300         MOVE SV019-APPROVED-TRAN-AMT TO                          20420000
204400              SV044-ECOMM-DOL-ISSNT-K                             20430000
204500       ELSE                                                       20440000
204600         ADD SV019-APPROVED-TRAN-AMT TO                           20450000
204700             SV043-ECOMM-DOL-ISSVNT-K                             20460000
204800         ADD +1 TO SV043-ECOMM-CNT-ISSVNT-K                       20470000
204900         MOVE SV019-APPROVED-TRAN-AMT TO                          20480000
205000              SV044-ECOMM-DOL-ISSVNT-K                            20490000
205100       END-IF                                                     20500000
205200     ELSE                                                         20510000
205300       IF SV019-POS-DATE < CR-CONTROL-DATE                        20520000
205400         IF SV019-TRANS-VOID-IND = 'N'                            20530000
205500           ADD SV019-APPROVED-TRAN-AMT TO                         20540000
205600               SV043-ECOMM-DOL-ISSNTP-K                           20550000
205700           ADD +1 TO SV043-ECOMM-CNT-ISSNTP-K                     20560000
205800           MOVE SV019-APPROVED-TRAN-AMT TO                        20570000
205900                SV044-ECOMM-DOL-ISSNTP-K                          20580000
206000         ELSE                                                     20590000
206100           ADD SV019-APPROVED-TRAN-AMT TO                         20600000
206200               SV043-ECOMM-DOL-ISSVNTP-K                          20610000
206300           ADD +1 TO SV043-ECOMM-CNT-ISSVNTP-K                    20620000
206400           MOVE SV019-APPROVED-TRAN-AMT TO                        20630000
206500                SV044-ECOMM-DOL-ISSVNTP-K                         20640000
206600         END-IF                                                   20650000
206700       END-IF                                                     20660000
206800     END-IF.                                                      20670000
206900******************************************************************20680000
207000*    UNMATCHED ECOMMERCE GIFTCARD TENDER                         *20690000
207100******************************************************************20700000
207200 Z330-ECOMM-GIFTCARD-TENDER.                                      20710000
207300     IF SV019-POS-DATE = CR-CONTROL-DATE                          20720000
207400       IF SV019-TRANS-VOID-IND = 'N'                              20730000
207500         ADD SV019-APPROVED-TRAN-AMT TO                           20740000
207600             SV043-ECOMM-DOL-TNDNT-G                              20750000
207700         ADD +1 TO SV043-ECOMM-CNT-TNDNT-G                        20760000
207800         MOVE SV019-APPROVED-TRAN-AMT TO                          20770000
207900              SV044-ECOMM-DOL-TNDNT-G                             20780000
208000       ELSE                                                       20790000
208100         ADD SV019-APPROVED-TRAN-AMT TO                           20800000
208200             SV043-ECOMM-DOL-TNDVNT-G                             20810000
208300         ADD +1 TO SV043-ECOMM-CNT-TNDVNT-G                       20820000
208400         MOVE SV019-APPROVED-TRAN-AMT TO                          20830000
208500              SV044-ECOMM-DOL-TNDVNT-G                            20840000
208600       END-IF                                                     20850000
208700     ELSE                                                         20860000
208800       IF SV019-POS-DATE < CR-CONTROL-DATE                        20870000
208900         IF SV019-TRANS-VOID-IND = 'N'                            20880000
209000           ADD SV019-APPROVED-TRAN-AMT TO                         20890000
209100               SV043-ECOMM-DOL-TNDNTP-G                           20900000
209200           ADD +1 TO SV043-ECOMM-CNT-TNDNTP-G                     20910000
209300           MOVE SV019-APPROVED-TRAN-AMT TO                        20920000
209400                SV044-ECOMM-DOL-TNDNTP-G                          20930000
209500         ELSE                                                     20940000
209600           ADD SV019-APPROVED-TRAN-AMT TO                         20950000
209700               SV043-ECOMM-DOL-TNDVNTP-G                          20960000
209800           ADD +1 TO SV043-ECOMM-CNT-TNDVNTP-G                    20970000
209900           MOVE SV019-APPROVED-TRAN-AMT TO                        20980000
210000                SV044-ECOMM-DOL-TNDVNTP-G                         20990000
210100         END-IF                                                   21000000
210200       END-IF                                                     21010000
210300     END-IF.                                                      21020000
210400******************************************************************21030000
210500*    UNMATCHED ECOMMERCE GIFTCARD TENDER                         *21040000
210600******************************************************************21050000
210700 Z340-ECOMM-GIFTCARD-ISSUE.                                       21060000
210800     IF SV019-POS-DATE = CR-CONTROL-DATE                          21070000
210900       IF SV019-TRANS-VOID-IND = 'N'                              21080000
211000         ADD SV019-APPROVED-TRAN-AMT TO                           21090000
211100             SV043-ECOMM-DOL-ISSNT-G                              21100000
211200         ADD +1 TO SV043-ECOMM-CNT-ISSNT-G                        21110000
211300         MOVE SV019-APPROVED-TRAN-AMT TO                          21120000
211400              SV044-ECOMM-DOL-ISSNT-G                             21130000
211500       ELSE                                                       21140000
211600         ADD SV019-APPROVED-TRAN-AMT TO                           21150000
211700             SV043-ECOMM-DOL-ISSVNT-G                             21160000
211800         ADD +1 TO SV043-ECOMM-CNT-ISSVNT-G                       21170000
211900         MOVE SV019-APPROVED-TRAN-AMT TO                          21180000
212000              SV044-ECOMM-DOL-ISSVNT-G                            21190000
212100       END-IF                                                     21200000
212200     ELSE                                                         21210000
212300       IF SV019-POS-DATE < CR-CONTROL-DATE                        21220000
212400         IF SV019-TRANS-VOID-IND = 'N'                            21230000
212500           ADD SV019-APPROVED-TRAN-AMT TO                         21240000
212600               SV043-ECOMM-DOL-ISSNTP-G                           21250000
212700           ADD +1 TO SV043-ECOMM-CNT-ISSNTP-G                     21260000
212800           MOVE SV019-APPROVED-TRAN-AMT TO                        21270000
212900                SV044-ECOMM-DOL-ISSNTP-G                          21280000
213000         ELSE                                                     21290000
213100           ADD SV019-APPROVED-TRAN-AMT TO                         21300000
213200               SV043-ECOMM-DOL-ISSVNTP-G                          21310000
213300           ADD +1 TO SV043-ECOMM-CNT-ISSVNTP-G                    21320000
213400           MOVE SV019-APPROVED-TRAN-AMT TO                        21330000
213500                SV044-ECOMM-DOL-ISSVNTP-G                         21340000
213600         END-IF                                                   21350000
213700       END-IF                                                     21360000
213800     END-IF.                                                      21370000
213900******************************************************************21380000
214000*     Z400-WRITE-UPDATE-RECORD                                   *21390000
214100******************************************************************21400000
214200 Z400-WRITE-UPDATE-RECORD.                                        21410000
214300                                                                  21420000
214400     INITIALIZE SV044-TOTAL-DETAIL-OUT.                           21430000
214500     WRITE KMC-POSTING-RECORD                                     21440000
214600         FROM SV018-UPDATE-POSTING-RECORD.                        21450000
214700     ADD +1 TO PA-UPDATE-RECORDS-WRITTEN.                         21460000
214800                                                                  21470000
214900     IF SV018-SETTLED                                             21480000
215000        IF SV022-CRD-TYP-CDE = 1                                  21490000
215100           IF SV022-ACTVY-TYP-CDE = 1                             21500000
215200               ADD SV022-APP-AUTH-AMT TO                          21510000
215300                   SV043-TOT-VER-ISSUE-K                          21520000
215400                   SV043-TOT-COMP-ISSUE-K                         21530000
215500           ELSE                                                   21540000
215600               ADD SV022-APP-AUTH-AMT TO                          21550000
215700                   SV043-TOT-VER-TND-K                            21560000
215800                   SV043-TOT-COMP-TND-K                           21570000
215900           END-IF                                                 21580000
216000        ELSE                                                      21590000
216100           IF SV022-ACTVY-TYP-CDE = 2                             21600000
216200               ADD SV022-APP-AUTH-AMT TO                          21610000
216300                   SV043-TOT-VER-ISSUE-G                          21620000
216400                   SV043-TOT-COMP-ISSUE-G                         21630000
216500           ELSE                                                   21640000
216600               ADD SV022-APP-AUTH-AMT TO                          21650000
216700                   SV043-TOT-VER-TND-G                            21660000
216800                   SV043-TOT-COMP-TND-G                           21670000
216900           END-IF                                                 21680000
217000        END-IF                                                    21690000
217100     END-IF.                                                      21700000
217200                                                                  21710000
217300     MOVE +1 TO PV-SUB.                                           21720000
217400     SET PS-NOT-ECOMM-STR TO TRUE.                                21730000
217500     MOVE SV018-STORE-NBR TO PV-STORE-NBR.                        21740000
217600     PERFORM Z600-ECOMM-STR UNTIL PV-SUB > PV-MAX-STORE.          21750000
217700                                                                  21760000
217800     IF PS-ECOMM-STR                                              21770000
217900       IF SV018-CRD-TYP-CDE = 1                                   21780000
218000         IF SV018-TRANS-TYPE = 3                                  21790000
218100           PERFORM Z410-ECOMM-KMRC-TENDER                         21800000
218200         ELSE                                                     21810000
218300           IF SV018-TRANS-TYPE = 1                                21820000
218400             PERFORM Z420-ECOMM-KMRC-ISSUE                        21830000
218500           END-IF                                                 21840000
218600         END-IF                                                   21850000
218700       ELSE                                                       21860000
218800         IF SV018-CRD-TYP-CDE = 2                                 21870000
218900           IF SV018-TRANS-TYPE = 3                                21880000
219000             PERFORM Z430-ECOMM-GIFTCARD-TENDER                   21890000
219100           ELSE                                                   21900000
219200             IF SV018-TRANS-TYPE = 2                              21910000
219300               PERFORM Z440-ECOMM-GIFTCARD-ISSUE                  21920000
219400             END-IF                                               21930000
219500           END-IF                                                 21940000
219600         END-IF                                                   21950000
219700       END-IF                                                     21960000
219800     END-IF.                                                      21970000
219900                                                                  21980000
220000******************************************************************21990000
220100*     MATCHED ECOMMERCE KMRC TENDER                              *22000000
220200******************************************************************22010000
220300 Z410-ECOMM-KMRC-TENDER.                                          22020000
220400     IF SV018-TRANS-VOID-IND = 'N'                                22030000
220500         ADD SV018-APPROVED-TRAN-AMT TO                           22040000
220600             SV043-ECOMM-DOL-TNDT-K                               22050000
220700         ADD +1 TO SV043-ECOMM-CNT-TNDT-K                         22060000
220800         MOVE SV018-APPROVED-TRAN-AMT TO                          22070000
220900              SV044-ECOMM-DOL-TNDT-K                              22080000
221000     ELSE                                                         22090000
221100         ADD SV018-APPROVED-TRAN-AMT TO                           22100000
221200             SV043-ECOMM-DOL-TNDVT-K                              22110000
221300         ADD +1 TO SV043-ECOMM-CNT-TNDVT-K                        22120000
221400         MOVE SV018-APPROVED-TRAN-AMT TO                          22130000
221500              SV044-ECOMM-DOL-TNDVT-K                             22140000
221600     END-IF.                                                      22150000
221700******************************************************************22160000
221800*     MATCHED ECOMMERCE KMRC ISSUE                               *22170000
221900******************************************************************22180000
222000 Z420-ECOMM-KMRC-ISSUE.                                           22190000
222100     IF SV018-TRANS-VOID-IND = 'N'                                22200000
222200         ADD SV018-APPROVED-TRAN-AMT TO                           22210000
222300             SV043-ECOMM-DOL-ISST-K                               22220000
222400         ADD +1 TO SV043-ECOMM-CNT-ISST-K                         22230000
222500         MOVE SV018-APPROVED-TRAN-AMT TO                          22240000
222600              SV044-ECOMM-DOL-ISST-K                              22250000
222700     ELSE                                                         22260000
222800         ADD SV018-APPROVED-TRAN-AMT TO                           22270000
222900             SV043-ECOMM-DOL-ISSVT-K                              22280000
223000         ADD +1 TO SV043-ECOMM-CNT-ISSVT-K                        22290000
223100         MOVE SV018-APPROVED-TRAN-AMT TO                          22300000
223200              SV044-ECOMM-DOL-ISSVT-K                             22310000
223300     END-IF.                                                      22320000
223400******************************************************************22330000
223500*     MATCHED ECOMMERCE GIFTCARD TENDER                          *22340000
223600******************************************************************22350000
223700 Z430-ECOMM-GIFTCARD-TENDER.                                      22360000
223800     IF SV018-TRANS-VOID-IND = 'N'                                22370000
223900         ADD SV018-APPROVED-TRAN-AMT TO                           22380000
224000             SV043-ECOMM-DOL-TNDT-G                               22390000
224100         ADD +1 TO SV043-ECOMM-CNT-TNDT-G                         22400000
224200         MOVE SV018-APPROVED-TRAN-AMT TO                          22410000
224300              SV044-ECOMM-DOL-TNDT-G                              22420000
224400     ELSE                                                         22430000
224500         ADD SV018-APPROVED-TRAN-AMT TO                           22440000
224600             SV043-ECOMM-DOL-TNDVT-G                              22450000
224700         ADD +1 TO SV043-ECOMM-CNT-TNDVT-G                        22460000
224800         MOVE SV018-APPROVED-TRAN-AMT TO                          22470000
224900              SV044-ECOMM-DOL-TNDVT-G                             22480000
225000     END-IF.                                                      22490000
225100******************************************************************22500000
225200*     MATCHED ECOMMERCE GIFTCARD ISSUE                           *22510000
225300******************************************************************22520000
225400 Z440-ECOMM-GIFTCARD-ISSUE.                                       22530000
225500     IF SV018-TRANS-VOID-IND = 'N'                                22540000
225600         ADD SV018-APPROVED-TRAN-AMT TO                           22550000
225700             SV043-ECOMM-DOL-ISST-G                               22560000
225800         ADD +1 TO SV043-ECOMM-CNT-ISST-G                         22570000
225900         MOVE SV018-APPROVED-TRAN-AMT TO                          22580000
226000              SV044-ECOMM-DOL-ISST-G                              22590000
226100     ELSE                                                         22600000
226200         ADD SV018-APPROVED-TRAN-AMT TO                           22610000
226300             SV043-ECOMM-DOL-ISSVT-G                              22620000
226400         ADD +1 TO SV043-ECOMM-CNT-ISSVT-G                        22630000
226500         MOVE SV018-APPROVED-TRAN-AMT TO                          22640000
226600              SV044-ECOMM-DOL-ISSVT-G                             22650000
226700     END-IF.                                                      22660000
226800******************************************************************22670000
226900*     Z600-ECOM-STR                                              *22680000
227000* ==> PROCESSES:                                                 *22690000
227100*     -SEARCHES THROUGH THE ECOMMERCE STORE TABLE                *22700000
227200******************************************************************22710000
227300 Z600-ECOMM-STR.                                                  22720000
227400     IF PV-STORE-NBR = PV-ECOMM-STR (PV-SUB)                      22730000
227500         SET PS-ECOMM-STR TO TRUE                                 22740000
227600     END-IF.                                                      22750000
227700     ADD +1 TO PV-SUB.                                            22760000
227800                                                                  22770000
227900******************************************************************22780000
228000*     Z900-SQL-ABEND                                             *22790000
228100* ==> PROCESSES:                                                 *22800000
228200*     -PERFORMS ABEND PROCESSING FOR SQL ERRORS.                 *22810000
228300* ==> PERFORMED FROM:                                            *22820000
228400******************************************************************22830000
228500 Z900-SQL-ABEND.                                                  22840000
228600                                                                  22850000
228700     DISPLAY 'Z900-SQL-ABEND'.                                    22860000
228800     DISPLAY '**  ABEND     **'.                                  22870000
228900     DISPLAY '**  PROGRAM   ** = ' PC-PROGRAM-NAME.               22880000
229000     DISPLAY '**  PARAGRAPH ** = ' PV-PARAGRAPH-NAME.             22890000
229100     DISPLAY '**  OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.    22900000
229200                                                                  22910000
229300******************************************************************22920000
229400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *22930000
229500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *22940000
229600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *22950000
229700* FORMAT.                                                        *22960000
229800******************************************************************22970000
229900     COPY DPPD004.                                                22980000
230000                                                                  22990000
230100     MOVE +4013 TO ABEND-CODE.                                    23000000
230200     CALL WS-ABEND-ROUTINE USING ABEND-CODE.                      23010000
P10237                                                                  23020006
P10237******************************************************************23030006
P10237* COPY MEMBER DPPD031 CONTAINS STATEMENTS NEEDED TO INVOKE       *23040017
P10237* PROTEGRITY MODULE FOR PROTECTION / UNPROTECTION                *23050012
P10237******************************************************************23060006
P10237     COPY DPPD031.                                                23070017
P10237                                                                  23080006
