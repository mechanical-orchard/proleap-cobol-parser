000100******************************************************************00010006
000200 IDENTIFICATION DIVISION.                                         00020007
000300 PROGRAM-ID.                DPKCS225.                             00030007
000400 AUTHOR.                    BRUCE BORCHARDT.                      00040007
000500 INSTALLATION.              KOHLS.                                00050007
000600 DATE-WRITTEN.              MARCH   1997.                         00060007
000700 DATE-COMPILED.                                                   00070007
000800                                                                  00080007
000900******************************************************************00090007
001000*  CICS PROGRAM                                                  *00100007
001100*      THIS PROGRAM is the security check program for the web    *00110007
001200*      interface                                                 *00120007
207210******************************************************************00130056
207210*  07/05/2018  Jim Hunter    (CHG0207210)                        *00140056
207210*              For Mainframe Refactoring                         *00150056
207210*              In the EXEC CICS VERIFY and CHANGE calls, specify *00160056
207210*              the password before the user id. (Find 207210)    *00170056
207210******************************************************************00180056
001300******************************************************************00190007
001400 ENVIRONMENT DIVISION.                                            00200007
001500******************************************************************00210007
001600 DATA DIVISION.                                                   00220007
001700******************************************************************00230007
001800 WORKING-STORAGE SECTION.                                         00240007
001900******************************************************************00250007
002000 01  WS-VARIABLES.                                                00260007
002100     05  WS-APPLID                       PIC X(8).                00270040
002200     05  WS-COUNTER                      PIC 99.                  00280040
002300     05  WS-SIGNON                       PIC X(6) VALUE 'SIGNON'. 00290040
002400     05  WS-GET                          PIC X(3) VALUE 'GET'.    00300040
002500     05  WS-RESP                         PIC S9(8) COMP.          00310040
002600     05  WS-RESP2                        PIC S9(8) COMP.          00320040
002700     05  WS-USER-STATUS                  PIC X.                   00330040
002800         88  WS-USERID-FOUND           VALUE 'Y'.                 00340007
002900     05  WS-TOKEN-STATUS                 PIC X.                   00350040
003000         88  WS-TOKEN-FOUND            VALUE 'Y'.                 00360040
003100     05  WS-NEW-PASSWORD                 PIC X.                   00370040
003200         88  WS-NEW-PASSWORD-NEEDED    VALUE 'Y'.                 00380022
003300     05  WS-TOKEN.                                                00390021
003400         10  WS-TOKEN-ARRAY OCCURS 10 TIMES                       00400033
003500                  INDEXED BY TOKEN-INDEX.                         00410021
003600             15  WS-TOKEN-BITE           PIC X.                   00420040
003700     05  WS-USERID.                                               00430021
003800         10  WS-USERID-ARRAY OCCURS 8 TIMES                       00440021
003900                  INDEXED BY USERID-INDEX.                        00450021
004000             15  WS-USERID-BITE          PIC X.                   00460040
004100     05  WS-PASSWORD.                                             00470021
004200         10  WS-PASSWORD-ARRAY OCCURS 8 TIMES                     00480021
004300                  INDEXED BY PASSWORD-INDEX.                      00490021
004400             15  WS-PASSWORD-BITE        PIC X.                   00500040
004500     05  WS-NEWPASSWORD1.                                         00510021
004600         10  WS-NEWPASSWORD1-ARRAY OCCURS 8 TIMES                 00520021
004700                  INDEXED BY NEWPASSWORD1-INDEX.                  00530021
004800             15  WS-NEWPASSWORD1-BITE    PIC X.                   00540040
004900     05  WS-NEWPASSWORD2.                                         00550021
005000         10  WS-NEWPASSWORD2-ARRAY OCCURS 8 TIMES                 00560021
005100                  INDEXED BY NEWPASSWORD2-INDEX.                  00570021
005200             15  WS-NEWPASSWORD2-BITE    PIC X.                   00580040
005300 01  WBST-COMMAREA.                                               00590021
005400    05  WBST-EYECATCHER     PIC X(4) VALUE '>STA'.                00600021
005500    05  WBST-FUNCTION-CODE  PIC X.                                00610021
005600    05  WBST-RETURN-CODE    PIC X.                                00620021
005700    05  FILLER              PIC XX.                               00630021
005800    05  WBST-TOKEN          PIC 9(9) COMP.                        00640035
005900    05  WBST-TOKEN-X4       REDEFINES WBST-TOKEN                  00650036
006000                            PIC X(4).                             00660036
006100    05  WBST-USERID         PIC X(8).                             00670023
006200    05  WBST-USER-AREA      PIC X(248).                           00680023
006300 01  CREATE                 PIC X VALUE 'C'.                      00690023
006400 01  RETRIEVE               PIC X VALUE 'R'.                      00700023
006500 01  STORE                  PIC X VALUE 'S'.                      00710023
006600 01  DESTROY                PIC X VALUE 'D'.                      00720023
006700 01  GOODRC                 PIC X VALUE X'00'.                    00730023
006800 01  WBST-TOKEN-DW          PIC 9(18) COMP.                       00740036
006900 01  FILLER         REDEFINES WBST-TOKEN-DW.                      00750036
007000     05  FILLER             PIC X(4).                             00760036
007100     05  WBST-TOKEN-FW      PIC X(4).                             00770036
007200 01  WBST-TOKEN9            PIC 9(10).                            00780033
007300 01  WBST-TOKENX REDEFINES WBST-TOKEN9                            00790040
007400                            PIC X(10).                            00800040
007500 01  TT-TRANS-TABLES.                                             00810023
007600     05  TT-TRANS-TABLE-LOW-GROUP.                                00820023
007700         10  TT-TRANS-TABLE-LOW OCCURS 26 TIMES                   00830023
007800                      INDEXED BY TABLE-LOW-INDEX.                 00840023
007900             15  TT-TRANS-TABLE-LOW-BITE    PIC X.                00850040
008000     05  TT-LOWER-CASE-CHARS                PIC X(26)             00860023
008100         VALUE 'abcdefghijklmnopqrstuvwxyz'.                      00870023
008200     05  TT-TRANS-TABLE-HIGH-GROUP.                               00880023
008300         10  TT-TRANS-TABLE-HIGH OCCURS 26 TIMES                  00890023
008400                      INDEXED BY TABLE-HIGH-INDEX.                00900023
008500             15  TT-TRANS-TABLE-HIGH-BITE   PIC X.                00910040
008600     05  TT-UPPER-CASE-CHARS                PIC X(26)             00920023
008700         VALUE 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.                      00930023
008800 01  EM-ERROR-MESSAGE-LIST.                                       00940038
008900      05 EM-MESSAGE0                  PIC X(71) VALUE             00950023
009000      '<p>NEW PASSWORDS NOT EQUAL, PLEASE REENTER'.               00960023
009100      05 EM-MESSAGE1                  PIC X(71) VALUE             00970023
009200      '<p>USERID NOT ON FILE'.                                    00980023
009300      05 EM-MESSAGE2                  PIC X(71) VALUE             00990023
009400      '<p>PASSWORD AS ENTERED IS INVALID, PLEASE TRY AGAIN'.      01000023
009500      05 EM-MESSAGE2A                 PIC X(71) VALUE             01010023
009600      '<p>OLD PASSWORD AS ENTERED IS INVALID, PLEASE TRY AGAIN'.  01020023
009700      05 EM-MESSAGE3                  PIC X(71) VALUE             01030023
009800      '<p>YOUR PASSWORD HAS EXPIRED, PLEASE ENTER NEW PASSWORD'.  01040023
009900      05 EM-MESSAGE4                  PIC X(71) VALUE             01050023
010000      '<p>NEW PASSWORD AS ENTERED IS INVALID                  '.  01060023
010100      05 EM-MESSAGE19                 PIC X(71) VALUE             01070023
010200      '<p>YOUR USERID HAS BEEN REVOKED, PLEASE CALL HELP DESK'.   01080023
010300      05 EM-MESSAGE32                 PIC X(71) VALUE             01090023
010400      '<p>INVALID USERID ENTERED'.                                01100023
010500      05 EM-MESSAGEOK                 PIC X(71) VALUE             01110023
010600      '<p>SIGNON SUCCESSFUL'.                                     01120023
010700******************************************************************01130040
010800* HIPERTEXT LINKS ARE THE MENU ITEMS DISPLAYED                    01140042
010900* CREATE ONE FOR EACH ITEM YOU WISH TO DISPLAY AND MOVE IT TO     01150042
011000* A COPY OF P1-LINE19                                             01160042
011100******************************************************************01170040
011200 01  HL-HIPERTEXT-LINKS.                                          01180040
011300     05  HL-OPTION1.                                              01190040
011400         10  HL-OPTION1-LINE1         PIC X(14)                   01200040
011500          VALUE '<a href="http:'.                                 01210040
011600******************************************************************01220040
011700* CHANGE LINE2 TO REFLECT YOUR CICS'S TCP/IP ADDRESS              01230042
011800******************************************************************01240040
011900         10  HL-OPTION1-LINE2         PIC X(38)                   01250040
012000          VALUE '//128.9.111.249:80/cics/cwba/dpkcstst?'.         01260040
012100         10  HL-OPTION1-OUTTOKEN      PIC X(10)                   01270040
012200          VALUE SPACES.                                           01280040
012300         10  HL-OPTION1-LINE3         PIC X(2)                    01290040
012400          VALUE '">'.                                             01300040
012500         10  HL-CRLF13                PIC X(2)                    01310040
012600          VALUE X'0D25'.                                          01320040
012700******************************************************************01330040
012800* CHANGE LINE4 TO REFLECT YOUR IMAGE SERVERS ADDRESS              01340042
012900******************************************************************01350040
013000*        10  HL-OPTION1-LINE4         PIC X(32)                   01360049
013100*         VALUE '<img src="http://128.9.110.68:80'.               01370049
013110         10  HL-OPTION1-LINE4         PIC X(30)                   01380049
013120          VALUE '<img src="http://10.1.12.4:80'.                  01390049
013200******************************************************************01400040
013300* redball.gif IS THE IMAGE WE USE FOR A BULLET POINT             *01410042
013400* CHANGE TO WHAT YOU HAVE AVAILABLE                              *01420042
013500******************************************************************01430040
013600         10  HL-OPTION1-LINE5         PIC X(22)                   01440040
013700          VALUE '/IMAGES/redball.gif"> '.                         01450040
013800         10  HL-OPTION1-LINE6         PIC X(26)                   01460048
013900          VALUE 'CICS Web Interface</a><br>'.                     01470048
013910     05  HL-OPTION2.                                              01480044
013920         10  HL-OPTION2-LINE1         PIC X(14)                   01490044
013930          VALUE '<a href="http:'.                                 01500044
013940******************************************************************01510044
013950* CHANGE LINE2 TO REFLECT YOUR CICS'S TCP/IP ADDRESS              01520044
013960******************************************************************01530044
013970*        10  HL-OPTION2-LINE2         PIC X(38)                   01540052
013980*         VALUE '//128.9.111.249:81/cics/cwba/dfhwbtta?'.         01550052
013981         10  HL-OPTION2-LINE2         PIC X(43)                   01560052
013982          VALUE '//128.9.111.249:80/cics/cwba/dfhwbtta/Z007?'.    01570054
013990         10  HL-OPTION2-OUTTOKEN      PIC X(10)                   01580044
013991          VALUE SPACES.                                           01590044
013992         10  HL-OPTION2-LINE3         PIC X(2)                    01600044
013993          VALUE '">'.                                             01610044
013994         10  HL-CRLF14                PIC X(2)                    01620044
013995          VALUE X'0D25'.                                          01630044
013996******************************************************************01640044
013997* CHANGE LINE4 TO REFLECT YOUR IMAGE SERVERS ADDRESS              01650044
013998******************************************************************01660044
013999*        10  HL-OPTION2-LINE4         PIC X(32)                   01670049
014000*         VALUE '<img src="http://128.9.110.68:80'.               01680049
014001         10  HL-OPTION1-LINE4         PIC X(30)                   01690049
014002          VALUE '<img src="http://10.1.12.4:80'.                  01700049
014003******************************************************************01710044
014004* redball.gif IS THE IMAGE WE USE FOR A BULLET POINT             *01720044
014005* CHANGE TO WHAT YOU HAVE AVAILABLE                              *01730044
014006******************************************************************01740044
014007         10  HL-OPTION2-LINE5         PIC X(22)                   01750044
014008          VALUE '/IMAGES/redball.gif"> '.                         01760044
014009         10  HL-OPTION2-LINE6         PIC X(26)                   01770048
014010          VALUE 'CICS MENU         </a><br>'.                     01780053
014020 01  EM-ERROR-MESSAGE.                                            01790044
014100     05  EM-LENGTH1                 PIC 9(8) COMP                 01800040
014200      VALUE 179.                                                  01810040
014300     05  EM-RESP                    PIC X(15)                     01820040
014400      VALUE 'HTTP/1.0 200 OK'.                                    01830040
014500     05  EM-CRLF1                   PIC X(2)                      01840040
014600      VALUE X'0D25'.                                              01850040
014700     05  EM-HDR1                    PIC X(23)                     01860040
014800      VALUE 'CONTENT-TYPE: text/html'.                            01870040
014900     05  EM-CRLF2                   PIC X(4)                      01880040
015000      VALUE X'0D250D25'.                                          01890040
015100     05  EM-LINE2                   PIC X(51)                     01900040
015200      VALUE '<html><head><title>CICS Web Interface signon screen'.01910040
015300     05  EM-LINE3                   PIC X(15)                     01920040
015400      VALUE '</title></head>'.                                    01930040
015500     05  EM-CRLF2                   PIC X(2)                      01940040
015600      VALUE X'0D25'.                                              01950040
015700     05  EM-LINE4                   PIC X(47)                     01960040
015800      VALUE '<BODY><H1>FAILURE IN TOKEN ASSIGNMENT     </H1>'.    01970040
015900     05  EM-CRLF3                   PIC X(2)                      01980040
016000      VALUE X'0D25'.                                              01990040
016100     05  EM-LINE24                  PIC X(14)                     02000013
016200      VALUE '</body></html>'.                                     02010040
016300 01  EM-ERROR-MESSAGE1.                                           02020023
016400     05  EM-LENGTH1                 PIC 9(8) COMP                 02030040
016500      VALUE 179.                                                  02040040
016600     05  EM-RESP                    PIC X(15)                     02050023
016700      VALUE 'HTTP/1.0 200 OK'.                                    02060040
016800     05  EM-CRLF1                   PIC X(2)                      02070040
016900      VALUE X'0D25'.                                              02080040
017000     05  EM-HDR1                    PIC X(23)                     02090023
017100      VALUE 'CONTENT-TYPE: text/html'.                            02100040
017200     05  EM-CRLF2                   PIC X(4)                      02110040
017300      VALUE X'0D250D25'.                                          02120040
017400     05  EM-LINE2                   PIC X(51)                     02130023
017500      VALUE '<html><head><title>CICS Web Interface signon screen'.02140040
017600     05  EM-LINE3                   PIC X(15)                     02150023
017700      VALUE '</title></head>'.                                    02160040
017800     05  EM-CRLF2                   PIC X(2)                      02170040
017900      VALUE X'0D25'.                                              02180040
018000     05  EM-LINE4                   PIC X(47)                     02190023
018100      VALUE '<BODY><H1>FAILURE STORING USERID          </H1>'.    02200040
018200     05  EM-CRLF3                   PIC X(2)                      02210040
018300      VALUE X'0D25'.                                              02220040
018400     05  EM-LINE24                  PIC X(14)                     02230023
018500      VALUE '</body></html>'.                                     02240040
018600 01  P1-PAGE-INFO1.                                               02250023
018801     05  P1-INFO1-LENGTH1           PIC 9(8) COMP                 02260052
018802      VALUE 960.                                                  02270052
018803*     VALUE 955.                                                  02280052
018810*     VALUE 801.                                                  02290045
018900     05  P1-RESP                    PIC X(15)                     02300023
019000      VALUE 'HTTP/1.0 200 OK'.                                    02310040
019100     05  P1-CRLF1                   PIC X(2)                      02320040
019200      VALUE X'0D25'.                                              02330040
019300     05  P1-HDR1                    PIC X(23)                     02340023
019400      VALUE 'CONTENT-TYPE: text/html'.                            02350040
019500     05  P1-CRLF2                   PIC X(4)                      02360040
019600      VALUE X'0D250D25'.                                          02370040
019700     05  P1-LINE2                   PIC X(51)                     02380023
019800     VALUE '<html><head><title>CICS Web Interface signon screen'. 02390023
019900     05  P1-LINE3                   PIC X(15)                     02400023
020000      VALUE '</title></head>'.                                    02410040
020100     05  P1-CRLF2                   PIC X(2)                      02420040
020200      VALUE X'0D25'.                                              02430040
020300     05  P1-LINE4                   PIC X(47)                     02440023
020400      VALUE '<body><h1>CICS Web Interface signon screen</h1>'.    02450040
020500     05  P1-CRLF3                   PIC X(2)                      02460040
020600      VALUE X'0D25'.                                              02470040
020700     05  P1-LINE5                   PIC X(23)                     02480023
020800      VALUE '<form action="DPKCS225?'.                            02490040
020900     05  P1-OUTTOKEN                PIC X(10)                     02500040
021000      VALUE SPACES.                                               02510040
021100     05  P1-LINE5A                  PIC X(16)                     02520023
021200      VALUE '" method="POST">'.                                   02530040
021300     05  P1-CRLF4                   PIC X(2)                      02540040
021400      VALUE X'0D25'.                                              02550040
021500     05  P1-LINE6                   PIC X(52)                     02560023
021600     VALUE '<input type="hidden" name="function" value="signon">'.02570023
021700     05  P1-CRLF5                   PIC X(2)                      02580040
021800      VALUE X'0D25'.                                              02590040
021900     05  P1-LINE7                   PIC X(46)                     02600023
022000      VALUE '<p>Please enter your userid and password, then'.     02610040
022100     05  P1-LINE8                   PIC X(27)                     02620023
022200      VALUE ' select the Signon button.'.                         02630040
022300     05  P1-CRLF6                   PIC X(2)                      02640040
022400      VALUE X'0D25'.                                              02650040
022500     05  P1-LINE9                   PIC X(10)                     02660023
022600      VALUE '<p>Userid '.                                         02670040
022700     05  P1-LINE10                  PIC X(51)                     02680023
022800     VALUE '<input type="text" name="userid" size="8" value="">'. 02690023
022900     05  P1-CRLF7                   PIC X(2)                      02700040
023000      VALUE X'0D25'.                                              02710040
023100     05  P1-LINE11                  PIC X(9)                      02720023
023200      VALUE 'Password '.                                          02730040
023300     05  P1-LINE12                  PIC X(22)                     02740023
023400      VALUE '<input type="password"'.                             02750040
023500     05  P1-LINE13                  PIC X(35)                     02760023
023600      VALUE ' name="password" size="8" value="">'.                02770040
023700     05  P1-CRLF8                   PIC X(2)                      02780040
023800      VALUE X'0D25'.                                              02790040
023900     05  P1-LINE14                  PIC X(24)                     02800023
024000      VALUE '<p><input type="submit" '.                           02810040
024100     05  P1-LINE15                  PIC X(29)                     02820023
024200      VALUE 'name="submit" value="SIGNON">'.                      02830040
024300     05  P1-CRLF9                   PIC X(2)                      02840040
024400      VALUE X'0D25'.                                              02850040
024500     05  P1-LINE16                  PIC X(20)                     02860023
024600      VALUE '<input type="reset">'.                               02870040
024700     05  P1-CRLF10                  PIC X(2)                      02880040
024800      VALUE X'0D25'.                                              02890040
024900     05  P1-LINE17                  PIC X(7)                      02900023
025000      VALUE '</form>'.                                            02910040
025100     05  P1-CRLF11                  PIC X(2)                      02920040
025200      VALUE X'0D25'.                                              02930040
025300     05  P1-LINE17A                 PIC X(71)                     02940040
025400      VALUE SPACES.                                               02950040
025500     05  P1-LINE18                  PIC X(12)                     02960023
025600      VALUE '<br><hr><br>'.                                       02970040
025700     05  P1-CRLF12                  PIC X(2)                      02980040
025800      VALUE X'0D25'.                                              02990040
025900******************************************************************03000040
026000* P1-LINE19 is where the hipertext links,(HL-OPTION1)             03010040
026100* in this case are moved to prior to setting up the               03020040
026200* commarea sent back to the browser.                              03030040
026300* To display more than one option you must create more            03040040
026400* P1-LINE19s and move your additional hipertext links             03050040
026500* to these new lines.  Increase the value of                      03060040
026600* P1-INFO1-LENGHT1 to include the length of the added             03070040
026700* lines.  If the total > 1000 you must increase the length of     03080040
026800* LS-OUTPUT and CC-COMMAREA-ARRAY to match.                       03090040
026900******************************************************************03100040
027000     05  P1-LINE19                  PIC X(146)                    03110048
027100      VALUE SPACES.                                               03120040
027110     05  P1-CRLF13                  PIC X(2)                      03130044
027120      VALUE X'0D25'.                                              03140044
027130     05  P1-LINE20                  PIC X(146)                    03150048
027140      VALUE SPACES.                                               03160044
027200     05  P1-LINE24                  PIC X(14)                     03170040
027300      VALUE '</body></html>'.                                     03180040
027400 01  P2-PAGE-INFO1.                                               03190040
027500     05  P2-INFO1-LENGTH1           PIC 9(8) COMP                 03200040
027600      VALUE 980.                                                  03210040
027700     05  P2-RESP                    PIC X(15)                     03220040
027800      VALUE 'HTTP/1.0 200 OK'.                                    03230040
027900     05  P2-CRLF1                   PIC X(2)                      03240040
028000      VALUE X'0D25'.                                              03250040
028100     05  P2-HDR1                    PIC X(23)                     03260040
028200      VALUE 'CONTENT-TYPE: text/html'.                            03270040
028300     05  P2-CRLF2                   PIC X(4)                      03280040
028400      VALUE X'0D250D25'.                                          03290040
028500     05  P2-LINE2                   PIC X(51)                     03300040
028600     VALUE '<html><head><title>CICS Web Interface signon screen'. 03310040
028700     05  P2-LINE3                   PIC X(15)                     03320040
028800      VALUE '</title></head>'.                                    03330040
028900     05  P2-CRLF3                   PIC X(2)                      03340040
029000      VALUE X'0D25'.                                              03350040
029100     05  P2-LINE4                   PIC X(47)                     03360040
029200      VALUE '<body><h1>CICS Web Interface signon screen</h1>'.    03370040
029300     05  P2-CRLF4                   PIC X(2)                      03380040
029400      VALUE X'0D25'.                                              03390040
029500     05  P2-LINE5                   PIC X(23)                     03400040
029600      VALUE '<form action="DPKCS225?'.                            03410040
029700     05  P2-OUTTOKEN                PIC X(10)                     03420040
029800      VALUE SPACES.                                               03430040
029900     05  P2-LINE5A                  PIC X(16)                     03440040
030000      VALUE '" method="POST">'.                                   03450040
030100     05  P2-CRLF5                   PIC X(2)                      03460040
030200      VALUE X'0D25'.                                              03470040
030300     05  P2-LINE6                   PIC X(52)                     03480040
030400     VALUE '<input type="hidden" name="function" value="signon">'.03490040
030500     05  P2-CRLF6                   PIC X(2)                      03500040
030600      VALUE X'0D25'.                                              03510040
030700     05  P2-LINE7                   PIC X(46)                     03520040
030800      VALUE '<p>Please enter your userid and password, then'.     03530040
030900     05  P2-LINE8                   PIC X(36)                     03540040
031000      VALUE '<p> enter a new password twice, then'.               03550040
031100     05  P2-LINE9                   PIC X(27)                     03560040
031200      VALUE ' select the Signon button.'.                         03570040
031300     05  P2-CRLF7                   PIC X(2)                      03580040
031400      VALUE X'0D25'.                                              03590040
031500     05  P2-LINE10                  PIC X(10)                     03600040
031600      VALUE '<p>Userid '.                                         03610040
031700     05  P2-LINE11                  PIC X(51)                     03620040
031800     VALUE '<input type="text" name="userid" size="8" value="">'. 03630040
031900     05  P2-CRLF8                   PIC X(2)                      03640040
032000      VALUE X'0D25'.                                              03650040
032100     05  P2-LINE12                  PIC X(9)                      03660040
032200      VALUE 'Password '.                                          03670040
032300     05  P2-LINE13                  PIC X(22)                     03680040
032400      VALUE '<input type="password"'.                             03690040
032500     05  P2-LINE14                  PIC X(35)                     03700040
032600      VALUE ' name="password" size="8" value="">'.                03710040
032700     05  P2-CRLF9                   PIC X(2)                      03720040
032800      VALUE X'0D25'.                                              03730040
032900     05  P2-LINE15                  PIC X(13)                     03740040
033000      VALUE 'New Password '.                                      03750040
033100     05  P2-LINE16                  PIC X(22)                     03760040
033200      VALUE '<input type="password"'.                             03770040
033300     05  P2-LINE17                  PIC X(39)                     03780040
033400      VALUE ' name="newpassword1" size="8" value="">'.            03790040
033500     05  P2-CRLF10                  PIC X(2)                      03800040
033600      VALUE X'0D25'.                                              03810040
033700     05  P2-LINE18                  PIC X(13)                     03820040
033800      VALUE 'New Password '.                                      03830040
033900     05  P2-LINE19                  PIC X(22)                     03840040
034000      VALUE '<input type="password"'.                             03850040
034100     05  P2-LINE20                  PIC X(39)                     03860040
034200      VALUE ' name="newpassword2" size="8" value="">'.            03870040
034300     05  P2-CRLF11                  PIC X(2)                      03880040
034400      VALUE X'0D25'.                                              03890040
034500     05  P2-LINE21                  PIC X(24)                     03900040
034600      VALUE '<p><input type="submit" '.                           03910040
034700     05  P2-LINE22                  PIC X(29)                     03920040
034800      VALUE 'NAME="SUBMIT" VALUE="RETRY ">'.                      03930040
034900     05  P2-CRLF12                  PIC X(2)                      03940040
035000      VALUE X'0D25'.                                              03950040
035100     05  P2-LINE23                  PIC X(20)                     03960040
035200      VALUE '<input type="reset">'.                               03970040
035300     05  P2-CRLF13                  PIC X(2)                      03980040
035400      VALUE X'0D25'.                                              03990040
035500     05  P2-LINE24                  PIC X(7)                      04000040
035600      VALUE '</form>'.                                            04010040
035700     05  P2-CRLF14                  PIC X(2)                      04020040
035800      VALUE X'0D25'.                                              04030040
035900     05  P2-LINE25                  PIC X(71)                     04040040
036000      VALUE SPACES.                                               04050040
036100     05  P2-LINE26                  PIC X(12)                     04060040
036200      VALUE '<br><hr><br>'.                                       04070040
036300     05  P2-CRLF15                  PIC X(2)                      04080040
036400      VALUE X'0D25'.                                              04090040
036500     05  P2-LINE27                  PIC X(131)                    04100040
036600      VALUE SPACES.                                               04110040
036700     05  P2-LINE28                  PIC X(14)                     04120040
036800      VALUE '</body></html>'.                                     04130040
036900 01  CA-COMMAREA.                                                 04140040
037000     05  CC-COMMAREA-ARRAY OCCURS 1000 TIMES                      04150040
037100                     INDEXED BY COMMAREA-ARRAY-INDEX.             04160040
037200         10  COMMAREA-ARRAY-BITE    PIC X.                        04170040
037300******************************************************************04180040
037400 LINKAGE SECTION.                                                 04190040
037500******************************************************************04200040
037600                                                                  04210040
037700 01  DFHCOMMAREA.                                                 04220040
037800     05  LS-OUTPUT                  PIC X(1000).                  04230040
037900******************************************************************04240040
038000 PROCEDURE DIVISION.                                              04250040
038100 0000-MAINLINE.                                                   04260040
038200     PERFORM 1000-SETUP.                                          04270040
038300     PERFORM 2000-CHECK-REQUEST.                                  04280040
038400     PERFORM 3000-LOAD-COMMAREA.                                  04290040
038500     EXEC CICS RETURN                                             04300040
038600         END-EXEC.                                                04310040
038700     GOBACK.                                                      04320040
038800 1000-SETUP.                                                      04330040
038900******************************************************************04340040
039000* INITIALIZE ALL TABLES PRIOR TO PROCESSING                      *04350040
039100******************************************************************04360040
039200     SET COMMAREA-ARRAY-INDEX, USERID-INDEX,                      04370040
039300         PASSWORD-INDEX, TOKEN-INDEX,                             04380040
039400         NEWPASSWORD1-INDEX, NEWPASSWORD2-INDEX TO 1.             04390040
039500     MOVE DFHCOMMAREA TO CA-COMMAREA.                             04400040
039600     MOVE SPACES TO WS-USERID, WS-PASSWORD, WS-NEWPASSWORD1,      04410040
039700          WS-NEWPASSWORD2.                                        04420040
039800     MOVE TT-UPPER-CASE-CHARS TO TT-TRANS-TABLE-HIGH-GROUP.       04430040
039900     MOVE TT-LOWER-CASE-CHARS TO TT-TRANS-TABLE-LOW-GROUP.        04440040
040000     IF EIBCALEN = ZERO                                           04450040
040100     EXEC CICS RETURN                                             04460040
040200         END-EXEC.                                                04470040
040300 2000-CHECK-REQUEST.                                              04480040
040400******************************************************************04490040
040500* IF THIS IS A "GET" THEN WE MUST CREATE A TOKEN                 *04500040
040600* OTHERWISE  FIND THE TOKEN AND SAVE IT FOR FUTURE USE           *04510040
040700* AND GET AND VERIFY THE USERID AND PASSWORD                     *04520040
040800******************************************************************04530040
040900     MOVE ZEROES TO WS-COUNTER.                                   04540040
041000     INSPECT CA-COMMAREA                                          04550040
041100             TALLYING WS-COUNTER                                  04560040
041200             FOR ALL WS-GET.                                      04570040
041300     IF WS-COUNTER > 0                                            04580040
041400        MOVE LOW-VALUES TO WBST-COMMAREA                          04590040
041500        MOVE '>STA' TO WBST-EYECATCHER                            04600040
041600        MOVE CREATE TO WBST-FUNCTION-CODE                         04610040
041700        EXEC CICS LINK PROGRAM('DFH$WBSR')                        04620040
041800                       COMMAREA(WBST-COMMAREA)                    04630040
041900                       LENGTH(268)                                04640040
042000        END-EXEC                                                  04650040
042100        IF WBST-RETURN-CODE = GOODRC                              04660040
042200***************************************************************** 04670042
042300* THE NEXT 3 STATEMENTS TRANSLATE THE PACKED TOKEN CREATED BY     04680042
042400* DFH$WBSR TO A 10 DIGIT DISPLAY FIELD PLACED IN THE HTML         04690042
042500***************************************************************** 04700042
042600             MOVE ZEROS TO WBST-TOKEN-DW                          04710042
042700             MOVE WBST-TOKEN-X4 TO WBST-TOKEN-FW                  04720042
042800             COMPUTE WBST-TOKEN9 = WBST-TOKEN-DW                  04730042
042900             MOVE WBST-TOKENX TO HL-OPTION1-OUTTOKEN, P1-OUTTOKEN,04740042
043000                  P2-OUTTOKEN, HL-OPTION2-OUTTOKEN                04750045
043100        ELSE                                                      04760042
043200             MOVE EM-ERROR-MESSAGE TO LS-OUTPUT                   04770042
043300             EXEC CICS RETURN END-EXEC                            04780042
043400     ELSE                                                         04790042
043500        PERFORM 2100-FIND-TOKEN UNTIL                             04800042
043600                WS-TOKEN-FOUND                                    04810042
043700        MOVE WS-TOKEN TO HL-OPTION1-OUTTOKEN, P1-OUTTOKEN,        04820042
043800                P2-OUTTOKEN, HL-OPTION2-OUTTOKEN                  04830045
043900        MOVE ZEROES TO WS-COUNTER                                 04840042
044000        INSPECT CA-COMMAREA                                       04850042
044100                TALLYING WS-COUNTER                               04860042
044200                FOR ALL WS-SIGNON                                 04870042
044300           IF WS-COUNTER > 0                                      04880042
044400              PERFORM 4000-FIND-USERID UNTIL                      04890042
044500                   WS-USERID-FOUND                                04900042
044600              PERFORM 5100-LOAD-PASSWORD                          04910042
044700              PERFORM 6000-SIGNON                                 04920042
044800           ELSE                                                   04930042
044900              PERFORM 4000-FIND-USERID UNTIL                      04940042
045000                   WS-USERID-FOUND                                04950042
045100              PERFORM 5100-LOAD-PASSWORD                          04960042
045200              PERFORM 7000-LOAD-NEWPW1                            04970042
045300              PERFORM 7100-LOAD-NEWPW2                            04980042
045400              IF WS-NEWPASSWORD1 = WS-NEWPASSWORD2                04990042
045500                   PERFORM 7300-CHANGE-PW                         05000042
045600              ELSE                                                05010042
045700                   MOVE 'Y' TO WS-NEW-PASSWORD                    05020042
045800                   MOVE EM-MESSAGE0 TO P2-LINE25.                 05030042
045900 2100-FIND-TOKEN.                                                 05040042
046000******************************************************************05050042
046100* LOCATE THE TOKEN IN THE INCOMING COMMAREA                       05060042
046200******************************************************************05070042
046300     SET COMMAREA-ARRAY-INDEX UP BY 1.                            05080042
046400     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '?'           05090042
046500          SET WS-TOKEN-FOUND TO TRUE                              05100042
046600          SET COMMAREA-ARRAY-INDEX UP BY 1                        05110042
046700          PERFORM 2200-LOAD-TOKEN 10 TIMES.                       05120042
046800 2200-LOAD-TOKEN.                                                 05130042
046900******************************************************************05140042
047000* COPY THE TOKEN TO A USEABLE AREA                                05150042
047100******************************************************************05160042
047200     MOVE COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) TO            05170042
047300          WS-TOKEN-BITE(TOKEN-INDEX)                              05180042
047400          SET TOKEN-INDEX, COMMAREA-ARRAY-INDEX UP BY 1.          05190042
047500 3000-LOAD-COMMAREA.                                              05200042
047600******************************************************************05210042
047700* MOVE THE HTML TO THE OUTPUT COMMAREA                            05220042
047800******************************************************************05230042
047900     EXEC CICS ASSIGN APPLID(WS-APPLID)                           05240042
048000     END-EXEC.                                                    05250042
048100     IF WS-NEW-PASSWORD-NEEDED                                    05260042
048200        MOVE P2-PAGE-INFO1 TO LS-OUTPUT                           05270042
048300     ELSE                                                         05280042
048400        MOVE P1-PAGE-INFO1 TO LS-OUTPUT.                          05290042
048500 4000-FIND-USERID.                                                05300042
048600******************************************************************05310042
048700* LOCATE THE USERID IN THE INCOMING COMMAREA                      05320042
048800******************************************************************05330042
048900     SET COMMAREA-ARRAY-INDEX UP BY 1.                            05340042
049000     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'           05350042
049100          SET WS-USERID-FOUND TO TRUE                             05360042
049200          PERFORM 4100-LOAD-USERID.                               05370042
049300 4100-LOAD-USERID.                                                05380042
049400     SET COMMAREA-ARRAY-INDEX UP BY 8.                            05390042
049500     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'           05400042
049600         NEXT SENTENCE                                            05410042
049700     ELSE                                                         05420042
049800         PERFORM 4200-USERID-LOADER UNTIL                         05430042
049900              COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'     05440042
050000         PERFORM 4300-USERID-CASE-TRANS.                          05450042
050100 4200-USERID-LOADER.                                              05460042
050200******************************************************************05470042
050300* COPY THE USERID TO A USEABLE AREA                               05480042
050400******************************************************************05490042
050500     MOVE COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) TO            05500042
050600          WS-USERID-BITE(USERID-INDEX)                            05510042
050700          SET USERID-INDEX, COMMAREA-ARRAY-INDEX UP BY 1.         05520042
050800 4300-USERID-CASE-TRANS.                                          05530042
050900******************************************************************05540042
051000* TRANSLATE USERID TO UPPER CASE                                  05550042
051100******************************************************************05560042
051200     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX TO 1.                  05570042
051300     PERFORM 4400-INSPECT-USERID 26 TIMES.                        05580042
051400 4400-INSPECT-USERID.                                             05590042
051500     INSPECT WS-USERID                                            05600042
051600          REPLACING ALL TT-TRANS-TABLE-LOW-BITE(TABLE-LOW-INDEX)  05610042
051700                    BY TT-TRANS-TABLE-HIGH-BITE(TABLE-HIGH-INDEX).05620042
051800     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX UP BY 1.               05630042
051900 5100-LOAD-PASSWORD.                                              05640042
052000******************************************************************05650042
052100* LOCATE THE PASSWORD AND MOVE IT TO A USEABLE AREA               05660042
052200******************************************************************05670042
052300     SET COMMAREA-ARRAY-INDEX UP BY 10.                           05680042
052400     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'           05690042
052500         NEXT SENTENCE                                            05700042
052600     ELSE                                                         05710042
052700         PERFORM 5200-PASSWORD-LOADER UNTIL                       05720042
052800              COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'     05730042
052900         PERFORM 5300-PASSWORD-CASE-TRANS.                        05740042
053000 5200-PASSWORD-LOADER.                                            05750042
053100     MOVE COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) TO            05760042
053200          WS-PASSWORD-BITE(PASSWORD-INDEX)                        05770042
053300          SET PASSWORD-INDEX, COMMAREA-ARRAY-INDEX UP BY 1.       05780042
053400 5300-PASSWORD-CASE-TRANS.                                        05790042
053500******************************************************************05800042
053600* TRANSLATE PASSWORD TO UPPER CASE                                05810042
053700******************************************************************05820042
053800     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX TO 1.                  05830042
053900     PERFORM 5400-INSPECT-PASSWORD 26 TIMES.                      05840042
054000 5400-INSPECT-PASSWORD.                                           05850042
054100     INSPECT WS-PASSWORD                                          05860042
054200          REPLACING ALL TT-TRANS-TABLE-LOW-BITE(TABLE-LOW-INDEX)  05870042
054300                    BY TT-TRANS-TABLE-HIGH-BITE(TABLE-HIGH-INDEX).05880042
054400     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX UP BY 1.               05890042
054500 6000-SIGNON.                                                     05900042
054600******************************************************************05910042
054700* EXECUTE A SIGNON                                                05920042
054800******************************************************************05930042
054900     EXEC CICS VERIFY                                             05940042
207210         PASSWORD(WS-PASSWORD)                                    05950056
207210         USERID(WS-USERID)                                        05960056
055200         RESP(WS-RESP)                                            05970042
055300         RESP2(WS-RESP2)                                          05980042
055400     END-EXEC.                                                    05990042
055500     EVALUATE TRUE                                                06000042
055600         WHEN WS-RESP = DFHRESP(USERIDERR)                        06010042
055700             MOVE EM-MESSAGE1 TO P1-LINE17A                       06020042
055800         WHEN WS-RESP2 = 2                                        06030042
055900             MOVE EM-MESSAGE2 TO P1-LINE17A                       06040042
056000         WHEN WS-RESP2 = 3                                        06050042
056100             MOVE EM-MESSAGE3 TO P1-LINE17A                       06060042
056200             MOVE 'Y' TO WS-NEW-PASSWORD                          06070042
056300         WHEN WS-RESP2 = 19                                       06080042
056400             MOVE EM-MESSAGE19 TO P1-LINE17A                      06090042
056500         WHEN WS-RESP2 = 32                                       06100042
056600             MOVE EM-MESSAGE32 TO P1-LINE17A                      06110042
056700         WHEN WS-RESP = 0                                         06120042
056800             MOVE EM-MESSAGEOK TO P1-LINE17A                      06130042
056900             MOVE HL-OPTION1 TO P1-LINE19                         06140042
056910             MOVE HL-OPTION2 TO P1-LINE20                         06150044
057000             PERFORM 7400-STORE-USERID                            06160042
057100     END-EVALUATE.                                                06170042
057200 7000-LOAD-NEWPW1.                                                06180042
057300******************************************************************06190042
057400* IF WE ASKED FOR A NEW PASSWORD   FIND IT                        06200042
057500******************************************************************06210042
057600     SET COMMAREA-ARRAY-INDEX UP BY 14.                           06220042
057700     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'           06230042
057800         NEXT SENTENCE                                            06240042
057900     ELSE                                                         06250042
058000         PERFORM 7010-NEWPASSWORD1-LOADER UNTIL                   06260042
058100              COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'     06270042
058200         PERFORM 7020-NEWPASSWORD1-CASE-TRANS.                    06280042
058300 7010-NEWPASSWORD1-LOADER.                                        06290042
058400******************************************************************06300042
058500* COPY NEW PASSWORD TO USEABLE AREA                               06310042
058600******************************************************************06320042
058700     MOVE COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) TO            06330042
058800          WS-NEWPASSWORD1-BITE(NEWPASSWORD1-INDEX)                06340042
058900          SET NEWPASSWORD1-INDEX, COMMAREA-ARRAY-INDEX UP BY 1.   06350042
059000 7020-NEWPASSWORD1-CASE-TRANS.                                    06360042
059100******************************************************************06370042
059200* TRANSLATE NEW PASSWORD TO UPPERCASE                             06380042
059300******************************************************************06390042
059400     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX TO 1.                  06400042
059500     PERFORM 7030-INSPECT-NEWPASSWORD1 26 TIMES.                  06410042
059600 7030-INSPECT-NEWPASSWORD1.                                       06420042
059700     INSPECT WS-NEWPASSWORD1                                      06430042
059800          REPLACING ALL TT-TRANS-TABLE-LOW-BITE(TABLE-LOW-INDEX)  06440042
059900                    BY TT-TRANS-TABLE-HIGH-BITE(TABLE-HIGH-INDEX).06450042
060000     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX UP BY 1.               06460042
060100 7100-LOAD-NEWPW2.                                                06470042
060200     SET COMMAREA-ARRAY-INDEX UP BY 14.                           06480042
060300     IF COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'           06490042
060400         NEXT SENTENCE                                            06500042
060500     ELSE                                                         06510042
060600         PERFORM 7110-NEWPASSWORD2-LOADER UNTIL                   06520042
060700              COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) = '&'     06530042
060800         PERFORM 7120-NEWPASSWORD2-CASE-TRANS.                    06540042
060900 7110-NEWPASSWORD2-LOADER.                                        06550042
061000     MOVE COMMAREA-ARRAY-BITE(COMMAREA-ARRAY-INDEX) TO            06560042
061100          WS-NEWPASSWORD2-BITE(NEWPASSWORD2-INDEX)                06570042
061200          SET NEWPASSWORD2-INDEX, COMMAREA-ARRAY-INDEX UP BY 1.   06580042
061300 7120-NEWPASSWORD2-CASE-TRANS.                                    06590042
061400     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX TO 1.                  06600042
061500     PERFORM 7130-INSPECT-NEWPASSWORD2 26 TIMES.                  06610042
061600 7130-INSPECT-NEWPASSWORD2.                                       06620042
061700     INSPECT WS-NEWPASSWORD2                                      06630042
061800          REPLACING ALL TT-TRANS-TABLE-LOW-BITE(TABLE-LOW-INDEX)  06640042
061900                    BY TT-TRANS-TABLE-HIGH-BITE(TABLE-HIGH-INDEX).06650042
062000     SET TABLE-LOW-INDEX, TABLE-HIGH-INDEX UP BY 1.               06660042
062100 7300-CHANGE-PW.                                                  06670042
062200******************************************************************06680042
062300* EXECUTE CHANGE PASSWORD                                         06690042
062400******************************************************************06700042
062500     EXEC CICS CHANGE                                             06710042
207210         PASSWORD(WS-PASSWORD)                                    06720056
207210         NEWPASSWORD(WS-NEWPASSWORD1)                             06730056
207210         USERID(WS-USERID)                                        06740056
062900         RESP(WS-RESP)                                            06750042
063000         RESP2(WS-RESP2)                                          06760042
063100     END-EXEC.                                                    06770042
063200     EVALUATE TRUE                                                06780042
063300         WHEN WS-RESP = DFHRESP(USERIDERR)                        06790042
063400             MOVE EM-MESSAGE1 TO P2-LINE25                        06800042
063500             MOVE 'Y' TO WS-NEW-PASSWORD                          06810042
063600         WHEN WS-RESP2 = 2                                        06820042
063700             MOVE EM-MESSAGE2A TO P2-LINE25                       06830042
063800             MOVE 'Y' TO WS-NEW-PASSWORD                          06840042
063900         WHEN WS-RESP2 = 4                                        06850042
064000             MOVE EM-MESSAGE4 TO P2-LINE25                        06860042
064100             MOVE 'Y' TO WS-NEW-PASSWORD                          06870042
064200         WHEN WS-RESP2 = 19                                       06880042
064300             MOVE EM-MESSAGE19 TO P2-LINE25                       06890042
064400             MOVE 'Y' TO WS-NEW-PASSWORD                          06900042
064500         WHEN WS-RESP2 = 32                                       06910042
064600             MOVE EM-MESSAGE32 TO P2-LINE25                       06920042
064700             MOVE 'Y' TO WS-NEW-PASSWORD                          06930042
064800         WHEN WS-RESP = 0                                         06940042
064900             MOVE EM-MESSAGEOK TO P1-LINE17A                      06950042
065000             MOVE HL-OPTION1 TO P1-LINE19                         06960042
065010             MOVE HL-OPTION2 TO P1-LINE20                         06970044
065100             PERFORM 7400-STORE-USERID                            06980042
065200     END-EVALUATE.                                                06990042
065300 7400-STORE-USERID.                                               07000042
065400******************************************************************07010042
065500* STORE USERID WITH THE TOKEN FOR LATER USE                       07020042
065600******************************************************************07030042
065700     MOVE LOW-VALUES TO WBST-COMMAREA.                            07040042
065800     PERFORM 2100-FIND-TOKEN UNTIL                                07050042
065900             WS-TOKEN-FOUND.                                      07060042
066000     MOVE ZEROS TO WBST-TOKEN-DW.                                 07070042
066100***************************************************************** 07080042
066200* THE NEXT 3 STATEMENTS TRANSLATE THE 10 DIGIT DISPLAY TOKEN      07090042
066300* FROM THE INCOMING HTML INTO A PACKED TOKEN FOR USE BY DFH$WBSR  07100042
066400***************************************************************** 07110042
066500     MOVE WS-TOKEN TO WBST-TOKENX.                                07120042
066600     COMPUTE WBST-TOKEN-DW = WBST-TOKEN9.                         07130042
066700     MOVE WBST-TOKEN-FW TO WBST-TOKEN-X4.                         07140042
066800     MOVE '>STA' TO WBST-EYECATCHER.                              07150042
066900     MOVE STORE TO WBST-FUNCTION-CODE.                            07160042
067000     MOVE WS-USERID TO WBST-USERID.                               07170042
067100     EXEC CICS LINK PROGRAM('DFH$WBSR')                           07180042
067200                    COMMAREA(WBST-COMMAREA)                       07190042
067300                    LENGTH(268)                                   07200042
067400     END-EXEC.                                                    07210042
067500     IF WBST-RETURN-CODE = GOODRC                                 07220023
067600          NEXT SENTENCE                                           07230023
067700     ELSE                                                         07240023
067800          MOVE EM-ERROR-MESSAGE1 TO LS-OUTPUT                     07250023
067900          EXEC CICS RETURN END-EXEC.                              07260023
