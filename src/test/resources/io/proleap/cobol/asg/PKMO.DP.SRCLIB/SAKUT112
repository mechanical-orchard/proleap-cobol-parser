000300*---------------------------------------------------------------  00010000
000400 IDENTIFICATION DIVISION.                                         00020000
000500*---------------------------------------------------------------  00030000
000600 PROGRAM-ID.         SAKUT112.                                    00040001
000700 AUTHOR.             JOE GARDETTO.                                00050000
000800 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060000
000900 DATE-WRITTEN        MARCH 2013.                                  00070001
001000 DATE-COMPILED.                                                   00080000
001100                                                                  00090000
001200*---------------------------------------------------------------  00100000
001300* THIS PROGRAM CREATES A COMMA DELIMITED FILE THAT WILL BE FTP'D  00110000
001400* TO THE SALES AUDIT TEAM WEEKLY AFTER THE GL POSTING. THE FILE   00120001
001500* WILL CONTAIN A LIST OF ALL MISSING TRANSACTIONS FOR THE LAST    00130001
001600* 6 WEEKS.                                                        00140001
001800*---------------------------------------------------------------  00150000
001900                                                                  00160000
002000*---------------------------------------------------------------  00170000
002100* HISTORY LOG:                                                    00180000
002200*                                                                 00190000
002300* DATE: 03/07/13                                                  00200001
002400* WR/IR#: WR41828                                                 00210001
002500* PROGRAMMER: JOE GARDETTO                                        00220000
002600* DESCRIPTION: NEW PROGRAM                                        00230000
C93531******************************************************************00231044
C93531* DATE: 07/14/2015  CHG0120946                                    00232046
C93531* WHO: JOE GARDETTO                                               00233044
C93531* WHY: CHANGED FTP CONTROL CARD TO MFT FORMAT AND REMOVED IS FTP  00234046
C93531*      PARM FILE.                                                 00235046
C93531******************************************************************00236044
002700*---------------------------------------------------------------  00250000
003000 ENVIRONMENT DIVISION.                                            00260000
003200 CONFIGURATION SECTION.                                           00270000
003300 SOURCE-COMPUTER.    IBM-3090.                                    00280000
003400 OBJECT-COMPUTER.    IBM-3090.                                    00290000
003500                                                                  00300000
003600 INPUT-OUTPUT SECTION.                                            00310000
003800 FILE-CONTROL.                                                    00320000
003900                                                                  00330000
004000     SELECT DATE-FILE                                             00340001
004100         ASSIGN TO INP01.                                         00350000
004200                                                                  00360000
004300     SELECT MISSING-TRANS-FILE                                    00370001
004400         ASSIGN TO OUT01.                                         00380000
004500                                                                  00390000
004300     SELECT MISSING-TRANS-FTP-SA                                  00392232
004400         ASSIGN TO OUT02.                                         00392342
004500                                                                  00393012
004600*---------------------------------------------------------------  00400000
004700 DATA DIVISION.                                                   00410000
004900 FILE SECTION.                                                    00420000
005000                                                                  00430000
005100 FD  DATE-FILE                                                    00440001
005200     RECORDING MODE IS F                                          00450000
005300     RECORD CONTAINS 80 CHARACTERS                                00460000
005400     LABEL RECORDS ARE STANDARD                                   00470000
005500     BLOCK CONTAINS 0 RECORDS.                                    00480000
005600                                                                  00490000
005700 01  INPUT-DATE-CONTROL-RECORD   PIC X(80).                       00500005
005800                                                                  00510000
005900 FD  MISSING-TRANS-FILE                                           00520001
006000     RECORDING MODE IS F                                          00530000
006100     RECORD CONTAINS 80 CHARACTERS                                00540000
006200     LABEL RECORDS ARE STANDARD                                   00550000
006300     BLOCK CONTAINS 0  RECORDS.                                   00560000
006400                                                                  00570000
006500 01  MISSING-TRANS-RECORD        PIC X(80).                       00580025
006600                                                                  00590000
005900 FD  MISSING-TRANS-FTP-SA                                         00597332
006000     RECORDING MODE IS F                                          00597415
006100     RECORD CONTAINS 80 CHARACTERS                                00597515
006200     LABEL RECORDS ARE STANDARD                                   00597615
006300     BLOCK CONTAINS 0  RECORDS.                                   00597715
006400                                                                  00597815
006500 01  MISSING-TRANS-FTP-SA-REC    PIC X(80).                       00597932
006600                                                                  00599832
006700*---------------------------------------------------------------  00600000
006800 WORKING-STORAGE SECTION.                                         00610000
006900*---------------------------------------------------------------  00620000
007000 01  AC-ABEND-CODE               PIC   S9(04) VALUE +0            00630000
007100                                              COMP SYNC.          00640000
007200     88  AC-CURSOR-OPEN                       VALUE +4001.        00650000
007300     88  AC-CURSOR-CLOSE                      VALUE +4002.        00660000
007400     88  AC-CURSOR-FETCH                      VALUE +4003.        00670000
007500     88  AC-INVALID-CONTROL-CARD              VALUE +4004.        00680000
007600     88  AC-CALENDAR-ROUTINE-ERROR            VALUE +4005.        00690000
007700     88  AC-FILE-SEQUENCE-ERROR               VALUE +4007.        00700000
007800     88  AC-DB2-ERROR                         VALUE +4013.        00710000
007900                                                                  00720000
008000*------------------------------------------------                 00730000
008100* MISSING TRANSACTION REPORT HEADER RECORD - OUTPUT               00740002
008200*------------------------------------------------                 00750000
008300 01  MTR-COLUMN-HEADINGS.                                         00761002
008400     05  COLUMN-1                PIC  X(22)   VALUE               00770002
008400           'COUNT_OF_TRANSACTIONS,'.                              00780002
008400     05  COLUMN-2                PIC  X(08)   VALUE               00790005
008400           'SLS_DTE,'.                                            00800002
008400     05  COLUMN-3                PIC  X(08)   VALUE               00810005
008400           'STR_NBR,'.                                            00820002
008400     05  COLUMN-4                PIC  X(08)   VALUE               00830005
008400           'RGST_ID,'.                                            00840005
008400     05  COLUMN-5                PIC  X(11)   VALUE               00850002
008400           'TRN_TYP_CDE'.                                         00860002
007900                                                                  00870000
008000*------------------------------------------------                 00880000
008100* MISSING TRANSACTION REPORT RECORD LAYOUT - OUTPUT               00890002
008200*------------------------------------------------                 00900000
010100                                                                  00910000
       01  MTR-DETAIL-RECORD.                                           00921025
009200     05  MTR-TRN-COUNT           PIC  9(8)    VALUE ZEROES.       00930002
008900     05  FILLER                  PIC  X(1)    VALUE ','.          00940000
008800     05  MTR-SALES-DATE          PIC  X(10)   VALUE SPACES.       00941002
008900     05  FILLER                  PIC  X(1)    VALUE ','.          00942002
008800     05  MTR-STORE-NBR           PIC  X(4)    VALUE SPACES.       00943002
009100     05  FILLER                  PIC  X(1)    VALUE ','.          00970000
008800     05  MTR-RGST-ID             PIC  X(4)    VALUE SPACES.       00980005
009100     05  FILLER                  PIC  X(1)    VALUE ','.          00990000
008800     05  MTR-TRN-TYP-CDE         PIC  X(2)    VALUE SPACES.       01000005
010100                                                                  01019811
010200*---------------------------------------------------------------  01020000
010300* LAYOUT FOR THE INPUT DATE CONTROL CARD                          01030003
010500*---------------------------------------------------------------  01050000
010600 01  INPUT-DATE-CONTROL-AREA.                                     01061003
010700     05  INPUT-CONTROL-DATE      PIC  X(10)   VALUE SPACES.       01070003
011200     05  FILLER                  PIC  X(70)   VALUE SPACES.       01110003
011300                                                                  01120000
011400*------------------------------------------------                 01130000
011500* PC- PROGRAM CONSTANTS                                           01140000
011600*------------------------------------------------                 01150000
011700 01  PC-PROGRAM-CONSTANTS.                                        01160000
011800     05  PC-PROGRAM-NAME         PIC  X(8)    VALUE 'SAKUT112'.   01170001
011900     05  PC-ROW-NOT-FOUND        PIC S9(04)   VALUE +100          01180000
012000                                              COMP SYNC.          01190000
009001     05  PC-QUOTE                PIC  X(01)  VALUE QUOTE.         01211020
012200*------------------------------------------------                 01212015
012300* PS- PROGRAM SWITCHES                                            01220000
012400*------------------------------------------------                 01230000
012500 01  PS-PROGRAM-SWITCHES.                                         01240000
012600     05  PS-END-OF-MTR-CURSOR-SW     PIC X  VALUE 'N'.            01250002
012700         88 PS-END-OF-MTR-CURSOR            VALUE 'Y'.            01260002
012800     05  PS-END-OF-DATE-FILE-SW      PIC X  VALUE 'N'.            01270002
012900         88 PS-END-OF-DATE-FILE             VALUE 'Y'.            01280002
012800     05  PS-VALID-INPUT-DATE-SW      PIC X  VALUE 'N'.            01281004
012900         88 PS-VALID-INPUT-DATE             VALUE 'Y'.            01282004
013000                                                                  01290000
013100*------------------------------------------------                 01300000
013200* PV- PROGRAM VARIABLES                                           01310000
013300*------------------------------------------------                 01320000
013400 01  PV-PROGRAM-VARIABLES.                                        01330000
013500     05  PV-RECORDS-WRITTEN          PIC S9(7)    VALUE +0 COMP-3.01340000
013600     05  PV-MTR-CURSOR-COUNT         PIC S9(7)    VALUE +0 COMP-3.01350002
013700     05  PV-START-DATE               PIC X(10).                   01360000
013800     05  PV-END-DATE                 PIC X(10).                   01370000
013700     05  PV-FTP-START-DATE.                                       01371025
013700         10  PV-FTP-START-MM         PIC X(2)     VALUE SPACES.   01371125
013700         10  FILLER                  PIC X(1)     VALUE '_'.      01371226
013700         10  PV-FTP-START-DD         PIC X(2)     VALUE SPACES.   01371325
013700     05  PV-FTP-END-DATE.                                         01371425
013700         10  PV-FTP-END-MM           PIC X(2)     VALUE SPACES.   01371525
013700         10  FILLER                  PIC X(1)     VALUE '_'.      01371626
013700         10  PV-FTP-END-DD           PIC X(2)     VALUE SPACES.   01371725
013900     05  PV-PARAGRAPH-NAME           PIC X(30)    VALUE SPACES.   01380000
014000     05  PV-OPERATION-MSG-1          PIC X(40)    VALUE SPACES.   01390000
014100     05  PV-OPERATION-MSG-2          PIC X(40)    VALUE SPACES.   01400000
014200     05  PV-DB2-OPERATION            PIC X(30)    VALUE SPACES.   01410000
015200     05  PV-EDIT-MASK                PIC Z,ZZZ,ZZ9.               01460000
011900     05  PV-FTP-REC                  PIC  X(80)   VALUE SPACES.   01491015
013900     05  PV-FTP-STRING1              PIC X(5)     VALUE SPACES.   01492038
013900     05  PV-FTP-STRING2              PIC X(19)    VALUE SPACES.   01493038
013900     05  PV-FTP-STRING3              PIC X(23)    VALUE SPACES.   01494038
019100                                                                  01500000
019200*-----------------------------------------------------            01510000
019300* PARAMETER LIST FOR THE CALENDAR ROUTINE (DPKUT500)              01520000
019400*-----------------------------------------------------            01530000
019500     COPY DPWS500.                                                01540000
019600                                                                  01550000
019700*-----------------------------------------------------            01560000
019800* WS FIELDS FOR SQLCA MESSAGE ROUTINE (DPPD004)                   01570000
019900*-----------------------------------------------------            01580000
020000     COPY DPWS004.                                                01590000
020100                                                                  01600000
020200*-----------------------------------------------------            01610000
020300* DB2 COMMUNICATION AREA                                          01620000
020400*-----------------------------------------------------            01630000
020500     EXEC SQL                                                     01640000
020600          INCLUDE SQLCA                                           01650000
020700     END-EXEC.                                                    01660000
020800                                                                  01670000
020900*-----------------------------------------------------            01680000
021000* DB2 TABLE DB2PDBA.TEPPART - PARTITION TABLE                     01690000
021100*-----------------------------------------------------            01700000
021200     EXEC SQL                                                     01710000
021300          INCLUDE TEPPART                                         01720000
021400     END-EXEC.                                                    01730000
022200                                                                  01740000
021600*-----------------------------------------------------            01750000
021700* DB2 TABLE DB2PDBA.TEPTRN - TRANSACTION TABLE                    01760000
021800*-----------------------------------------------------            01770000
021900     EXEC SQL                                                     01780000
022000          INCLUDE TEPTRN                                          01790000
022100     END-EXEC.                                                    01800000
023600                                                                  02027008
023700*---------------------------------------------------------------  02030000
023800* MTR-CURSOR --> MISSING TRANSACTIONS FOR LAST 6 WEEKS            02040002
024000*---------------------------------------------------------------  02050000
024100     EXEC SQL                                                     02060000
             DECLARE MTR-CURSOR CURSOR FOR                              02470202
               SELECT                                                   02471002
                 COUNT(TRN.TRN_NBR)                                     02471102
                ,PRT.SLS_DTE                                            02471302
                ,TRN.STR_NBR                                            02471402
                ,TRN.RGST_ID                                            02471502
                ,TRN.TRN_TYP_CDE                                        02471602
               FROM                                                     02471802
                 TEPPART PRT                                            02471902
                ,TEPTRN TRN                                             02472002
               WHERE                                                    02472202
                     PRT.PARTN_NBR = TRN.PARTN_NBR                      02472302
                 AND PRT.SLS_DTE BETWEEN :PV-START-DATE                 02473130
                                     AND :PV-END-DATE                   02473230
                 AND PRT.DB_STRUC_CDE = 'O'                             02473627
                 AND TRN.SLS_CORR_SEQ_NBR > 0                           02473727
                 AND TRN.TRN_STAT_CDE IN ('V', 'Z', 'L')                02473827
                 AND NOT EXISTS                                         02473927
                         (SELECT 'Y'                                    02474027
                            FROM TEPTRN TRN1                            02474127
                           WHERE TRN.PARTN_NBR = TRN1.PARTN_NBR         02474227
                             AND TRN.STR_NBR = TRN1.STR_NBR             02474327
                             AND TRN.RGST_ID = TRN1.RGST_ID             02474427
                             AND TRN.TRN_NBR = TRN1.TRN_NBR             02474527
                             AND TRN1.SLS_CORR_SEQ_NBR <= 0)            02474627
               GROUP BY                                                 02474727
                 PRT.SLS_DTE                                            02474827
                ,TRN.STR_NBR                                            02474927
                ,TRN.RGST_ID                                            02475027
                ,TRN.TRN_TYP_CDE                                        02475127
               WITH UR                                                  02476002
028400     END-EXEC.                                                    02480000
023600                                                                  02481008
028500                                                                  02493008
028600*---------------------------------------------------------------  02500000
028700 PROCEDURE DIVISION.                                              02510000
028800*---------------------------------------------------------------  02520000
028900     PERFORM 1000-INITIALIZATION.                                 02530000
029000                                                                  02540000
           PERFORM 2000-PROCESS-MISSING-TRAN-RPT                        02571042
             UNTIL PS-END-OF-MTR-CURSOR.                                02572045
           PERFORM 2020-CREATE-FTP-FILE-SA.                             02572145
           PERFORM 8000-END-OF-JOB.                                     02580045
030400                                                                  02670000
030500     STOP RUN.                                                    02680000
030600                                                                  02690000
030700*---------------------------------------------------------------  02700000
030800* INITIALIZATION ROUTINE, OPEN THE EXTRACT, ACCEPT THE CARD       02710000
030900* FROM SYSIN, PERFORM THE ROUTINE TO FIND THE FISCAL PERIOD AND   02720000
031000* PERFORM THE ROUTINE TO OPEN THE CURSOR                          02730000
031100*---------------------------------------------------------------  02740000
031200 1000-INITIALIZATION.                                             02750000
031300                                                                  02760000
031400     OPEN INPUT  DATE-FILE.                                       02770001
031500     OPEN OUTPUT MISSING-TRANS-FILE.                              02780001
031500     OPEN OUTPUT MISSING-TRANS-FTP-SA.                            02782032
031600                                                                  02790000
031700     READ DATE-FILE                                               02800001
031800         INTO INPUT-DATE-CONTROL-AREA                             02810003
031900         AT END SET PS-END-OF-DATE-FILE                           02820002
032000                                    TO TRUE.                      02830000
032100     IF PS-END-OF-DATE-FILE                                       02840002
032200         MOVE '1000-INITIALIZATION'                               02850000
032300                                    TO PV-PARAGRAPH-NAME          02860000
032400         MOVE 'INPUT DATE CONTROL CARD IS EMPTY'                  02870003
032500                                    TO PV-OPERATION-MSG-1         02880000
032600         SET AC-FILE-SEQUENCE-ERROR TO TRUE                       02890000
032700         PERFORM 9999-ABEND                                       02900000
           ELSE                                                         02901003
104900         WRITE MISSING-TRANS-RECORD                               02902003
105000              FROM MTR-COLUMN-HEADINGS                            02903003
033100         PERFORM 1100-DATE-ROUTINE                                02904003
033200         PERFORM 1200-OPEN-MTR-CURSOR                             02905003
033300         PERFORM 2100-FETCH-MTR-CURSOR                            02906003
032800     END-IF.                                                      02910000
032900                                                                  02920003
033600*---------------------------------------------------------------  03010000
033700* INITIALIZE THE CALL PARAMETERS, SET THE DATE INDICATORS,        03020000
033800* MOVE THE YEAR AND PERIOD TO THE INPUT AREA, AND CALL THE        03030000
033900* ROUTINE AND CHECK FOR ERRORS.                                   03040000
034000*---------------------------------------------------------------  03050000
034100 1100-DATE-ROUTINE.                                               03060000
034200                                                                  03070000
034300     INITIALIZE DPG51 DPG52 DPG53 DPG54 DPG55 DPG56.              03080000
034400                                                                  03090004
034500     SET  DPG51-ACTUAL-CALENDAR-ONLY  TO TRUE.                    03141004
034600     SET  DPG51-DECREMENT-DATE        TO TRUE.                    03142004
034700     SET  DPG52-LK-DTE-ISO-FMT        TO TRUE.                    03143004
034800     MOVE INPUT-CONTROL-DATE          TO DPG52-LK-DATE-INPUT.     03144004
071000     MOVE 41                          TO DPG51-INCR-DECR-DAYS-9.  03144114
034900                                                                  03145004
035000     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03150000
035100                                             DPG54 DPG55 DPG56.   03160000
035200     EVALUATE TRUE                                                03170000
035300         WHEN DPG54-SEVERE-ERROR                                  03180000
035400         WHEN DPG54-DATE-INVALID                                  03190000
035500             MOVE '1100-DATE-ROUTINE'                             03200000
035600                                       TO PV-PARAGRAPH-NAME       03210000
035700             MOVE 'ERROR CONVERTING INPUT CARD DATE'              03220000
035800                                       TO PV-OPERATION-MSG-1      03230000
035900             SET AC-CALENDAR-ROUTINE-ERROR                        03240000
036000                                       TO TRUE                    03250000
036100             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      03260000
036200             MOVE DPG54-ERROR-MESSAGE  TO PV-OPERATION-MSG-2      03270000
036300             PERFORM 9999-ABEND                                   03280000
036400     END-EVALUATE.                                                03290000
036500                                                                  03291004
012900     SET PS-VALID-INPUT-DATE          TO TRUE.                    03292014
072700     MOVE DPG55-DB2-ISO-DATE-FMT      TO PV-START-DATE.           03352114
072700     MOVE INPUT-CONTROL-DATE          TO PV-END-DATE.             03352214
                                                                        03352325
           MOVE PV-START-DATE(6:2)          TO PV-FTP-START-MM.         03352425
           MOVE PV-START-DATE(9:2)          TO PV-FTP-START-DD.         03352525
           MOVE PV-END-DATE(6:2)            TO PV-FTP-END-MM.           03352625
           MOVE PV-END-DATE(9:2)            TO PV-FTP-END-DD.           03352725
                                                                        03353825
036900     DISPLAY 'PV-START-DATE - ' PV-START-DATE                     03353925
037000     DISPLAY 'PV-END-DATE --- ' PV-END-DATE.                      03354014
037100                                                                  03360000
037200*---------------------------------------------------------------  03370000
037300* OPEN MTR CURSOR AND CHECK FOR ERRORS                            03380008
037400*---------------------------------------------------------------  03390000
037500 1200-OPEN-MTR-CURSOR.                                            03400002
037600                                                                  03410000
037700     EXEC SQL                                                     03420000
037800          OPEN MTR-CURSOR                                         03430002
037900     END-EXEC.                                                    03440000
038000                                                                  03450000
038100     EVALUATE TRUE                                                03460000
038200         WHEN SQLCODE = ZERO                                      03470000
038300              CONTINUE                                            03480000
038400         WHEN SQLWARN0 NOT EQUAL SPACE                            03490000
038500         WHEN SQLCODE NOT EQUAL ZERO                              03500000
038600              MOVE '1200-OPEN-MTR-CURSOR'                         03510002
038700                                 TO PV-PARAGRAPH-NAME             03520000
038800              MOVE 'ERROR ON OPEN OF MTR-CURSOR'                  03530002
038900                                 TO PV-DB2-OPERATION              03540000
039000              SET AC-CURSOR-OPEN TO TRUE                          03550000
039100              PERFORM 9800-SQL-ABEND                              03560000
039200     END-EVALUATE.                                                03570000
039300                                                                  03581008
039400*---------------------------------------------------------------  03590000
039600* WRITE ROW TO MISSING-TRANS-FILE; PERFORM FETCH TO GET           03600001
039700* ANOTHER ROW FROM THE CURSOR;                                    03610000
040000*---------------------------------------------------------------  03620000
040100 2000-PROCESS-MISSING-TRAN-RPT.                                   03630004
040200                                                                  03640000
041400     MOVE EPTRN-TRN-NBR          TO MTR-TRN-COUNT.                03670042
041600     MOVE EPTRN-SLS-DTE          TO MTR-SALES-DATE.               03671042
083420     MOVE EPTRN-STR-NBR          TO MTR-STORE-NBR.                03672042
083420     MOVE EPTRN-RGST-ID          TO MTR-RGST-ID.                  03673142
083420     MOVE EPTRN-TRN-TYP-CDE      TO MTR-TRN-TYP-CDE.              03674042
                                                                        03720000
044900     PERFORM 9000-WRITE-EXTRACT-RECORDS.                          03730000
045100     MOVE ZEROES TO MTR-TRN-COUNT.                                03740004
                                                                        03750000
081800     PERFORM 2100-FETCH-MTR-CURSOR.                               03760002
039300                                                                  03761008
                                                                        03771115
      *---------------------------------------------------------------  03771232
      * WRITE THE FTP COMMANDS TO THE FTP FILE FOR SALES AUDIT;         03771332
      *---------------------------------------------------------------  03771532
       2020-CREATE-FTP-FILE-SA.                                         03771632
                                                                        03774424
           INITIALIZE PV-FTP-REC.                                       03774824
           STRING                                                       03774924
      *        'PUT '                          DELIMITED BY SIZE,       03775044
      *         PC-QUOTE                       DELIMITED BY SIZE,       03775144
      *        'PKMO.SA.MSNG.TRAN.RPT'         DELIMITED BY SIZE,       03775244
      *         PC-QUOTE                       DELIMITED BY SIZE,       03775344
               ' SET %DIR4 = %DIR3 + '         DELIMITED BY SIZE,       03775644
               'MISSING_TRANSACTION_RPT_'      DELIMITED BY SIZE,       03775744
                PV-FTP-START-DATE              DELIMITED BY SIZE,       03775825
               '_TO_'                          DELIMITED BY SIZE,       03775924
                PV-FTP-END-DATE                DELIMITED BY SIZE,       03776025
               '.CSV'                          DELIMITED BY SIZE        03776124
              INTO                                                      03776224
                  PV-FTP-REC.                                           03777024
           PERFORM 9020-WRITE-FTP-SA-RECORDS.                           03777334
                                                                        03784732
                                                                        03785532
082000*FETCHHERE                                                        03786032
082100*---------------------------------------------------------------  03790000
082200* FETCH THE MTR CURSOR AND CHECK FOR ERRORS                       03800008
082300*---------------------------------------------------------------  03810000
082400 2100-FETCH-MTR-CURSOR.                                           03820002
082500                                                                  03830000
082600     EXEC SQL                                                     03840000
082700          FETCH MTR-CURSOR                                        03850002
                 INTO :EPTRN-TRN-NBR                                    03860004
                     ,:EPTRN-SLS-DTE                                    03861002
                     ,:EPTRN-STR-NBR                                    03862002
                     ,:EPTRN-RGST-ID                                    03863002
                     ,:EPTRN-TRN-TYP-CDE                                03870004
083300     END-EXEC.                                                    03900000
                                                                        03910000
083500     EVALUATE TRUE                                                03930000
083600         WHEN SQLCODE = ZERO                                      03940000
083700             ADD 1                  TO PV-MTR-CURSOR-COUNT        04000002
083800         WHEN SQLCODE = PC-ROW-NOT-FOUND                          04010000
083900             SET PS-END-OF-MTR-CURSOR                             04020002
084000                                     TO TRUE                      04030000
084100         WHEN SQLWARN0 NOT EQUAL SPACE                            04040000
084200         WHEN SQLCODE NOT EQUAL ZERO                              04050000
084300             MOVE '2100-FETCH-MTR-CURSOR'                         04060002
084400                                     TO PV-PARAGRAPH-NAME         04070000
084500             MOVE SQLCODE            TO PV-DB2-OPERATION          04080000
084900             SET AC-CURSOR-FETCH     TO TRUE                      04090000
085000             PERFORM 9800-SQL-ABEND                               04100000
085100     END-EVALUATE.                                                04110000
                                                                        04111008
099000*---------------------------------------------------------------  04130000
099100* CLOSES FISCAL MONTH INPUT FILE, ECOMM RETURN EXTRACT FILE, AND  04140000
099200* ECOMM CURSOR                                                    04150000
099300*---------------------------------------------------------------  04160000
099400 8000-END-OF-JOB.                                                 04170000
100000     CLOSE DATE-FILE.                                             04180001
100100     CLOSE MISSING-TRANS-FILE.                                    04190001
100100     CLOSE MISSING-TRANS-FTP-SA.                                  04192032
100200                                                                  04200000
100300     PERFORM 8100-CLOSE-MTR-CURSOR.                               04210002
100400                                                                  04220000
100500     DISPLAY '****************************************'           04230000
100600     DISPLAY '*************** SAKUT112 ***************'           04240001
100700     DISPLAY '****************************************'           04250000
100800     MOVE PV-MTR-CURSOR-COUNT TO PV-EDIT-MASK                     04260002
100900     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04270000
101000     DISPLAY 'RETURN COUNT ROWS FETCHED......'                    04280000
101100         PV-EDIT-MASK                                             04290000
101200     MOVE PV-RECORDS-WRITTEN     TO PV-EDIT-MASK                  04300000
101300     INSPECT PV-EDIT-MASK REPLACING LEADING SPACE BY '.'          04310000
101400     DISPLAY 'EXTRACT RECORDS WRITTEN........'                    04320000
101500         PV-EDIT-MASK                                             04330000
101600     DISPLAY '****************************************'           04340000
101700     DISPLAY '****************************************'           04350000
101800     DISPLAY '****************************************'.          04360000
101900                                                                  04370000
102000     MOVE ZERO                   TO RETURN-CODE.                  04380000
102100                                                                  04390000
102200*---------------------------------------------------------------  04400000
102300* CLOSE THE ECOMM CURSOR AND CHECK FOR ERRORS                     04410000
102400*---------------------------------------------------------------  04420000
102500 8100-CLOSE-MTR-CURSOR.                                           04430002
102600                                                                  04440000
102700     EXEC SQL                                                     04450000
102800          CLOSE MTR-CURSOR                                        04460002
102900     END-EXEC.                                                    04470000
103000                                                                  04480000
103100     EVALUATE TRUE                                                04490000
103200         WHEN SQLCODE = ZERO                                      04500000
103300              CONTINUE                                            04510000
103400         WHEN SQLWARN0 NOT EQUAL SPACE                            04520000
103500         WHEN SQLCODE NOT EQUAL ZERO                              04530000
103600             MOVE '8100-CLOSE-MTR-CURSOR'                         04540002
103700                                 TO PV-PARAGRAPH-NAME             04550000
103800             MOVE 'ERROR ON CLOSE OF MTR-CURSOR'                  04560002
103900                                 TO PV-DB2-OPERATION              04570000
104000             SET AC-CURSOR-CLOSE TO TRUE                          04580000
104100             PERFORM 9800-SQL-ABEND                               04590000
104200     END-EVALUATE.                                                04600000
104300                                                                  04610000
104400*---------------------------------------------------------------  04620000
104500* THIS MODULE WRITES THE OUTPUT FILE RECORD                       04630000
104600*---------------------------------------------------------------  04640000
104700 9000-WRITE-EXTRACT-RECORDS.                                      04650000
104800                                                                  04660000
104900     WRITE MISSING-TRANS-RECORD                                   04670001
105000         FROM MTR-DETAIL-RECORD.                                  04680002
105100                                                                  04690000
105200     ADD 1 TO PV-RECORDS-WRITTEN.                                 04700000
105300                                                                  04710000
104400*---------------------------------------------------------------  04719115
104500* THIS MODULE WRITES THE OUTPUT FTP FILE RECORD FOR SALES AUDIT   04719232
104600*---------------------------------------------------------------  04719315
104700 9020-WRITE-FTP-SA-RECORDS.                                       04719432
                                                                        04719515
           WRITE MISSING-TRANS-FTP-SA-REC                               04719832
               FROM PV-FTP-REC.                                         04719917
                                                                        04721115
105400*---------------------------------------------------------------  04722000
105500* 9800-SQL-ABEND                                                  04730000
105600* ABEND PROGRAM WHEN A WARNING OR SQL ERROR CODE OCCURS           04740000
105700*---------------------------------------------------------------  04750000
105800 9800-SQL-ABEND.                                                  04760000
105900     DISPLAY '** ABEND     **'.                                   04770000
106000     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                04780000
106100     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04790000
106200     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               04800000
106600                                                                  04810000
106700     COPY DPPD004.                                                04820000
106800     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04830000
106900                                                                  04840000
107000*---------------------------------------------------------------  04850000
107100* 9999-ABEND                                                      04860000
107200* ABEND PROGRAM WHEN AN ERROR OCCURS                              04870000
107300*---------------------------------------------------------------  04880000
107400 9999-ABEND.                                                      04890000
107500     DISPLAY '** ABEND     **'.                                   04900000
107600     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                04910000
107700     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04920000
107800     DISPLAY '** OPERATION ** = ' PV-OPERATION-MSG-1.             04930000
107900     DISPLAY '**           ** = ' PV-OPERATION-MSG-2.             04940000
108000                                                                  04950000
108100     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         04960000
