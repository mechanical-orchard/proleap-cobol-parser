000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400                                                                  00040001
000500 PROGRAM-ID.    SUKUT074.                                         00050001
000600 AUTHOR.        TOM BOYD                                          00060001
000700 INSTALLATION.  KOHLS.                                            00070001
000800 DATE-WRITTEN   JULY 2002.                                        00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100******************************************************************00110001
001200*  THIS PROGRAM CREATES AN EXTRACT FILE OF DATA FROM THE          00120001
001300*  SUT_TRIP_SUM (SUT00007) TABLE                                  00130015
001400******************************************************************00140001
001500                                                                  00150001
001600******************************************************************00160001
001700 ENVIRONMENT DIVISION.                                            00170001
001800******************************************************************00180001
001900                                                                  00190001
002000 CONFIGURATION SECTION.                                           00200001
002100                                                                  00210001
002200 SOURCE-COMPUTER.        IBM-3090.                                00220001
002300 OBJECT-COMPUTER.        IBM-3090.                                00230001
002400                                                                  00240001
002500 INPUT-OUTPUT SECTION.                                            00250001
002600                                                                  00260001
002700 FILE-CONTROL.                                                    00270001
002800                                                                  00280001
002900                                                                  00290001
003000     SELECT SUT-TRIP-SUM-FILE                                     00300001
003100         ASSIGN TO OUT04.                                         00310016
003200                                                                  00320001
003300******************************************************************00330042
003400 DATA DIVISION.                                                   00340043
003500******************************************************************00350043
003600                                                                  00360043
003700 FILE SECTION.                                                    00370043
003800                                                                  00380043
003900 FD  SUT-TRIP-SUM-FILE                                            00390043
004000     RECORDING MODE IS F                                          00400043
004100     LABEL RECORDS ARE STANDARD                                   00410043
004200     BLOCK CONTAINS 0 RECORDS.                                    00420043
004300                                                                  00430043
004400 01  SUT-TRIP-SUM-REC          PIC  X(50).                        00440043
004500                                                                  00450043
004600*                                                                 00460043
004700******************************************************************00470043
004800 WORKING-STORAGE SECTION.                                         00480043
004900******************************************************************00490043
005000*                                                                 00500043
005100*                                                                 00510043
005200*                                                                 00520043
005300******************************************************************00530043
005400*  DB2 FORMATTED MESSAGE AREA                                     00540043
005500******************************************************************00550043
005600     COPY DPWS004.                                                00560043
005700*                                                                 00570043
005800******************************************************************00580043
005900*  COMMUNICATIONS AREA FOR DB2                                    00590043
006000******************************************************************00600043
006100     EXEC SQL                                                     00610043
006200          INCLUDE SQLCA                                           00620043
006300     END-EXEC.                                                    00630043
006400*                                                                 00640043
006500******************************************************************00650043
006600*  COBOL DECLARATION AND DCLGEN MEMBER FOR THE SUT TRIP SUMMARY   00660043
006700*  TABLE                                                          00670043
006800******************************************************************00680043
006900     EXEC SQL                                                     00690043
007000          INCLUDE SUT00007                                        00700043
007100     END-EXEC.                                                    00710043
007200*                                                                 00720043
007300 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00730043
007400                                                   COMP SYNC.     00740043
007500                                                                  00750043
007600 01  PS-PROGRAM-SWITCHES.                                         00760043
007700     05  PS-EOF-TRIP-ID-CNT-SW       PIC  X(01)    VALUE 'N'.     00770043
007800         88  PS-EOF-TRIP-ID-CNT                    VALUE 'Y'.     00780043
007900         88  PS-MORE-TRIP-ID-CNT                   VALUE 'N'.     00790043
008000     05  PS-EOF-SPEC-TRIP-ID-SW      PIC  X(01)    VALUE 'N'.     00800043
008100         88  PS-EOF-SPEC-TRIP-ID                   VALUE 'Y'.     00810043
008200         88  PS-MORE-SPEC-TRIP-ID                  VALUE 'N'.     00820043
008300                                                                  00830043
008400 01  PC-PROGRAM-CONSTANTS.                                        00840043
008500     05  PC-ROW-NOT-FOUND            PIC S9(04)    VALUE +100     00850043
008600                                                   COMP SYNC.     00860043
008700     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00870043
008800         'SUKUT074'.                                              00880043
008900                                                                  00890043
009000 01  PV-PROGRAM-VARIABLES.                                        00900043
009100     05  PV-CLOSE-COUNTER            PIC S9(04)    VALUE ZERO     00910043
009200                                                   COMP SYNC.     00920043
009300     05  PV-FETCH-COUNTER            PIC S9(04)    VALUE ZERO     00930043
009400                                                   COMP SYNC.     00940043
009500     05  PV-WRITE-COUNTER            PIC S9(09)    VALUE ZERO     00950043
009600                                                   COMP SYNC.     00960043
009700     05  PV-WRITE2-COUNTER           PIC S9(09)    VALUE ZERO     00970043
009800                                                   COMP SYNC.     00980043
009900     05  PV-DISPLAY-COUNT            PIC ZZZ,ZZZ,ZZ9.             00990043
010000     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  01000043
010100     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  01010043
010200                                                                  01020043
010300     05  PV-OTBND-TRIP-ID            PIC S9(09)    COMP.          01030043
010400     05  PV-TRIP-ID-COUNT            PIC S9(04)    VALUE ZERO     01040043
010500                                                   COMP.          01050043
010600*                                                                 01060043
010700*  CURSOR DECLARATION FOR OTBND-TRIP-ID-CNT-CUR                   01070043
010800*                                                                 01080043
010900                                                                  01090043
011000     EXEC SQL                                                     01100043
011100          DECLARE TRIP-ID-CNT-CUR CURSOR FOR                      01110043
011200              SELECT OTBND_TRIP_ID, COUNT(*)                      01120043
011300              FROM SUT_TRIP_SUM                                   01130043
011400              GROUP BY OTBND_TRIP_ID                              01140043
011500              HAVING COUNT(*) > 1                                 01150043
011600     END-EXEC.                                                    01160043
011700                                                                  01170043
011800*                                                                 01180043
011900*  CURSOR DECLARATION FOR SPEC-TRIP-ID-CUR CURSOR                 01190043
012000*                                                                 01200043
012100                                                                  01210043
012200     EXEC SQL                                                     01220043
012300         DECLARE SPEC-TRIP-ID-CUR CURSOR FOR                      01230043
012400             SELECT  TRIP_OCRNC_ID                                01240043
012500                   , OTBND_TRIP_ID                                01250043
012600                   , CRE_TMST                                     01260043
012700                   , UNT_QTY                                      01270043
012800                   , SKU_QTY                                      01280043
012900                   , CART_QTY                                     01290043
013000                   , RTL_DOL_AMT                                  01300043
013100                   , COST_DOL_AMT                                 01310043
013200             FROM SUT_TRIP_SUM                                    01320043
013300             WHERE OTBND_TRIP_ID = :PV-OTBND-TRIP-ID              01330043
013400             ORDER BY CRE_TMST DESC                               01340043
013500    END-EXEC.                                                     01350043
013600/                                                                 01360043
013700                                                                  01370043
013800 PROCEDURE DIVISION.                                              01380043
013900******************************************************************01390043
014000 0000-PROGRAM-MAINLINE.                                           01400043
014100******************************************************************01410043
014200*                                                                 01420043
014300                                                                  01430043
014400     PERFORM 1000-INITIALIZE.                                     01440043
014500                                                                  01450043
014600     PERFORM                                                      01460043
014700        UNTIL PS-EOF-TRIP-ID-CNT                                  01470043
014800        IF PS-MORE-TRIP-ID-CNT                                    01480043
014900           PERFORM 2000-PROCESS-TRIP-IDS                          01490043
015000           PERFORM 8200-FETCH-TRIP-ID-CNT-CUR                     01500043
015100        END-IF                                                    01510043
015200     END-PERFORM.                                                 01520043
015300                                                                  01530043
015400     DISPLAY ' EXTRACTS WRITTEN = ' PV-WRITE-COUNTER.             01540043
015410                                                                  01541043
015420     CLOSE SUT-TRIP-SUM-FILE.                                     01542043
015430     PERFORM 8500-CLOSE-TRIP-ID-CNT-CUR.                          01543043
015440     GOBACK.                                                      01544043
015500/                                                                 01550043
015600******************************************************************01560043
015700 1000-INITIALIZE.                                                 01570043
015800******************************************************************01580043
015900     OPEN OUTPUT SUT-TRIP-SUM-FILE.                               01590043
016000     PERFORM 8000-OPEN-TRIP-ID-CNT-CUR.                           01600043
016100     PERFORM 8200-FETCH-TRIP-ID-CNT-CUR.                          01610043
016200                                                                  01620043
016300/                                                                 01630043
016400******************************************************************01640043
016500 2000-PROCESS-TRIP-IDS.                                           01650043
016600******************************************************************01660043
016700* OPEN SPEC-TRIP-ID-CUR                                           01670043
016800* FETCH 1ST RECORD BUT DO NOT WRITE TO FILE(MOST RECENT OCCURANCE)01680043
016900* CONTINUE FETCHING RECORDS                                       01690043
017000* WRITE TO FILE UNTIL PV-TRIP-ID-COUNT OR PS-EOF-SPEC-TRIP-ID     01700043
017100* CLOSE SPEC-TRIP-ID-CUR                                          01710043
017200                                                                  01720043
017300     IF PS-MORE-SPEC-TRIP-ID                                      01730043
017400                                                                  01740043
017500        PERFORM 8100-OPEN-SPEC-TRIP-ID-CUR                        01750043
017600                                                                  01760043
017700        PERFORM WITH TEST BEFORE                                  01770043
017800          VARYING PV-FETCH-COUNTER FROM 1 BY 1                    01780043
017900            UNTIL (PV-FETCH-COUNTER > PV-TRIP-ID-COUNT            01790043
018000                   OR PS-EOF-SPEC-TRIP-ID)                        01800043
018100                                                                  01810043
018200               PERFORM 8300-FETCH-SPEC-TRIP-ID                    01820043
018300               IF PV-FETCH-COUNTER EQUAL 1                        01830043
018400                  CONTINUE                                        01840043
018500               ELSE                                               01850043
018600                  PERFORM 7000-WRITE-TRIP-SUM-RECORD              01860043
018700               END-IF                                             01870043
018800                                                                  01880043
018900        END-PERFORM                                               01890043
019000                                                                  01900043
019100        PERFORM 8400-CLOSE-SPEC-TRIP-ID-CUR                       01910043
019200     END-IF.                                                      01920043
019300/                                                                 01930043
019400******************************************************************01940043
019500 7000-WRITE-TRIP-SUM-RECORD.                                      01950043
019600******************************************************************01960043
019700                                                                  01970043
019800      INITIALIZE SUT-TRIP-SUM-REC.                                01980043
019900      WRITE SUT-TRIP-SUM-REC                                      01990043
020000          FROM DCLSUT00007.                                       02000043
020100      ADD +1 TO PV-WRITE-COUNTER.                                 02010043
020200                                                                  02020043
020300/                                                                 02030043
020400******************************************************************02040043
020500 8000-OPEN-TRIP-ID-CNT-CUR.                                       02050043
020600******************************************************************02060043
020700                                                                  02070043
020800         EXEC SQL                                                 02080043
020900              OPEN TRIP-ID-CNT-CUR                                02090043
021000         END-EXEC                                                 02100043
021100                                                                  02110043
021200         EVALUATE TRUE                                            02120043
021300*            WHEN SQLCODE = -904                                  02130043
021400*            WHEN SQLCODE = -911                                  02140043
021500*                CONTINUE                                         02150043
021600             WHEN SQLWARN0 NOT = SPACES                           02160043
021700             WHEN SQLCODE < ZERO                                  02170043
021800             WHEN SQLCODE > ZERO                                  02180043
021900                 MOVE '8000-OPEN-TRIP-ID-CNT-CUR'                 02190043
022000                                 TO PV-PARAGRAPH-NAME             02200043
022100                 MOVE 'OPEN THE TRIP-ID-CNT-CUR '                 02210043
022200                                 TO PV-DB2-OPERATION-ATTEMPTED    02220043
022300                 PERFORM 9100-SQL-ABEND                           02230043
022400             WHEN SQLCODE = ZERO                                  02240043
022500                 CONTINUE                                         02250014
022600         END-EVALUATE.                                            02260014
022700/                                                                 02270014
022800******************************************************************02280014
022900 8100-OPEN-SPEC-TRIP-ID-CUR.                                      02290014
023000******************************************************************02300014
023100                                                                  02310014
023200         EXEC SQL                                                 02320014
023300              OPEN SPEC-TRIP-ID-CUR                               02330014
023400         END-EXEC                                                 02340014
023500                                                                  02350014
023600         EVALUATE TRUE                                            02360014
023700*            WHEN SQLCODE = -904                                  02370041
023800*            WHEN SQLCODE = -911                                  02380041
023900*                CONTINUE                                         02390041
024000             WHEN SQLWARN0 NOT = SPACES                           02400014
024100             WHEN SQLCODE < ZERO                                  02410014
024200             WHEN SQLCODE > ZERO                                  02420014
024300                 MOVE '8100-OPEN-SPEC-TRIP-ID-CUR    '            02430014
024400                                 TO PV-PARAGRAPH-NAME             02440014
024500                 MOVE 'OPEN THE SPEC-TRIP-ID-CUR    '             02450014
024600                                 TO PV-DB2-OPERATION-ATTEMPTED    02460014
024700                 PERFORM 9100-SQL-ABEND                           02470014
024800             WHEN SQLCODE = ZERO                                  02480014
024900                 CONTINUE                                         02490014
025000         END-EVALUATE.                                            02500014
025100                                                                  02510014
025200/                                                                 02520014
025300                                                                  02530014
025400******************************************************************02540014
025500 8200-FETCH-TRIP-ID-CNT-CUR.                                      02550014
025600******************************************************************02560014
025700     EXEC SQL                                                     02570014
025800         FETCH TRIP-ID-CNT-CUR                                    02580014
025900         INTO   :PV-OTBND-TRIP-ID                                 02590025
026000              , :PV-TRIP-ID-COUNT                                 02600014
026100     END-EXEC.                                                    02610014
026200                                                                  02620014
026300     EVALUATE TRUE                                                02630014
026400         WHEN SQLCODE = ZERO                                      02640014
026500             SET PS-MORE-SPEC-TRIP-ID TO TRUE                     02650021
026600                                                                  02660025
026700         WHEN SQLCODE = +100                                      02670014
026800             SET PS-EOF-TRIP-ID-CNT                               02680014
026900                                 TO TRUE                          02690014
027000         WHEN SQLWARN0 NOT = SPACES                               02700014
027100         WHEN SQLCODE < ZERO                                      02710014
027200         WHEN SQLCODE > ZERO                                      02720014
027300             MOVE '8200-FETCH-TRIP-ID-CNT-CUR     '               02730014
027400                                 TO PV-PARAGRAPH-NAME             02740014
027500             MOVE 'FETCH-TRIP-ID-CNT-CUR          '               02750014
027600                                 TO PV-DB2-OPERATION-ATTEMPTED    02760014
027700             PERFORM 9100-SQL-ABEND                               02770014
027800     END-EVALUATE.                                                02780014
027900/                                                                 02790014
028000                                                                  02800014
028100******************************************************************02810014
028200 8300-FETCH-SPEC-TRIP-ID.                                         02820014
028300******************************************************************02830002
028400                                                                  02840014
028500     EXEC SQL                                                     02850015
028600         FETCH SPEC-TRIP-ID-CUR                                   02860015
028700         INTO   :SUT00007-TRIP-OCRNC-ID                           02870015
028800              , :SUT00007-OTBND-TRIP-ID                           02880028
028900              , :SUT00007-CRE-TMST                                02890015
029000              , :SUT00007-UNT-QTY                                 02900015
029100              , :SUT00007-SKU-QTY                                 02910015
029200              , :SUT00007-CART-QTY                                02920015
029300              , :SUT00007-RTL-DOL-AMT                             02930015
029400              , :SUT00007-COST-DOL-AMT                            02940015
029500     END-EXEC.                                                    02950015
029600                                                                  02960015
029700     EVALUATE TRUE                                                02970015
029800         WHEN SQLCODE = ZERO                                      02980015
029900             CONTINUE                                             02990015
030000         WHEN SQLCODE = +100                                      03000015
030100             SET PS-EOF-SPEC-TRIP-ID                              03010015
030200                                 TO TRUE                          03020015
030300         WHEN SQLWARN0 NOT = SPACES                               03030015
030400         WHEN SQLCODE < ZERO                                      03040015
030500         WHEN SQLCODE > ZERO                                      03050015
030600             MOVE '8300-FETCH-SPEC-TRIP-ID        '               03060015
030700                                 TO PV-PARAGRAPH-NAME             03070015
030800             MOVE 'FETCH-SPEC-TRIP-ID             '               03080015
030900                                 TO PV-DB2-OPERATION-ATTEMPTED    03090015
031000             PERFORM 9100-SQL-ABEND                               03100015
031100     END-EVALUATE.                                                03110015
031200                                                                  03120015
031300/                                                                 03130015
031400                                                                  03140015
031500******************************************************************03150015
031600 8400-CLOSE-SPEC-TRIP-ID-CUR.                                     03160015
031700******************************************************************03170015
031800                                                                  03180015
031900         EXEC SQL                                                 03190015
032000              CLOSE SPEC-TRIP-ID-CUR                              03200015
032100         END-EXEC                                                 03210015
032200                                                                  03220015
032300         EVALUATE TRUE                                            03230015
032400*            WHEN SQLCODE = -904                                  03240042
032500*            WHEN SQLCODE = -911                                  03250042
032600*                CONTINUE                                         03260042
032700             WHEN SQLWARN0 NOT = SPACES                           03270015
032800             WHEN SQLCODE < ZERO                                  03280015
032900             WHEN SQLCODE > ZERO                                  03290015
033000                 MOVE '8400-CLOSE-SPEC-TRIP-ID-CUR    '           03300015
033100                                 TO PV-PARAGRAPH-NAME             03310015
033200                 MOVE 'CLOSE THE SPEC-TRIP-ID-CUR      '          03320015
033300                                 TO PV-DB2-OPERATION-ATTEMPTED    03330015
033400                 PERFORM 9100-SQL-ABEND                           03340015
033500             WHEN SQLCODE = ZERO                                  03350015
033600                 CONTINUE                                         03360015
033700         END-EVALUATE.                                            03370015
033800                                                                  03380015
033900/                                                                 03390015
034000******************************************************************03400015
034100 8500-CLOSE-TRIP-ID-CNT-CUR.                                      03410015
034200******************************************************************03420015
034300                                                                  03430039
034400         EXEC SQL                                                 03440015
034500              CLOSE TRIP-ID-CNT-CUR                               03450015
034600         END-EXEC                                                 03460015
034700                                                                  03470015
034800         EVALUATE TRUE                                            03480015
034900*            WHEN SQLCODE = -904                                  03490042
035000*            WHEN SQLCODE = -911                                  03500042
035100*                CONTINUE                                         03510042
035200             WHEN SQLWARN0 NOT = SPACES                           03520015
035300             WHEN SQLCODE < ZERO                                  03530015
035400             WHEN SQLCODE > ZERO                                  03540015
035500                 MOVE '8500-CLOSE-TRIP-ID-CNT-CUR     '           03550015
035600                                 TO PV-PARAGRAPH-NAME             03560015
035700                 MOVE 'CLOSE THE TRIP-ID-CNT-CUR       '          03570015
035800                                 TO PV-DB2-OPERATION-ATTEMPTED    03580015
035900                 PERFORM 9100-SQL-ABEND                           03590015
036000             WHEN SQLCODE = ZERO                                  03600015
036100                 CONTINUE                                         03610015
036200         END-EVALUATE.                                            03620015
036300                                                                  03630039
037500******************************************************************03750002
037600 9100-SQL-ABEND.                                                  03760002
037700*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    03770002
037800*  ERROR OR WARNING CODE OCCURS.                                  03780002
037900******************************************************************03790002
038000     DISPLAY '9100-SQL-ABEND'.                                    03800002
038100     DISPLAY '** ABEND     **'.                                   03810002
038200     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        03820002
038300     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              03830002
038400     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     03840002
038500                                                                  03850002
038600*    ABEND COPYBOOK                                               03860002
038700     COPY DPPD004.                                                03870002
038800                                                                  03880002
038900     MOVE +4013                  TO ABEND-CODE.                   03890002
039000     CALL 'ILBOABN0' USING ABEND-CODE.                            03900002
039100/                                                                 03910002
