000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         APKRP248.                                    00020000
000300 AUTHOR.             CHRIS BOEHNLEIN.                             00030000
000400 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00040000
000500 DATE-WRITTEN.       04-21-98.                                    00050000
000510                                                                  00051000
000600******************************************************************00060000
000610* COBOL II WITH SQL                                              *00061000
000620*----------------------------------------------------------------*00062000
000630* CREATE MONTHLY SUMMARY IMPORT REPORTS                          *00063000
000640*----------------------------------------------------------------*00064000
000650* THIS PROGRAM PERFORMS DB2 CALLS AGAINST THE LEGACY SYSTEM TO   *00065000
000660* DETERMINE WHAT ENTRIES WERE MADE FOR THE IMPORT PURCHASE       *00066000
000670* ORDERS FROM THE ADJUSTMENT JOURNAL FOR THE PREVIOUS FISCAL     *00067000
000671* MONTH.  THIS PROGRAM FOCUSES SPECIFICALLY ON ACCOUNTS 10301    *00067100
000672* AND 10306.                                                     *00067200
000680*----------------------------------------------------------------*00068000
000690* DB2 TABLES:                                                    *00069000
000691*  1. INVOICE TABLE                            (TINVOIC)         *00069100
000692*  2. AP PAYMENT CONTROL TABLE                 (TAPCNTL)         *00069200
000693*  3. PURCHASE ORDER HEADER TABLE              (TPURCHS)         *00069300
000694*  4. EXTERNAL ENTERPRISE TABLE                (TEXTENT)         *00069400
000695*  5. INVOICE CHARGE/ALLOWANCE TABLE           (TALCHRG)         *00069500
000696*  6. AP CHARGE TYPE TABLE                     (TACCTYP)         *00069600
000697*  7. VENDOR/DEPARTMENT TABLE                  (TVNDDPT)         *00069700
000698*                                                                *00069800
000699* INPUT:                                                         *00069900
000700*  1. DETAIL IMPORT FILE                       (APRD047)         *00070000
000701*  2. DETAIL ACCOUNT IMPORT FILE               (APRD047)         *00070100
000702*                                                                *00070200
000703* OUTPUT:                                                        *00070300
000704*  1. IMPORT PURCHASE ORDERS FILE                                *00070400
000705*  2. MONTHLY SUMMARY IMPORT REPORT                              *00070500
000706*----------------------------------------------------------------*00070600
000707* PROGRAM CHANGES:                                               *00070700
000708*                                                                *00070800
000709* DATE 08/2005                                                   *00070901
000710*   CHANGE MADE: INITIAL IMPLEMENTATION                          *00071001
000715*   MADE BY: KRYSTEN LEARY                WR/IR: WR24554         *00071500
000716*                                                                *00071616
000717* DATE  04/15/2013                                               *00071716
000718*     CHANGE MADE: MODIFIED LOGIC WHERE TRANCODES 68 AND 73 WERE *00071816
000719*     HARD-CODED TO BE REPORTED AS DEBITS TO REMOVE THE HARD-CODE*00071916
000720*     AND REPLACE IT WITH CHECKING THE POSTING TYPE OF 'CHARGE'  *00072016
000721*     TO BE REPORTED AS DEBITS.                                  *00072116
000722*     MADE BY: NANCY EILBES            WR/IR #: CHG0051542       *00072216
000723*                                                                *00072318
000724* DATE 11/2014                                                   *00072418
000725*   CHANGE MADE: CHANGE THE LENGTH OF WS-PO-HOLD VARIABLE TO 9   *00072518
000726*                FROM LENGTH 7.                                  *00072618
000727*   MADE BY: COGNIZANT                       WR/IR: CHG0094517   *00072718
000728*                                                                *00072820
000729* DATE 09/2018                                                   *00072920
000730*   CHANGE MADE: REMOVE COPYBOOK PJRNLEXT. REPLACE REFERENCE     *00073020
000731*                TO PJR-DETAIL-PONUM WITH PV-DISPLAY-PONUM IN    *00073120
000732*                PARAGRAPH S800-READ-DUNNS-NBR                   *00073220
000733*   MADE BY: GERMAN BANDA                    WR/IR: CHG0209715   *00073321
000734*                                                                *00073423
000735* DATE 05/12/2020                                                *00073523
000736*   CHANGE MADE: MODIFIED THE REPORT HEADING TO ACCOMMODATE AN   *00073623
000737*   ACCOUNT DESCRIPTION IN PLACE OF AN ACCOUNT NUMBER. CONTROL   *00073723
000738*   CARDS FEEDING THE REPORT WILL NOW SEND A 15 CHAR DESCRIPTION *00073823
000739*   INSTEAD OF A 5 CHAR ACCOUNT NUMBER.                          *00073923
000740*   MADE BY: NANCY EILBES                    WR/IR: CHG0244277   *00074024
000741******************************************************************00074123
000742                                                                  00074223
000750 ENVIRONMENT DIVISION.                                            00075023
000800 CONFIGURATION SECTION.                                           00080000
000900 SOURCE-COMPUTER.    IBM-3090.                                    00090000
001000 OBJECT-COMPUTER.    IBM-3090.                                    00100000
001100                                                                  00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT DETAIL-IMPORT-FILE-PJ         ASSIGN TO INP01.        00150000
001700     SELECT DETAIL-ACCT-IMPORT-FILE-PJ    ASSIGN TO INP02.        00170000
001900     SELECT WORK-REPORT-FILE              ASSIGN TO OUT01.        00190000
002000     SELECT SUMMARY-REPORT-FILE           ASSIGN TO RPT01.        00200000
002100                                                                  00210000
002200 DATA DIVISION.                                                   00220000
002400 FILE SECTION.                                                    00240000
002500                                                                  00250000
002600 FD  DETAIL-IMPORT-FILE-PJ                                        00260000
002700     RECORDING MODE IS F                                          00270000
002800     LABEL RECORDS ARE STANDARD                                   00280000
002900     RECORD CONTAINS 170 CHARACTERS                               00290000
003000     BLOCK CONTAINS 0  RECORDS                                    00300000
003100     DATA RECORD IS DR-DETAIL-IMPORT-RECORD-PJ.                   00310000
003200 01  DR-IMPORT-RECORD-PJ           PIC X(170).                    00320000
003300                                                                  00330000
003400 FD  DETAIL-ACCT-IMPORT-FILE-PJ                                   00340000
003500     RECORDING MODE IS F                                          00350000
003600     LABEL RECORDS ARE STANDARD                                   00360000
003700     RECORD CONTAINS 170 CHARACTERS                               00370000
003800     BLOCK CONTAINS 0  RECORDS                                    00380000
003900     DATA RECORD IS DR-ACCT-IMPORT-RECORD-PJ.                     00390000
004000 01  DR-ACCT-IMPORT-RECORD-PJ      PIC X(170).                    00400000
004100                                                                  00410000
004200 FD  WORK-REPORT-FILE                                             00420000
004300     RECORDING MODE IS F                                          00430000
004400     LABEL RECORDS ARE STANDARD                                   00440000
004500     RECORD CONTAINS 168 CHARACTERS                               00450000
004600     BLOCK CONTAINS 0  RECORDS                                    00460000
004700     DATA RECORD IS WR-WORK-REPORT-RECORD.                        00470000
004800 01  WR-WORK-REPORT-RECORD         PIC X(168).                    00480000
004801                                                                  00480100
004810 FD  SUMMARY-REPORT-FILE                                          00481000
004820     RECORDING MODE IS F                                          00482000
004830     LABEL RECORDS ARE STANDARD                                   00483000
004850     BLOCK CONTAINS 0  RECORDS.                                   00485000
004870 01  SUMMARY-REPORT-RECORD         PIC X(132).                    00487000
004900                                                                  00490000
005100 WORKING-STORAGE SECTION.                                         00510000
005200*----------------------------------------------------------------*00520000
005210* GL EXTRACT FILE LAYOUT (INPUT)                                 *00521000
005220*----------------------------------------------------------------*00522000
005300     COPY APRD047.                                                00530000
005301                                                                  00530100
005410*----------------------------------------------------------------*00541000
005420* WORKING STORAGE FOR DATE ROUTINE                               *00542000
005430*----------------------------------------------------------------*00543000
005500     COPY DPWS500.                                                00550000
005501                                                                  00550100
005510*----------------------------------------------------------------*00551000
005520* SQLCA FORMATTED MESSAGE AREA                                   *00552000
005530*----------------------------------------------------------------*00553000
005600     COPY DPWS004.                                                00560000
005610                                                                  00561000
005700*----------------------------------------------------------------*00570000
005800* DB2 COMMUNICATION                                              *00580000
005900*----------------------------------------------------------------*00590000
010000     COPY SQLCA2.                                                 01000000
010400                                                                  01040000
010410*----------------------------------------------------------------*01041000
010420* STANDARD HEADER LAYOUT                                         *01042000
010430*----------------------------------------------------------------*01043000
010440     COPY DPWS132O.                                               01044000
010450                                                                  01045000
010460 01  CONTROL-CARD.                                                01046000
010470     05  CC-ACCOUNT              PIC X(15)  VALUE SPACES.         01047022
010480                                                                  01048000
014010 01  PROGRAM-CONSTANTS.                                           01401000
014020     05  PC-PROGRAM-NAME         PIC X(08)  VALUE 'APKRP248'.     01402000
014030     05  PC-MAX-RETRIES          PIC 9(02)  VALUE 3.              01403000
014040                                                                  01404000
014050 01  PROGRAM-COUNTERS.                                            01405000
014060     05  PV-ACCT-READ-CNT        PIC 9(08)  VALUE ZERO.           01406000
014070     05  PV-IMPORT-READ-CNT      PIC 9(08)  VALUE ZERO.           01407000
014080     05  PV-WRITTEN-CNT          PIC 9(08)  VALUE ZERO.           01408000
014090                                                                  01409000
014092 01  PROGRAM-SWITCHES.                                            01409200
014093     05  END-OF-FILE-IMPORT-PJ   PIC X(01)  VALUE 'N'.            01409300
014094         88 END-OF-FILE-IMPORT              VALUE 'Y'.            01409400
014095     05  PS-MORE-TINVOIC         PIC X(01)  VALUE 'N'.            01409500
014096         88 PS-NO-MORE-TINVOIC              VALUE 'Y'.            01409600
014097     05  END-OF-FILE-NO-ACCT     PIC X(01)  VALUE 'N'.            01409700
014098         88 END-OF-FILE-ACCT                VALUE 'Y'.            01409800
014099                                                                  01409900
014100 01  PROGRAM-VARIABLES.                                           01410000
015200     05  PV-RETRY-COUNTER        PIC 9(02)  VALUE ZERO.           01520000
016100     05  PV-FIRST-FISCAL-DATE    PIC X(10)  VALUE SPACES.         01610000
016400     05  PV-LAST-FISCAL-DATE     PIC X(10)  VALUE SPACES.         01640000
016401     05  PV-DISPLAY-PONUM        PIC X(09)  VALUE SPACES.         01640120
016410                                                                  01641000
016420 01  DATE-WORK-AREA.                                              01642000
016430     05  SYSTEM-DATE             PIC 9(06)  VALUE ZERO.           01643000
016440     05  FILLER REDEFINES SYSTEM-DATE.                            01644000
016450         10  SYSTEM-YEAR         PIC 9(02).                       01645000
016460         10  SYSTEM-MONTH        PIC 9(02).                       01646000
016470         10  SYSTEM-DAY          PIC 9(02).                       01647000
016480     05  SYSTEM-TIME             PIC 9(08)  VALUE ZERO.           01648000
016490     05  FILLER REDEFINES SYSTEM-TIME.                            01649000
016491         10  SYSTEM-HOUR         PIC 9(02).                       01649100
016492         10  SYSTEM-MINUTE       PIC 9(02).                       01649200
016493         10  SYSTEM-SECOND       PIC 9(02).                       01649300
016494         10  FILLER              PIC 9(02).                       01649400
016495                                                                  01649500
016500 01  ACCOUNT-TABLE.                                               01650000
016600     05 ACCT-TABLE OCCURS 100000 TIMES INDEXED BY X1.             01660000
016700        10 ACCT-PO               PIC X(09)  VALUE SPACES.         01670000
016800        10 ACCT-DATE             PIC X(10)  VALUE SPACES.         01680000
017100                                                                  01710000
018100 01 WS-WORKING-STORAGE.                                           01810000
018200    05  WS-DB2-ACCOUNT.                                           01820000
018400        10  WS-DB2-ACCT          PIC X(05)  VALUE SPACES.         01840000
018500    05  WS-DB2-ACCOUNT2          PIC X(07)  VALUE SPACES.         01850000
018600    05  WS-DETAIL-PONUM          PIC 9(09)  VALUE ZERO.           01860000
019000    05  WS-DUNNS-NUMBER          PIC X(09)  VALUE SPACES.         01900000
019100    05  WS-DT-PONUM              PIC S9(9)  COMP.                 01910000
019200    05  WS-DM-TOTAL              PIC S9(11)V99 COMP-3 VALUE ZERO. 01920000
019400    05  WS-CM-TOTAL              PIC S9(11)V99 VALUE ZERO COMP-3. 01940000
020100    05  WS-JN-DATE               PIC X(10)  VALUE SPACES.         02010000
020200    05  WS-HD-PO                 PIC 9(07)  VALUE ZEROS.          02020000
020800    05  WS-HD-DATE               PIC X(10)  VALUE SPACES.         02080000
021500    05  WS-INVOIC-PO-NBR         PIC S9(09) COMP.                 02150000
021600    05  WS-HOLD-ACCT             PIC X(07)  VALUE SPACES.         02160000
021700    05  WS-PO-HOLD               PIC 9(09)  VALUE ZEROS.          02170018
021800    05  WS-DEBIT-TOTAL           PIC S9(11)V99 COMP-3 VALUE ZERO. 02180000
022000    05  WS-CREDIT-TOTAL          PIC S9(11)V99 COMP-3 VALUE ZERO. 02200000
022200    05  WS-INV-TOTAL             PIC S9(11)V99 COMP-3 VALUE ZERO. 02220000
022510    05  WS-REQ-ENTR-TRMNL-ID     PIC X(04)  VALUE SPACES.         02251000
022600                                                                  02260000
022610 01 REPORT-CONTROLS.                                              02261000
022620    05  PAGE-COUNT               PIC S9(04) COMP-3 VALUE ZERO.    02262000
022630    05  LINE-COUNT               PIC S9(04) COMP-3 VALUE ZERO.    02263000
022640 01 BLANK-LINE                   PIC X(132) VALUE SPACES.         02264000
022650                                                                  02265000
022660 01 HDR-LINE-1.                                                   02266000
022661    05  FILLER                   PIC X(40)  VALUE SPACES.         02266122
022662    05  FILLER                   PIC X(34)  VALUE                 02266222
022663        'MONTHLY SUMMARY IMPORT REPORT FOR '.                     02266322
022664    05  HDR1-ACCOUNT             PIC X(15)  VALUE SPACES.         02266422
022665    05  FILLER                   PIC X(40)  VALUE SPACES.         02266522
022666                                                                  02266600
022670 01 HDR-LINE-2.                                                   02267000
022671    05  FILLER                   PIC X(45)  VALUE SPACES.         02267100
022672    05  FILLER                   PIC X(15)  VALUE                 02267200
022673        'FOR THE PERIOD '.                                        02267300
022674    05  HDR2-START-MM            PIC X(02)  VALUE SPACES.         02267400
022675    05  FILLER                   PIC X(01)  VALUE '-'.            02267500
022676    05  HDR2-START-DD            PIC X(02)  VALUE SPACES.         02267600
022677    05  FILLER                   PIC X(01)  VALUE '-'.            02267700
022678    05  HDR2-START-YYYY          PIC X(04)  VALUE SPACES.         02267800
022679    05  FILLER                   PIC X(09)  VALUE ' THROUGH '.    02267900
022680    05  HDR2-END-MM              PIC X(02)  VALUE SPACES.         02268000
022681    05  FILLER                   PIC X(01)  VALUE '-'.            02268100
022682    05  HDR2-END-DD              PIC X(02)  VALUE SPACES.         02268200
022683    05  FILLER                   PIC X(01)  VALUE '-'.            02268300
022684    05  HDR2-END-YYYY            PIC X(04)  VALUE SPACES.         02268400
022685    05  FILLER                   PIC X(43)  VALUE SPACES.         02268500
022686                                                                  02268600
022690 01 HDR-LINE-3.                                                   02269000
022800    05  FILLER                   PIC X(01)  VALUE SPACES.         02280000
022900    05  FILLER                   PIC X(07)  VALUE 'ACCOUNT'.      02290000
023000    05  FILLER                   PIC X(02)  VALUE SPACES.         02300000
023100    05  FILLER                   PIC X(10)  VALUE 'VENDOR NBR'.   02310000
023200    05  FILLER                   PIC X(02)  VALUE SPACES.         02320000
023300    05  FILLER                   PIC X(06)  VALUE 'PO NBR'.       02330000
023400    05  FILLER                   PIC X(08)  VALUE SPACES.         02340000
023410    05  FILLER                   PIC X(09)  VALUE 'DEBIT AMT'.    02341000
023420    05  FILLER                   PIC X(05)  VALUE SPACES.         02342000
023430    05  FILLER                   PIC X(10)  VALUE 'DEBIT DATE'.   02343000
023440    05  FILLER                   PIC X(04)  VALUE SPACES.         02344000
023450    05  FILLER                   PIC X(10)  VALUE 'CREDIT AMT'.   02345000
023460    05  FILLER                   PIC X(03)  VALUE SPACES.         02346000
023470    05  FILLER                   PIC X(11)  VALUE 'CREDIT DATE'.  02347000
023480    05  FILLER                   PIC X(02)  VALUE SPACES.         02348000
023490    05  FILLER                   PIC X(09)  VALUE 'JRNL DATE'.    02349000
023491    05  FILLER                   PIC X(04)  VALUE SPACES.         02349100
023492    05  FILLER                   PIC X(11)  VALUE 'INVOICE AMT'.  02349200
023493    05  FILLER                   PIC X(04)  VALUE SPACES.         02349300
023494    05  FILLER                   PIC X(12)  VALUE 'REVERSAL AMT'. 02349400
023495    05  FILLER                   PIC X(02)  VALUE SPACES.         02349505
023500                                                                  02350000
024400 01 DH-DETAIL-LINE1.                                              02440000
024500    05  FILLER                   PIC X(01)  VALUE SPACES.         02450000
024600    05  DH-ACCOUNT               PIC X(07)  VALUE SPACES.         02460000
024700    05  FILLER                   PIC X(02)  VALUE SPACES.         02470000
024800    05  DH-PO-DUNNS              PIC X(09)  VALUE SPACES.         02480000
024900    05  FILLER                   PIC X(03)  VALUE SPACES.         02490000
025000    05  DH-PO-NUMBER             PIC X(10)  VALUE SPACES.         02500000
025100    05  FILLER                   PIC X(02)  VALUE SPACES.         02510000
025200    05  DH-DEBIT-TOTAL           PIC ---,---,---.99.              02520000
025300    05  FILLER                   PIC X(02)  VALUE SPACES.         02530000
025400    05  DH-DM-MONTH              PIC 9(02)  VALUE ZEROS.          02540000
025500    05  FILLER                   PIC X(01)  VALUE '-'.            02550000
025600    05  DH-DM-DAY                PIC 9(02)  VALUE ZEROS.          02560000
025700    05  FILLER                   PIC X(01)  VALUE '-'.            02570000
025800    05  DH-DM-YEAR               PIC 9(02)  VALUE ZEROS.          02580000
025900    05  FILLER                   PIC X(04)  VALUE SPACES.         02590000
026000    05  DH-CREDIT-TOTAL          PIC ---,---,---.99.              02600000
026100    05  FILLER                   PIC X(02)  VALUE SPACES.         02610000
026200    05  DH-CM-MONTH              PIC 9(02)  VALUE ZEROS.          02620000
026300    05  FILLER                   PIC X(01)  VALUE '-'.            02630000
026400    05  DH-CM-DAY                PIC 9(02)  VALUE ZEROS.          02640000
026500    05  FILLER                   PIC X(01)  VALUE '-'.            02650000
026600    05  DH-CM-YEAR               PIC 9(02)  VALUE ZEROS.          02660000
026700    05  FILLER                   PIC X(04)  VALUE SPACES.         02670000
026800    05  DH-JN-MONTH              PIC 9(02)  VALUE ZEROS.          02680000
026900    05  FILLER                   PIC X(01)  VALUE '-'.            02690000
027000    05  DH-JN-DAY                PIC 9(02)  VALUE ZEROS.          02700000
027100    05  FILLER                   PIC X(01)  VALUE '-'.            02710000
027200    05  DH-JN-YEAR               PIC 9(02)  VALUE ZEROS.          02720000
027300    05  FILLER                   PIC X(03)  VALUE SPACES.         02730000
027400    05  DH-INV                   PIC ---,---,---.99.              02740000
027500    05  FILLER                   PIC X(02)  VALUE SPACES.         02750000
027600    05  DH-PPR                   PIC ---,---,---.99.              02760000
027601    05  FILLER                   PIC X(01)  VALUE SPACE.          02760105
027610                                                                  02761003
027700 01 EOR-END-OF-REPORT.                                            02770003
027710    05  FILLER                   PIC X(54)  VALUE SPACES.         02771005
027720    05  FILLER                   PIC X(25)  VALUE                 02772003
027730        '**** END OF REPORT *****'.                               02773003
027740    05  FILLER                   PIC X(53)  VALUE SPACES.         02774005
027750                                                                  02775003
027800 01 DT-HOLD-TOTAL.                                                02780000
027900    05  DT-ACCOUNT               PIC X(07)  VALUE SPACES.         02790000
028000    05  DT-PO-DUNNS              PIC X(09)  VALUE SPACES.         02800000
028100    05  DT-PO-NUMBER             PIC 9(09)  VALUE ZEROS.          02810000
028200    05  DT-DEBIT-TOTAL           PIC S9(12)V99 VALUE ZEROS.       02820000
028300    05  DT-DM-MONTH              PIC 9(02)  VALUE ZEROS.          02830000
028400    05  DT-DM-DAY                PIC 9(02)  VALUE ZEROS.          02840000
028500    05  DT-DM-YEAR               PIC 9(02)  VALUE ZEROS.          02850000
028600    05  DT-CREDIT-TOTAL          PIC S9(12)V99 VALUE ZEROS.       02860000
028700    05  DT-CM-MONTH              PIC 9(02)  VALUE ZEROS.          02870000
028800    05  DT-CM-DAY                PIC 9(02)  VALUE ZEROS.          02880000
028900    05  DT-CM-YEAR               PIC 9(02)  VALUE ZEROS.          02890000
029000    05  DT-JN-MONTH              PIC 9(02)  VALUE ZEROS.          02900000
029100    05  DT-JN-DAY                PIC 9(02)  VALUE ZEROS.          02910000
029200    05  DT-JN-YEAR               PIC 9(02)  VALUE ZEROS.          02920000
029300    05  DT-INV                   PIC S9(12)V99 VALUE ZEROS.       02930000
029400    05  DT-PPR                   PIC S9(12)V99 VALUE ZEROS.       02940000
029500                                                                  02950000
029600 01 HH-HOLD-DATE.                                                 02960000
029700    05  HH-DM-MONTH              PIC 9(02)  VALUE ZEROS.          02970000
029800    05  HH-DM-DAY                PIC 9(02)  VALUE ZEROS.          02980000
029900    05  HH-DM-YEAR               PIC 9(02)  VALUE ZEROS.          02990000
030000    05  HH-CM-MONTH              PIC 9(02)  VALUE ZEROS.          03000000
030100    05  HH-CM-DAY                PIC 9(02)  VALUE ZEROS.          03010000
030200    05  HH-CM-YEAR               PIC 9(02)  VALUE ZEROS.          03020000
030300    05  HH-JN-MONTH              PIC 9(02)  VALUE ZEROS.          03030000
030400    05  HH-JN-DAY                PIC 9(02)  VALUE ZEROS.          03040000
030500    05  HH-JN-YEAR               PIC 9(02)  VALUE ZEROS.          03050000
030600                                                                  03060000
030601*----------------------------------------------------------------*03060100
030602* DB2 ABEND AREA                                                 *03060200
030603*----------------------------------------------------------------*03060300
030604 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO.          03060400
030605     88  AC-BAD-DATA                         VALUE +4003.         03060500
030606     88  AC-DB2-ERROR                        VALUE +4013.         03060600
030607                                                                  03060700
030608 01  ABEND-AREAS.                                                 03060800
030609     05  AA-ABEND-LIT            PIC X(40)   VALUE                03060900
030610           '*****       ABEND'.                                   03061000
030611     05  AA-PROGRAM-LIT          PIC X(40)   VALUE                03061100
030612             '*****   PROGRAM:         '.                         03061200
030613     05  AA-PARAGRAPH-LIT.                                        03061300
030614         10  FILLER              PIC X(17)   VALUE                03061400
030615             '***** PARAGRAPH: '.                                 03061500
030616         10  AA-PARAGRAPH-NAME   PIC X(35)   VALUE SPACES.        03061600
030617     05  AA-MESSAGE-LINE.                                         03061700
030618         10  FILLER              PIC X(06)   VALUE '*****'.       03061800
030619         10  AA-MESSAGE          PIC X(127)  VALUE SPACES.        03061900
030620     05  AA-DB2-ERROR-LIT        PIC X(40)   VALUE                03062000
030621             '*****    DB2 ERROR'.                                03062100
030622     05  AA-DB2-OPERATION-LIT.                                    03062200
030623         10  FILLER              PIC X(17)   VALUE                03062300
030624             '***** OPERATION: '.                                 03062400
030625         10  AA-DB2-OPERATION.                                    03062500
030626             15  AA-DB2-OP-1     PIC X(25)   VALUE SPACES.        03062600
030627             15  AA-DB2-OP-2     PIC X(25)   VALUE SPACES.        03062700
030628     05  AA-DB2-TABLE-1          PIC X(08)   VALUE SPACES.        03062800
030629     05  AA-DB2-TABLE-2          PIC X(08)   VALUE SPACES.        03062900
030630     05  AA-DB2-TABLE-3          PIC X(08)   VALUE SPACES.        03063000
030631     05  AA-DB2-TABLE-4          PIC X(08)   VALUE SPACES.        03063100
030632                                                                  03063200
030633*----------------------------------------------------------------*03063300
030634* EXTERNAL EXTERPRISE TABLE                                      *03063400
030635*----------------------------------------------------------------*03063500
030636     EXEC SQL                                                     03063600
030637        INCLUDE TEXTENT                                           03063700
030638     END-EXEC.                                                    03063800
030640                                                                  03064000
030641*----------------------------------------------------------------*03064100
030642* AP PAYMENT CONTROL TABLE                                       *03064200
030643*----------------------------------------------------------------*03064300
030644     EXEC SQL                                                     03064400
030645        INCLUDE TAPCNTL                                           03064500
030646     END-EXEC.                                                    03064600
030647                                                                  03064700
030648*----------------------------------------------------------------*03064800
030649* PURCHASE ORDER HEADER TABLE                                    *03064900
030650*----------------------------------------------------------------*03065000
030651     EXEC SQL                                                     03065100
030660        INCLUDE TPURCHS                                           03066000
030670     END-EXEC.                                                    03067000
030680                                                                  03068000
030681*----------------------------------------------------------------*03068100
030682* INVOICE TABLE                                                  *03068200
030683*----------------------------------------------------------------*03068300
030698     EXEC SQL                                                     03069800
030699        INCLUDE TINVOIC                                           03069900
030700     END-EXEC.                                                    03070000
030701                                                                  03070100
030702*----------------------------------------------------------------*03070200
030703* INVOICE CHARGE/ALLOWANCE TABLE                                 *03070300
030704*----------------------------------------------------------------*03070400
030705     EXEC SQL                                                     03070500
030706        INCLUDE TALCHRG                                           03070600
030707     END-EXEC.                                                    03070700
030708                                                                  03070800
030709*----------------------------------------------------------------*03070900
030710* AP CHARGE TYPE TABLE                                           *03071000
030711*----------------------------------------------------------------*03071100
030712     EXEC SQL                                                     03071200
030713        INCLUDE TACCTYP                                           03071300
030714     END-EXEC.                                                    03071400
030715                                                                  03071500
030723*----------------------------------------------------------------*03072300
030724* VENDOR/DEPARTMENT TABLE                                        *03072400
030725*----------------------------------------------------------------*03072500
030726     EXEC SQL                                                     03072600
030727        INCLUDE TVNDDPT                                           03072700
030728     END-EXEC.                                                    03072800
030729                                                                  03072900
030730*----------------------------------------------------------------*03073000
030731* DB2 COMMUNICATIONS                                             *03073100
030732*----------------------------------------------------------------*03073200
030733     EXEC SQL                                                     03073300
030734        INCLUDE SQLCA                                             03073400
030735     END-EXEC.                                                    03073500
030736                                                                  03073600
030740*----------------------------------------------------------------*03074000
030800* CURSOR DECLARATIONS                                            *03080000
030900*----------------------------------------------------------------*03090000
031000     EXEC SQL                                                     03100000
031100         DECLARE INVOICE_CSR CURSOR FOR                           03110000
031200              SELECT                                              03120000
031300                    I.PO_NBR                                      03130000
031400                   ,A.ALW_CHRG_AMT                                03140000
031500                   ,'      '                                      03150000
031600                   ,I.INVC_ID                                     03160000
031700                   ,I.PPD_RVRSL_IND                               03170000
031800               FROM TINVOIC I                                     03180000
031900                   ,TALCHRG A                                     03190000
032000                   ,TACCTYP T                                     03200000
032100               WHERE I.PO_NBR = A.PO_NBR                          03210000
032300                 AND I.INVC_ID = A.INVC_ID                        03230000
032400                 AND A.ALW_CHRG_CDE = T.ALW_CHRG_CDE              03240000
032500                 AND I.INVC_TYP_CDE = 'EI'                        03250000
032600                 AND I.STATUS_CDE ^= 'DE'                         03260000
032610                 AND I.STATUS_CDE ^= 'PR'                         03261000
032700                 AND I.CRE_DTE >= :PV-FIRST-FISCAL-DATE           03270014
032800                 AND I.CRE_DTE <= :PV-LAST-FISCAL-DATE            03280014
032900                 AND T.GL_ACCT_NBR = :WS-DB2-ACCOUNT2             03290000
033000               ORDER BY I.PO_NBR                                  03300000
033100     END-EXEC.                                                    03310000
033200                                                                  03320000
033300*-----------------------*                                         03330000
033400 PROCEDURE DIVISION.                                              03340000
033500*-----------------------*                                         03350000
033600 0000-MAINLINE-PROCESSING.                                        03360000
033700                                                                  03370000
033800     PERFORM B100-INITIALIZATION.                                 03380000
033900     PERFORM B200-PROCESS-EXTRACT                                 03390000
034000             UNTIL END-OF-FILE-IMPORT AND                         03400000
034100                   PS-NO-MORE-TINVOIC.                            03410000
034300     PERFORM W100-WRITE-WORK-REPORT-FILE.                         03430000
034301     PERFORM W400-WRITE-END-OF-REPORT.                            03430104
034310     PERFORM B300-TERMINATION.                                    03431000
034800     STOP RUN.                                                    03480000
034900                                                                  03490000
034910*----------------------------------------------------------------*03491000
034920* INITIALIATION PROCESSING                                       *03492000
034930*----------------------------------------------------------------*03493000
035000 B100-INITIALIZATION.                                             03500000
035100                                                                  03510000
035101     ACCEPT CONTROL-CARD.                                         03510100
035102     MOVE CC-ACCOUNT                TO HDR1-ACCOUNT.              03510200
035110     ACCEPT SYSTEM-DATE FROM DATE.                                03511000
035120     MOVE SYSTEM-YEAR               TO DP132O-RUN-YEAR.           03512000
035130     MOVE SYSTEM-MONTH              TO DP132O-RUN-MONTH.          03513000
035140     MOVE SYSTEM-DAY                TO DP132O-RUN-DAY.            03514000
035150     ACCEPT SYSTEM-TIME FROM TIME.                                03515000
035160     MOVE SYSTEM-HOUR               TO DP132O-RUN-HOUR.           03516000
035170     MOVE SYSTEM-MINUTE             TO DP132O-RUN-MINUTE.         03517000
035180     MOVE PC-PROGRAM-NAME           TO DP132O-PROGRAM-NAME.       03518000
035190     MOVE 1                         TO DP132O-REPORT-NUMBER.      03519022
035194     DISPLAY 'RUN DATE = ' SYSTEM-DATE.                           03519400
035195     DISPLAY 'RUN TIME = ' SYSTEM-TIME.                           03519500
035196                                                                  03519600
035200     OPEN INPUT  DETAIL-IMPORT-FILE-PJ                            03520000
035300                 DETAIL-ACCT-IMPORT-FILE-PJ                       03530000
035400          OUTPUT WORK-REPORT-FILE                                 03540000
035410                 SUMMARY-REPORT-FILE.                             03541000
035500                                                                  03550000
035600     INITIALIZE DCLTEXTENT                                        03560000
035700                DCLTAPCNTL                                        03570000
035710                DCLTPURCHS                                        03571000
035720                DCLTINVOIC                                        03572000
035730                DCLTALCHRG                                        03573000
035740                DCLTACCTYP                                        03574000
035800                DCLTVNDDPT.                                       03580000
035806                                                                  03580600
035820     PERFORM S100-SELECT-PREV-FISCAL-DATA.                        03582014
035830     PERFORM S200-GET-FIRST-LAST-FISCAL-DT.                       03583014
035831                                                                  03583100
035832     MOVE PV-FIRST-FISCAL-DATE(1:4)            TO HDR2-START-YYYY.03583214
035833     MOVE PV-FIRST-FISCAL-DATE(6:2)            TO HDR2-START-MM.  03583314
035834     MOVE PV-FIRST-FISCAL-DATE(9:2)            TO HDR2-START-DD.  03583414
035835     MOVE PV-LAST-FISCAL-DATE(1:4)             TO HDR2-END-YYYY.  03583514
035836     MOVE PV-LAST-FISCAL-DATE(6:2)             TO HDR2-END-MM.    03583614
035837     MOVE PV-LAST-FISCAL-DATE(9:2)             TO HDR2-END-DD.    03583714
035844     PERFORM W200-WRITE-REPORT-HEADERS.                           03584400
035845                                                                  03584500
035850     PERFORM S300-GET-ACCT-IMPORT-DATA.                           03585000
035900     PERFORM R100-READ-IMPORT-FILE-PJ.                            03590000
036100     MOVE AP047-GL-ACCT-NBR   TO WS-HOLD-ACCT.                    03610000
036200     MOVE WS-HOLD-ACCT        TO WS-DB2-ACCT.                     03620000
037500     MOVE WS-DB2-ACCOUNT      TO WS-DB2-ACCOUNT2.                 03750000
037600     PERFORM Y100-OPEN-INVOICE-CSR.                               03760000
037800     PERFORM S400-FETCH-INVOICE-CSR.                              03780000
037900                                                                  03790000
038100     IF INVOIC-PO-NBR > WS-DETAIL-PONUM                           03810000
038200        IF INVOIC-PO-NBR = ZEROS                                  03820000
038300           MOVE ZEROS            TO WS-PO-HOLD                    03830000
038400        ELSE                                                      03840000
038500           MOVE INVOIC-PO-NBR    TO WS-PO-HOLD                    03850000
038600        END-IF                                                    03860000
038700     ELSE                                                         03870000
038800        IF WS-DETAIL-PONUM = ZEROS                                03880000
038900           MOVE ZEROS            TO WS-PO-HOLD                    03890000
039000        ELSE                                                      03900000
039100           MOVE WS-DETAIL-PONUM  TO WS-PO-HOLD                    03910000
039200        END-IF                                                    03920000
039300     END-IF.                                                      03930000
039400                                                                  03940000
039410*----------------------------------------------------------------*03941000
039420* THIS ROUTINE HOLDS THE MAIN LOGIC FOR PROCESSING THE OUTPUT    *03942000
039430*----------------------------------------------------------------*03943000
039500 B200-PROCESS-EXTRACT.                                            03950000
039600                                                                  03960000
039700     EVALUATE TRUE                                                03970000
039800     WHEN INVOIC-PO-NBR = WS-DETAIL-PONUM                         03980000
039900        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            03990000
040000        PERFORM S800-READ-DUNNS-NBR                               04000000
040100        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            04010000
040200        MOVE INVOIC-GRO-COST-AMT        TO DT-INV                 04020000
040300        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04030000
040400        MOVE INVOIC-PO-NBR              TO DT-PO-NUMBER           04040000
040600        IF AP047-CHARGE                                           04060015
040700**      IF AP047-AP-TRN-CDE = '68' OR '73'                        04070015
040900           MOVE AP047-GRO-COST-AMT      TO DT-DEBIT-TOTAL         04090000
041000           ADD  AP047-GRO-COST-AMT      TO WS-DM-TOTAL            04100000
041100        ELSE                                                      04110000
041200           MOVE INVOIC-PO-NBR           TO WS-INVOIC-PO-NBR       04120000
041410           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04141000
041420              MOVE AP047-GRO-COST-AMT   TO DT-PPR                 04142000
041430           END-IF                                                 04143000
041700           MOVE AP047-GRO-COST-AMT      TO DT-CREDIT-TOTAL        04170000
041800           ADD  AP047-GRO-COST-AMT      TO WS-CM-TOTAL            04180000
041900        END-IF                                                    04190000
042000        PERFORM S500-GET-DATE-ACTUAL                              04200000
042200        IF AP047-GL-ACCT-NBR = '10301 '                           04220000
042300           PERFORM S600-GET-JRNL-DATE                             04230000
042400        END-IF                                                    04240000
042500        MOVE HH-DM-MONTH                TO DT-DM-MONTH            04250000
042600        MOVE HH-DM-DAY                  TO DT-DM-DAY              04260000
042700        MOVE HH-DM-YEAR                 TO DT-DM-YEAR             04270000
042800        MOVE HH-CM-MONTH                TO DT-CM-MONTH            04280000
042900        MOVE HH-CM-DAY                  TO DT-CM-DAY              04290000
043000        MOVE HH-CM-YEAR                 TO DT-CM-YEAR             04300000
043100        MOVE HH-JN-MONTH                TO DT-JN-MONTH            04310000
043200        MOVE HH-JN-DAY                  TO DT-JN-DAY              04320000
043300        MOVE HH-JN-YEAR                 TO DT-JN-YEAR             04330000
043400        PERFORM W100-WRITE-WORK-REPORT-FILE                       04340000
043500        PERFORM R100-READ-IMPORT-FILE-PJ                          04350000
043600        PERFORM S400-FETCH-INVOICE-CSR                            04360000
043700      WHEN INVOIC-PO-NBR > WS-DETAIL-PONUM                        04370000
043900        IF AP047-ENT-NME-DESC (1:9) = SPACES                      04390000
044000           MOVE ZEROS                   TO DT-PO-NUMBER           04400000
044100        ELSE                                                      04410000
044200           MOVE WS-DETAIL-PONUM         TO DT-PO-NUMBER           04420000
044300        END-IF                                                    04430000
044500        IF AP047-GL-ACCT-NBR NOT EQUAL '10301 '                   04450000
044600           PERFORM S600-GET-JRNL-DATE                             04460000
044700        END-IF                                                    04470000
044800        PERFORM S500-GET-DATE-ACTUAL                              04480000
044900        MOVE HH-DM-MONTH                TO DT-DM-MONTH            04490000
045000        MOVE HH-DM-DAY                  TO DT-DM-DAY              04500000
045100        MOVE HH-DM-YEAR                 TO DT-DM-YEAR             04510000
045200        MOVE HH-CM-MONTH                TO DT-CM-MONTH            04520000
045300        MOVE HH-CM-DAY                  TO DT-CM-DAY              04530000
045400        MOVE HH-CM-YEAR                 TO DT-CM-YEAR             04540000
045500        MOVE HH-JN-MONTH                TO DT-JN-MONTH            04550000
045600        MOVE HH-JN-DAY                  TO DT-JN-DAY              04560000
045700        MOVE HH-JN-YEAR                 TO DT-JN-YEAR             04570000
045800        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04580000
046000        IF AP047-CHARGE                                           04600015
046100**      IF AP047-AP-TRN-CDE = '68' OR '73'                        04610015
046300           MOVE AP047-GRO-COST-AMT      TO DT-DEBIT-TOTAL         04630000
046400           ADD  AP047-GRO-COST-AMT      TO WS-DM-TOTAL            04640000
046500        ELSE                                                      04650000
046600           MOVE WS-DETAIL-PONUM         TO WS-INVOIC-PO-NBR       04660000
046810           IF INVOIC-PPD-RVRSL-IND = 'Y'                          04681000
046820               MOVE AP047-GRO-COST-AMT  TO DT-PPR                 04682000
046830           END-IF                                                 04683000
047100           MOVE AP047-GRO-COST-AMT      TO DT-CREDIT-TOTAL        04710000
047200           ADD  AP047-GRO-COST-AMT      TO WS-CM-TOTAL            04720000
047300        END-IF                                                    04730000
047500        MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DT-PONUM            04750000
047600        PERFORM S800-READ-DUNNS-NBR                               04760000
047700        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            04770000
047800        PERFORM W100-WRITE-WORK-REPORT-FILE                       04780000
047900        PERFORM R100-READ-IMPORT-FILE-PJ                          04790000
048000      WHEN INVOIC-PO-NBR < WS-DETAIL-PONUM                        04800000
048100        MOVE INVOIC-PO-NBR              TO WS-DT-PONUM            04810000
048200        PERFORM S800-READ-DUNNS-NBR                               04820000
048300        MOVE WS-DUNNS-NUMBER            TO DT-PO-DUNNS            04830000
048400        MOVE INVOIC-PO-NBR              TO DT-PO-NUMBER           04840000
048500        MOVE WS-HOLD-ACCT               TO DT-ACCOUNT             04850000
048600        MOVE INVOIC-GRO-COST-AMT        TO DT-INV                 04860000
048700        MOVE INVOIC-PO-NBR              TO WS-INVOIC-PO-NBR       04870000
048910        IF INVOIC-PPD-RVRSL-IND = 'Y'                             04891000
048920           MOVE AP047-GRO-COST-AMT      TO DT-PPR                 04892000
048930        END-IF                                                    04893000
048940        PERFORM W100-WRITE-WORK-REPORT-FILE                       04894000
049100        PERFORM S400-FETCH-INVOICE-CSR                            04910000
049200      END-EVALUATE.                                               04920000
049202                                                                  04920200
049210*----------------------------------------------------------------*04921000
049220* END OF PROGRAM PROCESSING                                      *04922000
049230*----------------------------------------------------------------*04923000
049240 B300-TERMINATION.                                                04924000
049250                                                                  04925000
049260     DISPLAY '**************************************************'.04926000
049300     DISPLAY '**            APKRP248 RECORD COUNT             **'.04930000
049400     DISPLAY '**************************************************'.04940000
049500     DISPLAY 'TOTAL IMPORT RECORDS READ = ' PV-IMPORT-READ-CNT.   04950000
049600     DISPLAY 'TOTAL ACCT RECORDS READ   = ' PV-ACCT-READ-CNT.     04960000
049700     DISPLAY 'TOTAL RECORDS WRITTEN     = ' PV-WRITTEN-CNT.       04970000
049800     DISPLAY '**************************************************'.04980000
049900     DISPLAY '**************************************************'.04990000
050000                                                                  05000000
050100     PERFORM Y200-CLOSE-INVOICE-CSR.                              05010000
050200     CLOSE DETAIL-IMPORT-FILE-PJ                                  05020000
050300           DETAIL-ACCT-IMPORT-FILE-PJ                             05030000
050400           WORK-REPORT-FILE                                       05040000
050410           SUMMARY-REPORT-FILE.                                   05041000
050500                                                                  05050000
063110**---------------------------------------------------------------*06311000
063120* READS THE INPUT FILE                                           *06312000
063130*----------------------------------------------------------------*06313000
063200 R100-READ-IMPORT-FILE-PJ.                                        06320000
063300                                                                  06330000
063400     READ DETAIL-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE        06340000
063500           AT END                                                 06350000
063510              SET END-OF-FILE-IMPORT TO TRUE                      06351000
063600              MOVE '9999999'         TO AP047-ENT-NME-DESC (1:9)  06360000
063610           NOT AT END                                             06361000
063620              ADD 1                  TO PV-IMPORT-READ-CNT.       06362000
063700                                                                  06370000
063900     MOVE AP047-ENT-NME-DESC (1:9)   TO WS-DETAIL-PONUM.          06390000
064100     IF END-OF-FILE-IMPORT                                        06410000
064200        MOVE 999999999               TO WS-DETAIL-PONUM           06420000
064300     END-IF.                                                      06430000
064400                                                                  06440000
064500*----------------------------------------------------------------*06450000
064600* READS THE INPUT FILE CONTAINING ACCOUNT DATA                   *06460000
064700*----------------------------------------------------------------*06470000
064800 R200-READ-ACCT-IMPORT-FILE.                                      06480000
064900                                                                  06490000
065000     READ DETAIL-ACCT-IMPORT-FILE-PJ INTO AP047-GL-EXTRACT-FILE   06500000
065100          AT END                                                  06510000
065200             SET END-OF-FILE-ACCT    TO TRUE                      06520000
065300          NOT AT END                                              06530000
065400             ADD 1                   TO PV-ACCT-READ-CNT.         06540000
065500                                                                  06550000
065600     MOVE AP047-ENT-NME-DESC(1:9)    TO ACCT-PO (X1).             06560000
065700     MOVE AP047-ENT-NME-DESC (10:10) TO ACCT-DATE (X1).           06570000
065800                                                                  06580000
065810*----------------------------------------------------------------*06581000
065820* SELECT THE PREVIOUS FISCAL PERIOD AND YEAR FROM THE TAPCNTL    *06582000
065821* TABLE                                                          *06582100
065830*----------------------------------------------------------------*06583000
065840 S100-SELECT-PREV-FISCAL-DATA.                                    06584000
065850                                                                  06585000
065860     EXEC SQL                                                     06586000
065861        SELECT PREV_PSTG_FYR_NBR                                  06586100
065862             , PREV_PSTG_FMN_NBR                                  06586200
065863          INTO :APCNTL-PREV-PSTG-FYR-NBR                          06586300
065864             , :APCNTL-PREV-PSTG-FMN-NBR                          06586400
065865          FROM TAPCNTL                                            06586500
065870     END-EXEC.                                                    06587000
065880                                                                  06588000
065890     EVALUATE TRUE                                                06589000
065891       WHEN SQLCODE = ZERO                                        06589100
065892          CONTINUE                                                06589200
065893       WHEN SQLWARN0 NOT = SPACES                                 06589300
065894       WHEN SQLCODE NOT = ZERO                                    06589400
065895          MOVE 'S100-SELECT-PREV-FISCAL-DATA' TO AA-PARAGRAPH-NAME06589500
065896          MOVE 'UNSUCCESSFUL SELECT '         TO AA-DB2-OPERATION 06589600
065897          MOVE 'TAPCNTL'                      TO AA-DB2-TABLE-1   06589700
065898          MOVE SPACES                         TO AA-DB2-TABLE-2   06589800
065899                                                 AA-DB2-TABLE-3   06589900
065900                                                 AA-DB2-TABLE-4   06590000
065901          PERFORM Z999-DB2-ABEND                                  06590100
065902     END-EVALUATE.                                                06590200
065903                                                                  06590300
065904*----------------------------------------------------------------*06590400
065905* USE THE KOHLS CALENDAR ROUTINE TO GET THE FIRST AND LAST       *06590500
065906* FISCAL DATE OF THE PREVIOUS PERIOD.                            *06590600
065907*----------------------------------------------------------------*06590700
065908 S200-GET-FIRST-LAST-FISCAL-DT.                                   06590800
065909                                                                  06590900
065910     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55, DPG56.         06591000
065911                                                                  06591100
065912     SET DPG51-FISCAL-454-CALENDAR    TO TRUE.                    06591200
065913     SET DPG52-LK-DTE-FISC-PRD-CC     TO TRUE.                    06591300
065914     MOVE APCNTL-PREV-PSTG-FYR-NBR    TO DPG52-FISCAL-CC-PRD-YR.  06591400
065915     MOVE APCNTL-PREV-PSTG-FMN-NBR    TO DPG52-FISCAL-CC-PRD-PP.  06591500
065916                                                                  06591600
065917     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    06591700
065918                                             DPG54 DPG55 DPG56.   06591800
065919                                                                  06591900
065920     IF DPG54-NO-ERROR                                            06592000
065921        DISPLAY 'PERIOD START DATE: '  DPG56-FIRST-FP-DB2-ISO-FMT 06592100
065922        DISPLAY 'PERIOD END DATE: ' DPG56-LAST-FP-DB2-ISO-FMT     06592200
065923        MOVE DPG56-FIRST-FP-DB2-ISO-FMT  TO PV-FIRST-FISCAL-DATE  06592300
065924        MOVE DPG56-LAST-FP-DB2-ISO-FMT   TO PV-LAST-FISCAL-DATE   06592400
065925     ELSE                                                         06592500
065926        MOVE 'S200-GET-FIRST-LAST-FISCAL-DT' TO AA-PARAGRAPH-NAME 06592600
065927        MOVE DPG54-ERROR-MESSAGE             TO AA-MESSAGE        06592700
065928        SET AC-BAD-DATA                      TO TRUE              06592800
065929        PERFORM Z999-DB2-ABEND                                    06592900
065930     END-IF.                                                      06593000
065931                                                                  06593100
065940*----------------------------------------------------------------*06594000
066000* STORES THE ACCOUNT IMPORT DATA INTO INTERNAL TABLE             *06600000
066100*----------------------------------------------------------------*06610000
066200 S300-GET-ACCT-IMPORT-DATA.                                       06620000
066300                                                                  06630000
066400     SET X1 TO 1.                                                 06640000
066500     PERFORM R200-READ-ACCT-IMPORT-FILE                           06650000
066600             VARYING X1 FROM 1 BY 1                               06660000
066700             UNTIL END-OF-FILE-ACCT.                              06670000
066900     MOVE WS-HD-PO         TO ACCT-PO (X1).                       06690000
067000     MOVE WS-HD-DATE       TO ACCT-DATE (X1).                     06700000
067100     INITIALIZE AP047-GL-EXTRACT-FILE.                            06710000
067200                                                                  06720000
079110*----------------------------------------------------------------*07911000
079120* FETCH INVOICE_CSR CURSOR                                       *07912000
079130*----------------------------------------------------------------*07913000
079200 S400-FETCH-INVOICE-CSR.                                          07920000
079800                                                                  07980000
079900     PERFORM WITH TEST AFTER                                      07990000
080000        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      08000000
080100        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              08010000
080200                SQLCODE = ZERO OR                                 08020000
080300                SQLCODE = +100                                    08030000
080400        EXEC SQL                                                  08040000
080500           FETCH INVOICE_CSR                                      08050000
080600               INTO   :INVOIC-PO-NBR                              08060000
080800                    , :INVOIC-GRO-COST-AMT                        08080000
080900                    , :WS-REQ-ENTR-TRMNL-ID                       08090000
081000                    , :INVOIC-INVC-ID                             08100000
081010                    , :INVOIC-PPD-RVRSL-IND                       08101000
081100        END-EXEC                                                  08110000
081200                                                                  08120000
081300        EVALUATE TRUE                                             08130000
081400            WHEN SQLCODE = ZERO                                   08140000
081500            WHEN SQLCODE = -904                                   08150000
081600            WHEN SQLCODE = -913                                   08160000
081700                 CONTINUE                                         08170000
081800            WHEN SQLCODE = +100                                   08180000
081900                 SET PS-NO-MORE-TINVOIC  TO TRUE                  08190000
082000                 MOVE 999999999          TO INVOIC-PO-NBR         08200000
082100            WHEN SQLWARN0 NOT = SPACES                            08210000
082200            WHEN SQLCODE  NOT = ZERO                              08220000
082300                 MOVE 'S400-FETCH-INVOICE-CSR'                    08230000
082400                                            TO AA-PARAGRAPH-NAME  08240000
082500                 MOVE 'UNSUCCESSFUL FETCH'  TO AA-DB2-OPERATION   08250000
082700                 MOVE 'TINVOIC'             TO AA-DB2-TABLE-1     08270000
082800                 MOVE 'TALCHRG'             TO AA-DB2-TABLE-2     08280000
082810                 MOVE 'TACCTYP'             TO AA-DB2-TABLE-3     08281000
082820                 MOVE SPACES                TO AA-DB2-TABLE-4     08282000
082900                 PERFORM Z999-DB2-ABEND                           08290000
083000        END-EVALUATE                                              08300000
083100     END-PERFORM.                                                 08310000
083200                                                                  08320000
083300     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         08330000
083400         MOVE 'S400-FETCH-INVOICE-CSR'  TO AA-PARAGRAPH-NAME      08340000
083600         MOVE 'MAX RETRIES EXCEEDED ON FETCH TINVOIC'             08360000
083700                                        TO AA-DB2-OPERATION       08370000
083800         PERFORM Z999-DB2-ABEND                                   08380000
083900     END-IF.                                                      08390000
084000                                                                  08400000
084100     EVALUATE TRUE                                                08410000
084200        WHEN SQLCODE = ZEROS                                      08420000
084300        WHEN SQLCODE = +100                                       08430000
084400             CONTINUE                                             08440000
084500        WHEN OTHER                                                08450000
084600             MOVE 'S400-FETCH-INVOICE-CSR' TO AA-PARAGRAPH-NAME   08460000
084800             MOVE 'UNSUCCESSFUL FETCH'     TO AA-DB2-OPERATION    08480000
085000             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      08500000
085100             MOVE 'TALCHRG'                TO AA-DB2-TABLE-2      08510000
085110             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      08511000
085120             MOVE SPACES                   TO AA-DB2-TABLE-4      08512000
085200             PERFORM Z999-DB2-ABEND                               08520000
085300     END-EVALUATE.                                                08530000
085400                                                                  08540000
085401*----------------------------------------------------------------*08540100
085402* GET THE DEBIT, CREDIT, OR JOURNAL DATE                         *08540200
085403*----------------------------------------------------------------*08540300
085404 S500-GET-DATE-ACTUAL.                                            08540400
085405                                                                  08540500
085406     INITIALIZE DPG51, DPG52, DPG53, DPG54, DPG55,  DPG56.        08540600
085407                                                                  08540700
085408     IF AP047-CHARGE                                              08540815
085409**   IF AP047-AP-TRN-CDE = '68' OR '73'                           08540915
085410        MOVE AP047-ENT-NME-DESC (15:2)    TO HH-DM-MONTH          08541015
085411        MOVE AP047-ENT-NME-DESC (18:2)    TO HH-DM-DAY            08541115
085412        MOVE AP047-ENT-NME-DESC (12:2)    TO HH-DM-YEAR           08541215
085413        MOVE ZEROS                        TO HH-CM-MONTH          08541315
085414        MOVE ZEROS                        TO HH-CM-DAY            08541415
085415        MOVE ZEROS                        TO HH-CM-YEAR           08541515
085416        IF AP047-GL-ACCT-NBR = '10301 '                           08541615
085417           MOVE AP047-ENT-NME-DESC (15:2) TO HH-JN-MONTH          08541715
085418           MOVE AP047-ENT-NME-DESC (18:2) TO HH-JN-DAY            08541815
085419           MOVE AP047-ENT-NME-DESC (12:2) TO HH-JN-YEAR           08541915
085420        END-IF                                                    08542015
085421     ELSE                                                         08542115
085422        MOVE AP047-ENT-NME-DESC (15:2)    TO HH-CM-MONTH          08542215
085423        MOVE AP047-ENT-NME-DESC (18:2)    TO HH-CM-DAY            08542315
085424        MOVE AP047-ENT-NME-DESC (12:2)    TO HH-CM-YEAR           08542415
085425        MOVE ZEROS                        TO HH-DM-MONTH          08542515
085426        MOVE ZEROS                        TO HH-DM-DAY            08542615
085427        MOVE ZEROS                        TO HH-DM-YEAR           08542715
085428     END-IF.                                                      08542815
085429                                                                  08542915
085430*----------------------------------------------------------------*08543015
085431* GET THE JOURNAL DATE                                           *08543115
085432*----------------------------------------------------------------*08543215
085433 S600-GET-JRNL-DATE.                                              08543315
085434                                                                  08543415
085435     PERFORM S700-SEARCH-ACCT-TABLE.                              08543515
085436     MOVE WS-JN-DATE (6:2)        TO HH-JN-MONTH.                 08543615
085437     MOVE WS-JN-DATE (9:2)        TO HH-JN-DAY.                   08543715
085438     MOVE WS-JN-DATE (3:2)        TO HH-JN-YEAR.                  08543815
085439                                                                  08543915
085440*----------------------------------------------------------------*08544015
085441* SEARCHES THE INTERNAL ACCOUNT TABLE                            *08544115
085442*----------------------------------------------------------------*08544215
085443 S700-SEARCH-ACCT-TABLE.                                          08544315
085444                                                                  08544415
085445     SET X1 TO 1.                                                 08544515
085446     SEARCH ACCT-TABLE                                            08544615
085447         AT END                                                   08544715
085448            MOVE '0000-00-00'      TO WS-JN-DATE                  08544815
085449         WHEN AP047-ENT-NME-DESC (1:9) = ACCT-PO(X1)              08544915
085450            MOVE ACCT-DATE(X1)     TO WS-JN-DATE                  08545015
085451     END-SEARCH.                                                  08545115
085452                                                                  08545215
085453*----------------------------------------------------------------*08545315
085454* GET THE DUNN NUMBER FROM THE TVNDDPT, TPURCHS, AND TEXTENT     *08545415
085455* TABLES                                                         *08545515
085456*----------------------------------------------------------------*08545615
085457 S800-READ-DUNNS-NBR.                                             08545715
085461                                                                  08546100
085466     EXEC SQL                                                     08546600
085467        SELECT C.DUN_NBR                                          08546700
085468        INTO :WS-DUNNS-NUMBER                                     08546800
085469        FROM TVNDDPT A                                            08546900
085470           , TPURCHS B                                            08547000
085471           , TEXTENT C                                            08547100
085472        WHERE A.ENT_ID = B.ENT_ID                                 08547200
085473          AND B.ENT_ID = C.ENT_ID                                 08547300
085474          AND B.PO_NBR = :WS-DT-PONUM                             08547400
085475          AND VER_STATUS_CDE = 'A'                                08547500
085476          AND A.DEPT_NBR = B.DEPT_NBR                             08547600
085477     END-EXEC.                                                    08547700
085478                                                                  08547800
085479     EVALUATE TRUE                                                08547900
085480         WHEN SQLCODE = ZERO                                      08548000
085481              CONTINUE                                            08548100
085482         WHEN SQLCODE = +100                                      08548200
085483              CONTINUE                                            08548300
085484         WHEN SQLWARN0 NOT = SPACES                               08548400
085485         WHEN SQLCODE  NOT = ZERO                                 08548500
085486              MOVE WS-DT-PONUM  TO PV-DISPLAY-PONUM               08548620
085487              DISPLAY 'WS-DT-PONUM ' PV-DISPLAY-PONUM             08548720
085489              MOVE 'S800-READ-DUNNS-NBR'   TO AA-PARAGRAPH-NAME   08548900
085490              MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION    08549000
085491              MOVE 'TVNDDPT'               TO AA-DB2-TABLE-1      08549100
085492              MOVE 'TPURCHS'               TO AA-DB2-TABLE-2      08549200
085493              MOVE 'TEXTENT'               TO AA-DB2-TABLE-3      08549300
085494              MOVE SPACES                  TO AA-DB2-TABLE-4      08549400
085495              PERFORM Z999-DB2-ABEND                              08549500
085496     END-EVALUATE.                                                08549600
085497                                                                  08549700
085498*----------------------------------------------------------------*08549800
085499* WRITE RECORD TO EXTRAC FILE                                    *08549900
085500*----------------------------------------------------------------*08550000
085501 W100-WRITE-WORK-REPORT-FILE.                                     08550100
085502                                                                  08550200
085503       IF DT-PO-NUMBER = WS-PO-HOLD                               08550300
085504          INITIALIZE DH-DETAIL-LINE1                              08550400
085505          MOVE  DT-ACCOUNT             TO DH-ACCOUNT              08550500
085506          MOVE  DT-PO-DUNNS            TO DH-PO-DUNNS             08550600
085507          MOVE  DT-PO-NUMBER           TO DH-PO-NUMBER            08550700
085508          ADD   DT-DEBIT-TOTAL         TO WS-DEBIT-TOTAL          08550800
085509          MOVE  WS-DEBIT-TOTAL         TO DH-DEBIT-TOTAL          08550900
085510          ADD   DT-CREDIT-TOTAL        TO WS-CREDIT-TOTAL         08551000
085511          ADD   DT-INV                 TO WS-INV-TOTAL            08551100
085512          MOVE  WS-INV-TOTAL           TO DH-INV                  08551200
085513          MOVE  WS-CREDIT-TOTAL        TO DH-CREDIT-TOTAL         08551300
085514          MOVE  DT-PO-NUMBER           TO WS-INVOIC-PO-NBR        08551400
085515          IF INVOIC-PPD-RVRSL-IND = 'Y'                           08551500
085516             MOVE AP047-GRO-COST-AMT   TO DH-PPR                  08551600
085517          END-IF                                                  08551700
085518          IF  DT-DM-MONTH > 0 OR                                  08551800
085519              DT-DM-DAY   > 0 OR                                  08551900
085520              DT-DM-YEAR  > 0                                     08552000
085521               MOVE  DT-DM-MONTH       TO DH-DM-MONTH             08552100
085522               MOVE  DT-DM-DAY         TO DH-DM-DAY               08552200
085523               MOVE  DT-DM-YEAR        TO DH-DM-YEAR              08552300
085524          END-IF                                                  08552400
085525          IF  DT-CM-MONTH > 0 OR                                  08552500
085526              DT-CM-DAY   > 0 OR                                  08552600
085527              DT-CM-YEAR  > 0                                     08552700
085528               MOVE  DT-CM-MONTH       TO DH-CM-MONTH             08552800
085529               MOVE  DT-CM-DAY         TO DH-CM-DAY               08552900
085530               MOVE  DT-CM-YEAR        TO DH-CM-YEAR              08553000
085531          END-IF                                                  08553100
085532          IF  DT-JN-MONTH > 0 OR                                  08553200
085533              DT-JN-DAY   > 0 OR                                  08553300
085534              DT-JN-YEAR  > 0                                     08553400
085535               MOVE  DT-JN-MONTH       TO DH-JN-MONTH             08553500
085536               MOVE  DT-JN-DAY         TO DH-JN-DAY               08553600
085537               MOVE  DT-JN-YEAR        TO DH-JN-YEAR              08553700
085538          END-IF                                                  08553800
085539          INITIALIZE DT-HOLD-TOTAL                                08553900
085540        ELSE                                                      08554000
085541          INITIALIZE WS-DEBIT-TOTAL                               08554100
085542          INITIALIZE WS-CREDIT-TOTAL                              08554200
085543          INITIALIZE WS-INV-TOTAL                                 08554300
085544                                                                  08554400
085545           IF DH-ACCOUNT   = SPACES  AND                          08554500
085546              DH-PO-DUNNS  = SPACES  AND                          08554600
085547              DH-PO-NUMBER = SPACES                               08554700
085548                 CONTINUE                                         08554800
085549           ELSE                                                   08554900
085550                 WRITE WR-WORK-REPORT-RECORD                      08555000
085551                 FROM DH-DETAIL-LINE1 AFTER 1                     08555100
085552                 PERFORM W300-WRITE-REPORT-DETAILS                08555212
085553           END-IF                                                 08555300
085554                                                                  08555400
085555           MOVE DT-PO-NUMBER           TO WS-PO-HOLD              08555500
085556                                                                  08555600
085557           IF HH-DM-MONTH    =  DH-DM-MONTH AND                   08555700
085558              HH-DM-DAY      =  DH-DM-DAY   AND                   08555800
085559              HH-DM-YEAR     =  DH-DM-YEAR                        08555900
085560                 MOVE  0               TO HH-DM-MONTH             08556000
085561                 MOVE  0               TO HH-DM-DAY               08556100
085562                 MOVE  0               TO HH-DM-YEAR              08556200
085563           END-IF                                                 08556300
085564                                                                  08556400
085565           IF HH-CM-MONTH    =  DH-CM-MONTH AND                   08556500
085566              HH-CM-DAY      =  DH-CM-DAY   AND                   08556600
085567              HH-CM-YEAR     =  DH-CM-YEAR                        08556700
085568                 MOVE  0               TO HH-CM-MONTH             08556800
085569                 MOVE  0               TO HH-CM-DAY               08556900
085570                 MOVE  0               TO HH-CM-YEAR              08557000
085571           END-IF                                                 08557100
085572                                                                  08557200
085573           IF HH-JN-MONTH    =  DH-JN-MONTH AND                   08557300
085574              HH-JN-DAY      =  DH-JN-DAY   AND                   08557400
085575              HH-JN-YEAR     =  DH-JN-YEAR                        08557500
085576                 MOVE  0               TO HH-JN-MONTH             08557600
085577                 MOVE  0               TO HH-JN-DAY               08557700
085578                 MOVE  0               TO HH-JN-YEAR              08557800
085579           END-IF                                                 08557900
085580                                                                  08558000
085581           INITIALIZE DH-DETAIL-LINE1                             08558100
085582           MOVE  DT-ACCOUNT            TO DH-ACCOUNT              08558200
085583           MOVE  DT-PO-DUNNS           TO DH-PO-DUNNS             08558300
085584           MOVE  DT-PO-NUMBER          TO DH-PO-NUMBER            08558400
085585           ADD   DT-DEBIT-TOTAL        TO WS-DEBIT-TOTAL          08558500
085586           MOVE  WS-DEBIT-TOTAL        TO DH-DEBIT-TOTAL          08558600
085587           MOVE  DT-DM-MONTH           TO DH-DM-MONTH             08558700
085588           MOVE  DT-DM-DAY             TO DH-DM-DAY               08558800
085589           MOVE  DT-DM-YEAR            TO DH-DM-YEAR              08558900
085590           ADD   DT-CREDIT-TOTAL       TO WS-CREDIT-TOTAL         08559000
085591           MOVE  WS-CREDIT-TOTAL       TO DH-CREDIT-TOTAL         08559100
085592           MOVE  DT-CM-MONTH           TO DH-CM-MONTH             08559200
085593           MOVE  DT-CM-DAY             TO DH-CM-DAY               08559300
085594           MOVE  DT-CM-YEAR            TO DH-CM-YEAR              08559400
085595           MOVE  DT-JN-MONTH           TO DH-JN-MONTH             08559500
085596           MOVE  DT-JN-DAY             TO DH-JN-DAY               08559600
085597           MOVE  DT-JN-YEAR            TO DH-JN-YEAR              08559700
085598           MOVE  DT-PO-NUMBER          TO WS-INVOIC-PO-NBR        08559800
085599           ADD   DT-INV                TO WS-INV-TOTAL            08559900
085600           MOVE  WS-INV-TOTAL          TO DH-INV                  08560000
085601           IF INVOIC-PPD-RVRSL-IND = 'Y'                          08560100
085602              MOVE AP047-GRO-COST-AMT  TO DH-PPR                  08560200
085603           END-IF                                                 08560300
085604           INITIALIZE DT-HOLD-TOTAL                               08560400
085605         END-IF.                                                  08560500
085606                                                                  08560600
085607         ADD 1                         TO PV-WRITTEN-CNT.         08560700
085608                                                                  08560800
085609*----------------------------------------------------------------*08560900
085610* WRITES REPORT HEADERS                                          *08561000
085611*----------------------------------------------------------------*08561100
085612 W200-WRITE-REPORT-HEADERS.                                       08561200
085613                                                                  08561300
085614     INITIALIZE LINE-COUNT.                                       08561400
085615     ADD 1                            TO PAGE-COUNT.              08561500
085616     MOVE PAGE-COUNT                  TO DP132O-PAGE-NUMBER.      08561600
085617     WRITE SUMMARY-REPORT-RECORD                                  08561700
085618           FROM DP132O-STANDRD-HEADER-132-COLS AFTER PAGE.        08561800
085619                                                                  08561900
085620     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-1 AFTER 1.         08562000
085621     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-2 AFTER 1.         08562100
085622     WRITE SUMMARY-REPORT-RECORD FROM BLANK-LINE AFTER 1.         08562200
085623     WRITE SUMMARY-REPORT-RECORD FROM HDR-LINE-3 AFTER 1.         08562300
085624     ADD 5                       TO LINE-COUNT.                   08562400
085625                                                                  08562500
085626*----------------------------------------------------------------*08562600
085627* WRITES REPORT DETAILS                                          *08562700
085628*----------------------------------------------------------------*08562800
085629 W300-WRITE-REPORT-DETAILS.                                       08562900
085630                                                                  08563000
085631     IF LINE-COUNT > 59                                           08563100
085632        PERFORM W200-WRITE-REPORT-HEADERS                         08563200
085633     END-IF.                                                      08563300
085634                                                                  08563400
085635     WRITE SUMMARY-REPORT-RECORD FROM DH-DETAIL-LINE1 AFTER 1.    08563500
085636     ADD 1                       TO LINE-COUNT.                   08563600
085637                                                                  08563703
085639*----------------------------------------------------------------*08563903
085640* WRITE END OF REPORT LINE                                       *08564003
085641*----------------------------------------------------------------*08564103
085642 W400-WRITE-END-OF-REPORT.                                        08564203
085643                                                                  08564303
085644     WRITE SUMMARY-REPORT-RECORD FROM EOR-END-OF-REPORT AFTER 1.  08564403
085645                                                                  08564503
085646*----------------------------------------------------------------*08564600
085647* OPEN INVOICE_CSR CURSOR                                        *08564700
085648*----------------------------------------------------------------*08564800
085649 Y100-OPEN-INVOICE-CSR.                                           08564900
085650                                                                  08565000
085700     PERFORM WITH TEST AFTER                                      08570000
085800        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      08580000
085900        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              08590000
086000                SQLCODE = ZERO                                    08600000
086100        EXEC SQL                                                  08610000
086200            OPEN INVOICE_CSR                                      08620000
086300        END-EXEC                                                  08630000
086400                                                                  08640000
086500        EVALUATE TRUE                                             08650000
086600            WHEN SQLCODE = ZERO                                   08660000
086700            WHEN SQLCODE = -904                                   08670000
086800            WHEN SQLCODE = -913                                   08680000
086900                 CONTINUE                                         08690000
087000            WHEN SQLWARN0 NOT = SPACES                            08700000
087100            WHEN SQLCODE  NOT = ZERO                              08710000
087200                 MOVE 'Y100-OPEN-INVOICE-CSR' TO AA-PARAGRAPH-NAME08720000
087400                 MOVE 'UNSUCCESSFUL OPEN'     TO AA-DB2-OPERATION 08740000
087600                 MOVE 'TINVOIC'               TO AA-DB2-TABLE-1   08760000
087700                 MOVE 'TALCHRG'               TO AA-DB2-TABLE-2   08770000
087710                 MOVE 'TACCTYP'               TO AA-DB2-TABLE-3   08771000
087720                 MOVE SPACES                  TO AA-DB2-TABLE-4   08772000
087800                 PERFORM Z999-DB2-ABEND                           08780000
087900        END-EVALUATE                                              08790000
088000     END-PERFORM.                                                 08800000
088100                                                                  08810000
088200     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         08820000
088300         MOVE 'Y100-OPEN-INVOICE-CSR'  TO AA-PARAGRAPH-NAME       08830000
088500         MOVE 'MAX RETRIES EXCEEDED ON OPEN TINVOIC'              08850000
088600                                       TO AA-DB2-OPERATION        08860000
088700         PERFORM Z999-DB2-ABEND                                   08870000
088800     END-IF.                                                      08880000
088900                                                                  08890000
089000     EVALUATE TRUE                                                08900000
089100        WHEN SQLCODE = ZEROS                                      08910000
089200             CONTINUE                                             08920000
089300        WHEN OTHER                                                08930000
089400             MOVE 'Y100-OPEN-INVOICE-CSR'  TO AA-PARAGRAPH-NAME   08940000
089600             MOVE 'UNSUCCESSFUL OPEN'      TO AA-DB2-OPERATION    08960000
089800             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      08980000
089900             MOVE 'TALCHRG'                TO AA-DB2-TABLE-2      08990000
089910             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      08991000
089920             MOVE SPACES                   TO AA-DB2-TABLE-4      08992000
090000             PERFORM Z999-DB2-ABEND                               09000000
090100     END-EVALUATE.                                                09010000
090200                                                                  09020000
090210*----------------------------------------------------------------*09021000
090220* CLOSE INVOICE_CSR CURSOR                                       *09022000
090230*----------------------------------------------------------------*09023000
090300 Y200-CLOSE-INVOICE-CSR.                                          09030000
090400                                                                  09040000
090500     PERFORM WITH TEST AFTER                                      09050000
090600        VARYING PV-RETRY-COUNTER FROM 1 BY 1                      09060000
090700        UNTIL   PV-RETRY-COUNTER > PC-MAX-RETRIES OR              09070000
090800                SQLCODE = ZERO                                    09080000
090900         EXEC SQL                                                 09090000
091000             CLOSE INVOICE_CSR                                    09100000
091100         END-EXEC                                                 09110000
091200                                                                  09120000
091300        EVALUATE TRUE                                             09130000
091400            WHEN SQLCODE = ZERO                                   09140000
091500            WHEN SQLCODE = -904                                   09150000
091600            WHEN SQLCODE = -913                                   09160000
091700                 CONTINUE                                         09170000
091800            WHEN SQLWARN0 NOT = SPACES                            09180000
091900            WHEN SQLCODE  NOT = ZERO                              09190000
092000                 MOVE 'Y200-CLOSE-INVOICE-CSR'                    09200000
092100                                            TO AA-PARAGRAPH-NAME  09210000
092200                 MOVE 'UNSUCCESSFUL CLOSE'  TO AA-DB2-OPERATION   09220000
092400                 MOVE 'TINVOIC'             TO AA-DB2-TABLE-1     09240000
092500                 MOVE 'TALCHRG'             TO AA-DB2-TABLE-2     09250000
092510                 MOVE 'TACCTYP'             TO AA-DB2-TABLE-3     09251000
092520                 MOVE SPACES                TO AA-DB2-TABLE-4     09252000
092600                 PERFORM Z999-DB2-ABEND                           09260000
092700        END-EVALUATE                                              09270000
092800     END-PERFORM.                                                 09280000
092900                                                                  09290000
093000     IF PV-RETRY-COUNTER > PC-MAX-RETRIES                         09300000
093100         MOVE 'Y200-CLOSE-INVOICE-CSR'  TO AA-PARAGRAPH-NAME      09310000
093300         MOVE 'MAX RETRIES EXCEEDED ON CLOSE TINVOIC'             09330000
093400                                        TO AA-DB2-OPERATION       09340000
093500         PERFORM Z999-DB2-ABEND                                   09350000
093600     END-IF.                                                      09360000
093700                                                                  09370000
093800     EVALUATE TRUE                                                09380000
093900        WHEN SQLCODE = ZEROS                                      09390000
094000             CONTINUE                                             09400000
094100        WHEN OTHER                                                09410000
094200             MOVE 'Y200-CLOSE-INVOICE-CSR' TO AA-PARAGRAPH-NAME   09420000
094400             MOVE 'UNSUCCESSFUL CLOSE'     TO AA-DB2-OPERATION    09440000
094600             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      09460000
094700             MOVE 'TALCHRG'                TO AA-DB2-TABLE-2      09470000
094710             MOVE 'TACCTYP'                TO AA-DB2-TABLE-3      09471000
094720             MOVE SPACES                   TO AA-DB2-TABLE-4      09472000
094800             PERFORM Z999-DB2-ABEND                               09480000
094900     END-EVALUATE.                                                09490000
094901                                                                  09490100
094910*----------------------------------------------------------------*09491000
094920* DB2 ABEND ROUTINE                                              *09492000
094930*----------------------------------------------------------------*09493000
095000 Z999-DB2-ABEND.                                                  09500000
095100                                                                  09510000
095200     DISPLAY AA-ABEND-LIT.                                        09520000
095300     DISPLAY AA-DB2-ERROR-LIT.                                    09530000
095400     DISPLAY AA-PROGRAM-LIT.                                      09540000
095500     DISPLAY AA-PARAGRAPH-LIT.                                    09550000
095600     DISPLAY AA-DB2-OPERATION-LIT.                                09560000
095700     DISPLAY AA-DB2-TABLE-1.                                      09570000
095800     DISPLAY AA-DB2-TABLE-2.                                      09580000
095810     DISPLAY AA-DB2-TABLE-3.                                      09581000
095820     DISPLAY AA-DB2-TABLE-4.                                      09582000
095900     SET AC-DB2-ERROR TO TRUE.                                    09590000
096000                                                                  09600000
096100     COPY DPPD004.                                                09610000
096300     CALL 'ILBOABN0' USING ABEND-CODE.                            09630000
