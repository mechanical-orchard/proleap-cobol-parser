000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SUKUT097.                                00050000
000600 AUTHOR.                 GERMAN BANDA.                            00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            SEPTMEBER, 2003.                         00080001
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001100***************************************************************** 00110000
001200*                                                               * 00120000
001300*  THIS PROGRAM WILL CREATE AN EXTRACT FILE OF PO AUDIT REQUESTS* 00130000
001400*  TO CREATE ARCHIVE REPORTS. THE REQUESTED REPORT WILL BE      * 00140000
001500*  PROCESSED AND APPEAR IN RDS.                                 * 00150000
001600***************************************************************** 00160000
002500***************************************************************** 00250000
002600 ENVIRONMENT DIVISION.                                            00260000
002700***************************************************************** 00270000
002800                                                                  00280000
002900 CONFIGURATION SECTION.                                           00290000
003000                                                                  00300000
003100 SOURCE-COMPUTER.        IBM-3090.                                00310000
003200 OBJECT-COMPUTER.        IBM-3090.                                00320000
003300                                                                  00330000
003400 INPUT-OUTPUT SECTION.                                            00340000
003500                                                                  00350000
003600 FILE-CONTROL.                                                    00360000
003700*                                                                 00370000
004100     SELECT SU-EXTRACT-FILE                                       00410000
004200         ASSIGN TO OUT01.                                         00420000
004300*                                                                 00430000
004400***************************************************************** 00440000
004500 DATA DIVISION.                                                   00450000
004600***************************************************************** 00460000
004700*                                                                 00470000
004800 FILE SECTION.                                                    00480000
004900*                                                                 00490000
005700 FD  SU-EXTRACT-FILE                                              00570000
005800     RECORDING MODE IS F                                          00580000
005900     BLOCK CONTAINS 0  RECORDS.                                   00590000
006000 01  SU-EXTRACT-RECORD               PIC  X(069).                 00600000
006100*                                                                 00610000
006200                                                                  00620000
006300 WORKING-STORAGE SECTION.                                         00630000
006400*                                                                 00640000
006500 01  PROGRAM-SWITCHES.                                            00650000
006600     05  PS-END-OF-PO-AUD-REQ-CURSOR-SW PIC X(01)  VALUE 'N'.     00660001
006700         88  PS-END-OF-PO-AUD-REQ-CURSOR           VALUE 'Y'.     00670001
006800     05  PS-END-OF-TRIP-CURSOR-SW    PIC  X(01)    VALUE 'N'.     00680000
006900         88  PS-END-OF-TRIP-CURSOR                 VALUE 'Y'.     00690000
007000         88  PS-NOT-END-OF-TRIP-CURSOR             VALUE 'N'.     00700000
007100     05  PS-END-OF-CARTON-CURSOR-SW PIC   X(01)    VALUE 'N'.     00710000
007200         88  PS-END-OF-CARTON-CURSOR               VALUE 'Y'.     00720000
007300     05  PS-END-OF-CARDIN-SW         PIC  X(01)    VALUE 'N'.     00730000
007400         88  PS-END-OF-CARDIN                      VALUE 'Y'.     00740000
007500     05  PS-RECORD-TYPE-SW           PIC  X(01)    VALUE 'B'.     00750000
007600         88  PS-ERROR-RECORD                       VALUE 'A'.     00760000
007700         88  PS-DETAIL-RECORD                      VALUE 'B'.     00770000
007800*                                                                 00780000
007900 01  PC-CONSTANTS.                                                00790000
008000     05  PC-1                        PIC S9(03)    VALUE +1       00800000
008100                                                   COMP-3.        00810000
008200     05  PC-A                        PIC  X(01)    VALUE 'A'.     00820000
008300     05  PC-B                        PIC  X(01)    VALUE 'B'.     00830000
008400     05  PC-Y                        PIC  X(01)    VALUE 'Y'.     00840000
008500     05  PC-RCV                      PIC  X(03)    VALUE 'RCV'.   00850000
008510     05  PC-DEFAULT-TIMESTAMP        PIC  X(26)    VALUE          00851007
008520                                    '9999-09-09-09.09.09.999999'. 00852008
008600     05  PC-SUKUT097                 PIC  X(08)    VALUE          00860000
008700         'SUKUT097'.                                              00870000
008800*                                                                 00880000
008900 01  PV-MISC-FIELDS.                                              00890000
009000     05  PV-LINE-SUB                 PIC S9(03)    VALUE ZERO     00900000
009100                                                   COMP-3.        00910000
009200     05  PV-ABEND-CODE               PIC S9(04)    VALUE ZERO     00920000
009300                                                   COMP SYNC.     00930000
009400     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00940000
009500     05  PV-MANIFEST-X               PIC  X(09).                  00950000
009600     05  PV-MANIFEST REDEFINES PV-MANIFEST-X                      00960000
009700                                     PIC  9(09).                  00970000
009710     05  PV-RPT-REQUEST-TMST             PIC X(26).               00971005
009720     05  PV-RPT-REQUEST-TMST-R REDEFINES PV-RPT-REQUEST-TMST.     00972004
009730         10 PV-RPT-REQ-YY                PIC  X(04).              00973001
009740         10 FILLER                       PIC  X(01).              00974006
009750         10 PV-RPT-REQ-MM                PIC  X(02).              00975001
009760         10 FILLER                       PIC  X(01).              00976006
009770         10 PV-RPT-REQ-DD                PIC  X(02).              00977001
009780         10 FILLER                       PIC  X(01).              00978006
009790         10 PV-RPT-REQ-HR                PIC  X(02).              00979006
009791         10 FILLER                       PIC  X(01).              00979106
009792         10 PV-RPT-REQ-MIN               PIC  X(02).              00979206
009793         10 FILLER                       PIC  X(01).              00979306
009794         10 PV-RPT-REQ-SECONDS           PIC  X(02).              00979406
009795         10 FILLER                       PIC  X(07).              00979506
009800 EJECT                                                            00980000
009900*                                                                 00990000
010600     COPY SURD039.                                                01060000
010700                                                                  01070000
010800******************************************************************01080000
010900*  COPY BOOK FOR THE PO AUDIT REQUEST TABLE *                     01090000
011000******************************************************************01100000
011100     EXEC SQL                                                     01110000
011200          INCLUDE SUT00029                                        01120000
011300     END-EXEC.                                                    01130000
011400******************************************************************01140000
021900 EJECT                                                            02190000
022000*  DB2 COMMUNICATION AREA                                         02200000
022100*                                                                 02210000
022200     EXEC SQL                                                     02220000
022300         INCLUDE SQLCA                                            02230000
022400     END-EXEC.                                                    02240000
022500 EJECT                                                            02250000
022600*  DB2 COMMUNICATION AREA2                                        02260000
022700*                                                                 02270000
022800     COPY SQLCA2.                                                 02280000
022900 EJECT                                                            02290000
023000                                                                  02300000
023100                                                                  02310000
023200     EXEC SQL                                                     02320000
023300       DECLARE PO-AUD-REQ-CSR CURSOR FOR                          02330000
023400         SELECT DISTINCT                                          02340000
023500                USR_ID                                            02350000
023510              , RPT_REQ_TMST                                      02351000
023520              , PO_NBR                                            02352000
023530              , REC_SEQ_NBR                                       02353000
023540              , ORGN_LOC_NBR                                      02354000
023550              , DEST_LOC_NBR                                      02355000
023800          FROM  SUT_RPT_REQ                                       02380000
024500          WHERE RPT_CRE_TMST     =  :PC-DEFAULT-TIMESTAMP         02450007
024600          ORDER BY PO_NBR                                         02460010
025800     END-EXEC.                                                    02580000
029600                                                                  02960000
029700*                                                                 02970000
029800 PROCEDURE DIVISION.                                              02980000
029900*                                                                 02990000
030000 0000-MAINLINE-PROCESSING.                                        03000000
030100******************************************************************03010000
030200**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      03020000
030300******************************************************************03030000
030500     OPEN OUTPUT SU-EXTRACT-FILE.                                 03050002
030800*                                                                 03080000
030900     PERFORM 2000-PROCESS-TRAILER.                                03090000
031100                                                                  03110000
031300     CLOSE SU-EXTRACT-FILE.                                       03130001
031400*                                                                 03140000
031500     GOBACK.                                                      03150000
031600*                                                                 03160000
035200 2000-PROCESS-TRAILER.                                            03520000
035400     PERFORM 2100-OPEN-PO-AUD-REQ-CURSOR.                         03540001
035500                                                                  03550001
035600     PERFORM 2200-FETCH-PO-AUD-REQ-CURSOR                         03560001
035700                                                                  03570001
035800     PERFORM 2300-PROCESS-PO-AUD-REQ-CURSOR                       03580001
035900         UNTIL PS-END-OF-PO-AUD-REQ-CURSOR                        03590001
036000            OR PS-ERROR-RECORD.                                   03600000
036100                                                                  03610001
036200     PERFORM 2400-CLOSE-PO-AUD-REQ-CURSOR.                        03620002
036300                                                                  03630002
036310                                                                  03631002
036400 2100-OPEN-PO-AUD-REQ-CURSOR.                                     03640001
036500     MOVE '2100-OPEN-PO-AUD-REQ-CURSOR   '                        03650001
036600                                 TO PV-ABEND-PARAGRAPH.           03660000
036700     EXEC SQL                                                     03670000
036800         OPEN PO-AUD-REQ-CSR                                      03680000
036900     END-EXEC.                                                    03690000
036910                                                                  03691001
037000     EVALUATE TRUE                                                03700000
037100       WHEN SQLCODE = ZEROS                                       03710000
037200         CONTINUE                                                 03720000
037700       WHEN OTHER                                                 03770000
037800         DISPLAY PV-ABEND-PARAGRAPH                               03780000
037900         PERFORM Z999-SQL-ERROR                                   03790000
038000     END-EVALUATE.                                                03800000
038100                                                                  03810000
038200 2200-FETCH-PO-AUD-REQ-CURSOR.                                    03820001
038300     MOVE '2200-FETCH-PO-AUD-REQ-CURSOR   '                       03830001
038400                                 TO PV-ABEND-PARAGRAPH.           03840000
038500     EXEC SQL                                                     03850000
038600          FETCH PO-AUD-REQ-CSR                                    03860000
038700          INTO  :SUT00029-USR-ID                                  03870001
038800              , :SUT00029-RPT-REQ-TMST                            03880001
038900              , :SUT00029-PO-NBR                                  03890001
038910              , :SUT00029-REC-SEQ-NBR                             03891001
038920              , :SUT00029-ORGN-LOC-NBR                            03892001
038930              , :SUT00029-DEST-LOC-NBR                            03893001
039000     END-EXEC.                                                    03900000
039100                                                                  03910000
039200     EVALUATE TRUE                                                03920000
039300       WHEN SQLCODE = ZEROS                                       03930000
039400         CONTINUE                                                 03940000
039500       WHEN SQLCODE = +100                                        03950000
039600         SET PS-END-OF-PO-AUD-REQ-CURSOR TO TRUE                  03960001
040100       WHEN OTHER                                                 04010000
040200         DISPLAY PV-ABEND-PARAGRAPH                               04020000
040300         PERFORM Z999-SQL-ERROR                                   04030000
040400     END-EVALUATE.                                                04040000
040500                                                                  04050000
040600 2300-PROCESS-PO-AUD-REQ-CURSOR.                                  04060001
040610     INITIALIZE SU039-REQUEST-RECORD.                             04061001
040620                                                                  04062001
040700     MOVE SUT00029-USR-ID        TO SU039-TK-NBR.                 04070001
040900     MOVE SUT00029-PO-NBR        TO SU039-PO-NBR.                 04090001
040901                                                                  04090101
040910     IF SUT00029-REC-SEQ-NBR  >  0                                04091001
040920        SET SU039-NOT-ALL-RECEIVERS TO TRUE                       04092001
040930     ELSE                                                         04093001
040940        SET SU039-ALL-RECEIVERS TO TRUE                           04094001
040950     END-IF                                                       04095001
040960                                                                  04096001
041000     MOVE SUT00029-REC-SEQ-NBR   TO SU039-REC-SEQ-NBR.            04100001
041100     MOVE SUT00029-ORGN-LOC-NBR  TO SU039-OPER-UNT-ID.            04110001
041200     MOVE SUT00029-DEST-LOC-NBR  TO SU039-DEST-OPER-UNT-ID.       04120001
041210     MOVE SUT00029-RPT-REQ-TMST  TO PV-RPT-REQUEST-TMST.          04121001
041220     MOVE PV-RPT-REQ-YY          TO SU039-REQ-YY.                 04122001
041240     MOVE PV-RPT-REQ-MM          TO SU039-REQ-MM.                 04124001
041260     MOVE PV-RPT-REQ-DD          TO SU039-REQ-DD.                 04126001
041280     MOVE PV-RPT-REQ-HR          TO SU039-REQ-HRS                 04128001
041291     MOVE PV-RPT-REQ-MIN         TO SU039-REQ-MIN                 04129101
041293     MOVE PV-RPT-REQ-SECONDS     TO SU039-REQ-SEC.                04129301
041300                                                                  04130001
041400                                                                  04140001
041900     PERFORM 8000-WRITE-EXTRACT-RECORD.                           04190000
042000     PERFORM 2200-FETCH-PO-AUD-REQ-CURSOR.                        04200001
042100                                                                  04210000
042200                                                                  04220000
042300 2400-CLOSE-PO-AUD-REQ-CURSOR.                                    04230001
042400     MOVE '2400-CLOSE-PO-AUD-REQ-CURSOR   '                       04240001
042500                                 TO PV-ABEND-PARAGRAPH.           04250000
042600     EXEC SQL                                                     04260000
042700         CLOSE PO-AUD-REQ-CSR                                     04270000
042800     END-EXEC.                                                    04280000
042900     EVALUATE TRUE                                                04290000
043000       WHEN SQLCODE = ZEROS                                       04300000
043100         CONTINUE                                                 04310000
043600       WHEN OTHER                                                 04360000
043700         DISPLAY PV-ABEND-PARAGRAPH                               04370000
043800         PERFORM Z999-SQL-ERROR                                   04380000
043900     END-EVALUATE.                                                04390000
044000                                                                  04400000
080200*                                                                 08020000
080300 8000-WRITE-EXTRACT-RECORD.                                       08030000
080400     WRITE SU-EXTRACT-RECORD                                      08040000
080500       FROM SU039-REQUEST-RECORD.                                 08050001
080600*                                                                 08060000
080700******************************************************************08070000
080800*     SQL WARNING OR ERROR PROCESSING                            *08080000
080900*                                                                *08090000
081000******************************************************************08100000
081100                                                                  08110000
081200*                                                                 08120000
081300 Z999-SQL-ERROR.                                                  08130000
081400*---------------                                                  08140000
081500                                                                  08150000
081600     MOVE SQLCODE    TO SQLCODE2.                                 08160000
081700     MOVE SQLERRD(3) TO SQLERRD3.                                 08170000
081800     DISPLAY '** ABEND **       ** = SQLERROR'.                   08180000
081900     DISPLAY '** PROGRAM        ** = SUKUT097'.                   08190000
082000     DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  08200000
082100     DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  08210000
082200     DISPLAY '** SQLERRM        ** = ' SQLERRM.                   08220000
082300     DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  08230000
082400     EXEC SQL                                                     08240000
082500         COMMIT                                                   08250000
082600     END-EXEC.                                                    08260000
082700     MOVE +4013 TO PV-ABEND-CODE.                                 08270000
082800     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         08280000
