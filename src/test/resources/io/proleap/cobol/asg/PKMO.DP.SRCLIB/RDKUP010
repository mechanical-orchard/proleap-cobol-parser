000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400 PROGRAM-ID.         RDKUP010.                                    00040001
000500 AUTHOR.             BARB ERTL.                                   00050001
000600 INSTALLATION.       KOHLS DEPARTMENT STORES.                     00060001
000700 DATE-WRITTEN.       MAY 2003.                                    00070001
000800 DATE-COMPILED.                                                   00080001
000900                                                                  00090001
001000******************************************************************00100001
001100* THIS PROGRAM UPDATES (OR INSERTS) THE RDT_CUST AND            * 00110001
001200* RDT_MAL_CK_RFND TABLES.                                         00120001
001300*                                                                *00130001
001400*                                                                *00140001
001500* INPUT FILES:   UPDATE REFUND FILE        DDNAME = INP01        *00150001
001600*                                                                *00160001
001700* OUTPUT FILES:  N/A                                             *00170001
001800*                                                                *00180001
001900******************************************************************00180125
260107* CHG0260107   JIM HUNTER   08-19-21   ADD COPYBOOK DPWS991 TO    00181025
260107*                                      MAKE DPKUT901 CALL DYNAMIC.00182025
001900******************************************************************00190001
002000 ENVIRONMENT DIVISION.                                            00200001
002100******************************************************************00210001
002200                                                                  00220001
002300 CONFIGURATION SECTION.                                           00230001
002400                                                                  00240001
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250001
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260001
002700                                                                  00270001
002800 INPUT-OUTPUT SECTION.                                            00280001
002900                                                                  00290001
003000 FILE-CONTROL.                                                    00300001
003100                                                                  00310001
003200******************************************************************00320001
003300 DATA DIVISION.                                                   00330001
003400******************************************************************00340001
003500                                                                  00350001
003600 WORKING-STORAGE SECTION.                                         00360001
003700                                                                  00370001
003800 01  ABEND-CODE                  PIC S9(04)     VALUE +0  COMP.   00380001
003900                                                                  00390001
004000******************************************************************00400001
004100*PC - PROGRAM CONSTANTS                                           00410001
004200******************************************************************00420001
004300 01  PROGRAM-CONSTANTS.                                           00430001
004400     05  PC-MAX-RETRIES          PIC S9(04)     VALUE +3          00440001
004500                                                COMP SYNC.        00450001
004600     05  PC-MAX-DEADLOCKS        PIC S9(04)     VALUE +3          00460001
004700                                                COMP SYNC.        00470001
004800     05  PC-CKPT-JOB-NAME        PIC  X(08)     VALUE 'RDK015  '. 00480001
004900     05  PC-CKPT-PLAN-NAME       PIC  X(08)     VALUE 'RDKUP010'. 00490001
005000     05  PC-CURRENT-PROGRAM-NAME PIC  X(08)     VALUE 'RDKUP010'. 00500001
005100                                                                  00510001
005200     05  PC-TRAN-PRES-FUNC-CODES.                                 00520001
005300         10  PC-TRAN-PRES-FUNC-OPEN   PIC  X(05)  VALUE 'OPEN '.  00530001
005400         10  PC-TRAN-PRES-FUNC-TRANS  PIC  X(05)  VALUE 'TRANS'.  00540001
005500         10  PC-TRAN-PRES-FUNC-RSTRT  PIC  X(05)  VALUE 'RSTRT'.  00550001
005600         10  PC-TRAN-PRES-FUNC-CLOSE  PIC  X(05)  VALUE 'CLOSE'.  00560001
005700                                                                  00570001
005800     05  PC-MINUS-ONE            PIC S9(01)     VALUE -1.         00580001
005900                                                                  00590001
006000******************************************************************00600001
006100*PV - PROGRAM VARIABLES                                           00610001
006200******************************************************************00620001
006300 01  PROGRAM-VARIABLES.                                           00630001
006400     05  PV-SQL-SUB                   PIC  9(03)   VALUE ZERO.    00640001
006500     05  PV-DEADLOCK-COUNTER          PIC  9(03)   VALUE ZERO.    00650001
006600     05  PV-PARAGRAPH-NAME            PIC  X(30)   VALUE SPACE.   00660001
006700     05  PV-DB2-OPER-ATTEMPTED        PIC  X(30)   VALUE SPACE.   00670001
006800     05  PV-CURRENT-TIMESTAMP         PIC  X(26)   VALUE SPACES.  00680001
006900     05  PV-DISPLAY-COUNT             PIC ZZ,ZZZ,ZZZ,ZZ9.         00690009
007000                                                                  00700001
007100******************************************************************00710001
007200*PS - PROGRAM SWITCHES                                            00720001
007300******************************************************************00730001
007400 01  PROGRAM-SWITCHES.                                            00740001
007500     05  PS-RESTART-REQUIRED-SW  PIC X(01)      VALUE 'N'.        00750001
007600         88  PS-RESTART-REQUIRED                VALUE 'Y'.        00760001
007700         88  PS-RESTART-NOT-REQUIRED            VALUE 'N'.        00770001
007800     05  PS-CUSTOMER-FOUND-SW    PIC X(01)      VALUE 'N'.        00780001
007900         88  PS-CUST-FOUND                      VALUE 'Y'.        00790001
008000         88  PS-CUST-NOT-FOUND                  VALUE 'N'.        00800001
008100         88  PS-MULT-CUST-FOUND                 VALUE 'M'.        00810014
008200     05  PS-UPDATE-NEEDED-SW     PIC X(01)      VALUE 'N'.        00820002
008300         88  PS-UPDATE-NEEDED                   VALUE 'Y'.        00830002
008400         88  PS-UPDATE-NOT-NEEDED               VALUE 'N'.        00840002
008500     05  PS-UPDATE-PHONE-SW      PIC X(01)      VALUE 'N'.        00850015
008600         88  PS-UPDATE-PHONE                    VALUE 'Y'.        00860015
008700         88  PS-PHONE-UPD-NOT-NEEDED            VALUE 'N'.        00870018
008800                                                                  00880001
008900******************************************************************00890001
009000*      NULL INDICATORS                                           *00900001
009100******************************************************************00910001
009200 01  NI-NULL-INDICATORS.                                          00920001
009300     05  NI-PHN                         PIC S9(04) COMP   VALUE 0.00930001
009400                                                                  00940001
009500******************************************************************00950001
009600*      UPDATE REFUND RECORD LAYOUT                               *00960001
009700******************************************************************00970001
009800     COPY RDRD037.                                                00980001
009900                                                                  00990001
010000******************************************************************01000001
010100**   DCLGEN FOR TABLE RDT_CUST                                    01010001
010200******************************************************************01020001
010300     EXEC SQL                                                     01030001
010400         INCLUDE RDT00000                                         01040001
010500     END-EXEC.                                                    01050001
010600                                                                  01060001
010700******************************************************************01070001
010800**   DCLGEN FOR TABLE RDT_MAL_CK_RFND                             01080001
010900******************************************************************01090001
011000     EXEC SQL                                                     01100001
011100         INCLUDE RDT00001                                         01110001
011200     END-EXEC.                                                    01120001
011300                                                                  01130001
011400******************************************************************01140001
011500*  SQL COMMUNICATIONS WORK AREA                                  *01150001
011600******************************************************************01160001
011700     COPY SQLCA2.                                                 01170001
011800                                                                  01180001
011900******************************************************************01190001
012000*  DB2 FORMATTED ERROR MESSAGE                                   *01200001
012100******************************************************************01210001
012200     COPY DPWS004.                                                01220001
012300                                                                  01230001
012400******************************************************************01240001
012500*  TRANSACTION PREPARATION MODULE COMMUNICATIONS AREA            *01250001
012600******************************************************************01260001
260107     COPY DPWS991.                                                01270025
012700                                                                  01271025
012700     COPY DPLS001.                                                01272025
012800     05  WORK-STORAGE-PASSED.                                     01280001
012900******************************************************************01290001
013000*PA - PROGRAM ACCUMULATORS                                        01300001
013100******************************************************************01310001
013200         10  PROGRAM-ACCUMULATORS.                                01320001
013300             15  PA-CUST-ROWS-UPDATED      PIC S9(11)  VALUE ZERO 01330001
013400                                                       COMP-3.    01340001
013500             15  PA-CUST-ROWS-INSERTED     PIC S9(11)  VALUE ZERO 01350001
013600                                                       COMP-3.    01360001
013700             15  PA-REFUND-ROWS-INSERTED   PIC S9(11)  VALUE ZERO 01370001
013800                                                       COMP-3.    01380001
013900                                                                  01390001
014000 01  FILLER                          PIC X(4096)  VALUE SPACE.    01400001
014100******************************************************************01410001
014200*  COMMUNICATIONS AREA FOR DB2                                   *01420001
014300******************************************************************01430001
014400     EXEC SQL                                                     01440001
014500         INCLUDE SQLCA                                            01450001
014600     END-EXEC.                                                    01460001
014700                                                                  01470001
014800******************************************************************01480001
014900 PROCEDURE DIVISION.                                              01490001
015000******************************************************************01500001
015100 0000-MAINLINE.                                                   01510001
015200                                                                  01520001
015300     PERFORM 1000-INITIALIZE.                                     01530001
015400                                                                  01540001
015500     PERFORM 2000-PROCESS-UPDATE-RECORDS                          01550001
015600         UNTIL DP001-PREP-TRANS-EOF.                              01560001
015700                                                                  01570001
015800     PERFORM 3000-EOJ-ROUTINE.                                    01580001
015900                                                                  01590001
016000     GOBACK.                                                      01600001
016100                                                                  01610001
016200******************************************************************01620001
016300*     1000-INITIALIZE                                            *01630001
016400* ==> PROCESSES:                                                 *01640001
016500* ==> PERFORMED FROM: 0000-MAINLINE                              *01650001
016600******************************************************************01660001
016700 1000-INITIALIZE.                                                 01670001
016800                                                                  01680001
016900     MOVE PC-TRAN-PRES-FUNC-OPEN TO DP001-FUNC-CODE.              01690001
017000     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      01700001
017100                                                                  01710001
017200******************************************************************01720001
017300*     2000-PROCESS-UPDATE-RECORDS                                *01730001
017400* ==> PROCESSES:                                                 *01740001
017500* ==> PERFORMED FROM: 0000-MAINLINE                              *01750001
017600******************************************************************01760001
017700 2000-PROCESS-UPDATE-RECORDS.                                     01770001
017800                                                                  01780001
017900     SET PS-RESTART-NOT-REQUIRED                                  01790016
018000         PS-CUST-NOT-FOUND TO TRUE.                               01800016
018100                                                                  01810001
018200     IF RD037-DRV-LIC-NBR GREATER THAN SPACES                     01820001
018300         PERFORM 5000-SELECT-CUST-BY-DL                           01830001
018400         IF PS-CUST-FOUND                                         01840001
018500             PERFORM 5500-CHECK-FOR-UPDATE                        01850001
018600         ELSE                                                     01860001
018700             IF PS-MULT-CUST-FOUND                                01870013
018800                 PERFORM 5200-SELECT-CUST-BY-DL-NAME              01880013
018900                 IF PS-CUST-FOUND                                 01890013
019000                     PERFORM 5500-CHECK-FOR-UPDATE                01900013
019100                 ELSE                                             01910013
019200                     PERFORM 5100-SELECT-CUST-BY-NAME             01920013
019300                     IF PS-CUST-FOUND                             01930013
019400                         PERFORM 5500-CHECK-FOR-UPDATE            01940013
019500                     ELSE                                         01950013
019600                         PERFORM 7000-INSERT-CUSTOMER             01960013
019700                         IF RD037-PHN-NBR GREATER THAN SPACES     01970013
019800                            MOVE RD037-PHN-NBR TO RDT00000-PHN-NBR01980013
019900                             PERFORM 7200-UPDATE-PHONE            01990013
020000                         END-IF                                   02000013
020100                     END-IF                                       02010013
020200                 END-IF                                           02020013
020300             ELSE                                                 02030016
020400                 PERFORM 5100-SELECT-CUST-BY-NAME                 02040016
020500                 IF PS-CUST-FOUND                                 02050016
020600                     PERFORM 5500-CHECK-FOR-UPDATE                02060016
020700                 ELSE                                             02070016
020800                     PERFORM 7000-INSERT-CUSTOMER                 02080016
020900                     IF RD037-PHN-NBR GREATER THAN SPACES         02090016
021000                        MOVE RD037-PHN-NBR TO RDT00000-PHN-NBR    02100016
021100                         PERFORM 7200-UPDATE-PHONE                02110016
021200                     END-IF                                       02120016
021300                 END-IF                                           02130016
021400             END-IF                                               02140001
021500         END-IF                                                   02150001
021600     ELSE                                                         02160001
021700         PERFORM 5100-SELECT-CUST-BY-NAME                         02170001
021800         IF PS-CUST-FOUND                                         02180001
021900             PERFORM 5500-CHECK-FOR-UPDATE                        02190001
022000         ELSE                                                     02200001
022100             PERFORM 7000-INSERT-CUSTOMER                         02210001
022200             IF RD037-PHN-NBR GREATER THAN SPACES                 02220002
022300                 MOVE RD037-PHN-NBR TO RDT00000-PHN-NBR           02230002
022400                 PERFORM 7200-UPDATE-PHONE                        02240002
022500             END-IF                                               02250002
022600         END-IF                                                   02260001
022700     END-IF.                                                      02270001
022800                                                                  02280001
022900     PERFORM 8000-INSERT-REFUND.                                  02290001
023000                                                                  02300001
023100*----------------------------------------------------------------*02310001
023200*  IF A RESTART IS REQUIRED, ISSUE A RESTART CALL RATHER THAN A  *02320001
023300*  TRANS CALL.  THIS WILL ALLOW PROCESSING TO RESUME WITH THE    *02330001
023400*  FIRST TRANSACTION AFTER THE LAST COMMIT.                      *02340001
023500*----------------------------------------------------------------*02350001
023600     IF PS-RESTART-REQUIRED                                       02360001
023700         MOVE PC-TRAN-PRES-FUNC-RSTRT TO DP001-FUNC-CODE          02370001
023800     ELSE                                                         02380001
023900         MOVE PC-TRAN-PRES-FUNC-TRANS TO DP001-FUNC-CODE          02390001
024000     END-IF.                                                      02400001
024100                                                                  02410001
024200     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      02420001
024300                                                                  02430001
024400******************************************************************02440001
024500*     3000-EOJ-ROUTINE                                           *02450001
024600* ==> PROCESSES:                                                 *02460001
024700* ==> PERFORMED FROM: 0000-MAINLINE                              *02470001
024800******************************************************************02480001
024900 3000-EOJ-ROUTINE.                                                02490001
025000                                                                  02500001
025100     MOVE PA-CUST-ROWS-UPDATED      TO PV-DISPLAY-COUNT.          02510007
025200     DISPLAY 'CUST ROWS UPDATED    ' PV-DISPLAY-COUNT.            02520007
025300     MOVE PA-CUST-ROWS-INSERTED     TO PV-DISPLAY-COUNT.          02530007
025400     DISPLAY 'CUST ROWS INSERTED   ' PV-DISPLAY-COUNT.            02540007
025500     MOVE PA-REFUND-ROWS-INSERTED   TO PV-DISPLAY-COUNT.          02550007
025600     DISPLAY 'REFUND ROWS INSERTED ' PV-DISPLAY-COUNT.            02560007
025700                                                                  02570007
025800     MOVE PC-TRAN-PRES-FUNC-CLOSE TO DP001-FUNC-CODE.             02580001
025900     PERFORM 4000-BUILD-COMM-AREA-TRAN-PRES.                      02590001
026000                                                                  02600001
026100******************************************************************02610001
026200*     4000-BUILD-COMM-AREA-TRAN-PRES                             *02620001
026300* ==> PROCESSES:                                                 *02630001
026400*     - BUILD THE COMMUNICATION AREA FOR A CALL TO THE           *02640001
026500*       TRANSACTION PRESENTATION MODULE.                         *02650001
026600* ==> PERFORMED FROM:                                            *02660001
026700******************************************************************02670001
026800 4000-BUILD-COMM-AREA-TRAN-PRES.                                  02680001
026900                                                                  02690001
027000     MOVE LENGTH OF WORK-STORAGE-PASSED                           02700001
027100                                       TO DP001-WORK-STRG-LENGTH. 02710001
027200     MOVE PC-CKPT-JOB-NAME             TO DP001-JOB-NAME.         02720001
027300     MOVE PC-CKPT-PLAN-NAME            TO DP001-PLAN-NAME.        02730001
027400     PERFORM Z900-CALL-TRANS-PRES-MODULE.                         02740003
027500     MOVE DP001-TRANS-RECORD           TO RD037-RECORD.           02750001
027600     IF DP001-CKPT-TAKEN                                          02760001
027700         INITIALIZE PV-DEADLOCK-COUNTER                           02770001
027800     END-IF.                                                      02780001
027900                                                                  02790001
028000******************************************************************02800001
028100*     5000-SELECT-CUST-BY-DL                                     *02810001
028200* ==> PROCESSES:                                                 *02820001
028300*     - TRIES TO SELECT THE CUSTOMER BY DRIVER LICENSE           *02830001
028400* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *02840001
028500******************************************************************02850001
028600 5000-SELECT-CUST-BY-DL.                                          02860001
028700                                                                  02870001
028800     MOVE ZERO TO NI-PHN.                                         02880001
028900                                                                  02890001
029000     PERFORM WITH TEST AFTER                                      02900001
029100         VARYING PV-SQL-SUB                                       02910001
029200         FROM 1 BY 1                                              02920001
029300         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       02930001
029400                OR SQLCODE = -911                                 02940001
029500                OR SQLCODE = -811                                 02950012
029600                OR SQLCODE = 0                                    02960005
029700                OR SQLCODE = +100)                                02970005
029800                                                                  02980001
029900         EXEC SQL                                                 02990001
030000            SELECT  CUST_ID                                       03000001
030100                   ,DRV_LIC_NBR                                   03010001
030200                   ,LAST_NM                                       03020001
030300                   ,FRST_NM                                       03030001
030400                   ,M2A_LNE_1_ADDR                                03040001
030500                   ,M2A_CTY_NM                                    03050001
030600                   ,M2A_ST_CDE                                    03060001
030700                   ,M2A_PSTL_CDE                                  03070001
030800                   ,PHN_NBR                                       03080004
030900                   ,LAST_UPD_DTE                                  03090001
031000              INTO  :RDT00000-CUST-ID                             03100001
031100                   ,:RDT00000-DRV-LIC-NBR                         03110001
031200                   ,:RDT00000-LAST-NM                             03120001
031300                   ,:RDT00000-FRST-NM                             03130001
031400                   ,:RDT00000-M2A-LNE-1-ADDR                      03140001
031500                   ,:RDT00000-M2A-CTY-NM                          03150003
031600                   ,:RDT00000-M2A-ST-CDE                          03160003
031700                   ,:RDT00000-M2A-PSTL-CDE                        03170003
031800                   ,:RDT00000-PHN-NBR :NI-PHN                     03180001
031900                   ,:RDT00000-LAST-UPD-DTE                        03190001
032000              FROM  RDT_CUST                                      03200001
032100             WHERE DRV_LIC_NBR   = :RD037-DRV-LIC-NBR             03210001
032200               AND M2A_ST_CDE    = :RD037-M2A-ST-CDE              03220017
032300              WITH UR                                             03230002
032400         END-EXEC                                                 03240001
032500                                                                  03250001
032600         EVALUATE TRUE                                            03260001
032700             WHEN SQLCODE = 0                                     03270001
032800                 SET PS-CUST-FOUND TO TRUE                        03280001
032900                 IF NI-PHN < 0                                    03290001
033000                     MOVE SPACES TO RDT00000-PHN-NBR              03300001
033100                 END-IF                                           03310001
033200             WHEN SQLCODE = +100                                  03320001
033300                 SET PS-CUST-NOT-FOUND TO TRUE                    03330013
033400             WHEN SQLCODE = -811                                  03340011
033500                 SET PS-MULT-CUST-FOUND TO TRUE                   03350013
033600             WHEN SQLCODE = -911                                  03360001
033700                 ADD +1 TO PV-DEADLOCK-COUNTER                    03370001
033800                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        03380001
033900                     MOVE '5000-SELECT-CUST-BY-DL    '            03390001
034000                                      TO PV-PARAGRAPH-NAME        03400001
034100                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        03410001
034200                                      TO PV-DB2-OPER-ATTEMPTED    03420001
034300                     PERFORM 9999-SQL-ABEND                       03430001
034400                 ELSE                                             03440001
034500                     SET PS-RESTART-REQUIRED TO TRUE              03450001
034600                 END-IF                                           03460001
034700             WHEN OTHER                                           03470001
034800                 MOVE '5000-SELECT-CUST-BY-DL    '                03480001
034900                                      TO PV-PARAGRAPH-NAME        03490001
035000                 MOVE 'SELECT ORIGINAL TRANS REFUND '             03500001
035100                                      TO PV-DB2-OPER-ATTEMPTED    03510001
035200                 PERFORM 9999-SQL-ABEND                           03520001
035300         END-EVALUATE                                             03530001
035400     END-PERFORM.                                                 03540001
035500                                                                  03550001
035600     IF PV-SQL-SUB > PC-MAX-RETRIES                               03560001
035700         MOVE '5000-SELECT-CUST-BY-DL    '                        03570001
035800                                      TO PV-PARAGRAPH-NAME        03580001
035900         MOVE 'SELECT RETRIES EXCEEDED       '                    03590005
036000                                      TO PV-DB2-OPER-ATTEMPTED    03600001
036100         PERFORM 9999-SQL-ABEND                                   03610001
036200     END-IF.                                                      03620001
036300                                                                  03630001
036400******************************************************************03640002
036500*     5100-SELECT-CUST-BY-NAME                                   *03650002
036600* ==> PROCESSES:                                                 *03660002
036700*     - TRIES TO SELECT THE CUSTOMER BY NAME AND ADDR LINE 1     *03670002
036800* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *03680002
036900******************************************************************03690002
037000 5100-SELECT-CUST-BY-NAME.                                        03700002
037100                                                                  03710002
037200     MOVE ZERO TO NI-PHN.                                         03720002
037300                                                                  03730002
037400     PERFORM WITH TEST AFTER                                      03740002
037500         VARYING PV-SQL-SUB                                       03750002
037600         FROM 1 BY 1                                              03760002
037700         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       03770002
037800                OR SQLCODE = -911                                 03780002
037900                OR SQLCODE = 0                                    03790005
038000                OR SQLCODE = -811                                 03800023
038100                OR SQLCODE = +100)                                03810005
038200                                                                  03820002
038300         EXEC SQL                                                 03830002
038400            SELECT  CUST_ID                                       03840002
038500                   ,DRV_LIC_NBR                                   03850002
038600                   ,LAST_NM                                       03860002
038700                   ,FRST_NM                                       03870002
038800                   ,M2A_LNE_1_ADDR                                03880002
038900                   ,M2A_CTY_NM                                    03890002
039000                   ,M2A_ST_CDE                                    03900002
039100                   ,M2A_PSTL_CDE                                  03910002
039200                   ,PHN_NBR                                       03920004
039300                   ,LAST_UPD_DTE                                  03930002
039400              INTO  :RDT00000-CUST-ID                             03940002
039500                   ,:RDT00000-DRV-LIC-NBR                         03950002
039600                   ,:RDT00000-LAST-NM                             03960002
039700                   ,:RDT00000-FRST-NM                             03970002
039800                   ,:RDT00000-M2A-LNE-1-ADDR                      03980002
039900                   ,:RDT00000-M2A-CTY-NM                          03990003
040000                   ,:RDT00000-M2A-ST-CDE                          04000003
040100                   ,:RDT00000-M2A-PSTL-CDE                        04010003
040200                   ,:RDT00000-PHN-NBR :NI-PHN                     04020002
040300                   ,:RDT00000-LAST-UPD-DTE                        04030002
040400              FROM  RDT_CUST                                      04040002
040500             WHERE LAST_NM        = :RD037-LAST-NM                04050002
040600               AND FRST_NM        = :RD037-FRST-NM                04060002
040700               AND M2A_LNE_1_ADDR = :RD037-M2A-LNE-1-ADDR         04070004
040800              WITH UR                                             04080002
040900         END-EXEC                                                 04090002
041000                                                                  04100002
041100         EVALUATE TRUE                                            04110002
041200             WHEN SQLCODE = 0                                     04120002
041300                 SET PS-CUST-FOUND TO TRUE                        04130002
041400                 IF NI-PHN < 0                                    04140002
041500                     MOVE SPACES TO RDT00000-PHN-NBR              04150002
041600                 END-IF                                           04160002
041700             WHEN SQLCODE = +100                                  04170002
041800                 SET PS-CUST-NOT-FOUND TO TRUE                    04180002
041900             WHEN SQLCODE = -811                                  04190024
042000                 SET PS-CUST-NOT-FOUND TO TRUE                    04200024
042100                 DISPLAY 'MULTIPLE CUSTOMERS FOUND'               04210024
042200                 DISPLAY RD037-LAST-NM                            04220024
042300                 DISPLAY RD037-FRST-NM                            04230024
042400                 DISPLAY RD037-M2A-LNE-1-ADDR                     04240024
042500             WHEN SQLCODE = -911                                  04250002
042600                 ADD +1 TO PV-DEADLOCK-COUNTER                    04260002
042700                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        04270002
042800                     MOVE '5100-SELECT-CUST-BY-NAME  '            04280002
042900                                      TO PV-PARAGRAPH-NAME        04290002
043000                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        04300002
043100                                      TO PV-DB2-OPER-ATTEMPTED    04310002
043200                     PERFORM 9999-SQL-ABEND                       04320002
043300                 ELSE                                             04330002
043400                     SET PS-RESTART-REQUIRED TO TRUE              04340002
043500                 END-IF                                           04350002
043600             WHEN OTHER                                           04360002
043700                 MOVE '5100-SELECT-CUST-BY-NAME  '                04370002
043800                                      TO PV-PARAGRAPH-NAME        04380002
043900                 MOVE 'SELECT ORIGINAL TRANS REFUND '             04390002
044000                                      TO PV-DB2-OPER-ATTEMPTED    04400002
044100                 PERFORM 9999-SQL-ABEND                           04410002
044200         END-EVALUATE                                             04420002
044300     END-PERFORM.                                                 04430002
044400                                                                  04440002
044500     IF PV-SQL-SUB > PC-MAX-RETRIES                               04450002
044600         MOVE '5100-SELECT-CUST-BY-NAME  '                        04460002
044700                                      TO PV-PARAGRAPH-NAME        04470002
044800         MOVE 'VERIFY RETRIES EXCEEDED       '                    04480002
044900                                      TO PV-DB2-OPER-ATTEMPTED    04490002
045000         PERFORM 9999-SQL-ABEND                                   04500002
045100     END-IF.                                                      04510002
045200                                                                  04520002
045300******************************************************************04530013
045400*     5200-SELECT-CUST-BY-DL-NAME                                *04540013
045500* ==> PROCESSES:                                                 *04550013
045600*     - TRIES TO SELECT THE CUSTOMER BY DRIVER LICENSE AND LAST  *04560013
045700*       NAME                                                     *04570013
045800* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *04580013
045900******************************************************************04590013
046000 5200-SELECT-CUST-BY-DL-NAME.                                     04600013
046100                                                                  04610013
046200     MOVE ZERO TO NI-PHN.                                         04620013
046300                                                                  04630013
046400     PERFORM WITH TEST AFTER                                      04640013
046500         VARYING PV-SQL-SUB                                       04650013
046600         FROM 1 BY 1                                              04660013
046700         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       04670013
046800                OR SQLCODE = -911                                 04680013
046900                OR SQLCODE = 0                                    04690013
047000                OR SQLCODE = -811                                 04700022
047100                OR SQLCODE = +100)                                04710013
047200                                                                  04720013
047300         EXEC SQL                                                 04730013
047400            SELECT  CUST_ID                                       04740013
047500                   ,DRV_LIC_NBR                                   04750013
047600                   ,LAST_NM                                       04760013
047700                   ,FRST_NM                                       04770013
047800                   ,M2A_LNE_1_ADDR                                04780013
047900                   ,M2A_CTY_NM                                    04790013
048000                   ,M2A_ST_CDE                                    04800013
048100                   ,M2A_PSTL_CDE                                  04810013
048200                   ,PHN_NBR                                       04820013
048300                   ,LAST_UPD_DTE                                  04830013
048400              INTO  :RDT00000-CUST-ID                             04840013
048500                   ,:RDT00000-DRV-LIC-NBR                         04850013
048600                   ,:RDT00000-LAST-NM                             04860013
048700                   ,:RDT00000-FRST-NM                             04870013
048800                   ,:RDT00000-M2A-LNE-1-ADDR                      04880013
048900                   ,:RDT00000-M2A-CTY-NM                          04890013
049000                   ,:RDT00000-M2A-ST-CDE                          04900013
049100                   ,:RDT00000-M2A-PSTL-CDE                        04910013
049200                   ,:RDT00000-PHN-NBR :NI-PHN                     04920013
049300                   ,:RDT00000-LAST-UPD-DTE                        04930013
049400              FROM  RDT_CUST                                      04940013
049500             WHERE DRV_LIC_NBR    = :RD037-DRV-LIC-NBR            04950014
049600               AND LAST_NM        = :RD037-LAST-NM                04960013
049700               AND M2A_ST_CDE     = :RD037-M2A-ST-CDE             04970017
049800              WITH UR                                             04980013
049900         END-EXEC                                                 04990013
050000                                                                  05000013
050100         EVALUATE TRUE                                            05010013
050200             WHEN SQLCODE = 0                                     05020013
050300                 SET PS-CUST-FOUND TO TRUE                        05030013
050400                 IF NI-PHN < 0                                    05040013
050500                     MOVE SPACES TO RDT00000-PHN-NBR              05050013
050600                 END-IF                                           05060013
050700             WHEN SQLCODE = +100                                  05070013
050800                 SET PS-CUST-NOT-FOUND TO TRUE                    05080013
050900             WHEN SQLCODE = -811                                  05090021
051000                 SET PS-MULT-CUST-FOUND TO TRUE                   05100021
051100             WHEN SQLCODE = -911                                  05110013
051200                 ADD +1 TO PV-DEADLOCK-COUNTER                    05120013
051300                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        05130013
051400                     MOVE '5200-SELECT-CUST-BY-DL-NAME'           05140013
051500                                      TO PV-PARAGRAPH-NAME        05150013
051600                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        05160013
051700                                      TO PV-DB2-OPER-ATTEMPTED    05170013
051800                     PERFORM 9999-SQL-ABEND                       05180013
051900                 ELSE                                             05190013
052000                     SET PS-RESTART-REQUIRED TO TRUE              05200013
052100                 END-IF                                           05210013
052200             WHEN OTHER                                           05220013
052300                 MOVE '5200-SELECT-CUST-BY-DL-NAME'               05230013
052400                                      TO PV-PARAGRAPH-NAME        05240013
052500                 MOVE 'SELECT ORIGINAL TRANS REFUND '             05250013
052600                                      TO PV-DB2-OPER-ATTEMPTED    05260013
052700                 PERFORM 9999-SQL-ABEND                           05270013
052800         END-EVALUATE                                             05280013
052900     END-PERFORM.                                                 05290013
053000                                                                  05300013
053100     IF PV-SQL-SUB > PC-MAX-RETRIES                               05310013
053200         MOVE '5200-SELECT-CUST-BY-DL-NAME'                       05320013
053300                                      TO PV-PARAGRAPH-NAME        05330013
053400         MOVE 'VERIFY RETRIES EXCEEDED       '                    05340013
053500                                      TO PV-DB2-OPER-ATTEMPTED    05350013
053600         PERFORM 9999-SQL-ABEND                                   05360013
053700     END-IF.                                                      05370013
053800                                                                  05380013
053900******************************************************************05390013
054000*     5500-CHECK-FOR-UPDATE                                      *05400002
054100* ==> PROCESSES:                                                 *05410002
054200*     - CHECKS TO SEE IF INFO ON INPUT RECORD IS MORE CURRENT    *05420002
054300*       THAN WHAT IS IN THE TABLE                                *05430002
054400* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *05440002
054500******************************************************************05450002
054600 5500-CHECK-FOR-UPDATE.                                           05460002
054700                                                                  05470002
054800     SET PS-UPDATE-NOT-NEEDED                                     05480015
054900         PS-PHONE-UPD-NOT-NEEDED TO TRUE.                         05490015
055000                                                                  05500002
055100     IF RDT00000-LAST-UPD-DTE GREATER THAN RD037-RFND-REQ-DTE     05510002
055200         CONTINUE                                                 05520002
055300     ELSE                                                         05530002
055400         IF RDT00000-DRV-LIC-NBR NOT = RD037-DRV-LIC-NBR          05540002
055500             IF RD037-DRV-LIC-NBR GREATER THAN SPACES             05550002
055600                 MOVE RD037-DRV-LIC-NBR TO RDT00000-DRV-LIC-NBR   05560002
055700                 SET PS-UPDATE-NEEDED TO TRUE                     05570017
055800             END-IF                                               05580002
055900         END-IF                                                   05590002
056000         IF RDT00000-LAST-NM NOT = RD037-LAST-NM                  05600002
056100             IF RD037-LAST-NM GREATER THAN SPACES                 05610002
056200                 MOVE RD037-LAST-NM     TO RDT00000-LAST-NM       05620002
056300                 SET PS-UPDATE-NEEDED TO TRUE                     05630017
056400             END-IF                                               05640002
056500         END-IF                                                   05650002
056600         IF RDT00000-FRST-NM NOT = RD037-FRST-NM                  05660002
056700             IF RD037-FRST-NM GREATER THAN SPACES                 05670002
056800                 MOVE RD037-FRST-NM     TO RDT00000-FRST-NM       05680002
056900                 SET PS-UPDATE-NEEDED TO TRUE                     05690017
057000             END-IF                                               05700002
057100         END-IF                                                   05710002
057200         IF RDT00000-M2A-LNE-1-ADDR NOT =                         05720002
057300                                         RD037-M2A-LNE-1-ADDR     05730002
057400             IF RD037-M2A-LNE-1-ADDR GREATER THAN SPACES          05740002
057500                 MOVE RD037-M2A-LNE-1-ADDR TO                     05750002
057600                                         RDT00000-M2A-LNE-1-ADDR  05760002
057700                 SET PS-UPDATE-NEEDED TO TRUE                     05770017
057800             END-IF                                               05780002
057900         END-IF                                                   05790002
058000         IF RDT00000-M2A-CTY-NM NOT = RD037-M2A-CTY-NM            05800002
058100             IF RD037-M2A-CTY-NM GREATER THAN SPACES              05810002
058200                 MOVE RD037-M2A-CTY-NM TO RDT00000-M2A-CTY-NM     05820002
058300                 SET PS-UPDATE-NEEDED TO TRUE                     05830017
058400             END-IF                                               05840002
058500         END-IF                                                   05850002
058600         IF RDT00000-M2A-ST-CDE NOT = RD037-M2A-ST-CDE            05860002
058700             IF RD037-M2A-ST-CDE GREATER THAN SPACES              05870002
058800                 MOVE RD037-M2A-ST-CDE TO RDT00000-M2A-ST-CDE     05880002
058900                 SET PS-UPDATE-NEEDED TO TRUE                     05890017
059000             END-IF                                               05900002
059100         END-IF                                                   05910002
059200         IF RDT00000-M2A-PSTL-CDE NOT = RD037-M2A-PSTL-CDE        05920002
059300             IF RD037-M2A-PSTL-CDE GREATER THAN SPACES            05930002
059400                 MOVE RD037-M2A-PSTL-CDE TO RDT00000-M2A-PSTL-CDE 05940002
059500                 SET PS-UPDATE-NEEDED TO TRUE                     05950017
059600             END-IF                                               05960002
059700         END-IF                                                   05970002
059800         IF RDT00000-PHN-NBR NOT = RD037-PHN-NBR                  05980002
059900             IF RD037-PHN-NBR GREATER THAN SPACES                 05990002
060000                 MOVE RD037-PHN-NBR TO RDT00000-PHN-NBR           06000002
060100                 SET PS-UPDATE-PHONE TO TRUE                      06010017
060200             END-IF                                               06020002
060300         END-IF                                                   06030002
060400     END-IF.                                                      06040002
060500                                                                  06050002
060600     IF PS-UPDATE-NEEDED                                          06060002
060700         PERFORM 7100-UPDATE-CUSTOMER                             06070002
060800     END-IF.                                                      06080002
060900                                                                  06090002
061000     IF PS-UPDATE-PHONE                                           06100010
061100         PERFORM 7200-UPDATE-PHONE                                06110010
061200     END-IF.                                                      06120010
061300                                                                  06130010
061400******************************************************************06140002
061500*     7000-INSERT-CUSTOMER                                       *06150001
061600* ==> PROCESSES:                                                 *06160001
061700*     - INSERTS THE CUSTOMER RECORD.                             *06170001
061800* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *06180001
061900******************************************************************06190001
062000 7000-INSERT-CUSTOMER.                                            06200001
062100                                                                  06210001
062200     PERFORM WITH TEST AFTER                                      06220019
062300         VARYING PV-SQL-SUB                                       06230019
062400         FROM 1 BY 1                                              06240019
062500         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       06250019
062600                OR SQLCODE = -911                                 06260019
062700                OR SQLCODE = 0)                                   06270019
062800                                                                  06280019
062900         EXEC SQL                                                 06290019
063000             SELECT MAX(CUST_ID + 1)                              06300019
063100               INTO :RDT00000-CUST-ID                             06310019
063200               FROM RDT_CUST                                      06320019
063300         END-EXEC                                                 06330019
063400                                                                  06340002
063500         EVALUATE TRUE                                            06350019
063600             WHEN SQLCODE = 0                                     06360019
063700                 CONTINUE                                         06370019
063800             WHEN SQLCODE = -911                                  06380019
063900                 ADD +1 TO PV-DEADLOCK-COUNTER                    06390019
064000                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        06400019
064100                     MOVE '7000-INSERT-CUSTOMER        '          06410019
064200                                      TO PV-PARAGRAPH-NAME        06420019
064300                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        06430019
064400                                      TO PV-DB2-OPER-ATTEMPTED    06440019
064500                     PERFORM 9999-SQL-ABEND                       06450019
064600                 ELSE                                             06460019
064700                     SET PS-RESTART-REQUIRED TO TRUE              06470019
064800                 END-IF                                           06480019
064900             WHEN OTHER                                           06490019
065000                 MOVE '7000-INSERT-CUSTOMER        '              06500019
065100                                  TO PV-PARAGRAPH-NAME            06510019
065200                 MOVE 'SELECT NEXT CUST-ID          '             06520019
065300                                  TO PV-DB2-OPER-ATTEMPTED        06530019
065400                 PERFORM 9999-SQL-ABEND                           06540019
065500         END-EVALUATE                                             06550019
065600     END-PERFORM.                                                 06560019
065700                                                                  06570019
065800     IF PV-SQL-SUB > PC-MAX-RETRIES                               06580019
065900         MOVE '7000-INSERT-CUSTOMER        '                      06590019
066000                                      TO PV-PARAGRAPH-NAME        06600019
066100         MOVE 'SELECT RETRIES EXCEEDED       '                    06610019
066200                                      TO PV-DB2-OPER-ATTEMPTED    06620019
066300         PERFORM 9999-SQL-ABEND                                   06630019
066400     END-IF.                                                      06640019
066500                                                                  06650019
066600     MOVE RD037-DRV-LIC-NBR    TO RDT00000-DRV-LIC-NBR.           06660002
066700     MOVE RD037-LAST-NM        TO RDT00000-LAST-NM.               06670002
066800     MOVE RD037-FRST-NM        TO RDT00000-FRST-NM.               06680002
066900     MOVE RD037-M2A-LNE-1-ADDR TO RDT00000-M2A-LNE-1-ADDR.        06690002
067000     MOVE RD037-M2A-CTY-NM     TO RDT00000-M2A-CTY-NM.            06700002
067100     MOVE RD037-M2A-ST-CDE     TO RDT00000-M2A-ST-CDE.            06710002
067200     MOVE RD037-M2A-PSTL-CDE   TO RDT00000-M2A-PSTL-CDE.          06720002
067300     MOVE SPACES               TO RDT00000-MID-INIT-NM            06730004
067400                                  RDT00000-M2A-LNE-2-ADDR.        06740002
067500     MOVE 'C'                  TO RDT00000-RFND-PRIV-CDE.         06750002
067600                                                                  06760002
067700     PERFORM WITH TEST AFTER                                      06770001
067800         VARYING PV-SQL-SUB                                       06780001
067900         FROM 1 BY 1                                              06790001
068000         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       06800001
068100                OR SQLCODE = -911                                 06810001
068200                OR SQLCODE = 0)                                   06820001
068300                                                                  06830001
068400         EXEC SQL                                                 06840001
068500             INSERT INTO RDT_CUST                                 06850001
068600                    (CUST_ID                                      06860001
068700                    ,DRV_LIC_NBR                                  06870001
068800                    ,LAST_NM                                      06880001
068900                    ,FRST_NM                                      06890001
069000                    ,MID_INIT_NM                                  06900002
069100                    ,M2A_LNE_1_ADDR                               06910001
069200                    ,M2A_LNE_2_ADDR                               06920004
069300                    ,M2A_CTY_NM                                   06930001
069400                    ,M2A_ST_CDE                                   06940001
069500                    ,M2A_PSTL_CDE                                 06950002
069600                    ,RFND_PRIV_CDE)                               06960002
069700             VALUES                                               06970001
069800                    (:RDT00000-CUST-ID                            06980001
069900                    ,:RDT00000-DRV-LIC-NBR                        06990001
070000                    ,:RDT00000-LAST-NM                            07000001
070100                    ,:RDT00000-FRST-NM                            07010001
070200                    ,:RDT00000-MID-INIT-NM                        07020002
070300                    ,:RDT00000-M2A-LNE-1-ADDR                     07030001
070400                    ,:RDT00000-M2A-LNE-2-ADDR                     07040002
070500                    ,:RDT00000-M2A-CTY-NM                         07050001
070600                    ,:RDT00000-M2A-ST-CDE                         07060001
070700                    ,:RDT00000-M2A-PSTL-CDE                       07070003
070800                    ,:RDT00000-RFND-PRIV-CDE)                     07080002
070900         END-EXEC                                                 07090001
071000                                                                  07100001
071100         EVALUATE TRUE                                            07110001
071200             WHEN SQLCODE = 0                                     07120001
071300                 ADD +1 TO PA-CUST-ROWS-INSERTED                  07130002
071400             WHEN SQLCODE = -911                                  07140001
071500                 ADD +1 TO PV-DEADLOCK-COUNTER                    07150001
071600                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        07160001
071700                     MOVE '7000-INSERT-CUSTOMER        '          07170001
071800                                      TO PV-PARAGRAPH-NAME        07180001
071900                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        07190001
072000                                      TO PV-DB2-OPER-ATTEMPTED    07200001
072100                     PERFORM 9999-SQL-ABEND                       07210001
072200                 ELSE                                             07220001
072300                     SET PS-RESTART-REQUIRED TO TRUE              07230001
072400                 END-IF                                           07240001
072500             WHEN OTHER                                           07250001
072600                 MOVE '7000-INSERT-CUSTOMER        '              07260001
072700                                  TO PV-PARAGRAPH-NAME            07270001
072800                 MOVE 'INSERT TO RDT_CUST           '             07280001
072900                                  TO PV-DB2-OPER-ATTEMPTED        07290001
073000                 PERFORM 9999-SQL-ABEND                           07300001
073100         END-EVALUATE                                             07310001
073200     END-PERFORM.                                                 07320001
073300                                                                  07330001
073400     IF PV-SQL-SUB > PC-MAX-RETRIES                               07340001
073500         MOVE '7000-INSERT-CUSTOMER        '                      07350001
073600                                      TO PV-PARAGRAPH-NAME        07360001
073700         MOVE 'INSERT RETRIES EXCEEDED       '                    07370001
073800                                      TO PV-DB2-OPER-ATTEMPTED    07380001
073900         PERFORM 9999-SQL-ABEND                                   07390001
074000     END-IF.                                                      07400001
074100                                                                  07410001
074200******************************************************************07420002
074300*     7100-UPDATE-CUSTOMER                                       *07430002
074400* ==> PROCESSES:                                                 *07440002
074500*     - UPDATES THE CUSTOMER RECORD.                             *07450002
074600* ==> PERFORMED FROM:  5500-CHECK-FOR-UPDATE                     *07460002
074700******************************************************************07470002
074800 7100-UPDATE-CUSTOMER.                                            07480002
074900                                                                  07490002
075000     PERFORM WITH TEST AFTER                                      07500002
075100         VARYING PV-SQL-SUB                                       07510002
075200         FROM 1 BY 1                                              07520002
075300         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       07530002
075400                OR SQLCODE = -911                                 07540002
075500                OR SQLCODE = 0)                                   07550002
075600                                                                  07560002
075700         EXEC SQL                                                 07570002
075800             UPDATE RDT_CUST                                      07580002
075900                SET  DRV_LIC_NBR    = :RDT00000-DRV-LIC-NBR       07590002
076000                    ,LAST_NM        = :RDT00000-LAST-NM           07600002
076100                    ,FRST_NM        = :RDT00000-FRST-NM           07610003
076200                    ,M2A_LNE_1_ADDR = :RDT00000-M2A-LNE-1-ADDR    07620002
076300                    ,M2A_CTY_NM     = :RDT00000-M2A-CTY-NM        07630002
076400                    ,M2A_ST_CDE     = :RDT00000-M2A-ST-CDE        07640002
076500                    ,M2A_PSTL_CDE   = :RDT00000-M2A-PSTL-CDE      07650002
076600                    ,LAST_UPD_DTE   = CURRENT_DATE                07660003
076700              WHERE CUST_ID = :RDT00000-CUST-ID                   07670002
076800         END-EXEC                                                 07680002
076900                                                                  07690002
077000         EVALUATE TRUE                                            07700002
077100             WHEN SQLCODE = 0                                     07710002
077200                 ADD +1 TO PA-CUST-ROWS-UPDATED                   07720002
077300             WHEN SQLCODE = -911                                  07730002
077400                 ADD +1 TO PV-DEADLOCK-COUNTER                    07740002
077500                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        07750002
077600                     MOVE '7100-UPDATE-CUSTOMER        '          07760002
077700                                      TO PV-PARAGRAPH-NAME        07770002
077800                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        07780002
077900                                      TO PV-DB2-OPER-ATTEMPTED    07790002
078000                     PERFORM 9999-SQL-ABEND                       07800002
078100                 ELSE                                             07810002
078200                     SET PS-RESTART-REQUIRED TO TRUE              07820002
078300                 END-IF                                           07830002
078400             WHEN OTHER                                           07840002
078500                 MOVE '7100-UPDATE-CUSTOMER        '              07850002
078600                                  TO PV-PARAGRAPH-NAME            07860002
078700                 MOVE 'INSERT TO RDT_CUST           '             07870002
078800                                  TO PV-DB2-OPER-ATTEMPTED        07880002
078900                 PERFORM 9999-SQL-ABEND                           07890002
079000         END-EVALUATE                                             07900002
079100     END-PERFORM.                                                 07910002
079200                                                                  07920002
079300     IF PV-SQL-SUB > PC-MAX-RETRIES                               07930002
079400         MOVE '7100-UPDATE-CUSTOMER        '                      07940002
079500                                      TO PV-PARAGRAPH-NAME        07950002
079600         MOVE 'INSERT RETRIES EXCEEDED       '                    07960002
079700                                      TO PV-DB2-OPER-ATTEMPTED    07970002
079800         PERFORM 9999-SQL-ABEND                                   07980002
079900     END-IF.                                                      07990002
080000                                                                  08000002
080100******************************************************************08010002
080200*     7200-UPDATE-PHONE                                          *08020002
080300* ==> PROCESSES:                                                 *08030002
080400*     - UPDATES THE CUSTOMER PHONE NUMBER                        *08040002
080500* ==> PERFORMED FROM:  5500-CHECK-FOR-UPDATE                     *08050002
080600******************************************************************08060002
080700 7200-UPDATE-PHONE.                                               08070002
080800                                                                  08080002
080900     PERFORM WITH TEST AFTER                                      08090002
081000         VARYING PV-SQL-SUB                                       08100002
081100         FROM 1 BY 1                                              08110002
081200         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       08120002
081300                OR SQLCODE = -911                                 08130002
081400                OR SQLCODE = 0)                                   08140002
081500                                                                  08150002
081600         EXEC SQL                                                 08160002
081700             UPDATE RDT_CUST                                      08170002
081800                SET  PHN_NBR        = :RDT00000-PHN-NBR           08180002
081900                    ,LAST_UPD_DTE   = CURRENT DATE                08190003
082000              WHERE CUST_ID = :RDT00000-CUST-ID                   08200002
082100         END-EXEC                                                 08210002
082200                                                                  08220002
082300         EVALUATE TRUE                                            08230002
082400             WHEN SQLCODE = 0                                     08240002
082500                 IF PS-UPDATE-NEEDED                              08250010
082600                     CONTINUE                                     08260010
082700                 ELSE                                             08270010
082800                     ADD +1 TO PA-CUST-ROWS-UPDATED               08280010
082900                 END-IF                                           08290010
083000             WHEN SQLCODE = -911                                  08300002
083100                 ADD +1 TO PV-DEADLOCK-COUNTER                    08310002
083200                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        08320002
083300                     MOVE '7200-UPDATE-PHONE        '             08330002
083400                                      TO PV-PARAGRAPH-NAME        08340002
083500                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        08350002
083600                                      TO PV-DB2-OPER-ATTEMPTED    08360002
083700                     PERFORM 9999-SQL-ABEND                       08370002
083800                 ELSE                                             08380002
083900                     SET PS-RESTART-REQUIRED TO TRUE              08390002
084000                 END-IF                                           08400002
084100             WHEN OTHER                                           08410002
084200                 MOVE '7200-UPDATE-PHONE        '                 08420002
084300                                  TO PV-PARAGRAPH-NAME            08430002
084400                 MOVE 'INSERT TO RDT_CUST           '             08440002
084500                                  TO PV-DB2-OPER-ATTEMPTED        08450002
084600                 PERFORM 9999-SQL-ABEND                           08460002
084700         END-EVALUATE                                             08470002
084800     END-PERFORM.                                                 08480002
084900                                                                  08490002
085000     IF PV-SQL-SUB > PC-MAX-RETRIES                               08500002
085100         MOVE '7200-UPDATE-PHONE        '                         08510002
085200                                      TO PV-PARAGRAPH-NAME        08520002
085300         MOVE 'INSERT RETRIES EXCEEDED       '                    08530002
085400                                      TO PV-DB2-OPER-ATTEMPTED    08540002
085500         PERFORM 9999-SQL-ABEND                                   08550002
085600     END-IF.                                                      08560002
085700                                                                  08570002
085800                                                                  08580002
085900******************************************************************08590002
086000*     8000-INSERT-REFUND                                         *08600002
086100* ==> PROCESSES:                                                 *08610001
086200*     - INSERTS THE REFUND RECORD                                *08620002
086300* ==> PERFORMED FROM:  2000-PROCESS-UPDATE-RECORDS               *08630002
086400******************************************************************08640001
086500 8000-INSERT-REFUND.                                              08650002
086600                                                                  08660001
086700     MOVE RDT00000-CUST-ID     TO RDT00001-CUST-ID.               08670002
086800     MOVE RD037-STR-RGST-ID    TO RDT00001-STR-RGST-ID.           08680002
086900     MOVE RD037-RGST-TRN-NBR   TO RDT00001-RGST-TRN-NBR.          08690002
087000     MOVE RD037-RFND-SEQ-NBR   TO RDT00001-RFND-SEQ-NBR.          08700002
087100     MOVE RD037-STR-NBR        TO RDT00001-STR-NBR.               08710002
087200     COMPUTE RDT00001-RFND-AMT = RD037-RFND-AMT                   08720006
087300                               * PC-MINUS-ONE.                    08730006
087400     MOVE RD037-RFND-REQ-DTE   TO RDT00001-RFND-REQ-DTE.          08740002
087500     MOVE 'P'                  TO RDT00001-RFND-STAT-CDE.         08750002
087600                                                                  08760002
087700     MOVE 0                    TO PV-SQL-SUB.                     08770002
087800                                                                  08780002
087900     PERFORM WITH TEST AFTER                                      08790008
088000         UNTIL (PV-SQL-SUB > PC-MAX-RETRIES                       08800002
088100                OR SQLCODE = 0)                                   08810002
088200                                                                  08820002
088300         EXEC SQL                                                 08830002
088400             INSERT INTO RDT_MAL_CK_RFND                          08840002
088500                    (CUST_ID                                      08850002
088600                    ,STR_RGST_ID                                  08860002
088700                    ,RGST_TRN_NBR                                 08870002
088800                    ,RFND_SEQ_NBR                                 08880002
088900                    ,STR_NBR                                      08890002
089000                    ,RFND_AMT                                     08900002
089100                    ,RFND_STAT_CDE                                08910002
089200                    ,RFND_REQ_DTE                                 08920002
089300                    ,LST_UPD_TMST)                                08930002
089400             VALUES                                               08940002
089500                    (:RDT00001-CUST-ID                            08950002
089600                    ,:RDT00001-STR-RGST-ID                        08960002
089700                    ,:RDT00001-RGST-TRN-NBR                       08970002
089800                    ,:RDT00001-RFND-SEQ-NBR                       08980002
089900                    ,:RDT00001-STR-NBR                            08990002
090000                    ,:RDT00001-RFND-AMT                           09000002
090100                    ,:RDT00001-RFND-STAT-CDE                      09010002
090200                    ,:RDT00001-RFND-REQ-DTE                       09020002
090300                    ,CURRENT TIMESTAMP)                           09030002
090400         END-EXEC                                                 09040002
090500                                                                  09050002
090600         EVALUATE TRUE                                            09060002
090700             WHEN SQLCODE = 0                                     09070002
090800                 ADD +1 TO PA-REFUND-ROWS-INSERTED                09080002
090900             WHEN SQLCODE = -803                                  09090002
091000                 ADD +1 TO RDT00001-RFND-SEQ-NBR                  09100002
091100             WHEN SQLCODE = -911                                  09110002
091200                 ADD +1 TO PV-DEADLOCK-COUNTER                    09120002
091300                           PV-SQL-SUB                             09130002
091400                 IF PV-DEADLOCK-COUNTER > PC-MAX-DEADLOCKS        09140002
091500                     MOVE '8000-INSERT-REFUND        '            09150002
091600                                      TO PV-PARAGRAPH-NAME        09160002
091700                     MOVE 'MAXIMUM DEADLOCKS EXCEEDED    '        09170002
091800                                      TO PV-DB2-OPER-ATTEMPTED    09180002
091900                     PERFORM 9999-SQL-ABEND                       09190002
092000                 ELSE                                             09200002
092100                     SET PS-RESTART-REQUIRED TO TRUE              09210002
092200                 END-IF                                           09220002
092300             WHEN OTHER                                           09230002
092400                 MOVE '8000-INSERT-REFUND        '                09240002
092500                                  TO PV-PARAGRAPH-NAME            09250002
092600                 MOVE 'INSERT TO RDT_MAL_CK_RFND    '             09260002
092700                                  TO PV-DB2-OPER-ATTEMPTED        09270002
092800                 PERFORM 9999-SQL-ABEND                           09280002
092900         END-EVALUATE                                             09290002
093000     END-PERFORM.                                                 09300002
093100                                                                  09310002
093200     IF PV-SQL-SUB > PC-MAX-RETRIES                               09320002
093300         MOVE '8000-INSERT-REFUND        '                        09330002
093400                                      TO PV-PARAGRAPH-NAME        09340002
093500         MOVE 'INSERT RETRIES EXCEEDED       '                    09350002
093600                                      TO PV-DB2-OPER-ATTEMPTED    09360002
093700         PERFORM 9999-SQL-ABEND                                   09370002
093800     END-IF.                                                      09380002
093900                                                                  09390002
094000******************************************************************09400001
094100*  ABEND THE PROGRAM IN THE EVENT THAT A SQL ERROR OR WARNING    *09410001
094200*  CODE OCCURS.                                                  *09420001
094300******************************************************************09430001
094400 9999-SQL-ABEND.                                                  09440001
094500                                                                  09450001
094600     DISPLAY '** ABEND     **'.                                   09460001
094700     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        09470001
094800     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              09480001
094900     DISPLAY '** OPERATION ** = ' PV-DB2-OPER-ATTEMPTED.          09490001
095000                                                                  09500001
095100******************************************************************09510001
095200*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *09520001
095300*  MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE       *09530001
095400*  'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE   *09540001
095500*  FORMAT.                                                       *09550001
095600******************************************************************09560001
095700     COPY DPPD004.                                                09570001
095800                                                                  09580001
095900     MOVE +4013 TO ABEND-CODE.                                    09590001
096000     CALL 'ILBOABN0' USING ABEND-CODE.                            09600001
096100                                                                  09610001
096200******************************************************************09620001
096300*  THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-  *09630001
096400*  MENTS THAT ARE REQUIRED TO INVOKE THE TRANSACTION PRESENTATION*09640001
096500*  MODULE (DPKUT901) OF THE DB2 CHECKPOINT RESTART SYSTEM.       *09650001
096600******************************************************************09660001
096700     COPY DPPD001.                                                09670001
