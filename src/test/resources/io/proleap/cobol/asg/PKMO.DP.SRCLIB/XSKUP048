000100******************************************************************00080003
000200 IDENTIFICATION DIVISION.                                         00010003
000300******************************************************************00080003
000400 PROGRAM-ID.    XSKUP048.                                         00020003
000500 AUTHOR.        KOHLS DEPARTMENT STORES.                          00030003
000600 INSTALLATION.  LIHUA LIANG.                                      00040003
000700 DATE-WRITTEN.  03/10/2003.                                       00050003
000800                                                                  00070003
000900******************************************************************00080003
001000*   THIS PROGRAM IS CALLED FROM XSKUT012 TO UPDATE SKU LOCATION   00110003
001100*   TABLE (XST_SKU_LOC) WHEN MESSAGE 075 IS ENCOUNTERED.          00120003
001110*   MESSAGE 075 IS SKU PRICE AND/OR STATUS CHANGE (CORP = STORE 0)00120003
001200******************************************************************00150003
PK9078* 09/15/11 - COGNIZANT        - PKE000000009078                           
PK9078*    ADDED A CHECK FOR 2ND TIME CLEARANCE SKU'S TO UPDATE THE             
PK9078*    ORIGIN CLEARANCE DATE.                                               
001400******************************************************************00150003
001200******************************************************************00150003
PK9078* 09/30/11 - COGNIZANT        - PKE000000009078                           
PK9078*    ADDED A CHECK FOR 2ND TIME CLEARANCE SKU'S TO UPDATE THE             
PK9078*    ORIGIN CLEARANCE DATE FOR SKU'S WITH OTHER STAT_CDE THAN 30          
PK9078*    AND 25.                                                              
001400******************************************************************00150003
001500 ENVIRONMENT DIVISION.                                            00170003
001600******************************************************************00150003
001700 CONFIGURATION SECTION.                                           00180003
001800 SOURCE-COMPUTER.  IBM-3090.                                      00190003
001900 OBJECT-COMPUTER.  IBM-3090.                                      00200003
002000 DATA DIVISION.                                                   00210003
002100                                                                  00220003
002200 WORKING-STORAGE SECTION.                                         00230003
002300******************************************************************00240003
002400*    PROGRAM SWITCHES.                                            00250003
002500******************************************************************00260003
002600 01  PS-PROGRAM-SWITCHES.                                         00270003
002700     05  PS-CONTINUE-SW               PIC  X(01) VALUE 'Y'.       00280003
002800         88  PS-CONTINUE-YES                     VALUE 'Y'.       00290003
002900         88  PS-CONTINUE-NO                      VALUE 'N'.       00300003
003000     05  PS-ACTION-IND                PIC  9(02) VALUE 00.        00310003
003100         88  PS-ACTION-REVERSE                   VALUE 01.        00320003
003200         88  PS-ACTION-NOTHING                   VALUE 02.        00340003
003300                                                                  00350003
003400******************************************************************00350003
003500*    PROGRAM CONSTANTS.                                           00360003
003600******************************************************************00370003
003700 01  PC-PROGRAM-CONSTANTS.                                        00380003
003800     05  PC-MAX-RETRIES               PIC  9(01) VALUE 3.         00390003
003801     05  PC-YES                       PIC  X(01) VALUE 'Y'.       00390003
003802     05  PC-NO                        PIC  X(01) VALUE 'N'.       00390003
003803     05  PC-CLEARANCE                 PIC  X(02) VALUE '30'.      00390003
003804     05  PC-MIXED                     PIC  X(02) VALUE '25'.      00390003
003805     05  PC-IMKUP039                  PIC  X(08) VALUE 'IMKUP039'.00390003
003806     05  PC-MARK1                     PIC  X(01) VALUE '1'.       00390003
003900                                                                  00400003
004000******************************************************************00350003
004100*    PROGRAM VARIABLES.                                           00360003
004200******************************************************************00370003
004210 01  PV-PROGRAM-VARIABLES.                                        00380003
004300     05  PC-10-DIGIT                  PIC 9(10)  VALUE ZEROS.     00400003
004301     05  PC-18-DIGIT                  PIC S9(18) COMP VALUE ZEROS.00400003
004302     05  PC-09-DIGIT                  PIC S9(09) COMP VALUE ZEROS.00400003
004303     05  PV-RETRIES                   PIC  9(01) VALUE ZEROS.     00400003
004400     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACE.     00450003
004401     05  PV-RETURN-SQLCODE            PIC S9(04) VALUE ZEROS.             
004402     05  PV-END-TMST-IND              PIC S9(04) VALUE +0 COMP.   00310003
004403         88  PV-END-TMST-NULL                    VALUE -1.        00320003
004404     05  PV-GP-PRICE-IND              PIC S9(04) VALUE +0 COMP.   00310003
004405         88  PV-GP-PRICE-NULL                    VALUE -1.        00320003
004406     05  PV-GP-QTY-IND                PIC S9(04) VALUE +0 COMP.   00310003
004407         88  PV-GP-QTY-NULL                      VALUE -1.        00320003
004408     05  PV-GP-AMT-IND                PIC S9(04) VALUE +0 COMP.   00310003
004409         88  PV-GP-AMT-NULL                      VALUE -1.        00320003
004410     05  PV-MKDN-CDE-IND              PIC S9(04) VALUE +0 COMP.   00310003
004411         88  PV-MKDN-CDE-NULL                    VALUE -1.        00320003
004412         88  PV-MKDN-CDE-VALUE                   VALUE  0.        00320003
004413     05  PV-ORIG-CLR-DTE-IND          PIC S9(04) VALUE +0 COMP.   00310003
004414         88  PV-ORIG-CLR-DTE-NULL                VALUE -1.        00320003
004415         88  PV-ORIG-CLR-DTE-VALUE               VALUE  0.        00320003
004800                                                                  00350003
004801     05  PV-SAVE-DATA.                                            00520003
004802         10 PV-INTR-UPC-ID            PIC S9(09) COMP.                    
004803         10 PV-LOC-NBR                PIC S9(04) COMP.                    
004804         10 PV-BEG-TMST               PIC  X(26).                         
004805         10 PV-END-TMST               PIC  X(26).                         
004806         10 PV-UNT-RTL-AMT            PIC S9(7)V9(2) COMP-3.              
004807         10 PV-UNT-COST-AMT           PIC S9(7)V9(3) COMP-3.              
004808         10 PV-LOC-SKU-STAT-CDE       PIC  X(02).                         
004809         10 PV-UPC-STAT-CHG-DTE       PIC  X(10).                         
004810         10 PV-UNT-RTL-CHG-DTE        PIC  X(10).                         
004811         10 PV-GP-PRIC-ID             PIC S9(09) COMP.                    
004812         10 PV-GP-RTL-QTY             PIC S9(04) COMP.                    
004813         10 PV-GP-RTL-AMT             PIC S9(7)V9(2) COMP-3.              
004814         10 PV-LAST-UPD-TMST          PIC  X(26).                         
004815         10 PV-SOR-LAST-MSG-TMST      PIC  X(26).                         
004816         10 PV-MKDN-CDE               PIC  X(01).                         
004817         10 PV-ORIG-CLR-DTE           PIC  X(10).                         
004818                                                                  00350003
004900******************************************************************00530003
005000*    ABEND COPYBOOKS                                              00540003
005100******************************************************************00550003
005200     COPY DPWS004.                                                00570003
005300                                                                  00580003
005400******************************************************************00530003
005500*    DB2 MESSAGE AREA                                             00540003
005600******************************************************************00550003
005700     COPY SQLCA2.                                                 00590003
005800                                                                  00600003
005900******************************************************************00530003
006000*    ITEM COPYBOOK                                                00540003
006100******************************************************************00550003
006200     COPY IMRD008.                                                00610003
006300                                                                  00600003
006400******************************************************************00620003
006500*    DB2 COMMUNICATION AREA                                       00630003
006600******************************************************************00640003
006700     EXEC SQL                                                     00660003
006800          INCLUDE SQLCA                                           00670003
006900     END-EXEC.                                                    00680003
007000                                                                  00690003
007100******************************************************************00620003
007200*    XST_SKU_LOC TABLE                                            00630003
007300******************************************************************00640003
007400     EXEC SQL                                                     00700003
007500         INCLUDE XST00008                                         00710003
007600     END-EXEC.                                                    00720003
007700                                                                  00730003
007701******************************************************************00620003
007702*    XST_SKU_ATTR TABLE                                           00630003
007703******************************************************************00640003
007704     EXEC SQL                                                     00700003
007705         INCLUDE XST00011                                         00710003
007706     END-EXEC.                                                    00720003
007707                                                                  00730003
007708******************************************************************00620003
007709*    XST_SKU_LOC_ATTR TABLE                                       00630003
007710******************************************************************00640003
007711     EXEC SQL                                                     00700003
007712         INCLUDE XST00041                                         00710003
007713     END-EXEC.                                                    00720003
007714                                                                  00730003
007800******************************************************************00750003
007900 LINKAGE SECTION.                                                 00740003
008000******************************************************************00770003
008100 01  LV-IMRD008-RECORD                PIC  X(450).                00780003
008200 01  LV-RETURN-CODE                   PIC S9(04).                 00790003
008300 01  LV-ACTION-IND                    PIC  9(02).                 00800003
008400 01  LV-CURRENT-TIMESTAMP             PIC  X(26).                 00810003
008500                                                                  00820003
008600******************************************************************00870003
008700 PROCEDURE DIVISION USING LV-IMRD008-RECORD,                      00830003
008800                          LV-RETURN-CODE,                         00840003
008900                          LV-ACTION-IND,                          00850003
009000                          LV-CURRENT-TIMESTAMP.                   00860003
009100******************************************************************00870003
009200 0000-MAINLINE.                                                   00880003
009300                                                                  00890003
009400      PERFORM 1000-INITIALIZATION.                                00900003
009500                                                                  00890003
009600      PERFORM 2000-PROCESS-MESSAGE.                               00910003
009800                                                                  00890003
009900      PERFORM 9999-WRAPUP.                                        00930003
010000                                                                  00940003
010100***************************************************************** 00950003
010200 1000-INITIALIZATION.                                             00980003
010300*     INITIALIZATION AREA                                         00960003
010400***************************************************************** 00970003
010500                                                                  00990003
010600     SET PS-CONTINUE-YES              TO TRUE.                    01020003
010700                                                                  00990003
010800     INITIALIZE PV-RETRIES                                        01030003
010801                PV-SAVE-DATA                                      01030003
010802                PV-RETURN-SQLCODE                                 01030003
010803                DCLXST00008                                       01030003
010804                DCLXST00041.                                      01030003
010900                                                                  01040003
011000     MOVE LV-IMRD008-RECORD           TO IMRD008-RECORD.          01050003
011100                                                                  01040003
011300     MOVE IM008-ITEM-KEY-INTR-UPC-ID  TO PC-10-DIGIT.             01080003
011301     MOVE PC-10-DIGIT                 TO PC-18-DIGIT.             01080003
011302     MOVE PC-18-DIGIT                 TO PC-09-DIGIT.             01080003
011303     MOVE PC-09-DIGIT                 TO XST00008-INTR-UPC-ID.    01080003
011304                                                                  01080003
013300     MOVE ZERO                        TO XST00008-LOC-NBR.        01360003
013301     MOVE IM008-RTL-CHG-EFF-BEG-TMST  TO XST00008-BEG-TMST.       01360003
013302                                                                  01060003
013303***************************************************************** 01170003
013304 2000-PROCESS-MESSAGE.                                            01200003
013305*     CALLS PROCESS TO DELETE ANY FUTURE SKU LOCATION ROWS,       01180003
013306*     DETERMINE WHETHER A SKU LOCATION ROW ALREADY EXISTS FOR THE         
013307*     EFFECTIVE TIMESTAMP AND THEN PERFORM UPDATES AND/OR INSERTS         
013308*     AS APPROPRIATE.  SKU LOCATION ATTRIBUTE AND SKU ATTRIBUTE           
013309*     DATA MAY BE UPDATED AS WELL.                                        
013310***************************************************************** 01190003
013311                                                                  01210003
013312     PERFORM 2100-DELETE-SKU-LOC.                                 01240003
013313                                                                  01240003
013314     IF PS-CONTINUE-YES                                           01240003
013315        PERFORM 2200-SELECT-CURRENT-SKU-LOC                       01240003
013316     END-IF.                                                      01240003
013317                                                                  01240003
013322     IF PS-CONTINUE-YES                                           01240003
013323        IF XST00008-BEG-TMST    = IM008-RTL-CHG-EFF-BEG-TMST      01240003
013324           PERFORM 2300-UPDATE-PRICE-STATUS                       01240003
013325        ELSE                                                      01240003
013326           PERFORM 2400-END-CURRENT-ROW                           01240003
013327           IF PS-CONTINUE-YES                                     01240003
013328              PERFORM 2500-INSERT-NEW-ROW                         01240003
013329           END-IF                                                 01240003
013330        END-IF                                                    01240003
013331     END-IF.                                                      01240003
013332                                                                  01250003
013333     IF PS-CONTINUE-YES                                           01240003
013334        PERFORM 2600-DETM-SKU-LOC-ATTR                            01240003
013335     END-IF.                                                      01240003
013336                                                                  01250003
013354     IF PS-CONTINUE-YES                                           01240003
013355        IF IM008-RTL-CHG-CRE-BY-USR-ID    = PC-IMKUP039 AND       01240003
013356           IM008-RTL-CHG-RGN-PRIC-IND-SUP  = PC-NO AND            01240003
013357           (((IM008-RTL-CHG-UPC-STAT-CDE   = '25' OR              01240003
013358              IM008-RTL-CHG-UPC-STAT-CDE   = '30') AND            01240003
013359             (IM008-RTL-CHG-UPC-STAT-CDE-N = '10' OR              01240003
013360              IM008-RTL-CHG-UPC-STAT-CDE-N = '20' OR              01240003
013361              IM008-RTL-CHG-UPC-STAT-CDE-N = '40' OR              01240003
013362              IM008-RTL-CHG-UPC-STAT-CDE-N = '90')) OR            01240003
013363             (IM008-RTL-CHG-UPC-STAT-CDE   = '25' AND             01240003
013364              IM008-RTL-CHG-UPC-STAT-CDE-N = '30') OR             01240003
013365             (IM008-RTL-CHG-UPC-STAT-CDE   = '30' AND                     
013366             (IM008-RTL-CHG-MKDN-CDE       = '1' OR                       
013367              IM008-RTL-CHG-MKDN-CDE       = '2' OR                       
013368              IM008-RTL-CHG-MKDN-CDE       = 'F')) OR                     
013369             (IM008-RTL-CHG-UPC-STAT-CDE   = '25' AND                     
013370              IM008-RTL-CHG-UPC-STAT-CDE-N = '30' AND             01240003
013371              IM008-RTL-CHG-MKDN-CDE       = '1'))                        
013372              PERFORM 2750-DELETE-FUTURE-RCP                      01240003
013373                                                                          
013374              IF PS-CONTINUE-YES                                  01240003
013375                 PERFORM 2800-END-SKU-LOC                         01240003
013376              END-IF                                              01240003
013377                                                                          
013378              IF PS-CONTINUE-YES                                  01240003
013379                 PERFORM 2900-DELETE-SKU-LOC-ATTR                 01240003
013380              END-IF                                              01240003
013381        END-IF                                                    01240003
013382     END-IF.                                                      01240003
013383                                                                  01250003
013384     IF PS-CONTINUE-YES                                           01240003
013385        IF IM008-RTL-CHG-UNT-RTL-AMT-CHG                          01240003
013386           IF IM008-RTL-CHG-UPC-STAT-CDE-N = '30'                 01240003
013387              CONTINUE                                            01240003
013388           ELSE                                                   01240003
013389              MOVE PC-09-DIGIT        TO XST00011-INTR-UPC-ID     01080003
013390              MOVE IM008-RTL-CHG-UNT-RTL-AMT-N                    01080003
013391                                     TO XST00011-LAST-NCLR-RTL-AMT01080003
013392              PERFORM 3000-UPDATE-XST-SKU-ATTR                    01240003
013393           END-IF                                                 01240003
013394        END-IF                                                    01240003
013395     END-IF.                                                      01240003
013396                                                                  01250003
013397     IF PS-CONTINUE-NO                                            01240003
013398        MOVE SQLCODE TO PV-RETURN-SQLCODE                                 
013399        DISPLAY '** BAD SQL IN XSKUP048, PARAGRAPH '                      
013400                PV-PARAGRAPH-NAME                                         
013401        DISPLAY '   FOR INTR UPC ID '                                     
013402                IM008-ITEM-KEY-INTR-UPC-ID ' **'                  01080003
013403     END-IF.                                                      01240003
013404                                                                  01240003
013405***************************************************************** 01270003
013406 2100-DELETE-SKU-LOC.                                             01330003
013407*     DELETES FUTURE ROW IN XST_SKU_LOC TABLE IF ONE EXIST.       01280003
013408***************************************************************** 01320003
013409                                                                  01370003
013500     PERFORM                                                      01380003
013501        WITH TEST AFTER                                           01380003
013502        VARYING PV-RETRIES                                        01380003
013503        FROM 1 BY 1                                               01380003
013504        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
013505        OR SQLCODE = ZERO                                         01380003
013506        OR SQLCODE = +100                                         01380003
013507        OR PS-CONTINUE-NO                                         01380003
013600                                                                  01390003
013601        EXEC SQL                                                  01390003
013602           DELETE                                                 01390003
013603             FROM XST_SKU_LOC                                     01390003
013700            WHERE INTR_UPC_ID = :XST00008-INTR-UPC-ID             01400003
013701              AND LOC_NBR     = :XST00008-LOC-NBR                 01400003
013702              AND BEG_TMST    > :XST00008-BEG-TMST                01400003
013800        END-EXEC                                                  01410003
013900                                                                  01420003
014000        EVALUATE TRUE                                             01430003
014200           WHEN SQLCODE = ZERO                                    01450003
014210           WHEN SQLCODE = +100                                    01450003
014300              CONTINUE                                            01460003
014500           WHEN SQLCODE = -904                                    01480003
014501           WHEN SQLCODE = -911                                    01480003
014502           WHEN SQLCODE = -913                                    01480003
014600              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
014700                 SET PS-CONTINUE-NO   TO TRUE                     01500003
014701                 MOVE '2100-DELETE-SKU-LOC'                       01360003
014702                                      TO PV-PARAGRAPH-NAME        01360003
015000              END-IF                                              01530003
015100           WHEN OTHER                                             01540003
015101              MOVE '2100-DELETE-SKU-LOC'                          01360003
015102                                      TO PV-PARAGRAPH-NAME        01360003
015103              SET PS-CONTINUE-NO      TO TRUE                     01500003
015300        END-EVALUATE                                              01560003
015310     END-PERFORM.                                                 01560003
015400                                                                  01570003
015401***************************************************************** 01270003
015402 2200-SELECT-CURRENT-SKU-LOC.                                     01330003
015403*     SELECT CURRENT ROW OF SKU LOCATION.                         01280003
015404***************************************************************** 01320003
015405                                                                  01350003
015406     PERFORM                                                      01380003
015407        WITH TEST AFTER                                           01380003
015408        VARYING PV-RETRIES                                        01380003
015409        FROM 1 BY 1                                               01380003
015410        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
015411        OR SQLCODE = ZERO                                         01380003
015412        OR PS-CONTINUE-NO                                         01380003
015413                                                                  01390003
015414        EXEC SQL                                                  01380003
015415           SELECT INTR_UPC_ID                                     01390003
015416                 ,LOC_NBR                                         01390003
015417                 ,BEG_TMST                                        01390003
015418                 ,END_TMST                                        01390003
015419                 ,UNT_RTL_AMT                                     01390003
015420                 ,UNT_COST_AMT                                    01390003
015421                 ,LOC_SKU_STAT_CDE                                01390003
015422                 ,UPC_STAT_CHG_DTE                                01390003
015423                 ,UNT_RTL_CHG_DTE                                 01390003
015424                 ,GP_PRIC_ID                                      01390003
015425                 ,GP_RTL_QTY                                      01390003
015426                 ,GP_RTL_AMT                                      01390003
015427                 ,LAST_UPD_TMST                                   01390003
015428                 ,SOR_LAST_MSG_TMST                               01390003
015429                 ,MKDN_CDE                                        01390003
015430                 ,ORIG_CLR_DTE                                    01390003
015431             INTO :XST00008-INTR-UPC-ID                           01390003
015432                 ,:XST00008-LOC-NBR                               01390003
015433                 ,:XST00008-BEG-TMST                              01390003
015434                 ,:XST00008-END-TMST :PV-END-TMST-IND             01390003
015435                 ,:XST00008-UNT-RTL-AMT                           01390003
015436                 ,:XST00008-UNT-COST-AMT                          01390003
015437                 ,:XST00008-LOC-SKU-STAT-CDE                      01390003
015438                 ,:XST00008-UPC-STAT-CHG-DTE                      01390003
015439                 ,:XST00008-UNT-RTL-CHG-DTE                       01390003
015440                 ,:XST00008-GP-PRIC-ID :PV-GP-PRICE-IND           01390003
015441                 ,:XST00008-GP-RTL-QTY :PV-GP-QTY-IND             01390003
015442                 ,:XST00008-GP-RTL-AMT :PV-GP-AMT-IND             01390003
015443                 ,:XST00008-LAST-UPD-TMST                         01390003
015444                 ,:XST00008-SOR-LAST-MSG-TMST                     01390003
015445                 ,:XST00008-MKDN-CDE     :PV-MKDN-CDE-IND         01390003
015446                 ,:XST00008-ORIG-CLR-DTE :PV-ORIG-CLR-DTE-IND     01390003
015447             FROM XST_SKU_LOC                                     01390003
015448            WHERE INTR_UPC_ID = :XST00008-INTR-UPC-ID             01400003
015449              AND LOC_NBR     = :XST00008-LOC-NBR                 01400003
015450              AND BEG_TMST   <= :IM008-RTL-CHG-EFF-BEG-TMST       01400003
015451              AND (END_TMST  IS NULL                              01400003
015452               OR  END_TMST  >= :IM008-RTL-CHG-EFF-BEG-TMST)      01400003
015453        END-EXEC                                                  01410003
015454                                                                  01420003
015455        EVALUATE TRUE                                             01430003
015456           WHEN SQLCODE = ZERO                                    01450003
015457                CONTINUE                                          01350003
015458           WHEN SQLCODE = -904                                    01480003
015459           WHEN SQLCODE = -911                                    01480003
015460           WHEN SQLCODE = -913                                    01480003
015461              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
015462                 SET PS-CONTINUE-NO   TO TRUE                     01500003
015463                 MOVE '2200-SELECT-CURRENT-SKU-LOC'               01360003
015464                                      TO PV-PARAGRAPH-NAME        01360003
015465              END-IF                                              01530003
015466           WHEN OTHER                                             01540003
015467              MOVE '2200-SELECT-CURRENT-SKU-LOC'                  01360003
015468                                      TO PV-PARAGRAPH-NAME        01360003
015469              SET PS-CONTINUE-NO      TO TRUE                     01500003
015470        END-EVALUATE                                              01560003
015480     END-PERFORM.                                                 01560003
015490                                                                          
015500*    * IF SELECT OF CURRENT ROW IS SUCCESSFUL, SAVE VALUES FOR            
015600*    * FUTURE USE.                                                        
015601     IF PS-CONTINUE-YES                                                   
015602        MOVE XST00008-INTR-UPC-ID        TO PV-INTR-UPC-ID        01390003
015603        MOVE XST00008-LOC-NBR            TO PV-LOC-NBR            01390003
015604        MOVE XST00008-BEG-TMST           TO PV-BEG-TMST           01390003
015605        MOVE XST00008-UNT-RTL-AMT        TO PV-UNT-RTL-AMT        01390003
015606        MOVE XST00008-UNT-COST-AMT       TO PV-UNT-COST-AMT       01390003
015607        MOVE XST00008-LOC-SKU-STAT-CDE   TO PV-LOC-SKU-STAT-CDE   01390003
015608        MOVE XST00008-UPC-STAT-CHG-DTE   TO PV-UPC-STAT-CHG-DTE   01390003
015609        MOVE XST00008-UNT-RTL-CHG-DTE    TO PV-UNT-RTL-CHG-DTE    01390003
015610        MOVE XST00008-LAST-UPD-TMST      TO PV-LAST-UPD-TMST      01390003
015611        MOVE XST00008-SOR-LAST-MSG-TMST  TO PV-SOR-LAST-MSG-TMST  01390003
015612        MOVE XST00008-END-TMST           TO PV-END-TMST           01390003
015613        MOVE XST00008-GP-PRIC-ID         TO PV-GP-PRIC-ID         01390003
015614        MOVE XST00008-GP-RTL-QTY         TO PV-GP-RTL-QTY         01390003
015615        MOVE XST00008-GP-RTL-AMT         TO PV-GP-RTL-AMT         01390003
015616        MOVE XST00008-MKDN-CDE           TO PV-MKDN-CDE           01390003
015617        MOVE XST00008-ORIG-CLR-DTE       TO PV-ORIG-CLR-DTE       01390003
015618     END-IF.                                                              
015619                                                                  01570003
015620***************************************************************** 01270003
015621 2300-UPDATE-PRICE-STATUS.                                        01330003
015622*     UPDATE PRICE AND STATUS DATA.  DONE WHEN SKU LOCATION ROW   01280003
015623*     ALREADY EXISTS FOR THE EFFECTIVE TIMESTAMP (AS IN WHEN A            
015624*     SEPARATE COST MESSAGE HAS ALREADY BEEN PROCESSED).                  
015625***************************************************************** 01320003
015626                                                                  01360003
015627     MOVE IM008-RTL-CHG-UNT-RTL-CHG-DTE                           01360003
015628                                     TO XST00008-UNT-RTL-CHG-DTE. 01360003
015629     MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE                          01360003
015630                                     TO XST00008-UPC-STAT-CHG-DTE.01360003
015631                                                                          
015632     IF IM008-RTL-CHG-UNT-RTL-AMT-CHG                             01360003
015633        MOVE IM008-RTL-CHG-UNT-RTL-AMT-N                          01360003
015634                                     TO XST00008-UNT-RTL-AMT      01360003
015635     END-IF.                                                      01360003
015636                                                                  01370003
015637     IF IM008-RTL-CHG-MEITGP-NBR-CHG                              01360003
015638        IF IM008-RTL-CHG-MEITGP-NBR-N  = ZERO                     01360003
015639           MOVE -1                   TO PV-GP-PRICE-IND           01360003
015640                                        PV-GP-QTY-IND             01360003
015641                                        PV-GP-AMT-IND             01360003
015642        ELSE                                                      01360003
015643           MOVE IM008-RTL-CHG-MEITGP-NBR                          01360003
015644                                     TO XST00008-GP-PRIC-ID       01360003
015645           MOVE IM008-RTL-CHG-GP-QTY-N                            01360003
015646                                     TO XST00008-GP-RTL-QTY       01360003
015647           MOVE IM008-RTL-CHG-GP-RTL-AMT-N                        01360003
015648                                     TO XST00008-GP-RTL-AMT       01360003
015649           MOVE ZERO                 TO PV-GP-PRICE-IND           01360003
015650                                        PV-GP-QTY-IND             01360003
015651                                        PV-GP-AMT-IND             01360003
015652        END-IF                                                    01360003
015653     END-IF.                                                      01360003
015654                                                                  01370003
015655     IF IM008-RTL-CHG-SKU-STAT-DSC-CHG                            01360003
015656        MOVE IM008-RTL-CHG-UPC-STAT-CDE-N                         01360003
015657                                     TO XST00008-LOC-SKU-STAT-CDE 01360003
015658     END-IF.                                                      01360003
015659                                                                          
015664     IF IM008-RTL-CHG-UPC-STAT-CDE-N = '30'                               
015670*       * CLEARANCE                       *                               
015680        IF IM008-RTL-CHG-MKDN-CDE <= SPACES                               
015690*          * NON-MARKDOWN OPTIMIZATION STORE *                            
015700           MOVE SPACES          TO XST00008-MKDN-CDE                      
015800           SET PV-MKDN-CDE-NULL TO TRUE                                   
015900                                                                          
PK9078*          IF IM008-RTL-CHG-UNT-RTL-CHG-DTE <=                            
PK9078*             IM008-RTL-CHG-UPC-STAT-CHG-DTE                              
PK9078           IF IM008-RTL-CHG-UPC-STAT-CDE NOT EQUAL '30'                   
PK9078           AND IM008-RTL-CHG-UPC-STAT-CDE NOT EQUAL '25'                  
016200*             * YELLOW TICKET - SET ORIGINAL CLEARANCE DATE *             
016300              MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE TO                      
016400                   XST00008-ORIG-CLR-DTE                                  
016500              SET PV-ORIG-CLR-DTE-VALUE           TO TRUE                 
016600           ELSE                                                           
016700*             * RED TICKET - CARRY OVER VALUES SET WHEN FIRST *           
016800*             * WENT TO YELLOW TICKET                         *           
016900              CONTINUE                                                    
017000           END-IF                                                         
017100        ELSE                                                              
017200*          * MARKDOWN OPTIMIZATION STORE *                                
017300*          * NON-MARKDOWN OPTIMIZATION STORE *                            
017400           MOVE IM008-RTL-CHG-MKDN-CDE TO XST00008-MKDN-CDE               
017500           SET PV-MKDN-CDE-VALUE       TO TRUE                            
017600                                                                          
017700           IF IM008-RTL-CHG-MKDN-CDE = PC-MARK1                           
017800*             * MARK 1 CLEAR - SET ORIGINAL CLEARANCE DATE *              
017900              MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE TO                      
018000                   XST00008-ORIG-CLR-DTE                                  
018100              SET PV-ORIG-CLR-DTE-VALUE           TO TRUE                 
018200           ELSE                                                           
018300*             * MARK 2 OR FINAL CLEAR - CARRY OVER VALUES SET *           
018400*             * WHEN FIRST WENT TO CLEARANCE                  *           
018500              CONTINUE                                                    
018600           END-IF                                                         
018700        END-IF                                                            
018800     ELSE                                                                 
018900*       * NOT CLEARANCE                   *                               
019000        MOVE SPACES              TO XST00008-MKDN-CDE                     
019100        MOVE SPACES              TO XST00008-ORIG-CLR-DTE                 
019200        SET PV-MKDN-CDE-NULL     TO TRUE                                  
019201        SET PV-ORIG-CLR-DTE-NULL TO TRUE                                  
019202     END-IF.                                                      01360003
019203                                                                  01370003
019204     PERFORM                                                      01380003
019205        WITH TEST AFTER                                           01380003
019206        VARYING PV-RETRIES                                        01380003
019207        FROM 1 BY 1                                               01380003
019208        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
019209        OR SQLCODE = ZERO                                         01380003
019210        OR SQLCODE = +100                                         01380003
019211        OR PS-CONTINUE-NO                                         01380003
019212                                                                  01390003
019213        EXEC SQL                                                  01380003
019214           UPDATE XST_SKU_LOC                                     01390003
019215              SET END_TMST          = NULL                        01390003
019216                 ,UNT_RTL_AMT       = :XST00008-UNT-RTL-AMT       01360003
019217                 ,LOC_SKU_STAT_CDE  = :XST00008-LOC-SKU-STAT-CDE  01360003
019218                 ,UPC_STAT_CHG_DTE  = :XST00008-UPC-STAT-CHG-DTE  01360003
019219                 ,GP_PRIC_ID        = :XST00008-GP-PRIC-ID        01360003
019220                                      :PV-GP-PRICE-IND            01360003
019221                 ,UNT_RTL_CHG_DTE   = :XST00008-UNT-RTL-CHG-DTE   01360003
019222                 ,GP_RTL_QTY        = :XST00008-GP-RTL-QTY        01360003
019223                                      :PV-GP-QTY-IND              01360003
019224                 ,GP_RTL_AMT        = :XST00008-GP-RTL-AMT        01360003
019225                                      :PV-GP-AMT-IND              01360003
019226                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
019227                 ,SOR_LAST_MSG_TMST = :IM008-CRE-TMST             01390003
019228                 ,MKDN_CDE          = :XST00008-MKDN-CDE          01360003
019229                                      :PV-MKDN-CDE-IND            01360003
019230                 ,ORIG_CLR_DTE      = :XST00008-ORIG-CLR-DTE      01360003
019231                                      :PV-ORIG-CLR-DTE-IND        01360003
019232            WHERE INTR_UPC_ID       = :XST00008-INTR-UPC-ID       01400003
019233              AND LOC_NBR           = :XST00008-LOC-NBR           01400003
019234              AND BEG_TMST          = :XST00008-BEG-TMST          01400003
019235        END-EXEC                                                  01410003
019236                                                                  01420003
019237        EVALUATE TRUE                                             01430003
019238           WHEN SQLCODE = ZERO                                    01450003
019239              CONTINUE                                            01460003
019240           WHEN SQLCODE = -904                                    01480003
019241           WHEN SQLCODE = -911                                    01480003
019242           WHEN SQLCODE = -913                                    01480003
019243              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
019244                 SET PS-CONTINUE-NO   TO TRUE                     01500003
019245                 MOVE '2300-UPDATE-PRICE-STATUS'                  01360003
019246                                      TO PV-PARAGRAPH-NAME        01360003
019247              END-IF                                              01530003
019248           WHEN OTHER                                             01540003
019249              MOVE '2300-UPDATE-PRICE-STATUS'                     01360003
019250                                      TO PV-PARAGRAPH-NAME        01360003
019251              SET PS-CONTINUE-NO      TO TRUE                     01500003
019252        END-EVALUATE                                              01560003
019253     END-PERFORM.                                                 01560003
019254                                                                  01570003
019255***************************************************************** 01270003
019256 2400-END-CURRENT-ROW.                                            01330003
019257*     PERFORM AN UPDATE TO END THE CURRENT ROW IN SKU LOCATION    01280003
019258*     TABLE.                                                      01280003
019259***************************************************************** 01320003
019260                                                                  01390003
019261     PERFORM                                                      01380003
019262        WITH TEST AFTER                                           01380003
019263        VARYING PV-RETRIES                                        01380003
019264        FROM 1 BY 1                                               01380003
019265        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
019266        OR SQLCODE = ZERO                                         01380003
019267        OR PS-CONTINUE-NO                                         01380003
019268                                                                  01390003
019269        EXEC SQL                                                  01380003
019270           UPDATE XST_SKU_LOC                                     01390003
019271              SET END_TMST          = TIMESTAMP                   01390003
019272                  (:IM008-RTL-CHG-EFF-BEG-TMST) - 1 MICROSECOND   01390003
019273                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
019274                 ,SOR_LAST_MSG_TMST = :IM008-CRE-TMST             01390003
019275            WHERE INTR_UPC_ID       = :XST00008-INTR-UPC-ID       01400003
019276              AND LOC_NBR           = :XST00008-LOC-NBR           01400003
019277              AND BEG_TMST          = :XST00008-BEG-TMST          01400003
019278        END-EXEC                                                  01410003
019279                                                                  01420003
019280        EVALUATE TRUE                                             01430003
019281           WHEN SQLCODE = ZERO                                    01450003
019282              CONTINUE                                            01460003
019283           WHEN SQLCODE = -904                                    01480003
019284           WHEN SQLCODE = -911                                    01480003
019285           WHEN SQLCODE = -913                                    01480003
019286              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
019287                 SET PS-CONTINUE-NO   TO TRUE                     01500003
019288                 MOVE '2400-END-CURRENT-ROW'                      01360003
019289                                      TO PV-PARAGRAPH-NAME        01360003
019290              END-IF                                              01530003
019291           WHEN OTHER                                             01540003
019292              MOVE '2400-END-CURRENT-ROW'                         01360003
019293                                      TO PV-PARAGRAPH-NAME        01360003
019294              SET PS-CONTINUE-NO      TO TRUE                     01500003
019295        END-EVALUATE                                              01560003
019296     END-PERFORM.                                                 01560003
019297                                                                  01570003
019298***************************************************************** 01270003
019299 2500-INSERT-NEW-ROW.                                             01330003
019300*     INSERT A NEW ROW INTO SKU LOCATION TABLE.                   01280003
019301***************************************************************** 01320003
019302                                                                  01350003
019303*    * START BY CARRYING OVER ALL VALUES FROM THE ROW JUST ENDED.         
019304     MOVE PV-SAVE-DATA               TO DCLXST00008.              01360003
019305                                                                  01350003
019306*    * NOW MODIFY THOSE THAT ARE CHANGING.                                
019307     MOVE IM008-RTL-CHG-EFF-BEG-TMST TO XST00008-BEG-TMST.        01380003
019308     MOVE IM008-CRE-TMST             TO                           01380003
019309          XST00008-SOR-LAST-MSG-TMST.                             01380003
019310     MOVE IM008-RTL-CHG-UNT-RTL-CHG-DTE                           01360003
019311                                     TO XST00008-UNT-RTL-CHG-DTE. 01360003
019312     MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE                          01360003
019313                                     TO XST00008-UPC-STAT-CHG-DTE.01360003
019314                                                                  01360003
019315     IF IM008-RTL-CHG-UNT-RTL-AMT-CHG                             01360003
019316        MOVE IM008-RTL-CHG-UNT-RTL-AMT-N                          01360003
019317                                     TO XST00008-UNT-RTL-AMT      01360003
019318     END-IF.                                                      01360003
019319                                                                  01370003
019320     IF IM008-RTL-CHG-MEITGP-NBR-CHG                              01360003
019321        IF IM008-RTL-CHG-MEITGP-NBR-N  = ZERO                     01360003
019322           MOVE -1                   TO PV-GP-PRICE-IND           01360003
019323                                        PV-GP-QTY-IND             01360003
019324                                        PV-GP-AMT-IND             01360003
019325        ELSE                                                      01360003
019326           MOVE IM008-RTL-CHG-MEITGP-NBR-N                        01360003
019327                                     TO XST00008-GP-PRIC-ID       01360003
019328           MOVE IM008-RTL-CHG-GP-QTY-N                            01360003
019329                                     TO XST00008-GP-RTL-QTY       01360003
019330           MOVE IM008-RTL-CHG-GP-RTL-AMT-N                        01360003
019331                                     TO XST00008-GP-RTL-AMT       01360003
019332           MOVE ZERO                 TO PV-GP-PRICE-IND           01360003
019333                                         PV-GP-QTY-IND            01360003
019334                                         PV-GP-AMT-IND            01360003
019335        END-IF                                                    01360003
019336     END-IF.                                                      01360003
019337                                                                  01370003
019338     IF IM008-RTL-CHG-SKU-STAT-DSC-CHG                            01360003
019339        MOVE IM008-RTL-CHG-UPC-STAT-CDE-N                         01360003
019340                                     TO XST00008-LOC-SKU-STAT-CDE 01360003
019350     END-IF.                                                      01360003
019360                                                                          
019370     IF IM008-RTL-CHG-UPC-STAT-CDE-N = '30'                               
019380*       * CLEARANCE                       *                               
019390        IF IM008-RTL-CHG-MKDN-CDE <= SPACES                               
019400*          * NON-MARKDOWN OPTIMIZATION STORE *                            
019500           MOVE SPACES          TO XST00008-MKDN-CDE                      
019600           SET PV-MKDN-CDE-NULL TO TRUE                                   
019700                                                                          
PK9078*          IF IM008-RTL-CHG-UNT-RTL-CHG-DTE <=                            
PK9078*             IM008-RTL-CHG-UPC-STAT-CHG-DTE                              
PK9078           IF IM008-RTL-CHG-UPC-STAT-CDE NOT EQUAL '30'                   
PK9078           AND IM008-RTL-CHG-UPC-STAT-CDE NOT EQUAL '25'                  
020000*             * YELLOW TICKET - SET ORIGINAL CLEARANCE DATE *             
020100              MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE TO                      
020200                   XST00008-ORIG-CLR-DTE                                  
020300              SET PV-ORIG-CLR-DTE-VALUE           TO TRUE                 
020400           ELSE                                                           
020500*             * RED TICKET - CARRY OVER VALUES SET WHEN FIRST *           
020600*             * WENT TO YELLOW TICKET                         *           
020700              CONTINUE                                                    
020800           END-IF                                                         
020900        ELSE                                                              
021000*          * MARKDOWN OPTIMIZATION STORE *                                
021100*          * NON-MARKDOWN OPTIMIZATION STORE *                            
021200           MOVE IM008-RTL-CHG-MKDN-CDE TO XST00008-MKDN-CDE               
021300           SET PV-MKDN-CDE-VALUE       TO TRUE                            
021400                                                                          
021500           IF IM008-RTL-CHG-MKDN-CDE = PC-MARK1                           
021600*             * MARK 1 CLEAR - SET ORIGINAL CLEARANCE DATE *              
021700              MOVE IM008-RTL-CHG-UPC-STAT-CHG-DTE TO                      
021800                   XST00008-ORIG-CLR-DTE                                  
021900              SET PV-ORIG-CLR-DTE-VALUE           TO TRUE                 
022000           ELSE                                                           
022100*             * MARK 2 OR FINAL CLEAR - CARRY OVER VALUES SET *           
022200*             * WHEN FIRST WENT TO CLEARANCE                  *           
022300              CONTINUE                                                    
022400           END-IF                                                         
022500        END-IF                                                            
022600     ELSE                                                                 
022700*       * NOT CLEARANCE                   *                               
022800        MOVE SPACES              TO XST00008-MKDN-CDE                     
022900        MOVE SPACES              TO XST00008-ORIG-CLR-DTE                 
023000        SET PV-MKDN-CDE-NULL     TO TRUE                                  
023001        SET PV-ORIG-CLR-DTE-NULL TO TRUE                                  
023002     END-IF.                                                      01360003
023003                                                                  01370003
023004     PERFORM                                                      01380003
023005        WITH TEST AFTER                                           01380003
023006        VARYING PV-RETRIES                                        01380003
023007        FROM 1 BY 1                                               01380003
023008        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023009        OR SQLCODE = ZERO                                         01380003
023010        OR PS-CONTINUE-NO                                         01380003
023011                                                                  01390003
023012        EXEC SQL                                                  01380003
023013           INSERT INTO XST_SKU_LOC                                01390003
023014              ( INTR_UPC_ID                                       01390003
023015               ,LOC_NBR                                           01400003
023016               ,BEG_TMST                                          01400003
023017               ,END_TMST                                          01400003
023018               ,UNT_RTL_AMT                                       01400003
023019               ,UNT_COST_AMT                                      01410003
023020               ,LOC_SKU_STAT_CDE                                  01410003
023021               ,UPC_STAT_CHG_DTE                                  01410003
023022               ,UNT_RTL_CHG_DTE                                   01410003
023023               ,GP_PRIC_ID                                        01410003
023024               ,GP_RTL_QTY                                        01420003
023025               ,GP_RTL_AMT                                        01420003
023026               ,LAST_UPD_TMST                                     01420003
023027               ,SOR_LAST_MSG_TMST                                 01420003
023028               ,MKDN_CDE                                          01420003
023029               ,ORIG_CLR_DTE)                                     01420003
023030           VALUES                                                 01420003
023031              ( :XST00008-INTR-UPC-ID                             01390003
023032               ,:XST00008-LOC-NBR                                 01400003
023033               ,:XST00008-BEG-TMST                                01400003
023034               ,NULL                                              01400003
023035               ,:XST00008-UNT-RTL-AMT                             01400003
023036               ,:XST00008-UNT-COST-AMT                            01410003
023037               ,:XST00008-LOC-SKU-STAT-CDE                        01410003
023038               ,:XST00008-UPC-STAT-CHG-DTE                        01410003
023039               ,:XST00008-UNT-RTL-CHG-DTE                         01410003
023040               ,:XST00008-GP-PRIC-ID :PV-GP-PRICE-IND             01410003
023041               ,:XST00008-GP-RTL-QTY :PV-GP-QTY-IND               01420003
023042               ,:XST00008-GP-RTL-AMT :PV-GP-AMT-IND               01420003
023043               ,CURRENT TIMESTAMP                                 01420003
023044               ,:XST00008-SOR-LAST-MSG-TMST                       01420003
023045               ,:XST00008-MKDN-CDE     :PV-MKDN-CDE-IND           01420003
023046               ,:XST00008-ORIG-CLR-DTE :PV-ORIG-CLR-DTE-IND)      01420003
023047        END-EXEC                                                  01430003
023048                                                                  01430003
023049        EVALUATE TRUE                                             01430003
023050           WHEN SQLCODE = ZERO                                    01450003
023051              CONTINUE                                            01460003
023052           WHEN SQLCODE = -904                                    01480003
023053           WHEN SQLCODE = -911                                    01480003
023054           WHEN SQLCODE = -913                                    01480003
023055              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023056                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023057                 MOVE '2500-INSERT-NEW-ROW'                       01360003
023058                                      TO PV-PARAGRAPH-NAME        01360003
023059              END-IF                                              01530003
023060           WHEN OTHER                                             01540003
023061              MOVE '2500-INSERT-NEW-ROW'                          01360003
023062                                      TO PV-PARAGRAPH-NAME        01360003
023063              SET PS-CONTINUE-NO      TO TRUE                     01500003
023064        END-EVALUATE                                              01560003
023065     END-PERFORM.                                                 01560003
023066                                                                  01570003
023067***************************************************************** 01270003
023068 2600-DETM-SKU-LOC-ATTR.                                          01330003
023069*     DETERMINE VALUE FOR PRMPT_FOR_PRIC_IND IN XST_SKU_LOC_ATTR. 01280003
023070***************************************************************** 01320003
023071                                                                  01350003
023072     IF IM008-RTL-CHG-SKU-STAT-DSC-CHG                            01360003
023073        IF IM008-RTL-CHG-UPC-STAT-CDE-N = PC-CLEARANCE            01380003
023074           IF IM008-RTL-CHG-UPC-STAT-CHG-DTE <                    01380003
023075              IM008-RTL-CHG-UNT-RTL-CHG-DTE                       01380003
023076              MOVE PC-NO              TO                          01360003
023077                   XST00041-PRMPT-FOR-PRIC-IND                    01360003
023078           ELSE                                                   01380003
023079              MOVE PC-NO              TO                          01360003
023080                   XST00041-PRMPT-FOR-PRIC-IND                    01360003
023081           END-IF                                                 01380003
023082           PERFORM 2700-UPDATE-SKU-LOC-ATTR                       01380003
023083        ELSE                                                      01360003
023084           IF (IM008-RTL-CHG-UPC-STAT-CDE = PC-CLEARANCE OR       01360003
023085               IM008-RTL-CHG-UPC-STAT-CDE = PC-MIXED)             01360003
023086              MOVE PC-YES             TO                          01360003
023087                   XST00041-PRMPT-FOR-PRIC-IND                    01360003
023088              PERFORM 2700-UPDATE-SKU-LOC-ATTR                    01380003
023089           END-IF                                                 01380003
023090        END-IF                                                    01360003
023091     ELSE                                                         01360003
023092        IF IM008-RTL-CHG-UNT-RTL-AMT-CHG                          01380003
023093           IF IM008-RTL-CHG-UPC-STAT-CDE-N = PC-CLEARANCE         01380003
023094              IF IM008-RTL-CHG-UPC-STAT-CHG-DTE <                 01380003
023095                 IM008-RTL-CHG-UNT-RTL-CHG-DTE                    01380003
023096                 MOVE PC-NO           TO                          01360003
023097                      XST00041-PRMPT-FOR-PRIC-IND                 01360003
023098              ELSE                                                01380003
023099                 MOVE PC-NO           TO                          01360003
023100                      XST00041-PRMPT-FOR-PRIC-IND                 01360003
023101              END-IF                                              01380003
023102              PERFORM 2700-UPDATE-SKU-LOC-ATTR                    01380003
023103           ELSE                                                   01360003
023104              MOVE PC-YES             TO                          01360003
023105                   XST00041-PRMPT-FOR-PRIC-IND                    01360003
023106              PERFORM 2700-UPDATE-SKU-LOC-ATTR                    01380003
023107           END-IF                                                 01380003
023108        END-IF                                                    01360003
023109     END-IF.                                                      01360003
023110                                                                  01370003
023111***************************************************************** 01270003
023112 2700-UPDATE-SKU-LOC-ATTR.                                        01330003
023113*     UPDATE TABLE XST_SKU_LOC_ATTR.                              01280003
023114***************************************************************** 01320003
023115                                                                  01350003
023116     PERFORM                                                      01380003
023117        WITH TEST AFTER                                           01380003
023118        VARYING PV-RETRIES                                        01380003
023119        FROM 1 BY 1                                               01380003
023120        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023121        OR SQLCODE = ZERO                                         01380003
023122        OR SQLCODE = +100                                         01380003
023123        OR PS-CONTINUE-NO                                         01380003
023124                                                                  01390003
023125        EXEC SQL                                                  01380003
023126           UPDATE XST_SKU_LOC_ATTR                                01390003
023127              SET PRMPT_FOR_PRIC_IND =                            01390003
023128                  :XST00041-PRMPT-FOR-PRIC-IND                    01390003
023129                 ,LAST_UPD_TMST      = CURRENT TIMESTAMP          01390003
023130            WHERE INTR_UPC_ID        = :XST00008-INTR-UPC-ID      01400003
023131              AND LOC_NBR            = :XST00008-LOC-NBR          01400003
023132        END-EXEC                                                  01410003
023133                                                                  01430003
023134        EVALUATE TRUE                                             01430003
023135           WHEN SQLCODE = ZERO                                    01450003
023136              CONTINUE                                            01460003
023137           WHEN SQLCODE = -904                                    01480003
023138           WHEN SQLCODE = -911                                    01480003
023139           WHEN SQLCODE = -913                                    01480003
023140              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023141                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023142                 MOVE '2700-UPDATE-SKU-LOC-ATTR'                  01360003
023143                                      TO PV-PARAGRAPH-NAME        01360003
023144              END-IF                                              01530003
023145           WHEN OTHER                                             01540003
023146              MOVE '2700-UPDATE-SKU-LOC-ATTR'                     01360003
023147                                      TO PV-PARAGRAPH-NAME        01360003
023148              SET PS-CONTINUE-NO      TO TRUE                     01500003
023149        END-EVALUATE                                              01560003
023150     END-PERFORM.                                                 01560003
023151                                                                  01240003
023152***************************************************************** 01270003
023153 2750-DELETE-FUTURE-RCP.                                          01330003
023154*     DELETES FUTURE RCP ROWS IN XST_SKU_LOC TABLE IF ANY EXIST.  01280003
023155*     USED WHEN SKU STATUS CHANGES FROM CLEARANCE TO ACTIVE, SO           
023156*     FUTURE RCP COULD NO LONGER BE CORRECT.                              
023157***************************************************************** 01320003
023158                                                                  01370003
023159     PERFORM                                                      01380003
023160        WITH TEST AFTER                                           01380003
023161        VARYING PV-RETRIES                                        01380003
023162        FROM 1 BY 1                                               01380003
023163        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023164        OR SQLCODE = ZERO                                         01380003
023165        OR SQLCODE = +100                                         01380003
023166        OR PS-CONTINUE-NO                                         01380003
023167                                                                  01390003
023168        EXEC SQL                                                  01390003
023169           DELETE                                                 01390003
023170             FROM XST_SKU_LOC                                     01390003
023171            WHERE INTR_UPC_ID =  :XST00008-INTR-UPC-ID            01400003
023172              AND LOC_NBR     >  0                                01400003
023173              AND BEG_TMST    >= :IM008-RTL-CHG-EFF-BEG-TMST      01400003
023174              AND (END_TMST   IS NULL                             01400003
023175               OR  END_TMST   >= :IM008-RTL-CHG-EFF-BEG-TMST)     01400003
023176        END-EXEC                                                  01410003
023177                                                                  01420003
023178        EVALUATE TRUE                                             01430003
023179           WHEN SQLCODE = ZERO                                    01450003
023180           WHEN SQLCODE = +100                                    01450003
023181              CONTINUE                                            01460003
023182           WHEN SQLCODE = -904                                    01480003
023183           WHEN SQLCODE = -911                                    01480003
023184           WHEN SQLCODE = -913                                    01480003
023185              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023186                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023187                 MOVE '2750-DELETE-FUTURE-RCP'                    01360003
023188                                      TO PV-PARAGRAPH-NAME        01360003
023189              END-IF                                              01530003
023190           WHEN OTHER                                             01540003
023191              MOVE '2750-DELETE-FUTURE-RCP'                       01360003
023192                                      TO PV-PARAGRAPH-NAME        01360003
023193              SET PS-CONTINUE-NO      TO TRUE                     01500003
023194        END-EVALUATE                                              01560003
023195     END-PERFORM.                                                 01560003
023196                                                                  01570003
023197***************************************************************** 01270003
023198 2800-END-SKU-LOC.                                                01330003
023199*     UPDATE TABLE XST_SKU_LOC, IF ROWS NEED TO BE ENDED.         01280003
023200***************************************************************** 01320003
023201                                                                  01350003
023202     PERFORM                                                      01380003
023203        WITH TEST AFTER                                           01380003
023204        VARYING PV-RETRIES                                        01380003
023205        FROM 1 BY 1                                               01380003
023206        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023207        OR SQLCODE = ZERO                                         01380003
023208        OR SQLCODE = +100                                         01380003
023209        OR PS-CONTINUE-NO                                         01380003
023210                                                                  01390003
023211        EXEC SQL                                                  01380003
023212           UPDATE XST_SKU_LOC                                     01390003
023213              SET END_TMST    =                                   01390003
023214                  TIMESTAMP(:IM008-RTL-CHG-EFF-BEG-TMST) -        01390003
023215                  1 MICROSECOND                                   01390003
023216                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
023217                 ,SOR_LAST_MSG_TMST = :IM008-CRE-TMST             01390003
023218            WHERE INTR_UPC_ID = :XST00008-INTR-UPC-ID             01400003
023219              AND LOC_NBR     > 0                                 01400003
023220              AND (END_TMST  IS NULL                              01400003
023221               OR  END_TMST  >= :IM008-RTL-CHG-EFF-BEG-TMST)      01400003
023222        END-EXEC                                                  01410003
023223                                                                  01430003
023224        EVALUATE TRUE                                             01430003
023225           WHEN SQLCODE = ZERO                                    01450003
023226           WHEN SQLCODE = +100                                    01480003
023227              CONTINUE                                            01460003
023228           WHEN SQLCODE = -904                                    01480003
023229           WHEN SQLCODE = -911                                    01480003
023230           WHEN SQLCODE = -913                                    01480003
023231              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023232                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023233                 MOVE '2800-END-SKU-LOC'                          01360003
023234                                      TO PV-PARAGRAPH-NAME        01360003
023235              END-IF                                              01530003
023236           WHEN OTHER                                             01540003
023237              MOVE '2800-END-SKU-LOC'                             01360003
023238                                      TO PV-PARAGRAPH-NAME        01360003
023239              SET PS-CONTINUE-NO      TO TRUE                     01500003
023240        END-EVALUATE                                              01560003
023241     END-PERFORM.                                                 01560003
023242                                                                  01570003
023243***************************************************************** 01270003
023244 2900-DELETE-SKU-LOC-ATTR.                                        01330003
023245*     DELETES ROW IN XST_SKU_LOC_ATTR, IF ANY EXIST.              01280003
023246***************************************************************** 01320003
023247                                                                  01350003
023248     PERFORM                                                      01380003
023249        WITH TEST AFTER                                           01380003
023250        VARYING PV-RETRIES                                        01380003
023251        FROM 1 BY 1                                               01380003
023252        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023253        OR SQLCODE = ZERO                                         01380003
023254        OR SQLCODE = +100                                         01380003
023255        OR PS-CONTINUE-NO                                         01380003
023256                                                                  01390003
023257        EXEC SQL                                                  01380003
023258           DELETE                                                 01390003
023259             FROM XST_SKU_LOC_ATTR                                01390003
023260            WHERE INTR_UPC_ID = :XST00008-INTR-UPC-ID             01400003
023261              AND LOC_NBR     > 0                                 01400003
023262        END-EXEC                                                  01410003
023263                                                                  01420003
023264        EVALUATE TRUE                                             01430003
023265           WHEN SQLCODE = ZERO                                    01450003
023266           WHEN SQLCODE = +100                                    01450003
023267              CONTINUE                                            01460003
023268           WHEN SQLCODE = -904                                    01480003
023269           WHEN SQLCODE = -911                                    01480003
023270           WHEN SQLCODE = -913                                    01480003
023271              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023272                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023273                 MOVE '2900-DELETE-SKU-LOC-ATTR'                  01360003
023274                                      TO PV-PARAGRAPH-NAME        01360003
023275              END-IF                                              01530003
023276           WHEN OTHER                                             01540003
023277              MOVE '2900-DELETE-SKU-LOC-ATTR'                     01360003
023278                                      TO PV-PARAGRAPH-NAME        01360003
023279              SET PS-CONTINUE-NO      TO TRUE                     01500003
023280        END-EVALUATE                                              01560003
023281     END-PERFORM.                                                 01560003
023282                                                                  01570003
023283***************************************************************** 01270003
023284 3000-UPDATE-XST-SKU-ATTR.                                        01330003
023285*     UPDATE SKU ATTR TABLE.  ANYTIME THE PRICE CHANGES AND THE   01280003
023286*     IT IS NOT CLEARANCE STATUS, THE LAST NON-CLEARANCE RETAIL   01280003
023287*     AMOUNT MUST BE UPDATED.                                             
023288***************************************************************** 01320003
023289                                                                  01350003
023290     PERFORM                                                      01380003
023291        WITH TEST AFTER                                           01380003
023292        VARYING PV-RETRIES                                        01380003
023293        FROM 1 BY 1                                               01380003
023294        UNTIL PV-RETRIES > PC-MAX-RETRIES                         01380003
023295        OR SQLCODE = ZERO                                         01380003
023296        OR PS-CONTINUE-NO                                         01380003
023297                                                                  01390003
023298        EXEC SQL                                                  01380003
023299           UPDATE XST_SKU_ATTR                                    01390003
023300              SET LAST_NCLR_RTL_AMT = :XST00011-LAST-NCLR-RTL-AMT 01390003
023301                 ,LAST_UPD_TMST     = CURRENT TIMESTAMP           01390003
023302            WHERE INTR_UPC_ID       = :XST00011-INTR-UPC-ID       01400003
023303        END-EXEC                                                  01410003
023304                                                                  01430003
023305        EVALUATE TRUE                                             01430003
023306           WHEN SQLCODE = ZERO                                    01450003
023307              CONTINUE                                            01460003
023308           WHEN SQLCODE = -904                                    01480003
023309           WHEN SQLCODE = -911                                    01480003
023310           WHEN SQLCODE = -913                                    01480003
023311              IF PV-RETRIES >= PC-MAX-RETRIES                     01490003
023312                 SET PS-CONTINUE-NO   TO TRUE                     01500003
023313                 MOVE '3000-UPDATE-XST-SKU-ATTR'                  01360003
023314                                      TO PV-PARAGRAPH-NAME        01360003
023315              END-IF                                              01530003
023316           WHEN OTHER                                             01540003
023317              MOVE '3000-UPDATE-XST-SKU-ATTR'                     01360003
023318                                      TO PV-PARAGRAPH-NAME        01360003
023319              SET PS-CONTINUE-NO      TO TRUE                     01500003
023320        END-EVALUATE                                              01560003
023321     END-PERFORM.                                                 01560003
023322                                                                  01570003
023323******************************************************************01590003
023324 9999-WRAPUP.                                                     01620003
023325*     MOVE RETURN CODE TO LINKAGE VARIABLE AND EXIT MODULE        01600003
023326******************************************************************01610003
023327                                                                  01630003
023328     MOVE PV-RETURN-SQLCODE TO LV-RETURN-CODE.                    01660003
023329     MOVE PS-ACTION-IND     TO LV-ACTION-IND.                     01670003
023330                                                                  01680003
023331     EXIT PROGRAM.                                                01690003
023332                                                                  01700003
