000100 IDENTIFICATION DIVISION.                                         00010039
000200 PROGRAM-ID.             WSKCS303.                                00020040
000300 AUTHOR.                 PATRICK BURKE.                           00030040
000400 INSTALLATION.           KOHLS.                                   00040040
000500 DATE-WRITTEN            FEBRAURY 2007.                           00050040
000600 DATE-COMPILED.                                                   00060040
000700                                                                  00070040
001400******************************************************************00140016
001500* THIS PROGRAM WILL CALL THE VENDOR SHIPMENT CONTROL MODULE TO    00150009
001600* DOWNLOAD THE WMS SHIPMENTS THAT ARE READY TO BE DOWNLOADED.     00160009
001700******************************************************************00170009
001800                                                                  00180009
001900 ENVIRONMENT DIVISION.                                            00190009
002000 DATA DIVISION.                                                   00200009
002100 WORKING-STORAGE SECTION.                                         00210009
002200                                                                  00220009
002300*---------------------------------------------------------------* 00230009
002400*  RECORD LAYOUT FOR THE COMMAREA BEING USED TO PASS DATA TO    * 00240009
002500*  THE VENDOR ASN DOWNLOAD MODULE (WSKCS301).                   * 00250047
002600*---------------------------------------------------------------* 00260009
002700     COPY WSWS003.                                                00270011
002800                                                                  00280009
002900*---------------------------------------------------------------* 00290031
003000*      THIS COPYBOOK IS USED FOR THE MAINTANCE OF THE WMS ASN     00300031
003100*  DOWNLOAD CONTROL TABLES.                                       00310031
003200*---------------------------------------------------------------* 00320031
003300     COPY WSWS001.                                                00330031
003400                                                                  00340031
003500*-----------------------------------------------------------------00350009
003600*  LAYOUT FOR THE ABEND MODULE COMMUNICATIONS AREA.               00360009
003700*-----------------------------------------------------------------00370009
003800     COPY DPWS013.                                                00380009
003900*                                                                 00390009
004000     COPY RCWS071.                                                00400009
004100*                                                                 00410009
004200 01  PC-PROGRAM-CONSTANTS.                                        00420009
004300     05  PC-MAX-RETRIES                  PIC S9(03)  VALUE +3     00430009
004400                                                     COMP-3.      00440009
004500     05  PC-TRANID-E291                  PIC  X(04)  VALUE 'E291'.00450009
004600     05  PC-SPACES                       PIC  X(22)  VALUE SPACES.00460009
004700     05  PC-CURRENT-PGM-NAME             PIC  X(08)  VALUE        00470009
004800         'WSKCS303'.                                              00480009
004900     05  PC-ASN-DOWNLOAD-MOD          PIC X(8)  VALUE  'WSKCS301'.00490011
005000     05  PC-ASN-DOWNLOAD-MOD-LENGTH   PIC S9(4) VALUE +125        00500011
005100                                                COMP SYNC.        00510011
005101     05  PC-WMS-CONTROL-MOD           PIC X(8)  VALUE  'WSKCS305'.00510146
005102     05  PC-WMS-CONTROL-MOD-LENGTH    PIC S9(4) VALUE +125        00510246
005103                                                COMP SYNC.        00510346
005110     05  PC-SHIP-ASN-MOD             PIC X(08)  VALUE             00511041
005120                                                 'WSKCS304'.      00512041
005130     05  PC-SHIP-ASN-MOD-LENGTH      PIC S9(4) VALUE +125         00513041
005140                                                COMP SYNC.        00514041
005150     05  PC-SHIP-ASN-MOD-TRAN        PIC X(04)  VALUE 'W304'.     00515041
005160                                                                  00516041
005200     05  PC-DEFAULT-DATE-1               PIC  X(26)  VALUE        00520009
005300                                   '9999-09-09-09.09.09.999999'.  00530009
005400     05  PC-DEFAULT-DATE-2               PIC  X(26)  VALUE        00540009
005500                                   '0001-01-01-00.00.00.000000'.  00550009
005600     05  PC-DEFAULT-TMST                 PIC  X(26)   VALUE       00560009
005700                                   '9999-09-09-09.09.09.999999'.  00570009
005800*                                                                 00580009
005900 01  PS-PROGRAM-SWITCHES.                                         00590009
006000     05  PS-END-OF-CSR-SW                PIC  X(01)  VALUE 'N'.   00600011
006100         88  PS-END-OF-CSR                           VALUE 'Y'.   00610011
006200         88  PS-END-OF-CSR-NO                        VALUE 'N'.   00620011
006300     05  PS-CSSL-LOGGING-SW              PIC  X(01)  VALUE 'N'.   00630009
006400         88  PS-CSSL-LOGGING-YES                     VALUE 'Y'.   00640009
006500         88  PS-CSSL-LOGGING-NO                      VALUE 'N'.   00650009
006501* JAK 07/2007 - ADD NEW SWITCHES                                  00650160
006510     05  PS-CALL-ASN-SW                  PIC  X(01)  VALUE 'N'.   00651060
006520         88  PS-CALL-ASN-YES                         VALUE 'Y'.   00652060
006530         88  PS-CALL-ASN-NO                          VALUE 'N'.   00653060
006540     05  PS-END-OF-TRBL-CSR-SW           PIC  X(01)  VALUE 'N'.   00654060
006550         88  PS-END-OF-TRBL-CSR                      VALUE 'Y'.   00655060
006560         88  PS-END-OF-TRBL-CSR-NO                   VALUE 'N'.   00656060
006570* JAK 07/2007 - END                                               00657060
006600*                                                                 00660009
006700 01  DK-DB2-KEYS.                                                 00670009
006800     05  DK-SHIP-ID                      PIC  X(20).              00680009
006900                                                                  00690009
007000     05  DK-TRIP-ID                      PIC S9(09)  VALUE ZERO   00700009
007100                                                     COMP.        00710009
007200                                                                  00720009
007300 01  PV-PROGRAM-VARIABLES.                                        00730009
007400     05  PV-DISPLAY-SQLCODE              PIC 9(04).               00740030
007500     05  PV-DISPLAY-TRIP-ID              PIC 9(09).               00750030
007600     05  PV-CICS-RESPONSE                PIC S9(08)  VALUE ZEROS  00760009
007700                                                     COMP SYNC.   00770009
007800     05  PV-RETRY-COUNTER                PIC S9(04)  VALUE ZEROS  00780009
007900                                                     COMP SYNC.   00790009
008000     05  PV-NULL-IND                     PIC S9(04)  VALUE ZEROS  00800009
008100                                                     COMP SYNC.   00810009
008200     05  PV-DB2-TROUBLE-COUNT            PIC S9(09)  VALUE ZEROS  00820009
008300                                                     COMP-3.      00830009
008400     05  PV-DB2-FREIGHT-COUNT            PIC S9(09)  VALUE ZEROS  00840009
008500                                                     COMP-3.      00850009
008600     05  PV-ARRIVED-COUNT                PIC S9(09)  VALUE ZEROS  00860009
008700                                                     COMP-3.      00870009
008800     05  PV-TASK-X.                                               00880009
008900         10  PV-TASK                     PIC 9(07)   VALUE ZERO.  00890009
009000     05  PV-RECEIVE-LENGTH               PIC S9(04)  VALUE +0     00900009
009100                                                     COMP SYNC.   00910009
009200     05  PV-WRITE-LENGTH                 PIC S9(04)  VALUE +0     00920009
009300                                                     COMP SYNC.   00930009
009400     05  PV-COMMAREA-LENGTH              PIC S9(04)  VALUE +0     00940009
009500                                                     COMP SYNC.   00950009
009600     05  PV-STACK-RBA                    PIC S9(09)  VALUE ZEROS  00960009
009700                                                     COMP SYNC.   00970009
009800     05  PV-CICS-MSG-AREA                PIC  X(120) VALUE SPACE. 00980009
009900     05  PV-ERROR-TRIP                   PIC  9(09)  VALUE ZEROS. 00990012
010000     05  PV-ERROR-SHIPT-ID               PIC  9(09)  VALUE ZEROS. 01000012
010100     05  PC-TRANID-W303                  PIC  X(04)  VALUE 'W303'.01010013
010200     05  PV-CURRENT-TIMESTAMP            PIC  X(26)  VALUE SPACE. 01020009
010300     05  PV-PREV-TIMESTAMP               PIC  X(26)  VALUE SPACE. 01030009
010400                                                                  01040012
010500     05  PV-RESTART-TIME                 PIC  S9(09)    VALUE +0  01050009
010600                                                     COMP SYNC.   01060009
010700     05  PV-UPDATE-TIME                  PIC  S9(09) COMP.        01070015
010800                                                                  01080015
010900     05  PV-DISP-TRIP                    PIC  9(09) VALUE ZEROS.  01090012
011000     05  PV-DISP-SHIPT-ID                PIC  X(20) VALUE ZEROS.  01100066
011100     05  PV-PARA-NAME                    PIC  X(23).              01110009
011101* JAK 07/2007 - ADD NEW VARIABLES                                 01110160
011110     05  PV-SQL-COUNT                    PIC  S9(09) COMP.        01111060
011111     05  PV-TROUBLE-COUNT                PIC  S9(09) COMP         01111160
011112                                                       VALUE +0.  01111260
011120* JAK 07/2007 - END                                               01112060
013200                                                                  01320009
014000*---------------------------------------------------------------* 01400009
014100*    DB2 AREA FOR TKRPRPM - PARAMENTERS TABLE                   * 01410009
014200*---------------------------------------------------------------* 01420009
014300     EXEC SQL                                                     01430009
014400          INCLUDE TKRPRPM                                         01440009
014500     END-EXEC.                                                    01450009
014600*                                                                 01460009
014710*---------------------------------------------------------------* 01471009
014800*    DB2 AREA FOR WST_SHPMT_XREF_HDR                            * 01480009
014900*        WMS SHIPMENT CROSS REFERENCE HEADER TABLE              * 01490009
015000*---------------------------------------------------------------* 01500009
015100     EXEC SQL                                                     01510009
015200          INCLUDE WST00001                                        01520009
015300     END-EXEC.                                                    01530009
015400*                                                                 01540009
015500*---------------------------------------------------------------* 01550009
015600*    DB2 AREA FOR WST_SHPMT_XREF_DTL                            * 01560009
015700*        WMS SHIPMENT CROSS REFERENCE DETAIL TABLE              * 01570009
015800*---------------------------------------------------------------* 01580009
015900     EXEC SQL                                                     01590009
016000          INCLUDE WST00002                                        01600009
016100     END-EXEC.                                                    01610009
016200*                                                                 01620009
016210*---------------------------------------------------------------* 01621044
016220*    DB2 AREA FOR WST_INTGRTN_TYP - INTEGRATION TYPE            * 01622044
016230*---------------------------------------------------------------* 01623044
016400     EXEC SQL                                                     01640004
016500         INCLUDE WST00008                                         01650004
016600     END-EXEC.                                                    01660004
016610*---------------------------------------------------------------* 01661044
016620*    DB2 AREA FOR WST_ATTR_DEFN - ATTRIBUTE DEFINITION          * 01662044
016630*---------------------------------------------------------------* 01663044
016800     EXEC SQL                                                     01680004
016900         INCLUDE WST00009                                         01690004
017000     END-EXEC.                                                    01700004
017010*---------------------------------------------------------------* 01701044
017020*    DB2 AREA FOR WST_ATTR_ELEM - ATTRIBUTE ELEMENT             * 01702044
017030*---------------------------------------------------------------* 01703044
017200     EXEC SQL                                                     01720004
017300         INCLUDE WST00010                                         01730004
017400     END-EXEC.                                                    01740004
017401* JAK 07/2007 - ADD NEW DATABASE TABLES                           01740161
017402*---------------------------------------------------------------* 01740261
017403*    DB2 AREA FOR TTRBNTF - TROUBLE NOTIFICATION TABLE          * 01740361
017404*---------------------------------------------------------------* 01740461
017405     EXEC SQL                                                     01740561
017406         INCLUDE TTRBNTF                                          01740661
017407     END-EXEC.                                                    01740761
017408*---------------------------------------------------------------* 01740861
017409*    DB2 AREA FOR TTRBRSN - TROUBLE REASON CODE TABLE           * 01740961
017410*---------------------------------------------------------------* 01741061
017411     EXEC SQL                                                     01741161
017412         INCLUDE TTRBRSN                                          01741261
017413     END-EXEC.                                                    01741361
017414*---------------------------------------------------------------* 01741461
017415*    DB2 AREA FOR TTRBRCN - TROUBLE REPORTING CONTROL TABLE     * 01741561
017416*---------------------------------------------------------------* 01741661
017417     EXEC SQL                                                     01741761
017418         INCLUDE TTRBRCN                                          01741861
017419     END-EXEC.                                                    01741961
017420* JAK 07/2007 - END                                               01742061
017421*---------------------------------------------------------------* 01742144
017422* * *  WMS ASN DOWNLOAD CONTROL AREA                              01742241
017423*---------------------------------------------------------------* 01742344
017430     COPY WSWS004.                                                01743041
017440                                                                  01744041
017500*---------------------------------------------------------------* 01750009
017600* WMS CROSS REFERENCE CURSOR TO DETERMINE WHAT IS READY TO BE   * 01760009
017700* DOWNLOADED FROM THE SHIPMENT CROSS REFERENCE TABLES           * 01770009
017800*---------------------------------------------------------------* 01780009
017900     EXEC SQL                                                     01790009
018000          DECLARE WMS_XREF_CSR CURSOR FOR                         01800009
018100            SELECT A.INTR_TRIP_ID                                 01810009
018200                  ,A.EXT_SHP_ID                                   01820009
018300                  ,A.DWNLD_TMST                                   01830030
018310                  ,A.RCPT_TMST                                    01831046
018400                  ,A.DEST_LOC_NBR                                 01840035
018410                  ,A.SOR_CDE                                      01841041
018420                  ,A.DWNLD_CDE                                    01842078
018500              FROM WST_SHPMT_XREF_HDR A                           01850010
018800            WHERE A.DWNLD_CDE      IN ('N','P')                   01880009
018900              AND A.LAST_PRCG_TMST  <                             01890083
019000                    (CURRENT TIMESTAMP - :PV-UPDATE-TIME SECONDS) 01900083
019600          ORDER BY                                                01960036
019700                A.INTR_TRIP_ID                                    01970009
019800              , A.EXT_SHP_ID                                      01980009
019900     END-EXEC.                                                    01990009
020000                                                                  02000009
020001* JAK 07/2007 - ADD NEW CURSOR                                    02000160
020010*---------------------------------------------------------------* 02001060
020020* TROUBLE CURSOR TO DETERMINE WHICH LINES ARE IN TROUBLE        * 02002060
020040*---------------------------------------------------------------* 02004060
020050     EXEC SQL                                                     02005060
020060          DECLARE TRBL_CSR CURSOR FOR                             02006060
020070            SELECT PO_NBR                                         02007060
020080                  ,RCVR_SEQ_NBR                                   02008060
020094              FROM WST_SHPMT_XREF_DTL                             02009460
020095            WHERE DWNLD_CDE      = 'T'                            02009560
020096            AND   EXT_SHP_ID     = :DK-SHIP-ID                    02009660
020101     END-EXEC.                                                    02010160
020102                                                                  02010260
020110*---------------------------------------------------------------* 02011009
020200*    DB2 AREA FOR COMMUNICATIONS                                * 02020009
020300*---------------------------------------------------------------* 02030009
020400     EXEC SQL                                                     02040009
020500          INCLUDE SQLCA                                           02050009
020600     END-EXEC.                                                    02060009
020700***************************************************************** 02070009
020800/                                                                 02080030
020900 PROCEDURE DIVISION.                                              02090009
021000                                                                  02100009
021100 0000-PROGRAM-MAINLINE.                                           02110009
021200                                                                  02120009
021300     MOVE EIBTASKN               TO PV-TASK.                      02130009
021400                                                                  02140009
021500     STRING ' WSKCS303 STARTED - TASK = ' PV-TASK-X               02150009
021600     DELIMITED BY SIZE INTO PV-CICS-MSG-AREA.                     02160009
021700     PERFORM 9990-WRITE-CICS.                                     02170009
021800                                                                  02180009
021900     PERFORM 0005-SET-CSSL-SWITCH.                                02190053
022000                                                                  02200030
022001* JAK 08/2007 - ADDED PERFORM OF PARAGRAPH 0500                   02200175
022010     PERFORM 0500-MAIN-DRIVER-INFO.                               02201073
022020                                                                  02202073
022100     PERFORM 0010-GET-RESTART-INFO.                               02210009
022200                                                                  02220009
022300     PERFORM 1000-OPEN-XREF-CSR.                                  02230009
022400                                                                  02240009
022500     PERFORM 1100-READ-XREF-ROW.                                  02250009
022600                                                                  02260009
022700     PERFORM 2000-PROCESS                                         02270009
022800         UNTIL PS-END-OF-CSR.                                     02280011
022900                                                                  02290009
023000     PERFORM 1200-CLOSE-XREF-CSR.                                 02300009
023100                                                                  02310009
023200     STRING ' WSKCS303 ENDED - TASK = '                           02320009
023300            PV-TASK-X                    DELIMITED BY SIZE        02330009
023400       INTO PV-CICS-MSG-AREA.                                     02340009
023500     PERFORM 9990-WRITE-CICS.                                     02350009
023600                                                                  02360009
023700                                                                  02370009
023800     EXEC CICS                                                    02380009
023900          RETURN                                                  02390009
024000     END-EXEC.                                                    02400009
024100                                                                  02410009
024200 0005-SET-CSSL-SWITCH.                                            02420030
024300     MOVE '0005-CICS-LOGGING'    TO WS003-PARAGRAPH-NAME.         02430008
024400                                                                  02440030
024500* READ PARM TO DETERMINE CICS LOGGING                             02450002
024600                                                                  02460002
024700         EXEC SQL                                                 02470002
024800             SELECT  D.ATTR_ELEM_TXT                              02480002
024900             INTO  :PS-CSSL-LOGGING-SW                            02490002
025000             FROM   WST_INTGRTN_TYP A                             02500002
025100                  , WST_ATTR_DEFN   B                             02510002
025200                  , WST_ATTR_ELEM   C                             02520002
025300                  , WST_ATTR_ELEM   D                             02530002
025400             WHERE  A.INTGRTN_TYP_CDE   = 'CSSLLOG'               02540002
025500               AND  A.INTGRTN_TYP_CDE   = B.INTGRTN_TYP_CDE       02550002
025600               AND  B.ATTR_DEFN_SEQ_NBR = 1                       02560002
025700               AND  B.INTGRTN_TYP_CDE   = C.INTGRTN_TYP_CDE       02570002
025800               AND  C.ATTR_DEFN_SEQ_NBR = 1                       02580002
025900               AND  B.INTGRTN_TYP_CDE   = D.INTGRTN_TYP_CDE       02590002
026000               AND  D.ATTR_DEFN_SEQ_NBR = 2                       02600002
026100               AND  C.ATTR_ELEM_SEQ_NBR = D.ATTR_ELEM_SEQ_NBR     02610002
026200               AND  C.ATTR_ELEM_TXT     = 'WSKCS303'              02620002
026300         END-EXEC                                                 02630002
026400                                                                  02640002
026500         EVALUATE TRUE                                            02650002
026600             WHEN SQLCODE = ZERO                                  02660002
026700                 CONTINUE                                         02670030
026800             WHEN SQLCODE = -904                                  02680002
026900             WHEN SQLCODE = -913                                  02690002
027000             WHEN SQLCODE = -911                                  02700002
027100             WHEN SQLWARN0 NOT = SPACES                           02710002
027200             WHEN SQLCODE NOT = ZERO                              02720002
027300                MOVE  SQLCODE            TO PV-DISPLAY-SQLCODE    02730030
027400                STRING   ' WSKCS303-0005-'                        02740030
027500                         '  SQLCODE='                             02750030
027600                         PV-DISPLAY-SQLCODE                       02760030
027700                         ' '                                      02770030
027800                         DELIMITED BY SIZE                        02780030
027900                                         INTO PV-CICS-MSG-AREA    02790030
028000                SET DP013-NO-ROLLBACK                             02800030
028100                    DP013-DB2-ABEND  TO TRUE                      02810030
028200                PERFORM 9999-WRITE-CICS-LOG-MSG                   02820030
028300         END-EVALUATE.                                            02830002
028400                                                                  02840002
028500******************************************************************02850009
028600*               START NEXT W303 'XX' SECONDS LATER                02860043
028700*=================================================================02870009
028800* DETERMINES WHEN THE NEXT TIME THIS PROCESS IS RUN. 'XX' SECONDS 02880009
028900* IS OBTAINED FROM THE (TKRPRPM) TABLE FOR PARM 'ASNRST'.  IF     02890043
029000* THE SECONDS OBTAINED (PV-RESTART-TIME) IS EQUAL TO 0, THE TRANS 02900009
029100* WILL NOT BE RESTARTED.                                          02910009
029200******************************************************************02920009
029300 0010-GET-RESTART-INFO.                                           02930009
029400                                                                  02940009
029500     IF  PS-CSSL-LOGGING-YES                                      02950009
029600         MOVE '0001-GET-RESTART-INFO '  TO PV-PARA-NAME           02960009
029700         PERFORM 9998-BUILD-MESSAGE                               02970009
029800     END-IF.                                                      02980009
029900                                                                  02990009
030000     PERFORM                                                      03000009
030100            WITH TEST AFTER                                       03010009
030200         VARYING PV-RETRY-COUNTER                                 03020009
030300            FROM 1 BY 1                                           03030009
030400           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                03040009
030500              OR SQLCODE = ZERO                                   03050009
030600              OR SQLCODE = +100                                   03060009
030700                                                                  03070009
030800         EXEC SQL                                                 03080009
030900              SELECT FUNC_QTY                                     03090009
031000                INTO :KRPRPM-FUNC-QTY                             03100009
031100                FROM TKRPRPM                                      03110009
031200               WHERE LOC_ID             =   90                    03120009
031300                 AND INTFC_SYS_CDE      =  'KHL'                  03130009
031400                 AND FUNC_PRC_STAT_CDE  =  'AC'                   03140009
031500                 AND SYS_PRC_FUNC_CDE   =  'DWNRST'               03150009
031600                 AND (CURRENT DATE                                03160009
031700                     BETWEEN DATE(FUNC_BEG_TMST) AND              03170009
031800                             DATE(FUNC_END_TMST))                 03180009
031900         END-EXEC                                                 03190009
032000                                                                  03200009
032100         EVALUATE TRUE                                            03210009
032200            WHEN SQLCODE = ZERO                                   03220009
032300               MOVE  KRPRPM-FUNC-QTY  TO  PV-RESTART-TIME         03230009
032400                                                                  03240009
032500            WHEN SQLCODE = -904                                   03250009
032600            WHEN SQLCODE = -913                                   03260009
032700            WHEN SQLCODE = -911                                   03270009
032800               CONTINUE                                           03280009
032900                                                                  03290009
033000          WHEN OTHER                                              03300009
033100             MOVE '0001-GET-RESTART-INFO'                         03310009
033200                               TO DP013-PARAGRAPH                 03320009
033300             MOVE 'ERROR SELECTING DATA FOR E291 '                03330009
033400                               TO DP013-MESSAGE-TEXT (1)          03340009
033500             MOVE SQLCA        TO DP013-SQLCA                     03350009
033600             MOVE 'TKRPRPM '   TO DP013-DB2-TABLE-NAME (1)        03360009
033700             SET DP013-NO-ROLLBACK                                03370009
033800                 DP013-DB2-ABEND  TO TRUE                         03380009
033900             PERFORM 9999-WRITE-CICS-LOG-MSG                      03390009
034000         END-EVALUATE                                             03400009
034100     END-PERFORM.                                                 03410009
034200                                                                  03420009
034300***************************************************************** 03430013
034400* UNCOMMENT THIS AFTER TESTING IS COMPLETE                        03440013
034500* THIS WILL DETERMINE WHEN THE PROCESS WILL START UP.             03450013
034600***************************************************************** 03460013
034700     IF PV-RESTART-TIME > 0                                       03470050
034800         EXEC CICS                                                03480050
034900             START TRANSID(PC-TRANID-W303)                        03490050
035000                 AFTER SECONDS (PV-RESTART-TIME)                  03500050
035100         END-EXEC.                                                03510050
035200                                                                  03520009
035300******************************************************************03530009
035400* SELECT FROM INTEGRATION THE NUMBER OF SECONDS FOR THE PARM VALUE03540043
035410* 'ASNTRIGGER'.  THIS WILL BE USED IN THE MAIN DRIVER OF THE      03541043
035500* PROGRAM TO SELECT TRIPS THAT HAVE NOT BEEN UPDATED FOR X AMOUNT 03550043
035600* OF TIME.                                                        03560043
035700******************************************************************03570009
035800 0500-MAIN-DRIVER-INFO.                                           03580009
035900                                                                  03590009
036000     IF  PS-CSSL-LOGGING-YES                                      03600009
036100         MOVE '0500-MAIN-DRIVER-INFO '  TO PV-PARA-NAME           03610009
036200         PERFORM 9998-BUILD-MESSAGE                               03620009
036300     END-IF.                                                      03630009
036400                                                                  03640009
036500     PERFORM                                                      03650009
036600            WITH TEST AFTER                                       03660009
036700         VARYING PV-RETRY-COUNTER                                 03670009
036800            FROM 1 BY 1                                           03680009
036900           UNTIL PV-RETRY-COUNTER > PC-MAX-RETRIES                03690009
037000              OR SQLCODE = ZERO                                   03700009
037100              OR SQLCODE = +100                                   03710009
037200                                                                  03720009
037201         EXEC SQL                                                 03720143
037220              SELECT INT(C.ATTR_ELEM_NBR)                         03722043
037221                INTO :PV-UPDATE-TIME                              03722143
037230                FROM WST_INTGRTN_TYP   A                          03723044
037240                   , WST_ATTR_DEFN   B                            03724044
037250                   , WST_ATTR_ELEM   C                            03725044
037260               WHERE A.APPL_FUNC_DESC     =  'ASNTRCKNG'          03726043
037270                 AND A.INTGRTN_TYP_CDE    =  'ASNTRIGGER'         03727043
037271                 AND A.INTGRTN_TYP_CDE    =  B.INTGRTN_TYP_CDE    03727143
037280                 AND B.ATTR_DEFN_SEQ_NBR  =  1                    03728043
037290                 AND B.INTGRTN_TYP_CDE    =  C.INTGRTN_TYP_CDE    03729043
037291                 AND C.ATTR_DEFN_SEQ_NBR  =  1                    03729143
038400         END-EXEC                                                 03840009
038500                                                                  03850009
038600         EVALUATE TRUE                                            03860009
038700            WHEN SQLCODE = ZERO                                   03870009
038710* JAK 08/2007 - CHG LOGIC FOR SQLCODE = ZERO                      03871073
038720******         MOVE  KRPRPM-FUNC-QTY  TO  PV-UPDATE-TIME          03872073
038800               CONTINUE                                           03880073
038900                                                                  03890009
039000            WHEN SQLCODE = -904                                   03900009
039100            WHEN SQLCODE = -913                                   03910009
039200            WHEN SQLCODE = -911                                   03920009
039300               CONTINUE                                           03930009
039400                                                                  03940009
039500          WHEN OTHER                                              03950009
039600             MOVE '0500-MAIN-DRIVER-INFO'                         03960009
039700                               TO DP013-PARAGRAPH                 03970009
039800             MOVE 'ERROR SELECTING SECONDS FOR CSR '              03980043
039900                               TO DP013-MESSAGE-TEXT (1)          03990009
040000             MOVE SQLCA        TO DP013-SQLCA                     04000009
040100             MOVE 'WST_INTGRTN_TYP'                               04010045
040101                               TO DP013-DB2-TABLE-NAME (1)        04010143
040110             MOVE 'WST_ATTR_DEFN'                                 04011043
040111                               TO DP013-DB2-TABLE-NAME (2)        04011143
040120             MOVE 'WST_ATTR_ELEM'                                 04012043
040130                               TO DP013-DB2-TABLE-NAME (3)        04013043
040200             SET DP013-NO-ROLLBACK                                04020009
040300                 DP013-DB2-ABEND  TO TRUE                         04030009
040400             PERFORM 9999-WRITE-CICS-LOG-MSG                      04040009
040500         END-EVALUATE                                             04050009
040600     END-PERFORM.                                                 04060009
040700                                                                  04070009
040800****************************************************************  04080009
040900*  OPEN THE CURSOR TO RETRIEVE WHAT IS READY TO BE DOWNLOADED  *  04090009
041000*  FROM THE CROSS REFERENCE TABLES                             *  04100009
041100****************************************************************  04110009
041200 1000-OPEN-XREF-CSR.                                              04120009
041300                                                                  04130009
041400     IF  PS-CSSL-LOGGING-YES                                      04140009
041500         MOVE '1000-OPEN-XREF-CSR' TO PV-PARA-NAME                04150009
041600         PERFORM 9998-BUILD-MESSAGE                               04160009
041700     END-IF.                                                      04170009
041800                                                                  04180009
041900     EXEC SQL                                                     04190009
042000         OPEN WMS_XREF_CSR                                        04200009
042100     END-EXEC.                                                    04210009
042200                                                                  04220009
042300                                                                  04230009
042400     EVALUATE TRUE                                                04240009
042500         WHEN SQLCODE = ZERO                                      04250009
042600             CONTINUE                                             04260009
042700         WHEN SQLWARN0 NOT = SPACES                               04270009
042800         WHEN SQLCODE < ZERO                                      04280009
042900         WHEN SQLCODE > ZERO                                      04290009
043000             MOVE '1000-OPEN-XREF-CSR'                            04300009
043100                               TO DP013-PARAGRAPH                 04310009
043200             MOVE 'ERROR OPENING SHIPMENT XREF CURSOR'            04320009
043300                               TO DP013-MESSAGE-TEXT (1)          04330009
043400             MOVE SQLCA        TO DP013-SQLCA                     04340009
043500             MOVE 'WST00001'   TO DP013-DB2-TABLE-NAME (1)        04350009
043600             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (2)        04360009
043700             SET DP013-NO-ROLLBACK                                04370009
043800                 DP013-DB2-ABEND                                  04380009
043900                               TO TRUE                            04390009
044000             PERFORM 9999-WRITE-CICS-LOG-MSG                      04400009
044100     END-EVALUATE.                                                04410009
044200/                                                                 04420009
044300****************************************************************  04430009
044400*  RETRIEVE A ROW FROM THE SHIPMENT XREF CURSOR.               *  04440009
044500****************************************************************  04450009
044600 1100-READ-XREF-ROW.                                              04460009
044700                                                                  04470009
044800     IF  PS-CSSL-LOGGING-YES                                      04480009
044900         MOVE '1100-READ-XREF-ROW' TO PV-PARA-NAME                04490009
045000         PERFORM 9998-BUILD-MESSAGE                               04500009
045100     END-IF.                                                      04510009
045200                                                                  04520009
045300     INITIALIZE DCLWST00001                                       04530009
045400                                                                  04540009
045500     EXEC SQL                                                     04550009
045600          FETCH WMS_XREF_CSR                                      04560009
045700          INTO  :WST00001-INTR-TRIP-ID                            04570009
045800              , :WST00001-EXT-SHP-ID                              04580009
045900              , :WST00001-DWNLD-TMST                              04590009
045910              , :WST00001-RCPT-TMST                               04591046
046000              , :WST00001-DEST-LOC-NBR                            04600035
046010              , :WST00001-SOR-CDE                                 04601041
046020              , :WST00001-DWNLD-CDE                               04602079
046100     END-EXEC.                                                    04610035
046200                                                                  04620035
046300     EVALUATE TRUE                                                04630035
046400         WHEN SQLCODE = ZERO                                      04640035
046500             MOVE WST00001-INTR-TRIP-ID   TO DK-TRIP-ID           04650035
046600             MOVE WST00001-EXT-SHP-ID     TO DK-SHIP-ID           04660035
046700         WHEN SQLCODE = +100                                      04670035
046800             SET PS-END-OF-CSR TO TRUE                            04680035
046900         WHEN SQLWARN0 NOT = SPACES                               04690035
047000         WHEN SQLCODE < ZERO                                      04700035
047100         WHEN SQLCODE > ZERO                                      04710035
047200             MOVE '1100-READ-XREF-ROW'                            04720035
047300                               TO DP013-PARAGRAPH                 04730035
047400             MOVE 'ERROR SELECTING DATA FROM XREF CURSOR'         04740035
047500                               TO DP013-MESSAGE-TEXT (1)          04750035
047600             MOVE SQLCA        TO DP013-SQLCA                     04760035
047700             MOVE 'WST00001'   TO DP013-DB2-TABLE-NAME (1)        04770035
047800             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (2)        04780035
047900             SET DP013-ROLLBACK                                   04790035
048000                 DP013-DB2-ABEND                                  04800035
048100                               TO TRUE                            04810009
048200             PERFORM 9999-WRITE-CICS-LOG-MSG                      04820009
048300     END-EVALUATE.                                                04830009
048400/                                                                 04840009
048500****************************************************************  04850009
048600*  CLOSE THE CURSOR                                            *  04860009
048700****************************************************************  04870009
048800 1200-CLOSE-XREF-CSR.                                             04880009
048900                                                                  04890009
049000     IF  PS-CSSL-LOGGING-YES                                      04900009
049100         MOVE '1200-CLOSE-XREF-CSR'  TO PV-PARA-NAME              04910009
049200         PERFORM 9998-BUILD-MESSAGE                               04920009
049300     END-IF.                                                      04930009
049400                                                                  04940009
049500     EXEC SQL                                                     04950009
049600         CLOSE WMS_XREF_CSR                                       04960009
049700     END-EXEC.                                                    04970009
049800                                                                  04980009
049900     EVALUATE TRUE                                                04990009
050000         WHEN SQLCODE = ZERO                                      05000009
050100             CONTINUE                                             05010009
050200         WHEN SQLWARN0 NOT = SPACES                               05020009
050300         WHEN SQLCODE < ZERO                                      05030009
050400         WHEN SQLCODE > ZERO                                      05040009
050500             MOVE '1200-CLOSE-XREF-CSR'                           05050009
050600                               TO DP013-PARAGRAPH                 05060009
050700             MOVE 'ERROR CLOSING XREF CURSOR'                     05070009
050800                               TO DP013-MESSAGE-TEXT (1)          05080009
050900             MOVE SQLCA        TO DP013-SQLCA                     05090009
051000             MOVE 'WST00001'   TO DP013-DB2-TABLE-NAME (1)        05100009
051100             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (2)        05110009
051200             SET DP013-NO-ROLLBACK                                05120009
051300                 DP013-DB2-ABEND                                  05130009
051400                               TO TRUE                            05140009
051500             PERFORM 9999-WRITE-CICS-LOG-MSG                      05150009
051600     END-EVALUATE.                                                05160009
051700/                                                                 05170009
051800******************************************************************05180009
051900*  FOR EACH ROW RETURNED FROM THE SHIPMENT CROSS REFERENCE TABLE *05190009
052000*  CURSOR CALL THE VENDOR ASN DOWNLOAD MODULE WSKCS301           *05200047
052100******************************************************************05210009
052200 2000-PROCESS.                                                    05220009
052300                                                                  05230009
052400     IF  PS-CSSL-LOGGING-YES                                      05240009
052500         MOVE '2000-PROCESS  ' TO PV-PARA-NAME                    05250009
052600         PERFORM 9998-BUILD-MESSAGE                               05260009
052700     END-IF.                                                      05270009
052800                                                                  05280009
052824     IF  WST00001-SOR-CDE  = 'SH'                                 05282441
052825* DMH - 07/27/27 BEGIN                                            05282585
052826         MOVE WST00001-INTR-TRIP-ID  TO WS004-OTBND-TRIP-ID       05282685
052827         MOVE WST00001-DEST-LOC-NBR  TO WS004-OPER-UNT-ID         05282788
052828* DMH - 07/27/27 BEGIN                                            05282888
052829         MOVE '2600-CALL-WSKCS304'   TO PV-PARA-NAME              05282988
052830         PERFORM 9998-BUILD-MESSAGE                               05283088
052840         PERFORM 2600-CALL-WSKCS304                               05284088
052901     ELSE                                                         05290141
052902* JAK 07/2007 ADD ADDITIONAL LOGIC                                05290259
052903         IF WST00001-DWNLD-CDE = 'P'                              05290359
052904             SET PS-CALL-ASN-NO    TO TRUE                        05290459
052905             PERFORM 3000-CHECK-FOR-NEW-DTLS                      05290559
052906             IF PS-CALL-ASN-NO                                    05290659
052907                 PERFORM 3010-CHECK-TRBL-RESOLVED                 05290759
052908             END-IF                                               05290859
052909             IF PS-CALL-ASN-YES                                   05290959
052910                IF WST00001-RCPT-TMST = PC-DEFAULT-DATE-1         05291059
052911                    MOVE '2500-CALL-WSKCS301'   TO PV-PARA-NAME   05291159
052912                    PERFORM 9998-BUILD-MESSAGE                    05291259
052913                    PERFORM 2500-CALL-WSKCS301                    05291359
052914                ELSE                                              05291459
052915                    MOVE '2550-CALL-WSKCS305'   TO PV-PARA-NAME   05291559
052916                    PERFORM 9998-BUILD-MESSAGE                    05291659
052917                    PERFORM 2550-CALL-WSKCS305                    05291759
052918                END-IF                                            05291859
052919             END-IF                                               05291959
052920         ELSE                                                     05292059
052921* JAK 07/2007 END NEW LOGIC                                       05292159
052922             IF WST00001-RCPT-TMST = PC-DEFAULT-DATE-1            05292259
052923                MOVE '2500-CALL-WSKCS301'   TO PV-PARA-NAME       05292359
052924                PERFORM 9998-BUILD-MESSAGE                        05292459
052925                PERFORM 2500-CALL-WSKCS301                        05292559
052926             ELSE                                                 05292659
052927                MOVE '2550-CALL-WSKCS305'   TO PV-PARA-NAME       05292759
052928                PERFORM 9998-BUILD-MESSAGE                        05292859
052929                PERFORM 2550-CALL-WSKCS305                        05292959
052930             END-IF                                               05293059
052931         END-IF                                                   05293159
052940     END-IF.                                                      05294059
053000                                                                  05300009
053100     PERFORM 1100-READ-XREF-ROW.                                  05310009
053200                                                                  05320009
053300******************************************************************05330009
053400*  CALL VENDOR ASN DOWNLOAD MODULE (WSKCS301)                    *05340047
053500******************************************************************05350009
053600 2500-CALL-WSKCS301.                                              05360047
053720                                                                  05372053
053800     IF  PS-CSSL-LOGGING-YES                                      05380009
053900         MOVE WST00001-INTR-TRIP-ID TO PV-DISPLAY-TRIP-ID         05390030
054000         STRING   ' WSKCS301-2500:'                               05400030
054100                  ' EXT SHP ID: '                                 05410030
054200                  WST00001-EXT-SHP-ID                             05420030
054300                  ' TRIP ID: '                                    05430030
054400                  PV-DISPLAY-TRIP-ID                              05440030
054500                  DELIMITED BY SIZE                               05450030
054600                  INTO PV-CICS-MSG-AREA                           05460030
054700         MOVE '2500-CALL-WSKCS301 ' TO PV-PARA-NAME               05470047
054800         PERFORM 9998-BUILD-MESSAGE                               05480009
054900     END-IF.                                                      05490009
055000                                                                  05500009
055100     INITIALIZE WS003-SHIPT-COMMAREA.                             05510030
055200                                                                  05520030
055300     MOVE PC-CURRENT-PGM-NAME      TO WS003-CALLING-PROGRAM-NAME. 05530011
055400     MOVE WST00001-INTR-TRIP-ID    TO WS003-TRIP-ID.              05540011
055500     MOVE WST00001-EXT-SHP-ID      TO WS003-WM-SHIPT-NBR.         05550011
055600     MOVE 'SWEEPER'                TO WS003-CALLING-PROGRAM-NAME. 05560011
055700     MOVE WST00001-DEST-LOC-NBR    TO WS003-OPER-UNT-ID.          05570035
055800     MOVE 'SWEEPER'                TO WS003-USERID.               05580035
055900     MOVE PV-TASK                  TO WS003-SRC-TASK-NUMBER.      05590035
056000                                                                  05600034
056100     IF WST00001-DWNLD-TMST = PC-DEFAULT-TMST                     05610030
056200        SET WS003-APPOINTMENT-YES TO TRUE                         05620030
056300     ELSE                                                         05630030
056400        SET WS003-APPOINTMENT-NO TO TRUE                          05640030
056500     END-IF.                                                      05650030
056600                                                                  05660009
056700     EXEC CICS                                                    05670073
056800          START TRANSID ('W301')                                  05680073
056900               FROM (WS003-SHIPT-COMMAREA)                        05690073
057000     END-EXEC.                                                    05700073
057100                                                                  05710030
057200* JAK 08/2007 - REMOVED CODE THAT WAS CALLING WSKCS301 AND        05720074
057300*               CHECKING FOR A RETURN CODE                        05730073
060800                                                                  06080009
060801******************************************************************06080146
060802*  LINK TO THE WMS ASN CONTROL MODULE (WSKCS305)                 *06080246
060803******************************************************************06080346
060804 2550-CALL-WSKCS305.                                              06080448
060805                                                                  06080546
060808     INITIALIZE WS001-FIELDS.                                     06080846
060809                                                                  06080946
060810     SET WS001-CREATE-DUMMY           TO TRUE.                    06081046
060811     MOVE WST00001-EXT-SHP-ID         TO WS001-EXT-SHP-ID.        06081146
060812     MOVE WST00001-INTR-TRIP-ID       TO WS001-TRIP-ID.           06081258
060813     MOVE +0                          TO WS001-KOHLS-SHIPT-ID.    06081346
060814     MOVE +0                          TO WS001-OPER-UNT-ID.       06081446
060815     SET WS001-SOURCE-RCVNG           TO TRUE.                    06081546
060816     MOVE 'SWEEPER'                   TO WS001-USER-ID.           06081647
060817     MOVE PV-TASK                     TO WS001-SRC-TASK-NUMBER.   06081747
060818     MOVE +0                          TO WS001-PO-LNE-NBR.        06081846
060819     MOVE +0                          TO WS001-PREPK-ID.          06081946
060820     MOVE  0                          TO WS001-SKU-NBR.           06082046
060821     MOVE  SPACE                      TO WS001-DTL-ASN-LEVEL-IND. 06082146
060822     MOVE PC-CURRENT-PGM-NAME                                     06082247
060823                                  TO WS001-CALLING-PROGRAM-NAME.  06082346
060824                                                                  06082446
060825     MOVE LENGTH OF WS001-FIELDS  TO  PV-COMMAREA-LENGTH.         06082546
060826                                                                  06082646
060827     EXEC CICS                                                    06082746
060828         LINK PROGRAM  (PC-WMS-CONTROL-MOD)                       06082846
060829              COMMAREA (WS001-FIELDS)                             06082946
060830              LENGTH   (PV-COMMAREA-LENGTH)                       06083046
060831     END-EXEC.                                                    06083146
060832                                                                  06083246
060833     EVALUATE TRUE                                                06083346
060834         WHEN WS001-SUCCESSFUL                                    06083446
060835              CONTINUE                                            06083546
060836         WHEN WS001-DATABASE-BUSY OR                              06083646
060837              WS001-INVALID-SQL                                   06083746
060842              INITIALIZE PV-CICS-MSG-AREA                         06084246
060843              STRING 'WSKCS303-'                                  06084346
060844                     'PC-WMS-CONTROL-MOD - '                      06084446
060845                                           DELIMITED BY SIZE      06084546
060846                                      INTO PV-CICS-MSG-AREA       06084646
060847              PERFORM 9997-WRITE-TO-CSSL                          06084746
060849                                                                  06084946
060850              INITIALIZE PV-CICS-MSG-AREA                         06085046
060851              STRING 'WSKCS303-'                                  06085146
060852                     WS001-CRA-RET-MSG                            06085246
060853                                           DELIMITED BY SIZE      06085346
060854                                      INTO PV-CICS-MSG-AREA       06085446
060855              PERFORM 9997-WRITE-TO-CSSL                          06085546
060857         WHEN WS001-ERROR                                         06085746
060863              INITIALIZE PV-CICS-MSG-AREA                         06086346
060864              STRING 'WSKCS303-'                                  06086446
060865                     'PC-WMS-CONTROL-MOD - '                      06086546
060866                                           DELIMITED BY SIZE      06086646
060867                                      INTO PV-CICS-MSG-AREA       06086746
060868              PERFORM 9997-WRITE-TO-CSSL                          06086846
060870                                                                  06087046
060871              INITIALIZE PV-CICS-MSG-AREA                         06087146
060872              STRING 'WSKCS303-'                                  06087246
060873                     WS001-CRA-RET-MSG                            06087346
060874                                           DELIMITED BY SIZE      06087446
060875                                      INTO PV-CICS-MSG-AREA       06087546
060876              PERFORM 9997-WRITE-TO-CSSL                          06087646
060878                                                                  06087846
060879         WHEN OTHER                                               06087946
060880                                                                  06088046
060881              INITIALIZE PV-CICS-MSG-AREA                         06088146
060882              STRING 'WSKCS303-'                                  06088246
060883                     'PC-WMS-CONTROL-MOD - '                      06088346
060884                                           DELIMITED BY SIZE      06088446
060885                                      INTO PV-CICS-MSG-AREA       06088546
060886              PERFORM 9997-WRITE-TO-CSSL                          06088646
060888                                                                  06088846
060889              INITIALIZE PV-CICS-MSG-AREA                         06088946
060890              STRING 'WSKCS303-'                                  06089046
060891                     WS001-CRA-RET-MSG                            06089146
060892                                           DELIMITED BY SIZE      06089246
060893                                      INTO PV-CICS-MSG-AREA       06089346
060894              PERFORM 9997-WRITE-TO-CSSL                          06089446
060896                                                                  06089646
060897             MOVE 'PC-WMS-CONTROL-MOD' TO DP013-PARAGRAPH         06089746
060898             MOVE 'UNSUCCESSFUL CALL TO WMS  MOD'                 06089846
060899                                         TO DP013-MESSAGE-TEXT (1)06089946
060900             MOVE WS001-SUCCESS-IND      TO DP013-MESSAGE-TEXT (2)06090046
060901             PERFORM 9997-WRITE-TO-CSSL                           06090146
060903             SET DP013-NO-ROLLBACK                                06090346
060904                 DP013-DB2-ABEND  TO TRUE                         06090446
060906             PERFORM 9999-WRITE-CICS-LOG-MSG                      06090646
060907                                                                  06090746
060908     END-EVALUATE.                                                06090846
060909******************************************************************06090941
060910*  CALL SHIP ASN DOWNLOAD MODULE (WSKCS304)                       06091041
060911******************************************************************06091141
060912 2600-CALL-WSKCS304.                                              06091255
060913                                                                  06091341
060916     MOVE WST00001-EXT-SHP-ID    TO WS004-WMS-SHPT-ID.            06091653
060917     MOVE 'WSKCS303'             TO WS004-CALLING-PROGRAM-NAME.   06091753
060918     MOVE PV-TASK                TO WS004-SRC-TASK-NUMBER.        06091853
060919                                                                  06091953
060920                                                                  06092053
060921* THIS IS A STARTED TASK - IT WILL NOT RETURN BACK TO HERE        06092153
060922* TRANID IS W304 - IT EXECUTES WSKCS304                           06092253
060923                                                                  06092353
060924     EXEC CICS                                                    06092453
060925          START TRANSID (PC-SHIP-ASN-MOD-TRAN)                    06092553
060926                FROM (WS004-FIELDS)                               06092653
060930     END-EXEC.                                                    06093041
060960/                                                                 06096041
061000******************************************************************06100041
061060 2002-GET-TIMESTAMP.                                              06106041
061100                                                                  06110009
061200      EXEC SQL                                                    06120009
061300         SELECT CURRENT TIMESTAMP                                 06130009
061400         INTO  :PV-CURRENT-TIMESTAMP                              06140009
061500         FROM  TKRPRPM                                            06150009
061600      END-EXEC.                                                   06160009
061700                                                                  06170009
061800      EVALUATE TRUE                                               06180009
061900       WHEN SQLCODE = ZERO                                        06190009
062000       WHEN SQLCODE = -811                                        06200009
062100          CONTINUE                                                06210009
062200       WHEN OTHER                                                 06220009
062300          MOVE '2001-GET-TIMESTAMP           '                    06230009
062400                          TO DP013-PARAGRAPH                      06240009
062500          MOVE 'ERROR SELECTING CURR TIMESTAMP'                   06250009
062600                          TO DP013-MESSAGE-TEXT (1)               06260009
062700          MOVE SQLCA      TO DP013-SQLCA                          06270009
062800          MOVE 'TKRPRPM '   TO DP013-DB2-TABLE-NAME (1)           06280009
062900          SET DP013-NO-ROLLBACK                                   06290009
063000              DP013-DB2-ABEND  TO TRUE                            06300009
063100          PERFORM 9999-WRITE-CICS-LOG-MSG                         06310009
063200      END-EVALUATE.                                               06320009
063300                                                                  06330009
063400 9000-SYNCPOINT.                                                  06340009
063500                                                                  06350009
063600     IF  PS-CSSL-LOGGING-YES                                      06360009
063700         MOVE '9000-SYNCPOINT             ' TO PV-PARA-NAME       06370009
063800         PERFORM 9998-BUILD-MESSAGE                               06380009
063900     END-IF.                                                      06390009
064000                                                                  06400009
064100     EXEC CICS                                                    06410009
064200         SYNCPOINT                                                06420009
064300     END-EXEC.                                                    06430009
064400/                                                                 06440009
064401* JAK 07/2007 - ADD NEW PARAGRAPHS                                06440160
064410****************************************************************  06441059
064420*  CHECK TO SEE IF THERE ARE ANY NEW DETAIL ROWS ON THE        *  06442059
064421*  SHIPMENT THAT NEED TO BE DOWNLOADED.                        *  06442159
064430****************************************************************  06443059
064440 3000-CHECK-FOR-NEW-DTLS.                                         06444059
064450                                                                  06445059
064460     IF  PS-CSSL-LOGGING-YES                                      06446059
064470         MOVE '3000-CHECK-FOR-NEW-DTLS' TO PV-PARA-NAME           06447059
064480         PERFORM 9998-BUILD-MESSAGE                               06448059
064490     END-IF.                                                      06449059
064491                                                                  06449159
064494     EXEC SQL                                                     06449459
064495          SELECT COUNT(*)                                         06449559
064497          INTO  :PV-SQL-COUNT                                     06449760
064498          FROM   WST_SHPMT_XREF_DTL                               06449860
064499          WHERE  EXT_SHP_ID    = :DK-SHIP-ID                      06449962
064500          AND    DWNLD_CDE     = 'N'                              06450060
064503     END-EXEC.                                                    06450359
064504                                                                  06450459
064505     EVALUATE TRUE                                                06450559
064506         WHEN SQLCODE = ZERO                                      06450659
064507** SLH 12/07                                                      06450784
064508             IF PV-SQL-COUNT > 0                                  06450882
064509                SET PS-CALL-ASN-YES     TO TRUE                   06450982
064510             END-IF                                               06451082
064511         WHEN SQLCODE = +100                                      06451160
064512             CONTINUE                                             06451260
064513         WHEN SQLWARN0 NOT = SPACES                               06451360
064514         WHEN SQLCODE < ZERO                                      06451460
064515         WHEN SQLCODE > ZERO                                      06451560
064516             MOVE '3000-CHECK-FOR-NEW-DTLS'                       06451660
064517                               TO DP013-PARAGRAPH                 06451760
064518             MOVE 'ERROR SELECTING DATA FROM XREF DTL'            06451860
064519                               TO DP013-MESSAGE-TEXT (1)          06451960
064520             MOVE SQLCA        TO DP013-SQLCA                     06452060
064521             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (1)        06452160
064522             SET DP013-ROLLBACK                                   06452260
064523                 DP013-DB2-ABEND                                  06452360
064524                               TO TRUE                            06452460
064525             PERFORM 9999-WRITE-CICS-LOG-MSG                      06452560
064526     END-EVALUATE.                                                06452660
064527/                                                                 06452760
064528****************************************************************  06452860
064529*  CHECK TO SEE IF ANY OF THE DETAIL ROWS WERE IN TROUBLE      *  06452960
064530*  BUT HAVE NOW BEEN RESOLVED.                                 *  06453060
064531****************************************************************  06453160
064532 3010-CHECK-TRBL-RESOLVED.                                        06453260
064533                                                                  06453360
064534     PERFORM 3020-OPEN-TRBL-CSR.                                  06453460
064536     PERFORM 3030-READ-TRBL-CSR                                   06453660
064539         UNTIL PS-END-OF-TRBL-CSR                                 06453960
064540         OR    PS-CALL-ASN-YES.                                   06454060
064541     PERFORM 3040-CLOSE-TRBL-CSR.                                 06454160
064542                                                                  06454260
064543****************************************************************  06454360
064544*  OPEN THE CURSOR TO FETCH THE DETAIL ROWS THAT ARE IN TROUBLE*  06454460
064546****************************************************************  06454660
064547 3020-OPEN-TRBL-CSR.                                              06454760
064549                                                                  06454960
064550     IF  PS-CSSL-LOGGING-YES                                      06455060
064551         MOVE '3020-OPEN-TRBL-CSR' TO PV-PARA-NAME                06455160
064552         PERFORM 9998-BUILD-MESSAGE                               06455260
064553     END-IF.                                                      06455360
064554                                                                  06455460
064555     EXEC SQL                                                     06455560
064556         OPEN TRBL_CSR                                            06455660
064557     END-EXEC.                                                    06455760
064559                                                                  06455960
064560     EVALUATE TRUE                                                06456060
064561         WHEN SQLCODE = ZERO                                      06456160
064562             CONTINUE                                             06456260
064563         WHEN SQLWARN0 NOT = SPACES                               06456360
064564         WHEN SQLCODE < ZERO                                      06456460
064565         WHEN SQLCODE > ZERO                                      06456560
064566             MOVE '3020-OPEN-TRBL-CSR'                            06456660
064567                               TO DP013-PARAGRAPH                 06456760
064568             MOVE 'ERROR OPENING XREF DTL TRBL CURSOR'            06456860
064569                               TO DP013-MESSAGE-TEXT (1)          06456960
064570             MOVE SQLCA        TO DP013-SQLCA                     06457060
064571             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (1)        06457160
064572             SET DP013-NO-ROLLBACK                                06457260
064573                 DP013-DB2-ABEND                                  06457360
064574                               TO TRUE                            06457460
064575             PERFORM 9999-WRITE-CICS-LOG-MSG                      06457560
064576     END-EVALUATE.                                                06457660
064577/                                                                 06457760
064578****************************************************************  06457860
064579*  RETRIEVE A ROW FROM THE TROUBLE CURSOR.                     *  06457960
064580****************************************************************  06458060
064581 3030-READ-TRBL-CSR.                                              06458160
064583                                                                  06458360
064584     IF  PS-CSSL-LOGGING-YES                                      06458460
064585         MOVE '3030-READ-TRBL-CSR' TO PV-PARA-NAME                06458560
064586         PERFORM 9998-BUILD-MESSAGE                               06458660
064587     END-IF.                                                      06458760
064588                                                                  06458860
064591     EXEC SQL                                                     06459160
064592          FETCH TRBL_CSR                                          06459260
064593          INTO  :WST00002-PO-NBR                                  06459360
064594              , :WST00002-RCVR-SEQ-NBR                            06459460
064599     END-EXEC.                                                    06459960
064600                                                                  06460060
064601     EVALUATE TRUE                                                06460160
064602         WHEN SQLCODE = ZERO                                      06460260
064603             PERFORM 3100-CHECK-FOR-TROUBLE                       06460360
064605         WHEN SQLCODE = +100                                      06460560
064606             SET PS-END-OF-TRBL-CSR TO TRUE                       06460660
064607         WHEN SQLWARN0 NOT = SPACES                               06460760
064608         WHEN SQLCODE < ZERO                                      06460860
064609         WHEN SQLCODE > ZERO                                      06460960
064610             MOVE '3030-READ-TRBL-CSR'                            06461060
064611                               TO DP013-PARAGRAPH                 06461160
064612             MOVE 'ERROR SELECTING DATA FROM TRBL CURSOR'         06461260
064613                               TO DP013-MESSAGE-TEXT (1)          06461360
064614             MOVE SQLCA        TO DP013-SQLCA                     06461460
064615             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (1)        06461560
064617             SET DP013-ROLLBACK                                   06461760
064618                 DP013-DB2-ABEND                                  06461860
064619                               TO TRUE                            06461960
064620             PERFORM 9999-WRITE-CICS-LOG-MSG                      06462060
064621     END-EVALUATE.                                                06462160
064622/                                                                 06462260
064623****************************************************************  06462360
064624*  CLOSE THE CURSOR                                            *  06462460
064625****************************************************************  06462560
064626 3040-CLOSE-TRBL-CSR.                                             06462660
064627                                                                  06462760
064628     IF  PS-CSSL-LOGGING-YES                                      06462860
064629         MOVE '3040-CLOSE-TRBL-CSR'  TO PV-PARA-NAME              06462960
064630         PERFORM 9998-BUILD-MESSAGE                               06463060
064631     END-IF.                                                      06463160
064632                                                                  06463260
064633     EXEC SQL                                                     06463360
064634         CLOSE TRBL_CSR                                           06463460
064635     END-EXEC.                                                    06463560
064636                                                                  06463660
064637     EVALUATE TRUE                                                06463760
064638         WHEN SQLCODE = ZERO                                      06463860
064639             CONTINUE                                             06463960
064640         WHEN SQLWARN0 NOT = SPACES                               06464060
064641         WHEN SQLCODE < ZERO                                      06464160
064642         WHEN SQLCODE > ZERO                                      06464260
064643             MOVE '3040-CLOSE-TRBL-CSR'                           06464360
064644                               TO DP013-PARAGRAPH                 06464460
064645             MOVE 'ERROR CLOSING TRBL CURSOR'                     06464560
064646                               TO DP013-MESSAGE-TEXT (1)          06464660
064647             MOVE SQLCA        TO DP013-SQLCA                     06464760
064648             MOVE 'WST00002'   TO DP013-DB2-TABLE-NAME (1)        06464860
064650             SET DP013-NO-ROLLBACK                                06465060
064651                 DP013-DB2-ABEND                                  06465160
064652                               TO TRUE                            06465260
064653             PERFORM 9999-WRITE-CICS-LOG-MSG                      06465360
064654     END-EVALUATE.                                                06465460
064655/                                                                 06465560
064656******************************************************************06465660
064657** CHECK FOR TROUBLE AT ANY LEVEL - RCVR, PK OR LN LEVEL        **06465760
064658** IF COUNT IS ZERO, THEN THE TROUBLE HAS BEEN RESOLVED.        **06465860
064659******************************************************************06465960
064660 3100-CHECK-FOR-TROUBLE.                                          06466060
064661                                                                  06466160
064662     IF  PS-CSSL-LOGGING-YES                                      06466260
064663         MOVE '3100-CHECK-FOR-TROUBLE'  TO PV-PARA-NAME           06466360
064664         PERFORM 9998-BUILD-MESSAGE                               06466460
064665     END-IF.                                                      06466560
064666                                                                  06466660
064667     MOVE 0                   TO PV-TROUBLE-COUNT.                06466760
064668                                                                  06466860
064669     EXEC SQL                                                     06466960
064670        SELECT COUNT(*)                                           06467060
064671          INTO :PV-TROUBLE-COUNT                                  06467160
064672          FROM TTRBNTF A                                          06467260
064673              ,TTRBRSN C                                          06467360
064674         WHERE A.PO_NBR       =  :WST00002-PO-NBR                 06467460
064675           AND A.REC_SEQ_NBR  =  :WST00002-RCVR-SEQ-NBR           06467560
064676           AND A.RESOLVED_IND IN ('N','I','R')                    06467660
064677           AND A.TRBL_RSN_CDE = C.TRBL_RSN_CDE                    06467760
064678           AND C.NOTIF_IND    =  'T'                              06467860
064679           AND NOT EXISTS                                         06467960
064680              ( SELECT *                                          06468060
064681                FROM  TTRBRCN B                                   06468160
064682                WHERE B.RPT_PGM_NM  = :PC-ASN-DOWNLOAD-MOD        06468260
064683                  AND A.TRBL_RSN_CDE  =  B.TRBL_RSN_CDE )         06468360
064684     END-EXEC.                                                    06468460
064685                                                                  06468560
064686     EVALUATE TRUE                                                06468660
064687         WHEN SQLCODE = +100                                      06468760
064688         WHEN SQLCODE = -305                                      06468862
064689              SET PS-CALL-ASN-YES      TO TRUE                    06468962
064690         WHEN SQLCODE = ZERO                                      06469062
064691              IF PV-TROUBLE-COUNT = 0                             06469160
064692                 SET PS-CALL-ASN-YES      TO TRUE                 06469260
064693              END-IF                                              06469360
064694         WHEN SQLWARN0 NOT = SPACES                               06469460
064695         WHEN SQLCODE NOT = ZERO                                  06469560
064697         WHEN SQLCODE NOT = -811                                  06469760
064698             MOVE '3100-CHECK-FOR-TROUBLE'                        06469860
064699                               TO DP013-PARAGRAPH                 06469960
064700             MOVE 'ERROR READING TRBL TABLES'                     06470060
064701                               TO DP013-MESSAGE-TEXT (1)          06470160
064702             MOVE SQLCA        TO DP013-SQLCA                     06470260
064703             MOVE 'TTRBNTF'    TO DP013-DB2-TABLE-NAME (1)        06470360
064704             MOVE 'TTRBRSN'    TO DP013-DB2-TABLE-NAME (2)        06470460
064705             MOVE 'TTRBRCN'    TO DP013-DB2-TABLE-NAME (3)        06470560
064706             SET DP013-NO-ROLLBACK                                06470660
064707                 DP013-DB2-ABEND                                  06470760
064708                               TO TRUE                            06470860
064709             PERFORM 9999-WRITE-CICS-LOG-MSG                      06470960
064746     END-EVALUATE.                                                06474660
064747                                                                  06474760
064748* JAK 07/2007 - END NEW PARAGRAPHS                                06474860
064749                                                                  06474960
064750******************************************************************06475060
064751*    WRITE A MESSAGE TO THE CICS LOG.                            *06475160
064760******************************************************************06476060
064800 9900-WRITE-CICS.                                                 06480009
064900     MOVE LENGTH OF PV-CICS-MSG-AREA  TO PV-COMMAREA-LENGTH.      06490009
065000                                                                  06500009
065100     EXEC CICS                                                    06510009
065200         WRITEQ TD                                                06520009
065300         QUEUE ('CSSL')                                           06530009
065400         FROM (PV-CICS-MSG-AREA)                                  06540009
065500         LENGTH (PV-COMMAREA-LENGTH)                              06550009
065600         RESP (PV-CICS-RESPONSE)                                  06560009
065700     END-EXEC.                                                    06570009
065800                                                                  06580009
065900     MOVE SPACES TO PV-CICS-MSG-AREA.                             06590009
066000                                                                  06600009
066100******************************************************************06610009
066200*    WRITE A MESSAGE TO THE CICS LOG.                            *06620009
066300******************************************************************06630009
066400 9990-WRITE-CICS.                                                 06640009
066500     MOVE 120 TO PV-WRITE-LENGTH.                                 06650009
066600                                                                  06660009
066700     EXEC CICS WRITEQ TD QUEUE('CSMT') FROM(PV-CICS-MSG-AREA)     06670009
066800          LENGTH(PV-WRITE-LENGTH) NOHANDLE                        06680009
066900     END-EXEC.                                                    06690009
067000                                                                  06700009
067100     MOVE SPACES TO PV-CICS-MSG-AREA.                             06710009
067200                                                                  06720009
067300******************************************************************06730009
067400*    WRITE A MESSAGE TO THE CICS LOG - FOR LOGGING               *06740009
067500******************************************************************06750009
067600 9997-WRITE-TO-CSSL.                                              06760009
067700                                                                  06770009
067800     MOVE LENGTH OF PV-CICS-MSG-AREA  TO PV-COMMAREA-LENGTH.      06780009
067900                                                                  06790009
068000     EXEC CICS                                                    06800009
068100          WRITEQ TD                                               06810009
068200           QUEUE   ('CSSL')                                       06820009
068300            FROM   (PV-CICS-MSG-AREA)                             06830009
068400          LENGTH   (PV-COMMAREA-LENGTH)                           06840009
068500            RESP   (PV-CICS-RESPONSE)                             06850009
068600     END-EXEC.                                                    06860009
068700                                                                  06870009
068800                                                                  06880009
068900 9998-BUILD-MESSAGE.                                              06890009
069000      MOVE WST00001-INTR-TRIP-ID   TO PV-DISP-TRIP.               06900012
069100      MOVE WST00001-EXT-SHP-ID     TO PV-DISP-SHIPT-ID.           06910012
069200      STRING   ' WSKCS303 '                                       06920009
069300               PV-PARA-NAME                                       06930009
069400               'TRIP = '                                          06940012
069500               PV-DISP-TRIP '-'                                   06950012
069600               PV-DISP-SHIPT-ID '-'                               06960012
069700               DELIMITED BY SIZE                                  06970009
069800                               INTO PV-CICS-MSG-AREA.             06980009
069900      PERFORM 9997-WRITE-TO-CSSL.                                 06990009
070000                                                                  07000009
070100************************************************************      07010009
070200*  WRITE ALL OF THE CICS ABEND INFORMATION TO THE CICS LOG *      07020009
070300*  AND RETURN CONTROL TO CICS.                             *      07030009
070400************************************************************      07040009
070500 9999-WRITE-CICS-LOG-MSG.                                         07050009
070600     MOVE PC-CURRENT-PGM-NAME  TO  DP013-PROGRAM.                 07060009
070700     MOVE DFHEIBLK             TO  DP013-DFHEIBLK.                07070009
070800                                                                  07080009
070900     INITIALIZE DP013-SRC-TASK-NUMBER                             07090009
071000                DP013-STACK.                                      07100009
071100     SET DP013-LINK-RETURN     TO TRUE.                           07110009
071200                                                                  07120009
071300     EXEC CICS                                                    07130009
071400         LINK                                                     07140009
071500             PROGRAM   (DP013-NAME)                               07150009
071600             COMMAREA  (DP013-PARAMETERS)                         07160009
071700             LENGTH    (DP013-LENGTH)                             07170009
071800     END-EXEC.                                                    07180009
071900                                                                  07190009
072000     EXEC CICS                                                    07200009
072100         RETURN                                                   07210009
072200     END-EXEC.                                                    07220009
072300*                                                                 07230009
