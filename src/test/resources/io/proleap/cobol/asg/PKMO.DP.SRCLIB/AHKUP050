000300 IDENTIFICATION DIVISION.                                         00030001
000400 PROGRAM-ID.         AHKUP050.                                    00040001
000500 AUTHOR.             PATRICK BURKE.                               00050001
000600 DATE-WRITTEN.       MAY 2000.                                    00060001
000700 DATE-COMPILED.                                                   00070001
000800*************************************************************     00080001
000900*    COBOL 2 WITH SQL                                       *     00090001
001000*                                                           *     00100001
001100*   AHKUP050 - ARCHIVE HISTORY DATA DELETION - TRECDVS      *     00110001
001200*                                                           *     00120001
001300*   PROGRAM OVERVIEW:                                       *     00130001
001400*                                                           *     00140001
001500*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TRECDVS.  *     00150001
001600*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00160001
001700*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00170001
001800*                                                           *     00180001
001900*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00190001
002000*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00200001
002100*  THESE COLUMNS ARE ORD_NBR, ORD_LNE_NBR, REC_SEQ_NBR,     *     00210005
002200*  STR_NBR, VRFY_SRC-CDE.                                   *     00220005
002300*                                                           *     00230001
002400*   INPUT:                                                  *     00240001
002500*                                                           *     00250001
002600*     1. TRECDVS DELETION FILE  COPYBOOK DCLTRECDVS         *     00260001
002700*                                                           *     00270001
002800*   DB2 TABLES:                                             *     00280001
002900*                                                           *     00290001
003000*        TRECDVS - RECEIVING HEADER TABLE                   *     00300001
003100*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00310001
003200*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00320001
003300*                                                           *     00330001
003400*************************************************************     00340001
003500*                                                           *     00350001
003600*************************************************************     00360001
003700 EJECT                                                            00370001
003800 ENVIRONMENT DIVISION.                                            00380001
003900 CONFIGURATION SECTION.                                           00390001
004000 SOURCE-COMPUTER.        IBM-370.                                 00400001
004100 OBJECT-COMPUTER.        IBM-370.                                 00410001
004200                                                                  00420001
004300 INPUT-OUTPUT SECTION.                                            00430001
004400 FILE-CONTROL.                                                    00440001
004500     SELECT TRECDVS-EXTRACT-FILE ASSIGN TO INP01.                 00450001
004600                                                                  00460001
004700 DATA DIVISION.                                                   00470001
004800 FILE SECTION.                                                    00480001
004900 FD  TRECDVS-EXTRACT-FILE                                         00490001
005000     RECORDING MODE IS F                                          00500001
005100     LABEL RECORDS ARE STANDARD                                   00510001
005200     BLOCK CONTAINS 0 RECORDS                                     00520001
005300     RECORD CONTAINS 25  CHARACTERS                               00530008
005400     DATA RECORD IS TRECDVS-EXTRACT-DATA.                         00540001
005500 01  TRECDVS-EXTRACT-DATA       PIC X(25).                        00550008
005600                                                                  00560001
005700                                                                  00570001
005800 EJECT                                                            00580001
005900 WORKING-STORAGE SECTION.                                         00590001
006000                                                                  00600001
006100 01  FILLER                       PIC X(58)     VALUE             00610001
006200     '************WORKING STORAGE STARTS HERE*******************'.00620001
006300                                                                  00630001
006400 01  PV-PROGRAM-VARIABLES.                                        00640001
006500     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP050'.  00650002
006600     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00660001
006700     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00670001
006800     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00680001
006900                                                                  00690001
007000     05  PV-TRECDVS-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00700002
007100                                               COMP-3.            00710001
007200     05  PV-TRECDVS-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00720002
007300                                               COMP-3.            00730001
007400     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00740001
007500                                               COMP-3.            00750001
007600     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00760001
007700                                               COMP-3.            00770001
007800     05  PV-DISP-ORD-NBR          PIC X(09)    VALUE SPACES.      00780001
007810     05  PV-DISP-ORD-LNE-NBR      PIC X(09)    VALUE SPACES.      00781002
007900     05  PV-DISP-REC-SEQ-NBR      PIC X(09)    VALUE SPACES.      00790001
008000     05  PV-DISP-STR-NBR          PIC X(09)    VALUE SPACES.      00800002
008100     05  PV-DISP-VRFY-SRC-CDE     PIC X(09)    VALUE SPACES.      00810002
008200 01  PC-PROGRAM-CONSTANTS.                                        00820001
008300     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00830001
008400                                                COMP SYNC.        00840001
008500     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00850001
008600     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00860001
008700     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00870001
008800                                                                  00880001
008900 01  PS-PROGRAM-SWITCHES.                                         00890001
009000     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00900001
009100         88  COMMITS-TAKEN                      VALUE 'T'.        00910001
009200         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00920001
009300     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00930001
009400         88  MORE-EXTRACT                       VALUE 'M'.        00940001
009500         88  END-OF-EXTRACT                     VALUE 'E'.        00950001
009600     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00960001
009700         88  NORMAL-RUN                         VALUE '0'.        00970001
009800         88  RESTART-RUN                        VALUE '9'.        00980001
009900                                                                  00990001
010000 01  WS-COUNTER.                                                  01000001
010100     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01010001
010200     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01020001
010300                                                                  01030001
010400 01  CKPT-RESTART-INFO.                                           01040001
010500     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01050001
010600                                                                  01060001
010700*----------------------------------------------------------------*01070001
010800*  ABEND DATA AREAS                                              *01080001
010900*----------------------------------------------------------------*01090001
011000 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01100001
011100                                             COMP SYNC.           01110001
011200     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01120001
011300     88  AC-BAD-DATA                         VALUE +4008.         01130001
011400     88  AC-DB2-ERROR                        VALUE +4013.         01140001
011500     88  AC-DATE-ERROR                       VALUE +4019.         01150001
011600                                                                  01160001
011700                                                                  01170001
011800 01  ABEND-AREAS.                                                 01180001
011900     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01190001
012000             '*****       ABEND'.                                 01200001
012100     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01210001
012200             '*****   PROGRAM: AHKUP050'.                         01220002
012300     05  AA-PARAGRAPH-LIT.                                        01230001
012400         10  FILLER              PIC  X(17)  VALUE                01240001
012500             '***** PARAGRAPH: '.                                 01250001
012600         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01260001
012700     05  AA-MESSAGE-LINE-1.                                       01270001
012800         10  FILLER              PIC  X(06)  VALUE '*****'.       01280001
012900         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01290001
013000     05  AA-MESSAGE-LINE-2.                                       01300001
013100         10  FILLER              PIC  X(06)  VALUE '*****'.       01310001
013200         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01320001
013300     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01330001
013400             '*****    DB2 ERROR'.                                01340001
013500     05  AA-DB2-OPERATION-LIT.                                    01350001
013600         10  FILLER              PIC  X(17)  VALUE                01360001
013700             '***** OPERATION: '.                                 01370001
013800         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01380001
013900     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01390001
014000     EJECT                                                        01400001
014100                                                                  01410001
014200     COPY DPWS004.                                                01420001
014300     EJECT                                                        01430001
014400*----------------------------------------------------------------*01440001
014500*      TRECDVS TABLE LAYOUT                                       01450002
014600*----------------------------------------------------------------*01460001
014700         EXEC SQL                                                 01470001
014800             INCLUDE TRECDVS                                      01480002
014900         END-EXEC.                                                01490001
015000                                                                  01500001
015100*----------------------------------------------------------------*01510001
015200*      TCKRSTCNTL TABLE LAYOUT                                    01520001
015300*----------------------------------------------------------------*01530001
015400         EXEC SQL                                                 01540001
015500             INCLUDE TCKRSTCN                                     01550001
015600         END-EXEC.                                                01560001
015700                                                                  01570001
015800*----------------------------------------------------------------*01580001
015900*      TCKRSTINF TABLE LAYOUT                                     01590001
016000*----------------------------------------------------------------*01600001
016100         EXEC SQL                                                 01610001
016200             INCLUDE TCKRSTIN                                     01620001
016300         END-EXEC.                                                01630001
016400 EJECT                                                            01640001
016500*----------------------------------------------------------------*01650001
016600*  DB2 COMMUNICATION AREA                                         01660001
016700*----------------------------------------------------------------*01670001
016800*                                                                 01680001
016900     EXEC SQL                                                     01690001
017000         INCLUDE SQLCA                                            01700001
017100     END-EXEC.                                                    01710001
017200                                                                  01720001
017300*----------------------------------------------------------------*01730001
017400*  DB2 COMMUNICATION AREA2                                        01740001
017500*----------------------------------------------------------------*01750001
017600*                                                                 01760001
017700     COPY SQLCA2.                                                 01770001
017800     EJECT                                                        01780001
017900 PROCEDURE DIVISION.                                              01790001
018000 A100-MAINLINE-ROUTINE.                                           01800001
018100                                                                  01810001
018200     PERFORM B100-INITIALIZATION.                                 01820001
018300                                                                  01830001
018400     PERFORM B200-TRECDVS-EXTRACT-PROCESS                         01840002
018500       UNTIL END-OF-EXTRACT.                                      01850001
018600                                                                  01860001
018700     PERFORM B300-EOJ-PROCESSING.                                 01870001
018800                                                                  01880001
018900     GOBACK.                                                      01890001
019000 EJECT                                                            01900001
019100 B100-INITIALIZATION.                                             01910001
019200                                                                  01920001
019300     EXEC SQL                                                     01930001
019400         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01940001
019500     END-EXEC.                                                    01950001
019600                                                                  01960001
019700     PERFORM X300-GET-CHECKPOINT-CNTL.                            01970001
019800     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01980001
019900                                                                  01990001
020000     OPEN INPUT TRECDVS-EXTRACT-FILE.                             02000002
020100                                                                  02010001
020200     IF RESTART-RUN                                               02020001
020300         PERFORM X200-CHECKPOINT-RESTART                          02030001
020400     ELSE                                                         02040001
020500         PERFORM R100-READ-EXTRACT-FILE                           02050001
020600     END-IF.                                                      02060001
020700                                                                  02070001
020800     PERFORM X500-SET-CHECKPOINT-TIME.                            02080001
020900                                                                  02090001
021000                                                                  02100001
021100     EJECT                                                        02110001
021200 B200-TRECDVS-EXTRACT-PROCESS.                                    02120002
021300                                                                  02130001
021310     MOVE RECDVS-ORD-NBR            TO PV-DISP-ORD-NBR.           02131002
021400     MOVE RECDVS-ORD-LNE-NBR        TO PV-DISP-ORD-LNE-NBR.       02140002
021410     MOVE RECDVS-REC-SEQ-NBR        TO PV-DISP-REC-SEQ-NBR.       02141002
021500     MOVE RECDVS-STR-NBR            TO PV-DISP-STR-NBR.           02150002
021600     MOVE RECDVS-VRFY-SRC-CDE       TO PV-DISP-VRFY-SRC-CDE.      02160002
021800                                                                  02180001
021900     PERFORM D100-DELETE-TRECDVS.                                 02190002
022000                                                                  02200001
022100     PERFORM X100-CHECKPOINT-CHECK.                               02210001
022200                                                                  02220001
022300     PERFORM R100-READ-EXTRACT-FILE.                              02230001
022400     EJECT                                                        02240001
022500                                                                  02250001
022600                                                                  02260001
022700 B300-EOJ-PROCESSING.                                             02270001
022800                                                                  02280001
022900     DISPLAY '** AHKUP050 SUMMARY **'.                            02290002
023000     DISPLAY '** TRECDVS INPUT COUNT = ' PV-TRECDVS-INPUT-COUNT.  02300002
023100     DISPLAY '** TRECDVS DELETE COUNT = ' PV-TRECDVS-DELETE-COUNT.02310002
023200     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02320001
023300                                                                  02330001
023400     CLOSE  TRECDVS-EXTRACT-FILE.                                 02340002
023500                                                                  02350001
023600     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02360001
023700     PERFORM X600-UPDATE-TCKRSTCNTL.                              02370001
023800                                                                  02380001
023900     EJECT                                                        02390001
024000*----------------------------------------------------------------*02400001
024100*    DELETES FROM THE TRECDVS TABLE. NO OTHER TABLES REFERENCE   *02410002
024200*    THIS TABLE.                                                 *02420002
024400*----------------------------------------------------------------*02440001
024500 D100-DELETE-TRECDVS.                                             02450002
024600                                                                  02460001
024700     MOVE 'D100-DELETE-TRECDVS' TO PV-CURRENT-PARAGRAPH.          02470002
024800                                                                  02480001
024900     PERFORM WITH TEST AFTER                                      02490001
025000        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02500001
025100          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02510001
025200             OR SQLCODE = ZERO                                    02520001
025300                                                                  02530001
025400         EXEC SQL                                                 02540001
025500              DELETE                                              02550001
025600                FROM TRECDVS                                      02560002
025610               WHERE ORD_NBR     = :RECDVS-ORD-NBR                02561002
025700                 AND ORD_LNE_NBR = :RECDVS-ORD-LNE-NBR            02570002
025710                 AND REC_SEQ_NBR = :RECDVS-REC-SEQ-NBR            02571002
025800                 AND STR_NBR     = :RECDVS-STR-NBR                02580002
025900                 AND VRFY_SRC_CDE = :RECDVS-VRFY-SRC-CDE          02590002
026100         END-EXEC                                                 02610001
026200                                                                  02620001
026300         EVALUATE TRUE                                            02630001
026400             WHEN SQLCODE = ZERO                                  02640001
026500                 ADD 1 TO PV-TRECDVS-DELETE-COUNT                 02650002
026600                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02660009
026700                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02670001
026800                                                                  02680001
026900             WHEN SQLCODE = -904                                  02690001
027000             WHEN SQLCODE = -913                                  02700001
027100                  CONTINUE                                        02710001
027200                                                                  02720001
027300             WHEN SQLCODE = +100                                  02730001
027400                 MOVE PV-CURRENT-PARAGRAPH                        02740001
027500                                     TO AA-PARAGRAPH-NAME         02750001
027510                 DISPLAY '******** ORD NBR:'                      02751004
027520                          PV-DISP-ORD-NBR                         02752004
027521                 DISPLAY '******** ORD LNE NBR:'                  02752104
027522                          PV-DISP-ORD-LNE-NBR                     02752204
027523                 DISPLAY '******** REC SEQ NBR :'                 02752304
027524                          PV-DISP-REC-SEQ-NBR                     02752404
027525                 DISPLAY '******** STR NBR :'                     02752504
027526                          PV-DISP-STR-NBR                         02752604
027527                 DISPLAY '******** VRFY SRC CDE:'                 02752704
027528                          PV-DISP-VRFY-SRC-CDE                    02752804
028400                 MOVE 'ROW NOT ON TABLE ********'                 02840001
028500                          TO AA-MESSAGE-1                         02850001
028600                 MOVE SPACES TO AA-MESSAGE-2                      02860001
028700                 MOVE 'UNSUCCESSFUL DELETE'                       02870001
028800                          TO AA-DB2-OPERATION                     02880001
028900                 MOVE 'TRECDVS'  TO AA-DB2-TABLE                  02890004
029000                 PERFORM Z999-DB2-ABEND                           02900001
029100             WHEN SQLWARN0 NOT = SPACES                           02910001
029200             WHEN SQLCODE  NOT = ZERO                             02920001
029300                 MOVE PV-CURRENT-PARAGRAPH                        02930001
029400                                     TO AA-PARAGRAPH-NAME         02940001
029410                 DISPLAY '******** ORD NBR:'                      02941004
029420                          PV-DISP-ORD-NBR                         02942004
029430                 DISPLAY '******** ORD LNE NBR:'                  02943004
029440                          PV-DISP-ORD-LNE-NBR                     02944004
029450                 DISPLAY '******** REC SEQ NBR :'                 02945004
029460                          PV-DISP-REC-SEQ-NBR                     02946004
029470                 DISPLAY '******** STR NBR :'                     02947004
029480                          PV-DISP-STR-NBR                         02948004
029490                 DISPLAY '******** VRFY SRC CDE:'                 02949004
029491                          PV-DISP-VRFY-SRC-CDE                    02949104
030300                 MOVE SPACES TO AA-MESSAGE-1                      03030001
030400                                AA-MESSAGE-2                      03040001
030500                 MOVE 'UNSUCCESSFUL DELETE'                       03050001
030600                                     TO AA-DB2-OPERATION          03060001
030700                 MOVE 'TRECDVS'      TO AA-DB2-TABLE              03070004
030800                 PERFORM Z999-DB2-ABEND                           03080001
030900         END-EVALUATE                                             03090001
031000     END-PERFORM.                                                 03100001
031100                                                                  03110001
031200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03120001
031300         MOVE PV-CURRENT-PARAGRAPH                                03130001
031400                             TO AA-PARAGRAPH-NAME                 03140001
031410         DISPLAY '******** ORD NBR:'                              03141002
031420                          PV-DISP-ORD-NBR                         03142002
031421         DISPLAY '******** ORD LNE NBR:'                          03142102
031422                          PV-DISP-ORD-LNE-NBR                     03142202
031430         DISPLAY '******** REC SEQ NBR :'                         03143002
031440                          PV-DISP-REC-SEQ-NBR                     03144002
031500         DISPLAY '******** STR NBR :'                             03150002
031600                          PV-DISP-STR-NBR                         03160002
031700         DISPLAY '******** VRFY SRC CDE:'                         03170002
031800                          PV-DISP-VRFY-SRC-CDE                    03180002
032300         MOVE SPACES TO AA-MESSAGE-1                              03230001
032400                        AA-MESSAGE-2                              03240001
032500         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03250001
032600                             TO AA-DB2-OPERATION                  03260001
032700         MOVE 'TRECDVS'      TO AA-DB2-TABLE                      03270002
032800         PERFORM Z999-DB2-ABEND                                   03280001
032900     END-IF.                                                      03290001
033000                                                                  03300001
033100     EJECT                                                        03310001
033200 R100-READ-EXTRACT-FILE.                                          03320001
033300                                                                  03330001
033400     READ TRECDVS-EXTRACT-FILE                                    03340002
033500          INTO DCLTRECDVS                                         03350002
033600          AT END SET END-OF-EXTRACT TO TRUE.                      03360001
033700                                                                  03370001
033800     IF MORE-EXTRACT                                              03380001
033900         ADD 1 TO PV-TRECDVS-INPUT-COUNT                          03390002
034000     END-IF.                                                      03400001
034100                                                                  03410001
034200                                                                  03420001
034300     EJECT                                                        03430001
034400*----------------------------------------------------------------*03440001
034500*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03450001
034600*----------------------------------------------------------------*03460001
034700 X100-CHECKPOINT-CHECK.                                           03470001
034800                                                                  03480001
034900     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03490001
035000                                                                  03500001
035100     EXEC SQL                                                     03510001
035200       SET :WS-TMST = CURRENT TIMESTAMP                           03520001
035300     END-EXEC.                                                    03530001
035400                                                                  03540001
035500     IF SQLCODE = +0                                              03550001
035600         CONTINUE                                                 03560001
035700     ELSE                                                         03570001
035800         MOVE PV-CURRENT-PARAGRAPH                                03580001
035900                             TO AA-PARAGRAPH-NAME                 03590001
036000         MOVE SPACES TO AA-MESSAGE-1                              03600001
036100                        AA-MESSAGE-2                              03610001
036200         MOVE 'BAD SET COMMAND'                                   03620001
036300                             TO AA-DB2-OPERATION                  03630001
036400         MOVE SPACES             TO AA-DB2-TABLE                  03640001
036500         PERFORM Z999-DB2-ABEND                                   03650001
036600     END-IF.                                                      03660001
036700                                                                  03670001
036800     IF WS-TMST > WS-HOLD-TMST                                    03680001
036900         IF NO-COMMITS-TAKEN                                      03690001
037000             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03700001
037100             PERFORM X600-UPDATE-TCKRSTCNTL                       03710001
037200             SET COMMITS-TAKEN TO TRUE                            03720001
037300         END-IF                                                   03730001
037400         PERFORM X700-UPDATE-TCKRSTINF                            03740001
037500         PERFORM Y100-COMMIT                                      03750001
037600         PERFORM X500-SET-CHECKPOINT-TIME                         03760001
037700     END-IF.                                                      03770001
037800                                                                  03780001
037900 EJECT                                                            03790001
038000*----------------------------------------------------------------*03800001
038100*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03810001
038200*----------------------------------------------------------------*03820001
038300 X200-CHECKPOINT-RESTART.                                         03830001
038400                                                                  03840001
038500     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03850001
038600                                                                  03860001
038700     PERFORM X400-GET-CHECKPOINT-INFO.                            03870001
038800     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03880001
038900                                                                  03890001
039000     DISPLAY '** AHKUP050 CHECKPOINT RESTART **'                  03900002
039100     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03910001
039200              CR-EXTRACT-RECS-WORKED.                             03920001
039300     DISPLAY '***********************************************'    03930001
039400                                                                  03940001
039500     PERFORM R100-READ-EXTRACT-FILE                               03950001
039600         CR-EXTRACT-RECS-WORKED TIMES.                            03960001
039700     PERFORM R100-READ-EXTRACT-FILE.                              03970001
039800 EJECT                                                            03980001
039900*----------------------------------------------------------------*03990001
040000*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04000001
040100*----------------------------------------------------------------*04010001
040200 X300-GET-CHECKPOINT-CNTL.                                        04020001
040300                                                                  04030001
040400     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04040001
040500                                                                  04050001
040600     PERFORM WITH TEST AFTER                                      04060001
040700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04070001
040800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04080001
040900                     SQLCODE = ZERO                               04090001
041000                                                                  04100001
041100             EXEC SQL                                             04110001
041200              SELECT CKPT_STAT_CODE                               04120001
041300               INTO :PV-CKPT-STAT-CODE                            04130001
041400               FROM TCKRSTCNTL                                    04140001
041500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04150001
041600             END-EXEC                                             04160001
041700                                                                  04170001
041800             EVALUATE TRUE                                        04180001
041900                 WHEN SQLCODE = ZERO                              04190001
042000                 WHEN SQLCODE = -904                              04200001
042100                 WHEN SQLCODE = -913                              04210001
042200                      CONTINUE                                    04220001
042300                                                                  04230001
042400                 WHEN SQLWARN0 NOT = SPACES                       04240001
042500                 WHEN SQLCODE  NOT = ZERO                         04250001
042600                     MOVE PV-CURRENT-PARAGRAPH                    04260001
042700                                         TO AA-PARAGRAPH-NAME     04270001
042800                     DISPLAY '******** PLAN_NAME:'                04280001
042900                              PV-PROGRAM-NAME                     04290001
043000                     MOVE SPACES TO AA-MESSAGE-1                  04300001
043100                                    AA-MESSAGE-2                  04310001
043200                     MOVE 'UNSUCCESSFUL SELECT'                   04320001
043300                                         TO AA-DB2-OPERATION      04330001
043400                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04340001
043500                     PERFORM Z999-DB2-ABEND                       04350001
043600             END-EVALUATE                                         04360001
043700     END-PERFORM.                                                 04370001
043800                                                                  04380001
043900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04390001
044000         MOVE PV-CURRENT-PARAGRAPH                                04400001
044100                             TO AA-PARAGRAPH-NAME                 04410001
044200         DISPLAY '******** PLAN_NAME:'                            04420001
044300                  PV-PROGRAM-NAME                                 04430001
044400         MOVE SPACES TO AA-MESSAGE-1                              04440001
044500                        AA-MESSAGE-2                              04450001
044600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04460001
044700                             TO AA-DB2-OPERATION                  04470001
044800         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04480001
044900         PERFORM Z999-DB2-ABEND                                   04490001
045000     END-IF.                                                      04500001
045100                                                                  04510001
045200 EJECT                                                            04520001
045300*----------------------------------------------------------------*04530001
045400*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04540001
045500*----------------------------------------------------------------*04550001
045600 X400-GET-CHECKPOINT-INFO.                                        04560001
045700                                                                  04570001
045800     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04580001
045900                                                                  04590001
046000     PERFORM WITH TEST AFTER                                      04600001
046100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04610001
046200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04620001
046300                     SQLCODE = ZERO                               04630001
046400                                                                  04640001
046500             EXEC SQL                                             04650001
046600              SELECT WORK_STRG_DESC                               04660001
046700               INTO :TCKRSTINF-WORK-STRG-DESC                     04670001
046800               FROM TCKRSTINF                                     04680001
046900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04690001
047000             END-EXEC                                             04700001
047100                                                                  04710001
047200             EVALUATE TRUE                                        04720001
047300                 WHEN SQLCODE = ZERO                              04730001
047400                 WHEN SQLCODE = -904                              04740001
047500                 WHEN SQLCODE = -913                              04750001
047600                      CONTINUE                                    04760001
047700                                                                  04770001
047800                 WHEN SQLWARN0 NOT = SPACES                       04780001
047900                 WHEN SQLCODE  NOT = ZERO                         04790001
048000                     MOVE PV-CURRENT-PARAGRAPH                    04800001
048100                                         TO AA-PARAGRAPH-NAME     04810001
048200                     DISPLAY '******** PLAN_NAME:'                04820001
048300                              PV-PROGRAM-NAME                     04830001
048400                     MOVE SPACES TO AA-MESSAGE-1                  04840001
048500                                    AA-MESSAGE-2                  04850001
048600                     MOVE 'UNSUCCESSFUL SELECT'                   04860001
048700                                         TO AA-DB2-OPERATION      04870001
048800                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04880001
048900                     PERFORM Z999-DB2-ABEND                       04890001
049000             END-EVALUATE                                         04900001
049100     END-PERFORM.                                                 04910001
049200                                                                  04920001
049300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04930001
049400         MOVE PV-CURRENT-PARAGRAPH                                04940001
049500                             TO AA-PARAGRAPH-NAME                 04950001
049600         DISPLAY '******** PLAN_NAME:'                            04960001
049700                  PV-PROGRAM-NAME                                 04970001
049800         MOVE SPACES TO AA-MESSAGE-1                              04980001
049900                        AA-MESSAGE-2                              04990001
050000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05000001
050100                             TO AA-DB2-OPERATION                  05010001
050200         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05020001
050300         PERFORM Z999-DB2-ABEND                                   05030001
050400     END-IF.                                                      05040001
050500                                                                  05050001
050600 EJECT                                                            05060001
050700*----------------------------------------------------------------*05070001
050800*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05080001
050900*----------------------------------------------------------------*05090001
051000 X500-SET-CHECKPOINT-TIME.                                        05100001
051100                                                                  05110001
051200     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05120001
051300                                                                  05130001
051400     PERFORM WITH TEST AFTER                                      05140001
051500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05150001
051600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05160001
051700                     SQLCODE = ZERO                               05170001
051800                                                                  05180001
051900             EXEC SQL                                             05190001
052000              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05200001
052100               INTO :WS-HOLD-TMST                                 05210001
052200               FROM TCKRSTCNTL                                    05220001
052300               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05230001
052400             END-EXEC                                             05240001
052500                                                                  05250001
052600             EVALUATE TRUE                                        05260001
052700                 WHEN SQLCODE = ZERO                              05270001
052800                 WHEN SQLCODE = -904                              05280001
052900                 WHEN SQLCODE = -913                              05290001
053000                      CONTINUE                                    05300001
053100                                                                  05310001
053200                 WHEN SQLWARN0 NOT = SPACES                       05320001
053300                 WHEN SQLCODE  NOT = ZERO                         05330001
053400                     MOVE PV-CURRENT-PARAGRAPH                    05340001
053500                                         TO AA-PARAGRAPH-NAME     05350001
053600                     DISPLAY '******** PLAN_NAME:'                05360001
053700                              PV-PROGRAM-NAME                     05370001
053800                     MOVE SPACES TO AA-MESSAGE-1                  05380001
053900                                    AA-MESSAGE-2                  05390001
054000                     MOVE 'UNSUCCESSFUL SELECT'                   05400001
054100                                         TO AA-DB2-OPERATION      05410001
054200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05420001
054300                     PERFORM Z999-DB2-ABEND                       05430001
054400             END-EVALUATE                                         05440001
054500     END-PERFORM.                                                 05450001
054600                                                                  05460001
054700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05470001
054800         MOVE PV-CURRENT-PARAGRAPH                                05480001
054900                             TO AA-PARAGRAPH-NAME                 05490001
055000         DISPLAY '******** PLAN_NAME:'                            05500001
055100                  PV-PROGRAM-NAME                                 05510001
055200         MOVE SPACES TO AA-MESSAGE-1                              05520001
055300                        AA-MESSAGE-2                              05530001
055400         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05540001
055500                             TO AA-DB2-OPERATION                  05550001
055600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05560001
055700         PERFORM Z999-DB2-ABEND                                   05570001
055800     END-IF.                                                      05580001
055900                                                                  05590001
056000 EJECT                                                            05600001
056100*----------------------------------------------------------------*05610001
056200*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05620001
056300*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05630001
056400*----------------------------------------------------------------*05640001
056500 X600-UPDATE-TCKRSTCNTL.                                          05650001
056600                                                                  05660001
056700     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05670001
056800                                                                  05680001
056900     PERFORM WITH TEST AFTER                                      05690001
057000             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05700001
057100             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05710001
057200                     SQLCODE = ZERO                               05720001
057300                                                                  05730001
057400             EXEC SQL                                             05740001
057500                 UPDATE TCKRSTCNTL                                05750001
057600                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05760001
057700                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05770001
057800             END-EXEC                                             05780001
057900                                                                  05790001
058000             EVALUATE TRUE                                        05800001
058100                 WHEN SQLCODE = ZERO                              05810001
058200                 WHEN SQLCODE = -904                              05820001
058300                 WHEN SQLCODE = -913                              05830001
058400                      CONTINUE                                    05840001
058500                                                                  05850001
058600                 WHEN SQLWARN0 NOT = SPACES                       05860001
058700                 WHEN SQLCODE  NOT = ZERO                         05870001
058800                     MOVE PV-CURRENT-PARAGRAPH                    05880001
058900                                         TO AA-PARAGRAPH-NAME     05890001
059000                     DISPLAY '******** PLAN_NAME:'                05900001
059100                              PV-PROGRAM-NAME                     05910001
059200                     MOVE SPACES TO AA-MESSAGE-1                  05920001
059300                                    AA-MESSAGE-2                  05930001
059400                     MOVE 'UNSUCCESSFUL UPDATE'                   05940001
059500                                         TO AA-DB2-OPERATION      05950001
059600                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05960001
059700                     PERFORM Z999-DB2-ABEND                       05970001
059800             END-EVALUATE                                         05980001
059900     END-PERFORM.                                                 05990001
060000                                                                  06000001
060100     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06010001
060200         MOVE PV-CURRENT-PARAGRAPH                                06020001
060300                             TO AA-PARAGRAPH-NAME                 06030001
060400         DISPLAY '******** PLAN_NAME:'                            06040001
060500                  PV-PROGRAM-NAME                                 06050001
060600         MOVE SPACES TO AA-MESSAGE-1                              06060001
060700                        AA-MESSAGE-2                              06070001
060800         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06080001
060900                             TO AA-DB2-OPERATION                  06090001
061000         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06100001
061100         PERFORM Z999-DB2-ABEND                                   06110001
061200     END-IF.                                                      06120001
061300                                                                  06130001
061400     EJECT                                                        06140001
061500*----------------------------------------------------------------*06150001
061600*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06160001
061700*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06170001
061800*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06180001
061900*----------------------------------------------------------------*06190001
062000 X700-UPDATE-TCKRSTINF.                                           06200001
062100                                                                  06210001
062200     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06220001
062300                                                                  06230001
062400     MOVE PV-TRECDVS-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06240006
062500     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06250001
062600     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06260001
062700                                                                  06270001
062800     PERFORM WITH TEST AFTER                                      06280001
062900             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06290001
063000             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06300001
063100                     SQLCODE = ZERO                               06310001
063200                                                                  06320001
063300             EXEC SQL                                             06330001
063400                 UPDATE TCKRSTINF                                 06340001
063500                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06350001
063600                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06360001
063700             END-EXEC                                             06370001
063800                                                                  06380001
063900             EVALUATE TRUE                                        06390001
064000                 WHEN SQLCODE = ZERO                              06400001
064100                 WHEN SQLCODE = -904                              06410001
064200                 WHEN SQLCODE = -913                              06420001
064300                      CONTINUE                                    06430001
064400                                                                  06440001
064500                 WHEN SQLWARN0 NOT = SPACES                       06450001
064600                 WHEN SQLCODE  NOT = ZERO                         06460001
064700                     MOVE PV-CURRENT-PARAGRAPH                    06470001
064800                                         TO AA-PARAGRAPH-NAME     06480001
064900                     DISPLAY '******** PLAN_NAME:'                06490001
065000                              PV-PROGRAM-NAME                     06500001
065100                     MOVE SPACES TO AA-MESSAGE-1                  06510001
065200                                    AA-MESSAGE-2                  06520001
065300                     MOVE 'UNSUCCESSFUL UPDATE'                   06530001
065400                                         TO AA-DB2-OPERATION      06540001
065500                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06550001
065600                     PERFORM Z999-DB2-ABEND                       06560001
065700             END-EVALUATE                                         06570001
065800     END-PERFORM.                                                 06580001
065900                                                                  06590001
066000     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06600001
066100         MOVE PV-CURRENT-PARAGRAPH                                06610001
066200                             TO AA-PARAGRAPH-NAME                 06620001
066300         DISPLAY '******** PLAN_NAME:'                            06630001
066400                  PV-PROGRAM-NAME                                 06640001
066500         MOVE SPACES TO AA-MESSAGE-1                              06650001
066600                        AA-MESSAGE-2                              06660001
066700         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06670001
066800                             TO AA-DB2-OPERATION                  06680001
066900         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06690001
067000         PERFORM Z999-DB2-ABEND                                   06700001
067100     END-IF.                                                      06710001
067200                                                                  06720001
067300 EJECT                                                            06730001
067400                                                                  06740001
067500*----------------------------------------------------------------*06750001
067600*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06760001
067700*----------------------------------------------------------------*06770001
067800 Y100-COMMIT.                                                     06780001
067900                                                                  06790001
068000     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06800001
068100                                                                  06810001
068200     EXEC SQL                                                     06820001
068300         COMMIT                                                   06830001
068400     END-EXEC.                                                    06840001
068500                                                                  06850001
068600     EVALUATE TRUE                                                06860001
068700         WHEN SQLCODE = ZEROS                                     06870001
068800             CONTINUE                                             06880001
068900         WHEN OTHER                                               06890001
069000             MOVE PV-CURRENT-PARAGRAPH                            06900001
069100                                 TO AA-PARAGRAPH-NAME             06910001
069200             MOVE SPACES TO AA-MESSAGE-1                          06920001
069300                            AA-MESSAGE-2                          06930001
069400             MOVE 'UNSUCCESSFUL COMMIT'                           06940001
069500                                 TO AA-DB2-OPERATION              06950001
069600             MOVE SPACES         TO AA-DB2-TABLE                  06960001
069700             PERFORM Z999-DB2-ABEND                               06970001
069800     END-EVALUATE.                                                06980001
069900 EJECT                                                            06990001
070000 Z900-PROCESS-ABEND.                                              07000001
070100                                                                  07010001
070200     DISPLAY '*** ABEND'.                                         07020001
070300     DISPLAY '*** PROGRAM   = AHKUP050'.                          07030002
070400     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07040001
070500     DISPLAY AA-MESSAGE-LINE-1.                                   07050001
070600     DISPLAY AA-MESSAGE-LINE-2.                                   07060001
070700     COPY DPPD004.                                                07070001
070800     CALL 'ILBOABN0' USING ABEND-CODE.                            07080001
070900                                                                  07090001
071000                                                                  07100001
071100                                                                  07110001
071200 Z999-DB2-ABEND.                                                  07120001
071300                                                                  07130001
071400     DISPLAY AA-ABEND-LIT.                                        07140001
071500     DISPLAY AA-DB2-ERROR-LIT.                                    07150001
071600     DISPLAY AA-PROGRAM-LIT.                                      07160001
071700     DISPLAY AA-PARAGRAPH-LIT.                                    07170001
071800     DISPLAY AA-DB2-OPERATION-LIT.                                07180001
071900     DISPLAY AA-DB2-TABLE.                                        07190001
072000     SET AC-DB2-ERROR TO TRUE.                                    07200001
072100                                                                  07210001
072200     COPY DPPD004.                                                07220001
072300                                                                  07230001
072400     CALL 'ILBOABN0' USING ABEND-CODE.                            07240001
