000100******************************************************************00010000
000200******************************************************************00020000
000300**         I D E N T I F I C A T I O N   D I V I S I O N        **00030000
000400******************************************************************00040000
000500******************************************************************00050000
000600 IDENTIFICATION DIVISION.                                         00060000
000700 PROGRAM-ID.    SUKUT133.                                         00070001
000800 AUTHOR.        DAN HINTZ.                                        00080002
000900 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00090000
001000 DATE-WRITTEN.  FEBRUARY, 2014.                                   00100008
001100 DATE-COMPILED.                                                   00110000
001200                                                                  00120000
001300******************************************************************00130000
001400*  THIS PROGRAM WILL BE USED TO RESEND DIRECTIVES FROM THE CAR-  *00140000
001500*  TON DIRECTIVE TRACKING TABLE (SUT_CART_DIRV_TRKG).            *00150000
001600*                                                                *00160000
001700*  A CONTROL FILE WILL CONTAIN A DC NUMBER AND BEGIN AND END     *00170000
001800*  DATE RANGE DESCRIBING THE DIRECTIVES TO BE RESENT.            *00180000
001900*                                                                *00190000
002000*  FOR EACH CONTROL RECORD, A CURSOR WILL BE OPENED THAT WILL    *00200000
002100*  GATHER ALL DIRECTIVES TO BE RESENT. FOR EACH ROW IN THE       *00210000
002200*  CURSOR A RECORD WILL BE WRITTEN TO AN OUTPUT FILE.  THIS NEW  *00220003
002300*  OUTPUT FILE WILL BE INPUT TO PROGRAM SUKUT135 WHERE THE       *00230003
002400*  CALLS WILL BE MADE TO THE DIRECTIVE GENERATOR PROGRAM         *00240003
002400*  (SUKUT129).                                                   *00241003
001900*                                                                *00241103
002400*  THIS WAY, WE CAN CONTROL THE DIRECTIVES THAT ARE GETTING SENT *00242003
002400*  AGAIN (ONLY 'ADD' DIRECTIVES OR ONLY 'DELETE' DIRECTIVES)     *00242103
002400*  WITHOUT NEEDING TO CHANGE THE CURSOR IN THIS PROGRAM.         *00243003
002500******************************************************************00250000
002600 EJECT                                                            00260000
002700******************************************************************00270000
002800******************************************************************00280000
002900**            E N V I R O N M E N T   D I V I S I O N           **00290000
003000******************************************************************00300000
003100******************************************************************00310000
003200 ENVIRONMENT DIVISION.                                            00320000
003300                                                                  00330000
003400 CONFIGURATION SECTION.                                           00340000
003500                                                                  00350000
003600 SOURCE-COMPUTER.  IBM-3090.                                      00360000
003700 OBJECT-COMPUTER.  IBM-3090.                                      00370000
003800                                                                  00380000
003900 INPUT-OUTPUT SECTION.                                            00390000
004000                                                                  00400000
004100 FILE-CONTROL.                                                    00410000
004200                                                                  00420000
004300     SELECT SURD029-CONTROL-FILE                                  00430003
004400         ASSIGN TO INP01.                                         00440003
004600                                                                  00460103
004300     SELECT SURD104-DIRECTIVE-FILE                                00461003
004400         ASSIGN TO OUT01.                                         00462003
004600                                                                  00464003
004700 EJECT                                                            00470000
004800******************************************************************00480000
004900******************************************************************00490000
005000**                   D A T A   D I V I S I O N                  **00500000
005100******************************************************************00510000
005200******************************************************************00520000
005300 DATA DIVISION.                                                   00530000
005400                                                                  00540000
005500 FILE SECTION.                                                    00550000
005600                                                                  00560000
005700 FD  SURD029-CONTROL-FILE                                         00570000
005800     RECORDING MODE IS F                                          00580000
005900     LABEL RECORDS ARE STANDARD                                   00590000
006000     BLOCK CONTAINS 0 RECORDS.                                    00600000
006100                                                                  00610000
006200 01  SURD029-CONTROL-RECORD         PIC X(80).                    00620000
006300                                                                  00630000
005700 FD  SURD104-DIRECTIVE-FILE                                       00631003
005800     RECORDING MODE IS F                                          00632003
005900     LABEL RECORDS ARE STANDARD                                   00633003
006000     BLOCK CONTAINS 0 RECORDS.                                    00634003
006100                                                                  00635003
006200 01  SURD104-DIRECTIVE-RECORD       PIC X(200).                   00636007
006300                                                                  00637003
006300                                                                  00638003
006400*----------------------------------------------------------------*00640000
006500*                         WORKING STORAGE                        *00650000
006600*----------------------------------------------------------------*00660000
006700 WORKING-STORAGE SECTION.                                         00670000
006800                                                                  00680000
007400 01  WS-ABEND-FIELDS.                                             00740000
007500     05  WS-AC-ABEND-CODE          PIC S9(04) VALUE ZEROES.       00750000
007600     05  WS-ABEND-CODE             PIC S9(04) VALUE +0            00760000
007700                                              COMP SYNC.          00770000
007800 01  WS-PROGRAM-ACCUMULATORS.                                     00780000
007900     05  WS-CNTRL-RECS-READ        PIC 9(13)  VALUE 0.            00790000
008000         88  NO-CONTROL-CARDS                 VALUE 0.            00800000
008100     05  WS-DIRECTIVES-FETCHED     PIC 9(13)  VALUE 0.            00810000
008200     05  WS-DIRECTIVE-RECS-WRITTEN PIC 9(13)  VALUE 0.            00820008
008300                                                                  00830000
008400 01  WS-PROGRAM-SWITCHES.                                         00840000
008500     05  WS-END-OF-CURSOR          PIC X(01)  VALUE 'N'.          00850000
008600         88  CURSOR-AT-END                    VALUE 'Y'.          00860000
008700         88  CURSOR-NOT-AT-END                VALUE 'N'.          00870000
008500     05  WS-END-OF-SURD029-FILE    PIC X(01)  VALUE 'N'.          00881003
008600         88  SURD029-FILE-AT-END              VALUE 'Y'.          00882003
008700         88  SURD029-FILE-NOT-AT-END          VALUE 'N'.          00883003
008800                                                                  00884003
008900 01  WS-PROGRAM-CONSTANTS.                                        00890000
009000     05  WS-CURRENT-PROGRAM-NAME   PIC X(08)  VALUE 'SUKUT133'.   00900001
009000     05  WS-RESEND                 PIC X(08)  VALUE 'RESEND  '.   00901014
009100                                                                  00910000
009200 01  WS-CONSTANTS.                                                00920000
009300     05  WS-LIT-ADD                PIC X(06)  VALUE 'ADD   '.     00930000
009400     05  WS-LIT-DELETE             PIC X(06)  VALUE 'DELETE'.     00940000
009500     05  WS-LIT-MODIFY             PIC X(06)  VALUE 'MODIFY'.     00950000
009600                                                                  00960000
009700 01  WS-MISCELLANEOUS.                                            00970000
009800     05  WS-TIMESTAMP              PIC X(26)  VALUE SPACES.       00980000
009900     05  WS-BEGIN-TIMESTAMP        PIC X(26)  VALUE SPACES.       00990000
010000     05  WS-END-TIMESTAMP          PIC X(26)  VALUE SPACES.       01000000
010100     05  WS-PARAGRAPH-NAME         PIC X(31)  VALUE SPACES.       01010000
010200                                                                  01020000
010300*----------------------------------------------------------------*01030000
010400*  INPUT DUAL FEED CONTROL LAYOUT                                *01040000
010500*----------------------------------------------------------------*01050000
010600     COPY SURD029.                                                01060000
010700 EJECT                                                            01070000
010300*----------------------------------------------------------------*01071003
010400*  OUTPUT FILE FOR DIRECTIVES TO RESEND.                         *01072003
010500*----------------------------------------------------------------*01073003
010600     COPY SURD104.                                                01074003
010700 EJECT                                                            01075003
011300*----------------------------------------------------------------*01130000
011400*  DB2 FORMATTED MESSAGE AREA                                    *01140000
011500*----------------------------------------------------------------*01150000
011600     COPY DPWS004.                                                01160000
011700 EJECT                                                            01170000
011800*----------------------------------------------------------------*01180000
011900*  COMMUNICATIONS AREA FOR DB2                                   *01190000
012000*----------------------------------------------------------------*01200000
012100     EXEC SQL                                                     01210003
               INCLUDE SQLCA                                            01211003
           END-EXEC.                                                    01212003
012200 EJECT                                                            01220000
012300*----------------------------------------------------------------*01230000
012400*  DB2 DECLARATION - SHIPPING UNIT - CARTON DIRECTIVE TRACKING   *01240000
012500*      TABLE (SUT_CART_DIRV_TRKG)                                *01250000
012600*----------------------------------------------------------------*01260000
012700     EXEC SQL                                                     01270003
               INCLUDE SUT00102                                         01271003
           END-EXEC.                                                    01272003
012800 EJECT                                                            01280000
012900*----------------------------------------------------------------*01290000
013000*  DB2 TABLE DECLARATION -  XLT_LOC  TABLE.                      *01300000
013100*      (XLT_LOC)                                                 *01310000
013200*----------------------------------------------------------------*01320000
013300     EXEC SQL                                                     01330003
               INCLUDE XLT00010                                         01331003
           END-EXEC.                                                    01332003
013400 EJECT                                                            01340000
013500*----------------------------------------------------------------*01350000
013600*  RESEND DIRECTIVES CURSOR                                      *01360000
013700*                                                                *01370000
013800*  THIS CURSOR WILL GATHER THE DIRECTIVES WITHIN A DATE RANGE    *01380000
013900*  FOR A PARTICULAR DC. THESE ARE THE DIRECTIVES TO BE RESENT    *01390000
014000*  VIA CALLS TO THE DIRECTIVE GENERATOR. DIRECTIVES PREVIOUSLY   *01400000
014100*  RESENT ARE EXCLUDED.                                          *01410000
014200*                                                                *01420000
014300*  THE CURSOR READS AS FOLLOWS: SELECT THE DIRECTIVES FOR A      *01430000
014400*  PARTICULAR DC WHERE (1) THE DIRECTIVES WERE NORMAL DIRECTIVES *01440000
014500*  ISSUED DURING A CERTAIN DATE RANGE, AND (2) THE DIRECTIVES DID*01450000
014600*  NOT HAVE NORMAL DIRECTIVES ISSUED AFTER THE DATE RANGE, AND   *01460000
014700*  (3) A DELETE DIRECTIVE IS NOT FOLLOWED BY AN ADD DIRECTIVE    *01470000
014800*  FOR THE SAME BARCODE ISSUED BY THE SAME REQUESTOR PROGRAM     *01480000
014900*  (HENCE, ASSUMING THE DELETE WAS THE PRODUCT OF THE SINGLE     *01490000
015000*  ADD DIRECTIVE REQUEST).                                       *01500000
015100*                                                                *01510000
015200*  A NORMAL DIRECTIVE IS A DIRECTIVE THAT IS NOT A DIRECTIVE     *01520000
015300*  RESENT BY THIS APPLICATION. THAT IS, IT IS A DIRECTIVE SENT   *01530000
015400*  DURING THE NORMAL COURSE OF DC PROCESSING.                    *01540000
015500*                                                                *01550000
015600*  PART (3) IS REQUIRED TO PREVENT RESENDING A DELETE DIRECTIVE  *01560000
015700*  THAT WILL BE AUTOMATICALLY GENERATED BY THE DIRECTIVE GEN-    *01570000
015800*  ERATOR WHEN IT PROCESSES AN ADD DIRECTIVE.                    *01580000
015900*----------------------------------------------------------------*01590000
016000     EXEC SQL                                                     01600000
016100        DECLARE RESEND_DIRECTIVES_CSR CURSOR WITH HOLD FOR        01610000
016200        SELECT A.BRCDE_NBR                                        01620000
016300              ,A.OPER_UNT_ID                                      01630000
016400              ,A.DIRV_RSN_CDE                                     01640000
016500              ,A.AUD_CNTL_NBR                                     01650000
016600              ,A.SHIPT_UNT_ID                                     01660000
016700              ,A.AUD_STAT_CDE                                     01670000
016800              ,A.PO_NBR                                           01680000
016900              ,A.RCVR_SEQ_NBR                                     01690000
017000              ,A.PO_LNE_NBR                                       01700000
017100              ,A.PREPK_ID                                         01710000
017200              ,A.STR_NBR                                          01720000
017300              ,A.CASI_CDE                                         01730000
017400              ,A.CART_STAT_CDE                                    01740000
017500              ,A.AUD_FALR_RSN_NM                                  01750000
017600              ,A.STR_ZN_ID                                        01760000
017700              ,A.SEASET_YR                                        01770000
017800              ,A.SEASET_SHRT_NM                                   01780000
017900              ,A.CRE_BY_USR_ID                                    01790000
018000              ,A.CNVYR_PRC_ACTN_NM                                01800000
018100        FROM   SUT_CART_DIRV_TRKG A                               01810000
018200        WHERE  A.OPER_UNT_ID       = :SUT00102-OPER-UNT-ID        01820000
018300          AND  A.CRE_TMST    BETWEEN :WS-BEGIN-TIMESTAMP          01830000
018400                                 AND :WS-END-TIMESTAMP            01840000
018500          AND  A.CRE_PGM_NM       <> :SUT00102-CRE-PGM-NM         01850000
018600          AND  NOT EXISTS                                         01860000
018700               (                                                  01870000
018800                SELECT *                                          01880000
018900                FROM   SUT_CART_DIRV_TRKG B                       01890000
019000                WHERE  B.BRCDE_NBR   = A.BRCDE_NBR                01900000
019100                  AND  B.CRE_TMST    > :WS-END-TIMESTAMP          01910000
019200                  AND  B.CRE_PGM_NM <> :SUT00102-CRE-PGM-NM       01920000
019300               )                                                  01930000
019400          AND  NOT                                                01940000
019500               (                                                  01950000
019600                    A.CNVYR_PRC_ACTN_NM = 'DELETE'                01960000
019700                AND EXISTS                                        01970000
019800                    (                                             01980000
019900                      SELECT *                                    01990000
020000                      FROM   SUT_CART_DIRV_TRKG C                 02000000
020100                      WHERE  C.BRCDE_NBR = A.BRCDE_NBR            02010000
020200                        AND  C.CRE_TMST  =                        02020000
020300                             (                                    02030000
020400                              SELECT MIN(D.CRE_TMST)              02040000
020500                              FROM   SUT_CART_DIRV_TRKG D         02050000
020600                              WHERE  D.BRCDE_NBR  = A.BRCDE_NBR   02060000
020700                                AND  D.CRE_TMST   > A.CRE_TMST    02070000
020800                                AND  D.CRE_PGM_NM = A.CRE_PGM_NM  02080000
020900                             )                                    02090000
021000                        AND  C.CNVYR_PRC_ACTN_NM = 'ADD'          02100000
021100                    )                                             02110000
021200               )                                                  02120000
021300        ORDER BY CRE_TMST                                         02130000
021400        FOR READ ONLY                                             02140000
021500     END-EXEC.                                                    02150000
021600 EJECT                                                            02160000
021700******************************************************************02170000
021800******************************************************************02180000
021900**             P R O C E D U R E   D I V I S I O N              **02190000
022000******************************************************************02200000
022100******************************************************************02210000
022200 PROCEDURE DIVISION.                                              02220000
022300                                                                  02230000
022400*----------------------------------------------------------------*02240000
022500*  MAINLINE - CONTROLS THE MAIN PROCESSING OF THE PROGRAM.       *02250000
022600*----------------------------------------------------------------*02260000
022700 0000-MAINLINE.                                                   02270000
022800                                                                  02280000
022900**** PERFORM PROGRAM INITIALIZATION.                              02290000
023000                                                                  02300000
023100     PERFORM 1000-INITIALIZE.                                     02310003
023200                                                                  02320000
029200     PERFORM 7000-READ-CONTROL-CARD.                              02321003
023200                                                                  02322003
023300**** FOR EACH CONTROL CARD, RESEND THE DIRECTIVES CHARACTERIZED   02330000
023400**** BY THE PARAMETERS.                                           02340000
023500                                                                  02350000
023600     PERFORM 2000-RESEND-DIRECTIVES                               02360003
023700       UNTIL SURD029-FILE-AT-END.                                 02370003
023800                                                                  02380000
023900**** PERFORM PROGRAM TERMINATION.                                 02390000
024000                                                                  02400000
024100     PERFORM 3000-TERMINATE.                                      02410003
024200                                                                  02420000
024400     STOP RUN.                                                    02440000
024500 EJECT                                                            02450000
024600*----------------------------------------------------------------*02460000
024700*  PROGRAM INITIALIZATION                                        *02470000
024800*----------------------------------------------------------------*02480000
024900 1000-INITIALIZE.                                                 02490000
025000                                                                  02500000
025100**** NOTIFY OF PROGRAM STARTUP.                                   02510000
025200                                                                  02520000
025300     DISPLAY '**************************************************'.02530000
025400     DISPLAY '* PROGRAM '                                         02540000
025500             WS-CURRENT-PROGRAM-NAME                              02550000
025600                               ' BEGINS '                         02560000
025700             FUNCTION CURRENT-DATE                                02570000
025800                                                            '  *'.02580000
025900     DISPLAY '* COMPILED: '                                       02590000
026000             FUNCTION WHEN-COMPILED                               02600000
026100                                              '                *'.02610000
026200     DISPLAY '**************************************************'.02620000
026300     DISPLAY ' '.                                                 02630000
026400                                                                  02640000
026500**** OPEN THE CONTROL FILE. THIS FILE CONTAINS A LIST OF          02650000
026600**** PARAMETERS THAT DEFINE THE DIRECTIVES TO RESEND.             02660000
026700                                                                  02670000
026800     OPEN INPUT  SURD029-CONTROL-FILE                             02680007
026800          OUTPUT SURD104-DIRECTIVE-FILE.                          02681007
026900                                                                  02690000
028300 EJECT                                                            02830000
028400*----------------------------------------------------------------*02840000
028500*  SEND THE DIRECTIVES SPECIFIED BY THE CONTROL FILE PARAMETERS  *02850000
028600*----------------------------------------------------------------*02860000
028700 2000-RESEND-DIRECTIVES.                                          02870000
028800                                                                  02880000
029800**** VALIDATE THE CONTROL CARD.                                   02980000
029900                                                                  02990000
030000     PERFORM 2200-VALIDATE-PARMS.                                 03000003
030100                                                                  03010000
030200**** OPEN THE DIRECTIVES CURSOR. THESE ARE THE DIRECTIVES TO      03020000
030300**** RESEND AS CHARACTERIZED BY THE CONTROL CARD.                 03030000
030400                                                                  03040000
030500     PERFORM 2300-OPEN-DIRECTIVE-CURSOR.                          03050003
030600                                                                  03060000
050700     PERFORM 2400-FETCH-DIRECTIVE.                                03061007
050800                                                                  03062007
030700**** FOR EACH ROW ON THE CURSOR, CALL THE DIRECTIVE GENERATOR     03070000
030800**** TO ISSUE A DIRECTIVE.                                        03080000
030900                                                                  03090000
031000     PERFORM 2500-RESEND-DIRECTIVES                               03100007
031100       UNTIL CURSOR-AT-END.                                       03110000
031200                                                                  03120000
031300**** CLOSE THE DIRECTIVES CURSOR.                                 03130000
031400                                                                  03140000
031500     PERFORM 2600-CLOSE-DIRECTIVE-CURSOR.                         03150007
031600                                                                  03160000
029200     PERFORM 7000-READ-CONTROL-CARD.                              03170011
031900 EJECT                                                            03190000
035100*----------------------------------------------------------------*03510000
035200*  VALIDATE THE CONTROL CARD PARAMETERS                          *03520000
035300*----------------------------------------------------------------*03530000
035400 2200-VALIDATE-PARMS.                                             03540000
035500                                                                  03550000
035600**** VALIDATE THE DC NUMBER                                       03560000
035700                                                                  03570000
035800     PERFORM 2210-VALIDATE-DC.                                    03580003
035900                                                                  03590000
036000**** VALIDATE THE DATE RANGE                                      03600000
036100                                                                  03610000
036200     PERFORM 2220-VALIDATE-DATES.                                 03620003
036300                                                                  03630000
036600 EJECT                                                            03660000
036700*----------------------------------------------------------------*03670000
036800*  VALIDATE THE DC NUMBER                                        *03680000
036900*----------------------------------------------------------------*03690000
037000 2210-VALIDATE-DC.                                                03700000
037100                                                                  03710000
037200     MOVE SU029-OPER-UNT-ID TO XLT00010-LOC-NBR.                  03720000
037300                                                                  03730000
037400     EXEC SQL                                                     03740000
037500        SELECT LOC_TYP_CDE                                        03750000
037600        INTO   :XLT00010-LOC-TYP-CDE                              03760000
037700        FROM   XLT_LOC                                            03770000
037800        WHERE  LOC_NBR     = :XLT00010-LOC-NBR                    03780000
037900          AND  LOC_TYP_CDE = 'DC'                                 03790000
038000     END-EXEC.                                                    03800000
038100                                                                  03810000
038200     EVALUATE TRUE                                                03820000
038300        WHEN SQLCODE = +0                                         03830000
038400           CONTINUE                                               03840000
038500        WHEN SQLCODE = +100                                       03850000
038600           DISPLAY '*!*!*!*!*! ABEND 04 !*!*!*!*!*!*!*!*!*!*'     03860000
038700           DISPLAY '*! INVALID DC NUMBER ON CONTROL FILE. !*'     03870000
038800           DISPLAY '*! DC NUMBER: '                               03880000
038900                   SU029-OPER-UNT-ID                              03890000
039000                                     '                    !*'     03900000
039100           DISPLAY '*!*!*!*!*! ABEND 04 !*!*!*!*!*!*!*!*!*!*'     03910000
039200           MOVE '2210-VALIDATE-DC' TO WS-PARAGRAPH-NAME           03920000
039300           PERFORM 9100-SQL-ABEND                                 03930003
039400        WHEN SQLCODE  > 0                                         03940000
039500        WHEN SQLWARN0 = 'W'                                       03950000
039600           DISPLAY '*!*!*!*!*! ABEND 05 !*!*!*!*!*!*!*!*!*!*!*'   03960000
039700           DISPLAY '*! WARNING ISSUED ON SELECT OF XLT_LOC  !*'   03970000
039800           DISPLAY '*! LOCATION: '                                03980000
039900                   XLT00010-LOC-NBR '                       !*'   03990000
040000           DISPLAY '*!*!*!*!*! ABEND 05 !*!*!*!*!*!*!*!*!*!*!*'   04000000
040100           MOVE '2210-VALIDATE-DC' TO WS-PARAGRAPH-NAME           04010000
040200           PERFORM 9100-SQL-ABEND                                 04020003
040300        WHEN SQLCODE < 0                                          04030000
040400           DISPLAY '*!*!*!*!*! ABEND 06 !*!*!*!*!*!*!*!*!*!*!*'   04040000
040500           DISPLAY '*! ERROR ISSUED ON SELECT OF XLT_LOC'         04050000
040600           DISPLAY '*! LOCATION: '                                04060000
040700                   XLT00010-LOC-NBR '                       !*'   04070000
040800           DISPLAY '*!*!*!*!*! ABEND 06 !*!*!*!*!*!*!*!*!*!*!*'   04080000
040900           MOVE '2210-VALIDATE-DC' TO WS-PARAGRAPH-NAME           04090000
041000           PERFORM 9100-SQL-ABEND                                 04100003
041100     END-EVALUATE.                                                04110000
041200                                                                  04120000
041500 EJECT                                                            04150000
041600*----------------------------------------------------------------*04160000
041700*  VALIDATE THE DATE RANGE                                       *04170000
041800*----------------------------------------------------------------*04180000
041900 2220-VALIDATE-DATES.                                             04190000
042000                                                                  04200000
042100**** VALIDATE THE BEGIN TIMESTAMP                                 04210000
042200                                                                  04220000
042300     MOVE SU029-TMST-BEGIN TO WS-TIMESTAMP.                       04230000
042400                                                                  04240000
042500     PERFORM 2221-VALIDATE-TIMESTAMP.                             04250003
042600                                                                  04260000
042700**** VALIDATE THE END TIMESTAMP                                   04270000
042800                                                                  04280000
042900     MOVE SU029-TMST-END   TO WS-TIMESTAMP.                       04290000
043000                                                                  04300000
043100     PERFORM 2221-VALIDATE-TIMESTAMP.                             04310003
043200                                                                  04320000
043500 EJECT                                                            04350000
043600*----------------------------------------------------------------*04360000
043700*  VALDIATE A TIMESTAMP                                          *04370000
043800*----------------------------------------------------------------*04380000
043900 2221-VALIDATE-TIMESTAMP.                                         04390000
044000                                                                  04400000
044100**** VALIDATE THE TENDERED TIMESTAMP                              04410000
044200                                                                  04420000
044300     EXEC SQL                                                     04430000
044400        SET :WS-TIMESTAMP = TIMESTAMP(:WS-TIMESTAMP)              04440000
044500     END-EXEC.                                                    04450000
044600                                                                  04460000
044700     EVALUATE TRUE                                                04470000
044800        WHEN SQLCODE = +0                                         04480000
044900           CONTINUE                                               04490000
045000        WHEN OTHER                                                04500000
045100           DISPLAY '*!*!*!*!*! ABEND 07 !*!*!*!*!*!*'             04510000
045200           DISPLAY '*! PARAMETER DATE IN ERROR.   !*'             04520000
045300           DISPLAY '*! '                                          04530000
045400                   WS-TIMESTAMP                 ' !*'             04540000
045500           DISPLAY '*!*!*!*!*! ABEND 07 !*!*!*!*!*!*'             04550000
045600           MOVE '2221-VALIDATE-TIMESTAMP' TO WS-PARAGRAPH-NAME    04560000
045700           PERFORM 9100-SQL-ABEND                                 04570003
045800     END-EVALUATE.                                                04580000
045900                                                                  04590000
046200 EJECT                                                            04620000
046300*----------------------------------------------------------------*04630000
046400*  OPEN THE CURSOR THAT WILL GATHER ALL THE DIRECTIVES TO BE     *04640000
046500*  RESENT.                                                       *04650000
046600*----------------------------------------------------------------*04660000
046700 2300-OPEN-DIRECTIVE-CURSOR.                                      04670000
046800                                                                  04680000
046900**** SETUP THE KEYS. WE WANT TO EXCLUDE DIRECTIVES WHERE THE      04690014
047000**** CRE-PGM-NM ON SUT_CART_DIRV_TRKG IS 'RESEND', INDICATING THE 04700014
047100**** DIRECTIVE HAD BEEN SENT AGAIN USING THE BATCH PROCESS.  WE   04710014
047100**** DO NOT WANT TO RESEND ANY DIRECTIVES THAT HAVE ALREADY BEEN  04710114
046900**** RESENT.                                                      04711014
047200                                                                  04720000
047300     MOVE SU029-OPER-UNT-ID         TO SUT00102-OPER-UNT-ID.      04730011
047400     MOVE SU029-TMST-BEGIN          TO WS-BEGIN-TIMESTAMP.        04740011
047500     MOVE SU029-TMST-END            TO WS-END-TIMESTAMP.          04750011
047600     MOVE WS-RESEND                 TO SUT00102-CRE-PGM-NM.       04760014
047700                                                                  04770000
047800**** OPEN THE CURSOR.                                             04780000
047900                                                                  04790000
048000     EXEC SQL                                                     04800000
048100        OPEN RESEND_DIRECTIVES_CSR                                04810000
048200     END-EXEC.                                                    04820000
048300                                                                  04830000
048400     EVALUATE TRUE                                                04840000
048500        WHEN SQLCODE = +0                                         04850000
048600           SET CURSOR-NOT-AT-END     TO TRUE                      04860000
048700           INITIALIZE WS-DIRECTIVES-FETCHED                       04870000
048800        WHEN OTHER                                                04880000
048900           DISPLAY '*!*!*!*!*! ABEND 08 !*!*!*!*!*!*!*!*!*'       04890000
049000           DISPLAY '*! ERROR OPENING DIRECTIVES CURSOR. !*'       04900000
049100           DISPLAY '*!*!*!*!*! ABEND 08 !*!*!*!*!*!*!*!*!*'       04910000
049200           MOVE '2300-OPEN-DIRECTIVE-CURSOR' TO WS-PARAGRAPH-NAME 04920000
049300           PERFORM 9100-SQL-ABEND                                 04930003
049400     END-EVALUATE.                                                04940000
049500                                                                  04950000
049800 EJECT                                                            04980000
052400*----------------------------------------------------------------*04981007
052500*  FETCH A DIRECTIVE TO BE RESENT                                *04982007
052600*----------------------------------------------------------------*04983007
052700 2400-FETCH-DIRECTIVE.                                            04984007
052800                                                                  04985007
052900     EXEC SQL                                                     04986007
053000        FETCH RESEND_DIRECTIVES_CSR                               04987007
053100        INTO  :SUT00102-BRCDE-NBR                                 04988007
053200             ,:SUT00102-OPER-UNT-ID                               04989007
053300             ,:SUT00102-DIRV-RSN-CDE                              04989107
053400             ,:SUT00102-AUD-CNTL-NBR                              04989207
053500             ,:SUT00102-SHIPT-UNT-ID                              04989307
053600             ,:SUT00102-AUD-STAT-CDE                              04989407
053700             ,:SUT00102-PO-NBR                                    04989507
053800             ,:SUT00102-RCVR-SEQ-NBR                              04989607
053900             ,:SUT00102-PO-LNE-NBR                                04989707
054000             ,:SUT00102-PREPK-ID                                  04989807
054100             ,:SUT00102-STR-NBR                                   04989907
054200             ,:SUT00102-CASI-CDE                                  04990007
054300             ,:SUT00102-CART-STAT-CDE                             04990107
054400             ,:SUT00102-AUD-FALR-RSN-NM                           04990207
054500             ,:SUT00102-STR-ZN-ID                                 04990307
054600             ,:SUT00102-SEASET-YR                                 04990407
054700             ,:SUT00102-SEASET-SHRT-NM                            04990507
054800             ,:SUT00102-CRE-BY-USR-ID                             04990607
054900             ,:SUT00102-CNVYR-PRC-ACTN-NM                         04990707
055000     END-EXEC.                                                    04990807
055100                                                                  04990907
055200     EVALUATE TRUE                                                04991007
055300        WHEN SQLCODE = +0                                         04991107
055400           ADD 1 TO WS-DIRECTIVES-FETCHED                         04991207
055500        WHEN SQLCODE = +100                                       04991307
055600           SET CURSOR-AT-END TO TRUE                              04991407
055700        WHEN OTHER                                                04991507
055800           DISPLAY '*!*!*!*!*! ABEND 09 !*!*!*!*!*!*!*!*!*'       04991607
055900           DISPLAY '*! ERROR FETCHING DIRECTIVES CURSOR.!*'       04991707
056000           DISPLAY '*!*!*!*!*! ABEND 09 !*!*!*!*!*!*!*!*!*'       04991807
056100           MOVE '2400-FETCH-DIRECTIVE' TO WS-PARAGRAPH-NAME       04991907
056200           PERFORM 9100-SQL-ABEND                                 04992007
056300     END-EVALUATE.                                                04992107
056400                                                                  04992207
049900*----------------------------------------------------------------*04993000
050000*  RESEND THE DIRECTIVES GATHERED IN THE DIRECTIVES WRITING      *05000013
050100*  DIRECTIVE MESSAGE RECORDS TO AN OUTPUT FILE.  THIS FILE WILL  *05010013
050100*  BE READ BY SUKUT135 WHERE THE DIRECTIVE GENERATOR PROGRAM     *05011013
050100*  WILL BE CALLED TO RESEND THE DIRECTIVE MESSAGES.              *05012013
050200*----------------------------------------------------------------*05020013
050300 2500-RESEND-DIRECTIVES.                                          05030007
050400                                                                  05040000
051300**** FORMAT THE DIRECTIVE MESSAGE COPYBOOK                        05130013
051400                                                                  05140000
051500     PERFORM 2550-FORMAT-DIRECTIVE-REC.                           05150007
051600                                                                  05160000
051500     PERFORM 8000-WRITE-DIRECTIVE-REC.                            05170007
051600                                                                  05180007
050700     PERFORM 2400-FETCH-DIRECTIVE.                                05201007
052000                                                                  05202007
052300 EJECT                                                            05230000
056800*----------------------------------------------------------------*05680000
056900*  FORMAT THE DIRECTIVE OUTPUT RECORD                            *05690007
057000*----------------------------------------------------------------*05700000
057100 2550-FORMAT-DIRECTIVE-REC.                                       05710007
057200                                                                  05720000
057500     INITIALIZE SU104-DIRECTIVE-RESEND-RECORD.                    05750007
057600                                                                  05760000
058000     SET SU104-CARTON-DIRECTIVE TO TRUE.                          05800007
058400     MOVE SUT00102-CNVYR-PRC-ACTN-NM                              05840012
058400                                   TO SU104-CNVYR-PRC-ACTN-NM.    05841012
060400     MOVE SUT00102-BRCDE-NBR       TO SU104-P2L-BRCDE-NBR.        06041012
060500     MOVE SUT00102-OPER-UNT-ID     TO SU104-OPER-UNT-ID.          06050007
060600     MOVE SUT00102-DIRV-RSN-CDE    TO SU104-DIRV-RSN-CDE.         06060007
060700     MOVE SUT00102-AUD-CNTL-NBR    TO SU104-AUD-CNTL-NBR.         06070007
060800     MOVE SUT00102-SHIPT-UNT-ID    TO SU104-SML-BRCDE-NBR.        06080007
060900     MOVE SUT00102-AUD-STAT-CDE    TO SU104-AUD-STAT-CDE.         06090007
061000     MOVE SUT00102-PO-NBR          TO SU104-PO-NBR.               06100007
061100     MOVE SUT00102-RCVR-SEQ-NBR    TO SU104-RCVR-SEQ-NBR.         06110007
061200     MOVE SUT00102-PO-LNE-NBR      TO SU104-PO-LNE-NBR.           06120007
061300     MOVE SUT00102-PREPK-ID        TO SU104-PO-PREPK-ID.          06130007
061400     MOVE SUT00102-STR-NBR         TO SU104-STR-NBR.              06140007
061500     MOVE SUT00102-CASI-CDE        TO SU104-CASI-CDE.             06150007
061600     MOVE SUT00102-CART-STAT-CDE   TO SU104-CART-STAT-CDE.        06160007
061700     MOVE SUT00102-AUD-FALR-RSN-NM TO SU104-AUD-FAIL-RSN.         06170007
061800     MOVE SUT00102-STR-ZN-ID       TO SU104-STR-ZN.               06180007
061900     MOVE SUT00102-SEASET-YR       TO SU104-SEASET-YR.            06190007
062000     MOVE SUT00102-SEASET-SHRT-NM  TO SU104-SEASET-CDE.           06200007
062100     MOVE SUT00102-CRE-BY-USR-ID   TO SU104-ASSOC-ID.             06210007
062200                                                                  06220000
062500 EJECT                                                            06250000
064700*----------------------------------------------------------------*06470000
064800*  CLOSE THE CURSOR THAT GATHERS ALL THE DIRECTIVES TO BE        *06480007
064900*  RESENT.                                                       *06490000
065000*----------------------------------------------------------------*06500000
065100 2600-CLOSE-DIRECTIVE-CURSOR.                                     06510007
065200                                                                  06520000
065300     EXEC SQL                                                     06530000
065400        CLOSE RESEND_DIRECTIVES_CSR                               06540000
065500     END-EXEC.                                                    06550000
065600                                                                  06560000
065700     EVALUATE TRUE                                                06570000
065800        WHEN SQLCODE = +0                                         06580000
065900           SET CURSOR-NOT-AT-END TO TRUE                          06590000
066000        WHEN OTHER                                                06600000
066100           DISPLAY '*!*!*!*!*! ABEND 11 !*!*!*!*!*!*!*!*!*'       06610000
066200           DISPLAY '*! ERROR CLOSING DIRECTIVES CURSOR. !*'       06620000
066300           DISPLAY '*!*!*!*!*! ABEND 11 !*!*!*!*!*!*!*!*!*'       06630000
066400           MOVE '2600-CLOSE-DIRECTIVE-CURSOR' TO WS-PARAGRAPH-NAME06640007
066500           PERFORM 9100-SQL-ABEND                                 06650003
066600     END-EVALUATE.                                                06660000
066700                                                                  06670000
066800**** DISPLAY RUN STATS FOR THIS PARAMETER RECORD                  06680000
066900                                                                  06690000
067000     DISPLAY WS-DIRECTIVES-FETCHED                                06700000
067100             ' DIRECTIVES RESENT FOR DC '                         06710000
067200             SU029-OPER-UNT-ID                                    06720000
067300             ' BETWEEN '                                          06730000
067400             SU029-TMST-BEGIN                                     06740000
067500             ' AND '                                              06750000
067600             SU029-TMST-END.                                      06760000
067700                                                                  06770000
068000 EJECT                                                            06800000
068100*----------------------------------------------------------------*06810000
068200*  PROGRAM TERMINATION                                           *06820000
068300*----------------------------------------------------------------*06830000
068400 3000-TERMINATE.                                                  06840000
068500                                                                  06850000
068600**** CLOSE THE CONTROL FILE AND OUTPUT DIRECTIVE FILE             06860007
068700                                                                  06870000
 68800     CLOSE SURD029-CONTROL-FILE                                   06880007
 68800           SURD104-DIRECTIVE-FILE.                                06881007
068900                                                                  06890000
070100**** DISPLAY RUN STATS                                            07010000
070200                                                                  07020000
070300     PERFORM 3100-DISPLAY-RUN-STATS.                              07030003
070400                                                                  07040000
070500**** NOTIFY OF PROGRAM SHUTDOWN.                                  07050000
070600                                                                  07060000
070700     DISPLAY ' '.                                                 07070000
070800     DISPLAY '**************************************************'.07080000
070900     DISPLAY '* PROGRAM '                                         07090000
071000             WS-CURRENT-PROGRAM-NAME                              07100000
071100                               ' ENDS '                           07110000
071200             FUNCTION CURRENT-DATE                                07120000
071300                                                          '    *'.07130000
071400     DISPLAY '**************************************************'.07140000
071500                                                                  07150000
071600 3000-EXIT.                                                       07160000
071700     EXIT.                                                        07170000
071800 EJECT                                                            07180000
071900******************************************************************07190000
072000* DISPLAY THE RUNSTATS                                           *07200000
072100******************************************************************07210000
072200 3100-DISPLAY-RUN-STATS.                                          07220000
072300                                                                  07230000
072400     DISPLAY ' '.                                                 07240000
072500     DISPLAY 'CONTROL CARDS READ....: ' WS-CNTRL-RECS-READ.       07250008
072500     DISPLAY 'DIRECTIVE RECS WRITTEN: ' WS-DIRECTIVE-RECS-WRITTEN.07260008
072700                                                                  07270008
072800 3100-EXIT.                                                       07280000
072900     EXIT.                                                        07290000
073000 EJECT                                                            07300000
032000*----------------------------------------------------------------*07301007
032100*  READ THE CONTROL FILE                                         *07302007
032200*----------------------------------------------------------------*07303007
032300 7000-READ-CONTROL-CARD.                                          07304007
032400                                                                  07305007
032500     READ SURD029-CONTROL-FILE                                    07306007
               INTO SURD029-RECORD                                      07307007
080100            AT END SET SURD029-FILE-AT-END TO TRUE.               07308007
032600                                                                  07309007
032700     IF  SURD029-FILE-NOT-AT-END                                  07309107
032900           ADD 1 TO WS-CNTRL-RECS-READ                            07309207
032700     END-IF.                                                      07309307
034700                                                                  07309407
035000 EJECT                                                            07309507
022116******************************************************************07309608
022117* WRITES TO THE OUTPUT FILE                                       07309708
022118******************************************************************07309808
022119 8000-WRITE-DIRECTIVE-REC.                                        07309908
022120                                                                  07310008
022121     WRITE SURD104-DIRECTIVE-RECORD                               07310108
022122        FROM SU104-DIRECTIVE-RESEND-RECORD.                       07310208
032600                                                                  07310308
022123     ADD +1  TO  WS-DIRECTIVE-RECS-WRITTEN.                       07310408
022124                                                                  07310508
035000 EJECT                                                            07310608
073100******************************************************************07311000
073200* PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    *07320000
073300* ERROR OR WARNING CODE OCCURS.                                  *07330000
073400******************************************************************07340000
073500******************************************************************07350000
073600* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *07360000
073700* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *07370000
073800* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *07380000
073900* FORMAT.                                                        *07390000
074000******************************************************************07400000
074100 9100-SQL-ABEND.                                                  07410000
074200                                                                  07420000
074300     PERFORM 3100-DISPLAY-RUN-STATS.                              07430003
074400                                                                  07440000
074500     COPY DPPD004.                                                07450000
074600                                                                  07460000
074700     MOVE +4013 TO WS-ABEND-CODE.                                 07470000
074800     CALL 'ILBOABN0' USING WS-ABEND-CODE.                         07480000
074900                                                                  07490000
075000 9100-EXIT.                                                       07500000
075100     EXIT.                                                        07510000
075200 EJECT                                                            07520000
075300******************************************************************07530000
075400* 9999-ABEND                                                      07540000
075500*     ABEND PROGRAM WHEN AN ERROR OCCURS.                         07550000
075600******************************************************************07560000
075700 9999-ABEND.                                                      07570000
075800                                                                  07580000
075900     PERFORM 3100-DISPLAY-RUN-STATS.                              07590003
076000                                                                  07600000
076100     DISPLAY '** ABEND           **'.                             07610000
076200     DISPLAY '** PROGRAM         ** = ' WS-CURRENT-PROGRAM-NAME.  07620000
076300     DISPLAY '** PARAGRAPH       ** = ' WS-PARAGRAPH-NAME.        07630000
076400                                                                  07640000
076500     CALL 'ILBOABN0' USING WS-AC-ABEND-CODE.                      07650000
076600                                                                  07660000
076700 9999-EXIT.                                                       07670000
076800     EXIT.                                                        07680000
