000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT070.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800* ************************************************************** *00080000
000900* * AHKUT070.  "ARCHIVE HISTORY" PROJECT.  EXTRACT PROGRAM.    * *00090000
001000* *                                                            * *00100000
001100* * PURPOSE:                                                   * *00110000
001200* * THIS PROGRAM CREATES AN EXTRACT FILE FROM: TTRBDTL.        * *00120000
001300* * THIS EXTRACT FILE CONSISTS OF ROWS ELIGIBLE TO BE:         * *00130000
001400* * 1) LOADED TO THE "ARCHIVE/HISTORY" VERSIONS OF THE TABLES. * *00140000
001500* * 2) DELETED FROM THE OPERATIONAL VERSIONS OF THE TABLES.    * *00150000
001600* *                                                            * *00160000
001700* * PROCESSING OVERVIEW:                                       * *00170000
001800* * THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,  * *00180000
001900* * 1) INCREMENT COUNT OF RECORDS READ.                        * *00190000
002000* * 2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE.            * *00200000
002100* *    2.A) IF NO MATCH(ES):                                   * *00210000
002200* *         2.A.1) PROCESSING CONTINUES                        * *00220000
002300* *         2.A.2) DO NOT PERFORM ERROR/REPORTING ROUTINES;    * *00230000
002400* *                THIS SYSTEM DOES NOT CLEANSE DATA NOR REPORT* *00240000
002500* *                ON UNCLEAN DATA.  IT SIMPLY MIGRATES        * *00250000
002600* *                CONDITIONS OCCURRING IN OPERATIONAL         * *00260000
002700* *                TABLES OVER TO THE ARCHIVE/HISTORY TABLES.  * *00270000
002800* *    2.B) IF MATCH(ES):                                      * *00280000
002900* *         2.B.1) INCREMENT COUNT OF ROW(S) FOUND.            * *00290000
003000* *         2.B.2) WRITE THESE ROW(S) TO THE EXTRACT FILE.     * *00300000
003100* *         2.B.3) INCREMENT COUNT OF RECORDS WRITTEN.         * *00310000
003200* *         2.B.4) DO NOT REMOVE THE ROW(S) FROM THE TABLE     * *00320000
003300* *                AT THIS TIME.  THEY WILL BE REMOVED IN OTHER* *00330000
003400* *                PROCESSING, AFTER HAVING BEEN LOADED TO THE * *00340000
003500* *                ARCHIVE/HISTORY TABLE.                      * *00350000
003600* * 3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *00360000
003700* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *00370000
003800* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *00380000
003900* ************************************************************** *00390000
004000 ENVIRONMENT DIVISION.                                            00400000
004100 CONFIGURATION SECTION.                                           00410000
004200 SOURCE-COMPUTER.        IBM-3090.                                00420000
004300 OBJECT-COMPUTER.        IBM-3090.                                00430000
004400                                                                  00440000
004500 INPUT-OUTPUT SECTION.                                            00450000
004600 FILE-CONTROL.                                                    00460000
004700                                                                  00470000
004800     SELECT IN-DRIVER-FILE                ASSIGN TO IN01.         00480000
004900     SELECT OUT-EXTRACT-FILE              ASSIGN TO OUT01.        00490000
005000                                                                  00500000
005100******************************************************************00510000
005200 DATA DIVISION.                                                   00520000
005300 FILE SECTION.                                                    00530000
005400                                                                  00540000
005500 FD  IN-DRIVER-FILE                                               00550000
005600     RECORDING MODE IS F                                          00560000
005700     LABEL RECORDS ARE STANDARD                                   00570000
005800     BLOCK CONTAINS 0 RECORDS.                                    00580000
005900 01  IN-DRIVER-RECORD                PIC  X(247).                 00590005
006000                                                                  00600000
006100**** TTRBDTL:                                                     00610000
006200 FD  OUT-EXTRACT-FILE                                             00620000
006300     RECORDING MODE IS F                                          00630000
006400     LABEL RECORDS ARE STANDARD                                   00640000
006500     BLOCK CONTAINS 0 RECORDS.                                    00650000
006600 01  OUT-EXTRACT-RECORD              PIC  X(290).                 00660000
006700                                                                  00670000
006800                                                                  00680000
006900                                                                  00690000
007000 WORKING-STORAGE SECTION.                                         00700000
007100                                                                  00710000
007200 01  PC-PROGRAM-CONSTANTS.                                        00720000
007300     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT070'.  00730000
007400     05  PC-PGM-PROGRESS-DESC.                                    00740000
007500         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00750000
007600         10  PC-CONTINUING           PIC X(10) VALUE              00760000
007700                                               'CONTINUING'.      00770000
007800         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00780000
007900         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00790000
008000     05  PC-ABEND-INFO.                                           00800000
008100         10  PC-ABEND                PIC X(11) VALUE              00810000
008200                                               '** ABEND **'.     00820000
008300         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00830000
008400                                               '- PARA       : '. 00840000
008500         10  PC-ABEND-MSG-DISPLAY-PARA                            00850000
008600                                     PIC X(15) VALUE              00860000
008700                                               '  CALLED PARA: '. 00870000
008800         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00880000
008900                                               '  FOR ABEND# : '. 00890000
009000         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00900000
009100                                               '- ERROR IS   : '. 00910000
009200         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00920000
009300         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00930000
009400                                               '- ACTION     : '. 00940000
009500     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 5000.        00950000
009600                                                                  00960000
009700 01  PS-PROGRAM-SWITCHES.                                         00970000
009800     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         00980000
009900         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         00990000
010000         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01000000
010100     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01010006
010200         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01020006
010300         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01030006
010400     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         01040000
010500         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         01050000
010600         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         01060000
010700                                                                  01070000
010800 01  PV-PROGRAM-VARIABLES.                                        01080000
011010     05  PV-NOTIF-NBR-COMP           PIC S9(9) VALUE 0 COMP.      01101000
011020     05  PV-NOTIF-NBR-NUM            PIC  9(9) VALUE 0.           01102000
011100     05  PV-IN-DRIVER-RECS-READ-CNT  PIC  9(9) VALUE 0.           01110000
011200     05  PV-RECS-WITH-MATCHES-CNT    PIC  9(9) VALUE 0.           01120000
011300     05  PV-TABLE-ROW-SELECT-CNT     PIC  9(9) VALUE 0.           01130000
011400     05  PV-EXTRACT-WRITTEN-CNT      PIC  9(9) VALUE 0.           01140000
011500                                                                  01150000
011600     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01160000
011700     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01170000
011800     05  PV-DB2-TABLE-NAME           PIC X(18) VALUE SPACES.      01180000
011900     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01190000
012000     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01200000
012100     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01210000
012200                                                                  01220000
012300     05  PV-TMST                     PIC X(26) VALUE SPACES.      01230000
012400     05  PV-TIMESTAMP-DETAIL                                      01240000
012500         REDEFINES                                                01250000
012600         PV-TMST.                                                 01260000
012700         10  PV-TIMESTAMP-19.                                     01270000
012800             15  PV-TMS-DATE.                                     01280000
012900                 20  PV-TMS-YEAR.                                 01290000
013000                     25  PV-TMS-CC   PIC X(02).                   01300000
013100                     25  PV-TMS-YY   PIC X(02).                   01310000
013200                 20  FILLER          PIC X(01).                   01320000
013300                 20  PV-TMS-MONTH    PIC X(02).                   01330000
013400                 20  FILLER          PIC X(01).                   01340000
013500                 20  PV-TMS-DAY      PIC X(02).                   01350000
013600             15  FILLER              PIC X(01).                   01360000
013700             15  PV-TMS-HOUR         PIC X(02).                   01370000
013800             15  FILLER              PIC X(01).                   01380000
013900             15  PV-TMS-MINUTE       PIC X(02).                   01390000
014000             15  FILLER              PIC X(01).                   01400000
014100             15  PV-TMS-SECOND       PIC X(02).                   01410000
014200         10  FILLER                  PIC X(01).                   01420000
014300         10  PV-TMS-MSECOND          PIC X(06).                   01430000
014400                                                                  01440000
014500 01  DM-DISPLAY-MESSAGE.                                          01450000
014600     05  DM-01-10.                                                01460000
014700         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01470000
014800         10  FILLER                  PIC X(02) VALUE ': '.        01480000
014900     05  DM-11-80.                                                01490000
015000         10  FILLER                  PIC X(37) VALUE              01500000
015100                        'SELECT ROWS MATCHING PO DRIVER FILE, '.  01510000
015200         10  FILLER                  PIC X(30) VALUE              01520000
015300                        'CREATING TTRBDTL EXTRACT FILE.'.         01530000
015400         10  FILLER                  PIC X(01) VALUE SPACE.       01540000
015500         10  FILLER                  PIC X(01) VALUE ALL '*'.     01550000
015600     05  DM-81-120.                                               01560000
015700         10  FILLER                  PIC X(40) VALUE ALL '*'.     01570000
015800                                                                  01580000
015900 01  DP-DISPLAY-PROGRESS-MSG.                                     01590000
016000     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01600000
016100     05  FILLER                      PIC X(02) VALUE SPACE.       01610000
016200     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01620000
016300     05  FILLER                      PIC X(04) VALUE ' AT '.      01630000
016400     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01640000
016500     05  FILLER                      PIC X(03) VALUE '.  '.       01650000
016600     05  FILLER                      PIC X(03) VALUE              01660000
016700                                         'IN:'.                   01670000
016800     05  DP-IN-CNT                   PIC ZZZ,ZZZ,ZZ9              01680000
016900                                               VALUE ZERO.        01690000
017000     05  FILLER                      PIC X(02) VALUE ', '.        01700000
017100*    05  FILLER                      PIC X(16) VALUE              01710000
017200*                                        'DRIVER W/ROW(S):'.      01720000
017300*    05  DP-MATCHES-FOUND-CNT        PIC ZZZ,ZZZ,ZZ9              01730000
017400*                                              VALUE ZERO.        01740000
017500*    05  FILLER                      PIC X(02) VALUE ', '.        01750000
017600     05  FILLER                      PIC X(14) VALUE              01760000
017700                                         'ROWS SELECTED:'.        01770000
017800     05  DP-ROWS-SELECTED-CNT        PIC ZZZ,ZZZ,ZZ9              01780000
017900                                               VALUE ZERO.        01790000
018000     05  FILLER                      PIC X(02) VALUE ', '.        01800000
018100     05  FILLER                      PIC X(04) VALUE              01810000
018200                                         'OUT:'.                  01820000
018300     05  DP-OUT-CNT                  PIC ZZZ,ZZZ,ZZ9              01830000
018400                                               VALUE ZERO.        01840000
018500     05  FILLER                      PIC X(01) VALUE '.'.         01850000
018600                                                                  01860000
018700 01  ABEND-CODE                      PIC S9(04)                   01870000
018800                                               VALUE ZEROES       01880000
018900                                               COMP SYNC.         01890000
019000                                                                  01900000
019100*---------------------------------------------------------------* 01910000
019200*  DB2 FORMATTED MESSAGE AREA                                     01920000
019300*---------------------------------------------------------------* 01930000
019400     COPY DPWS004.                                                01940000
019500                                                                  01950000
019600                                                                  01960000
019700*---------------------------------------------------------------* 01970000
019800*  AHRD006  - RECORD LAYOUT FOR TROUBLE DRIVER FILE, INPUT.     * 01980001
019900*---------------------------------------------------------------* 01990000
020000     COPY AHRD006.                                                02000001
020100                                                                  02010000
020200                                                                  02020000
020300*---------------------------------------------------------------* 02030000
020400*    DB2 AREA FOR TTRBDTL                                       * 02040000
020500*---------------------------------------------------------------* 02050000
020600     EXEC SQL                                                     02060000
020700          INCLUDE TTRBDTL                                         02070000
020800     END-EXEC.                                                    02080000
020900                                                                  02090000
021000*---------------------------------------------------------------* 02100000
021100*    DB2 AREA FOR COMMUNICATIONS                                * 02110000
021200*---------------------------------------------------------------* 02120000
021300     EXEC SQL                                                     02130000
021400          INCLUDE SQLCA                                           02140000
021500     END-EXEC.                                                    02150000
021600                                                                  02160000
021700*---------------------------------------------------------------* 02170006
021800*    DEFINE CURSOR FOR TTRBDTL :                                * 02180006
021900*    PULL ALL AVAILABLE COLUMNS, SO EXTRACT FILE WILL CONTAIN   * 02190006
022000*    ALL DATA TO POPULATE "ARCHIVE HISTORY" COPY OF THIS TABLE. * 02200006
022100*---------------------------------------------------------------* 02210006
022200     EXEC SQL                                                     02220006
022300          DECLARE TABLE-CURSOR CURSOR FOR                         02230006
022400            SELECT NOTIF_NBR                                      02240006
022410                ,  CRE_TMST                                       02241006
022420                ,  CRE_UID                                        02242006
022421                ,  FREEFORM_TEXT                                  02242106
022426            FROM   TTRBDTL                                        02242606
022427             WHERE  (NOTIF_NBR = :PV-NOTIF-NBR-COMP)              02242706
022428            FOR  FETCH ONLY                                       02242806
022429           WITH  UR                                               02242906
022430     END-EXEC.                                                    02243006
022431                                                                  02243100
022432 PROCEDURE DIVISION.                                              02243200
022440********************                                              02244000
022450                                                                  02245000
022460 0000-PROGRAM-MAINLINE.                                           02246000
022470                                                                  02247000
022480     PERFORM 1000-INITIALIZE.                                     02248000
022490                                                                  02249000
022500     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02250000
022600     PERFORM 2000-PROCESS-DRIVER-FILE                             02260000
022700         UNTIL PS-IN-DRIVER-EOF.                                  02270000
022800                                                                  02280000
022900     PERFORM 6000-EOJ-ROUTINE.                                    02290000
023000     STOP RUN.                                                    02300000
023100                                                                  02310000
023200                                                                  02320000
023300* ************************************************************** *02330000
023400* * INITIALIZATIONS                                            * *02340000
023500* ************************************************************** *02350000
023600 1000-INITIALIZE.                                                 02360000
023700                                                                  02370000
023800     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02380000
023900     DISPLAY DM-DISPLAY-MESSAGE.                                  02390000
024000                                                                  02400000
024100     MOVE PC-BEGINNING              TO DP-STATUS-DESCRIPTION.     02410000
024200     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02420000
024300                                                                  02430000
024400     PERFORM 9000-OPEN-IN-DRIVER-FILE.                            02440000
024500     PERFORM 9700-OPEN-OUT-EXTRACT-FILE.                          02450000
024600                                                                  02460000
024700                                                                  02470000
024800* ************************************************************** *02480000
024900* * 1) GET NEXT RECORD FROM DRIVER FILE, AND                   * *02490000
025000* *    1A- POPULATE KEY (WHERE CLAUSE) FOR TABLE SELECT        * *02500000
025200* *    1B- EXTRACT THE ROWS FOR THE INPUT DRIVER RECORD        * *02520000
025400* *    2) FOR EACH ROW,                                        * *02540000
025500* *       2A- INCREMENT COUNTS                                 * *02550000
025600* *       2B- WRITE EXTRACT RECORD                             * *02560000
025800* ************************************************************** *02580000
025900 2000-PROCESS-DRIVER-FILE.                                        02590000
026000                                                                  02600000
026100     PERFORM 9050-READ-IN-DRIVER-FILE.                            02610000
026200     IF PS-IN-DRIVER-EOF                                          02620000
026300         CONTINUE                                                 02630000
026400     ELSE                                                         02640000
026500         MOVE AH006-NOTIF-NBR      TO PV-NOTIF-NBR-COMP           02650002
026700         PERFORM 2100-CHECK-PGM-PROGRESS                          02670000
026800         SET PS-TABLE-LOOP-NOT-DONE   TO TRUE                     02680000
026900         SET PS-CURSOR-HAS-NO-DATA    TO TRUE                     02690006
027000         PERFORM 9100-OPEN-TABLE-CURSOR                           02700006
027100         PERFORM 3000-EXTRACT-ROWS-FROM-TABLE                     02710000
027200             UNTIL PS-TABLE-LOOP-DONE                             02720000
027300         PERFORM 9190-CLOSE-TABLE-CURSOR                          02730006
027400     END-IF.                                                      02740000
027500                                                                  02750000
027600                                                                  02760000
027700* ************************************************************** *02770000
027800* *    EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT     * *02780000
027900* *    RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST   * *02790000
028000* *    WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.   * *02800000
028100* ************************************************************** *02810000
028200 2100-CHECK-PGM-PROGRESS.                                         02820000
028300     DIVIDE    PV-IN-DRIVER-RECS-READ-CNT                         02830000
028400         BY        PC-HOW-OFTEN-TO-DISPLAY                        02840000
028500         GIVING    PV-DISPLAY-NTH-MULTIPLE                        02850000
028600         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      02860000
028700                                                                  02870000
028800     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           02880000
028900         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      02890000
029000         PERFORM 6200-DISPLAY-PGM-PROGRESS                        02900000
029100     END-IF.                                                      02910000
029200                                                                  02920000
029300                                                                  02930000
029400* ************************************************************** *02940000
029500* * EXTRACT ROWS FROM TABLE, FOR THE CURRENT DRIVER RECORD     * *02950000
029600* ************************************************************** *02960000
029700 3000-EXTRACT-ROWS-FROM-TABLE.                                    02970000
029800     INITIALIZE DCLTTRBDTL.                                       02980000
029900     PERFORM 9150-FETCH-TABLE-CURSOR.                             02990006
030000     IF PS-TABLE-LOOP-DONE                                        03000000
030100         CONTINUE                                                 03010000
030200     ELSE                                                         03020000
030300         PERFORM 9750-WRITE-EXTRACT-RECORD                        03030000
030400     END-IF.                                                      03040000
030500                                                                  03050000
030600                                                                  03060000
030700* ************************************************************** *03070000
030800* * DISPLAY END OF RUN MESSAGE, CLOSE THE OUTPUT FILES         * *03080000
030900* ************************************************************** *03090000
031000 6000-EOJ-ROUTINE.                                                03100000
031100                                                                  03110000
031200     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           03120000
031300     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         03130000
031400                                                                  03140000
031500     MOVE PC-ENDING                 TO DP-STATUS-DESCRIPTION.     03150000
031600     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03160000
031700                                                                  03170000
031800                                                                  03180000
031900* ************************************************************** *03190000
032000* * DISPLAY PROGRAM PROGRESS.                                  * *03200000
032100* ************************************************************** *03210000
032200 6200-DISPLAY-PGM-PROGRESS.                                       03220000
032300                                                                  03230000
032400     EXEC SQL                                                     03240000
032500          SET :PV-TMST = CURRENT TIMESTAMP                        03250000
032600     END-EXEC.                                                    03260000
032700                                                                  03270000
032800     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03280000
032900     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03290000
033000     MOVE PV-IN-DRIVER-RECS-READ-CNT                              03300000
033100                                    TO DP-IN-CNT.                 03310000
033200*    MOVE PV-RECS-WITH-MATCHES-CNT  TO DP-MATCHES-FOUND-CNT.      03320000
033300     MOVE PV-TABLE-ROW-SELECT-CNT   TO DP-ROWS-SELECTED-CNT.      03330000
033400     MOVE PV-EXTRACT-WRITTEN-CNT    TO DP-OUT-CNT.                03340000
033500                                                                  03350000
033600     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03360000
033700                                                                  03370000
033800                                                                  03380000
033900* ************************************************************** *03390000
034000* * FILE AND DB2 TABLE ACCESS PARAGRAPHS.                      * *03400000
034100* * 90XX- INPUT:  DRIVER FILE                                  * *03410000
034300* * 97XX- OUTPUT: TABLE EXTRACT                                * *03430000
034400* ************************************************************** *03440000
034500                                                                  03450000
034600* ************************************************************** *03460000
034700* * OPEN  INPUT DRIVER FILE                                    * *03470000
034800* ************************************************************** *03480000
034900 9000-OPEN-IN-DRIVER-FILE.                                        03490000
035000     OPEN  INPUT  IN-DRIVER-FILE.                                 03500000
035100                                                                  03510000
035200                                                                  03520000
035300* ************************************************************** *03530000
035400* * READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT        * *03540000
035500* ************************************************************** *03550000
035600 9050-READ-IN-DRIVER-FILE.                                        03560000
035700     READ IN-DRIVER-FILE                                          03570000
035800          INTO AH006-TTRBNTF                                      03580000
035900          AT END                                                  03590000
036000              SET PS-IN-DRIVER-EOF TO TRUE.                       03600000
036100                                                                  03610000
036200     IF PS-IN-DRIVER-EOF                                          03620000
036300         CONTINUE                                                 03630000
036400     ELSE                                                         03640000
036500         ADD +1 TO PV-IN-DRIVER-RECS-READ-CNT                     03650000
036600     END-IF.                                                      03660000
036700                                                                  03670000
036800                                                                  03680000
036900* ************************************************************** *03690000
037000* * CLOSE INPUT DRIVER FILE                                    * *03700000
037100* ************************************************************** *03710000
037200 9090-CLOSE-IN-DRIVER-FILE.                                       03720000
037300     CLOSE IN-DRIVER-FILE.                                        03730000
037600                                                                  03760006
037700* ************************************************************** *03770006
037800* * OPEN  TABLE CURSOR                                         * *03780006
037900* ************************************************************** *03790006
038000 9100-OPEN-TABLE-CURSOR.                                          03800006
038100     EXEC SQL                                                     03810006
038200          OPEN TABLE-CURSOR                                       03820006
038300     END-EXEC.                                                    03830006
038400                                                                  03840006
038500     EVALUATE TRUE                                                03850006
038600         WHEN SQLCODE = ZERO                                      03860006
038700              ADD +1 TO PV-RECS-WITH-MATCHES-CNT                  03870006
038800              SET PS-CURSOR-HAS-DATA TO TRUE                      03880006
038900         WHEN SQLCODE = +100                                      03890006
039000              SET PS-TABLE-LOOP-DONE TO TRUE                      03900006
039100         WHEN SQLWARN0 NOT EQUAL SPACE                            03910006
039200         WHEN SQLCODE  NOT EQUAL ZERO                             03920006
039300              MOVE '9100-OPEN-TABLE-CURSOR'                       03930006
039400                                 TO PV-PARAGRAPH-NAME             03940006
039500              MOVE 'OPEN TABLE CURSOR'                            03950006
039600                                 TO PV-DB2-OPERATION-MSG-1        03960006
039700              MOVE 'TTRBNTF'     TO PV-DB2-TABLE-NAME             03970006
039800              PERFORM 9999-DB2-ABEND                              03980006
039900     END-EVALUATE.                                                03990006
039910                                                                  03991006
040100* ************************************************************** *04010000
040200* * FETCH TABLE CURSOR                                         * *04020006
040300* ************************************************************** *04030000
040400 9150-FETCH-TABLE-CURSOR.                                         04040006
040500     EXEC SQL                                                     04050000
040600         FETCH TABLE-CURSOR                                       04060006
040641          INTO  :TRBDTL-NOTIF-NBR                                 04064103
040644             ,  :TRBDTL-CRE-TMST                                  04064400
040645             ,  :TRBDTL-CRE-UID                                   04064500
040646             ,  :TRBDTL-FREEFORM-TEXT                             04064603
042640     END-EXEC.                                                    04264000
042650                                                                  04265000
042660                                                                  04266006
042670     EVALUATE TRUE                                                04267006
042680         WHEN SQLCODE = ZERO                                      04268006
042690              ADD +1                 TO PV-TABLE-ROW-SELECT-CNT   04269006
042700              SET PS-CURSOR-HAS-DATA TO TRUE                      04270006
042800         WHEN SQLCODE = +100                                      04280006
042900              SET PS-TABLE-LOOP-DONE TO TRUE                      04290006
043000         WHEN SQLWARN0 NOT EQUAL SPACE                            04300006
043100         WHEN SQLCODE NOT EQUAL ZERO                              04310006
043200              MOVE '9150-FETCH-TABLE-CURSOR'                      04320006
043300                                 TO PV-PARAGRAPH-NAME             04330006
043400              MOVE 'FETCH TABLE CURSOR'                           04340006
043500                                 TO PV-DB2-OPERATION-MSG-1        04350006
043600              MOVE 'TTRBDTL'     TO PV-DB2-TABLE-NAME             04360006
043700              PERFORM 9999-DB2-ABEND                              04370006
043710     END-EVALUATE.                                                04371006
043720                                                                  04372006
043820* ************************************************************** *04382006
043830* * CLOSE TABLE CURSOR                                         * *04383006
043840* ************************************************************** *04384006
043850 9190-CLOSE-TABLE-CURSOR.                                         04385006
043860     EXEC SQL                                                     04386006
043870          CLOSE TABLE-CURSOR                                      04387006
043880     END-EXEC.                                                    04388006
043890                                                                  04389006
043891     EVALUATE TRUE                                                04389106
043892         WHEN SQLCODE = ZERO                                      04389206
043893              CONTINUE                                            04389306
043894         WHEN SQLWARN0 NOT EQUAL SPACE                            04389406
043895         WHEN SQLCODE NOT EQUAL ZERO                              04389506
043896              MOVE '9190-CLOSE-TABLE-CURSOR'                      04389606
043897                                 TO PV-PARAGRAPH-NAME             04389706
043898              MOVE 'CLOSE TABLE CURSOR'                           04389806
043899                                 TO PV-DB2-OPERATION-MSG-1        04389906
043900              MOVE 'TTRBNTF'     TO PV-DB2-TABLE-NAME             04390006
043910              PERFORM 9999-DB2-ABEND                              04391006
043920     END-EVALUATE.                                                04392006
043930                                                                  04393006
044000                                                                  04400000
046200* ************************************************************** *04620000
046300* * OPEN OUTPUT EXTRACT FILE                                   * *04630000
046400* ************************************************************** *04640000
046500 9700-OPEN-OUT-EXTRACT-FILE.                                      04650000
046600     OPEN OUTPUT OUT-EXTRACT-FILE.                                04660000
046700                                                                  04670000
046800                                                                  04680000
046900* ************************************************************** *04690000
047000* * WRITE A RECORD TO THE TABLE EXTRACT FILE                   * *04700000
047100* ************************************************************** *04710000
047200 9750-WRITE-EXTRACT-RECORD.                                       04720000
047300     WRITE  OUT-EXTRACT-RECORD  FROM  DCLTTRBDTL.                 04730000
047400     ADD +1 TO PV-EXTRACT-WRITTEN-CNT.                            04740000
047500                                                                  04750000
047600                                                                  04760000
047700* ************************************************************** *04770000
047800* * CLOSE OUTPUT EXTRACT FILE                                  * *04780000
047900* ************************************************************** *04790000
048000 9790-CLOSE-OUT-EXTRACT-FILE.                                     04800000
048100     CLOSE OUT-EXTRACT-FILE.                                      04810000
048200                                                                  04820000
048300                                                                  04830000
048400* ************************************************************** *04840000
048500* * DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *04850000
048600* * AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN          * *04860000
048700* * SQL ERROR OR WARNING CODE OCCURS.                          * *04870000
048800* ************************************************************** *04880000
048900 9999-DB2-ABEND.                                                  04890000
049000                                                                  04900000
049100     DISPLAY PC-CURRENT-PROGRAM-NAME                              04910000
049200             ' 9999-DB2-ABEND'.                                   04920000
049300     DISPLAY PC-CURRENT-PROGRAM-NAME                              04930000
049400             ' ** ABEND           **'.                            04940000
049500     DISPLAY PC-CURRENT-PROGRAM-NAME                              04950000
049600             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       04960000
049700     DISPLAY PC-CURRENT-PROGRAM-NAME                              04970000
049800             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME.       04980000
049900     DISPLAY PC-CURRENT-PROGRAM-NAME                              04990000
050000             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05000000
050100                                                                  05010000
050200     DISPLAY PC-CURRENT-PROGRAM-NAME                              05020000
050300             ' ** SQLCODE         ** = ' SQLCODE.                 05030000
050400     MOVE SQLCODE TO PV-SQLCODE.                                  05040000
050500     DISPLAY PC-CURRENT-PROGRAM-NAME                              05050000
050600             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05060000
050700                                                                  05070000
050800     DISPLAY PC-CURRENT-PROGRAM-NAME                              05080000
050900             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05090000
051000                                                                  05100000
051100                                                                  05110000
051200*----------------------------------------------------------------*05120000
051300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05130000
051400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05140000
051500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05150000
051600* FORMAT.                                                        *05160000
051700*----------------------------------------------------------------*05170000
051800     COPY DPPD004.                                                05180000
051900                                                                  05190000
052000     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05200000
052100     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05210000
052200     PERFORM 9090-CLOSE-IN-DRIVER-FILE.                           05220000
052300     PERFORM 9790-CLOSE-OUT-EXTRACT-FILE.                         05230000
052400                                                                  05240000
052500*----------------------------------------------------------------*05250000
052600* CALL ABEND                                                     *05260000
052700*----------------------------------------------------------------*05270000
052800     MOVE +4013                  TO ABEND-CODE.                   05280000
052900     CALL 'ILBOABN0' USING ABEND-CODE.                            05290000
053000*                                                                 05300000
