000100 IDENTIFICATION DIVISION.                                         00010008
000200 PROGRAM-ID.         AHKUP055.                                    00020008
000300 AUTHOR.             PATRICK BURKE.                               00030008
000400 DATE-WRITTEN.       MAY 2000.                                    00040008
000500 DATE-COMPILED.                                                   00050008
000600*************************************************************     00060008
000700*    COBOL 2 WITH SQL                                       *     00070008
000800*                                                           *     00080008
000900*   AHKUP055 - ARCHIVE HISTORY DATA DELETION - TWKORIN      *     00090008
001000*                                                           *     00100008
001100*   PROGRAM OVERVIEW:                                       *     00110008
001200*                                                           *     00120008
001300*  THIS PROGRAM DELETES "OLD" ROWS FROM DB2 TABLE TWKORIN.  *     00130008
001400*  ROWS DELETED ARE THOSE PREVIOUSLY - IDENTIFIED/EXTRACTED *     00140008
001500*  WITHIN THE ARCHIVE/HISTORY SYSTEM.                       *     00150008
001600*                                                           *     00160008
001700*  THE EXTRACT FILE USED AS INPUT WILL BE SORTED BY THE     *     00170008
001800*  CLUSTERING INDEX COLUMNS TO SPEED THE DELETION PROCESS.  *     00180008
001900*  THESE COLUMNS ARE ORD_NBR, RCVR_SEQ_NBR, ORD_LNE_NBR,    *     00190008
002000*  WORK_ORD_SEQ_NBR, OPER-UNT_ID, FCLTY_ID, WO_INST_SEQ_NBR.*     00200008
002100*                                                           *     00210008
002200*   INPUT:                                                  *     00220008
002300*                                                           *     00230008
002400*     1. TWKORIN DELETION FILE  COPYBOOK DCLTWRKORD         *     00240008
002500*                                                           *     00250008
002600*   DB2 TABLES:                                             *     00260008
002700*                                                           *     00270008
002800*        TWKORIN - RECEIVING HEADER TABLE                   *     00280008
002900*        TCKRSTIN - CHECKPOINT/RESTART INFO TABLE           *     00290008
003000*        TCKRSTCN - CHECKPOINT/RESTART CONTROL TABLE        *     00300008
003100*                                                           *     00310008
003200*************************************************************     00320008
003300*                                                           *     00330008
003400*************************************************************     00340008
003500 EJECT                                                            00350008
003600 ENVIRONMENT DIVISION.                                            00360008
003700 CONFIGURATION SECTION.                                           00370008
003800 SOURCE-COMPUTER.        IBM-370.                                 00380008
003900 OBJECT-COMPUTER.        IBM-370.                                 00390008
004000                                                                  00400008
004100 INPUT-OUTPUT SECTION.                                            00410008
004200 FILE-CONTROL.                                                    00420008
004300     SELECT TWKORIN-EXTRACT-FILE ASSIGN TO INP01.                 00430008
004400                                                                  00440008
004500 DATA DIVISION.                                                   00450008
004600 FILE SECTION.                                                    00460008
004700 FD  TWKORIN-EXTRACT-FILE                                         00470008
004800     RECORDING MODE IS F                                          00480008
004900     LABEL RECORDS ARE STANDARD                                   00490008
005000     BLOCK CONTAINS 0 RECORDS                                     00500008
005100     RECORD CONTAINS 137 CHARACTERS                               00510008
005200     DATA RECORD IS TWKORIN-EXTRACT-DATA.                         00520008
005300 01  TWKORIN-EXTRACT-DATA       PIC X(137).                       00530008
005400                                                                  00540008
005500                                                                  00550008
005600 EJECT                                                            00560008
005700 WORKING-STORAGE SECTION.                                         00570008
005800                                                                  00580008
005900 01  FILLER                       PIC X(58)     VALUE             00590008
006000     '************WORKING STORAGE STARTS HERE*******************'.00600008
006100                                                                  00610008
006200 01  PV-PROGRAM-VARIABLES.                                        00620008
006300     05  PV-PROGRAM-NAME          PIC X(08)    VALUE 'AHKUP055'.  00630008
006400     05  PV-CKPT-STAT-CODE        PIC X(01)    VALUE SPACE.       00640008
006500     05  PV-CURRENT-PARAGRAPH     PIC X(50)    VALUE SPACES.      00650008
006600     05  PV-CURRENT-TMST          PIC X(26)    VALUE SPACES.      00660008
006700                                                                  00670008
006800     05  PV-TWKORIN-INPUT-COUNT   PIC 9(09)    VALUE ZERO         00680008
006900                                               COMP-3.            00690008
007000     05  PV-TWKORIN-DELETE-COUNT  PIC 9(09)    VALUE ZERO         00700008
007100                                               COMP-3.            00710008
007200     05  PV-SQL-DELETE-COUNT      PIC 9(09)    VALUE ZERO         00720008
007300                                               COMP-3.            00730008
007400     05  PV-SQLERRD3              PIC S9(09)   VALUE ZERO         00740008
007500                                               COMP-3.            00750008
007600     05  PV-DISP-ORD-NBR          PIC X(09)    VALUE SPACES.      00760008
007700     05  PV-DISP-RCVR-SEQ-NBR     PIC X(09)    VALUE SPACES.      00770008
007800     05  PV-DISP-ORD-LNE-NBR      PIC X(09)    VALUE SPACES.      00780008
007900     05  PV-DISP-WORK-ORD-SEQ-NBR  PIC X(09)    VALUE SPACES.     00790008
008000     05  PV-DISP-OPER-UNT-ID      PIC X(09)    VALUE SPACES.      00800008
008100     05  PV-DISP-FCLTY-ID         PIC X(09)    VALUE SPACES.      00810008
008200     05  PV-DISP-WO-INSTR-SEQ-NBR  PIC X(09)    VALUE SPACES.     00820008
008300 01  PC-PROGRAM-CONSTANTS.                                        00830008
008400     05  PC-RETRY-MAX             PIC S9(04)    VALUE +3          00840008
008500                                                COMP SYNC.        00850008
008600     05  PC-RETRY-COUNT           PIC S9(04)    VALUE ZEROS.      00860008
008700     05  PC-IN-PROCESS-CODE       PIC X(01)     VALUE '9'.        00870008
008800     05  PC-RUN-COMPLETE-CODE     PIC X(01)     VALUE '0'.        00880008
008900                                                                  00890008
009000 01  PS-PROGRAM-SWITCHES.                                         00900008
009100     05  PS-COMMITS-TAKEN-SW      PIC  X(01)    VALUE 'N'.        00910008
009200         88  COMMITS-TAKEN                      VALUE 'T'.        00920008
009300         88  NO-COMMITS-TAKEN                   VALUE 'N'.        00930008
009400     05  PS-END-EXTRACT-SW        PIC  X(01)    VALUE 'M'.        00940008
009500         88  MORE-EXTRACT                       VALUE 'M'.        00950008
009600         88  END-OF-EXTRACT                     VALUE 'E'.        00960008
009700     05  PS-RUN-TYPE-SW           PIC  X(01)    VALUE ' '.        00970008
009800         88  NORMAL-RUN                         VALUE '0'.        00980008
009900         88  RESTART-RUN                        VALUE '9'.        00990008
010000                                                                  01000008
010100 01  WS-COUNTER.                                                  01010008
010200     05  WS-HOLD-TMST             PIC X(26)     VALUE SPACES.     01020008
010300     05  WS-TMST                  PIC X(26)     VALUE SPACES.     01030008
010400                                                                  01040008
010500 01  CKPT-RESTART-INFO.                                           01050008
010600     05  CR-EXTRACT-RECS-WORKED   PIC  9(9)     VALUE ZERO.       01060008
010700                                                                  01070008
010800*----------------------------------------------------------------*01080008
010900*  ABEND DATA AREAS                                              *01090008
011000*----------------------------------------------------------------*01100008
011100 01  ABEND-CODE                  PIC S9(04)  VALUE ZEROS          01110008
011200                                             COMP SYNC.           01120008
011300     88  AC-BAD-RECEIVE-DATA                 VALUE +4001.         01130008
011400     88  AC-BAD-DATA                         VALUE +4008.         01140008
011500     88  AC-DB2-ERROR                        VALUE +4013.         01150008
011600     88  AC-DATE-ERROR                       VALUE +4019.         01160008
011700                                                                  01170008
011800                                                                  01180008
011900 01  ABEND-AREAS.                                                 01190008
012000     05  AA-ABEND-LIT            PIC  X(40)  VALUE                01200008
012100             '*****       ABEND'.                                 01210008
012200     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                01220008
012300             '*****   PROGRAM: AHKUP055'.                         01230008
012400     05  AA-PARAGRAPH-LIT.                                        01240008
012500         10  FILLER              PIC  X(17)  VALUE                01250008
012600             '***** PARAGRAPH: '.                                 01260008
012700         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        01270008
012800     05  AA-MESSAGE-LINE-1.                                       01280008
012900         10  FILLER              PIC  X(06)  VALUE '*****'.       01290008
013000         10  AA-MESSAGE-1        PIC  X(127) VALUE SPACES.        01300008
013100     05  AA-MESSAGE-LINE-2.                                       01310008
013200         10  FILLER              PIC  X(06)  VALUE '*****'.       01320008
013300         10  AA-MESSAGE-2        PIC  X(127) VALUE SPACES.        01330008
013400     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                01340008
013500             '*****    DB2 ERROR'.                                01350008
013600     05  AA-DB2-OPERATION-LIT.                                    01360008
013700         10  FILLER              PIC  X(17)  VALUE                01370008
013800             '***** OPERATION: '.                                 01380008
013900         10  AA-DB2-OPERATION    PIC  X(50)  VALUE SPACES.        01390008
014000     05  AA-DB2-TABLE            PIC  X(08)  VALUE SPACES.        01400008
014100     EJECT                                                        01410008
014200                                                                  01420008
014300     COPY DPWS004.                                                01430008
014400     EJECT                                                        01440008
014500*----------------------------------------------------------------*01450008
014600*      TWKORIN TABLE LAYOUT                                       01460008
014700*----------------------------------------------------------------*01470008
014800         EXEC SQL                                                 01480008
014900             INCLUDE TWKORIN                                      01490008
015000         END-EXEC.                                                01500008
015100                                                                  01510008
015200*----------------------------------------------------------------*01520008
015300*      TCKRSTCNTL TABLE LAYOUT                                    01530008
015400*----------------------------------------------------------------*01540008
015500         EXEC SQL                                                 01550008
015600             INCLUDE TCKRSTCN                                     01560008
015700         END-EXEC.                                                01570008
015800                                                                  01580008
015900*----------------------------------------------------------------*01590008
016000*      TCKRSTINF TABLE LAYOUT                                     01600008
016100*----------------------------------------------------------------*01610008
016200         EXEC SQL                                                 01620008
016300             INCLUDE TCKRSTIN                                     01630008
016400         END-EXEC.                                                01640008
016500 EJECT                                                            01650008
016600*----------------------------------------------------------------*01660008
016700*  DB2 COMMUNICATION AREA                                         01670008
016800*----------------------------------------------------------------*01680008
016900*                                                                 01690008
017000     EXEC SQL                                                     01700008
017100         INCLUDE SQLCA                                            01710008
017200     END-EXEC.                                                    01720008
017300                                                                  01730008
017400*----------------------------------------------------------------*01740008
017500*  DB2 COMMUNICATION AREA2                                        01750008
017600*----------------------------------------------------------------*01760008
017700*                                                                 01770008
017800     COPY SQLCA2.                                                 01780008
017900     EJECT                                                        01790008
018000 PROCEDURE DIVISION.                                              01800008
018100 A100-MAINLINE-ROUTINE.                                           01810008
018200                                                                  01820008
018300     PERFORM B100-INITIALIZATION.                                 01830008
018400                                                                  01840008
018500     PERFORM B200-TWKORIN-EXTRACT-PROCESS                         01850008
018600       UNTIL END-OF-EXTRACT.                                      01860008
018700                                                                  01870008
018800     PERFORM B300-EOJ-PROCESSING.                                 01880008
018900                                                                  01890008
019000     GOBACK.                                                      01900008
019100 EJECT                                                            01910008
019200 B100-INITIALIZATION.                                             01920008
019300                                                                  01930008
019400     EXEC SQL                                                     01940008
019500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 01950008
019600     END-EXEC.                                                    01960008
019700                                                                  01970008
019800     PERFORM X300-GET-CHECKPOINT-CNTL.                            01980008
019900     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    01990008
020000                                                                  02000008
020100     OPEN INPUT TWKORIN-EXTRACT-FILE.                             02010008
020200                                                                  02020008
020300     IF RESTART-RUN                                               02030008
020400         PERFORM X200-CHECKPOINT-RESTART                          02040008
020500     ELSE                                                         02050008
020600         PERFORM R100-READ-EXTRACT-FILE                           02060008
020700     END-IF.                                                      02070008
020800                                                                  02080008
020900     PERFORM X500-SET-CHECKPOINT-TIME.                            02090008
021000                                                                  02100008
021100                                                                  02110008
021200     EJECT                                                        02120008
021300 B200-TWKORIN-EXTRACT-PROCESS.                                    02130008
021400                                                                  02140008
021500     MOVE WKORIN-ORD-NBR            TO PV-DISP-ORD-NBR.           02150008
021600     MOVE WKORIN-RCVR-SEQ-NBR       TO PV-DISP-RCVR-SEQ-NBR.      02160008
021700     MOVE WKORIN-ORD-LNE-NBR        TO PV-DISP-ORD-LNE-NBR.       02170008
021800     MOVE WKORIN-WORK-ORD-SEQ-NBR   TO PV-DISP-WORK-ORD-SEQ-NBR.  02180008
021900     MOVE WKORIN-OPER-UNT-ID        TO PV-DISP-OPER-UNT-ID.       02190008
022000     MOVE WKORIN-FCLTY-ID           TO PV-DISP-FCLTY-ID.          02200008
022100     MOVE WKORIN-WO-INSTR-SEQ-NBR   TO PV-DISP-WO-INSTR-SEQ-NBR.  02210008
022200                                                                  02220008
022300     PERFORM D100-DELETE-TWKORIN.                                 02230008
022400                                                                  02240008
022500     PERFORM X100-CHECKPOINT-CHECK.                               02250008
022600                                                                  02260008
022700     PERFORM R100-READ-EXTRACT-FILE.                              02270008
022800     EJECT                                                        02280008
022900                                                                  02290008
023000                                                                  02300008
023100 B300-EOJ-PROCESSING.                                             02310008
023200                                                                  02320008
023300     DISPLAY '** AHKUP055 SUMMARY **'.                            02330008
023400     DISPLAY '** TWKORIN INPUT COUNT = ' PV-TWKORIN-INPUT-COUNT.  02340008
023500     DISPLAY '** TWKORIN DELETE COUNT = ' PV-TWKORIN-DELETE-COUNT.02350008
023600     DISPLAY '** SQL DELETE COUNT = ' PV-SQL-DELETE-COUNT.        02360008
023700                                                                  02370008
023800     CLOSE  TWKORIN-EXTRACT-FILE.                                 02380008
023900                                                                  02390008
024000     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02400008
024100     PERFORM X600-UPDATE-TCKRSTCNTL.                              02410008
024200                                                                  02420008
024300     EJECT                                                        02430008
024400*----------------------------------------------------------------*02440008
024500*    DELETES FROM THE TWKORIN TABLE. NO OTHER TABLES REFERENCE   *02450008
024600*    THIS TABLE.                                                 *02460008
024700*----------------------------------------------------------------*02470008
024800 D100-DELETE-TWKORIN.                                             02480008
024900                                                                  02490008
025000     MOVE 'D100-DELETE-TWKORIN' TO PV-CURRENT-PARAGRAPH.          02500008
025100                                                                  02510008
025200     PERFORM WITH TEST AFTER                                      02520008
025300        VARYING PC-RETRY-COUNT FROM 1 BY 1                        02530008
025400          UNTIL PC-RETRY-COUNT > PC-RETRY-MAX                     02540008
025500             OR SQLCODE = ZERO                                    02550008
025600                                                                  02560008
025700         EXEC SQL                                                 02570008
025800              DELETE                                              02580008
025900                FROM TWKORIN                                      02590008
026000               WHERE ORD_NBR          = :WKORIN-ORD-NBR           02600008
026100                 AND RCVR_SEQ_NBR     = :WKORIN-RCVR-SEQ-NBR      02610008
026200                 AND ORD_LNE_NBR      = :WKORIN-ORD-LNE-NBR       02620008
026300                 AND WORK_ORD_SEQ_NBR  = :WKORIN-WORK-ORD-SEQ-NBR 02630008
026400                 AND OPER_UNT_ID      = :WKORIN-OPER-UNT-ID       02640008
026500                 AND FCLTY_ID         = :WKORIN-FCLTY-ID          02650008
026600                 AND WO_INSTR_SEQ_NBR = :WKORIN-WO-INSTR-SEQ-NBR  02660008
026610                 AND CRE_TMST         = :WKORIN-CRE-TMST          02661009
026700         END-EXEC                                                 02670008
026800                                                                  02680008
026900         EVALUATE TRUE                                            02690008
027000             WHEN SQLCODE = ZERO                                  02700008
027100                 ADD 1 TO PV-TWKORIN-DELETE-COUNT                 02710008
027200                 MOVE SQLERRD(3) TO PV-SQLERRD3                   02720008
027300                 ADD PV-SQLERRD3 TO PV-SQL-DELETE-COUNT           02730008
027400                                                                  02740008
027500             WHEN SQLCODE = -904                                  02750008
027600             WHEN SQLCODE = -913                                  02760008
027700                  CONTINUE                                        02770008
027800                                                                  02780008
027900             WHEN SQLCODE = +100                                  02790008
028000                 MOVE PV-CURRENT-PARAGRAPH                        02800008
028100                                     TO AA-PARAGRAPH-NAME         02810008
028200                 DISPLAY '******** ORD NBR:'                      02820008
028300                          PV-DISP-ORD-NBR                         02830008
028400                 DISPLAY '******** RCVR SEQ NBR:'                 02840008
028500                          PV-DISP-RCVR-SEQ-NBR                    02850008
028600                 DISPLAY '******** ORD LNE NBR:'                  02860008
028700                          PV-DISP-ORD-LNE-NBR                     02870008
028800                 DISPLAY '******** WORK ORD SEQ NBR:'             02880008
028900                          PV-DISP-WORK-ORD-SEQ-NBR                02890008
029000                 DISPLAY '******** OPER UNT ID:'                  02900008
029100                          PV-DISP-OPER-UNT-ID                     02910008
029200                 DISPLAY '******** FCLTY ID:'                     02920008
029300                          PV-DISP-FCLTY-ID                        02930008
029400                 DISPLAY '******** WO INSTR SEQ NBR:'             02940008
029500                          PV-DISP-WO-INSTR-SEQ-NBR                02950008
029600                 MOVE 'ROW NOT ON TABLE ********'                 02960008
029700                          TO AA-MESSAGE-1                         02970008
029800                 MOVE SPACES TO AA-MESSAGE-2                      02980008
029900                 MOVE 'UNSUCCESSFUL DELETE'                       02990008
030000                          TO AA-DB2-OPERATION                     03000008
030100                 MOVE 'TWKORIN'  TO AA-DB2-TABLE                  03010008
030200                 PERFORM Z999-DB2-ABEND                           03020008
030300             WHEN SQLWARN0 NOT = SPACES                           03030008
030400             WHEN SQLCODE  NOT = ZERO                             03040008
030500                 MOVE PV-CURRENT-PARAGRAPH                        03050008
030600                                     TO AA-PARAGRAPH-NAME         03060008
030700                 DISPLAY '******** ORD NBR:'                      03070008
030800                          PV-DISP-ORD-NBR                         03080008
030810                 DISPLAY '******** RCVR SEQ NBR:'                 03081008
030820                          PV-DISP-RCVR-SEQ-NBR                    03082008
030830                 DISPLAY '******** ORD LNE NBR:'                  03083008
030840                          PV-DISP-ORD-LNE-NBR                     03084008
030850                 DISPLAY '******** WORK ORD SEQ NBR:'             03085008
030860                          PV-DISP-WORK-ORD-SEQ-NBR                03086008
030870                 DISPLAY '******** OPER UNT ID:'                  03087008
030880                          PV-DISP-OPER-UNT-ID                     03088008
030890                 DISPLAY '******** FCLTY ID:'                     03089008
030891                          PV-DISP-FCLTY-ID                        03089108
030892                 DISPLAY '******** WO INSTR SEQ NBR:'             03089208
030893                          PV-DISP-WO-INSTR-SEQ-NBR                03089308
030894                 MOVE SPACES TO AA-MESSAGE-1                      03089408
030895                                AA-MESSAGE-2                      03089508
030896                 MOVE 'UNSUCCESSFUL DELETE'                       03089608
030897                                     TO AA-DB2-OPERATION          03089708
030898                 MOVE 'TWKORIN'     TO AA-DB2-TABLE               03089808
030899                 PERFORM Z999-DB2-ABEND                           03089908
030900         END-EVALUATE                                             03090008
031000     END-PERFORM.                                                 03100008
031100                                                                  03110008
031200     IF PC-RETRY-COUNT > PC-RETRY-MAX                             03120008
031300         MOVE PV-CURRENT-PARAGRAPH                                03130008
031400                             TO AA-PARAGRAPH-NAME                 03140008
031500         DISPLAY '******** ORD NBR:'                              03150008
031600                          PV-DISP-ORD-NBR                         03160008
031700         DISPLAY '******** RCVR SEQ NBR:'                         03170008
031800                          PV-DISP-RCVR-SEQ-NBR                    03180008
031900         DISPLAY '******** ORD LNE NBR:'                          03190008
032000                          PV-DISP-ORD-LNE-NBR                     03200008
032100         DISPLAY '******** WORK ORD SEQ NBR:'                     03210008
032200                          PV-DISP-WORK-ORD-SEQ-NBR                03220008
032300         DISPLAY '******** OPER UNT ID:'                          03230008
032400                          PV-DISP-OPER-UNT-ID                     03240008
032500         DISPLAY '******** FCLTY ID:'                             03250008
032600                          PV-DISP-FCLTY-ID                        03260008
032700         DISPLAY '******** WO INSTR SEQ NBR:'                     03270008
032800                          PV-DISP-WO-INSTR-SEQ-NBR                03280008
032900         MOVE SPACES TO AA-MESSAGE-1                              03290008
033000                        AA-MESSAGE-2                              03300008
033100         MOVE 'MAX RETRIES EXCEEDED ON DELETE'                    03310008
033200                             TO AA-DB2-OPERATION                  03320008
033300         MOVE 'TWKORIN'      TO AA-DB2-TABLE                      03330008
033400         PERFORM Z999-DB2-ABEND                                   03340008
033500     END-IF.                                                      03350008
033600                                                                  03360008
033700     EJECT                                                        03370008
033800 R100-READ-EXTRACT-FILE.                                          03380008
033900                                                                  03390008
034000     READ TWKORIN-EXTRACT-FILE                                    03400008
034100          INTO DCLTWKORIN                                         03410008
034200          AT END SET END-OF-EXTRACT TO TRUE.                      03420008
034300                                                                  03430008
034400     IF MORE-EXTRACT                                              03440008
034500         ADD 1 TO PV-TWKORIN-INPUT-COUNT                          03450008
034600     END-IF.                                                      03460008
034700                                                                  03470008
034800                                                                  03480008
034900     EJECT                                                        03490008
035000*----------------------------------------------------------------*03500008
035100*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03510008
035200*----------------------------------------------------------------*03520008
035300 X100-CHECKPOINT-CHECK.                                           03530008
035400                                                                  03540008
035500     MOVE 'X100-CHECKPOINT-CHECK' TO PV-CURRENT-PARAGRAPH.        03550008
035600                                                                  03560008
035700     EXEC SQL                                                     03570008
035800       SET :WS-TMST = CURRENT TIMESTAMP                           03580008
035900     END-EXEC.                                                    03590008
036000                                                                  03600008
036100     IF SQLCODE = +0                                              03610008
036200         CONTINUE                                                 03620008
036300     ELSE                                                         03630008
036400         MOVE PV-CURRENT-PARAGRAPH                                03640008
036500                             TO AA-PARAGRAPH-NAME                 03650008
036600         MOVE SPACES TO AA-MESSAGE-1                              03660008
036700                        AA-MESSAGE-2                              03670008
036800         MOVE 'BAD SET COMMAND'                                   03680008
036900                             TO AA-DB2-OPERATION                  03690008
037000         MOVE SPACES             TO AA-DB2-TABLE                  03700008
037100         PERFORM Z999-DB2-ABEND                                   03710008
037200     END-IF.                                                      03720008
037300                                                                  03730008
037400     IF WS-TMST > WS-HOLD-TMST                                    03740008
037500         IF NO-COMMITS-TAKEN                                      03750008
037600             MOVE PC-IN-PROCESS-CODE TO PV-CKPT-STAT-CODE         03760008
037700             PERFORM X600-UPDATE-TCKRSTCNTL                       03770008
037800             SET COMMITS-TAKEN TO TRUE                            03780008
037900         END-IF                                                   03790008
038000         PERFORM X700-UPDATE-TCKRSTINF                            03800008
038100         PERFORM Y100-COMMIT                                      03810008
038200         PERFORM X500-SET-CHECKPOINT-TIME                         03820008
038300     END-IF.                                                      03830008
038400                                                                  03840008
038500 EJECT                                                            03850008
038600*----------------------------------------------------------------*03860008
038700*    CHECK TO SEE IF A CHECKPOINT SHOULD BE TAKEN.               *03870008
038800*----------------------------------------------------------------*03880008
038900 X200-CHECKPOINT-RESTART.                                         03890008
039000                                                                  03900008
039100     MOVE 'X200-CHECKPOINT-RESTART' TO PV-CURRENT-PARAGRAPH.      03910008
039200                                                                  03920008
039300     PERFORM X400-GET-CHECKPOINT-INFO.                            03930008
039400     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CKPT-RESTART-INFO.     03940008
039500                                                                  03950008
039600     DISPLAY '** AHKUP055 CHECKPOINT RESTART **'                  03960008
039700     DISPLAY '** EXTRACT RECS BYPASSED ON RESTART = '             03970008
039800              CR-EXTRACT-RECS-WORKED.                             03980008
039900     DISPLAY '***********************************************'    03990008
040000                                                                  04000008
040100     PERFORM R100-READ-EXTRACT-FILE                               04010008
040200         CR-EXTRACT-RECS-WORKED TIMES.                            04020008
040300     PERFORM R100-READ-EXTRACT-FILE.                              04030008
040400 EJECT                                                            04040008
040500*----------------------------------------------------------------*04050008
040600*    SELECT CHECKPOINT RESTART CONTROL INFO.                     *04060008
040700*----------------------------------------------------------------*04070008
040800 X300-GET-CHECKPOINT-CNTL.                                        04080008
040900                                                                  04090008
041000     MOVE 'X300-GET-CHECKPOINT-CNTL' TO PV-CURRENT-PARAGRAPH.     04100008
041100                                                                  04110008
041200     PERFORM WITH TEST AFTER                                      04120008
041300             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04130008
041400             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04140008
041500                     SQLCODE = ZERO                               04150008
041600                                                                  04160008
041700             EXEC SQL                                             04170008
041800              SELECT CKPT_STAT_CODE                               04180008
041900               INTO :PV-CKPT-STAT-CODE                            04190008
042000               FROM TCKRSTCNTL                                    04200008
042100               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04210008
042200             END-EXEC                                             04220008
042300                                                                  04230008
042400             EVALUATE TRUE                                        04240008
042500                 WHEN SQLCODE = ZERO                              04250008
042600                 WHEN SQLCODE = -904                              04260008
042700                 WHEN SQLCODE = -913                              04270008
042800                      CONTINUE                                    04280008
042900                                                                  04290008
043000                 WHEN SQLWARN0 NOT = SPACES                       04300008
043100                 WHEN SQLCODE  NOT = ZERO                         04310008
043200                     MOVE PV-CURRENT-PARAGRAPH                    04320008
043300                                         TO AA-PARAGRAPH-NAME     04330008
043400                     DISPLAY '******** PLAN_NAME:'                04340008
043500                              PV-PROGRAM-NAME                     04350008
043600                     MOVE SPACES TO AA-MESSAGE-1                  04360008
043700                                    AA-MESSAGE-2                  04370008
043800                     MOVE 'UNSUCCESSFUL SELECT'                   04380008
043900                                         TO AA-DB2-OPERATION      04390008
044000                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          04400008
044100                     PERFORM Z999-DB2-ABEND                       04410008
044200             END-EVALUATE                                         04420008
044300     END-PERFORM.                                                 04430008
044400                                                                  04440008
044500     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04450008
044600         MOVE PV-CURRENT-PARAGRAPH                                04460008
044700                             TO AA-PARAGRAPH-NAME                 04470008
044800         DISPLAY '******** PLAN_NAME:'                            04480008
044900                  PV-PROGRAM-NAME                                 04490008
045000         MOVE SPACES TO AA-MESSAGE-1                              04500008
045100                        AA-MESSAGE-2                              04510008
045200         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    04520008
045300                             TO AA-DB2-OPERATION                  04530008
045400         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      04540008
045500         PERFORM Z999-DB2-ABEND                                   04550008
045600     END-IF.                                                      04560008
045700                                                                  04570008
045800 EJECT                                                            04580008
045900*----------------------------------------------------------------*04590008
046000*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO  *04600008
046100*----------------------------------------------------------------*04610008
046200 X400-GET-CHECKPOINT-INFO.                                        04620008
046300                                                                  04630008
046400     MOVE 'X400-GET-CHECKPOINT-INFO' TO PV-CURRENT-PARAGRAPH.     04640008
046500                                                                  04650008
046600     PERFORM WITH TEST AFTER                                      04660008
046700             VARYING PC-RETRY-COUNT FROM 1 BY 1                   04670008
046800             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             04680008
046900                     SQLCODE = ZERO                               04690008
047000                                                                  04700008
047100             EXEC SQL                                             04710008
047200              SELECT WORK_STRG_DESC                               04720008
047300               INTO :TCKRSTINF-WORK-STRG-DESC                     04730008
047400               FROM TCKRSTINF                                     04740008
047500               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 04750008
047600             END-EXEC                                             04760008
047700                                                                  04770008
047800             EVALUATE TRUE                                        04780008
047900                 WHEN SQLCODE = ZERO                              04790008
048000                 WHEN SQLCODE = -904                              04800008
048100                 WHEN SQLCODE = -913                              04810008
048200                      CONTINUE                                    04820008
048300                                                                  04830008
048400                 WHEN SQLWARN0 NOT = SPACES                       04840008
048500                 WHEN SQLCODE  NOT = ZERO                         04850008
048600                     MOVE PV-CURRENT-PARAGRAPH                    04860008
048700                                         TO AA-PARAGRAPH-NAME     04870008
048800                     DISPLAY '******** PLAN_NAME:'                04880008
048900                              PV-PROGRAM-NAME                     04890008
049000                     MOVE SPACES TO AA-MESSAGE-1                  04900008
049100                                    AA-MESSAGE-2                  04910008
049200                     MOVE 'UNSUCCESSFUL SELECT'                   04920008
049300                                         TO AA-DB2-OPERATION      04930008
049400                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          04940008
049500                     PERFORM Z999-DB2-ABEND                       04950008
049600             END-EVALUATE                                         04960008
049700     END-PERFORM.                                                 04970008
049800                                                                  04980008
049900     IF PC-RETRY-COUNT > PC-RETRY-MAX                             04990008
050000         MOVE PV-CURRENT-PARAGRAPH                                05000008
050100                             TO AA-PARAGRAPH-NAME                 05010008
050200         DISPLAY '******** PLAN_NAME:'                            05020008
050300                  PV-PROGRAM-NAME                                 05030008
050400         MOVE SPACES TO AA-MESSAGE-1                              05040008
050500                        AA-MESSAGE-2                              05050008
050600         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05060008
050700                             TO AA-DB2-OPERATION                  05070008
050800         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      05080008
050900         PERFORM Z999-DB2-ABEND                                   05090008
051000     END-IF.                                                      05100008
051100                                                                  05110008
051200 EJECT                                                            05120008
051300*----------------------------------------------------------------*05130008
051400*    SET THE TIME FOR THE NEXT CHECKPOINT.                       *05140008
051500*----------------------------------------------------------------*05150008
051600 X500-SET-CHECKPOINT-TIME.                                        05160008
051700                                                                  05170008
051800     MOVE 'X500-SET-CHECKPOINT-TIME' TO PV-CURRENT-PARAGRAPH.     05180008
051900                                                                  05190008
052000     PERFORM WITH TEST AFTER                                      05200008
052100             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05210008
052200             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05220008
052300                     SQLCODE = ZERO                               05230008
052400                                                                  05240008
052500             EXEC SQL                                             05250008
052600              SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)05260008
052700               INTO :WS-HOLD-TMST                                 05270008
052800               FROM TCKRSTCNTL                                    05280008
052900               WHERE PLAN_NAME = :PV-PROGRAM-NAME                 05290008
053000             END-EXEC                                             05300008
053100                                                                  05310008
053200             EVALUATE TRUE                                        05320008
053300                 WHEN SQLCODE = ZERO                              05330008
053400                 WHEN SQLCODE = -904                              05340008
053500                 WHEN SQLCODE = -913                              05350008
053600                      CONTINUE                                    05360008
053700                                                                  05370008
053800                 WHEN SQLWARN0 NOT = SPACES                       05380008
053900                 WHEN SQLCODE  NOT = ZERO                         05390008
054000                     MOVE PV-CURRENT-PARAGRAPH                    05400008
054100                                         TO AA-PARAGRAPH-NAME     05410008
054200                     DISPLAY '******** PLAN_NAME:'                05420008
054300                              PV-PROGRAM-NAME                     05430008
054400                     MOVE SPACES TO AA-MESSAGE-1                  05440008
054500                                    AA-MESSAGE-2                  05450008
054600                     MOVE 'UNSUCCESSFUL SELECT'                   05460008
054700                                         TO AA-DB2-OPERATION      05470008
054800                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          05480008
054900                     PERFORM Z999-DB2-ABEND                       05490008
055000             END-EVALUATE                                         05500008
055100     END-PERFORM.                                                 05510008
055200                                                                  05520008
055300     IF PC-RETRY-COUNT > PC-RETRY-MAX                             05530008
055400         MOVE PV-CURRENT-PARAGRAPH                                05540008
055500                             TO AA-PARAGRAPH-NAME                 05550008
055600         DISPLAY '******** PLAN_NAME:'                            05560008
055700                  PV-PROGRAM-NAME                                 05570008
055800         MOVE SPACES TO AA-MESSAGE-1                              05580008
055900                        AA-MESSAGE-2                              05590008
056000         MOVE 'MAX RETRIES EXCEEDED ON SELECT'                    05600008
056100                             TO AA-DB2-OPERATION                  05610008
056200         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      05620008
056300         PERFORM Z999-DB2-ABEND                                   05630008
056400     END-IF.                                                      05640008
056500                                                                  05650008
056600 EJECT                                                            05660008
056700*----------------------------------------------------------------*05670008
056800*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *05680008
056900*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *05690008
057000*----------------------------------------------------------------*05700008
057100 X600-UPDATE-TCKRSTCNTL.                                          05710008
057200                                                                  05720008
057300     MOVE 'X600-UPDATE-TCKRSTCNTL' TO PV-CURRENT-PARAGRAPH.       05730008
057400                                                                  05740008
057500     PERFORM WITH TEST AFTER                                      05750008
057600             VARYING PC-RETRY-COUNT FROM 1 BY 1                   05760008
057700             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             05770008
057800                     SQLCODE = ZERO                               05780008
057900                                                                  05790008
058000             EXEC SQL                                             05800008
058100                 UPDATE TCKRSTCNTL                                05810008
058200                 SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE          05820008
058300                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          05830008
058400             END-EXEC                                             05840008
058500                                                                  05850008
058600             EVALUATE TRUE                                        05860008
058700                 WHEN SQLCODE = ZERO                              05870008
058800                 WHEN SQLCODE = -904                              05880008
058900                 WHEN SQLCODE = -913                              05890008
059000                      CONTINUE                                    05900008
059100                                                                  05910008
059200                 WHEN SQLWARN0 NOT = SPACES                       05920008
059300                 WHEN SQLCODE  NOT = ZERO                         05930008
059400                     MOVE PV-CURRENT-PARAGRAPH                    05940008
059500                                         TO AA-PARAGRAPH-NAME     05950008
059600                     DISPLAY '******** PLAN_NAME:'                05960008
059700                              PV-PROGRAM-NAME                     05970008
059800                     MOVE SPACES TO AA-MESSAGE-1                  05980008
059900                                    AA-MESSAGE-2                  05990008
060000                     MOVE 'UNSUCCESSFUL UPDATE'                   06000008
060100                                         TO AA-DB2-OPERATION      06010008
060200                     MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE          06020008
060300                     PERFORM Z999-DB2-ABEND                       06030008
060400             END-EVALUATE                                         06040008
060500     END-PERFORM.                                                 06050008
060600                                                                  06060008
060700     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06070008
060800         MOVE PV-CURRENT-PARAGRAPH                                06080008
060900                             TO AA-PARAGRAPH-NAME                 06090008
061000         DISPLAY '******** PLAN_NAME:'                            06100008
061100                  PV-PROGRAM-NAME                                 06110008
061200         MOVE SPACES TO AA-MESSAGE-1                              06120008
061300                        AA-MESSAGE-2                              06130008
061400         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06140008
061500                             TO AA-DB2-OPERATION                  06150008
061600         MOVE 'TCKRSTCNTL'   TO AA-DB2-TABLE                      06160008
061700         PERFORM Z999-DB2-ABEND                                   06170008
061800     END-IF.                                                      06180008
061900                                                                  06190008
062000     EJECT                                                        06200008
062100*----------------------------------------------------------------*06210008
062200*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *06220008
062300*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *06230008
062400*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.        *06240008
062500*----------------------------------------------------------------*06250008
062600 X700-UPDATE-TCKRSTINF.                                           06260008
062700                                                                  06270008
062800     MOVE 'X700-UPDATE-TCKRSTINF' TO PV-CURRENT-PARAGRAPH.        06280008
062900                                                                  06290008
063000     MOVE PV-TWKORIN-INPUT-COUNT TO CR-EXTRACT-RECS-WORKED.       06300008
063100     MOVE CKPT-RESTART-INFO   TO TCKRSTINF-WORK-STRG-DESC-TEXT.   06310008
063200     MOVE 4022                TO TCKRSTINF-WORK-STRG-DESC-LEN.    06320008
063300                                                                  06330008
063400     PERFORM WITH TEST AFTER                                      06340008
063500             VARYING PC-RETRY-COUNT FROM 1 BY 1                   06350008
063600             UNTIL   PC-RETRY-COUNT > PC-RETRY-MAX OR             06360008
063700                     SQLCODE = ZERO                               06370008
063800                                                                  06380008
063900             EXEC SQL                                             06390008
064000                 UPDATE TCKRSTINF                                 06400008
064100                 SET WORK_STRG_DESC   = :TCKRSTINF-WORK-STRG-DESC 06410008
064200                 WHERE PLAN_NAME      = :PV-PROGRAM-NAME          06420008
064300             END-EXEC                                             06430008
064400                                                                  06440008
064500             EVALUATE TRUE                                        06450008
064600                 WHEN SQLCODE = ZERO                              06460008
064700                 WHEN SQLCODE = -904                              06470008
064800                 WHEN SQLCODE = -913                              06480008
064900                      CONTINUE                                    06490008
065000                                                                  06500008
065100                 WHEN SQLWARN0 NOT = SPACES                       06510008
065200                 WHEN SQLCODE  NOT = ZERO                         06520008
065300                     MOVE PV-CURRENT-PARAGRAPH                    06530008
065400                                         TO AA-PARAGRAPH-NAME     06540008
065500                     DISPLAY '******** PLAN_NAME:'                06550008
065600                              PV-PROGRAM-NAME                     06560008
065700                     MOVE SPACES TO AA-MESSAGE-1                  06570008
065800                                    AA-MESSAGE-2                  06580008
065900                     MOVE 'UNSUCCESSFUL UPDATE'                   06590008
066000                                         TO AA-DB2-OPERATION      06600008
066100                     MOVE 'TCKRSTINF'    TO AA-DB2-TABLE          06610008
066200                     PERFORM Z999-DB2-ABEND                       06620008
066300             END-EVALUATE                                         06630008
066400     END-PERFORM.                                                 06640008
066500                                                                  06650008
066600     IF PC-RETRY-COUNT > PC-RETRY-MAX                             06660008
066700         MOVE PV-CURRENT-PARAGRAPH                                06670008
066800                             TO AA-PARAGRAPH-NAME                 06680008
066900         DISPLAY '******** PLAN_NAME:'                            06690008
067000                  PV-PROGRAM-NAME                                 06700008
067100         MOVE SPACES TO AA-MESSAGE-1                              06710008
067200                        AA-MESSAGE-2                              06720008
067300         MOVE 'MAX RETRIES EXCEEDED ON UPDATE'                    06730008
067400                             TO AA-DB2-OPERATION                  06740008
067500         MOVE 'TCKRSTINF'    TO AA-DB2-TABLE                      06750008
067600         PERFORM Z999-DB2-ABEND                                   06760008
067700     END-IF.                                                      06770008
067800                                                                  06780008
067900 EJECT                                                            06790008
068000                                                                  06800008
068100*----------------------------------------------------------------*06810008
068200*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *06820008
068300*----------------------------------------------------------------*06830008
068400 Y100-COMMIT.                                                     06840008
068500                                                                  06850008
068600     MOVE 'Y100-COMMIT'    TO PV-CURRENT-PARAGRAPH.               06860008
068700                                                                  06870008
068800     EXEC SQL                                                     06880008
068900         COMMIT                                                   06890008
069000     END-EXEC.                                                    06900008
069100                                                                  06910008
069200     EVALUATE TRUE                                                06920008
069300         WHEN SQLCODE = ZEROS                                     06930008
069400             CONTINUE                                             06940008
069500         WHEN OTHER                                               06950008
069600             MOVE PV-CURRENT-PARAGRAPH                            06960008
069700                                 TO AA-PARAGRAPH-NAME             06970008
069800             MOVE SPACES TO AA-MESSAGE-1                          06980008
069900                            AA-MESSAGE-2                          06990008
070000             MOVE 'UNSUCCESSFUL COMMIT'                           07000008
070100                                 TO AA-DB2-OPERATION              07010008
070200             MOVE SPACES         TO AA-DB2-TABLE                  07020008
070300             PERFORM Z999-DB2-ABEND                               07030008
070400     END-EVALUATE.                                                07040008
070500 EJECT                                                            07050008
070600 Z900-PROCESS-ABEND.                                              07060008
070700                                                                  07070008
070800     DISPLAY '*** ABEND'.                                         07080008
070900     DISPLAY '*** PROGRAM   = AHKUP055'.                          07090008
071000     DISPLAY '*** PARAGRAPH = ' PV-CURRENT-PARAGRAPH.             07100008
071100     DISPLAY AA-MESSAGE-LINE-1.                                   07110008
071200     DISPLAY AA-MESSAGE-LINE-2.                                   07120008
071300     COPY DPPD004.                                                07130008
071400     CALL 'ILBOABN0' USING ABEND-CODE.                            07140008
071500                                                                  07150008
071600                                                                  07160008
071700                                                                  07170008
071800 Z999-DB2-ABEND.                                                  07180008
071900                                                                  07190008
072000     DISPLAY AA-ABEND-LIT.                                        07200008
072100     DISPLAY AA-DB2-ERROR-LIT.                                    07210008
072200     DISPLAY AA-PROGRAM-LIT.                                      07220008
072300     DISPLAY AA-PARAGRAPH-LIT.                                    07230008
072400     DISPLAY AA-DB2-OPERATION-LIT.                                07240008
072500     DISPLAY AA-DB2-TABLE.                                        07250008
072600     SET AC-DB2-ERROR TO TRUE.                                    07260008
072700                                                                  07270008
072800     COPY DPPD004.                                                07280008
072900                                                                  07290008
073000     CALL 'ILBOABN0' USING ABEND-CODE.                            07300008
