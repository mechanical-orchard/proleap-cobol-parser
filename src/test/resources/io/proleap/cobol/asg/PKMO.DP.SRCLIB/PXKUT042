       IDENTIFICATION DIVISION.                                         00010001
       PROGRAM-ID.           PXKUT042.                                  00020001
       AUTHOR.               D. WELLER                                  00030001
       INSTALLATION.         KOHLS DEPARTMENT STORES.                   00040001
       DATE-WRITTEN          03/07/2007.                                00050001
       DATE-COMPILED.                                                   00060001
                                                                        00070001
      ******************************************************************00080001
      *   PXKUT042 - FORMAT FILE FOR ORACLE                             00090001
      *                                                                 00100001
      *   THIS PROGRAM SEQUENTIALLY READS AN INPUT FILE (PXRD050)       00110001
      *   AND CREATES A DATA OUTPUT FILE (PXRD051) FOR UNIX             00120001
      *   AND A COUNT OUTPUT FILE (PXRD045) FOR UNIX.                   00130001
      ******************** HISTORY OF CHANGES **************************00140001
      * CHG ID/                                                        *00141001
      * WR/PROJ  DATE        DESCRIPTION OF CHANGES                    *00142001
      * -------  ----------  ----------------------------------------  *00143001
280975* SEPHORA  01/24/2023  ADDED TWO DB2 TABLES, XST-PRCHG TO GET    *00143119
280975* CHG0280975           THE DEPT-NBR OF THE PRCHG-ID AND TMDSEAR  *00143219
280975* BARB SCHULTZ         TO KNOW IF THE DEPT-NBR WAS A SEPHORA DEPT*00143319
280975******************************************************************00143719
                                                                        00145001
       ENVIRONMENT DIVISION.                                            00146001
                                                                        00147001
       CONFIGURATION SECTION.                                           00148001
                                                                        00149001
       SOURCE-COMPUTER. IBM-3090.                                       00150001
       OBJECT-COMPUTER. IBM-3090.                                       00160001
                                                                        00170001
       INPUT-OUTPUT SECTION.                                            00180001
       FILE-CONTROL.                                                    00190001
                                                                        00200001
           SELECT EXTRACT-FILE                                          00210001
               ASSIGN TO INP01.                                         00220001
                                                                        00230001
           SELECT DATA-FILE                                             00240001
               ASSIGN TO OUT01.                                         00250001
                                                                        00260001
           SELECT COUNT-FILE                                            00270001
               ASSIGN TO OUT02.                                         00280001
                                                                        00290001
       DATA DIVISION.                                                   00300001
                                                                        00310001
       FILE SECTION.                                                    00320001
       FD  EXTRACT-FILE                                                 00330001
           LABEL RECORDS ARE STANDARD                                   00340001
           RECORDING MODE IS F                                          00350001
           BLOCK CONTAINS 0 RECORDS.                                    00360001
       01  EXTRACT-RECORD                  PIC X(80).                   00370003
                                                                        00380001
       FD  DATA-FILE                                                    00390001
           LABEL RECORDS ARE STANDARD                                   00400001
           RECORDING MODE IS F                                          00410001
           BLOCK CONTAINS 0 RECORDS.                                    00420001
       01  DATA-RECORD                     PIC X(80).                   00430001
                                                                        00431001
       FD  COUNT-FILE                                                   00432001
           LABEL RECORDS ARE STANDARD                                   00433001
           RECORDING MODE IS F                                          00434001
           BLOCK CONTAINS 0 RECORDS.                                    00435001
       01  COUNT-RECORD                    PIC X(80).                   00436001
                                                                        00437001
       WORKING-STORAGE SECTION.                                         00438001
                                                                        00439001
      ***************************************************************** 00440001
      *  EXTRACT RECORD LAYOUT - INPUT                                  00450004
      ***************************************************************** 00460001
      *01  PXRD050-DATA-RECORD.                                         00470001
           COPY PXRD050.                                                00480001
                                                                        00490001
      ***************************************************************** 00500001
      *  DATA RECORD LAYOUT - OUTPUT                                    00510004
      ***************************************************************** 00520001
      *01  PXRD051-DATA-RECORD.                                         00530001
           COPY PXRD051.                                                00540001
                                                                        00550001
      ***************************************************************** 00560001
      *  COUNT RECORD LAYOUT - OUTPUT                                   00570004
      ***************************************************************** 00571001
      *01  PXRD045-COUNT-RECORD.                                        00572001
           COPY PXRD045.                                                00573001
                                                                        00573104
280975*----------------------------------------------------------*      00574021
280975* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         00574121
280975*----------------------------------------------------------*      00574221
280975     COPY DPWS004.                                                00574319
280975                                                                  00574419
280975*----------------------------------------------------------*      00574521
280975* DB2 MESSAGE AREA                                                00574621
280975*----------------------------------------------------------*      00574721
280975     COPY SQLCA2.                                                 00574819
280975                                                                  00574919
280975*----------------------------------------------------------*      00575021
280975* DB2 COMMUNICATIONS AREA                                         00575121
280975*----------------------------------------------------------*      00575221
280975     EXEC SQL                                                     00575319
280975       INCLUDE SQLCA                                              00575419
280975     END-EXEC.                                                    00577019
280975                                                                  00577119
280975*----------------------------------------------------------*      00577221
280975* DB2 TABLE XST_PRCHG                                             00577321
280975*----------------------------------------------------------*      00577421
280975     EXEC SQL                                                     00577519
280975       INCLUDE XST00063                                           00577619
280975     END-EXEC.                                                    00577719
280975                                                                  00577819
280975*----------------------------------------------------------*      00577921
280975* DB2 TABLE TMDSEAR                                               00578021
280975*----------------------------------------------------------*      00578121
280975     EXEC SQL                                                     00578219
280975       INCLUDE TMDSEAR                                            00578319
280975     END-EXEC.                                                    00578419
                                                                        00579004
      ***************************************************************** 00579104
      *  PROGRAM'S CONSTANTS                                          * 00579204
      ***************************************************************** 00579304
       01  PC-PROGRAM-CONSTANTS.                                        00579404
           05  PC-PROGRAM-NAME             PIC X(08)       VALUE        00579504
               'PXKUT042'.                                              00580001
                                                                        00590001
      ***************************************************************** 00600001
      *  PROGRAM'S SWITCHES                                           * 00610001
      ***************************************************************** 00620001
       01  PS-PROGRAM-SWITCHES.                                         00630001
           05  PS-END-OF-INPUT-FILE-SW     PIC X(01)       VALUE 'N'.   00640001
               88  PS-END-OF-INPUT-FILE                    VALUE 'Y'.   00650001
               88  PS-NOT-END-OF-INPUT-FILE                VALUE 'N'.   00660001
280975     05  PS-DEPT-NBR-SW              PIC X(01)       VALUE 'N'.   00661019
280975         88  PS-DEPT-NBR-YES                         VALUE 'Y'.   00662019
280975         88  PS-DEPT-NBR-NO                          VALUE 'N'.   00663019
280975     05  PS-SEPHORA-DEPT-NBR-SW      PIC X(01)       VALUE 'N'.   00664019
280975         88  PS-SEPHORA-DEPT-NBR-YES                 VALUE 'Y'.   00665019
280975         88  PS-SEPHORA-DEPT-NBR-NO                  VALUE 'N'.   00666019
                                                                        00670001
      ***************************************************************** 00680001
      *  PROGRAM'S VARIABLES                                          * 00690001
      ***************************************************************** 00700001
       01  PV-PROGRAM-VARIABLES.                                        00710001
           05  PV-PARAGRAPH-NAME           PIC X(40)       VALUE SPACES.00720001
           05  PV-RECORDS-READ             PIC 9(10)       VALUE 0.     00730001
           05  PV-RECORDS-WRITTEN          PIC 9(10)       VALUE 0.     00740001
280975     05  PV-SEPHORA-RECORD           PIC 9(10)       VALUE 0.     00750019
280975     05  PV-PXRD040-DEPT-N           PIC 9(03)       VALUE 0.     00752019
280975     05  PV-PXRD040-DEPT-NBR         PIC X(03)       VALUE SPACES.00753019
280975     05  PV-DEPT-NBR-COMP            PIC S9(04)V COMP VALUE 0.    00755219
280975     05  PV-DEPT-NBR                 PIC 9(04)       VALUE 0.     00755319
280975     05  PV-DEPT-NBR-PREV            PIC 9(04)       VALUE 0.     00755419
280975     05  PV-PRCHG-ID                 PIC S9(9) COMP  VALUE 0.     00755519
280975     05  PV-PRCHG-ID-PREV            PIC S9(9) COMP  VALUE 0.     00755819
280975     05  PV-SQL-CODE                 PIC S9(6) COMP-3 VALUE 0.    00755919
                                                                        00756010
      ***************************************************************** 00760001
      *  ABEND CODE AREA                                              * 00770001
      ***************************************************************** 00780001
       01  PV-ABEND-CODE                   PIC S9(04)      VALUE ZEROES 00790001
                               COMP SYNC.                               00800001
           88  ABEND-4001-INV-WRITE-KEY                    VALUE +4001. 00810001
           88  ABEND-4002-INV-READ-KEY                     VALUE +4002. 00820001
           88  ABEND-4003-CNTL-CARD-ERRORS                 VALUE +4003. 00830001
           88  ABEND-4004-SEQUENCE-ERROR                   VALUE +4004. 00840001
           88  ABEND-4005-OPEN-FILE-ERROR                  VALUE +4005. 00850001
           88  ABEND-4006-CLOSE-FILE-ERROR                 VALUE +4006. 00860001
           88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 00870001
           88  ABEND-4009-INVALID-DATA                     VALUE +4009. 00880001
           88  ABEND-4012-BAD-INTR-SORT                    VALUE +4012. 00890001
           88  ABEND-4013-DB-ERROR                         VALUE +4013. 00900001
                                                                        00910001
       01  WS-MSG-TEXT                     PIC X(512)      VALUE SPACES.00920001
       01  WS-MAX-SIZE                     PIC S9(09)      VALUE +512   00930001
                               COMP.                                    00940001
       01  WS-MSG-LENGTH                   PIC S9(09)      VALUE ZEROES 00950001
                               COMP.                                    00960001
                                                                        00973004
       PROCEDURE DIVISION.                                              00980001
                                                                        00990001
      ******************************************************************01000001
      *    MAINLINE LOGIC                                              *01010001
      ******************************************************************01020001
                                                                        01030001
       0000-MAINLINE.                                                   01040001
                                                                        01050001
           PERFORM 1000-INITIALIZATION.                                 01060001
                                                                        01070001
           PERFORM 2000-PROCESS-INPUT                                   01080001
               UNTIL PS-END-OF-INPUT-FILE.                              01090001
                                                                        01100001
           PERFORM 9900-EOJ-LOGIC.                                      01110001
                                                                        01120001
           GOBACK.                                                      01130001
                                                                        01140001
      ******************************************************************01150001
280975*  OPEN FILES AND READ FIRST INPUT RECORD                        *01160020
      ******************************************************************01170001
       1000-INITIALIZATION.                                             01180001
                                                                        01190001
           OPEN INPUT  EXTRACT-FILE.                                    01200001
           OPEN OUTPUT DATA-FILE.                                       01210001
           OPEN OUTPUT COUNT-FILE.                                      01220001
                                                                        01230001
           PERFORM 6100-READ-EXTRACT-FILE.                              01240001
           IF PS-END-OF-INPUT-FILE                                      01250001
               DISPLAY ' *** NOTHING TO PROCESS ***'                    01260001
               DISPLAY ' '                                              01270001
280975     ELSE                                                         01271020
280975         MOVE ZEROES           TO PV-PRCHG-ID-PREV                01272020
280975                                  PV-DEPT-NBR-PREV                01273020
           END-IF.                                                      01280001
                                                                        01290001
      ******************************************************************01300001
      *    2000-PROCESS-INPUT                                          *01310001
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE              *01320001
      *      PURPOSE: READ AND PROCESS THE PURCHASE ADJUSTMENT FILE    *01330001
      *               TO UPDATE THE DAT_AVL_VND_FUND TABLE             *01340001
      ******************************************************************01350001
       2000-PROCESS-INPUT.                                              01360001
                                                                        01370001
           PERFORM 7000-PROCESS-INPUT.                                  01380001
                                                                        01390001
           PERFORM 6100-READ-EXTRACT-FILE.                              01400001
                                                                        01410001
      ******************************************************************01420001
      *  READ EXTRACT FILE                                              01430001
      ******************************************************************01440001
       6100-READ-EXTRACT-FILE.                                          01450001
                                                                        01460001
           READ EXTRACT-FILE INTO PXRD050-DATA-RECORD                   01470001
               AT END SET PS-END-OF-INPUT-FILE TO TRUE.                 01480001
                                                                        01490001
           IF PS-NOT-END-OF-INPUT-FILE                                  01500001
               ADD 1 TO PV-RECORDS-READ                                 01510001
           END-IF.                                                      01520001
                                                                        01530001
      ******************************************************************01540001
      *  WRITE OUT DATA RECORD                                          01550001
      ******************************************************************01560001
       6300-WRITE-DATA-FILE.                                            01570001
                                                                        01580016
           WRITE DATA-RECORD FROM PXRD051-DATA-RECORD.                  01590001
           ADD 1 TO PV-RECORDS-WRITTEN.                                 01600001
                                                                        01610001
      ******************************************************************01620001
      *  WRITE OUT COUNT RECORD                                         01630001
      ******************************************************************01640001
       6400-WRITE-COUNT-FILE.                                           01650001
                                                                        01660001
           MOVE PV-RECORDS-WRITTEN     TO PXRD045-COUNT.                01670001
           WRITE COUNT-RECORD FROM PXRD045-COUNT-RECORD.                01680001
                                                                        01681001
      ******************************************************************01682001
      *  PROCESS INPUT                                                  01683001
      ******************************************************************01684001
       7000-PROCESS-INPUT.                                              01685001
                                                                        01686001
           MOVE '7000-PROCESS-INPUT'   TO PV-PARAGRAPH-NAME.            01687001
                                                                        01688012
           MOVE PXRD050-EVNT-CTG-CDE   TO PXRD051-EVNT-CTG-CDE.         01689001
           MOVE PXRD050-PRCHG-TYP-CDE  TO PXRD051-PRCHG-TYP-CDE.        01690001
           MOVE PXRD050-EVNT-DTE       TO PXRD051-EFF-DATE.             01700002
           MOVE PXRD050-STR-NBR        TO PXRD051-STR-NBR.              01710001
           MOVE PXRD050-SKU-NBR        TO PXRD051-SKU-NBR.              01720001
           IF PXRD050-STR-EXPTED-QTY < 0 THEN                           01730001
               MOVE ZEROES             TO PXRD051-STR-EXPTED-QTY        01740001
           ELSE                                                         01750001
               MOVE PXRD050-STR-EXPTED-QTY                              01751001
                                       TO PXRD051-STR-EXPTED-QTY        01752001
           END-IF.                                                      01753001
280975     IF PXRD050-PRCHG-ID = PV-PRCHG-ID-PREV                       01753619
280975        CONTINUE                                                  01753819
280975     ELSE                                                         01753919
280975        PERFORM 7500-LOOKUP-DEPT-NBR                              01754319
280975        MOVE XST00063-DEPT-NBR  TO PV-DEPT-NBR-PREV               01754419
280975        MOVE PXRD050-PRCHG-ID   TO PV-PRCHG-ID-PREV               01754519
280975     END-IF.                                                      01754619
280975                                                                  01754719
280975**** I ADDED DEPT-NBR TO THE FILE SO I COULD SEE THE DEPT. THIS   01754819
280975**** WAS NOT ADDED TO THE PRODUCTION FILE AND IS ONLY USED FOR    01754919
280975**** TESTING. ALSO NEED PXRD051 FROM TKMA.DP.SRCLIB FOR THIS.     01755019
280975**** MOVE PV-DEPT-NBR            TO PXRD051-DEPT-NBR.             01755119
                                                                        01755217
           MOVE PXRD050-PRCHG-ID       TO PXRD051-PRCHG-ID.             01755301
           MOVE PXRD050-NEW-UNT-RTL-AMT                                 01755401
                                       TO PXRD051-NEW-UNT-RTL-AMT.      01755501
           IF PXRD050-GP-RTL-QTY-NULL-IND = X'6F'                       01756001
               MOVE ZEROES             TO PXRD051-NW-GP-RTL-QTY         01757001
           ELSE                                                         01758001
               MOVE PXRD050-NW-GP-RTL-QTY                               01759001
                                       TO PXRD051-NW-GP-RTL-QTY         01759101
           END-IF.                                                      01760001
           IF PXRD050-GP-RTL-AMT-NULL-IND = X'6F'                       01770001
               MOVE ZEROES             TO PXRD051-NW-GP-RTL-AMT         01780001
           ELSE                                                         01790001
               MOVE PXRD050-NW-GP-RTL-AMT                               01800001
                                       TO PXRD051-NW-GP-RTL-AMT         01801001
           END-IF.                                                      01810001
                                                                        01820001
280975     IF PS-SEPHORA-DEPT-NBR-YES                                   01821119
280975        ADD +1 TO PV-SEPHORA-RECORD                               01822019
280975     ELSE                                                         01823019
280975        PERFORM 6300-WRITE-DATA-FILE                              01830019
280975     END-IF.                                                      01830119
280975                                                                  01831019
280975******************************************************************01832019
280975*  LOOK UP DEPT NBR ON XST_PRCHG                                  01832119
280975******************************************************************01832219
280975 7500-LOOKUP-DEPT-NBR.                                            01833019
280975                                                                  01833119
280975     MOVE 'N' TO PS-DEPT-NBR-SW.                                  01833219
280975     MOVE 'N' TO PS-SEPHORA-DEPT-NBR-SW.                          01833319
280975                                                                  01834019
280975     EXEC SQL                                                     01839019
280975        SELECT DEPT_NBR                                           01839119
280975           INTO :PV-DEPT-NBR-COMP                                 01839219
280975        FROM XST_PRCHG                                            01839319
280975        WHERE PRCHG_ID   = :PXRD050-PRCHG-ID                      01839419
280975     END-EXEC.                                                    01839919
280975                                                                  01840019
280975     EVALUATE TRUE                                                01840119
280975        WHEN SQLCODE = +0                                         01840219
280975             SET PS-DEPT-NBR-YES TO TRUE                          01840419
280975             MOVE PV-DEPT-NBR-COMP TO PV-DEPT-NBR                 01840619
280975             PERFORM 8000-FIND-IF-SEPHORA-DEPT                    01840819
280975        WHEN SQLCODE = +100                                       01840919
280975             SET PS-DEPT-NBR-NO  TO TRUE                          01841119
280975        WHEN OTHER                                                01841219
280975             SET PS-DEPT-NBR-NO  TO TRUE                          01841419
280975     END-EVALUATE.                                                01841519
280975                                                                  01841619
280975******************************************************************01842119
280975*  FIND IF THE RECORD HAS A SEPHORA DEPT                          01842219
280975******************************************************************01842319
280975 8000-FIND-IF-SEPHORA-DEPT.                                       01843019
280975                                                                  01844019
280975     MOVE PV-DEPT-NBR           TO PV-PXRD040-DEPT-N.             01846019
280975     MOVE PV-PXRD040-DEPT-N     TO PV-PXRD040-DEPT-NBR.           01847019
280975     SET PS-SEPHORA-DEPT-NBR-NO TO TRUE.                          01847119
280975                                                                  01848019
280975     EXEC SQL                                                     01849019
280975        SELECT DEPT_NBR                                           01849119
280975           INTO :MDSEAR-DEPT-NBR                                  01849219
280975        FROM TMDSEAR                                              01849319
280975        WHERE DMA_NBR    = '50'                                   01849419
280975          AND MDSELV_CDE = 'DPT'                                  01849519
280975          AND DEPT_NBR   = :PV-PXRD040-DEPT-NBR                   01849619
280975          AND STRT_DTE  <= CURRENT DATE                           01849719
280975          AND END_DTE   >= CURRENT DATE                           01849819
280975     END-EXEC.                                                    01849919
280975                                                                  01850019
280975     EVALUATE TRUE                                                01850119
280975        WHEN SQLCODE = +0                                         01850219
280975             SET PS-SEPHORA-DEPT-NBR-YES TO TRUE                  01850419
280975        WHEN SQLCODE = +100                                       01850519
280975             SET PS-SEPHORA-DEPT-NBR-NO  TO TRUE                  01850719
280975        WHEN OTHER                                                01850819
280975             SET PS-SEPHORA-DEPT-NBR-NO  TO TRUE                  01851019
280975     END-EVALUATE.                                                01851119
280975                                                                  01851219
      ******************************************************************01852004
      *    9900-EOJ-LOGIC.                                              01860001
      *      THIS IS PERFORMED AT END OF INPUT FILE.                    01870001
      *      PURPOSE: CLOSE INPUT FILE,                                 01880001
      *      DISPLAY RECORD COUNTS.                                     01890001
      ******************************************************************01900001
       9900-EOJ-LOGIC.                                                  01910001
                                                                        01920001
           PERFORM 6400-WRITE-COUNT-FILE.                               01930001
           CLOSE EXTRACT-FILE.                                          01940001
           CLOSE DATA-FILE.                                             01950001
           CLOSE COUNT-FILE.                                            01960001
                                                                        01970001
           DISPLAY ' '.                                                 01980001
           DISPLAY 'RECORDS READ       ' PV-RECORDS-READ.               01990001
           DISPLAY 'PARAMETERS WRITTEN ' PV-RECORDS-WRITTEN.            02000001
280975     DISPLAY 'SEPHORA RECORD NOT WRITTEN ' PV-SEPHORA-RECORD.     02001019
           DISPLAY '**------ END ' PC-PROGRAM-NAME ' ------**'.         02010001
                                                                        02020001
      ******************************************************************02030001
      * PROGRAM ABEND PARAGRAPH                                         02040001
      ******************************************************************02050001
       9999-ABEND.                                                      02060001
                                                                        02070001
           CALL 'ILBOABN0'  USING PV-ABEND-CODE.                        02080001
                                                                        02090001
      ******************************************************************02100001
      *    END OF SOURCE CODE FOR PXKUT042                             *02110001
      ******************************************************************02120001
