       IDENTIFICATION DIVISION.                                         00010001
       PROGRAM-ID.           PXKUT034.                                  00020001
       AUTHOR.               D. WELLER                                  00030001
       INSTALLATION.         KOHLS DEPARTMENT STORES.                   00040001
       DATE-WRITTEN          08/13/2007.                                00050034
       DATE-COMPILED.                                                   00060001
                                                                        00070001
      ******************************************************************00080001
      *   PXKUT034 - CANCEL PRICE CHANGE EVENTS IN ORACLE               00090040
      *              REACTIVATE PRICE CHANGE EVENTS IN ORACLE           00091040
      *                                                                 00100001
      *   THIS PROGRAM SEQUENTIALLY READS AN INPUT FILE (PXRD043)       00110001
      *   AND USES IT TO CHANGE THE STATUS IN ORACLE TABLE PXT_EVNT     00120034
      *   TO 'C' (CANCELLED) OR 'A' (ACTIVE).                           00130040
      ******************** HISTORY OF CHANGES **************************00150001
      * CHG ID/                                                        *00160001
      * WR/PROJ          DATE        DESCRIPTION OF CHANGES            *00170040
      * ---------------  ----------  --------------------------------  *00180040
      * INC000000251806  02/07/2008  ADD THE ABILITY TO REACTIVATE      00181040
      *                              CANCELLED EVENTS                   00182040
      * CHG ID/                                                        *00183046
      * WR/PROJ          DATE        DESCRIPTION OF CHANGES            *00184046
      * ---------------  ----------  --------------------------------  *00185046
      * CHG0212016       10/26/2018  CHANGED PROGRAM TO EXTERNALIZE     00186047
      *                              ORACLE LOGON                       00187046
      *                              CHANGES ARE TAGGED TO CHG016.      00188047
      ******************************************************************00190001
                                                                        00200001
       ENVIRONMENT DIVISION.                                            00210001
                                                                        00220001
       CONFIGURATION SECTION.                                           00230001
                                                                        00240001
       SOURCE-COMPUTER. IBM-3090.                                       00250001
       OBJECT-COMPUTER. IBM-3090.                                       00260001
                                                                        00270001
       INPUT-OUTPUT SECTION.                                            00280001
       FILE-CONTROL.                                                    00290001
CHG016     SELECT ORACLE-LOGON-FILE                                     00300047
CHG016         ASSIGN TO ORALOGON.                                      00310047
                                                                        00320001
           SELECT INPUT-FILE                                            00330040
               ASSIGN TO INP02.                                         00340001
                                                                        00350001
       DATA DIVISION.                                                   00420001
                                                                        00430001
       FILE SECTION.                                                    00440001
CHG016 FD  ORACLE-LOGON-FILE                                            00450047
CHG016     RECORDING MODE IS F                                          00460047
CHG016     LABEL RECORDS ARE STANDARD                                   00470047
CHG016     BLOCK CONTAINS 0 RECORDS                                     00480047
CHG016     RECORD CONTAINS 80 CHARACTERS                                00490047
CHG016     DATA RECORDS IS OL-ORACLE-LOGON-RECORD.                      00491047
CHG016 01  OL-ORACLE-LOGON-RECORD          PIC X(80).                   00492047
                                                                        00500001
       FD  INPUT-FILE                                                   00510040
           LABEL RECORDS ARE STANDARD                                   00520001
           RECORDING MODE IS F                                          00530011
           BLOCK CONTAINS 0 RECORDS.                                    00540001
       01  INPUT-RECORD                    PIC X(80).                   00550040
                                                                        00560001
       WORKING-STORAGE SECTION.                                         00690001
                                                                        00700001
      ***************************************************************** 00710001
      *  INPUT RECORD LAYOUT                                            00720040
      ***************************************************************** 00730001
      *01  PX043-RECORD.                                                00740040
           COPY PXRD043.                                                00750001
                                                                        00750105
      *----------------------------------------------------------       00751005
      *                      O  R  A  C  L  E                           00752005
      *==========================================================       00753005
      *                                                                 00754005
      * ORACLE DECLARE SECTION                                          00755005
      * ORACLE USED AND RETURNED VARIABLES                              00756005
      *                                                                 00757005
      *----------------------------------------------------------       00758005
           COPY PXWS001.                                                00759005
                                                                        00760001
                                                                        01010003
      ***************************************************************** 01020003
      *  PROGRAM'S ACCUMULATORS                                       * 01030003
      ***************************************************************** 01040003
       01  PA-PROGRAM-ACCUMULATORS.                                     01050003
           05  PA-ROWS-CANCELLED           PIC 9(10)       VALUE ZEROES.01080034
           05  PA-ROWS-ACTIVATED           PIC 9(10)       VALUE ZEROES.01081040
           05  PA-ROWS-TO-COMMIT           PIC 9(10)       VALUE ZEROES.01090034
           05  PA-RECORDS-READ             PIC 9(10)       VALUE ZEROES.01103026
                                                                        01130001
      ***************************************************************** 01140001
      *  PROGRAM'S CONSTANTS                                          * 01150001
      ***************************************************************** 01160001
       01  PC-PROGRAM-CONSTANTS.                                        01170001
           05  PC-MAX-DEADLOCKS            PIC S9(04)      VALUE +3.    01180001
           05  PC-PROGRAM-NAME             PIC X(08)       VALUE        01190026
               'PXKUT034'.                                              01200001
           05  PC-AUTO-LOGON               PIC X(1)        VALUE '/'.   01210041
      *    05  PC-ORACLE-PROD-ID-LGTH      PIC 9(02)       VALUE 1.     01220041
                                                                        01230001
      ***************************************************************** 01240001
      *  PROGRAM'S SWITCHES                                           * 01250001
      ***************************************************************** 01260001
       01  PS-PROGRAM-SWITCHES.                                         01270001
           05  PS-END-OF-INP-FILE-SW       PIC X(01)       VALUE 'N'.   01280040
               88  PS-END-OF-INP-FILE                      VALUE 'Y'.   01290040
               88  PS-NOT-END-OF-INP-FILE                  VALUE 'N'.   01300040
           05  PS-END-OF-CONTROL-CARDS-SW  PIC X(01)       VALUE 'N'.   01310001
               88  PS-END-OF-CONTROL-CARDS                 VALUE 'Y'.   01320001
               88  PS-NOT-END-OF-CONTROL-CARDS             VALUE 'N'.   01330001
           05  PS-ROW-PROCESSED-SW         PIC X(01)       VALUE 'N'.   01331006
               88  PS-ROW-PROCESSED                        VALUE 'Y'.   01332006
               88  PS-ROW-NOT-PROCESSED                    VALUE 'N'.   01333006
           05  PS-ROW-FOUND-SW             PIC X(01)       VALUE 'N'.   01334006
               88  PS-ROW-FOUND                            VALUE 'Y'.   01335006
               88  PS-ROW-NOT-FOUND                        VALUE 'N'.   01336006
           05  PS-REQUEST-STATUS           PIC X(08)       VALUE SPACES.01430001
               88  PS-UPDATE-REQUEST                       VALUE        01440001
                   'UPDATE  '.                                          01450001
               88  PS-INSERT-REQUEST                       VALUE        01460001
                   'INSERT  '.                                          01470001
               88  PS-NEGATIVE-FOUND                       VALUE        01480001
                   'NEG FND '.                                          01490001
           05  PS-OPERATION-ATTEMPTED      PIC X(40)       VALUE SPACES.01500001
               88  PS-DEADLOCK-MSG                         VALUE        01510001
                   'MAXIMUM DEADLOCK COUNT EXCEEDED         '.          01520001
               88  PS-CHECK-AVL-FUND-MSG                   VALUE        01530001
                   'CHECKING AVAILABLE FUND FAILED          '.          01540001
               88  PS-CHECKPOINT-UPDATE-MSG                VALUE        01550001
                   'UPDATE CHECKPOINT FAILED                '.          01560001
               88  PS-COMMIT-MSG                           VALUE        01570001
                   'COMMIT FAILED                           '.          01580001
               88  PS-ORA-LOGIN-MSG                        VALUE        01590001
                   'ORACLE LOGIN FAILED                     '.          01600001
               88  PS-UPDATE-AVL-FUND-MSG                  VALUE        01610001
                   'UPDATE OF AVAILABLE FUND FAILED         '.          01620001
               88  PS-INSERT-AVL-FUND-MSG                  VALUE        01630001
                   'INSERT OF NEW AVAILABLE FUND FAILED     '.          01640001
               88  PS-GET-RESTART-MSG                      VALUE        01650001
                   'GETTING RESTARTING INFORMATION FAILED   '.          01660001
               88  PS-CHECK-RESTART-MSG                    VALUE        01670001
                   'CHECKING RESTARTING CONTROL FAILED      '.          01680001
CHG016     05  PS-END-OF-LOGON-FILE-SW          PIC  X(01) VALUE 'N'.   01681047
CHG016         88 PS-END-OF-LOGON-FILE                     VALUE 'Y'.   01682047
CHG016     05  PS-ORA-SRC-CTL-DONE-SW           PIC  X(01) VALUE 'N'.   01683047
CHG016         88  PS-ORACLE-SRC-EMPTY                     VALUE 'Y'.   01684047
                                                                        01690001
      ***************************************************************** 01700001
      *  PROGRAM'S VARIABLES                                          * 01710001
      ***************************************************************** 01720001
       01  PV-PROGRAM-VARIABLES.                                        01730001
           05  PV-PRCHG-EFF-DTE            PIC  X(10)  VALUE SPACES.    01730106
           05  PV-TABLE-NAME               PIC  X(30)  VALUE SPACES.    01731005
           05  PV-RETRY-COUNT              PIC S9(04)  VALUE ZEROES.    01740006
           05  PV-PARAGRAPH-NAME           PIC X(40)   VALUE SPACES.    01750006
           05  PV-OPERATION-MSG            PIC  X(60)  VALUE SPACES.    01750105
           05  PV-OPERATION-MSG-1          PIC  X(40)  VALUE SPACES.    01750205
           05  PV-OPERATION-MSG-2          PIC  X(40)  VALUE SPACES.    01750305
           05  PV-EVNT-CDE                 PIC X(03)   VALUE SPACES.    01751006
           05  PV-NULL-RETURN              PIC S9(04)  VALUE ZEROES     01760006
                               COMP.                                    01770001
           05  PV-COMMIT-MAX               PIC S9(05)  VALUE ZEROES     01800006
                               COMP.                                    01801003
CHG016     05  PV-ORACLE-USERID-LEN        PIC S9(4)   VALUE ZEROS      01802047
CHG016                                                 COMP SYNC.       01803047
CHG016     05  PV-ORACLE-PASSWORD-LEN      PIC S9(4)   VALUE ZEROS      01804047
CHG016                                                 COMP SYNC.       01805047
                                                                        01810001
CHG016******************************************************************01820047
CHG016*      ORACLE CONNECTION VARIABLES                                01821047
CHG016******************************************************************01821147
005100 01  CC-ORACLE-CONNECTION.                                        01821241
CHG016     05  CC-ORACLE-USERID             PIC X(40).                  01821347
CHG016         88 CC-AUTO-LOGON                            VALUE '/'.   01821447
CHG016     05  CC-ORACLE-PASSWORD           PIC X(40).                  01821547
CHG016                                                                  01821647
      ***************************************************************** 01822001
      *  ABEND CODE AREA                                              * 01830001
      ***************************************************************** 01840001
       01  ABEND-CODE                      PIC S9(04)  VALUE +0  COMP.  01850005
           88  ABEND-4001-WRITE-ERROR                  VALUE +4001.     01860005
           88  ABEND-4002-READ-ERROR                   VALUE +4002.     01870005
           88  ABEND-4003-CTRL-CARD-ERROR              VALUE +4003.     01880005
           88  ABEND-4004-TABLE-ERROR                  VALUE +4004.     01890005
           88  ABEND-4005-OPEN-ERROR                   VALUE +4005.     01900005
           88  ABEND-4006-CLOSE-ERROR                  VALUE +4006.     01910005
           88  ABEND-4007-SEQUENCE-ERROR               VALUE +4007.     01920005
           88  ABEND-4008-DATA-ERROR                   VALUE +4008.     01930005
           88  ABEND-4009-KEY-DATA-ERROR               VALUE +4009.     01940005
           88  ABEND-4013-DB-ERROR                     VALUE +4013.     01950005
           88  ABEND-4014-ORACLE-LOGON-ERROR           VALUE +4014.     01960005
           88  ABEND-4019-DATE-ROUTINE-ERROR           VALUE +4019.     01970005
           88  ABEND-4444-FORCED-ABEND                 VALUE +4444.     01971005
                                                                        01980001
       01  WS-MSG-TEXT                     PIC X(512)      VALUE SPACES.01990001
       01  WS-MAX-SIZE                     PIC S9(09)      VALUE +512   02000001
                               COMP.                                    02010001
       01  WS-MSG-LENGTH                   PIC S9(09)      VALUE ZEROES 02020001
                               COMP.                                    02030001
                                                                        02040001
      ******************************************************************02050001
      *    ORACLE DECLARE SECTION                                       02060001
      ******************************************************************02070001
           EXEC SQL BEGIN DECLARE SECTION END-EXEC.                     02080001
                                                                        02081025
       01  PV-ORACLE-ID                    PIC  X(01)  VALUE '/'.       02092005
       01  USERNAME                        PIC X(10)      VARYING.      02100001
       01  PASSWD                          PIC X(10)      VARYING.      02110001
                                                                        02120001
      ******************************************************************02130001
      * COBOL DECLARATION FOR TABLE PXT_EVNT                           *02140001
      ******************************************************************02150001
           EXEC SQL                                                     02160001
               INCLUDE PXT00006                                         02170004
           END-EXEC.                                                    02180001
                                                                        02282001
           EXEC SQL END DECLARE SECTION END-EXEC.                       02290001
      *                                                                 02300001
      * ORA COMMUNICATION AREA                                          02310001
      *                                                                 02320001
        01       SQLCA.                                                 02330001
                 05  SQLCAID               PIC X(8).                    02340001
                 05  SQLCABC               PIC S9(9) COMPUTATIONAL.     02350001
                 05  SQLCODE               PIC S9(9) COMPUTATIONAL.     02360001
                 05  SQLERRM.                                           02370001
                     49 SQLERRML           PIC S9(4) COMPUTATIONAL.     02380001
                     49 SQLERRMC           PIC X(70).                   02390001
                 05  SQLERRP               PIC X(8).                    02400001
                 05  SQLERRD OCCURS 6 TIMES                             02410001
                                           PIC S9(9) COMPUTATIONAL.     02420001
                 05  SQLWARN.                                           02430001
                     10 SQLWARN0           PIC X(1).                    02440001
                     10 SQLWARN1           PIC X(1).                    02450001
                     10 SQLWARN2           PIC X(1).                    02460001
                     10 SQLWARN3           PIC X(1).                    02470001
                     10 SQLWARN4           PIC X(1).                    02480001
                     10 SQLWARN5           PIC X(1).                    02490001
                     10 SQLWARN6           PIC X(1).                    02500001
                     10 SQLWARN7           PIC X(1).                    02510001
                 05  SQLEXT                PIC X(8).                    02520001
      ******************************************************************02530001
      * ORA COMMUNICATION AREA2                                         02540001
           COPY SQLCA2.                                                 02550001
                                                                        02560001
       PROCEDURE DIVISION.                                              02570001
                                                                        02580001
      ******************************************************************02590001
      *    MAINLINE LOGIC                                              *02600001
      ******************************************************************02610001
                                                                        02620001
       0000-MAINLINE.                                                   02630001
                                                                        02640001
           PERFORM 1000-INITIALIZATION.                                 02650001
                                                                        02660001
           PERFORM 2000-PROCESS-INPUT                                   02670001
               UNTIL PS-END-OF-INP-FILE.                                02680040
                                                                        02690001
           PERFORM 9900-EOJ-LOGIC.                                      02700001
                                                                        02710001
           GOBACK.                                                      02720001
                                                                        02721005
      ******************************************************************02740001
      *    LOGON TO ORACLE, AND DECLARE THE ORACLE CURSORS.            *02750001
      ******************************************************************02760001
       1000-INITIALIZATION.                                             02770001
                                                                        02780001
           OPEN INPUT  ORACLE-LOGON-FILE.                               02790041
CHG016                                                                  02791047
CHG016     DISPLAY 'ORACLE FILE READ'.                                  02792047
CHG016     PERFORM 7500-READ-ORACLE-LOGON.                              02793047
CHG016                                                                  02794047
CHG016     DISPLAY 'ORACLE FILE CLOSE'.                                 02795047
CHG016     CLOSE ORACLE-LOGON-FILE.                                     02796047
CHG016                                                                  02797047
CHG016     IF ((PS-END-OF-LOGON-FILE)                                   02798047
CHG016              OR (CC-ORACLE-CONNECTION = SPACES))                 02799047
CHG016           DISPLAY '** ABEND **'                                  02799147
CHG016           DISPLAY PC-PROGRAM-NAME ' - ORACLE LOGON CONTROL CARD '02799247
CHG016               'NOT PROVIDED'                                     02799347
CHG016           SET PS-ORACLE-SRC-EMPTY TO TRUE                        02799447
CHG016           CALL 'ILBOABN0' USING ABEND-CODE                       02799547
CHG016     END-IF.                                                      02799647
CHG016                                                                  02799747
CHG016         IF CC-AUTO-LOGON                                         02799847
CHG016             DISPLAY PC-PROGRAM-NAME  ' - AUTO LOGON TO ORACLE'   02799947
CHG016             EXEC SQL                                             02800047
CHG016               CONNECT  :PC-AUTO-LOGON                            02801047
CHG016             END-EXEC                                             02802047
CHG016     ELSE                                                         02803047
CHG016         INITIALIZE PV-ORACLE-USERID-LEN                          02804047
CHG016                    PV-ORACLE-PASSWORD-LEN                        02805047
CHG016           INSPECT    CC-ORACLE-USERID                            02806047
CHG016             TALLYING   PV-ORACLE-USERID-LEN                      02807047
CHG016             FOR CHARACTERS BEFORE INITIAL SPACE                  02808047
CHG016           INSPECT    CC-ORACLE-PASSWORD                          02809047
CHG016             TALLYING   PV-ORACLE-PASSWORD-LEN                    02809147
CHG016             FOR CHARACTERS BEFORE INITIAL SPACE                  02809247
CHG016         MOVE CC-ORACLE-USERID (1:PV-ORACLE-USERID-LEN) TO        02809347
CHG016                    USERNAME-ARR                                  02809447
CHG016         MOVE PV-ORACLE-USERID-LEN TO USERNAME-LEN                02809547
CHG016         MOVE CC-ORACLE-PASSWORD (1:PV-ORACLE-PASSWORD-LEN) TO    02809647
CHG016                      PASSWD-ARR                                  02809747
CHG016         MOVE PV-ORACLE-PASSWORD-LEN TO PASSWD-LEN                02809847
CHG016           DISPLAY PC-PROGRAM-NAME  ' - LOGON TO ORACLE AS USER ' 02809947
CHG016                      USERNAME-ARR                                02810047
CHG016            EXEC SQL                                              02811047
CHG016                 CONNECT :USERNAME IDENTIFIED BY :PASSWD          02812047
CHG016            END-EXEC                                              02813047
CHG016         INITIALIZE CC-ORACLE-PASSWORD                            02814047
CHG016                    PASSWD                                        02815047
CHG016     END-IF.                                                      02816047
CHG016                                                                  02817047
CHG016         IF SQLCODE NOT = 0                                       02818047
CHG016               DISPLAY '** CONNECTING TO ORACLE BY USERID **'     02819047
CHG016               DISPLAY 'TRIED TO CONNECT TO ORACLE UNDER: '       02819147
CHG016                                  PASSWD                          02819247
CHG016            SET ABEND-4014-ORACLE-LOGON-ERROR TO TRUE             02819347
CHG016               PERFORM Z100-ABEND                                 02819447
CHG016         END-IF.                                                  02819547
CHG016                                                                  02819647
           OPEN INPUT  INPUT-FILE.                                      02820040
                                                                        03150001
           PERFORM 6100-READ-INPUT-FILE.                                03160040
           IF PS-END-OF-INP-FILE                                        03170040
               DISPLAY ' *** NOTHING TO PROCESS ***'                    03180001
               DISPLAY ' '                                              03190001
           END-IF.                                                      03220001
                                                                        03230024
      ******************************************************************03780001
      *    2000-PROCESS-INPUT                                          *03790001
      *      THIS IS PERFORMED ONLY VIA THE 0000-MAINLINE              *03800001
      *      PURPOSE: READ AND PROCESS THE FILES EXTRACTED IN JOBS     *03810023
      *               PXK006, PXK007 AND PXK008 TO                      03811023
      *               TO DELETE FROM THE PXT_EVNT                       03820023
      *               AND THE PXT_EVNT_STR_MDSE TABLES.                 03821023
      ******************************************************************03830001
       2000-PROCESS-INPUT.                                              03840001
                                                                        03850001
           PERFORM 7000-ORACLE-CANCELLATIONS.                           03860037
                                                                        03870001
           PERFORM 6100-READ-INPUT-FILE.                                03880040
                                                                        03890001
      ******************************************************************03990001
      *  READ DELETE IN FILE                                            04000006
      ******************************************************************04010001
       6100-READ-INPUT-FILE.                                            04020040
                                                                        04030001
           READ INPUT-FILE INTO PX043-RECORD                            04040040
               AT END SET PS-END-OF-INP-FILE TO TRUE.                   04050040
                                                                        04060001
           IF PS-NOT-END-OF-INP-FILE                                    04070040
               ADD 1 TO PA-RECORDS-READ                                 04080026
           END-IF.                                                      04090001
                                                                        04240001
      ******************************************************************04370001
      *  DO DELETES IN ORACLE                                           04380003
      ******************************************************************04390001
       7000-ORACLE-CANCELLATIONS.                                       04400037
                                                                        04410001
           MOVE '7000-ORACLE-CANCELLATIONS' TO PV-PARAGRAPH-NAME.       04420037
                                                                        04421004
           PERFORM 7900-SELECT-EVNT-CDE.                                04422004
           IF PS-ROW-FOUND                                              04423004
               IF PX043-CDE = 'C'                                       04440040
                   PERFORM 7100-CANCEL-EVNT                             04441034
               END-IF                                                   04450004
               IF PX043-CDE = 'A'                                       04460040
                   PERFORM 7200-ACTIVATE-EVNT                           04470040
               END-IF                                                   04480040
           ELSE                                                         04490104
               DISPLAY '** EVNT_CDE NOT FOUND'                          04490204
               DISPLAY '** PRCHG-TYP-CDE:  ' PX043-PRCHG-TYP-CDE        04490304
               DISPLAY '** EVNT-CTG-CDE:   ' PX043-EVNT-CTG-CDE         04490404
           END-IF.                                                      04500004
                                                                        04510019
      ******************************************************************04632403
      *  CANCEL ROW IN PXT_EVNT                                         04633034
      ******************************************************************04634003
       7100-CANCEL-EVNT.                                                04635034
                                                                        04636003
           MOVE '7100-CANCEL-EVNT'     TO PV-PARAGRAPH-NAME.            04637034
           MOVE PX043-PRCHG-EFF-DTE    TO PV-PRCHG-EFF-DTE.             04637106
                                                                        04638003
           EXEC SQL                                                     04639003
               UPDATE                                                   04639134
                       PXT_EVNT                                         04639204
                  SET  EVNT_STAT_CDE = 'C'                              04639334
                 WHERE                                                  04639803
                       EVNT_CDE    = :PV-EVNT-CDE                       04639904
                   AND EVNT_DTE    =                                    04640006
                       TO_DATE(:PV-PRCHG-EFF-DTE,'YYYY-MM-DD')          04640406
           END-EXEC.                                                    04640606
                                                                        04640706
           EVALUATE TRUE                                                04640806
               WHEN SQLCODE = 0                                         04640906
                   ADD +1              TO PA-ROWS-CANCELLED             04641034
                   DISPLAY '=== EVENT CANCELLED ==='                    04641136
                   DISPLAY 'EVENT CODE:  ' PV-EVNT-CDE                  04641236
                   DISPLAY 'EVENT DATE:  ' PV-PRCHG-EFF-DTE             04641336
                   PERFORM 8000-CHECK-COMMIT                            04641406
      * ORACLE RETURNS SQLCODE = 1403 WHEN NO ROW IS FOUND              04641513
               WHEN SQLCODE = 1403                                      04641612
                   DISPLAY '--- EVENT NOT FOUND ---'                    04641738
                   DISPLAY 'EVENT CODE:  ' PV-EVNT-CDE                  04641837
                   DISPLAY 'EVENT DATE:  ' PV-PRCHG-EFF-DTE             04641937
                   PERFORM 8000-CHECK-COMMIT                            04642012
               WHEN OTHER                                               04642112
                   DISPLAY '** PRCHG-TYP-CDE:  ' PX043-PRCHG-TYP-CDE    04642226
                   DISPLAY '** EVNT-CTG-CDE:   ' PX043-EVNT-CTG-CDE     04642326
                   DISPLAY '** PRCHG-EFF-DTE:  ' PX043-PRCHG-EFF-DTE    04642426
                   DISPLAY '** STR-NBR:        ' PX043-STR-NBR          04642526
                   DISPLAY '** SKU-NBR:        ' PX043-SKU-NBR          04642626
                   DISPLAY '** RECORD:         ' PA-RECORDS-READ        04642726
                   PERFORM 9990-SQL-ERROR                               04642806
           END-EVALUATE.                                                04642906
                                                                        04643007
      ******************************************************************04645040
      *  ACTIVATE ROW IN PXT_EVNT                                       04646040
      ******************************************************************04647040
       7200-ACTIVATE-EVNT.                                              04648040
                                                                        04649040
           MOVE '7200-CANCEL-EVNT'     TO PV-PARAGRAPH-NAME.            04650040
           MOVE PX043-PRCHG-EFF-DTE    TO PV-PRCHG-EFF-DTE.             04660040
                                                                        04670040
           EXEC SQL                                                     04680040
               UPDATE                                                   04690040
                       PXT_EVNT                                         04700040
                  SET  EVNT_STAT_CDE = 'A'                              04710040
                 WHERE                                                  04720040
                       EVNT_CDE    = :PV-EVNT-CDE                       04730040
                   AND EVNT_DTE    =                                    04740040
                       TO_DATE(:PV-PRCHG-EFF-DTE,'YYYY-MM-DD')          04750040
           END-EXEC.                                                    04760040
                                                                        04770040
           EVALUATE TRUE                                                04780040
               WHEN SQLCODE = 0                                         04790040
                   ADD +1              TO PA-ROWS-ACTIVATED             04800040
                   DISPLAY '=== EVENT ACTIVATED ==='                    04810040
                   DISPLAY 'EVENT CODE:  ' PV-EVNT-CDE                  04820040
                   DISPLAY 'EVENT DATE:  ' PV-PRCHG-EFF-DTE             04830040
                   PERFORM 8000-CHECK-COMMIT                            04840040
      * ORACLE RETURNS SQLCODE = 1403 WHEN NO ROW IS FOUND              04850040
               WHEN SQLCODE = 1403                                      04860040
                   DISPLAY '--- EVENT NOT FOUND ---'                    04870040
                   DISPLAY 'EVENT CODE:  ' PV-EVNT-CDE                  04880040
                   DISPLAY 'EVENT DATE:  ' PV-PRCHG-EFF-DTE             04890040
                   PERFORM 8000-CHECK-COMMIT                            04900040
               WHEN OTHER                                               04910040
                   DISPLAY '** PRCHG-TYP-CDE:  ' PX043-PRCHG-TYP-CDE    04920040
                   DISPLAY '** EVNT-CTG-CDE:   ' PX043-EVNT-CTG-CDE     04930040
                   DISPLAY '** PRCHG-EFF-DTE:  ' PX043-PRCHG-EFF-DTE    04940040
                   DISPLAY '** STR-NBR:        ' PX043-STR-NBR          04950040
                   DISPLAY '** SKU-NBR:        ' PX043-SKU-NBR          04960040
                   DISPLAY '** RECORD:         ' PA-RECORDS-READ        04970040
                   PERFORM 9990-SQL-ERROR                               04980040
           END-EVALUATE.                                                04990040
                                                                        05000040
      ******************************************************************05180001
      *  SELECT EVNT_CDE - PXT_EVNT HAS THE EVNT_CDE ONLY.  IT DOESN'T  05190037
      *                    HAVE THE PRCHG_TYP_CDE OR THE EVNT_CTG_CDE.  05191037
      *                    THIS LOOKUP GETS THE EVNT_CDE FROM ORACLE    05192037
      *                    FROM ORACLE TABLE PXT_EVNT_CDE_PRCHG_XREF.   05193037
      ******************************************************************05200001
       7900-SELECT-EVNT-CDE.                                            05220003
                                                                        05230001
           MOVE '7900-SELECT-EVNT-CDE' TO PV-PARAGRAPH-NAME.            05240003
                                                                        05250001
           EXEC SQL                                                     05260001
                 SELECT                                                 05270001
                       A.EVNT_CDE                                       05280003
                 INTO                                                   05290001
                       :PV-EVNT-CDE            :PV-NULL-RETURN          05300003
                 FROM                                                   05310001
                       PXT_EVNT_CDE_PRCHG_XREF A                        05320003
                 WHERE                                                  05340001
                       A.PRCHG_TYP_CDE =  :PX043-PRCHG-TYP-CDE          05350006
                   AND A.EVNT_CTG_CDE  =  :PX043-EVNT-CTG-CDE           05360006
           END-EXEC.                                                    05430001
                                                                        05440001
           EVALUATE TRUE                                                05450001
               WHEN SQLCODE = 0                                         05460001
                 SET PS-ROW-PROCESSED         TO TRUE                   05470001
                 IF PV-NULL-RETURN = -1                                 05480001
                   SET PS-ROW-NOT-FOUND       TO TRUE                   05490001
                 ELSE                                                   05500001
                   SET PS-ROW-FOUND             TO TRUE                 05510001
                 END-IF                                                 05520001
               WHEN SQLCODE = 1403                                      05530001
                   SET PS-ROW-NOT-FOUND       TO TRUE                   05540001
                   SET PS-ROW-PROCESSED       TO TRUE                   05550001
               WHEN SQLCODE = -54                                       05560001
                   ADD +1                        TO PV-RETRY-COUNT      05570001
                   DISPLAY                                              05580037
                       'DEADLOCK ORA-00054 7900-SELECT-EVNT-CDE'        05581040
                   IF PV-RETRY-COUNT > PC-MAX-DEADLOCKS                 05590001
                       SET PS-DEADLOCK-MSG         TO TRUE              05600001
                       DISPLAY '** RECORD:      ' PA-RECORDS-READ       05601026
                       PERFORM 9990-SQL-ERROR                           05610001
                   END-IF                                               05620001
               WHEN OTHER                                               05630001
                   DISPLAY '** PRCHG-TYP-CDE:  ' PX043-PRCHG-TYP-CDE    05640026
                   DISPLAY '** EVNT-CTG-CDE:   ' PX043-EVNT-CTG-CDE     05650026
                   DISPLAY '** PRCHG-EFF-DTE:  ' PX043-PRCHG-EFF-DTE    05651026
                   DISPLAY '** STR-NBR:        ' PX043-STR-NBR          05652026
                   DISPLAY '** SKU-NBR:        ' PX043-SKU-NBR          05652126
                   DISPLAY '** RECORD:         ' PA-RECORDS-READ        05653026
                   PERFORM 9990-SQL-ERROR                               05660001
           END-EVALUATE.                                                05670001
                                                                        05670126
CHG016****************************************************************  05670247
CHG016* LOGON TO ORACLE                                                 05670347
CHG016****************************************************************  05670447
CHG016 7500-READ-ORACLE-LOGON.                                          05670547
CHG016                                                                  05670647
CHG016     READ ORACLE-LOGON-FILE                                       05670747
CHG016         INTO CC-ORACLE-CONNECTION                                05670847
CHG016         AT END                                                   05670947
CHG016             SET PS-END-OF-LOGON-FILE TO TRUE                     05671047
CHG016     END-READ.                                                    05671147
CHG016                                                                  05671247
      ******************************************************************05671326
      *    COMMIT-CHANGES.                                             *05671426
      *      PURPOSE: COMMIT CHANGES TO THUS FAR                       *05671526
      ******************************************************************05671626
       8000-CHECK-COMMIT.                                               05671726
                                                                        05671826
           ADD +1                        TO PA-ROWS-TO-COMMIT.          05672026
                                                                        05673626
      ******************************************************************05679026
      * UPDATE CHECKPOINT INFORMATION TABLE. TAKE A COMMIT.             05679126
      ******************************************************************05679226
       8800-COMMIT-CHANGES.                                             05679326
                                                                        05679426
           EXEC SQL                                                     05681626
               COMMIT                                                   05681726
           END-EXEC.                                                    05681826
                                                                        05681926
           IF SQLCODE = 0                                               05682026
               MOVE ZEROES                     TO PA-ROWS-TO-COMMIT     05682237
           ELSE                                                         05682326
               MOVE  '8800-COMMIT-CHANGES    ' TO PV-PARAGRAPH-NAME     05682426
               SET PS-COMMIT-MSG               TO TRUE                  05682526
               PERFORM 9990-SQL-ERROR                                   05682626
           END-IF.                                                      05682726
                                                                        05682826
      ******************************************************************05690001
      *    9900-EOJ-LOGIC.                                              05700001
      *      THIS IS PERFORMED AT END OF INPUT FILE.                    05710001
      *      PURPOSE: CLOSE INPUT FILE,                                 05720001
      *      DISPLAY RECORD COUNTS.                                     05730001
      ******************************************************************05740001
       9900-EOJ-LOGIC.                                                  05750001
                                                                        05750733
           IF PA-RECORDS-READ > ZEROES                                  05750833
                                                                        05751133
               PERFORM 8800-COMMIT-CHANGES                              05751239
                                                                        05751521
           END-IF.                                                      05752033
                                                                        05760001
           CLOSE INPUT-FILE.                                            05780040
                                                                        05810001
           DISPLAY ' '.                                                 05820001
           DISPLAY 'RECORDS READ       ' PA-RECORDS-READ.               05830026
           DISPLAY 'ROWS CANCELLED     ' PA-ROWS-CANCELLED.             05840034
           DISPLAY 'ROWS ACTIVATED     ' PA-ROWS-ACTIVATED.             05841040
           DISPLAY '**------ END ' PC-PROGRAM-NAME ' ------**'.         05850026
                                                                        05910001
      ******************************************************************05920001
      * DISPLAYS ERRORS ENCOUNTERED ON SQL REQUEST                      05930001
      ******************************************************************05940001
       9990-SQL-ERROR.                                                  05950001
                                                                        05960001
           MOVE SQLCODE    TO SQLCODE2.                                 05970001
           MOVE SQLERRD(3) TO SQLERRD3.                                 05980001
           DISPLAY '** ABEND **       ** = SQLERROR'.                   05990001
           DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.           06000026
           DISPLAY '** PARAGRAPH      ** = ' PV-PARAGRAPH-NAME.         06010001
           DISPLAY '** SQLCODE        ** = ' SQLCODE2.                  06020001
           DISPLAY '** ROWS PROCESSED ** = ' SQLERRD3.                  06030001
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   06040001
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  06050001
           DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                06060001
           DISPLAY '** OPERATION      ** = ' PS-OPERATION-ATTEMPTED.    06070001
                                                                        06080001
           MOVE SPACES TO WS-MSG-TEXT.                                  06090001
      *    GET FULL TEXT OF ERROR MESSAGE                               06100001
                                                                        06110001
           CALL 'SQLGLM' USING WS-MSG-TEXT,                             06120001
                               WS-MAX-SIZE,                             06130001
                               WS-MSG-LENGTH.                           06140001
           DISPLAY 'MESSAGE TEXT      ** = ' WS-MSG-TEXT.               06150001
                                                                        06160001
           EXEC SQL                                                     06170001
               ROLLBACK WORK RELEASE                                    06180001
           END-EXEC.                                                    06190001
                                                                        06200001
           SET ABEND-4013-DB-ERROR  TO TRUE.                            06210001
                                                                        06220001
           PERFORM Z100-ABEND.                                          06230005
                                                                        06240005
      *-----------------------------------------------------------      06250005
      * Z100-ABEND                                                      06260005
      *  - PERFORM AN ABEND THAT OCCURED RELATED TO ORACLE              06270005
      *-----------------------------------------------------------      06280005
       Z100-ABEND.                                                      06290005
                                                                        06300005
           DISPLAY '                       '.                           06301005
           DISPLAY '** ABEND **       ** = SQLERROR'.                   06302005
           DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.           06303026
           DISPLAY '** SQLCODE        ** = ' SQLCODE.                   06304005
           DISPLAY '** ABEND CODE     ** = ' ABEND-CODE.                06305005
           DISPLAY '** SQLERRM        ** = ' SQLERRM.                   06306005
           DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                  06307005
           DISPLAY '** SQLERRD(5)     ** = ' SQLERRD(5).                06308005
           DISPLAY '** PARAGRAPH      ** = ' PV-PARAGRAPH-NAME.         06309005
           DISPLAY '** TABLE          ** = ' PV-TABLE-NAME.             06309105
           DISPLAY '** OPERATION      ** = ' PV-OPERATION-MSG.          06309205
           DISPLAY '                       '.                           06309305
                                                                        06309405
           CALL 'ILBOABN0' USING ABEND-CODE.                            06309505
                                                                        06310001
      ******************************************************************06320001
      *    END OF SOURCE CODE FOR PXKUT034                             *06330001
      ******************************************************************06340001
