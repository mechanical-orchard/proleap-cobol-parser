000100 IDENTIFICATION DIVISION.                                         00010014
000200 TITLE 'DAILY - NOT SCANNED DETAIL EXTRACT'.                      00020023
000300                                                                  00030014
000400 PROGRAM-ID.             SUKUT114.                                00040014
000500 AUTHOR.                 PATRICK BURKE.                           00050014
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060014
000700 DATE-WRITTEN            SEPTEMBER 2005.                          00070014
000800 DATE-COMPILED.                                                   00080014
000900                                                                  00090014
001000***************************************************************** 00100014
001100* EXTRACT TROUBLE DATA FOR THE DAILY - NOT SCANNED DETAIL         00110024
001200* REPORT.                                                         00120024
001300***************************************************************** 00130014
001400 ENVIRONMENT DIVISION.                                            00140014
001500 CONFIGURATION SECTION.                                           00150014
001600                                                                  00160014
001700 SOURCE-COMPUTER.        IBM-3090.                                00170014
001800 OBJECT-COMPUTER.        IBM-3090.                                00180014
001900****************************************************************  00190014
002000 INPUT-OUTPUT SECTION.                                            00200014
002100 FILE-CONTROL.                                                    00210014
002200                                                                  00220014
002300     SELECT INPUT-FILE           ASSIGN TO INP01.                 00230014
002400                                                                  00240014
002500     SELECT EXTRACT-FILE         ASSIGN TO OUT01.                 00250014
002600                                                                  00260014
002700****************************************************************  00270014
002800 DATA DIVISION.                                                   00280014
002900 FILE SECTION.                                                    00290014
003000                                                                  00300014
003100 FD  INPUT-FILE                                                   00310014
003200     LABEL RECORDS ARE STANDARD                                   00320014
003300     RECORDING MODE IS F                                          00330014
003400     BLOCK CONTAINS 0 RECORDS.                                    00340014
003500 01  INPUT-REC                   PIC X(600).                      00350014
003600                                                                  00360014
003700 FD  EXTRACT-FILE                                                 00370016
003800     RECORDING MODE IS F                                          00380014
003900     LABEL RECORDS ARE STANDARD                                   00390014
004000     BLOCK CONTAINS 0 RECORDS.                                    00400014
004100 01  EXTRACT-REC                 PIC X(600).                      00410014
004200                                                                  00420014
004300 WORKING-STORAGE SECTION.                                         00430014
004400                                                                  00440014
004500 01  FILLER.                                                      00450014
004600     05  FILLER                      PIC  X(36)    VALUE          00460014
004700         ' ***** WORKING STORAGE PGM=SUKUT114 '.                  00470014
004800     05  PGM-COMPILED                PIC  X(20)    VALUE SPACE.   00480014
004900     05  FILLER                      PIC  X(10)    VALUE          00490014
005000         ' LOCATION='.                                            00500014
005100     05  PGM-LOCATION                PIC  X(04)    VALUE SPACE.   00510014
005200     05  FILLER                      PIC  X(06)    VALUE          00520014
005300         ' *****'.                                                00530014
005400                                                                  00540014
005500 01  PS-SWITCHES.                                                 00550014
005600     05  PS-END-OF-INPUT-SW           PIC X(01) VALUE 'N'.        00560014
005700         88  PS-END-OF-INPUT-YES                VALUE 'Y'.        00570014
005800         88  PS-END-OF-INPUT-NO                 VALUE 'N'.        00580014
006200     05  PS-BCS-CSR-SW                PIC X(01) VALUE 'N'.        00620014
006300         88  PS-END-OF-BCS-CSR                  VALUE 'Y'.        00630014
006400         88  PS-END-OF-BCS-CSR-NO               VALUE 'N'.        00640014
006500     05  PS-MI-CSR-SW                 PIC X(01) VALUE 'N'.        00650014
006600         88  PS-END-OF-MI-CSR                   VALUE 'Y'.        00660014
006700         88  PS-END-OF-MI-CSR-NO                VALUE 'N'.        00670014
006800                                                                  00680014
006900 01  PC-CONSTANTS.                                                00690014
007000     05  PC-CURRENT-PROGRAM-NAME     PIC  X(08)    VALUE          00700014
007100                                                   'SUKUT114'.    00710014
007200     05  PC-ILBOABN0                 PIC  X(08)    VALUE          00720014
007300                                                   'ILBOABN0'.    00730014
007400     05  PC-MAX-RETRIES              PIC S9(04)    VALUE  +3      00740014
007500                                                   COMP.          00750014
007600                                                                  00760014
007700 01  PV-MISC-STUFF.                                               00770014
007800     05  PV-TRBL-RSN-CDE              PIC  9(04) VALUE ZERO.      00780016
007900     05  PV-OPER-UNT-ID               PIC S9(04) COMP.            00790017
008000     05  PV-PO-NBR                    PIC S9(09) COMP.            00800017
008100     05  PV-REC-SEQ-NBR               PIC S9(09) COMP.            00810017
008200     05  PV-PO-LNE-NBR                PIC S9(09) COMP.            00820017
008300                                                                  00830017
008400     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00840017
008500     05  PV-DB2-OPERATION-ATTEMPTED   PIC X(60)  VALUE SPACE.     00850017
008600     05  PV-SQL-CODE                  PIC 9(04)  VALUE ZERO.      00860017
008700     05  PV-ABEND-CODE                PIC S9(04) VALUE ZERO       00870014
008800                                                   COMP SYNC.     00880014
008900     05  PV-RETRY-COUNTER             PIC S9(04) VALUE ZERO       00890014
009000                                                 COMP SYNC.       00900014
009100     05  PV-COMMIT-COUNTER            PIC S9(04) VALUE ZERO       00910014
009200                                                 COMP SYNC.       00920014
009300     05  PV-READ-COUNTER              PIC S9(09) COMP-3           00930014
009400                                              VALUE ZERO.         00940014
009500     05  PV-TOT-RECS-READ             PIC 9(07).                  00950016
009600     05  PV-ROWS-NOT-WRITTEN          PIC S9(09) COMP-3           00960014
009700                                              VALUE ZERO.         00970014
009800     05  PV-MI-CSR-FETCH              PIC S9(09) COMP-3           00980015
009900                                              VALUE ZERO.         00990014
010000     05  PV-BCS-CSR-FETCH             PIC S9(09) COMP-3           01000015
010100                                              VALUE ZERO.         01010015
010200     05  PV-NULL-IND-1                PIC S9(04)  VALUE +0  COMP. 01020014
010300     05  PV-WRITE-1-COUNTER           PIC S9(09) COMP-3           01030014
010400                                              VALUE ZERO.         01040014
010500     05  PV-BYPASS-COUNT              PIC S9(09) COMP-3           01050014
010600                                              VALUE ZERO.         01060014
010700     05  PV-DISP-NBR                  PIC ZZZ,ZZZ,ZZ9.            01070014
010800     05  PV-ABEND-OPERATION           PIC X(20) VALUE SPACES.     01080014
010900     05  PV-ABEND-STRUCTURE-1         PIC X(20) VALUE SPACES.     01090014
011000                                                                  01100014
011100     05  PV-START1.                                               01110014
011200         10  PV-START-DATE1              PIC  X(10).              01120014
011300         10  PV-START-TIME1              PIC  X(16)  VALUE        01130014
011400                   '-00.00.00.000000'.                            01140014
011500     05  PV-START-TMST1 REDEFINES PV-START1 PIC X(26).            01150014
011600                                                                  01160014
011700     05  PV-END1.                                                 01170014
011800         10  PV-END-DATE1                 PIC  X(10).             01180014
011900         10  PV-END-TIME1                 PIC  X(16)  VALUE       01190014
012000                   '-23.59.59.999999'.                            01200014
012100     05  PV-END-TMST1 REDEFINES PV-END1    PIC  X(26).            01210014
012200                                                                  01220014
012300     05  PV-DB2-DATE.                                             01230014
012400         10  PV-DB2-CC                  PIC X(02).                01240014
012500         10  PV-DB2-YY                  PIC X(02).                01250014
012600         10  FILLER                     PIC X(01).                01260014
012700         10  PV-DB2-MM                  PIC X(02).                01270014
012800         10  FILLER                     PIC X(01).                01280014
012900         10  PV-DB2-DD                  PIC X(02).                01290014
013000         10  FILLER                     PIC X(01).                01300014
013100         10  PV-DB2-HH                  PIC X(02).                01310014
013200         10  FILLER                     PIC X(01).                01320014
013300         10  PV-DB2-MN                  PIC X(02).                01330014
013400         10  FILLER                     PIC X(01).                01340014
013500         10  PV-DB2-SS                  PIC X(09).                01350014
013600                                                                  01360014
013700 01  ABEND-CODE                       PIC S9(04)     VALUE +0     01370014
013800                                                     COMP SYNC.   01380014
013900     88  ABEND-4001-WRITE-ERROR                      VALUE +4001. 01390014
014000     88  ABEND-4002-READ-ERROR                       VALUE +4002. 01400014
014100     88  ABEND-4003-CTRL-CARD-ERROR                  VALUE +4003. 01410014
014200     88  ABEND-4004-TABLE-ERROR                      VALUE +4004. 01420014
014300     88  ABEND-4005-OPEN-ERROR                       VALUE +4005. 01430014
014400     88  ABEND-4006-CLOSE-ERROR                      VALUE +4006. 01440014
014500     88  ABEND-4007-SEQUENCE-ERROR                   VALUE +4007. 01450014
014600     88  ABEND-4008-DATS-ERROR                       VALUE +4008. 01460014
014700     88  ABEND-4009-KEY-DATS-ERROR                   VALUE +4009. 01470014
014800     88  ABEND-4013-DB2-ERROR                        VALUE +4013. 01480014
014900                                                                  01490014
015000 01  PV-COUNT-MSG-1.                                              01500014
015100     05  FILLER                       PIC X(26) VALUE             01510014
015200         'RECORDS WRITTEN TO OUT01 ='.                            01520014
015300     05  PV-MSG-1-COUNT               PIC Z,ZZZ,ZZZ,ZZ9.          01530014
015400                                                                  01540014
015500 01  PV-COUNT-MSG-1A.                                             01550022
015600     05  FILLER                       PIC X(26) VALUE             01560022
015700         'RECORDS READ             ='.                            01570022
015800     05  PV-MSG-1A-COUNT              PIC Z,ZZZ,ZZZ,ZZ9.          01580022
015900                                                                  01590022
016000 01  PV-COUNT-MSG-2.                                              01600014
016100     05  FILLER                       PIC X(26) VALUE             01610014
016200         'BCS CSR FETCHES          ='.                            01620016
016300     05  PV-MSG-2-COUNT               PIC Z,ZZZ,ZZZ,ZZ9.          01630014
016400                                                                  01640014
016500 01  PV-COUNT-MSG-3.                                              01650014
016600     05  FILLER                       PIC X(26) VALUE             01660014
016700         'MI CSR FETCHES           ='.                            01670016
016800     05  PV-MSG-3-COUNT               PIC Z,ZZZ,ZZZ,ZZ9.          01680014
016900                                                                  01690014
017000*    REPORT EXTRACT FILE                                          01700014
017100     COPY SURD066.                                                01710014
017200/                                                                 01720014
017300******************************************************************01730014
017400*    DB2 DCLGEN FOR THE TROUBLE NOTIFICATION TABLE                01740014
017500******************************************************************01750014
017600     EXEC SQL                                                     01760014
017700          INCLUDE TTRBNTF                                         01770014
017800     END-EXEC.                                                    01780014
017900/                                                                 01790014
018000******************************************************************01800014
018100*    DB2 DCLGEN FOR THE TTRBRSN TABLE                             01810014
018200******************************************************************01820014
018300     EXEC SQL                                                     01830014
018400          INCLUDE TTRBRSN                                         01840014
018500     END-EXEC.                                                    01850014
018600/                                                                 01860014
018700******************************************************************01870014
018800*    DB2 DCLGEN FOR THE TTRBRCN TABLE                             01880014
018900******************************************************************01890014
019000     EXEC SQL                                                     01900014
019100          INCLUDE TTRBRCN                                         01910014
019200     END-EXEC.                                                    01920014
019300/                                                                 01930014
019400******************************************************************01940014
019500*    DB2 DCLGEN FOR THE TRECITM TABLE                             01950014
019600******************************************************************01960014
019700     EXEC SQL                                                     01970014
019800          INCLUDE TRECITM                                         01980014
019900     END-EXEC.                                                    01990014
020000/                                                                 02000014
020100******************************************************************02010014
020200     EXEC SQL                                                     02020014
020300         INCLUDE SQLCA                                            02030014
020400     END-EXEC.                                                    02040014
020500                                                                  02050014
020600     COPY SQLCA2.                                                 02060014
020700                                                                  02070014
020800     COPY DPWS004.                                                02080014
020900                                                                  02090014
021000*---------------------------------------------------------------* 02100014
021100* BCS TROUBLE CURSOR                                              02110014
021200*---------------------------------------------------------------* 02120014
021300     EXEC SQL DECLARE BCS-CSR CURSOR FOR                          02130014
021400         SELECT B.TRBL_RSN_CDE                                    02140014
021500              , B.TRBL_SHT_DESC                                   02150014
021600           FROM TTRBNTF A                                         02160017
021700              , TTRBRSN B                                         02170017
021800              , TTRBRCN C                                         02180017
021900*         WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID               02190023
022000          WHERE A.PO_NBR          = :PV-PO-NBR                    02200023
022100            AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR               02210017
022200            AND A.PO_LNE_NBR      = :PV-PO-LNE-NBR                02220017
022300            AND A.PREPK_ID        = 0                             02230014
022400            AND A.TRBL_RSN_CDE    = B.TRBL_RSN_CDE                02240014
022500            AND A.TRBL_RSN_CDE    = C.TRBL_RSN_CDE                02250014
022600            AND C.RPT_PGM_NM      = 'SUKUT114'                    02260014
022700         UNION                                                    02270014
022800         SELECT B.TRBL_RSN_CDE                                    02280014
022900              , B.TRBL_SHT_DESC                                   02290014
023000           FROM TTRBNTF A                                         02300014
023100              , TTRBRSN B                                         02310014
023200              , TTRBRCN C                                         02320014
023300*         WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID               02330023
023400          WHERE A.PO_NBR          = :PV-PO-NBR                    02340023
023500            AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR               02350017
023600            AND A.PO_LNE_NBR      = 0                             02360014
023700            AND A.PREPK_ID        = 0                             02370014
023800            AND A.TRBL_RSN_CDE    = B.TRBL_RSN_CDE                02380014
023900            AND A.TRBL_RSN_CDE    = C.TRBL_RSN_CDE                02390014
024000            AND C.RPT_PGM_NM      = 'SUKUT114'                    02400014
024100*         ORDER BY A.TRBL_RSN_CDE                                 02410017
024200     END-EXEC.                                                    02420014
024300                                                                  02430014
024400*---------------------------------------------------------------* 02440014
024500* MI TROUBLE CURSOR                                               02450014
024600*---------------------------------------------------------------* 02460014
024700     EXEC SQL DECLARE MI-CSR CURSOR FOR                           02470014
024800        SELECT B.PREPK_ID                                         02480017
024900             , C.TRBL_RSN_CDE                                     02490014
025000             , C.TRBL_SHT_DESC                                    02500014
025100          FROM TRECITM A                                          02510014
025200             , TTRBNTF B                                          02520014
025300             , TTRBRSN C                                          02530014
025400             , TTRBRCN D                                          02540014
025500*        WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID                02550023
025600         WHERE A.ORD_NBR         = :PV-PO-NBR                     02560023
025700           AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR                02570017
025800           AND A.ORD_LNE_NBR     = :PV-PO-LNE-NBR                 02580017
025900           AND A.VER_STATUS_CDE  = 'A'                            02590014
026000           AND B.OPER_UNT_ID     = A.OPER_UNT_ID                  02600014
026100           AND B.PO_NBR          = A.ORD_NBR                      02610014
026200           AND B.REC_SEQ_NBR     = A.REC_SEQ_NBR                  02620014
026300           AND B.PREPK_ID        = A.PREPK_ID                     02630014
026400           AND B.TRBL_RSN_CDE    = C.TRBL_RSN_CDE                 02640014
026500           AND B.TRBL_RSN_CDE    = D.TRBL_RSN_CDE                 02650014
026600           AND D.RPT_PGM_NM      = 'SUKUT114'                     02660017
026700         UNION                                                    02670014
026800         SELECT A.PREPK_ID                                        02680014
026900              , B.TRBL_RSN_CDE                                    02690014
027000              , B.TRBL_SHT_DESC                                   02700014
027100           FROM TTRBNTF A                                         02710014
027200              , TTRBRSN B                                         02720014
027300              , TTRBRCN C                                         02730014
027400*         WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID               02740023
027500          WHERE A.PO_NBR          = :PV-PO-NBR                    02750023
027600            AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR               02760017
027700            AND A.PO_LNE_NBR      = :PV-PO-LNE-NBR                02770017
027800            AND A.PREPK_ID        = 0                             02780014
027900            AND A.TRBL_RSN_CDE    = B.TRBL_RSN_CDE                02790014
028000            AND A.TRBL_RSN_CDE    = C.TRBL_RSN_CDE                02800014
028100            AND C.RPT_PGM_NM      = 'SUKUT114'                    02810014
028200          UNION                                                   02820014
028300          SELECT A.PREPK_ID                                       02830014
028400               , B.TRBL_RSN_CDE                                   02840014
028500               , B.TRBL_SHT_DESC                                  02850014
028600            FROM TTRBNTF A                                        02860014
028700               , TTRBRSN B                                        02870014
028800               , TTRBRCN C                                        02880014
028900*          WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID              02890023
029000           WHERE A.PO_NBR          = :PV-PO-NBR                   02900023
029100             AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR              02910017
029200             AND A.PO_LNE_NBR      = 0                            02920014
029300             AND A.PREPK_ID        = 0                            02930014
029400             AND A.TRBL_RSN_CDE    = B.TRBL_RSN_CDE               02940014
029500             AND A.TRBL_RSN_CDE    = C.TRBL_RSN_CDE               02950014
029600             AND C.RPT_PGM_NM      = 'SUKUT114'                   02960014
029700*           ORDER BY A.TRBL_RSN_CDE                               02970017
029800     END-EXEC.                                                    02980014
029900/                                                                 02990014
030000***************************************************************** 03000014
030100 PROCEDURE DIVISION.                                              03010014
030200                                                                  03020014
030300     PERFORM 1000-INITIALIZATION.                                 03030014
030400                                                                  03040014
030500     PERFORM 7000-READ-INPUT.                                     03050014
030501                                                                  03050126
030510     IF PS-END-OF-INPUT-YES                                       03051026
030520         DISPLAY ' '                                              03052026
030530         DISPLAY ALL '*'                                          03053026
030540         DISPLAY '  INPUT FILE IS EMPTY '                         03054026
030550         DISPLAY ALL '*'                                          03055026
030560         DISPLAY ' '                                              03056026
030570     END-IF.                                                      03057026
030600                                                                  03060014
030700     PERFORM 2000-PROCESS                                         03070016
030800        UNTIL PS-END-OF-INPUT-YES.                                03080016
030900                                                                  03090014
031000     PERFORM 9000-QUIT.                                           03100014
031100                                                                  03110014
031200     GOBACK.                                                      03120014
031300/                                                                 03130014
031400***************************************************************** 03140014
031500 1000-INITIALIZATION.                                             03150014
031600                                                                  03160014
031700     MOVE '1000-INITIALIZATION         '  TO PV-ABEND-PARAGRAPH.  03170014
031800                                                                  03180014
031900*OPEN FILES.                                                      03190014
032000     OPEN INPUT INPUT-FILE.                                       03200027
032100     OPEN OUTPUT EXTRACT-FILE.                                    03210027
032200                                                                  03220014
033000/                                                                 03300014
033100***************************************************************** 03310015
033200 2000-PROCESS.                                                    03320014
033300                                                                  03330014
033400     MOVE '2000-PROCESS'                  TO PV-ABEND-PARAGRAPH.  03340014
033500                                                                  03350015
033600     MOVE ZERO TO PV-TRBL-RSN-CDE.                                03360021
033700                                                                  03370021
033800     IF SU066-PKGNG-CDE  = 'M' OR 'I'                             03380016
033900         PERFORM 7510-OPEN-MI-CSR                                 03390020
034000         PERFORM 7520-FETCH-MI-CSR                                03400020
034100            UNTIL PS-END-OF-MI-CSR                                03410020
034200         PERFORM 7530-CLOSE-MI-CSR                                03420020
034300     ELSE                                                         03430016
034400         PERFORM 7310-OPEN-BCS-CSR                                03440020
034500         PERFORM 7320-FETCH-BCS-CSR                               03450020
034600            UNTIL PS-END-OF-BCS-CSR                               03460020
034700         PERFORM 7330-CLOSE-BCS-CSR                               03470020
034800     END-IF                                                       03480016
034900                                                                  03490016
035000                                                                  03500020
035100     IF PV-TRBL-RSN-CDE = 0                                       03510020
035200         PERFORM 8200-WRITE-SU066                                 03520020
035300     END-IF.                                                      03530020
035400                                                                  03540014
035500*READ NEXT INPUT REC                                              03550014
035600     PERFORM 7000-READ-INPUT.                                     03560014
035700                                                                  03570014
035800/                                                                 03580014
035900******************************************************************03590020
036000*  PROCESS MI CURSOR                                             *03600020
036100******************************************************************03610020
036200 2100-PROCESS-MI-CSR.                                             03620020
036300                                                                  03630020
036400     IF TRBRSN-TRBL-RSN-CDE NOT = PV-TRBL-RSN-CDE                 03640020
036500        IF SU066-TRBL-EXIST  = 'N'                                03650020
036600           MOVE 'Y' TO SU066-TRBL-EXIST                           03660020
036700        END-IF                                                    03670020
036800        IF TRBNTF-PREPK-ID = 0                                    03680020
036900            PERFORM 2500-GET-PREPK-ID                             03690020
037000        ELSE                                                      03700020
037100            MOVE TRBNTF-PREPK-ID  TO SU066-PREPK-ID               03710020
037200        END-IF                                                    03720020
037300                                                                  03730020
037400        MOVE 0                    TO SU066-TRN-LNE-NBR            03740020
037500        MOVE TRBRSN-TRBL-RSN-CDE  TO SU066-TRBL-RSN-CDE           03750020
037600        MOVE TRBRSN-TRBL-SHT-DESC TO SU066-TRBL-SHT-DESC          03760020
037700        PERFORM 8200-WRITE-SU066                                  03770020
037800                                                                  03780020
037900        MOVE TRBRSN-TRBL-RSN-CDE TO SU066-TRBL-RSN-CDE            03790020
038000     END-IF.                                                      03800020
038100/                                                                 03810020
038200******************************************************************03820020
038300*  PROCESS BCS CURSOR                                            *03830020
038400******************************************************************03840020
038500 2200-PROCESS-BCS-CSR.                                            03850020
038600                                                                  03860020
038700     IF TRBRSN-TRBL-RSN-CDE NOT =  PV-TRBL-RSN-CDE                03870021
038800        IF SU066-TRBL-EXIST  = 'N'                                03880020
038900           MOVE 'Y' TO SU066-TRBL-EXIST                           03890020
039000        END-IF                                                    03900020
039100        IF SU066-PKGNG-CDE = SPACES                               03910020
039200            MOVE 0              TO SU066-TRN-LNE-NBR              03920020
039300        END-IF                                                    03930020
039400                                                                  03940020
039500        MOVE 0                    TO SU066-PREPK-ID               03950020
039600        MOVE TRBRSN-TRBL-RSN-CDE  TO SU066-TRBL-RSN-CDE           03960020
039700        MOVE TRBRSN-TRBL-SHT-DESC TO SU066-TRBL-SHT-DESC          03970020
039800                                                                  03980020
039900        PERFORM 8200-WRITE-SU066                                  03990020
040000        MOVE TRBRSN-TRBL-RSN-CDE  TO PV-TRBL-RSN-CDE              04000020
040100     END-IF.                                                      04010020
040200                                                                  04020020
040300/                                                                 04030020
040400******************************************************************04040014
040500*  GET PREPACK ID FROM TRECITM                                   *04050016
040600******************************************************************04060014
040700 2500-GET-PREPK-ID.                                               04070016
040800                                                                  04080014
040900      EXEC SQL                                                    04090016
041000          SELECT PREPK_ID                                         04100016
041100            INTO  :RECITM-PREPK-ID                                04110016
041200            FROM TRECITM A                                        04120016
041300            WHERE A.OPER_UNT_ID     = :PV-OPER-UNT-ID             04130017
041400              AND A.ORD_NBR         = :PV-PO-NBR                  04140017
041500              AND A.REC_SEQ_NBR     = :PV-REC-SEQ-NBR             04150017
041600              AND A.ORD_LNE_NBR     = :PV-PO-LNE-NBR              04160017
041700              AND A.VER_STATUS_CDE  = 'A'                         04170016
041800            WITH UR                                               04180016
041900      END-EXEC.                                                   04190016
042000                                                                  04200016
042100     EVALUATE TRUE                                                04210016
042200         WHEN SQLCODE = ZERO                                      04220016
042300         WHEN SQLCODE = +100                                      04230016
042400             CONTINUE                                             04240016
042500         WHEN SQLWARN0 NOT = SPACES                               04250016
042600         WHEN SQLCODE < ZERO                                      04260016
042700         WHEN SQLCODE > ZERO                                      04270016
042800             MOVE '2500-GET-PREPK    '  TO PV-ABEND-PARAGRAPH     04280016
042900             MOVE 'GET RECITM PREPK  '                            04290016
043000                                 TO PV-DB2-OPERATION-ATTEMPTED    04300016
043100             PERFORM 9100-SQL-ABEND                               04310016
043200     END-EVALUATE.                                                04320016
043300                                                                  04330016
043400/                                                                 04340016
043500******************************************************************04350016
043600*  READ INPUT FILE                                               *04360016
043700******************************************************************04370016
043800 7000-READ-INPUT.                                                 04380016
043900                                                                  04390016
044000     SET PS-END-OF-MI-CSR-NO   TO TRUE.                           04400014
044100     SET PS-END-OF-BCS-CSR-NO  TO TRUE.                           04410014
044200                                                                  04420014
044300     READ INPUT-FILE INTO SU066-RECORD                            04430014
044400       AT END                                                     04440014
044500         SET PS-END-OF-INPUT-YES TO TRUE                          04450014
044600       NOT AT END                                                 04460014
044700         MOVE SU066-OPER-UNT-ID   TO PV-OPER-UNT-ID               04470017
044800         MOVE SU066-PO-NBR        TO PV-PO-NBR                    04480017
044900         MOVE SU066-REC-SEQ-NBR   TO PV-REC-SEQ-NBR               04490017
045000         MOVE SU066-TRN-LNE-NBR   TO PV-PO-LNE-NBR                04500017
045100         ADD 1  TO PV-TOT-RECS-READ                               04510016
045200     END-READ.                                                    04520014
045300                                                                  04530014
045400******************************************************************04540014
045500*  OPEN THE BCS CURSOR.                                           04550014
045600******************************************************************04560014
045700 7310-OPEN-BCS-CSR.                                               04570014
045800                                                                  04580014
045900      EXEC SQL                                                    04590014
046000           OPEN BCS-CSR                                           04600014
046100      END-EXEC.                                                   04610014
046200                                                                  04620014
046300      EVALUATE TRUE                                               04630014
046400          WHEN SQLCODE = ZERO                                     04640014
046500          WHEN SQLCODE = -904                                     04650014
046600          WHEN SQLCODE = -911                                     04660014
046700              CONTINUE                                            04670014
046800          WHEN SQLWARN0 NOT = SPACES                              04680014
046900          WHEN SQLCODE < ZERO                                     04690014
047000          WHEN SQLCODE > ZERO                                     04700014
047100              MOVE '7310-OPEN-BCS-CURSOR' TO PV-ABEND-PARAGRAPH   04710014
047200              MOVE 'OPEN THE BCS-CSR '                            04720014
047300                                TO PV-DB2-OPERATION-ATTEMPTED     04730014
047400              PERFORM 9100-SQL-ABEND                              04740014
047500      END-EVALUATE.                                               04750014
047600                                                                  04760014
047700******************************************************************04770014
047800*  FETCH THE RESULTS OF BCS CURSOR                                04780014
047900******************************************************************04790014
048000 7320-FETCH-BCS-CSR.                                              04800014
048100                                                                  04810014
048200     EXEC SQL                                                     04820014
048300          FETCH BCS-CSR                                           04830014
048400           INTO :TRBRSN-TRBL-RSN-CDE                              04840015
048500               ,:TRBRSN-TRBL-SHT-DESC                             04850015
048600     END-EXEC.                                                    04860014
048700                                                                  04870014
048800     EVALUATE TRUE                                                04880014
048900         WHEN SQLCODE = ZERO                                      04890014
049000             PERFORM 2200-PROCESS-BCS-CSR                         04900020
049100             ADD +1 TO PV-BCS-CSR-FETCH                           04910015
049200         WHEN SQLCODE = +100                                      04920014
049300             SET  PS-END-OF-BCS-CSR TO TRUE                       04930014
049400         WHEN SQLWARN0 NOT = SPACES                               04940014
049500         WHEN SQLCODE < ZERO                                      04950014
049600         WHEN SQLCODE > ZERO                                      04960014
049700             MOVE '7320-FETCH-BCS-CSR'  TO PV-ABEND-PARAGRAPH     04970014
049800             MOVE 'FETCH THE BCS-CSR '                            04980014
049900                                 TO PV-DB2-OPERATION-ATTEMPTED    04990014
050000             PERFORM 9100-SQL-ABEND                               05000014
050100     END-EVALUATE.                                                05010014
050200                                                                  05020014
050300******************************************************************05030014
050400*  CLOSE THE BCS CURSOR.                                          05040014
050500******************************************************************05050014
050600 7330-CLOSE-BCS-CSR.                                              05060014
050700      EXEC SQL                                                    05070014
050800          CLOSE BCS-CSR                                           05080014
050900      END-EXEC.                                                   05090014
051000                                                                  05100014
051100      EVALUATE TRUE                                               05110014
051200          WHEN SQLCODE = ZERO                                     05120014
051300          WHEN SQLCODE = -904                                     05130014
051400          WHEN SQLCODE = -911                                     05140014
051500              CONTINUE                                            05150014
051600          WHEN SQLWARN0 NOT = SPACES                              05160014
051700          WHEN SQLCODE < ZERO                                     05170014
051800          WHEN SQLCODE > ZERO                                     05180014
051900              MOVE '7330-CLOSE-BCS-CSR' TO PV-ABEND-PARAGRAPH     05190014
052000              MOVE 'CLOSE THE BCS-CSR   '                         05200014
052100                              TO PV-DB2-OPERATION-ATTEMPTED       05210014
052200              PERFORM 9100-SQL-ABEND                              05220014
052300      END-EVALUATE.                                               05230014
052400/                                                                 05240014
052500******************************************************************05250014
052600******************************************************************05260014
052700*  OPEN THE MI CURSOR.                                            05270014
052800******************************************************************05280014
052900 7510-OPEN-MI-CSR.                                                05290014
053000                                                                  05300014
053100      EXEC SQL                                                    05310014
053200           OPEN MI-CSR                                            05320014
053300      END-EXEC.                                                   05330014
053400                                                                  05340014
053500      EVALUATE TRUE                                               05350014
053600          WHEN SQLCODE = ZERO                                     05360014
053700          WHEN SQLCODE = -904                                     05370014
053800          WHEN SQLCODE = -911                                     05380014
053900              CONTINUE                                            05390014
054000          WHEN SQLWARN0 NOT = SPACES                              05400014
054100          WHEN SQLCODE < ZERO                                     05410014
054200          WHEN SQLCODE > ZERO                                     05420014
054300              MOVE '7510-OPEN-MI-CURSOR' TO PV-ABEND-PARAGRAPH    05430014
054400              MOVE 'OPEN THE MI-CSR '                             05440014
054500                                TO PV-DB2-OPERATION-ATTEMPTED     05450014
054600              PERFORM 9100-SQL-ABEND                              05460014
054700      END-EVALUATE.                                               05470014
054800                                                                  05480014
054900******************************************************************05490014
055000*  FETCH THE RESULTS FROM THE MI CURSOR.                          05500014
055100******************************************************************05510014
055200 7520-FETCH-MI-CSR.                                               05520014
055300                                                                  05530014
055400     EXEC SQL                                                     05540014
055500          FETCH MI-CSR                                            05550014
055600           INTO :TRBNTF-PREPK-ID                                  05560015
055700               ,:TRBRSN-TRBL-RSN-CDE                              05570015
055800               ,:TRBRSN-TRBL-SHT-DESC                             05580015
055900     END-EXEC.                                                    05590014
056000                                                                  05600014
056100     EVALUATE TRUE                                                05610014
056200         WHEN SQLCODE = ZERO                                      05620014
056300             PERFORM 2100-PROCESS-MI-CSR                          05630020
056400             ADD +1 TO PV-MI-CSR-FETCH                            05640015
056500         WHEN SQLCODE = +100                                      05650014
056600             SET  PS-END-OF-MI-CSR TO TRUE                        05660014
056700         WHEN SQLWARN0 NOT = SPACES                               05670014
056800         WHEN SQLCODE < ZERO                                      05680014
056900         WHEN SQLCODE > ZERO                                      05690014
057000             MOVE '7520-FETCH-MI-CSR'  TO PV-ABEND-PARAGRAPH      05700014
057100             MOVE 'FETCH THE MI-CSR '                             05710014
057200                                 TO PV-DB2-OPERATION-ATTEMPTED    05720014
057300             PERFORM 9100-SQL-ABEND                               05730014
057400     END-EVALUATE.                                                05740014
057500                                                                  05750014
057600******************************************************************05760014
057700*  CLOSE THE MI CURSOR.                                           05770014
057800******************************************************************05780014
057900 7530-CLOSE-MI-CSR.                                               05790014
058000      EXEC SQL                                                    05800014
058100          CLOSE MI-CSR                                            05810014
058200      END-EXEC.                                                   05820014
058300                                                                  05830014
058400      EVALUATE TRUE                                               05840014
058500          WHEN SQLCODE = ZERO                                     05850014
058600          WHEN SQLCODE = -904                                     05860014
058700          WHEN SQLCODE = -911                                     05870014
058800              CONTINUE                                            05880014
058900          WHEN SQLWARN0 NOT = SPACES                              05890014
059000          WHEN SQLCODE < ZERO                                     05900014
059100          WHEN SQLCODE > ZERO                                     05910014
059200              MOVE '7530-CLOSE-MI-CSR' TO PV-ABEND-PARAGRAPH      05920014
059300              MOVE 'CLOSE THE MI-CSR   '                          05930014
059400                              TO PV-DB2-OPERATION-ATTEMPTED       05940014
059500              PERFORM 9100-SQL-ABEND                              05950014
059600      END-EVALUATE.                                               05960014
059700/                                                                 05970014
059800******************************************************************05980014
059900 8200-WRITE-SU066.                                                05990014
060000     MOVE '8200-WRITE-SU066    '  TO PV-ABEND-PARAGRAPH.          06000014
060100     WRITE                                                        06010014
060200         EXTRACT-REC     FROM SU066-RECORD                        06020015
060300     END-WRITE.                                                   06030014
060400     ADD 1                            TO PV-WRITE-1-COUNTER.      06040014
060500/                                                                 06050014
060600******************************************************************06060015
060700 9000-QUIT.                                                       06070014
060800                                                                  06080014
060900*CLOSE FILES                                                      06090014
061000     CLOSE INPUT-FILE                                             06100014
061100     CLOSE EXTRACT-FILE                                           06110016
061200                                                                  06120014
061300     MOVE PV-WRITE-1-COUNTER          TO PV-MSG-1-COUNT           06130014
061400     DISPLAY PV-COUNT-MSG-1.                                      06140014
061500                                                                  06150014
061600     MOVE PV-TOT-RECS-READ            TO PV-MSG-1A-COUNT          06160022
061700     DISPLAY PV-COUNT-MSG-1A.                                     06170022
061800                                                                  06180022
061900     MOVE PV-MI-CSR-FETCH             TO PV-MSG-2-COUNT           06190015
062000     DISPLAY PV-COUNT-MSG-2.                                      06200015
062100                                                                  06210015
062200     MOVE PV-BCS-CSR-FETCH            TO PV-MSG-3-COUNT           06220015
062300     DISPLAY PV-COUNT-MSG-3.                                      06230014
062400                                                                  06240014
062500/                                                                 06250014
062600 9100-SQL-ABEND.                                                  06260014
062700******************************************************************06270014
062800*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    06280014
062900*  ERROR OR WARNING CODE OCCURS.                                  06290014
063000******************************************************************06300014
063100     DISPLAY '9100-SQL-ABEND'.                                    06310014
063200     DISPLAY '** ABEND     **'.                                   06320014
063300     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06330014
063400     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             06340014
063500     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     06350014
063600     DISPLAY '**              ** = '                              06360014
063700     MOVE SQLCODE TO PV-SQL-CODE.                                 06370014
063800     DISPLAY '** SQL CODE  ** = ' PV-SQL-CODE.                    06380014
063900     MOVE +4013 TO PV-ABEND-CODE.                                 06390014
064000     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         06400014
064100                                                                  06410014
