000100 IDENTIFICATION DIVISION.                                         00010002
000200 TITLE 'MQ ADJUSTMENT PROCESSING - PC.MERCHANDISE.ADJ.Q'.         00020002
000300 PROGRAM-ID.    PCKUP012.                                         00030002
000400 AUTHOR.        DENNIS STEFFEN.                                   00040002
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050002
000600 DATE-WRITTEN.  EARLY WINTER 2004.                                00060002
000700 DATE-COMPILED.                                                   00070002
000800***************************************************************** 00080002
000900*                                                               * 00090002
001000*    THIS PROGRAM WILL RETRIEVE ADJUSTMENTS FROM THE            * 00100002
001100*    MESSAGE QUEUE AND UPDATE THE INTRANSIT QUANTITIES          * 00110002
001200*    ACCORDINGLY - PCT_TRN_CLSN_BAL & PCT_TRN_CLSN_DTL.         * 00120002
001300*                                                               * 00130002
001400*    THIS TRANSACTION WILL BE TRIGGERED BY MQ SERIES.           * 00140002
001500*  WHEN COMPILING THIS PROGRAM, USE A 'Y' IN MQ SERIES PROGRAM. * 00150002
001600*                                                               * 00160002
001700*    THERE ARE FOUR TYPES OF ADJUSTMENTS THAT WILL BE           * 00170002
001800*    ON THE QUEUE AND THEY ARE AS FOLLOWS:                      * 00180002
001900*                                                               * 00190002
002000*    RA - RECEIPT ADJUSTMENTS                                   * 00200002
002100*    OA - ON-HAND ADJUSTMENTS                                   * 00210002
002200*    ST - REPLACEMENT SKU ADJUSTMENTS                           * 00220002
002300*    SE - STORE EXPECTED ADJUSTMENTS                            * 00230002
000800***************************************************************** 00080002
223774* 05/14/2019  JIM ARENDT  CHG0223774                            *         
223774*  - AS PART OF THE DELOITTE REFACTOR PROJECT, REMOVED CODE THAT*         
223774*    WAS SETTING THE RETURN-CODE TO 4050 WHEN THE END OF THE    *         
223774*    QUEUE MESSAGE WAS RECEIVED.                                * 00240002
000800***************************************************************** 00080002
002500*                                                                 00250002
002600 ENVIRONMENT DIVISION.                                            00260002
002700 CONFIGURATION SECTION.                                           00270002
002800 SOURCE-COMPUTER.        IBM-3090.                                00280002
002900 OBJECT-COMPUTER.        IBM-3090.                                00290002
003000 INPUT-OUTPUT SECTION.                                            00300002
003100 FILE-CONTROL.                                                    00310002
003200                                                                  00320002
003300     SELECT CONTROL-CARD-1                                        00330002
003400            ASSIGN TO INP01.                                      00340002
003500     SELECT CONTROL-CARD-2                                        00350002
003600            ASSIGN TO INP02.                                      00360002
003700     SELECT CONTROL-CARD-3                                        00370002
003800            ASSIGN TO INP03.                                      00380002
003900                                                                  00390002
004000 DATA DIVISION.                                                   00400002
004100 FILE SECTION.                                                    00410002
004200                                                                  00420002
004300 FD  CONTROL-CARD-1                                               00430002
004400     RECORDING MODE F                                             00440002
004500     BLOCK CONTAINS 0 RECORDS                                     00450002
004600     LABEL RECORDS ARE OMITTED                                    00460002
004700     DATA RECORD IS CONTROL-CARD-1-RECORD.                        00470002
004800 01  CONTROL-CARD-1-RECORD           PIC X(080).                  00480002
004900                                                                  00490002
005000 FD  CONTROL-CARD-2                                               00500002
005100     RECORDING MODE F                                             00510002
005200     BLOCK CONTAINS 0 RECORDS                                     00520002
005300     LABEL RECORDS ARE OMITTED                                    00530002
005400     DATA RECORD IS CONTROL-CARD-2-RECORD.                        00540002
005500 01  CONTROL-CARD-2-RECORD           PIC X(080).                  00550002
005600                                                                  00560002
005700 FD  CONTROL-CARD-3                                               00570002
005800     RECORDING MODE F                                             00580002
005900     BLOCK CONTAINS 0 RECORDS                                     00590002
006000     LABEL RECORDS ARE OMITTED                                    00600002
006100     DATA RECORD IS CONTROL-CARD-3-RECORD.                        00610002
006200 01  CONTROL-CARD-3-RECORD           PIC X(080).                  00620002
006300/                                                                 00630002
006400 WORKING-STORAGE SECTION.                                         00640002
006500 01  CC-CONTROL-CARD-1-LAYOUT.                                    00650002
006600     05  CC-QUEUE-MANAGER-NAME      PIC X(48)   VALUE SPACES.     00660002
006700     05  FILLER                     PIC X(32)   VALUE SPACES.     00670002
006800                                                                  00680002
006900**CONTROL CARD 2 RECORD LAYOUT - LOCATION QUEUE NAME              00690002
007000 01  CC-CONTROL-CARD-2-LAYOUT.                                    00700002
007100     05  CC-LOCATION-QUEUE-NAME     PIC X(48)   VALUE SPACES.     00710002
007200     05  FILLER                     PIC X(32)   VALUE SPACES.     00720002
007300                                                                  00730002
007400**CONTROL CARD 3 RECORD LAYOUT - LOCATION ERROR QUEUE NAME        00740002
007500 01  CC-CONTROL-CARD-3-LAYOUT.                                    00750002
007600     05  CC-LOC-ERROR-QUEUE-NAME    PIC X(48)   VALUE SPACES.     00760002
007700     05  FILLER                     PIC X(32)   VALUE SPACES.     00770002
007800                                                                  00780002
007900 01  PS-PROGRAM-SWITCHES.                                         00790002
008000     05  PS-PROCESS-COMP-SW              PIC X(01)   VALUE 'N'.   00800002
008100         88  PS-PROCESS-COMPLETE-YES                 VALUE 'Y'.   00810002
008200         88  PS-PROCESS-COMPLETE-NO                  VALUE 'N'.   00820002
008300                                                                  00830002
008400     05  PS-PROCESS-INDICATOR-SW         PIC X(01)   VALUE 'N'.   00840002
008500         88  PS-PROCESS-CONTINUE-YES                 VALUE 'Y'.   00850002
008600         88  PS-PROCESS-CONTINUE-NO                  VALUE 'N'.   00860002
008700                                                                  00870002
008800     05  PS-ERROR-SW                    PIC X(01)    VALUE 'N'.   00880002
008900         88  PS-NO-ERROR                             VALUE 'N'.   00890002
009000         88  PS-ERROR                                VALUE 'Y'.   00900002
009100     05  PS-HEADER-SW                   PIC X(01) VALUE 'A'.      00910002
009200         88  PS-UPDATE-OLD-HEADER                 VALUE 'U'.      00920002
009300         88  PS-ADD-NEW-HEADER                    VALUE 'A'.      00930002
009400     05  PS-ERROR-QUE-OPEN-SW         PIC X(01)   VALUE 'N'.              
009500         88  PS-ERROR-QUE-OPEN-YES                VALUE 'Y'.      10081011
009600         88  PS-ERROR-QUE-OPEN-NO                 VALUE 'N'.      10081011
009700                                                                  00940002
009800 01  PV-PROGRAM-VARIABLES.                                        00950002
009900     05  PV-COMPILE-DATE              PIC X(016) VALUE SPACES.    00960002
010000     05  PV-DEBUG-SW                  PIC X(01) VALUE 'N'.        00970002
010100     05  PV-PARM-TIMESTAMP         PIC X(26).                     00980002
010200     05  PV-CURRENT-SYSID               PIC X(4)  VALUE SPACES.   00990002
010300         88  PV-KOHLS-TEST-SYSTEM            VALUE 'CIT1'.        01000002
010400         88  PV-KOHLS-ACC-TEST-SYSTEM        VALUE 'CIQA',        01010002
010500                                                   'CIQT',        01020002
010600                                                   'CILA',        01030002
010700                                                   'CILT'.        01040002
010800         88  PV-KOHLS-QA-SYSTEM              VALUE 'CIQA',        01050002
010900                                                   'CIQT'.        01060002
011000         88  PV-KOHLS-LEARNING-SYSTEM        VALUE 'CILA',        01070002
011100                                                   'CILT'.        01080002
011200         88  PV-KOHLS-PROD-SYSTEM            VALUE 'CIPS',        01090002
011300                                                   'CIP1',        01100002
011400                                                   'CIP3',        01110002
011500                                                   'CIP4',        01120002
011600                                                   'CIP6'.        01130002
011700     05  PV-CURRENT-NETNAME             PIC X(8)  VALUE SPACES.   01140002
011800     05  PV-RETRY-COUNTER               PIC S9(04)                01150002
011900                                             VALUE ZERO           01160002
012000                                             COMP SYNC.           01170002
012100     05  PV-LOC-NBR                     PIC S9(4) COMP.           01180002
012200     05  PV-EDIT-INTR-UPC-ID            PIC S9(18) COMP.          01190002
012300     05  PV-INTR-UPC-ID-R REDEFINES PV-EDIT-INTR-UPC-ID.          01200002
012400         10  FILLER                     PIC  X(04).               01210002
012500         10  PV-INTR-UPC-ID-COMP        PIC S9(09) COMP.          01220002
012600     05  PV-INTR-UPC-ID                 PIC S9(09) COMP.          01230002
012700     05  PV-QTY-CHANGE                  PIC  S9(07)V COMP-3       01240002
012800                                              VALUE 0.            01250002
012900     05  PV-IN-TRNST-QTY                PIC  S9(07)V COMP-3       01260002
013000                                              VALUE 0.            01270002
013100     05  PV-IN-TRNST-TRN-QTY            PIC  S9(07)V COMP-3       01280002
013200                                              VALUE 0.            01290002
013300     05  PV-IN-TRNST-BAL-QTY            PIC  S9(07)V COMP-3       01300002
013400                                              VALUE 0.            01310002
013500                                                                  01320002
013600 01  PV-CURRENT-TMST                PIC X(26)  VALUE SPACES.      01330002
013700 01  PV-BEGIN-TMST                  PIC X(26)  VALUE SPACES.      01340002
013800 01  PV-CURRENT-DATE                PIC X(10)  VALUE SPACE.       01350002
013900                                                                  01360002
014000 01  MQ-SERIES-VARIABLES.                                         01370002
014100     05  PV-MSG.                                                  01380002
014200         10  PV-MSG-END               PIC X(30).                  01390002
014300             88  PV-END-RUN-MSG       VALUE 'END RUN OF PROGRAM'. 01400002
014400             88  PV-STOP-SUB-MSG                                  01410002
014500                VALUE 'STOP SUBSCRIBING'.                         01420002
014600         10  FILLER                   PIC X(470).                 01430002
014700                                                                  01440002
014800     05  PV-GET-MESSAGE-BUFFER          PIC  X(500)               01450002
014900                                              VALUE SPACES.       01460002
015000     05  PV-GET-MSG-BUFFER-LENGTH       PIC S9(009)               01470002
015100                                              BINARY              01480002
015200                                              VALUE 500.          01490002
015300     05  PV-GET-DATA-LENGTH             PIC S9(009)               01500002
015400                                              BINARY              01510002
015500                                              VALUE 0.            01520002
015600     05  PV-PUT-MESSAGE-BUFFER          PIC  X(200)               01530002
015700                                           VALUE SPACES.          01540002
015800     05  PV-PUT-MSG-BUFFER-LENGTH       PIC S9(009)               01550002
015900                                              BINARY              01560002
016000                                              VALUE 200.          01570002
016100     05  PV-MESSAGE-LENGTH-IND-X        PIC  X(002).              01580002
016200     05  PV-MESSAGE-LENGTH-IND                                    01590002
016300      REDEFINES PV-MESSAGE-LENGTH-IND-X PIC S9(004)               01600002
016400                                              COMP.               01610002
016500     05  PV-CONNECT-HANDLE              PIC S9(009)               01620002
016600                                              BINARY              01630002
016700                                              VALUE 0.            01640002
016800     05  PV-GETQ-HANDLE                 PIC S9(009)               01650002
016900                                              BINARY              01660002
017000                                              VALUE 0.            01670002
017100     05  PV-OPEN-OPTIONS                PIC S9(009)               01680002
017200                                              BINARY              01690002
017300                                              VALUE 0.            01700002
017400     05  PV-COMPLETION-CODE             PIC S9(009)               01710002
017500                                              BINARY              01720002
017600                                              VALUE 0.            01730002
017700     05  PV-REASON                      PIC S9(009)               01740002
017800                                              BINARY              01750002
017900                                              VALUE 0.            01760002
018000     05  PV-CONNECT-REASON              PIC S9(009)               01770002
018100                                              BINARY              01780002
018200                                              VALUE 0.            01790002
018300     05  PV-DISPLAY-REASON            PIC S9(009)                 01800002
018400                                              VALUE 0.            01810002
018500     05  PV-DISPLAY-COMP-CODE         PIC S9(009)                 01820002
018600                                              VALUE 0.            01830002
018700     05  PV-DISPLAY-COMP-CDE          PIC  X(004).                01840002
018800     05  PV-DISPLAY-REASON-CDE        PIC  X(004).                01850002
018900     05  PV-DISP-NBR                  PIC ZZZ,ZZZ,ZZ9.            01860002
019000                                                                  01870002
019100 01  PV-MISC-ABEND-FIELDS.                                        01880002
019200     05  PV-PARAGRAPH-NAME            PIC X(30) VALUE SPACE.      01890002
019300     05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACE.      01900002
019400     05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACE.      01910002
019500     05  PV-DB2-OPERATION             PIC X(30) VALUE SPACE.      01920002
019600     05  PV-DISPLAY-RETURN-CODE       PIC ZZZZ9- VALUE ZERO.      01930002
019700                                                                  01940002
019800 01  PV-ABEND-VARIABLES.                                          01950002
019900     05  ABEND-CODE                   PIC S9(04) VALUE ZERO       01960002
020000                                          COMP SYNC.              01970002
020100     88  ABEND-4013-DB2-ERROR             VALUE +4013.            01980002
020200     88  ABEND-4020-MQ-ERROR              VALUE +4020.            01990002
020300     88  ABEND-4095-NOTIFY                VALUE +4095.            02000002
020400                                                                  02010002
020500 01  PE-PROGRAM-ERROR-MESSAGES.                                   02020002
020600*** MQ CALL ERROR MESSAGES - LENGTH 68 BYTES                      02030002
020700***************************************************************** 02040002
020800**** 05  PE-MQ-ERROR-MESSAGE.                                     02050002
020900****   10  FILLER                       PIC  X(021)               02060002
021000****       VALUE 'OPER033 -- IT ABEND -'.                         02070002
021100****   10  FILLER                       PIC  X(010)               02080002
021200****       VALUE 'MQ ERROR: '.                                    02090002
021300****   10  PE-MQ-CALL-TYPE              PIC  X(007) VALUE SPACES. 02100002
021400****   10  FILLER                       PIC  X(002) VALUE SPACES. 02110002
021500****   10  FILLER                       PIC  X(009)               02120002
021600****       VALUE 'COMP CDE='.                                     02130002
021700****   10  PE-MQ-COMPLETION-CODE        PIC  9(004) VALUE ZEROS.  02140002
021800****   10  FILLER                       PIC  X(002) VALUE SPACES. 02150002
021900****   10  FILLER                       PIC  X(008)               02160002
022000****       VALUE 'RSN CDE='.                                      02170002
022100****   10  PE-MQ-REASON-CODE            PIC  9(004) VALUE ZEROS.  02180002
022200****   10  FILLER                       PIC  X(001) VALUE SPACES. 02190002
022300***************************************************************** 02200002
022400     05  PE-MQ-ERROR-MESSAGE.                                     02210002
022500       10  FILLER                       PIC  X(021)               02220002
022600           VALUE '** IT TEST MESSAGE **'.                         02230002
022700       10  FILLER                       PIC  X(010)               02240002
022800           VALUE 'MQ ERROR: '.                                    02250002
022900       10  PE-MQ-CALL-TYPE              PIC  X(007) VALUE SPACES. 02260002
023000       10  FILLER                       PIC  X(002) VALUE SPACES. 02270002
023100       10  FILLER                       PIC  X(009)               02280002
023200           VALUE 'COMP CDE='.                                     02290002
023300       10  PE-MQ-COMPLETION-CODE        PIC  9(004) VALUE ZEROS.  02300002
023400       10  FILLER                       PIC  X(002) VALUE SPACES. 02310002
023500       10  FILLER                       PIC  X(008)               02320002
023600           VALUE 'RSN CDE='.                                      02330002
023700       10  PE-MQ-REASON-CODE            PIC  9(004) VALUE ZEROS.  02340002
023800       10  FILLER                       PIC  X(001) VALUE SPACES. 02350002
023900*                                                                 02360002
024000*** DB2 CALL ERROR MESSAGES - LENGTH 40 BYTES                     02370002
024100*                                                                 02380002
024200     05  PE-DB2-ERROR-MESSAGE.                                    02390002
024300       10  FILLER                       PIC X(016)                02400002
024400           VALUE 'DB2 ERR IN PARA-'.                              02410002
024500       10  PE-DB2-PARA                  PIC X(004) VALUE SPACES.  02420002
024600       10  FILLER                       PIC X(001) VALUE SPACES.  02430002
024700       10  FILLER                       PIC X(009)                02440002
024800           VALUE 'SQLCODE: '.                                     02450002
024900       10  PE-DB2-SQLCODE            PIC ZZZZZ999- VALUE ZEROES.  02460002
025000*** MQ MESSAGE DETAIL ERROR - LENGTH 40 BYTES                     02470002
025100     05  PE-MQ-MSG-DETAIL.                                        02480002
025200       10  PE-PARA                      PIC  X(005).              02490002
025300       10  PE-PARAGRAPH-NBR             PIC  X(005).              02500002
025400       10  PE-ERROR-MSG                 PIC  X(029).              02510002
025500                                                                  02520002
025600 01  PC-PROGRAM-CONSTANTS.                                        02530002
025700     05  PC-OPERATING-COMPANY           PIC X(02)   VALUE '03'.   02540002
025800     05  PC-CURRENT-PROGRAM-NAME        PIC X(08)   VALUE         02550002
025900                                                    'PCKUP012'.   02560002
026000     05  PC-MAX-RETRY-CNT          PIC S9(04)    VALUE 3          02570002
026100                                                 COMP SYNC.       02580002
026200     05  PC-MORE-THAN-MAX-RETRY    PIC S9(04)    VALUE 4          02590002
026300                                                 COMP SYNC.       02600002
026400     05  PC-CORP-STR-NBR                PIC X(03)  VALUE '000'.   02610002
026500                                                                  02620002
026600 01  PA-PROGRAM-ACCUMULATORS COMP-3.                              02630002
026700     05  PA-MESSAGE-FROM-QUEUE        PIC S9(09) VALUE ZEROS.     02640002
026800     05  PA-MESSAGES-WRITTEN-TO-BKUP  PIC S9(09) VALUE ZEROS.     02650002
026900     05  PA-MESSAGES-UPDATED          PIC S9(09) VALUE ZEROS.     02660002
027000     05  PA-MESSAGES-TO-ERROR-QUEUE   PIC S9(09) VALUE ZEROS.     02670002
027100     05  PA-PO-LIST-MESSAGES          PIC S9(09) VALUE 0.         02680002
027200     05  PA-END-OF-RUN-MESSAGES       PIC S9(09) VALUE 0.         02690002
027300     05  PA-STOP-PROC-MESSAGES        PIC S9(09) VALUE 0.         02700002
027400     05  PA-HEADERS-INSERTED          PIC S9(09) VALUE 0.         02710002
027500     05  PA-HEADERS-UPDATED           PIC S9(09) VALUE 0.         02720002
027600     05  PA-DETAILS-INSERTED          PIC S9(09) VALUE 0.         02730002
027700                                                                  02740002
027800 01 MQ-SERIES-CONSTANTS.                                          02750002
027900     05  PC-MQCONN                PIC X(008)  VALUE 'CSQCCONN'.   02760002
028000     05  PC-MQOPEN                PIC X(008)  VALUE 'CSQCOPEN'.   02770002
028100     05  PC-MQGET                 PIC X(008)  VALUE 'CSQCGET'.    02780002
028200     05  PC-MQPUT1                PIC X(008)  VALUE 'CSQCPUT1'.   02790002
028300     05  PC-MQCLOSE               PIC X(008)  VALUE 'CSQCCLOS'.   02800002
028400     05  PC-MQDISC                PIC X(008)  VALUE 'CSQCDISC'.   02810002
028500     05  PC-QMGR-NAME             PIC X(004)  VALUE SPACES.       02820002
028600       88  PC-PROD-QMGR-NAME                  VALUE 'QKSP'.       02830002
028700       88  PC-QA-QMGR-NAME                    VALUE 'QKSQ'.       02840002
028800       88  PC-TEST-QMGR-NAME                  VALUE 'QKST'.       02850002
028900*** THIS IS THE INPUT QUEUE NAME                                  02860002
029000     05  PC-IT-MERCH-ADJ-Q-NAME         PIC X(020)                02870002
029100         VALUE 'PC.MERCHANDISE.ADJ.Q'.                            02880002
029200***  05  PC-IT-MERCH-ADJ-Q-NAME         PIC X(017)                02890002
029300***      VALUE 'ISTRN7_TRANS_DATA'.                               02900002
029400*** THIS IS THE OUTPUT QUEUE NAME                                 02910002
029500     05  PC-IT-ERROR-Q-NAME             PIC X(026)                02920002
029600         VALUE 'PC.MERCHANDISE.ADJ.ERROR.Q'.                      02930002
029700                                                                  02940002
029800**** 05  PC-IT-ERROR-Q-NAME             PIC X(020)                02950002
029900****     VALUE 'ISTRN7_UPDATE_REPORT'.                            02960002
030000*** THIS IS THE OUTPUT WAIT TIME INTERVAL CURRENTLY 5 MINUTES     02970002
030100*** THIS IS CALCULATED 5MIN * 60SECS * 1000 = 300,000             02980002
030200*****05  PC-MQGET-WAIT-TIME             PIC S9(009)               02990002
030300*****                                         VALUE 300000        03000002
030400*****                                         BINARY.             03010002
030500     05  PC-MQGET-WAIT-TIME             PIC S9(009)               03020002
030600                                              VALUE 2000          03030002
030700                                              BINARY.             03040002
030800/                                                                 03050002
030900 01  MQV-WORKING-STORAGE.                                         03060002
031000     05  MQV-MQCONN                 PIC  X(08) VALUE 'CSQBCONN'.  03070002
031100     05  MQV-MQOPEN                 PIC  X(08) VALUE 'CSQBOPEN'.  03080002
031200     05  MQV-MQPUT                  PIC  X(08) VALUE 'CSQBPUT'.   03090002
031300     05  MQV-MQGET                  PIC  X(08) VALUE 'CSQBGET'.   03100002
031400     05  MQV-MQCMIT                 PIC  X(08) VALUE 'CSQBCOMM'.  03110002
031500     05  MQV-MQBACK                 PIC  X(08) VALUE 'CSQBBACK'.  03120002
031600     05  MQV-MQCLOSE                PIC  X(08) VALUE 'CSQBCLOS'.  03130002
031700     05  MQV-MQDISC                 PIC  X(08) VALUE 'CSQBDISC'.  03140002
031800     05  MQV-MQCHECK                PIC  X(08) VALUE 'MQR2C'.     03150002
031900     05  MQV-HCONN                  PIC S9(09) BINARY VALUE 0.    03160002
032000     05  MQV-COMPLETION-CODE        PIC S9(09) BINARY.            03170002
032100     05  MQV-REASON                 PIC S9(09) BINARY.            03180002
032200     05  MQV-OPEN-OPTIONS           PIC S9(09) BINARY.            03190002
032300     05  MQV-LOC-HANDLE1            PIC S9(09) BINARY VALUE 0.    03200002
032400     05  MQV-LOC-HANDLE2            PIC S9(09) BINARY VALUE 0.    03210002
032500     05  MQV-ERROR-HANDLE           PIC S9(09) BINARY VALUE 0.    03220002
032600     05  MQV-REASON-TEXT            PIC X(30)  VALUE SPACES.      03230002
032700     05  MQV-MSGBUFFER            PIC X(500)  VALUE SPACES.       03240002
032800     05  MQV-MSG                  PIC X(500)  VALUE SPACES.       03250002
032900     05  MQV-ERRMSGBUF            PIC X(500)  VALUE SPACES.       03260002
033000     05  MQV-MSG-LENGTH           PIC S9(09)                      03270002
033100                                     BINARY VALUE +500.           03280002
033200     05  MQV-DATA-LENGTH          PIC S9(09) BINARY.              03290002
033300/                                                                 03300002
033400***************************************************************** 03310002
033500* MQ SERIES API CONTROL BLOCKS                                    03320002
033600***************************************************************** 03330002
033700 01  MQM-OBJECT-DESCRIPTOR.                                       03340002
033800     COPY CMQODV.                                                 03350002
033900                                                                  03360002
034000 01  MQM-MESSAGE-DESCRIPTOR.                                      03370002
034100     COPY CMQMDV.                                                 03380002
034200                                                                  03390002
034300 01  MQM-GET-MESSAGE-OPTIONS.                                     03400002
034400     COPY CMQGMOV.                                                03410002
034500                                                                  03420002
034600 01  MQM-PUT-MESSAGE-OPTIONS.                                     03430002
034700     COPY CMQPMOV.                                                03440002
034800                                                                  03450002
034900***************************************************************** 03460002
035000* MQV CONTAINS CONSTANTS(FOR FILLING IN THE CONTROL BLOCKS)       03470002
035100* AND RETURN CODES(FOR TESTING THE RESULT OF A CALL)              03480002
035200***************************************************************** 03490002
035300 01  MQM-CONSTANTS.                                               03500002
035400     COPY CMQV.                                                   03510002
035500                                                                  03520002
035600     COPY DPWS004.                                                03530002
035700                                                                  03540002
035800*    ABEND PROCESSING                                             03550002
035900     COPY DPWS013.                                                03560002
036000                                                                  03570002
036100*    MQ INPUT                                                     03580002
036200     COPY ISRD001.                                                03590002
036300                                                                  03600002
036400*    IN-TRANSIT ERROR QUEUE                                       03610002
036500     COPY PCRD013.                                                03620002
036600                                                                  03630002
036700*    IN-TRANSIT MESSAGE LOG                                       03640002
036800     COPY PCRD014.                                                03650002
036900                                                                  03660002
037000*    PCT_TRN_CLSN_BAL                                             03670002
037100     EXEC SQL                                                     03680002
037200          INCLUDE PCT00014                                        03690002
037300     END-EXEC.                                                    03700002
037400                                                                  03710002
037500*    PCT_TRN_CLSN_DTL                                  *          03720002
037600     EXEC SQL                                                     03730002
037700          INCLUDE PCT00015                                        03740002
037800     END-EXEC.                                                    03750002
037900                                                                  03760002
038000*    PARM TABLE                                                   03770002
038100     EXEC SQL                                                     03780002
038200          INCLUDE TKRPRPM                                         03790002
038300     END-EXEC.                                                    03800002
038400                                                                  03810002
038500     EXEC SQL                                                     03820002
038600          INCLUDE SQLCA                                           03830002
038700     END-EXEC.                                                    03840002
038800                                                                  03850002
038900     COPY SQLCA2.                                                 03860002
039000                                                                  03870002
039100 LINKAGE SECTION.                                                 03880002
039200                                                                  03890002
039300 PROCEDURE DIVISION.                                              03900002
039400                                                                  03910002
039500     PERFORM 1000-INITIALIZE.                                     03920002
039600                                                                  03930002
039700     IF PV-DEBUG-SW = 'Y'                                         08940002
039800         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        03940002
039900     END-IF                                                               
040000                                                                  03950002
040100     PERFORM 2000-PROCESS-ADJ-REQUEST                             03960002
040200         UNTIL PS-PROCESS-COMPLETE-YES                            03970002
040300                                                                  03980002
040400     IF PV-DEBUG-SW = 'Y'                                         08940002
040500         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        03990002
040600     END-IF                                                               
040700                                                                  04000002
040800     PERFORM 9900-WRAPUP.                                         04010002
040900                                                                  04020002
041000     GOBACK.                                                      04030002
041100                                                                  04040002
041200******************************************************************04050002
041300* THIS PARAGRAPH WILL DEFINE THE CURRENT SYSTEM ID AND THE FULL  *04060002
041400* LOGICAL UNIT NAME FOR THE LINE ON WHICH THIS TRANSACTION IS    *04070002
041500* RUNNING.                                                       *04080002
041600******************************************************************04090002
041700 1000-INITIALIZE.                                                 04100002
041800                                                                  04110002
041900     MOVE WHEN-COMPILED               TO PV-COMPILE-DATE          04120002
042000     DISPLAY ' COMPILED ON: ' PV-COMPILE-DATE(1:08) ' '           04130002
042100                              PV-COMPILE-DATE(09:08)              04140002
042200     MOVE '1000-INITIALIZE'           TO PV-PARAGRAPH-NAME.       04150002
042300                                                                  04160002
042400     OPEN INPUT  CONTROL-CARD-1                                   04170002
042500                 CONTROL-CARD-2                                   04180002
042600                 CONTROL-CARD-3                                   04190002
042700                                                                  04200002
042800     PERFORM 8900-READ-CONTROL-CARD-1.                            04210002
042900     PERFORM 8910-READ-CONTROL-CARD-2.                            04220002
043000     PERFORM 8920-READ-CONTROL-CARD-3.                            04230002
043100                                                                  04240002
043200     IF  CC-QUEUE-MANAGER-NAME    =  SPACES                       04250002
043300      OR CC-LOCATION-QUEUE-NAME =    SPACES                       04260002
043400      OR CC-LOC-ERROR-QUEUE-NAME =     SPACES                     04270002
043500         DISPLAY 'EMPTY CONTROL CARD'                             04280002
043600         DISPLAY 'QUEUE MANAGER NAME    ' CC-QUEUE-MANAGER-NAME   04290002
043700         DISPLAY 'LOCATION QUEUE NAME ' CC-LOCATION-QUEUE-NAME    04300002
043800         DISPLAY 'LOCATION ERROR QUEUE NAME '                     04310002
043900                                   CC-LOC-ERROR-QUEUE-NAME        04320002
044000         PERFORM 9000-MQ-ABEND                                    04330002
044100     END-IF.                                                      04340002
044200                                                                  04350002
044300     PERFORM 7000-SELECT-TKRPRPM                                  04360002
044400     PERFORM 7010-DISPLAY-MSGS                                    04370002
044500                                                                  04380002
044600     PERFORM 8000-CONNECT-TO-QMGR.                                04390002
044700     PERFORM 8010-OPEN-LOCATION-QUEUE.                            04400002
044800     PERFORM 8020-OPEN-ERROR-QUEUE.                               04410002
044900                                                                  04420002
045000                                                                  04430002
045100     PERFORM 1010-SET-CURRENT-TMST.                               04440002
045200     PERFORM 1015-SET-CURRENT-DATE.                               04450002
045300                                                                  04460002
045400     MOVE 'N' TO PS-ERROR-SW.                                     04470002
045500                                                                  04480002
045600     PERFORM 8100-GET-MESSAGE.                                    04490002
045700/                                                                 04500002
045800 1010-SET-CURRENT-TMST.                                           04510002
045900                                                                  04520002
046000     IF PV-DEBUG-SW = 'Y'                                         04530002
046100         DISPLAY 'PCKUP012 - 1010-SET-CURRENT-TMST'               04540002
046200     END-IF.                                                      04550002
046300                                                                  04560002
046400     EXEC SQL                                                     04570002
046500         SET :PV-CURRENT-TMST = CURRENT TIMESTAMP                 04580002
046600     END-EXEC                                                     04590002
046700                                                                  04600002
046800     EVALUATE TRUE                                                04610002
046900        WHEN SQLCODE = ZERO                                       04620002
047000            CONTINUE                                              04630002
047100                                                                  04640002
047200        WHEN SQLWARN0 NOT = SPACES                                04650002
047300        WHEN SQLCODE  NOT = ZERO                                  04660002
047400            DISPLAY '**************************************'      04670002
047500            DISPLAY '** ABEND                            **'      04680002
047600            DISPLAY '** PROGRAM = PCKUP012               **'      04690002
047700            DISPLAY '** PARAGRAPH = 1010-SET-CURRENT-TMST**'      04700002
047800            DISPLAY '** SET CURRENT TIMESTAMP            **'      04710002
047900            DISPLAY '** SQLCODE = ' SQLCODE                       04720002
048000            DISPLAY '**************************************'      04730002
048100            PERFORM 9100-SQL-ABEND-ROUTINE                        04740002
048200     END-EVALUATE.                                                04750002
048300                                                                  04760002
048400******************************************************************04770002
048500* SET THE CURRENT DATE.                                           04780002
048600******************************************************************04790002
048700 1015-SET-CURRENT-DATE.                                           04800002
048800                                                                  04810002
048900                                                                  04820002
049000     IF PV-DEBUG-SW = 'Y'                                         04830002
049100         DISPLAY 'PCKUP012 - 1015-SET-CURRENT-DATE'               04840002
049200     END-IF.                                                      04850002
049300                                                                  04860002
049400     EXEC SQL                                                     04870002
049500         SET :PV-CURRENT-DATE = CURRENT DATE                      04880002
049600     END-EXEC                                                     04890002
049700                                                                  04900002
049800     EVALUATE TRUE                                                04910002
049900        WHEN SQLCODE = ZERO                                       04920002
050000            CONTINUE                                              04930002
050100                                                                  04940002
050200        WHEN SQLWARN0 NOT = SPACES                                04950002
050300        WHEN SQLCODE  NOT = ZERO                                  04960002
050400            DISPLAY '**************************************'      04970002
050500            DISPLAY '** ABEND                            **'      04980002
050600            DISPLAY '** PROGRAM = PCKUP012               **'      04990002
050700            DISPLAY '** PARAGRAPH = 1015-SET-CURRENT-DATE**'      05000002
050800            DISPLAY '** SET CURRENT DATE                 **'      05010002
050900            DISPLAY '** SQLCODE = ' SQLCODE                       05020002
051000            DISPLAY '**************************************'      05030002
051100            PERFORM 9100-SQL-ABEND-ROUTINE                        05040002
051200     END-EVALUATE.                                                05050002
051300/                                                                 05060002
051400******************************************************************05070002
051500* THIS PARAGRAPH WILL PROCESS THE ADJUSTMENT REQUESTS UNTIL      *05080002
051600* THE QUEUE IS EMPTY.  THERE ARE CURRENTLY FOUR TYPES OF         *05090002
051700* ADJUSTMENTS - ONHAND ADJUSTMENT, RECEIPT ADJUSTMENT, SKU        05100002
051800* TRANSFERS, AND IN-TRANSIT ADJUSTMENTS.                         *05110002
051900* THERE ARE MULTIPLE SYNCPOINTS IN THIS PARAGRAPH.  THE FIRST    *05120002
052000* WILL COMPLETE THE ADJUSTMENT.  THE LAST WILL ENSURE THAT       *05130002
052100* WE ALWAYS PERFORM A DESTRUCTIVE READ OF THE QUEUE.             *05140002
052200******************************************************************05150002
052300 2000-PROCESS-ADJ-REQUEST.                                        05160002
052400                                                                  05170002
052500     IF PV-DEBUG-SW = 'Y'                                         05180002
052600         DISPLAY 'PCKUP012 - 2000-PROCESS-ADJ-REQUEST'            05190002
052700     END-IF.                                                      05200002
052800                                                                  05210002
052900     MOVE 'N' TO PS-ERROR-SW.                                     05220002
053000                                                                  05230002
053100     EVALUATE TRUE                                                05240002
053200     WHEN IS001-IN-TRNST-UNT-ADJ-QTY = ZERO                       05250002
053300     WHEN IS001-STR-NBR  = ZERO                                   05260002
053400     WHEN IS001-ADJ-ACTN-CDE = 'R'                                05270002
053500     WHEN IS001-FR-INTR-UPC-ID = ZERO                             05280002
053600         CONTINUE                                                 05290002
053700     WHEN OTHER                                                   05300002
053800         MOVE IS001-FR-INTR-UPC-ID    TO PV-EDIT-INTR-UPC-ID      05310002
053900         MOVE PV-INTR-UPC-ID-COMP     TO PV-INTR-UPC-ID           05320002
054000         EVALUATE IS001-ADJ-TYP-CDE                               05330002
054100             WHEN 'OA'                                            05340002
054200             WHEN 'RA'                                            05350002
054300             WHEN 'SA'                                            05360002
054400                 PERFORM 2100-PROCESS-ADJ                         05370002
054500             WHEN 'ST'                                            05380002
054600                 PERFORM 2100-PROCESS-ADJ                         05390002
054700                 IF PS-NO-ERROR                                   05400002
054800                     MOVE IS001-FR-INTR-UPC-ID                    05410002
054900                                      TO PV-EDIT-INTR-UPC-ID      05420002
055000                     MOVE PV-INTR-UPC-ID-COMP                     05430002
055100                                      TO PV-INTR-UPC-ID           05440002
055200                     MOVE 'I'         TO IS001-ADJ-ACTN-CDE       05450002
055300                     PERFORM 3000-CALC-INTRNST-QTY                05460002
055400                     IF PS-NO-ERROR                               05470002
055500                         PERFORM 7150-UPDATE-INTRANSIT-HEADER     05480002
055600                     END-IF                                       05490002
055700                 END-IF                                           05500002
055800             WHEN OTHER                                           05510002
055900                 SET PS-ERROR         TO TRUE                     05520002
056000         END-EVALUATE                                             05530002
056100     END-EVALUATE.                                                05540002
056200                                                                  05550002
056300     PERFORM 7900-COMMIT-DB2                                      05560002
056400     PERFORM 8100-GET-MESSAGE.                                    05570002
056500                                                                  05580002
056600*    IF PS-NO-ERROR                                               05590002
056700*       PERFORM 9998-CICS-SYNCPOINT                               05600002
056800*    END-IF.                                                      05610002
056900/                                                                 05620002
057000******************************************************************05630002
057100* THIS PARAGRAPH PROCESSES 'OA', 'RA', AND 'IT' ADJUSMENTS. IT    05640002
057200* WILL TRY TO SELECT A ROW FROM PCT_IN_TRNST_QTY.  IF SUCCESSFUL, 05650002
057300* THE ROW WILL BE UPDATED.  IF NO ROW IS FOUND, A ROW WILL BE     05660002
057400* INSERTED.  A ROW WILL ALSO BE INSERTED ONTO THE PCT_IN_TRNST_   05670002
057500* TRN TABLE.                                                      05680002
057600* IF ANY ERRORS OCCUR - WRITE ERROR RECORD TO THE ERROR QUEUE     05690002
057700* AND READ THE NEXT MQ MESSAGE.                                   05700002
057800******************************************************************05710002
057900 2100-PROCESS-ADJ.                                                05720002
058000                                                                  05730002
058100     IF PV-DEBUG-SW = 'Y'                                         05740002
058200         DISPLAY 'PCKUP012 - 2100-PROCESS-ADJ'                    05750002
058300     END-IF.                                                      05760002
058400                                                                  05770002
058500     MOVE IS001-STR-NBR               TO PV-LOC-NBR               05780002
058600     PERFORM 7100-SELECT-INTRANSIT-HEADER.                        05790002
058700                                                                  05800002
058800     IF PS-NO-ERROR                                               05810002
058900         MOVE IS001-IN-TRNST-UNT-ADJ-QTY  TO PV-QTY-CHANGE        05820002
059000         IF PS-UPDATE-OLD-HEADER                                  05830002
059100             PERFORM 3000-CALC-INTRNST-QTY                        05840002
059200             IF PS-NO-ERROR                                       05850002
059300                 PERFORM 7150-UPDATE-INTRANSIT-HEADER             05860002
059400             END-IF                                               05870002
059500         ELSE                                                     05880002
059600             IF PS-ADD-NEW-HEADER                                 05890002
059700                 PERFORM 3100-CALC-INTRNST-QTY                    05900002
059800                 IF PS-NO-ERROR                                   05910002
059900                     PERFORM 7050-INSERT-INTRANSIT-HEADER         05920002
060000                 END-IF                                           05930002
060100             END-IF                                               05940002
060200         END-IF                                                   05950002
060300     END-IF.                                                      05960002
060400                                                                  05970002
060500     IF PS-NO-ERROR                                               05980002
060600         PERFORM 7125-INSERT-INTRANSIT-TRANS                      05990010
060700     END-IF.                                                      06000002
060800                                                                  06010002
060900/                                                                 06020002
061000******************************************************************06030002
061100*    CALCULATE THE INTRANSIT QTY  FOR AN UPDATE                  *06040002
061200******************************************************************06050002
061300 3000-CALC-INTRNST-QTY.                                           06060002
061400                                                                  06070002
061500     IF PV-DEBUG-SW = 'Y'                                         06080002
061600         DISPLAY 'PCKUP012 - 3000-CALC-INTRNST-QTY'               06090002
061700     END-IF.                                                      06100002
061800                                                                  06110002
061900     EVALUATE IS001-ADJ-ACTN-CDE                                  06120002
062000         WHEN 'D'                                                 06130002
062100            COMPUTE PV-IN-TRNST-QTY =                             06140002
062200                          (PCT00014-TRN-CLSN-QTY - PV-QTY-CHANGE) 06150002
062300            MOVE PV-IN-TRNST-QTY  TO   PV-IN-TRNST-BAL-QTY        06160002
062400            COMPUTE PV-QTY-CHANGE = (PV-QTY-CHANGE * -1)          06170002
062500         WHEN 'I'                                                 06180002
062600            COMPUTE PV-IN-TRNST-QTY =                             06190002
062700                          (PCT00014-TRN-CLSN-QTY + PV-QTY-CHANGE) 06200002
062800            MOVE PV-IN-TRNST-QTY  TO  PV-IN-TRNST-BAL-QTY         06210002
062900         WHEN OTHER                                               06220002
063000             SET PS-ERROR TO TRUE                                 06230002
063100             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     06240002
063200             MOVE 'PARA-' TO PE-PARA                              06250002
063300             MOVE '3000-' TO PE-PARAGRAPH-NBR                     06260002
063400             MOVE 'INVALID ADJUSTMENT ACTION CDE' TO PE-ERROR-MSG 06270002
063500             PERFORM 5000-FORMAT-ERROR-MESSAGE                    06280002
063600             PERFORM 8250-PUT-ON-ERROR-QUEUE                      06290002
063700     END-EVALUATE.                                                06300002
063800                                                                  06310002
063900******************************************************************06320002
064000*    CALCULATE THE INTRANSIT QTY  FOR AN INSERT                  *06330002
064100******************************************************************06340002
064200 3100-CALC-INTRNST-QTY.                                           06350002
064300                                                                  06360002
064400     IF PV-DEBUG-SW = 'Y'                                         06370002
064500         DISPLAY 'PCKUP012 - 3100-CALC-INTRNST-QTY'               06380002
064600     END-IF.                                                      06390002
064700                                                                  06400002
064800     EVALUATE IS001-ADJ-ACTN-CDE                                  06410002
064900         WHEN 'D'                                                 06420002
065000            COMPUTE PV-IN-TRNST-QTY = (PV-QTY-CHANGE * -1)        06430002
065100            MOVE PV-IN-TRNST-QTY  TO   PV-IN-TRNST-BAL-QTY        06440002
065200            COMPUTE PV-QTY-CHANGE = (PV-QTY-CHANGE * -1)          06450002
065300         WHEN 'I'                                                 06460002
065400            MOVE PV-QTY-CHANGE    TO   PV-IN-TRNST-QTY            06470002
065500            MOVE PV-IN-TRNST-QTY  TO   PV-IN-TRNST-BAL-QTY        06480002
065600         WHEN OTHER                                               06490002
065700             SET PS-ERROR TO TRUE                                 06500002
065800             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     06510002
065900             MOVE 'PARA-' TO PE-PARA                              06520002
066000             MOVE '3100-' TO PE-PARAGRAPH-NBR                     06530002
066100             MOVE 'INVALID ADJUSTMENT ACTION CDE' TO PE-ERROR-MSG 06540002
066200             PERFORM 5000-FORMAT-ERROR-MESSAGE                    06550002
066300             PERFORM 8250-PUT-ON-ERROR-QUEUE                      06560002
066400     END-EVALUATE.                                                06570002
066500/                                                                 06580002
066600******************************************************************06590002
066700* FORMAT MQ ERROR MESSAGE.                                       *06600002
066800******************************************************************06610002
066900 5000-FORMAT-ERROR-MESSAGE.                                       06620002
067000                                                                  06630002
067100     IF PV-DEBUG-SW = 'Y'                                         06640002
067200         DISPLAY 'PCKUP012 - 5000-FORMAT-ERROR-MESSAGE'           06650002
067300     END-IF.                                                      06660002
067400                                                                  06670002
067500     MOVE 'ERR'                      TO  PC013-RECORD-TYPE        06680007
067600     MOVE IS001-FR-INTR-UPC-ID       TO  PC013-FR-INTR-UPC-ID.    06690002
067700     MOVE IS001-TO-INTR-UPC-ID       TO  PC013-TO-INTR-UPC-ID.    06700002
067800     MOVE IS001-STR-NBR              TO  PC013-STR-NBR.           06710002
067900     MOVE IS001-IN-TRNST-UNT-ADJ-QTY TO PC013-IN-TRNST-UNT-ADJ-QTY06720002
068000     MOVE IS001-MDSE-ADJ-ID          TO  PC013-MDSE-ADJ-ID.       06730002
068100     MOVE IS001-ADJ-ACTN-CDE         TO  PC013-ADJ-ACTN-CDE.      06740002
068200     MOVE IS001-ADJ-TYP-CDE          TO  PC013-ADJ-TYP-CDE.       06750002
068300     MOVE IS001-FR-SKU-NBR           TO  PC013-FR-SKU-NBR.        06760002
068400     MOVE IS001-TO-SKU-NBR           TO  PC013-TO-SKU-NBR.        06770002
068500     MOVE IS001-FR-DEPT-NBR          TO  PC013-FR-DEPT-NBR.       06780002
068600     MOVE IS001-FR-MAJ-CL-NBR        TO  PC013-FR-MAJ-CL-NBR.     06790002
068700     MOVE IS001-FR-SUB-CL-NBR        TO  PC013-FR-SUB-CL-NBR      06800002
068800     MOVE IS001-OH-UNT-ADJ-QTY       TO  PC013-OH-UNT-ADJ-QTY.    06810002
068900     MOVE PE-MQ-MSG-DETAIL           TO  PC013-ERROR-DESCRIPTION. 06820002
068900     MOVE IS001-PO-NBR               TO  PC013-PO-NBR             06820002
068900     MOVE IS001-RCVR-SEQ-NBR         TO  PC013-RCVR-SEQ-NBR.      06820002
069000/                                                                 06830002
069100 7000-SELECT-TKRPRPM.                                             06840002
069200     MOVE 'N'                         TO PV-DEBUG-SW              06850002
069300     EXEC SQL                                                     06860002
069400         SELECT                                                   06870002
069500             FUNC_TXT                                             06880002
069600         ,   CURRENT TIMESTAMP                                    06890002
069700         INTO                                                     06900002
069800            :PV-DEBUG-SW                                          06910002
069900         ,  :PV-PARM-TIMESTAMP                                    06920002
070000         FROM TKRPRPM                                             06930002
070100         WHERE                                                    06940002
070200             LOC_ID = 90                                          06950002
070300         AND INTFC_SYS_CDE = 'KHL'                                06960002
070400         AND SYS_PRC_FUNC_CDE = 'PCMQAJ'                          06970009
070500     END-EXEC.                                                    06980002
070600                                                                  06990002
070700     EVALUATE TRUE                                                07000002
070800         WHEN SQLCODE = +0                                        07010002
070900             CONTINUE                                             07020002
071000         WHEN SQLCODE = +100                                      07030002
071100             MOVE 'N'                 TO PV-DEBUG-SW              07040002
071200         WHEN OTHER                                               07050002
071300             SET PS-ERROR TO TRUE                                 07060002
071400             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     07070002
071500             MOVE '7000-' TO PE-DB2-PARA                          07080002
071600             MOVE SQLCODE TO PE-DB2-SQLCODE                       07090002
071700             MOVE PE-DB2-ERROR-MESSAGE  TO PE-MQ-MSG-DETAIL       07100002
071800             PERFORM 5000-FORMAT-ERROR-MESSAGE                    07110002
071900             IF PS-ERROR-QUE-OPEN-YES                             10081011
072000                 PERFORM 8250-PUT-ON-ERROR-QUEUE                  07120002
072100                 PERFORM 8300-COMMIT-MESSAGE                      07130002
072200             END-IF                                                       
072300             PERFORM 7950-ROLLBACK-DB2                            07140002
072400     END-EVALUATE.                                                07150002
072500                                                                  07160002
072600 7010-DISPLAY-MSGS.                                               07170002
072700     IF PV-DEBUG-SW = 'Y'                                         07180002
072800         DISPLAY 'TABLE= ' IS001-RMS-TBL-NAME                     07190002
072900                           PV-PARM-TIMESTAMP                      07200002
073000     END-IF.                                                      07210002
073100/                                                                 07220002
073200******************************************************************07230002
073300* SELECT ROW FROM PCT_TRN_CLSN_BAL                                07240002
073400******************************************************************07250002
073500 7100-SELECT-INTRANSIT-HEADER.                                    07260002
073600                                                                  07270002
073700     IF PV-DEBUG-SW = 'Y'                                         07280002
073800         DISPLAY 'PCKUP012 - 7100-SELECT-INTRANSIT-HEADER'        07290002
073900     END-IF.                                                      07300002
074000                                                                  07310002
074100     EXEC SQL                                                     07320002
074200         SELECT  TRN_CLSN_QTY                                     07330002
074300           INTO :PCT00014-TRN-CLSN-QTY                            07340002
074400          FROM  PCT_TRN_CLSN_BAL                                  07350002
074500         WHERE INTR_UPC_ID = :PV-INTR-UPC-ID                      07360002
074600           AND LOC_NBR     = :PV-LOC-NBR                          07370002
074700           AND TRN_CLSN_CDE = 'SE'                                07740002
074800     END-EXEC.                                                    07380002
074900                                                                  07390002
075000      EVALUATE TRUE                                               07400002
075100         WHEN SQLCODE = ZERO                                      07410002
075200             SET PS-UPDATE-OLD-HEADER TO TRUE                     07420002
075300         WHEN SQLCODE = +100                                      07430002
075400             SET PS-ADD-NEW-HEADER TO TRUE                        07440002
075500         WHEN SQLCODE NOT = ZERO                                  07450002
075600             SET PS-ERROR TO TRUE                                 07460002
075700             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     07470002
075800             MOVE '7100-' TO PE-DB2-PARA                          07480002
075900             MOVE SQLCODE TO PE-DB2-SQLCODE                       07490002
076000             MOVE PE-DB2-ERROR-MESSAGE  TO PE-MQ-MSG-DETAIL       07500002
076100             PERFORM 5000-FORMAT-ERROR-MESSAGE                    07510002
076200             PERFORM 8250-PUT-ON-ERROR-QUEUE                      07520002
076300             PERFORM 8300-COMMIT-MESSAGE                          07530002
076400             PERFORM 7950-ROLLBACK-DB2                            07540002
076500                                                                  07550002
076600*            WRITE A ROW TO MESSAGE LOG TABLE AND COMMIT          07560002
076700*                  PERFORM 2410-UPDATE-MESSAGE-LOG                07570002
076800*                  PERFORM 7900-COMMIT-DB2                        07580002
076900     END-EVALUATE.                                                07590002
077000                                                                  07600002
077100******************************************************************07610002
077200* INSERT A ROW TO PCT_TRN_CLSN_BAL                                07620002
077300******************************************************************07630002
077400 7050-INSERT-INTRANSIT-HEADER.                                    07640002
077500                                                                  07650002
077600     IF PV-DEBUG-SW = 'Y'                                         07660002
077700         DISPLAY 'PCKUP012 - 7050-INSERT-INTRANSIT-HEADER'        07670002
077800     END-IF.                                                      07680002
077900                                                                  07690002
078000     EXEC SQL                                                     07700002
078100         INSERT INTO PCT_TRN_CLSN_BAL                             07710002
078200           ( INTR_UPC_ID                                          07720002
078300            ,LOC_NBR                                              07730002
078400            ,TRN_CLSN_CDE                                         07740002
078500            ,TRN_CLSN_QTY                                         07750002
078600            ,LAST_UPD_DTE                                         07760002
078700           )                                                      07770002
078800             VALUES                                               07780002
078900           (                                                      07790002
079000             :PV-INTR-UPC-ID                                      07800002
079100           , :PV-LOC-NBR                                          07810002
079200           , 'SE'                                                 07820002
079300           , :PV-IN-TRNST-QTY                                     07830002
079400           , CURRENT DATE                                         07840002
079500           )                                                      07850002
079600     END-EXEC.                                                    07860002
079700                                                                  07870002
079800     EVALUATE TRUE                                                07880002
079900         WHEN SQLCODE = ZERO                                      07890002
080000             ADD 1                    TO PA-HEADERS-INSERTED      07900002
080100         WHEN SQLCODE NOT = ZERO                                  07910002
080200             SET PS-ERROR TO TRUE                                 07920002
080300             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     07930002
080400             MOVE '7050-' TO PE-DB2-PARA                          07940002
080500             MOVE SQLCODE TO PE-DB2-SQLCODE                       07950002
080600             MOVE PE-DB2-ERROR-MESSAGE  TO PE-MQ-MSG-DETAIL       07960002
080700             PERFORM 5000-FORMAT-ERROR-MESSAGE                    07970002
080800             PERFORM 8250-PUT-ON-ERROR-QUEUE                      07980002
080900             PERFORM 8300-COMMIT-MESSAGE                          07990002
081000             PERFORM 7950-ROLLBACK-DB2                            08000002
081100                                                                  08010002
081200*            WRITE A ROW TO MESSAGE LOG TABLE AND COMMIT          08020002
081300*                  PERFORM 2410-UPDATE-MESSAGE-LOG                08030002
081400*                  PERFORM 7900-COMMIT-DB2                        08040002
081500     END-EVALUATE.                                                08050002
081600                                                                  08060002
081700******************************************************************08070002
081800* INSERT A ROW TO PCT_TRN_CLSN_DTL                                08080002
081900******************************************************************08090002
082000 7125-INSERT-INTRANSIT-TRANS.                                     08100010
082100                                                                  08110002
082200     MOVE IS001-PO-NBR                TO PCT00015-PO-NBR                  
082300     MOVE IS001-RCVR-SEQ-NBR          TO PCT00015-RCVR-SEQ-NBR            
082400                                                                          
082500     EXEC SQL                                                     08120002
082600         INSERT INTO PCT_TRN_CLSN_DTL                             08130002
082700           ( INTR_UPC_ID                                          08140002
082800            ,LOC_NBR                                              08150002
082900            ,TRN_CLSN_CDE                                         08160002
083000            ,IN_TRNST_TRN_TMST                                    08170002
083100            ,TRN_TYP_CDE                                          08180002
083200            ,TRN_CLSN_PRCG_QTY                                    08190002
083300            ,TRN_CLSN_BAL_QTY                                     08200002
083400            ,UPD_USR_ID                                           08210002
083500            ,OTBND_TRIP_ID                                        08220002
083600            ,PO_NBR                                               08230002
083700            ,RCVR_SEQ_NBR                                         08240002
083800           )                                                      08250002
083900             VALUES                                               08260002
084000           ( :PV-INTR-UPC-ID                                      08270002
084100           , :PV-LOC-NBR                                          08280002
084200           , 'SE'                                                 08290002
084300           , CURRENT TIMESTAMP                                    08300002
084400           , :IS001-ADJ-TYP-CDE                                   08310002
084500           , :PV-QTY-CHANGE                                       08320002
084600           , :PV-IN-TRNST-BAL-QTY                                 08330002
084700           , :PC-CURRENT-PROGRAM-NAME                             08340002
084800           , NULL                                                 08350002
084900           , :PCT00015-PO-NBR                                     08360002
085000           , :PCT00015-RCVR-SEQ-NBR                               08370002
085100           )                                                      08380002
085200     END-EXEC.                                                    08390002
085300                                                                  08400002
085400     EVALUATE TRUE                                                08410002
085500         WHEN SQLCODE = ZERO                                      08420002
085600             ADD 1                    TO PA-DETAILS-INSERTED      08430002
085700         WHEN SQLCODE < ZERO                                      08440002
085800             SET PS-ERROR TO TRUE                                 08450002
085900             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     08460002
086000             MOVE '7125-' TO PE-DB2-PARA                          08470010
086100             MOVE SQLCODE TO PE-DB2-SQLCODE                       08480002
086200             MOVE PE-DB2-ERROR-MESSAGE  TO PE-MQ-MSG-DETAIL       08490002
086300             PERFORM 5000-FORMAT-ERROR-MESSAGE                    08500002
086400             PERFORM 8250-PUT-ON-ERROR-QUEUE                      08510002
086500             PERFORM 8300-COMMIT-MESSAGE                          08520002
086600             PERFORM 7950-ROLLBACK-DB2                            08530002
086700                                                                  08540002
086800*            WRITE A ROW TO MESSAGE LOG TABLE AND COMMIT          08550002
086900*                  PERFORM 2410-UPDATE-MESSAGE-LOG                08560002
087000*                  PERFORM 7900-COMMIT-DB2                        08570002
087100     END-EVALUATE.                                                08580002
087200                                                                  08590002
087300******************************************************************08600002
087400* UPDATE A ROW IN PCT_TRN_CLSN_BAL                                08610002
087500******************************************************************08620002
087600 7150-UPDATE-INTRANSIT-HEADER.                                    08630002
087700                                                                  08640002
087800     EXEC SQL                                                     08650002
087900         UPDATE PCT_TRN_CLSN_BAL                                  08660002
088000               SET  TRN_CLSN_QTY = :PV-IN-TRNST-QTY               08670002
088100                 ,  LAST_UPD_DTE = CURRENT DATE                   08680002
088200             WHERE  INTR_UPC_ID  = :PV-INTR-UPC-ID                08690002
088300               AND  LOC_NBR      = :PV-LOC-NBR                    08700002
088400               AND  TRN_CLSN_CDE = 'SE'                           07740002
088500     END-EXEC.                                                    08710002
088600                                                                  08720002
088700     EVALUATE TRUE                                                08730002
088800         WHEN SQLCODE = ZERO                                      08740002
088900             ADD 1                    TO PA-HEADERS-UPDATED       08750002
089000         WHEN SQLCODE < ZERO                                      08760002
089100             SET PS-ERROR TO TRUE                                 08770002
089200             MOVE SPACES  TO PE-MQ-MSG-DETAIL                     08780002
089300             MOVE '7150-' TO PE-DB2-PARA                          08790002
089400             MOVE SQLCODE TO PE-DB2-SQLCODE                       08800002
089500             MOVE PE-DB2-ERROR-MESSAGE  TO PE-MQ-MSG-DETAIL       08810002
089600             PERFORM 5000-FORMAT-ERROR-MESSAGE                    08820002
089700             PERFORM 8250-PUT-ON-ERROR-QUEUE                      08830002
089800             PERFORM 8300-COMMIT-MESSAGE                          08840002
089900             PERFORM 7950-ROLLBACK-DB2                            08850002
090000                                                                  08860002
090100*            WRITE A ROW TO MESSAGE LOG TABLE AND COMMIT          08870002
090200*                  PERFORM 2410-UPDATE-MESSAGE-LOG                08880002
090300*                  PERFORM 7900-COMMIT-DB2                        08890002
090400     END-EVALUATE.                                                08900002
090500                                                                  08910002
090600 7900-COMMIT-DB2.                                                 08920002
090700                                                                  08930002
090800     IF PV-DEBUG-SW = 'Y'                                         08940002
090900         DISPLAY 'PCKUP012 - 7900-COMMIT-DB2'                     08950002
091000     END-IF.                                                      08960002
091100                                                                  08970002
091200     MOVE '7900-COMMIT-DB2' TO PV-PARAGRAPH-NAME.                 08990002
091300                                                                          
091400     IF PV-DEBUG-SW = 'Y'                                         08940002
091500         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        08980002
091600     END-IF.                                                      08960002
091700                                                                  09000002
091800     EXEC SQL                                                     09010002
091900          COMMIT                                                  09020002
092000     END-EXEC.                                                    09030002
092100                                                                  09040002
092200     EVALUATE TRUE                                                09050002
092300        WHEN SQLCODE = ZERO                                       09060002
092400             CONTINUE                                             09070002
092500        WHEN OTHER                                                09080002
092600             DISPLAY 'UNABLE TO COMMIT DATA'                      09090002
092700             PERFORM 8050-BACK-OUT-MQV-CHANGES                    09100002
092800             PERFORM 8030-DISCONNECT-QMGR                         09110002
092900             PERFORM 9100-SQL-ABEND-ROUTINE                       09120002
093000     END-EVALUATE.                                                09130002
093100                                                                  09140002
093200 7950-ROLLBACK-DB2.                                               09150002
093300                                                                  09160002
093400     IF PV-DEBUG-SW = 'Y'                                         09170002
093500         DISPLAY 'PCKUP012 - 7950-ROLLBACK-DB2'                   09180002
093600     END-IF.                                                      09190002
093700                                                                  09200002
093800     IF SQLCODE NOT = -911                                        09210002
093900         EXEC SQL                                                 09220002
094000              ROLLBACK                                            09230002
094100         END-EXEC                                                 09240002
094200     END-IF.                                                      09250002
094300/                                                                 09260002
094400 8000-CONNECT-TO-QMGR.                                            09270002
094500                                                                  09280002
094600     MOVE '8000-CONNECT-TO-QMGR'       TO PV-PARAGRAPH-NAME.      09290002
094700                                                                  09300002
094800     CALL MQV-MQCONN USING CC-QUEUE-MANAGER-NAME                  09310002
094900                           MQV-HCONN                              09320002
095000                           MQV-COMPLETION-CODE                    09330002
095100                           MQV-REASON.                            09340002
095200                                                                  09350002
095300     EVALUATE TRUE                                                09360002
095400        WHEN MQV-COMPLETION-CODE = MQCC-OK                        09370002
095500             DISPLAY 'SUCCESSFULLY CONNECTED TO: '                09380002
095600                                            CC-QUEUE-MANAGER-NAME 09390002
095700        WHEN OTHER                                                09400002
095800             DISPLAY 'UNSUCCESSFUL CONNECT TO: '                  09410008
095900                                            CC-QUEUE-MANAGER-NAME 09420008
096000             CALL MQV-MQCHECK USING MQV-REASON                    09430002
096100                                    MQV-REASON-TEXT               09440002
096200             DISPLAY 'QUEUE CONNECTING TO ' CC-QUEUE-MANAGER-NAME 09450002
096300             MOVE 'UNABLE TO CONNECT'  TO PV-OPERATION-MSG-1      09460002
096400             PERFORM 9000-MQ-ABEND                                09470002
096500     END-EVALUATE.                                                09480002
096600                                                                  09490002
096700 8010-OPEN-LOCATION-QUEUE.                                        09500002
096800                                                                  09510002
096900     MOVE '8010-OPEN-LOCATION-QUEUE' TO PV-PARAGRAPH-NAME.        09520002
097000                                                                  09530002
097100     MOVE CC-LOCATION-QUEUE-NAME TO MQOD-OBJECTNAME               09540002
097200     MOVE CC-QUEUE-MANAGER-NAME    TO MQOD-OBJECTQMGRNAME.        09550002
097300                                                                  09560002
097400                                                                  09570002
097500* MQOPEN COMPUTE LINE USE FOR NON-DESTRUCTIVE READ **             09580002
097600*    COMPUTE MQV-OPEN-OPTIONS      = MQOO-BROWSE +                09590002
097700                                                                  09600002
097800** THIS COMPUTE LINE USE FOR DESTRUCTIVE READ **                  09610002
097900     COMPUTE MQV-OPEN-OPTIONS      = MQOO-INPUT-SHARED            09620002
098000                                   + MQOO-OUTPUT                  09630002
098100                                   + MQOO-FAIL-IF-QUIESCING.      09640002
098200                                                                  09650002
098300     CALL MQV-MQOPEN USING MQV-HCONN                              09660002
098400                           MQM-OBJECT-DESCRIPTOR                  09670002
098500                           MQV-OPEN-OPTIONS                       09680002
098600                           MQV-LOC-HANDLE1                        09690002
098700                           MQV-COMPLETION-CODE                    09700002
098800                           MQV-REASON.                            09710002
098900                                                                  09720002
099000     EVALUATE TRUE                                                09730002
099100        WHEN MQV-COMPLETION-CODE = MQCC-OK                        09740002
099200             DISPLAY 'SUCCESSFULLY OPENED QUEUE: '                09750002
099300                                        CC-LOCATION-QUEUE-NAME    09760002
099400        WHEN OTHER                                                09770002
099500             CALL MQV-MQCHECK USING MQV-REASON                    09780002
099600                                   MQV-REASON-TEXT                09790002
099700             DISPLAY 'CANNOT OPEN QUEUE ' CC-LOCATION-QUEUE-NAME  09800002
099800             MOVE 'CANNOT OPEN QUEUE'  TO PV-OPERATION-MSG-1      09810002
099900             PERFORM 8030-DISCONNECT-QMGR                         09820002
100000             PERFORM 9000-MQ-ABEND                                09830002
100100     END-EVALUATE.                                                09840002
100200                                                                  09850002
100300 8020-OPEN-ERROR-QUEUE.                                           09860002
100400                                                                  09870002
100500     MOVE '8020-OPEN-ERROR-QUEUE' TO PV-PARAGRAPH-NAME.           09880002
100600                                                                  09890002
100700     MOVE CC-LOC-ERROR-QUEUE-NAME  TO MQOD-OBJECTNAME.            09900002
100800     MOVE CC-QUEUE-MANAGER-NAME    TO MQOD-OBJECTQMGRNAME.        09910002
100900                                                                  09920002
101000     COMPUTE MQV-OPEN-OPTIONS      = MQOO-BROWSE +                09930002
101100                                     MQOO-OUTPUT +                09940002
101200*                                    MQOO-INPUT-SHARED +          09950002
101300                                     MQOO-FAIL-IF-QUIESCING.      09960002
101400                                                                  09970002
101500     CALL MQV-MQOPEN USING MQV-HCONN                              09980002
101600                           MQM-OBJECT-DESCRIPTOR                  09990002
101700                           MQV-OPEN-OPTIONS                       10000002
101800                           MQV-LOC-HANDLE2                        10010002
101900                           MQV-COMPLETION-CODE                    10020002
102000                           MQV-REASON.                            10030002
102100                                                                  10040002
102200     EVALUATE TRUE                                                10050002
102300        WHEN MQV-COMPLETION-CODE = MQCC-OK                        10060002
102400             DISPLAY 'SUCCESSFULLY OPENED QUEUE: '                10070002
102500                                 CC-LOC-ERROR-QUEUE-NAME          10080002
102600             SET PS-ERROR-QUE-OPEN-YES TO TRUE                    10081011
102700        WHEN OTHER                                                10090002
102800             CALL MQV-MQCHECK USING MQV-REASON                    10100002
102900                                   MQV-REASON-TEXT                10110002
103000             DISPLAY 'CANNOT OPEN QUEUE '                         10120002
103100                                   CC-LOC-ERROR-QUEUE-NAME        10130002
103200             MOVE 'CANNOT OPEN QUEUE'  TO PV-OPERATION-MSG-1      10140002
103300             PERFORM 8030-DISCONNECT-QMGR                         10150002
103400             PERFORM 9000-MQ-ABEND                                10160002
103500     END-EVALUATE.                                                10170002
103600                                                                  10180002
103700 8030-DISCONNECT-QMGR.                                            10190002
103800                                                                  10200002
103900     IF PV-DEBUG-SW = 'Y'                                         10210002
104000         DISPLAY 'PCKUP012 - 8030-DISCONNECT-QMGR'                10220002
104100     END-IF.                                                      10230002
104200                                                                  10240002
104300     CALL MQV-MQDISC USING MQV-HCONN                              10250002
104400                           MQV-COMPLETION-CODE                    10260002
104500                           MQV-REASON.                            10270002
104600                                                                  10280002
104700     EVALUATE TRUE                                                10290002
104800        WHEN MQV-COMPLETION-CODE = MQCC-OK                        10300002
104900             CONTINUE                                             10310002
105000        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                10320002
105100             CALL MQV-MQCHECK USING MQV-REASON                    10330002
105200                                    MQV-REASON-TEXT               10340002
105300             MOVE 'MQDISC ERROR'       TO PV-OPERATION-MSG-1      10350002
105400             PERFORM 9000-MQ-ABEND                                10360002
105500     END-EVALUATE.                                                10370002
105600                                                                  10380002
105700 8100-GET-MESSAGE.                                                10390002
105800     IF PV-DEBUG-SW = 'Y'                                         10400002
105900         DISPLAY '##############################'                 10410002
106000         DISPLAY 'PCKUP012 - 8100-GET-MESSAGE'                    10420002
106100     END-IF.                                                      10430002
106200                                                                  10440002
106300     MOVE '8100-GET-MESSAGE' TO PV-PARAGRAPH-NAME.                10450002
106400                                                                  10460002
106500     INITIALIZE MQV-MSGBUFFER                                     10470002
106600                MQV-ERRMSGBUF                                     10480002
106700                MQV-MSG.                                          10490002
106800                                                                  10500002
106900     MOVE MQMI-NONE            TO MQMD-MSGID.                     10510002
107000     MOVE MQCI-NONE            TO MQMD-CORRELID.                  10520002
107100     MOVE MQFMT-STRING         TO MQMD-FORMAT.                    10530002
107200                                                                  10540002
107300*** THE UNLIMITED WAIT INTERVAL MEANS THAT PROCESSING WILL        10550002
107400*** CONTINUE UNTIL A END-OF-RUN MESSAGE APPEARS ON THE Q.         10560002
107500     MOVE MQWI-UNLIMITED       TO MQGMO-WAITINTERVAL.             10570004
107600                                                                  10580002
107700*    30 SECONDS                                                   10590002
107800*    MOVE 30000                TO MQGMO-WAITINTERVAL.             10600004
107900                                                                  10610002
108000     MOVE LENGTH OF IS001-MERCH-ADJUST-RECORD                     10620002
108100                                  TO MQV-MSG-LENGTH               10630002
108200                                                                  10640002
108300     COMPUTE MQGMO-OPTIONS  =  MQGMO-WAIT +                       10650002
108400                               MQGMO-SYNCPOINT +                  10660002
108500                               MQGMO-CONVERT   +                  10670002
108600                               MQGMO-FAIL-IF-QUIESCING.           10680002
108700                                                                  10690002
108800     CALL MQV-MQGET USING MQV-HCONN                               10700002
108900                          MQV-LOC-HANDLE1                         10710002
109000                          MQM-MESSAGE-DESCRIPTOR                  10720002
109100                          MQM-GET-MESSAGE-OPTIONS                 10730002
109200                          MQV-MSG-LENGTH                          10740002
109300                          MQV-MSGBUFFER                           10750002
109400                          MQV-DATA-LENGTH                         10760002
109500                          MQV-COMPLETION-CODE                     10770002
109600                          MQV-REASON.                             10780002
109700                                                                  10790002
109800                                                                  10800002
109900     IF  MQV-COMPLETION-CODE = MQCC-OK                            10810002
110000         ADD +1                TO PA-MESSAGE-FROM-QUEUE           10820002
110100         INITIALIZE IS001-MERCH-ADJUST-RECORD                     10830002
110200         MOVE MQV-MSGBUFFER    TO IS001-MERCH-ADJUST-RECORD       10840002
110300         IF PV-DEBUG-SW = 'Y'                                     08940002
110400             DISPLAY IS001-MERCH-ADJUST-RECORD                    10850002
110500         END-IF                                                           
110600                                                                  10860002
110700*        POPULATE CORRELID FIELD                                  10870002
110800*        MOVE XL011-ORDER-NBR  TO PV-PO-NBR-TO-GET                10880002
110900                                                                  10890002
111000         MOVE MQV-MSGBUFFER    TO PV-MSG                          10900002
111100                                                                  10910002
111200         PERFORM 7000-SELECT-TKRPRPM                              10920002
111300         PERFORM 7010-DISPLAY-MSGS                                10930002
111400                                                                  10940002
111500         PERFORM 8110-LOG-MESSAGE                                 10950002
111600                                                                  10960002
111700         PERFORM 7900-COMMIT-DB2                                  10970002
111800         PERFORM 8300-COMMIT-MESSAGE                              10980002
111900                                                                  10990002
112000     ELSE                                                         11000002
112100         EVALUATE TRUE                                            11010002
112200             WHEN MQV-REASON = MQRC-NO-MSG-AVAILABLE              11020002
112300                 SET PS-PROCESS-COMPLETE-YES TO TRUE              11030002
112400         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        11040002
112500             WHEN OTHER                                           11050002
112600                 CALL MQV-MQCHECK USING MQV-REASON                11060002
112700                                   MQV-REASON-TEXT                11070002
112800                 MOVE 'ERROR RETRIEVING MESSAGE'                  11080002
112900                                TO PV-OPERATION-MSG-1             11090002
113000                 PERFORM 8050-BACK-OUT-MQV-CHANGES                11100002
113100                 PERFORM 8030-DISCONNECT-QMGR                     11110002
113200                 PERFORM 9000-MQ-ABEND                            11120002
113300         END-EVALUATE                                             11130002
113400     END-IF.                                                      11140002
113500                                                                  11150002
113600*** THE END OF PROGRAM MSG WILL SHUT DOWN THE STARTED TASK        11160002
113800                                                                  11180002
113900     IF PV-END-RUN-MSG                                            11190002
114000         DISPLAY ' END RUN MSG'                                   11200002
114100         ADD +1      TO PA-END-OF-RUN-MESSAGES                    11210002
114200         SUBTRACT 1 FROM PA-MESSAGE-FROM-QUEUE                    11220002
114300         SET PS-PROCESS-COMPLETE-YES  TO TRUE                     11230002
114400         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        11240002
114600     END-IF.                                                      11260002
114700                                                                  11270002
114800*** THE STOP SUBSCRIBING MESSAGE WILL SHUT DOWN                   11280002
114900*** THE STARTED TASK WITH A ZERO RETURN CODE                      11290002
115000*    IF PV-STOP-SUB-MSG                                           11300002
115100*        DISPLAY ' STOP SUB MSG'                                  11310002
115200*        ADD +1      TO PA-STOP-PROC-MESSAGES                     11320002
115300*        SUBTRACT 1 FROM PA-MESSAGE-FROM-QUEUE                    11330002
115400*        SET PS-PROCESS-COMPLETE-YES  TO TRUE                     11340002
115500*    END-IF.                                                      11350002
115600/                                                                 11360002
115700 8110-LOG-MESSAGE.                                                11370002
115800                                                                  11380002
115900     IF PV-DEBUG-SW = 'Y'                                         11390002
116000         DISPLAY 'PCKUP012 - 8110-LOG-MESSAGE'                    11400002
116100     END-IF.                                                      11410002
116200                                                                  11420002
116300     INITIALIZE PC014-MESSAGE-LOG-RECORD.                         11430002
116400                                                                  11440002
116500     SET PC014-LOG-MESSAGE            TO TRUE                     11450002
116600     EXEC SQL                                                     11460002
116700         SET :PC014-BEG-TIMESTAMP = CURRENT TIMESTAMP             11470002
116800     END-EXEC                                                     11480002
116900     MOVE IS001-MERCH-ADJUST-RECORD   TO PC014-ISRD001-DATA       11490002
117000                                                                  11500002
117100     MOVE LENGTH OF PC014-MESSAGE-LOG-RECORD                      11510002
117200                                      TO MQV-MSG-LENGTH           11520002
117300                                                                  11530002
117400     MOVE CC-LOC-ERROR-QUEUE-NAME     TO MQOD-OBJECTNAME.         11540002
117500     MOVE CC-QUEUE-MANAGER-NAME       TO MQOD-OBJECTQMGRNAME.     11550002
117600                                                                  11560002
117700     IF PV-END-RUN-MSG                                            11570005
117800         MOVE 'END'                   TO MQMD-CORRELID            11580005
117900         SET PC014-END-MESSAGE        TO TRUE                     11590006
118000     ELSE                                                         11600005
118100         MOVE 'LOG'                   TO MQMD-CORRELID            11610005
118200         SET PC014-LOG-MESSAGE        TO TRUE                     11620006
118300     END-IF                                                       11630005
118400                                                                  11640003
118500     COMPUTE MQPMO-OPTIONS = MQPMO-NONE                           11650002
118600                           + MQPMO-FAIL-IF-QUIESCING.             11660002
118700                                                                  11670002
118800     MOVE LOW-VALUES                  TO MQV-ERRMSGBUF            11680002
118900     MOVE PC014-MESSAGE-LOG-RECORD    TO MQV-ERRMSGBUF            11690002
119000                                                                  11700002
119100     CALL MQV-MQPUT USING MQV-HCONN                               11710002
119200                          MQV-LOC-HANDLE2                         11720002
119300                          MQM-MESSAGE-DESCRIPTOR                  11730002
119400                          MQM-PUT-MESSAGE-OPTIONS                 11740002
119500                          MQV-MSG-LENGTH                          11750002
119600                          MQV-ERRMSGBUF                           11760002
119700                          MQV-COMPLETION-CODE                     11770002
119800                          MQV-REASON.                             11780002
119900                                                                  11790002
120000     EVALUATE TRUE                                                11800002
120100        WHEN MQV-COMPLETION-CODE = MQCC-OK                        11810002
120200             ADD +1                 TO PA-MESSAGES-WRITTEN-TO-BKUP11820002
120300             PERFORM 8300-COMMIT-MESSAGE                          11830002
120400        WHEN OTHER                                                11840002
120500             DISPLAY 'UNABLE TO WRITE TO LOG QUEUE'               11850002
120600             CALL MQV-MQCHECK USING MQV-REASON                    11860002
120700                                    MQV-REASON-TEXT               11870002
120800             MOVE 'MQPUT ERROR'      TO PV-OPERATION-MSG-1        11880002
120900             PERFORM 8030-DISCONNECT-QMGR                         11890002
121000             PERFORM 9000-MQ-ABEND                                11900002
121100     END-EVALUATE.                                                11910002
121200/                                                                 11920002
121300 8050-BACK-OUT-MQV-CHANGES.                                       11930002
121400                                                                  11940002
121500     IF PV-DEBUG-SW = 'Y'                                         11950002
121600         DISPLAY 'PCKUP012 - 8050-BACK-OUT-MQV-CHANGES'           11960002
121700     END-IF.                                                      11970002
121800                                                                  11980002
121900     CALL MQV-MQBACK USING MQV-HCONN                              11990002
122000                           MQV-COMPLETION-CODE                    12000002
122100                           MQV-REASON.                            12010002
122200                                                                  12020002
122300     EVALUATE TRUE                                                12030002
122400        WHEN MQV-COMPLETION-CODE = MQCC-OK                        12040002
122500             CONTINUE                                             12050002
122600        WHEN OTHER                                                12060002
122700             CALL MQV-MQCHECK USING MQV-REASON                    12070002
122800                                    MQV-REASON-TEXT               12080002
122900             MOVE 'MQBACK ERROR'  TO PV-OPERATION-MSG-1           12090002
123000             PERFORM 8030-DISCONNECT-QMGR                         12100002
123100             PERFORM 9000-MQ-ABEND                                12110002
123200     END-EVALUATE.                                                12120002
123300/                                                                 12130002
123400 8150-CLOSE-MSG-QUEUE.                                            12140002
123500                                                                  12150002
123600     CALL MQV-MQCLOSE USING MQV-HCONN                             12160002
123700                            MQV-LOC-HANDLE1                       12170002
123800                            MQCO-NONE                             12180002
123900                            MQV-COMPLETION-CODE                   12190002
124000                            MQV-REASON.                           12200002
124100                                                                  12210002
124200     EVALUATE TRUE                                                12220002
124300        WHEN MQV-COMPLETION-CODE = MQCC-OK                        12230002
124400             CONTINUE                                             12240002
124500        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                12250002
124600             CALL MQV-MQCHECK USING MQV-REASON                    12260002
124700                                    MQV-REASON-TEXT               12270002
124800             MOVE 'CANNOT CLOSE MSG QUEUE' TO PV-OPERATION-MSG-1  12280002
124900             PERFORM 8030-DISCONNECT-QMGR                         12290002
125000             PERFORM 9000-MQ-ABEND                                12300002
125100     END-EVALUATE.                                                12310002
125200                                                                  12320002
125300 8200-CLOSE-ERR-QUEUE.                                            12330002
125400                                                                  12340002
125500     CALL MQV-MQCLOSE USING MQV-HCONN                             12350002
125600                            MQV-LOC-HANDLE2                       12360002
125700                            MQCO-NONE                             12370002
125800                            MQV-COMPLETION-CODE                   12380002
125900                            MQV-REASON.                           12390002
126000                                                                  12400002
126100     EVALUATE TRUE                                                12410002
126200        WHEN MQV-COMPLETION-CODE = MQCC-OK                        12420002
126300             CONTINUE                                             12430002
126400        WHEN MQV-COMPLETION-CODE NOT EQUAL MQCC-OK                12440002
126500             CALL MQV-MQCHECK USING MQV-REASON                    12450002
126600                                    MQV-REASON-TEXT               12460002
126700             MOVE 'CANNOT CLOSE ERR QUEUE' TO PV-OPERATION-MSG-1  12470002
126800             PERFORM 8030-DISCONNECT-QMGR                         12480002
126900             PERFORM 9000-MQ-ABEND                                12490002
127000     END-EVALUATE.                                                12500002
127100                                                                  12510002
127200******************************************************************12520002
127300*   THIS PARAGRAPH WILL PERFORM THE FOLLOWING FUNCTIONS -        *12530002
127400*   OPENS ERROR QUEUE, PUTS MESSAGE TO ERROR QUEUE AND           *12540002
127500*   CLOSES THE ERROR QUEUE.                                      *12550002
127600******************************************************************12560002
127700 8250-PUT-ON-ERROR-QUEUE.                                         12570002
127800                                                                  12580002
127900     IF PV-DEBUG-SW = 'Y'                                         12590002
128000         DISPLAY 'PCKUP012 - 8250-PUT-ON-ERROR-QUEUE'             12600002
128100     END-IF.                                                      12610002
128200                                                                  12620002
128300                                                                  12630002
128400     MOVE CC-LOC-ERROR-QUEUE-NAME TO MQOD-OBJECTNAME.             12640002
128500     MOVE CC-QUEUE-MANAGER-NAME   TO MQOD-OBJECTQMGRNAME.         12650002
128600                                                                  12660002
128700     COMPUTE MQPMO-OPTIONS = MQPMO-NONE                           12670002
128800                           + MQPMO-FAIL-IF-QUIESCING.             12680002
128900                                                                  12690002
129000     MOVE LOW-VALUES                  TO MQV-ERRMSGBUF            12700002
129100     MOVE LENGTH OF PC013-IT-ERROR-RECORD                         12710002
129200                                      TO MQV-MSG-LENGTH           12720002
129300     MOVE PC013-IT-ERROR-RECORD       TO MQV-ERRMSGBUF            12730002
129400     MOVE 'ERR'                       TO MQMD-CORRELID            12740003
129500                                                                  12750002
129600     CALL MQV-MQPUT USING MQV-HCONN                               12760002
129700                          MQV-LOC-HANDLE2                         12770002
129800                          MQM-MESSAGE-DESCRIPTOR                  12780002
129900                          MQM-PUT-MESSAGE-OPTIONS                 12790002
130000                          MQV-MSG-LENGTH                          12800002
130100                          MQV-ERRMSGBUF                           12810002
130200                          MQV-COMPLETION-CODE                     12820002
130300                          MQV-REASON.                             12830002
130400                                                                  12840002
130500     EVALUATE TRUE                                                12850002
130600        WHEN MQV-COMPLETION-CODE = MQCC-OK                        12860002
130700             ADD +1                 TO PA-MESSAGES-TO-ERROR-QUEUE 12870002
130800        WHEN OTHER                                                12880002
130900             DISPLAY 'UNABLE TO WRITE TO LOC ERROR QUEUE'         12890002
131000             CALL MQV-MQCHECK USING MQV-REASON                    12900002
131100                                    MQV-REASON-TEXT               12910002
131200             MOVE 'MQPUT ERROR'      TO PV-OPERATION-MSG-1        12920002
131300             PERFORM 8030-DISCONNECT-QMGR                         12930002
131400             PERFORM 9000-MQ-ABEND                                12940002
131500     END-EVALUATE.                                                12950002
131600                                                                  12960002
131700 8300-COMMIT-MESSAGE.                                             12970002
131800                                                                  12980002
131900     IF PV-DEBUG-SW = 'Y'                                         12990002
132000         DISPLAY 'PCKUP012 - 8300-COMMIT-MESSAGE'                 13000002
132100     END-IF.                                                      13010002
132200                                                                  13020002
132300     IF PV-DEBUG-SW = 'Y'                                         08940002
132400         DISPLAY ' PROCESS-COMPLETE = ' PS-PROCESS-COMP-SW        13030002
132500     END-IF                                                               
132600                                                                          
132700     MOVE '8300-COMMIT-MESSAGE'          TO PV-PARAGRAPH-NAME.    13040002
132800                                                                  13050002
132900     CALL MQV-MQCMIT USING MQV-HCONN                              13060002
133000                           MQV-COMPLETION-CODE                    13070002
133100                           MQV-REASON.                            13080002
133200                                                                  13090002
133300     EVALUATE TRUE                                                13100002
133400        WHEN MQV-COMPLETION-CODE = MQCC-OK                        13110002
133500             CONTINUE                                             13120002
133600        WHEN OTHER                                                13130002
133700             CALL MQV-MQCHECK USING MQV-REASON                    13140002
133800                                    MQV-REASON-TEXT               13150002
133900             MOVE 'ERROR COMMITING DATA' TO PV-OPERATION-MSG-1    13160002
134000             PERFORM 8050-BACK-OUT-MQV-CHANGES                    13170002
134100             PERFORM 8030-DISCONNECT-QMGR                         13180002
134200             PERFORM 9000-MQ-ABEND                                13190002
134300     END-EVALUATE.                                                13200002
134400                                                                  13210002
134500/                                                                 13220002
134600 8900-READ-CONTROL-CARD-1.                                        13230002
134700                                                                  13240002
134800     READ CONTROL-CARD-1                                          13250002
134900         INTO CC-CONTROL-CARD-1-LAYOUT                            13260002
135000     END-READ.                                                    13270002
135100                                                                  13280002
135200 8910-READ-CONTROL-CARD-2.                                        13290002
135300                                                                  13300002
135400     READ CONTROL-CARD-2                                          13310002
135500         INTO CC-CONTROL-CARD-2-LAYOUT                            13320002
135600     END-READ.                                                    13330002
135700                                                                  13340002
135800 8920-READ-CONTROL-CARD-3.                                        13350002
135900                                                                  13360002
136000     READ CONTROL-CARD-3                                          13370002
136100         INTO CC-CONTROL-CARD-3-LAYOUT                            13380002
136200     END-READ.                                                    13390002
136300/                                                                 13400002
136400 9000-MQ-ABEND.                                                   13410002
136500                                                                  13420002
136600     MOVE +4020 TO ABEND-CODE.                                    13430002
136700                                                                  13440002
136800     DISPLAY '**** ABEND *************************************'.  13450002
136900     DISPLAY '** MQSERIES ERROR **'.                              13460002
137000     DISPLAY '** PROGRAM:    ' PC-CURRENT-PROGRAM-NAME.           13470002
137100     DISPLAY '** ABEND CODE: ' ABEND-CODE.                        13480002
137200     DISPLAY '** PARAGRAPH:  ' PV-PARAGRAPH-NAME.                 13490002
137300     DISPLAY '** MESSAGE:    ' PV-OPERATION-MSG-1.                13500002
137400     DISPLAY '** COMP CODE:  ' MQV-COMPLETION-CODE.               13510002
137500     DISPLAY '** RSN CODE:   ' MQV-REASON.                        13520002
137600     DISPLAY '** RSN TEXT:   ' MQV-REASON-TEXT.                   13530002
137700     DISPLAY '************************************************'.  13540002
137800     CALL 'ILBOABN0' USING ABEND-CODE.                            13550002
137900/                                                                 13560002
138000 9100-SQL-ABEND-ROUTINE.                                          13570002
138100                                                                  13580002
138200     COPY DPPD004.                                                13590002
138300     SET ABEND-4013-DB2-ERROR TO TRUE.                            13600002
138400     CALL 'ILBOABN0' USING ABEND-CODE.                            13610002
138500/                                                                 13620002
138600 9900-WRAPUP.                                                     13630002
138700*END OF PROGRAM ROUTINE                                           13640002
138800                                                                  13650002
138900     PERFORM 8150-CLOSE-MSG-QUEUE.                                13660002
139000     PERFORM 8200-CLOSE-ERR-QUEUE.                                13670002
139100     PERFORM 8030-DISCONNECT-QMGR.                                13680002
139200                                                                  13690002
139300     CLOSE CONTROL-CARD-1                                         13700002
139400           CONTROL-CARD-2                                         13710002
139500           CONTROL-CARD-3                                         13720002
139600                                                                  13730002
139700     PERFORM 9910-DISPLAY-STATISTICS.                             13740002
139800                                                                  13750002
139900     IF PA-MESSAGES-TO-ERROR-QUEUE > 0                            13760002
140000         SET ABEND-4095-NOTIFY TO TRUE                            13770002
140100         MOVE ABEND-CODE TO RETURN-CODE                           13780002
140200     END-IF.                                                      13790002
140300/                                                                 13800002
140400 9910-DISPLAY-STATISTICS.                                         13810002
140500                                                                  13820002
140600     DISPLAY '*********************************************'.     13830002
140700     DISPLAY 'PROGRAM NAME: ' PC-CURRENT-PROGRAM-NAME.            13840002
140800     DISPLAY '*********************************************'.     13850002
140900                                                                  13860002
141000     MOVE PA-MESSAGE-FROM-QUEUE       TO PV-DISP-NBR              13870002
141100     DISPLAY 'MESSAGES FROM QUEUE:             ' PV-DISP-NBR      13880002
141200                                                                  13890002
141300     MOVE PA-MESSAGES-WRITTEN-TO-BKUP TO PV-DISP-NBR              13900002
141400     DISPLAY 'MESSAGES WRITTEN TO BKUP:        ' PV-DISP-NBR      13910002
141500                                                                  13920002
141600     MOVE PA-MESSAGES-TO-ERROR-QUEUE  TO PV-DISP-NBR              13930002
141700     DISPLAY 'MESSAGES WRITTEN TO ERROR QUEUE: ' PV-DISP-NBR.     13940002
141800                                                                  13950002
141900     MOVE PA-END-OF-RUN-MESSAGES      TO PV-DISP-NBR              13960002
142000     DISPLAY 'END OF RUN MESSAGES            : ' PV-DISP-NBR.     13970002
142100                                                                  13980002
142200     MOVE PA-HEADERS-INSERTED         TO PV-DISP-NBR              13990002
142300     DISPLAY 'HEADERS INSERTED               : ' PV-DISP-NBR.     14000002
142400                                                                  14010002
142500     MOVE PA-HEADERS-UPDATED          TO PV-DISP-NBR              14020002
142600     DISPLAY 'HEADERS UPDATED                : ' PV-DISP-NBR.     14030002
142700                                                                  14040002
142800     MOVE PA-DETAILS-INSERTED         TO PV-DISP-NBR              14050002
142900     DISPLAY 'DETAILS INSERTED               : ' PV-DISP-NBR.     14060002
143000/                                                                 14070002
143100                                                                  14080002
143200                                                                  14090002
143300                                                                  14100002
143400*   ERROR NOTIFICATIONS                                           14110002
143500**** IF CLOSE FAILS DISPLAY SYSTEM ERROR MESSAGE AND              14120002
143600**** EXIT.  THE OPERATOR WILL BE EXPECTED TO CONTACT THE          14130002
143700**** IN-TRANSIT PRIMARY ON-CALL.                                  14140002
143800*    IF (PV-COMPLETION-CODE = MQCC-OK)                            14150002
143900*       CONTINUE                                                  14160002
144000*    ELSE                                                         14170002
144100*       MOVE 'MQCLOSE' TO PE-MQ-CALL-TYPE                         14180002
144200*       MOVE PV-COMPLETION-CODE TO PV-DISPLAY-COMP-CODE           14190002
144300*       MOVE PV-DISPLAY-COMP-CODE TO PE-MQ-COMPLETION-CODE        14200002
144400*       MOVE PV-REASON TO PV-DISPLAY-REASON                       14210002
144500*       MOVE PV-DISPLAY-REASON TO PE-MQ-REASON-CODE               14220002
144600*       PERFORM 9000-WRITE-MSG-TO-CONSOLE                         14230002
144700*       PERFORM 4900-DISCONNECT-FROM-Q-MNGR                       14240002
144800*       PERFORM 9999-RETURN-TO-NATIVE-CICS                        14250002
