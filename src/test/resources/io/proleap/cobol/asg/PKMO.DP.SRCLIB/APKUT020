000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.     APKUT020.                                        00020000
000300 AUTHOR.         MARY KING.                                       00030000
000400 DATE-WRITTEN.   01/30/1996.                                      00040000
000500 DATE-COMPILED.                                                   00050000
000600****************************************************************  00060014
000700* COBOL 2 WITH SQL                                             *  00070014
000710*--------------------------------------------------------------*  00071014
000800*    --- INVOICE EXTRACT FOR BATCH MATCH PROCESSING ---        *  00080014
000900*                                                              *  00090014
001000* THIS PROGRAM RETRIEVES INVOICE INFORMATION TO BE USED IN THE *  00100014
001100* BATCH MATCH PROCESS.  A FILE OF INVOICE DATA WILL BE         *  00110014
001200* PRODUCED FOR INVOICES THAT ARE CANDIDATES FOR THE BATCH      *  00120014
001300* MATCH PROCESS.  POS WITH IDENTIFIABLE ERRORS WILL BE WRITTEN *  00130014
001400* TO AN ERROR FILE. IMPORT INVOICES GOING TO REPORTING WILL BE *  00140014
001500* WRITTEN TO THE NEW IMPORT EXTRACT FILE.  ALSO, ALL EXPENSE   *  00150014
001600* INVOICES ASSOCIATED WITH THE SAME PO WILL BE WRITTEN TO THE  *  00160014
001700* IMPORT FILE.                                                 *  00170014
001800*--------------------------------------------------------------*  00180014
001900* INPUT:                                                       *  00190014
002000*  1. INVOICE TABLE                          (TINVOIC)         *  00200014
002100*  2. MERCHANDISE INVOICE TABLE              (TMDINVC)         *  00210014
002200*  3. PURCHASE ORDER AGREEMENT TABLE         (TPOAGMT)         *  00220014
002300*  4. PAYMENT TERMS TABLE                    (TPAYTRM)         *  00230014
002400*  5. INVOICE TERMS TABLE                    (TINVCTM)         *  00240014
002500*  6. PURCHASE TABLE                         (TPURCHS)         *  00250014
002600*  7. EXTERNAL ENTERPRISE NAME               (TENTNME)         *  00260014
002700*  8. EXTERNAL ENTERPRISE                    (TEXTENT)         *  00270014
002800*  9. RELEASED PO/STORES                     (TPOSTRR)         *  00280014
002900* 10. ALLOWANCE/CHARGE TABLE                 (TALCHRG)         *  00290014
003000*                                                              *  00300014
003100* OUTPUT:                                                      *  00310014
003200*  1. BATCH MATCH INVOICE EXTRACT FILE       (APRD060)         *  00320017
003400*  2. IMPORT EXTRACT FILE                    (APRD060)         *  00340017
003600*  3. INVOICE ERROR EXCEPTION FILE           (APRD059)         *  00360017
003700*                                                              *  00370014
003800****************************************************************  00380014
004000* CHANGE LOG:                                                   * 00400000
004100*  9/11/96 - POPULATE A NEW FIELD, ENT-ID, ON THE APRD060       * 00410000
004200*            COPYBOOK IN PARAGRAPH D100; FOR DUE DATE CONTROL   * 00420000
004300*            DAYS BY VENDOR.  ADDED END-ID TO SELECT IN R500-   * 00430000
004400*        BY: PDVOLK                                 WR 4074     * 00440000
004500*                                                               * 00450000
004600* 12/04/96 - AUTOMATIC WRITEOFF OF UNJOURNALIZED RECPS AND NIR  * 00460000
004700*            ADD INVOICE TYPE CODE OF 'WO' TO INVOICE CURSOR    * 00470000
004800*        BY: PDVOLK                                 WR 3803     * 00480000
004900*                                                               * 00490000
005000* 08/25/97 - MODIFICATIONS WERE MADE TO OBTAIN THE PO TYPE      * 00500000
005100*            CODE AND TO ENSURE THAT, FOR IMPORT POS, ONLY      * 00510000
005200*            THOSE INVOICES WHICH AP APPROVES WILL BE EXTRACTED * 00520000
005300*            AND SENT ON TO THE BATCH MATCH. IMPORT INVOICES    * 00530000
005400*            GOING TO REPORTING WILL BE WRITTEN TO THE NEW      * 00540000
005500*            IMPORT EXTRACT FILE.                               * 00550000
005600*        BY: J. KNOKE (TCC)                         WR 4164     * 00560000
005700*                                                               * 00570000
005800* 10/23/97 - CORRECT THE WRITE-OFF INVOICES SO THAT THEY PROCESS* 00580000
005900*            THE SAME WAY REGARDLESS OF THE PO TYPE.            * 00590000
006000*        BY: CHRIS BOEHNLEIN                        WR 4164     * 00600000
006100*                                                               * 00610000
006200* 11/11/97 - IF A IMPORT PO DOES NOT CONTAIN A VALUE FOR THE    * 00620000
006300*            IMPORT CHARGE PROCESS CODE, THEN THE INVOICE IS    * 00630000
006400*            INCLUDED ON AN ERROR FILE RATHER THEN THE EXTRACT  * 00640000
006500*            FILE.                                              * 00650000
006600*        BY: CHRIS BOEHNLEIN                         P118171    * 00660000
006700* 11/14/97 - INITIALIZED THE PV-INVOICE-TYPE FIELD AFTER        * 00670000
006800*            PROCESSING THE EXPENSE INVOICES FOR IMPORT PO'S.   * 00680000
006900*            ALSO RENAMED THE DATA AREA FOR THE EXPENSE INVOICE * 00690000
007000*            CURSOR RECORD.                                     * 00700000
007100*        BY: JERRY ZELLMER                           P118171    * 00710000
007200* 01/15/98 - ADDED INVC_NET_COST_AMT FIELD TO INVOICES_CSR. ALSO* 00720000
007300*            ADDED DISCOUNT-CSR FOR THE PURPOSE OF         *      00730000
007400*            CALCULATING THE CORRECT AMOUNT TO BE PASSED ALONG  * 00740000
007500*            IN THE INVOICE EXTRACT PROCESS.  THE DISCOUNT      * 00750000
007600*            AMOUNT IS CALCULATED FOR IMPORT INVOICES ONLY.     * 00760000
007700*        BY: MARK BURNSIDE                           WR 4164    * 00770000
007800*                                                               * 00780000
007900* 05/15/98 - COMBINED THE INVOICE AND EXPENSE CURSORS INTO ONE  * 00790000
008000*            CURSOR USING A UNION ALL.  THE PURPOSE OF THIS IS  * 00800000
008100*            TO BE ABLE TO EXTRACT EXPENSE INVOICES THAT DO NOT * 00810000
008200*            HAVE AN MI. THE CURSOR ALSO WILL BE ABLE TO EXTRACT* 00820000
008300*            EI'S THAT HAVE BEEN ADDED AFTER THE PO HAS BEEN    * 00830000
008400*            PAY RELEASED.  QUITE A BIT OF THE CODE THAT WAS    * 00840000
008500*            PROCESSING THE EI'S HAS NOW BEEN COMBINED WITH CODE* 00850000
008600*            THAT PROCESSES MI'S.  OTHER SECTIONS OF CODE HAVE  * 00860000
008700*            BEEN OMITTED THAT ARE NO LONGER NEEDED, LIKE THOSE * 00870000
008800*            PERTAINING TO THE OLD EXPENSE CURSOR.              * 00880000
008900*        BY: MIKE BESKE                              WR 4164    * 00890000
009000*                                                               * 00900000
009100* 02/26/99 - INSERTED VALID PO-STR SWITCH CHECK INTO B300-      * 00910000
009200*            PARAGRAPH SO IF LAST RECORD PO-STR ALREADY HAS     * 00920000
009300*            AN ENTRY ON TPOSTRR TABLE THIS RECORD WILL NOT BE  * 00930000
009400*            WRITTEN OUT.                                       * 00940000
009500*        BY: MARK BURNSIDE                         PITS 284353  * 00950000
009600*                                                               * 00960000
009700* 04/11/00 - ADDED A NEW IMPORT PO TYPE CODE (IE) TO VARIOUS IF * 00970000
009800*            STATEMENTS.  THIS IS PART OF THE PO TEAM ADDING 4  * 00980000
009900*            NEW PO TYPE CODES TO TPURCHS.                      * 00990000
010000*        BY: MIKE BESKE                            WR#: 20997   * 01000000
010100*                                                               * 01010000
010200* 04/13/00 - ADDED PC-ECOM-IMPORT-PO (IF) AS A VALID IMPORT     * 01020000
010300*            PO TYPE CODE.                                      * 01030000
010400*        BY: MIKE BESKE                            WR#: 20997   * 01040000
010500*                                                               * 01050000
010600* 11/10/00 - THIS PROGRAM WAS MODIFIED TO PROCESS THE           * 01060000
010700*            ADDITIONAL EXTEDED DAYS IN THE PO TERMS.           * 01070000
010800*            THE NEW LOGIC WAS ADDED TO THE END OF              * 01080000
010900*            R300-SELECT-TPAYTRM.                               * 01090000
011000*        BY: JILL JUEL                             WR#: 20224   * 01100000
011100*                                                               * 01110000
011200* 08/17/01 - MODIFIED THE INVOICES_CSR TO EXCLUDE STATUS CODE   * 01120000
011300*            'PR' FROM THE SECOND HALF OF THE UNION.  THIS WILL * 01130000
011400*            PREVENT THE 'PENDING REVIEW' INVOICES FROM BEING   * 01140000
011500*            EXTRACTED AND WRITTEN TO THE IMPORT INVOICE FILE.  * 01150000
011600*        BY: ALEXIS KEIKER                         WR#: 20530   * 01160000
011700*                                                               * 01170000
011800* 01/11/02 - SEPARATED INVOICE-TBL-OVER-LIMIT 88 LEVEL FROM THE * 01180000
011900*            PS-ERROR-SW AND PUT IT UNDER ITS OWN SWITCH.  THIS * 01190000
012000*            WAS NEEDED TO CORRECT THE PROBLEM OF HAVING A PO   * 01200000
012100*            THAT HAD A BULK REMAINDER INVOICE AND MORE THAN    * 01210000
012200*            1000 BY-STORE INVOICES.  ALL OF THESE WERE IN 'EN' * 01220000
012300*            STATUS.  THE ERROR CONDITION FOR THE MIXED BULK AND* 01230000
012400*            AND BY-STORE INVOICES OCCURRED FIRST, THEN THE ERROR*01240000
012500*            FOR MORE THAN 1000 INVOICES OCCURED.  IT CAUSED A  * 01250000
012600*            LOOP UNTIL THE S0C4 OCCURRED.                      * 01260000
012700*        BY: MIKE BESKE                           PITS: 442701  * 01270000
012800*                                                               * 01280000
012900* 06/17/02 - ARK PO PROJECT PHASE 1.  REMOVE TABLE TPAYREQ FROM * 01290000
013000*            INVOICES_CSR AND REPLACE ALL REFERENCES TO TPAYREQ * 01300000
013100*            COLUMNS AND DCLGENS WITH NEW TINVOIC COLUMNS AND   * 01310000
013200*            DCLGENS.                                           * 01320000
013300*        BY: KEVIN CATLIN                   WR #: 23500         * 01330000
013400*                                                               * 01340000
013500* 06/25/02 RECOMPILE FROM PRODUCTION TO PICK UP CHANGES TO      * 01350000
013600*          COPYBOOKS APPD052 AND APWS052.  ADDED INITIALIZE OF  * 01360000
013700*          PURCHS-PO-TYP-CDE IF ROW NOT FOUND FOR SELECT        * 01370000
013800*          STATEMENT IN PARAGRAPH R500.                         * 01380000
013900*          BY:  KEVIN CATLIN                 WR#: 23839         * 01390000
014000*                                                               * 01400000
014100* 08/08/2002 COLBY HANGER EXPENSE PROCESSING.  RECOMPILE FROM   * 01410000
014200*            PRODUCTION TO INCORPORATE COPYBOOK CHANGES.        * 01420000
014300*        BY: KEVIN CATLIN                   WR#: 23254          * 01430000
014400*                                                               * 01440000
014500* 07/08/02 ARK PO PROJECT PHASE 2.  CHANGED REFERENCES IN PARA  * 01450000
014600*          R400 AND THE DECLARATION OF THE DISCOUNT CURSOR TO   * 01460000
014700*          THE PAYMENTREQUEST NUMER WHICH IS NO LONGER USED.    * 01470000
014800*          BY: BRIAN HASSLINGER               WR#: 23500        * 01480000
014900*                                                               * 01490000
015000* 11/04/02 CHANGED MADE:                                        * 01500000
015100* COLBY DATING.  MODIFIED ALL OF THE AMOUNT FIELDS FROM 9(7)V99 * 01510000
015200* TO S9(9)V99 COMP-3 IN COPYBOOK APWS052.THIS WAS DONE          * 01520000
015300* TO CORRECT A DISCOUNT BALANCING ISSUE.                        * 01530000
015400* ADDED VALUE OF 'PJ' TO LIST OF STATUS CODES IN THE WHERE      * 01540000
015500* CONDITION OF THE INVOICES_CSR FOR THE COLBY DATING PROJECT.   * 01550000
015600*        BY: MIKE BESKE                       WR#:  23750       * 01560000
015700*                                                               * 01570000
015800* DATE  03/25/2003                                              * 01580000
015900*     CHANGE MADE: RECOMPILE FROM PRODUCTION TO PICK UP CHANGE  * 01590000
016000*     TO COPYBOOK APWS052.                                      * 01600000
016100*     MADE BY: KEVIN CATLIN            WR/IR #: WR24481         * 01610000
016200*                                                               * 01620000
016300* DATE  01/30/2004                                              * 01630000
016400*     CHANGE MADE: RECOMPILE FROM PRODUCTION TO PICK UP CHANGE  * 01640000
016500*     TO COPYBOOKS APWS052 AND APPD052. THIS INVOLVES THE VENDOR* 01650000
016600*     INSURANCE EXCEPTION OF NOT CHARGING BACK THE VENDOR FOR   * 01660000
016700*     INSURANCE CHARGE CODES: 'INS' AND '445'.  THE VENDORS ARE * 01670000
016800*     ANDEL JEWELRY '117498121' AND CITIZEN WATCH '078822863'.  * 01680000
016900*     MADE BY: MIKE BESKE              WR/IR #: P000628860      * 01690000
017000*                                                               * 01700000
017100* DATE  04/07/2004                                              * 01710000
017200*     CHANGE MADE: CORRECTED CODE IN PARA C200- FOR THE RECENTLY* 01720000
017300*     OCCURRING ERROR SITUATION: WHENEVER A PO HAS MORE THAN    * 01730000
017400*     1000 INVOICES WITH THE SAME STORE NUMBER (IE,BULK STORE 0)* 01740000
017500*     IT WOULD OVERVERFLOW THE IA-INVOICES ARRAY FROM APWS008.  * 01750000
017600*     THIS OVERFLOW HAPPENED BECAUSE THE 88 LEVEL LOAD-INVOICES * 01760000
017700*     WAS STILL SET AND ALLOWED THE 1001 INVOICES TO GO THRU THE* 01770000
017800*     MOVE STATEMENTS OF THE INVOLVING THE ARRAY ELEMENTS. THIS * 01780000
017900*     CAUSED A MEMORY OVERLAY OF THE COPYBOOK APWS052 FIELDS    * 01790000
018000*     APPD052-ALLOWANCE AND APPD052-CHARGE.  THESE FIELDS HAVE  * 01800000
018100*     CONSTANT VALUES OF 'A' & 'C' RESPECTIVELY.  ONCE THESE    * 01810000
018200*     VALUES WERE WIPED OUT IT CAUSED ANY IMPORT MI INVOICES    * 01820000
018300*     WITH ALLOWANCES(DISCOUNTS) TO NOT HAVE THE CALCULATED NET * 01830000
018400*     COST AMOUNT BE MOVED TO THE INVOICE ARRAY.  THE NET COST  * 01840000
018500*     THAT WAS IN THE ARRAY WAS EQUAL TO THE GROSS COST AMOUNT. * 01850000
018600*     THIS CAUSED BALANCING PROBLEMS LATER IN THE BATCH RUN     * 01860000
018700*     WHEN THE IMPORT PO WAS JOURNALIZED.  THE CODE CORRECTION  * 01870000
018800*     IS TO CREATE ONE LARGE IF STATEMENT FROM THE PREVIOUS 3   * 01880000
018900*     SMALLER IF STATEMENTS.  THIS STOPS A TABLE OVERFLOW FROM  * 01890000
019000*     OCCURRING.                                                * 01900000
019100*     MADE BY: MIKE BESKE              WR/IR #: WR26553         * 01910000
019200*                                                               * 01920000
019300* DATE  04/28/2005                                              * 01930000
019400*     CHANGE MADE: RECOMPILE FROM PRODUCTION TO PICK UP CHANGES * 01940000
019500*     TO COPYBOOKS APWS052 AND APPD052.                         * 01950000
019600*     MADE BY: KRYSTEN LEARY           WR/IR #: WR28651         * 01960000
019700*                                                               * 01970000
019800* DATE  03/02/2006                                              * 01980003
019900*     CHANGE MADE: TEMPORARY FIX TO INCLUDE BROADCAST AND CO-OP * 01990004
020000*     ALLOWANCES IN THE GROSS ALLOWANCE AMOUNT.                 * 02000004
020100*     MADE BY: GREG WISIALOWSKI        WR/IR #:  P000855667     * 02010004
020200*                                                               * 02020004
020300* DATE  03/07/2006                                              * 02030004
020400*     CHANGE MADE: WHILE LOADING INVOICES FOR AN IMPORT PO WITH * 02040004
020500*     A PO TYPE CODE = ('MI', 'IE' OR 'IF) 2 PIECES OF INFO.    * 02050004
020600*     NEED TO BE NOTED: WHEN A MERCHANDISE INVOICE WITH A       * 02060004
020700*     MERCHANDISE STATUS OF 'BM' EXISTS ** AND ** A MERCHANDISE * 02070004
020800*     INVOICE WITH A MERCHANDISE STATUS OTHER THAN 'BM' EXISTS. * 02080004
020900*                                                               * 02090004
021000*     WHILE UNLOADING THE ABOVE QUALIFYING RECORDS, INVOICES    * 02100004
021100*     WITH AN INVOICE TYPE CODE OF 'MI' NEEDS TO BE REVIEWED:   * 02110004
021200*                                                               * 02120004
021300*     A) IF IT HAS A MERCHANDISE STATUS OF 'BM' ** AND ** A     * 02130004
021400*     MERCHANDISE STATUS OF OTHER THAN 'BM' THEN ALL THE        * 02140004
021500*     RECORDS FOR THIS INVOICE CAN BE WRITTEN TO THE IMPORT     * 02150004
021600*     EXTRACT FILE BUT THE RECORDS WITH THE MERCHANDISE         * 02160004
021700*     STATUS OF 'BM' ** CAN'T ** BE WRITTEN TO THE MAIN         * 02170004
021800*     EXTRACT FILE.                                             * 02180004
021900*                                                               * 02190004
022000*     B) IF IT HAS ALL MI WITH A MERCHANDISE STATUS OF 'BM'     * 02200004
022100*      ** OR ** HAS ALL MI WITH A MERCHANDISE STATUS OTHER THAN * 02210004
022200*     'BM' THEN ALL THE RECORDS FOR THIS INVOICE CAN BE WRITTEN * 02220004
022300*     TO THE IMPORT EXTRACT FILE AND THE RECORDS WITH THE       * 02230004
022400*     MERCHANDISE STATUS OF 'BM' ** CAN ** BE WRITTEN TO THE    * 02240004
022500*     MAIN EXTRACT FILE.                                        * 02250004
022600*     MADE BY: MICHELE RINDFLEISCH     WR/IR #: P000845858      * 02260004
022700*                                                               * 02270004
022800* DATE  03/08/2006                                              * 02280000
022900*     CHANGE MADE: TEMPORARY FIX TO INCLUDE BROADCAST AND CO-OP * 02290000
023000*     ALLOWANCES IN THE GROSS ALLOWANCE AMOUNT - REINSTALL      * 02300000
023100*     MADE BY: GREG WISIALOWSKI        WR/IR #:  P000858176     * 02310000
023200*                                                               * 02320004
023300* DATE O3/21/2006                                               * 02330006
023310*     CHANGE MADE: CODE ADDED FOR BATCH MATCH ON 3/7/06 WAS     * 02331008
023320*     REMOVED TO MODIFY CODE TO ALLOW FOR A LARGER AMOUNT OF    * 02332008
023330*     DATA BEING PROCESSED. THE RULES FROM 03/07/06 STILL APPLY * 02333008
023700*     MADE BY: MICHELE RINDFLEISCH     WR/IR #: P000858176      * 02370004
023800*                                                               * 02380009
023810* DATE O3/23/2006                                               * 02381012
023820*     CHANGE MADE: REMOVE TEMPORARY CODE FOR VENDOR ALLOWANCE   * 02382009
023830*     INSTALLATION.                                             * 02383013
023850*     MADE BY: GREG WISIALOWSKI        WR/IR #: WR30028         * 02385011
023851*                                                               * 02385113
023860* DATE 03/11/2007                                               * 02386056
023870*     CHANGE MADE: MATCH BY DC -- ALTERED THE INVOICES_CSR      * 02387019
023880*     SELECT STATEMENT TO INCLUDE THE IV.DC_NBR AND THE         * 02388019
023881*     IV.MTCH_LVL_CDE FIELDS AND CHANGED THE FETCH STATEMENT    * 02388120
023882*     ACCORDINGLY.  REMOVED ALL INSANCES OF INVOICED-BY-BULK    * 02388221
023883*     AND INVOICED-BY-STORE SINCE THESE FIELDS SERVED NO        * 02388321
023884*     PURPOSE.  CHANGED ALL INSTANCES OF VALIDATE-PO-STR TO BE  * 02388437
023886*     VALIDATE-PO-MTCH IN PARAGRAPHS B100-INITIALIZE AND        * 02388621
023887*     C100-PO-BREAK.  IN PARAGRAPH B200-PROCESS-INVOICES REMOVED* 02388720
023888*     ALL LOGIC RELATING TO STORE COMPARISON AND REPLACED IT    * 02388820
023889*     WITH MATCH LEVEL CODE COMPARISON. IN PARAGRAPH            * 02388920
023890*     C200-LOAD-INVOICE-DATA MOVED THE INVOIC-DC-NBR AND THE    * 02389020
023891*     INVOIC-MTCH-LVL-CDE TO THE CORRESPONDING INTERNAL ARRAY   * 02389120
023892*     FIELDS.  BASED ON THE INVOIC-MTCH-LVL-CDE, MOVED EITHER   * 02389220
023893*     ZEROS, THE INVOIC-STR-NBR, OR THE INVOIC-DC-NBR TO THE    * 02389320
023894*     INTERNAL ARRAY MTCH-LOC-NBR FIELD.  ADDED LOGIC TO        * 02389420
023895*     PARAGRAPH D100-PREPARE-INVOIC-EXTRACT TO MOVE THE DC-NBR, * 02389520
023896*     MTCH-LVL-CDE, AND MTCH-LOC-NBR FROM THE INTERNAL ARRAY    * 02389620
023897*     TO THE CORRESPONDING APRD060 COPYBOOK FIELDS.  ADDED LOGIC* 02389746
023898*     TO PARAGRAPH E300-FORMAT-INVCD-ERROR TO MOVE THE DC-NBR   * 02389846
023899*     AND MTCH-LVL-CDE TO THE APPROPRIATE APRD059 COPYBOOK      * 02389946
023900*     FIELDS.  LASTLY,  ADDED THE CLAUSE MTCH_LVL_CDE =         * 02390046
023901*     PV-SAVED-MTCH-LVL-CDE TO THE WHERE PORTION OF THE QUERY IN* 02390146
023902*     PARAGRAPH R200-CHECK-FOR-PO-MTCH.                         * 02390246
023904*     MADE BY: KRYSTEN LEARY           WR/IR #: WR21578         * 02390413
023905*                                                               * 02390557
023906* DATE 03/02/2010                                               * 02390659
023907*     CHANGE MADE: UPDATED LOGIC IN B200 AND E100 THAT WAS      * 02390757
023908*     FETCHING THROUGH THE INVOICE CURSOR TO GET PAST THE PO/   * 02390857
023909*     LOCATION/MATCH LEVEL BEING PROCESSED WHEN EITHER A TABLE  * 02390957
023910*     OVERFLOW OR A TPOSTRR FOUND WAS BEING HANDLED.  WHEN THE  * 02391057
023911*     MATCH LEVEL IS 'P', THE PERFORM UNTIL CAN'T COMPARE THE   * 02391157
023912*     LOCATION NUMBER BECAUSE THE SAVE FIELDS ARE FORCED TO     * 02391257
023913*     ZERO, BUT THE DATABASE FIELDS WILL NOT CONTAIN ZERO -     * 02391357
023914*     THIS CAUSED THE PROGRAM TO LOOP CONTINUOUSLY BECAUSE IT   * 02391457
023915*     WOULD NOT PERFORM THE NEXT FETCH.  SEPARATED THE MATCH    * 02391557
023916*     LEVEL'P' CHECK FROM THE MATCH LEVEL 'S' CHECK AND TOOK    * 02391657
023917*     THE LOCATION COMPARISON OUT OF THE 'UNTIL' LOGIC ON THE   * 02391757
023918*     LEVEL 'P' PROCESS.                                        * 02391857
023919*     MADE BY: NANCY EILBES            WR/IR #: PKE000000002198 * 02391958
023920*                                                               * 02392059
023921* DATE 12/17/2015                                               * 02392159
023922*     CHANGE MADE: RECOMPILED TO INCLUDE CHANGES TO APWS008     * 02392259
023923*     TO INCREASE THE INVOICE ARRAY TO 8000 ENTRIES.            * 02392359
023934*     MADE BY: NANCY EILBES            WR/IR #: CHG0130416      * 02393459
023935*                                                               * 02393560
023936* DATE 12/01/2016                                               * 02393660
023937*     CHANGE MADE: RECOMPILED TO INCLUDE CHANGES TO APWS008     * 02393760
023938*     TO INCREASE THE INVOICE ARRAY TO 50000 ENTRIES.           * 02393860
023939*     MADE BY: NANCY EILBES            WR/IR #: CHG0157916      * 02393960
023935*                                                               * 02394064
023936* DATE 05/11/2021                                               * 02394173
023937*     CHANGE MADE: ADD SEPHORA LOGIC                            * 02394264
023939*     MADE BY: JEAN KURK                CHG0256545              * 02394473
023935*                                                               * 02394574
023936* DATE 02/22/2024                                               * 02394674
023937*     CHANGE MADE: FIX ISSUE WITH WO INVOICE NOT GETTING        * 02394774
023937*     BATCHED MATCHED WHEN THERE ARE EI INVOICES PRESENT        * 02394874
023939*     MADE BY: JEAN KURK                CHG0300350              * 02394974
023940*---------------------------------------------------------------* 02395059
024000                                                                  02400013
024100 ENVIRONMENT DIVISION.                                            02410000
024200 CONFIGURATION SECTION.                                           02420000
024300 SOURCE-COMPUTER.    IBM-3090.                                    02430000
024400 OBJECT-COMPUTER.    IBM-3090.                                    02440000
024500                                                                  02450000
024600 INPUT-OUTPUT SECTION.                                            02460000
024700 FILE-CONTROL.                                                    02470000
024800     SELECT INVOICE-EXTRACT-FILE          ASSIGN TO UT-S-OUT01.   02480000
024900     SELECT IMPORT-EXTRACT-FILE           ASSIGN TO UT-S-OUT02.   02490000
025000     SELECT ERROR-FILE                    ASSIGN TO UT-S-OUT03.   02500000
025100                                                                  02510013
025200 DATA DIVISION.                                                   02520000
025300 FILE SECTION.                                                    02530000
025400                                                                  02540000
025500 FD  INVOICE-EXTRACT-FILE                                         02550000
025600     RECORDING MODE IS F                                          02560000
025700     LABEL RECORDS ARE STANDARD                                   02570000
025800     BLOCK CONTAINS 0 RECORDS                                     02580000
025900     DATA RECORD IS INVOICE-EXTRACT-RECORD.                       02590000
026000 01  INVOICE-EXTRACT-RECORD.                                      02600000
026100     05 FILLER                        PIC  X(175).                02610000
026200                                                                  02620000
026300 FD  IMPORT-EXTRACT-FILE                                          02630000
026400     RECORDING MODE IS F                                          02640000
026500     LABEL RECORDS ARE STANDARD                                   02650000
026600     BLOCK CONTAINS 0 RECORDS                                     02660000
026700     DATA RECORD IS IMPORT-EXTRACT-RECORD.                        02670000
026800 01  IMPORT-EXTRACT-RECORD.                                       02680000
026900     05 FILLER                        PIC  X(175).                02690000
027000                                                                  02700000
027100 FD  ERROR-FILE                                                   02710000
027200     RECORDING MODE IS F                                          02720000
027300     LABEL RECORDS ARE STANDARD                                   02730000
027400     BLOCK CONTAINS 0 RECORDS                                     02740000
027500     DATA RECORD IS ERROR-RECORD.                                 02750000
027600 01  ERROR-RECORD                     PIC  X(100).                02760000
027700                                                                  02770013
027800 WORKING-STORAGE SECTION.                                         02780000
027810*----------------------------------------------------------------*02781014
027820* INVOICE DATA ARRAY                                             *02782014
027830*----------------------------------------------------------------*02783014
027840     COPY APWS008.                                                02784014
027850                                                                  02785014
027860*----------------------------------------------------------------*02786014
027870* WORKING STORAGE AREA FOR APPD052                               *02787014
027880*----------------------------------------------------------------*02788014
027890     COPY APWS052.                                                02789014
027891                                                                  02789114
027892*----------------------------------------------------------------*02789214
027893* BATCH MATCH INVOICE EXTRACT LAYOUT                             *02789314
027894*----------------------------------------------------------------*02789414
027895     COPY APRD060.                                                02789514
027896                                                                  02789614
027897*----------------------------------------------------------------*02789714
027898* ERROR FILE LAYOUT                                              *02789814
027899*----------------------------------------------------------------*02789914
027900     COPY APRD059.                                                02790014
027901                                                                  02790114
027902*----------------------------------------------------------------*02790214
027903* SQLCA FORMATTED MESSAGE AREA                                   *02790314
027904*----------------------------------------------------------------*02790414
027905     COPY DPWS004.                                                02790514
027906                                                                  02790614
027907*----------------------------------------------------------------*02791264
027908* COMMUNICATIONS AREA FOR DB2                                    *02791364
027909*----------------------------------------------------------------*02791464
027910     COPY SQLCA2.                                                 02791564
027911                                                                  02791664
028000 01  PV-PROGRAM-VARIABLES.                                        02800000
028100     05  FILLER                  PIC  X(30)  VALUE                02810000
028200         '** BEGINING OF APKUT020 W/S **'.                        02820000
028300     05  PV-PROGRAM-NAME         PIC  X(08)  VALUE 'APKUT020'.    02830000
028400     05  PV-SAVED-PO             PIC S9(09)  VALUE ZEROS COMP.    02840013
028600     05  PV-SAVED-VEND-CH-PO     PIC S9(09)  VALUE ZEROS COMP.    02860013
028800     05  PV-SAVED-STR            PIC S9(04)  VALUE ZEROS COMP.    02880013
028900     05  PV-SAVED-LOC            PIC S9(05)  VALUE ZEROS COMP.    02890052
028910     05  PV-SAVED-MTCH-LVL-CDE   PIC  X(01)  VALUE SPACES.        02891014
028910     05  PV-SAVED-INVC-TYP-CDE   PIC  X(02)  VALUE SPACES.        02892074
029000     05  PV-SAVED-BM-FLG         PIC  X(01)  VALUE SPACES.        02900013
029100     05  PV-SAVED-NOT-BM-FLG     PIC  X(01)  VALUE SPACES.        02910013
029200     05  PV-TERMS-DISC-PCT       PIC SV9(4)  VALUE ZEROS.         02920000
029300     05  PV-TERMS-DUE-DAY-QTY    PIC  9(03)  VALUE ZEROS.         02930000
029400     05  PV-TERMS-EXT-DAY-QTY    PIC  9(03)  VALUE ZEROS.         02940000
029500     05  PV-TERMS-SEL-CDE        PIC  X(01)  VALUE SPACE.         02950013
029600     05  PV-DISC-EXTENDED-DAYS   PIC S9(04)  COMP.                02960013
029700                                                                  02970000
029800 01  PS-PROGRAM-SWITCHES.                                         02980000
029900     05  PS-OUT-OF-INVOICES-SW       PIC X(01) VALUE 'M'.         02990000
030000         88  OUT-OF-INVOICES                   VALUE 'O'.         03000000
030100         88  MORE-INVOICES                     VALUE 'M'.         03010000
030200     05  PS-OUT-OF-EXPENSES-SW       PIC X(01) VALUE ' '.         03020000
030300         88  END-EXPENSE-INVOICES              VALUE 'Y'.         03030000
030400         88  MORE-EXPENSE-INVOICES             VALUE ' '.         03040000
030500     05  PS-VALID-PO-MTCH-SW         PIC X(01) VALUE 'I'.         03050016
030600         88  INVALID-PO-MTCH                   VALUE 'I'.         03060016
030700         88  VALID-PO-MTCH                     VALUE 'V'.         03070016
031100     05  PS-PO-FOUND-SW              PIC X(01) VALUE 'N'.         03110000
031200         88  PO-FOUND                          VALUE 'Y'.         03120000
031300         88  PO-NOT-FOUND                      VALUE 'N'.         03130000
031400     05  PS-END-OF-MONTH-SW          PIC X(01) VALUE 'N'.         03140000
031500         88  END-OF-MONTH                      VALUE 'Y'.         03150000
031600         88  NOT-END-OF-MONTH                  VALUE 'N'.         03160000
031700     05  PS-IMPORT-EXTRACT-SW        PIC X(01) VALUE 'N'.         03170004
031800         88  IMPORT-EXTRACT-ALLOWED            VALUE 'Y'.         03180004
031900     05  PS-BATCH-MATCH-ALLOWED-SW   PIC X(01) VALUE 'N'.         03190004
032000         88  BATCH-MATCH-ALLOWED               VALUE 'Y'.         03200004
032100     05  PS-OUT-OF-IMPORT-DISCOUNTS  PIC X(01) VALUE 'M'.         03210000
032200         88  END-OF-IMPORT-DISCOUNTS           VALUE 'O'.         03220000
032300         88  MORE-IMPORT-DISCOUNTS             VALUE 'M'.         03230000
032400                                                                  03240000
032500******************************************************************03250000
032600* NOTE: IF ANY NEW ERRORS ARE ADDED TO THE 88 LEVELS BELOW        03260000
032700*       FOR PS-ERROR-SW, DO NOT USE VALUE 6.  THIS VALUE IS USED  03270000
032800*       IN THE PS-INVOICE-TBL-LIMIT-ERR.  IT ORIGINALLY WAS PART  03280000
032900*       OF THE PS-ERROR-SW, BUT DUE TO A PROBLEM THAT CAUSED PITS 03290000
033000*   # 442701, THE PROGRAM LOGIC IN PARAGRAPH B200-PROCESS-INVOICES03300000
033100*       REQUIRED IT TO BE SEPARATED.  THE PROBLEM WAS THE RARE    03310000
033200*       SITUATION INVOICING A INVOICED-BY-ERROR BEING TRUE THEN   03320000
033300*       HAVING A INVOICE-TBL-OVER-LIMIT CONDITION FOR THE SAME PO.03330000
033400*       IT CAUSED A LOOP UNTIL A S0C4 OCCURRED.                   03340000
033500*                                                                 03350000
033600     05  PS-ERROR-SW                 PIC 9(03) VALUE ZERO.        03360000
033700         88  NO-ERRORS                         VALUE ZERO.        03370000
033800         88  INVOICED-BY-ERROR                 VALUE 1.           03380000
033900         88  INVOICE-OB-STATUS                 VALUE 2.           03390000
034000         88  INVOICE-IB-STATUS                 VALUE 3.           03400000
034100         88  NO-INV-TERMS                      VALUE 4.           03410000
034200         88  NO-PO-TERMS                       VALUE 5.           03420000
034300         88  INVOICE-WITH-ZERO-COST            VALUE 7.           03430000
034400         88  LOAD-INVOICES                     VALUES 0, 1, 7, 8. 03440000
034500         88  IMPORT-FIELD-NOT-VALID            VALUE 8.           03450000
034510         88  MTCH-LVL-INVALID                  VALUE 9.           03451053
034600                                                                  03460000
034700     05  PS-INVOICE-TBL-ERR-SW       PIC 9(03) VALUE ZERO.        03470000
034800         88  NO-INVOICE-TBL-LIMIT-ERR          VALUE ZERO.        03480000
034900         88  INVOICE-TBL-OVER-LIMIT            VALUE 6.           03490000
035100******************************************************************03510000
035200                                                                  03520000
035400 01  PA-PROGRAM-AMOUNTS.                                          03540000
035500     05  PA-PO-MTCH-COUNT         PIC  9(07)    VALUE ZEROS.      03550062
035600     05  PA-ERROR-COUNT           PIC  9(07)    VALUE ZEROS.      03560000
035700     05  PA-IMPORT-COUNT          PIC  9(07)    VALUE ZEROS.      03570000
035900                                                                  03590000
036000 01  PC-PROGRAM-CONSTANTS.                                        03600000
036100     05  PC-OUT-OF-BALANCE       PIC  X(02)  VALUE 'OB'.          03610000
036200     05  PC-ITEM-OUT-OF-BALANCE  PIC  X(02)  VALUE 'IB'.          03620000
036300                                                                  03630013
037300*----------------------------------------------------------------*03730000
037400* COMMUNICATIONS AREA FOR DB2                                    *03740013
037500*----------------------------------------------------------------*03750000
037900     EXEC SQL                                                     03790000
038000          INCLUDE SQLCA                                           03800000
038100     END-EXEC.                                                    03810000
038200                                                                  03820013
038300*----------------------------------------------------------------*03830000
038400* INVOICE TABLE                                                  *03840013
038500*----------------------------------------------------------------*03850000
038600     EXEC SQL                                                     03860000
038700          INCLUDE TINVOIC                                         03870000
038800     END-EXEC.                                                    03880000
038900                                                                  03890013
039000*----------------------------------------------------------------*03900000
039100* MERCHANDISE INVOICE TABLE                                      *03910013
039200*----------------------------------------------------------------*03920000
039300     EXEC SQL                                                     03930000
039400          INCLUDE TMDINVC                                         03940000
039500     END-EXEC.                                                    03950000
039600                                                                  03960013
039700*----------------------------------------------------------------*03970000
039800* PURCHASE ORDER AGREEMENT TABLE                                 *03980013
039900*----------------------------------------------------------------*03990000
040000     EXEC SQL                                                     04000000
040100          INCLUDE TPOAGMT                                         04010000
040200     END-EXEC.                                                    04020000
040300                                                                  04030013
040400*----------------------------------------------------------------*04040000
040500* PAYMENT TERMS TABLE                                            *04050013
040600*----------------------------------------------------------------*04060000
040700     EXEC SQL                                                     04070000
040800          INCLUDE TPAYTRM                                         04080000
040900     END-EXEC.                                                    04090000
041000                                                                  04100013
041100*----------------------------------------------------------------*04110000
041200* INVOICE PAYMENT TERMS TABLE                                    *04120013
041300*----------------------------------------------------------------*04130000
041400     EXEC SQL                                                     04140000
041500          INCLUDE TINVCTM                                         04150000
041600     END-EXEC.                                                    04160000
041700                                                                  04170013
041800*----------------------------------------------------------------*04180000
041900* PURCHASE TABLE                                                 *04190013
042000*----------------------------------------------------------------*04200000
042100     EXEC SQL                                                     04210000
042200          INCLUDE TPURCHS                                         04220000
042300     END-EXEC.                                                    04230000
042400                                                                  04240013
042500*----------------------------------------------------------------*04250000
042600* EXTERNAL ENTERPRISE NAME TABLE                                 *04260013
042700*----------------------------------------------------------------*04270000
042800     EXEC SQL                                                     04280000
042900          INCLUDE TENTNME                                         04290000
043000     END-EXEC.                                                    04300000
043100                                                                  04310013
043200*----------------------------------------------------------------*04320000
043300* EXTERNAL ENTERPRISE TABLE                                      *04330013
043400*----------------------------------------------------------------*04340000
043500     EXEC SQL                                                     04350000
043600          INCLUDE TEXTENT                                         04360000
043700     END-EXEC.                                                    04370000
043800                                                                  04380013
043900*----------------------------------------------------------------*04390000
044000* RELEASED PO/STORES TABLE                                       *04400013
044100*----------------------------------------------------------------*04410000
044200     EXEC SQL                                                     04420000
044300          INCLUDE TPOSTRR                                         04430000
044400     END-EXEC.                                                    04440000
044500                                                                  04450013
044600*----------------------------------------------------------------*04460000
044700* ALLOWANCE/CHARGE TABLE                                         *04470013
044800*----------------------------------------------------------------*04480000
044900     EXEC SQL                                                     04490000
045000          INCLUDE TALCHRG                                         04500000
045100     END-EXEC.                                                    04510000
045200                                                                  04520013
044600*----------------------------------------------------------------*04521064
044700* MERCHANDISE AREA                                               *04522064
044800*----------------------------------------------------------------*04523064
044900     EXEC SQL                                                     04524064
045000          INCLUDE TMDSEAR                                         04525064
045100     END-EXEC.                                                    04526064
045200                                                                  04527064
044600*----------------------------------------------------------------*04528064
044700* VENDOR CAPABILITY                                              *04529064
044800*----------------------------------------------------------------*04529164
044900     EXEC SQL                                                     04529264
045000          INCLUDE VNT00001                                        04529364
045100     END-EXEC.                                                    04529464
045200                                                                  04529564
045300*----------------------------------------------------------------*04530000
045400* INVOICES_CSR GETS ALL ENTERED AND IN RECONCILATION INVOICES    *04540000
045500* FOR THE PURCHASE ORDER BEING PROCESSED.                        *04550000
045600*----------------------------------------------------------------*04560000
045700     EXEC SQL                                                     04570000
045800       DECLARE INVOICES_CSR CURSOR FOR                            04580000
045900         SELECT                                                   04590000
046000             IV.PO_NBR                                            04600000
046100            ,IV.STR_NBR                                           04610000
046200            ,IV.INVC_ID                                           04620000
046300            ,IV.INVC_TYP_CDE                                      04630000
046400            ,IV.STATUS_CDE                                        04640000
046500            ,IV.INVC_DTE                                          04650000
046600            ,IV.ENTR_MTHD_CDE                                     04660000
046700            ,IV.GRO_COST_AMT                                      04670000
046800            ,IV.DTL_ENTR_IND                                      04680000
046900            ,MI.TERM_SEL_CDE                                      04690000
047000            ,MI.TOT_INVC_PC_QTY                                   04700000
047100            ,MI.IMPRT_CHRG_PRC_CDE                                04710000
047200            ,IV.PAYT_REQ_SEQ_NBR                                  04720000
047300            ,IV.CRE_DTE                                           04730000
047400            ,IV.CRE_BY_USR_ID                                     04740000
047500            ,IV.INVC_NET_COST_AMT                                 04750000
047510            ,IV.DC_NBR                                            04751013
047520            ,IV.MTCH_LVL_CDE                                      04752013
047600         FROM                                                     04760000
047700             TINVOIC IV                                           04770000
047800            ,TMDINVC MI                                           04780000
047900         WHERE IV.PO_NBR       = MI.PO_NBR                        04790000
048000           AND IV.INVC_ID      = MI.INVC_ID                       04800000
048100           AND IV.STATUS_CDE   IN ('EN','RC','OB','IB','BM','PJ') 04810000
048200           AND IV.INVC_TYP_CDE IN ('MI', 'RI', 'WO')              04820000
048300                                                                  04830000
048400         UNION ALL                                                04840000
048500                                                                  04850000
048600         SELECT                                                   04860000
048700             IV.PO_NBR                                            04870000
048800            ,IV.STR_NBR                                           04880000
048900            ,IV.INVC_ID                                           04890000
049000            ,IV.INVC_TYP_CDE                                      04900000
049100            ,IV.STATUS_CDE                                        04910000
049200            ,IV.INVC_DTE                                          04920000
049300            ,IV.ENTR_MTHD_CDE                                     04930000
049400            ,IV.GRO_COST_AMT                                      04940000
049500            ,IV.DTL_ENTR_IND                                      04950000
049600            ,' '                                                  04960000
049700            ,0                                                    04970000
049800            ,'   '                                                04980000
049900            ,IV.PAYT_REQ_SEQ_NBR                                  04990000
050000            ,IV.CRE_DTE                                           05000000
050100            ,IV.CRE_BY_USR_ID                                     05010000
050200            ,IV.INVC_NET_COST_AMT                                 05020000
050210            ,IV.DC_NBR                                            05021013
050220            ,IV.MTCH_LVL_CDE                                      05022013
050300         FROM                                                     05030000
050400             TINVOIC IV                                           05040000
050500         WHERE IV.STATUS_CDE NOT IN ('DE','PR')                   05050000
050600           AND IV.INVC_TYP_CDE     = 'EI'                         05060000
050700           AND IV.AP_PRC_CDE       = ' '                          05070000
050800         ORDER BY 1                                               05080000
050900                 ,2                                               05090000
051100     END-EXEC.                                                    05110000
051200                                                                  05120013
051300*----------------------------------------------------------------*05130000
051400* DISCOUNT_CSR WILL RETRIEVE THE DISCOUNT RECORDS FOR A          *05140014
051500* PARTICULAR INVOICE.                                            *05150000
051600*----------------------------------------------------------------*05160000
051700     EXEC SQL                                                     05170000
051800       DECLARE DISCOUNT_CSR CURSOR FOR                            05180000
051900         SELECT                                                   05190000
052000             ALW_CHRG_AMT                                         05200000
052100            ,ALW_CHRG_PCT                                         05210000
052200            ,ALW_CHRG_CDE                                         05220000
052300            ,ALW_CHRG_TYP_CDE                                     05230000
052400         FROM                                                     05240000
052500             TALCHRG                                              05250000
052600         WHERE PO_NBR           = :PV-SAVED-PO                    05260000
052700           AND INVC_ID          = :INVOIC-INVC-ID                 05270000
052800           AND ALW_CHRG_TYP_CDE = 'A'                             05280000
052900           AND ALW_CHRG_PCT     > 0                               05290000
053000     END-EXEC.                                                    05300000
053100                                                                  05310013
027907*----------------------------------------------------------------*05320066
027908* WORKING STORAGE FOR SEPHORA                                    *05330066
027909*----------------------------------------------------------------*05340066
027910     COPY APWS021.                                                05350066
027911                                                                  05360066
054200*----------------------------------------------------------------*05420000
054300*  ABEND DATA AREAS                                              *05430000
054400*----------------------------------------------------------------*05440000
054500 01  ABEND-CODE               PIC S9(04)  VALUE ZEROS COMP SYNC.  05450013
054700     88  AC-BAD-DATA                      VALUE +4003.            05470013
054800     88  AC-DB2-ERROR                     VALUE +4013.            05480013
054900                                                                  05490000
055100 01  ABEND-AREAS.                                                 05510000
055200     05  AA-ABEND-LIT            PIC  X(40)  VALUE                05520013
055300         '*****       ABEND'.                                     05530013
055400     05  AA-PROGRAM-LIT          PIC  X(40)  VALUE                05540013
055500         '*****   PROGRAM: APKUT020'.                             05550013
055600     05  AA-PARAGRAPH-LIT.                                        05560000
055700         10  FILLER              PIC  X(17)  VALUE                05570013
055800             '***** PARAGRAPH: '.                                 05580013
055900         10  AA-PARAGRAPH-NAME   PIC  X(35)  VALUE SPACES.        05590000
056000     05  AA-MESSAGE-LINE.                                         05600000
056100         10  FILLER              PIC  X(06)  VALUE '*****'.       05610000
056200         10  AA-MESSAGE          PIC  X(127) VALUE SPACES.        05620000
056300     05  AA-DB2-ERROR-LIT        PIC  X(40)  VALUE                05630000
056400         '*****    DB2 ERROR'.                                    05640013
056500     05  AA-DB2-OPERATION-LIT.                                    05650000
056600         10  FILLER              PIC  X(17)  VALUE                05660000
056700             '***** OPERATION: '.                                 05670000
056800         10  AA-DB2-OPERATION.                                    05680000
056900             15  AA-DB2-OP-1     PIC  X(25)  VALUE SPACES.        05690000
057000             15  AA-DB2-OP-2     PIC  X(25)  VALUE SPACES.        05700000
057100     05  AA-DB2-TABLE-1          PIC  X(08)  VALUE SPACES.        05710000
057200     05  AA-DB2-TABLE-2          PIC  X(08)  VALUE SPACES.        05720000
057300     05  AA-DB2-TABLE-3          PIC  X(08)  VALUE SPACES.        05730000
057400     05  AA-DB2-TABLE-4          PIC  X(08)  VALUE SPACES.        05740000
057500                                                                  05750000
057800 01  FILLER                      PIC  X(25)  VALUE                05780000
057900     '** END OF APKUT020 W/S **'.                                 05790000
058000                                                                  05800013
058010*--------------------------*                                      05801013
058100 PROCEDURE DIVISION.                                              05810000
058110*--------------------------*                                      05811013
058200 A100-MAIN.                                                       05820000
058300                                                                  05830000
058400     PERFORM B100-INITIALIZE.                                     05840000
058600     PERFORM B200-PROCESS-INVOICES                                05860000
058700       UNTIL OUT-OF-INVOICES.                                     05870014
058900     PERFORM B300-END-PROGRAM.                                    05890000
059100     GOBACK.                                                      05910000
059200                                                                  05920013
059300*----------------------------------------------------------------*05930000
059400* INITIALIZATION PROCESSING                                      *05940013
059500*----------------------------------------------------------------*05950000
059600 B100-INITIALIZE.                                                 05960000
059700                                                                  05970000
059800     OPEN OUTPUT INVOICE-EXTRACT-FILE                             05980000
059900                 IMPORT-EXTRACT-FILE                              05990000
060000                 ERROR-FILE.                                      06000000
060100                                                                  06010000
060200     INITIALIZE DCLTINVOIC                                        06020000
060300                DCLTMDINVC                                        06030000
060400                DCLTPOAGMT                                        06040000
060500                DCLTPAYTRM                                        06050000
060600                DCLTINVCTM                                        06060000
060700                DCLTPURCHS                                        06070000
060800                DCLTENTNME                                        06080000
060900                DCLTEXTENT                                        06090000
061000                DCLTPOSTRR                                        06100000
061000                DCLTMDSEAR                                        06101064
061100                IA-INVOICE-ARRAY                                  06110000
061200                DCLTALCHRG.                                       06120000
061300                                                                  06130004
061400     MOVE 'N'    TO PV-SAVED-BM-FLG,                              06140004
061500                    PV-SAVED-NOT-BM-FLG.                          06150004
061600                                                                  06160000
061600     MOVE PV-PROGRAM-NAME         TO SA-PROGRAM-NAME.             06161064
061600     PERFORM S100-GET-SEPHORA-DEPT.                               06162064
061600                                                                  06163064
061700     PERFORM Y100-OPEN-INVOICES-CSR.                              06170000
061800     PERFORM R100-FETCH-INVOICES.                                 06180000
062000     IF OUT-OF-INVOICES                                           06200000
062100        MOVE 'B100-INITIALIZE'    TO AA-PARAGRAPH-NAME            06210013
062200        MOVE 'NO POS ELIGIBLE FOR BATCH MATCH PROCESSING'         06220013
062300                                  TO AA-MESSAGE                   06230013
062400        SET AC-BAD-DATA           TO TRUE                         06240013
062500        PERFORM Z999-ABEND                                        06250013
062600     END-IF.                                                      06260000
062700                                                                  06270000
062800     SET INVALID-PO-MTCH          TO TRUE.                        06280015
062900     PERFORM E100-VALIDATE-PO-MTCH                                06290015
063000       UNTIL VALID-PO-MTCH                                        06300015
063100          OR OUT-OF-INVOICES                                      06310015
063300     IF OUT-OF-INVOICES                                           06330000
063400        MOVE 'B100-INITIALIZE'    TO AA-PARAGRAPH-NAME            06340013
063500        MOVE 'NO VALID POS FOR BATCH MATCH PROCESSING'            06350013
063600                                  TO AA-MESSAGE                   06360013
063700        SET AC-BAD-DATA           TO TRUE                         06370013
063800        PERFORM Z999-ABEND                                        06380013
063900     END-IF.                                                      06390000
064000                                                                  06400000
064600     PERFORM R500-SELECT-VENDOR-DATA.                             06460000
064700                                                                  06470013
064800*----------------------------------------------------------------*06480000
064900* CONTROLS THE PROCESSING OF EACH PO/MATCH LEVEL COMBINATION.... *06490016
065200*                                                                *06520000
065300* - INVOICES FOR THE SAME PO AND MATCH LEVEL WILL GENERATE AN    *06530016
065400*   'INVOICED-BY-ERROR'.  THESE INVOICES WILL BE LOADED TO THE   *06540016
065500*   INTERNAL ARRAY AND THE NEXT PO BREAK ALONG WITH BEING        *06550016
065600*   WRITTEN TO THE ERROR OUTPUT FILE.                            *06560016
065700*                                                                *06570016
065900* - INVOICES FOR DIFFERENT POS WILL BE LOADED TO THE INTERNAL    *06590016
066000*   ARRAY AND BE FORMATTED TO POTENTIALLY BE WRITTEN TO THE      *06600016
066100*   INVOICE EXTRACT OUTPUT FILE.  HOWEVER, IF ANY OF THE         *06610016
066200*   FOLLOWING CONDITIONS ARE SATISFIED, AN ERROR RECORD WILL BE  *06620016
066300*   CREATED ON THE ERROR OUTPUT FILE:                            *06630016
066400*   A) THE INVOICE STATUS IS AN OUT OF BALANCE STATUS (EITHER    *06640016
066500*      'OB' OR 'IB').  NO INVOICES ARE PROCESSED WITHOUT ERRORS  *06650016
066600*      FOR THE PO/MATCH LEVEL COMBINATION.                       *06660016
066700*   B) AN IMPORT MERCHANDISE OR REMAINDER INVOICE HAS NO IMPORT  *06670016
066800*      CHARGE PROCESS CODE.  OTHER INVOICES WITHOUT ERRORS FOR   *06680016
066900*      THAT PO/MATCH LEVEL COMBINATION WILL CONTINUE TO BE       *06690016
067000*      PROCESSED.                                                *06700016
067100*   C) A NON-EXPENSE INVOICE HAS A GROSS COST OF ZERO.  OTHER    *06710016
067200*      INVOICES WITHOUT ERRORS FOR THAT PO/MATCH LEVEL           *06720016
067300*      COMBINATION WILL CONTINUE TO BE PROCESSED.                *06730016
067400*                                                                *06740000
067410* - READ THE NEXT INVOICE.                                       *06741016
067420*                                                                *06742016
067500* NOTE: THE NO TERMS ERROR CONDITION ALSO CAUSES ERROR RECORDS   *06750016
067600*       TO BE WRITTEN FOR EACH INVOICE IN ERROR AND NO INVOICES  *06760016
067700*       WITHOUT ERRORS TO BE PROCESSED FOR THAT PO/MATCH LEVEL   *06770016
067710*       COMBINATION.                                             *06771016
067800*       THE TABLE OVERFLOW ERROR CONDITION WILL CAUSE ONLY ONE   *06780016
067900*       ERROR RECORD TO BE WRITTEN OUT AND ANY REMAINING         *06790016
068000*       INVOICES TO BE BYPASSED.                                 *06800016
068100*----------------------------------------------------------------*06810000
068200 B200-PROCESS-INVOICES.                                           06820000
068300                                                                  06830000
069740     IF INVOIC-PO-NBR = PV-SAVED-PO                               06974051
069741        IF INVOIC-MTCH-LVL-CDE = PV-SAVED-MTCH-LVL-CDE            06974151
069742           EVALUATE TRUE                                          06974251
069743             WHEN PV-SAVED-MTCH-LVL-CDE = 'P'                     06974351
069744               CONTINUE                                           06974451
069745             WHEN PV-SAVED-MTCH-LVL-CDE = 'D'                     06974551
069746               IF INVOIC-DC-NBR = PV-SAVED-LOC                    06974651
069747                  CONTINUE                                        06974751
069748               ELSE                                               06974851
069749                  PERFORM C100-PO-BREAK                           06974951
069750               END-IF                                             06975051
069751             WHEN PV-SAVED-MTCH-LVL-CDE = 'S'                     06975152
069752               IF INVOIC-STR-NBR = PV-SAVED-LOC                   06975251
069753                  CONTINUE                                        06975351
069754               ELSE                                               06975451
069755                  PERFORM C100-PO-BREAK                           06975552
069756               END-IF                                             06975654
069757             WHEN OTHER                                           06975752
069758               IF INVOIC-INVC-TYP-CDE = 'EI'                      06975852
069759                  CONTINUE                                        06975952
069760               ELSE                                               06976052
069761                  SET MTCH-LVL-INVALID TO TRUE                    06976153
069762               END-IF                                             06976252
069763           END-EVALUATE                                           06976351
069764        ELSE                                                      06976452
069765           IF (PV-SAVED-MTCH-LVL-CDE = 'P'                        06976574
069766              AND INVOIC-INVC-TYP-CDE = 'EI')                     06976674
069765           OR (INVOIC-MTCH-LVL-CDE = 'P'                          06976774
069766              AND PV-SAVED-INVC-TYP-CDE = 'EI')                   06976874
069765*          IF PV-SAVED-MTCH-LVL-CDE = 'P'                         06976974
069766*             AND INVOIC-INVC-TYP-CDE = 'EI'                      06977074
069767              CONTINUE                                            06977152
069768           ELSE                                                   06977252
069769              SET INVOICED-BY-ERROR TO TRUE                       06977352
069770           END-IF                                                 06977452
069771        END-IF                                                    06977552
069772     ELSE                                                         06977652
069773        PERFORM C100-PO-BREAK                                     06977752
069774     END-IF.                                                      06977851
069780                                                                  06978051
069800     IF INVOICED-BY-ERROR                                         06980000
069900        PERFORM C200-LOAD-INVOICE-DATA                            06990000
070000     ELSE                                                         07000000
070100        IF INVOIC-STATUS-CDE = PC-OUT-OF-BALANCE                  07010000
070200           SET INVOICE-OB-STATUS             TO TRUE              07020000
070300           PERFORM E200-FORMAT-ERROR                              07030000
070400        ELSE                                                      07040000
070500           IF INVOIC-STATUS-CDE = PC-ITEM-OUT-OF-BALANCE          07050000
070600              SET INVOICE-IB-STATUS          TO TRUE              07060000
070700              PERFORM E200-FORMAT-ERROR                           07070000
070800           ELSE                                                   07080000
070900              IF (PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF') AND   07090000
071000                 (INVOIC-INVC-TYP-CDE = 'MI' OR 'RI') AND         07100000
071100                 (MDINVC-IMPRT-CHRG-PRC-CDE = SPACES)             07110000
071200                  SET IMPORT-FIELD-NOT-VALID TO TRUE              07120016
071300                  PERFORM E200-FORMAT-ERROR                       07130016
071400              ELSE                                                07140000
071500                 IF (INVOIC-GRO-COST-AMT = 0) AND                 07150000
071600                    (INVOIC-INVC-TYP-CDE NOT = 'EI')              07160000
071700                     SET INVOICE-WITH-ZERO-COST  TO TRUE          07170016
071800                     PERFORM E200-FORMAT-ERROR                    07180016
071900                 ELSE                                             07190000
072000                     PERFORM C200-LOAD-INVOICE-DATA               07200016
072100                 END-IF                                           07210000
072200              END-IF                                              07220000
072300           END-IF                                                 07230000
072400        END-IF                                                    07240000
072500     END-IF.                                                      07250000
072600                                                                  07260000
072700     IF INVOICE-TBL-OVER-LIMIT                                    07270000
072800        IF INVOICED-BY-ERROR                                      07280000
072900           PERFORM R100-FETCH-INVOICES                            07290000
073000             UNTIL INVOIC-PO-NBR > PV-SAVED-PO                    07300017
073100                OR OUT-OF-INVOICES                                07310017
073200        ELSE                                                      07320000
073210           IF INVOIC-MTCH-LVL-CDE = 'P'                           07321057
073300              PERFORM R100-FETCH-INVOICES                         07330052
073400                UNTIL INVOIC-PO-NBR > PV-SAVED-PO                 07340057
073700                   OR OUT-OF-INVOICES                             07370052
073710           ELSE                                                   07371052
073711               IF INVOIC-MTCH-LVL-CDE = 'S'                       07371157
073712                  PERFORM R100-FETCH-INVOICES                     07371257
073713                    UNTIL (INVOIC-PO-NBR > PV-SAVED-PO            07371357
073714                       OR (INVOIC-PO-NBR = PV-SAVED-PO            07371457
073715                           AND INVOIC-STR-NBR > PV-SAVED-LOC))    07371557
073716                       OR OUT-OF-INVOICES                         07371657
073717               ELSE                                               07371757
073718                  PERFORM R100-FETCH-INVOICES                     07371857
073719                    UNTIL (INVOIC-PO-NBR > PV-SAVED-PO            07371957
073720                       OR (INVOIC-PO-NBR = PV-SAVED-PO            07372057
073721                           AND INVOIC-DC-NBR > PV-SAVED-LOC))     07372157
073722                       OR OUT-OF-INVOICES                         07372257
073730               END-IF                                             07373057
073740           END-IF                                                 07374057
073800        END-IF                                                    07380000
073900     ELSE                                                         07390000
074000        PERFORM R100-FETCH-INVOICES                               07400000
074100     END-IF.                                                      07410000
074200                                                                  07420013
074300*----------------------------------------------------------------*07430000
074400* WRITES OUT LAST PO/MATCH LEVEL COMBINATION TO EITHER THE       *07440016
074500* EXTRACT OR ERROR FILE, DISPLAYS COUNTS, AND CLOSES FILES.      *07450016
074700*----------------------------------------------------------------*07470000
074800 B300-END-PROGRAM.                                                07480000
074900                                                                  07490000
075000     IF LOAD-INVOICES                                             07500000
075100        PERFORM R500-SELECT-VENDOR-DATA                           07510000
075200** 02-26-99 - ADDED VALID-PO-STR ADDITIONAL CONDITION             07520000
075300**            STATEMENT SO IF THE LAST PO IN FILE IS LOCATED ON   07530000
075400**            THE TPOSTRR DB2 TABLE IT WILL NOT BE WRITTEN TO THE 07540000
075500**            OUTPUT.                                             07550000
075600        IF ((NO-ERRORS AND NO-INVOICE-TBL-LIMIT-ERR)              07560016
075800             OR INVOICE-WITH-ZERO-COST                            07580016
075900             OR IMPORT-FIELD-NOT-VALID)                           07590016
076000             AND VALID-PO-MTCH                                    07600016
076100           PERFORM D100-PREPARE-INVOICE-EXTRACT                   07610000
076200               VARYING IA-SUB FROM 1 BY 1                         07620000
076300               UNTIL IA-SUB > IA-SUB-MAX                          07630000
076400           IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'            07640000
076500              ADD 1 TO PA-IMPORT-COUNT                            07650000
076600           ELSE                                                   07660000
076700              ADD 1 TO PA-PO-MTCH-COUNT                           07670016
076800           END-IF                                                 07680000
076900        ELSE                                                      07690000
077000           IF INVOICED-BY-ERROR                                   07700000
077100              PERFORM E300-FORMAT-INVCD-ERROR                     07710000
077200                  VARYING IA-SUB FROM 1 BY 1                      07720000
077300                  UNTIL IA-SUB > IA-SUB-MAX                       07730000
077400           END-IF                                                 07740000
077500        END-IF                                                    07750000
077600     END-IF.                                                      07760000
077700                                                                  07770000
077800     DISPLAY 'PO/MATCH PROCESSED          = ' PA-PO-MTCH-COUNT.   07780016
077900     DISPLAY 'IMPORT PO/STORES PROCESSED  = ' PA-IMPORT-COUNT.    07790000
078000     DISPLAY 'ERRORS ENCOUNTERED          = ' PA-ERROR-COUNT.     07800000
078100                                                                  07810000
078200     PERFORM Y110-CLOSE-INVOICES-CSR.                             07820000
078400     CLOSE INVOICE-EXTRACT-FILE                                   07840000
078500           IMPORT-EXTRACT-FILE                                    07850000
078600           ERROR-FILE.                                            07860000
078700                                                                  07870013
078800*----------------------------------------------------------------*07880000
078900* WRITES OUT THE INVOICE EXTRACT FILE OR THE ERROR FILE AND      *07890016
079000* CALLS ROUTINES TO PREPARE FOR THE NEXT VALID PO/MATCH LEVEL    *07900016
079010* COMBINATION.                                                   *07901016
079100*----------------------------------------------------------------*07910000
079200 C100-PO-BREAK.                                                   07920016
079300                                                                  07930000
079400     IF LOAD-INVOICES                                             07940000
079500        IF (NO-ERRORS AND NO-INVOICE-TBL-LIMIT-ERR)               07950013
079700            OR INVOICE-WITH-ZERO-COST                             07970013
079800            OR IMPORT-FIELD-NOT-VALID                             07980013
079900            PERFORM D100-PREPARE-INVOICE-EXTRACT                  07990013
080000             VARYING IA-SUB FROM 1 BY 1                           08000013
080100               UNTIL IA-SUB > IA-SUB-MAX                          08010000
080200            IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'           08020013
080300               ADD 1 TO PA-IMPORT-COUNT                           08030013
080400            ELSE                                                  08040013
080500               ADD 1 TO PA-PO-MTCH-COUNT                          08050018
080600            END-IF                                                08060013
080700        ELSE                                                      08070000
080800           IF INVOICED-BY-ERROR                                   08080000
080900              PERFORM E300-FORMAT-INVCD-ERROR                     08090000
081000                  VARYING IA-SUB FROM 1 BY 1                      08100000
081100                  UNTIL IA-SUB > IA-SUB-MAX                       08110000
081200           END-IF                                                 08120000
081300        END-IF                                                    08130000
081400     END-IF.                                                      08140000
081500                                                                  08150000
081600     SET INVALID-PO-MTCH           TO TRUE.                       08160016
081700     PERFORM E100-VALIDATE-PO-MTCH                                08170016
081800       UNTIL VALID-PO-MTCH                                        08180016
081900          OR OUT-OF-INVOICES.                                     08190013
082000                                                                  08200000
082700     PERFORM                                                      08270000
082800       VARYING IA-SUB FROM 1 BY 1                                 08280016
082900         UNTIL IA-SUB > IA-SUB-LIMIT OR                           08290016
083000               IA-SUB > IA-SUB-MAX                                08300016
083100       INITIALIZE IA-INVOICES (IA-SUB)                            08310016
083200     END-PERFORM.                                                 08320000
083300                                                                  08330000
083400     MOVE ZEROS         TO IA-SUB                                 08340000
083500                           IA-SUB-MAX                             08350000
083600                           PV-TERMS-DISC-PCT                      08360000
083700                           PV-TERMS-DUE-DAY-QTY                   08370000
083800                           PV-TERMS-EXT-DAY-QTY.                  08380000
083900     MOVE SPACES        TO PS-END-OF-MONTH-SW                     08390000
084000                           PV-TERMS-SEL-CDE.                      08400000
084200     MOVE 'N'           TO PV-SAVED-BM-FLG                        08420016
084300                           PV-SAVED-NOT-BM-FLG.                   08430004
084400                                                                  08440000
084500     SET NO-INVOICE-TBL-LIMIT-ERR                                 08450000
084600         NO-ERRORS      TO TRUE.                                  08460000
084700                                                                  08470000
084800     IF INVOIC-PO-NBR  NOT = PV-SAVED-VEND-CH-PO                  08480000
084900        PERFORM R500-SELECT-VENDOR-DATA                           08490016
085000     END-IF.                                                      08500000
085100     MOVE INVOIC-PO-NBR TO PV-SAVED-VEND-CH-PO.                   08510000
085200                                                                  08520013
085360*----------------------------------------------------------------*08536000
085400* LOADS THE INTERNAL INVOICE ARRAY WITH RELEVANT INVOICE DATA.   *08540014
085500*----------------------------------------------------------------*08550000
085600 C200-LOAD-INVOICE-DATA.                                          08560000
085700                                                                  08570000
085800     ADD 1 TO IA-SUB                                              08580000
085900              IA-SUB-MAX.                                         08590000
086000                                                                  08600000
086100     IF IA-SUB-MAX > IA-SUB-LIMIT                                 08610000
086200        SET INVOICE-TBL-OVER-LIMIT      TO TRUE                   08620000
086300        PERFORM E200-FORMAT-ERROR                                 08630000
086400     ELSE                                                         08640000
086500        IF LOAD-INVOICES                                          08650000
086600           EVALUATE TRUE                                          08660000
086700             WHEN MDINVC-TERM-SEL-CDE = 'P'                       08670000
086800               PERFORM D200-PROCESS-PO-TERMS                      08680014
086900             WHEN MDINVC-TERM-SEL-CDE = 'I'                       08690000
087000               PERFORM D300-PROCESS-INVOICE-TERMS                 08700014
087100           END-EVALUATE                                           08710000
087200           IF (PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF') AND      08720000
087300              (INVOIC-INVC-TYP-CDE NOT = 'EI')                    08730000
087400               PERFORM D400-GET-DISCOUNT-AMTS                     08740014
087500           END-IF                                                 08750000
087600           IF LOAD-INVOICES                                       08760000
087700              MOVE INVOIC-INVC-ID       TO IA-INVOICE-ID(IA-SUB)  08770013
087800              MOVE INVOIC-INVC-TYP-CDE  TO IA-INVOICE-TYPE(IA-SUB)08780000
087900              MOVE INVOIC-STATUS-CDE  TO IA-INVOICE-STATUS(IA-SUB)08790000
088000              MOVE INVOIC-INVC-DTE      TO IA-INVOICE-DATE(IA-SUB)08800000
088100              MOVE INVOIC-ENTR-MTHD-CDE TO IA-ENTRY-METHOD(IA-SUB)08810000
088200              MOVE INVOIC-GRO-COST-AMT                            08820016
088300                TO IA-GROSS-COST-AMT(IA-SUB)                      08830013
088400              MOVE INVOIC-PAYT-REQ-SEQ-NBR                        08840000
088500                TO IA-PAYT-REQ-SEQ-NBR(IA-SUB)                    08850013
088600              MOVE INVOIC-CRE-DTE       TO IA-ENTRY-DATE(IA-SUB)  08860013
088700              MOVE INVOIC-DTL-ENTR-IND  TO IA-DTL-ENTR-IND(IA-SUB)08870000
088710              MOVE INVOIC-DC-NBR        TO IA-DC-NBR(IA-SUB)      08871013
088720              MOVE INVOIC-MTCH-LVL-CDE  TO IA-MTCH-LVL-CDE(IA-SUB)08872013
088730              IF IA-MTCH-LVL-CDE(IA-SUB) = 'P'                    08873029
088740                 MOVE ZEROS             TO IA-MTCH-LOC-NBR(IA-SUB)08874013
088750              ELSE                                                08875013
088760                 IF IA-MTCH-LVL-CDE(IA-SUB) = 'S'                 08876029
088770                    MOVE INVOIC-STR-NBR TO IA-MTCH-LOC-NBR(IA-SUB)08877013
088780                 ELSE                                             08878013
088781                    IF IA-MTCH-LVL-CDE(IA-SUB) = 'D'              08878129
088790                       MOVE INVOIC-DC-NBR                         08879027
088791                         TO IA-MTCH-LOC-NBR(IA-SUB)               08879127
088792                    END-IF                                        08879227
088793                 END-IF                                           08879313
088794              END-IF                                              08879413
088800              MOVE PV-TERMS-SEL-CDE   TO IA-TERMS-SEL-CDE(IA-SUB) 08880014
088900              MOVE PV-TERMS-DISC-PCT  TO IA-TERMS-DISC-PCT(IA-SUB)08890000
089000              MOVE PV-TERMS-DUE-DAY-QTY                           08900013
089100                TO IA-TERMS-DUE-DAY-QTY(IA-SUB)                   08910013
089200              MOVE PV-TERMS-EXT-DAY-QTY                           08920013
089300                TO IA-TERMS-EXT-DAY-QTY(IA-SUB)                   08930013
089400              MOVE PS-END-OF-MONTH-SW TO IA-EOM-INDICATOR(IA-SUB) 08940014
089500              IF INVOIC-INVC-TYP-CDE NOT = 'EI'                   08950000
089600                 MOVE INVOIC-STR-NBR  TO IA-STR-NBR(IA-SUB)       08960014
089700                 MOVE MDINVC-TOT-INVC-PC-QTY                      08970000
089800                   TO IA-TOT-INVOICE-QTY(IA-SUB)                  08980013
089900                 MOVE INVOIC-CRE-BY-USR-ID                        08990000
090000                   TO IA-ENTER-USERID(IA-SUB)                     09000013
090100                 MOVE INVOIC-INVC-NET-COST-AMT                    09010000
090200                   TO IA-NET-COST-AMT(IA-SUB)                     09020013
090300                 MOVE ZEROS           TO IA-DUE-DATE(IA-SUB)      09030014
090400                                         IA-CUTOFF-DATE(IA-SUB)   09040014
090500                 MOVE SPACES         TO IA-STATUS-CHG-DATE(IA-SUB)09050000
090600                                        IA-PAYMENT-DUE-SW(IA-SUB) 09060013
090700                                        IA-DUE-DTE-SRC-CDE(IA-SUB)09070000
090800                                        IA-INVOICE-INCL-SW(IA-SUB)09080000
090900                                        IA-HOLD-IND(IA-SUB)       09090013
091000              END-IF                                              09100000
091100              IF (PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF')       09110004
091200                 AND INVOIC-INVC-TYP-CDE = 'MI'                   09120016
091300                 IF IA-INVOICE-STATUS(IA-SUB) = 'BM'              09130004
091400                    MOVE 'Y' TO PV-SAVED-BM-FLG                   09140004
091500                 ELSE                                             09150004
091600                    MOVE 'Y' TO PV-SAVED-NOT-BM-FLG               09160047
091700                 END-IF                                           09170004
091800              END-IF                                              09180004
091800              SET IA-SEPHORA-VND-NO(IA-SUB) TO TRUE               09180164
091800              SET IA-SEPHORA-DPT-NO(IA-SUB) TO TRUE               09180264
091800              EVALUATE TRUE                                       09181067
091800                 WHEN PS-SEPHORA-OTHER                            09181171
091800                    SET IA-SEPHORA-VND-YES(IA-SUB)  TO TRUE       09181264
091800                 WHEN PS-SEPHORA-AT-KOHLS                         09181364
091800                    SET IA-SEPHORA-DPT-YES(IA-SUB)  TO TRUE       09181464
091800                    SET IA-SEPHORA-VND-YES(IA-SUB)  TO TRUE       09181571
091800              END-EVALUATE                                        09182064
091900           END-IF                                                 09190004
092000        END-IF                                                    09200004
092100     END-IF.                                                      09210004
092200                                                                  09220000
092400*----------------------------------------------------------------*09240000
092500* PREPARES THE BATCH MATCH INVOICE EXTRACT FILE.                 *09250014
092600*----------------------------------------------------------------*09260000
092700 D100-PREPARE-INVOICE-EXTRACT.                                    09270000
092800                                                                  09280000
092900     INITIALIZE AP060-INVOICE-EXTRACT.                            09290000
093000                                                                  09300000
093100     MOVE ENTNME-ENT-NAME-DESC         TO AP060-VENDOR-NAME.      09310000
093200     MOVE ENTNME-ENT-ID                TO AP060-ENT-ID.           09320000
093300     MOVE EXTENT-DUN-NBR               TO AP060-VENDOR-NUMBER.    09330000
093400     MOVE PURCHS-PO-TYP-CDE            TO AP060-PO-TYP-CDE.       09340000
093500                                                                  09350000
093600     MOVE PV-SAVED-PO                  TO AP060-PO-NBR.           09360000
093701     MOVE IA-STR-NBR(IA-SUB)           TO AP060-STR-NBR.          09370134
093800                                                                  09380000
093900     MOVE IA-INVOICE-ID(IA-SUB)        TO AP060-INVOICE-NUMBER.   09390013
094000     MOVE IA-INVOICE-TYPE(IA-SUB)      TO AP060-INVOICE-TYPE.     09400013
094100     MOVE IA-INVOICE-STATUS(IA-SUB)    TO AP060-INVOICE-STATUS.   09410013
094200     MOVE IA-INVOICE-DATE(IA-SUB)      TO AP060-INVOICE-DATE.     09420013
094300     MOVE IA-ENTRY-METHOD(IA-SUB)      TO AP060-ENTRY-METHOD.     09430013
094400     MOVE IA-GROSS-COST-AMT(IA-SUB)    TO AP060-GROSS-COST-AMT.   09440013
094500     MOVE IA-TOT-INVOICE-QTY(IA-SUB)   TO AP060-TOT-INVOICE-QTY.  09450013
094600     MOVE IA-PAYT-REQ-SEQ-NBR(IA-SUB)  TO AP060-PAYT-REQ-SEQ-NBR. 09460013
094700     MOVE IA-ENTRY-DATE(IA-SUB)        TO AP060-ENTRY-DATE.       09470013
094800     MOVE IA-DTL-ENTR-IND(IA-SUB)      TO AP060-DTL-ENTR-IND.     09480013
094900     MOVE IA-DUE-DATE(IA-SUB)          TO AP060-DUE-DATE.         09490013
095000     MOVE IA-CUTOFF-DATE(IA-SUB)       TO AP060-CUTOFF-DATE.      09500013
095100     MOVE IA-TERMS-SEL-CDE(IA-SUB)     TO AP060-TERMS-SEL-CDE.    09510013
095200     MOVE IA-TERMS-DISC-PCT(IA-SUB)    TO AP060-TERMS-DISC-PCT.   09520013
095300     MOVE IA-TERMS-DUE-DAY-QTY(IA-SUB) TO AP060-TERMS-DUE-DAY-QTY.09530000
095400     MOVE IA-TERMS-EXT-DAY-QTY(IA-SUB) TO AP060-TERMS-EXT-DAY-QTY.09540000
095500     MOVE IA-EOM-INDICATOR(IA-SUB)     TO AP060-EOM-INDICATOR.    09550013
095600     MOVE IA-PAYMENT-DUE-SW(IA-SUB)    TO AP060-PAYMENT-DUE-SW.   09560013
095700     MOVE IA-DUE-DTE-SRC-CDE(IA-SUB)   TO AP060-DUE-DTE-SRC-CDE.  09570013
095800     MOVE IA-NET-COST-AMT(IA-SUB)      TO AP060-NET-COST-AMT.     09580013
095900     MOVE SPACES                       TO AP060-CRE-PRC-CDE.      09590000
095910     MOVE IA-DC-NBR(IA-SUB)            TO AP060-DC-NBR.           09591013
095920     MOVE IA-MTCH-LVL-CDE(IA-SUB)      TO AP060-MTCH-LVL-CDE.     09592013
095930     MOVE IA-MTCH-LOC-NBR(IA-SUB)      TO AP060-MTCH-LOC-NBR.     09593013
095930     MOVE IA-SEPHORA-VND-IND(IA-SUB)   TO AP060-SEPHORA-VND-IND.  09594064
095930     MOVE IA-SEPHORA-DPT-IND(IA-SUB)   TO AP060-SEPHORA-DPT-IND.  09595064
096000                                                                  09600000
096100     IF PURCHS-PO-TYP-CDE = 'IM' OR 'IE' OR 'IF'                  09610000
096200        IF IA-MERCHANDISE-INVOICE (IA-SUB)                        09620004
096300           PERFORM D500-VALIDATE-MI-IMPORT                        09630004
096400           IF IMPORT-EXTRACT-ALLOWED                              09640004
096500              PERFORM W300-WRITE-IMPORT-EXT                       09650004
096600           END-IF                                                 09660004
096700        ELSE                                                      09670004
096800           IF IA-REMAINDER-INVOICE (IA-SUB)                       09680004
096900              OR IA-EXPENSE-INVOICE (IA-SUB)                      09690014
097000                 PERFORM W300-WRITE-IMPORT-EXT                    09700014
097100           END-IF                                                 09710004
097200        END-IF                                                    09720004
097300        IF (IA-MERCHANDISE-INVOICE (IA-SUB)                       09730004
097400            AND BATCH-MATCH-ALLOWED)                              09740014
097500             OR IA-WRITEOFF-INVOICE (IA-SUB)                      09750014
097600                PERFORM W100-WRITE-INVOICE-EXT                    09760014
097700                ADD 1 TO PA-PO-MTCH-COUNT                         09770018
097800        END-IF                                                    09780004
097900     ELSE                                                         09790000
098000        PERFORM W100-WRITE-INVOICE-EXT                            09800000
098100     END-IF.                                                      09810000
098200                                                                  09820014
098300*----------------------------------------------------------------*09830000
098400* MOVES TERMS RELATED FIELDS FROM TABLE AREAS TO WORKING STORAGE *09840014
098500* WHEN PO TERMS ARE INDICATED.                                   *09850014
098600*----------------------------------------------------------------*09860000
098700 D200-PROCESS-PO-TERMS.                                           09870000
098800                                                                  09880000
098900     PERFORM R300-SELECT-PO-TERMS.                                09890000
099000                                                                  09900000
099100     IF NO-PO-TERMS                                               09910000
099200        PERFORM E200-FORMAT-ERROR                                 09920014
099300     ELSE                                                         09930000
099400        IF PAYTRM-DUE-DAY-FR-DTE-TXT = 'EOM'                      09940014
099500           SET END-OF-MONTH              TO TRUE                  09950014
099600        ELSE                                                      09960014
099700           SET NOT-END-OF-MONTH          TO TRUE                  09970014
099800        END-IF                                                    09980014
099900                                                                  09990000
100000        IF PAYTRM-DISCOUNT-PCT = 0                                10000014
100100           MOVE PAYTRM-DUE-DAY-QTY       TO PV-TERMS-DUE-DAY-QTY  10010014
100200        ELSE                                                      10020014
100300           MOVE PAYTRM-DISCOUNT-DAYS-QTY TO PV-TERMS-DUE-DAY-QTY  10030014
100500        END-IF                                                    10050014
100600                                                                  10060000
100700        MOVE POAGMT-DISC-PAY-DAY-QTY     TO PV-TERMS-EXT-DAY-QTY  10070014
100900        MOVE PAYTRM-DISCOUNT-PCT         TO PV-TERMS-DISC-PCT     10090014
101000        MOVE MDINVC-TERM-SEL-CDE         TO PV-TERMS-SEL-CDE      10100014
101100     END-IF.                                                      10110000
101200                                                                  10120000
101400*----------------------------------------------------------------*10140000
101500* MOVES TERMS RELATED FIELDS FROM TABLE AREAS TO WORKING STORAGE *10150014
101600* WHEN INVOICE TERMS ARE INDICATED.                              *10160014
101700*----------------------------------------------------------------*10170000
101800 D300-PROCESS-INVOICE-TERMS.                                      10180000
101900                                                                  10190000
102000     PERFORM R400-SELECT-INVOICE-TERMS.                           10200000
102100                                                                  10210000
102200     IF NO-INV-TERMS                                              10220000
102300        PERFORM E200-FORMAT-ERROR                                 10230014
102400     ELSE                                                         10240000
102500        IF INVCTM-TERM-TYP-CDE = '02'                             10250014
102600           SET END-OF-MONTH             TO TRUE                   10260014
102700        ELSE                                                      10270014
102800           SET NOT-END-OF-MONTH         TO TRUE                   10280014
102900        END-IF                                                    10290014
103000                                                                  10300000
103100        IF INVCTM-DISC-PCT = 0                                    10310014
103200           MOVE INVCTM-NET-DUE-DAY-QTY  TO PV-TERMS-DUE-DAY-QTY   10320014
103400        ELSE                                                      10340014
103500           MOVE INVCTM-DISC-DUE-DAY-QTY TO PV-TERMS-DUE-DAY-QTY   10350014
103700        END-IF                                                    10370014
103800                                                                  10380000
103900        MOVE INVCTM-EXTD-DAYS-QTY       TO PV-TERMS-EXT-DAY-QTY   10390014
104100        MOVE INVCTM-DISC-PCT            TO PV-TERMS-DISC-PCT      10410014
104200        MOVE MDINVC-TERM-SEL-CDE        TO PV-TERMS-SEL-CDE       10420014
104300     END-IF.                                                      10430000
104400                                                                  10440014
104500*----------------------------------------------------------------*10450000
104600* ACCUMULATE THE DISCOUNT AMOUNT FOR EACH INVOICE.               *10460014
104700*----------------------------------------------------------------*10470000
104800 D400-GET-DISCOUNT-AMTS.                                          10480000
104900                                                                  10490000
105000     SET MORE-IMPORT-DISCOUNTS TO TRUE.                           10500000
105100                                                                  10510000
105200     PERFORM Y300-OPEN-IMPORT-DISCOUNT-CSR.                       10520000
105300     PERFORM R600-FETCH-IMPORT-DISCOUNT-CSR.                      10530000
105400                                                                  10540000
105500     INITIALIZE APPD052-VARIABLES.                                10550000
105600     MOVE INVOIC-GRO-COST-AMT                                     10560000
105700          TO APPD052-GROSS-INVOICE-COST.                          10570000
105800                                                                  10580000
105900     PERFORM WITH TEST BEFORE                                     10590000
106000       UNTIL END-OF-IMPORT-DISCOUNTS                              10600000
106100         PERFORM CALC-ALW-CHRG                                    10610000
106200         PERFORM R600-FETCH-IMPORT-DISCOUNT-CSR                   10620000
106300     END-PERFORM.                                                 10630000
106400                                                                  10640000
106500     SUBTRACT APPD052-ALLOWANCE-AMT FROM                          10650000
106600                            INVOIC-INVC-NET-COST-AMT.             10660000
107100     PERFORM Y310-CLOSE-IMPORT-DISCOUNT-CSR.                      10710000
107200                                                                  10720000
107300     COPY APPD052.                                                10730000
107400                                                                  10740014
107500*--------------------------------------------------------------*  10750014
107600* DETERMINE IF AN MI QUALIFIES TO BE INCLUDED ON THE IMPORT    *  10760014
107700* EXTRACT FILE AND IF A BATCH MATCH MI QUALIFIES TO BE         *  10770014
107800* INCLUDED ON THE MAIN EXTRACT FILE.                           *  10780014
107900*--------------------------------------------------------------*  10790014
108000 D500-VALIDATE-MI-IMPORT.                                         10800004
108100                                                                  10810004
108200     MOVE 'N'                 TO PS-IMPORT-EXTRACT-SW.            10820014
108300     MOVE 'N'                 TO PS-BATCH-MATCH-ALLOWED-SW.       10830014
108400                                                                  10840004
108500     IF PV-SAVED-BM-FLG = 'Y' AND PV-SAVED-NOT-BM-FLG = 'Y'       10850014
108700        MOVE 'Y'              TO PS-IMPORT-EXTRACT-SW             10870014
108800        IF PV-SAVED-BM-FLG = 'Y'                                  10880014
108900           MOVE 'N'           TO PS-BATCH-MATCH-ALLOWED-SW        10890014
109000        END-IF                                                    10900014
109100     ELSE                                                         10910004
109200        MOVE 'Y'              TO PS-IMPORT-EXTRACT-SW             10920014
109300        IF PV-SAVED-BM-FLG = 'Y'                                  10930004
109400           MOVE 'Y'           TO PS-BATCH-MATCH-ALLOWED-SW        10940014
109500        END-IF                                                    10950004
109600     END-IF.                                                      10960004
109700                                                                  10970004
109900*----------------------------------------------------------------*10990000
110000* READS THE TABLES UNTIL A PO/MATCH LEVEL COMBINATION IS         *11000015
110100* RETRIEVED THAT HAS NOT BEEN PAY RELEASED.                      *11010015
110200*----------------------------------------------------------------*11020000
110300 E100-VALIDATE-PO-MTCH.                                           11030015
110400                                                                  11040000
110500     MOVE INVOIC-PO-NBR             TO PV-SAVED-PO.               11050000
110500     MOVE INVOIC-INVC-TYP-CDE       TO PV-SAVED-INVC-TYP-CDE.     11050174
110510     IF INVOIC-MTCH-LVL-CDE = 'P'                                 11051040
110520        MOVE ZEROS                  TO PV-SAVED-STR               11052040
110521                                       PV-SAVED-LOC               11052152
110530     ELSE                                                         11053040
110540        IF INVOIC-MTCH-LVL-CDE = 'S'                              11054040
110600           MOVE INVOIC-STR-NBR      TO PV-SAVED-STR               11060040
110601                                       PV-SAVED-LOC               11060152
110602        ELSE                                                      11060240
110603           MOVE INVOIC-DC-NBR       TO PV-SAVED-STR               11060340
110604                                       PV-SAVED-LOC               11060452
110605        END-IF                                                    11060540
110606     END-IF.                                                      11060615
110610     MOVE INVOIC-MTCH-LVL-CDE       TO PV-SAVED-MTCH-LVL-CDE.     11061014
110700                                                                  11070000
110800     SET PO-NOT-FOUND          TO TRUE.                           11080000
110900     PERFORM R200-CHECK-FOR-PO-MTCH.                              11090015
111000                                                                  11100000
111100     IF PO-FOUND                                                  11110000
111200        DISPLAY 'ROW ON TPOSTRR FOR'                              11120013
111300        DISPLAY 'PO: ' PV-SAVED-PO                                11130013
111400        DISPLAY 'STORE/DC: ' PV-SAVED-STR                         11140016
111410        DISPLAY 'MATCH LEVEL: ' PV-SAVED-MTCH-LVL-CDE             11141016
111420        IF INVOIC-MTCH-LVL-CDE = 'P'                              11142057
111421           PERFORM R100-FETCH-INVOICES                            11142152
111422             UNTIL (INVOIC-PO-NBR NOT = PV-SAVED-PO)              11142252
111423                OR (INVOIC-MTCH-LVL-CDE NOT =                     11142354
111424                    PV-SAVED-MTCH-LVL-CDE)                        11142452
111426                OR OUT-OF-INVOICES                                11142652
111427        ELSE                                                      11142757
111428            IF INVOIC-MTCH-LVL-CDE = 'S'                          11142857
111429               PERFORM R100-FETCH-INVOICES                        11142957
111430                 UNTIL (INVOIC-PO-NBR NOT = PV-SAVED-PO)          11143057
111431                    OR (INVOIC-MTCH-LVL-CDE NOT =                 11143157
111432                        PV-SAVED-MTCH-LVL-CDE)                    11143257
111433                    OR (INVOIC-STR-NBR NOT = PV-SAVED-LOC)        11143357
111434                    OR OUT-OF-INVOICES                            11143457
111440            ELSE                                                  11144057
111500               PERFORM R100-FETCH-INVOICES                        11150057
111600                  UNTIL (INVOIC-PO-NBR NOT = PV-SAVED-PO)         11160057
111700                     OR (INVOIC-MTCH-LVL-CDE NOT =                11170057
111710                         PV-SAVED-MTCH-LVL-CDE)                   11171057
111800                     OR (INVOIC-DC-NBR NOT = PV-SAVED-LOC)        11180057
111810                     OR OUT-OF-INVOICES                           11181057
111820            END-IF                                                11182057
111830        END-IF                                                    11183057
111900     ELSE                                                         11190000
112000        SET VALID-PO-MTCH     TO TRUE                             11200015
112100     END-IF.                                                      11210000
112200                                                                  11220013
112310*----------------------------------------------------------------*11231000
112400* PREPARES THE FIELDS FOR THE ERROR REPORT                       *11240014
112500*----------------------------------------------------------------*11250000
112600 E200-FORMAT-ERROR.                                               11260000
112700                                                                  11270000
112800     PERFORM R500-SELECT-VENDOR-DATA.                             11280000
112900                                                                  11290000
113000     MOVE ENTNME-ENT-NAME-DESC     TO AP059-VENDOR-NAME.          11300016
113100     MOVE EXTENT-DUN-NBR           TO AP059-VENDOR-NUMBER.        11310016
113300     MOVE PV-SAVED-PO              TO AP059-PO-NBR.               11330016
113400     MOVE PV-SAVED-STR             TO AP059-STR-NBR.              11340016
113500                                                                  11350000
113600     IF INVOICE-TBL-OVER-LIMIT                                    11360000
113700        MOVE PS-INVOICE-TBL-ERR-SW TO AP059-REASON-CODE           11370000
113800     ELSE                                                         11380000
113900        MOVE PS-ERROR-SW           TO AP059-REASON-CODE           11390000
114000     END-IF.                                                      11400000
114200     IF INVOICE-TBL-OVER-LIMIT                                    11420000
114300         MOVE SPACES               TO AP059-INVOICE-ID            11430016
114400                                      AP059-ENTER-USERID          11440016
114500     ELSE                                                         11450000
114600         MOVE INVOIC-INVC-ID       TO AP059-INVOICE-ID            11460000
114700         MOVE INVOIC-CRE-BY-USR-ID TO AP059-ENTER-USERID          11470000
114800     END-IF.                                                      11480000
114900                                                                  11490000
115000     ADD 1                         TO PA-ERROR-COUNT.             11500016
115100     PERFORM W200-WRITE-ERROR.                                    11510000
115200                                                                  11520014
115300*----------------------------------------------------------------*11530000
115400* MOVES INVOICE FIELDS FROM THE INTERNAL TABLE TO ERROR FIELDS   *11540014
115500* AND WRITES OUT ERROR RECORD FOR EACH INVOICE.                  *11550014
115600*----------------------------------------------------------------*11560000
115700 E300-FORMAT-INVCD-ERROR.                                         11570000
115800                                                                  11580000
115900     MOVE ENTNME-ENT-NAME-DESC       TO AP059-VENDOR-NAME.        11590000
116000     MOVE EXTENT-DUN-NBR             TO AP059-VENDOR-NUMBER.      11600000
116100                                                                  11610000
116200     MOVE PV-SAVED-PO                TO AP059-PO-NBR.             11620000
116300     MOVE PS-ERROR-SW                TO AP059-REASON-CODE.        11630000
116400     MOVE IA-STR-NBR(IA-SUB)         TO AP059-STR-NBR.            11640014
116500     MOVE IA-INVOICE-ID(IA-SUB)      TO AP059-INVOICE-ID.         11650014
116600     MOVE IA-ENTER-USERID(IA-SUB)    TO AP059-ENTER-USERID.       11660014
116610     MOVE IA-DC-NBR(IA-SUB)          TO AP059-DC-NBR.             11661046
116620     MOVE IA-MTCH-LVL-CDE(IA-SUB)    TO AP059-MTCH-LVL-CDE.       11662046
116700                                                                  11670000
116800     ADD 1                           TO PA-ERROR-COUNT.           11680000
116900     PERFORM W200-WRITE-ERROR.                                    11690000
117000                                                                  11700014
117100*----------------------------------------------------------------*11710000
117200*  RETRIEVES THE INVOICES ELIGIBLE FOR BATCH MATCH CONSIDERATION *11720000
117300*  NOTE:  A NOT FOUND CONDITION IN THIS INSTANCE RESULTS IN      *11730000
117400*         THE OUT OF INVOICES SWITCH BEING SET.                  *11740000
117500*----------------------------------------------------------------*11750000
117600 R100-FETCH-INVOICES.                                             11760000
117700                                                                  11770000
117800     EXEC SQL                                                     11780000
117900         FETCH INVOICES_CSR                                       11790000
118000         INTO :INVOIC-PO-NBR                                      11800000
118100             ,:INVOIC-STR-NBR                                     11810000
118200             ,:INVOIC-INVC-ID                                     11820000
118300             ,:INVOIC-INVC-TYP-CDE                                11830000
118400             ,:INVOIC-STATUS-CDE                                  11840000
118500             ,:INVOIC-INVC-DTE                                    11850000
118600             ,:INVOIC-ENTR-MTHD-CDE                               11860000
118700             ,:INVOIC-GRO-COST-AMT                                11870000
118800             ,:INVOIC-DTL-ENTR-IND                                11880000
118900             ,:MDINVC-TERM-SEL-CDE                                11890000
119000             ,:MDINVC-TOT-INVC-PC-QTY                             11900000
119100             ,:MDINVC-IMPRT-CHRG-PRC-CDE                          11910000
119200             ,:INVOIC-PAYT-REQ-SEQ-NBR                            11920000
119300             ,:INVOIC-CRE-DTE                                     11930000
119400             ,:INVOIC-CRE-BY-USR-ID                               11940000
119500             ,:INVOIC-INVC-NET-COST-AMT                           11950000
119510             ,:INVOIC-DC-NBR                                      11951013
119520             ,:INVOIC-MTCH-LVL-CDE                                11952013
119600     END-EXEC.                                                    11960000
119700                                                                  11970000
119800     EVALUATE TRUE                                                11980000
119900         WHEN SQLCODE = ZERO                                      11990000
120000              CONTINUE                                            12000000
120100                                                                  12010000
120200         WHEN SQLCODE = +100                                      12020000
120300              SET OUT-OF-INVOICES TO TRUE                         12030000
120500         WHEN SQLWARN0 NOT = SPACES                               12050000
120600         WHEN SQLCODE  NOT = ZERO                                 12060000
120700             MOVE 'R100-FETCH-INVOICES'    TO AA-PARAGRAPH-NAME   12070000
120800             MOVE 'UNSUCCESSFUL FETCH WITH INVOICES_CSR'          12080000
120900                                           TO AA-DB2-OPERATION    12090000
121000             MOVE 'TINVOIC'                TO AA-DB2-TABLE-1      12100000
121100             MOVE 'TMDINVC'                TO AA-DB2-TABLE-2      12110000
121200             MOVE SPACES                   TO AA-DB2-TABLE-3      12120000
121300             PERFORM Z998-DB2-ABEND                               12130000
121400     END-EVALUATE.                                                12140000
121500                                                                  12150013
121600*----------------------------------------------------------------*12160000
121610* CHECKS THAT THE PO/STORE/MATCH LEVEL OR PO/DC/MATCH LEVEL      *12161016
121620* COMBINATION DOES NOT ALREADY EXIST ON THE TPOSTRR TABLE.  IF   *12162016
121700* IT DOES, THE PO/STORE OR PO/DC IS NOT A CANDIDATE FOR THE      *12170016
121701* BATCH MATCH PROCESS.                                           *12170116
122000* NOTE: A NOT FOUND CONDITION IN THIS INSTANCE MEANS THERE IS    *12200013
122100*       NOT A PAY RELEASE ALREADY IN PROCESS.                    *12210013
122200*----------------------------------------------------------------*12220000
122300 R200-CHECK-FOR-PO-MTCH.                                          12230015
122400                                                                  12240000
122500     EXEC SQL                                                     12250000
122600         SELECT                                                   12260000
122700             PO_NBR                                               12270000
122800         INTO                                                     12280000
122900             :POSTRR-PO-NBR                                       12290000
123000         FROM TPOSTRR                                             12300000
123100         WHERE PO_NBR = :PV-SAVED-PO                              12310015
123200           AND STR_NBR IN (0, :PV-SAVED-STR)                      12320015
123300           AND STATUS_CDE IN (' ', 'I','A')                       12330000
123310           AND MTCH_LVL_CDE = :PV-SAVED-MTCH-LVL-CDE              12331015
123400     END-EXEC.                                                    12340000
123500                                                                  12350000
123600     EVALUATE TRUE                                                12360000
123700       WHEN SQLCODE = ZERO                                        12370015
123800         SET PO-FOUND                 TO TRUE                     12380015
124000       WHEN SQLCODE = +100                                        12400015
124100         CONTINUE                                                 12410015
124300       WHEN SQLWARN0 NOT = SPACES                                 12430015
124400       WHEN SQLCODE  NOT = ZERO                                   12440015
124500         MOVE '8500-GET-INHOUSE-NMR ' TO AA-PARAGRAPH-NAME        12450015
124600         MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION         12460015
124700         MOVE 'TEXTENT'               TO AA-DB2-TABLE-1           12470015
124800         MOVE SPACES                  TO AA-DB2-TABLE-2           12480015
124900                                         AA-DB2-TABLE-3           12490015
125000         PERFORM Z998-DB2-ABEND                                   12500015
125100     END-EVALUATE.                                                12510000
125200                                                                  12520014
125300*----------------------------------------------------------------*12530000
125400* RETRIEVES THE TERMS WHEN THE TERM SELECT CODE INDICATES THEY   *12540014
125500* EXIST ON THE PURCHASE ORDER TABLES.                            *12550014
125600* NOTE: A NOT FOUND CONDITION IN THIS INSTANCE RESULTS IN THE NO *12560014
125700*       PO TERMS ERROR SWITCH BEING SET.                         *12570014
125800*----------------------------------------------------------------*12580000
125900 R300-SELECT-PO-TERMS.                                            12590000
126000                                                                  12600000
126100     EXEC SQL                                                     12610000
126200         SELECT                                                   12620000
126300             PA.DISC_PAY_DAY_QTY                                  12630000
126400            ,PT.DISCOUNT_PCT                                      12640000
126500            ,PT.DUE_DAY_QTY                                       12650000
126600            ,PT.DISCOUNT_DAYS_QTY                                 12660000
126700            ,PT.DUE_DAY_FR_DTE_TXT                                12670000
126800         INTO                                                     12680000
126900             :POAGMT-DISC-PAY-DAY-QTY                             12690000
127000            ,:PAYTRM-DISCOUNT-PCT                                 12700000
127100            ,:PAYTRM-DUE-DAY-QTY                                  12710000
127200            ,:PAYTRM-DISCOUNT-DAYS-QTY                            12720000
127300            ,:PAYTRM-DUE-DAY-FR-DTE-TXT                           12730000
127400         FROM                                                     12740000
127500             TPOAGMT PA,                                          12750000
127600             TPAYTRM PT                                           12760000
127700         WHERE PA.PO_NBR         = :PV-SAVED-PO                   12770000
127800           AND PA.PAYT_TERM_ID   = PT.PAY_TERM_ID                 12780000
127900           AND PA.AGRMT_TYP_ID   = '2'                            12790000
128000           AND PA.VER_STATUS_CDE = 'A'                            12800000
128100     END-EXEC.                                                    12810000
128200                                                                  12820000
128300     EVALUATE TRUE                                                12830000
128400       WHEN SQLCODE = ZERO                                        12840014
128500         CONTINUE                                                 12850014
128700       WHEN SQLCODE = +100                                        12870014
128800         SET NO-PO-TERMS TO TRUE                                  12880014
129000       WHEN SQLWARN0 NOT = SPACES                                 12900014
129100       WHEN SQLCODE  NOT = ZERO                                   12910014
129200         MOVE 'R300-SELECT-PO-TERMS'   TO AA-PARAGRAPH-NAME       12920014
129300         MOVE 'UNSUCCESSFUL SELECT'    TO AA-DB2-OPERATION        12930014
129400         MOVE 'TPOAGMT'                TO AA-DB2-TABLE-1          12940014
129500         MOVE 'TPAYTRM'                TO AA-DB2-TABLE-2          12950014
129600         MOVE SPACES                   TO AA-DB2-TABLE-3          12960014
129700         PERFORM Z998-DB2-ABEND                                   12970014
129800     END-EVALUATE.                                                12980000
129900                                                                  12990000
130000     EXEC SQL                                                     13000000
130100         SELECT  PA.DISC_PAY_DAY_QTY                              13010000
130200           INTO :PV-DISC-EXTENDED-DAYS                            13020000
130300           FROM  TPOAGMT PA                                       13030000
130400          WHERE  PA.PO_NBR         = :PV-SAVED-PO                 13040000
130500            AND  PA.VER_STATUS_CDE = 'A'                          13050000
130600            AND  PA.AGRMT_TYP_ID   = '5'                          13060000
130700            AND  PA.TYP_CDE        =  1                           13070000
130800     END-EXEC.                                                    13080000
130900                                                                  13090000
131000     EVALUATE TRUE                                                13100000
131100       WHEN SQLCODE = ZERO                                        13110014
131200         ADD PV-DISC-EXTENDED-DAYS    TO POAGMT-DISC-PAY-DAY-QTY  13120014
131300       WHEN SQLCODE = +100                                        13130014
131400         CONTINUE                                                 13140014
131500       WHEN SQLWARN0 NOT = SPACES                                 13150014
131600       WHEN SQLCODE  NOT = ZERO                                   13160014
131700         MOVE 'R300-SELECT-PO-TERMS'  TO AA-PARAGRAPH-NAME        13170014
131800         MOVE 'UNSUCCESSFUL SELECT'   TO AA-DB2-OPERATION         13180014
131900         MOVE 'TPOAGMT'               TO AA-DB2-TABLE-1           13190014
132000         MOVE SPACES                  TO AA-DB2-TABLE-2           13200014
132100         MOVE SPACES                  TO AA-DB2-TABLE-3           13210014
132200         PERFORM Z998-DB2-ABEND                                   13220014
132300     END-EVALUATE.                                                13230000
132400                                                                  13240014
132500*----------------------------------------------------------------*13250000
132600* RETRIEVES THE TERMS WHEN THE TERM SELECT CODE INDICATES THEY   *13260014
132700* EXIST ON THE INVOICE TERMS TABLE.                              *13270014
132800* NOTE: A NOT FOUND CONDITION IN THIS INSTANCE RESULTS IN THE NO *13280014
132900*       INVOICE TERMS ERROR SWITCH BEING SET.                    *13290014
133000*----------------------------------------------------------------*13300000
133100 R400-SELECT-INVOICE-TERMS.                                       13310000
133200                                                                  13320000
133300     EXEC SQL                                                     13330000
133400         SELECT                                                   13340000
133500             DISC_PCT                                             13350000
133600            ,DISC_DUE_DAY_QTY                                     13360000
133700            ,EXTD_DAYS_QTY                                        13370000
133800            ,NET_DUE_DAY_QTY                                      13380000
133900            ,TERM_TYP_CDE                                         13390000
134000         INTO                                                     13400000
134100             :INVCTM-DISC-PCT                                     13410000
134200            ,:INVCTM-DISC-DUE-DAY-QTY                             13420000
134300            ,:INVCTM-EXTD-DAYS-QTY                                13430000
134400            ,:INVCTM-NET-DUE-DAY-QTY                              13440000
134500            ,:INVCTM-TERM-TYP-CDE                                 13450000
134600         FROM TINVCTM                                             13460000
134700         WHERE PO_NBR            = :PV-SAVED-PO                   13470000
134800           AND INVC_ID           = :INVOIC-INVC-ID                13480000
134900           AND TERM_SEQ_NBR      = 1                              13490000
135000     END-EXEC.                                                    13500000
135100                                                                  13510000
135200     EVALUATE TRUE                                                13520000
135300       WHEN SQLCODE = ZERO                                        13530014
135400         CONTINUE                                                 13540014
135600       WHEN SQLCODE = +100                                        13560014
135700         SET NO-INV-TERMS TO TRUE                                 13570014
135900       WHEN SQLWARN0 NOT = SPACES                                 13590014
136000       WHEN SQLCODE  NOT = ZERO                                   13600014
136100         MOVE 'R400-SELECT-INVOICE-TERMS' TO AA-PARAGRAPH-NAME    13610014
136200         MOVE 'UNSUCCESSFUL SELECT'       TO AA-DB2-OPERATION     13620014
136300         MOVE 'TINVCTM'                   TO AA-DB2-TABLE-1       13630014
136400         MOVE SPACES                      TO AA-DB2-TABLE-2       13640014
136500                                             AA-DB2-TABLE-3       13650014
136600         PERFORM Z998-DB2-ABEND                                   13660014
136700     END-EVALUATE.                                                13670000
136800                                                                  13680014
136900*----------------------------------------------------------------*13690000
137000* RETRIEVES THE VENDOR NAME AND NUMBER                           *13700014
137100* NOTE: A NOT FOUND CONDITION IN THIS INSTANCE RESULTS IN THE    *13710014
137200*       VENDOR NAME AND NUMBER FIELDS BEING FILLED WITH DEFAULT  *13720014
137300*       VALUES.                                                  *13730014
137400*----------------------------------------------------------------*13740000
137500 R500-SELECT-VENDOR-DATA.                                         13750000
137600                                                                  13760000
137700     EXEC SQL                                                     13770000
137800         SELECT                                                   13780000
137900              EN.ENT_NAME_DESC                                    13790000
138000             ,EN.ENT_ID                                           13800000
138100             ,EE.DUN_NBR                                          13810000
138200             ,PU.PO_TYP_CDE                                       13820000
138200             ,PU.DEPT_NBR                                         13821064
138300         INTO                                                     13830000
138400              :ENTNME-ENT-NAME-DESC                               13840000
138500             ,:ENTNME-ENT-ID                                      13850000
138600             ,:EXTENT-DUN-NBR                                     13860000
138700             ,:PURCHS-PO-TYP-CDE                                  13870000
138700             ,:PURCHS-DEPT-NBR                                    13871064
138800         FROM TENTNME EN                                          13880000
138900             ,TEXTENT EE                                          13890000
139000             ,TPURCHS PU                                          13900000
139100         WHERE PU.PO_NBR         = :INVOIC-PO-NBR                 13910000
139200           AND PU.VER_STATUS_CDE = 'A'                            13920000
139300           AND EE.ENT_ID         = PU.ENT_ID                      13930000
139400           AND EN.ENT_ID         = PU.ENT_ID                      13940000
139500           AND EN.TYPE_CDE       = '01'                           13950000
139600     END-EXEC.                                                    13960000
139700                                                                  13970000
139800     EVALUATE TRUE                                                13980000
139900       WHEN SQLCODE = ZERO                                        13990014
140000*        CONTINUE                                                 14000064
140000         MOVE ENTNME-ENT-ID      TO PV-ENT-ID                     14010064
140000         MOVE PURCHS-DEPT-NBR    TO PV-DEPT-NBR                   14011064
140000         PERFORM S500-CHECK-FOR-SEPHORA                           14012064
140000         CONTINUE                                                 14014064
140200       WHEN SQLCODE = +100                                        14020014
140300         MOVE 'VENDOR PRIMARY NAME NOT FOUND'                     14030016
140400           TO ENTNME-ENT-NAME-DESC                                14040014
140500         MOVE SPACES                    TO EXTENT-DUN-NBR         14050014
140600                                           PURCHS-PO-TYP-CDE      14060014
140700         MOVE ZEROS                     TO ENTNME-ENT-ID          14070014
140900       WHEN SQLWARN0 NOT = SPACES                                 14090014
141000       WHEN SQLCODE  NOT = ZERO                                   14100014
141100         MOVE 'R500-SELECT-VENDOR-DATA' TO AA-PARAGRAPH-NAME      14110014
141200         MOVE 'UNSUCCESSFUL SELECT'     TO AA-DB2-OPERATION       14120014
141300         MOVE 'TENTNME'                 TO AA-DB2-TABLE-1         14130014
141400         MOVE 'TEXTENT'                 TO AA-DB2-TABLE-2         14140014
141500         MOVE 'TPURCHS'                 TO AA-DB2-TABLE-3         14150014
141600         PERFORM Z998-DB2-ABEND                                   14160014
141700     END-EVALUATE.                                                14170000
141800                                                                  14180014
141900*----------------------------------------------------------------*14190000
142000* RETRIEVES THE DISCOUNT RECORDS FOR PARTICULAR INVOICES FROM    *14200014
142100* THE TINVOIC TABLE.                                             *14210014
142200*----------------------------------------------------------------*14220000
142300 R600-FETCH-IMPORT-DISCOUNT-CSR.                                  14230000
142400                                                                  14240000
142500     EXEC SQL                                                     14250000
142600         FETCH DISCOUNT_CSR                                       14260000
142700         INTO :ALCHRG-ALW-CHRG-AMT                                14270000
142800             ,:ALCHRG-ALW-CHRG-PCT                                14280000
142900             ,:ALCHRG-ALW-CHRG-CDE                                14290000
143000             ,:ALCHRG-ALW-CHRG-TYP-CDE                            14300000
143100     END-EXEC.                                                    14310000
143200                                                                  14320000
143300     EVALUATE TRUE                                                14330000
143400       WHEN SQLCODE = ZERO                                        14340014
143500         CONTINUE                                                 14350014
143700       WHEN SQLCODE = +100                                        14370014
143800         SET END-OF-IMPORT-DISCOUNTS   TO TRUE                    14380014
144000       WHEN SQLWARN0 NOT = SPACES                                 14400014
144100       WHEN SQLCODE  NOT = ZERO                                   14410014
144200         MOVE 'R600-FETCH-IMPORT-DISCOUNT-CSR'                    14420014
144300           TO AA-PARAGRAPH-NAME                                   14430014
144400         MOVE 'UNSUCCESSFUL FETCH WITH DISCOUNT_CSR'              14440014
144500           TO AA-DB2-OPERATION                                    14450014
144600         MOVE 'TALCHRG'                TO AA-DB2-TABLE-1          14460014
144700         MOVE SPACES                   TO AA-DB2-TABLE-2          14470014
144800                                          AA-DB2-TABLE-3          14480014
144900         PERFORM Z998-DB2-ABEND                                   14490014
145000     END-EVALUATE.                                                14500000
145100                                                                  14510014
145200*--------------------------------------------------------------*  14520014
145300* WRITES OUT THE BATCH MATCH INVOICE EXTRACT RECORD.           *  14530014
145400*--------------------------------------------------------------*  14540014
145500 W100-WRITE-INVOICE-EXT.                                          14550000
145600                                                                  14560000
145700     WRITE INVOICE-EXTRACT-RECORD FROM AP060-INVOICE-EXTRACT.     14570000
145800                                                                  14580000
145900*--------------------------------------------------------------*  14590014
146000* WRITES OUT THE ERROR RECORD.                                 *  14600014
146100*--------------------------------------------------------------*  14610014
146200 W200-WRITE-ERROR.                                                14620000
146300                                                                  14630000
146400     WRITE ERROR-RECORD FROM AP059-ERROR-RECORD.                  14640000
146600     INITIALIZE AP059-ERROR-RECORD.                               14660000
146700                                                                  14670000
146800*--------------------------------------------------------------*  14680014
146900* WRITES OUT THE INVOICE EXPENSE EXTRACT FILE                  *  14690014
147000*--------------------------------------------------------------*  14700014
147100 W300-WRITE-IMPORT-EXT.                                           14710000
147200                                                                  14720000
147300     WRITE IMPORT-EXTRACT-RECORD FROM AP060-INVOICE-EXTRACT.      14730000
147400                                                                  14740000
147600*--------------------------------------------------------------*  14760014
147700* OPENS THE INVOICES CURSOR.                                   *  14770014
147800*--------------------------------------------------------------*  14780014
147900 Y100-OPEN-INVOICES-CSR.                                          14790000
148000                                                                  14800000
148100     EXEC SQL                                                     14810000
148200         OPEN INVOICES_CSR                                        14820000
148300     END-EXEC.                                                    14830000
148400                                                                  14840000
148500     EVALUATE TRUE                                                14850000
148600       WHEN SQLCODE = ZERO                                        14860014
148700         CONTINUE                                                 14870014
148900       WHEN SQLWARN0 NOT = SPACES                                 14890014
149000       WHEN SQLCODE  NOT = ZERO                                   14900014
149100         MOVE 'Y100-OPEN-INVOICES-CSR' TO AA-PARAGRAPH-NAME       14910014
149200         MOVE 'UNSUCCESSFUL OPEN ON INVOICES_CSR'                 14920014
149300           TO AA-DB2-OPERATION                                    14930014
149400         MOVE 'TINVOIC'                TO AA-DB2-TABLE-1          14940014
149500         MOVE 'TMDINVC'                TO AA-DB2-TABLE-2          14950014
149600         MOVE SPACES                   TO AA-DB2-TABLE-3          14960014
149700         PERFORM Z998-DB2-ABEND                                   14970014
149800     END-EVALUATE.                                                14980000
149900                                                                  14990000
150200*--------------------------------------------------------------*  15020014
150300* CLOSES THE INVOICES CURSOR.                                  *  15030014
150400*--------------------------------------------------------------*  15040014
150500 Y110-CLOSE-INVOICES-CSR.                                         15050000
150600                                                                  15060000
150700       EXEC SQL                                                   15070000
150800           CLOSE INVOICES_CSR                                     15080000
150900       END-EXEC.                                                  15090000
151000                                                                  15100000
151100       EVALUATE TRUE                                              15110000
151200         WHEN SQLCODE = ZERO                                      15120014
151300           CONTINUE                                               15130014
151500         WHEN SQLWARN0 NOT = SPACES                               15150014
151600         WHEN SQLCODE  NOT = ZERO                                 15160014
151700           MOVE 'Y110-CLOSE-INVOICES-CSR'  TO AA-PARAGRAPH-NAME   15170014
151900           MOVE 'UNSUCCESSFUL CLOSE ON INVOICES_CSR'              15190014
152000             TO AA-DB2-OPERATION                                  15200014
152100           MOVE 'TINVOIC'                  TO AA-DB2-TABLE-1      15210014
152200           MOVE 'TMDINVC'                  TO AA-DB2-TABLE-2      15220014
152300           MOVE SPACES                     TO AA-DB2-TABLE-3      15230014
152400           PERFORM Z998-DB2-ABEND                                 15240014
152500       END-EVALUATE.                                              15250000
152600                                                                  15260014
152700*--------------------------------------------------------------*  15270014
152800* OPENS THE IMPORT DISCOUNT CURSOR.                            *  15280014
152900*--------------------------------------------------------------*  15290014
153000 Y300-OPEN-IMPORT-DISCOUNT-CSR.                                   15300000
153100                                                                  15310000
153200     EXEC SQL                                                     15320000
153300         OPEN DISCOUNT_CSR                                        15330000
153400     END-EXEC.                                                    15340000
153500                                                                  15350000
153600     EVALUATE TRUE                                                15360000
153700       WHEN SQLCODE = ZERO                                        15370014
153800         CONTINUE                                                 15380014
154000       WHEN SQLWARN0 NOT = SPACES                                 15400014
154100       WHEN SQLCODE  NOT = ZERO                                   15410014
154200         MOVE 'Y300-OPEN-IMPORT-DISCOUNT-CSR' TO AA-PARAGRAPH-NAME15420014
154400         MOVE 'UNSUCCESSFUL OPEN ON DISCOUNT_CSR'                 15440014
154500           TO AA-DB2-OPERATION                                    15450014
154600         MOVE 'TALCHRG'                       TO AA-DB2-TABLE-1   15460014
154700         MOVE SPACES                          TO AA-DB2-TABLE-2   15470014
154800         PERFORM Z998-DB2-ABEND                                   15480018
154900     END-EVALUATE.                                                15490000
155000                                                                  15500000
155100*--------------------------------------------------------------*  15510014
155200* CLOSES THE IMPORT DISCOUNT CURSOR.                           *  15520014
155300*--------------------------------------------------------------*  15530014
155400 Y310-CLOSE-IMPORT-DISCOUNT-CSR.                                  15540000
155500                                                                  15550000
155600       EXEC SQL                                                   15560000
155700           CLOSE DISCOUNT_CSR                                     15570000
155800       END-EXEC.                                                  15580000
155900                                                                  15590000
156000       EVALUATE TRUE                                              15600000
156100         WHEN SQLCODE = ZERO                                      15610014
156200           CONTINUE                                               15620014
156400         WHEN SQLWARN0 NOT = SPACES                               15640014
156500         WHEN SQLCODE  NOT = ZERO                                 15650014
156600           MOVE 'Y310-CLOSE-IMPORT-DISCOUNT-CSR'                  15660014
156700             TO AA-PARAGRAPH-NAME                                 15670014
156800           MOVE 'UNSUCCESSFUL CLOSE ON DISCOUNT_CSR'              15680014
156900             TO AA-DB2-OPERATION                                  15690014
157000           MOVE 'TALCHRG'        TO AA-DB2-TABLE-1                15700014
157100           MOVE SPACES           TO AA-DB2-TABLE-2                15710014
157200           PERFORM Z998-DB2-ABEND                                 15720018
157300       END-EVALUATE.                                              15730000
157400                                                                  15740014
157500*--------------------------------------------------------------*  15750014
157600* ABEND ROUTINE FOR DB2 ERRORS                                 *  15760014
157700*--------------------------------------------------------------*  15770014
157800 Z998-DB2-ABEND.                                                  15780000
157900                                                                  15790000
158000     DISPLAY AA-ABEND-LIT.                                        15800000
158100     DISPLAY AA-DB2-ERROR-LIT.                                    15810000
158200     DISPLAY AA-PROGRAM-LIT.                                      15820000
158300     DISPLAY AA-PARAGRAPH-LIT.                                    15830000
158400     DISPLAY AA-DB2-OPERATION-LIT.                                15840000
158500     DISPLAY AA-DB2-TABLE-1.                                      15850000
158600     DISPLAY AA-DB2-TABLE-2.                                      15860000
158700     DISPLAY AA-DB2-TABLE-3.                                      15870000
158800     DISPLAY AA-DB2-TABLE-4.                                      15880000
158900     DISPLAY '*****                PO = ' PV-SAVED-PO.            15890000
159000     DISPLAY '*****             STORE = ' PV-SAVED-STR.           15900000
159100     SET AC-DB2-ERROR TO TRUE.                                    15910000
159200                                                                  15920000
159300     COPY DPPD004.                                                15930000
159400                                                                  15940000
159500     CALL 'ILBOABN0' USING ABEND-CODE.                            15950000
159600                                                                  15960000
159900*--------------------------------------------------------------*  15990014
160000* ABEND ROUTINE                                                *  16000014
160100*--------------------------------------------------------------*  16010014
160200 Z999-ABEND.                                                      16020000
160300                                                                  16030000
160400     CLOSE INVOICE-EXTRACT-FILE                                   16040000
160500           IMPORT-EXTRACT-FILE                                    16050000
160600           ERROR-FILE.                                            16060000
160700     DISPLAY AA-ABEND-LIT.                                        16070000
160800     DISPLAY AA-PROGRAM-LIT.                                      16080000
160900     DISPLAY AA-PARAGRAPH-LIT.                                    16090000
161000     DISPLAY AA-MESSAGE-LINE.                                     16100000
161100     CALL 'ILBOABN0' USING ABEND-CODE.                            16110000
161200                                                                  16120014
159900*--------------------------------------------------------------*  16130064
160000* SEPHORA LOOK UP LOGIC                                        *  16140064
160100*--------------------------------------------------------------*  16150064
159200                                                                  16160064
159300     COPY APPD021.                                                16170064
