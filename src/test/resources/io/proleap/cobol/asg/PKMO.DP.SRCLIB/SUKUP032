000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400*                                                                 00040000
000500 PROGRAM-ID.             SUKUP032.                                00050001
000600 AUTHOR.                 CHERI PARMLEY.                           00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN.           MAY 2016.                                00080001
000900 DATE-COMPILED.                                                   00090000
001000*                                                                 00100000
001100***************************************************************** 00110000
001200* THIS PROGRAM WILL BE USED TO DELETE ROWS FROM THE TRACKING      00120001
001300* NUMBER HISTORY DATABASE (SUT_TRK_NBR_HIST).                     00130001
001400***************************************************************** 00133000
001500 ENVIRONMENT DIVISION.                                            00134000
001600***************************************************************** 00135000
001700 CONFIGURATION SECTION.                                           00136000
001800 SOURCE-COMPUTER.                        IBM-3090.                00137000
001900 OBJECT-COMPUTER.                        IBM-3090.                00138000
002000 INPUT-OUTPUT SECTION.                                            00139000
002100 FILE-CONTROL.                                                    00140000
002200                                                                  00150000
002300     SELECT EXTRACT-FILE                                          00160000
002400         ASSIGN TO INP01.                                         00170000
002500/                                                                 00180000
002600***************************************************************** 00190000
002700 DATA DIVISION.                                                   00200000
002800***************************************************************** 00210000
002900 FILE SECTION.                                                    00220000
003000                                                                  00230000
003100 FD  EXTRACT-FILE                                                 00240000
003200     RECORDING MODE IS F                                          00250000
003300     LABEL RECORDS ARE STANDARD                                   00260000
003400     BLOCK CONTAINS 0 RECORDS.                                    00270000
003500 01  EXTRACT-RECORD                   PIC X(100).                 00280000
003600/                                                                 00290000
003700***************************************************************** 00300000
003800 WORKING-STORAGE SECTION.                                         00310000
003900***************************************************************** 00320000
004000                                                                  00330000
004100 01  PS-SWITCHES.                                                 00340000
004200     05  PS-END-OF-INPUT-FILE-SW      PIC X(01) VALUE 'N'.        00350000
004300         88  PS-END-OF-INPUT                    VALUE 'Y'.        00360000
004400         88  PS-NOT-END-OF-INPUT                VALUE 'N'.        00370000
004500                                                                  00380000
004600 01  PV-VARIABLES.                                                00390000
004700     05  PV-COUNT                     PIC  9(09) VALUE ZERO.      00400000
004710     05  PV-COMMIT-CNT                PIC  9(09) VALUE ZERO.      00410000
004800     05  PV-READ-CNT                  PIC  9(09) VALUE ZERO.      00420000
005300     05  PV-TRKG-DELETE-CNT           PIC  9(09) VALUE ZERO.      00440001
005410     05  PV-TRKG-NOT-FND-CNT          PIC  9(09) VALUE ZERO.      00441003
005500     05  PV-DISPLAY-CNT               PIC  ZZZ,ZZZ,ZZ9.           00450002
008600                                                                  00510000
008700******************************************************************00520000
008800 01  PV-ABEND-FIELDS.                                             00530000
008900     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00540000
009000                                                 COMP SYNC.       00550000
009100     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUP032'.00560001
009200     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    00570000
009300     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    00580000
009400     05  PV-ABEND-STRUCTURE-1         PIC  X(08) VALUE SPACES.    00590000
009500     05  PV-ABEND-STRUCTURE-2         PIC  X(08) VALUE SPACES.    00600000
009600     05  PV-ABEND-STRUCTURE-3         PIC  X(08) VALUE SPACES.    00610000
009700     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00620000
009800     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00630000
009900     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00640000
009910     05  PV-DB2-FUNCTION              PIC  X(50) VALUE SPACES.    00650000
010000/                                                                 00660000
010100 01  PC-CONSTANTS.                                                00670000
010200     05  PC-CURRENT-PROGRAM-NAME      PIC X(08) VALUE 'SUKUP032'. 00680001
010500     05  PC-COMMIT-HOLD               PIC 9(3)  VALUE 100.        00690000
010510     05  PC-COUNT-HOLD                PIC 9(9)  VALUE 100000.     00700000
010600                                                                  00710000
010700******************************************************************00720000
010800*  LAYOUT FOR EXTRACT FILE                                        00730000
010900******************************************************************00740000
011000     COPY SURD115.                                                00750001
011100*                                                                 00760000
012200******************************************************************00770000
012300*  DB2 FORMATTED MESSAGE AREA                                     00780000
012400******************************************************************00790000
012500     COPY DPWS004.                                                00800000
012600                                                                  00810000
013200******************************************************************00820000
013300*   DB2 SQL COMMUNICATION AREA                                    00830000
013400******************************************************************00840000
013500     EXEC SQL                                                     00850000
013600         INCLUDE SQLCA                                            00860000
013700     END-EXEC.                                                    00870000
013800*                                                                 00880000
013900     COPY SQLCA2.                                                 00890000
014000*                                                                 00900000
014100******************************************************************00910000
014200*   SUT_TRKG_NBR_HIST                                             00920001
014300******************************************************************00930000
014400*                                                                 00940000
014500     EXEC SQL                                                     00950000
014600         INCLUDE SUT00119                                         00960001
014700     END-EXEC.                                                    00970000
014800*                                                                 00980000
014900******************************************************************01150000
015000 PROCEDURE DIVISION.                                              01160000
015100******************************************************************01170000
015200 0000-MAINLINE.                                                   01180000
015300                                                                  01190000
015400     PERFORM 1000-INITIALIZE.                                     01200000
015500                                                                  01210000
015600     PERFORM 2000-PROCESS-EXTRACT                                 01220000
015700         UNTIL PS-END-OF-INPUT.                                   01230000
015800                                                                  01240000
015900     PERFORM 9000-EOJ.                                            01250000
016000                                                                  01260000
016100      GOBACK.                                                     01270000
016200                                                                  01280000
016300******************************************************************01290000
016400*  INITIALIZATION TASKS.                                          01300000
016500*    -- OPEN INPUT FILE                                           01310000
016600*    -- READ FILE                                                 01320000
016700******************************************************************01330000
016800 1000-INITIALIZE.                                                 01340000
016900                                                                  01350000
017000     OPEN INPUT  EXTRACT-FILE.                                    01360000
017100                                                                  01370000
017200     PERFORM 2100-READ-EXTRACT.                                   01380000
017300/                                                                 01390000
017400******************************************************************01400000
017500 2000-PROCESS-EXTRACT.                                            01410000
017600******************************************************************01420000
017700*                                                                 01430000
017701     IF  PV-COUNT  <  PC-COUNT-HOLD                               01440000
017702         CONTINUE                                                 01450000
017703     ELSE                                                         01460000
017704         MOVE PV-READ-CNT  TO  PV-DISPLAY-CNT                     01470000
017705         DISPLAY 'READ:  '     PV-DISPLAY-CNT                     01480000
017706         MOVE  ZEROES  TO      PV-COUNT                           01490000
017707     END-IF.                                                      01500000
017708                                                                  01510000
017810     PERFORM 8100-DELETE-TRKG-HIST.                               01590001
017823     ADD +1 TO PV-COMMIT-CNT.                                     01640001
017830                                                                  01670000
018000                                                                  01700000
018100     IF PV-COMMIT-CNT > PC-COMMIT-HOLD                            01710000
018200         PERFORM 2200-COMMIT-DELETE                               01720000
018300     END-IF.                                                      01730000
018400                                                                  01740000
018500     PERFORM 2100-READ-EXTRACT.                                   01750000
018600*                                                                 01760000
018700******************************************************************01770000
018800*  READ NEXT INPUT FILE RECORD.                                   01780000
018900******************************************************************01790000
019000 2100-READ-EXTRACT.                                               01800000
019100                                                                  01810000
019200     READ EXTRACT-FILE INTO SU115-EXTRACT-RECORD                  01820001
019300        AT END                                                    01830000
019400           SET PS-END-OF-INPUT TO TRUE                            01840000
019500        NOT AT END                                                01850000
019600           ADD +1                   TO PV-READ-CNT                01860000
019610                                       PV-COUNT                   01870000
019700     END-READ.                                                    01880000
019800*                                                                 01890000
019900******************************************************************01900000
020000* COMMIT THE DELETE FROM ERROR TABLE                              01910000
020100******************************************************************01920000
020200 2200-COMMIT-DELETE.                                              01930000
020300                                                                  01940000
020400      EXEC SQL                                                    01950000
020500         COMMIT                                                   01960000
020600      END-EXEC                                                    01970000
020700                                                                  01980000
020900      MOVE +0 TO PV-COMMIT-CNT.                                   01990000
021000                                                                  02000000
024210******************************************************************02300000
024220* DELETE THE SUT_TRKG_NBR_HIST                                    02310001
024230******************************************************************02320000
024240 8100-DELETE-TRKG-HIST.                                           02330002
024250                                                                  02340000
024260     EXEC SQL                                                     02350000
024270          DELETE                                                  02360000
024280            FROM  SUT_TRKG_NBR_HIST                               02370001
024290           WHERE TRKG_NBR      = :SU115-TRKG-NBR                  02380004
024290             AND TRKG_STAT_CDE = :SU115-TRKG-STAT-CDE             02381004
024290             AND CRE_TMST      = :SU115-CRE-TMST                  02382001
024296     END-EXEC.                                                    02390000
024297                                                                  02400000
024298     EVALUATE TRUE                                                02410000
024299         WHEN SQLCODE = 0                                         02420000
024300             ADD +1           TO PV-TRKG-DELETE-CNT               02430002
024301         WHEN SQLCODE = +100                                      02430100
024302             ADD +1           TO PV-TRKG-NOT-FND-CNT              02430202
024303         WHEN SQLCODE = -532                                      02430300
024304             CONTINUE                                             02430400
024307         WHEN SQLCODE < 0                                         02430500
024308         WHEN SQLCODE > 0                                         02430600
024309         WHEN SQLWARN0 = 'W'                                      02430700
024310             MOVE '8100-DELETE-TRKG-HIST   '                      02430801
024311                         TO PV-ABEND-PARAGRAPH                    02430900
024312             MOVE 'DELETE OF SUT_TRKG_NBR_HIST '                  02431001
024313                         TO PV-DB2-FUNCTION                       02431100
024314             PERFORM 9200-SQL-ABEND                               02431200
024315     END-EVALUATE.                                                02431300
024316/                                                                 02431400
024344/                                                                 02434200
024350******************************************************************02434300
024400*CLOSE INPUT FILE.                                                02434400
024500******************************************************************02434500
024600 9000-EOJ.                                                        02434600
024700*                                                                 02434700
024800     CLOSE EXTRACT-FILE.                                          02434800
024900                                                                  02434900
025000     MOVE PV-READ-CNT           TO PV-DISPLAY-CNT.                02435000
025100     DISPLAY 'READ:              ' PV-DISPLAY-CNT.                02436000
025400     MOVE PV-TRKG-DELETE-CNT    TO PV-DISPLAY-CNT.                02439001
025500     DISPLAY 'TRKG-HIST DELETE:  ' PV-DISPLAY-CNT.                02440005
025530     MOVE PV-TRKG-NOT-FND-CNT   TO PV-DISPLAY-CNT.                02450003
025540     DISPLAY 'TRKG-HIST  NOT FD: ' PV-DISPLAY-CNT.                02460003
025600                                                                  02530000
025700******************************************************************02540000
025800 9200-SQL-ABEND.                                                  02550000
025900******************************************************************02560000
026000                                                                  02570000
026100     MOVE SQLCODE                     TO SQLCODE2.                02580000
026200     MOVE SQLERRD(3)                  TO SQLERRD3.                02590000
026300                                                                  02600000
026400     DISPLAY '** ABEND **         ** = SQLERROR'.                 02610000
026500     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        02620000
026600     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             02630000
026700     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                02640000
026800     DISPLAY '*** TRKG#       = ' SU115-TRKG-NBR.                 02650002
026900     DISPLAY '*** TRKG STAT CD= ' SU115-TRKG-STAT-CDE.            02660002
027000     DISPLAY '*** CRE TMST    = ' SU115-CRE-TMST.                 02670002
027100                                                                  02680000
027200     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                02690000
027300     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                02700000
027400     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 02710000
027500     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                02720000
027600                                                                  02730000
027700                                                                  02740000
027800     MOVE +4013                       TO PV-ABEND-CODE.           02750000
027900     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         02760000
028000                                                                  02770000
