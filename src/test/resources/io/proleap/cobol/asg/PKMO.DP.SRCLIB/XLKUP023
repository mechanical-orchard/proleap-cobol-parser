000100 TITLE 'DELETE TPURITM, TALLPLN, TMESTDS ON PACK_REPLACE MESSAGE'.        
000200 IDENTIFICATION DIVISION.                                                 
000300 PROGRAM-ID.    XLKUP023.                                                 
000400 AUTHOR.        DEANNA BRANTNER.                                          
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                                  
000600 DATE-WRITTEN.  APRIL 2003.                                               
000700 DATE-COMPILED.                                                           
000800******************************************************************        
000900* THIS PGM IS PART OF THE INTERFACING BETWEEN RMS PO & LEGACY PO.         
001000******************************************************************        
001100* THIS DB2 PROGRAM IS CALLED TO PROCESS CERTAIN TYPES OF PO DATA          
001200* PASSED FROM RMS.  THE PROGRAM INSERTS, UPDATES OR DELETES ROWS          
001300* ON THE LEGACY TPURITM, TALLPLN, AND TMESTDS TABLES.                     
001400******************************************************************        
001500 ENVIRONMENT DIVISION.                                                    
001600 CONFIGURATION SECTION.                                                   
001700 SOURCE-COMPUTER.  IBM-3090.                                              
001800 OBJECT-COMPUTER.  IBM-3090.                                              
001900 DATA DIVISION.                                                           
002000                                                                          
002100 WORKING-STORAGE SECTION.                                                 
002200                                                                          
002300 01  PS-PROGRAM-STUFF.                                                    
002400     05  PS-EXISTENCE-PO              PIC S9 COMP-3 VALUE ZERO.           
002500         88  PS-PO-EXISTS-YES                       VALUE 1.              
002600         88  PS-PO-EXISTS-NO                        VALUE ZERO.           
002700     05  PS-ERROR-SW                    PIC  X(01)  VALUE 'N'.            
002800         88  PS-NO-ERROR                            VALUE 'N'.            
002900         88  PS-ERROR                               VALUE 'Y'.            
003000     05  PS-CHECK-SW                    PIC  X(01)  VALUE 'Y'.            
003100         88  PS-NO-CHECK                            VALUE 'N'.            
003200         88  PS-CHECK                               VALUE 'Y'.            
003300     05  PS-TPURITM-CURSOR-SW           PIC  X(01)  VALUE 'N'.            
003400         88  PS-EOF-TPURITM-CSR                     VALUE 'Y'.            
003500     05  PS-NULL-IND                    PIC S9(04)  VALUE +0 COMP.        
003600     05  PS-DISPLAY-FIELD               PIC 9(09)   VALUE 0.              
004000     05  PS-DISPLAY-FLD                 PIC 9(09)   VALUE 0.              
004100                                                                          
005000                                                                          
005100**** PO AGREEMENTS                                                        
005200     EXEC SQL                                                             
005300         INCLUDE TPOPRPK                                                  
005400     END-EXEC.                                                            
005500                                                                          
005600     EXEC SQL                                                             
005700         INCLUDE TALLPLN                                                  
005800     END-EXEC.                                                            
005900                                                                          
006000**** PURCHASING ITEMS                                                     
006100     EXEC SQL                                                             
006200         INCLUDE TPURITM                                                  
006300     END-EXEC.                                                            
006400                                                                          
006500     EXEC SQL                                                             
006600         INCLUDE TMESTDS                                                  
006700     END-EXEC.                                                            
006800                                                                          
009100*---------------------------------------------------------------*         
009200*  CURSOR TO RETRIEVE LINE NUMBER FROM TPURITM                 *          
009300*---------------------------------------------------------------*         
009500     EXEC SQL                                                             
009600          DECLARE TPURITM-CSR CURSOR FOR                                  
009700           SELECT PO_LNE_NBR                                              
009800           FROM   TPURITM                                                 
009900           WHERE  PO_NBR         = :PURITM-PO-NBR                         
010000             AND  PO_PREPK_ID    = :PURITM-PO-PREPK-ID                    
010100     END-EXEC.                                                            
010200                                                                          
011500                                                                          
011600     EXEC SQL                                                             
011700          INCLUDE SQLCA                                                   
011800     END-EXEC.                                                            
011900                                                                          
012000     COPY SQLCA2.                                                         
012100                                                                          
012200 LINKAGE SECTION.                                                         
012300 01  XLRD011-RECORD.                                                      
012400     COPY XLRD011.                                                        
012500                                                                          
012600******************************************************************        
012700 PROCEDURE DIVISION USING XLRD011-RECORD.                                 
012800                                                                          
012900     PERFORM 1000-INITIALIZATION.                                         
013000                                                                          
013100     IF PS-NO-ERROR                                                       
013200         MOVE XL011-ORDER-NBR       TO PURITM-PO-NBR                      
013300         MOVE POPRPK-PO-PREPK-ID    TO PURITM-PO-PREPK-ID                 
013400         PERFORM 3100-OPEN-CURSOR                                         
013500         PERFORM 3000-FETCH-CURSOR UNTIL PS-EOF-TPURITM-CSR               
013600                                      OR XL011-SQL-ERROR                  
013700                                      OR XL011-SYSTEM-ERROR               
013800         PERFORM 3200-CLOSE-CURSOR                                        
013900         IF PS-NO-ERROR AND XL011-SUCCESSFUL                              
014000             PERFORM 5000-DELETE-TPURITM                                  
014500         END-IF                                                           
014600     END-IF.                                                              
014700                                                                          
014800     MOVE  0  TO SQLCODE.                                                 
014900     MOVE 'N' TO PS-TPURITM-CURSOR-SW.                                    
015000     MOVE 'N' TO PS-ERROR-SW.                                             
015100     MOVE 'N' TO PS-CHECK-SW.                                             
015200     MOVE  0  TO PS-EXISTENCE-PO.                                         
015300     PERFORM 9999-WRAPUP.                                                 
015400                                                                          
015500     GOBACK.                                                              
015600                                                                          
015700******************************************************************        
015800 1000-INITIALIZATION.                                                     
015900                                                                          
016000* JAK 04/2007 - ADD DEBUG LOGIC                                           
016100     IF XL011-DEBUG-YES                                                   
016200         DISPLAY 'XLKUP023 - 1000-INITIALIZATION'                         
016300         DISPLAY 'XLKUP023 - XL011-ORDER-NBR = '  XL011-ORDER-NBR         
016400               ' '  XL011-MSG-ID                                          
016500     END-IF.                                                              
016600                                                                          
016700     INITIALIZE XL011-RETURN-AREA.                                        
016800     MOVE 'XLKUP023'                  TO XL011-ERROR-PROGRAM.             
017200     PERFORM 2000-GOTO-TPOPRPK.                                           
017300                                                                          
017400******************************************************************        
017500 2000-GOTO-TPOPRPK.                                                       
017600                                                                          
017700* JAK 04/2007 - ADD DEBUG LOGIC                                           
017800     IF XL011-DEBUG-YES                                                   
017900         DISPLAY 'XLKUP023 - 2000-GOTO-TPOPRPK'                           
018000         DISPLAY 'XLKUP023 - XL011-PACK-SKU-NBR '                         
018100                 XL011-PACK-SKU-NBR                                       
018200     END-IF.                                                              
018300                                                                          
018400     MOVE '2000-GOTO-TPOPRPK '      TO XL011-ERROR-PARAGRAPH.             
018500     MOVE XL011-PACK-SKU-NBR        TO POPRPK-PK-SKU-NBR.                 
018600     MOVE XL011-ORDER-NBR           TO POPRPK-PO-NBR.                     
018700                                                                          
018800     EXEC SQL                                                             
018900         SELECT PO_PREPK_ID                                               
019000         INTO :POPRPK-PO-PREPK-ID                                         
019100         FROM  TPOPRPK                                                    
019200         WHERE PO_NBR               = :POPRPK-PO-NBR                      
019300           AND PK_SKU_NBR           = :POPRPK-PK-SKU-NBR                  
019400       END-EXEC.                                                          
019500                                                                          
019600       MOVE SQLCODE                  TO XL011-SQLCODE.                    
019700       EVALUATE TRUE                                                      
019800           WHEN SQLCODE = ZERO                                            
019900               CONTINUE                                                   
020000           WHEN SQLCODE = +100                                            
020100               SET PS-ERROR         TO TRUE                               
020200           WHEN OTHER                                                     
020300               SET XL011-SQL-ERROR  TO TRUE                               
020400               MOVE 'TPOPRPK'       TO XL011-DB2-TABLE-NAME(1)            
020500       END-EVALUATE.                                                      
020600                                                                          
020700******************************************************************        
020800 3000-FETCH-CURSOR.                                                       
020900                                                                          
021000* JAK 04/2007 - ADD DEBUG LOGIC                                           
021100     IF XL011-DEBUG-YES                                                   
021200         DISPLAY 'XLKUP023 - 3000-FETCH-CURSOR'                           
021300     END-IF.                                                              
021400                                                                          
021500     MOVE '3000-FETCH-CURSOR'       TO XL011-ERROR-PARAGRAPH.             
021600                                                                          
021700     EXEC SQL                                                             
021800          FETCH TPURITM-CSR                                               
021900          INTO :PURITM-PO-LNE-NBR                                         
022300     END-EXEC.                                                            
022400                                                                          
022500                                                                          
022600     MOVE SQLCODE          TO XL011-SQLCODE.                              
022700     EVALUATE TRUE                                                        
022800         WHEN SQLCODE = ZERO                                              
022900* JAK 04/2007 - ADD DEBUG LOGIC                                           
023000             IF XL011-DEBUG-YES                                           
023100                 MOVE PURITM-PO-LNE-NBR TO PS-DISPLAY-FLD                 
023200                 DISPLAY 'XLKUP023 - PO LNE NBR='                         
023300                         PS-DISPLAY-FLD                                   
023400             END-IF                                                       
023500             IF XL011-SUCCESSFUL                                          
023600                 PERFORM 4000-DELETE-TMESTDS                              
023700             END-IF                                                       
023800             IF XL011-SUCCESSFUL                                          
023900                 PERFORM 4100-DELETE-TALLPLN                              
024000             END-IF                                                       
024500         WHEN SQLCODE = +100                                              
024600             SET PS-EOF-TPURITM-CSR   TO TRUE                             
024700         WHEN OTHER                                                       
024800             SET PS-ERROR                                                 
024900                 XL011-SQL-ERROR      TO TRUE                             
025000             MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)          
025100     END-EVALUATE.                                                        
025200                                                                          
025300******************************************************************        
025400 3100-OPEN-CURSOR.                                                        
025500                                                                          
025600* JAK 04/2007 - ADD DEBUG LOGIC                                           
025700     IF XL011-DEBUG-YES                                                   
025800         DISPLAY 'XLKUP023 - 3100-OPEN-CURSOR'                            
025900     END-IF.                                                              
026000                                                                          
026100     MOVE '3100-OPEN-CURSOR'        TO XL011-ERROR-PARAGRAPH.             
026200                                                                          
026300     EXEC SQL                                                             
026400          OPEN TPURITM-CSR                                                
026500     END-EXEC.                                                            
026600                                                                          
026700     EVALUATE TRUE                                                        
026800         WHEN SQLCODE = +0                                                
026900         WHEN SQLCODE = -904                                              
027000         WHEN SQLCODE = -913                                              
027100              CONTINUE                                                    
027200         WHEN OTHER                                                       
027300             SET XL011-SQL-ERROR      TO TRUE                             
027400             MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)          
027500     END-EVALUATE.                                                        
027600                                                                          
027700******************************************************************        
027800 3200-CLOSE-CURSOR.                                                       
027900                                                                          
028000* JAK 04/2007 - ADD DEBUG LOGIC                                           
028100     IF XL011-DEBUG-YES                                                   
028200         DISPLAY 'XLKUP023 - 3200-CLOSE-CURSOR'                           
028300     END-IF.                                                              
028400                                                                          
028500     EXEC SQL                                                             
028600          CLOSE TPURITM-CSR                                               
028700     END-EXEC.                                                            
028800                                                                          
028900     EVALUATE TRUE                                                        
029000         WHEN SQLCODE = +0                                                
029100              CONTINUE                                                    
029200         WHEN OTHER                                                       
029300             SET PS-ERROR             TO TRUE                             
029400     END-EVALUATE.                                                        
029500                                                                          
029600******************************************************************        
029700 4000-DELETE-TMESTDS.                                                     
029800                                                                          
029900* JAK 04/2007 - ADD DEBUG LOGIC                                           
030000     IF XL011-DEBUG-YES                                                   
030100         DISPLAY 'XLKUP023 - 4000-DELETE-TMESTDS'                         
030200     END-IF.                                                              
030300                                                                          
030400     MOVE '4000-DELETE-TMESTDS'  TO XL011-ERROR-PARAGRAPH.                
030500     MOVE XL011-ORDER-NBR        TO MESTDS-PO-NBR.                        
030600     MOVE PURITM-PO-LNE-NBR      TO MESTDS-PO-LNE-NBR.                    
030700                                                                          
030800     EXEC SQL                                                             
030900         DELETE                                                           
031000         FROM  TMESTDS                                                    
031100         WHERE PO_NBR           = :MESTDS-PO-NBR                          
031200           AND PO_LNE_NBR       = :MESTDS-PO-LNE-NBR                      
031300     END-EXEC.                                                            
031400                                                                          
031500     MOVE SQLCODE              TO XL011-SQLCODE.                          
031600     EVALUATE TRUE                                                        
031700         WHEN SQLCODE = ZERO                                              
031800         WHEN SQLCODE = +100                                              
031900             CONTINUE                                                     
032000         WHEN OTHER                                                       
032100             SET XL011-SQL-ERROR      TO TRUE                             
032200             MOVE 'TMESTDS'           TO XL011-DB2-TABLE-NAME(1)          
032300     END-EVALUATE.                                                        
032400                                                                          
032500******************************************************************        
032600 4100-DELETE-TALLPLN.                                                     
032700                                                                          
032800* JAK 04/2007 - ADD DEBUG LOGIC                                           
032900     IF XL011-DEBUG-YES                                                   
033000         DISPLAY 'XLKUP023 - 4100-DELETE-TALLPLN'                         
033100     END-IF.                                                              
033200                                                                          
033300     MOVE '4100-DELETE-TALLPLN'  TO XL011-ERROR-PARAGRAPH.                
033400     MOVE XL011-ORDER-NBR        TO ALLPLN-PO-NBR.                        
033500     MOVE PURITM-PO-LNE-NBR      TO ALLPLN-PO-LNE-NBR.                    
033600                                                                          
033700     EXEC SQL                                                             
033800         DELETE                                                           
033900         FROM  TALLPLN                                                    
034000         WHERE PO_NBR           = :ALLPLN-PO-NBR                          
034100           AND PO_LNE_NBR       = :ALLPLN-PO-LNE-NBR                      
034200     END-EXEC.                                                            
034300                                                                          
034400     MOVE SQLCODE              TO XL011-SQLCODE.                          
034500     EVALUATE TRUE                                                        
034600         WHEN SQLCODE = ZERO                                              
034700         WHEN SQLCODE = +100                                              
034800             CONTINUE                                                     
034900         WHEN OTHER                                                       
035000             SET XL011-SQL-ERROR      TO TRUE                             
035100             MOVE 'TALLPLN'           TO XL011-DB2-TABLE-NAME(1)          
035200     END-EVALUATE.                                                        
035300                                                                          
035400******************************************************************        
035500 5000-DELETE-TPURITM.                                                     
035600                                                                          
035700* JAK 04/2007 - ADD DEBUG LOGIC                                           
035800     IF XL011-DEBUG-YES                                                   
035900         DISPLAY 'XLKUP023 - 5000-DELETE-TPURITM'                         
036000     END-IF.                                                              
036100                                                                          
036200     MOVE '5000-DELETE-TPURITM'  TO XL011-ERROR-PARAGRAPH.                
036300     MOVE XL011-ORDER-NBR        TO PURITM-PO-NBR.                        
036400     MOVE POPRPK-PO-PREPK-ID     TO PURITM-PO-PREPK-ID.                   
036500                                                                          
036600     EXEC SQL                                                             
036700         DELETE                                                           
036800         FROM  TPURITM                                                    
036900         WHERE PO_NBR           = :PURITM-PO-NBR                          
037000           AND PO_PREPK_ID      = :PURITM-PO-PREPK-ID                     
037100     END-EXEC.                                                            
037200                                                                          
037300     MOVE SQLCODE              TO XL011-SQLCODE.                          
037400     EVALUATE TRUE                                                        
037500         WHEN SQLCODE = ZERO                                              
037600         WHEN SQLCODE = +100                                              
037700             CONTINUE                                                     
037800         WHEN OTHER                                                       
037900             SET XL011-SQL-ERROR      TO TRUE                             
038000             MOVE 'TPURITM'           TO XL011-DB2-TABLE-NAME(1)          
038100     END-EVALUATE.                                                        
038200                                                                          
059500 9999-WRAPUP.                                                             
059600                                                                          
059700* JAK 04/2007 - ADD DEBUG LOGIC                                           
059800     IF XL011-DEBUG-YES                                                   
059900         DISPLAY 'XLKUP023 - 9999-WRAPUP'                                 
060000         DISPLAY 'XLKUP023 - XL011-RETURN-CODE='                          
060100                             XL011-RETURN-CODE                            
060200         DISPLAY 'XLKUP023 - XL011-SQLCODE='                              
060300                             XL011-SQLCODE                                
060400         DISPLAY 'XLKUP023 - XL011-ERROR-PARAGRAPH='                      
060500                             XL011-ERROR-PARAGRAPH                        
060600         DISPLAY 'XLKUP023 - XL011-SQLCA='                                
060700                             XL011-SQLCA                                  
060800     END-IF.                                                              
060900                                                                          
061000     MOVE SQLCA                       TO XL011-SQLCA.                     
061100                                                                          
