000100******************************************************************00010020
000200 IDENTIFICATION DIVISION.                                         00020020
000300******************************************************************00030020
000400                                                                  00040020
000500 PROGRAM-ID.     RDKCS010.                                        00050020
000600 AUTHOR.         CHUCK ALBERTY -- EXACTA.                         00060020
000700 INSTALLATION.   KOHLS DEPARTMENT STORES.                         00070020
000800 DATE-WRITTEN.   10/07/91.                                        00080020
000900 DATE-COMPILED.                                                   00090020
001000                                                                  00100020
001100******************************************************************00110020
001200*               CICS PROGRAM - RDKCS010 - U010                   *00120020
001300*                                                                *00130020
001400*   CASH REFUND AUTHORIZATION SYSTEM                             *00140020
001500*                                                                *00150020
001600*   THIS PROGRAM WILL CREATE A TEMPORARY STORAGE QUEUE FOR       *00160020
001700*   THE CASH REFUND AUTHORIZATION PARAMETERS BY STORE NUMBER.    *00170020
001800*   THIS IS DONE BY JOINING THE STORE DB2 TABLE (XST_LOC)        *00180020
001900*   AND THE CASH REFUND CONTROL DB2 TABLE (TRDCNTL) AND THEN     *00190020
002000*   WRITING OUT THE TS QUEUE (REFAUTHQ).                         *00200020
002100*                                                                *00210020
002200*   THIS PROGRAM WILL BE EXECUTED ONLY AT CICS STARTUP.          *00220020
002300*                                                                *00230020
002400*   THE TS QUEUE WILL BE READ BY OTHER TRANSACTIONS FOR THE      *00240020
002500*   CASH REFUND REFERRALS FOR FASTER PROCESSING.                 *00250020
002600*                                                                *00260020
002700*   03/18/96 - K. SUTTON - MODIFIED THE PROGRAM TO ALLOW TWO NEW *00270020
002800*   WR# 3722   COLUMNS ON THE TRDCNTL TABLE TO BE SELECTED.  THE *00280020
002900*              FIELDS, LO_RFND_AUTH_AMT AND HGH_RFND_AUTH_AMT,   *00290020
003000*              WERE ALSO ADDED TO THE TEMPORARY STORAGE QUEUE.   *00300020
003100******************************************************************00310020
003200******************************************************************00320020
003300 ENVIRONMENT DIVISION.                                            00330020
003400******************************************************************00340020
003500******************************************************************00350020
003600 DATA DIVISION.                                                   00360020
003700******************************************************************00370020
003800 WORKING-STORAGE SECTION.                                         00380020
003900                                                                  00390020
004000*************                                                     00400020
004100*   UNFORMATTED MESSAGES FOR DB2 ERRORS/WARNINGS                  00410020
004200*************                                                     00420020
004300                                                                  00430020
004400 01  DB2-MESSSAGE.                                                00440020
004500     05  DM-RESOURCE-UNAVAIL-MSG.                                 00450020
004600         10  FILLER                  PIC  X(48)      VALUE        00460020
004700             'A RESOURCE WAS NOT AVAILABLE.  PLEASE TRY AGAIN.'.  00470020
004800     05  DM-DEADLOCK-TIMEOUT-MSG.                                 00480020
004900         10  FILLER                  PIC  X(48)      VALUE        00490020
005000             'DEADLOCK OR TIMEOUT.  PLEASE TRY AGAIN.         '.  00500020
005100     05  DM-NOT-AUTHORIZED-MSG.                                   00510020
005200         10  FILLER                  PIC  X(48)      VALUE        00520020
005300             'CONNECTION AUTHORIZATION FAILURE.  CONTACT DP.  '.  00530020
005400     05  DM-NOT-CONNECTED-MSG.                                    00540020
005500         10  FILLER                  PIC  X(48)      VALUE        00550020
005600             'CONNECTION NOT ESTABLISHED.  TRY AGAIN.         '.  00560020
005700     05  DM-OTHER-DB2-ERROR-MSG.                                  00570020
005800         10  FILLER                  PIC  X(48)      VALUE        00580020
005900             'A DB2 ERROR HAS OCCURRED - CONTACT DP - '.          00590020
006000     05  DM-DB2-ERROR-MSG.                                        00600020
006100         10  DM-ERROR-MSG            PIC  X(48).                  00610020
006200         10  FILLER                  PIC  X(16)      VALUE        00620020
006300             'PROGRAM RDKCS010'.                                  00630020
006400         10  FILLER                  PIC  X(11)      VALUE        00640020
006500             ' SQLCODE = '.                                       00650020
006600         10  DM-SQLCODE              PIC  Z(8)9-     VALUE ZERO.  00660020
006700     05  DM-DB2-WARNING-MSG.                                      00670020
006800         10  FILLER                  PIC  X(42)      VALUE        00680020
006900             'A DB2 WARNING HAS OCCURRED - CONTACT DP - '.        00690020
007000         10  FILLER                  PIC  X(16)      VALUE        00700020
007100             'PROGRAM RDKCS010'.                                  00710020
007200         10  FILLER                  PIC  X(11)      VALUE        00720020
007300             ' SQLCODE = '.                                       00730020
007400         10  DM-SQLCODE1             PIC  Z(8)9-     VALUE ZERO.  00740020
007500                                                                  00750020
007600                                                                  00760020
007700 01  DRU-DB2-RESOURCE-UNAVAIL-MSG.                                00770020
007800     05  FILLER                      PIC  X(48)      VALUE        00780020
007900         'A RESOURCE WAS NOT AVAILABLE.  PLEASE TRY AGAIN.'.      00790020
008000     05  FILLER                      PIC  X(19)      VALUE        00800020
008100         '(PROGRAM RDKCS010).'.                                   00810020
008200                                                                  00820020
008300                                                                  00830020
008400 01  OTHER-MESSAGES.                                              00840020
008500     05  OM-DONE                     PIC  X(44)      VALUE        00850020
008600         'RDKCS010 - TS QUEUE-ID REFAUTHQ CREATED     '.          00860020
008700     05  OM-NO-SPACE                 PIC  X(44)      VALUE        00870020
008800         'RDKCS010 - NO SPACE FOR TS QUEUEID REFAUTHQ '.          00880020
008900                                                                  00890020
009000                                                                  00900020
009100 01  PROGRAM-ACCUMULATORS.                                        00910020
009200     05  PA-RETRY-COUNT              PIC S9(04)      VALUE ZERO   00920020
009300                                                     COMP SYNC.   00930020
009400                                                                  00940020
009500 01  PROGRAM-CONSTANTS.                                           00950020
009600     05  PC-U010                     PIC  X(04)     VALUE 'U010'. 00960020
009700     05  PC-MAX-RETRY                PIC S9(04)     VALUE +3      00970020
009800                                                     COMP SYNC.   00980020
009900     05  PC-MORE-THAN-MAX-RETRY      PIC S9(04)     VALUE +4      00990020
010000                                                     COMP SYNC.   01000020
010100     05  PC-MAX-STORES               PIC S9(04)     VALUE +9999   01010022
010200                                                     COMP SYNC.   01020020
010300     05  PC-DB2-ERROR-LENGTH         PIC S9(04)     VALUE +84     01030020
010400                                                     COMP SYNC.   01040020
010500     05  PC-DB2-WARNING-LENGTH       PIC S9(04)     VALUE +78     01050020
010600                                                     COMP SYNC.   01060020
010700     05  PC-TS-CREATED-LENGTH        PIC S9(04)     VALUE +044    01070020
010800                                                     COMP SYNC.   01080020
010900                                                                  01090020
011000 01  PROGRAM-VARIABLES.                                           01100020
011100     05  PV-RESP                     PIC S9(04)      COMP.        01110020
011200     05  PV-ITEM-NMBR                PIC  9(05).                  01120020
011300                                                                  01130020
011400 01  TEMPORARY-STORAGE-FIELDS.                                    01140020
011500     05  TS-QUEUE-NAME               PIC  X(08)      VALUE        01150020
011600         'REFAUTHQ'.                                              01160020
011700     05  TS-ITEM-NMBR                PIC S9(04)      COMP.        01170020
011800     05  TS-RECORD.                                               01180020
011900         10  TS-STORE-NMBR           PIC  9(05).                  01190020
012000         10  TS-STORE-GP-NBR         PIC  9(02).                  01200020
012100         10  TS-ACTIVITY-PERIOD      PIC  9(02).                  01210020
012200         10  TS-MAX-REFUNDS-PER-PRD  PIC  9(01).                  01220020
012300         10  TS-MAX-REFUND-AMT-PER-PRD                            01230020
012400                                     PIC S9(05)      COMP-3.      01240020
012500         10  TS-MAX-STORES-PER-DAY   PIC 9(01).                   01250020
012600         10  TS-MAX-REFUNDS-PER-DAY  PIC 9(01).                   01260020
012700         10  TS-MAX-REFUND-AMT-PER-DAY                            01270020
012800                                     PIC S9(05)      COMP-3.      01280020
012900         10  TS-LOW-REFUND-AUTH-AMT  PIC S9(05)V9(02)             01290020
013000                                                     COMP-3.      01300020
013100         10  TS-HIGH-REFUND-AUTH-AMT PIC S9(05)V9(02)             01310020
013200                                                     COMP-3.      01320020
013300         10  TS-MAX-CSH-BCK-AMT      PIC S9(05)V9(02)             01330020
013400                                                     COMP-3.      01340020
013500     05  TS-RECORD-LENGTH            PIC S9(04)      COMP         01350020
013600                                                     VALUE +30.   01360020
013700*                                                                 01370020
013800*                                                                 01380020
013900******************************************************************01390020
014000*  SQL AND COBOL DECLARATIONS FOR XST_LOC                         01400020
014100******************************************************************01410020
014200     EXEC SQL                                                     01420020
014300          INCLUDE XST00001                                        01430020
014400     END-EXEC.                                                    01440020
014500*                                                                 01450020
014600*                                                                 01460020
014700******************************************************************01470020
014800*  SQL AND COBOL DECLARATIONS FOR XST_LOC_ATTR                    01480020
014900******************************************************************01490020
015000     EXEC SQL                                                     01500020
015100          INCLUDE XST00025                                        01510020
015200     END-EXEC.                                                    01520020
015300*                                                                 01530020
015400*                                                                 01540020
015500******************************************************************01550020
015600*  SQL AND COBOL DECLARATIONS FOR THE CASH REFUND AUTHORIZATION   01560020
015700*  CONTROL TABLE (TRDCNTL)                                        01570020
015800******************************************************************01580020
015900     EXEC SQL                                                     01590020
016000          INCLUDE TRDCNTL                                         01600020
016100     END-EXEC.                                                    01610020
016200*                                                                 01620020
016300*                                                                 01630020
016400******************************************************************01640020
016500*  STANDARD LAYOUT FOR THE SQL COMMUNICATIONS AREA                01650020
016600******************************************************************01660020
016700     EXEC SQL                                                     01670020
016800          INCLUDE SQLCA                                           01680020
016900     END-EXEC.                                                    01690020
017000*                                                                 01700020
017100*                                                                 01710020
017200******************************************************************01720020
017300*  SQL DECLARATION TO JOIN XST_LOC, XST_LOC_ATTR, TRDCNTL         01730020
017400******************************************************************01740020
017500     EXEC SQL                                                     01750020
017600          DECLARE REFUND_AUTH_CSR CURSOR FOR                      01760020
017700           SELECT A.LOC_NBR,                                      01770020
017800                  B.CSH_RFND_GP_NBR,                              01780020
017900                  C.ACTVY_PER_DAY_NBR,                            01790020
018000                  C.MAX_RET_DAY_NBR,                              01800020
018100                  C.MAX_RET_PER_NBR,                              01810020
018200                  C.MAX_DOL_RT_DAY_AMT,                           01820020
018300                  C.MAX_DOL_RT_PER_AMT,                           01830020
018400                  C.MAX_STR_DAY_NBR,                              01840020
018500                  C.LO_RFND_AUTH_AMT,                             01850020
018600                  C.HGH_RFND_AUTH_AMT,                            01860020
018700                  C.MAX_CSH_BCK_AMT                               01870020
018800             FROM XST_LOC      A,                                 01880020
018900                  XST_LOC_ATTR B,                                 01890020
019000                  TRDCNTL      C                                  01900020
019100            WHERE B.LOC_NBR         = A.LOC_NBR                   01910021
019200              AND B.CSH_RFND_GP_NBR = C.AUTH_GP_NBR               01920021
019300              AND A.LOC_NBR         > 0                           01930021
019400            ORDER BY A.LOC_NBR                                    01940020
019500     END-EXEC.                                                    01950020
019600/                                                                 01960020
019700******************************************************************01970020
019800 PROCEDURE DIVISION.                                              01980020
019900******************************************************************01990020
020000*                                                                 02000020
020100 0000-MAINLINE.                                                   02010020
020200******************************************************************02020020
020300*   MAIN MODULE.                                                  02030020
020400*   - OPENS CURSOR                                                02040020
020500*   - LOADS TO TS                                                 02050020
020600*   - CLOSE CURSOR                                                02060020
020700*   - RETURN TO CICS                                              02070020
020800******************************************************************02080020
020900***                                                               02090020
021000***  DELETE TS QUEUE REFAUTHQ, JUST IN CASE IT IS THERE           02100020
021100***                                                               02110020
021200     PERFORM 1300-DELETE-QUEUE.                                   02120020
021300*                                                                 02130020
021400***                                                               02140020
021500***  SINCE THIS TRANS IS EXECUTED AT CICS START-UP, DB2 MIGHT     02150020
021600***  MIGHT NOT BE FULLY UP YET.  SO, WHEN SQLCODE = -923 IS       02160020
021700***  ENCOUNTERED, DELAY FOR 1 MINUTE AND RE-TRY AGAIN.  DO THIS   02170020
021800***  UNTIL SLQCODE = 0 OR UNTIL 3 TRIES.                          02180020
021900***                                                               02190020
022000     PERFORM                                                      02200020
022100       VARYING PA-RETRY-COUNT FROM 1 BY 1                         02210020
022200         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      02220020
022300                                                                  02230020
022400         EXEC SQL                                                 02240020
022500              OPEN REFUND_AUTH_CSR                                02250020
022600         END-EXEC                                                 02260020
022700                                                                  02270020
022800         EVALUATE TRUE                                            02280020
022900             WHEN SQLCODE = 0                                     02290020
023000                  MOVE PC-MORE-THAN-MAX-RETRY                     02300020
023100                                     TO PA-RETRY-COUNT            02310020
023200             WHEN SQLCODE = -923                                  02320020
023300                  EXEC CICS DELAY                                 02330020
023400                            INTERVAL(100)                         02340020
023500                  END-EXEC                                        02350020
023600             WHEN SQLCODE < 0                                     02360020
023700                  PERFORM 9000-SQL-ERROR                          02370020
023800             WHEN SQLCODE > 0                                     02380020
023900             WHEN SQLWARN0 = 'W'                                  02390020
024000                  PERFORM 9100-SQL-WARNING                        02400020
024100         END-EVALUATE                                             02410020
024200     END-PERFORM.                                                 02420020
024300                                                                  02430020
024400     IF  SQLCODE = 0                                              02440020
024500         CONTINUE                                                 02450020
024600     ELSE                                                         02460020
024700         PERFORM 9000-SQL-ERROR                                   02470020
024800     END-IF.                                                      02480020
024900                                                                  02490020
025000     INITIALIZE PV-ITEM-NMBR.                                     02500020
025100     PERFORM 1100-FETCH.                                          02510020
025200     PERFORM 1000-CREATE-TS                                       02520020
025300       UNTIL SQLCODE = +100                                       02530020
025400         OR PV-ITEM-NMBR > PC-MAX-STORES.                         02540020
025500                                                                  02550020
025600     PERFORM                                                      02560020
025700       VARYING PA-RETRY-COUNT FROM 1 BY 1                         02570020
025800         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      02580020
025900                                                                  02590020
026000         EXEC SQL                                                 02600020
026100              CLOSE REFUND_AUTH_CSR                               02610020
026200         END-EXEC                                                 02620020
026300                                                                  02630020
026400         EVALUATE TRUE                                            02640020
026500             WHEN SQLCODE = 0                                     02650020
026600                  MOVE PC-MORE-THAN-MAX-RETRY                     02660020
026700                                     TO PA-RETRY-COUNT            02670020
026800             WHEN SQLCODE = -904                                  02680020
026900             WHEN SQLCODE = -913                                  02690020
027000                  CONTINUE                                        02700020
027100             WHEN SQLCODE < 0                                     02710020
027200                  PERFORM 9000-SQL-ERROR                          02720020
027300             WHEN SQLCODE > 0                                     02730020
027400             WHEN SQLWARN0 = 'W'                                  02740020
027500                  PERFORM 9100-SQL-WARNING                        02750020
027600         END-EVALUATE                                             02760020
027700     END-PERFORM.                                                 02770020
027800                                                                  02780020
027900     EVALUATE TRUE                                                02790020
028000         WHEN SQLCODE = 0                                         02800020
028100              CONTINUE                                            02810020
028200         WHEN SQLCODE < 0                                         02820020
028300              PERFORM 9000-SQL-ERROR                              02830020
028400         WHEN SQLCODE > 0                                         02840020
028500         WHEN SQLWARN0 = 'W'                                      02850020
028600              PERFORM 9100-SQL-WARNING                            02860020
028700     END-EVALUATE.                                                02870020
028800                                                                  02880020
028900     EXEC CICS                                                    02890020
029000          SYNCPOINT                                               02900020
029100     END-EXEC.                                                    02910020
029200                                                                  02920020
029300     EXEC CICS WRITEQ TD                                          02930020
029400               QUEUE('CSSL')                                      02940020
029500               FROM(OM-DONE)                                      02950020
029600               LENGTH(PC-TS-CREATED-LENGTH)                       02960020
029700     END-EXEC.                                                    02970020
029800                                                                  02980020
029900     EXEC CICS RETURN                                             02990020
030000     END-EXEC.                                                    03000020
030100                                                                  03010020
030200     GOBACK.                                                      03020020
030300*                                                                 03030020
030400*                                                                 03040020
030500 1000-CREATE-TS.                                                  03050020
030600******************************************************************03060020
030700*   LOAD REFUND AUTH PARAMETER TABLE TO TS. THE TS WILL HAVE 200  03070020
030800*   ENTRIES ALWAYS.  THE ITEM-NMBR IS = THE STORE-NUMBER.  DUMMY  03080020
030900*   ENTRIES ARE CREATED FOR NON-EXISTENT STORES.                  03090020
031000******************************************************************03100020
031100     ADD 1                           TO PV-ITEM-NMBR.             03110020
031200*                                                                 03120020
031300     IF  XST00001-LOC-NBR > PV-ITEM-NMBR                          03130020
031400         PERFORM                                                  03140020
031500           VARYING PV-ITEM-NMBR FROM PV-ITEM-NMBR BY 1            03150020
031600             UNTIL PV-ITEM-NMBR = XST00001-LOC-NBR                03160020
031700                                                                  03170020
031800             INITIALIZE TS-RECORD                                 03180020
031900             MOVE PV-ITEM-NMBR       TO TS-STORE-NMBR             03190020
032000                                        TS-ITEM-NMBR              03200020
032100             PERFORM 1200-WRITE-QUEUE                             03210020
032200         END-PERFORM                                              03220020
032300     END-IF.                                                      03230020
032400*                                                                 03240020
032500     MOVE XST00001-LOC-NBR           TO TS-STORE-NMBR.            03250020
032600     MOVE XST00025-CSH-RFND-GP-NBR   TO TS-STORE-GP-NBR.          03260020
032700     MOVE RDCNTL-ACTVY-PER-DAY-NBR   TO TS-ACTIVITY-PERIOD.       03270020
032800     MOVE RDCNTL-MAX-RET-DAY-NBR     TO TS-MAX-REFUNDS-PER-DAY.   03280020
032900     MOVE RDCNTL-MAX-RET-PER-NBR     TO TS-MAX-REFUNDS-PER-PRD.   03290020
033000     MOVE RDCNTL-MAX-DOL-RT-PER-AMT  TO TS-MAX-REFUND-AMT-PER-PRD.03300020
033100     MOVE RDCNTL-MAX-DOL-RT-DAY-AMT  TO TS-MAX-REFUND-AMT-PER-DAY.03310020
033200     MOVE RDCNTL-MAX-STR-DAY-NBR     TO TS-MAX-STORES-PER-DAY.    03320020
033300     MOVE RDCNTL-LO-RFND-AUTH-AMT    TO TS-LOW-REFUND-AUTH-AMT.   03330020
033400     MOVE RDCNTL-HGH-RFND-AUTH-AMT   TO TS-HIGH-REFUND-AUTH-AMT.  03340020
033500     MOVE RDCNTL-MAX-CSH-BCK-AMT     TO TS-MAX-CSH-BCK-AMT.       03350020
033600     MOVE TS-STORE-NMBR              TO TS-ITEM-NMBR.             03360020
033700*                                                                 03370020
033800     PERFORM 1200-WRITE-QUEUE.                                    03380020
033900     PERFORM 1100-FETCH.                                          03390020
034000*                                                                 03400020
034100     IF  SQLCODE = +100                                           03410020
034200         ADD 1                       TO PV-ITEM-NMBR              03420020
034300         INITIALIZE TS-RECORD                                     03430020
034400         MOVE PV-ITEM-NMBR           TO TS-STORE-NMBR             03440020
034500                                        TS-ITEM-NMBR              03450020
034600         PERFORM 1200-WRITE-QUEUE                                 03460020
034700     END-IF.                                                      03470020
034800*                                                                 03480020
034900*                                                                 03490020
035000 1100-FETCH.                                                      03500020
035100******************************************************************03510020
035200*   FETCH THE CURSOR DEFINED TO JOIN TRDCNTL, XST_LOC,            03520020
035300*   AND XST_LOC_ATTR                                              03530020
035400******************************************************************03540020
035500     PERFORM                                                      03550020
035600       VARYING PA-RETRY-COUNT FROM 1 BY 1                         03560020
035700         UNTIL PA-RETRY-COUNT > PC-MAX-RETRY                      03570020
035800                                                                  03580020
035900        EXEC SQL                                                  03590020
036000             FETCH REFUND_AUTH_CSR                                03600020
036100              INTO :XST00001-LOC-NBR,                             03610020
036200                   :XST00025-CSH-RFND-GP-NBR,                     03620020
036300                   :RDCNTL-ACTVY-PER-DAY-NBR,                     03630020
036400                   :RDCNTL-MAX-RET-DAY-NBR,                       03640020
036500                   :RDCNTL-MAX-RET-PER-NBR,                       03650020
036600                   :RDCNTL-MAX-DOL-RT-DAY-AMT,                    03660020
036700                   :RDCNTL-MAX-DOL-RT-PER-AMT,                    03670020
036800                   :RDCNTL-MAX-STR-DAY-NBR,                       03680020
036900                   :RDCNTL-LO-RFND-AUTH-AMT,                      03690020
037000                   :RDCNTL-HGH-RFND-AUTH-AMT,                     03700020
037100                   :RDCNTL-MAX-CSH-BCK-AMT                        03710020
037200        END-EXEC                                                  03720020
037300                                                                  03730020
037400        EVALUATE TRUE                                             03740020
037500            WHEN SQLCODE = 0                                      03750020
037600            WHEN SQLCODE = +100                                   03760020
037700                 MOVE PC-MORE-THAN-MAX-RETRY                      03770020
037800                                     TO PA-RETRY-COUNT            03780020
037900            WHEN SQLCODE = -904                                   03790020
038000            WHEN SQLCODE = -913                                   03800020
038100                 CONTINUE                                         03810020
038200            WHEN SQLCODE < 0                                      03820020
038300                 PERFORM 9000-SQL-ERROR                           03830020
038400            WHEN SQLCODE > 0                                      03840020
038500            WHEN SQLWARN0 = 'W'                                   03850020
038600                PERFORM 9100-SQL-WARNING                          03860020
038700        END-EVALUATE                                              03870020
038800     END-PERFORM.                                                 03880020
038900*                                                                 03890020
039000     IF  SQLCODE = 0                                              03900020
039100      OR SQLCODE = +100                                           03910020
039200         CONTINUE                                                 03920020
039300     ELSE                                                         03930020
039400         PERFORM 9000-SQL-ERROR                                   03940020
039500     END-IF.                                                      03950020
039600*                                                                 03960020
039700*                                                                 03970020
039800 1200-WRITE-QUEUE.                                                03980020
039900******************************************************************03990020
040000*   WRITE TS QUEUE                                                04000020
040100******************************************************************04010020
040200     EXEC CICS WRITEQ TS                                          04020020
040300               QUEUE('REFAUTHQ')                                  04030020
040400               FROM(TS-RECORD)                                    04040020
040500               LENGTH(TS-RECORD-LENGTH)                           04050020
040600               ITEM(TS-ITEM-NMBR)                                 04060020
040700               MAIN                                               04070020
040800               RESP(PV-RESP)                                      04080020
040900     END-EXEC.                                                    04090020
041000*                                                                 04100020
041100     IF  PV-RESP = DFHRESP(NOSPACE)                               04110020
041200         PERFORM 9200-NO-SPACE                                    04120020
041300     END-IF.                                                      04130020
041400*                                                                 04140020
041500*                                                                 04150020
041600 1300-DELETE-QUEUE.                                               04160020
041700******************************************************************04170020
041800*   DELETEQ TS QUEUE                                              04180020
041900******************************************************************04190020
042000     EXEC CICS DELETEQ TS                                         04200020
042100               QUEUE('REFAUTHQ')                                  04210020
042200               RESP(PV-RESP)                                      04220020
042300     END-EXEC.                                                    04230020
042400*                                                                 04240020
042500*                                                                 04250020
042600 9000-SQL-ERROR.                                                  04260020
042700******************************************************************04270020
042800*    DB2 SQL WARNING AND SQL ERROR PARAGRAPHS                     04280020
042900******************************************************************04290020
043000     EVALUATE SQLCODE                                             04300020
043100         WHEN -904                                                04310020
043200              MOVE DM-RESOURCE-UNAVAIL-MSG TO DM-ERROR-MSG        04320020
043300         WHEN -913                                                04330020
043400              MOVE DM-DEADLOCK-TIMEOUT-MSG TO DM-ERROR-MSG        04340020
043500         WHEN -922                                                04350020
043600              MOVE DM-NOT-AUTHORIZED-MSG   TO DM-ERROR-MSG        04360020
043700         WHEN -923                                                04370020
043800              MOVE DM-NOT-CONNECTED-MSG    TO DM-ERROR-MSG        04380020
043900         WHEN ANY                                                 04390020
044000              MOVE DM-OTHER-DB2-ERROR-MSG  TO DM-ERROR-MSG        04400020
044100     END-EVALUATE.                                                04410020
044200*                                                                 04420020
044300     MOVE SQLCODE                    TO DM-SQLCODE.               04430020
044400*                                                                 04440020
044500     EXEC CICS WRITEQ TD                                          04450020
044600               QUEUE('CSSL')                                      04460020
044700               FROM(DM-DB2-ERROR-MSG)                             04470020
044800               LENGTH(PC-DB2-ERROR-LENGTH)                        04480020
044900     END-EXEC.                                                    04490020
045000*                                                                 04500020
045100     EXEC CICS SYNCPOINT                                          04510020
045200     END-EXEC                                                     04520020
045300*                                                                 04530020
045400     EXEC CICS RETURN                                             04540020
045500     END-EXEC.                                                    04550020
045600*                                                                 04560020
045700*                                                                 04570020
045800 9100-SQL-WARNING.                                                04580020
045900******************************************************************04590020
046000*  EXIT THE CASH REFUND SYSTEM DISPLAYING A FORMATTED DB2        *04600020
046100*  WARNING MESSAGE.                                              *04610020
046200******************************************************************04620020
046300     MOVE SQLCODE                    TO DM-SQLCODE1.              04630020
046400*                                                                 04640020
046500     EXEC CICS WRITEQ TD                                          04650020
046600               QUEUE ('CSSL')                                     04660020
046700               FROM(DM-DB2-WARNING-MSG)                           04670020
046800               LENGTH(PC-DB2-WARNING-LENGTH)                      04680020
046900     END-EXEC.                                                    04690020
047000*                                                                 04700020
047100     EXEC CICS SYNCPOINT                                          04710020
047200     END-EXEC.                                                    04720020
047300*                                                                 04730020
047400     EXEC CICS RETURN                                             04740020
047500     END-EXEC.                                                    04750020
047600*                                                                 04760020
047700*                                                                 04770020
047800 9200-NO-SPACE.                                                   04780020
047900******************************************************************04790020
048000*  DISPLAY NO-SPACE MESSAGE                                      *04800020
048100******************************************************************04810020
048200     EXEC CICS WRITEQ TD                                          04820020
048300               QUEUE('CSSL')                                      04830020
048400               FROM(OM-NO-SPACE)                                  04840020
048500               LENGTH(PC-TS-CREATED-LENGTH)                       04850020
048600     END-EXEC.                                                    04860020
