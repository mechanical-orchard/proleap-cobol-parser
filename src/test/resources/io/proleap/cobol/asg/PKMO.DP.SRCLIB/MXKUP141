       IDENTIFICATION DIVISION.                                         00010003
218056 PROGRAM-ID.      MXKUP141.                                       00020003
       AUTHOR.          RYAN STAUFFACHER                                00030003
       INSTALLATION.    KOHLS DEPARTMENT STORES.                        00040003
       DATE-WRITTEN.    02/12/2008.                                     00050003
       DATE-COMPILED.                                                   00060003
      ******************************************************************00070003
      **  MR PURGE OF TMRTRN                                            00080003
      **                                                                00090003
      **  THE PROGRAM WILL PURGE ROWS FROM TMRTRN THAT ARE MORE THAN    00100003
      **  FOUR MONTHS OLD.                                              00110003
      ******************************************************************00120003
218056**  02/18/2019    JIM HUNTER    CHG0218056                        00130003
218056**  MAINFRAME REFACTORING - MR JOBS WILL NOT BE REFACTORED BECAUSE00140003
218056**  THEY CALL INFOREM PROGRAMS WHICH ARE OWNED BY A VENDOR AND    00150003
218056**  CAN NOT BE REFACTORED.  SINCE THIS JOB DOES NOT CALL ANY      00160003
218056**  INFOREM MODULES AND IT LOCKS TABLES, IT WILL BE COPIED TO     00170003
218056**  AN MX JOB SO THAT IT CAN BE REFACTORED.  MR JOBS REMAINING    00180003
218056**  ON THE MAINFRAME WILL BE POINTED TO THE DB2 LUW TABLES AND    00190003
218056**  CAN NOT LOCK TABLES.                                          00200003
218056******************************************************************00210003
       ENVIRONMENT DIVISION.                                            00220003
       CONFIGURATION SECTION.                                           00230003
       SOURCE-COMPUTER.        IBM-3090.                                00240003
       OBJECT-COMPUTER.        IBM-3090.                                00250003
       INPUT-OUTPUT SECTION.                                            00260003
       FILE-CONTROL.                                                    00270003
                                                                        00280003
       DATA DIVISION.                                                   00290003
       FILE SECTION.                                                    00300003
                                                                        00310003
       WORKING-STORAGE SECTION.                                         00320003
      ******************************************************************00330003
      **SWITCHES                                                        00340003
      ******************************************************************00350003
       01  PS-PROGRAM-SWITCHES.                                         00360003
           05  PS-TMRTRN-CSR-SW             PIC X(01)   VALUE 'Y'.      00370003
               88  PS-NOT-EOF-TMRTRN-CSR                VALUE 'Y'.      00380003
               88  PS-EOF-TMRTRN-CSR                    VALUE 'N'.      00390003
0423RM     05  PS-TMRSTTR-EOF-SW            PIC X(01)   VALUE 'N'.      00391004
0423RM         88  PS-TMRSTTR-EOF                       VALUE 'Y'.      00392004
                                                                        00400003
      ******************************************************************00410003
      **PROGRAM CONSTANTS                                               00420003
      ******************************************************************00430003
       01  PC-PROGRAM-CONSTANTS.                                        00440003
218056     05  PC-PGM-NAME                PIC X(08)   VALUE 'MXKUP141'. 00450003
218056     05  PC-JOB-NAME                PIC X(08)   VALUE 'MXK502'.   00460003
           05  PC-MAX-RETRIES             PIC S9(04)  COMP SYNC         00470003
                                                      VALUE +3.         00480003
                                                                        00490003
0423RM******************************************************************00500004
0423RM**PROGRAM COUNTS                                                  00510004
0423RM******************************************************************00520004
0423RM 01  PC-PROGRAM-COUNTS.                                           00530004
0423RM     05  PC-NBR-TMRTRN-DELETES      PIC 9(09)   VALUE ZERO.       00540004
0423RM     05  PC-NBR-TMRSKTR-DELETES     PIC 9(09)   VALUE ZERO.       00550004
0423RM     05  PC-NBR-TMRGRTR-DELETES     PIC 9(09)   VALUE ZERO.       00560004
0423RM     05  PC-NBR-TMRSTTR-DELETES     PIC 9(09)   VALUE ZERO.       00570004
                                                                        00580003
                                                                        00650003
      ******************************************************************00660003
      **PROGRAM VARIABLES                                               00670003
      ******************************************************************00680003
       01  PV-PROGRAM-COUNTERS.                                         00690003
           05  PV-RETRY-CNT               PIC S9(04)  VALUE ZEROS.      00700003
       01  PV-ABEND-FIELDS.                                             00710003
           05  PV-ABEND-CODE              PIC S9(4) VALUE ZERO.         00720003
           05  PV-PARAGRAPH-NAME          PIC X(30) VALUE SPACE.        00730003
           05  PV-OPERATION-MSG-1         PIC X(40) VALUE SPACE.        00740003
           05  PV-OPERATION-MSG-2         PIC X(40) VALUE SPACE.        00750003
       01  PV-COMMIT-COUNT                PIC 9(09) VALUE ZERO.         00760003
      ******************************************************************00770003
      **COPYBOOKS                                                       00780003
      ******************************************************************00790003
      ***VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004        00800003
           COPY DPWS004.                                                00810003
                                                                        00820003
      ***DB2 ABEND COPYBOOK                                             00830003
           COPY DPWS900.                                                00840003
                                                                        00850003
      ***DB2 MESSAGE AREA                                               00860003
           COPY SQLCA2.                                                 00870003
                                                                        00880003
      ***DB2 COMMUNICATIONS AREA                                        00890003
           EXEC SQL                                                     00900003
                INCLUDE SQLCA                                           00910003
           END-EXEC.                                                    00920003
                                                                        00930003
      ******************************************************************00940003
      **TABLES                                                          00950003
      ******************************************************************00960003
      ***TABLE TMRGRTR                                                  00970003
           EXEC SQL                                                     00980003
                INCLUDE TMRGRTR                                         00990003
           END-EXEC.                                                    01000003
      ***TABLE TMRTRN                                                   01010003
           EXEC SQL                                                     01020003
                INCLUDE TMRTRN                                          01030003
           END-EXEC.                                                    01040003
      ***TABLE TMRSKTR                                                  01050003
           EXEC SQL                                                     01060003
                INCLUDE TMRSKTR                                         01070003
           END-EXEC.                                                    01080003
      ***TABLE TMRSTTR                                                  01090003
           EXEC SQL                                                     01100003
                INCLUDE TMRSTTR                                         01110003
           END-EXEC.                                                    01120003
      ***************************************************************** 01130003
       PROCEDURE DIVISION.                                              01140003
      ***************************************************************** 01150003
                                                                        01160003
218056     DISPLAY 'BEGIN MESSAGES FOR MXKUP141'.                       01170003
                                                                        01180003
           PERFORM 2000-DELETE-TABLES                                   01190003
                                                                        01200003
           DISPLAY 'COMMIT COUNT: ' PV-COMMIT-COUNT.                    01210003
218056     DISPLAY 'END   MESSAGES FOR MXKUP141'.                       01220003
                                                                        01230003
           GOBACK.                                                      01240003
                                                                        01250003
      ******************************************************************01260003
      **LOCK THE TMRTRN TABLE                                           01270003
      ******************************************************************01280003
       1100-LOCK-TMRTRN.                                                01290003
           MOVE '1100-LOCK-TMRTRN ' TO PV-PARAGRAPH-NAME.               01300003
                                                                        01310003
           INITIALIZE PV-RETRY-CNT.                                     01320003
           PERFORM WITH TEST AFTER                                      01330003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           01340003
             UNTIL SQLCODE = ZERO                                       01350003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        01360003
                   EXEC SQL                                             01370003
                       LOCK TABLE TMRTRN IN EXCLUSIVE MODE              01380004
                   END-EXEC                                             01390003
                                                                        01400003
                   EVALUATE TRUE                                        01410003
                       WHEN SQLCODE = ZERO                              01420003
                            CONTINUE                                    01430003
                       WHEN SQLCODE = -904                              01440003
                       WHEN SQLCODE = -911                              01450003
                       WHEN SQLCODE = -913                              01460003
                            CONTINUE                                    01470003
                       WHEN SQLWARN NOT = SPACES                        01480003
                       WHEN SQLCODE NOT = ZERO                          01490003
                            MOVE 'LOCK TMRTRN PROBLEM'                  01500003
                                              TO  PV-OPERATION-MSG-1    01510003
                            PERFORM 9900-SQL-ABEND-ROUTINE              01520003
                   END-EVALUATE                                         01530003
           END-PERFORM.                                                 01540003
                                                                        01550003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             01560003
               MOVE 'LOCK TMRTRN RETRIES EXCEEDED '                     01570003
                                      TO  PV-OPERATION-MSG-1            01580003
               PERFORM 9900-SQL-ABEND-ROUTINE                           01590003
           END-IF.                                                      01600003
                                                                        01610003
      ******************************************************************01620003
      **LOCK THE TMRGRTR TABLE                                          01630003
      ******************************************************************01640003
       1200-LOCK-TMRGRTR.                                               01650003
           MOVE '1200-LOCK-TMRGRTR ' TO PV-PARAGRAPH-NAME.              01660003
                                                                        01670003
           INITIALIZE PV-RETRY-CNT.                                     01680003
           PERFORM WITH TEST AFTER                                      01690003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           01700003
             UNTIL SQLCODE = ZERO                                       01710003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        01720003
                   EXEC SQL                                             01730003
                       LOCK TABLE TMRGRTR IN EXCLUSIVE MODE             01740004
                   END-EXEC                                             01750003
                                                                        01760003
                   EVALUATE TRUE                                        01770003
                       WHEN SQLCODE = ZERO                              01780003
                            CONTINUE                                    01790003
                       WHEN SQLCODE = -904                              01800003
                       WHEN SQLCODE = -911                              01810003
                       WHEN SQLCODE = -913                              01820003
                            CONTINUE                                    01830003
                       WHEN SQLWARN NOT = SPACES                        01840003
                       WHEN SQLCODE NOT = ZERO                          01850003
                            MOVE 'LOCK TMRGRTR PROBLEM'                 01860003
                                              TO  PV-OPERATION-MSG-1    01870003
                            PERFORM 9900-SQL-ABEND-ROUTINE              01880003
                   END-EVALUATE                                         01890003
           END-PERFORM.                                                 01900003
                                                                        01910003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             01920003
               MOVE 'LOCK TMRGRTR RETRIES EXCEEDED '                    01930003
                                      TO  PV-OPERATION-MSG-1            01940003
               PERFORM 9900-SQL-ABEND-ROUTINE                           01950003
           END-IF.                                                      01960003
                                                                        01970003
      ******************************************************************01980003
      **LOCK THE TMRSTTR TABLE                                          01990003
      ******************************************************************02000003
       1300-LOCK-TMRSTTR.                                               02010003
           MOVE '1300-LOCK-TMRSTTR ' TO PV-PARAGRAPH-NAME.              02020003
                                                                        02030003
           INITIALIZE PV-RETRY-CNT.                                     02040003
           PERFORM WITH TEST AFTER                                      02050003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           02060003
             UNTIL SQLCODE = ZERO                                       02070003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        02080003
                   EXEC SQL                                             02090003
                       LOCK TABLE TMRSTTR IN EXCLUSIVE MODE             02100004
                   END-EXEC                                             02110003
                                                                        02120003
                   EVALUATE TRUE                                        02130003
                       WHEN SQLCODE = ZERO                              02140003
                            CONTINUE                                    02150003
                       WHEN SQLCODE = -904                              02160003
                       WHEN SQLCODE = -911                              02170003
                       WHEN SQLCODE = -913                              02180003
                            CONTINUE                                    02190003
                       WHEN SQLWARN NOT = SPACES                        02200003
                       WHEN SQLCODE NOT = ZERO                          02210003
                            MOVE 'LOCK TMRSTTR PROBLEM'                 02220003
                                              TO  PV-OPERATION-MSG-1    02230003
                            PERFORM 9900-SQL-ABEND-ROUTINE              02240003
                   END-EVALUATE                                         02250003
           END-PERFORM.                                                 02260003
                                                                        02270003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             02280003
               MOVE 'LOCK TMRSTTR RETRIES EXCEEDED '                    02290003
                                      TO  PV-OPERATION-MSG-1            02300003
               PERFORM 9900-SQL-ABEND-ROUTINE                           02310003
           END-IF.                                                      02320003
                                                                        02330003
      ******************************************************************02340003
      **LOCK THE TMRSKTR TABLE                                          02350003
      ******************************************************************02360003
       1400-LOCK-TMRSKTR.                                               02370003
           MOVE '1400-LOCK-TMRSKTR ' TO PV-PARAGRAPH-NAME.              02380003
                                                                        02390003
           INITIALIZE PV-RETRY-CNT.                                     02400003
           PERFORM WITH TEST AFTER                                      02410003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           02420003
             UNTIL SQLCODE = ZERO                                       02430003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        02440003
                   EXEC SQL                                             02450003
                       LOCK TABLE TMRSKTR IN EXCLUSIVE MODE             02460004
                   END-EXEC                                             02470003
                                                                        02480003
                   EVALUATE TRUE                                        02490003
                       WHEN SQLCODE = ZERO                              02500003
                            CONTINUE                                    02510003
                       WHEN SQLCODE = -904                              02520003
                       WHEN SQLCODE = -911                              02530003
                       WHEN SQLCODE = -913                              02540003
                            CONTINUE                                    02550003
                       WHEN SQLWARN NOT = SPACES                        02560003
                       WHEN SQLCODE NOT = ZERO                          02570003
                            MOVE 'LOCK TMRSKTR PROBLEM'                 02580003
                                              TO  PV-OPERATION-MSG-1    02590003
                            PERFORM 9900-SQL-ABEND-ROUTINE              02600003
                   END-EVALUATE                                         02610003
           END-PERFORM.                                                 02620003
                                                                        02630003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             02640003
               MOVE 'LOCK TMRSKTR RETRIES EXCEEDED '                    02650003
                                      TO  PV-OPERATION-MSG-1            02660003
               PERFORM 9900-SQL-ABEND-ROUTINE                           02670003
           END-IF.                                                      02680003
                                                                        02690003
      ***************************************************************** 02700003
      **DELETE ROWS                                                     02710003
      ***************************************************************** 02720003
       2000-DELETE-TABLES.                                              02730003
                                                                        02740003
           PERFORM 2100-DELETE-TMRSKTR                                  02750003
0423RM     DISPLAY 'TMRSKTR DELETE COUNT: ' PC-NBR-TMRSKTR-DELETES.     02760004
                                                                        02770003
           PERFORM 2200-DELETE-TMRGRTR.                                 02780003
0423RM     DISPLAY 'TMRGRTR DELETE COUNT: ' PC-NBR-TMRGRTR-DELETES.     02790004
                                                                        02800003
0423RM     MOVE 'N' TO PS-TMRSTTR-EOF-SW.                               02810004
           PERFORM 2300-DELETE-TMRSTTR                                  02820003
0423RM         UNTIL PS-TMRSTTR-EOF.                                    02830004
0423RM     DISPLAY 'TMRSTTR DELETE COUNT: ' PC-NBR-TMRSTTR-DELETES.     02840004
                                                                        02850003
           PERFORM 2400-DELETE-TMRTRN.                                  02860003
0423RM     DISPLAY 'TMRTRN DELETE COUNT: '  PC-NBR-TMRTRN-DELETES.      02870004
                                                                        02880003
      ***************************************************************** 02890003
      **DELETE ROWS FROM TABLE TMRSTTR                                  02900003
      ***************************************************************** 02910003
       2100-DELETE-TMRSKTR.                                             02920003
           MOVE '2100-DELETE-TMRSKTR ' TO PV-PARAGRAPH-NAME.            02930003
                                                                        02940003
           PERFORM 1400-LOCK-TMRSKTR.                                   02950003
                                                                        02960003
           INITIALIZE PV-RETRY-CNT.                                     02970003
           PERFORM WITH TEST AFTER                                      02980003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           02990003
             UNTIL SQLCODE = ZERO                                       03000003
                OR SQLCODE = +100                                       03010003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03020003
                   EXEC SQL                                             03030003
                      DELETE                                            03040003
                        FROM TMRSKTR SK                                 03050004
                       WHERE EXISTS (SELECT 'X'                         03060003
                                       FROM TMRTRN TR                   03070004
                                      WHERE TR.DEPT_NBR = SK.DEPT_NBR   03080003
                                        AND TR.TRN_ID   = SK.TRN_ID     03090003
                                        AND LAST_UPD_TMST <             03100003
                                         CURRENT TIMESTAMP - 4 MONTHS)  03110003
                   END-EXEC                                             03120003
                                                                        03130003
                   EVALUATE TRUE                                        03140003
                      WHEN SQLCODE = ZERO                               03150003
0423RM                     ADD SQLERRD (3) TO PC-NBR-TMRSKTR-DELETES    03160004
                      WHEN SQLCODE = +100                               03170003
                           CONTINUE                                     03180003
                      WHEN SQLCODE = -904                               03190003
                      WHEN SQLCODE = -911                               03200003
                      WHEN SQLCODE = -913                               03210003
                         CONTINUE                                       03220003
                      WHEN OTHER                                        03230003
                         DISPLAY 'CANT DELETE FROM TMRSKTR'             03240003
                         PERFORM 9900-SQL-ABEND-ROUTINE                 03250003
                   END-EVALUATE                                         03260003
           END-PERFORM.                                                 03270003
                                                                        03280003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03290003
              MOVE 'DEL OF TMRSKTR TBL RETRIES EXCEEDED  '              03300003
                                     TO  PV-OPERATION-MSG-1             03310003
              PERFORM 9900-SQL-ABEND-ROUTINE                            03320003
           END-IF.                                                      03330003
                                                                        03340003
           PERFORM 8000-COMMIT-WORK.                                    03350003
                                                                        03360003
      ***************************************************************** 03370003
      **DELETE ROWS FROM TABLE TMRGRTR                                  03380003
      ***************************************************************** 03390003
       2200-DELETE-TMRGRTR.                                             03400003
           MOVE '2200-DELETE-TMRGRTR ' TO PV-PARAGRAPH-NAME.            03410003
                                                                        03420003
           PERFORM 1200-LOCK-TMRGRTR.                                   03430003
                                                                        03440003
           INITIALIZE PV-RETRY-CNT.                                     03450003
           PERFORM WITH TEST AFTER                                      03460003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           03470003
             UNTIL SQLCODE = ZERO                                       03480003
                OR SQLCODE = +100                                       03490003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03500003
                   EXEC SQL                                             03510003
                      DELETE                                            03520003
                        FROM TMRGRTR GR                                 03530004
                       WHERE EXISTS (SELECT 'X'                         03540003
                                       FROM TMRTRN TR                   03550004
                                      WHERE TR.DEPT_NBR = GR.DEPT_NBR   03560003
                                        AND TR.TRN_ID   = GR.TRN_ID     03570003
                                        AND LAST_UPD_TMST <             03580003
                                         CURRENT TIMESTAMP - 4 MONTHS)  03590003
                   END-EXEC                                             03600003
                                                                        03610003
                   EVALUATE TRUE                                        03620003
                      WHEN SQLCODE = ZERO                               03630003
0423RM                     ADD SQLERRD (3) TO PC-NBR-TMRGRTR-DELETES    03640004
                      WHEN SQLCODE = +100                               03650003
                           CONTINUE                                     03660003
                      WHEN SQLCODE = -904                               03670003
                      WHEN SQLCODE = -911                               03680003
                      WHEN SQLCODE = -913                               03690003
                         CONTINUE                                       03700003
                      WHEN OTHER                                        03710003
                         DISPLAY 'CANT DELETE FROM TMRGRTR'             03720003
                         PERFORM 9900-SQL-ABEND-ROUTINE                 03730003
                   END-EVALUATE                                         03740003
           END-PERFORM.                                                 03750003
                                                                        03760003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             03770003
              MOVE 'DEL OF TMRGRTR TBL RETRIES EXCEEDED  '              03780003
                                     TO  PV-OPERATION-MSG-1             03790003
              PERFORM 9900-SQL-ABEND-ROUTINE                            03800003
           END-IF.                                                      03810003
                                                                        03820003
           PERFORM 8000-COMMIT-WORK.                                    03830003
                                                                        03840003
      ***************************************************************** 03850003
      **DELETE ROWS FROM TABLE TMRSKTR                                  03860003
      ***************************************************************** 03870003
       2300-DELETE-TMRSTTR.                                             03880003
           MOVE '2300-DELETE-TMRSTTR ' TO PV-PARAGRAPH-NAME.            03890003
                                                                        03900003
           PERFORM 1300-LOCK-TMRSTTR.                                   03910003
                                                                        03920003
           INITIALIZE PV-RETRY-CNT.                                     03930003
           PERFORM WITH TEST AFTER                                      03940003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           03950003
             UNTIL SQLCODE = ZERO                                       03960003
                OR SQLCODE = +100                                       03970003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        03980003
                   EXEC SQL                                             03990003
                      DELETE                                            04000003
                        FROM TMRSTTR ST                                 04010004
                       WHERE EXISTS (SELECT 'X'                         04020003
                                       FROM TMRTRN TR                   04030004
                                      WHERE TR.DEPT_NBR = ST.DEPT_NBR   04040003
                                        AND TR.TRN_ID   = ST.TRN_ID     04050003
                                        AND LAST_UPD_TMST <             04060003
                                         CURRENT TIMESTAMP - 4 MONTHS)  04070003
0423RM                FETCH FIRST 200000 ROWS ONLY                      04080004
                   END-EXEC                                             04090003
                                                                        04100003
                   EVALUATE TRUE                                        04110003
                      WHEN SQLCODE = ZERO                               04120003
0423RM                     ADD SQLERRD (3) TO PC-NBR-TMRSTTR-DELETES    04130004
                      WHEN SQLCODE = +100                               04140003
                           MOVE 'Y' TO PS-TMRSTTR-EOF-SW                04150003
                      WHEN SQLCODE = -904                               04160003
                      WHEN SQLCODE = -911                               04170003
                      WHEN SQLCODE = -913                               04180003
                         CONTINUE                                       04190003
                      WHEN OTHER                                        04200003
                         DISPLAY 'CANT DELETE FROM TMRSTTR'             04210003
                         PERFORM 9900-SQL-ABEND-ROUTINE                 04220003
                   END-EVALUATE                                         04230003
           END-PERFORM.                                                 04240003
                                                                        04250003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             04260003
              MOVE 'DEL OF TMRSTTR TBL RETRIES EXCEEDED  '              04270003
                                     TO  PV-OPERATION-MSG-1             04280003
              PERFORM 9900-SQL-ABEND-ROUTINE                            04290003
           END-IF.                                                      04300003
                                                                        04310003
           PERFORM 8000-COMMIT-WORK.                                    04320003
                                                                        04330003
      ***************************************************************** 04340003
      **DELETE ROWS FROM TABLE TMRTRN                                   04350003
      ***************************************************************** 04360003
       2400-DELETE-TMRTRN.                                              04370003
           MOVE '2200-DELETE-TMRTRN ' TO PV-PARAGRAPH-NAME.             04380003
                                                                        04390003
           PERFORM 1100-LOCK-TMRTRN.                                    04400003
                                                                        04410003
           INITIALIZE PV-RETRY-CNT.                                     04420003
           PERFORM WITH TEST AFTER                                      04430003
             VARYING PV-RETRY-CNT FROM 1 BY 1                           04440003
             UNTIL SQLCODE = ZERO                                       04450003
                OR SQLCODE = +100                                       04460003
                OR PV-RETRY-CNT > PC-MAX-RETRIES                        04470003
                   EXEC SQL                                             04480003
                      DELETE                                            04490003
                        FROM TMRTRN                                     04500004
                       WHERE LAST_UPD_TMST <                            04510003
                                         CURRENT TIMESTAMP - 4 MONTHS   04520003
                   END-EXEC                                             04530003
                                                                        04540003
                   EVALUATE TRUE                                        04550003
                      WHEN SQLCODE = ZERO                               04560003
0423RM                     ADD SQLERRD (3) TO PC-NBR-TMRTRN-DELETES     04570004
                      WHEN SQLCODE = +100                               04580003
                           CONTINUE                                     04590003
                      WHEN SQLCODE = -904                               04600003
                      WHEN SQLCODE = -911                               04610003
                      WHEN SQLCODE = -913                               04620003
                         CONTINUE                                       04630003
                      WHEN OTHER                                        04640003
                         DISPLAY 'CANT DELETE FROM TMRGRTR'             04650003
                         PERFORM 9900-SQL-ABEND-ROUTINE                 04660003
                   END-EVALUATE                                         04670003
           END-PERFORM.                                                 04680003
                                                                        04690003
           IF PV-RETRY-CNT > PC-MAX-RETRIES                             04700003
              MOVE 'DEL OF TMRGRTR TBL RETRIES EXCEEDED  '              04710003
                                     TO  PV-OPERATION-MSG-1             04720003
              PERFORM 9900-SQL-ABEND-ROUTINE                            04730003
           END-IF.                                                      04740003
                                                                        04750003
           PERFORM 8000-COMMIT-WORK.                                    04760003
                                                                        04770003
      *----------------------------------------------------------       04780003
      * 8000-COMMIT-WORK.                                               04790003
      *     COMMIT WORK.                                                04800003
      *----------------------------------------------------------       04810003
       8000-COMMIT-WORK.                                                04820003
                                                                        04830003
           EXEC SQL                                                     04840003
               COMMIT                                                   04850003
           END-EXEC.                                                    04860003
                                                                        04870003
           EVALUATE TRUE                                                04880003
             WHEN SQLCODE = ZERO                                        04890003
               ADD +1                  TO PV-COMMIT-COUNT               04900003
             WHEN OTHER                                                 04910003
               DISPLAY 'CANT COMMIT'                                    04920003
               PERFORM 9900-SQL-ABEND-ROUTINE                           04930003
           END-EVALUATE.                                                04940003
                                                                        04950003
      *----------------------------------------------------------       04960003
      * 9800-ABEND-ROUTINE.                                             04970003
      *     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.                  04980003
      *----------------------------------------------------------       04990003
       9800-ABEND-ROUTINE.                                              05000003
           DISPLAY '** ABEND           **'.                             05010003
           DISPLAY '** PROGRAM         ** = ' PC-PGM-NAME.              05020003
           DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        05030003
           DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       05040003
           DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       05050003
           MOVE +4000 TO PV-ABEND-CODE                                  05060003
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05070003
                                                                        05080003
                                                                        05090003
      ******************************************************************05100003
      **SQL ABEND ROUTINE                                               05110003
      ******************************************************************05120003
       9900-SQL-ABEND-ROUTINE.                                          05130003
           DISPLAY '** ABEND     **'.                                   05140003
           DISPLAY '** PROGRAM   ** = ' PC-PGM-NAME.                    05150003
           DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              05160003
           DISPLAY '** OPERATION ** = ' PV-OPERATION-MSG-1.             05170003
      *    STMTS FOR USING SQLCA MSG DISPLAY MODULE "DSNTIAR"           05180003
           COPY DPPD004.                                                05190003
           MOVE 4013          TO PV-ABEND-CODE.                         05200003
           CALL 'ILBOABN0' USING PV-ABEND-CODE.                         05210003
