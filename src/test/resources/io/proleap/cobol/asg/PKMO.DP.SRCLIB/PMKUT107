      ******************************************************************00010000
       IDENTIFICATION DIVISION.                                         00020000
      ******************************************************************00030000
                                                                        00040000
       PROGRAM-ID.      PMKUT107.                                       00050000
       AUTHOR.          DARYL WOELFEL.                                  00060000
       INSTALLATION.    KOHLS DEPARTMENT STORES.                        00070000
       DATE-WRITTEN.    SEPTEMBER 2003.                                 00080000
       DATE-COMPILED.                                                   00090000
                                                                        00100000
      ******************************************************************00110000
      * NEW PROMO EXCEPTION REPORTING - BLOW TO SKU/STORE AND LOOK UP  *00120000
      * SKU INFO.                                                      *00130000
      ******************************************************************00140000
      **   CHANGE LOG:                                                 *00150000
      ******************************************************************00160000
      * 11/17/2003  P000609432                                         *00170000
      *                                                                *00180000
      * COLLEEN CUMMINGS.                                              *00190000
      * FIX TO CHECK PV-END-TMST INSTEAD OF PV-BEG-TMST WHEN           *00200000
      * COMPARING END-TMST FROM XST_SKU_LOC - OTHERWISE RETURNED -811  *00210000
      * (DUPLICATE ROW) IN SOME SITUATIONS.                            *00220000
      *                                                                 00230000
      * 02/02/2004  WR26451                                            *00240000
      * KELLY LARUM.                                                   *00250000
      * CONSIDER FUTURE PERM PRICE CHANGES                             *00260000
      *                                                                *00270000
      * DATE:         02/26/2004                                       *00280000
      * WR/IR#:       WR26451                                          *00290000
      * PROGRAMMER:   COLLEEN CUMMINGS                                 *00300000
      * DESCRIPTION:  CHANGED LOOKUP TO TSKST INFORMATION BASED ON     *00310000
      *               STORE 0 INSTEAD OF INDIVIDUAL SAMPLE STORES.     *00320000
      *               NEEDED TO DO THIS IF MDSE WAS RECEIVED IN STORES *00330000
      *               OTHER THAN SAMPLE STORES - ELSE WE SKIP IF NO    *00340000
      *               ORDER EITHER - SO WE WOULD BE MISSING VIOLATIONS.*00350000
      *                                                                *00360000
      * DATE:         07/22/2004                                       *00370000
      * WR/IR#:       P000674595                                       *00380000
      * PROGRAMMER:   COLLEEN CUMMINGS                                 *00390000
      * DESCRIPTION:  FIX -811 ON PERM PRICE LOOKUP IN PARAGRAPH       *00400000
      *               H500.  ALLOWED -811 TO BE VALID.                 *00410000
      *                                                                *00420000
      * DATE:         03/15/2005                                       *00430000
      * PROGRAMMER:   KELLY WIESNER                                    *00440000
      * DESCRIPTION:  STORE NUMBER EXPANSION PROJECT                   *00450000
      *               CHANGED STORE_NMBR TO LOC_NBR FOR TSKST QUERY    *00460000
      *               AND COMMIT LOGIC AND NEW PERM CHANGES             00470000
      *                                                                *00471000
      * DATE:         11/11/2005                                       *00471100
      * WR/IR#:       P000821491                                       *00471200
      * PROGRAMMER:   TOM BOYD                                         *00471300
      * DESCRIPTION:  BROKE SKU_LOC INTO SEPERATE CURSOR TO HELP       *00471400
      *               IMPROVED PERFORMANCE.                            *00471500
JB0201*                                                                *00471602
JB0201* DATE:         02/01/2006                                       *00471702
JB0201* PROGRAMMER:   JOHN BOLDT, STRATAGEM                            *00471902
JB0201* DESCRIPTION:  PERFORMANCE ENHANCEMENT CHANGES AS RECOMMENDED   *00472002
JB0201*               BY DBA.                                          *00472102
JB0308*                                                                *        
JB0308* DATE:         03/08/2006                                       *        
JB0308* WR/IR#:       WR30242                                          *        
JB0308* PROGRAMMER:   JOHN BOLDT, STRATAGEM                            *        
JB0308* DESCRIPTION:  MOVE SKU_LOC CURSOR PROCESSING INTO SEPARATE     *        
JB0308*               PROGRAM FOR IMPROVED PERFORMANCE PER DBA.        *        
JB0308*               THIS REQUIRES SPLITTING PMKUT107 INTO 3 PROGRAMS,*        
JB0308*               THIS ONE (PMKUT107), PMKUT143, AND PMKUT144.     *        
C21565*                                                                *        
C21565* DATE:         09/01/2015                                       *        
C21565* WR/IR#:       CHG0121565                                       *        
C21565* PROGRAMMER:   JOHN SELWITSCHKA                                 *        
C21565* DESCRIPTION:  PERFORMANCE IMPROVEMENT. REDUCE REPEATED SELECTS *        
C21565*               OF THE SAME DATA.                                *        
      *                                                                *        
C44283* DATE:         06/14/2016                                       *        
C44283* WR/IR#:       CHG0144283                                       *        
C44283* PROGRAMMER:   COGNIZANT                                        *        
C44283* DESCRIPTION:  MODIFIED LOGIC IN SCL,MCL AND DPT TO COMPARE WITH*        
C44283*               PREVIOUS INPUT RECORD AND SKIP DUPLICATE ROWS    *        
      *                                                                *        
C47460* DATE:         07/28/2016                                       *        
C47460* WR/IR#:       CHG0147460                                       *        
C47460* PROGRAMMER:   COGNIZANT                                        *        
C47460* DESCRIPTION:  REMOVED TIME CHECKS, COMMITS AND DECREASED       *        
C47460*               DISPLAY FREQUENCY FOR CPU PERFORMANCE            *        
C47460*               IMPROVEMENT                                      *        
      *                                                                *        
C35506* DATE:         11/08/2019                                       *        
C35506* WR/IR#:       CHG0235506                                       *        
C35506* PROGRAMMER:   COGNIZANT                                        *        
C35506* DESCRIPTION:  INCREASED INTERNAL TABLE SIZE FROM 99999 TO      *        
C35506*               150000                                           *        
      *                                                                *        
C49816* DATE:         10/08/2020                                       *        
C49816* WR/IR#:       CHG0235506                                       *        
C49816* PROGRAMMER:   COGNIZANT                                        *        
C49816* DESCRIPTION:  INCREASED INTERNAL TABLE SIZE FROM 150000 TO     *        
C49816*               200000                                           *        
      *                                                                *        
C72453* DATE:         07/22/2022                                       *        
C72453* WR/IR#:       CHG0272453                                       *        
C72453* PROGRAMMER:   COGNIZANT                                        *        
C72453* DESCRIPTION:  INCREASED INTERNAL TABLE SIZE FROM 400000 TO     *        
C72453*               600000                                           *        
      ******************************************************************00472200
                                                                        00472300
      ******************************************************************00472400
       ENVIRONMENT DIVISION.                                            00472500
      ******************************************************************00472600
                                                                        00473000
       CONFIGURATION SECTION.                                           00474000
                                                                        00475000
       SOURCE-COMPUTER. IBM-3090.                                       00476000
       OBJECT-COMPUTER. IBM-3090.                                       00477000
                                                                        00478000
       INPUT-OUTPUT SECTION.                                            00479000
                                                                        00480000
       FILE-CONTROL.                                                    00490000
                                                                        00500000
           SELECT PRICING-FILE                                          00510000
               ASSIGN                       TO INP01.                   00520000
                                                                        00530000
           SELECT EXPLODED-FILE                                         00540000
               ASSIGN                       TO OUT01.                   00550000
                                                                        00560000
      ******************************************************************00570000
       DATA DIVISION.                                                   00580000
      ******************************************************************00590000
                                                                        00600000
       FILE SECTION.                                                    00610000
                                                                        00620000
       FD  PRICING-FILE                                                 00630000
           RECORDING MODE F                                             00640000
           BLOCK CONTAINS 0 RECORDS                                     00650000
           LABEL RECORDS ARE STANDARD.                                  00660000
       01  PRICING-REC                   PIC X(154).                    00670000
                                                                        00680000
       FD  EXPLODED-FILE                                                00690000
           RECORDING MODE F                                             00700000
           BLOCK CONTAINS 0 RECORDS                                     00710000
           LABEL RECORDS ARE STANDARD.                                  00720000
JB0308 01  EXPLODED-REC                  PIC X(247).                    00730000
                                                                        00740000
       WORKING-STORAGE SECTION.                                         00750000
                                                                        00760000
      ******************************************************************00770000
      * PC PROGRAM CONSTANTS                                            00780000
      ******************************************************************00790000
       01  PC-PROGRAM-CONSTANTS.                                        00800000
           05  PC-PROGRAM-NAME              PIC X(08)     VALUE         00810000
                                                          'PMKUT107'.   00820000
C72453     05  PC-EXCL-LIMIT                PIC 9(06)     VALUE 600000. 00830000
                                                                        00840000
      ******************************************************************00850000
      * PV PROGRAM VARIABLES                                            00860000
      ******************************************************************00870000
       01  PV-PROGRAM-VARIABLES.                                        00880000
           05  PV-PARAGRAPH-NAME            PIC X(40) VALUE SPACES.     00890000
           05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACES.     00900000
           05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACES.     00910000
           05  PV-CPU-TIME                  PIC 9(08) VALUE 0.          00930000
           05  PV-DEPT-NBR                  PIC S9(04)V COMP-3 VALUE 0. 01490000
           05  PV-MAJ-CL-NBR                PIC S9(04)V COMP-3 VALUE 0. 01500000
           05  PV-SUB-CL-NBR                PIC S9(04)V COMP-3 VALUE 0. 01510000
           05  PV-VS-ID                     PIC S9(09) COMP VALUE 0.    01520000
           05  PV-SKU-NBR                   PIC S9(08)V COMP-3 VALUE 0. 01530000
           05  PV-RECS-DIV                  PIC S9(09)  VALUE 0.        01570000
           05  PV-RECS-REM                  PIC S9(09)  VALUE 0.        01580000
           05  PV-EXCL-SUB                  PIC 9(04) VALUE 0.          01620000
           05  PV-MAX-EXCL                  PIC 9(04) VALUE 0.          01630000
C21565     05  PV-SUB-CL-NBR-SAVE           PIC S9(04)V COMP-3 VALUE 0. 01630000
C21565     05  PV-MAJ-CL-NBR-SAVE           PIC S9(04)V COMP-3 VALUE 0. 01630000
C21565     05  PV-DEPT-NBR-SAVE             PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PA-MCL-SKIP-COUNTER          PIC 9(09)  VALUE 0.                 
           05  PA-SCL-SKIP-COUNTER          PIC 9(09)  VALUE 0.                 
           05  PA-DPT-SKIP-COUNTER          PIC 9(09)  VALUE 0.                 
      *    CHANGE PC-EXCL-LIMIT TO MATCH ANY CHANGE IN SIZE HERE        01640000
           05  PT-EXCLUSION-TABLE                                       01650000
               OCCURS 600000 TIMES.                                     01660000
               10  PT-MDSE-SELN-ID          PIC 9(10).                  01670000
               10  PT-MDSE-SELN-LNE-ID      PIC 9(10).                  01680000
               10  PT-SKU-NBR               PIC 9(08).                  01690000
       01  PV-PROGRAM-TEMP-VARIABLES.                                   00880000
           05  PV-MAJ-CL-NBR-MCL            PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-DEPT-NBR-MCL              PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-STR-NBR-MCL               PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-MDSE-HIER-CDE-MCL         PIC X(03) VALUE SPACES.     01630000
           05  PV-DEPT-NBR-DPT              PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-STR-NBR-DPT               PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-MDSE-HIER-CDE-DPT         PIC X(03) VALUE SPACES.     01630000
           05  PV-MAJ-CL-NBR-SCL            PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-SUB-CL-NBR-SCL            PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-DEPT-NBR-SCL              PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-STR-NBR-SCL               PIC S9(04)V COMP-3 VALUE 0. 01630000
           05  PV-MDSE-HIER-CDE-SCL         PIC X(03) VALUE SPACES.     01630000
C21565* CHANGE PT-SCL-SKU-TBL-MAX TO MATCH ANY CHANGE IN SIZE HERE      01640000
C72453 01  PT-SCL-SKU-TBL-MAX               PIC  9(6)   VALUE 600000.           
C21565 01  PT-SCL-SKU-TABLE.                                            01650000
C21565     05  PT-SCL-SKU-TBL-SIZE          PIC  9(6)   VALUE 0.        01650000
C72453     05  PT-SCL-SKU-TBL-ENTRY OCCURS 600000 TIMES                 01650000
C21565                                      INDEXED BY PT-SCL-SKU-INDX  01650000
C21565                                            PT-SCL-SKU-INDX-SIZE. 01650000
C21565         10  PT-SCL-SKU-NBR           PIC  9(08)  VALUE 0.        01670000
C21565         10  PT-SCL-VS-ID             PIC  9(09)  VALUE 0.        01670000
C21565         10  PT-SCL-VS-NBR            PIC  X(20)  VALUE SPACES.   01680000
C21565         10  PT-SCL-INTR-UPC-ID       PIC S9(09)  COMP  VALUE 0.  01690000
                                                                        01700000
      ******************************************************************01710000
      * PS PROGRAM SWITCHES                                            *01720000
      ******************************************************************01730000
       01  PS-PROGRAM-SWITCHES.                                         01740000
           05  PS-END-OF-PRICING-FILE-SW       PIC X(01)     VALUE 'N'. 01750000
               88  PS-END-OF-PRICING-FILE                    VALUE 'Y'. 01760000
           05  PS-END-OF-STYLE-CSR-SW          PIC X(01)     VALUE 'N'. 01790000
               88  PS-END-OF-STYLE-CSR                       VALUE 'Y'. 01800000
           05  PS-END-OF-SCL-CSR-SW            PIC X(01)     VALUE 'N'. 01810000
               88  PS-END-OF-SCL-CSR                         VALUE 'Y'. 01820000
           05  PS-END-OF-MCL-CSR-SW            PIC X(01)     VALUE 'N'. 01830000
               88  PS-END-OF-MCL-CSR                         VALUE 'Y'. 01840000
           05  PS-END-OF-DEPT-CSR-SW           PIC X(01)     VALUE 'N'. 01850000
               88  PS-END-OF-DEPT-CSR                        VALUE 'Y'. 01860000
           05  PS-SKU-FOUND-SW                 PIC X(01)     VALUE 'N'. 01870000
               88  PS-SKU-FOUND                              VALUE 'N'. 01880000
               88  PS-SKU-NOT-FOUND                          VALUE 'Y'. 01890000
C21565     05  PS-SCL-SKU-FOUND-SW             PIC X(01)     VALUE 'N'. 01870000
C21565         88  PS-SCL-SKU-FOUND                          VALUE 'Y'. 01880000
C21565         88  PS-SCL-SKU-NOT-FOUND                      VALUE 'N'. 01890000
      ******************************************************************01960000
      * PA PROGRAM ACCUMULATORS                                        *01970000
      ******************************************************************01980000
       01  PA-PROGRAM-ACCUMULATORS.                                     01990000
           05  PA-RECS-WRITTEN               PIC S9(13) COMP-3 VALUE 0. 02000000
           05  PA-READ-COUNTER               PIC S9(11) COMP-3 VALUE 0. 02010000
                                                                        02020000
      ******************************************************************02030000
      *    EXCEPTION PRICING EXTRACT INPUT RECORD                       02040000
      ******************************************************************02050000
           COPY PMRD106.                                                02060000
                                                                        02070000
      ******************************************************************02080000
      *    OUTPUT RECORD - INTERIM EXTRACT EXPLODED BY SKU/STORE        02090000
      ******************************************************************02100000
JB0308     COPY PMRD113.                                                02110000
                                                                        02120000
      ******************************************************************02130000
      *    VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004      02140000
      ******************************************************************02150000
           COPY DPWS004.                                                02160000
                                                                        02170000
      ******************************************************************02180000
      *    TABLE INCLUDES                                               02190000
      ******************************************************************02200000
           EXEC SQL INCLUDE TSKXREF END-EXEC.                           02230000
      *    XST_SKU:                                                     02270000
           EXEC SQL INCLUDE XST00010 END-EXEC.                          02280000
      *    XST_VND_STYL:                                                02290000
           EXEC SQL INCLUDE XST00013 END-EXEC.                          02300000
                                                                        02430000
      ******************************************************************02440000
      *    SQL COMMUNICATIONS AREA DCLGEN                               02450000
      ******************************************************************02460000
           EXEC SQL                                                     02470000
               INCLUDE SQLCA                                            02480000
           END-EXEC.                                                    02490000
                                                                        02500000
      ******************************************************************02510000
      *    EXTENSION TO THE SQL COMMUNICATIONS AREA FOR EDITING        *02520000
      *    SQL CODES FOR DISPLAY                                       *02530000
      ******************************************************************02540000
           COPY SQLCA2.                                                 02550000
                                                                        02560000
      ******************************************************************02570000
      *    DEPT-CSR                                                     02580000
      *    03/15/2005 - ADDED WITH HOLD BECAUSE OF THE COMMIT LOGIC     02590000
      *    ADDED - OTHERWISE CURSOR GETS CLOSED UPON COMMIT.            02600000
      ******************************************************************02610000
           EXEC SQL                                                     02620000
                DECLARE DEPT-CSR CURSOR WITH HOLD                       02630000
                FOR SELECT                                              02640000
                      A.MAJ_CL_NBR                                      02650000
                     ,A.SUB_CL_NBR                                      02660000
                     ,A.VS_ID                                           02670000
                     ,A.VS_NBR                                          02680000
                     ,B.INTR_UPC_ID                                     02690000
                     ,B.SKU_NBR                                         02700000
                 FROM XST_VND_STYL A                                    02710000
                     ,XST_SKU B                                         02720000
                     ,TSKXREF X                                         02730000
                WHERE A.STYL_ID = B.STYL_ID                             02740000
                  AND A.DEPT_NBR = :PV-DEPT-NBR                         02750000
                  AND B.INTR_UPC_ID = X.INTR_UPC_ID                     02760000
                  AND X.SKU_STAT_CDE NOT IN ('30','98')                 02770000
                ORDER BY B.INTR_UPC_ID                                  02780000
                WITH UR                                                 02790000
           END-EXEC.                                                    02791000
                                                                        02792000
      ******************************************************************02793000
      *    MCL-CSR                                                      02794000
      *    03/15/2005 - ADDED WITH HOLD BECAUSE OF THE COMMIT LOGIC     02795000
      *    ADDED - OTHERWISE CURSOR GETS CLOSED UPON COMMIT.            02796000
      ******************************************************************02797000
           EXEC SQL                                                     02798000
                DECLARE MCL-CSR CURSOR WITH HOLD                        02799000
                FOR SELECT                                              02800000
                      A.SUB_CL_NBR                                      02810000
                     ,A.VS_ID                                           02820000
                     ,A.VS_NBR                                          02830000
                     ,B.INTR_UPC_ID                                     02840000
                     ,B.SKU_NBR                                         02850000
                 FROM XST_VND_STYL A                                    02860000
                     ,XST_SKU B                                         02870000
                     ,TSKXREF X                                         02880000
                WHERE A.STYL_ID = B.STYL_ID                             02890000
                  AND A.DEPT_NBR = :PV-DEPT-NBR                         02900000
                  AND A.MAJ_CL_NBR = :PV-MAJ-CL-NBR                     02910000
                  AND B.INTR_UPC_ID = X.INTR_UPC_ID                     02920000
                  AND X.SKU_STAT_CDE NOT IN ('30','98')                 02930000
                ORDER BY B.INTR_UPC_ID                                  02940000
                WITH UR                                                 02950000
           END-EXEC.                                                    02960000
                                                                        02970000
      ******************************************************************02980000
      *    SCL-CSR                                                      02990000
      *    03/15/2005 - ADDED WITH HOLD BECAUSE OF THE COMMIT LOGIC     03000000
      *    ADDED - OTHERWISE CURSOR GETS CLOSED UPON COMMIT.            03010000
      ******************************************************************03020000
           EXEC SQL                                                     03030000
                DECLARE SCL-CSR CURSOR WITH HOLD                        03040000
                FOR SELECT                                              03050000
                      A.VS_ID                                           03060000
                     ,A.VS_NBR                                          03070000
                     ,B.INTR_UPC_ID                                     03080000
                     ,B.SKU_NBR                                         03090000
                 FROM XST_VND_STYL A                                    03100000
                     ,XST_SKU B                                         03110000
                     ,TSKXREF X                                         03120000
                WHERE A.STYL_ID = B.STYL_ID                             03130000
                  AND A.DEPT_NBR = :PV-DEPT-NBR                         03140000
                  AND A.MAJ_CL_NBR = :PV-MAJ-CL-NBR                     03150000
                  AND A.SUB_CL_NBR = :PV-SUB-CL-NBR                     03160000
                  AND B.INTR_UPC_ID = X.INTR_UPC_ID                     03170000
                  AND X.SKU_STAT_CDE NOT IN ('30','98')                 03180000
                ORDER BY B.INTR_UPC_ID                                  03190000
                WITH UR                                                 03200000
           END-EXEC.                                                    03210000
                                                                        03220000
      ******************************************************************03230000
      *    STYLE-CSR                                                    03240000
      *    03/15/2005 - ADDED WITH HOLD BECAUSE OF THE COMMIT LOGIC     03250000
      *    ADDED - OTHERWISE CURSOR GETS CLOSED UPON COMMIT.            03260000
      ******************************************************************03270000
           EXEC SQL                                                     03280000
                DECLARE STYLE-CSR CURSOR WITH HOLD                      03290000
                FOR SELECT                                              03300000
                      A.VS_NBR                                          03310000
                     ,B.INTR_UPC_ID                                     03320000
                     ,B.SKU_NBR                                         03330000
                 FROM XST_VND_STYL A                                    03340000
                     ,XST_SKU B                                         03350000
                     ,TSKXREF X                                         03360000
                WHERE A.STYL_ID = B.STYL_ID                             03370000
                  AND A.DEPT_NBR = :PV-DEPT-NBR                         03380000
                  AND A.MAJ_CL_NBR = :PV-MAJ-CL-NBR                     03390000
                  AND A.SUB_CL_NBR = :PV-SUB-CL-NBR                     03400000
                  AND A.VS_ID = :PV-VS-ID                               03410000
                  AND B.INTR_UPC_ID = X.INTR_UPC_ID                     03420000
                  AND X.SKU_STAT_CDE NOT IN ('30','98')                 03421000
                ORDER BY B.INTR_UPC_ID                                  03422000
                WITH UR                                                 03423000
           END-EXEC.                                                    03424000
                                                                        03425000
      ******************************************************************03426000
      * AC ABEND CODES                                                 *03427000
      ******************************************************************03428000
                                                                        03429000
       01  ABEND-CODE                       PIC S9(04)   COMP VALUE +0. 03430000
           88  ABEND-4001-WRITE-ERROR                    VALUE +4001.   03440000
           88  ABEND-4002-READ-ERROR                     VALUE +4002.   03450000
           88  ABEND-4003-CTRL-CARD-ERROR                VALUE +4003.   03460000
           88  ABEND-4004-TABLE-ERROR                    VALUE +4004.   03470000
           88  ABEND-4005-OPEN-ERROR                     VALUE +4005.   03480000
           88  ABEND-4006-CLOSE-ERROR                    VALUE +4006.   03490000
           88  ABEND-4007-SEQUENCE-ERROR                 VALUE +4007.   03500000
           88  ABEND-4008-DATA-ERROR                     VALUE +4008.   03510000
           88  ABEND-4009-KEY-DATA-ERROR                 VALUE +4009.   03520000
           88  ABEND-4013-DB2-ERROR                      VALUE +4013.   03530000
           88  ABEND-4019-DATE-ROUTINE-ERROR             VALUE +4019.   03540000
           88  ABEND-4444-FORCED-ABEND                   VALUE +4444.   03550000
                                                                        03560000
       PROCEDURE DIVISION.                                              03570000
                                                                        03580000
      ******************************************************************03590000
      * MAIN PROCESSING                                                 03600000
      ******************************************************************03610000
       A100-PROGRAM-MAINLINE.                                           03620000
                                                                        03630000
           DISPLAY 'PROCESSING BEGINNING: '.                            03641002
           ACCEPT PV-CPU-TIME FROM TIME.                                03650000
           DISPLAY 'STARTING TIME: ' PV-CPU-TIME.                       03660000
                                                                        03670000
           PERFORM B100-INITIALIZE                                      03680000
           PERFORM B200-READ-PRICING-FILE                               03690000
                                                                        03700000
           IF PS-END-OF-PRICING-FILE                                    03710000
               DISPLAY ' '                                              03720000
               DISPLAY '*** EMPTY INPUT FILE. ***'                      03730000
               DISPLAY ' '                                              03740000
           ELSE                                                         03750000
               PERFORM B300-PROCESS-PRICING-FILE                        03770000
                   UNTIL PS-END-OF-PRICING-FILE                         03780000
           END-IF                                                       03790000
                                                                        03800000
           PERFORM B900-EOJ-ROUTINE                                     03810000
                                                                        03820000
           ACCEPT PV-CPU-TIME FROM TIME.                                03830000
           DISPLAY ' '.                                                 03840000
           DISPLAY 'ENDING TIME: ' PV-CPU-TIME.                         03850000
                                                                        03860000
           GOBACK.                                                      03870000
                                                                        03880000
      ******************************************************************03890000
      * OPEN FILES                                                      03900000
      ******************************************************************03910000
       B100-INITIALIZE.                                                 03920000
                                                                        03930000
JB0308     OPEN INPUT  PRICING-FILE                                     03940000
JB0308          OUTPUT EXPLODED-FILE.                                   03950000
                                                                        03960000
      ******************************************************************03970000
      * READ IN THE PRICING EXTRACT FILE                                03980000
      ******************************************************************03990000
       B200-READ-PRICING-FILE.                                          04000000
                                                                        04010000
           READ PRICING-FILE                                            04020000
               INTO PM106-EXCPT-PRCG-EXT                                04030000
               AT END                                                   04040000
                   SET PS-END-OF-PRICING-FILE TO TRUE.                  04050000
                                                                                
      ******************************************************************04580000
      * PROCESS THE PRICING EXTRACT FILE                                04590000
      ******************************************************************04600000
       B300-PROCESS-PRICING-FILE.                                       04610000
                                                                        04620000
           MOVE 'N' TO PS-END-OF-STYLE-CSR-SW                           04820000
JB0308                 PS-END-OF-SCL-CSR-SW                             04830000
JB0308                 PS-END-OF-MCL-CSR-SW                             04840000
JB0308                 PS-END-OF-DEPT-CSR-SW                            04850000
                                                                        04860000
           MOVE 0 TO PV-SKU-NBR                                         04870000
JB0308               PV-VS-ID                                           04880000
JB0308               PV-SUB-CL-NBR                                      04890000
JB0308               PV-MAJ-CL-NBR                                      04900000
JB0308               PV-DEPT-NBR                                        04910000
C21565                                                                  04860000
C21565     IF PM106-MDSE-HIER-CDE NOT = 'SCL'                                   
C21565         MOVE 0 TO PV-SUB-CL-NBR-SAVE                             04910000
C21565                   PV-MAJ-CL-NBR-SAVE                             04910000
C21565                   PV-DEPT-NBR-SAVE                               04910000
C21565     END-IF                                                       04910000
                                                                        04920000
      ***  DISPLAY 'MDSE-HEIR-CDE: ' PM106-MDSE-HIER-CDE                04930000
                                                                        04940000
           IF PM106-MDSE-HIER-CDE = 'SKU'                               04950000
               MOVE PM106-SKU-NBR TO PV-SKU-NBR                         04960000
                                                                        04970000
      *        0 = EXCLUSION, 1 = INCLUSION                             04980000
               IF PM106-REC-TYP-CDE = 0                                 04990000
      *            ADD EXCLUDED SKU TO EXCL TABLE                       05000000
                   ADD +1 TO PV-MAX-EXCL                                05010000
                   IF PV-MAX-EXCL < PC-EXCL-LIMIT                       05020000
                       MOVE PM106-MDSE-SELN-ID                          05030000
                           TO PT-MDSE-SELN-ID (PV-MAX-EXCL)             05040000
                       MOVE PM106-MDSE-SELN-LNE-ID                      05050000
                           TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)         05060000
                       MOVE PM106-SKU-NBR                               05070000
                           TO PT-SKU-NBR (PV-MAX-EXCL)                  05080000
                   ELSE                                                 05090000
                       MOVE 'B300-PROCESS-PRICING' TO PV-PARAGRAPH-NAME 05100000
                       MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-105110000
                       PERFORM Z900-SQL-ABEND                           05120000
                   END-IF                                               05130000
               ELSE                                                     05140000
      *            LOOK FOR THE SKU IN THE EXCLUSION LIST               05150000
                   PERFORM WITH TEST BEFORE                             05160000
                       VARYING PV-EXCL-SUB FROM +1 BY +1                05170000
                       UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR             05180000
                         ( PT-SKU-NBR(PV-EXCL-SUB) = PM106-SKU-NBR AND  05190000
                           PT-MDSE-SELN-ID(PV-EXCL-SUB) =               05200000
                               PM106-MDSE-SELN-ID AND                   05210000
                           PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =           05220000
                               PM106-MDSE-SELN-LNE-ID )                 05230000
                   END-PERFORM                                          05240000
                                                                        05250000
      *            IF SKU WASN'T FOUND IN THE EXCLUSION LIST, PROCESS IT05260000
                   IF PV-EXCL-SUB > PV-MAX-EXCL                         05270000
                       PERFORM C100-SELECT-SKU                          05280000
                       IF PS-SKU-FOUND                                  05290000
                          PERFORM C300-PROCESS-SKU                      05300000
                       END-IF                                           05310000
                   END-IF                                               05320000
               END-IF                                                   05330000
           ELSE                                                         05340000
               IF PM106-MDSE-HIER-CDE = 'STY'                           05350000
      *            PROCESS STYLE-CSR                                    05360000
                   MOVE PM106-VS-ID      TO PV-VS-ID                    05370000
                   MOVE PM106-SUB-CL-NBR TO PV-SUB-CL-NBR               05380000
                   MOVE PM106-MAJ-CL-NBR TO PV-MAJ-CL-NBR               05390000
                   MOVE PM106-DEPT-NBR   TO PV-DEPT-NBR                 05400000
                                                                        05410000
                   PERFORM D100-OPEN-STYLE-CSR                          05420000
                   PERFORM D200-FETCH-STYLE-CSR                         05430000
                   IF NOT PS-END-OF-STYLE-CSR                           05440000
                       PERFORM D300-PROCESS-STYLE-CSR                   05450000
                         UNTIL PS-END-OF-STYLE-CSR                      05460000
                   END-IF                                               05470000
                   PERFORM D400-CLOSE-STYLE-CSR                         05480000
               ELSE                                                     05490000
                   IF PM106-MDSE-HIER-CDE = 'SCL'                       05500000
                    IF PM106-MAJ-CL-NBR NOT EQUAL TO                            
                              PV-MAJ-CL-NBR-SCL OR                              
                       PM106-SUB-CL-NBR NOT EQUAL TO                            
                              PV-SUB-CL-NBR-SCL OR                              
                       PM106-DEPT-NBR   NOT EQUAL TO                            
                              PV-DEPT-NBR-SCL   OR                              
                       PM106-STR-NBR    NOT EQUAL TO                            
                              PV-STR-NBR-SCL    OR                              
                       PM106-MDSE-HIER-CDE NOT EQUAL TO                         
                              PV-MDSE-HIER-CDE-SCL                              
      *                PROCESS SCL-CSR                                  05510000
                       MOVE PM106-SUB-CL-NBR TO PV-SUB-CL-NBR           05520000
                       MOVE PM106-MAJ-CL-NBR TO PV-MAJ-CL-NBR           05530000
                       MOVE PM106-DEPT-NBR   TO PV-DEPT-NBR             05540000
                                                                        05550000
C21565               IF PV-SUB-CL-NBR = PV-SUB-CL-NBR-SAVE AND                  
C21565                  PV-MAJ-CL-NBR = PV-MAJ-CL-NBR-SAVE AND                  
C21565                  PV-DEPT-NBR   = PV-DEPT-NBR-SAVE                        
C21565                 PERFORM VARYING PT-SCL-SKU-INDX FROM 1 BY 1              
C21565                   UNTIL PT-SCL-SKU-INDX > PT-SCL-SKU-TBL-MAX             
C21565                      OR PT-SCL-SKU-INDX > PT-SCL-SKU-INDX-SIZE           
C21565                      OR PS-SCL-SKU-NOT-FOUND                             
C21565                     PERFORM E500-PROCESS-SCL-SKU-TABLE                   
C21565                 END-PERFORM                                              
C21565                 IF PT-SCL-SKU-INDX > PT-SCL-SKU-TBL-MAX                  
C21565                   DISPLAY '*********** ABEND *******************'        
C21565                   DISPLAY '**  PROGRAM   => ' PC-PROGRAM-NAME            
C21565                   DISPLAY '**  PARAGRAPH => ' PV-PARAGRAPH-NAME          
C21565                   DISPLAY ' TABLE OVERFLOW ON PT-SCL-SKU-TABLE  '        
C21565                   DISPLAY ' INCREASE PT-SCL-SKU-TBL-MAX LIMIT   '        
C21565                   DISPLAY ' CURRENT LIMIT = ' PT-SCL-SKU-TBL-MAX         
C21565                   DISPLAY '*************************************'        
C21565                   DISPLAY '  '                                           
C21565                   SET ABEND-4004-TABLE-ERROR TO TRUE                     
C21565                   CALL 'ILBOABN0' USING ABEND-CODE                       
C21565                 END-IF                                                   
C21565               ELSE                                                       
                       PERFORM E100-OPEN-SCL-CSR                        05560000
                       PERFORM E200-FETCH-SCL-CSR                       05570000
                       IF NOT PS-END-OF-SCL-CSR                         05580000
C21565                     SET PS-SCL-SKU-FOUND TO TRUE                         
C21565                     SET PT-SCL-SKU-INDX TO 1                             
                           PERFORM E300-PROCESS-SCL-CSR                 05590000
                             UNTIL PS-END-OF-SCL-CSR                    05600000
C21565                 ELSE                                                     
C21565                     SET PS-SCL-SKU-NOT-FOUND TO TRUE                     
                       END-IF                                           05610000
                       PERFORM E400-CLOSE-SCL-CSR                       05620000
C21565               END-IF                                                     
C21565               MOVE PV-SUB-CL-NBR TO PV-SUB-CL-NBR-SAVE                   
C21565               MOVE PV-MAJ-CL-NBR TO PV-MAJ-CL-NBR-SAVE                   
C21565               MOVE PV-DEPT-NBR   TO PV-DEPT-NBR-SAVE                     
                     MOVE PM106-MAJ-CL-NBR  TO PV-MAJ-CL-NBR-SCL                
                     MOVE PM106-SUB-CL-NBR  TO PV-SUB-CL-NBR-SCL                
                     MOVE PM106-DEPT-NBR    TO PV-DEPT-NBR-SCL                  
                     MOVE PM106-STR-NBR     TO PV-STR-NBR-SCL                   
                     MOVE PM106-MDSE-HIER-CDE  TO                               
                                       PV-MDSE-HIER-CDE-SCL                     
                    ELSE                                                        
                      ADD +1 TO PA-SCL-SKIP-COUNTER                             
                   END-IF                                               05610000
                   ELSE                                                 05630000
                       IF PM106-MDSE-HIER-CDE = 'MCL'                   05640000
                          IF PM106-MAJ-CL-NBR NOT EQUAL TO                      
                                     PV-MAJ-CL-NBR-MCL OR                       
                             PM106-DEPT-NBR   NOT EQUAL TO                      
                                     PV-DEPT-NBR-MCL   OR                       
                             PM106-STR-NBR    NOT EQUAL TO                      
                                     PV-STR-NBR-MCL    OR                       
                             PM106-MDSE-HIER-CDE NOT EQUAL TO                   
                                     PV-MDSE-HIER-CDE-MCL                       
      *                    PROCESS MCL-CSR                              05650000
                            MOVE PM106-MAJ-CL-NBR TO PV-MAJ-CL-NBR      05660000
                            MOVE PM106-DEPT-NBR   TO PV-DEPT-NBR        05670000
                                                                        05680000
                            PERFORM F100-OPEN-MCL-CSR                   05690000
                            PERFORM F200-FETCH-MCL-CSR                  05700000
                            IF NOT PS-END-OF-MCL-CSR                    05710000
                                PERFORM F300-PROCESS-MCL-CSR            05720000
                                  UNTIL PS-END-OF-MCL-CSR               05730000
                           END-IF                                       05740000
                           PERFORM F400-CLOSE-MCL-CSR                   05750000
                           MOVE PM106-MAJ-CL-NBR  TO PV-MAJ-CL-NBR-MCL          
                           MOVE PM106-DEPT-NBR    TO PV-DEPT-NBR-MCL            
                           MOVE PM106-STR-NBR     TO PV-STR-NBR-MCL             
                           MOVE PM106-MDSE-HIER-CDE  TO                         
                                           PV-MDSE-HIER-CDE-MCL                 
                           ELSE                                                 
                             ADD +1 TO PA-MCL-SKIP-COUNTER                      
                           END-IF                                       05740000
                       ELSE                                             05760000
                         MOVE PM106-DEPT-NBR   TO PV-DEPT-NBR           05780000
                         IF PM106-DEPT-NBR   NOT EQUAL TO                       
                                    PV-DEPT-NBR-DPT   OR                        
                            PM106-STR-NBR    NOT EQUAL TO                       
                                    PV-STR-NBR-DPT    OR                        
                            PM106-MDSE-HIER-CDE NOT EQUAL TO                    
                                    PV-MDSE-HIER-CDE-DPT                        
      *                    PROCESS DEPT-CSR                             05770000
                                                                        05790000
                           PERFORM G100-OPEN-DEPT-CSR                   05800000
                           PERFORM G200-FETCH-DEPT-CSR                  05810000
                           IF NOT PS-END-OF-DEPT-CSR                    05820000
                               PERFORM G300-PROCESS-DEPT-CSR            05830000
                                 UNTIL PS-END-OF-DEPT-CSR               05840000
                           END-IF                                       05850000
                           PERFORM G400-CLOSE-DEPT-CSR                  05860000
                           MOVE PM106-DEPT-NBR    TO PV-DEPT-NBR-DPT            
                           MOVE PM106-STR-NBR     TO PV-STR-NBR-DPT             
                           MOVE PM106-MDSE-HIER-CDE  TO                         
                                           PV-MDSE-HIER-CDE-DPT                 
                           ELSE                                                 
                             ADD +1 TO PA-DPT-SKIP-COUNTER                      
                         END-IF                                         05850000
                       END-IF                                           05870000
                   END-IF                                               05880000
               END-IF                                                   05890000
           END-IF                                                       05900000
                                                                        05910000
           ADD +1 TO PA-READ-COUNTER.                                   05920000
                                                                        05930000
      *    DISPLAY PROGRESS                                             05940000
C47460     DIVIDE PA-READ-COUNTER BY 1000000                            05950001
               GIVING PV-RECS-DIV                                       05980000
               REMAINDER PV-RECS-REM                                    05990000
           IF PV-RECS-REM = 0                                           06000000
               ACCEPT PV-CPU-TIME FROM TIME                             06010000
               DISPLAY ' '                                              06020000
               DISPLAY 'TIME: ' PV-CPU-TIME                             06030000
               DISPLAY PA-READ-COUNTER ' INPUT RECORDS PROCESSED'       06040000
           END-IF                                                       06050000
                                                                        06060000
           PERFORM B200-READ-PRICING-FILE.                              06070000
                                                                        06080000
      ******************************************************************06090000
      * CLEAN UP                                                        06100000
      ******************************************************************06110000
       B900-EOJ-ROUTINE.                                                06120000
                                                                        06130000
           CLOSE PRICING-FILE                                           06140000
                 EXPLODED-FILE.                                         06150000
                                                                        06160000
           DISPLAY ' '                                                  06170000
           DISPLAY 'TOTAL NUMBER OF RECORDS WRITTEN: ' PA-RECS-WRITTEN  06180000
           DISPLAY 'TOTAL MCL RECORDS SKIPPED: ' PA-MCL-SKIP-COUNTER    06180000
           DISPLAY 'TOTAL SCL RECORDS SKIPPED: ' PA-SCL-SKIP-COUNTER    06180000
           DISPLAY 'TOTAL DPT RECORDS SKIPPED: ' PA-DPT-SKIP-COUNTER    06180000
           DISPLAY ' '.                                                 06190000
                                                                        06200000
      ******************************************************************06210000
      * RETRIEVE THE INPUT SKU'S INFO                                   06220000
      ******************************************************************06230000
       C100-SELECT-SKU.                                                 06240000
                                                                        06250000
           EXEC SQL                                                     06260000
               SELECT A.DEPT_NBR                                        06270000
                     ,A.MAJ_CL_NBR                                      06280000
                     ,A.SUB_CL_NBR                                      06290000
                     ,A.VS_ID                                           06300000
                     ,A.VS_NBR                                          06310000
                     ,B.INTR_UPC_ID                                     06320000
                 INTO :XST00013-DEPT-NBR                                06330000
                     ,:XST00013-MAJ-CL-NBR                              06340000
                     ,:XST00013-SUB-CL-NBR                              06350000
                     ,:XST00013-VS-ID                                   06360000
                     ,:XST00013-VS-NBR                                  06370000
                     ,:XST00010-INTR-UPC-ID                             06380000
                 FROM XST_VND_STYL A                                    06390000
                     ,XST_SKU B                                         06400000
                WHERE A.STYL_ID = B.STYL_ID                             06410000
                  AND B.SKU_NBR = :PV-SKU-NBR                           06420000
                WITH UR                                                 06430000
           END-EXEC.                                                    06440000
                                                                        06450000
           EVALUATE TRUE                                                06460000
               WHEN SQLCODE = 0                                         06470000
                   SET PS-SKU-FOUND            TO TRUE                  06480000
               WHEN SQLCODE = +100                                      06490000
                   MOVE 'C100-PROCESS-SKU'     TO PV-PARAGRAPH-NAME     06500000
                   MOVE 'SKU NOT FOUND: '      TO PV-OPERATION-MSG-1    06510000
                   MOVE PV-SKU-NBR             TO PV-OPERATION-MSG-2    06520000
      *            PERFORM Z900-SQL-ABEND                               06530000
                   SET PS-SKU-NOT-FOUND        TO TRUE                  06540000
               WHEN OTHER                                               06550000
                   MOVE 'C100-PROCESS-SKU'     TO PV-PARAGRAPH-NAME     06560000
                   MOVE 'ERROR ON SKU SELECT ' TO PV-OPERATION-MSG-1    06570000
                   MOVE PV-SKU-NBR             TO PV-OPERATION-MSG-2    06580000
                   PERFORM Z900-SQL-ABEND                               06590000
           END-EVALUATE.                                                06600000
                                                                        06610000
      ******************************************************************06620000
      * PROCESS THE SKU                                                 06630000
      ******************************************************************06640000
       C300-PROCESS-SKU.                                                06650000
                                                                        06660000
      *       ONLY GET HERE FOR INCLUSIONS, SO JUST WRITE IT OUT.       06730000
JB0308        MOVE PM106-SKU-NBR          TO PM113-SKU-NBR              06910000
JB0308        MOVE PM106-STR-NBR          TO PM113-LOC-NBR              06920000
JB0308        MOVE PM106-PROMO-INTFC-ID   TO PM113-PROMO-INTFC-ID       06760000
JB0308        MOVE PM106-MDSE-SELN-ID     TO PM113-MDSE-SELN-ID         06770000
JB0308        MOVE PM106-MDSE-SELN-LNE-ID TO PM113-MDSE-SELN-LNE-ID     06780000
JB0308        MOVE PM106-AD-EVNT-ID       TO PM113-AD-EVNT-ID           06790000
JB0308        MOVE PM106-PROMO-ID         TO PM113-PROMO-ID             06800000
JB0308        MOVE PM106-STRT-TMST        TO PM113-PROMO-STRT-TMST      06810000
JB0308        MOVE PM106-END-TMST         TO PM113-PROMO-END-TMST       06820000
JB0308        MOVE PM106-PROMO-ITM-ID     TO PM113-PROMO-ITM-ID         06830000
                                                                        06840000
JB0308        MOVE XST00013-DEPT-NBR      TO PM113-DEPT-NBR             06850000
JB0308        MOVE XST00013-MAJ-CL-NBR    TO PM113-MAJ-CL-NBR           06860000
JB0308        MOVE XST00013-SUB-CL-NBR    TO PM113-SUB-CL-NBR           06870000
JB0308        MOVE XST00013-VS-ID         TO PM113-VS-ID                06880000
JB0308        MOVE XST00013-VS-NBR        TO PM113-VS-NBR               06890000
                                                                        06900000
JB0308        MOVE XST00010-INTR-UPC-ID   TO PM113-INTR-UPC-ID                  
                                                                        07020000
JB0308        PERFORM H100-MOVE-PROMO-PRICE-FIELDS                      07020000
JB0308                                                                  07020000
JB0308        MOVE 1                      TO PM113-MDSE-HIER-LVL-CDE    07060000
                                                                                
JB0308        PERFORM W100-WRITE-EXPLODED-FILE.                         07080000
                                                                        07130000
      ******************************************************************07140000
      * OPEN THE STYLE CURSOR                                           07150000
      ******************************************************************07160000
       D100-OPEN-STYLE-CSR.                                             07170000
                                                                        07180000
           EXEC SQL                                                     07190000
               OPEN STYLE-CSR                                           07200000
           END-EXEC.                                                    07210000
                                                                        07220000
           EVALUATE TRUE                                                07230000
               WHEN SQLCODE = +0                                        07240000
                   CONTINUE                                             07250000
               WHEN OTHER                                               07260000
                   MOVE 'D100-OPEN-STYLE-CSR           '                07270000
                                     TO PV-PARAGRAPH-NAME               07280000
                   MOVE 'OPEN ERROR ON STYLE-CSR     '                  07290000
                                     TO PV-OPERATION-MSG-1              07300000
                   PERFORM Z900-SQL-ABEND                               07310000
           END-EVALUATE.                                                07320000
                                                                        07330000
      ******************************************************************07340000
      * FETCH THE STYLE CURSOR                                          07350000
      ******************************************************************07360000
       D200-FETCH-STYLE-CSR.                                            07370000
                                                                        07380000
           EXEC SQL                                                     07390000
               FETCH STYLE-CSR                                          07400000
                INTO :XST00013-VS-NBR                                   07410000
                    ,:XST00010-INTR-UPC-ID                              07420000
                    ,:XST00010-SKU-NBR                                  07430000
           END-EXEC.                                                    07440000
                                                                        07450000
           EVALUATE TRUE                                                07460000
               WHEN SQLCODE = +0                                        07470000
                   CONTINUE                                             07480000
               WHEN SQLCODE = +100                                      07490000
                   SET PS-END-OF-STYLE-CSR TO TRUE                      07500000
               WHEN OTHER                                               07510000
                   MOVE 'D200-FETCH-STYLE-CSR          '                07520000
                                     TO PV-PARAGRAPH-NAME               07530000
                   MOVE 'FETCH ERROR ON STYLE-CSR    '                  07540000
                                     TO PV-OPERATION-MSG-1              07550000
                   PERFORM Z900-SQL-ABEND                               07560000
           END-EVALUATE.                                                07570000
                                                                        07580000
      ******************************************************************07590000
      * PROCESS THE STYLE CURSOR                                        07600000
      ******************************************************************07610000
       D300-PROCESS-STYLE-CSR.                                          07620000
                                                                        07630000
              IF PM106-REC-TYP-CDE = 0                                  07700000
      *           ADD EXCLUDED SKU TO EXCL TABLE                        07710000
                  ADD +1 TO PV-MAX-EXCL                                 07720000
                  IF PV-MAX-EXCL < PC-EXCL-LIMIT                        07730000
                      MOVE PM106-MDSE-SELN-ID                           07740000
                          TO PT-MDSE-SELN-ID (PV-MAX-EXCL)              07750000
                      MOVE PM106-MDSE-SELN-LNE-ID                       07760000
                          TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)          07770000
                      MOVE XST00010-SKU-NBR                             07780000
                          TO PT-SKU-NBR (PV-MAX-EXCL)                   07790000
                  ELSE                                                  07800000
                      MOVE 'D300-PROCESS-STYLE' TO PV-PARAGRAPH-NAME    07810000
                      MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-1 07820000
                      PERFORM Z900-SQL-ABEND                            07830000
                  END-IF                                                07840000
              ELSE                                                      07850000
      *           LOOK FOR THE SKU IN THE EXCLUSION LIST                07860000
                  PERFORM WITH TEST BEFORE                              07870000
                      VARYING PV-EXCL-SUB FROM +1 BY +1                 07880000
                      UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR              07890000
                     ( PT-SKU-NBR(PV-EXCL-SUB) = XST00010-SKU-NBR AND   07900000
                       PT-MDSE-SELN-ID(PV-EXCL-SUB) =                   07910000
                           PM106-MDSE-SELN-ID AND                       07920000
                       PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =               07930000
                           PM106-MDSE-SELN-LNE-ID )                     07940000
                  END-PERFORM                                           07950000
                                                                        07960000
      *           IF SKU WASN'T FOUND IN THE EXCLUSION LIST, WRITE IT   07970000
                  IF PV-EXCL-SUB > PV-MAX-EXCL                          07980000
JB0308                MOVE XST00010-SKU-NBR    TO PM113-SKU-NBR         08170000
JB0308                MOVE PM106-STR-NBR       TO PM113-LOC-NBR         08180000
JB0308                MOVE PM106-PROMO-INTFC-ID                         08010000
JB0308                                         TO PM113-PROMO-INTFC-ID  08010000
JB0308                MOVE PM106-MDSE-SELN-ID  TO PM113-MDSE-SELN-ID    08020000
JB0308                MOVE PM106-MDSE-SELN-LNE-ID                       08030000
JB0308                                         TO PM113-MDSE-SELN-LNE-ID08040000
JB0308                MOVE PM106-AD-EVNT-ID    TO PM113-AD-EVNT-ID      08050000
JB0308                MOVE PM106-PROMO-ID      TO PM113-PROMO-ID        08060000
JB0308                MOVE PM106-STRT-TMST     TO PM113-PROMO-STRT-TMST 08070000
JB0308                MOVE PM106-END-TMST      TO PM113-PROMO-END-TMST  08080000
JB0308                MOVE PM106-PROMO-ITM-ID  TO PM113-PROMO-ITM-ID    08090000
                                                                        08100000
JB0308                MOVE PM106-DEPT-NBR      TO PM113-DEPT-NBR        08110000
JB0308                MOVE PM106-MAJ-CL-NBR    TO PM113-MAJ-CL-NBR      08120000
JB0308                MOVE PM106-SUB-CL-NBR    TO PM113-SUB-CL-NBR      08130000
JB0308                MOVE PM106-VS-ID         TO PM113-VS-ID           08140000
JB0308                MOVE XST00013-VS-NBR     TO PM113-VS-NBR          08150000
                                                                        08290000
JB0308                MOVE XST00010-INTR-UPC-ID TO PM113-INTR-UPC-ID            
                                                                        08290000
JB0308                PERFORM H100-MOVE-PROMO-PRICE-FIELDS              07020000
JB0308                                                                  07020000
JB0308                MOVE 2 TO PM113-MDSE-HIER-LVL-CDE                 08340000
                                                                                
                      PERFORM W100-WRITE-EXPLODED-FILE                  08360000
                  END-IF                                                08400000
JB0308        END-IF.                                                   08410000
           PERFORM D200-FETCH-STYLE-CSR.                                08430000
                                                                        08440000
      ******************************************************************08450000
      * CLOSE THE STYLE CURSOR                                          08460000
      ******************************************************************08470000
       D400-CLOSE-STYLE-CSR.                                            08480000
                                                                        08490000
           EXEC SQL                                                     08500000
               CLOSE STYLE-CSR                                          08510000
           END-EXEC.                                                    08520000
                                                                        08530000
           EVALUATE TRUE                                                08540000
               WHEN SQLCODE = +0                                        08550000
                   CONTINUE                                             08560000
               WHEN OTHER                                               08570000
                   MOVE 'D400-CLOSE-STYLE-CSR           '               08580000
                                     TO PV-PARAGRAPH-NAME               08590000
                   MOVE 'CLOSE ERROR ON STYLE-CSR     '                 08600000
                                     TO PV-OPERATION-MSG-1              08610000
                   PERFORM Z900-SQL-ABEND                               08620000
           END-EVALUATE.                                                08630000
                                                                        08640000
      ******************************************************************08650000
      * OPEN THE SUBCLASS CURSOR                                        08660000
      ******************************************************************08670000
       E100-OPEN-SCL-CSR.                                               08680000
                                                                        08690000
           EXEC SQL                                                     08700000
               OPEN SCL-CSR                                             08710000
           END-EXEC.                                                    08720000
                                                                        08730000
           EVALUATE TRUE                                                08740000
               WHEN SQLCODE = +0                                        08750000
                   CONTINUE                                             08760000
               WHEN OTHER                                               08770000
                   MOVE 'E100-OPEN-SCL-CSR             '                08780000
                                     TO PV-PARAGRAPH-NAME               08790000
                   MOVE 'OPEN ERROR ON SCL-CSR       '                  08800000
                                     TO PV-OPERATION-MSG-1              08810000
                   PERFORM Z900-SQL-ABEND                               08820000
           END-EVALUATE.                                                08830000
                                                                        08840000
      ******************************************************************08850000
      * FETCH THE SUBCLASS CURSOR                                       08860000
      ******************************************************************08870000
       E200-FETCH-SCL-CSR.                                              08880000
                                                                        08890000
           EXEC SQL                                                     08900000
               FETCH SCL-CSR                                            08910000
                INTO :XST00013-VS-ID                                    08920000
                    ,:XST00013-VS-NBR                                   08930000
                    ,:XST00010-INTR-UPC-ID                              08940000
                    ,:XST00010-SKU-NBR                                  08950000
           END-EXEC.                                                    08960000
                                                                        08970000
           EVALUATE TRUE                                                08980000
               WHEN SQLCODE = +0                                        08990000
                   CONTINUE                                             09000000
               WHEN SQLCODE = +100                                      09010000
                   SET PS-END-OF-SCL-CSR TO TRUE                        09020000
               WHEN OTHER                                               09030000
                   MOVE 'E200-FETCH-SCL-CSR            '                09040000
                                     TO PV-PARAGRAPH-NAME               09050000
                   MOVE 'FETCH ERROR ON SCL-CSR      '                  09060000
                                     TO PV-OPERATION-MSG-1              09070000
                   PERFORM Z900-SQL-ABEND                               09080000
           END-EVALUATE.                                                09090000
                                                                        09100000
      ******************************************************************09110000
      * PROCESS THE SUBCLASS CURSOR                                     09120000
      ******************************************************************09130000
       E300-PROCESS-SCL-CSR.                                            09140000
                                                                        09150000
              IF PM106-REC-TYP-CDE = 0                                  09220000
      *           ADD EXCLUDED SKUS TO EXCL TABLE                       09230000
                  ADD +1 TO PV-MAX-EXCL                                 09240000
                  IF PV-MAX-EXCL < PC-EXCL-LIMIT                        09250000
                      MOVE PM106-MDSE-SELN-ID                           09260000
                          TO PT-MDSE-SELN-ID (PV-MAX-EXCL)              09270000
                      MOVE PM106-MDSE-SELN-LNE-ID                       09280000
                          TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)          09290000
                      MOVE XST00010-SKU-NBR                             09300000
                          TO PT-SKU-NBR (PV-MAX-EXCL)                   09310000
                  ELSE                                                  09320000
                      MOVE 'E300-PROCESS-SCL-CSR' TO PV-PARAGRAPH-NAME  09330000
                      MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-1 09340000
                      PERFORM Z900-SQL-ABEND                            09350000
                  END-IF                                                09360000
              ELSE                                                      09370000
      *           LOOK FOR THE SKU IN THE EXCLUSION LIST                09380000
                  PERFORM WITH TEST BEFORE                              09390000
                      VARYING PV-EXCL-SUB FROM +1 BY +1                 09400000
                      UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR              09410000
                      ( PT-SKU-NBR(PV-EXCL-SUB) = XST00010-SKU-NBR AND  09420000
                        PT-MDSE-SELN-ID(PV-EXCL-SUB) =                  09430000
                            PM106-MDSE-SELN-ID AND                      09440000
                        PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =              09450000
                            PM106-MDSE-SELN-LNE-ID )                    09460000
                  END-PERFORM                                           09470000
                                                                        09480000
      *           IF SKU WASN'T FOUND IN THE EXCLUSION LIST, WRITE IT   09490000
                  IF PV-EXCL-SUB > PV-MAX-EXCL                          09500000
JB0308                MOVE XST00010-SKU-NBR    TO PM113-SKU-NBR         09690000
C21565                                  PT-SCL-SKU-NBR (PT-SCL-SKU-INDX)        
JB0308                MOVE PM106-STR-NBR       TO PM113-LOC-NBR         09700000
                                                                        09720000
JB0308                MOVE PM106-PROMO-INTFC-ID                         09530000
JB0308                                         TO PM113-PROMO-INTFC-ID  09530000
JB0308                MOVE PM106-MDSE-SELN-ID  TO PM113-MDSE-SELN-ID    09540000
JB0308                MOVE PM106-MDSE-SELN-LNE-ID                       09550000
JB0308                                         TO PM113-MDSE-SELN-LNE-ID09560000
JB0308                MOVE PM106-AD-EVNT-ID    TO PM113-AD-EVNT-ID      09570000
JB0308                MOVE PM106-PROMO-ID      TO PM113-PROMO-ID        09580000
JB0308                MOVE PM106-STRT-TMST     TO PM113-PROMO-STRT-TMST 09590000
JB0308                MOVE PM106-END-TMST      TO PM113-PROMO-END-TMST  09600000
JB0308                MOVE PM106-PROMO-ITM-ID  TO PM113-PROMO-ITM-ID    09610000
JB0308                MOVE PM106-DEPT-NBR      TO PM113-DEPT-NBR        09630000
JB0308                MOVE PM106-MAJ-CL-NBR    TO PM113-MAJ-CL-NBR      09640000
JB0308                MOVE PM106-SUB-CL-NBR    TO PM113-SUB-CL-NBR      09650000
JB0308                                                                  09680000
JB0308                MOVE XST00013-VS-ID      TO PM113-VS-ID           09660000
C21565                                   PT-SCL-VS-ID  (PT-SCL-SKU-INDX)        
JB0308                MOVE XST00013-VS-NBR     TO PM113-VS-NBR          09670000
C21565                                   PT-SCL-VS-NBR (PT-SCL-SKU-INDX)        
                                                                        09750000
JB0308                MOVE XST00010-INTR-UPC-ID TO PM113-INTR-UPC-ID            
C21565                              PT-SCL-INTR-UPC-ID (PT-SCL-SKU-INDX)        
                                                                        09850000
JB0308                PERFORM H100-MOVE-PROMO-PRICE-FIELDS              07020000
JB0308                                                                  07020000
JB0308                MOVE 3 TO PM113-MDSE-HIER-LVL-CDE                 09860000
                                                                                
                      PERFORM W100-WRITE-EXPLODED-FILE                  09880000
                  END-IF                                                09920000
              END-IF.                                                   09930000
           PERFORM E200-FETCH-SCL-CSR.                                  09950000
C21565     IF NOT PS-END-OF-SCL-CSR                                             
C21565        SET PT-SCL-SKU-INDX UP BY 1                                       
C21565     ELSE                                                                 
C21565        SET PT-SCL-SKU-INDX-SIZE TO PT-SCL-SKU-INDX                       
C21565     END-IF.                                                              
                                                                        09960000
      ******************************************************************09970000
      * CLOSE THE SUBCLASS CURSOR                                       09980000
      ******************************************************************09990000
       E400-CLOSE-SCL-CSR.                                              10000000
                                                                        10010000
           EXEC SQL                                                     10020000
               CLOSE SCL-CSR                                            10030000
           END-EXEC.                                                    10040000
                                                                        10050000
           EVALUATE TRUE                                                10060000
               WHEN SQLCODE = +0                                        10070000
                   CONTINUE                                             10080000
               WHEN OTHER                                               10090000
                   MOVE 'E400-CLOSE-SCL-CSR             '               10100000
                                     TO PV-PARAGRAPH-NAME               10110000
                   MOVE 'CLOSE ERROR ON SCL-CSR       '                 10120000
                                     TO PV-OPERATION-MSG-1              10130000
                   PERFORM Z900-SQL-ABEND                               10140000
           END-EVALUATE.                                                10150000
                                                                        10160000
C21565******************************************************************09110000
C21565* PROCESS THE SUBCLASS SKU TABLE                                  09120000
C21565******************************************************************09130000
C21565 E500-PROCESS-SCL-SKU-TABLE.                                      09140000
C21565                                                                  09150000
C21565        IF PM106-REC-TYP-CDE = 0                                  09220000
C21565*           ADD EXCLUDED SKUS TO EXCL TABLE                       09230000
C21565            ADD +1 TO PV-MAX-EXCL                                 09240000
C21565            IF PV-MAX-EXCL < PC-EXCL-LIMIT                        09250000
C21565                MOVE PM106-MDSE-SELN-ID                           09260000
C21565                    TO PT-MDSE-SELN-ID (PV-MAX-EXCL)              09270000
C21565                MOVE PM106-MDSE-SELN-LNE-ID                       09280000
C21565                    TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)          09290000
C21565                MOVE PT-SCL-SKU-NBR (PT-SCL-SKU-INDX)             09300000
C21565                    TO PT-SKU-NBR (PV-MAX-EXCL)                   09310000
C21565            ELSE                                                  09320000
C21565                MOVE 'E500-PROCESS-SCL-SKU-TABLE'                 09330000
C21565                                            TO PV-PARAGRAPH-NAME  09330000
C21565                MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-1 09340000
C21565                PERFORM Z900-SQL-ABEND                            09350000
C21565            END-IF                                                09360000
C21565        ELSE                                                      09370000
C21565*           LOOK FOR THE SKU IN THE EXCLUSION LIST                09380000
C21565            PERFORM WITH TEST BEFORE                              09390000
C21565                VARYING PV-EXCL-SUB FROM +1 BY +1                 09400000
C21565                UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR              09410000
C21565                ( PT-SKU-NBR(PV-EXCL-SUB) =                       09420000
C21565                             PT-SCL-SKU-NBR (PT-SCL-SKU-INDX) AND 09420000
C21565                  PT-MDSE-SELN-ID(PV-EXCL-SUB) =                  09430000
C21565                      PM106-MDSE-SELN-ID AND                      09440000
C21565                  PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =              09450000
C21565                      PM106-MDSE-SELN-LNE-ID )                    09460000
C21565            END-PERFORM                                           09470000
C21565                                                                  09480000
C21565*           IF SKU WASN'T FOUND IN THE EXCLUSION LIST, WRITE IT   09490000
C21565            IF PV-EXCL-SUB > PV-MAX-EXCL                          09500000
C21565                MOVE PT-SCL-SKU-NBR (PT-SCL-SKU-INDX)             09690000
C21565                                         TO PM113-SKU-NBR         09690000
C21565                MOVE PM106-STR-NBR       TO PM113-LOC-NBR         09700000
C21565                                                                  09720000
C21565                MOVE PM106-PROMO-INTFC-ID                         09530000
C21565                                         TO PM113-PROMO-INTFC-ID  09530000
C21565                MOVE PM106-MDSE-SELN-ID  TO PM113-MDSE-SELN-ID    09540000
C21565                MOVE PM106-MDSE-SELN-LNE-ID                       09550000
C21565                                         TO PM113-MDSE-SELN-LNE-ID09560000
C21565                MOVE PM106-AD-EVNT-ID    TO PM113-AD-EVNT-ID      09570000
C21565                MOVE PM106-PROMO-ID      TO PM113-PROMO-ID        09580000
C21565                MOVE PM106-STRT-TMST     TO PM113-PROMO-STRT-TMST 09590000
C21565                MOVE PM106-END-TMST      TO PM113-PROMO-END-TMST  09600000
C21565                MOVE PM106-PROMO-ITM-ID  TO PM113-PROMO-ITM-ID    09610000
C21565                MOVE PM106-DEPT-NBR      TO PM113-DEPT-NBR        09630000
C21565                MOVE PM106-MAJ-CL-NBR    TO PM113-MAJ-CL-NBR      09640000
C21565                MOVE PM106-SUB-CL-NBR    TO PM113-SUB-CL-NBR      09650000
C21565                                                                  09680000
C21565                MOVE PT-SCL-VS-ID   (PT-SCL-SKU-INDX)             09660000
C21565                                         TO PM113-VS-ID           09660000
C21565                MOVE PT-SCL-VS-NBR  (PT-SCL-SKU-INDX)             09670000
C21565                                         TO PM113-VS-NBR          09670000
C21565                                                                  09750000
C21565                MOVE PT-SCL-INTR-UPC-ID (PT-SCL-SKU-INDX)                 
C21565                                         TO PM113-INTR-UPC-ID             
C21565                                                                  09850000
C21565                PERFORM H100-MOVE-PROMO-PRICE-FIELDS              07020000
C21565                                                                  07020000
C21565                MOVE 3 TO PM113-MDSE-HIER-LVL-CDE                 09860000
                                                                                
C21565                PERFORM W100-WRITE-EXPLODED-FILE                  09880000
C21565            END-IF                                                09920000
C21565        END-IF.                                                   09930000
C21565                                                                  09930000
      ******************************************************************10170000
      * OPEN THE MAJOR CLASS CURSOR                                     10180000
      ******************************************************************10190000
       F100-OPEN-MCL-CSR.                                               10200000
                                                                        10210000
           EXEC SQL                                                     10220000
               OPEN MCL-CSR                                             10230000
           END-EXEC.                                                    10240000
                                                                        10250000
           EVALUATE TRUE                                                10260000
               WHEN SQLCODE = +0                                        10270000
                   CONTINUE                                             10280000
               WHEN OTHER                                               10290000
                   MOVE 'F100-OPEN-MCL-CSR             '                10300000
                                     TO PV-PARAGRAPH-NAME               10310000
                   MOVE 'OPEN ERROR ON MCL-CSR       '                  10320000
                                     TO PV-OPERATION-MSG-1              10330000
                   PERFORM Z900-SQL-ABEND                               10340000
           END-EVALUATE.                                                10350000
                                                                        10360000
      ******************************************************************10370000
      * FETCH THE MAJOR CLASS CURSOR                                    10380000
      ******************************************************************10390000
       F200-FETCH-MCL-CSR.                                              10400000
                                                                        10410000
           EXEC SQL                                                     10420000
               FETCH MCL-CSR                                            10430000
                INTO :XST00013-SUB-CL-NBR                               10440000
                    ,:XST00013-VS-ID                                    10450000
                    ,:XST00013-VS-NBR                                   10460000
                    ,:XST00010-INTR-UPC-ID                              10470000
                    ,:XST00010-SKU-NBR                                  10480000
           END-EXEC.                                                    10490000
                                                                        10500000
           EVALUATE TRUE                                                10510000
               WHEN SQLCODE = +0                                        10520000
                   CONTINUE                                             10530000
               WHEN SQLCODE = +100                                      10540000
                   SET PS-END-OF-MCL-CSR TO TRUE                        10550000
               WHEN OTHER                                               10560000
                   MOVE 'F200-FETCH-MCL-CSR            '                10570000
                                     TO PV-PARAGRAPH-NAME               10580000
                   MOVE 'FETCH ERROR ON MCL-CSR      '                  10590000
                                     TO PV-OPERATION-MSG-1              10600000
                   PERFORM Z900-SQL-ABEND                               10610000
           END-EVALUATE.                                                10620000
                                                                        10630000
      ******************************************************************10640000
      * PROCESS THE MAJOR CLASS CURSOR                                  10650000
      ******************************************************************10660000
       F300-PROCESS-MCL-CSR.                                            10670000
                                                                        10680000
              IF PM106-REC-TYP-CDE = 0                                  10750000
      *           ADD EXCLUDED SKUS TO EXCL TABLE                       10760000
                  ADD +1 TO PV-MAX-EXCL                                 10770000
                  IF PV-MAX-EXCL < PC-EXCL-LIMIT                        10780000
                      MOVE PM106-MDSE-SELN-ID                           10790000
                          TO PT-MDSE-SELN-ID (PV-MAX-EXCL)              10800000
                      MOVE PM106-MDSE-SELN-LNE-ID                       10810000
                          TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)          10820000
                      MOVE XST00010-SKU-NBR                             10830000
                          TO PT-SKU-NBR (PV-MAX-EXCL)                   10840000
                  ELSE                                                  10850000
                      MOVE 'F300-PROCESS-MCL-CSR' TO PV-PARAGRAPH-NAME  10860000
                      MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-1 10870000
                      PERFORM Z900-SQL-ABEND                            10880000
                  END-IF                                                10890000
              ELSE                                                      10900000
      *           LOOK FOR THE SKU IN THE EXCLUSION LIST                10910000
                  PERFORM WITH TEST BEFORE                              10920000
                      VARYING PV-EXCL-SUB FROM +1 BY +1                 10930000
                      UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR              10940000
                        ( PT-SKU-NBR(PV-EXCL-SUB) = XST00010-SKU-NBR AND10950000
                          PT-MDSE-SELN-ID(PV-EXCL-SUB) =                10960000
                           PM106-MDSE-SELN-ID AND                       10970000
                          PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =            10980000
                           PM106-MDSE-SELN-LNE-ID )                     10990000
                  END-PERFORM                                           11000000
                                                                        11010000
      *           IF SKU WASN'T FOUND IN THE EXCLUSION LIST, WRITE IT   11020000
                  IF PV-EXCL-SUB > PV-MAX-EXCL                          11030000
JB0308               MOVE XST00010-SKU-NBR     TO PM113-SKU-NBR         11220000
JB0308               MOVE PM106-STR-NBR        TO PM113-LOC-NBR         11230000
JB0308               MOVE PM106-PROMO-INTFC-ID                          11060000
JB0308                                         TO PM113-PROMO-INTFC-ID  11060000
JB0308               MOVE PM106-MDSE-SELN-ID   TO PM113-MDSE-SELN-ID    11070000
JB0308               MOVE PM106-MDSE-SELN-LNE-ID                        11080000
JB0308                                         TO PM113-MDSE-SELN-LNE-ID11090000
JB0308               MOVE PM106-AD-EVNT-ID     TO PM113-AD-EVNT-ID      11100000
JB0308               MOVE PM106-PROMO-ID       TO PM113-PROMO-ID        11110000
JB0308               MOVE PM106-STRT-TMST      TO PM113-PROMO-STRT-TMST 11120000
JB0308               MOVE PM106-END-TMST       TO PM113-PROMO-END-TMST  11130000
JB0308               MOVE PM106-PROMO-ITM-ID   TO PM113-PROMO-ITM-ID    11140000
JB0308               MOVE PM106-DEPT-NBR       TO PM113-DEPT-NBR        11160000
JB0308               MOVE PM106-MAJ-CL-NBR     TO PM113-MAJ-CL-NBR      11170000
                                                                                
JB0308               MOVE XST00013-SUB-CL-NBR TO PM113-SUB-CL-NBR       11180000
JB0308               MOVE XST00013-VS-ID      TO PM113-VS-ID            11340000
JB0308               MOVE XST00013-VS-NBR     TO PM113-VS-NBR           11200000
                                                                        11280000
JB0308               MOVE XST00010-INTR-UPC-ID TO PM113-INTR-UPC-ID             
                                                                        11380000
JB0308               PERFORM H100-MOVE-PROMO-PRICE-FIELDS               07020000
JB0308                                                                  07020000
JB0308               MOVE 4 TO PM113-MDSE-HIER-LVL-CDE                  11390000
                                                                                
                     PERFORM W100-WRITE-EXPLODED-FILE                   11410000
                  END-IF                                                11450000
JB0308        END-IF.                                                   11460000
           PERFORM F200-FETCH-MCL-CSR.                                  11480000
                                                                        11490000
      ******************************************************************11500000
      * CLOSE THE MAJOR CLASS CURSOR                                    11510000
      ******************************************************************11520000
       F400-CLOSE-MCL-CSR.                                              11530000
                                                                        11540000
           EXEC SQL                                                     11550000
               CLOSE MCL-CSR                                            11560000
           END-EXEC.                                                    11570000
                                                                        11580000
           EVALUATE TRUE                                                11590000
               WHEN SQLCODE = +0                                        11600000
                   CONTINUE                                             11610000
               WHEN OTHER                                               11620000
                   MOVE 'F400-CLOSE-MCL-CSR             '               11630000
                                     TO PV-PARAGRAPH-NAME               11640000
                   MOVE 'CLOSE ERROR ON MCL-CSR       '                 11650000
                                     TO PV-OPERATION-MSG-1              11660000
                   PERFORM Z900-SQL-ABEND                               11670000
           END-EVALUATE.                                                11680000
                                                                        11690000
      ******************************************************************11700000
      * OPEN THE DEPT CURSOR                                            11710000
      ******************************************************************11720000
       G100-OPEN-DEPT-CSR.                                              11730000
                                                                        11740000
           EXEC SQL                                                     11750000
               OPEN DEPT-CSR                                            11760000
           END-EXEC.                                                    11770000
                                                                        11780000
           EVALUATE TRUE                                                11790000
               WHEN SQLCODE = +0                                        11800000
                   CONTINUE                                             11810000
               WHEN OTHER                                               11820000
                   MOVE 'G100-OPEN-DEPT-CSR            '                11830000
                                     TO PV-PARAGRAPH-NAME               11840000
                   MOVE 'OPEN ERROR ON DEPT-CSR      '                  11850000
                                     TO PV-OPERATION-MSG-1              11860000
                   PERFORM Z900-SQL-ABEND                               11870000
           END-EVALUATE.                                                11880000
                                                                        11890000
      ******************************************************************11900000
      * FETCH THE DEPT CURSOR                                           11910000
      ******************************************************************11920000
       G200-FETCH-DEPT-CSR.                                             11930000
                                                                        11940000
           EXEC SQL                                                     11950000
               FETCH DEPT-CSR                                           11960000
                INTO :XST00013-MAJ-CL-NBR                               11970000
                    ,:XST00013-SUB-CL-NBR                               11980000
                    ,:XST00013-VS-ID                                    11990000
                    ,:XST00013-VS-NBR                                   12000000
                    ,:XST00010-INTR-UPC-ID                              12010000
                    ,:XST00010-SKU-NBR                                  12020000
           END-EXEC.                                                    12030000
                                                                        12040000
           EVALUATE TRUE                                                12050000
               WHEN SQLCODE = +0                                        12060000
                   CONTINUE                                             12070000
               WHEN SQLCODE = +100                                      12080000
                   SET PS-END-OF-DEPT-CSR TO TRUE                       12090000
               WHEN OTHER                                               12100000
                   MOVE 'G200-FETCH-DEPT-CSR           '                12110000
                                     TO PV-PARAGRAPH-NAME               12120000
                   MOVE 'FETCH ERROR ON DEPT-CSR     '                  12130000
                                     TO PV-OPERATION-MSG-1              12140000
                   PERFORM Z900-SQL-ABEND                               12150000
           END-EVALUATE.                                                12160000
                                                                        12170000
      ******************************************************************12180000
      * PROCESS THE DEPT CURSOR                                         12190000
      ******************************************************************12200000
       G300-PROCESS-DEPT-CSR.                                           12210000
                                                                        12220000
              IF PM106-REC-TYP-CDE = 0                                  12290000
      *           SHOULDN'T EVER FALL IN HERE (FOR NOW AT LEAST)...     12300000
      *            SINCE EXCLUSIONS CAN'T BE DONE AT DEPT LEVEL         12310000
                                                                        12320000
      *           ADD EXCLUDED SKUS TO EXCL TABLE                       12330000
                  ADD +1 TO PV-MAX-EXCL                                 12340000
                  IF PV-MAX-EXCL < PC-EXCL-LIMIT                        12350000
                      MOVE PM106-MDSE-SELN-ID                           12360000
                          TO PT-MDSE-SELN-ID (PV-MAX-EXCL)              12370000
                      MOVE PM106-MDSE-SELN-LNE-ID                       12380000
                          TO PT-MDSE-SELN-LNE-ID (PV-MAX-EXCL)          12390000
                      MOVE XST00010-SKU-NBR                             12400000
                          TO PT-SKU-NBR (PV-MAX-EXCL)                   12410000
                  ELSE                                                  12420000
                      MOVE 'G300-PROCESS-DEPT-CSR' TO PV-PARAGRAPH-NAME 12430000
                      MOVE 'TOO MANY EXCLUSIONS ' TO PV-OPERATION-MSG-1 12440000
                      PERFORM Z900-SQL-ABEND                            12450000
                  END-IF                                                12460000
              ELSE                                                      12470000
      *           LOOK FOR THE SKU IN THE EXCLUSION LIST                12480000
                  PERFORM WITH TEST BEFORE                              12490000
                      VARYING PV-EXCL-SUB FROM +1 BY +1                 12500000
                      UNTIL (PV-EXCL-SUB > PV-MAX-EXCL) OR              12510000
                        ( PT-SKU-NBR(PV-EXCL-SUB) = XST00010-SKU-NBR AND12520000
                          PT-MDSE-SELN-ID(PV-EXCL-SUB) =                12530000
                              PM106-MDSE-SELN-ID AND                    12540000
                          PT-MDSE-SELN-LNE-ID(PV-EXCL-SUB) =            12550000
                              PM106-MDSE-SELN-LNE-ID )                  12560000
                  END-PERFORM                                           12570000
                                                                        12580000
      *           IF SKU WASN'T FOUND IN THE EXCLUSION LIST, WRITE IT   12590000
                  IF PV-EXCL-SUB > PV-MAX-EXCL                          12600000
JB0308                MOVE XST00010-SKU-NBR    TO PM113-SKU-NBR         12790000
JB0308                MOVE PM106-STR-NBR       TO PM113-LOC-NBR         12800000
                                                                        12820000
JB0308                MOVE PM106-PROMO-INTFC-ID                         12630000
JB0308                                         TO PM113-PROMO-INTFC-ID  12630000
JB0308                MOVE PM106-MDSE-SELN-ID  TO PM113-MDSE-SELN-ID    12640000
JB0308                MOVE PM106-MDSE-SELN-LNE-ID                       12650000
JB0308                                         TO PM113-MDSE-SELN-LNE-ID12660000
JB0308                MOVE PM106-AD-EVNT-ID    TO PM113-AD-EVNT-ID      12670000
JB0308                MOVE PM106-PROMO-ID      TO PM113-PROMO-ID        12680000
JB0308                MOVE PM106-STRT-TMST     TO PM113-PROMO-STRT-TMST 12690000
JB0308                MOVE PM106-END-TMST      TO PM113-PROMO-END-TMST  12700000
JB0308                MOVE PM106-PROMO-ITM-ID  TO PM113-PROMO-ITM-ID    12710000
JB0308                MOVE PM106-DEPT-NBR      TO PM113-DEPT-NBR        12730000
                                                                        12720000
JB0308                MOVE XST00013-MAJ-CL-NBR TO PM113-MAJ-CL-NBR      12740000
JB0308                MOVE XST00013-SUB-CL-NBR TO PM113-SUB-CL-NBR      12750000
JB0308                MOVE XST00013-VS-ID      TO PM113-VS-ID           12760000
JB0308                MOVE XST00013-VS-NBR     TO PM113-VS-NBR          12770000
                                                                        12780000
JB0308                MOVE XST00010-INTR-UPC-ID TO PM113-INTR-UPC-ID            
                                                                        12910000
JB0308                PERFORM H100-MOVE-PROMO-PRICE-FIELDS              07020000
JB0308                                                                  07020000
JB0308                MOVE 5 TO PM113-MDSE-HIER-LVL-CDE                 12960000
                                                                                
                      PERFORM W100-WRITE-EXPLODED-FILE                  12980000
                  END-IF                                                13020000
JB0308        END-IF.                                                   13030000
           PERFORM G200-FETCH-DEPT-CSR.                                 13050000
                                                                        13060000
      ******************************************************************13070000
      * CLOSE THE DEPT CURSOR                                           13080000
      ******************************************************************13090000
       G400-CLOSE-DEPT-CSR.                                             13100000
                                                                        13110000
           EXEC SQL                                                     13120000
               CLOSE DEPT-CSR                                           13130000
           END-EXEC.                                                    13140000
                                                                        13150000
           EVALUATE TRUE                                                13160000
               WHEN SQLCODE = +0                                        13170000
                   CONTINUE                                             13180000
               WHEN OTHER                                               13190000
                   MOVE 'G400-CLOSE-DEPT-CSR          '                 13200000
                                     TO PV-PARAGRAPH-NAME               13210000
                   MOVE 'CLOSE ERROR ON DEPT-CSR      '                 13220000
                                     TO PV-OPERATION-MSG-1              13230000
                   PERFORM Z900-SQL-ABEND                               13240000
           END-EVALUATE.                                                13250000
                                                                        13260000
      ******************************************************************13270000
      * MOVE OUT THE PROMO PRICING FIELDS                               13280000
      ******************************************************************13290000
       H100-MOVE-PROMO-PRICE-FIELDS.                                    13300000
                                                                        13310000
JB0308     MOVE PM106-PRICG-TYP-CDE TO PM113-PROMO-PRICG-TYP-CDE        13320000
                                                                        13330000
           IF PM106-PRICG-TYP-CDE(1:1) = 'G'                            13340000
JB0308         MOVE 0 TO PM113-PROMO-PRIC-PT-AMT                        13350000
JB0308                   PM113-PROMO-PRICG-AMT                          13360000
                                                                        13370000
JB0308         MOVE PM106-GROUP-QTY TO PM113-PROMO-GP-QTY               13380000
JB0308         MOVE PM106-PRICG-AMT TO PM113-PROMO-GP-AMT               13390000
           ELSE                                                         13400000
               IF PM106-PRICG-TYP-CDE = 'SPO'                           13410000
JB0308             MOVE ZEROS           TO PM113-PROMO-PRIC-PT-AMT      13460000
               ELSE                                                     13470000
JB0308             MOVE PM106-PRICG-AMT TO PM113-PROMO-PRIC-PT-AMT      13480000
               END-IF                                                   13490000
                                                                        13500000
JB0308         MOVE PM106-PRICG-AMT TO PM113-PROMO-PRICG-AMT            13510000
                                                                        13520000
JB0308         MOVE 0 TO PM113-PROMO-GP-QTY                             13530000
JB0308                   PM113-PROMO-GP-AMT                             13540000
           END-IF.                                                      13550000
                                                                        13560000
      ******************************************************************15980000
      * WRITE THE EXPLODED FILE                                         15990000
      ******************************************************************16000000
       W100-WRITE-EXPLODED-FILE.                                        16010000
                                                                        16020000
JB0308     WRITE EXPLODED-REC FROM PM113-EXCPT-PRCG-EXT-SKU.            16030000
           ADD +1 TO PA-RECS-WRITTEN.                                   16040000
                                                                        16050000
      ******************************************************************16060000
      * SQL ABEND / EL ABENDO DEL SQL                                   16070000
      ******************************************************************16080000
       Z900-SQL-ABEND.                                                  16090000
                                                                        16100000
           DISPLAY 'Z900-SQL-ABEND'.                                    16110000
           DISPLAY '**  ABEND     **'.                                  16120000
           DISPLAY '**  PROGRAM   **  = ' PC-PROGRAM-NAME.              16130000
           DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            16140000
           DISPLAY '**  OPERATION **  = ' PV-OPERATION-MSG-1.           16150000
           DISPLAY '**            **  = ' PV-OPERATION-MSG-2.           16160000
                                                                        16170000
      ******************************************************************16180000
      * THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *16190000
      * MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *16200000
      * 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *16210000
      * FORMAT.                                                        *16220000
      ******************************************************************16230000
           COPY DPPD004.                                                16240000
                                                                        16250000
           SET ABEND-4013-DB2-ERROR TO TRUE.                            16260000
           CALL 'ILBOABN0' USING ABEND-CODE.                            16270000
