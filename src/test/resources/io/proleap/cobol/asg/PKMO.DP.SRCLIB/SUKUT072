000100******************************************************************00010001
000200 IDENTIFICATION DIVISION.                                         00020001
000300******************************************************************00030001
000400                                                                  00040001
000500 PROGRAM-ID.             SUKUT072.                                00050001
000600 AUTHOR.                 LYNN MCADAMS.                            00060001
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070001
000800 DATE-WRITTEN            JULY, 2002.                              00080001
000900 DATE-COMPILED.                                                   00090001
001000                                                                  00100001
001100*----------------------------------------------------------------*00110001
001200* THIS PROGRAM WILL CREATE 1 OUTPUT EXTRACT FILE AT THE PO,      *00120002
001300* RECEIVER, LINE LEVEL FROM THE TRECEIV TABLE.  THE NEW FILE     *00130002
001400* WILL CONTAIN PO, RCVR LINES THAT HAVE A COMPLETED STATUS.      *00140002
001500* THE LAYOUT FOR THE OUTPUT FILE IS SURD036.                     *00150002
001600*----------------------------------------------------------------*00160001
001700                                                                  00170001
001800***************************************************************** 00180001
001900 ENVIRONMENT DIVISION.                                            00190001
002000***************************************************************** 00200001
002100 INPUT-OUTPUT SECTION.                                            00210001
002200                                                                  00220001
002300 FILE-CONTROL.                                                    00230001
002400                                                                  00240001
002500     SELECT EXTRACT-FILE1 ASSIGN TO OUT01.                        00250001
002600                                                                  00260001
002700***************************************************************** 00270001
002800 DATA DIVISION.                                                   00280001
002900***************************************************************** 00290001
003000 FILE SECTION.                                                    00300001
003100*                                                                 00310001
003200*                                                                 00320001
003300 FD  EXTRACT-FILE1                                                00330001
003400     RECORDING MODE IS F                                          00340001
003500     LABEL RECORDS ARE STANDARD                                   00350001
003600     BLOCK CONTAINS 0 RECORDS.                                    00360001
003700 01  EXTRACT-RECORD1             PIC X(300).                      00370044
003800*                                                                 00380001
003900*                                                                 00390001
004000***************************************************************** 00400001
004100 WORKING-STORAGE SECTION.                                         00410001
004200                                                                  00420001
004300 01  PS-PROGRAM-SWITCHES.                                         00430001
004400     05  PS-EOF-TRECEIV-SW            PIC X(01)  VALUE 'N'.       00440004
004500         88  PS-EOF-TRECEIV-CSR                  VALUE 'Y'.       00450004
004600         88  PS-NOT-EOF-TRECEIV-CSR              VALUE 'N'.       00460004
004700     05  PS-EOF-TKRPRPM-SW            PIC X(01)  VALUE 'N'.       00470086
004800         88  PS-EOF-TKRPRPM-CSR                  VALUE 'Y'.       00480086
004900         88  PS-NOT-EOF-TKRPRPM-CSR              VALUE 'N'.       00490086
005000     05  PS-MANIFEST-DC-SW            PIC X(01)  VALUE 'N'.       00500001
005100         88  PS-MANIFEST-DC-FOUND                VALUE 'Y'.       00510001
005200         88  PS-MANIFEST-DC-NOT-FND              VALUE 'N'.       00520001
005300*                                                                 00530001
005400 01  PV-PROGRAM-VARIABLES.                                        00540001
005500     05 PV-EXTRACT-DTE                PIC X(10).                  00550001
005600*                                                                 00560001
005700     05 PV-CRE-DATE-TMST              PIC X(10).                  00570001
005800     05 PV-CRE-TIME-TMST              PIC X(8).                   00580001
005900*                                                                 00590001
006000     05  PV-SQLCODE                   PIC 9(9)   VALUE ZERO.      00600001
006100*                                                                 00610001
006200     05  PV-FETCH-COUNT               PIC S9(09) VALUE ZERO       00620076
006300                                                  COMP SYNC.      00630001
006400     05  PV-WRITE-COUNT               PIC S9(09) VALUE ZERO       00640076
006500                                                  COMP SYNC.      00650001
006600     05  PV-DISPLAY-COUNT             PIC ZZZ,ZZZ,ZZ9.            00660001
006700     05  PV-DISPLAY-PO-NBR               PIC 999999999-.          00670099
006800     05  PV-DISPLAY-PO-LINE-NBR          PIC 999999999-.          00680099
006900     05  PV-DISPLAY-RCVR-SEQ-NBR         PIC 999999999-.          00690099
007000     05  PV-DB2-CURRENT-TIMESTAMP     PIC X(26)  VALUE SPACE.     00700001
007100     05  PV-DB2-TABLE-NAME            PIC  X(08) VALUE SPACES.    00710099
007200     05  PV-DB2-TABLE-NAME1           PIC  X(08) VALUE SPACES.    00720099
007300     05  PV-DB2-FUNCTION             PIC X(30) VALUE SPACE.       00730099
007400                                                                  00740001
007500 01  CC-CONTROL-CARD.                                             00750086
007600     05  CC-CONSTANT                 PIC  X(07)      VALUE SPACE. 00760086
007700     05  FILLER                      PIC  X(01)      VALUE SPACE. 00770086
007800*    05  CC-DAYS                     PIC  9(03)      VALUE ZERO.  00780086
007900     05  CC-TIME-ZONE                PIC  X(25)      VALUE SPACE. 00790086
008000     05  FILLER                      PIC  X(44)      VALUE SPACE. 00800086
008100                                                                  00810086
008200 01  DK-DB-KEYS.                                                  00820001
008300     05  DK-OPER-UNT-ID              PIC S9(04) COMP.             00830051
008400     05  DK-PO-NBR                   PIC S9(09) COMP.             00840001
008500     05  DK-REC-SEQ-NBR              PIC S9(09) COMP.             00850058
008600     05  DK-LINE-NBR                 PIC S9(09) COMP.             00860058
008700                                                                  00870001
008800 01  DN-DB2-NULL-INDICATORS.                                      00880001
008900     05  DN-VEH-NBR                   PIC S9(04) COMP VALUE +0.   00890001
009000                                                                  00900001
009100 01 PC-PROGRAM-CONSTANTS.                                         00910001
009200     05 PC-PROGRAM-NAME              PIC X(08)  VALUE 'SUKUT072'. 00920001
009300     05 PC-DEFAULT-TMST              PIC X(26)                    00930001
009400             VALUE '9999-09-09-09.09.09.999999'.                  00940001
009500                                                                  00950001
009600                                                                  00960001
009700 01  PV-ABEND-FIELDS.                                             00970001
009800     05  PV-ABEND-CODE                PIC S9(04) VALUE +0         00980001
009900                                                 COMP SYNC.       00990001
010000     05  PV-ABEND-PROGRAM             PIC  X(08) VALUE 'SUKUT072'.01000001
010100     05  PV-ABEND-PARAGRAPH           PIC  X(50) VALUE SPACES.    01010001
010200     05  PV-ABEND-OPERATION           PIC  X(51) VALUE SPACES.    01020001
010300     05  PV-ABEND-OPERATION1          PIC  X(51) VALUE SPACES.    01030099
010400     05  PV-ABEND-OPERATION2          PIC  X(51) VALUE SPACES.    01040099
010500     05  PV-ABEND-OPERATION3          PIC  X(51) VALUE SPACES.    01050099
010600     05  PV-ABEND-DATA1               PIC  X(10) VALUE SPACES.    01060065
010700     05  PV-ABEND-DATA2               PIC  X(10) VALUE SPACES.    01070065
010800     05  PV-PARAGRAPH-NAME            PIC  X(30) VALUE SPACES.    01080001
010900     05  PV-DB2-OPERATION-ATTEMPTED   PIC  X(30) VALUE SPACES.    01090001
011000     05  PV-DISPLAY-SQLCODE           PIC -9(05) VALUE ZEROES.    01100001
011100     05  PV-SQL-RETURN-CD             PIC  999-.                  01110001
011200     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    01120001
011300     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    01130001
011400     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    01140001
011500     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    01150001
011600                                                                  01160001
011700******************************************************************01170001
011800*  USED FOR DB2 ERROR MESSAGE BUILDING                            01180001
011900******************************************************************01190001
012000     COPY DPWS004.                                                01200099
012100                                                                  01210001
012200******************************************************************01220001
012300*   DB2 SQL COMMUNICATION AREA                                    01230001
012400******************************************************************01240001
012500     EXEC SQL                                                     01250001
012600          INCLUDE SQLCA                                           01260001
012700     END-EXEC.                                                    01270001
012800*DB2 AREA FOR COMMUNICATIONS AREA2                                01280099
012900     COPY SQLCA2.                                                 01290099
013000                                                                  01300001
013100******************************************************************01310001
013200*   DB2 DCLGEN FOR PO-PURCHASE TABLE                              01320001
013300******************************************************************01330001
013400     EXEC SQL                                                     01340001
013500          INCLUDE TPURCHS                                         01350001
013600     END-EXEC.                                                    01360001
013700                                                                  01370001
013800******************************************************************01380001
013900*   DB2 DCLGEN FOR RC-RECEIPT ITEM TABLE                          01390001
014000******************************************************************01400001
014100     EXEC SQL                                                     01410001
014200          INCLUDE TRECITM                                         01420001
014300     END-EXEC.                                                    01430001
014400                                                                  01440001
014500******************************************************************01450001
014600*   DB2 DCLGEN FOR RC-RECEIVER TABLE                              01460001
014700******************************************************************01470001
014800     EXEC SQL                                                     01480001
014900          INCLUDE TRECEIV                                         01490001
015000     END-EXEC.                                                    01500001
015100                                                                  01510001
015200******************************************************************01520001
015300*   DB2 DCLGEN FOR DC-DISTRIBUTION TRANSACTION HEADER TABLE       01530001
015400******************************************************************01540001
015500     EXEC SQL                                                     01550001
015600          INCLUDE TDISTHD                                         01560001
015700     END-EXEC.                                                    01570001
015800                                                                  01580001
015900******************************************************************01590001
016000*   DCLGEN LAYOUT AND COBOL DECLARATION FOR THE PARM TABLE TO     01600001
016100*   CHECK IF DC IS MANIFESTING                                    01610001
016200******************************************************************01620001
016300     EXEC SQL                                                     01630001
016400          INCLUDE TKRPRPM                                         01640001
016500     END-EXEC.                                                    01650001
016600                                                                  01660057
016700******************************************************************01670088
016800*  DCLGEN LAYOUT AND COBOL DECLARATION FOR THE LOGISTICS          01680099
016900*  LOCATION TABLE                                                 01690099
017000******************************************************************01700088
017100* XLT_LOC                                                         01710099
017200     EXEC SQL                                                     01720088
017300          INCLUDE XLT00010                                        01730099
017400     END-EXEC.                                                    01740088
017500                                                                  01750088
017600******************************************************************01760057
017700*   DB2 DCLGEN FOR PC-WORK ORDER INSTRUCTION TABLE                01770057
017800******************************************************************01780057
017900     EXEC SQL                                                     01790057
018000          INCLUDE TWKORIN                                         01800057
018100     END-EXEC.                                                    01810057
018200                                                                  01820001
018300                                                                  01830001
018400******************************************************************01840001
018500* EXTRACT CURSOR                                                 *01850001
018600******************************************************************01860001
018700     EXEC SQL                                                     01870001
018800          DECLARE TRECEIV-CSR CURSOR FOR                          01880004
018900          SELECT A.ORD_NBR                                        01890091
019000               , A.REC_SEQ_NBR                                    01900034
019100               , B.ORD_LNE_NBR                                    01910034
019200               , A.REC_TYP_CDE                                    01920099
019300               , B.STATUS_CDE                                     01930034
019400               , A.VERFYD_TMST                                    01940034
019500               , B.VERFYD_TMST                                    01950073
019600               , CURRENT TIMESTAMP                                01960001
019700            FROM TRECEIV A                                        01970034
019800               , TRECITM B                                        01980034
019900           WHERE A.ORD_NBR        = B.ORD_NBR                     01990037
020000             AND A.REC_SEQ_NBR    = B.REC_SEQ_NBR                 02000037
020100             AND A.OPER_UNT_ID    = :DK-OPER-UNT-ID               02010098
020200             AND A.STATUS_CDE     = 'CM'                          02020037
020300             AND B.VER_STATUS_CDE = 'A'                           02030034
020400             AND NOT A.REC_TYP_CDE IN ('AP', 'CD')                02040099
020500        ORDER BY A.CURR_OPER_UNT_ID                               02050083
020600             WITH UR                                              02060081
020700     END-EXEC.                                                    02070001
020800                                                                  02080001
020900******************************************************************02090086
021000*  TKRPRPM CURSOR - GET DC'S IN TIMEZONE                         *02100086
021100******************************************************************02110086
021200     EXEC SQL                                                     02120086
021300          DECLARE TKRPRPM_CSR CURSOR FOR                          02130086
021400            SELECT A.LOC_NBR,                                     02140099
021500                   A.OPN_DTE,                                     02150099
021600                   A.CLO_DTE                                      02160099
021700            FROM   XLT_LOC A,                                     02170099
021800                   TKRPRPM B                                      02180086
021900            WHERE  A.LOC_TYP_CDE      = 'DC'                      02190099
022000              AND  A.LOC_NBR          = B.LOC_ID                  02200099
022100              AND  B.SYS_PRC_FUNC_CDE = 'STATZN'                  02210086
022200              AND  B.INTFC_SYS_CDE    = 'KHL'                     02220086
022300              AND  B.FUNC_TXT         = :CC-TIME-ZONE             02230086
022400            ORDER BY 1                                            02240086
022500            WITH UR                                               02250086
022600     END-EXEC.                                                    02260086
022700                                                                  02270007
022800***********************************************************       02280001
022900*  RECORD LAYOUT FOR THE CARTON EXCEPTION EXTRACT FILE            02290043
023000***********************************************************       02300001
023100     COPY SURD036.                                                02310099
023200                                                                  02320001
023300 EJECT                                                            02330001
023400***********************************************************       02340001
023500 PROCEDURE DIVISION.                                              02350001
023600***********************************************************       02360001
023700*    DISPLAY '***BEGINNING SUKUT072***'.                          02370061
023800                                                                  02380040
023900     PERFORM 1000-INITIALIZE.                                     02390079
024000                                                                  02400040
024100     PERFORM 2000-PROCESS-CURSOR                                  02410038
024200*        UNTIL PS-EOF-TRECEIV-CSR.                                02420090
024300         UNTIL PS-EOF-TKRPRPM-CSR.                                02430090
024400                                                                  02440040
024500     PERFORM 3530-CLOSE-TKRPRPM-CSR.                              02450090
024600                                                                  02460040
024700     PERFORM 9000-CLOSE-FILES                                     02470090
024800                                                                  02480040
024900                                                                  02490040
025000     GOBACK.                                                      02500001
025100                                                                  02510040
025200                                                                  02520040
025300******************************************************************02530001
025400*  DO FIRST TIME PROGRAM INITIALIZE TASKS.                        02540079
025500******************************************************************02550001
025600 1000-INITIALIZE.                                                 02560079
025700                                                                  02570001
025800     OPEN OUTPUT EXTRACT-FILE1.                                   02580002
025900                                                                  02590053
026000     INITIALIZE SU036-RECORD.                                     02600097
026100                                                                  02610097
026200     ACCEPT CC-CONTROL-CARD FROM SYSIN                            02620086
026300         DISPLAY '** TIMEZONE = ' CC-TIME-ZONE                    02630086
026400                                                                  02640086
026500*FIRST FETCH                                                      02650086
026600     SET PS-NOT-EOF-TKRPRPM-CSR TO TRUE                           02660086
026700     PERFORM 3510-OPEN-TKRPRPM-CSR                                02670086
026800     PERFORM 3520-FETCH-TKRPRPM-CSR                               02680086
026900                                                                  02690086
027000     IF SQLCODE = +0                                              02700086
027100        PERFORM 2150-CHECK-IF-MFST-DC                             02710086
027200     ELSE                                                         02720086
027300        SET PS-MANIFEST-DC-NOT-FND TO TRUE                        02730086
027400     END-IF                                                       02740086
027500                                                                  02750086
027600     IF PS-MANIFEST-DC-FOUND                                      02760086
027700*FIRST FETCH                                                      02770086
027800        SET PS-NOT-EOF-TRECEIV-CSR TO TRUE                        02780086
027900        PERFORM 1910-OPEN-TRECEIV-CSR                             02790086
028000        PERFORM 1920-FETCH-TRECEIV-CSR                            02800086
028100              UNTIL PS-EOF-TRECEIV-CSR                            02810086
028200        PERFORM 1930-CLOSE-TRECEIV-CSR                            02820086
028300     ELSE                                                         02830086
028400        CONTINUE                                                  02840086
028500     END-IF.                                                      02850086
028600                                                                  02860018
028700***************************************************************** 02870001
028800 1910-OPEN-TRECEIV-CSR.                                           02880020
028900***************************************************************** 02890001
029000     EXEC SQL                                                     02900001
029100         OPEN TRECEIV-CSR                                         02910004
029200     END-EXEC.                                                    02920001
029300                                                                  02930040
029400     EVALUATE TRUE                                                02940001
029500         WHEN SQLCODE = +0                                        02950001
029600             CONTINUE                                             02960001
029700         WHEN SQLWARN0 NOT = SPACE                                02970001
029800         WHEN SQLCODE  NOT = +0                                   02980001
029900             MOVE '1910-OPEN-TRECEIV-CSR'                         02990020
030000                                 TO PV-ABEND-PARAGRAPH            03000001
030100             PERFORM Z999-SQL-ABEND                               03010001
030200     END-EVALUATE.                                                03020001
030300                                                                  03030040
030400                                                                  03040040
030500***************************************************************** 03050001
030600* GET ROWS WHERE STATUS IS COMPLETED                              03060002
030700 1920-FETCH-TRECEIV-CSR.                                          03070040
030800***************************************************************** 03080001
030900     MOVE '1920-FETCH-TRECEIV-CSR  ' TO PV-ABEND-PARAGRAPH.       03090019
031000                                                                  03100040
031100     EXEC SQL                                                     03110001
031200          FETCH TRECEIV-CSR                                       03120004
031300           INTO  :RECEIV-ORD-NBR                                  03130091
031400               , :RECEIV-REC-SEQ-NBR                              03140002
031500               , :RECITM-ORD-LNE-NBR                              03150035
031600               , :RECEIV-REC-TYP-CDE                              03160099
031700               , :RECITM-STATUS-CDE                               03170035
031800               , :RECEIV-VERFYD-TMST                              03180002
031900               , :RECITM-VERFYD-TMST                              03190073
032000               , :PV-DB2-CURRENT-TIMESTAMP                        03200002
032100     END-EXEC.                                                    03210002
032200                                                                  03220040
032300     EVALUATE TRUE                                                03230002
032400         WHEN SQLCODE = +0                                        03240002
032500              MOVE RECEIV-ORD-NBR     TO DK-PO-NBR                03250064
032600              MOVE RECEIV-REC-SEQ-NBR TO DK-REC-SEQ-NBR           03260064
032700              MOVE RECITM-ORD-LNE-NBR TO DK-LINE-NBR              03270064
032800                                                                  03280064
032900*LMM          PERFORM 2150-CHECK-IF-MFST-DC                       03290086
033000*             IF PS-MANIFEST-DC-FOUND                             03300086
033100                 ADD +1 TO PV-FETCH-COUNT                         03310076
033200                 PERFORM 2355-SELECT-TWKORIN                      03320056
033300                 PERFORM 2360-SELECT-TPURCHS                      03330034
033400                 PERFORM 2370-SELECT-TDISTHD                      03340034
033500                                                                  03350034
033600                 PERFORM 2200-LOAD-EXTRACT-RECORD                 03360034
033700                 ADD +1 TO PV-WRITE-COUNT                         03370076
033800                 PERFORM 8000-WRITE-EXTRACT1                      03380034
033900*             END-IF                                              03390086
034000         WHEN SQLCODE = +100                                      03400002
034100              SET PS-EOF-TRECEIV-CSR TO TRUE                      03410036
034200         WHEN SQLWARN0 NOT = SPACE                                03420002
034300         WHEN SQLCODE  NOT = +0                                   03430002
034400              MOVE '1920-FETCH-TRECEIV-CSR'                       03440019
034500                                   TO PV-ABEND-PARAGRAPH          03450002
034600              MOVE 'ATTEMPTING TO FETCH EXTRACT CURSOR'           03460002
034700                                   TO PV-ABEND-OPERATION          03470002
034800              MOVE RECEIV-ORD-NBR      TO PV-DISPLAY-PO-NBR       03480099
034900              STRING 'PO NBR: '         DELIMITED BY SIZE         03490099
035000                  PV-DISPLAY-PO-NBR     DELIMITED BY SIZE         03500099
035100                            INTO PV-ABEND-OPERATION1              03510099
035200              MOVE RECEIV-REC-SEQ-NBR                             03520099
035300                              TO PV-DISPLAY-RCVR-SEQ-NBR          03530099
035400              STRING 'RECV SEQ: '       DELIMITED BY SIZE         03540099
035500                  PV-DISPLAY-RCVR-SEQ-NBR                         03550099
035600                                        DELIMITED BY SIZE         03560099
035700                            INTO PV-ABEND-OPERATION2              03570099
035800              MOVE RECITM-ORD-LNE-NBR  TO PV-DISPLAY-PO-LINE-NBR  03580099
035900              STRING 'PO LINE NBR: '    DELIMITED BY SIZE         03590099
036000                 PV-DISPLAY-PO-LINE-NBR DELIMITED BY SIZE         03600099
036100                            INTO PV-ABEND-OPERATION3              03610099
036200              PERFORM Z999-SQL-ABEND                              03620002
036300     END-EVALUATE.                                                03630002
036400                                                                  03640040
036500                                                                  03650040
036600***************************************************************** 03660040
036700 1930-CLOSE-TRECEIV-CSR.                                          03670019
036800***************************************************************** 03680005
036900                                                                  03690040
037000     EXEC SQL                                                     03700005
037100         CLOSE TRECEIV-CSR                                        03710005
037200     END-EXEC                                                     03720005
037300                                                                  03730042
037400                                                                  03740042
037500     EVALUATE TRUE                                                03750005
037600         WHEN SQLCODE = ZERO                                      03760005
037700             CONTINUE                                             03770005
037800         WHEN OTHER                                               03780005
037900             PERFORM Z999-SQL-ABEND                               03790005
038000     END-EVALUATE.                                                03800005
038100                                                                  03810040
038200                                                                  03820040
038300***************************************************************** 03830005
038400 2000-PROCESS-CURSOR.                                             03840038
038500***************************************************************** 03850005
038600     MOVE '2000-PROCESS-CURSOR  ' TO PV-ABEND-PARAGRAPH.          03860038
038700                                                                  03870019
038800*NEXT FETCH                                                       03880086
038900     PERFORM 3520-FETCH-TKRPRPM-CSR                               03890086
039000     IF SQLCODE = +0                                              03900086
039100        PERFORM 2150-CHECK-IF-MFST-DC                             03910086
039200     ELSE                                                         03920086
039300        SET PS-MANIFEST-DC-NOT-FND TO TRUE                        03930086
039400     END-IF                                                       03940086
039500                                                                  03950086
039600     IF PS-MANIFEST-DC-FOUND                                      03960086
039700        SET PS-NOT-EOF-TRECEIV-CSR TO TRUE                        03970086
039800        PERFORM 1910-OPEN-TRECEIV-CSR                             03980087
039900        PERFORM 1920-FETCH-TRECEIV-CSR                            03990086
040000           UNTIL PS-EOF-TRECEIV-CSR                               04000086
040100        PERFORM 1930-CLOSE-TRECEIV-CSR                            04010086
040200     ELSE                                                         04020086
040300        CONTINUE                                                  04030086
040400     END-IF.                                                      04040086
040500                                                                  04050056
040600***************************************************************** 04060018
040700*CHECK TO SEE IF CARTON WAS CREATED AT MANIFESTING DC             04070002
040800 2150-CHECK-IF-MFST-DC.                                           04080002
040900***************************************************************** 04090040
041000                                                                  04100002
041100     MOVE XLT00010-LOC-NBR TO DK-OPER-UNT-ID                      04110099
041200                                                                  04120089
041300     EXEC SQL                                                     04130002
041400          SELECT FUNC_END_TMST                                    04140002
041500               , FUNC_TXT                                         04150002
041600          INTO  :KRPRPM-FUNC-END-TMST                             04160002
041700               ,:KRPRPM-FUNC-TXT                                  04170002
041800          FROM   TKRPRPM                                          04180002
041900          WHERE  SYS_PRC_FUNC_CDE  = 'DCMFST'                     04190002
042000            AND  LOC_ID            = :DK-OPER-UNT-ID              04200051
042100            AND  INTFC_SYS_CDE     = 'KHL'                        04210002
042200            AND  FUNC_PRC_STAT_CDE = 'AC'                         04220002
042300            AND  FUNC_TXT          = 'Y'                          04230002
042400            WITH UR                                               04240082
042500     END-EXEC.                                                    04250002
042600                                                                  04260002
042700     EVALUATE TRUE                                                04270002
042800         WHEN SQLCODE = ZERO                                      04280002
042900             SET PS-MANIFEST-DC-FOUND  TO TRUE                    04290002
043000         WHEN SQLCODE = +100                                      04300002
043100             SET PS-MANIFEST-DC-NOT-FND TO TRUE                   04310002
043200         WHEN SQLWARN0 NOT = SPACES                               04320002
043300         WHEN SQLCODE < ZERO                                      04330002
043400         WHEN SQLCODE > ZERO                                      04340002
043500             MOVE '2150-CHECK-IF-MFST-DC'                         04350002
043600                 TO PV-PARAGRAPH-NAME                             04360002
043700             MOVE 'SELECT OF TKRPRPM TABLE'                       04370002
043800                 TO PV-DB2-OPERATION-ATTEMPTED                    04380002
043900             PERFORM Z999-SQL-ABEND                               04390002
044000     END-EVALUATE.                                                04400002
044100                                                                  04410040
044200                                                                  04420040
044300***************************************************************** 04430002
044400 2200-LOAD-EXTRACT-RECORD.                                        04440002
044500***************************************************************** 04450002
044600     MOVE '2200-LOAD-EXTRACT-RCD   ' TO PV-ABEND-PARAGRAPH.       04460002
044700                                                                  04470002
044800     MOVE XLT00010-LOC-NBR         TO SU036-OPER-UNT-ID.          04480099
044900     MOVE RECEIV-ORD-NBR           TO SU036-PO-NUMBER.            04490013
045000     MOVE RECEIV-REC-SEQ-NBR       TO SU036-REC-SEQ-NBR.          04500003
045100     MOVE RECITM-ORD-LNE-NBR       TO SU036-LINE-NBR.             04510003
045200     MOVE RECITM-STATUS-CDE        TO SU036-LINE-STATUS.          04520002
045300     MOVE PURCHS-SEASET-SHRT-NM    TO SU036-SEASONAL-NAME.        04530002
045400                                                                  04540063
045500     IF RECITM-STATUS-CDE = 'VE'                                  04550077
045600       MOVE RECITM-VERFYD-TMST                                    04560077
045700            TO SU036-TMST-LINE-VERIFIED                           04570077
045800     ELSE                                                         04580077
045900       MOVE WKORIN-STOP-TMST                                      04590077
046000            TO SU036-TMST-LINE-VERIFIED                           04600077
046100     END-IF.                                                      04610077
046200                                                                  04620075
046300     MOVE DISTHD-FCSE-CNFRMN-TMST  TO SU036-TMST-LINE-CONFIRMED.  04630002
046400     MOVE DISTHD-RSLTS-RCVD-TMST   TO SU036-TMST-LINE-P2L-UPLD.   04640002
046500     MOVE PV-DB2-CURRENT-TIMESTAMP TO SU036-TMST-CREATED.         04650002
046600                                                                  04660002
046700                                                                  04670005
046800***************************************************************** 04680056
046900 2355-SELECT-TWKORIN.                                             04690056
047000***************************************************************** 04700056
047100     EXEC SQL                                                     04710056
047200        SELECT A.STOP_TMST                                        04720099
047300        INTO  :WKORIN-STOP-TMST                                   04730070
047400        FROM   TWKORIN A                                          04740070
047500        WHERE  A.ORD_NBR          = :DK-PO-NBR                    04750070
047600          AND  A.RCVR_SEQ_NBR     = :DK-REC-SEQ-NBR               04760070
047700          AND  A.ORD_LNE_NBR      = 0                             04770070
047800          AND  A.VER_STATUS_CDE   = 'A'                           04780070
047900          AND  A.STOP_TMST IN                                     04790071
048000            (SELECT MAX(C.STOP_TMST)                              04800071
048100              FROM TWKORIN C                                      04810071
048200            WHERE C.ORD_NBR      = :DK-PO-NBR                     04820071
048300              AND C.RCVR_SEQ_NBR = :DK-REC-SEQ-NBR                04830071
048400              AND C.ORD_LNE_NBR  = 0                              04840071
048500              AND C.VER_STATUS_CDE   = 'A'                        04850071
048600              AND STOP_TMST NOT IN ('9999-09-09-09.09.09.000000') 04860074
048700              AND STOP_TMST NOT IN ('9999-09-09-09.09.09.999999'))04870074
048800              WITH UR                                             04880082
048900     END-EXEC.                                                    04890056
049000                                                                  04900056
049100     EVALUATE TRUE                                                04910056
049200         WHEN SQLCODE = +0                                        04920056
049300         WHEN SQLCODE = +100                                      04930056
049400         WHEN SQLCODE = -811                                      04940099
049500              CONTINUE                                            04950077
049600         WHEN SQLWARN0 NOT = SPACE                                04960056
049700         WHEN SQLCODE  NOT = +0                                   04970056
049800              MOVE '2355-SELECT-TWKORIN'                          04980056
049900                                   TO PV-ABEND-PARAGRAPH          04990056
050000              MOVE 'ATTEMPTING TO SELECT TWKORIN'                 05000056
050100                                   TO PV-ABEND-OPERATION          05010056
050200              MOVE DK-PO-NBR           TO PV-DISPLAY-PO-NBR       05020099
050300              STRING 'PO NBR: '         DELIMITED BY SIZE         05030099
050400                  PV-DISPLAY-PO-NBR     DELIMITED BY SIZE         05040099
050500                            INTO PV-ABEND-OPERATION1              05050099
050600              MOVE DK-REC-SEQ-NBR                                 05060099
050700                              TO PV-DISPLAY-RCVR-SEQ-NBR          05070099
050800              STRING 'RECV SEQ: '       DELIMITED BY SIZE         05080099
050900                  PV-DISPLAY-RCVR-SEQ-NBR                         05090099
051000                                        DELIMITED BY SIZE         05100099
051100                            INTO PV-ABEND-OPERATION2              05110099
051200              PERFORM Z999-SQL-ABEND                              05120056
051300     END-EVALUATE.                                                05130056
051400                                                                  05140056
051500***************************************************************** 05150040
051600*GET SEASONAL SHORT NAME                                          05160002
051700 2360-SELECT-TPURCHS.                                             05170002
051800***************************************************************** 05180040
051900     EXEC SQL                                                     05190002
052000          SELECT SEASET_SHRT_NM                                   05200002
052100            INTO  :PURCHS-SEASET-SHRT-NM                          05210002
052200            FROM TPURCHS                                          05220002
052300           WHERE PO_NBR          = :DK-PO-NBR                     05230002
052400             AND VER_STATUS_CDE  = 'A'                            05240002
052500             WITH UR                                              05250082
052600     END-EXEC.                                                    05260002
052700                                                                  05270002
052800     EVALUATE TRUE                                                05280002
052900         WHEN SQLCODE = +0                                        05290002
053000              CONTINUE                                            05300002
053100         WHEN SQLCODE = +100                                      05310002
053200              CONTINUE                                            05320002
053300         WHEN SQLWARN0 NOT = SPACE                                05330002
053400         WHEN SQLCODE  NOT = +0                                   05340002
053500              MOVE '2360-SELECT-TPURCHS'                          05350002
053600                                   TO PV-ABEND-PARAGRAPH          05360002
053700              MOVE 'ATTEMPTING TO SELECT TPURCHS'                 05370002
053800                                   TO PV-ABEND-OPERATION          05380002
053900              MOVE DK-PO-NBR           TO PV-DISPLAY-PO-NBR       05390099
054000              STRING 'PO NBR: '         DELIMITED BY SIZE         05400099
054100                  PV-DISPLAY-PO-NBR     DELIMITED BY SIZE         05410099
054200                            INTO PV-ABEND-OPERATION1              05420099
054300              PERFORM Z999-SQL-ABEND                              05430002
054400     END-EVALUATE.                                                05440002
054500                                                                  05450040
054600***************************************************************** 05460040
054700*GET DATES                                                        05470002
054800 2370-SELECT-TDISTHD.                                             05480002
054900***************************************************************** 05490040
055000     EXEC SQL                                                     05500002
055100          SELECT P2L_CART_CNT                                     05510002
055200               , RSLTS_RCVD_TMST                                  05520002
055300               , FCSE_CNFRMN_TMST                                 05530002
055400            INTO  :DISTHD-P2L-CART-CNT                            05540002
055500               ,  :DISTHD-RSLTS-RCVD-TMST                         05550002
055600               ,  :DISTHD-FCSE-CNFRMN-TMST                        05560002
055700            FROM TDISTHD                                          05570002
055800           WHERE ORD_NBR      = :DK-PO-NBR                        05580002
055900             AND RCVR_SEQ_NBR = :DK-REC-SEQ-NBR                   05590058
056000             AND ORD_LNE_NBR  = :DK-LINE-NBR                      05600058
056100             WITH UR                                              05610082
056200     END-EXEC.                                                    05620002
056300                                                                  05630002
056400     EVALUATE TRUE                                                05640002
056500         WHEN SQLCODE = +0                                        05650002
056600              IF DISTHD-P2L-CART-CNT > 0                          05660002
056700                 CONTINUE                                         05670002
056800              END-IF                                              05680002
056900                                                                  05690002
057000              IF DISTHD-P2L-CART-CNT = 0                          05700002
057100                 MOVE PC-DEFAULT-TMST TO DISTHD-RSLTS-RCVD-TMST   05710002
057200              END-IF                                              05720002
057300         WHEN SQLCODE = +100                                      05730002
057400              CONTINUE                                            05740002
057500         WHEN SQLWARN0 NOT = SPACE                                05750002
057600         WHEN SQLCODE  NOT = +0                                   05760002
057700              MOVE '2370-SELECT-TDISTHD'                          05770002
057800                                   TO PV-ABEND-PARAGRAPH          05780002
057900              MOVE 'ATTEMPTING TO SELECT TDISTHD'                 05790002
058000                                   TO PV-ABEND-OPERATION          05800002
058100              MOVE DK-PO-NBR           TO PV-DISPLAY-PO-NBR       05810099
058200              STRING 'PO NBR: '         DELIMITED BY SIZE         05820099
058300                  PV-DISPLAY-PO-NBR     DELIMITED BY SIZE         05830099
058400                            INTO PV-ABEND-OPERATION1              05840099
058500              MOVE DK-REC-SEQ-NBR                                 05850099
058600                              TO PV-DISPLAY-RCVR-SEQ-NBR          05860099
058700              STRING 'RECV SEQ: '       DELIMITED BY SIZE         05870099
058800                  PV-DISPLAY-RCVR-SEQ-NBR                         05880099
058900                                        DELIMITED BY SIZE         05890099
059000                            INTO PV-ABEND-OPERATION2              05900099
059100              MOVE DK-LINE-NBR         TO PV-DISPLAY-PO-LINE-NBR  05910099
059200              STRING 'PO LINE NBR: '    DELIMITED BY SIZE         05920099
059300                 PV-DISPLAY-PO-LINE-NBR DELIMITED BY SIZE         05930099
059400                            INTO PV-ABEND-OPERATION3              05940099
059500              PERFORM Z999-SQL-ABEND                              05950002
059600     END-EVALUATE.                                                05960002
059700                                                                  05970040
059800                                                                  05980086
059900***************************************************************** 05990086
060000 3510-OPEN-TKRPRPM-CSR.                                           06000086
060100***************************************************************** 06010086
060200     MOVE '3510-OPEN-TKRPRPM-CSR'                                 06020086
060300         TO PV-ABEND-PARAGRAPH.                                   06030086
060400     MOVE 'OPEN THE TKRPRPM_CSR'                                  06040086
060500         TO PV-DB2-OPERATION-ATTEMPTED.                           06050086
060600                                                                  06060086
060700     EXEC SQL                                                     06070086
060800         OPEN TKRPRPM_CSR                                         06080086
060900     END-EXEC.                                                    06090086
061000                                                                  06100086
061100     EVALUATE TRUE                                                06110086
061200         WHEN SQLWARN0 NOT = SPACE                                06120086
061300         WHEN SQLCODE < ZERO                                      06130086
061400         WHEN SQLCODE > ZERO                                      06140086
061500             PERFORM Z999-SQL-ABEND                               06150086
061600         WHEN SQLCODE = ZEROS                                     06160086
061700              CONTINUE                                            06170086
061800     END-EVALUATE.                                                06180086
061900                                                                  06190086
062000***************************************************************** 06200086
062100 3520-FETCH-TKRPRPM-CSR.                                          06210086
062200***************************************************************** 06220086
062300                                                                  06230086
062400     MOVE '3520-FETCH-TKRPRPM'                                    06240086
062500         TO PV-ABEND-PARAGRAPH.                                   06250086
062600     MOVE 'FETCH THE TKRPRPM_CSR'                                 06260086
062700         TO PV-DB2-OPERATION-ATTEMPTED.                           06270086
062800                                                                  06280086
062900     EXEC SQL                                                     06290086
063000          FETCH TKRPRPM_CSR                                       06300086
063100             INTO  :XLT00010-LOC-NBR,                             06310099
063200                   :XLT00010-OPN-DTE,                             06320099
063300                   :XLT00010-CLO-DTE                              06330099
063400     END-EXEC.                                                    06340086
063500                                                                  06350086
063600     EVALUATE TRUE                                                06360086
063700         WHEN SQLCODE = +0                                        06370086
063800              CONTINUE                                            06380086
063900         WHEN SQLCODE = +100                                      06390086
064000              SET PS-EOF-TKRPRPM-CSR TO TRUE                      06400086
064100         WHEN SQLWARN0 NOT = SPACE                                06410086
064200         WHEN SQLCODE < ZERO                                      06420086
064300         WHEN SQLCODE > ZERO                                      06430086
064400             PERFORM Z999-SQL-ABEND                               06440086
064500     END-EVALUATE.                                                06450086
064600                                                                  06460086
064700                                                                  06470086
064800***************************************************************** 06480086
064900 3530-CLOSE-TKRPRPM-CSR.                                          06490086
065000***************************************************************** 06500086
065100                                                                  06510086
065200     MOVE '3530-CLOSE-TKRPRPM-CSR.'                               06520086
065300         TO PV-ABEND-PARAGRAPH.                                   06530086
065400     MOVE 'CLOSE THE TKRPRPM_CSR'                                 06540086
065500         TO PV-DB2-OPERATION-ATTEMPTED.                           06550086
065600                                                                  06560086
065700     EXEC SQL                                                     06570086
065800         CLOSE TKRPRPM_CSR                                        06580086
065900     END-EXEC.                                                    06590086
066000                                                                  06600086
066100     EVALUATE TRUE                                                06610086
066200         WHEN SQLWARN0 NOT = SPACE                                06620086
066300         WHEN SQLCODE < ZERO                                      06630086
066400         WHEN SQLCODE > ZERO                                      06640086
066500             PERFORM Z999-SQL-ABEND                               06650086
066600         WHEN SQLCODE = ZEROS                                     06660086
066700             CONTINUE                                             06670086
066800     END-EVALUATE.                                                06680086
066900                                                                  06690086
067000***************************************************************** 06700019
067100 8000-WRITE-EXTRACT1.                                             06710002
067200***************************************************************** 06720040
067300     WRITE EXTRACT-RECORD1                                        06730002
067400       FROM SU036-RECORD.                                         06740002
067500     INITIALIZE SU036-RECORD.                                     06750096
067600                                                                  06760040
067700                                                                  06770040
067800***************************************************************** 06780090
067900 9000-CLOSE-FILES.                                                06790090
068000     MOVE PV-FETCH-COUNT TO PV-DISPLAY-COUNT.                     06800090
068100     DISPLAY 'TOTAL RECORDS FETCHED '          PV-DISPLAY-COUNT.  06810090
068200                                                                  06820090
068300     MOVE PV-WRITE-COUNT TO PV-DISPLAY-COUNT.                     06830090
068400     DISPLAY 'TOTAL COMPLETED RECS WRITTEN  '  PV-DISPLAY-COUNT.  06840090
068500*FETCH TOTAL SHOULD EQUAL WRITE TOTAL                             06850090
068600                                                                  06860090
068700     CLOSE EXTRACT-FILE1.                                         06870090
068800***************************************************************** 06880002
068900 Z999-SQL-ABEND.                                                  06890002
069000***************************************************************** 06900002
069100     MOVE SQLCODE                     TO SQLCODE2.                06910099
069200     MOVE SQLERRD(3)                  TO SQLERRD3.                06920099
069300                                                                  06930099
069400     DISPLAY '** ABEND **         ** = SQLERROR'.                 06940099
069500     DISPLAY '** PROGRAM   ** = ' PC-PROGRAM-NAME.                06950099
069600     DISPLAY '** PO NUMBER ** = ' PV-DISPLAY-PO-NBR.              06960099
069700     DISPLAY '** RECEIVER  ** = ' PV-DISPLAY-RCVR-SEQ-NBR.        06970099
069800     DISPLAY '** PO LNE NBR** = ' PV-DISPLAY-PO-LINE-NBR.         06980099
069900                                                                  06990099
070000                                                                  07000099
070100     DISPLAY '** PARAGRAPH ** = ' PV-ABEND-PARAGRAPH.             07010099
070200     DISPLAY '** OPERATION ** = ' PV-DB2-FUNCTION.                07020099
070300     DISPLAY '** DB2 TABLE ** = ' PV-DB2-TABLE-NAME.              07030099
070400     DISPLAY '** DB2 TABLE ** = ' PV-DB2-TABLE-NAME1.             07040099
070500     DISPLAY '** SQLCODE          ** = ' SQLCODE2.                07050099
070600     DISPLAY '** ROWS PROCESSED   ** = ' SQLERRD3.                07060099
070700     DISPLAY '** SQLERRM          ** = ' SQLERRM.                 07070099
070800     DISPLAY '** SQLERRMC         ** = ' SQLERRMC.                07080099
070900                                                                  07090002
071000                                                                  07100002
071100     MOVE +4013                  TO PV-ABEND-CODE.                07110002
071200     CALL 'ILBOABN0' USING PV-ABEND-CODE.                         07120002
