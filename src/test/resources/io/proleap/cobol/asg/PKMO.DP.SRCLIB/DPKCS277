000100 IDENTIFICATION DIVISION.                                         00010001
000200 PROGRAM-ID.    DPKCS277.                                         00020001
000300 AUTHOR.        JOE LAROSA.                                       00030001
000400 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00040001
000500 DATE-WRITTEN.  10-01-99.                                         00050001
000600 DATE-COMPILED.                                                   00060001
000610*                                                                 00061012
000620*********************************************************         00062013
000630* *   IF ANY CHANGES ARE MADE TO THIS PROGRAM         * *         00063013
000640* *   BE SURE TO CHECK THE BATCH PROGRAM (TMKUT019)   * *         00064013
000650* *   TO SEE IF THE SAME CHANGE SHOULD BE MADE        * *         00065013
000660*********************************************************         00066013
000670*                                                                 00067013
000700******************************************************************00070001
000800*  Z277 - CENTRAL DC PREPACK 'PACK OTR CALCULATION MODULE'.       00080001
000900*                                                                 00090001
001000* THIS PROGRAM IS A CLONE OF DPKCS276 WITH CHANGES TO MAKE IT     00100001
001100* WORK FOR PREPACK (CONVERTS UNITS INTO PACKS).                   00110001
001200*                                                                 00120001
001300******************************************************************00130001
001310******************************************************************00131014
001320* CHANGE HISTORY                                                 *00132015
001330*    CHANGES                                                     *00133014
001340*     MADE BY: PRITHIVIRAJ SUBRAMANIAN (COGNIZANT)               *00134014
001350*     DATE:    10/15/2014                                        *00135014
001360*                                                                *00136014
001370*      CHANGES THRU OUT THE PROGRAM TO INCREASE THE SIZE OF PO#  *00137014
001380*      FROM 7 DIGITS TO 8 DIGITS. TAGGED WITH *PS 10/15/2014     *00138014
001390******************************************************************00139014
001400 ENVIRONMENT DIVISION.                                            00140001
001500 CONFIGURATION SECTION.                                           00150001
001600                                                                  00160001
001700 SOURCE-COMPUTER.        IBM-3090.                                00170001
001800 OBJECT-COMPUTER.        IBM-3090.                                00180001
001900                                                                  00190001
002000******************************************************************00200001
002100 DATA DIVISION.                                                   00210001
002200 WORKING-STORAGE SECTION.                                         00220001
002300                                                                  00230001
002400 01  COUNTERS-AND-STUFF.                                          00240001
002500     05  PV-APP-LINE-NBR         PIC S9(9) COMP VALUE ZERO.       00250001
002600     05  PV-PURITM-RATO-QTY      PIC S9(4) COMP VALUE ZERO.       00260001
002700     05  PV-RECITM-RATO-QTY      PIC S9(4) COMP VALUE ZERO.       00270001
002800     05  PV-ALLPLN-SPLIT-QTY-PK  PIC S9(4) COMP VALUE ZERO.       00280001
002900     05  PV-RECEIVED-QTY         PIC S9(9) COMP VALUE ZERO.       00290001
003000     05  PV-RECEIVED-DRV-QTY     PIC S9(9) COMP VALUE ZERO.       00300001
003100     05  PV-RECEIVED-QTY-PK      PIC S9(9) COMP VALUE ZERO.       00310001
003200     05  PV-SUM-QTY              PIC S9(9) COMP VALUE ZERO.       00320001
003300*PS 10/15/2014 CHANGE STARTS                                      00330014
003310     05  PV-DISP-PO-NBR          PIC 9(8).                        00331014
003320*PS 10/15/2014 CHANGE ENDS                                        00332014
003400     05  PV-DISP-REC-SEQ-NBR     PIC 9(4).                        00340001
003500     05  PV-DISP-PO-LNE-NBR      PIC 9(3).                        00350001
003600     05  PV-DISP-OPER-UNT-ID     PIC 9(4).                        00360001
003700     05  PV-DISP-FCLTY-ID        PIC 9(4).                        00370001
003800     05  PV-DISP-STR-NBR         PIC 9(4).                        00380001
003900     05  PV-RETURN-MSG           PIC X(40).                       00390001
004000     05  PV-SQLCODE              PIC S9(9) COMP-4.                00400001
004100     05  PV-DISPLAY-SQLCODE      PIC -Z(8)9.                      00410001
004200     05  PV-DISPLAY-QTY          PIC Z(4)9.                       00420001
004300                                                                  00430001
004400 01  PROGRAM-SWITCHES.                                            00440001
004500     05  PS-ERRORS-SW                 PIC  X    VALUE 'N'.        00450001
004600         88  PS-ERRORS-NO                       VALUE 'N'.        00460001
004700         88  PS-ERRORS-YES                      VALUE 'Y'.        00470001
004800     05  PS-EOF-PLAN-CSR-SW           PIC  X    VALUE 'N'.        00480001
004900         88  PS-EOF-PLAN-CSR                    VALUE 'Y'.        00490001
005000     05  PS-EOF-BASE-CSR-SW           PIC  X    VALUE 'N'.        00500001
005100         88  PS-EOF-BASE-CSR                    VALUE 'Y'.        00510001
005200     05  PS-PRIOR-CURSOR-SW           PIC  X    VALUE 'N'.        00520001
005300         88  PS-PRIOR-CURSOR-START              VALUE 'N'.        00530001
005400         88  PS-PRIOR-CURSOR-EOF                VALUE 'Y'.        00540001
005500     05  PS-CURSOR-SW                 PIC  X    VALUE 'N'.        00550001
005600         88  PS-CURSOR-CLOSED                   VALUE 'N'.        00560001
005700         88  PS-CURSOR-OPEN                     VALUE 'Y'.        00570001
005800     05  PS-LINE-DISTRO-SW            PIC  X    VALUE 'Y'.        00580001
005900         88  PS-LINE-HAS-DISTRO-YES             VALUE 'Y'.        00590001
006000         88  PS-LINE-HAS-DISTRO-NO              VALUE 'N'.        00600001
006100     05  PS-PACK-DISTRO-SW            PIC  X    VALUE 'N'.        00610001
006200         88  PS-PACK-DISTRO-INVALID             VALUE 'Y'.        00620001
006300         88  PS-PACK-DISTRO-VALID               VALUE 'N'.        00630001
006400     05  PS-HAVE-DRV-QTY-SW           PIC  X    VALUE 'N'.        00640001
006500         88  PS-HAVE-DRV-QTY-YES                VALUE 'Y'.        00650001
006600         88  PS-HAVE-DRV-QTY-NO                 VALUE 'N'.        00660001
006610     05  PS-DRIVER-LINE-SW            PIC  X    VALUE 'N'.        00661013
006620         88  PS-NO-DRIVER-LINE                  VALUE 'N'.        00662001
006630         88  PS-DRIVER-LINE                     VALUE 'Y'.        00663001
006700                                                                  00670001
006800 01  PROGRAM-KEYS.                                                00680001
006900     05  DK-PO-NBR               PIC S9(9) COMP VALUE ZERO.       00690001
007000     05  DK-LINE-NBR             PIC S9(9) COMP VALUE ZERO.       00700001
007100     05  DK-DRIVER-LINE-NBR      PIC S9(9) COMP VALUE ZERO.       00710001
007200     05  DK-PO-PREPK-ID          PIC S9(4) COMP VALUE ZERO.       00720001
007300     05  DK-STAT-CDE-AP          PIC  X(02)  VALUE 'AP'.          00730001
007400     05  DK-STAT-CDE-AC          PIC  X(02)  VALUE 'AC'.          00740001
007500     05  DK-STAT-CDE-CM          PIC  X(02)  VALUE 'CM'.          00750001
007510     05  DK-STAT-CDE-RV          PIC  X(02)  VALUE 'RV'.          00751006
007600                                                                  00760001
007700 01  PROGRAM-LITERALS.                                            00770001
007800     05  PC-CURRENT-PROGRAM-NAME PIC X(8)  VALUE 'DPKCS277'.      00780001
007900     05  PC-A                    PIC X     VALUE 'A'.             00790001
008000     05  PC-Y                    PIC X     VALUE 'Y'.             00800001
008100     05  PC-AC                   PIC X(2)  VALUE 'AC'.            00810001
008200     05  PC-IP                   PIC X(2)  VALUE 'IP'.            00820001
008300     05  PC-CM                   PIC X(2)  VALUE 'CM'.            00830001
008400     05  PC-VE                   PIC X(2)  VALUE 'VE'.            00840001
008500     05  PC-SHORT-ONE            PIC S9(4) COMP VALUE +1.         00850001
008600     05  PC-MAX-OCCUR-LNE        PIC S9(3) VALUE +100             00860001
008700                                                COMP-3.           00870001
008800     05  PC-MAX-OCCUR-STR        PIC S9(3) VALUE +250             00880001
008900                                                COMP-3.           00890001
009000     05  PC-NULL-TMST            PIC X(26) VALUE                  00900001
009100                       '0001-01-01-00.00.00.000000'.              00910001
009200     05  PC-TSYMSG-00551         PIC  9(05)  VALUE 00551.         00920001
009300     05  PC-TSYMSG-01096         PIC  9(05)  VALUE 01096.         00930001
009400                                                                  00940001
009500/*****************************************************************00950001
009600     COPY DPWS277.                                                00960001
009700/                                                                 00970001
009800     COPY DPWS013.                                                00980001
009900/                                                                 00990001
010000     COPY DPWS020.                                                01000001
010100                                                                  01010001
010200/*****************************************************************01020001
010300*    DB2 SQL COMMUNICATION AREA                                   01030001
010400******************************************************************01040001
010500     EXEC SQL                                                     01050001
010600          INCLUDE SQLCA                                           01060001
010700     END-EXEC.                                                    01070001
010800                                                                  01080001
010900******************************************************************01090001
011000*    DB2 DCLGEN FOR MERCHANDISE STORE ALLOCATION PLAN TABLE       01100001
011100******************************************************************01110001
011200     EXEC SQL                                                     01120001
011300          INCLUDE TALLPLN                                         01130001
011400     END-EXEC.                                                    01140001
011500                                                                  01150001
011600******************************************************************01160001
011700*    DB2 DCLGEN FOR MERCHANDISE STORE DISTRIBUTION PLAN TABLE     01170001
011800******************************************************************01180001
011900     EXEC SQL                                                     01190001
012000          INCLUDE TMESTDS                                         01200001
012100     END-EXEC.                                                    01210001
012200                                                                  01220001
012300******************************************************************01230001
012400*    DB2 DCLGEN FOR SPECIFIC PLAN                                 01240001
012500******************************************************************01250001
012600     EXEC SQL                                                     01260001
012700          INCLUDE TSPSTDS                                         01270001
012800     END-EXEC.                                                    01280001
012900                                                                  01290001
013000******************************************************************01300001
013100*    DB2 DCLGEN FOR PO PURCHASE ITEM TABLE (PO LINE ITEMS)        01310001
013200******************************************************************01320001
013300     EXEC SQL                                                     01330001
013400          INCLUDE TPURITM                                         01340001
013500     END-EXEC.                                                    01350001
013600                                                                  01360001
013700******************************************************************01370001
013800*    DB2 DCLGEN FOR RECEIVER TABLE                                01380001
013900******************************************************************01390001
014000     EXEC SQL                                                     01400001
014100          INCLUDE TRECEIV                                         01410001
014200     END-EXEC.                                                    01420001
014300                                                                  01430001
014400******************************************************************01440001
014500*    DB2 DCLGEN FOR RECEIVER ITEM                                 01450001
014600******************************************************************01460001
014700     EXEC SQL                                                     01470001
014800          INCLUDE TRECITM                                         01480001
014900     END-EXEC.                                                    01490001
015000                                                                  01500001
015100******************************************************************01510001
015200*    DB2 DCLGEN FOR RECEIVE DISTRIBUTION TABLE                    01520001
015300******************************************************************01530001
015400     EXEC SQL                                                     01540001
015500          INCLUDE TRECDIS                                         01550001
015600     END-EXEC.                                                    01560001
015700                                                                  01570001
015800******************************************************************01580001
015900*                   BASE NUMBER CURSORS                           01590001
016000*                 ************************                        01600001
016100*    THESE CURSORS ARE USED TO POPULATE                           01610001
016200*    DP277-STORE-NBR OR DP277-LNE-NBR                             01620001
016300*    AND DP277-STR-DISTRO-QTY FOR EACH STORE OR LINE.             01630001
016400*    SUBTRACTING ALL RECEIPTS FROM THIS WILL GIVE THE OTR.        01640001
016500******************************************************************01650001
016600                                                                  01660001
016700** THIS CURSOR IS THE BASIS FOR MASTER PLAN (STORE-LEVEL-OTR)     01670001
016800     EXEC SQL                                                     01680001
016900         DECLARE STORE-TABLE-CSR CURSOR FOR                       01690001
017000          SELECT STR_NBR                                          01700001
017100               , STR_DISTRO_QTY                                   01710001
017200               , ALLOC_SEQ_CDE                                    01720001
017300               , RNK_SEQ_NBR                                      01730001
017400               , STR_CNSTR_CDE                                    01740001
017500               , STR_CNSTR_QTY                                    01750001
017600            FROM TMESTDS                                          01760001
017700           WHERE PO_NBR     = :DP277-PO-NBR                       01770001
017800             AND PO_LNE_NBR = :PURITM-PO-LNE-NBR                  01780001
017900             AND PLAN_NBR   = :ALLPLN-PLAN-NBR                    01790001
017910           ORDER BY STR_NBR                                       01791001
017920     END-EXEC.                                                    01792001
017930                                                                  01793001
017940** THIS CURSOR IS THE BASIS FOR SPECIFIC PLAN (STORE-LEVEL-OTR)   01794001
017950     EXEC SQL                                                     01795001
017960         DECLARE SPSTDS-CSR CURSOR FOR                            01796001
017970          SELECT STR_NBR                                          01797001
017980               , STR_DISTRO_QTY                                   01798001
017990            FROM TSPSTDS                                          01799001
018000           WHERE PO_NBR     = :DP277-PO-NBR                       01800001
018100             AND PO_LNE_NBR = :PURITM-PO-LNE-NBR                  01810001
018200             AND PLAN_NBR   = :ALLPLN-PLAN-NBR                    01820001
018300           ORDER BY STR_NBR                                       01830001
018400     END-EXEC.                                                    01840001
018500                                                                  01850001
018600** THIS CURSOR IS THE BASIS FOR DP277-LINE-TABLE (LINE-LEVEL-OTR) 01860001
018700     EXEC SQL                                                     01870001
018800         DECLARE PLAN-CSR CURSOR FOR                              01880001
018900          SELECT A.PO_LNE_NBR                                     01890001
019000               , A.APP_PO_LNE_NBR                                 01900001
019100               , A.PREPK_RATO_QTY                                 01910001
019200            FROM TPURITM A                                        01920001
019300                ,TRECITM B                                        01930001
019400           WHERE  A.PO_NBR          = :DP277-PO-NBR               01940001
019500             AND  B.ORD_NBR         = A.PO_NBR                    01950001
019600             AND  B.ORD_LNE_NBR     = A.APP_PO_LNE_NBR            01960001
019700             AND  OPER_UNT_ID       = :DP277-OPER-UNT-ID          01970001
019800             AND  REC_SEQ_NBR       = :DP277-REC-SEQ-NBR          01980001
019900             AND  B.PREPK_ID        = :DK-PO-PREPK-ID             01990001
020100             AND  A.VER_STATUS_CDE  = :PC-A                       02010001
020200             AND  B.VER_STATUS_CDE  = :PC-A                       02020001
020300             AND  (A.STATUS_CDE     = :DK-STAT-CDE-AP             02030001
020400              OR   A.STATUS_CDE     = :DK-STAT-CDE-CM             02040001
020410              OR   A.STATUS_CDE     = :DK-STAT-CDE-RV             02041006
020500              OR   A.STATUS_CDE     = :DK-STAT-CDE-AC)            02050001
020600     END-EXEC.                                                    02060001
020610** THIS CURSOR IS THE BASIS FOR DP277-LINE-TABLE (LINE-LEVEL-OTR) 02061001
020620     EXEC SQL                                                     02062001
020630         DECLARE PLAN-LINE-CSR CURSOR FOR                         02063001
020640          SELECT A.PO_LNE_NBR                                     02064001
020650               , A.APP_PO_LNE_NBR                                 02065001
020660               , A.PREPK_RATO_QTY                                 02066001
020670            FROM TPURITM A                                        02067001
020690           WHERE  A.PO_NBR          = :DP277-PO-NBR               02069001
020691             AND  A.APP_PO_LNE_NBR  = :DP277-PO-LNE-NBR           02069101
020696             AND  A.VER_STATUS_CDE  = :PC-A                       02069601
020698             AND  (A.STATUS_CDE     = :DK-STAT-CDE-AP             02069801
020699              OR   A.STATUS_CDE     = :DK-STAT-CDE-CM             02069901
020700              OR   A.STATUS_CDE     = :DK-STAT-CDE-RV             02070006
020701              OR   A.STATUS_CDE     = :DK-STAT-CDE-AC)            02070101
020702     END-EXEC.                                                    02070201
020710                                                                  02071001
020800******************************************************************02080001
020900*                     RECEIPT CURSORS                             02090001
021000*                 ************************                        02100001
021100*    THESE CURSORS ARE USED TO RETRIEVE THE PRIOR RECEIPTS        02110001
021200*    TO BE SUBTRACTED FROM DP277-STORE-OTR-QTY.                   02120001
021300*                                                                 02130001
021400*    'RECEIVER-LEVEL' PRIOR RECEIPTS ARE DEFINED AS ANY 'VE'      02140001
021500*    RECEIPT OR 'IP'/'CM' RECEIPT CREATED PRIOR TO THE GIVEN      02150001
021600*    RECEIVER.                                                    02160001
021700*                                                                 02170001
021800*    'PO-LEVEL' PRIOR RECEIPTS INCLUDE ALL RECEIPTS INCLUDING     02180001
021900*    THE GIVEN RECEIVER.                                          02190001
022000*                                                                 02200001
022100******************************************************************02210001
022200                                                                  02220001
022300******************************************************************02230001
022400*    RECEIVER-LEVEL CURSOR                                        02240001
022500*    THIS IS A LIST OF RECEIVERS FOR A PO, LINE, AND DC THAT      02250001
022600*    ARE EITHER VERIFIED OR HAD BEEN CREATED PRIOR TO THE         02260001
022700*    CURRENT DATE AND TIME.  USED IN PARAGRAPH 1300-              02270001
022800******************************************************************02280001
022900     EXEC SQL                                                     02290001
023000         DECLARE REC-LVL-CSR CURSOR FOR                           02300001
023100          SELECT REC_SEQ_NBR                                      02310001
023200               , STATUS_CDE                                       02320001
023300            FROM TRECITM                                          02330001
023400           WHERE ORD_NBR         = :DP277-PO-NBR                  02340001
023500             AND ORD_LNE_NBR     = :DK-LINE-NBR                   02350001
023600             AND OPER_UNT_ID     = :DP277-OPER-UNT-ID             02360001
023700             AND REC_SEQ_NBR    ^= :DP277-REC-SEQ-NBR             02370001
023800             AND VER_STATUS_CDE  = :PC-A                          02380001
023900             AND (CRE_TMST       < :RECITM-CRE-TMST               02390001
024000              OR  CRE_TMST       = :RECITM-CRE-TMST               02400001
024100              OR  STATUS_CDE     = :PC-VE)                        02410001
024200           ORDER BY 1                                             02420001
024300     END-EXEC.                                                    02430001
024400                                                                  02440001
024500******************************************************************02450001
024600*    PO-LEVEL CURSOR                                              02460001
024700*    THIS IS A LIST OF RECEIVERS AND THEIR STATUSES FOR A         02470001
024800*    PO, LINE AND DC REGARDLESS OF CREATION TIME.                 02480001
024900******************************************************************02490001
025000     EXEC SQL                                                     02500001
025100         DECLARE PO-LVL-CSR CURSOR FOR                            02510001
025200          SELECT REC_SEQ_NBR                                      02520001
025300               , STATUS_CDE                                       02530001
025400            FROM TRECITM                                          02540001
025500           WHERE ORD_NBR         = :DP277-PO-NBR                  02550001
025600             AND ORD_LNE_NBR     = :DK-LINE-NBR                   02560001
025700             AND OPER_UNT_ID     = :DP277-OPER-UNT-ID             02570001
025800             AND VER_STATUS_CDE  = :PC-A                          02580001
025900             AND STATUS_CDE     IN (:PC-IP, :PC-CM, :PC-VE)       02590001
026000           ORDER BY 1                                             02600001
026100     END-EXEC.                                                    02610001
026200                                                                  02620001
026300/*****************************************************************02630001
026400 LINKAGE SECTION.                                                 02640001
026500                                                                  02650001
026600 01  DFHCOMMAREA.                                                 02660001
026700     05  FILLER                       OCCURS 1 TO 15000 TIMES     02670001
026800                                      DEPENDING ON EIBCALEN.      02680001
026900         10  FILLER                   PIC X.                      02690001
027000                                                                  02700001
027100/*****************************************************************02710001
027200******************************************************************02720001
027300 PROCEDURE DIVISION.                                              02730001
027400                                                                  02740001
027500     PERFORM 0001-HOUSEKEEPING.                                   02750001
027600                                                                  02760001
027700     EVALUATE TRUE                                                02770001
027800       WHEN DP277-STORE-LEVEL-OTR                                 02780001
027900           PERFORM 1000-STORE-LEVEL-OTR                           02790001
028000                                                                  02800001
028100       WHEN DP277-LINE-LEVEL-OTR                                  02810001
028200           PERFORM 2000-LINE-LEVEL-OTR                            02820001
028300                                                                  02830001
028400       WHEN OTHER                                                 02840001
028500           STRING ' INVALID OTR TYPE (' DP277-OTR-TYPE ')'        02850001
028600                  DELIMITED BY SIZE INTO PV-RETURN-MSG            02860001
028700           MOVE 1 TO DP277-RETURN-CODE                            02870001
028800           PERFORM DP013-0000-PROCESS-ABEND                       02880001
028900     END-EVALUATE.                                                02890001
029000                                                                  02900001
029100     PERFORM VARYING DP277-STR-IDX FROM 1 BY 1                    02910001
029200       UNTIL DP277-STORE-NBR(DP277-STR-IDX) = ZERO                02920001
029300        OR DP277-STR-IDX > PC-MAX-OCCUR-STR                       02930001
029400         MOVE DP277-STR-OTR-QTY(DP277-STR-IDX)                    02940001
029500              TO DP277-STR-DISTRO-OTR(DP277-STR-IDX)              02950001
029600         IF DP277-STR-OTR-QTY(DP277-STR-IDX) < ZERO               02960001
029700             MOVE ZERO TO DP277-STR-OTR-QTY(DP277-STR-IDX)        02970001
029800         END-IF                                                   02980001
029900     END-PERFORM.                                                 02990001
030000                                                                  03000001
030100     PERFORM VARYING DP277-LNE-IDX FROM 1 BY 1                    03010001
030200       UNTIL DP277-LNE-NBR(DP277-LNE-IDX) = ZERO                  03020001
030300        OR DP277-LNE-IDX > PC-MAX-OCCUR-LNE                       03030001
030400         MOVE DP277-LNE-OTR-QTY(DP277-LNE-IDX)                    03040001
030500                   TO DP277-LNE-DISTRO-OTR(DP277-LNE-IDX)         03050001
030600         IF DP277-LNE-OTR-QTY(DP277-LNE-IDX) < ZERO               03060001
030700             MOVE ZERO TO DP277-LNE-OTR-QTY(DP277-LNE-IDX)        03070001
030800         END-IF                                                   03080001
030900     END-PERFORM.                                                 03090001
031000                                                                  03100001
031100     MOVE DP277-COMMAREA TO DFHCOMMAREA.                          03110001
031200                                                                  03120001
031300     GOBACK.                                                      03130001
031400                                                                  03140001
031500                                                                  03150001
031600******************************************************************03160001
031700******************************************************************03170001
031800 0001-HOUSEKEEPING.                                               03180001
031900                                                                  03190001
032000     MOVE DFHCOMMAREA TO DP277-COMMAREA.                          03200001
032100                                                                  03210001
032200     INITIALIZE DP277-LINE-TABLE                                  03220001
032300                DP277-STORE-TABLE                                 03230001
032400                DP277-RETURN-DATA.                                03240001
032500                                                                  03250001
032600******************************************************************03260001
032700******************************************************************03270001
032800 1000-STORE-LEVEL-OTR.                                            03280001
032900                                                                  03290001
033000     MOVE DP277-PO-NBR      TO DK-PO-NBR.                         03300001
033100     MOVE DP277-PO-LNE-NBR  TO DK-LINE-NBR.                       03310001
033200     MOVE DP277-PO-PREPK-ID TO DK-PO-PREPK-ID.                    03320001
033300                                                                  03330001
033400*GET PURITM LINE NUMBER.                                          03340001
033500     PERFORM 1120-GET-TPURITM-RECORD.                             03350001
033600                                                                  03360001
033700     MOVE PURITM-PO-LNE-NBR TO DK-LINE-NBR.                       03370001
033800                                                                  03380001
033900*GET APPROVED LINE NUMBER.                                        03390001
034000     PERFORM 1100-GET-APP-LINE-NBR.                               03400001
034100                                                                  03410001
034200*GET PLAN.                                                        03420001
034300     IF PS-ERRORS-NO                                              03430001
034400         PERFORM 1110-GET-TALLPLN                                 03440001
034401     ELSE                                                         03440104
034410         INITIALIZE DCLTALLPLN                                    03441004
034420                    PV-ALLPLN-SPLIT-QTY-PK                        03442005
034500     END-IF.                                                      03450001
034600                                                                  03460001
034700     MOVE ALLPLN-CURR-SPLIT-QTY       TO DP277-CURR-SPLIT-QTY     03470001
034800     MOVE PV-ALLPLN-SPLIT-QTY-PK      TO DP277-CURR-SPLIT-PK      03480001
034810*DP277-DISTRO-REQ-ID COMES FROM CHECKS OF TMESTDS.RNK_SEQ_NBR.    03481009
034811*IF ANY RNK_SEQ_NBR IN THE 1200-FILL-BASE-NUMBERS PROCESSING      03481109
034812*EQUALS ZERO, IT WILL OVERLAY THE DEFAULT OF 1.                   03481209
034820*RMS OBSOLETES TALLPLN.DISTRO_REQ_ID                              03482007
034900*    MOVE ALLPLN-DISTRO-REQ-ID        TO DP277-DISTRO-REQ-ID      03490007
034910     MOVE +1                          TO DP277-DISTRO-REQ-ID      03491008
035000     MOVE ALLPLN-ALLOC-OUTR-PK-QTY    TO DP277-ALLOC-OUTR-PK-QTY  03500001
035100     MOVE ALLPLN-PK-SIZE-RND-CDE      TO DP277-PK-SIZE-RND-CDE    03510001
035200                                                                  03520001
035300*MOVE ORIGINAL LINE NUMBER BACK INTO KEY.                         03530001
035400     MOVE DP277-PO-LNE-NBR  TO DK-LINE-NBR.                       03540001
035500*LOAD STORE TABLE.                                                03550001
035600     IF PS-ERRORS-NO                                              03560001
035700         PERFORM 1200-FILL-BASE-NUMBERS                           03570001
035800     END-IF.                                                      03580001
035900                                                                  03590001
036000*DETERMINE OTR.                                                   03600001
036100     IF PS-ERRORS-NO AND DP277-MASTER-PLAN                        03610001
036200       AND PS-LINE-HAS-DISTRO-YES                                 03620001
036300                                                                  03630001
036400         EVALUATE TRUE                                            03640001
036500           WHEN DP277-RECEIVER-OTR                                03650001
036600               PERFORM 1300-RCVR-OTR                              03660001
036700                                                                  03670001
036800           WHEN DP277-PO-OTR                                      03680001
036900               PERFORM 1400-PO-OTR                                03690001
037000                                                                  03700001
037100           WHEN OTHER                                             03710001
037200               STRING ' INVALID OTR SCOPE FLAG ('                 03720001
037300                      DP277-OTR-SCOPE ')' DELIMITED BY SIZE       03730001
037400                      INTO PV-RETURN-MSG                          03740001
037500               MOVE 2 TO DP277-RETURN-CODE                        03750001
037600               PERFORM DP013-0000-PROCESS-ABEND                   03760001
037700                                                                  03770001
037800         END-EVALUATE                                             03780001
037900     END-IF.                                                      03790001
038000                                                                  03800001
038100******************************************************************03810001
038200*  THE APP LINE NUMBER MAY NOT BE THE SAME AS THE KEY LINE        03820001
038300*  NUMBER DUE TO PO LINES BEING DELETED.  THE RECEIVING SYSTEM    03830001
038400*  IS KEYED BY THE APPROVED LINE NUMBER.  THE PO SYSTEM IS KEYED  03840001
038500*  BY THE LINE NUMBER IN THE KEY.                                 03850001
038600******************************************************************03860001
038700 1100-GET-APP-LINE-NBR.                                           03870001
038800                                                                  03880001
038900     EXEC SQL                                                     03890001
039000         SELECT A.APP_PO_LNE_NBR                                  03900001
039100              , A.PREPK_RATO_QTY                                  03910001
039200           INTO :PV-APP-LINE-NBR                                  03920001
039300              , :PV-PURITM-RATO-QTY                               03930001
039400           FROM TPURITM A                                         03940001
039500          WHERE A.PO_NBR         = :DK-PO-NBR                     03950001
039600            AND A.PO_LNE_NBR     = :DK-LINE-NBR                   03960001
039700            AND A.PO_PREPK_ID    = :DK-PO-PREPK-ID                03970001
039800            AND A.VER_STATUS_CDE = :PC-A                          03980001
039900     END-EXEC.                                                    03990001
040000                                                                  04000001
040100     EVALUATE TRUE                                                04010001
040200       WHEN SQLCODE = ZERO                                        04020001
040300           CONTINUE                                               04030001
040400                                                                  04040001
040500       WHEN SQLCODE = -904                                        04050001
040600       WHEN SQLCODE = -911                                        04060001
040700       WHEN SQLCODE = -913                                        04070001
040800           MOVE 3  TO DP277-RETURN-CODE                           04080001
040900           PERFORM 9900-SOFT-ABORT                                04090001
041000                                                                  04100001
041100       WHEN OTHER                                                 04110001
041200           MOVE 4  TO DP277-RETURN-CODE                           04120001
041300           PERFORM 9800-PGM-ABEND                                 04130001
041400     END-EVALUATE.                                                04140001
041500                                                                  04150001
041600******************************************************************04160001
041700******************************************************************04170001
041800 1110-GET-TALLPLN.                                                04180001
041900                                                                  04190001
042000     INITIALIZE DCLTALLPLN                                        04200001
042100     EXEC SQL                                                     04210001
042200         SELECT PLAN_NBR                                          04220001
042300              , CURR_SPLIT_QTY                                    04230001
042400              , DISTRO_REQ_ID                                     04240001
042500              , ALLOC_OUTR_PK_QTY                                 04250001
042600              , PK_SIZE_RND_CDE                                   04260001
042700           INTO :ALLPLN-PLAN-NBR                                  04270001
042800              , :ALLPLN-CURR-SPLIT-QTY                            04280001
042900              , :ALLPLN-DISTRO-REQ-ID                             04290001
043000              , :ALLPLN-ALLOC-OUTR-PK-QTY                         04300001
043100              , :ALLPLN-PK-SIZE-RND-CDE                           04310001
043200           FROM TALLPLN                                           04320001
043300          WHERE PO_NBR     = :DK-PO-NBR                           04330001
043400            AND PO_LNE_NBR = :DK-LINE-NBR                         04340001
043500            AND DEST_NBR   = :DP277-OPER-UNT-ID                   04350001
043600     END-EXEC.                                                    04360001
043700                                                                  04370001
043800     EVALUATE TRUE                                                04380001
043900       WHEN SQLCODE = ZERO                                        04390001
044000           SET PS-LINE-HAS-DISTRO-YES TO TRUE                     04400001
044100*CALCULATE PACKS FROM UNITS.                                      04410001
044200           IF PV-PURITM-RATO-QTY > +0                             04420001
044300               SET  PS-PACK-DISTRO-VALID TO TRUE                  04430001
044400               DIVIDE ALLPLN-CURR-SPLIT-QTY                       04440001
044500                   BY PV-PURITM-RATO-QTY                          04450001
044600               GIVING PV-ALLPLN-SPLIT-QTY-PK                      04460001
044700           ELSE                                                   04470001
044800               MOVE 0 TO PV-ALLPLN-SPLIT-QTY-PK                   04480001
044900               SET  PS-PACK-DISTRO-INVALID TO TRUE                04490001
045000           END-IF                                                 04500001
045100                                                                  04510001
045200       WHEN SQLCODE = +100                                        04520001
045300           SET PS-LINE-HAS-DISTRO-NO TO TRUE                      04530001
045400           MOVE 5 TO DP277-RETURN-CODE                            04540001
045500           PERFORM 9000-NO-DISTRO-ERROR                           04550001
045600                                                                  04560001
045700       WHEN SQLCODE = -904                                        04570001
045800       WHEN SQLCODE = -911                                        04580001
045900       WHEN SQLCODE = -913                                        04590001
046000           MOVE 6 TO DP277-RETURN-CODE                            04600001
046100           PERFORM 9900-SOFT-ABORT                                04610001
046200                                                                  04620001
046300       WHEN OTHER                                                 04630001
046400           MOVE 7 TO DP277-RETURN-CODE                            04640001
046500           PERFORM 9800-PGM-ABEND                                 04650001
046600     END-EVALUATE.                                                04660001
046700                                                                  04670001
046701 1120-GET-TPURITM-RECORD.                                         04670101
046702******************************************************************04670201
046703*    THIS PARAGRAPH RETRIEVES A RECORD FROM TABLE TPURITM.        04670301
046704******************************************************************04670401
046705                                                                  04670501
046706         EXEC SQL                                                 04670601
046707              SELECT PO_LNE_NBR                                   04670701
046708                INTO :PURITM-PO-LNE-NBR                           04670801
046709                FROM TPURITM                                      04670901
046710               WHERE PO_NBR         = :DK-PO-NBR                  04671001
046711                 AND APP_PO_LNE_NBR = :DK-LINE-NBR                04671101
046712                 AND VER_STATUS_CDE = :PC-A                       04671201
046713         END-EXEC                                                 04671301
046714                                                                  04671401
046715         EVALUATE TRUE                                            04671501
046716             WHEN SQLCODE = +0                                    04671601
046717                  CONTINUE                                        04671701
046718                                                                  04671801
046719             WHEN SQLCODE = -904                                  04671901
046720             WHEN SQLCODE = -911                                  04672001
046721             WHEN SQLCODE = -913                                  04672101
046722                 MOVE 6 TO DP277-RETURN-CODE                      04672201
046723                 PERFORM 9900-SOFT-ABORT                          04672301
046724                                                                  04672401
046725             WHEN OTHER                                           04672501
046726                 MOVE 7 TO DP277-RETURN-CODE                      04672601
046727                 PERFORM 9800-PGM-ABEND                           04672701
046728         END-EVALUATE.                                            04672801
046729                                                                  04672901
046730******************************************************************04673001
046740******************************************************************04674001
046750 1200-FILL-BASE-NUMBERS.                                          04675001
046760                                                                  04676001
046770     PERFORM 1210-OPEN-STORE-TABLE-CSR.                           04677001
046780                                                                  04678001
046790*GET FIRST STORE TABLE ENTRY.                                     04679001
046800     IF PS-ERRORS-NO                                              04680001
046900       AND PS-LINE-HAS-DISTRO-YES                                 04690001
047000         PERFORM 1220-FETCH-STORE-TABLE-CSR                       04700001
047100         IF PS-EOF-BASE-CSR                                       04710001
047200             SET PS-ERRORS-YES                                    04720001
047300                 PS-LINE-HAS-DISTRO-NO TO TRUE                    04730001
047310             MOVE 0 TO DP277-DISTRO-REQ-ID                        04731010
047400             MOVE 8 TO DP277-RETURN-CODE                          04740001
047500             PERFORM 9000-NO-DISTRO-ERROR                         04750001
047600         END-IF                                                   04760001
047700     END-IF.                                                      04770001
047800                                                                  04780001
047900*LOOP THRU ALL MESTDS & LOAD TO TABLE.                            04790001
048000     IF PS-ERRORS-NO                                              04800001
048100       AND PS-LINE-HAS-DISTRO-YES                                 04810001
048200         PERFORM 1230-LOAD-TO-STR-TABLE                           04820001
048300           VARYING DP277-STR-IDX FROM 1 BY 1                      04830001
048400             UNTIL PS-EOF-BASE-CSR OR PS-ERRORS-YES               04840001
048500                OR DP277-STR-IDX > PC-MAX-OCCUR-STR               04850001
048600     END-IF.                                                      04860001
048700                                                                  04870001
048800     IF PS-CURSOR-OPEN                                            04880001
048900         PERFORM 1240-CLOSE-STORE-TABLE-CSR                       04890001
049000     END-IF.                                                      04900001
049100                                                                  04910001
049200******************************************************************04920001
049300******************************************************************04930001
049400 1210-OPEN-STORE-TABLE-CSR.                                       04940001
049500                                                                  04950001
049600     EVALUATE TRUE                                                04960001
049700       WHEN DP277-SPECIFIC-PLAN                                   04970001
049800         EXEC SQL                                                 04980001
049900             OPEN SPSTDS-CSR                                      04990001
050000         END-EXEC                                                 05000001
050100                                                                  05010001
050200       WHEN DP277-MASTER-PLAN                                     05020001
050300         EXEC SQL                                                 05030001
050400             OPEN STORE-TABLE-CSR                                 05040001
050500         END-EXEC                                                 05050001
050600                                                                  05060001
050700       WHEN OTHER                                                 05070001
050800           MOVE 9  TO DP277-RETURN-CODE                           05080001
050900           PERFORM 9000-NO-DISTRO-ERROR                           05090001
051000     END-EVALUATE.                                                05100001
051100                                                                  05110001
051200     EVALUATE TRUE                                                05120001
051300       WHEN SQLCODE = ZERO                                        05130001
051400           SET PS-CURSOR-OPEN TO TRUE                             05140001
051500                                                                  05150001
051600       WHEN SQLCODE = -904                                        05160001
051700       WHEN SQLCODE = -911                                        05170001
051800       WHEN SQLCODE = -913                                        05180001
051900           SET PS-CURSOR-CLOSED TO TRUE                           05190001
052000           MOVE 10 TO DP277-RETURN-CODE                           05200001
052100           PERFORM 9900-SOFT-ABORT                                05210001
052200                                                                  05220001
052300       WHEN OTHER                                                 05230001
052400           SET PS-CURSOR-CLOSED TO TRUE                           05240001
052500           SET PS-LINE-HAS-DISTRO-NO TO TRUE                      05250001
052600           MOVE 11 TO DP277-RETURN-CODE                           05260001
052700           PERFORM 9000-NO-DISTRO-ERROR                           05270001
052800                                                                  05280001
052900     END-EVALUATE.                                                05290001
053000                                                                  05300001
053100******************************************************************05310001
053200******************************************************************05320001
053300 1220-FETCH-STORE-TABLE-CSR.                                      05330001
053400                                                                  05340001
053500     EVALUATE TRUE                                                05350001
053600       WHEN DP277-SPECIFIC-PLAN                                   05360001
053700         EXEC SQL                                                 05370001
053800             FETCH SPSTDS-CSR                                     05380001
053900              INTO :MESTDS-STR-NBR                                05390001
054000                 , :MESTDS-STR-DISTRO-QTY                         05400001
054100         END-EXEC                                                 05410001
054200                                                                  05420001
054300       WHEN DP277-MASTER-PLAN                                     05430001
054400         EXEC SQL                                                 05440001
054500             FETCH STORE-TABLE-CSR                                05450001
054600              INTO :MESTDS-STR-NBR                                05460001
054700                 , :MESTDS-STR-DISTRO-QTY                         05470001
054800                 , :MESTDS-ALLOC-SEQ-CDE                          05480001
054900                 , :MESTDS-RNK-SEQ-NBR                            05490001
055000                 , :MESTDS-STR-CNSTR-CDE                          05500001
055100                 , :MESTDS-STR-CNSTR-QTY                          05510001
055200         END-EXEC                                                 05520001
055300                                                                  05530001
055400       WHEN OTHER                                                 05540001
055500           MOVE 12 TO DP277-RETURN-CODE                           05550001
055600           PERFORM 9000-NO-DISTRO-ERROR                           05560001
055700     END-EVALUATE.                                                05570001
055800                                                                  05580001
055900     EVALUATE TRUE                                                05590001
056000       WHEN SQLCODE = ZERO                                        05600001
056010           IF MESTDS-RNK-SEQ-NBR = ZERO                           05601009
056020               MOVE MESTDS-RNK-SEQ-NBR TO DP277-DISTRO-REQ-ID     05602009
056030           END-IF                                                 05603009
056100*          CONTINUE                                               05610009
056200                                                                  05620001
056300       WHEN SQLCODE = +100                                        05630001
056400           SET PS-EOF-BASE-CSR TO TRUE                            05640001
056500                                                                  05650001
056600       WHEN OTHER                                                 05660001
056700           MOVE 13 TO DP277-RETURN-CODE                           05670001
056800           PERFORM 9000-NO-DISTRO-ERROR                           05680001
056810           MOVE ZERO TO DP277-DISTRO-REQ-ID                       05681011
056900                                                                  05690001
057000     END-EVALUATE.                                                05700001
057100                                                                  05710001
057200******************************************************************05720001
057300******************************************************************05730001
057400 1230-LOAD-TO-STR-TABLE.                                          05740001
057500                                                                  05750001
057600     MOVE MESTDS-STR-NBR TO DP277-STORE-NBR(DP277-STR-IDX).       05760001
057700     MOVE MESTDS-ALLOC-SEQ-CDE                                    05770001
057800                         TO DP277-ALLOC-SEQ-CDE(DP277-STR-IDX).   05780001
057900     MOVE MESTDS-RNK-SEQ-NBR                                      05790001
058000                         TO DP277-RNK-SEQ-NBR(DP277-STR-IDX).     05800001
058100     MOVE MESTDS-STR-CNSTR-CDE                                    05810001
058200                         TO DP277-STR-CNSTR-CDE(DP277-STR-IDX).   05820001
058300     MOVE MESTDS-STR-CNSTR-QTY                                    05830001
058400                         TO DP277-STR-CNSTR-QTY(DP277-STR-IDX).   05840001
058500                                                                  05850001
058600     MOVE MESTDS-STR-DISTRO-QTY                                   05860001
058700                         TO DP277-STR-DISTRO-QTY(DP277-STR-IDX)   05870001
058800                            DP277-STR-OTR-QTY (DP277-STR-IDX)     05880001
058900                            PV-DISPLAY-QTY.                       05890001
059000     MOVE PV-DISPLAY-QTY TO DP277-STR-DISTRO-QTY-X(DP277-STR-IDX) 05900001
059100                            DP277-STR-OTR-QTY-X(DP277-STR-IDX).   05910001
059200                                                                  05920001
059300*CALCULATE PACKS FROM UNITS.                                      05930001
059400     IF PV-PURITM-RATO-QTY > +0                                   05940001
059500         DIVIDE MESTDS-STR-DISTRO-QTY                             05950001
059600             BY PV-PURITM-RATO-QTY                                05960001
059700         GIVING DP277-STR-DISTRO-PK(DP277-STR-IDX)                05970001
059800         MOVE DP277-STR-DISTRO-PK(DP277-STR-IDX)                  05980001
059900              TO DP277-STR-OTR-PK(DP277-STR-IDX)                  05990001
060000     END-IF.                                                      06000001
060100                                                                  06010001
060200     PERFORM 1220-FETCH-STORE-TABLE-CSR.                          06020001
060300                                                                  06030001
060400******************************************************************06040001
060500******************************************************************06050001
060600 1240-CLOSE-STORE-TABLE-CSR.                                      06060001
060700                                                                  06070001
060800     EVALUATE TRUE                                                06080001
060900       WHEN DP277-SPECIFIC-PLAN                                   06090001
061000         EXEC SQL                                                 06100001
061100             CLOSE SPSTDS-CSR                                     06110001
061200         END-EXEC                                                 06120001
061300                                                                  06130001
061400       WHEN DP277-MASTER-PLAN                                     06140001
061500         EXEC SQL                                                 06150001
061600             CLOSE STORE-TABLE-CSR                                06160001
061700         END-EXEC                                                 06170001
061800                                                                  06180001
061900       WHEN OTHER                                                 06190001
062000           MOVE 14 TO DP277-RETURN-CODE                           06200001
062100           PERFORM 9000-NO-DISTRO-ERROR                           06210001
062200     END-EVALUATE.                                                06220001
062300                                                                  06230001
062400     EVALUATE TRUE                                                06240001
062500       WHEN SQLCODE = ZERO                                        06250001
062600           SET PS-CURSOR-CLOSED TO TRUE                           06260001
062700                                                                  06270001
062800       WHEN OTHER                                                 06280001
062900           MOVE 15 TO DP277-RETURN-CODE                           06290001
063000           PERFORM 9000-NO-DISTRO-ERROR                           06300001
063100     END-EVALUATE.                                                06310001
063200                                                                  06320001
063300******************************************************************06330001
063400* RECEIVER OTR AT THE STORE LEVEL                                 06340001
063500******************************************************************06350001
063600 1300-RCVR-OTR.                                                   06360001
063700                                                                  06370001
063800     MOVE PV-APP-LINE-NBR TO DK-LINE-NBR                          06380001
063900     PERFORM 7000-GET-RECITM-TMST.                                06390001
064000                                                                  06400001
064100     IF PS-ERRORS-NO                                              06410001
064200         PERFORM 7100-OPEN-RECITM-CURSOR                          06420001
064300     END-IF.                                                      06430001
064400                                                                  06440001
064500     IF PS-ERRORS-NO                                              06450001
064600         PERFORM 7110-FETCH-RECITM-CURSOR                         06460001
064700     END-IF.                                                      06470001
064800                                                                  06480001
064900     IF PS-PRIOR-CURSOR-EOF                                       06490001
065000         SET PS-ERRORS-YES TO TRUE                                06500001
065100     END-IF.                                                      06510001
065200                                                                  06520001
065300     IF PS-ERRORS-NO                                              06530001
065400         PERFORM 4000-PROCESS-RECITM-CURSOR                       06540001
065500           UNTIL PS-PRIOR-CURSOR-EOF                              06550001
065600              OR PS-ERRORS-YES                                    06560001
065700     END-IF.                                                      06570001
065800                                                                  06580001
065900     IF PS-CURSOR-OPEN                                            06590001
066000         PERFORM 7120-CLOSE-RECITM-CURSOR                         06600001
066100     END-IF.                                                      06610001
066200                                                                  06620001
066300******************************************************************06630001
066400* PO OTR AT THE STORE LEVEL                                       06640001
066500******************************************************************06650001
066600 1400-PO-OTR.                                                     06660001
066700                                                                  06670001
066800     IF PS-ERRORS-NO                                              06680001
066900         MOVE PV-APP-LINE-NBR TO DK-LINE-NBR                      06690001
067000         PERFORM 7200-OPEN-RECITM-CURSOR                          06700001
067100     END-IF.                                                      06710001
067200                                                                  06720001
067300     IF PS-ERRORS-NO                                              06730001
067400         PERFORM 7210-FETCH-RECITM-CURSOR                         06740001
067500     END-IF.                                                      06750001
067600                                                                  06760001
067700     IF PS-ERRORS-NO                                              06770001
067800         PERFORM 4000-PROCESS-RECITM-CURSOR                       06780001
067900           UNTIL PS-PRIOR-CURSOR-EOF                              06790001
068000              OR PS-ERRORS-YES                                    06800001
068100     END-IF.                                                      06810001
068200                                                                  06820001
068300     IF PS-CURSOR-OPEN                                            06830001
068400         PERFORM 7220-CLOSE-RECITM-CURSOR                         06840001
068500     END-IF.                                                      06850001
068600                                                                  06860001
068700******************************************************************06870001
068800******************************************************************06880001
068900 2000-LINE-LEVEL-OTR.                                             06890001
069000                                                                  06900001
069100     MOVE DP277-PO-PREPK-ID TO DK-PO-PREPK-ID.                    06910001
069200     IF PS-ERRORS-NO                                              06920001
069300         PERFORM 2100-FILL-BASE-NUMBERS                           06930001
069400     END-IF.                                                      06940001
069500                                                                  06950001
069600     IF PS-ERRORS-NO                                              06960001
069700         EVALUATE TRUE                                            06970001
069800           WHEN DP277-RECEIVER-OTR                                06980001
069900               PERFORM 2200-PROCESS-RCVR-OTR-RCPTS                06990001
070000                 VARYING DP277-LNE-IDX FROM 1 BY 1                07000001
070100                   UNTIL DP277-LNE-NBR(DP277-LNE-IDX) = ZERO      07010001
070200                      OR DP277-FATAL-ERROR                        07020001
070300                                                                  07030001
070400           WHEN DP277-PO-OTR                                      07040001
070500               PERFORM 2300-PROCESS-PO-OTR-RCPTS                  07050001
070600                 VARYING DP277-LNE-IDX FROM 1 BY 1                07060001
070700                   UNTIL DP277-LNE-NBR(DP277-LNE-IDX) = ZERO      07070001
070800                      OR DP277-FATAL-ERROR                        07080001
070900                                                                  07090001
071000           WHEN OTHER                                             07100001
071100               MOVE 'INVALID OTR SCOPE FLAG' TO PV-RETURN-MSG     07110001
071200               MOVE 16 TO DP277-RETURN-CODE                       07120001
071300         END-EVALUATE                                             07130001
071400     END-IF.                                                      07140001
071500                                                                  07150001
071600******************************************************************07160001
071700******************************************************************07170001
071800 2100-FILL-BASE-NUMBERS.                                          07180001
071900                                                                  07190001
072000     PERFORM 2110-OPEN-PLAN-CURSOR.                               07200001
072100                                                                  07210001
072200     IF PS-ERRORS-NO                                              07220001
072300         PERFORM 2120-FETCH-PLAN-CURSOR                           07230001
072400     END-IF.                                                      07240001
072500                                                                  07250001
072600     IF PS-EOF-PLAN-CSR                                           07260001
072700         SET PS-ERRORS-YES TO TRUE                                07270001
072800     END-IF.                                                      07280001
072900                                                                  07290001
073000     IF PS-ERRORS-NO                                              07300001
073100         PERFORM 2130-LOAD-PLANS                                  07310001
073200           VARYING DP277-LNE-IDX FROM 1 BY 1                      07320001
073300             UNTIL PS-EOF-PLAN-CSR                                07330001
073400                OR DP277-SOFT-ABORT                               07340001
073500                OR DP277-LNE-IDX > PC-MAX-OCCUR-LNE               07350001
073600     END-IF.                                                      07360001
073700                                                                  07370001
073800     IF PS-CURSOR-OPEN                                            07380001
073900         PERFORM 2140-CLOSE-PLAN-CURSOR                           07390001
074000     END-IF.                                                      07400001
074100                                                                  07410001
074200******************************************************************07420001
074300******************************************************************07430001
074400 2110-OPEN-PLAN-CURSOR.                                           07440001
074500                                                                  07450001
074510     EVALUATE TRUE                                                07451001
074520       WHEN DP277-PO-PREPK-ID = 0                                 07452001
074600        EXEC SQL                                                  07460001
074700           OPEN PLAN-LINE-CSR                                     07470001
074800        END-EXEC                                                  07480001
074810       WHEN OTHER                                                 07481001
074820        EXEC SQL                                                  07482001
074830           OPEN PLAN-CSR                                          07483001
074840        END-EXEC                                                  07484001
074850     END-EVALUATE.                                                07485001
074900                                                                  07490001
075000     EVALUATE TRUE                                                07500001
075100       WHEN SQLCODE = ZERO                                        07510001
075200           SET PS-CURSOR-OPEN TO TRUE                             07520001
075300                                                                  07530001
075400       WHEN SQLCODE = -904                                        07540001
075500       WHEN SQLCODE = -911                                        07550001
075600       WHEN SQLCODE = -913                                        07560001
075700           SET PS-CURSOR-CLOSED TO TRUE                           07570001
075800           MOVE 17 TO DP277-RETURN-CODE                           07580001
075900           PERFORM 9900-SOFT-ABORT                                07590001
076000                                                                  07600001
076100       WHEN OTHER                                                 07610001
076200           SET PS-CURSOR-CLOSED TO TRUE                           07620001
076300           MOVE 18 TO DP277-RETURN-CODE                           07630001
076400           PERFORM 9800-PGM-ABEND                                 07640001
076500     END-EVALUATE.                                                07650001
076600                                                                  07660001
076700******************************************************************07670001
076800******************************************************************07680001
076900 2120-FETCH-PLAN-CURSOR.                                          07690001
077000                                                                  07700001
077010     EVALUATE TRUE                                                07701001
077011       WHEN DP277-PO-PREPK-ID = 0                                 07701101
077030        EXEC SQL                                                  07703001
077040           FETCH PLAN-LINE-CSR                                    07704001
077050            INTO :PURITM-PO-LNE-NBR                               07705001
077051               , :PURITM-APP-PO-LNE-NBR                           07705101
077052               , :PURITM-PREPK-RATO-QTY                           07705201
077053        END-EXEC                                                  07705301
077060       WHEN OTHER                                                 07706001
077070        EXEC SQL                                                  07707001
077080           FETCH PLAN-CSR                                         07708001
077090            INTO :PURITM-PO-LNE-NBR                               07709001
077091               , :PURITM-APP-PO-LNE-NBR                           07709101
077092               , :PURITM-PREPK-RATO-QTY                           07709201
077093        END-EXEC                                                  07709301
077094     END-EVALUATE.                                                07709401
077700                                                                  07770001
077800     EVALUATE TRUE                                                07780001
077900       WHEN SQLCODE = ZERO                                        07790001
078000           CONTINUE                                               07800001
078100                                                                  07810001
078200       WHEN SQLCODE = +100                                        07820001
078300           SET PS-EOF-PLAN-CSR TO TRUE                            07830001
078400                                                                  07840001
078500       WHEN OTHER                                                 07850001
078600           MOVE 19 TO DP277-RETURN-CODE                           07860001
078700           PERFORM 9800-PGM-ABEND                                 07870001
078800     END-EVALUATE.                                                07880001
078900                                                                  07890001
079000******************************************************************07900001
079100******************************************************************07910001
079200 2130-LOAD-PLANS.                                                 07920001
079300                                                                  07930001
079400     MOVE DP277-PO-NBR          TO DK-PO-NBR.                     07940001
079500     MOVE PURITM-PO-LNE-NBR     TO DK-LINE-NBR.                   07950001
079600     MOVE PURITM-PREPK-RATO-QTY TO PV-PURITM-RATO-QTY.            07960001
079700     MOVE PURITM-APP-PO-LNE-NBR TO DP277-LNE-NBR(DP277-LNE-IDX).  07970001
079800                                                                  07980001
079900     PERFORM 1110-GET-TALLPLN.                                    07990001
080000                                                                  08000001
080100     IF SQLCODE = ZERO                                            08010001
080200         PERFORM 2150-SUM-ALL-STORES                              08020001
080300                                                                  08030001
080400         EVALUATE TRUE                                            08040001
080500           WHEN SQLCODE = ZERO OR +100 OR -305                    08050001
080600               MOVE MESTDS-STR-DISTRO-QTY                         08060001
080700                       TO DP277-LNE-DISTRO-QTY(DP277-LNE-IDX)     08070001
080800                          DP277-LNE-OTR-QTY(DP277-LNE-IDX)        08080001
080900                          PV-DISPLAY-QTY                          08090001
081000               MOVE PV-DISPLAY-QTY                                08100001
081100                       TO DP277-LNE-DISTRO-QTY-X(DP277-LNE-IDX)   08110001
081200                          DP277-LNE-OTR-QTY-X(DP277-LNE-IDX)      08120001
081300*CALCULATE PACKS FROM UNITS.                                      08130001
081400               IF PV-PURITM-RATO-QTY > +0                         08140001
081500                   DIVIDE MESTDS-STR-DISTRO-QTY                   08150001
081600                       BY PV-PURITM-RATO-QTY                      08160001
081700                   GIVING DP277-LNE-DISTRO-PK(DP277-LNE-IDX)      08170001
081800                   MOVE DP277-LNE-DISTRO-PK(DP277-LNE-IDX)        08180001
081900                        TO DP277-LNE-OTR-PK(DP277-LNE-IDX)        08190001
082000               END-IF                                             08200001
082100                                                                  08210001
082200           WHEN PS-LINE-HAS-DISTRO-NO                             08220001
082300               MOVE ALL '*'                                       08230001
082400                        TO DP277-LNE-OTR-QTY-X(DP277-LNE-IDX)     08240001
082500               MOVE ZEROES                                        08250001
082600                        TO PV-DISPLAY-QTY                         08260001
082700                           DP277-LNE-OTR-QTY(DP277-LNE-IDX)       08270001
082800                           DP277-LNE-OTR-PK(DP277-LNE-IDX)        08280001
082900                           DP277-LNE-DISTRO-QTY(DP277-LNE-IDX)    08290001
083000                           DP277-LNE-DISTRO-PK(DP277-LNE-IDX)     08300001
083100               MOVE PV-DISPLAY-QTY                                08310001
083200                        TO DP277-LNE-DISTRO-QTY-X(DP277-LNE-IDX)  08320001
083300                                                                  08330001
083400           WHEN OTHER                                             08340001
083500               MOVE ZEROES                                        08350001
083600                        TO DP277-LNE-DISTRO-QTY(DP277-LNE-IDX)    08360001
083700                           DP277-LNE-DISTRO-PK(DP277-LNE-IDX)     08370001
083800                           DP277-LNE-OTR-QTY(DP277-LNE-IDX)       08380001
083900                           DP277-LNE-OTR-PK(DP277-LNE-IDX)        08390001
084000               MOVE SPACES                                        08400001
084100                        TO DP277-LNE-OTR-QTY-X(DP277-LNE-IDX)     08410001
084200                           DP277-LNE-DISTRO-QTY-X(DP277-LNE-IDX)  08420001
084300         END-EVALUATE                                             08430001
084400     END-IF.                                                      08440001
084500                                                                  08450001
084600     IF PS-ERRORS-NO                                              08460001
084700       AND NOT DP277-SOFT-ABORT                                   08470001
084800         PERFORM 2120-FETCH-PLAN-CURSOR                           08480001
084900     END-IF.                                                      08490001
085000                                                                  08500001
085100******************************************************************08510001
085200******************************************************************08520001
085300 2140-CLOSE-PLAN-CURSOR.                                          08530001
085400                                                                  08540001
085410     EVALUATE TRUE                                                08541001
085411       WHEN DP277-PO-PREPK-ID = 0                                 08541101
085430        EXEC SQL                                                  08543001
085440           CLOSE PLAN-LINE-CSR                                    08544001
085450        END-EXEC                                                  08545001
085460       WHEN OTHER                                                 08546001
085470        EXEC SQL                                                  08547001
085480           CLOSE PLAN-CSR                                         08548001
085490        END-EXEC                                                  08549001
085491     END-EVALUATE.                                                08549101
085800                                                                  08580001
085900     EVALUATE TRUE                                                08590001
086000       WHEN SQLCODE = ZERO                                        08600001
086100           SET PS-CURSOR-CLOSED TO TRUE                           08610001
086200                                                                  08620001
086300       WHEN OTHER                                                 08630001
086400           MOVE 20 TO DP277-RETURN-CODE                           08640001
086500           PERFORM 9800-PGM-ABEND                                 08650001
086600     END-EVALUATE.                                                08660001
086700                                                                  08670001
086800******************************************************************08680001
086900******************************************************************08690001
087000 2150-SUM-ALL-STORES.                                             08700001
087100                                                                  08710001
087200     MOVE ZEROES TO MESTDS-STR-DISTRO-QTY.                        08720001
087300                                                                  08730001
087400     IF DP277-STR-NBR = ZERO                                      08740001
087500         EXEC SQL                                                 08750001
087600             SELECT SUM(A.STR_DISTRO_QTY)                         08760001
087700               INTO :MESTDS-STR-DISTRO-QTY                        08770001
087800               FROM TMESTDS A                                     08780001
087900              WHERE A.PO_NBR     = :DK-PO-NBR                     08790001
088000                AND A.PO_LNE_NBR = :DK-LINE-NBR                   08800001
088100                AND A.PLAN_NBR   = :ALLPLN-PLAN-NBR               08810001
088200         END-EXEC                                                 08820001
088300     ELSE                                                         08830001
088400         EXEC SQL                                                 08840001
088500             SELECT A.STR_DISTRO_QTY                              08850001
088600               INTO :MESTDS-STR-DISTRO-QTY                        08860001
088700               FROM TMESTDS A                                     08870001
088800              WHERE A.PO_NBR     = :DK-PO-NBR                     08880001
088900                AND A.PO_LNE_NBR = :DK-LINE-NBR                   08890001
089000                AND A.PLAN_NBR   = :ALLPLN-PLAN-NBR               08900001
089100                AND A.STR_NBR    = :DP277-STR-NBR                 08910001
089200         END-EXEC                                                 08920001
089300     END-IF.                                                      08930001
089400                                                                  08940001
089500     EVALUATE TRUE                                                08950001
089600       WHEN SQLCODE = ZERO                                        08960001
089700           IF DP277-STR-NBR = ZERO                                08970001
089800               IF MESTDS-STR-DISTRO-QTY                           08980001
089900                 NOT = ALLPLN-CURR-SPLIT-QTY                      08990001
090000                   MOVE ALLPLN-CURR-SPLIT-QTY                     09000001
090100                     TO MESTDS-STR-DISTRO-QTY                     09010001
090200               END-IF                                             09020001
090300           END-IF                                                 09030001
090400                                                                  09040001
090500       WHEN SQLCODE = +100 OR -305                                09050001
090600           IF DP277-STR-NBR = ZERO                                09060001
090700               MOVE ALLPLN-CURR-SPLIT-QTY                         09070001
090800                 TO MESTDS-STR-DISTRO-QTY                         09080001
090900           ELSE                                                   09090001
091000               MOVE 21 TO DP277-RETURN-CODE                       09100001
091100               SET PS-LINE-HAS-DISTRO-NO TO TRUE                  09110001
091200               PERFORM 9000-NO-DISTRO-ERROR                       09120001
091300           END-IF                                                 09130001
091400                                                                  09140001
091500       WHEN SQLCODE = -904                                        09150001
091600       WHEN SQLCODE = -911                                        09160001
091700       WHEN SQLCODE = -913                                        09170001
091800           MOVE 22 TO DP277-RETURN-CODE                           09180001
091900           PERFORM 9900-SOFT-ABORT                                09190001
092000                                                                  09200001
092100       WHEN OTHER                                                 09210001
092200           MOVE 23 TO DP277-RETURN-CODE                           09220001
092300           SET PS-LINE-HAS-DISTRO-NO TO TRUE                      09230001
092400           PERFORM 9000-NO-DISTRO-ERROR                           09240001
092500     END-EVALUATE.                                                09250001
092600                                                                  09260001
092700******************************************************************09270001
092800* RECEIVER OTR AT THE LINE LEVEL                                  09280001
092900******************************************************************09290001
093000 2200-PROCESS-RCVR-OTR-RCPTS.                                     09300001
093100                                                                  09310001
093200*ALL '*' INDICATES A 'NO DISTRO' ERROR FOR THE LINE               09320001
093300     IF DP277-LNE-OTR-QTY-X(DP277-LNE-IDX) = ALL '*'              09330001
093400         SET PS-ERRORS-YES TO TRUE                                09340001
093500     ELSE                                                         09350001
093600         SET PS-ERRORS-NO                                         09360001
093700             PS-PRIOR-CURSOR-START TO TRUE                        09370001
093800         MOVE DP277-LNE-NBR(DP277-LNE-IDX) TO DK-LINE-NBR         09380001
093900         PERFORM 7000-GET-RECITM-TMST                             09390001
094000     END-IF                                                       09400001
094100                                                                  09410001
094200     IF PS-ERRORS-NO AND NOT DP277-FATAL-ERROR                    09420001
094300         PERFORM 7100-OPEN-RECITM-CURSOR                          09430001
094400     END-IF.                                                      09440001
094500                                                                  09450001
094600     IF PS-ERRORS-NO AND NOT DP277-FATAL-ERROR                    09460001
094700         PERFORM 7110-FETCH-RECITM-CURSOR                         09470001
094800     END-IF.                                                      09480001
094900                                                                  09490001
095000     IF PS-PRIOR-CURSOR-EOF                                       09500001
095100         SET PS-ERRORS-YES TO TRUE                                09510001
095200     END-IF.                                                      09520001
095300                                                                  09530001
095400     IF PS-ERRORS-NO                                              09540001
095500         SET PS-HAVE-DRV-QTY-NO TO TRUE                           09550001
095600         PERFORM 6000-PROCESS-RECITM-CURSOR                       09560001
095700           UNTIL PS-PRIOR-CURSOR-EOF                              09570001
095800              OR PS-ERRORS-YES                                    09580001
095900              OR DP277-FATAL-ERROR                                09590001
096000     END-IF.                                                      09600001
096100                                                                  09610001
096200     IF PS-CURSOR-OPEN                                            09620001
096300         PERFORM 7120-CLOSE-RECITM-CURSOR                         09630001
096400     END-IF.                                                      09640001
096500                                                                  09650001
096600******************************************************************09660001
096700* PO OTR AT THE LINE LEVEL                                        09670001
096800******************************************************************09680001
096900 2300-PROCESS-PO-OTR-RCPTS.                                       09690001
097000                                                                  09700001
097100*ALL '*' INDICATES A 'NO DISTRO' ERROR FOR THE LINE               09710001
097200     IF DP277-LNE-OTR-QTY-X(DP277-LNE-IDX) = ALL '*'              09720001
097300         SET PS-ERRORS-YES TO TRUE                                09730001
097400     ELSE                                                         09740001
097500         SET PS-ERRORS-NO TO TRUE                                 09750001
097600         MOVE DP277-LNE-NBR(DP277-LNE-IDX) TO DK-LINE-NBR         09760001
097700         PERFORM 7200-OPEN-RECITM-CURSOR                          09770001
097800     END-IF.                                                      09780001
097900                                                                  09790001
098000     IF PS-ERRORS-NO                                              09800001
098100         SET PS-PRIOR-CURSOR-START TO TRUE                        09810001
098200         PERFORM 7210-FETCH-RECITM-CURSOR                         09820001
098300     END-IF.                                                      09830001
098400                                                                  09840001
098500     IF PS-ERRORS-NO                                              09850001
098600         SET PS-HAVE-DRV-QTY-NO TO TRUE                           09860001
098700         PERFORM 6000-PROCESS-RECITM-CURSOR                       09870001
098800            UNTIL PS-PRIOR-CURSOR-EOF                             09880001
098900               OR PS-ERRORS-YES                                   09890001
099000               OR DP277-FATAL-ERROR                               09900001
099100     END-IF.                                                      09910001
099200                                                                  09920001
099300     IF PS-CURSOR-OPEN                                            09930001
099400         PERFORM 7220-CLOSE-RECITM-CURSOR                         09940001
099500     END-IF.                                                      09950001
099600                                                                  09960001
099700******************************************************************09970001
099800******************************************************************09980001
099900 4000-PROCESS-RECITM-CURSOR.                                      09990001
100000                                                                  10000001
100100     PERFORM 4100-APPLY-PRIOR-RECEIPTS                            10010001
100200       VARYING DP277-STR-IDX FROM 1 BY 1                          10020001
100300         UNTIL DP277-STORE-NBR(DP277-STR-IDX) = ZERO              10030001
100400            OR DP277-STR-IDX > PC-MAX-OCCUR-STR.                  10040001
100500                                                                  10050001
100600     IF PS-ERRORS-NO                                              10060001
100700         IF DP277-RECEIVER-OTR                                    10070001
100800             PERFORM 7110-FETCH-RECITM-CURSOR                     10080001
100900         ELSE                                                     10090001
101000             PERFORM 7210-FETCH-RECITM-CURSOR                     10100001
101100         END-IF                                                   10110001
101200     END-IF.                                                      10120001
101300                                                                  10130001
101400******************************************************************10140001
101500*    THIS PARAGRAPH RETRIEVES THE RECDIS RECORD FOR A GIVEN STORE.10150001
101600*    IT THEN ADDS INTO THE STORE ARRAY THE CORRECT STORE RECEIPTS 10160001
101700*    DEPENDING UPON THE STATUS CODE OF THE RECITM.                10170001
101800******************************************************************10180001
101900 4100-APPLY-PRIOR-RECEIPTS.                                       10190001
102000                                                                  10200001
102100     PERFORM 4110-APPLY-PRIOR-RECEIPTS.                           10210001
102200                                                                  10220001
102300*APPLY DRIVER LINE RECEIPTS (IF LINE CHANGED).                    10230001
102400     IF DK-LINE-NBR = DK-DRIVER-LINE-NBR                          10240001
102410       OR PS-NO-DRIVER-LINE                                       10241001
102500         MOVE PV-RECEIVED-QTY TO PV-RECEIVED-DRV-QTY              10250001
102600     ELSE                                                         10260001
102700         IF DK-DRIVER-LINE-NBR NOT = 0                            10270001
102800             PERFORM 4120-DETERMINE-DRVLNE-RECEIPTS               10280001
102900         END-IF                                                   10290001
103000     END-IF.                                                      10300001
103100                                                                  10310001
103200*CALCULATE PACK QUANTITY.                                         10320001
103210*NOTE:                                                            10321001
103220*ON A NON DRIVER LINE RECEIVER RATIO QUANTITY IS DEFAULTED TO     10322001
103230*THE PURITM RATIO                                                 10323001
103300     IF PV-RECITM-RATO-QTY > +0                                   10330001
103400       AND (DK-DRIVER-LINE-NBR NOT = 0                            10340001
103410        OR PS-NO-DRIVER-LINE)                                     10341001
103500         DIVIDE PV-RECEIVED-DRV-QTY                               10350001
103600           BY PV-RECITM-RATO-QTY                                  10360001
103700           GIVING PV-RECEIVED-QTY-PK                              10370001
103800         SUBTRACT PV-RECEIVED-QTY-PK                              10380001
103900             FROM DP277-STR-OTR-PK(DP277-STR-IDX)                 10390001
104000     ELSE                                                         10400001
104100         MOVE ZEROS TO PV-RECEIVED-QTY-PK                         10410001
104200     END-IF.                                                      10420001
104300                                                                  10430001
104400******************************************************************10440001
104500******************************************************************10450001
104600 4110-APPLY-PRIOR-RECEIPTS.                                       10460001
104700                                                                  10470001
104800     MOVE DP277-STORE-NBR(DP277-STR-IDX) TO RECDIS-STR-NBR.       10480001
104900                                                                  10490001
105000     IF RECITM-STATUS-CDE = PC-VE                                 10500001
105100         EXEC SQL                                                 10510001
105200             SELECT AP_VERIFY_ITM_QTY                             10520001
105300               INTO :PV-RECEIVED-QTY                              10530001
105400               FROM TRECDIS                                       10540001
105500              WHERE ORD_NBR        = :DP277-PO-NBR                10550001
105600                AND ORD_LNE_NBR    = :DK-LINE-NBR                 10560001
105700                AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR          10570001
105800                AND OPER_UNT_ID    = :DP277-OPER-UNT-ID           10580001
106000                AND STR_NBR        = :RECDIS-STR-NBR              10600001
106100                AND STR_FCLTY_ID   = :PC-SHORT-ONE                10610001
106110                AND FCLTY_ID       = :DP277-FCLTY-ID              10611013
106200         END-EXEC                                                 10620001
106300     ELSE                                                         10630001
106400         EXEC SQL                                                 10640001
106500             SELECT EXPTED_ITM_QTY                                10650001
106600               INTO :PV-RECEIVED-QTY                              10660001
106700               FROM TRECDIS                                       10670001
106800              WHERE ORD_NBR        = :DP277-PO-NBR                10680001
106900                AND ORD_LNE_NBR    = :DK-LINE-NBR                 10690001
107000                AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR          10700001
107100                AND OPER_UNT_ID    = :DP277-OPER-UNT-ID           10710001
107300                AND STR_NBR        = :RECDIS-STR-NBR              10730001
107400                AND STR_FCLTY_ID   = :PC-SHORT-ONE                10740001
107410                AND FCLTY_ID       = :DP277-FCLTY-ID              10741013
107500         END-EXEC                                                 10750001
107600     END-IF                                                       10760001
107700                                                                  10770001
107800     EVALUATE TRUE                                                10780001
107900       WHEN SQLCODE = ZERO                                        10790001
108000           SUBTRACT PV-RECEIVED-QTY                               10800001
108100               FROM DP277-STR-OTR-QTY(DP277-STR-IDX)              10810001
108200           IF DP277-STR-OTR-QTY(DP277-STR-IDX) > ZERO             10820001
108300               MOVE DP277-STR-OTR-QTY(DP277-STR-IDX)              10830001
108400                    TO PV-DISPLAY-QTY                             10840001
108500           ELSE                                                   10850001
108600               MOVE ZERO TO PV-DISPLAY-QTY                        10860001
108700           END-IF                                                 10870001
108800           MOVE PV-DISPLAY-QTY                                    10880001
108900                TO DP277-STR-OTR-QTY-X(DP277-STR-IDX)             10890001
109000                                                                  10900001
109100       WHEN SQLCODE = +100                                        10910001
109200           MOVE ZEROES TO PV-RECEIVED-QTY                         10920001
109300                                                                  10930001
109400       WHEN SQLCODE = -904                                        10940001
109500       WHEN SQLCODE = -911                                        10950001
109600       WHEN SQLCODE = -913                                        10960001
109700           MOVE 24 TO DP277-RETURN-CODE                           10970001
109800           PERFORM 9900-SOFT-ABORT                                10980001
109900                                                                  10990001
110000       WHEN OTHER                                                 11000001
110100           MOVE 25 TO DP277-RETURN-CODE                           11010001
110200           PERFORM 9800-PGM-ABEND                                 11020001
110300     END-EVALUATE.                                                11030001
110400                                                                  11040001
110500******************************************************************11050001
110600******************************************************************11060001
110700 4120-DETERMINE-DRVLNE-RECEIPTS.                                  11070001
110800                                                                  11080001
110900     MOVE DP277-STORE-NBR(DP277-STR-IDX) TO RECDIS-STR-NBR.       11090001
111000                                                                  11100001
111100     IF RECITM-STATUS-CDE = PC-VE                                 11110001
111200         EXEC SQL                                                 11120001
111300             SELECT AP_VERIFY_ITM_QTY                             11130001
111400               INTO :PV-RECEIVED-DRV-QTY                          11140001
111500               FROM TRECDIS                                       11150001
111600              WHERE ORD_NBR        = :DP277-PO-NBR                11160001
111700                AND ORD_LNE_NBR    = :DK-DRIVER-LINE-NBR          11170001
111800                AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR          11180001
111900                AND OPER_UNT_ID    = :DP277-OPER-UNT-ID           11190001
112100                AND STR_NBR        = :RECDIS-STR-NBR              11210001
112200                AND STR_FCLTY_ID   = :PC-SHORT-ONE                11220001
112210                AND FCLTY_ID       = :DP277-FCLTY-ID              11221013
112300         END-EXEC                                                 11230001
112400     ELSE                                                         11240001
112500         EXEC SQL                                                 11250001
112600             SELECT EXPTED_ITM_QTY                                11260001
112700               INTO :PV-RECEIVED-DRV-QTY                          11270001
112800               FROM TRECDIS                                       11280001
112900              WHERE ORD_NBR        = :DP277-PO-NBR                11290001
113000                AND ORD_LNE_NBR    = :DK-DRIVER-LINE-NBR          11300001
113100                AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR          11310001
113200                AND OPER_UNT_ID    = :DP277-OPER-UNT-ID           11320001
113400                AND STR_NBR        = :RECDIS-STR-NBR              11340001
113500                AND STR_FCLTY_ID   = :PC-SHORT-ONE                11350001
113510                AND FCLTY_ID       = :DP277-FCLTY-ID              11351013
113600         END-EXEC                                                 11360001
113700     END-IF                                                       11370001
113800                                                                  11380001
113900     EVALUATE TRUE                                                11390001
114000       WHEN SQLCODE = ZERO                                        11400001
114100           CONTINUE                                               11410001
114200       WHEN SQLCODE = +100                                        11420001
114300       WHEN SQLCODE = -305                                        11430001
114400           MOVE 0 TO PV-RECEIVED-DRV-QTY                          11440001
114500                                                                  11450001
114600       WHEN SQLCODE = -904                                        11460001
114700       WHEN SQLCODE = -911                                        11470001
114800       WHEN SQLCODE = -913                                        11480001
114900           MOVE 26 TO DP277-RETURN-CODE                           11490001
115000           PERFORM 9900-SOFT-ABORT                                11500001
115100                                                                  11510001
115200       WHEN OTHER                                                 11520001
115300           MOVE 27 TO DP277-RETURN-CODE                           11530001
115400           PERFORM 9800-PGM-ABEND                                 11540001
115500     END-EVALUATE.                                                11550001
115600                                                                  11560001
115700                                                                  11570001
115800******************************************************************11580001
115900******************************************************************11590001
116000 6000-PROCESS-RECITM-CURSOR.                                      11600001
116100                                                                  11610001
116200     PERFORM 6100-APPLY-PRIOR-RECEIPTS.                           11620001
116300                                                                  11630001
116400     SET PS-HAVE-DRV-QTY-NO TO TRUE.                              11640001
116500                                                                  11650001
116600     IF PS-ERRORS-NO                                              11660001
116700         IF DP277-RECEIVER-OTR                                    11670001
116800             PERFORM 7110-FETCH-RECITM-CURSOR                     11680001
116900         ELSE                                                     11690001
117000             PERFORM 7210-FETCH-RECITM-CURSOR                     11700001
117100     END-IF.                                                      11710001
117200                                                                  11720001
117300******************************************************************11730001
117400******************************************************************11740001
117500 6100-APPLY-PRIOR-RECEIPTS.                                       11750001
117600                                                                  11760001
117700     PERFORM 6110-APPLY-PRIOR-RECEIPTS.                           11770001
117800                                                                  11780001
117900*APPLY DRIVER LINE RECEIPTS (IF LINE CHANGED).                    11790001
118000     IF DK-LINE-NBR = DK-DRIVER-LINE-NBR                          11800001
118001        OR PS-NO-DRIVER-LINE                                      11800101
118100         MOVE PV-RECEIVED-QTY TO PV-RECEIVED-DRV-QTY              11810001
118200     ELSE                                                         11820001
118300         IF DK-DRIVER-LINE-NBR NOT = 0                            11830001
118400           AND PS-HAVE-DRV-QTY-NO                                 11840001
118500             PERFORM 6120-DETERMINE-DRVLNE-RECEIPTS               11850001
118600         END-IF                                                   11860001
118700     END-IF.                                                      11870001
118800                                                                  11880001
118900*CALCULATE PACK QUANTITY.                                         11890001
118910*NOTE:                                                            11891001
118911*ON A NON DRIVER LINE RECEIVER RATIO QUANTITY IS DEFAULTED TO     11891101
118912*THE PURITM RATIO                                                 11891201
119000     IF PV-RECITM-RATO-QTY > +0                                   11900001
119100       AND (DK-DRIVER-LINE-NBR NOT = 0                            11910001
119110         OR PS-NO-DRIVER-LINE)                                    11911001
119200         DIVIDE PV-RECEIVED-DRV-QTY                               11920001
119300           BY PV-RECITM-RATO-QTY                                  11930001
119400           GIVING PV-RECEIVED-QTY-PK                              11940001
119500         SUBTRACT PV-RECEIVED-QTY-PK                              11950001
119600             FROM DP277-LNE-OTR-PK(DP277-LNE-IDX)                 11960001
119700     ELSE                                                         11970001
119800         MOVE ZEROES TO PV-RECEIVED-QTY-PK                        11980001
119900     END-IF.                                                      11990001
120000                                                                  12000001
120100******************************************************************12010001
120200******************************************************************12020001
120300 6110-APPLY-PRIOR-RECEIPTS.                                       12030001
120400                                                                  12040001
120500     MOVE DP277-LNE-NBR(DP277-LNE-IDX) TO RECDIS-ORD-LNE-NBR.     12050001
120600                                                                  12060001
120700     EVALUATE RECITM-STATUS-CDE                                   12070001
120800       WHEN PC-VE                                                 12080001
120900           IF DP277-STR-NBR = ZERO                                12090001
121000               EXEC SQL                                           12100001
121100                   SELECT SUM(AP_VERIFY_ITM_QTY)                  12110001
121200                     INTO :PV-RECEIVED-QTY                        12120001
121300                     FROM TRECDIS                                 12130001
121400                    WHERE ORD_NBR        = :DP277-PO-NBR          12140001
121500                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    12150001
121600                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    12160001
121700                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     12170001
121900                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          12190001
121910                      AND FCLTY_ID       = :DP277-FCLTY-ID        12191013
122000               END-EXEC                                           12200001
122100           ELSE                                                   12210001
122200               EXEC SQL                                           12220001
122300                   SELECT AP_VERIFY_ITM_QTY                       12230001
122400                     INTO :PV-RECEIVED-QTY                        12240001
122500                     FROM TRECDIS                                 12250001
122600                    WHERE ORD_NBR        = :DP277-PO-NBR          12260001
122700                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    12270001
122800                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    12280001
122900                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     12290001
123000                      AND FCLTY_ID       = :DP277-FCLTY-ID        12300001
123100                      AND STR_NBR        = :DP277-STR-NBR         12310001
123200                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          12320001
123400               END-EXEC                                           12340001
123500           END-IF                                                 12350001
123600                                                                  12360001
123700       WHEN PC-IP                                                 12370001
123800       WHEN PC-CM                                                 12380001
123900           IF DP277-STR-NBR = ZERO                                12390001
124000               EXEC SQL                                           12400001
124100                   SELECT SUM(EXPTED_ITM_QTY)                     12410001
124200                     INTO :PV-RECEIVED-QTY                        12420001
124300                     FROM TRECDIS                                 12430001
124400                    WHERE ORD_NBR        = :DP277-PO-NBR          12440001
124500                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    12450001
124600                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    12460001
124700                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     12470001
124800                      AND FCLTY_ID       = :DP277-FCLTY-ID        12480001
125000                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          12500001
125100               END-EXEC                                           12510001
125200           ELSE                                                   12520001
125300               EXEC SQL                                           12530001
125400                   SELECT EXPTED_ITM_QTY                          12540001
125500                     INTO :PV-RECEIVED-QTY                        12550001
125600                     FROM TRECDIS                                 12560001
125700                    WHERE ORD_NBR        = :DP277-PO-NBR          12570001
125800                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    12580001
125900                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    12590001
126000                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     12600001
126100                      AND FCLTY_ID       = :DP277-FCLTY-ID        12610001
126200                      AND STR_NBR        = :DP277-STR-NBR         12620001
126400                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          12640001
126500               END-EXEC                                           12650001
126600           END-IF                                                 12660001
126700     END-EVALUATE.                                                12670001
126800                                                                  12680001
126900     EVALUATE TRUE                                                12690001
127000       WHEN SQLCODE = ZERO                                        12700001
127100           SUBTRACT PV-RECEIVED-QTY                               12710001
127200               FROM DP277-LNE-OTR-QTY(DP277-LNE-IDX)              12720001
127300           IF DP277-LNE-OTR-QTY(DP277-LNE-IDX) > ZERO             12730001
127400               MOVE DP277-LNE-OTR-QTY(DP277-LNE-IDX)              12740001
127500                    TO PV-DISPLAY-QTY                             12750001
127600           ELSE                                                   12760001
127700               MOVE ZERO TO PV-DISPLAY-QTY                        12770001
127800           END-IF                                                 12780001
127900           MOVE PV-DISPLAY-QTY                                    12790001
128000                TO DP277-LNE-OTR-QTY-X(DP277-LNE-IDX)             12800001
128100                                                                  12810001
128200       WHEN SQLCODE = +100                                        12820001
128300       WHEN SQLCODE = -305                                        12830001
128400           MOVE ZEROES TO PV-RECEIVED-QTY                         12840001
128500                                                                  12850001
128600       WHEN SQLCODE = -904                                        12860001
128700       WHEN SQLCODE = -911                                        12870001
128800       WHEN SQLCODE = -913                                        12880001
128900           MOVE 28 TO DP277-RETURN-CODE                           12890001
129000           PERFORM 9900-SOFT-ABORT                                12900001
129100                                                                  12910001
129200       WHEN OTHER                                                 12920001
129300           MOVE 29 TO DP277-RETURN-CODE                           12930001
129400           PERFORM 9800-PGM-ABEND                                 12940001
129500     END-EVALUATE.                                                12950001
129600                                                                  12960001
129700******************************************************************12970001
129800******************************************************************12980001
129900 6120-DETERMINE-DRVLNE-RECEIPTS.                                  12990001
130000                                                                  13000001
130100     MOVE DK-DRIVER-LINE-NBR TO RECDIS-ORD-LNE-NBR.               13010001
130200                                                                  13020001
130300     EVALUATE RECITM-STATUS-CDE                                   13030001
130400       WHEN PC-VE                                                 13040001
130500           IF DP277-STR-NBR = ZERO                                13050001
130600               EXEC SQL                                           13060001
130700                   SELECT SUM(AP_VERIFY_ITM_QTY)                  13070001
130800                     INTO :PV-RECEIVED-DRV-QTY                    13080001
130900                     FROM TRECDIS                                 13090001
131000                    WHERE ORD_NBR        = :DP277-PO-NBR          13100001
131100                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    13110001
131200                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    13120001
131300                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     13130001
131500                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          13150001
131510                      AND FCLTY_ID       = :DP277-FCLTY-ID        13151013
131600               END-EXEC                                           13160001
131700           ELSE                                                   13170001
131800               EXEC SQL                                           13180001
131900                   SELECT AP_VERIFY_ITM_QTY                       13190001
132000                     INTO :PV-RECEIVED-DRV-QTY                    13200001
132100                     FROM TRECDIS                                 13210001
132200                    WHERE ORD_NBR        = :DP277-PO-NBR          13220001
132300                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    13230001
132400                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    13240001
132500                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     13250001
132600                      AND FCLTY_ID       = :DP277-FCLTY-ID        13260001
132700                      AND STR_NBR        = :DP277-STR-NBR         13270001
132800                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          13280001
133000               END-EXEC                                           13300001
133100           END-IF                                                 13310001
133200                                                                  13320001
133300       WHEN PC-IP                                                 13330001
133400       WHEN PC-CM                                                 13340001
133500           IF DP277-STR-NBR = ZERO                                13350001
133600               EXEC SQL                                           13360001
133700                   SELECT SUM(EXPTED_ITM_QTY)                     13370001
133800                     INTO :PV-RECEIVED-DRV-QTY                    13380001
133900                     FROM TRECDIS                                 13390001
134000                    WHERE ORD_NBR        = :DP277-PO-NBR          13400001
134100                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    13410001
134200                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    13420001
134300                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     13430001
134400                      AND FCLTY_ID       = :DP277-FCLTY-ID        13440001
134600                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          13460001
134700               END-EXEC                                           13470001
134800           ELSE                                                   13480001
134900               EXEC SQL                                           13490001
135000                   SELECT EXPTED_ITM_QTY                          13500001
135100                     INTO :PV-RECEIVED-DRV-QTY                    13510001
135200                     FROM TRECDIS                                 13520001
135300                    WHERE ORD_NBR        = :DP277-PO-NBR          13530001
135400                      AND ORD_LNE_NBR    = :RECDIS-ORD-LNE-NBR    13540001
135500                      AND REC_SEQ_NBR    = :RECITM-REC-SEQ-NBR    13550001
135600                      AND OPER_UNT_ID    = :DP277-OPER-UNT-ID     13560001
135700                      AND FCLTY_ID       = :DP277-FCLTY-ID        13570001
135800                      AND STR_NBR        = :DP277-STR-NBR         13580001
136000                      AND STR_FCLTY_ID   = :PC-SHORT-ONE          13600001
136100               END-EXEC                                           13610001
136200           END-IF                                                 13620001
136300     END-EVALUATE.                                                13630001
136400                                                                  13640001
136500     EVALUATE TRUE                                                13650001
136600       WHEN SQLCODE = ZERO                                        13660001
136700           SET PS-HAVE-DRV-QTY-YES TO TRUE                        13670001
136800                                                                  13680001
136900       WHEN SQLCODE = +100                                        13690001
137000       WHEN SQLCODE = -305                                        13700001
137100           MOVE ZERO TO PV-RECEIVED-DRV-QTY                       13710001
137200                                                                  13720001
137300       WHEN SQLCODE = -904                                        13730001
137400       WHEN SQLCODE = -911                                        13740001
137500       WHEN SQLCODE = -913                                        13750001
137600           MOVE 30 TO DP277-RETURN-CODE                           13760001
137700           PERFORM 9900-SOFT-ABORT                                13770001
137800                                                                  13780001
137900       WHEN OTHER                                                 13790001
138000           MOVE 31 TO DP277-RETURN-CODE                           13800001
138100           PERFORM 9800-PGM-ABEND                                 13810001
138200     END-EVALUATE.                                                13820001
138300                                                                  13830001
138400******************************************************************13840001
138500*    THIS PARAGRAPH RETRIEVES THE EARLIEST TIMESTAMP FOR A PO     13850001
138600*    AND RECEIVER  WITHIN A DC.                                   13860001
138700******************************************************************13870001
138800 7000-GET-RECITM-TMST.                                            13880001
138900                                                                  13890001
139000     EXEC SQL                                                     13900001
139100         SELECT CRE_TMST                                          13910001
139200           INTO :RECITM-CRE-TMST                                  13920001
139300           FROM TRECITM                                           13930001
139400          WHERE ORD_NBR     = :DP277-PO-NBR                       13940001
139500            AND REC_SEQ_NBR = :DP277-REC-SEQ-NBR                  13950001
139600            AND ORD_LNE_NBR = :DK-LINE-NBR                        13960001
139700            AND OPER_UNT_ID = :DP277-OPER-UNT-ID                  13970001
139800     END-EXEC.                                                    13980001
139900                                                                  13990001
140000     EVALUATE TRUE                                                14000001
140100       WHEN SQLCODE = ZERO                                        14010001
140200           CONTINUE                                               14020001
140300                                                                  14030001
140400       WHEN SQLCODE = +100                                        14040001
140500           EXEC SQL                                               14050001
140600               SET :RECITM-CRE-TMST = CURRENT TIMESTAMP           14060001
140700           END-EXEC                                               14070001
140800                                                                  14080001
140900       WHEN SQLCODE = -904                                        14090001
141000       WHEN SQLCODE = -911                                        14100001
141100       WHEN SQLCODE = -913                                        14110001
141200           MOVE 32 TO DP277-RETURN-CODE                           14120001
141300           PERFORM 9900-SOFT-ABORT                                14130001
141400                                                                  14140001
141500       WHEN OTHER                                                 14150001
141600           MOVE 33 TO DP277-RETURN-CODE                           14160001
141700           PERFORM 9800-PGM-ABEND                                 14170001
141800     END-EVALUATE.                                                14180001
141900                                                                  14190001
142000******************************************************************14200001
142100******************************************************************14210001
142200 7100-OPEN-RECITM-CURSOR.                                         14220001
142300                                                                  14230001
142400     EXEC SQL                                                     14240001
142500         OPEN REC-LVL-CSR                                         14250001
142600     END-EXEC.                                                    14260001
142700                                                                  14270001
142800     EVALUATE TRUE                                                14280001
142900       WHEN SQLCODE = ZERO                                        14290001
143000           SET PS-CURSOR-OPEN TO TRUE                             14300001
143100                                                                  14310001
143200       WHEN SQLCODE = -904                                        14320001
143300       WHEN SQLCODE = -911                                        14330001
143400       WHEN SQLCODE = -913                                        14340001
143500           SET PS-CURSOR-CLOSED TO TRUE                           14350001
143600           MOVE 34 TO DP277-RETURN-CODE                           14360001
143700           PERFORM 9900-SOFT-ABORT                                14370001
143800                                                                  14380001
143900       WHEN OTHER                                                 14390001
144000           SET PS-CURSOR-CLOSED TO TRUE                           14400001
144100           MOVE 35 TO DP277-RETURN-CODE                           14410001
144200           PERFORM 9800-PGM-ABEND                                 14420001
144300     END-EVALUATE.                                                14430001
144400                                                                  14440001
144500******************************************************************14450001
144600******************************************************************14460001
144700 7110-FETCH-RECITM-CURSOR.                                        14470001
144800                                                                  14480001
144900     EXEC SQL                                                     14490001
145000         FETCH REC-LVL-CSR                                        14500001
145100          INTO :RECITM-REC-SEQ-NBR                                14510001
145200             , :RECITM-STATUS-CDE                                 14520001
145300     END-EXEC.                                                    14530001
145400                                                                  14540001
145500     EVALUATE TRUE                                                14550001
145600       WHEN SQLCODE = ZERO                                        14560001
145700           PERFORM 8000-FETCH-DRIVER-LINE                         14570001
145800           MOVE RECITM-PREPK-RATO-QTY TO PV-RECITM-RATO-QTY       14580001
145900           MOVE RECITM-ORD-LNE-NBR    TO DK-DRIVER-LINE-NBR       14590001
146000                                                                  14600001
146100       WHEN SQLCODE = +100                                        14610001
146200           SET PS-PRIOR-CURSOR-EOF TO TRUE                        14620001
146300                                                                  14630001
146400       WHEN OTHER                                                 14640001
146500           MOVE 36 TO DP277-RETURN-CODE                           14650001
146600           PERFORM 9800-PGM-ABEND                                 14660001
146700     END-EVALUATE.                                                14670001
146800                                                                  14680001
146900******************************************************************14690001
147000******************************************************************14700001
147100 7120-CLOSE-RECITM-CURSOR.                                        14710001
147200                                                                  14720001
147300     EXEC SQL                                                     14730001
147400         CLOSE REC-LVL-CSR                                        14740001
147500     END-EXEC.                                                    14750001
147600                                                                  14760001
147700     EVALUATE TRUE                                                14770001
147800       WHEN SQLCODE = ZERO                                        14780001
147900           SET PS-CURSOR-CLOSED TO TRUE                           14790001
148000                                                                  14800001
148100       WHEN OTHER                                                 14810001
148200           MOVE 37 TO DP277-RETURN-CODE                           14820001
148300           PERFORM 9800-PGM-ABEND                                 14830001
148400     END-EVALUATE.                                                14840001
148500                                                                  14850001
148600******************************************************************14860001
148700******************************************************************14870001
148800 7200-OPEN-RECITM-CURSOR.                                         14880001
148900                                                                  14890001
149000     EXEC SQL                                                     14900001
149100         OPEN PO-LVL-CSR                                          14910001
149200     END-EXEC.                                                    14920001
149300                                                                  14930001
149400     EVALUATE TRUE                                                14940001
149500       WHEN SQLCODE = ZERO                                        14950001
149600           SET PS-CURSOR-OPEN TO TRUE                             14960001
149700                                                                  14970001
149800       WHEN SQLCODE = -904                                        14980001
149900       WHEN SQLCODE = -911                                        14990001
150000       WHEN SQLCODE = -913                                        15000001
150100           SET PS-CURSOR-CLOSED TO TRUE                           15010001
150200           MOVE 38 TO DP277-RETURN-CODE                           15020001
150300           PERFORM 9900-SOFT-ABORT                                15030001
150400                                                                  15040001
150500       WHEN OTHER                                                 15050001
150600           SET PS-CURSOR-CLOSED TO TRUE                           15060001
150700           MOVE 39 TO DP277-RETURN-CODE                           15070001
150800           PERFORM 9800-PGM-ABEND                                 15080001
150900     END-EVALUATE.                                                15090001
151000                                                                  15100001
151100******************************************************************15110001
151200******************************************************************15120001
151300 7210-FETCH-RECITM-CURSOR.                                        15130001
151400                                                                  15140001
151500     EXEC SQL                                                     15150001
151600         FETCH PO-LVL-CSR                                         15160001
151700          INTO :RECITM-REC-SEQ-NBR                                15170001
151800             , :RECITM-STATUS-CDE                                 15180001
151900     END-EXEC.                                                    15190001
152000                                                                  15200001
152100     EVALUATE TRUE                                                15210001
152200       WHEN SQLCODE = ZERO                                        15220001
152300           PERFORM 8000-FETCH-DRIVER-LINE                         15230001
152400           MOVE RECITM-PREPK-RATO-QTY TO PV-RECITM-RATO-QTY       15240001
152500           MOVE RECITM-ORD-LNE-NBR    TO DK-DRIVER-LINE-NBR       15250001
152600                                                                  15260001
152700       WHEN SQLCODE = +100                                        15270001
152800           SET PS-PRIOR-CURSOR-EOF TO TRUE                        15280001
152900                                                                  15290001
153000       WHEN OTHER                                                 15300001
153100           MOVE 40 TO DP277-RETURN-CODE                           15310001
153200           PERFORM 9800-PGM-ABEND                                 15320001
153300     END-EVALUATE.                                                15330001
153400                                                                  15340001
153500******************************************************************15350001
153600******************************************************************15360001
153700 7220-CLOSE-RECITM-CURSOR.                                        15370001
153800                                                                  15380001
153900     EXEC SQL                                                     15390001
154000         CLOSE PO-LVL-CSR                                         15400001
154100     END-EXEC.                                                    15410001
154200                                                                  15420001
154300     EVALUATE TRUE                                                15430001
154400       WHEN SQLCODE = ZERO                                        15440001
154500           SET PS-CURSOR-CLOSED TO TRUE                           15450001
154600                                                                  15460001
154700       WHEN OTHER                                                 15470001
154800           MOVE 41 TO DP277-RETURN-CODE                           15480001
154900           PERFORM 9800-PGM-ABEND                                 15490001
155000     END-EVALUATE.                                                15500001
155100                                                                  15510001
155200******************************************************************15520001
155300******************************************************************15530001
155400 8000-FETCH-DRIVER-LINE.                                          15540001
155500                                                                  15550001
155600     EXEC SQL                                                     15560001
155700         SELECT DISTINCT                                          15570001
155800                PREPK_RATO_QTY                                    15580001
155900              , ORD_LNE_NBR                                       15590001
156000         INTO   :RECITM-PREPK-RATO-QTY                            15600001
156100              , :RECITM-ORD-LNE-NBR                               15610001
156200         FROM TRECITM                                             15620001
156300         WHERE ORD_NBR          = :DP277-PO-NBR                   15630001
156400         AND REC_SEQ_NBR        = :RECITM-REC-SEQ-NBR             15640001
156500         AND OPER_UNT_ID        = :DP277-OPER-UNT-ID              15650001
156600         AND PREPK_ID           = :DP277-PO-PREPK-ID              15660001
156700         AND PREPK_DRV_LNE_CDE  = 'A'                             15670001
156800     END-EXEC.                                                    15680001
156900                                                                  15690001
157000     EVALUATE TRUE                                                15700001
157100       WHEN SQLCODE = ZERO                                        15710001
157200           SET PS-DRIVER-LINE TO TRUE                             15720001
157300                                                                  15730001
157400       WHEN SQLCODE = +100                                        15740001
157410******************************************************************15741001
157411*NO DRIVER LINE CAN OCCUR IF THE RECEIVER IS A NON PREPACK       *15741101
157412*RECEIVER OR THE PREPACK LINE RECEIVER HAS BEEN DELETED.         *15741201
157413*THE RATIO QTY IS DEFAULTED TO THE PURITM RATIO.                 *15741301
157420******************************************************************15742001
157430           PERFORM 8010-FETCH-PURITM-RATIO                        15743001
157500           MOVE PURITM-PREPK-RATO-QTY  TO RECITM-PREPK-RATO-QTY   15750001
157600           MOVE ZEROES                 TO RECITM-ORD-LNE-NBR      15760001
157610           SET PS-NO-DRIVER-LINE TO TRUE                          15761001
157700                                                                  15770001
157800       WHEN SQLCODE = -904                                        15780001
157900       WHEN SQLCODE = -911                                        15790001
158000       WHEN SQLCODE = -913                                        15800001
158100           MOVE 42 TO DP277-RETURN-CODE                           15810001
158200           PERFORM 9900-SOFT-ABORT                                15820001
158300                                                                  15830001
158400       WHEN OTHER                                                 15840001
158500           MOVE 43 TO DP277-RETURN-CODE                           15850001
158600           PERFORM 9800-PGM-ABEND                                 15860001
158700     END-EVALUATE.                                                15870001
158710******************************************************************15871001
158720******************************************************************15872001
158730 8010-FETCH-PURITM-RATIO.                                         15873001
158740                                                                  15874001
158750     EXEC SQL                                                     15875001
158760         SELECT DISTINCT                                          15876001
158770                PREPK_RATO_QTY                                    15877001
158790         INTO   :PURITM-PREPK-RATO-QTY                            15879001
158792         FROM TPURITM                                             15879201
158793         WHERE PO_NBR           = :DP277-PO-NBR                   15879301
158794         AND   PO_LNE_NBR       = :DK-LINE-NBR                    15879401
158795         AND   VER_STATUS_CDE   = 'A'                             15879501
158796         AND   PO_PREPK_ID      = :DP277-PO-PREPK-ID              15879601
158798     END-EXEC.                                                    15879801
158799                                                                  15879901
158800     EVALUATE TRUE                                                15880001
158801       WHEN SQLCODE = ZERO                                        15880101
158802           CONTINUE                                               15880201
158803                                                                  15880301
158804       WHEN SQLCODE = +100                                        15880401
158810           MOVE 0                   TO PURITM-PREPK-RATO-QTY      15881002
158813                                                                  15881301
158814       WHEN SQLCODE = -904                                        15881401
158815       WHEN SQLCODE = -911                                        15881501
158816       WHEN SQLCODE = -913                                        15881601
158817           MOVE 42 TO DP277-RETURN-CODE                           15881701
158818           PERFORM 9900-SOFT-ABORT                                15881801
158819                                                                  15881901
158820       WHEN OTHER                                                 15882001
158821           MOVE 43 TO DP277-RETURN-CODE                           15882101
158822           PERFORM 9800-PGM-ABEND                                 15882201
158823     END-EVALUATE.                                                15882301
158830                                                                  15883001
158900******************************************************************15890001
159000******************************************************************15900001
159100 9000-NO-DISTRO-ERROR.                                            15910001
159200                                                                  15920001
159300     SET DP277-NO-DISTRO                                          15930001
159400         DP277-WARNING-ERROR TO TRUE.                             15940001
159500                                                                  15950001
159600     IF DP277-STORE-LEVEL-OTR                                     15960001
159700         PERFORM VARYING DP277-STR-IDX FROM 1 BY 1                15970001
159800           UNTIL DP277-STR-IDX > 250                              15980001
159900             MOVE ALL '*' TO DP277-STR-OTR-QTY-X(DP277-STR-IDX)   15990001
160000         END-PERFORM                                              16000001
160100     ELSE                                                         16010001
160200         MOVE ALL '*' TO DP277-LNE-OTR-QTY-X(DP277-LNE-IDX)       16020001
160300     END-IF.                                                      16030001
160400                                                                  16040001
160500******************************************************************16050001
160600*    WHEN A FATAL ERROR OCCURS PASS THE ERROR SWITCHES BACK TO    16060001
160700*    THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG.          16070001
160800******************************************************************16080001
160900 9800-PGM-ABEND.                                                  16090001
161000                                                                  16100001
161100     PERFORM VARYING DP277-LNE-ERR-IDX FROM 1 BY 1                16110001
161200       UNTIL DP277-LNE-ERR-IDX > 100                              16120001
161300         MOVE SPACES                                              16130001
161400                 TO DP277-LNE-OTR-QTY-X(DP277-LNE-ERR-IDX)        16140001
161500                    DP277-LNE-DISTRO-QTY-X(DP277-LNE-ERR-IDX)     16150001
161600         MOVE ZEROES                                              16160001
161700                 TO DP277-LNE-OTR-QTY(DP277-LNE-ERR-IDX)          16170001
161800                    DP277-LNE-DISTRO-QTY(DP277-LNE-ERR-IDX)       16180001
161900     END-PERFORM.                                                 16190001
162000                                                                  16200001
162100     PERFORM VARYING DP277-STR-ERR-IDX FROM 1 BY 1                16210001
162200       UNTIL DP277-STR-ERR-IDX > 250                              16220001
162300         MOVE SPACES                                              16230001
162400                 TO DP277-STR-OTR-QTY-X(DP277-STR-ERR-IDX)        16240001
162500                    DP277-STR-DISTRO-QTY-X(DP277-STR-ERR-IDX)     16250001
162600         MOVE ZEROES                                              16260001
162700                 TO DP277-STR-OTR-QTY(DP277-STR-ERR-IDX)          16270001
162800                    DP277-STR-DISTRO-QTY(DP277-STR-ERR-IDX)       16280001
162900     END-PERFORM.                                                 16290001
163000                                                                  16300001
163100     SET PS-ERRORS-YES TO TRUE.                                   16310001
163200                                                                  16320001
163300     SET DP277-FATAL-ERROR                                        16330001
163400         DP277-CROAK TO TRUE.                                     16340001
163500                                                                  16350001
163600     MOVE SQLCODE TO PV-SQLCODE.                                  16360001
163700     PERFORM 9950-FORMAT-ERROR-MSG.                               16370001
163800                                                                  16380001
163900     SET DP013-LINK-RETURN                                        16390001
164000         DP013-NO-ROLLBACK TO TRUE.                               16400001
164100                                                                  16410001
164200     PERFORM DP013-0000-PROCESS-ABEND.                            16420001
164300                                                                  16430001
164400******************************************************************16440001
164500*    THE DB2 RESOURCE IS NOT AVAILABLE, PASS THE ERROR SWITCHES  *16450001
164600*    BACK TO THE HOST PROGRAM AND WRITE TO THE CICS MESSAGE LOG  *16460001
164700******************************************************************16470001
164800 9900-SOFT-ABORT.                                                 16480001
164900                                                                  16490001
165000     SET PS-ERRORS-YES                                            16500001
165100         DP277-FATAL-ERROR                                        16510001
165200         DP277-SOFT-ABORT TO TRUE.                                16520001
165300                                                                  16530001
165400     PERFORM 9950-FORMAT-ERROR-MSG.                               16540001
165500                                                                  16550001
165600     SET DP013-LINK-RETURN                                        16560001
165700         DP013-NO-ROLLBACK TO TRUE.                               16570001
165800                                                                  16580001
165900     PERFORM DP013-0000-PROCESS-ABEND.                            16590001
166000                                                                  16600001
166100******************************************************************16610001
166200******************************************************************16620001
166300 9950-FORMAT-ERROR-MSG.                                           16630001
166400                                                                  16640001
166500     MOVE SQLCODE                TO PV-SQLCODE                    16650001
166600                                    PV-DISPLAY-SQLCODE.           16660001
166700                                                                  16670001
166800     MOVE DP277-PO-NBR           TO PV-DISP-PO-NBR                16680001
166900     IF DP277-PO-LNE-NBR = ZERO                                   16690001
167000         MOVE DK-LINE-NBR        TO PV-DISP-PO-LNE-NBR            16700001
167100     ELSE                                                         16710001
167200         MOVE DP277-PO-LNE-NBR   TO PV-DISP-PO-LNE-NBR            16720001
167300     END-IF                                                       16730001
167400     MOVE DP277-REC-SEQ-NBR      TO PV-DISP-REC-SEQ-NBR           16740001
167500     MOVE DP277-OPER-UNT-ID      TO PV-DISP-OPER-UNT-ID           16750001
167600     MOVE DP277-FCLTY-ID         TO PV-DISP-FCLTY-ID              16760001
167700     MOVE DP277-STR-NBR          TO PV-DISP-STR-NBR.              16770001
167800                                                                  16780001
167900     STRING '** DPKCS277 ** ERROR; '                              16790001
168000         PV-RETURN-MSG DELIMITED BY SIZE                          16800001
168100                                 INTO DP013-MESSAGE-TEXT (1)      16810001
168200                                                                  16820001
168300     STRING  ' DP277-RC = ' DP277-RETURN-CODE                     16830001
168400             '; SQLCODE = ' PV-DISPLAY-SQLCODE                    16840001
168500                                  DELIMITED BY SIZE               16850001
168600                                 INTO DP013-MESSAGE-TEXT (2)      16860001
168700                                                                  16870001
168800     MOVE '  PO    REC  LNE OPER FCLTY STR'                       16880001
168900                                   TO DP013-MESSAGE-TEXT (3)      16890001
169000                                                                  16900001
169100     STRING                                                       16910001
169200         PV-DISP-PO-NBR '-'                                       16920001
169300         PV-DISP-REC-SEQ-NBR '-'                                  16930001
169400         PV-DISP-PO-LNE-NBR '-'                                   16940001
169500         PV-DISP-OPER-UNT-ID '-'                                  16950001
169600         PV-DISP-FCLTY-ID '-'                                     16960001
169700         PV-DISP-STR-NBR                                          16970001
169800         DELIMITED BY SIZE INTO DP013-MESSAGE-TEXT (4).           16980001
169900                                                                  16990001
170000******************************************************************17000001
170100*    ABEND PROCESSOR MODULE                                      *17010001
170200******************************************************************17020001
170300                                                                  17030001
170400     COPY DPPD013.                                                17040001
