000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT001.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*  AHKUT001.   "ARCHIVE HISTORY" PROJECT. DATA OFFLOAD.          *00090000
001000*                                                                *00100000
001100*  PURPOSE:                                                      *00110000
001200*  THIS PROGRAM BEGINS THE PROCESS OF CREATING A DRIVER FILE.    *00120000
001300*  ONCE COMPLETED, THE DRIVER FILE WILL BE USED BY SUBSEQUENT    *00130000
001400*  PROGRAMS TO IDENTIFY AND EXTRACT COMPLETED PURCHASE ORDERS    *00140000
001500*  (PO'S) FROM SEVERAL INTERRELATED TABLES, FOR ARCHIVING.       *00150000
001600*                                                                *00160000
001700*  PROCESSING OVERVIEW:                                          *00170000
001800*  THIS PROGRAM ACCESSES TINVOIC ON PO_NBR AND INVC_ID           *00180000
001900*  AND APPLIES SELECTION CRITERIA, CREATING AN OUTPUT FILE       *00190000
002000*  OF RECORDS CONTAINING:                                        *00200000
002100*  1) THE FULL ROW OF DATA FROM TINVOIC                          *00210000
002200*  THESE RECORDS ARE ORDERED BY PO, PAYT_REQ_SEQ_NBR FOR EASE    *00220000
002300*  AND EFFICIENCY OF SUBSEQUENT PROCESSING.                      *00230000
002400*                                                                *00240000
002500*  FOR EACH PO RETURNED, AN ADDITIONAL SELECT IS PERFORMED ON    *00250000
002600*  TINVOIC TO DETERMINE IF THERE ARE ANY                         *00260000
002700*  INVOICES FOR THE PO THAT DO NOT MEET THE AGE CRITERIA.  IF    *00270000
002800*  ANY ARE FOUND, NONE OF THE ROWS FOR THE PO ARE WRITTEN TO     *00280000
002900*  THE EXTRACT FILE.                                             *00290000
003000******************************************************************00300000
003100* MARCH 2000                                                     *00310000
003200* MODIFIED LOGIC TO ADD A SELECT AGAINST A JOIN OF TPAYREQ AND   *00320000
003300* TINVOIC TO ENSURE THAT THERE ARE NO INVOICES FOR THE PO BEING  *00330000
003400* PROCESSED THAT DO NOT MEET THE ARCHIVE CRITERIA.               *00340000
003500* NANCY EILBES                                                   *00350000
003600*                                                                *00360000
003700* OCTOBER 2001                                                   *00370000
003800* ADDED LOGIC TO ACCEPT PAY DATE AND RELEASE DATE FROM CONTROL   *00380000
003900* CARD SO THAT IT DID NOT HAVE TO BE HARDCODED IN THE SQL        *00390000
004000* STATEMENTS.                                                    *00400000
004100* NANCY EILBES                                                   *00410000
004200*                                                                *00420000
004300* FEBRUARY 2002                                                  *00430000
004400* REMOVED DISPLAYS OF PO BEING BYPASSED/PROCESSED AND REPLACED   *00440000
004500* WITH COUNTERS THAT ARE DISPLAYED AT END OF JOB.                *00450000
004600* STATEMENTS.                                                    *00460000
004700* NANCY EILBES                                 WR# 22902         *00470000
004800*                                                                *00480000
004900* JUNE 2002                                                      *00490000
005000* REMOVED TPAYREQ REFERENCES AND USAGES AS PART OF THE ARK PO    *00500000
005100* PHASE 1 PROJECT.  TINVOIC WILL BE THE MAIN INVOICE TABLE AS    *00510000
005200* TPAYREQ IS BEING PHASED OUT.                                   *00520000
005300* MIKE BESKE                                   WR# 23500         *00530000
005400*                                                                *00540000
005500* JUNE 2007                                                      *00550000
005600* CHANGED THE SELECTION CRITERIA FOR INVOICES TO INCLUDE IMPORT  *00560000
005700* PO'S.  INVOICES FOR IMPORT PO'S DON'T ALWAYS FOLLOW THE SAME   *00570000
005800* RULES AS INVOICES FOR DOMESTIC PO'S.  ALSO, ADDED DC_NBR AND   *00580000
005900* MTCH_LVL_CDE TO TABLE-CURSOR.  INCREASED THE SIZE OF THE       *00590000
006000* OUT-DRIVER-FILE FROM 186 TO 189 TO ALLOW FOR THE 2 ADDITIONAL  *00600000
006001* FIELDS IN THE COPYBOOK AHRD001.                                *00600100
006002* ROLF NOHE                                    WR# 30241         *00600200
006003* FEB  2008                                                      *00600300
006004* CHANGED CURSOR TO BE LESS THAN OR EQUAL TO                     *00600400
006005* GREG WISIALOWSKI                             WR# 34276         *00600500
006006*                                                                *00600600
006007*DATE  05/22/2013                                                *00600700
006008*    CHANGE MADE: MODIFIED LOGIC IN 3000-CHECK-FOR-OTHER-INVOICES*00600800
006009*    TO ELIMINATE TABLE TPURCHS AND TO REMOVE THE CRITERIA FOR   *00600900
006010*    PAY-RELEASE DATE WHEN STATUS IS OP.  THE AP-PRC-DTE IS      *00601000
006011*    ENOUGH CRITERIA TO IDENTIFY INVOICES THAT SHOULD NOT BE     *00601100
006012*    ELIGIBLE, AND THE COMBINATION OF BOTH DATES WHEN THE STATUS *00601200
006013*    WAS 'OP' WAS KEEPING POS FROM BEING SELECTED.               *00601300
006014*    MADE BY: NANCY EILBES            WR/IR #: CHG0054421        *00601400
006015*                                                                *00601502
006016*DATE  06/18/2013                                                *00601602
006017*    CHANGE MADE: MODIFIED LOGIC IN THE CURSOR AND IN THE SQL IN *00601702
006018*    3000-CHECK-FOR-OTHER-INVOICES TO ALLOW SELECTION OF INVOICES*00601802
006019*    WHERE THE STATUS IS 'PD', BUT THE PAYT-DTE IS '9999-09-09'. *00601902
006020*    ADDED CRITERIA TO COMPARE THE STATUS CHANGE DATE INSTEAD OF *00602002
006021*    THE PAYT-DTE WHEN THIS IS TRUE.  THIS COMBINATION OF        *00602102
006023*    CONDITIONS WAS KEEPING POS FROM BEING SELECTED.             *00602302
006024*    MADE BY: NANCY EILBES            WR/IR #: CHG0056244        *00602402
006025******************************************************************00602502
006026 ENVIRONMENT DIVISION.                                            00602602
006027 CONFIGURATION SECTION.                                           00602702
006028 SOURCE-COMPUTER.        IBM-3090.                                00602802
006029 OBJECT-COMPUTER.        IBM-3090.                                00602902
006030                                                                  00603002
006031 INPUT-OUTPUT SECTION.                                            00603102
006040 FILE-CONTROL.                                                    00604000
006050                                                                  00605000
006060     SELECT  OUT-DRIVER-FILE              ASSIGN TO OUT01.        00606000
006070                                                                  00607000
006080 DATA DIVISION.                                                   00608000
006090 FILE SECTION.                                                    00609000
006100                                                                  00610000
006200 FD  OUT-DRIVER-FILE                                              00620000
006300     RECORDING MODE IS F                                          00630000
006400     LABEL RECORDS ARE STANDARD                                   00640000
006500     BLOCK CONTAINS 0 RECORDS.                                    00650000
006600 01  OUT-DRIVER-RECORD               PIC  X(189).                 00660000
006700                                                                  00670000
006800 WORKING-STORAGE SECTION.                                         00680000
006900                                                                  00690000
007000 01  PC-PROGRAM-CONSTANTS.                                        00700000
007100     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT001'.  00710000
007200     05  PC-PGM-PROGRESS-DESC.                                    00720000
007300         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00730000
007400         10  PC-JOINING-TBLS         PIC X(12) VALUE              00740000
007500                                               'JOINING TBLS'.    00750000
007600         10  PC-JOIN-COMPLETE        PIC X(13) VALUE              00760000
007700                                               'JOIN COMPLETE'.   00770000
007800         10  PC-CONTINUING           PIC X(10) VALUE              00780000
007900                                               'CONTINUING'.      00790000
008000         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00800000
008100         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00810000
008200     05  PC-ABEND-INFO.                                           00820000
008300         10  PC-ABEND                PIC X(11) VALUE              00830000
008400                                               '** ABEND **'.     00840000
008500         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00850000
008600                                               '- PARA       : '. 00860000
008700         10  PC-ABEND-MSG-DISPLAY-PARA                            00870000
008800                                     PIC X(15) VALUE              00880000
008900                                               '  CALLED PARA: '. 00890000
009000         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00900000
009100                                               '  FOR ABEND# : '. 00910000
009200         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00920000
009300                                               '- ERROR IS   : '. 00930000
009400         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00940000
009500         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00950000
009600                                               '- ACTION     : '. 00960000
009700     05  PC-TEST-AND-SET-NULL-IND.                                00970000
009800         10  PC-NOT-NULL             PIC S9(4) COMP               00980000
009900                                               VALUE ZERO.        00990000
010000         10  PC-NULL                 PIC S9(4) COMP               01000000
010100                                               VALUE -1.          01010000
010200         10  PC-NULL-CONV-ERR        PIC S9(4) COMP               01020000
010300                                               VALUE -2.          01030000
010400         10  PC-NULLIF-QUESTION-MARK PIC X(01) VALUE '?'.         01040000
010500                                                                  01050000
010600     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 100000.      01060000
010700                                                                  01070000
010800 01  PS-PROGRAM-SWITCHES.                                         01080000
010900     05  PS-TABLE-LOOP-DONE-SW       PIC X(01) VALUE 'N'.         01090000
011000         88  PS-TABLE-LOOP-DONE                VALUE 'Y'.         01100000
011100         88  PS-TABLE-LOOP-NOT-DONE            VALUE 'N'.         01110000
011200     05  PS-BYPASS-PO-IND            PIC X(01) VALUE 'N'.         01120000
011300         88  BYPASS-THIS-PO                    VALUE 'Y'.         01130000
011400         88  PROCESS-THIS-PO                   VALUE 'N'.         01140000
011500                                                                  01150000
011600 01  PV-PROGRAM-VARIABLES.                                        01160000
011700     05  PV-ONE                      PIC X     VALUE SPACES.      01170000
011800     05  PV-SAVE-PO-NBR              PIC  S9(9) COMP VALUE 0.     01180000
011900     05  DISPLAY-PO-NBR              PIC  ZZZZZZZZ9.              01190000
012000     05  PV-RLS-TMST                 PIC X(26) VALUE SPACES.      01200000
012100     05  PV-RLS-TMST-DETAIL REDEFINES PV-RLS-TMST.                01210000
012200         10  PV-RLS-DATE             PIC X(10).                   01220000
012300         10  PV-RLS-TIME             PIC X(16).                   01230000
012400     05  PV-SELECT-INTO-FIELD        PIC  X VALUE SPACES.         01240000
012500     05  PV-TABLE-ROW-FETCHED-CNT    PIC  9(9) VALUE 0.           01250000
012600     05  PV-DRIVER-WRITTEN-CNT       PIC  9(9) VALUE 0.           01260000
012700     05  PV-PROCESS-PO-COUNT         PIC  9(9) VALUE 0.           01270000
012800     05  PV-BYPASS-PO-COUNT          PIC  9(9) VALUE 0.           01280000
012900     05  PV-NULL-INDICATORS.                                      01290000
013000         10  PV-NULL-IND-INIT-INVC-ID                             01300000
013100                                     PIC S9(4) COMP               01310000
013200                                               VALUE 0.           01320000
013300     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01330000
013400     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01340000
013500     05  PV-DB2-TABLE-NAME-1         PIC X(18) VALUE SPACES.      01350000
013600     05  PV-DB2-TABLE-NAME-2         PIC X(18) VALUE SPACES.      01360000
013700     05  PV-DISPLAY-NTH-MULTIPLE     PIC 9(9)  VALUE 0.           01370000
013800     05  PV-DISPLAY-NTH-REMAINDER    PIC 9(9)  VALUE 0.           01380000
013900     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01390000
014000                                                                  01400000
014100     05  PV-TMST                     PIC X(26) VALUE SPACES.      01410000
014200     05  PV-TIMESTAMP-DETAIL                                      01420000
014300         REDEFINES                                                01430000
014400         PV-TMST.                                                 01440000
014500         10  PV-TIMESTAMP-19.                                     01450000
014600             15  PV-TMS-DATE.                                     01460000
014700                 20  PV-TMS-YEAR.                                 01470000
014800                     25  PV-TMS-CC   PIC X(02).                   01480000
014900                     25  PV-TMS-YY   PIC X(02).                   01490000
015000                 20  FILLER          PIC X(01).                   01500000
015100                 20  PV-TMS-MONTH    PIC X(02).                   01510000
015200                 20  FILLER          PIC X(01).                   01520000
015300                 20  PV-TMS-DAY      PIC X(02).                   01530000
015400             15  FILLER              PIC X(01).                   01540000
015500             15  PV-TMS-HOUR         PIC X(02).                   01550000
015600             15  FILLER              PIC X(01).                   01560000
015700             15  PV-TMS-MINUTE       PIC X(02).                   01570000
015800             15  FILLER              PIC X(01).                   01580000
015900             15  PV-TMS-SECOND       PIC X(02).                   01590000
016000         10  FILLER                  PIC X(01).                   01600000
016100         10  PV-TMS-MSECOND          PIC X(06).                   01610000
016200                                                                  01620000
016300                                                                  01630000
016400*---------------------------------------------------------------* 01640000
016500*  LAYOUT FOR THE CONTROL CARD.                                 * 01650000
016600*---------------------------------------------------------------* 01660000
016700 01  CC-CONTROL-CARD.                                             01670000
016800     05  CC-PROGRAM-ID            PIC X(08) VALUE SPACES.         01680000
016900     05  FILLER                   PIC X(01) VALUE SPACES.         01690000
017000     05  FILLER                   PIC X(11) VALUE 'PAY DATE = '.  01700000
017100     05  CC-PAY-DATE              PIC X(10) VALUE SPACES.         01710000
017200     05  FILLER                   PIC X(01) VALUE SPACES.         01720000
017300     05  FILLER                   PIC X(11) VALUE 'RLS DATE = '.  01730000
017400     05  CC-RLS-DATE              PIC X(10) VALUE SPACES.         01740000
017500                                                                  01750000
017600                                                                  01760000
017700*---------------------------------------------------------------* 01770000
017800*  RECORD LAYOUT FOR DRIVER FILE.                               * 01780000
017900*---------------------------------------------------------------* 01790000
018000     COPY AHRD001.                                                01800000
018100                                                                  01810000
018200                                                                  01820000
018300 01  DM-DISPLAY-MESSAGE.                                          01830000
018400     05  DM-01-10.                                                01840000
018500         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01850000
018600         10  FILLER                  PIC X(02) VALUE ': '.        01860000
018700     05  DM-11-80.                                                01870000
018800         10  FILLER                  PIC X(27) VALUE              01880000
018900                                    'BEGIN DRIVER FILE CREATION.'.01890000
019000         10  FILLER                  PIC X(01) VALUE SPACE.       01900000
019100         10  FILLER                  PIC X(42) VALUE ALL '*'.     01910000
019200     05  DM-81-120.                                               01920000
019300         10  FILLER                  PIC X(40) VALUE ALL '*'.     01930000
019400                                                                  01940000
019500 01  DP-DISPLAY-PROGRESS-MSG.                                     01950000
019600     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01960000
019700     05  FILLER                      PIC X(02) VALUE SPACE.       01970000
019800     05  DP-STATUS-DESCRIPTION       PIC X(13) VALUE SPACE.       01980000
019900     05  FILLER                      PIC X(04) VALUE ' AT '.      01990000
020000     05  DP-TIMESTAMP                PIC X(26) VALUE SPACE.       02000000
020100     05  FILLER                      PIC X(03) VALUE '.  '.       02010000
020200     05  FILLER                      PIC X(09) VALUE 'FETCHES: '. 02020000
020300     05  DP-TABLE-ROW-FETCHED-CNT    PIC ZZZ,ZZZ,ZZ9              02030000
020400                                               VALUE ZERO.        02040000
020500     05  FILLER                      PIC X(02) VALUE ', '.        02050000
020600     05  FILLER                      PIC X(09) VALUE 'WRITTEN: '. 02060000
020700     05  DP-DRIVER-WRITTEN-CNT       PIC ZZZ,ZZZ,ZZ9              02070000
020800                                               VALUE ZERO.        02080000
020900     05  FILLER                      PIC X(01) VALUE '.'.         02090000
021000                                                                  02100000
021100 01  ABEND-CODE                      PIC S9(04)                   02110000
021200                                               VALUE ZEROES       02120000
021300                                               COMP SYNC.         02130000
021400                                                                  02140000
021500*---------------------------------------------------------------* 02150000
021600*  DB2 FORMATTED MESSAGE AREA                                     02160000
021700*---------------------------------------------------------------* 02170000
021800     COPY DPWS004.                                                02180000
021900                                                                  02190000
022000*---------------------------------------------------------------* 02200000
022100*    DB2 AREA FOR TINVOIC                                       * 02210000
022200*---------------------------------------------------------------* 02220000
022300     EXEC SQL                                                     02230000
022400          INCLUDE TINVOIC                                         02240000
022500     END-EXEC.                                                    02250000
022600                                                                  02260000
022700*---------------------------------------------------------------* 02270000
022800*    DB2 AREA FOR SYSDUMMY                                      * 02280000
022900*---------------------------------------------------------------* 02290000
023000     EXEC SQL                                                     02300000
023100          INCLUDE SYSDUMMY                                        02310000
023200     END-EXEC.                                                    02320000
023300                                                                  02330000
023400*---------------------------------------------------------------* 02340000
023500*    DB2 AREA FOR COMMUNICATIONS                                * 02350000
023600*---------------------------------------------------------------* 02360000
023700     EXEC SQL                                                     02370000
023800          INCLUDE SQLCA                                           02380000
023900     END-EXEC.                                                    02390000
024000                                                                  02400000
024100*---------------------------------------------------------------* 02410000
024200*    DEFINE CURSOR FOR ACCESSING TINVOIC                        * 02420000
024300*---------------------------------------------------------------* 02430000
024400     EXEC SQL                                                     02440000
024500         DECLARE TABLE-CURSOR CURSOR FOR                          02450000
024600           SELECT B.PO_NBR                                        02460000
024700                , B.INVC_ID                                       02470000
024800                , B.PAYT_REQ_SEQ_NBR                              02480000
024900                , B.INVC_TYP_CDE                                  02490000
025000                , B.ENTR_MTHD_CDE                                 02500000
025100                , B.CRE_BY_USR_ID                                 02510000
025200                , B.BAR_CDE                                       02520000
025300                , B.SPLIT_TERMS_IND                               02530000
025400                , B.DTL_ENTR_IND                                  02540000
025500                , B.INVC_CART_CT                                  02550000
025600                , B.CRE_DTE                                       02560000
025700                , B.PPD_RVRSL_IND                                 02570000
025800                , B.INVC_DTE                                      02580000
025900                , B.GRO_COST_AMT                                  02590000
026000                , B.INVC_NET_COST_AMT                             02600000
026100                , B.RMIT_VND_ID                                   02610000
026200                , B.STR_NBR                                       02620000
026300                , B.HOLD_IND                                      02630000
026400                , B.DUE_DTE_SRC_CDE                               02640000
026500                , B.CALC_DUE_DTE                                  02650000
026600                , B.PAYT_DTE                                      02660000
026700                , B.AP_PRC_DTE                                    02670000
026800                , B.AP_PRC_CDE                                    02680000
026900                , B.PAYT_RLSE_TMST                                02690000
027000                , B.STATUS_CDE                                    02700000
027100                , B.STATUS_CHG_TMST                               02710000
027200                , B.DC_NBR                                        02720000
027300                , B.MTCH_LVL_CDE                                  02730000
027400             FROM TINVOIC B                                       02740000
027500            WHERE ((B.STATUS_CDE    = 'PD'                        02750000
027600                    AND B.PAYT_DTE <= :CC-PAY-DATE                02760001
027610                    AND B.PAYT_DTE <> '9999-09-09')               02761001
027700               OR                                                 02770000
027710                  (B.STATUS_CDE    = 'PD'                         02771001
027720                    AND DATE(B.STATUS_CHG_TMST) <= :CC-PAY-DATE)  02772001
027730               OR                                                 02773001
027800                  (B.STATUS_CDE    = 'OP'                         02780001
027900                    AND (B.PAYT_RLSE_TMST <= :PV-RLS-TMST         02790001
028000                      OR B.AP_PRC_DTE <= :PV-RLS-DATE)))          02800001
028100         ORDER BY B.PO_NBR                                        02810000
028200                 ,B.INVC_ID                                       02820000
028300         FOR FETCH ONLY                                           02830000
028400         WITH UR                                                  02840000
028500         OPTIMIZE FOR 1 ROW                                       02850000
028600     END-EXEC.                                                    02860000
028700                                                                  02870000
028800                                                                  02880000
028900 PROCEDURE DIVISION.                                              02890000
029000                                                                  02900000
029100 0000-PROGRAM-MAINLINE.                                           02910000
029200                                                                  02920000
029300     PERFORM 1000-INITIALIZE.                                     02930000
029400                                                                  02940000
029500     PERFORM 2000-GET-NEXT-FROM-CURSOR                            02950000
029600         UNTIL PS-TABLE-LOOP-DONE.                                02960000
029700                                                                  02970000
029800     PERFORM 6000-EOJ-ROUTINE.                                    02980000
029900     STOP RUN.                                                    02990000
030000                                                                  03000000
030100                                                                  03010000
030200******************************************************************03020000
030300*  INITIALIZATIONS                                               *03030000
030400******************************************************************03040000
030500 1000-INITIALIZE.                                                 03050000
030600                                                                  03060000
030700     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  03070000
030800     DISPLAY DM-DISPLAY-MESSAGE.                                  03080000
030900                                                                  03090000
031000     MOVE PC-BEGINNING            TO DP-STATUS-DESCRIPTION.       03100000
031100     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03110000
031200                                                                  03120000
031300     OPEN OUTPUT OUT-DRIVER-FILE.                                 03130000
031400                                                                  03140000
031500     ACCEPT CC-CONTROL-CARD.                                      03150000
031600     DISPLAY 'CONTROL CARD VALUES FOR THIS EXECUTION:'            03160000
031700     DISPLAY CC-CONTROL-CARD.                                     03170000
031800                                                                  03180000
031900     MOVE CC-RLS-DATE TO PV-RLS-DATE.                             03190000
032000     MOVE '-00.00.00.000001' TO PV-RLS-TIME.                      03200000
032100                                                                  03210000
032200     MOVE PC-JOINING-TBLS  TO DP-STATUS-DESCRIPTION.              03220000
032300     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03230000
032400     SET PS-TABLE-LOOP-NOT-DONE TO TRUE.                          03240000
032500     PERFORM 9100-OPEN-TABLE-CURSOR.                              03250000
032600     MOVE PC-JOIN-COMPLETE TO DP-STATUS-DESCRIPTION.              03260000
032700     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03270000
032800                                                                  03280000
032900     INITIALIZE DCLTINVOIC                                        03290000
033000                AH001-DRIVER-RECORD-LAYOUT.                       03300000
033100     PERFORM 9110-FETCH-TABLE-CURSOR.                             03310000
033200                                                                  03320000
033300     IF PS-TABLE-LOOP-DONE                                        03330000
033400        DISPLAY 'NO INVOICES SELECTED FROM CURSOR'                03340000
033500     END-IF.                                                      03350000
033600                                                                  03360000
033700******************************************************************03370000
033800*  FETCH NEXT FROM CURSOR & WRITE OUTPUT DRIVER FILE RECORD.     *03380000
033900******************************************************************03390000
034000 2000-GET-NEXT-FROM-CURSOR.                                       03400000
034100                                                                  03410000
034200     MOVE INVOIC-PO-NBR TO DISPLAY-PO-NBR.                        03420000
034300*    DISPLAY 'FETCHED PO = ' DISPLAY-PO-NBR.                      03430000
034400     MOVE PV-SAVE-PO-NBR TO DISPLAY-PO-NBR.                       03440000
034500*    DISPLAY 'SAVED   PO = ' DISPLAY-PO-NBR.                      03450000
034600                                                                  03460000
034700     IF  INVOIC-PO-NBR = PV-SAVE-PO-NBR                           03470000
034800         IF  BYPASS-THIS-PO                                       03480000
034900             CONTINUE                                             03490000
035000         ELSE                                                     03500000
035100             PERFORM 2010-POPULATE-DRIVER-RECORD                  03510000
035200             PERFORM 9650-WRITE-DRIVER-RECORD                     03520000
035300             PERFORM 2100-CHECK-PGM-PROGRESS                      03530000
035400         END-IF                                                   03540000
035500     ELSE                                                         03550000
035600         MOVE INVOIC-PO-NBR TO PV-SAVE-PO-NBR                     03560000
035700         PERFORM 3000-CHECK-FOR-OTHER-INVOICES                    03570000
035800         IF  BYPASS-THIS-PO                                       03580000
035900            CONTINUE                                              03590000
036000         ELSE                                                     03600000
036100             PERFORM 2010-POPULATE-DRIVER-RECORD                  03610000
036200             PERFORM 9650-WRITE-DRIVER-RECORD                     03620000
036300             PERFORM 2100-CHECK-PGM-PROGRESS                      03630000
036400         END-IF                                                   03640000
036500     END-IF.                                                      03650000
036600                                                                  03660000
036700     INITIALIZE DCLTINVOIC                                        03670000
036800                AH001-DRIVER-RECORD-LAYOUT.                       03680000
036900     PERFORM 9110-FETCH-TABLE-CURSOR.                             03690000
037000                                                                  03700000
037100******************************************************************03710000
037200*  MOVE COLUMNS FROM TABLES TO FIELDS IN DRIVER FILE RECORD.     *03720000
037300******************************************************************03730000
037400 2010-POPULATE-DRIVER-RECORD.                                     03740000
037500                                                                  03750000
037600     INITIALIZE AH001-DRIVER-RECORD-LAYOUT.                       03760000
037700                                                                  03770000
037800     MOVE INVOIC-PO-NBR            TO AH001-B-PO-NBR.             03780000
037900     MOVE INVOIC-INVC-ID           TO AH001-B-INVC-ID.            03790000
038000     MOVE INVOIC-PAYT-REQ-SEQ-NBR  TO AH001-B-PAYT-REQ-SEQ-NBR.   03800000
038100     MOVE INVOIC-INVC-TYP-CDE      TO AH001-B-INVC-TYP-CDE.       03810000
038200     MOVE INVOIC-ENTR-MTHD-CDE     TO AH001-B-ENTR-MTHD-CDE.      03820000
038300     MOVE INVOIC-CRE-BY-USR-ID     TO AH001-B-CRE-BY-USR-ID.      03830000
038400     MOVE INVOIC-BAR-CDE           TO AH001-B-BAR-CDE.            03840000
038500     MOVE INVOIC-SPLIT-TERMS-IND   TO AH001-B-SPLIT-TERMS-IND.    03850000
038600     MOVE INVOIC-DTL-ENTR-IND      TO AH001-B-DTL-ENTR-IND.       03860000
038700     MOVE INVOIC-INVC-CART-CT      TO AH001-B-INVC-CART-CT.       03870000
038800     MOVE INVOIC-CRE-DTE           TO AH001-B-CRE-DTE.            03880000
038900     MOVE INVOIC-PPD-RVRSL-IND     TO AH001-B-PPD-RVRSL-IND.      03890000
039000     MOVE INVOIC-INVC-DTE          TO AH001-B-INVC-DTE.           03900000
039100     MOVE INVOIC-GRO-COST-AMT      TO AH001-B-GRO-COST-AMT.       03910000
039200     MOVE INVOIC-INVC-NET-COST-AMT TO AH001-B-INVC-NET-COST-AMT.  03920000
039300     MOVE INVOIC-RMIT-VND-ID       TO AH001-B-RMIT-VND-ID.        03930000
039400     MOVE INVOIC-STR-NBR           TO AH001-B-STR-NBR.            03940000
039500     MOVE INVOIC-HOLD-IND          TO AH001-B-HOLD-IND.           03950000
039600     MOVE INVOIC-DUE-DTE-SRC-CDE   TO AH001-B-DUE-DTE-SRC-CDE.    03960000
039700     MOVE INVOIC-CALC-DUE-DTE      TO AH001-B-CALC-DUE-DTE.       03970000
039800     MOVE INVOIC-PAYT-DTE          TO AH001-B-PAYT-DTE.           03980000
039900     MOVE INVOIC-AP-PRC-DTE        TO AH001-B-AP-PRC-DTE.         03990000
040000     MOVE INVOIC-AP-PRC-CDE        TO AH001-B-AP-PRC-CDE.         04000000
040100     MOVE INVOIC-PAYT-RLSE-TMST    TO AH001-B-PAYT-RLSE-TMST.     04010000
040200     MOVE INVOIC-STATUS-CDE        TO AH001-B-STATUS-CDE.         04020000
040300     MOVE INVOIC-STATUS-CHG-TMST   TO AH001-B-STATUS-CHG-TMST.    04030000
040400     MOVE INVOIC-DC-NBR            TO AH001-B-DC-NBR.             04040000
040500     MOVE INVOIC-MTCH-LVL-CDE      TO AH001-B-MTCH-LVL-CDE.       04050000
040600                                                                  04060000
040700******************************************************************04070000
040800*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *04080000
040900*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *04090000
041000*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *04100000
041100******************************************************************04110000
041200 2100-CHECK-PGM-PROGRESS.                                         04120000
041300     DIVIDE    PV-DRIVER-WRITTEN-CNT                              04130000
041400         BY        PC-HOW-OFTEN-TO-DISPLAY                        04140000
041500         GIVING    PV-DISPLAY-NTH-MULTIPLE                        04150000
041600         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      04160000
041700                                                                  04170000
041800     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           04180000
041900         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      04190000
042000         PERFORM 6200-DISPLAY-PGM-PROGRESS                        04200000
042100     END-IF.                                                      04210000
042200                                                                  04220000
042300******************************************************************04230000
042400*  CHECK FOR OTHER INVOICES FOR THIS PO THAT DO NOT MEET THE     *04240000
042500*  ARCHIVE CRITERIA.                                             *04250000
042600******************************************************************04260000
042700 3000-CHECK-FOR-OTHER-INVOICES.                                   04270000
042800                                                                  04280000
042900     EXEC SQL                                                     04290000
043000       SELECT '1'                                                 04300000
043100        INTO  :PV-ONE                                             04310000
043200         FROM SYSIBM.SYSDUMMY1 X                                  04320000
043300        WHERE EXISTS (SELECT 1                                    04330000
043400               FROM TINVOIC B                                     04340000
043410              WHERE B.PO_NBR         = :PV-SAVE-PO-NBR            04341000
043420                AND ((B.STATUS_CDE   = 'PD'                       04342000
043430                      AND B.PAYT_DTE > :CC-PAY-DATE               04343001
043431                      AND B.PAYT_DTE <> '9999-09-09')             04343101
043432                 OR                                               04343201
043433                    (B.STATUS_CDE    = 'PD'                       04343301
043434                      AND DATE(B.STATUS_CHG_TMST) > :CC-PAY-DATE) 04343401
043440                 OR                                               04344000
043450                    (B.STATUS_CDE   = 'OP'                        04345000
043460                      AND B.AP_PRC_DTE > :PV-RLS-DATE))           04346000
043470***              OR                                               04347000
043480***                 ((B.STATUS_CDE   = 'OP'                       04348000
043481***                   AND ((B.PAYT_RLSE_TMST > :PV-RLS-TMST)      04348100
043482***                   OR (B.AP_PRC_DTE > :PV-RLS-DATE))))         04348200
043483***              OR  B.STATUS_CDE IN ('EN','RC','IB','OB'))       04348300
043484                 AND X.IBMREQD = X.IBMREQD)                       04348400
043485     END-EXEC.                                                    04348500
043486                                                                  04348600
043487                                                                  04348700
043488     EVALUATE TRUE                                                04348800
043489         WHEN SQLCODE = ZERO                                      04348900
043490         WHEN SQLCODE = -811                                      04349000
043500              SET BYPASS-THIS-PO TO TRUE                          04350000
043600              ADD +1 TO PV-BYPASS-PO-COUNT                        04360000
043601              MOVE PV-SAVE-PO-NBR TO DISPLAY-PO-NBR               04360100
043610              DISPLAY 'BYPASS PO = ' DISPLAY-PO-NBR               04361000
043700         WHEN SQLCODE = +100                                      04370000
043800              SET PROCESS-THIS-PO TO TRUE                         04380000
043900              ADD +1 TO PV-PROCESS-PO-COUNT                       04390000
044000         WHEN SQLWARN0 NOT EQUAL SPACE                            04400000
044100         WHEN SQLCODE  NOT EQUAL ZERO                             04410000
044200              MOVE '3000-CHECK-FOR-OTHER-INVOICES'                04420000
044300                                 TO PV-PARAGRAPH-NAME             04430000
044400              MOVE 'SELECT OTHER '                                04440000
044500                                 TO PV-DB2-OPERATION-MSG-1        04450000
044600              MOVE 'TINVOIC'     TO PV-DB2-TABLE-NAME-1           04460000
044700              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           04470000
044800              PERFORM 9999-DB2-ABEND                              04480000
044900     END-EVALUATE.                                                04490000
045000                                                                  04500000
045100******************************************************************04510000
045200*  CLOSE CURSOR & OUTPUT FILE, DISPLAY END OF RUN MESSAGE.       *04520000
045300******************************************************************04530000
045400 6000-EOJ-ROUTINE.                                                04540000
045500                                                                  04550000
045600     MOVE PC-ENDING  TO  DP-STATUS-DESCRIPTION.                   04560000
045700                                                                  04570000
045800     CLOSE OUT-DRIVER-FILE.                                       04580000
045900                                                                  04590000
046000     PERFORM 9130-CLOSE-TABLE-CURSOR.                             04600000
046100                                                                  04610000
046200     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           04620000
046300                                                                  04630000
046400     DISPLAY 'TOTAL PO NUMBERS PROCESSED = ' PV-PROCESS-PO-COUNT. 04640000
046500     DISPLAY 'TOTAL PO NUMBERS BYPASSED = ' PV-BYPASS-PO-COUNT.   04650000
046600                                                                  04660000
046700******************************************************************04670000
046800*  DISPLAY PROGRAM PROGRESS.                                     *04680000
046900******************************************************************04690000
047000 6200-DISPLAY-PGM-PROGRESS.                                       04700000
047100                                                                  04710000
047200     EXEC SQL                                                     04720000
047300          SET :PV-TMST = CURRENT TIMESTAMP                        04730000
047400     END-EXEC.                                                    04740000
047500                                                                  04750000
047600     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                04760000
047700     MOVE PV-TMST                   TO DP-TIMESTAMP.              04770000
047800     MOVE PV-TABLE-ROW-FETCHED-CNT  TO DP-TABLE-ROW-FETCHED-CNT.  04780000
047900     MOVE PV-DRIVER-WRITTEN-CNT     TO DP-DRIVER-WRITTEN-CNT.     04790000
048000                                                                  04800000
048100     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             04810000
048200                                                                  04820000
048300                                                                  04830000
048400******************************************************************04840000
048500*  OPEN   TABLE CURSOR                                           *04850000
048600******************************************************************04860000
048700 9100-OPEN-TABLE-CURSOR.                                          04870000
048800     EXEC SQL                                                     04880000
048900          OPEN TABLE-CURSOR                                       04890000
049000     END-EXEC.                                                    04900000
049100                                                                  04910000
049200     EVALUATE TRUE                                                04920000
049300         WHEN SQLCODE = ZERO                                      04930000
049400              CONTINUE                                            04940000
049500         WHEN SQLCODE = +100                                      04950000
049600              SET PS-TABLE-LOOP-DONE TO TRUE                      04960000
049700              MOVE '9100-OPEN-TABLE-CURSOR'                       04970000
049800                                 TO PV-PARAGRAPH-NAME             04980000
049900              MOVE 'OPEN TABLE CURSOR - NO ROWS SELECTED'         04990000
050000                                 TO PV-DB2-OPERATION-MSG-1        05000000
050100              MOVE 'TINVOIC'     TO PV-DB2-TABLE-NAME-1           05010000
050200              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           05020000
050300              PERFORM 9999-DB2-ABEND                              05030000
050400         WHEN SQLWARN0 NOT EQUAL SPACE                            05040000
050500         WHEN SQLCODE  NOT EQUAL ZERO                             05050000
050600              MOVE '9100-OPEN-TABLE-CURSOR'                       05060000
050700                                 TO PV-PARAGRAPH-NAME             05070000
050800              MOVE 'OPEN TABLE CURSOR'                            05080000
050900                                 TO PV-DB2-OPERATION-MSG-1        05090000
051000              MOVE 'TINVOIC'     TO PV-DB2-TABLE-NAME-1           05100000
051100              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           05110000
051200              PERFORM 9999-DB2-ABEND                              05120000
051300     END-EVALUATE.                                                05130000
051400                                                                  05140000
051500                                                                  05150000
051600******************************************************************05160000
051700*  FETCH TABLE CURSOR                                            *05170000
051800******************************************************************05180000
051900 9110-FETCH-TABLE-CURSOR.                                         05190000
052000     EXEC SQL                                                     05200000
052100         FETCH TABLE-CURSOR                                       05210000
052200          INTO  :INVOIC-PO-NBR                                    05220000
052300               ,:INVOIC-INVC-ID                                   05230000
052400               ,:INVOIC-PAYT-REQ-SEQ-NBR                          05240000
052500               ,:INVOIC-INVC-TYP-CDE                              05250000
052600               ,:INVOIC-ENTR-MTHD-CDE                             05260000
052700               ,:INVOIC-CRE-BY-USR-ID                             05270000
052800               ,:INVOIC-BAR-CDE                                   05280000
052900               ,:INVOIC-SPLIT-TERMS-IND                           05290000
053000               ,:INVOIC-DTL-ENTR-IND                              05300000
053100               ,:INVOIC-INVC-CART-CT                              05310000
053200               ,:INVOIC-CRE-DTE                                   05320000
053300               ,:INVOIC-PPD-RVRSL-IND                             05330000
053400               ,:INVOIC-INVC-DTE                                  05340000
053500               ,:INVOIC-GRO-COST-AMT                              05350000
053600               ,:INVOIC-INVC-NET-COST-AMT                         05360000
053700               ,:INVOIC-RMIT-VND-ID                               05370000
053800               ,:INVOIC-STR-NBR                                   05380000
053900               ,:INVOIC-HOLD-IND                                  05390000
054000               ,:INVOIC-DUE-DTE-SRC-CDE                           05400000
054100               ,:INVOIC-CALC-DUE-DTE                              05410000
054200               ,:INVOIC-PAYT-DTE                                  05420000
054300               ,:INVOIC-AP-PRC-DTE                                05430000
054400               ,:INVOIC-AP-PRC-CDE                                05440000
054500               ,:INVOIC-PAYT-RLSE-TMST                            05450000
054600               ,:INVOIC-STATUS-CDE                                05460000
054700               ,:INVOIC-STATUS-CHG-TMST                           05470000
054800               ,:INVOIC-DC-NBR                                    05480000
054900               ,:INVOIC-MTCH-LVL-CDE                              05490000
055000     END-EXEC.                                                    05500000
055100                                                                  05510000
055200     EVALUATE TRUE                                                05520000
055300         WHEN SQLCODE = ZERO                                      05530000
055400              ADD +1                 TO PV-TABLE-ROW-FETCHED-CNT  05540000
055500         WHEN SQLCODE = +100                                      05550000
055600              SET PS-TABLE-LOOP-DONE TO TRUE                      05560000
055700         WHEN SQLWARN0 NOT EQUAL SPACE                            05570000
055800         WHEN SQLCODE NOT EQUAL ZERO                              05580000
055900              MOVE '9110-FETCH-TABLE-CURSOR'                      05590000
056000                                 TO PV-PARAGRAPH-NAME             05600000
056100              MOVE 'FETCH TABLE CURSOR'                           05610000
056200                                 TO PV-DB2-OPERATION-MSG-1        05620000
056300              MOVE 'TINVOIC'     TO PV-DB2-TABLE-NAME-1           05630000
056400              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           05640000
056500              PERFORM 9999-DB2-ABEND                              05650000
056600     END-EVALUATE.                                                05660000
056700                                                                  05670000
056800                                                                  05680000
056900******************************************************************05690000
057000*  CLOSE TABLE CURSOR                                            *05700000
057100******************************************************************05710000
057200 9130-CLOSE-TABLE-CURSOR.                                         05720000
057300     EXEC SQL                                                     05730000
057400          CLOSE TABLE-CURSOR                                      05740000
057500     END-EXEC.                                                    05750000
057600                                                                  05760000
057700     EVALUATE TRUE                                                05770000
057800         WHEN SQLCODE = ZERO                                      05780000
057900              CONTINUE                                            05790000
058000         WHEN SQLWARN0 NOT EQUAL SPACE                            05800000
058100         WHEN SQLCODE NOT EQUAL ZERO                              05810000
058200              MOVE '9130-CLOSE-TABLE-CURSOR'                      05820000
058300                                 TO PV-PARAGRAPH-NAME             05830000
058400              MOVE 'CLOSE TABLE CURSOR'                           05840000
058500                                 TO PV-DB2-OPERATION-MSG-1        05850000
058600              MOVE 'TINVOIC'     TO PV-DB2-TABLE-NAME-1           05860000
058700              MOVE SPACES        TO PV-DB2-TABLE-NAME-2           05870000
058800              PERFORM 9999-DB2-ABEND                              05880000
058900     END-EVALUATE.                                                05890000
059000                                                                  05900000
059100                                                                  05910000
059200                                                                  05920000
059300                                                                  05930000
059400******************************************************************05940000
059500*  WRITE A RECORD TO THE DRIVER FILE                             *05950000
059600******************************************************************05960000
059700 9650-WRITE-DRIVER-RECORD.                                        05970000
059800     WRITE  OUT-DRIVER-RECORD  FROM  AH001-DRIVER-RECORD-LAYOUT.  05980000
059900     ADD +1 TO PV-DRIVER-WRITTEN-CNT.                             05990000
060000                                                                  06000000
060100                                                                  06010000
060200                                                                  06020000
060300******************************************************************06030000
060400*  DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT  *06040000
060500*  AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN             *06050000
060600*  SQL ERROR OR WARNING CODE OCCURS.                             *06060000
060700******************************************************************06070000
060800 9999-DB2-ABEND.                                                  06080000
060900     DISPLAY PC-CURRENT-PROGRAM-NAME                              06090000
061000             ' 9999-DB2-ABEND'.                                   06100000
061100     DISPLAY PC-CURRENT-PROGRAM-NAME                              06110000
061200             ' ** ABEND           **'.                            06120000
061300     DISPLAY PC-CURRENT-PROGRAM-NAME                              06130000
061400             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       06140000
061500     DISPLAY PC-CURRENT-PROGRAM-NAME                              06150000
061600             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME-1.     06160000
061700     DISPLAY PC-CURRENT-PROGRAM-NAME                              06170000
061800             ' **                 ** = ' PV-DB2-TABLE-NAME-2.     06180000
061900     DISPLAY PC-CURRENT-PROGRAM-NAME                              06190000
062000             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  06200000
062100                                                                  06210000
062200     DISPLAY PC-CURRENT-PROGRAM-NAME                              06220000
062300             ' ** SQLCODE         ** = ' SQLCODE.                 06230000
062400     MOVE SQLCODE TO PV-SQLCODE.                                  06240000
062500     DISPLAY PC-CURRENT-PROGRAM-NAME                              06250000
062600             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          06260000
062700                                                                  06270000
062800     DISPLAY PC-CURRENT-PROGRAM-NAME                              06280000
062900             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            06290000
063000                                                                  06300000
063100                                                                  06310000
063200*----------------------------------------------------------------*06320000
063300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *06330000
063400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *06340000
063500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *06350000
063600* FORMAT.                                                        *06360000
063700*----------------------------------------------------------------*06370000
063800     COPY DPPD004.                                                06380000
063900                                                                  06390000
064000     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     06400000
064100     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           06410000
064200                                                                  06420000
064300                                                                  06430000
064400*----------------------------------------------------------------*06440000
064500* CALL ABEND                                                     *06450000
064600*----------------------------------------------------------------*06460000
064700     MOVE +4013                  TO ABEND-CODE.                   06470000
064800     CALL 'ILBOABN0' USING ABEND-CODE.                            06480000
064900*                                                                 06490000
