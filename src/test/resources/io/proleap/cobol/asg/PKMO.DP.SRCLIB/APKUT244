000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.         APKUT244.                                    00020000
000300 AUTHOR.             CHRIS BOEHNLEIN.                             00030000
000500 DATE-WRITTEN.       04-21-98.                                    00050000
000510                                                                  00051000
000600****************************************************************  00060000
000610* COBOL II WITH SQL                                            *  00061000
000620*--------------------------------------------------------------*  00062000
000630* DATA EXTRACT FOR CREATION OF MONTHLY IMPORT REPORTS          *  00063000
000640*--------------------------------------------------------------*  00064000
000650* THIS PROGRAM EXTRACTS PO AND DATE DATA FROM THE JOURNAL      *  00065000
000651* ADJUSTMENT HEADER TABLE TO CREATE AN OUTPUT FILE THAT WILL   *  00065100
000660* BE USED TO PRODUCE THE MONTHLY IMPORT REPORTS.               *  00066005
000691*--------------------------------------------------------------*  00069100
000692* DB2 TABLES:                                                  *  00069200
000693*  1. JOURNAL ADJUSTMENT HEADER TABLE          (TADJRNL)       *  00069300
000694*                                                              *  00069400
000695* INPUT:                                                       *  00069500
000696*  1. DETAIL IMPORT FILE                       (APRD047)       *  00069600
000698*                                                              *  00069800
000699* OUTPUT:                                                      *  00069900
000700*  1. DETAIL IMPORT FILE                       (APRD047)       *  00070000
000701*--------------------------------------------------------------*  00070100
000702* PROGRAM CHANGES:                                             *  00070200
000703*                                                              *  00070300
000704* DATE 08/2005                                                 *  00070403
000705*   CHANGE MADE: INITIAL IMPLEMENTATION                        *  00070502
000707*   MADE BY: KRYSTEN LEARY                  WR/IR: WR24554     *  00070700
000708****************************************************************  00070800
000709                                                                  00070900
000710 ENVIRONMENT DIVISION.                                            00071000
000800 CONFIGURATION SECTION.                                           00080000
000810                                                                  00081000
000900 SOURCE-COMPUTER.    IBM-3090.                                    00090000
001000 OBJECT-COMPUTER.    IBM-3090.                                    00100000
001100                                                                  00110000
001200 INPUT-OUTPUT SECTION.                                            00120000
001300 FILE-CONTROL.                                                    00130000
001400                                                                  00140000
001500     SELECT DETAIL-IMPORT-PJ-FILE        ASSIGN TO INP01.         00150000
001700     SELECT WORK-REPORT-FILE             ASSIGN TO OUT01.         00170000
001900                                                                  00190000
002000 DATA DIVISION.                                                   00200000
002200 FILE SECTION.                                                    00220000
002300                                                                  00230000
002400 FD  DETAIL-IMPORT-PJ-FILE                                        00240000
002500     RECORDING MODE IS F                                          00250000
002600     LABEL RECORDS ARE STANDARD                                   00260000
002800     BLOCK CONTAINS 0  RECORDS                                    00280000
002900     DATA RECORD IS DETAIL-IMPORT-PJ-RECORD.                      00290000
003000 01  DETAIL-IMPORT-PJ-RECORD       PIC X(170).                    00300000
003100                                                                  00310000
003200 FD  WORK-REPORT-FILE                                             00320000
003300     RECORDING MODE IS F                                          00330000
003400     LABEL RECORDS ARE STANDARD                                   00340000
003500     RECORD CONTAINS 170 CHARACTERS                               00350000
003600     BLOCK CONTAINS 0  RECORDS                                    00360000
003700     DATA RECORD IS WORK-REPORT-RECORD.                           00370000
003800 01  WORK-REPORT-RECORD            PIC X(170).                    00380000
003900                                                                  00390000
004100 WORKING-STORAGE SECTION.                                         00410000
004200*--------------------------------------------------------------*  00420000
004210* GL EXTRACT FILE LAYOUT (INPUT/OUTPUT)                        *  00421000
004220*--------------------------------------------------------------*  00422000
004300     COPY APRD047.                                                00430000
004301                                                                  00430100
004410*--------------------------------------------------------------*  00441000
004420* SQLCA FORMATTED MESSAGE AREA                                 *  00442000
004430*--------------------------------------------------------------*  00443000
004500     COPY DPWS004.                                                00450000
004600                                                                  00460000
004610*--------------------------------------------------------------*  00461000
004620* DB2 COMMUNICATIONS AREA                                      *  00462000
004630*--------------------------------------------------------------*  00463000
004700     COPY SQLCA2.                                                 00470000
004900                                                                  00490000
005503 01  PROGRAM-CONSTANTS.                                           00550300
005504     05  PC-PROGRAM-NAME            PIC X(08)  VALUE 'APKUT244'.  00550400
005505                                                                  00550500
005506 01  PS-PROGRAM-SWITCHES.                                         00550600
005507     05  END-OF-FILE-NO-IMPORT      PIC X(01)  VALUE 'N'.         00550700
005508         88  END-OF-FILE-IMPORT                VALUE 'Y'.         00550800
005510                                                                  00551000
005513 01  PV-PROGRAM-COUNTERS.                                         00551300
005514     05  PV-IMPORT-READ-CNT         PIC 9(08)  VALUE ZEROES.      00551400
005515     05  PV-WRITTEN-CNT             PIC 9(08)  VALUE ZEROES.      00551500
005516                                                                  00551600
005517 01  ACCOUNT-TABLE.                                               00551700
005518     05 ACCT-TABLE OCCURS 100000 TIMES INDEXED BY X1.             00551800
005519        10 ACCT-PO                  PIC X(07)  VALUE SPACES.      00551900
005520        10 ACCT-DATE                PIC 9(05)  VALUE ZEROS.       00552000
005521                                                                  00552100
005526 01 WS-WORKING-STORAGE.                                           00552600
005527    05  WS-DB2-ACCOUNT.                                           00552700
005529        10  WS-DB2-ACCT             PIC X(05)  VALUE SPACES.      00552900
005530    05  WS-ENTER-DATE               PIC X(10)  VALUE SPACES.      00553000
005532    05  WS-DETAIL-PONUM             PIC 9(09)  VALUE ZERO.        00553200
005561                                                                  00556100
005619*--------------------------------------------------------------*  00561900
005620* ABEND CODE AREA                                              *  00562000
005621*--------------------------------------------------------------*  00562100
005622 01  ABEND-CODE                     PIC S9(04) VALUE ZERO.        00562200
005623     88  AC-BAD-DATA                           VALUE +4003.       00562300
005624     88  AC-DB2-ERROR                          VALUE +4013.       00562400
005625                                                                  00562500
005626 01  ABEND-AREAS.                                                 00562600
005627     05  AA-ABEND-LIT               PIC X(40)  VALUE              00562700
005628           '*****       ABEND'.                                   00562800
005629     05  AA-PROGRAM-LIT             PIC X(40)  VALUE              00562900
005630             '*****   PROGRAM:         '.                         00563000
005631     05  AA-PARAGRAPH-LIT.                                        00563100
005632         10  FILLER                 PIC X(17)  VALUE              00563200
005633             '***** PARAGRAPH: '.                                 00563300
005634         10  AA-PARAGRAPH-NAME      PIC X(35)  VALUE SPACES.      00563400
005635     05  AA-MESSAGE-LINE.                                         00563500
005636         10  FILLER                 PIC X(06)  VALUE '*****'.     00563600
005637         10  AA-MESSAGE             PIC X(127) VALUE SPACES.      00563700
005638     05  AA-DB2-ERROR-LIT           PIC X(40)  VALUE              00563800
005639             '*****    DB2 ERROR'.                                00563900
005640     05  AA-DB2-OPERATION-LIT.                                    00564000
005641         10  FILLER                 PIC X(17)  VALUE              00564100
005642             '***** OPERATION: '.                                 00564200
005643         10  AA-DB2-OPERATION.                                    00564300
005644             15  AA-DB2-OP-1        PIC X(25)  VALUE SPACES.      00564400
005645             15  AA-DB2-OP-2        PIC X(25)  VALUE SPACES.      00564500
005646     05  AA-DB2-TABLE-1             PIC X(08)  VALUE SPACES.      00564600
005647     05  AA-DB2-TABLE-2             PIC X(08)  VALUE SPACES.      00564700
005648     05  AA-DB2-TABLE-3             PIC X(08)  VALUE SPACES.      00564800
005650                                                                  00565000
005651*--------------------------------------------------------------*  00565100
005652* JOURNAL ADJUSTMENT JOURNAL TABLE                             *  00565200
005653*--------------------------------------------------------------*  00565300
005654     EXEC SQL                                                     00565400
005655        INCLUDE TADJRNL                                           00565500
005656     END-EXEC.                                                    00565600
005657                                                                  00565700
005658*--------------------------------------------------------------*  00565800
005660* DB2 COMMUNICATIONS                                           *  00566000
005700*--------------------------------------------------------------*  00570000
005900     EXEC SQL                                                     00590000
006000        INCLUDE SQLCA                                             00600000
006100     END-EXEC.                                                    00610000
006200                                                                  00620000
024200*---------------------------*                                     02420000
024300 PROCEDURE DIVISION.                                              02430000
024400*---------------------------*                                     02440000
024500 0000-MAINLINE-PROCESSING.                                        02450000
024600                                                                  02460000
024700     PERFORM B100-INITIALIZATION.                                 02470000
024800     PERFORM B200-PROCESS-EXTRACT                                 02480000
024900             UNTIL END-OF-FILE-IMPORT.                            02490000
024910     PERFORM B300-TERMINATION.                                    02491000
025200     STOP RUN.                                                    02520000
025210                                                                  02521000
025300*--------------------------------------------------------------*  02530000
025310* INITIALIZATION PROCESSING                                    *  02531000
025320*--------------------------------------------------------------*  02532000
025400 B100-INITIALIZATION.                                             02540000
025500                                                                  02550000
025600     OPEN INPUT  DETAIL-IMPORT-PJ-FILE                            02560000
025700          OUTPUT WORK-REPORT-FILE.                                02570000
025800                                                                  02580000
025810     INITIALIZE DCLTADJRNL.                                       02581000
025820                                                                  02582000
025900     PERFORM R100-READ-IMPORT-PJ-FILE.                            02590000
026000                                                                  02600000
026010*--------------------------------------------------------------*  02601000
026020* THIS ROUTINE HOLDS THE MAIN LOGIC FOR PROCESSING THE OUTPUT  *  02602000
026030*--------------------------------------------------------------*  02603000
026100 B200-PROCESS-EXTRACT.                                            02610000
026200                                                                  02620000
026300     MOVE AP047-VND-NBR            TO ADJRNL-VND-NBR.             02630000
026400     MOVE AP047-DOC-NBR            TO ADJRNL-DOC-NBR.             02640000
026500     MOVE AP047-DOC-DTE            TO ADJRNL-DOC-DTE.             02650000
026600     MOVE AP047-AP-TRN-CDE         TO ADJRNL-AP-TRN-CDE.          02660000
026700                                                                  02670000
026800     PERFORM S100-SELECT-PO.                                      02680000
026900                                                                  02690000
027000     INITIALIZE AP047-ENT-NME-DESC.                               02700000
027100     MOVE ADJRNL-PO-NBR            TO AP047-ENT-NME-DESC (1:9).   02710000
027200     MOVE WS-ENTER-DATE            TO AP047-ENT-NME-DESC (10:10). 02720000
027300     PERFORM W100-WRITE-WORK-REPORT-FILE.                         02730000
027400     PERFORM R100-READ-IMPORT-PJ-FILE.                            02740000
027500                                                                  02750000
027601*--------------------------------------------------------------*  02760100
027602* END OF PROGRAM PROCESSING                                    *  02760200
027603*--------------------------------------------------------------*  02760300
027604 B300-TERMINATION.                                                02760400
027605                                                                  02760500
027606     DISPLAY '************************************************'.  02760600
027607     DISPLAY '**      APKUT244 RECORD COUNTS                **'.  02760700
027608     DISPLAY '************************************************'.  02760800
027609     DISPLAY ' TOTAL IMPORT RECORDS READ = ' PV-IMPORT-READ-CNT.  02760900
027611     DISPLAY ' TOTAL RECORDS WRITTEN     = ' PV-WRITTEN-CNT.      02761100
027612     DISPLAY '************************************************'.  02761200
027613     DISPLAY '************************************************'.  02761300
027614                                                                  02761400
027616     CLOSE DETAIL-IMPORT-PJ-FILE                                  02761600
027618           WORK-REPORT-FILE.                                      02761800
027619                                                                  02761900
027621*--------------------------------------------------------------*  02762100
027622* SELECTS THE PURCHASE ORDER AND DATE FROM THE TADJRNL TABLE   *  02762200
027630*--------------------------------------------------------------*  02763000
027700 S100-SELECT-PO.                                                  02770000
027800                                                                  02780000
027900     EXEC SQL                                                     02790000
028000         SELECT PO_NBR                                            02800000
028100              , DATE(ENTR_TMST)                                   02810000
028200          INTO  :ADJRNL-PO-NBR                                    02820000
028300              , :WS-ENTER-DATE                                    02830001
028400         FROM TADJRNL                                             02840000
028500         WHERE VND_NBR = :ADJRNL-VND-NBR                          02850000
028600           AND DOC_NBR = :ADJRNL-DOC-NBR                          02860000
028700           AND DOC_DTE = :ADJRNL-DOC-DTE                          02870000
028800           AND AP_TRN_CDE = :ADJRNL-AP-TRN-CDE                    02880000
028900     END-EXEC.                                                    02890000
029000                                                                  02900000
029100     EVALUATE TRUE                                                02910000
029200       WHEN SQLCODE < ZERO                                        02920000
029300       WHEN SQLCODE > ZERO                                        02930000
029400           MOVE 'S100-SELECT-PO'         TO AA-PARAGRAPH-NAME     02940000
029600           MOVE 'UNSUCCESSFUL SELECT'    TO AA-DB2-OPERATION      02960000
029800           MOVE 'TADJRNL'                TO AA-DB2-TABLE-1        02980000
029810           MOVE SPACES                   TO AA-DB2-TABLE-2        02981000
029820                                            AA-DB2-TABLE-3        02982000
029900           PERFORM Z999-DB2-ABEND                                 02990000
030000     END-EVALUATE.                                                03000000
030100                                                                  03010000
030110*--------------------------------------------------------------*  03011000
030120* READS THE INPUT FILE                                         *  03012000
030130*--------------------------------------------------------------*  03013000
030200 R100-READ-IMPORT-PJ-FILE.                                        03020000
030300                                                                  03030000
030400     READ DETAIL-IMPORT-PJ-FILE INTO AP047-GL-EXTRACT-FILE        03040000
030500           AT END                                                 03050000
030510              SET END-OF-FILE-IMPORT     TO TRUE                  03051000
030520           NOT AT END                                             03052000
030530              ADD 1                      TO PV-IMPORT-READ-CNT.   03053000
030600                                                                  03060000
030700     IF END-OF-FILE-IMPORT                                        03070000
030800        MOVE 999999999                   TO WS-DETAIL-PONUM       03080000
030900     END-IF.                                                      03090000
031000                                                                  03100000
031010*--------------------------------------------------------------*  03101000
031020* WRITE RECORD TO EXTRACT FILE                                 *  03102000
031030*--------------------------------------------------------------*  03103000
031100 W100-WRITE-WORK-REPORT-FILE.                                     03110000
031200                                                                  03120000
031700     WRITE WORK-REPORT-RECORD      FROM AP047-GL-EXTRACT-FILE.    03170000
031900     ADD 1                         TO PV-WRITTEN-CNT.             03190000
032000                                                                  03200000
032010*--------------------------------------------------------------*  03201000
032020* DB2 ABEND ROUTINE                                            *  03202000
032030*--------------------------------------------------------------*  03203000
032100 Z999-DB2-ABEND.                                                  03210000
032200                                                                  03220000
032300     DISPLAY AA-ABEND-LIT.                                        03230000
032400     DISPLAY AA-DB2-ERROR-LIT.                                    03240000
032500     DISPLAY AA-PROGRAM-LIT.                                      03250000
032600     DISPLAY AA-PARAGRAPH-LIT.                                    03260000
032700     DISPLAY AA-DB2-OPERATION-LIT.                                03270000
032800     DISPLAY AA-DB2-TABLE-1.                                      03280000
032900     DISPLAY AA-DB2-TABLE-2.                                      03290000
032910     DISPLAY AA-DB2-TABLE-3.                                      03291000
033000     SET AC-DB2-ERROR TO TRUE.                                    03300000
033100                                                                  03310000
033200     COPY DPPD004.                                                03320000
033400     CALL 'ILBOABN0' USING ABEND-CODE.                            03340000
