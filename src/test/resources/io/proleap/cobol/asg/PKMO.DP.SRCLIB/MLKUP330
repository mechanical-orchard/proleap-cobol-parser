000100 IDENTIFICATION DIVISION.                                         00010002
000200                                                                  00020000
000300 PROGRAM-ID.    MLKUP330.                                         00030000
000400 AUTHOR.        PAUL KEBER - STRATAGEM.                           00040000
000500 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00050000
000600 DATE-WRITTEN.  6-24-99.                                          00060000
000700 DATE-COMPILED.                                                   00070000
000800                                                                  00080000
000900******************************************************************00090000
001000*     MLKUP330 - MONTHLY DEPARTMENT OPEN TO BUY TABLE UPDATE     *00100000
001100******************************************************************00110000
001200*     THIS PROGRAM WILL MAINTAIN THE MONTHLY DEPARTMENT OPEN TO  *00120000
001300* BUY DB2 TABLE WITH THE CURRENT MONTH'S DATA.  THE TABLE IS     *00130000
001300* READ USING THE TABLE KEY FROM EACH INPUT FILE RECORD.  IF THE  *00131000
001400* ROW IS FOUND, THE ROW IS UPDATED WITH DATA FROM THE INPUT FILE *00140000
001500* RECORD.  IF THE ROW IS NOT FOUND, A NEW ROW IS INSERTED ON THE *00150000
001700* DB2 TABLE (TMNDOTB).  COMMITS ARE TAKEN EVERY TEN SECONDS, AND *00170000
001800* CHECKPOINT RESTART LOGIC IS INCORPORATED.                      *00180000
001900*                                                                *00190000
      *    WR/PITS#     DATE        DESCRIPTION                        *00200000
      *    --------   --------     ---------------------------------   *00210000
      *    WR20586    01/17/00     ADDED CODE TO HANDLE NEW COLUMNS    *00220003
      *    THAT WILL BE USED FOR THE M/L STATISTICS REPORT.  THE NEW   *00220103
001900*    COLUMNS INCLUDE THE FOLLOWING:                              *00220203
001900*       1) MNDOTB_GRO_MRGN_AMT                                   *00220303
001900*       2) MNDOTB_RCPT_NET_COST_AMT                              *00220407
001900*       3) MNDOTB_PADJ_NET_COST_AMT                              *00220503
001900*       4) MNDOTB_PADJ_RTL_AMT                                   *00220603
001900*       5) MNDOTB_BEG_INV_RTL_AMT                                *00220703
31355 *                                                                *00221108
31355 *    WR31355    11/17/2000   ROD JANSSEN                         *00221208
31355 *    E-Commerce Combined Ledger Report Modification.......       *00221308
31355 *                                                                *00221408
002000******************************************************************00221503
002100                                                                  00222000
002200                                                                  00223000
002300 ENVIRONMENT DIVISION.                                            00224000
002400                                                                  00225000
002500 CONFIGURATION SECTION.                                           00226000
002600 SOURCE-COMPUTER.        IBM-3090.                                00227000
002700 OBJECT-COMPUTER.        IBM-3090.                                00228000
002800 INPUT-OUTPUT SECTION.                                            00229000
002900 FILE-CONTROL.                                                    00230000
003000     SELECT EXTRACT-FILE                                          00240000
003100         ASSIGN TO INP01.                                         00250000
003200                                                                  00260000
003300                                                                  00270000
003400 DATA DIVISION.                                                   00280000
003500 FILE SECTION.                                                    00290000
003600                                                                  00300000
003700 FD  EXTRACT-FILE                                                 00310000
003800     LABEL RECORDS ARE STANDARD                                   00320000
003900     RECORDING MODE IS F                                          00330000
004000     BLOCK CONTAINS 0 RECORDS.                                    00340000
004100 01  EXTRACT-RECORD              PIC X(125).                      00350006
004200*                                                                 00360000
004300                                                                  00370000
004400                                                                  00380000
004500 WORKING-STORAGE SECTION.                                         00390000
004600                                                                  00400000
004700 01  ABEND-CODE                  PIC S9(04)  VALUE ZERO COMP SYNC.00410000
004800                                                                  00420000
004900 01  PC-PROGRAM-CONSTANTS.                                        00430000
005300     05  PC-MAX-DEADLOCKS        PIC S9(04)    VALUE +3 COMP.     00440000
005000     05  PC-JOB-NAME             PIC  X(06)    VALUE 'MLK238'.    00450000
005100     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'MLKUP330'.  00460000
005400                                                                  00470000
005500 01  PC-PROGRAM-COUNTER.                                          00480000
005600     05  PC-UPDATE-CNT           PIC  9(09).                      00490000
005600     05  PC-DISPLAY-CNT          PIC  9(09).                      00500000
005800                                                                  00510000
005900 01  PE-PROGRAM-ERROR-MESSAGES.                                   00520000
006000     05  PE-MSG-01                       PIC X(50) VALUE          00530000
006100          'ATTEMPT TO SELECT ROW FOR UPDATE/INSERT FAILED   '.    00540000
006200     05  PE-MSG-02                       PIC X(50) VALUE          00550000
006300          'ATTEMPT TO UPDATE ROW ON TABLE TMNDOTB FAILED    '.    00560000
006400     05  PE-MSG-03                       PIC X(50) VALUE          00570000
006500          'ATTEMPT TO INSERT ROW ON TABLE TMNDOTB FAILED    '.    00580000
006600     05  PE-MSG-04                       PIC X(50) VALUE          00590000
006700          'ERROR IN SELECT ''STATUS CODE'' FROM TCKRSTCNTL  '.    00600000
006800     05  PE-MSG-05                       PIC X(50) VALUE          00610000
006900          'UPDATE TO ''WORK_STRG_DESC'' ON TCKRSTINF FAILED '.    00620000
007000     05  PE-MSG-06                       PIC X(50) VALUE          00630000
007100          'PROGRAM ABENDED WHILE TRYING TO PERFORM A COMMIT '.    00640000
007200     05  PE-MSG-07                       PIC X(50) VALUE          00650000
007300          'PROGRAM MAXIMUM DEADLOCK COUNT HAS BEEN EXCEEDED'.     00660000
007400     05  PE-MSG-08                       PIC X(50) VALUE          00670000
007500          'AFTER DEADLOCK ERROR, AN UPDATE OR INSERT FAILED'.     00680000
007600     05  PE-MSG-09                       PIC X(50) VALUE          00690000
007700          'CHECKPNT RESTART FAILED UPON FIRST INSERT/UPDATE'.     00700000
007800     05  PE-MSG-10                       PIC X(50) VALUE          00710000
007900          'UPDATE OF STATUS CODE ON TCKRSTCNTL UNSUCCESSFUL'.     00720000
008000     05  PE-MSG-11                       PIC X(50) VALUE          00730000
008100          'ATTEMPT TO SELECT TIMESTAMP + CKPT_FRQNCY_QTY   '.     00740000
008200*                                                                 00750000
008300 01  PS-PROGRAM-SWITCHES.                                         00760000
008400     05  PS-INPUT-FILE-EOF-SW         PIC X         VALUE 'N'.    00770000
008500         88  PS-MORE-INPUT-RECORDS                  VALUE 'N'.    00780000
008600         88  PS-NO-MORE-INPUT-RECORDS               VALUE 'Y'.    00790000
008700     05  PS-EMPTY-FILE-SW             PIC X         VALUE 'N'.    00800000
008800         88  PS-EMPTY-INPUT-FILE                    VALUE 'Y'.    00810000
008900     05  PS-FIRST-COMMIT-SW           PIC X         VALUE 'N'.    00820000
009000         88  PS-FIRST-COMMIT                        VALUE 'Y'.    00830000
009100     05  PS-DEADLOCK-RESTART-SW       PIC X         VALUE 'N'.    00840000
009200         88  PS-PROGRAM-DEADLOCKED                  VALUE 'Y'.    00850000
009300     05  PS-PROCESSING-OPTIONS        PIC X         VALUE 'P'.    00860000
009400         88  PS-UPDATE-MNDOTB-ROW                   VALUE 'U'.    00870000
009500         88  PS-INSERT-MNDOTB-ROW                   VALUE 'I'.    00880000
009600*                                                                 00890000
009700*                                                                 00900000
009800 01  PROGRAM-VARIABLES.                                           00910000
009900     05  PV-COUNT                        PIC S9(09) VALUE +0 COMP.00920000
009900     05  PV-DEADLOCK-COUNT               PIC S9(04) VALUE +0 COMP.00930000
010000     05  PV-PARAGRAPH-NAME               PIC  X(30) VALUE SPACES. 00940000
010100     05  PV-ABEND-MESSAGE                PIC  X(75) VALUE SPACES. 00950000
010200     05  PV-OPERATION-ATTEMPTED          PIC  X(50) VALUE SPACES. 00960000
010300     05  PV-CURRENT-TIMESTAMP            PIC  X(26) VALUE SPACES. 00970000
010400     05  PV-COMMIT-TIMESTAMP             PIC  X(26) VALUE SPACES. 00980000
010500     05  PV-SQLCODE-DISPLAY              PIC  ++++9 VALUE ZERO.   00990000
010600*                                                                 01000000
010700*                                                                 01010000
010800 01  PA-PROGRAM-ACCUMULATORS.                                     01020000
010900     05  PA-RECORD-COUNTS.                                        01030000
011000         10  PA-INPUT-COUNT              PIC  9(9)  VALUE ZEROES. 01040000
011200         10  PA-UPD-TMNDOTB-COUNT        PIC  9(9)  VALUE ZEROES. 01050000
011200         10  PA-INS-TMNDOTB-COUNT        PIC  9(9)  VALUE ZEROES. 01060000
011300         10  PA-SEL-TMNDOTB-COUNT        PIC  9(9)  VALUE ZEROES. 01070000
011400         10  PA-COMMIT-COUNT             PIC  9(9)  VALUE ZEROES. 01080000
011500*                                                                 01090000
011600 01  PD-PROGRAM-DISPLAYS.                                         01100000
011700     05  PD-DEADLOCK-COUNT         PIC  9(04) VALUE 0.            01110000
013800*                                                                 01120000
013900******************************************************************01130000
014000* MLRD127 - M/L MONTHLY DEPARTMENT OPEN TO BUY DATABASE UPDATE TXN01140000
014100******************************************************************01150000
31355      COPY MLRD127.                                                01160008
014300*                                                                 01170000
014400******************************************************************01180000
014500*  DB2 ERROR MESSAGES FORMAT AREA.                                01190000
014600******************************************************************01200000
014700     COPY DPWS004.                                                01210000
014800*                                                                 01220000
014900******************************************************************01230000
015000*  USED FOR DB2 ERRORS                                            01240000
015100******************************************************************01250000
015200     EXEC SQL                                                     01260000
015300         INCLUDE SQLCA                                            01270000
015400     END-EXEC.                                                    01280000
015500*                                                                 01290000
015600******************************************************************01300000
015700*  M/L MONTHLY DEPARTMENT OPEN TO BUY TABLE                       01310000
015800******************************************************************01320000
015900     EXEC SQL                                                     01330000
016000         INCLUDE TMNDOTB                                          01340000
016100     END-EXEC.                                                    01350000
015500*                                                                 01360000
016300***************************************************************** 01370000
016400* DB2 CHECKPOINT RESTART CONTROL TABLE AND RESTART INFO TABLE     01380000
016500***************************************************************** 01390000
016600     EXEC SQL                                                     01400000
016700         INCLUDE TCKRSTCN                                         01410000
016800     END-EXEC.                                                    01420000
016900*                                                                 01430000
017000     EXEC SQL                                                     01440000
017100         INCLUDE TCKRSTIN                                         01450000
017200     END-EXEC.                                                    01460000
017300*                                                                 01470000
017400******************************************************************01480000
017500* CHECKPOINT RESTART VARIABLES AND PREV COMMIT VARIABLES.        *01490000
017600******************************************************************01500000
017700 01  CR-CHECKPOINT-RESTART-AREA.                                  01510000
017800     05  CR-AREA-LEN                  PIC S9(04) VALUE +62 COMP.  01520000
017900     05  CR-CHECKPOINT-RESTART-VAR.                               01530000
31355          10  CR-PREV-DTL-KEY          PIC  X(16) VALUE SPACES.    01540008
018100         10  FILLER REDEFINES CR-PREV-DTL-KEY.                    01550000
018200             15  CR-FISCAL-MN-NBR     PIC  X(02).                 01560000
018300             15  CR-FISCAL-MN-END-DTE PIC  X(10).                 01570000
018400             15  CR-DEPT-NBR          PIC  X(03).                 01580000
31355              15  CR-CHNL-CDE          PIC  X(01).                 01581008
018700         10  CR-INPUT-READ-COUNT      PIC  9(09) VALUE ZEROES.    01590000
018800         10  CR-TMNDOTB-COMMIT-COUNT  PIC  9(09) VALUE ZEROES.    01600000
018900         10  CR-UPD-TMNDOTB-COUNT     PIC  9(09) VALUE ZEROES.    01610000
018900         10  CR-INS-TMNDOTB-COUNT     PIC  9(09) VALUE ZEROES.    01620000
019100         10  CR-SEL-TMNDOTB-COUNT     PIC  9(09) VALUE ZEROES.    01630000
019200*                                                                 01640000
019300 01  CK-CHECKPOINT-SAVE-AREA.                                     01650000
31355      05  CK-SAVE-PREV-KEY         PIC  X(16) VALUE SPACES.        01660008
019500     05  FILLER REDEFINES CK-SAVE-PREV-KEY.                       01670000
019600         10  CK-FISCAL-MN-NBR     PIC  X(02).                     01680000
019700         10  CK-FISCAL-MN-END-DTE PIC  X(10).                     01690000
019800         10  CK-DEPT-NBR          PIC  X(03).                     01700000
31355          10  CK-CHNL-CDE          PIC  X(01).                     01701008
020100*                                                                 01710000
020400*                                                                 01720000
020500*-------------------*                                             01730000
020600 PROCEDURE DIVISION.                                              01740000
020700*-------------------*                                             01750000
020800                                                                  01760000
020900 0000-MAIN-MODULE.                                                01770000
021000                                                                  01780000
021100     PERFORM 1000-INITIALIZATION.                                 01790000
021200*                                                                 01800000
021300     PERFORM 2000-PROCESS-INPUT                                   01810000
021400          UNTIL PS-NO-MORE-INPUT-RECORDS.                         01820000
021500*                                                                 01830000
021600     PERFORM 8000-EOJ-ROUTINE.                                    01840000
021700                                                                  01850000
021800     STOP RUN.                                                    01860000
021900*                                                                 01870000
022000*                                                                 01880000
022100*                                                                 01890000
022200******************************************************************01900000
022300* OPEN INPUT FILE , INITIALIZE COUNTERS , READ FIRST INPUT RECORD 01910000
022400* PREPARE CHECKPOINT RESTART TABLES FOR PROCESSING / RESTART      01920000
022500******************************************************************01930000
022600*                                                                 01940000
022700 1000-INITIALIZATION.                                             01950000
022800*                                                                 01960000
022900     OPEN INPUT EXTRACT-FILE.                                     01970000
023000*                                                                 01980000
023100     PERFORM 7400-INIT-CHECKPOINT-SELECT.                         01990000
023200*                                                                 02000000
023300* CKPT-STAT-CODE = '9' INDICATES A RESTART CONDITION              02010000
023400     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02020000
023500         PERFORM 7500-SELECT-RESTART-INFO                         02030000
023600         MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO                    02040000
023700                                       CR-CHECKPOINT-RESTART-VAR  02050000
023800         MOVE CR-PREV-DTL-KEY         TO CK-SAVE-PREV-KEY         02060000
023900* MOVE RESTART COUNTS TO PA-FIELDS FOR ACCURATE DISPLAY AT EOJ    02070000
024000         MOVE CR-UPD-TMNDOTB-COUNT    TO PA-UPD-TMNDOTB-COUNT     02080000
024000         MOVE CR-INS-TMNDOTB-COUNT    TO PA-INS-TMNDOTB-COUNT     02090000
024200         MOVE CR-SEL-TMNDOTB-COUNT    TO PA-SEL-TMNDOTB-COUNT     02100000
024300         MOVE CR-TMNDOTB-COMMIT-COUNT TO PA-COMMIT-COUNT          02110000
024400     ELSE                                                         02120000
024500         SET PS-FIRST-COMMIT TO TRUE                              02130000
024600     END-IF.                                                      02140000
024700*                                                                 02150000
024800     DISPLAY 'COMMITS WILL BE TAKEN EVERY ',                      02160000
024900             TCKRSTCNTL-CKPT-FRQNCY-QTY, ' SECONDS.'.             02170000
025000*                                                                 02180000
025100     PERFORM 4000-READ-EXTRACT-FILE UNTIL                         02190000
025200         PA-INPUT-COUNT > CR-INPUT-READ-COUNT                     02200000
025300      OR PS-NO-MORE-INPUT-RECORDS.                                02210000
025400*                                                                 02220000
025500     IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                           02230000
025600         DISPLAY 'FISCAL MONTH NBR      ' ML127-FSCL-MN-NBR       02240000
025700         DISPLAY 'FISCAL MONTH END DATE ' ML127-FSCL-MN-END-DTE   02250000
025800         DISPLAY 'DEPARTMENT NBR        ' ML127-DEPT-NBR          02260000
31355          DISPLAY 'CHANNEL CODE          ' ML127-CHNL-CDE          02261008
026100         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              02270000
026200                  PA-INPUT-COUNT                                  02280000
026300     END-IF.                                                      02290000
026400                                                                  02300000
026500     IF PS-NO-MORE-INPUT-RECORDS                                  02310000
026600         IF TCKRSTCNTL-CKPT-STAT-CODE = '9'                       02320000
026700             CONTINUE                                             02330000
026800         ELSE                                                     02340000
026900             DISPLAY '** NO RECORDS ON INPUT FILE **'             02350000
027000     ELSE                                                         02360000
027100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        02370000
027200     END-IF.                                                      02380000
027300*                                                                 02390000
027400*                                                                 02400000
027500******************************************************************02410000
027600* PROCESS THE INPUT EXTRACT FILE - UPDATE OR INSERT AS NEEDED     02420000
027700******************************************************************02430000
027800 2000-PROCESS-INPUT.                                              02440000
027900*                                                                 02450000
028000     MOVE 'N' TO PS-DEADLOCK-RESTART-SW.                          02460000
028100*                                                                 02470000
028600     MOVE ML127-FSCL-MN-NBR       TO MNDOTB-FSCL-MN-NBR.          02480004
028600     MOVE ML127-FSCL-MN-END-DTE   TO MNDOTB-FSCL-MN-END-DTE.      02490004
028600     MOVE ML127-DEPT-NBR          TO MNDOTB-DEPT-NBR.             02500004
31355      MOVE ML127-CHNL-CDE          TO MNDOTB-CHNL-CDE.             02501008
028600     MOVE ML127-SLS-RTL-AMT       TO MNDOTB-SLS-RTL-AMT.          02510004
028600     MOVE ML127-MKDN-RTL-AMT      TO MNDOTB-MKDN-RTL-AMT.         02520004
028600     MOVE ML127-RCPT-RTL-AMT      TO MNDOTB-RCPT-RTL-AMT.         02530004
028600     MOVE ML127-SHNK-RTL-AMT      TO MNDOTB-SHNK-RTL-AMT.         02550004
028600     MOVE ML127-END-INV-RTL-AMT   TO MNDOTB-END-INV-RTL-AMT.      02560004
028600     MOVE ML127-SLS-COST-AMT      TO MNDOTB-SLS-COST-AMT.         02580004
028600     MOVE ML127-TOT-ORD-RTL-AMT   TO MNDOTB-TOT-ORD-RTL-AMT.      02590004
028600     MOVE ML127-APP-ORD-RTL-AMT   TO MNDOTB-APP-ORD-RTL-AMT.      02600004
028600     MOVE ML127-APP-ORD-COST-AMT  TO MNDOTB-APP-ORD-COST-AMT.     02601004
      * DGM ADD                                                         02601104
028600     MOVE ML127-GRO-MRGN-AMT      TO MNDOTB-GRO-MRGN-AMT.         02602004
028600     MOVE ML127-RCPT-NET-COST-AMT TO MNDOTB-RCPT-NET-COST-AMT.    02602107
028600     MOVE ML127-PADJ-NET-COST-AMT TO MNDOTB-PADJ-NET-COST-AMT.    02602204
028600     MOVE ML127-PADJ-RTL-AMT      TO MNDOTB-PADJ-RTL-AMT.         02602304
028600     MOVE ML127-BOM-INV-RTL-AMT   TO MNDOTB-BEG-INV-RTL-AMT.      02602404
      * DGM END                                                         02603004
028100*                                                                 02610000
028200     PERFORM 6000-SELECT-MNDOTB-ROW.                              02620000
028300*                                                                 02630000
028400     IF PS-PROGRAM-DEADLOCKED                                     02640000
028500         CONTINUE                                                 02650000
028600     ELSE                                                         02660000
028700         EVALUATE TRUE                                            02670000
028800             WHEN PS-UPDATE-MNDOTB-ROW                            02680000
028900                 PERFORM 6100-UPDATE-MNDOTB-ROW                   02690000
029000             WHEN PS-INSERT-MNDOTB-ROW                            02700000
029100                 PERFORM 6200-INSERT-MNDOTB-ROW                   02710000
029600         END-EVALUATE                                             02720000
029700     END-IF.                                                      02730000
028300*                                                                 02740000
029900     IF PS-PROGRAM-DEADLOCKED                                     02750000
030000         CONTINUE                                                 02760000
030100     ELSE                                                         02770000
030200         PERFORM 7700-COMMIT-PROCESSING                           02780000
030300         PERFORM 4000-READ-EXTRACT-FILE                           02790000
029700     END-IF.                                                      02800000
030400*                                                                 02810000
034200*                                                                 02820000
034300******************************************************************02830000
034400* READS THE CONDENSED FILE INTO THE TMNDOTB LAYOUT                02840000
034500******************************************************************02850000
034600 4000-READ-EXTRACT-FILE.                                          02860000
034700     READ EXTRACT-FILE INTO ML127-MNTHLY-OTB-EXTRACT-REC          02870001
034800         AT END MOVE 'Y' TO PS-INPUT-FILE-EOF-SW.                 02880000
034900*                                                                 02890000
035000     IF PS-NO-MORE-INPUT-RECORDS                                  02900000
035100         MOVE ML127-FSCL-MN-NBR         TO CR-FISCAL-MN-NBR       02910000
035200         MOVE ML127-FSCL-MN-END-DTE     TO CR-FISCAL-MN-END-DTE   02920000
035300         MOVE ML127-DEPT-NBR            TO CR-DEPT-NBR            02930000
31355          MOVE ML127-CHNL-CDE            TO CR-CHNL-CDE            02931008
035600         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    02940000
067900         MOVE PA-UPD-TMNDOTB-COUNT      TO CR-UPD-TMNDOTB-COUNT   02950000
067900         MOVE PA-INS-TMNDOTB-COUNT      TO CR-INS-TMNDOTB-COUNT   02960000
068100         MOVE PA-SEL-TMNDOTB-COUNT      TO CR-SEL-TMNDOTB-COUNT   02970000
035700*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  02980000
035800         MOVE CR-CHECKPOINT-RESTART-AREA TO                       02990000
035900                                       TCKRSTINF-WORK-STRG-DESC   03000000
036000         EXEC SQL                                                 03010000
036100           UPDATE TCKRSTINF                                       03020000
036200              SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC      03030000
036300            WHERE JOB_NAME   = :PC-JOB-NAME                       03040000
036400              AND PLAN_NAME  = :PC-PROGRAM-NAME                   03050000
036500         END-EXEC                                                 03060000
036600         IF SQLCODE = 0                                           03070000
036700             CONTINUE                                             03080000
036800         ELSE                                                     03090000
036900             MOVE PE-MSG-05            TO PV-OPERATION-ATTEMPTED  03100000
037000             MOVE '* 4000-READ-EXTRACT-FILE *' TO                 03110000
037100                  PV-PARAGRAPH-NAME                               03120000
037200             PERFORM 9999-SQL-ABEND                               03130000
037300         END-IF                                                   03140000
037400     ELSE                                                         03150000
037500         ADD 1                         TO PA-INPUT-COUNT          03160000
                                                PC-UPDATE-CNT           03170000
               IF PC-UPDATE-CNT > 100000                                03180000
                    ADD 1                    TO PC-DISPLAY-CNT          03190000
038000              DISPLAY 'UPDATE COUNT: ' PC-DISPLAY-CNT             03200000
                    MOVE +0                  TO PC-UPDATE-CNT           03210000
038100         END-IF                                                   03220000
038200     END-IF.                                                      03230000
038300*                                                                 03240000
038300*                                                                 03250000
038400******************************************************************03260000
038500* SELECT A ROW FROM THE MONTHLY DEPT OPEN TO BUY TABLE THAT       03270000
038500* MATCHES THE INPUT KEY.                                          03271000
038700******************************************************************03290000
038800 6000-SELECT-MNDOTB-ROW.                                          03300000
038900*                                                                 03310000
039000     EXEC SQL                                                     03320000
039100         SELECT 1                                                 03330000
040100           INTO :PV-COUNT                                         03340000
041100         FROM TMNDOTB                                             03350000
041200        WHERE   FSCL_MN_NBR         = :MNDOTB-FSCL-MN-NBR         03360000
041300          AND   FSCL_MN_END_DTE     = :MNDOTB-FSCL-MN-END-DTE     03370000
041400          AND   DEPT_NBR            = :MNDOTB-DEPT-NBR            03380000
31355           AND   CHNL_CDE            = :MNDOTB-CHNL-CDE            03381008
041700     END-EXEC.                                                    03390000
041800*                                                                 03400000
041900     EVALUATE SQLCODE                                             03410000
042000         WHEN 0                                                   03420000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     03430000
042100             SET PS-UPDATE-MNDOTB-ROW    TO TRUE                  03440000
042200             ADD +1                      TO PA-SEL-TMNDOTB-COUNT  03450000
042300         WHEN +100                                                03460000
054300             MOVE ZERO                   TO PV-DEADLOCK-COUNT     03470000
042400             SET PS-INSERT-MNDOTB-ROW    TO TRUE                  03480000
042500         WHEN -911                                                03490000
042600             ADD +1             TO PV-DEADLOCK-COUNT              03500000
042700             DISPLAY 'DEADLOCK -911 IN 6000-SELECT-MNDOTB-ROW'    03510000
042800             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03520000
042900                 MOVE '6000-SELECT-MNDOTB-ROW'                    03530000
043000                                           TO PV-PARAGRAPH-NAME   03540000
043100                 PERFORM 9000-DEADLOCK-ERROR                      03550000
043200             ELSE                                                 03560000
043300                 PERFORM 7999-RESTART-PROCESS                     03570000
043400             END-IF                                               03580000
043500         WHEN OTHER                                               03590000
043600             MOVE '6000-SELECT-MNDOTB-ROW' TO PV-PARAGRAPH-NAME   03600000
043700             MOVE PE-MSG-01 TO PV-OPERATION-ATTEMPTED             03610000
043800             PERFORM 9999-SQL-ABEND                               03620000
043900     END-EVALUATE.                                                03630000
044000*                                                                 03640000
044100*                                                                 03650000
044200***************************************************************** 03660000
044300* THE INPUT RECORD FOUND A MATCHING ROW BASED ON FSCL INFO AND    03670000
044400* DEPARTMENT.  CURRENT TABLE VALUES ARE UPDATED WITH THE VALUES   03680000
044500* FROM THE INPUT RECORD.                                          03690000
044600***************************************************************** 03700000
044700 6100-UPDATE-MNDOTB-ROW.                                          03710000
044800*                                                                 03720000
044900*                                                                 03730000
045200     EXEC SQL                                                     03740000
045300         UPDATE TMNDOTB                                           03750000
045400             SET SLS_RTL_AMT        = :MNDOTB-SLS-RTL-AMT         03760000
045500               , MKDN_RTL_AMT       = :MNDOTB-MKDN-RTL-AMT        03770000
045600               , RCPT_RTL_AMT       = :MNDOTB-RCPT-RTL-AMT        03780000
045800               , SHNK_RTL_AMT       = :MNDOTB-SHNK-RTL-AMT        03800000
045900               , END_INV_RTL_AMT    = :MNDOTB-END-INV-RTL-AMT     03810000
046100               , SLS_COST_AMT       = :MNDOTB-SLS-COST-AMT        03830000
046200               , TOT_ORD_RTL_AMT    = :MNDOTB-TOT-ORD-RTL-AMT     03840000
046200               , APP_ORD_RTL_AMT    = :MNDOTB-APP-ORD-RTL-AMT     03841000
046300               , APP_ORD_COST_AMT   = :MNDOTB-APP-ORD-COST-AMT    03850000
046300               , GRO_MRGN_AMT       = :MNDOTB-GRO-MRGN-AMT        03851004
046300               , RCPT_NET_COST_AMT  = :MNDOTB-RCPT-NET-COST-AMT   03852007
046300               , PADJ_NET_COST_AMT  = :MNDOTB-PADJ-NET-COST-AMT   03852104
046300               , PADJ_RTL_AMT       = :MNDOTB-PADJ-RTL-AMT        03854004
046300               , BEG_INV_RTL_AMT    = :MNDOTB-BEG-INV-RTL-AMT     03855004
046400        WHERE   FSCL_MN_NBR         = :MNDOTB-FSCL-MN-NBR         03860000
046500          AND   FSCL_MN_END_DTE     = :MNDOTB-FSCL-MN-END-DTE     03870000
046600          AND   DEPT_NBR            = :MNDOTB-DEPT-NBR            03880000
31355           AND   CHNL_CDE            = :MNDOTB-CHNL-CDE            03881008
046900     END-EXEC.                                                    03890000
047000*                                                                 03900000
047100     EVALUATE SQLCODE                                             03910000
047200         WHEN 0                                                   03920000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              03930000
049300             ADD 1              TO PA-UPD-TMNDOTB-COUNT           03940000
047400         WHEN -911                                                03950000
047500             ADD +1             TO PV-DEADLOCK-COUNT              03960000
047600             DISPLAY 'DEADLOCK -911 IN 6100-UPDATE-MNDOTB-ROW'    03970000
047700             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              03980000
047800                 MOVE '6100-UPDATE-MNDOTB-ROW'                    03990000
047900                                TO PV-PARAGRAPH-NAME              04000000
048000                 PERFORM 9000-DEADLOCK-ERROR                      04010000
048100             ELSE                                                 04020000
048200                 PERFORM 7999-RESTART-PROCESS                     04030000
048300             END-IF                                               04040000
048400         WHEN OTHER                                               04050000
048500             MOVE '6100-UPDATE-MNDOTB-ROW'                        04060000
047900                                TO PV-PARAGRAPH-NAME              04070000
048600             MOVE PE-MSG-02     TO PV-OPERATION-ATTEMPTED         04080000
048700             PERFORM 9999-SQL-ABEND                               04090000
048800     END-EVALUATE.                                                04100000
048900*                                                                 04110000
049600*                                                                 04120000
049700***************************************************************** 04130000
049800* THERE WAS NO MATCHING ROW ON THE MONTHLY DEPT OPEN TO BUY TBL.* 04140000
049900* - ENTRY FOR THIS ENTITY IS INSERTED AS A 'NEW' ROW            * 04150000
050000***************************************************************** 04160000
050100 6200-INSERT-MNDOTB-ROW.                                          04170000
050200*                                                                 04180000
050300*                                                                 04190000
050400     EXEC SQL                                                     04200000
050500         INSERT INTO TMNDOTB                                      04210000
050600             (   FSCL_MN_NBR                                      04220000
050700               , FSCL_MN_END_DTE                                  04230000
050800               , DEPT_NBR                                         04240000
31355                , CHNL_CDE                                         04241008
051100               , SLS_RTL_AMT                                      04250000
051200               , MKDN_RTL_AMT                                     04260000
051300               , RCPT_RTL_AMT                                     04270000
051500               , SHNK_RTL_AMT                                     04290000
051600               , END_INV_RTL_AMT                                  04300000
051800               , SLS_COST_AMT                                     04320000
051900               , TOT_ORD_RTL_AMT                                  04330000
051900               , APP_ORD_RTL_AMT                                  04331000
052000               , APP_ORD_COST_AMT                                 04340004
                     , GRO_MRGN_AMT                                     04341004
                     , RCPT_NET_COST_AMT                                04342007
                     , PADJ_NET_COST_AMT                                04343004
                     , PADJ_RTL_AMT                                     04344004
                     , BEG_INV_RTL_AMT )                                04345004
052100         VALUES                                                   04350000
052200             (   :MNDOTB-FSCL-MN-NBR                              04360000
052300               , :MNDOTB-FSCL-MN-END-DTE                          04370000
052400               , :MNDOTB-DEPT-NBR                                 04380000
31355                , :MNDOTB-CHNL-CDE                                 04381008
052700               , :MNDOTB-SLS-RTL-AMT                              04390000
052800               , :MNDOTB-MKDN-RTL-AMT                             04400000
052900               , :MNDOTB-RCPT-RTL-AMT                             04410000
053100               , :MNDOTB-SHNK-RTL-AMT                             04430000
053200               , :MNDOTB-END-INV-RTL-AMT                          04440000
053400               , :MNDOTB-SLS-COST-AMT                             04460000
053500               , :MNDOTB-TOT-ORD-RTL-AMT                          04470000
053500               , :MNDOTB-APP-ORD-RTL-AMT                          04471000
053600               , :MNDOTB-APP-ORD-COST-AMT                         04480004
                     , :MNDOTB-GRO-MRGN-AMT                             04481004
                     , :MNDOTB-RCPT-NET-COST-AMT                        04482007
                     , :MNDOTB-PADJ-NET-COST-AMT                        04483004
                     , :MNDOTB-PADJ-RTL-AMT                             04484004
                     , :MNDOTB-BEG-INV-RTL-AMT )                        04485004
053700     END-EXEC.                                                    04490000
053800*                                                                 04500000
053900     EVALUATE SQLCODE                                             04510000
054000         WHEN 0                                                   04520000
054300             MOVE ZERO          TO PV-DEADLOCK-COUNT              04530000
056100             ADD 1              TO PA-INS-TMNDOTB-COUNT           04540000
054200         WHEN -911                                                04550000
054300             ADD +1             TO PV-DEADLOCK-COUNT              04560000
054400             DISPLAY 'DEADLOCK -911 IN 6200-INSERT-MNDOTB-ROW'    04570000
054500             IF PV-DEADLOCK-COUNT > PC-MAX-DEADLOCKS              04580000
054600                 MOVE '6200-INSERT-MNDOTB-ROW' TO                 04590000
054700                                              PV-PARAGRAPH-NAME   04600000
054800                 PERFORM 9000-DEADLOCK-ERROR                      04610000
054900             ELSE                                                 04620000
055000                 PERFORM 7999-RESTART-PROCESS                     04630000
055100             END-IF                                               04640000
055200         WHEN OTHER                                               04650000
055300             MOVE '6200-INSERT-MNDOTB-ROW' TO PV-PARAGRAPH-NAME   04660000
055400             MOVE PE-MSG-03              TO PV-OPERATION-ATTEMPTED04670000
055500             PERFORM 9999-SQL-ABEND                               04680000
055600     END-EVALUATE.                                                04690000
055700*                                                                 04700000
056400*                                                                 04710000
056500******************************************************************04720000
056600* 7300-GET-COMMIT-TIMESTAMP.                                     *04730000
056700* PROCESSES: GET THE COMMIT TIMESTAMP FROM THE CHECKPOINT        *04740000
056800*            CONTROL TABLE                                       *04750000
056900******************************************************************04760000
057000 7300-GET-COMMIT-TIMESTAMP.                                       04770000
057100                                                                  04780000
057200     EXEC SQL                                                     04790000
057300* CHECKPOINT TAKEN BASED ON CHEKPOINT RESTART CICSP1 PANEL        04800000
057400       SELECT (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)       04810000
057500         INTO :PV-COMMIT-TIMESTAMP                                04820000
057600         FROM TCKRSTCNTL                                          04830000
057700        WHERE JOB_NAME  = :PC-JOB-NAME                            04840000
057800          AND PLAN_NAME = :PC-PROGRAM-NAME                        04850000
057900     END-EXEC.                                                    04860000
058000                                                                  04870000
060900     IF SQLCODE = 0                                               04880000
061000         CONTINUE                                                 04890000
061100     ELSE                                                         04900000
00             MOVE '7300-GET-COMMIT-TIMESTAMP' TO PV-PARAGRAPH-NAME    04910000
00             MOVE PE-MSG-11             TO PV-OPERATION-ATTEMPTED     04920000
00             PERFORM 9999-SQL-ABEND                                   04930000
058900     END-IF.                                                      04940000
059000*                                                                 04950000
059100*                                                                 04960000
059200******************************************************************04970000
059300* 7400-INIT-CHECKPOINT-SELECT                                    *04980000
059400* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART CONTROL TABLE   *04990000
059500*            IF WE ARE IN A RESTART CONDITION.                   *05000000
059600******************************************************************05010000
059700 7400-INIT-CHECKPOINT-SELECT.                                     05020000
059800                                                                  05030000
059900     EXEC SQL                                                     05040000
060000       SELECT  CKPT_STAT_CODE                                     05050000
060100              ,CKPT_FRQNCY_QTY                                    05060000
060200         INTO  :TCKRSTCNTL-CKPT-STAT-CODE                         05070000
060300              ,:TCKRSTCNTL-CKPT-FRQNCY-QTY                        05080000
060400         FROM  TCKRSTCNTL                                         05090000
060500        WHERE  JOB_NAME  = :PC-JOB-NAME                           05100000
060600          AND  PLAN_NAME = :PC-PROGRAM-NAME                       05110000
060700     END-EXEC.                                                    05120000
060800                                                                  05130000
060900     IF SQLCODE = 0                                               05140000
061000         CONTINUE                                                 05150000
061100     ELSE                                                         05160000
061200         MOVE '7400-INIT-CHECKPOINT-SELECT' TO PV-PARAGRAPH-NAME  05170000
061300         MOVE PE-MSG-04             TO PV-OPERATION-ATTEMPTED     05180000
061400         PERFORM 9999-SQL-ABEND                                   05190000
061500     END-IF.                                                      05200000
061600*                                                                 05210000
061700*                                                                 05220000
061800******************************************************************05230000
061900* 7500-SELECT-RESTART-INFO                                       *05240000
062000* PROCESSES: SELECTS FROM THE CHECKPOINT RESTART INFORMATION     *05250000
062100*            TABLE TO OBTAIN THE PROGRAMS SAVED VARIABLES.       *05260000
062200******************************************************************05270000
062300 7500-SELECT-RESTART-INFO.                                        05280000
062400                                                                  05290000
062500     EXEC SQL                                                     05300000
062600       SELECT  WORK_STRG_DESC                                     05310000
062700         INTO  :TCKRSTINF-WORK-STRG-DESC                          05320000
062800         FROM  TCKRSTINF                                          05330000
062900        WHERE  JOB_NAME  = :PC-JOB-NAME                           05340000
063000          AND  PLAN_NAME = :PC-PROGRAM-NAME                       05350000
063100     END-EXEC.                                                    05360000
063200                                                                  05370000
063300     IF SQLCODE = 0                                               05380000
063400         CONTINUE                                                 05390000
063500     ELSE                                                         05400000
063600         MOVE '*7500-SELECT-RESTART-INFO*' TO PV-PARAGRAPH-NAME   05410000
063700         PERFORM 9999-SQL-ABEND                                   05420000
063800     END-IF.                                                      05430000
063900*                                                                 05440000
064000*                                                                 05450000
064100******************************************************************05460000
064200* 7600-SET-CURRENT-TIMESTAMP.                                    *05470000
064300* PROCESSES: GET THE CURRENT TIMESTAMP FROM DB2.                 *05480000
064400******************************************************************05490000
064500 7600-SET-CURRENT-TIMESTAMP.                                      05500000
064600                                                                  05510000
064700     EXEC SQL                                                     05520000
064800          SET :PV-CURRENT-TIMESTAMP = CURRENT TIMESTAMP           05530000
064900     END-EXEC.                                                    05540000
065000*                                                                 05550000
065100     IF SQLCODE = 0                                               05560000
065200         CONTINUE                                                 05570000
065300     ELSE                                                         05580000
065400         MOVE '*7600-SET-CURRENT-TIMESTAMP*' TO PV-PARAGRAPH-NAME 05590000
065500         PERFORM 9999-SQL-ABEND                                   05600000
065600     END-IF.                                                      05610000
065700*                                                                 05620000
065800*                                                                 05630000
065900******************************************************************05640000
066000* 7700-COMMIT-PROCESSING.                                        *05650000
066100* PROCESSES: CHECK IF WE NEED TO TAKE A COMMIT.                  *05660000
066200*          PREPARE CHECKPOINT RECORD FOR UPDATE OF WORK_STRG_DESC*05670000
066300******************************************************************05680000
066400 7700-COMMIT-PROCESSING.                                          05690000
066500     MOVE '*7700-COMMIT-PROCESSING*'    TO PV-PARAGRAPH-NAME.     05700000
066600                                                                  05710000
066700     PERFORM 7600-SET-CURRENT-TIMESTAMP.                          05720000
066800*                                                                 05730000
066900     IF PV-CURRENT-TIMESTAMP > PV-COMMIT-TIMESTAMP                05740000
067000*        PREPARE COMMIT RECORD FOR UPDATE                         05750000
067100         ADD 1                          TO PA-COMMIT-COUNT        05760000
067200         MOVE ML127-FSCL-MN-NBR         TO CR-FISCAL-MN-NBR       05770000
067300         MOVE ML127-FSCL-MN-END-DTE     TO CR-FISCAL-MN-END-DTE   05780000
067400         MOVE ML127-DEPT-NBR            TO CR-DEPT-NBR            05790000
31355          MOVE ML127-CHNL-CDE            TO CR-CHNL-CDE            05791008
067700         MOVE PA-COMMIT-COUNT           TO CR-TMNDOTB-COMMIT-COUNT05800000
067800         MOVE PA-INPUT-COUNT            TO CR-INPUT-READ-COUNT    05810000
067900         MOVE PA-UPD-TMNDOTB-COUNT      TO CR-UPD-TMNDOTB-COUNT   05820000
067900         MOVE PA-INS-TMNDOTB-COUNT      TO CR-INS-TMNDOTB-COUNT   05830000
068100         MOVE PA-SEL-TMNDOTB-COUNT      TO CR-SEL-TMNDOTB-COUNT   05840000
068200*        MOVE COMMIT INFO TO WORKING STORAGE ROW                  05850000
068300         MOVE CR-CHECKPOINT-RESTART-AREA TO                       05860000
068400                                       TCKRSTINF-WORK-STRG-DESC   05870000
068500         IF PS-FIRST-COMMIT                                       05880000
068600             MOVE '9' TO TCKRSTCNTL-CKPT-STAT-CODE                05890000
068700             PERFORM 7900-UPDATE-CHECKPOINT-STATUS                05900000
068800             MOVE 'N' TO PS-FIRST-COMMIT-SW                       05910000
068900         END-IF                                                   05920000
069000         PERFORM 7800-COMMIT-CHANGES                              05930000
069100         PERFORM 7300-GET-COMMIT-TIMESTAMP                        05940000
069200     END-IF.                                                      05950000
069300*                                                                 05960000
069400*                                                                 05970000
069500******************************************************************05980000
069600* 7800-COMMIT-CHANGES.                                            05990000
069700* PROCESSES: PERFORM UPDATE OF CHECKPOINT INFORMATION TABLE.      06000000
069800*            TAKE A COMMIT.                                       06010000
069900*  ==> PERFORMED FROM: 7700-COMMIT-PROCESSING.                    06020000
070000******************************************************************06030000
070100 7800-COMMIT-CHANGES.                                             06040000
070200                                                                  06050000
070300     EXEC SQL                                                     06060000
070400       UPDATE TCKRSTINF                                           06070000
070500          SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC          06080000
070600        WHERE JOB_NAME       = :PC-JOB-NAME                       06090000
070700          AND PLAN_NAME      = :PC-PROGRAM-NAME                   06100000
070800     END-EXEC.                                                    06110000
070900                                                                  06120000
071000     IF SQLCODE = 0                                               06130000
071100         CONTINUE                                                 06140000
071200     ELSE                                                         06150000
071300         MOVE PE-MSG-05                  TO PV-OPERATION-ATTEMPTED06160000
071400         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06170000
071500         PERFORM 9999-SQL-ABEND                                   06180000
071600     END-IF.                                                      06190000
071700                                                                  06200000
071800     EXEC SQL                                                     06210000
071900         COMMIT                                                   06220000
072000     END-EXEC.                                                    06230000
072100                                                                  06240000
072200     IF SQLCODE = 0                                               06250000
072300         CONTINUE                                                 06260000
072400     ELSE                                                         06270000
072500         MOVE PE-MSG-06                  TO PV-OPERATION-ATTEMPTED06280000
072600         MOVE  '* 7800-COMMIT-CHANGES *' TO PV-PARAGRAPH-NAME     06290000
072700         PERFORM 9999-SQL-ABEND                                   06300000
072800     END-IF.                                                      06310000
072900*                                                                 06320000
073000*                                                                 06330000
073100******************************************************************06340000
073200* 7900-UPDATE-CHECKPOINT-STATUS                                   06350000
073300* PROCESSES: UPDATES THE STATUS ON THE CHECKPOINT CONTROL TABLE   06360000
073400*                                                                 06370000
073500******************************************************************06380000
073600 7900-UPDATE-CHECKPOINT-STATUS.                                   06390000
073700                                                                  06400000
073800     EXEC SQL                                                     06410000
073900       UPDATE  TCKRSTCNTL                                         06420000
074000          SET  CKPT_STAT_CODE = :TCKRSTCNTL-CKPT-STAT-CODE        06430000
074100        WHERE  JOB_NAME  = :PC-JOB-NAME                           06440000
074200          AND  PLAN_NAME = :PC-PROGRAM-NAME                       06450000
074300     END-EXEC.                                                    06460000
074400                                                                  06470000
074500     IF SQLCODE = 0                                               06480000
074600         CONTINUE                                                 06490000
074700     ELSE                                                         06500000
074800         MOVE '7900-UPDATE-CHECKPOINT-STATUS' TO PV-PARAGRAPH-NAME06510000
074900         MOVE PE-MSG-10                  TO PV-OPERATION-ATTEMPTED06520000
075000         PERFORM 9999-SQL-ABEND                                   06530000
075100     END-IF.                                                      06540000
075200                                                                  06550000
075300     EJECT                                                        06560000
075400*                                                                 06570000
075500*                                                                 06580000
075600******************************************************************06590000
075700* PROGRAM RESTART DUE TO A DEADLOCK AGAINST TMNDOTB ROW FOR UPDATE06600000
075800*  FIND RESTART RECORD AND CKPT RESTART AT POINT OF LAST COMMIT.  06610000
075900******************************************************************06620000
076000 7999-RESTART-PROCESS.                                            06630000
076100*                                                                 06640000
076200     SET PS-PROGRAM-DEADLOCKED TO TRUE.                           06650000
076300*                                                                 06660000
076400     CLOSE EXTRACT-FILE.                                          06670000
076500*                                                                 06680000
076600     PERFORM 7500-SELECT-RESTART-INFO.                            06690000
076700*                                                                 06700000
076800     DISPLAY '**** RESTART **** '.                                06710000
076900     MOVE PV-DEADLOCK-COUNT TO PD-DEADLOCK-COUNT.                 06720000
077000     DISPLAY '** SQLCODE -911 **  ' PD-DEADLOCK-COUNT ' TIMES'.   06730000
077100*                                                                 06740000
077200*-- THIS CHECK WILL PREVENT THE FILE FROM BEING RESTARTED IN      06750000
077300*-- THE WRONG POSITION IF NO COMMITS HAVE OCCURRED AND THE        06760000
077400*-- RESTART INFORMATION IS NOT CLEARED OUT.                       06770000
077500     IF PS-FIRST-COMMIT                                           06780000
077600         INITIALIZE TCKRSTINF-WORK-STRG-DESC                      06790000
077700         DISPLAY 'NO COMMITS HAVE OCCURRED YET; RESTART FROM'     06800000
077800                ' BEGINNING'                                      06810000
077900     ELSE                                                         06820000
078000         DISPLAY 'TCKRSTINF-LAST CKPT '                           06830000
078100                  TCKRSTINF-WORK-STRG-DESC (1:62)                 06840000
078200***    INFO ON LAST CHECKPOINT TAKEN IS IN                        06850000
078300***    CR-CHECKPOINT-RESTART-AREA.                                06860000
078400         MOVE TCKRSTINF-WORK-STRG-DESC TO                         06870000
078500               CR-CHECKPOINT-RESTART-AREA                         06880000
078600         DISPLAY 'CHECKPOINT RESTART INFORMATION:'                06890000
078700         DISPLAY 'MONTH NBR       ' CR-FISCAL-MN-NBR              06900000
078800         DISPLAY 'MONTH END DATE  ' CR-FISCAL-MN-END-DTE          06910000
078900         DISPLAY 'DEPARTMENT NBR  ' CR-DEPT-NBR                   06920000
31355          DISPLAY 'CHANNEL CODE    ' CR-CHNL-CDE                   06921008
079200         DISPLAY 'INPUT RECS READ ' CR-INPUT-READ-COUNT           06930000
079300     END-IF.                                                      06940000
079400*                                                                 06950000
079500     OPEN INPUT EXTRACT-FILE.                                     06960000
079600     MOVE ZEROES                          TO PA-INPUT-COUNT.      06970000
079700*                                                                 06980000
079800*POSITION INPUT FILE TO 1ST RECORD AFTER LAST CHECKPOINT          06990000
079900     PERFORM 4000-READ-EXTRACT-FILE                               07000000
080000         UNTIL PA-INPUT-COUNT > CR-INPUT-READ-COUNT               07010000
080100           OR PS-NO-MORE-INPUT-RECORDS.                           07020000
080200     IF PS-NO-MORE-INPUT-RECORDS                                  07030000
080300         DISPLAY 'END OF INPUT FILE ON RESTART'                   07040000
080400     ELSE                                                         07050000
080500         DISPLAY 'INPUT RECORD RESTARTED ON RECORD '              07060000
080600                  PA-INPUT-COUNT                                  07070000
080700         DISPLAY 'FISCAL MONTH NBR      ' ML127-FSCL-MN-NBR       07080000
080800         DISPLAY 'FISCAL MONTH END DATE ' ML127-FSCL-MN-END-DTE   07090000
080900         DISPLAY 'DEPARTMENT NBR        ' ML127-DEPT-NBR          07100000
31355          DISPLAY 'CHANNEL CODE          ' ML127-CHNL-CDE          07101008
081200     END-IF.                                                      07110000
081300*                                                                 07120000
081400*RE-ESTABLISH COUNTS FOR PROCESSED INPUT (FROM CHECKPOINT RECORD) 07130000
081500     MOVE CR-UPD-TMNDOTB-COUNT    TO PA-UPD-TMNDOTB-COUNT.        07140000
081500     MOVE CR-INS-TMNDOTB-COUNT    TO PA-INS-TMNDOTB-COUNT.        07150000
081700     MOVE CR-SEL-TMNDOTB-COUNT    TO PA-SEL-TMNDOTB-COUNT.        07160000
081800     MOVE CR-TMNDOTB-COMMIT-COUNT TO PA-COMMIT-COUNT.             07170000
081900*                                                                 07180000
082000*                                                                 07190000
082100******************************************************************07200000
082200*  RESET STATUS CODE, DISPLAY FINAL COUNTS , CLOSE INPUT FILE    *07210000
082300******************************************************************07220000
082400 8000-EOJ-ROUTINE.                                                07230000
082500*                                                                 07240000
082600     MOVE '0' TO TCKRSTCNTL-CKPT-STAT-CODE.                       07250000
082700     PERFORM 7900-UPDATE-CHECKPOINT-STATUS.                       07260000
082800*                                                                 07270000
082900     DISPLAY '                                             '.     07280000
083000     DISPLAY 'INPUT RECORDS   ', PA-INPUT-COUNT.                  07290000
083100     DISPLAY 'SELECT TMNDOTB  ', PA-SEL-TMNDOTB-COUNT.            07300000
083200     DISPLAY 'UPDATE TMNDOTB  ', PA-UPD-TMNDOTB-COUNT.            07310000
083300     DISPLAY 'INSERT TMNDOTB  ', PA-INS-TMNDOTB-COUNT.            07320000
083400     DISPLAY '                                             '.     07330000
083500     DISPLAY 'COMMITS TAKEN   ', PA-COMMIT-COUNT.                 07340000
083600*                                                                 07350000
083700     CLOSE EXTRACT-FILE.                                          07360000
083800*                                                                 07370000
083900*                                                                 07380000
084000******************************************************************07390000
084100*  PERFORMED BY 6100-UPDATE AND 7200-INSERT                       07400000
084200*  THIS ROUTINE FORCES AN ABEND DUE TO A SQLCODE -911 (3 TIMES)   07410000
084300******************************************************************07420000
084400 9000-DEADLOCK-ERROR.                                             07430000
084500*                                                                 07440000
084600         MOVE PE-MSG-07             TO PV-OPERATION-ATTEMPTED     07450000
084700         PERFORM 9999-SQL-ABEND.                                  07460000
084800*                                                                 07470000
084900******************************************************************07480000
085000*  STANDARD DB2 ERROR ABEND ROUTINE                               07490000
085100*  THIS ROUTINE FORCES AN ABEND DUE TO A DB2 PROBLEM.             07500000
085200******************************************************************07510000
085300 9999-SQL-ABEND.                                                  07520000
085400                                                                  07530000
085500     MOVE +4013                 TO ABEND-CODE.                    07540000
085600     MOVE SQLCODE               TO PV-SQLCODE-DISPLAY.            07550000
085700     DISPLAY '**  ABEND     **'.                                  07560000
085800     DISPLAY '**  PROGRAM   ** => ' PC-PROGRAM-NAME.              07570000
085900     DISPLAY '**  PARAGRAPH **  = ' PV-PARAGRAPH-NAME.            07580000
086000     DISPLAY '**  OPERATION **  = ' PV-OPERATION-ATTEMPTED.       07590000
086100     DISPLAY '**  SQLCODE   **  = ' PV-SQLCODE-DISPLAY.           07600000
086200                                                                  07610000
086300     EXEC SQL                                                     07620000
086400          ROLLBACK                                                07630000
086500     END-EXEC.                                                    07640000
086600                                                                  07650000
086700*    THE FOLLOWING COPYBOOK UTILIZES THE DB2 ABEND MODULE         07660000
086800*    DSNTIAR TO CONVERT SQLCA INTO UNDERSTANDABLE VERBAGE.        07670000
086900                                                                  07680000
087000     COPY DPPD004.                                                07690000
087100     CALL 'ILBOABN0'  USING ABEND-CODE.                           07700000
