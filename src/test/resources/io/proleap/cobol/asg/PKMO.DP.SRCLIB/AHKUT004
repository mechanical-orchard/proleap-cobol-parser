000100 IDENTIFICATION DIVISION.                                         00010000
000200 PROGRAM-ID.    AHKUT004.                                         00020000
000300 AUTHOR.        CHERI MASTEL.                                     00030000
000400 INSTALLATION.  KOHLS.                                            00040000
000500 DATE-WRITTEN   AUG, 1997.                                        00050000
000600 DATE-COMPILED.                                                   00060000
000700                                                                  00070000
000800******************************************************************00080000
000900*   AHKUT004.  "ARCHIVE HISTORY" PROJECT. DATA OFFLOAD.          *00090000
001000*                                                                *00100000
001100*   PURPOSE:                                                     *00110000
001200*   THIS PROGRAM CONTINUES THE PROCESS OF DATA SELECTION TO      *00120000
001300*   CREATE A DRIVER FILE.                                        *00130000
001400*   ONCE COMPLETED, THE DRIVER FILE WILL BE USED BY SUBSEQUENT   *00140000
001500*   PROGRAMS TO IDENTIFY AND EXTRACT COMPLETED PO'S FROM         *00150000
001600*   SEVERAL INTERRELATED TABLES FOR ARCHIVING.                   *00160000
001700*                                                                *00170000
001800*   PROCESSING OVERVIEW:                                         *00180000
001900*   THIS PROGRAM APPLIES SELECTION CRITERIA FROM TABLE TNINREC   *00190000
002000*   TO THE RECORDS IN THE DRIVER FILE, POTENTIALLY REDUCING THE  *00200000
002100*   NUMBER OF RECORDS IN THE DRIVER FILE.                        *00210000
002200*   ALL RECORDS/ROWS FOR THE PURCHASE ORDER (PO) MUST MEET THE   *00220000
002300*   SELECTION CRITERIA FOR THE PO TO REMAIN IN THE DRIVER FILE.  *00230000
002400*                                                                *00240000
002500*   PROCESSING DETAIL:                                           *00250000
002600*   THIS PROGRAM READS A "DRIVER" FILE. FOR EACH RECORD READ,    *00260000
002700*   1) INCREMENT COUNT OF RECORDS READ.                          *00270000
002800*   2) ATTEMPT TO FIND RELATED ROW(S) ON THE TABLE,              *00280000
002900*      WHICH *DO NOT* MEET THE ARCHIVE CRITERIA.                 *00290000
003000*      2.A) IF NO MATCH(ES):                                     *00300000
003100*           2.A.1) LOOP TO WRITE ALL RECORDS FOR THIS PO         *00310000
003200*                  TO THE DRIVER FILE.                           *00320000
003300*           2.A.2) INCREMENT COUNT OF RECORDS WRITTEN.           *00330000
003400*           2.A.3) DO NOT REMOVE THE ROW(S) FROM THE TABLE       *00340000
003500*                  AT THIS TIME.  THEY WILL BE REMOVED IN OTHER  *00350000
003600*                  PROCESSING, AFTER HAVING BEEN LOADED TO THE   *00360000
003700*                  ARCHIVE/HISTORY TABLE.                        *00370000
003800*      2.B) IF MATCH(ES):                                        *00380000
003900*           2.B.1) PROCESSING CONTINUES:                         *00390000
004000*                  LOOP TO READ ALL RECORDS FOR THIS PO.         *00400000
004100*           2.B.2) THESE RECORDS ARE SCREENED OUT OF THE         *00410000
004200*                  DRIVER FILE.                                  *00420000
004300*   3) EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *00430000
004400*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *00440000
004500*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *00450000
004510*----------------------------------------------------------------*00451000
004520*  CHANGE LOG:                                                   *00452000
004530* 06/04/07                                                       *00453001
004540*     INCREASED SIZE OF INPUT AND OUTPUT FILES FROM 186 TO 189.  *00454000
004550*     THIS WAS NEEDED TO ALLOW FOR THE 2 NEW FIELDS IN THE       *00455000
004560*     AHRD001 COPYBOOK: DC-NBR AND MTCH-LVL-CDE.                 *00456000
004570* MADE BY: ROLF NOHE                           WR# 30241         *00457000
004580*----------------------------------------------------------------*00458000
004590******************************************************************00459000
004600 ENVIRONMENT DIVISION.                                            00460000
004700 CONFIGURATION SECTION.                                           00470000
004800 SOURCE-COMPUTER.        IBM-3090.                                00480000
004900 OBJECT-COMPUTER.        IBM-3090.                                00490000
005000                                                                  00500000
005100 INPUT-OUTPUT SECTION.                                            00510000
005200 FILE-CONTROL.                                                    00520000
005300                                                                  00530000
005400     SELECT  IN-DRIVER-FILE               ASSIGN TO IN01.         00540000
005500     SELECT  OUT-DRIVER-FILE              ASSIGN TO OUT01.        00550000
005600                                                                  00560000
005700******************************************************************00570000
005800 DATA DIVISION.                                                   00580000
005900 FILE SECTION.                                                    00590000
006000                                                                  00600000
006100 FD  IN-DRIVER-FILE                                               00610000
006200     RECORDING MODE IS F                                          00620000
006300     LABEL RECORDS ARE STANDARD                                   00630000
006400     BLOCK CONTAINS 0 RECORDS.                                    00640000
006500 01  IN-DRIVER-RECORD                PIC  X(189).                 00650000
006600                                                                  00660000
006700 FD  OUT-DRIVER-FILE                                              00670000
006800     RECORDING MODE IS F                                          00680000
006900     LABEL RECORDS ARE STANDARD                                   00690000
007000     BLOCK CONTAINS 0 RECORDS.                                    00700000
007100 01  OUT-DRIVER-RECORD               PIC  X(189).                 00710000
007200                                                                  00720000
007300 WORKING-STORAGE SECTION.                                         00730000
007400                                                                  00740000
007500 01  PC-PROGRAM-CONSTANTS.                                        00750000
007600     05  PC-CURRENT-PROGRAM-NAME     PIC X(08) VALUE 'AHKUT004'.  00760000
007700     05  PC-PGM-PROGRESS-DESC.                                    00770000
007800         10  PC-BEGINNING            PIC X(09) VALUE 'BEGINNING'. 00780000
007900         10  PC-CONTINUING           PIC X(10) VALUE              00790000
008000                                               'CONTINUING'.      00800000
008100         10  PC-ENDING               PIC X(06) VALUE 'ENDING'.    00810000
008200         10  PC-ABENDING             PIC X(08) VALUE 'ABENDING'.  00820000
008300     05  PC-ABEND-INFO.                                           00830000
008400         10  PC-ABEND                PIC X(11) VALUE              00840000
008500                                               '** ABEND **'.     00850000
008600         10  PC-ABEND-MSG-PARA       PIC X(15) VALUE              00860000
008700                                               '- PARA       : '. 00870000
008800         10  PC-ABEND-MSG-DISPLAY-PARA                            00880000
008900                                     PIC X(15) VALUE              00890000
009000                                               '  CALLED PARA: '. 00900000
009100         10  PC-ABEND-MSG-NUMBER     PIC X(15) VALUE              00910000
009200                                               '  FOR ABEND# : '. 00920000
009300         10  PC-ABEND-MSG-DESC       PIC X(15) VALUE              00930000
009400                                               '- ERROR IS   : '. 00940000
009500         10  PC-ABEND-MSG-INDENT-15  PIC X(15) VALUE SPACES.      00950000
009600         10  PC-ABEND-MSG-ACTION     PIC X(15) VALUE              00960000
009700                                               '- ACTION     : '. 00970000
009800     05  PC-POS                      PIC X     VALUE '+'.         00980000
009900     05  PC-NEG                      PIC X     VALUE '-'.         00990000
010000     05  PC-HOW-OFTEN-TO-DISPLAY     PIC 9(9)  VALUE 100000.      01000000
010100                                                                  01010000
010200 01  PS-PROGRAM-SWITCHES.                                         01020000
010300     05  PS-CONTROL-BREAK-SW         PIC X(01) VALUE 'N'.         01030000
010400         88  PS-CONTROL-BREAK                  VALUE 'Y'.         01040000
010500         88  PS-RESET-CONTROL-BREAK            VALUE 'N'.         01050000
010600     05  PS-IN-DRIVER-EOF-SW         PIC X(01) VALUE 'N'.         01060000
010700         88  PS-IN-DRIVER-EOF                  VALUE 'Y'.         01070000
010800         88  PS-IN-DRIVER-NOT-EOF              VALUE 'N'.         01080000
010900     05  PS-CURSOR-HAS-DATA-SW       PIC X(01) VALUE 'N'.         01090000
011000         88  PS-CURSOR-HAS-DATA                VALUE 'Y'.         01100000
011100         88  PS-CURSOR-HAS-NO-DATA             VALUE 'N'.         01110000
011200                                                                  01120000
011300 01  PV-PROGRAM-VARIABLES.                                        01130000
011400     05  PV-DRIVER-READ-IN-CNT       PIC  9(9) VALUE 0.           01140000
011500     05  PV-DRIVER-READ-PO-CNT       PIC  9(9) VALUE 0.           01150000
011600     05  PV-CURSORS-TOTAL-CNT        PIC  9(9) VALUE 0.           01160000
011700     05  PV-CURSORS-NONSELECT-CNT    PIC  9(9) VALUE 0.           01170000
011800     05  PV-ROW-COUNT                PIC S9(9) VALUE 0 COMP.      01180000
011900     05  PV-CURSORS-PO-SELECT-CNT    PIC  9(9) VALUE 0.           01190000
012000     05  PV-DRIVER-WRITTEN-CNT       PIC  9(9) VALUE 0.           01200000
012100     05  PV-PO-NBR                   PIC S9(9) COMP.              01210000
012200     05  PV-2-SPACES                 PIC X(02) VALUE SPACES.      01220000
012300     05  PV-PREV-PO-NBR              PIC S9(9) COMP.              01230000
012400     05  PV-PARAGRAPH-NAME           PIC X(30) VALUE SPACES.      01240000
012500     05  PV-DB2-OPERATION-MSG-1      PIC X(79) VALUE SPACES.      01250000
012600     05  PV-DB2-TABLE-NAME-1         PIC X(18) VALUE SPACES.      01260000
012700     05  PV-DB2-TABLE-NAME-2         PIC X(18) VALUE SPACES.      01270000
012800     05  PV-DISPLAY-NTH-MULTIPLE     PIC  9(9) VALUE 0.           01280000
012900     05  PV-DISPLAY-NTH-REMAINDER    PIC  9(9) VALUE 0.           01290000
013000     05  PV-SQLCODE                  PIC +999  VALUE ZERO.        01300000
013100                                                                  01310000
013200     05  PV-TMST                     PIC X(26) VALUE SPACES.      01320000
013300     05  PV-TIMESTAMP-DETAIL                                      01330000
013400         REDEFINES                                                01340000
013500         PV-TMST.                                                 01350000
013600         10  PV-TIMESTAMP-19.                                     01360000
013700             15  PV-TMS-DATE.                                     01370000
013800                 20  PV-TMS-YEAR.                                 01380000
013900                     25  PV-TMS-CC   PIC X(02).                   01390000
014000                     25  PV-TMS-YY   PIC X(02).                   01400000
014100                 20  FILLER          PIC X(01).                   01410000
014200                 20  PV-TMS-MONTH    PIC X(02).                   01420000
014300                 20  FILLER          PIC X(01).                   01430000
014400                 20  PV-TMS-DAY      PIC X(02).                   01440000
014500             15  FILLER              PIC X(01).                   01450000
014600             15  PV-TMS-HOUR         PIC X(02).                   01460000
014700             15  FILLER              PIC X(01).                   01470000
014800             15  PV-TMS-MINUTE       PIC X(02).                   01480000
014900             15  FILLER              PIC X(01).                   01490000
015000             15  PV-TMS-SECOND       PIC X(02).                   01500000
015100         10  FILLER                  PIC X(01).                   01510000
015200         10  PV-TMS-MSECOND          PIC X(06).                   01520000
015300                                                                  01530000
015400                                                                  01540000
015500*---------------------------------------------------------------* 01550000
015600*  RECORD LAYOUT FOR DRIVER FILE                                * 01560000
015700*---------------------------------------------------------------* 01570000
015800     COPY AHRD001.                                                01580000
015900                                                                  01590000
016000                                                                  01600000
016100 01  DM-DISPLAY-MESSAGE.                                          01610000
016200     05  DM-01-10.                                                01620000
016300         10  DM-PROGRAM              PIC X(08) VALUE SPACE.       01630000
016400         10  FILLER                  PIC X(02) VALUE ': '.        01640000
016500     05  DM-11-80.                                                01650000
016600         10  FILLER                  PIC X(38) VALUE              01660000
016700                        'APPLY TNINREC CRITERIA TO DRIVER FILE.'. 01670000
016800         10  FILLER                  PIC X(01) VALUE SPACE.       01680000
016900         10  FILLER                  PIC X(31) VALUE ALL '*'.     01690000
017000     05  DM-81-120.                                               01700000
017100         10  FILLER                  PIC X(40) VALUE ALL '*'.     01710000
017200                                                                  01720000
017300 01  DP-DISPLAY-PROGRESS-MSG.                                     01730000
017400     05  DP-PROGRAM                  PIC X(08) VALUE SPACE.       01740000
017500     05  FILLER                      PIC X(02) VALUE SPACE.       01750000
017600     05  DP-STATUS-DESCRIPTION       PIC X(10) VALUE SPACE.       01760000
017700     05  FILLER                      PIC X(04) VALUE ' AT '.      01770000
017800     05  DP-TIMESTAMP-19             PIC X(19) VALUE SPACE.       01780000
017900     05  FILLER                      PIC X(03) VALUE '.  '.       01790000
018000     05  FILLER                      PIC X(03) VALUE 'IN:'.       01800000
018100     05  DP-DRIVER-READ-IN-CNT       PIC ZZZ,ZZZ,ZZ9              01810000
018200                                               VALUE ZERO.        01820000
018300     05  FILLER                      PIC X(02) VALUE ', '.        01830000
018400     05  FILLER                      PIC X(05) VALUE 'PO"S:'.     01840000
018500     05  DP-DRIVER-READ-PO-CNT       PIC ZZZ,ZZZ,ZZ9              01850000
018600                                               VALUE ZERO.        01860000
018700     05  FILLER                      PIC X(02) VALUE ', '.        01870000
018800*    05  FILLER                      PIC X(08) VALUE              01880000
018900*                                              'CURSORS:'.        01890000
019000*    05  DP-CURSORS-TOTAL-CNT        PIC ZZZ,ZZZ,ZZ9              01900000
019100*                                              VALUE ZERO.        01910000
019200*    05  FILLER                      PIC X(02) VALUE ', '.        01920000
019300*    05  FILLER                      PIC X(10) VALUE              01930000
019400*                                              'NONSELECT:'.      01940000
019500*    05  DP-CURSORS-NONSELECT-CNT    PIC ZZZ,ZZZ,ZZ9              01950000
019600*                                              VALUE ZERO.        01960000
019700*    05  FILLER                      PIC X(02) VALUE ', '.        01970000
019800     05  FILLER                      PIC X(10) VALUE              01980000
019900                                               'PO SELECT:'.      01990000
020000     05  DP-CURSORS-PO-SELECT-CNT    PIC ZZZ,ZZZ,ZZ9              02000000
020100                                               VALUE ZERO.        02010000
020200     05  FILLER                      PIC X(02) VALUE ', '.        02020000
020300     05  FILLER                      PIC X(04) VALUE 'OUT:'.      02030000
020400     05  DP-DRIVER-WRITTEN-CNT       PIC ZZZ,ZZZ,ZZ9              02040000
020500                                               VALUE ZERO.        02050000
020600     05  FILLER                      PIC X(01) VALUE '.'.         02060000
020700                                                                  02070000
020800 01  ABEND-CODE                      PIC S9(04)                   02080000
020900                                               VALUE ZEROES       02090000
021000                                               COMP SYNC.         02100000
021100                                                                  02110000
021200*---------------------------------------------------------------* 02120000
021300*  DB2 FORMATTED MESSAGE AREA                                     02130000
021400*---------------------------------------------------------------* 02140000
021500     COPY DPWS004.                                                02150000
021600                                                                  02160000
021700*---------------------------------------------------------------* 02170000
021800*    DB2 AREA FOR TNINREC                                       * 02180000
021900*---------------------------------------------------------------* 02190000
022000     EXEC SQL                                                     02200000
022100          INCLUDE TNINREC                                         02210000
022200     END-EXEC.                                                    02220000
022300                                                                  02230000
022400*---------------------------------------------------------------* 02240000
022500*    DB2 AREA FOR COMMUNICATIONS                                * 02250000
022600*---------------------------------------------------------------* 02260000
022700     EXEC SQL                                                     02270000
022800          INCLUDE SQLCA                                           02280000
022900     END-EXEC.                                                    02290000
023000                                                                  02300000
023100*---------------------------------------------------------------* 02310000
023200*    DEFINE CURSOR FOR PULLING ROW(S) FROM TNINREC              * 02320000
023300*    WHICH DO *NOT* MEET THE SELECTION CRITERIA;                * 02330000
023400*    IF ANY ROW(S) ARE RETURNED, THIS PURCHASE ORDER (PO) WILL  * 02340000
023500*    *NOT* REMAIN IN THE DRIVER FILE.                           * 02350000
023600*---------------------------------------------------------------* 02360000
023700     EXEC SQL                                                     02370000
023800         DECLARE NONSELECT-CURSOR CURSOR FOR                      02380000
023900          SELECT COUNT(*)                                         02390000
024000            FROM TNINREC                                          02400000
024100           WHERE (PO_NBR     = :PV-PO-NBR)                        02410000
024200             AND (STATUS_CDE = :PV-2-SPACES)                      02420000
024300          FOR FETCH ONLY                                          02430000
024400          WITH UR                                                 02440000
024500     END-EXEC.                                                    02450000
024600                                                                  02460000
024700                                                                  02470000
024800 PROCEDURE DIVISION.                                              02480000
024900                                                                  02490000
025000 0000-PROGRAM-MAINLINE.                                           02500000
025100                                                                  02510000
025200     PERFORM 1000-INITIALIZE.                                     02520000
025300                                                                  02530000
025400     PERFORM 2000-PROCESS-ONE-PO                                  02540000
025500         UNTIL PS-IN-DRIVER-EOF.                                  02550000
025600                                                                  02560000
025700     PERFORM 6000-EOJ-ROUTINE.                                    02570000
025800     STOP RUN.                                                    02580000
025900                                                                  02590000
026000                                                                  02600000
026100******************************************************************02610000
026200*   INITIALIZATIONS                                              *02620000
026300******************************************************************02630000
026400 1000-INITIALIZE.                                                 02640000
026500                                                                  02650000
026600     MOVE PC-CURRENT-PROGRAM-NAME TO DM-PROGRAM.                  02660000
026700     DISPLAY DM-DISPLAY-MESSAGE.                                  02670000
026800                                                                  02680000
026900     MOVE PC-BEGINNING  TO  DP-STATUS-DESCRIPTION.                02690000
027000     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           02700000
027100                                                                  02710000
027200     OPEN  INPUT  IN-DRIVER-FILE                                  02720000
027300          OUTPUT OUT-DRIVER-FILE.                                 02730000
027400                                                                  02740000
027500     SET PS-IN-DRIVER-NOT-EOF TO TRUE.                            02750000
027600     PERFORM 9050-READ-IN-DRIVER-FILE.                            02760000
027700                                                                  02770000
027800******************************************************************02780000
027900*   PROCESS EACH RECORD FROM THE SEQUENTIAL DRIVER FILE.         *02790000
028000*   - CONTROL BREAK ON PO.                                       *02800000
028100*     PROCESS THE FIRST RECORD IN THE DRIVER FILE FOR THIS PO.   *02810000
028200*   - THIS WILL DETERMINE ACTION TO BE TAKEN FOR EACH            *02820000
028300*     SUBSEQUENT RECORD FOR THIS PO.                             *02830000
028400******************************************************************02840000
028500 2000-PROCESS-ONE-PO.                                             02850000
028600                                                                  02860000
028700     MOVE AH001-B-PO-NBR        TO PV-PREV-PO-NBR                 02870000
028800                                   PV-PO-NBR.                     02880000
028900     SET PS-RESET-CONTROL-BREAK TO TRUE.                          02890000
029000                                                                  02900000
029100     ADD +1                     TO PV-CURSORS-TOTAL-CNT.          02910000
029200     SET PS-CURSOR-HAS-NO-DATA  TO TRUE.                          02920000
029300     PERFORM 9100-OPEN-NONSELECT-CURSOR.                          02930000
029400     PERFORM 9110-FETCH-NONSELECT-CURSOR.                         02940000
029500                                                                  02950000
029600     IF PS-CURSOR-HAS-DATA                                        02960000
029700         ADD +1 TO PV-CURSORS-NONSELECT-CNT                       02970000
029800         PERFORM 9050-READ-IN-DRIVER-FILE                         02980000
029900             UNTIL PS-IN-DRIVER-EOF                               02990000
030000                OR PS-CONTROL-BREAK                               03000000
030100     ELSE                                                         03010000
030200         ADD +1 TO PV-CURSORS-PO-SELECT-CNT                       03020000
030300         PERFORM 2020-LOOP-TIL-NEXT-PO                            03030000
030400             UNTIL PS-IN-DRIVER-EOF                               03040000
030500                OR PS-CONTROL-BREAK                               03050000
030600     END-IF.                                                      03060000
030700                                                                  03070000
030800     PERFORM 9190-CLOSE-NONSELECT-CURSOR.                         03080000
030900                                                                  03090000
031000                                                                  03100000
031100******************************************************************03110000
031200*   COPY EACH RECORD FOR THIS PO FROM THE INPUT DRIVER FILE      *03120000
031300*   TO THE OUTPUT DRIVER FILE.                                   *03130000
031400******************************************************************03140000
031500 2020-LOOP-TIL-NEXT-PO.                                           03150000
031600                                                                  03160000
031700     PERFORM 9650-WRITE-DRIVER-RECORD.                            03170000
031800                                                                  03180000
031900     PERFORM 9050-READ-IN-DRIVER-FILE.                            03190000
032000                                                                  03200000
032100                                                                  03210000
032200******************************************************************03220000
032300*      EVERY NTH RECORD (IE: INITIAL SETTING 1000), REPORT       *03230000
032400*      RECORD COUNT AND CURRENT DATE/TIME.  THIS WILL ASSIST     *03240000
032500*      WITH RUN-TIME ESTIMATE OF TIME REMAINING TO COMPLETE.     *03250000
032600******************************************************************03260000
032700 2100-CHECK-PGM-PROGRESS.                                         03270000
032800                                                                  03280000
032900     DIVIDE    PV-DRIVER-READ-IN-CNT                              03290000
033000         BY        PC-HOW-OFTEN-TO-DISPLAY                        03300000
033100         GIVING    PV-DISPLAY-NTH-MULTIPLE                        03310000
033200         REMAINDER PV-DISPLAY-NTH-REMAINDER.                      03320000
033300                                                                  03330000
033400     IF PV-DISPLAY-NTH-REMAINDER = ZERO                           03340000
033500         MOVE PC-CONTINUING         TO DP-STATUS-DESCRIPTION      03350000
033600         PERFORM 6200-DISPLAY-PGM-PROGRESS                        03360000
033700     END-IF.                                                      03370000
033800                                                                  03380000
033900                                                                  03390000
034000******************************************************************03400000
034100*   CLOSE FILES, CURSOR, AND DISPLAY END OF RUN MESSAGE.         *03410000
034200******************************************************************03420000
034300 6000-EOJ-ROUTINE.                                                03430000
034400                                                                  03440000
034500     MOVE PC-ENDING  TO  DP-STATUS-DESCRIPTION.                   03450000
034600                                                                  03460000
034700     CLOSE IN-DRIVER-FILE                                         03470000
034800           OUT-DRIVER-FILE.                                       03480000
034900                                                                  03490000
035000     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           03500000
035100                                                                  03510000
035200                                                                  03520000
035300******************************************************************03530000
035400*   DISPLAY PROGRAM PROGRESS.                                    *03540000
035500******************************************************************03550000
035600 6200-DISPLAY-PGM-PROGRESS.                                       03560000
035700                                                                  03570000
035800     EXEC SQL                                                     03580000
035900          SET :PV-TMST = CURRENT TIMESTAMP                        03590000
036000     END-EXEC.                                                    03600000
036100                                                                  03610000
036200     MOVE PC-CURRENT-PROGRAM-NAME   TO DP-PROGRAM.                03620000
036300     MOVE PV-TIMESTAMP-19           TO DP-TIMESTAMP-19.           03630000
036400     MOVE PV-DRIVER-READ-IN-CNT     TO DP-DRIVER-READ-IN-CNT.     03640000
036500     MOVE PV-DRIVER-READ-PO-CNT     TO DP-DRIVER-READ-PO-CNT.     03650000
036600*    MOVE PV-CURSORS-TOTAL-CNT      TO DP-CURSORS-TOTAL-CNT.      03660000
036700*    MOVE PV-CURSORS-NONSELECT-CNT  TO DP-CURSORS-NONSELECT-CNT.  03670000
036800     MOVE PV-CURSORS-PO-SELECT-CNT  TO DP-CURSORS-PO-SELECT-CNT.  03680000
036900     MOVE PV-DRIVER-WRITTEN-CNT     TO DP-DRIVER-WRITTEN-CNT.     03690000
037000                                                                  03700000
037100     DISPLAY DP-DISPLAY-PROGRESS-MSG.                             03710000
037200                                                                  03720000
037300                                                                  03730000
037400******************************************************************03740000
037500*   READ  INPUT DRIVER FILE OF ELIGIBLE DATA TO EXTRACT          *03750000
037600******************************************************************03760000
037700 9050-READ-IN-DRIVER-FILE.                                        03770000
037800                                                                  03780000
037900     READ IN-DRIVER-FILE                                          03790000
038000          INTO AH001-DRIVER-RECORD-LAYOUT                         03800000
038100          AT END                                                  03810000
038200              SET PS-IN-DRIVER-EOF TO TRUE.                       03820000
038300                                                                  03830000
038400     IF PS-IN-DRIVER-EOF                                          03840000
038500         CONTINUE                                                 03850000
038600     ELSE                                                         03860000
038700         ADD +1                    TO PV-DRIVER-READ-IN-CNT       03870000
038800         IF AH001-B-PO-NBR = PV-PREV-PO-NBR                       03880000
038900             CONTINUE                                             03890000
039000         ELSE                                                     03900000
039100             SET PS-CONTROL-BREAK  TO TRUE                        03910000
039200             ADD +1                TO PV-DRIVER-READ-PO-CNT       03920000
039300         END-IF                                                   03930000
039400         PERFORM 2100-CHECK-PGM-PROGRESS                          03940000
039500     END-IF.                                                      03950000
039600                                                                  03960000
039700                                                                  03970000
039800                                                                  03980000
039900                                                                  03990000
040000******************************************************************04000000
040100*   OPEN  TABLE CURSOR                                           *04010000
040200******************************************************************04020000
040300 9100-OPEN-NONSELECT-CURSOR.                                      04030000
040400     EXEC SQL                                                     04040000
040500          OPEN NONSELECT-CURSOR                                   04050000
040600     END-EXEC.                                                    04060000
040700                                                                  04070000
040800     EVALUATE TRUE                                                04080000
040900         WHEN SQLCODE = ZERO                                      04090000
041000              CONTINUE                                            04100000
041100         WHEN SQLWARN0 NOT EQUAL SPACE                            04110000
041200         WHEN SQLCODE  NOT EQUAL ZERO                             04120000
041300              MOVE '9100-OPEN-NONSELECT-CURSOR'                   04130000
041400                                 TO PV-PARAGRAPH-NAME             04140000
041500              MOVE 'OPEN TABLE CURSOR'                            04150000
041600                                 TO PV-DB2-OPERATION-MSG-1        04160000
041700              MOVE 'TNINREC'     TO PV-DB2-TABLE-NAME-1           04170000
041800              PERFORM 9999-DB2-ABEND                              04180000
041900     END-EVALUATE.                                                04190000
042000                                                                  04200000
042100                                                                  04210000
042200******************************************************************04220000
042300*   FETCH TABLE CURSOR                                           *04230000
042400******************************************************************04240000
042500 9110-FETCH-NONSELECT-CURSOR.                                     04250000
042600     EXEC SQL                                                     04260000
042700         FETCH NONSELECT-CURSOR                                   04270000
042800          INTO  :PV-ROW-COUNT                                     04280000
042900     END-EXEC.                                                    04290000
043000                                                                  04300000
043100     EVALUATE TRUE                                                04310000
043200         WHEN SQLCODE = ZERO                                      04320000
043300              CONTINUE                                            04330000
043400         WHEN SQLWARN0 NOT EQUAL SPACE                            04340000
043500         WHEN SQLCODE NOT EQUAL ZERO                              04350000
043600              MOVE '9110-FETCH-NONSELECT-CURSOR'                  04360000
043700                                 TO PV-PARAGRAPH-NAME             04370000
043800              MOVE 'FETCH TABLE CURSOR'                           04380000
043900                                 TO PV-DB2-OPERATION-MSG-1        04390000
044000              MOVE 'TNINREC'     TO PV-DB2-TABLE-NAME-1           04400000
044100              PERFORM 9999-DB2-ABEND                              04410000
044200     END-EVALUATE.                                                04420000
044300                                                                  04430000
044400     IF PV-ROW-COUNT > 0                                          04440000
044500          SET PS-CURSOR-HAS-DATA    TO TRUE                       04450000
044600     ELSE                                                         04460000
044700          SET PS-CURSOR-HAS-NO-DATA TO TRUE                       04470000
044800     END-IF.                                                      04480000
044900                                                                  04490000
045000******************************************************************04500000
045100*   CLOSE TABLE CURSOR                                           *04510000
045200******************************************************************04520000
045300 9190-CLOSE-NONSELECT-CURSOR.                                     04530000
045400     EXEC SQL                                                     04540000
045500          CLOSE NONSELECT-CURSOR                                  04550000
045600     END-EXEC.                                                    04560000
045700                                                                  04570000
045800     EVALUATE TRUE                                                04580000
045900         WHEN SQLCODE = ZERO                                      04590000
046000              CONTINUE                                            04600000
046100         WHEN SQLWARN0 NOT EQUAL SPACE                            04610000
046200         WHEN SQLCODE NOT EQUAL ZERO                              04620000
046300              MOVE '9190-CLOSE-NONSELECT-CURSOR'                  04630000
046400                                 TO PV-PARAGRAPH-NAME             04640000
046500              MOVE 'CLOSE TABLE CURSOR'                           04650000
046600                                 TO PV-DB2-OPERATION-MSG-1        04660000
046700              MOVE 'TNINREC'     TO PV-DB2-TABLE-NAME-1           04670000
046800              PERFORM 9999-DB2-ABEND                              04680000
046900     END-EVALUATE.                                                04690000
047000                                                                  04700000
047100                                                                  04710000
047200                                                                  04720000
047300                                                                  04730000
047400******************************************************************04740000
047500*   WRITE A RECORD TO THE DRIVER FILE                            *04750000
047600******************************************************************04760000
047700 9650-WRITE-DRIVER-RECORD.                                        04770000
047800     WRITE  OUT-DRIVER-RECORD  FROM  AH001-DRIVER-RECORD-LAYOUT.  04780000
047900     ADD +1 TO PV-DRIVER-WRITTEN-CNT.                             04790000
048000                                                                  04800000
048100                                                                  04810000
048200                                                                  04820000
048300                                                                  04830000
048400******************************************************************04840000
048500*   DISPLAY INFORMATION NEEDED FOR DEBUGGING/MAINTENANCE/SUPPORT *04850000
048600*   AND CALL THE ABEND PROCESSOR IN THE EVENT THAT AN            *04860000
048700*   SQL ERROR OR WARNING CODE OCCURS.                            *04870000
048800******************************************************************04880000
048900 9999-DB2-ABEND.                                                  04890000
049000     DISPLAY PC-CURRENT-PROGRAM-NAME                              04900000
049100             ' 9999-DB2-ABEND'.                                   04910000
049200     DISPLAY PC-CURRENT-PROGRAM-NAME                              04920000
049300             ' ** ABEND           **'.                            04930000
049400     DISPLAY PC-CURRENT-PROGRAM-NAME                              04940000
049500             ' ** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.       04950000
049600     DISPLAY PC-CURRENT-PROGRAM-NAME                              04960000
049700             ' ** TABLES AFFECTED ** = ' PV-DB2-TABLE-NAME-1.     04970000
049800     DISPLAY PC-CURRENT-PROGRAM-NAME                              04980000
049900             ' **                 ** = ' PV-DB2-TABLE-NAME-2.     04990000
050000     DISPLAY PC-CURRENT-PROGRAM-NAME                              05000000
050100             ' ** OPERATION       ** = ' PV-DB2-OPERATION-MSG-1.  05010000
050200                                                                  05020000
050300     DISPLAY PC-CURRENT-PROGRAM-NAME                              05030000
050400             ' ** SQLCODE         ** = ' SQLCODE.                 05040000
050500     MOVE SQLCODE TO PV-SQLCODE.                                  05050000
050600     DISPLAY PC-CURRENT-PROGRAM-NAME                              05060000
050700             ' ** PV-SQLCODE      ** = ' PV-SQLCODE '.'.          05070000
050800                                                                  05080000
050900     DISPLAY PC-CURRENT-PROGRAM-NAME                              05090000
051000             ' ** SQLWARN0        ** = ' SQLWARN0 '.'.            05100000
051100                                                                  05110000
051200                                                                  05120000
051300*----------------------------------------------------------------*05130000
051400* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-   *05140000
051500* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE        *05150000
051600* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE    *05160000
051700* FORMAT.                                                        *05170000
051800*----------------------------------------------------------------*05180000
051900     COPY DPPD004.                                                05190000
052000                                                                  05200000
052100     MOVE PC-ABENDING               TO DP-STATUS-DESCRIPTION.     05210000
052200     PERFORM 6200-DISPLAY-PGM-PROGRESS.                           05220000
052300                                                                  05230000
052400                                                                  05240000
052500*----------------------------------------------------------------*05250000
052600* CALL ABEND                                                     *05260000
052700*----------------------------------------------------------------*05270000
052800     MOVE +4013                  TO ABEND-CODE.                   05280000
052900     CALL 'ILBOABN0' USING ABEND-CODE.                            05290000
053000*                                                                 05300000
