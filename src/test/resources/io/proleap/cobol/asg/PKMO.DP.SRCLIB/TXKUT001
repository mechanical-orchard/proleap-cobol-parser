000100 IDENTIFICATION DIVISION.                                         00010027
000200 PROGRAM-ID.   TXKUT001.                                          00020027
000300 AUTHOR.       KARL KENDRICK.                                     00030027
000400 DATE-WRITTEN. MAY 2007.                                          00040027
000500******************************************************************00050027
000600*  MODULE TYPE:   COBOL2 DB2 BATCH                                00060027
000700*                                                                 00070027
000800*  DESCRIPTION: THIS PROGRAM WILL USE SKUS ENTERED IN A CONTROL   00080027
000900*               CARD TO COUNT AND ACCUMULATE RECYCLE FEE'S CHARGED00090027
001000*               FOR PORTABLE DVD PLAYERS AND TELEVISIONS BY       00100027
001100*               STORE IN ORDER TO CREATE AN EXTRACT FILE WHICH    00110027
001200*               WILL BE USED TO FEED REPORT PROGRAM TXKRP001.     00120027
001300* JOB:  TXK510                                                    00130027
001400******************************************************************00140027
001500 ENVIRONMENT DIVISION.                                            00150027
001600 CONFIGURATION SECTION.                                           00160027
001700 SOURCE-COMPUTER.        IBM-3090.                                00170027
001800 OBJECT-COMPUTER.        IBM-3090.                                00180027
001900                                                                  00190027
002000 INPUT-OUTPUT SECTION.                                            00200027
002100                                                                  00210027
002200 FILE-CONTROL.                                                    00220027
002300                                                                  00230027
002400     SELECT DATE-CONTROL-FILE                                     00240027
002500       ASSIGN TO INP01.                                           00250027
002600                                                                  00260027
002700     SELECT SKU-CONTROL-FILE                                      00270027
002800       ASSIGN TO INP02.                                           00280027
002900                                                                  00290027
003000     SELECT RECYCLE-FEE-EXTRACT-FILE                              00300027
003100       ASSIGN TO OUT01.                                           00310027
003200                                                                  00320027
003300******************************************************************00330027
003400 DATA DIVISION.                                                   00340027
003500 FILE SECTION.                                                    00350027
003600                                                                  00360027
003700 FD  DATE-CONTROL-FILE                                            00370027
003800     RECORDING MODE F                                             00380027
003900     BLOCK CONTAINS 0 RECORDS                                     00390027
004000     LABEL RECORDS ARE OMITTED.                                   00400027
004100 01  DATE-CONTROL-RECORD                  PIC  X(80).             00410027
004200                                                                  00420027
004300 FD  SKU-CONTROL-FILE                                             00430027
004400     RECORDING MODE F                                             00440027
004500     BLOCK CONTAINS 0 RECORDS                                     00450027
004600     LABEL RECORDS ARE OMITTED.                                   00460027
004700 01  SKU-CONTROL-RECORD                   PIC  X(80).             00470027
004800                                                                  00480027
004900 FD  RECYCLE-FEE-EXTRACT-FILE                                     00490027
005000     RECORDING MODE F                                             00500027
005100     BLOCK CONTAINS 0 RECORDS                                     00510027
005200     LABEL RECORDS ARE OMITTED.                                   00520027
005300 01  RECYCLE-FEE-EXTRACT-RECORD           PIC  X(100).            00530027
005400                                                                  00540027
005500 WORKING-STORAGE SECTION.                                         00550027
005600                                                                  00560027
005700************************************************************      00570027
005800* CONTROL CARDS - FISCAL PERIOD END DATE                          00580027
005900************************************************************      00590027
006000 01  CC-DATE-CONTROL-CARD.                                        00600027
006100     05  CC-FISCAL-END-DATE          PIC  X(10) VALUE SPACE.      00610027
006200     05  CC-FISCAL-END-DATE-R REDEFINES CC-FISCAL-END-DATE.       00620027
006300         10  CC-FISCAL-END-CCYY      PIC  X(04).                  00630027
006400         10  FILLER                  PIC  X.                      00640027
006500         10  CC-FISCAL-END-MM        PIC  X(02).                  00650027
006600         10  FILLER                  PIC  X.                      00660027
006700         10  CC-FISCAL-END-DD        PIC  X(02).                  00670027
006800     05  FILLER                      PIC  X(70) VALUE SPACE.      00680027
006900                                                                  00690027
007000************************************************************      00700027
007100* CONTROL CARDS - SKU NUMBER                                      00710027
007200************************************************************      00720027
007300 01  CC-SKU-CONTROL-CARD.                                         00730027
007400     05  CC-SKU-NBR                  PIC  9(08) VALUE ZERO.       00740027
007500     05  CC-SKU-NBR-X REDEFINES                                   00750027
007600         CC-SKU-NBR                  PIC  X(08).                  00760027
007700     05  FILLER                      PIC  X(72) VALUE SPACE.      00770027
007800                                                                  00780027
007900************************************************************      00790027
008000* PS PROGRAM SWITCHES                                             00800027
008100************************************************************      00810027
008200 01  PS-PROGRAM-SWITCHES.                                         00820027
008300     05  PS-DATE-CONTROL-EOF-SW     PIC  X(001) VALUE 'N'.        00830027
008400       88  PS-DATE-CONTROL-EOF-YES              VALUE 'Y'.        00840027
008500       88  PS-DATE-CONTROL-EOF-NO               VALUE 'N'.        00850027
008600                                                                  00860027
008700     05  PS-SKU-CONTROL-EOF-SW      PIC  X(001) VALUE 'N'.        00870027
008800       88  PS-SKU-CONTROL-EOF-YES               VALUE 'Y'.        00880027
008900       88  PS-SKU-CONTROL-EOF-NO                VALUE 'N'.        00890027
009000                                                                  00900027
009100     05  PS-RECYCLE-FEE-CURSOR-EOF-SW PIC X(001) VALUE 'N'.       00910027
009200       88  PS-RECYCLE-FEE-CURSOR-EOF-YES         VALUE 'Y'.       00920027
009300       88  PS-RECYCLE-FEE-CURSOR-EOF-NO          VALUE 'N'.       00930027
009400                                                                  00940027
009500     05  PS-SKU-DESC-FOUND-SW PIC X(001) VALUE 'N'.               00950027
009600       88  PS-SKU-DESC-FOUND-YES                 VALUE 'Y'.       00960027
009700       88  PS-SKU-DESC-FOUND-NO                  VALUE 'N'.       00970027
009800                                                                  00980027
009900************************************************************      00990027
010000* PROGRAM CONSTANTS                                               01000027
010100************************************************************      01010027
010200 01  PC-PROGRAM-CONSTANTS.                                        01020027
010300     05  PC-CURRENT-PROGRAM-NAME   PIC  X(008)  VALUE 'TXKUT001'. 01030027
010400     05  PC-MAX-RETRIES            PIC S9(004)  COMP   VALUE +3.  01040027
010500                                                                  01050027
010600************************************************************      01060027
010700* PV PROGRAM VARIABLES                                            01070027
010800************************************************************      01080027
010900 01  PV-PROGRAM-VARAIBLES.                                        01090027
011000     05  PV-SQL-SUB                   PIC S9(04) COMP VALUE +0.   01100027
011100     05  PV-MAX-SKU-TABLE-SUB         PIC S9(04) COMP VALUE +100. 01110027
011200     05  PV-HOLD-PERIOD-START-DTE     PIC X(10)  VALUE SPACE.     01120027
011300     05  PV-HOLD-PERIOD-END-DTE       PIC X(10)  VALUE SPACE.     01130027
011400                                                                  01140027
011500************************************************************      01150027
011600* SKU NUMBERS TO BE PROCESSED                                     01160027
011700************************************************************      01170027
011800 01  PV-SKU-DATA-TABLE.                                           01180027
011900     05  PV-SKU-DATA-ENTRYS OCCURS 100 TIMES                      01190027
012000         INDEXED BY PV-SKU-NDX1.                                  01200027
012100         10  PV-SKU-NBR                   PIC  9(08)  VALUE ZERO. 01210027
012200                                                                  01220027
012300************************************************************      01230027
012400* THIS IS THE COPYBOOK FOR RECYCLE FEES COLLECTED AND      *      01240027
012500* RETURNED EXTRACT USED IN PROGRAM TXKUT001, JOB TXK510.   *      01250027
012600************************************************************      01260027
012700     COPY TXRD001.                                                01270027
012800                                                                  01280027
012900************************************************************      01290027
013000* DATE ROUTINE COPY MEMBERS                                       01300027
013100************************************************************      01310027
013200     COPY DPWS500.                                                01320027
013300                                                                  01330027
013400************************************************************      01340027
013500* PROGRAM ACCUMULATORS                                            01350027
013600************************************************************      01360027
013700 01  PA-PROGRAM-ACCUMULATORS.                                     01370027
013800     05  PA-DATE-CONTROL-RECS-READ    PIC  9(09)   VALUE ZERO.    01380027
013900     05  PA-SKU-CONTROL-RECS-READ     PIC  9(09)   VALUE ZERO.    01390027
014000     05  PA-RECYCLE-FEE-ROWS-READ     PIC  9(09)   VALUE ZERO.    01400027
014100     05  PA-RECYCLE-FEE-RECS-WRITTEN  PIC  9(09)   VALUE ZERO.    01410027
014200     05  PA-RECYCLE-FEE-CURSOR-READS  PIC  9(09)   VALUE ZERO.    01420027
014300                                                                  01430027
014400************************************************************      01440027
014500* ERROR HANDLING                                                  01450027
014600************************************************************      01460027
014700 01  PV-MISC-ABEND-FIELDS.                                        01470027
014800     05  PV-PARAGRAPH-NAME     PIC  X(030)  VALUE SPACE.          01480027
014900     05  PV-OPERATION-MSG-1    PIC  X(040)  VALUE SPACE.          01490027
015000     05  PV-OPERATION-MSG-2    PIC  X(040)  VALUE SPACE.          01500027
015100     05  PV-DB2-OPERATION      PIC  X(030)  VALUE SPACE.          01510027
015200                                                                  01520027
015300 01  ABEND-CODE                PIC S9(004)  VALUE ZEROS           01530027
015400                                            COMP  SYNC.           01540027
015500     88  ABEND-4003-INVALID-CNTL-CARD       VALUE +4003.          01550027
015600     88  ABEND-4004-TABLE-OVERFLOW          VALUE +4004.          01560027
015700     88  ABEND-4013-DB2-ERROR               VALUE +4013.          01570027
015800     88  ABEND-4019-CAL-SUB-ERROR           VALUE +4019.          01580027
015900                                                                  01590027
016000************************************************************      01600027
016100* VARIABLES REQUIRED FOR THE FORMAT SQLCA ROUTINE DPPD004         01610027
016200************************************************************      01620027
016300     COPY DPWS004.                                                01630027
016400                                                                  01640027
016500************************************************************      01650027
016600* DB2 MESSAGE AREA                                                01660027
016700************************************************************      01670027
016800     COPY SQLCA2.                                                 01680027
016900                                                                  01690027
017000************************************************************      01700027
017100* DB2 COMMUNICATIONS AREA                                         01710027
017200************************************************************      01720027
017300     EXEC SQL                                                     01730027
017400       INCLUDE SQLCA                                              01740027
017500     END-EXEC.                                                    01750027
017600                                                                  01760027
017700************************************************************      01770027
017800* DB2 TABLE XST_LOC    (XST00001)                                 01780027
017900************************************************************      01790027
018000     EXEC SQL                                                     01800027
018100       INCLUDE XST00001                                           01810027
018200     END-EXEC.                                                    01820027
018300                                                                  01830027
018400************************************************************      01840027
018500* DB2 TABLE TEPPART                                               01850027
018600************************************************************      01860027
018700     EXEC SQL                                                     01870027
018800       INCLUDE TEPPART                                            01880027
018900     END-EXEC.                                                    01890027
019000                                                                  01900027
019100************************************************************      01910027
019200* DB2 TABLE TEPTRN                                                01920027
019300************************************************************      01930027
019400     EXEC SQL                                                     01940027
019500       INCLUDE TEPTRN                                             01950027
019600     END-EXEC.                                                    01960027
019700                                                                  01970027
019800************************************************************      01980027
019900* DB2 TABLE TEPITM                                                01990027
020000************************************************************      02000027
020100     EXEC SQL                                                     02010027
020200       INCLUDE TEPITM                                             02020027
020300     END-EXEC.                                                    02030027
020400                                                                  02040027
020500************************************************************      02050027
020600* DB2 TABLE XST_SKU                                               02060027
020700************************************************************      02070027
020800     EXEC SQL                                                     02080027
020900       INCLUDE XST00010                                           02090027
021000     END-EXEC.                                                    02100027
021100                                                                  02110027
021200************************************************************      02120027
021300* TRANSACTION RETURN CURSOR                                       02130027
021400************************************************************      02140027
021500     EXEC SQL                                                     02150027
021600       DECLARE RECYCLE-FEE-CSR CURSOR FOR                         02160027
021700         SELECT B.SKU_NBR                                         02170027
021800               ,B.STR_NBR                                         02180027
021900               ,D.ST_CDE                                          02190027
022000               ,C.TRN_TYP_CDE                                     02200027
022100               ,B.SLD_QTY                                         02210027
022200               ,B.NET_CHRGD_AMT                                   02220027
022300           FROM TEPPART A                                         02230027
022400               ,TEPITM  B                                         02240027
022500               ,TEPTRN  C                                         02250027
022600               ,XST_LOC D                                         02260027
022700          WHERE A.PARTN_NBR        = B.PARTN_NBR                  02270027
022800            AND A.PARTN_NBR        = C.PARTN_NBR                  02280027
022900            AND C.STR_NBR          = B.STR_NBR                    02290027
023000            AND C.RGST_ID          = B.RGST_ID                    02300027
023100            AND C.TRN_NBR          = B.TRN_NBR                    02310027
023200            AND C.STRT_TM          = B.STRT_TM                    02320027
023300            AND C.SLS_CORR_SEQ_NBR = B.SLS_CORR_SEQ_NBR           02330027
023400            AND C.STR_NBR          = D.LOC_NBR                    02340027
023500            AND A.SLS_DTE BETWEEN                                 02350027
023600               :PV-HOLD-PERIOD-START-DTE   AND                    02360027
023700               :PV-HOLD-PERIOD-END-DTE                            02370027
023800            AND C.TRN_TYP_CDE  IN ('01', '02' , '11', '12')       02380027
023900            AND C.TRN_STAT_CDE IN ('V', 'Z', 'L', 'R')            02390027
024000            AND C.VOID_ABRT_CDE IN ('N','U')                      02400027
024100            AND B.LIV_RSLU_CDE  = '+'                             02410027
024200            AND B.SKU_NBR       = :XST00010-SKU-NBR               02420027
024300           ORDER BY B.STR_NBR                                     02430027
024400        FOR FETCH ONLY                                            02440027
024500        WITH UR                                                   02450027
024600     END-EXEC.                                                    02460027
024700                                                                  02470027
024800************************************************************      02480027
024900 PROCEDURE DIVISION.                                              02490027
025000************************************************************      02500027
025100 0000-MAINLINE.                                                   02510027
025200                                                                  02520027
025300     DISPLAY '************ START OF TXKUT001 ***************'.    02530027
025400                                                                  02540027
025500     PERFORM 1000-INITIALIZATION.                                 02550027
025600                                                                  02560027
025700     PERFORM 2000-PROC-SKU-TABLE                                  02570027
025800         VARYING PV-SKU-NDX1 FROM 1 BY 1                          02580027
025900         UNTIL PV-SKU-NDX1 > PA-SKU-CONTROL-RECS-READ.            02590027
026000                                                                  02600027
026100     PERFORM 9999-WRAPUP.                                         02610027
026200                                                                  02620027
026300     DISPLAY '************  END OF TXKUT001  ***************'.    02630027
026400                                                                  02640027
026500     GOBACK.                                                      02650027
026600                                                                  02660027
026700************************************************************      02670027
026800* INITIALIZATION.                                                 02680027
026900*     OPENS FILES                                                 02690027
027000*     INITIALIZES VARIABLES                                       02700027
027100*     PERFORM INITIAL READ                                        02710027
027200************************************************************      02720027
027300 1000-INITIALIZATION.                                             02730027
027400                                                                  02740027
027500     OPEN INPUT  DATE-CONTROL-FILE                                02750027
027600                 SKU-CONTROL-FILE                                 02760027
027700          OUTPUT RECYCLE-FEE-EXTRACT-FILE.                        02770027
027800                                                                  02780027
027900     PERFORM 8000-READ-DATE-CONTROL-FILE.                         02790027
028000                                                                  02800027
028100     IF  PS-DATE-CONTROL-EOF-YES                                  02810027
028200         MOVE '8000-READ-DATE-CONTROL-FILE  ' TO PV-PARAGRAPH-NAME02820027
028300         MOVE 'NO CONTROL CARD TO PROCESS' TO PV-OPERATION-MSG-1  02830027
028400         SET ABEND-4003-INVALID-CNTL-CARD  TO TRUE                02840027
028500         PERFORM 9910-ABEND                                       02850027
028600     END-IF.                                                      02860027
028700                                                                  02870027
028800     PERFORM 1100-GET-FISCAL-PERIOD-START.                        02880027
028900                                                                  02890027
029000     DISPLAY ' '.                                                 02900027
029100     DISPLAY 'CONTROL CARD DATE: ' CC-FISCAL-END-DATE.            02910027
029200                                                                  02920027
029300     DISPLAY ' '.                                                 02930027
029400     DISPLAY 'REPORTING FISCAL PERIOD =>'                         02940027
029500             ' START: ' PV-HOLD-PERIOD-START-DTE                  02950027
029600             ' - '                                                02960027
029700             ' END : ' PV-HOLD-PERIOD-END-DTE.                    02970027
029800                                                                  02980027
029900     PERFORM 8100-READ-SKU-CONTROL-FILE.                          02990027
030000                                                                  03000027
030100     IF  PS-SKU-CONTROL-EOF-YES                                   03010027
030200         DISPLAY '*********************************'              03020027
030300         DISPLAY '** ABEND SKU CC NOT FOUND      **'              03030027
030400         DISPLAY '** PROGRAM = TXKUT001          **'              03040027
030500         DISPLAY '*********************************'              03050027
030600         DISPLAY DPG54-ERROR-MESSAGE                              03060027
030700         SET ABEND-4003-INVALID-CNTL-CARD  TO TRUE                03070027
030800         PERFORM 9910-ABEND                                       03080027
030900     END-IF.                                                      03090027
031000                                                                  03100027
031100     DISPLAY ' '.                                                 03110027
031200     DISPLAY 'START - SKU NUMBER TABLE LOAD: '.                   03120027
031300     DISPLAY ' '.                                                 03130027
031400                                                                  03140027
031500     PERFORM 1200-LOAD-SKU-TABLE                                  03150027
031600       UNTIL PS-SKU-CONTROL-EOF-YES.                              03160027
031700                                                                  03170027
031800     DISPLAY ' '.                                                 03180027
031900     DISPLAY 'END - SKU NUMBER CONTROL TABLE LOAD: '.             03190027
032000                                                                  03200027
032100                                                                  03210027
032200******************************************************************03220027
032300* GET FISCAL PERIOD START DATE                                    03230027
032400******************************************************************03240027
032500 1100-GET-FISCAL-PERIOD-START.                                    03250027
032600                                                                  03260027
032700     INITIALIZE DPG51 DPG52 DPG53                                 03270027
032800                DPG54 DPG55 DPG56.                                03280027
032900                                                                  03290027
033000     SET DPG51-FISCAL-454-CALENDAR   TO TRUE.                     03300027
033100     SET DPG52-LK-DTE-ISO-FMT        TO TRUE.                     03310027
033200                                                                  03320027
033300     MOVE CC-FISCAL-END-DATE      TO DPG52-LK-DATE-INPUT.         03330027
033400                                                                  03340027
033500     CALL DP500-KOHLS-CALENDAR-ROUTINE USING DPG51 DPG52 DPG53    03350027
033600                                             DPG54 DPG55 DPG56.   03360027
033700                                                                  03370027
033800     IF  DPG54-SEVERE-ERROR                                       03380027
033900         DISPLAY '*********************************'              03390027
034000         DISPLAY '** ABEND FROM CALL SUB         **'              03400027
034100         DISPLAY '** PROGRAM = TXKUT001          **'              03410027
034200         DISPLAY '** DATE = ' CC-FISCAL-END-DATE '     **'        03420027
034300         DISPLAY '*********************************'              03430027
034400         DISPLAY DPG54-ERROR-MESSAGE                              03440027
034500         SET ABEND-4019-CAL-SUB-ERROR  TO TRUE                    03450027
034600         PERFORM 9910-ABEND                                       03460027
034700     ELSE                                                         03470027
034800     IF  DPG54-DATE-INVALID                                       03480027
034900         DISPLAY '*********************************'              03490027
035000         DISPLAY '** ABEND INVALID END DATE      **'              03500027
035100         DISPLAY '** PROGRAM = TXKUT001          **'              03510027
035200         DISPLAY '** DATE = ' CC-FISCAL-END-DATE '         **'    03520027
035300         DISPLAY '*********************************'              03530027
035400         DISPLAY DPG54-ERROR-MESSAGE                              03540027
035500         SET ABEND-4003-INVALID-CNTL-CARD TO TRUE                 03550027
035600         PERFORM 9910-ABEND                                       03560027
035700     END-IF                                                       03570027
035800     END-IF.                                                      03580027
035900                                                                  03590027
036000     MOVE DPG56-FIRST-FP-DB2-ISO-FMT TO PV-HOLD-PERIOD-START-DTE. 03600027
036100     MOVE DPG56-LAST-FP-DB2-ISO-FMT  TO PV-HOLD-PERIOD-END-DTE.   03610027
036200                                                                  03620027
036300******************************************************************03630027
036400* LOAD SKU TABLE XREF                                             03640027
036500******************************************************************03650027
036600 1200-LOAD-SKU-TABLE.                                             03660027
036700                                                                  03670027
036800     IF  PA-SKU-CONTROL-RECS-READ < PV-MAX-SKU-TABLE-SUB          03680027
036900                                                                  03690027
037000         IF  CC-SKU-NBR IS NUMERIC                                03700027
037100             MOVE CC-SKU-NBR                                      03710027
037200               TO PV-SKU-NBR (PA-SKU-CONTROL-RECS-READ)           03720027
037300             DISPLAY ' SKU=' PV-SKU-NBR (PA-SKU-CONTROL-RECS-READ)03730027
037400         ELSE                                                     03740027
037500             DISPLAY '*********************************'          03750027
037600             DISPLAY '** ABEND INVALID SKU NUMBER    **'          03760027
037700             DISPLAY '** PROGRAM = TXKUT001          **'          03770027
037800             DISPLAY '** SKU  = ' CC-SKU-NBR-X    '    **'        03780027
037900             DISPLAY '*********************************'          03790027
038000             DISPLAY DPG54-ERROR-MESSAGE                          03800027
038100             SET ABEND-4003-INVALID-CNTL-CARD TO TRUE             03810027
038200             PERFORM 9910-ABEND                                   03820027
038300         END-IF                                                   03830027
038400     ELSE                                                         03840027
038500         DISPLAY '*********************************'              03850027
038600         DISPLAY '** ABEND SKU TABLE OVERFLOW    **'              03860027
038700         DISPLAY '** PROGRAM = TXKUT001          **'              03870027
038800         DISPLAY '** SKU = ' CC-SKU-NBR-X                         03880027
038900         DISPLAY '** SUB = ' PA-SKU-CONTROL-RECS-READ             03890027
039000         DISPLAY '*********************************'              03900027
039100         DISPLAY DPG54-ERROR-MESSAGE                              03910027
039200         SET ABEND-4004-TABLE-OVERFLOW TO TRUE                    03920027
039300         PERFORM 9910-ABEND                                       03930027
039400     END-IF.                                                      03940027
039500                                                                  03950027
039600     PERFORM 8100-READ-SKU-CONTROL-FILE.                          03960027
039700                                                                  03970027
039800******************************************************************03980027
039900* PROCESS SKU IN TABLE                                            03990027
040000******************************************************************04000027
040100 2000-PROC-SKU-TABLE.                                             04010027
040200                                                                  04020027
040300     MOVE PV-SKU-NBR (PV-SKU-NDX1) TO XST00010-SKU-NBR.           04030027
040400     DISPLAY '  PROCESSING SKU = ' XST00010-SKU-NBR.              04040027
040500                                                                  04050027
040600****** GET SKU DESC                                               04060027
040700                                                                  04070027
040800     PERFORM 8300-SELECT-SKU-DESC.                                04080027
040900                                                                  04090027
041000     IF  PS-SKU-DESC-FOUND-YES                                    04100027
041100         CONTINUE                                                 04110027
041200     ELSE                                                         04120027
041300         MOVE '** SKU DESC NOT FOUND' TO XST00010-SKU-DESC        04130027
041400     END-IF.                                                      04140027
041500                                                                  04150027
041600****** EXECUTE SKU CURSOR                                         04160027
041700                                                                  04170027
041800     SET PS-RECYCLE-FEE-CURSOR-EOF-NO TO TRUE.                    04180027
041900                                                                  04190027
042000     PERFORM 8200-OPEN-RECYCLE-FEE-CSR.                           04200027
042100                                                                  04210027
042200     PERFORM 8210-FETCH-RECYCLE-FEE-ROW.                          04220027
042300                                                                  04230027
042400     IF  PS-RECYCLE-FEE-CURSOR-EOF-YES                            04240027
042500         INITIALIZE TX001-RECYCLE-FEE-RECORD                      04250027
042600                                                                  04260027
042700         MOVE PV-SKU-NBR (PV-SKU-NDX1) TO TX001-SKU-NBR           04270027
042800         MOVE XST00010-SKU-DESC        TO TX001-SKU-DESC          04280027
042900                                                                  04290027
043000         PERFORM 8500-WRITE-RECYCLE-FEE-EXTRACT                   04300027
043100     END-IF.                                                      04310027
043200                                                                  04320027
043300     PERFORM 2100-PROC-SKU-RECYCLE-FEES                           04330027
043400         UNTIL PS-RECYCLE-FEE-CURSOR-EOF-YES.                     04340027
043500                                                                  04350027
043600     PERFORM 8220-CLOSE-RECYCLE-FEE-CSR.                          04360027
043700                                                                  04370027
043800******************************************************************04380027
043900* PROCEESS RECYCLE FEES FOR SKU                                   04390027
044000******************************************************************04400027
044100 2100-PROC-SKU-RECYCLE-FEES.                                      04410027
044200                                                                  04420027
044300     INITIALIZE TX001-RECYCLE-FEE-RECORD.                         04430027
044400                                                                  04440027
044500     MOVE EPITM-SKU-NBR              TO TX001-SKU-NBR.            04450027
044600     MOVE XST00010-SKU-DESC          TO TX001-SKU-DESC.           04460027
044700     MOVE EPITM-STR-NBR              TO TX001-STR-NBR.            04470027
044800     MOVE XST00001-ST-CDE            TO TX001-ST-CDE.             04480027
044900                                                                  04490027
045000     PERFORM 2200-ACCUM-SLD-AND-RET-FEES                          04500027
045100       UNTIL PS-RECYCLE-FEE-CURSOR-EOF-YES                        04510027
045200          OR EPITM-STR-NBR NOT = TX001-STR-NBR.                   04520027
045300                                                                  04530027
045400     PERFORM 8500-WRITE-RECYCLE-FEE-EXTRACT.                      04540027
045500                                                                  04550027
045600******************************************************************04560027
045700* ACCUMULATE STORE/STATE SLD AND RET UNITS/AMOUNTS                04570027
045800******************************************************************04580027
045900 2200-ACCUM-SLD-AND-RET-FEES.                                     04590027
046000                                                                  04600027
046100     IF  EPTRN-TRN-TYP-CDE  = '01' OR '02'                        04610027
046200         ADD EPITM-SLD-QTY           TO TX001-UNITS-SOLD          04620027
046300         ADD EPITM-NET-CHRGD-AMT     TO TX001-FEES-CHRGD          04630027
046400     ELSE                                                         04640027
046500         ADD EPITM-SLD-QTY           TO TX001-UNITS-RTND          04650027
046600         ADD EPITM-NET-CHRGD-AMT     TO TX001-FEES-RTND           04660027
046700     END-IF.                                                      04670027
046800                                                                  04680027
046900     PERFORM 8210-FETCH-RECYCLE-FEE-ROW.                          04690027
047000                                                                  04700027
047100                                                                  04710027
047200******************************************************************04720027
047300* READ DATE CONTROL CARD.                                         04730027
047400******************************************************************04740027
047500 8000-READ-DATE-CONTROL-FILE.                                     04750027
047600                                                                  04760027
047700     READ DATE-CONTROL-FILE INTO CC-DATE-CONTROL-CARD             04770027
047800        AT END                                                    04780027
047900           SET PS-DATE-CONTROL-EOF-YES TO TRUE.                   04790027
048000                                                                  04800027
048100     IF  PS-DATE-CONTROL-EOF-NO                                   04810027
048200         ADD 1 TO PA-DATE-CONTROL-RECS-READ                       04820027
048300     END-IF.                                                      04830027
048400                                                                  04840027
048500******************************************************************04850027
048600* READ SKU NBR CONTROL CARD.                                      04860027
048700******************************************************************04870027
048800 8100-READ-SKU-CONTROL-FILE.                                      04880027
048900                                                                  04890027
049000     READ SKU-CONTROL-FILE INTO CC-SKU-CONTROL-CARD               04900027
049100        AT END                                                    04910027
049200           SET PS-SKU-CONTROL-EOF-YES TO TRUE.                    04920027
049300                                                                  04930027
049400     IF  PS-SKU-CONTROL-EOF-NO                                    04940027
049500         ADD 1 TO PA-SKU-CONTROL-RECS-READ                        04950027
049600     END-IF.                                                      04960027
049700                                                                  04970027
049800******************************************************************04980027
049900* OPEN ITEM CSR                                                   04990027
050000******************************************************************05000027
050100 8200-OPEN-RECYCLE-FEE-CSR.                                       05010027
050200                                                                  05020027
050300     PERFORM                                                      05030027
050400         WITH TEST AFTER                                          05040027
050500         VARYING PV-SQL-SUB                                       05050027
050600         FROM 1 BY 1                                              05060027
050700         UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                 05070027
050800                   OR  SQLCODE = 0)                               05080027
050900                                                                  05090027
051000         EXEC SQL                                                 05100027
051100           OPEN RECYCLE-FEE-CSR                                   05110027
051200         END-EXEC                                                 05120027
051300                                                                  05130027
051400         EVALUATE TRUE                                            05140027
051500           WHEN SQLCODE = 0                                       05150027
051600           WHEN SQLCODE = -904                                    05160027
051700           WHEN SQLCODE = -911                                    05170027
051800           WHEN SQLCODE = -913                                    05180027
051900             CONTINUE                                             05190027
052000           WHEN SQLWARN0 NOT EQUAL SPACE                          05200027
052100           WHEN SQLCODE  NOT EQUAL ZERO                           05210027
052200             MOVE '8200-OPEN-RECYCLE-FEE-CSR'                     05220027
052300                                     TO PV-PARAGRAPH-NAME         05230027
052400             MOVE 'ERROR ON OPEN OF RECYCLE-FEE-CSR CURSOR'       05240027
052500                                     TO PV-DB2-OPERATION          05250027
052600             PERFORM 9900-SQL-ABEND-ROUTINE                       05260027
052700         END-EVALUATE                                             05270027
052800     END-PERFORM.                                                 05280027
052900                                                                  05290027
053000     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         05300027
053100       MOVE '8200-OPEN-RECYCLE-FEE-CSR'                           05310027
053200                              TO  PV-PARAGRAPH-NAME               05320027
053300       MOVE '8200- OPEN RETRIES EXCEEDED'                         05330027
053400                              TO  PV-DB2-OPERATION                05340027
053500       PERFORM 9900-SQL-ABEND-ROUTINE                             05350027
053600     END-IF.                                                      05360027
053700                                                                  05370027
053800******************************************************************05380027
053900* FETCH RECYCLE FEE ROW                                           05390027
054000******************************************************************05400027
054100 8210-FETCH-RECYCLE-FEE-ROW.                                      05410027
054200                                                                  05420027
054300     PERFORM                                                      05430027
054400        WITH TEST AFTER                                           05440027
054500        VARYING PV-SQL-SUB                                        05450027
054600        FROM 1 BY 1                                               05460027
054700        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                  05470027
054800                   OR  SQLCODE = +100                             05480027
054900                   OR  SQLCODE = 0)                               05490027
055000                                                                  05500027
055100         EXEC SQL                                                 05510027
055200           FETCH RECYCLE-FEE-CSR                                  05520027
055300            INTO :EPITM-SKU-NBR                                   05530027
055400                ,:EPITM-STR-NBR                                   05540027
055500                ,:XST00001-ST-CDE                                 05550027
055600                ,:EPTRN-TRN-TYP-CDE                               05560027
055700                ,:EPITM-SLD-QTY                                   05570027
055800                ,:EPITM-NET-CHRGD-AMT                             05580027
055900         END-EXEC                                                 05590027
056000                                                                  05600027
056100         EVALUATE TRUE                                            05610027
056200           WHEN SQLCODE = -904                                    05620027
056300           WHEN SQLCODE = -911                                    05630027
056400           WHEN SQLCODE = -913                                    05640027
056500             CONTINUE                                             05650027
056600           WHEN SQLCODE = ZERO                                    05660027
056700              ADD 1 TO PA-RECYCLE-FEE-CURSOR-READS                05670027
056800                                                                  05680027
056900           WHEN SQLCODE = +100                                    05690027
057000             SET PS-RECYCLE-FEE-CURSOR-EOF-YES TO TRUE            05700027
057100           WHEN SQLWARN0 NOT EQUAL SPACE                          05710027
057200           WHEN SQLCODE NOT EQUAL ZERO                            05720027
057300             MOVE '8210-FETCH-RECYCLE-FEE-ROW'                    05730027
057400                                     TO PV-PARAGRAPH-NAME         05740027
057500             MOVE 'ERROR ON RET CSR'                              05750027
057600                                     TO PV-DB2-OPERATION          05760027
057700             PERFORM 9900-SQL-ABEND-ROUTINE                       05770027
057800         END-EVALUATE                                             05780027
057900     END-PERFORM.                                                 05790027
058000                                                                  05800027
058100     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        05810027
058200         MOVE '8210-FETCH-RECYCLE-FEE-ROW'                        05820027
058300                               TO  PV-PARAGRAPH-NAME              05830027
058400         MOVE '8210- FETCH RETRIES EXCEEDED'                      05840027
058500                               TO  PV-DB2-OPERATION               05850027
058600         PERFORM 9900-SQL-ABEND-ROUTINE                           05860027
058700     END-IF.                                                      05870027
058800                                                                  05880027
058900******************************************************************05890027
059000* CLOSE RECYCLE FEE CURSOR                                        05900027
059100******************************************************************05910027
059200 8220-CLOSE-RECYCLE-FEE-CSR.                                      05920027
059300                                                                  05930027
059400     PERFORM                                                      05940027
059500        WITH TEST AFTER                                           05950027
059600        VARYING PV-SQL-SUB                                        05960027
059700        FROM 1 BY 1                                               05970027
059800        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                  05980027
059900                   OR  SQLCODE = 0)                               05990027
060000                                                                  06000027
060100         EXEC SQL                                                 06010027
060200           CLOSE RECYCLE-FEE-CSR                                  06020027
060300         END-EXEC                                                 06030027
060400                                                                  06040027
060500         EVALUATE TRUE                                            06050027
060600           WHEN SQLCODE = -904                                    06060027
060700           WHEN SQLCODE = -911                                    06070027
060800           WHEN SQLCODE = -913                                    06080027
060900           WHEN SQLCODE = 0                                       06090027
061000             CONTINUE                                             06100027
061100           WHEN SQLWARN0 NOT EQUAL SPACE                          06110027
061200           WHEN SQLCODE NOT EQUAL ZERO                            06120027
061300             MOVE '8220-CLOSE-RECYCLE-FEE-CSR'                    06130027
061400                                     TO PV-PARAGRAPH-NAME         06140027
061500             MOVE 'ERROR ON CLOSE OF RECYCLE-FEE-CSR'             06150027
061600                                     TO PV-DB2-OPERATION          06160027
061700             PERFORM 9900-SQL-ABEND-ROUTINE                       06170027
061800         END-EVALUATE                                             06180027
061900     END-PERFORM.                                                 06190027
062000                                                                  06200027
062100     IF PV-SQL-SUB GREATER PC-MAX-RETRIES                         06210027
062200       MOVE '8220-CLOSE-RECYCLE-FEE-CSR'                          06220027
062300                               TO  PV-PARAGRAPH-NAME              06230027
062400       MOVE '8220- CLOSE RETRIES EXCEEDED'                        06240027
062500                               TO  PV-DB2-OPERATION               06250027
062600       PERFORM 9900-SQL-ABEND-ROUTINE                             06260027
062700     END-IF.                                                      06270027
062800                                                                  06280027
062900******************************************************************06290027
063000* SELECT SKU DESC                                                 06300027
063100******************************************************************06310027
063200 8300-SELECT-SKU-DESC.                                            06320027
063300                                                                  06330027
063400     SET PS-SKU-DESC-FOUND-NO  TO TRUE.                           06340027
063500                                                                  06350027
063600     PERFORM                                                      06360027
063700        WITH TEST AFTER                                           06370027
063800        VARYING PV-SQL-SUB                                        06380027
063900        FROM 1 BY 1                                               06390027
064000        UNTIL (PV-SQL-SUB GREATER PC-MAX-RETRIES                  06400027
064100                   OR  SQLCODE = +100                             06410027
064200                   OR  SQLCODE = 0)                               06420027
064300                                                                  06430027
064400         EXEC SQL                                                 06440027
064500           SELECT SKU_DESC                                        06450027
064600            INTO :XST00010-SKU-DESC                               06460027
064700            FROM XST_SKU                                          06470027
064800           WHERE SKU_NBR  = :XST00010-SKU-NBR                     06480027
064900         END-EXEC                                                 06490027
065000                                                                  06500027
065100         EVALUATE TRUE                                            06510027
065200           WHEN SQLCODE = -904                                    06520027
065300           WHEN SQLCODE = -911                                    06530027
065400           WHEN SQLCODE = -913                                    06540027
065500             CONTINUE                                             06550027
065600           WHEN SQLCODE = ZERO                                    06560027
065700             SET PS-SKU-DESC-FOUND-YES TO TRUE                    06570027
065800           WHEN SQLCODE = +100                                    06580027
065900             CONTINUE                                             06590027
066000           WHEN SQLWARN0 NOT EQUAL SPACE                          06600027
066100           WHEN SQLCODE NOT EQUAL ZERO                            06610027
066200             MOVE '8300-SELECT-SKU-DESC'                          06620027
066300                                     TO PV-PARAGRAPH-NAME         06630027
066400             MOVE 'ERROR ON SELECT'                               06640027
066500                                     TO PV-DB2-OPERATION          06650027
066600             PERFORM 9900-SQL-ABEND-ROUTINE                       06660027
066700         END-EVALUATE                                             06670027
066800     END-PERFORM.                                                 06680027
066900                                                                  06690027
067000     IF  PV-SQL-SUB GREATER PC-MAX-RETRIES                        06700027
067100         MOVE '8300-SELECT-SKU-DESC'                              06710027
067200                               TO  PV-PARAGRAPH-NAME              06720027
067300         MOVE '8300- SELECT RETRIES EXCEEDED'                     06730027
067400                               TO  PV-DB2-OPERATION               06740027
067500         PERFORM 9900-SQL-ABEND-ROUTINE                           06750027
067600     END-IF.                                                      06760027
067700                                                                  06770027
067800************************************************************      06780027
067900*     WRITE RECYCLE FEE EXTRACT RECORD                            06790027
068000************************************************************      06800027
068100 8500-WRITE-RECYCLE-FEE-EXTRACT.                                  06810027
068200                                                                  06820027
068300     WRITE RECYCLE-FEE-EXTRACT-RECORD                             06830027
068400      FROM TX001-RECYCLE-FEE-RECORD.                              06840027
068500                                                                  06850027
068600     ADD 1 TO PA-RECYCLE-FEE-RECS-WRITTEN.                        06860027
068700                                                                  06870027
068800************************************************************      06880027
068900*     SQL ABEND ROUTINE.                                          06890027
069000************************************************************      06900027
069100 9900-SQL-ABEND-ROUTINE.                                          06910027
069200                                                                  06920027
069300     DISPLAY '** ABEND     **'.                                   06930027
069400     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        06940027
069500     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              06950027
069600     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION.               06960027
069700                                                                  06970027
069800     COPY DPPD004.                                                06980027
069900     SET ABEND-4013-DB2-ERROR TO TRUE.                            06990027
070000     CALL 'ILBOABN0' USING ABEND-CODE.                            07000027
070100                                                                  07010027
070200************************************************************      07020027
070300*  ABEND - PERFORMS A NON-                                        07030027
070400************************************************************      07040027
070500 9910-ABEND.                                                      07050027
070600                                                                  07060027
070700     DISPLAY '** ABEND           **'.                             07070027
070800     DISPLAY '** PROGRAM         ** = ' PC-CURRENT-PROGRAM-NAME   07080027
070900     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        07090027
071000     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       07100027
071100     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       07110027
071200     CALL 'ILBOABN0' USING ABEND-CODE.                            07120027
071300                                                                  07130027
071400************************************************************      07140027
071500*     END OF PROGRAM ROUTINE. CLOSES ALL FILES AND DISPLAYS       07150027
071600*     ANY DATA FROM THE PROGRAM.                                  07160027
071700************************************************************      07170027
071800 9999-WRAPUP.                                                     07180027
071900                                                                  07190027
072000     CLOSE DATE-CONTROL-FILE                                      07200027
072100          SKU-CONTROL-FILE                                        07210027
072200          RECYCLE-FEE-EXTRACT-FILE.                               07220027
072300                                                                  07230027
072400     DISPLAY ' '.                                                 07240027
072500     DISPLAY '*********************************************'      07250027
072600     DISPLAY '    TXKUT001 SUMMARY STATISTICS              '      07260027
072700     DISPLAY '*********************************************'      07270027
072800     DISPLAY ' '.                                                 07280027
072900     DISPLAY 'DATE CONTROL RECS READ ................: '          07290027
073000              PA-DATE-CONTROL-RECS-READ.                          07300027
073100     DISPLAY ' '.                                                 07310027
073200     DISPLAY 'SKU NBR CONTROL RECS READ .............: '          07320027
073300              PA-SKU-CONTROL-RECS-READ.                           07330027
073400     DISPLAY ' '.                                                 07340027
073500     DISPLAY 'TOTAL RECYCLE FEE CURSOR READS ........: '          07350027
073600              PA-RECYCLE-FEE-CURSOR-READS.                        07360027
073700     DISPLAY ' '.                                                 07370027
073800     DISPLAY 'RECYCLE FEE RECORDS WRITTEN ...........: '          07380027
073900              PA-RECYCLE-FEE-RECS-WRITTEN.                        07390027
074000     DISPLAY ' '.                                                 07400027
074100     DISPLAY '*********************************************'.     07410027
074200                                                                  07420027
074300************************************************************      07430027
074400*             E N D    O F    P R O G R A M                       07440027
074500************************************************************      07450027
