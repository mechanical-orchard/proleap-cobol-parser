000100*------------------------*                                        00010009
000200 IDENTIFICATION DIVISION.                                         00020000
000300*------------------------*                                        00030009
000400 PROGRAM-ID.     APKUP914.                                        00040025
000500 AUTHOR.         MIKE BESKE.                                      00050009
000600 INSTALLATION.   KOHLS DEPARTMENT STORES.                         00060009
000700 DATE-WRITTEN.   OCTOBER 2008.                                    00070025
000800 DATE-COMPILED.                                                   00080009
000900                                                                  00090009
001000*---------------------------------------------------------------* 00100009
001100*  LOADS DATA TO APTW_NW_STR_DISC DB2 TABLE                     * 00110026
001200*---------------------------------------------------------------* 00120009
001300*                 COBOL 2 WITH DB2 SQL                          * 00130026
001400*---------------------------------------------------------------* 00140009
001500*                                                               * 00150009
001600*    THIS PROGRAM  INSERTS RECORDS FROM AN INPUT FILE TO THE    * 00160022
001700*  APTW_NW_STR_DISC DB2.TABLE.  THIS IS A LOAD PROGRAM THAT     * 00170026
001800*  REPLACES THE BMC UTILITY.                                    * 00180009
001900*                                                               * 00190009
002000*---------------------------------------------------------------* 00200009
002100*                                                               * 00210009
002200*  DB2 TABLES:                                DCLGENS:          * 00220009
002300*   1. AP NEW STORE DISCOUNT TABLE            (APT00000)        * 00230026
002400*   2. CHECKPOINT RESTART CONTROL             (TCKRSTCN)        * 00240026
002500*   3. CHECKPOINT RESTART INFO                (TCKRSTIN)        * 00250026
002600*                                                               * 00260009
002700*  OUTPUT:                                    COPYBOOK:         * 00270009
002800*   1. INPUT-FILE                             APT00000 DCLGEN   * 00280026
002900*                                                               * 00290009
003000*---------------------------------------------------------------* 00300009
003100* CHANGE LOG:                                                   * 00310009
003200*   DATE  10/13/2008                                            * 00320026
003300*       CHANGE MADE: NEW PROGRAM                                * 00330009
003400*       MADE BY: MIKE BESKE              WR/IR #: WR35173       * 00340009
003500*                                                               * 00350009
003600*---------------------------------------------------------------* 00360009
003700                                                                  00370009
003800*---------------------*                                           00380009
003900 ENVIRONMENT DIVISION.                                            00390009
004000*---------------------*                                           00400009
004100 CONFIGURATION SECTION.                                           00410009
004200 SOURCE-COMPUTER.        IBM-3090.                                00420009
004300 OBJECT-COMPUTER.        IBM-3090.                                00430009
004400                                                                  00440009
004500 INPUT-OUTPUT SECTION.                                            00450009
004600 FILE-CONTROL.                                                    00460009
004700                                                                  00470009
004800     SELECT INPUT-FILE   ASSIGN TO INP01.                         00480009
004900                                                                  00490009
005000*---------------------*                                           00500009
005100 DATA DIVISION.                                                   00510009
005200*---------------------*                                           00520009
005300 FILE SECTION.                                                    00530009
005400                                                                  00540009
005500 FD  INPUT-FILE                                                   00550009
005600     RECORDING MODE IS F                                          00560009
005700     LABEL RECORDS ARE STANDARD                                   00570009
005800     RECORD CONTAINS 32 CHARACTERS                                00580026
005900     BLOCK CONTAINS 0  RECORDS.                                   00590009
006000 01  INPUT-REC                        PIC X(32).                  00600026
006100                                                                  00610009
006200 WORKING-STORAGE SECTION.                                         00620009
006300                                                                  00630009
006400 01  FILLER                      PIC  X(27)     VALUE             00640009
006500     '** START OF APKUP914 W/S **'.                               00650025
006600                                                                  00660009
006700 01  PROGRAM-CONSTANTS.                                           00670009
006800     05  PC-PROGRAM-NAME         PIC  X(08)    VALUE 'APKUP914'.  00680025
006900     05  PC-IN-PROCESS-CODE      PIC  X(01)    VALUE '9'.         00690009
007000     05  PC-RUN-COMPLETE-CODE    PIC  X(01)    VALUE '0'.         00700009
007100     05  PC-RETRY-MAX            PIC S9(04)    VALUE +3  COMP.    00710009
007200                                                                  00720009
007300 01  PROGRAM-SWITCHES.                                            00730009
007400     05  PS-EOF-SW                    PIC X(01) VALUE 'N'.        00740022
007500         88  PS-EOF                             VALUE 'Y'.        00750022
007600     05  PS-RUN-TYPE-SW               PIC X(01) VALUE ' '.        00760009
007700         88  NORMAL-RUN                         VALUE '0'.        00770009
007800         88  RESTART-RUN                        VALUE '9'.        00780009
007900     05  PS-END-FILE-SW               PIC X(01) VALUE 'N'.        00790009
008000         88  MORE-TRANS-FILE                    VALUE 'N'.        00800009
008100         88  END-OF-TRANS-FILE                  VALUE 'Y'.        00810009
008200                                                                  00820009
008300 01  PROGRAM-VARIABLES.                                           00830022
008400     05  PV-RETRY-COUNT               PIC S9(04)  VALUE ZEROS.    00840022
008500     05  PV-CKPT-STAT-CODE            PIC X(01) VALUE SPACES.     00850022
008600     05  PV-TMST                      PIC X(26).                  00860022
008700     05  PV-HOLD-TMST                 PIC X(26).                  00870022
008800     05  PV-DISP-NBR                  PIC Z,ZZZ,ZZ9.              00880022
008900     05  PV-ABEND-CODE                PIC S9(04) COMP SYNC        00890022
009000                                                 VALUE ZERO.      00900022
009100     05  PV-UNPACK-LONG-NBR           PIC S9(09).                 00910029
009200     05  PV-UNPACK-SHORT-NBR          PIC S9(04).                 00920029
009300                                                                  00930029
009400 01  PV-COUNTERS.                                                 00940009
009500     05  PV-INPUT-COUNT               PIC S9(07) COMP-3           00950009
009600                                          VALUE ZERO.             00960009
009700     05  PV-INSERT-COUNT              PIC S9(07) COMP-3           00970009
009800                                          VALUE ZERO.             00980009
009900     05  PV-DUP-COUNT                 PIC S9(07) COMP-3           00990009
010000                                          VALUE ZERO.             01000009
010100     05  PV-COMMIT-COUNT              PIC S9(07) COMP-3           01010009
010200                                          VALUE ZERO.             01020009
010300 01  CR-CKPT-RESTART-INFO.                                        01030009
010400     05  CR-PO-NBR                    PIC S9(09) COMP             01040026
010500                                          VALUE ZERO.             01050026
010600     05  CR-LOC-NBR                   PIC S9(04) COMP             01060026
010700                                          VALUE ZERO.             01070026
010800     05  CR-GRND-OPN-DTE              PIC  X(10)                  01080026
010900                                          VALUE SPACE.            01090026
011000     05  CR-ENT-ID                    PIC S9(09) COMP             01100026
011100                                          VALUE ZERO.             01110026
011200     05  CR-DEPT-NBR                  PIC S9(04) COMP             01120026
011300                                          VALUE ZERO.             01130026
011400     05  CR-CNCL-DTE                  PIC  X(10)                  01140026
011500                                          VALUE SPACE.            01150026
011600     05  CR-READ-CNT                  PIC 9(08) VALUE ZEROES.     01160009
011700     05  CR-INSERT-CNT                PIC 9(08) VALUE ZEROES.     01170009
011800                                                                  01180009
011900 01  CKPT-RESTART-TMST.                                           01190009
012000     05  CR-CURR-TMST                 PIC X(26)  VALUE SPACES.    01200009
012100     05  CR-NEXT-TMST                 PIC X(26)  VALUE SPACES.    01210009
012200                                                                  01220009
012300*----------------------------------------------------------------*01230009
012400*    SQL COMMUNICATIONS AREA DCLGEN                               01240009
012500*----------------------------------------------------------------*01250009
012600     EXEC SQL                                                     01260009
012700          INCLUDE SQLCA                                           01270009
012800     END-EXEC.                                                    01280009
012900     COPY SQLCA2.                                                 01290009
013000                                                                  01300009
013100*----------------------------------------------------------------*01310009
013200*    AP NEW STORE DISCOUNT TABLE - APTW_NW_STR_DISC               01320026
013300*----------------------------------------------------------------*01330009
013400     EXEC SQL                                                     01340009
013500          INCLUDE APT00000                                        01350026
013600     END-EXEC.                                                    01360009
013700                                                                  01370009
013800*----------------------------------------------------------------*01380009
013900*    CHECKPOINT/RESTART CONTROL TABLE - TCKRSTCNTL                01390026
014000*----------------------------------------------------------------*01400009
014100     EXEC SQL                                                     01410009
014200          INCLUDE TCKRSTCN                                        01420026
014300     END-EXEC.                                                    01430009
014400                                                                  01440009
014500*----------------------------------------------------------------*01450009
014600*    CHECKPOINT/RESTART INFO TABLE - DCLTCKRSTINF                 01460026
014700*----------------------------------------------------------------*01470009
014800     EXEC SQL                                                     01480009
014900          INCLUDE TCKRSTIN                                        01490026
015000     END-EXEC.                                                    01500009
015100                                                                  01510009
015200*----------------------------------------------------------------*01520009
015300*    ABEND DATA AREAS                                             01530009
015400*----------------------------------------------------------------*01540009
015500 01  ABEND-CODE                    PIC S9(4)    VALUE ZEROES      01550009
015600                                   COMP         SYNC.             01560009
015700                                                                  01570009
015800     88  AC-ANY-ERROR                           VALUE  +4001      01580009
015900                                                THRU   +4019.     01590009
016000     88  AC-OPEN-ERROR                          VALUE  +4005.     01600009
016100     88  AC-CLOSE-ERROR                         VALUE  +4006.     01610009
016200     88  AC-INVALID-DATA                        VALUE  +4008.     01620009
016300     88  AC-DB2-ERROR                           VALUE  +4013.     01630009
016400     88  AC-UNSUCCESSFUL-SELECT                 VALUE  +4015.     01640009
016500     88  AC-MAX-RETRIES-EXCEEDED                VALUE  +4016.     01650009
016600                                                                  01660009
016700 01  ABEND-AREAS.                                                 01670009
016800     05  AA-ABEND-LIT              PIC  X(40)   VALUE             01680009
016900             '*****       ABEND'.                                 01690009
017000     05  AA-PROGRAM-LIT            PIC  X(40)   VALUE             01700009
017100             '*****   PROGRAM: APKUP914'.                         01710025
017200     05  AA-PARAGRAPH-LIT.                                        01720009
017300         10  FILLER                PIC  X(17)   VALUE             01730009
017400             '***** PARAGRAPH: '.                                 01740009
017500         10  AA-PARAGRAPH-NAME     PIC  X(35)   VALUE SPACES.     01750009
017600     05  AA-MESSAGE-LINE-1.                                       01760009
017700         10  FILLER                PIC  X(06)   VALUE '*****'.    01770009
017800         10  AA-MESSAGE-1          PIC  X(80)   VALUE SPACES.     01780009
017900     05  AA-MESSAGE-LINE-2.                                       01790009
018000         10  FILLER                PIC  X(06)   VALUE '*****'.    01800009
018100         10  AA-MESSAGE-2          PIC  X(80)   VALUE SPACES.     01810009
018200     05  AA-DB2-ERROR-LIT          PIC  X(40)   VALUE             01820009
018300             '*****    DB2 ERROR'.                                01830009
018400     05  AA-DB2-OPERATION-LIT.                                    01840009
018500         10  FILLER                PIC  X(17)   VALUE             01850009
018600             '***** OPERATION: '.                                 01860009
018700         10  AA-DB2-OPERATION.                                    01870009
018800             15  AA-DB2-OP-1       PIC  X(25)   VALUE SPACES.     01880009
018900             15  AA-DB2-OP-2       PIC  X(25)   VALUE SPACES.     01890009
019000     05  AA-DB2-TABLE-1            PIC  X(08)   VALUE SPACES.     01900009
019100     05  AA-DB2-TABLE-2            PIC  X(08)   VALUE SPACES.     01910009
019200                                                                  01920009
019300*----------------------------------------------------------------*01930009
019400*    SQLCA FORMATTED MESSAGE AREA                                 01940009
019500*----------------------------------------------------------------*01950009
019600     COPY DPWS004.                                                01960009
019700                                                                  01970009
019800*                                                                 01980009
019900 01  FILLER                      PIC  X(25)     VALUE             01990009
020000     '** END OF APKUP914 W/S **'.                                 02000025
020100                                                                  02010009
020200*-------------------*                                             02020009
020300 PROCEDURE DIVISION.                                              02030009
020400*-------------------*                                             02040009
020500 A100-MAIN.                                                       02050009
020600                                                                  02060022
020700     PERFORM B100-INITIALIZE.                                     02070009
020800                                                                  02080009
020900     PERFORM B200-PROCESS UNTIL PS-EOF.                           02090009
021000                                                                  02100009
021100     PERFORM B300-EOJ.                                            02110009
021200                                                                  02120009
021300     GOBACK.                                                      02130009
021400                                                                  02140009
021500*----------------------------------------------------------------*02150009
021600*    INITIALIZATION PROCESSING                                    02160009
021700*    - OPEN FILE                                                  02170009
021800*    - INITIALIZE DCLGENS AND SWITCHES                            02180009
021900*    - PERFORM SELECTS                                            02190009
022000*----------------------------------------------------------------*02200009
022100 B100-INITIALIZE.                                                 02210009
022200                                                                  02220022
022300     EXEC SQL                                                     02230009
022400         LOCK TABLE APTW_NW_STR_DISC IN EXCLUSIVE MODE            02240026
022500     END-EXEC.                                                    02250009
022600                                                                  02260009
022700     DISPLAY '**------  APKUP914  (PROCESSING MSGS)  ------**'.   02270025
022800                                                                  02280009
022900     OPEN INPUT INPUT-FILE.                                       02290009
023000                                                                  02300009
023100     INITIALIZE  DCLAPT00000                                      02310026
023200                 DCLTCKRSTCNTL                                    02320026
023300                 DCLTCKRSTINF                                     02330026
023400                 PROGRAM-SWITCHES.                                02340009
023500                                                                  02350009
023600     PERFORM S100-GET-CHECKPOINT-CNTL.                            02360009
023700     MOVE PV-CKPT-STAT-CODE TO PS-RUN-TYPE-SW.                    02370009
023800                                                                  02380009
023900     IF RESTART-RUN                                               02390009
024000        PERFORM X200-CHECKPOINT-RESTART                           02400009
024100     ELSE                                                         02410009
024200        PERFORM R100-READ-INPUT-FILE                              02420009
024300     END-IF.                                                      02430009
024400                                                                  02440009
024500     IF PS-EOF                                                    02450009
024600        IF NORMAL-RUN                                             02460009
024700           DISPLAY '****************************************'     02470009
024800           DISPLAY '*  EMPTY APTW_NW_STR_DISC FILE         *'     02480026
024900           DISPLAY '*  PROGRAM ** = APKUP914               *'     02490025
025000           DISPLAY '****************************************'     02500009
025100        ELSE                                                      02510009
025200           DISPLAY '****************************************'     02520009
025300           DISPLAY '*  C/R NO MATCH TO CONTROL DATA'              02530019
025400           DISPLAY '****************************************'     02540010
025500        END-IF                                                    02550010
025600     END-IF.                                                      02560010
025700                                                                  02570010
025800*----------------------------------------------------------------*02580010
025900*    PROCESS INPUT FILE                                           02590010
026000*----------------------------------------------------------------*02600010
026100 B200-PROCESS.                                                    02610010
026200                                                                  02620014
026300     PERFORM I100-INSERT-RECORD.                                  02630014
026400                                                                  02640014
026500     PERFORM X100-CHECKPOINT-COMMIT.                              02650014
026600                                                                  02660014
026700     PERFORM R100-READ-INPUT-FILE.                                02670014
026800                                                                  02680014
026900*----------------------------------------------------------------*02690014
027000*    END OF PROGRAM                                               02700014
027100*    - CLOSE FILE                                                 02710014
027200*    - DISPLAY COUNTS                                             02720014
027300*----------------------------------------------------------------*02730014
027400 B300-EOJ.                                                        02740014
027500                                                                  02750022
027600     CLOSE INPUT-FILE.                                            02760014
027700                                                                  02770014
027800     MOVE PC-RUN-COMPLETE-CODE TO PV-CKPT-STAT-CODE.              02780014
027900     PERFORM U400-UPDATE-TCKRSTCNTL.                              02790026
028000     PERFORM U500-UPDATE-TCKRSTINF.                               02800026
028100     PERFORM V100-COMMIT.                                         02810014
028200                                                                  02820014
028300     DISPLAY '****************************************'.          02830021
028400     MOVE PV-INPUT-COUNT              TO PV-DISP-NBR.             02840014
028500     DISPLAY '** RECORDS READ         = ' PV-DISP-NBR.            02850014
028600     MOVE PV-INSERT-COUNT             TO PV-DISP-NBR.             02860014
028700     DISPLAY '** RECORDS INSERTED     = ' PV-DISP-NBR.            02870014
028800     MOVE PV-COMMIT-COUNT             TO PV-DISP-NBR.             02880014
028900     DISPLAY 'COMMITS TAKEN           = ' PV-DISP-NBR.            02890014
029000*    MOVE PV-DUP-COUNT                TO PV-DISP-NBR.             02900019
029100*    DISPLAY 'DUPLICATE ROWS INSERTED = ' PV-DISP-NBR.            02910019
029200     DISPLAY '****************************************'.          02920021
029300     DISPLAY '**     END OF APKUP914 PROCESSING     **'.          02930025
029400     DISPLAY '****************************************'.          02940021
029500                                                                  02950014
029600*----------------------------------------------------------------*02960014
029700*    INSERT ROW TO APTW_NW_STR_DISC                               02970026
029800*----------------------------------------------------------------*02980014
029900 I100-INSERT-RECORD.                                              02990014
030000                                                                  03000014
030100     PERFORM WITH TEST AFTER                                      03010014
030200             VARYING PV-RETRY-COUNT FROM 1 BY 1                   03020014
030300             UNTIL   (PV-RETRY-COUNT > PC-RETRY-MAX) OR           03030014
030400                     (SQLCODE = ZERO)                             03040018
030500*                    (SQLCODE = ZERO) OR                          03050018
030600*                    (SQLCODE = -803)                             03060018
030700                                                                  03070014
030800          EXEC SQL                                                03080014
030900              INSERT INTO APTW_NW_STR_DISC                        03090026
031000                  (PO_NBR                                         03100026
031100                  ,LOC_NBR                                        03110026
031200                  ,GRND_OPN_DTE                                   03120026
031300                  ,ENT_ID                                         03130026
031400                  ,DEPT_NBR                                       03140026
031500                  ,CNCL_DTE                                       03150026
031600              )                                                   03160014
031700                  VALUES                                          03170014
031800                 (:APT00000-PO-NBR                                03180026
031900                 ,:APT00000-LOC-NBR                               03190026
032000                 ,:APT00000-GRND-OPN-DTE                          03200026
032100                 ,:APT00000-ENT-ID                                03210026
032200                 ,:APT00000-DEPT-NBR                              03220026
032300                 ,:APT00000-CNCL-DTE                              03230026
032400              )                                                   03240014
032500          END-EXEC                                                03250014
032600                                                                  03260014
032700        EVALUATE TRUE                                             03270014
032800           WHEN SQLCODE = ZERO                                    03280014
032900               ADD 1               TO PV-INSERT-COUNT             03290014
033000*          WHEN SQLCODE = -803                                    03300018
033100*              ADD 1               TO PV-DUP-COUNT                03310018
033200                                                                  03320014
033300           WHEN SQLWARN0 NOT = SPACES                             03330014
033400           WHEN SQLCODE  NOT = ZERO                               03340014
033500               MOVE 'I100-INSERT-RECORD'                          03350014
033600                                   TO AA-PARAGRAPH-NAME           03360014
033700               DISPLAY '** PLAN_NAME: ' PC-PROGRAM-NAME           03370014
033800               MOVE 'UNSUCCESSFUL INSERT' TO AA-DB2-OPERATION     03380014
033900               MOVE 'APT00000'     TO AA-DB2-TABLE-1              03390026
034000               MOVE SPACES         TO AA-DB2-TABLE-2              03400014
034100               PERFORM Z998-DB2-ABEND                             03410014
034200        END-EVALUATE                                              03420014
034300                                                                  03430014
034400     END-PERFORM.                                                 03440014
034500                                                                  03450014
034600     IF PV-RETRY-COUNT > PC-RETRY-MAX                             03460014
034700        MOVE 'I100-INSERT-RECORD      ' TO AA-PARAGRAPH-NAME      03470014
034800        MOVE 'MAX RETRIES EXCEEDED ON INSERT' TO AA-DB2-OPERATION 03480014
034900        MOVE 'APT00000'     TO AA-DB2-TABLE-1                     03490026
035000        MOVE SPACES         TO AA-DB2-TABLE-2                     03500014
035100        PERFORM Z998-DB2-ABEND                                    03510014
035200     END-IF.                                                      03520014
035300                                                                  03530014
035400*----------------------------------------------------------------*03540014
035500*    READ INPUT FILE                                              03550014
035600*----------------------------------------------------------------*03560014
035700 R100-READ-INPUT-FILE.                                            03570014
035800                                                                  03580022
035900     READ INPUT-FILE INTO DCLAPT00000                             03590026
036000          AT END                                                  03600014
036100              SET PS-EOF                   TO TRUE                03610014
036200          NOT AT END                                              03620014
036300              ADD 1                        TO PV-INPUT-COUNT      03630014
036400     END-READ.                                                    03640014
036500                                                                  03650014
036600*----------------------------------------------------------------*03660014
036700*    SELECT CHECKPOINT RESTART CONTROL INFO.                      03670014
036800*----------------------------------------------------------------*03680014
036900 S100-GET-CHECKPOINT-CNTL.                                        03690014
037000                                                                  03700014
037100     PERFORM WITH TEST AFTER                                      03710014
037200             VARYING PV-RETRY-COUNT FROM 1 BY 1                   03720014
037300             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             03730014
037400                     SQLCODE = ZERO                               03740014
037500                                                                  03750014
037600        EXEC SQL                                                  03760014
037700           SELECT  CKPT_STAT_CODE                                 03770014
037800             INTO  :PV-CKPT-STAT-CODE                             03780014
037900             FROM  TCKRSTCNTL                                     03790026
038000            WHERE  PLAN_NAME = :PC-PROGRAM-NAME                   03800014
038100        END-EXEC                                                  03810014
038200                                                                  03820014
038300        EVALUATE TRUE                                             03830014
038400           WHEN SQLCODE = ZERO                                    03840014
038500               CONTINUE                                           03850014
038600                                                                  03860014
038700           WHEN SQLWARN0 NOT = SPACES                             03870014
038800           WHEN SQLCODE  NOT = ZERO                               03880014
038900               MOVE 'S100-GET-CHECKPOINT-CNTL'                    03890014
039000                                   TO AA-PARAGRAPH-NAME           03900014
039100               DISPLAY '** PLAN_NAME: ' PC-PROGRAM-NAME           03910014
039200               MOVE 'UNSUCCESSFUL SELECT' TO AA-DB2-OPERATION     03920014
039300               MOVE 'TCKRSTCN'     TO AA-DB2-TABLE-1              03930026
039400               MOVE SPACES         TO AA-DB2-TABLE-2              03940014
039500               PERFORM Z998-DB2-ABEND                             03950014
039600        END-EVALUATE                                              03960014
039700                                                                  03970014
039800     END-PERFORM.                                                 03980014
039900                                                                  03990014
040000     IF PV-RETRY-COUNT > PC-RETRY-MAX                             04000014
040100        MOVE 'S100-GET-CHECKPOINT-CNTL' TO AA-PARAGRAPH-NAME      04010014
040200        MOVE 'MAX RETRIES EXCEEDED ON SELECT' TO AA-DB2-OPERATION 04020014
040300        MOVE 'TCKRSTCN'     TO AA-DB2-TABLE-1                     04030026
040400        MOVE SPACES         TO AA-DB2-TABLE-2                     04040014
040500        PERFORM Z998-DB2-ABEND                                    04050014
040600     END-IF.                                                      04060014
040700                                                                  04070014
040800                                                                  04080014
040900*----------------------------------------------------------------*04090014
041000*    SELECT CHECKPOINT RESTART WORKING STORAGE DESCRIPTION INFO.  04100014
041100*----------------------------------------------------------------*04110014
041200 S200-GET-CHECKPOINT-INFO.                                        04120014
041300                                                                  04130014
041400     PERFORM WITH TEST AFTER                                      04140014
041500             VARYING PV-RETRY-COUNT FROM 1 BY 1                   04150014
041600             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             04160014
041700                     SQLCODE = ZERO                               04170014
041800                                                                  04180014
041900        EXEC SQL                                                  04190014
042000           SELECT  WORK_STRG_DESC                                 04200014
042100             INTO  :TCKRSTINF-WORK-STRG-DESC                      04210026
042200             FROM  TCKRSTINF                                      04220026
042300            WHERE  PLAN_NAME = :PC-PROGRAM-NAME                   04230014
042400        END-EXEC                                                  04240014
042500                                                                  04250014
042600        EVALUATE TRUE                                             04260014
042700           WHEN SQLCODE = ZERO                                    04270014
042800               CONTINUE                                           04280014
042900                                                                  04290014
043000           WHEN SQLWARN0 NOT = SPACES                             04300014
043100           WHEN SQLCODE  NOT = ZERO                               04310014
043200               MOVE 'S200-GET-CHECKPOINT-INFO'                    04320014
043300                                   TO AA-PARAGRAPH-NAME           04330014
043400               DISPLAY '** PLAN_NAME: ' PC-PROGRAM-NAME           04340014
043500               MOVE 'UNSUCCESSFUL SELECT' TO AA-DB2-OPERATION     04350014
043600               MOVE 'TCKRSTIN'     TO AA-DB2-TABLE-1              04360026
043700               MOVE SPACES         TO AA-DB2-TABLE-2              04370014
043800               PERFORM Z998-DB2-ABEND                             04380014
043900        END-EVALUATE                                              04390014
044000                                                                  04400014
044100     END-PERFORM.                                                 04410014
044200                                                                  04420014
044300     IF PV-RETRY-COUNT > PC-RETRY-MAX                             04430014
044400        MOVE 'S200-GET-CHECKPOINT-INFO' TO AA-PARAGRAPH-NAME      04440014
044500        MOVE 'MAX RETRIES EXCEEDED ON SELECT' TO AA-DB2-OPERATION 04450014
044600        MOVE 'TCKRSTIN'     TO AA-DB2-TABLE-1                     04460026
044700        MOVE SPACES         TO AA-DB2-TABLE-2                     04470026
044800        PERFORM Z998-DB2-ABEND                                    04480014
044900     END-IF.                                                      04490014
045000                                                                  04500014
045100*----------------------------------------------------------------*04510014
045200*    UPDATES THE CHECKPOINT RESTART CONTROL TABLE.  THE STATUS   *04520014
045300*    CODE IS SET TO '9' (RUN IN PROGRESS) OR '0' (RUN COMPLETE). *04530014
045400*----------------------------------------------------------------*04540014
045500 U400-UPDATE-TCKRSTCNTL.                                          04550026
045600                                                                  04560014
045700     PERFORM WITH TEST AFTER                                      04570014
045800             VARYING PV-RETRY-COUNT FROM 1 BY 1                   04580014
045900             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             04590014
046000                     SQLCODE = ZERO                               04600014
046100                                                                  04610014
046200        EXEC SQL                                                  04620014
046300            UPDATE TCKRSTCNTL                                     04630026
046400               SET CKPT_STAT_CODE = :PV-CKPT-STAT-CODE            04640014
046500            WHERE PLAN_NAME      = :PC-PROGRAM-NAME               04650014
046600        END-EXEC                                                  04660014
046700                                                                  04670014
046800        EVALUATE TRUE                                             04680014
046900            WHEN SQLCODE = ZERO                                   04690014
047000                CONTINUE                                          04700014
047100                                                                  04710014
047200            WHEN SQLWARN0 NOT = SPACES                            04720014
047300            WHEN SQLCODE  NOT = ZERO                              04730014
047400                MOVE 'U400-UPDATE-TCKRSTCNTL'                     04740026
047500                                        TO AA-PARAGRAPH-NAME      04750026
047600                DISPLAY '** PLAN_NAME: ' PC-PROGRAM-NAME          04760026
047700                MOVE 'UNSUCCESSFUL UPDATE' TO AA-DB2-OPERATION    04770026
047800                MOVE 'TCKRSTCN'         TO AA-DB2-TABLE-1         04780026
047900                MOVE SPACES             TO AA-DB2-TABLE-2         04790026
048000                PERFORM Z998-DB2-ABEND                            04800026
048100        END-EVALUATE                                              04810026
048200                                                                  04820026
048300     END-PERFORM.                                                 04830026
048400                                                                  04840026
048500     IF PV-RETRY-COUNT > PC-RETRY-MAX                             04850026
048600        MOVE 'U400-UPDATE-TCKRSTCNTL' TO AA-PARAGRAPH-NAME        04860026
048700        MOVE 'MAX RETRIES EXCEEDED ON UPDATE' TO AA-DB2-OPERATION 04870026
048800        MOVE 'TCKRSTCN'     TO AA-DB2-TABLE-1                     04880026
048900        MOVE SPACES         TO AA-DB2-TABLE-2                     04890026
049000        PERFORM Z998-DB2-ABEND                                    04900026
049100     END-IF.                                                      04910026
049200                                                                  04920026
049300                                                                  04930026
049400*----------------------------------------------------------------*04940026
049500*    UPDATES THE CHECKPOINT RESTART INFO TABLE.  THE WORKING     *04950026
049600*    STORAGE DESCRIPTION FIELD IS UPDATED WITH THE CURRENT INPUT *04960026
049700*    FILE RECORD COUNTS AND THE FILE PROCESSOR INDICATOR.         04970026
049800*----------------------------------------------------------------*04980026
049900 U500-UPDATE-TCKRSTINF.                                           04990026
050000                                                                  05000026
050100     MOVE APT00000-PO-NBR           TO CR-PO-NBR.                 05010026
050200     MOVE APT00000-LOC-NBR          TO CR-LOC-NBR.                05020026
050300     MOVE APT00000-GRND-OPN-DTE     TO CR-GRND-OPN-DTE.           05030026
050400     MOVE APT00000-ENT-ID           TO CR-ENT-ID.                 05040026
050500     MOVE APT00000-DEPT-NBR         TO CR-DEPT-NBR.               05050026
050600     MOVE APT00000-CNCL-DTE         TO CR-CNCL-DTE.               05060026
050700     MOVE PV-INPUT-COUNT            TO CR-READ-CNT.               05070026
050800     MOVE PV-INSERT-COUNT           TO CR-INSERT-CNT.             05080026
050900     MOVE CR-CKPT-RESTART-INFO TO TCKRSTINF-WORK-STRG-DESC-LEN.   05090026
051000     MOVE 4022                 TO TCKRSTINF-WORK-STRG-DESC-TEXT.  05100026
051100                                                                  05110026
051200     PERFORM WITH TEST AFTER                                      05120026
051300             VARYING PV-RETRY-COUNT FROM 1 BY 1                   05130026
051400             UNTIL   PV-RETRY-COUNT > PC-RETRY-MAX OR             05140026
051500                     SQLCODE = ZERO                               05150026
051600                                                                  05160026
051700        EXEC SQL                                                  05170026
051800            UPDATE TCKRSTINF                                      05180026
051900               SET WORK_STRG_DESC = :TCKRSTINF-WORK-STRG-DESC     05190026
052000             WHERE PLAN_NAME      = :PC-PROGRAM-NAME              05200026
052100        END-EXEC                                                  05210026
052200                                                                  05220026
052300        EVALUATE TRUE                                             05230026
052400            WHEN SQLCODE = ZERO                                   05240026
052500                CONTINUE                                          05250026
052600                                                                  05260026
052700            WHEN SQLWARN0 NOT = SPACES                            05270026
052800            WHEN SQLCODE  NOT = ZERO                              05280026
052900                MOVE 'U500-UPDATE-TCKRSTINF' TO AA-PARAGRAPH-NAME 05290026
053000                DISPLAY '** PLAN_NAME: ' PC-PROGRAM-NAME          05300026
053100                MOVE 'UNSUCCESSFUL UPDATE' TO AA-DB2-OPERATION    05310026
053200                MOVE 'TCKRSTIN'        TO AA-DB2-TABLE-1          05320026
053300                MOVE SPACES            TO AA-DB2-TABLE-2          05330026
053400                PERFORM Z998-DB2-ABEND                            05340026
053500        END-EVALUATE                                              05350026
053600                                                                  05360026
053700     END-PERFORM.                                                 05370026
053800                                                                  05380026
053900     IF PV-RETRY-COUNT > PC-RETRY-MAX                             05390026
054000        MOVE 'U500-UPDATE-TCKRSTINF' TO AA-PARAGRAPH-NAME         05400026
054100        MOVE 'MAX RETRIES EXCEEDED ON UPDATE' TO AA-DB2-OPERATION 05410026
054200        MOVE 'TCKRSTIN'     TO AA-DB2-TABLE-1                     05420026
054300        MOVE SPACES         TO AA-DB2-TABLE-2                     05430026
054400        PERFORM Z998-DB2-ABEND                                    05440026
054500     END-IF.                                                      05450026
054600                                                                  05460026
054700                                                                  05470026
054800*----------------------------------------------------------------*05480026
054900*    ISSUES AN SQL COMMIT WORK AFTER A LUW HAS BEEN COMPLETED.   *05490026
055000*----------------------------------------------------------------*05500026
055100 V100-COMMIT.                                                     05510026
055200                                                                  05520026
055300     EXEC SQL                                                     05530026
055400         COMMIT                                                   05540026
055500     END-EXEC.                                                    05550026
055600                                                                  05560026
055700     EVALUATE TRUE                                                05570026
055800         WHEN SQLCODE = ZEROS                                     05580026
055900             ADD 1                    TO PV-COMMIT-COUNT          05590026
056000         WHEN OTHER                                               05600026
056100             MOVE 'V100-COMMIT' TO AA-PARAGRAPH-NAME              05610026
056200             MOVE 'UNSUCCESSFUL COMMIT' TO AA-DB2-OPERATION       05620026
056300             MOVE SPACES        TO AA-DB2-TABLE-1                 05630026
056400                                   AA-DB2-TABLE-2                 05640026
056500             PERFORM Z998-DB2-ABEND                               05650026
056600     END-EVALUATE.                                                05660026
056700                                                                  05670026
056800                                                                  05680026
056900*----------------------------------------------------------------*05690026
057000*    DO THE CHECKPOINT RESTART AND THE COMMIT.                    05700026
057100*----------------------------------------------------------------*05710026
057200 X100-CHECKPOINT-COMMIT.                                          05720026
057300                                                                  05730026
057400     EXEC SQL                                                     05740026
057500       SET :CR-CURR-TMST = CURRENT TIMESTAMP                      05750026
057600     END-EXEC.                                                    05760026
057700                                                                  05770026
057800     EVALUATE TRUE                                                05780026
057900         WHEN SQLCODE = ZERO                                      05790026
058000              CONTINUE                                            05800026
058100                                                                  05810026
058200        WHEN SQLWARN0 NOT = SPACES                                05820026
058300        WHEN SQLCODE  NOT = ZERO                                  05830026
058400            MOVE 'UNSUCCESSFUL SET TMST' TO AA-PARAGRAPH-NAME     05840026
058500            MOVE SPACES         TO AA-DB2-OPERATION               05850026
058600                                   AA-DB2-TABLE-1                 05860026
058700                                   AA-DB2-TABLE-2                 05870026
058800            PERFORM Z998-DB2-ABEND                                05880026
058900     END-EVALUATE.                                                05890026
059000                                                                  05900026
059100     IF CR-CURR-TMST > CR-NEXT-TMST                               05910026
059200        MOVE PC-IN-PROCESS-CODE      TO PV-CKPT-STAT-CODE         05920026
059300        PERFORM U400-UPDATE-TCKRSTCNTL                            05930026
059400        PERFORM U500-UPDATE-TCKRSTINF                             05940026
059500        PERFORM V100-COMMIT                                       05950026
059600                                                                  05960026
059700        EXEC SQL                                                  05970026
059800          SELECT  (CURRENT TIMESTAMP + CKPT_FRQNCY_QTY SECONDS)   05980026
059900            INTO  :CR-NEXT-TMST                                   05990026
060000            FROM  TCKRSTCNTL                                      06000026
060100           WHERE  PLAN_NAME = :PC-PROGRAM-NAME                    06010026
060200        END-EXEC                                                  06020026
060300                                                                  06030026
060400        EVALUATE TRUE                                             06040026
060500           WHEN SQLCODE = ZERO                                    06050026
060600               CONTINUE                                           06060026
060700                                                                  06070026
060800           WHEN SQLWARN0 NOT = SPACES                             06080026
060900           WHEN SQLCODE  NOT = ZERO                               06090026
061000               MOVE 'UNSUCCESSFUL NEXT TMST' TO AA-PARAGRAPH-NAME 06100026
061100               MOVE SPACES         TO AA-DB2-OPERATION            06110026
061200                                      AA-DB2-TABLE-1              06120026
061300                                      AA-DB2-TABLE-2              06130026
061400               PERFORM Z998-DB2-ABEND                             06140026
061500        END-EVALUATE                                              06150026
061600     END-IF.                                                      06160026
061700                                                                  06170026
061800                                                                  06180026
061900*----------------------------------------------------------------*06190026
062000*    GET THE RESTART INFO.                                        06200026
062100*----------------------------------------------------------------*06210026
062200 X200-CHECKPOINT-RESTART.                                         06220026
062300                                                                  06230026
062400     PERFORM S200-GET-CHECKPOINT-INFO.                            06240026
062500     MOVE TCKRSTINF-WORK-STRG-DESC-TEXT TO CR-CKPT-RESTART-INFO.  06250026
062600                                                                  06260026
062700     DISPLAY '****************************************'.          06270026
062800     DISPLAY '** >>>> APKUP914 CHECKPOINT RESTART <<<<'.          06280026
062900     DISPLAY '** PO NBR ON RESTART          = ' CR-PO-NBR.        06290028
063000     DISPLAY '** LOC NBR ON RESTART         = ' CR-LOC-NBR.       06300028
063100     DISPLAY '** RECORDS TO READ ON RESTART = ' CR-READ-CNT.      06310026
063200     DISPLAY '** RECORDS ALREADY INSERTED   = ' CR-INSERT-CNT.    06320026
063300     DISPLAY '*  C/R CONTROL DATA'                                06330026
063400     MOVE CR-PO-NBR   TO PV-UNPACK-LONG-NBR.                      06340029
063500     DISPLAY '*  PO NBR       = ' PV-UNPACK-LONG-NBR.             06350029
063600     MOVE CR-LOC-NBR  TO PV-UNPACK-SHORT-NBR.                     06360029
063700     DISPLAY '*  LOC NBR      = ' PV-UNPACK-SHORT-NBR.            06370029
063800     DISPLAY '*  GRND OPN DTE = ' CR-GRND-OPN-DTE.                06380029
063900     MOVE CR-ENT-ID   TO PV-UNPACK-LONG-NBR.                      06390029
064000     DISPLAY '*  ENT ID       = ' PV-UNPACK-LONG-NBR.             06400029
064100     MOVE CR-DEPT-NBR TO PV-UNPACK-SHORT-NBR.                     06410029
064200     DISPLAY '*  DEPT NBR     = ' PV-UNPACK-SHORT-NBR.            06420029
064300     DISPLAY '*  CNCL DTE     = ' CR-CNCL-DTE.                    06430029
064400     DISPLAY '****************************************'.          06440029
064500                                                                  06450029
064600**************************************************************    06460029
064700* THIS READ POSITIONS THE FILE AT THE LAST RECORD THAT WAS        06470029
064800* PROCESSED SUCCESSFULLY.                                         06480029
064900**************************************************************    06490029
065000     PERFORM R100-READ-INPUT-FILE                                 06500029
065100           WITH TEST AFTER                                        06510029
065200                UNTIL PS-EOF                                      06520029
065300                  OR  PV-INPUT-COUNT         = CR-READ-CNT.       06530029
065400*                 OR (PSA12-VENDOR-ID        = CR-VENDOR-ID       06540029
065500*                AND  PSA12-INVOICE-ID       = CR-INVOICE-ID      06550029
065600*                AND  PSA12-KC-SKU-NBR       = CR-KC-SKU-NBR      06560029
065700*                AND  PSA12-DEPTID           = CR-DEPTID          06570029
065800*                AND  PSA12-KC-PO-NBR        = CR-KC-PO-NBR       06580029
065900*                AND  PSA12-KC-VS-NBR        = CR-KC-VS-NBR       06590029
066000*                AND  PSA12-KC-INVC-QTY      = CR-KC-INVC-QTY     06600029
066100*                AND  PSA12-KC-RCVD-QTY      = CR-KC-RCVD-QTY     06610029
066200*                AND  PSA12-KC-INVC-COST-AMT = CR-KC-INVC-COST-AMT06620029
066300*                AND  PSA12-KC-ORD-COST-AMT  = CR-KC-ORD-COST-AMT 06630029
066400*                AND  PSA12-KC-TOT-COST-AMT  = CR-KC-TOT-COST-AMT 06640029
066500*                AND  PSA12-ORIGIN           = CR-ORIGIN          06650029
066600*                AND  PSA12-KC-CRE-DTE       = CR-KC-CRE-DTE      06660029
066700*                AND  PSA12-KC-AP-MEMO-TMST  = CR-KC-AP-MEMO-TMST 06670029
066800*                AND  PSA12-UPC-ID           = CR-UPC-ID).        06680029
066900                                                                  06690029
067000     IF NOT PS-EOF                                                06700029
067100        PERFORM R100-READ-INPUT-FILE                              06710029
067200     END-IF.                                                      06720029
067300                                                                  06730029
067400*----------------------------------------------------------------*06740029
067500*    DB2 ABEND ROUTINE                                            06750029
067600*----------------------------------------------------------------*06760029
067700 Z998-DB2-ABEND.                                                  06770029
067800                                                                  06780029
067900     CLOSE INPUT-FILE.                                            06790029
068000                                                                  06800029
068100     DISPLAY AA-ABEND-LIT.                                        06810029
068200     DISPLAY AA-MESSAGE-LINE-1.                                   06820029
068300     DISPLAY AA-MESSAGE-LINE-2.                                   06830029
068400     DISPLAY AA-DB2-ERROR-LIT.                                    06840029
068500     DISPLAY AA-PROGRAM-LIT.                                      06850029
068600     DISPLAY AA-PARAGRAPH-LIT.                                    06860029
068700     DISPLAY AA-DB2-OPERATION-LIT.                                06870029
068800     DISPLAY AA-DB2-TABLE-1.                                      06880029
068900     DISPLAY AA-DB2-TABLE-2.                                      06890029
069000     SET AC-DB2-ERROR TO TRUE.                                    06900029
069100                                                                  06910029
069200     COPY DPPD004.                                                06920029
069300                                                                  06930029
069400     CALL 'ILBOABN0' USING ABEND-CODE.                            06940029
