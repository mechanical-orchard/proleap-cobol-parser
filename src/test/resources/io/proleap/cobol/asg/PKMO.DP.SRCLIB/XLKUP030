000100 IDENTIFICATION DIVISION.                                         00010000
000200 TITLE 'APPLY USER DOMAIN CHANGES'.                               00020000
000300                                                                  00030000
000400 PROGRAM-ID.             XLKUP030.                                00040000
000500 AUTHOR.                 THERESE RAMSEYER.                        00050000
000600 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00060000
000700 DATE-WRITTEN            JANUARY 2004.                            00070000
000800 DATE-COMPILED.                                                   00080000
000900****************************************************************  00090000
001000*    U S E R   D O M A I N   S Y N C / U P D A T E                00100000
001100*                                                                 00110000
001200****************************************************************  00120000
001300* THIS PROGRAM READS AN INPUT FILE OF THE DIFFERENCES FOUND       00130000
001400* BETWEEN THE COMMON EXTRACT FILE AND THE UNLOAD OF THE XLT_USR   00140000
001500* TABLE. THE PROCESSING APPLIES ADDS, UPDATES AND DELETES IN      00150000
001600* ORDER TO KEEP THE COMMON EXTRACT FILE AND THE XLT_USR TABLE     00160000
001700* IN SYNC.                                                        00170000
001800* IF A DELETE IS ATTEMPTED AND THERE IS A REFERENTIAL INTEGRITY   00180000
001900* DB2 ERROR (-532), PROCESSING WILL CONTINUE, SEND A MESSAGE TO   00190000
002000* SYSOUT AND TALLY THE FAILED DELETES FOR THE END OF JOB SUMMARY  00200000
002100* STATS.                                                          00210000
002200* COMMITS ARE DONE AT 20 RECORD INTERVALS.                        00220000
002300* --------RETURN CODES-----------                                 00230000
002400* 4092 - REFERENTIAL INTEGRITY ISSUE /DELETE NOT PERFORMED        00240000
002500* 4093 - NOT FOUND SQL CODE /UPDATE NOT PERFORMED                 00250000
002600* 4094 - DATA INTEGRITY ISSUE FOUND DURING A WEEKLY CHECK         00260000
002700* 4095 - COMMON EXTRACT FILE IS EMPTY                             00270000
002800****************************************************************  00280000
002900 ENVIRONMENT DIVISION.                                            00290000
003000 CONFIGURATION SECTION.                                           00300000
003100 SOURCE-COMPUTER.        IBM-3090.                                00310000
003200 OBJECT-COMPUTER.        IBM-3090.                                00320000
003300 INPUT-OUTPUT SECTION.                                            00330000
003400                                                                  00340000
003500 FILE-CONTROL.                                                    00350000
003600                                                                  00360000
003700     SELECT XL-TRANS-FILE                                         00370000
003800         ASSIGN TO INP01.                                         00380000
003900                                                                  00390000
004000 DATA DIVISION.                                                   00400000
004100 FILE SECTION.                                                    00410000
004200                                                                  00420000
004300                                                                  00430000
004400 FD  XL-TRANS-FILE                                                00440000
004500     RECORDING MODE IS F                                          00450000
004600     LABEL RECORDS ARE STANDARD                                   00460000
004700     RECORD CONTAINS 250 CHARACTERS                               00470000
004800     BLOCK CONTAINS 0  RECORDS.                                   00480000
004900 01  XL-TRANS-REC                     PIC X(250).                 00490000
005000                                                                  00500000
005100 WORKING-STORAGE SECTION.                                         00510000
005200 01  PS-SWITCHES.                                                 00520000
005300     05  PS-EOF-TRANS-SW              PIC X(01) VALUE 'N'.        00530000
005400         88  PS-EOF-TRANS                       VALUE 'Y'.        00540000
005500     05  PS-FAILED-DELETE-SW          PIC X(01) VALUE 'N'.        00550000
005600         88  PS-DELETE-FAILED-YES               VALUE 'Y'.        00560000
005700     05  PS-FOUND-FOR-UPD-SW          PIC X(01) VALUE 'Y'.        00570000
005800         88  PS-FOUND-FOR-UPD-YES               VALUE 'Y'.        00580000
005900         88  PS-FOUND-FOR-UPD-NO                VALUE 'N'.        00590000
005910     05  PS-USER-ID-REVOKED-SW        PIC X(01) VALUE 'Y'.        00591000
005920         88  PS-USER-ID-REVOKED-YES             VALUE 'Y'.        00592000
005930         88  PS-USER-ID-REVOKED-NO              VALUE 'N'.        00593000
006000                                                                  00600000
006100     05  PS-COMMIT-SW                 PIC X(01) VALUE SPACE.      00610000
006200         88  PS-COMMIT-NOW                      VALUE 'Y'.        00620000
006300         88  PS-NO-COMMIT-YET                   VALUE 'N'.        00630000
006400                                                                  00640000
006500 01  DN-NULL-INDICATORS.                                          00650000
006600     05  DN-DIST-NBR                  PIC S9(04) COMP VALUE +0.   00660000
006700                                                                  00670000
006800 01  PA-PROGRAM-ACCUMULATORS.                                     00680000
006900     05  PA-COMMIT-COUNT             PIC 9(07) VALUE ZERO.        00690000
006900     05  PA-TOT-COMMITS-TAKEN        PIC 9(07) VALUE ZERO.        00691002
007000     05  PA-TOT-IN-RECS-READ         PIC 9(07) VALUE ZERO.        00700000
007100     05  PA-TOT-ADD-RECS-READ        PIC 9(07) VALUE ZERO.        00710000
007200     05  PA-TOT-MOD-RECS-READ        PIC 9(07) VALUE ZERO.        00720000
007300     05  PA-TOT-DEL-RECS-READ        PIC 9(07) VALUE ZERO.        00730000
007400     05  PA-TOT-DB2-INSERTS          PIC 9(07) VALUE ZERO.        00740000
007500     05  PA-TOT-DB2-UPDATES          PIC 9(07) VALUE ZERO.        00750000
007600     05  PA-TOT-DB2-DELETES          PIC 9(07) VALUE ZERO.        00760000
007700     05  PA-TOT-RI-FAILED-DELS       PIC 9(07) VALUE ZERO.        00770000
007710     05  PA-TOT-RI-REVOKED-DELS      PIC 9(07) VALUE ZERO.        00771000
007800                                                                  00780000
007900 01  PV-PROGRAM-VARIABLES.                                        00790000
008000     05  PV-RETRY-COUNTER            PIC S9(03) VALUE ZERO COMP-3.00800000
008100     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'XLKUP030'. 00810000
008110     05  PC-N                         PIC X(01) VALUE 'N'.        00811000
008200     05  PC-MAX-RETRIES               PIC S9(04) VALUE +3 COMP.   00820000
008300     05  PV-DISPLAY                   PIC Z,ZZZ,ZZ9.              00830000
008400     05  PV-ABEND-CODE                PIC S9(04) COMP SYNC        00840000
008500                                                 VALUE ZERO.      00850000
008600                                                                  00860000
008700 01  PV-ABEND-FIELDS.                                             00870000
008800     05  PV-ABEND-PROGRAM             PIC X(8)   VALUE 'XLKUP030'.00880000
008900     05  PV-ABEND-PARAGRAPH           PIC X(50)  VALUE SPACES.    00890000
009000     05  PV-ABEND-OPERATION           PIC X(50)  VALUE SPACES.    00900000
009100     05  PV-ABEND-STRUCTURE-1         PIC X(8)   VALUE SPACES.    00910000
009200     05  PV-ABEND-STRUCTURE-2         PIC X(8)   VALUE SPACES.    00920000
009300     05  PV-ABEND-STRUCTURE-3         PIC X(8)   VALUE SPACES.    00930000
009400     05  PV-ABEND-STATUS              PIC XX     VALUE SPACES.    00940000
009500     05  PV-DB2-OPERATION-MESSAGE-1   PIC  X(79) VALUE SPACES.    00950000
009600     05  PV-DB2-OPERATION-MESSAGE-2   PIC  X(79) VALUE SPACES.    00960000
009700     05  PV-DB2-OPERATION-MESSAGE-3   PIC  X(79) VALUE SPACES.    00970000
009800     05  PV-DB2-OPERATION-MESSAGE-4   PIC  X(79) VALUE SPACES.    00980000
009900     05  PV-SQLCODE                   PIC 9(9)  VALUE ZERO.       00990000
010000/                                                                 01000000
010100*    TRANSACTION RECORD                                           01010000
010200     COPY XLRD038.                                                01020000
010300/                                                                 01030000
010400*  USED FOR DB2 ERROR MESSAGE BUILDING                            01040000
010500     COPY DPWS004.                                                01050000
010600                                                                  01060000
010700*   DB2 SQL COMMUNICATION AREA                                    01070000
010800     EXEC SQL                                                     01080000
010900          INCLUDE SQLCA                                           01090000
011000     END-EXEC.                                                    01100000
011100     COPY SQLCA2.                                                 01110000
011200/                                                                 01120000
011300*    XLT_USR                                                      01130000
011400     EXEC SQL                                                     01140000
011500          INCLUDE XLT00024                                        01150000
011600     END-EXEC.                                                    01160000
011700                                                                  01170000
011800/                                                                 01180000
011900 PROCEDURE DIVISION.                                              01190000
012000     PERFORM 1000-INITIALIZE.                                     01200000
012100     PERFORM 2000-PROCESS UNTIL PS-EOF-TRANS.                     01210000
012200     PERFORM 9000-EOJ.                                            01220000
012300     STOP RUN.                                                    01230000
012400                                                                  01240000
012500 1000-INITIALIZE.                                                 01250000
012600                                                                  01260000
012700*SET UP COUNTERS                                                  01270000
012800     MOVE 0 TO PA-PROGRAM-ACCUMULATORS.                           01280000
012900*OPEN INPUT                                                       01290000
013000     OPEN INPUT XL-TRANS-FILE.                                    01300000
013100*PRIME READ                                                       01310000
013200     PERFORM 8000-READ-TRANS-FILE.                                01320000
013300     IF PS-EOF-TRANS                                              01330000
013400         DISPLAY ALL '*'                                          01340000
013500         DISPLAY '**  INP01 TRANS FILE IS EMPTY **'               01350000
013600         DISPLAY ALL '*'                                          01360000
013700     END-IF.                                                      01370000
013800                                                                  01380000
013900******************************************************************01390000
014000* APPLY USER DIFFERENCES TO THE XLT_USR TABLE                    *01400000
014100******************************************************************01410000
014200 2000-PROCESS.                                                    01420000
014300                                                                  01430000
014400     EVALUATE TRUE                                                01440000
014500          WHEN XL038-ADD                                          01450000
014600             PERFORM 7000-INSERT                                  01460000
014700                                                                  01470000
014800          WHEN XL038-DELETE                                       01480000
014900             PERFORM 7100-DELETE                                  01490000
015000                                                                  01500000
015100          WHEN XL038-MODIFY                                       01510000
015200             PERFORM 7200-UPDATE                                  01520000
015300                                                                  01530000
015400     END-EVALUATE.                                                01540000
015500                                                                  01550000
015600                                                                  01560000
015700     PERFORM 8000-READ-TRANS-FILE.                                01570000
015800                                                                  01580000
015900******************************************************************01590000
016000* COMMITTED RECORDS WILL REMAIN IN DB2 TABLES AFTER AN ABEND.     01600000
016100******************************************************************01610000
016200 6000-DB2-COMMIT.                                                 01620000
016300                                                                  01630000
016500     EXEC SQL                                                     01650001
016600          COMMIT                                                  01660001
016700     END-EXEC.                                                    01670001
016900                                                                  01690000
017000     EVALUATE TRUE                                                01700000
017100         WHEN SQLCODE = +0                                        01710000
017200              MOVE 0  TO PA-COMMIT-COUNT                          01720000
017200              ADD  1  TO PA-TOT-COMMITS-TAKEN                     01721002
017300         WHEN SQLWARN0 NOT = SPACES                               01730000
017400         WHEN SQLCODE  NOT = ZERO                                 01740000
017500         DISPLAY '****************************'                   01750000
017600         DISPLAY '** ABEND                  **'                   01760000
017700         DISPLAY '** PROGRAM = XLKUP030     **'                   01770000
017800         DISPLAY '** PARAGRAPH = 6000-COMMIT**'                   01780000
017900         DISPLAY '** UNSUCCESSFUL COMMIT    **'                   01790000
018000         DISPLAY '****************************'                   01800000
018100         PERFORM 9900-SQL-ERROR                                   01810000
018200     END-EVALUATE.                                                01820000
018300                                                                  01830000
018400****************************************************************  01840000
018500* INSERT                                                          01850000
018600****************************************************************  01860000
018700 7000-INSERT.                                                     01870000
018800     MOVE '7000-INSERT            '   TO PV-ABEND-PARAGRAPH.      01880000
018900                                                                  01890000
019000     MOVE XL038-U-USR-ID              TO XLT00024-USR-ID.         01900000
019100     MOVE XL038-U-LAST-NM             TO XLT00024-USR-LAST-NM.    01910000
019200     IF XL038-U-FRST-NM < SPACE                                   01920000
019300        MOVE SPACE                    TO XLT00024-USR-FRST-NM     01930000
019400     ELSE                                                         01940000
019500        MOVE XL038-U-FRST-NM          TO XLT00024-USR-FRST-NM     01950000
019600     END-IF.                                                      01960000
019700     IF XL038-U-MID-INIT < SPACE                                  01970000
019800        MOVE SPACE                    TO XLT00024-USR-MID-INIT    01980000
019900     ELSE                                                         01990000
020000        MOVE XL038-U-MID-INIT         TO XLT00024-USR-MID-INIT    02000000
020100     END-IF.                                                      02010000
020200     MOVE XL038-U-RVKE-IND            TO XLT00024-USR-RVKE-IND.   02020000
020300     MOVE XL038-U-DFLT-PRTR-ID        TO XLT00024-DFLT-PRTR-ID.   02030000
020400     MOVE XL038-U-EMP-ID              TO XLT00024-EMP-ID.         02040000
020500                                                                  02050000
020600     PERFORM                                                      02060000
020700         WITH TEST AFTER                                          02070000
020800         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     02080000
020900         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES) OR            02090000
021000                (SQLCODE = ZERO))                                 02100005
021100                                                                  02110000
021200     EXEC SQL                                                     02120000
021300         INSERT INTO XLT_USR                                      02130000
021400             (USR_ID                                              02140000
021500             ,USR_LAST_NM                                         02150000
021600             ,USR_FRST_NM                                         02160000
021700             ,USR_MID_INIT                                        02170000
021800             ,USR_RVKE_IND                                        02180000
021900             ,DFLT_PRTR_ID                                        02190000
022000             ,EMP_ID                                              02200000
022100             ,LAST_UPD_TMST                                       02210000
022200              )                                                   02220000
022300             VALUES                                               02230000
022400            (:XLT00024-USR-ID                                     02240000
022500            ,:XLT00024-USR-LAST-NM                                02250000
022600            ,:XLT00024-USR-FRST-NM                                02260000
022700            ,:XLT00024-USR-MID-INIT                               02270000
022800            ,:XLT00024-USR-RVKE-IND                               02280000
022900            ,:XLT00024-DFLT-PRTR-ID                               02290000
023000            ,:XLT00024-EMP-ID                                     02300000
023100            ,CURRENT TIMESTAMP                                    02310000
023200            )                                                     02320000
023300         END-EXEC                                                 02330000
023400                                                                  02340000
023500         EVALUATE TRUE                                            02350000
023600             WHEN SQLCODE = ZERO                                  02360000
023700                 ADD 1                TO PA-TOT-DB2-INSERTS       02370000
023800                                         PA-COMMIT-COUNT          02380000
016400                 IF  PA-COMMIT-COUNT > 19                         02381001
023900                     PERFORM 6000-DB2-COMMIT                      02390001
016400                 END-IF                                           02391001
024000             WHEN SQLCODE = -904                                  02400000
024100             WHEN SQLCODE = -911                                  02410000
024200             WHEN SQLCODE = -913                                  02420000
024300                 CONTINUE                                         02430000
024400                                                                  02440000
024500             WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')              02450000
024600                 DISPLAY '**************************************' 02460000
024700                 DISPLAY 'WARNING ISSUED ON INSERT OF XLT00024   '02470000
024800                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              02480000
024900                 DISPLAY '**********************************'     02490000
025000                 PERFORM 9800-SQL-WARNING                         02500000
025100                                                                  02510000
025200             WHEN SQLCODE < ZERO                                  02520000
025300                 DISPLAY '**************************************' 02530000
025400                 DISPLAY 'ERROR ISSUED ON INSERT OF XLT00024   '  02540000
025500                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              02550000
025600                 MOVE SQLCODE TO PV-DISPLAY                       02560000
025700                 DISPLAY 'SQLCODE =' PV-DISPLAY                   02570000
025800                 PERFORM 9900-SQL-ERROR                           02580000
025900                                                                  02590000
026000         END-EVALUATE                                             02600000
026100     END-PERFORM                                                  02610000
026200                                                                  02620000
026300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    02630000
026400         SQLCODE NOT = ZERO                                       02640000
026500         DISPLAY '**************************************'         02650000
026600         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         02660000
026700         DISPLAY 'INSERT TO XLT00024                    '         02670000
026800         DISPLAY 'ERROR ISSUED ON INSERT OF XLT00024  '           02680000
026900         DISPLAY 'USR-ID = ' XLT00024-USR-ID                      02690000
027000         DISPLAY '**************************************'         02700000
027100         PERFORM 9900-SQL-ERROR                                   02710000
027200     END-IF.                                                      02720000
027300                                                                  02730000
027400****************************************************************  02740000
027500* DELETE                                                          02750000
027600****************************************************************  02760000
027700 7100-DELETE.                                                     02770000
027800     MOVE '7100-DELETE             '  TO PV-ABEND-PARAGRAPH.      02780000
027900                                                                  02790000
028000     MOVE XL038-U-USR-ID              TO XLT00024-USR-ID.         02800000
028001                                                                  02800100
028200     PERFORM                                                      02820000
028300         WITH TEST AFTER                                          02830000
028400         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     02840000
028500         UNTIL  (PV-RETRY-COUNTER > PC-MAX-RETRIES) OR            02850000
028600                (SQLCODE = ZERO OR +100 OR -532)                  02860000
028700                                                                  02870000
028800         EXEC SQL                                                 02880000
028900             DELETE FROM XLT_USR                                  02890000
029000             WHERE USR_ID    = :XLT00024-USR-ID                   02900000
029200         END-EXEC                                                 02920000
029300                                                                  02930000
029400         EVALUATE TRUE                                            02940000
029500             WHEN SQLCODE = ZERO                                  02950000
029600                 ADD 1                TO PA-TOT-DB2-DELETES       02960000
029700                                         PA-COMMIT-COUNT          02970000
016400                 IF  PA-COMMIT-COUNT > 19                         02971001
023900                     PERFORM 6000-DB2-COMMIT                      02972001
016400                 END-IF                                           02973001
029900             WHEN SQLCODE = -532                                  02990000
030000                 SET PS-USER-ID-REVOKED-YES TO TRUE               03000000
030100                 PERFORM 7150-CHECK-REVOKE-FLAG                   03010000
030110*  IF THE REVOKE IND = 'N', PUT OUT A FAILED DELETE MSG           03011000
030200                 IF PS-USER-ID-REVOKED-NO                         03020000
030300                    ADD 1  TO PA-TOT-RI-FAILED-DELS               03030000
030400                    SET PS-DELETE-FAILED-YES  TO TRUE             03040000
030500                    DISPLAY '************************************'03050000
030600                    DISPLAY '!!!! RI ERROR TRYING TO DELETE: !!!!'03060000
030700                    DISPLAY 'USR-ID = ' XLT00024-USR-ID           03070000
030800                    DISPLAY '************************************'03080000
030810                 ELSE                                             03081000
030811                    ADD 1  TO PA-TOT-RI-REVOKED-DELS              03081100
030900                 END-IF                                           03090000
031000             WHEN SQLCODE = +100                                  03100000
031100             WHEN SQLCODE = -904                                  03110000
031200             WHEN SQLCODE = -911                                  03120000
031300             WHEN SQLCODE = -913                                  03130000
031400                 CONTINUE                                         03140000
031500                                                                  03150000
031600             WHEN (SQLCODE > ZERO OR SQLWARN0 = 'W')              03160000
031700                 DISPLAY '**************************************' 03170000
031800                 DISPLAY 'WARNING ISSUED ON DELETE OF XLT00024   '03180000
031900                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              03190000
032000                 DISPLAY '**********************************'     03200000
032100                 PERFORM 9800-SQL-WARNING                         03210000
032200                                                                  03220000
032300             WHEN SQLCODE < ZERO                                  03230000
032400                 DISPLAY '**************************************' 03240000
032500                 DISPLAY 'ERROR ISSUED ON DELETE OF XLT00024   '  03250000
032600                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              03260000
032700                 DISPLAY '**************************************' 03270000
032800                 PERFORM 9900-SQL-ERROR                           03280000
032900                                                                  03290000
033000         END-EVALUATE                                             03300000
033100     END-PERFORM                                                  03310000
033200                                                                  03320000
033300     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    03330000
033400         SQLCODE NOT = ZERO                                       03340000
033500         DISPLAY '**************************************'         03350000
033600         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         03360000
033700         DISPLAY 'DELETE TO XLT_USR                     '         03370000
033800         DISPLAY 'ERROR ISSUED ON DELETE OF XLT0024   '           03380000
033900         DISPLAY 'USR-ID = ' XLT00024-USR-ID                      03390000
034000         DISPLAY '**************************************'         03400000
034100         PERFORM 9900-SQL-ERROR                                   03410000
034200     END-IF.                                                      03420000
034300                                                                  03430000
034400****************************************************************  03440000
034500* CHECK THE REVOKE FLAG                                           03450000
034600****************************************************************  03460000
034700 7150-CHECK-REVOKE-FLAG.                                          03470000
034800     MOVE '7150-CHECK-REVOKE-FLAG  '  TO PV-ABEND-PARAGRAPH.      03480000
035700                                                                  03570000
035800     EXEC SQL                                                     03580000
035900         SELECT USR_RVKE_IND                                      03590000
035910         INTO  :XLT00024-USR-RVKE-IND                             03591000
035920         FROM   XLT_USR                                           03592000
036000         WHERE  USR_ID = :XLT00024-USR-ID                         03600000
036200     END-EXEC.                                                    03620000
036300                                                                  03630000
036400     EVALUATE TRUE                                                03640000
036500         WHEN SQLCODE = ZERO                                      03650000
036600             IF XLT00024-USR-RVKE-IND = PC-N                      03660000
036700                SET PS-USER-ID-REVOKED-NO TO TRUE                 03670000
036800             END-IF                                               03680000
038000         WHEN OTHER                                               03800000
038700             DISPLAY '**************************************'     03870000
038800             DISPLAY 'USER ID NOT FOUND FOR REVOKE IND CHECK'     03880000
038900             DISPLAY 'USR-ID = ' XLT00024-USR-ID                  03890000
039000             DISPLAY '**********************************'         03900000
039010             PERFORM 9900-SQL-ERROR                               03901000
039900                                                                  03990000
040000     END-EVALUATE.                                                04000000
040200                                                                  04020000
041400****************************************************************  04140000
041500* UPDATE                                                          04150000
041600****************************************************************  04160000
041700******   IF ANY CHANGE GETS A SQLCODE OF +100 (NOT FOUND)         04170000
041800******   A RETURN CODE OF 4093 IS SET AND INFORMATION IS          04180000
041900******   DISPLAYED TO SYSOUT AND PROGRAM CONTINUES PROCESSING.    04190000
042000****************************************************************  04200000
042100 7200-UPDATE.                                                     04210000
042200     MOVE '7200-UPDATE            '   TO PV-ABEND-PARAGRAPH.      04220000
042300                                                                  04230000
042400     MOVE XL038-U-USR-ID              TO XLT00024-USR-ID.         04240000
042500     MOVE XL038-U-LAST-NM             TO XLT00024-USR-LAST-NM.    04250000
042600     IF XL038-U-FRST-NM < SPACE                                   04260000
042700        MOVE SPACE                    TO XLT00024-USR-FRST-NM     04270000
042800     ELSE                                                         04280000
042900        MOVE XL038-U-FRST-NM          TO XLT00024-USR-FRST-NM     04290000
043000     END-IF.                                                      04300000
043100     IF XL038-U-MID-INIT < SPACE                                  04310000
043200        MOVE SPACE                    TO XLT00024-USR-MID-INIT    04320000
043300     ELSE                                                         04330000
043400        MOVE XL038-U-MID-INIT         TO XLT00024-USR-MID-INIT    04340000
043500     END-IF.                                                      04350000
043600     MOVE XL038-U-RVKE-IND            TO XLT00024-USR-RVKE-IND.   04360000
043700     MOVE XL038-U-DFLT-PRTR-ID        TO XLT00024-DFLT-PRTR-ID.   04370000
043800     MOVE XL038-U-EMP-ID              TO XLT00024-EMP-ID.         04380000
043900                                                                  04390000
044000     PERFORM                                                      04400000
044100         WITH TEST AFTER                                          04410000
044200         VARYING PV-RETRY-COUNTER FROM 1 BY 1                     04420000
044300         UNTIL ((PV-RETRY-COUNTER > PC-MAX-RETRIES) OR            04430000
044400                (SQLCODE = ZERO) OR (SQLCODE = +100))             04440000
044500                                                                  04450000
044600     EXEC SQL                                                     04460000
044700         UPDATE XLT_USR                                           04470000
044800         SET   USR_LAST_NM   = :XLT00024-USR-LAST-NM              04480000
044900              ,USR_FRST_NM   = :XLT00024-USR-FRST-NM              04490000
045000              ,USR_MID_INIT  = :XLT00024-USR-MID-INIT             04500000
045100              ,USR_RVKE_IND  = :XLT00024-USR-RVKE-IND             04510000
045200              ,DFLT_PRTR_ID  = :XLT00024-DFLT-PRTR-ID             04520000
045300              ,EMP_ID        = :XLT00024-EMP-ID                   04530000
045400              ,LAST_UPD_TMST = CURRENT TIMESTAMP                  04540000
045500         WHERE USR_ID        = :XLT00024-USR-ID                   04550000
045600         END-EXEC                                                 04560000
045700                                                                  04570000
045800         EVALUATE TRUE                                            04580000
045900             WHEN SQLCODE = ZERO                                  04590000
046000                 ADD 1                TO PA-TOT-DB2-UPDATES       04600000
046100                                         PA-COMMIT-COUNT          04610000
016400                 IF  PA-COMMIT-COUNT > 19                         04611001
023900                     PERFORM 6000-DB2-COMMIT                      04612001
016400                 END-IF                                           04613001
046300             WHEN SQLCODE = +100                                  04630000
046400                 MOVE 4093 TO RETURN-CODE                         04640000
046500                 SET PS-FOUND-FOR-UPD-NO  TO TRUE                 04650000
046600                 DISPLAY '**************************************' 04660000
046700                 DISPLAY 'WARNING !! USERID NOT FOUND FOR UPDATE '04670000
046800                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              04680000
046900                 DISPLAY '**********************************'     04690000
047000             WHEN SQLCODE = -904                                  04700000
047100             WHEN SQLCODE = -911                                  04710000
047200             WHEN SQLCODE = -913                                  04720000
047300                 CONTINUE                                         04730000
047400                                                                  04740000
047500             WHEN SQLWARN0 = 'W'                                  04750000
047600                 DISPLAY '**************************************' 04760000
047700                 DISPLAY 'WARNING ISSUED ON UPDATE OF XLT00024   '04770000
047800                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              04780000
047900                 DISPLAY '**********************************'     04790000
048000                 PERFORM 9800-SQL-WARNING                         04800000
048100                                                                  04810000
048200             WHEN SQLCODE < ZERO                                  04820000
048300                 DISPLAY '**************************************' 04830000
048400                 DISPLAY 'ERROR ISSUED ON UPDATE OF XLT00024 '    04840000
048500                 DISPLAY 'USR-ID = ' XLT00024-USR-ID              04850000
048600                 DISPLAY '**************************************' 04860000
048700                 PERFORM 9900-SQL-ERROR                           04870000
048800                                                                  04880000
048900         END-EVALUATE                                             04890000
049000     END-PERFORM                                                  04900000
049100                                                                  04910000
049200     IF  PV-RETRY-COUNTER > PC-MAX-RETRIES AND                    04920000
049300         SQLCODE NOT = ZERO                                       04930000
049400         DISPLAY '**************************************'         04940000
049500         DISPLAY 'MAX RETRIES EXCEEDED ATTEMPTING TO    '         04950000
049600         DISPLAY 'UPDATE TO XLT_LOC_TYP_CDE             '         04960000
049700         DISPLAY 'ERROR ISSUED ON UPDATE OF XLT00024  '           04970000
049800         DISPLAY 'USR-ID = ' XLT00024-USR-ID                      04980000
049900         DISPLAY '**************************************'         04990000
050000         DISPLAY '**************************************'         05000000
050100         PERFORM 9900-SQL-ERROR                                   05010000
050200     END-IF.                                                      05020000
050300                                                                  05030000
050400******************************************************************05040000
050500** READ INPUT                                                     05050000
050600******************************************************************05060000
050700 8000-READ-TRANS-FILE.                                            05070000
050800                                                                  05080000
050900     READ XL-TRANS-FILE                                           05090000
051000         INTO XL038-TRANS-REC                                     05100000
051100     AT END                                                       05110000
051200         SET PS-EOF-TRANS             TO TRUE                     05120000
051300     NOT AT END                                                   05130000
051400         ADD 1                        TO PA-TOT-IN-RECS-READ      05140000
051500         EVALUATE TRUE                                            05150000
051600               WHEN XL038-DELETE                                  05160000
051700                    ADD 1 TO PA-TOT-DEL-RECS-READ                 05170000
051800                                                                  05180000
051900               WHEN XL038-MODIFY                                  05190000
052000                    ADD 1 TO PA-TOT-MOD-RECS-READ                 05200000
052100                                                                  05210000
052200               WHEN XL038-ADD                                     05220000
052300                    ADD 1 TO PA-TOT-ADD-RECS-READ                 05230000
052400                                                                  05240000
052500         END-EVALUATE                                             05250000
052600     END-READ.                                                    05260000
052700                                                                  05270000
052800******************************************************************05280000
052900** END OF JOB ROUTINE                                             05290000
053000******************************************************************05300000
053100 9000-EOJ.                                                        05310000
053200                                                                  05320000
053300*CLOSE OUTPUT FILE                                                05330000
053400     CLOSE XL-TRANS-FILE                                          05340000
053500                                                                  05350000
053600*SET RET CODE TO KICK OFF EMAIL NOTIFICATION TO XL GROUP          05360000
053700     IF PS-DELETE-FAILED-YES                                      05370000
053800        MOVE 4092 TO RETURN-CODE                                  05380000
053900     END-IF.                                                      05390000
054000                                                                  05400000
054100     IF PS-FOUND-FOR-UPD-NO                                       05410000
054200        MOVE 4093 TO RETURN-CODE                                  05420000
054300     END-IF.                                                      05430000
054400                                                                  05440000
054500*DISPLAY SUMMARY STATISTICS                                       05450000
054600     DISPLAY ' '.                                                 05460000
054700     DISPLAY '*************************************'.             05470000
054800     DISPLAY '**      XLKUP030 SUMMARY STATS     **'.             05480000
054900     DISPLAY '*************************************'.             05490000
055000     DISPLAY ' '.                                                 05500000
055100     DISPLAY 'TOTAL INPUT ADD RECS READ : ' PA-TOT-ADD-RECS-READ. 05510000
055200     DISPLAY 'TOTAL INPUT MOD RECS READ : ' PA-TOT-MOD-RECS-READ. 05520000
055300     DISPLAY 'TOTAL INPUT DEL RECS READ : ' PA-TOT-DEL-RECS-READ. 05530000
055400     DISPLAY '-------------------------------------'.             05540000
055500     DISPLAY 'TOTAL INPUT RECS READ     : ' PA-TOT-IN-RECS-READ.  05550000
055600     DISPLAY ' '.                                                 05560000
055700     DISPLAY 'TOTAL INSERTS             : ' PA-TOT-DB2-INSERTS.   05570000
055800     DISPLAY 'TOTAL UPDATES             : ' PA-TOT-DB2-UPDATES.   05580000
055900     DISPLAY 'TOTAL DELETES             : ' PA-TOT-DB2-DELETES.   05590000
056000     DISPLAY 'TOTAL DELETES FAILED  - RI: ' PA-TOT-RI-FAILED-DELS.05600000
056010     DISPLAY 'TOTAL DELETES REVOKED - RI: ' PA-TOT-RI-REVOKED-DELS05601000
056010     DISPLAY 'TOTAL COMMITS TAKEN       : ' PA-TOT-COMMITS-TAKEN. 05602005
056100     DISPLAY '-------------------------------------'.             05610000
056200     DISPLAY ' '.                                                 05620000
056300     DISPLAY '*************************************'.             05630000
056400                                                                  05640000
056500******************************************************************05650000
056600** SQL WARNING                                                    05660000
056700******************************************************************05670000
056800 9800-SQL-WARNING.                                                05680000
056900                                                                  05690000
057000      MOVE SQLCODE               TO SQLCODE2.                     05700000
057100      MOVE SQLERRD(3)            TO SQLERRD3.                     05710000
057200      DISPLAY '** ABEND **       ** = SQLWARNING'.                05720000
057300      DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.          05730000
057400      DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.       05740000
057500      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 05750000
057600      DISPLAY '** SQLWARN0       ** = ' SQLWARN0.                 05760000
057700      DISPLAY '** SQLWARN1       ** = ' SQLWARN1.                 05770000
057800      DISPLAY '** SQLWARN2       ** = ' SQLWARN2.                 05780000
057900      DISPLAY '** SQLWARN3       ** = ' SQLWARN3.                 05790000
058000      DISPLAY '** SQLWARN4       ** = ' SQLWARN4.                 05800000
058100      DISPLAY '** SQLWARN5       ** = ' SQLWARN5.                 05810000
058200      DISPLAY '** SQLWARN6       ** = ' SQLWARN6.                 05820000
058300      DISPLAY '** SQLWARN7       ** = ' SQLWARN7.                 05830000
058400                                                                  05840000
058500      MOVE 4013                  TO PV-ABEND-CODE                 05850000
058600      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        05860000
058700                                                                  05870000
058800 9900-SQL-ERROR.                                                  05880000
058900                                                                  05890000
059000      MOVE SQLCODE               TO SQLCODE2.                     05900000
059100      MOVE SQLERRD(3)            TO SQLERRD3.                     05910000
059200      DISPLAY '** ABEND **       ** = SQLERROR'.                  05920000
059300      DISPLAY '** PROGRAM        ** = ' PC-PROGRAM-NAME.          05930000
059400      DISPLAY '** PARAGRAPH      ** = ' PV-ABEND-PARAGRAPH.       05940000
059500      DISPLAY '** SQLCODE        ** = ' SQLCODE2.                 05950000
059600      DISPLAY '** SQLERRM        ** = ' SQLERRM.                  05960000
059700      DISPLAY '** SQLERRMC       ** = ' SQLERRMC.                 05970000
059800                                                                  05980000
059900      MOVE 4013                  TO PV-ABEND-CODE                 05990000
060000      CALL 'ILBOABN0' USING PV-ABEND-CODE.                        06000000
