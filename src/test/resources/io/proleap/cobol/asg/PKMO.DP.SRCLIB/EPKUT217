000100*------------------------------------------------------------     00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300*------------------------------------------------------------     00030000
000400 PROGRAM-ID.    EPKUT217.                                         00040000
000500 AUTHOR.        MEDHA CHOUDHURY.                                  00050003
000510 INSTALLATION.  KOHLS DEPARTMENT STORES.                          00051003
000600 DATE-WRITTEN.  JAN 17, 2009.                                     00060003
000700                                                                  00070000
000710*-------------------------------------------------------------*   00071003
000720*    UPC/SKU XREF  FORMATTER                                  *   00072003
000730*-------------------------------------------------------------*   00073003
001020*    THIS PROGRAM WILL FORMAT THE UPC/SKU CROSS REFERENCE     *   00102003
001030*    DATA FILE FOR THE SQL SERVER STORE DATABASE TABLE,       *   00103003
001040*    AND ADD DISTRIBUTION HEADER RECORDS, AS APPROPRIATE.     *   00104003
001041*    POS 2009 FALL - PRICING INFRASTRUCTURE PROJECT WR# 35484 *   00104103
001050*                                                             *   00105003
001060*------------------------------------------------------------ *   00106003
003800*  INPUT:                                                     *   00380003
003900*        UPC-SKU-XREF-FILE                EPRD218             *   00390003
004000*        CC-TODAYS-DATE                   EPCC140             *   00400024
004100*        CC-TIME                          EPCC130             *   00410030
004400*                                                             *   00440003
004500*  OUTPUT:                                                    *   00450003
004600*        FORMATTED-XREF-FILE              EPRD217             *   00460003
004700*                                (FOR HEADER FORMAT)          *   00470003
004800*-------------------------------------------------------------*   00480003
004900* HISTORY LOG:                                                *   00490003
005000*                                                             *   00500003
005100*-------------------------------------------------------------*   00510003
005200* DATE: JAN 17 2009                                           *   00520023
005300* WR/IR#: WR #35484                                           *   00530023
005400* PROGRAMMER: MEDHA CHOUDHURY                                 *   00540023
005500* DESCRIPTION: INITIAL PROGRAM CREATION                       *   00550023
005600*-------------------------------------------------------------*   00560023
005610* DATE:                                                       *   00561023
005620* WR/IR#:                                                     *   00562023
005630* PROGRAMMER:                                                 *   00563023
005640* DESCRIPTION:                                                *   00564023
005650*                                                             *   00565023
005700*-------------------------------------------------------------*   00570003
005800 ENVIRONMENT DIVISION.                                            00580003
005900*-------------------------------------------------------------*   00590003
006000 CONFIGURATION SECTION.                                           00600003
006100 SOURCE-COMPUTER. IBM-3090.                                       00610003
006200 OBJECT-COMPUTER. IBM-3090.                                       00620003
006300                                                                  00630003
006400 INPUT-OUTPUT SECTION.                                            00640003
006500                                                                  00650003
006600 FILE-CONTROL.                                                    00660003
006700                                                                  00670003
006800*  INPUT:                                                     *   00680003
006900           SELECT UPC-SKU-XREF-FILE                               00690003
007000             ASSIGN TO INP01.                                     00700003
008300                                                                  00830003
008310           SELECT CC-TODAYS-DATE                                  00831024
008320             ASSIGN TO INP02.                                     00832024
008330                                                                  00833024
008340           SELECT CC-TIME                                         00834029
008350             ASSIGN TO INP03.                                     00835029
008360                                                                  00836029
008400*  OUTPUT:                                                    *   00840003
008500           SELECT FORMATTED-XREF-FILE                             00850003
008600             ASSIGN TO OUT01.                                     00860003
008700                                                                  00870003
008800*-------------------------------------------------------------*   00880003
008900 DATA DIVISION.                                                   00890003
009000*----------------------------------------------------------       00900003
009100 FILE SECTION.                                                    00910003
009200                                                                  00920003
009300 FD  UPC-SKU-XREF-FILE                                            00930003
009400     RECORDING MODE IS F                                          00940003
009500     LABEL RECORDS ARE STANDARD                                   00950003
009600     RECORD CONTAINS 80 CHARACTERS                                00960011
009700     BLOCK CONTAINS 0 RECORDS                                     00970003
009800     DATA RECORD IS UPC-SKU-XREF-RECORD.                          00980003
009900                                                                  00990003
010000 01  UPC-SKU-XREF-RECORD          PIC X(80).                      01000011
010100                                                                  01010003
010200 FD  CC-TODAYS-DATE                                               01020024
010300     RECORDING MODE IS F                                          01030024
010400     BLOCK CONTAINS 0 RECORDS                                     01040024
010500     LABEL RECORDS ARE STANDARD.                                  01050024
010600                                                                  01060024
010700 01  CC-TODAYS-DATE-RECORD        PIC X(80).                      01070024
010800                                                                  01080024
010900 FD  CC-TIME                                                      01090029
011000     RECORDING MODE IS F                                          01100029
011100     BLOCK CONTAINS 0 RECORDS                                     01110029
011200     LABEL RECORDS ARE STANDARD.                                  01120029
011300                                                                  01130029
011400 01  CC-TIME-RECORD  PIC X(80).                                   01140029
011500                                                                  01150029
013800 FD  FORMATTED-XREF-FILE                                          01380003
013900     RECORDING MODE IS V                                          01390003
014000     RECORD IS VARYING IN SIZE                                    01400003
014100     FROM 1 TO 100 CHARACTERS                                     01410003
014200     DEPENDING ON PV-BYTE-COUNT                                   01420003
014300     LABEL RECORDS ARE STANDARD                                   01430003
014400     DATA RECORD IS FORMATTED-XREF-RECORD.                        01440003
014500                                                                  01450003
014600 01  FORMATTED-XREF-RECORD.                                       01460003
014700     05  FORM-XRF-FLD             PIC X(01)                       01470024
014800         OCCURS 100 TIMES                                         01480003
014900              INDEXED BY                                          01490003
015000              FORM-XRF-LEN.                                       01500003
015100                                                                  01510003
015200*----------------------------------------------------------       01520003
015300 WORKING-STORAGE SECTION.                                         01530003
015400                                                                  01540003
015500 01  AC-ABEND-CODE                     PIC S9(04) VALUE ZERO      01550003
015600                                                  COMP SYNC.      01560003
015700     88  AC-INPUT-CONTROL-CARD-ERROR              VALUE +4003.    01570003
016100                                                                  01610003
016200*----------------------------------------------------------       01620003
016300* PC- PROGRAM CONSTANTS                                           01630003
016400*----------------------------------------------------------       01640003
016500 01  PC-PROGRAM-CONSTANTS.                                        01650003
016600     05  PC-PROGRAM-NAME              PIC X(08) VALUE 'EPKUT217'. 01660003
016900     05  PC-CSV-DELIMITER             PIC X(01) VALUE '|'.        01690003
017100     05  PC-UNDER-SCORE               PIC X(01) VALUE '_'.        01710003
017400     05  PC-ONE-ZERO                  PIC X(01) VALUE '0'.        01740003
017700     05  PC-STORE-SPECIFIC-GRP        PIC X(05) VALUE '05000'.    01770003
017800     05  PC-FIVE-ZERO                 PIC X(05) VALUE '00000'.    01780003
017900     05  PC-HDR-IND                   PIC X(03) VALUE 'HDR'.      01790003
018100                                                                  01810003
018110*----------------------------------------------------------       01811029
018120* TIME                                                            01812029
018130*----------------------------------------------------------       01813029
018140 01  PC-TIME.                                                     01814029
018150     05  PC-TIME-HHMM                 PIC X(04).                  01815029
018160     05  PC-TIME-SS                   PIC X(02).                  01816029
018200*----------------------------------------------------------       01820003
018300* PV- PROGRAM VARIABLES                                           01830003
018400*----------------------------------------------------------       01840003
018500 01  PV-PROGRAM-STATUS.                                           01850003
018600     05  PV-PARAGRAPH-NAME            PIC X(30) VALUE SPACES.     01860003
018700     05  PV-OPERATION-MSG-1           PIC X(40) VALUE SPACES.     01870003
018800     05  PV-OPERATION-MSG-2           PIC X(40) VALUE SPACES.     01880003
019100*                                                                 01910003
019200 01  PV-PROGRAM-VARIABLES.                                        01920003
019300     05  PV-TALLY                     PIC S9(03) COMP-3 VALUE +0. 01930003
019400     05  PV-BYTE-COUNT                PIC  9(04) VALUE ZERO.      01940003
019900                                                                  01990003
020000     05  PV-VARIABLE-OUTPUT-FIELD.                                02000003
020100         10  PV-BIT-VARIABLE          PIC X(01)                   02010003
020200                                          VALUE SPACES            02020003
020300                                          OCCURS 15 TIMES         02030004
020400                                          INDEXED BY              02040003
020500                                          PV-BIT-IDX              02050003
020600                                          PV-STR-IDX              02060003
020700                                          PV-EOF-IDX.             02070003
022500                                                                  02250003
025010     05  PV-HEADER-TMST.                                          02501030
025020         10  PV-HDR-BATCH-DT          PIC X(08).                  02502030
025030         10  PV-HDR-BATCH-TIME        PIC X(06).                  02503037
025040                                                                  02504030
025100     05  PV-FORMAT-HDR-DIST-DTE.                                  02510003
025200         10  PV-FORMAT-YYYY           PIC X(04).                  02520003
025300         10  PV-FORMAT-MM             PIC X(02).                  02530003
025400         10  PV-FORMAT-DD             PIC X(02).                  02540003
025500                                                                  02550003
026000     05  PV-EFF-WORK-DTE.                                         02600003
026100         10  PV-EFF-WORK-YYYY         PIC X(04).                  02610003
026200         10  PV-EFF-WORK-MM           PIC X(02).                  02620003
026300         10  PV-EFF-WORK-DD           PIC X(02).                  02630003
026400                                                                  02640003
026500     05  PV-PLU-FILE-DIST-DTE.                                    02650027
026600         10  PV-FILE-D-YYYY           PIC X(04).                  02660027
026700         10  PV-FILE-D-DASH-1         PIC X(01) VALUE '-'.        02670027
026800         10  PV-FILE-D-MM             PIC X(02).                  02680027
026900         10  PV-FILE-D-DASH-2         PIC X(01) VALUE '-'.        02690027
027000         10  PV-FILE-D-DD             PIC X(02).                  02700027
027300                                                                  02730003
027310     05  PV-STR-GRP-TYP-CDE           PIC 9(05) VALUE ZERO.       02731004
027320     05  PV-STR-GRP-ID-GRP.                                       02732007
027321         10  PV-FIRST-BYTES           PIC 9(05) VALUE ZERO.       02732114
027330         10  PV-STR-GRP-ID            PIC 9(05) VALUE ZERO.       02733004
027340     05  PV-FILE-TYPE                 PIC X(03) VALUE SPACES.     02734020
027341     05  PV-PRICG-EFFECT-DTE          PIC  X(10) VALUE SPACES.    02734120
027700                                                                  02770003
027710 01  PV-TIME-CALC                     PIC 9(06).                  02771029
027720                                                                  02772034
027730 01  PV-TIME.                                                     02773029
027740     05  PV-TIME-HH                   PIC 9(02).                  02774029
027750     05  PV-TIME-MM                   PIC 9(02).                  02775029
027760     05  PV-TIME-SS                   PIC 9(02).                  02776029
027770                                                                  02777029
028000*----------------------------------------------------------       02800003
028100* PV- PROGRAM COUNT VARIABLES                                     02810003
028200*----------------------------------------------------------       02820003
028300 01  PV-PROGRAM-COUNTERS.                                         02830003
028400     05  PV-DATA-REC-WRITEN           PIC 9(09) VALUE 0.          02840004
028410     05  PV-HDR-REC-WRITEN            PIC 9(09) VALUE 0.          02841004
028500     05  PV-RECORDS-READ              PIC 9(09) VALUE 0.          02850004
029100                                                                  02910003
031300*----------------------------------------------------------------*03130003
031400* PS- PROGRAM SWITCHES                                           *03140003
031500*----------------------------------------------------------------*03150003
031600 01  PS-PROGRAM-SWITCHES.                                         03160003
031700     05  PS-END-OF-XRF-SW             PIC  X(01) VALUE 'N'.       03170003
031800         88  PS-END-OF-XRF-FILE                  VALUE 'Y'.       03180006
031900         88  PS-NOT-END-XRF-FILE                 VALUE 'N'.       03190003
033200     05  PS-END-OF-PROCES-SW          PIC  X(01) VALUE 'N'.       03320003
033300         88  PS-END-OF-PROCESSING                VALUE 'Y'.       03330003
033400         88  PS-NOT-END-OF-PROCESSING            VALUE 'N'.       03340003
033500     05  PS-READY-TRACE-SW            PIC  X(01) VALUE 'N'.       03350003
033600         88 PS-READY-TRACE                       VALUE 'Y'.       03360003
033700         88 PS-RESET-TRACE                       VALUE 'N'.       03370003
033710     05  PS-END-OF-TODAYS-DATE-SW     PIC X(01)  VALUE 'N'.       03371025
033720         88  PS-END-OF-TODAYS-DATE-FILE          VALUE 'Y'.       03372025
033730     05  PS-END-OF-TOMORR-DATE-SW     PIC X(01)  VALUE 'N'.       03373025
033740         88  PS-END-OF-TOMORR-DATE-FILE          VALUE 'Y'.       03374025
033750     05  PS-END-OF-TIME-SW            PIC X(01)  VALUE 'N'.       03375033
033760         88  PS-END-OF-TIME-FILE                 VALUE 'Y'.       03376033
033800                                                                  03380003
037400*----------------------------------------------------------       03740003
037500* COPYBOOK  EPRD217 LAYOUT (USED TO WRITE THE HEADER RECORD)      03750020
037600*----------------------------------------------------------       03760003
037700     COPY EPRD217.                                                03770003
037800                                                                  03780003
037900*----------------------------------------------------------       03790003
038000* COPYBOOK  EPRD218 LAYOUT (USED TO READ THE INPUT FILE)          03800020
038100*----------------------------------------------------------       03810003
038200     COPY EPRD218.                                                03820003
038300                                                                  03830003
038400*----------------------------------------------------------       03840024
038500* TODAYS DATE - BASED ON DAY THE JOB WAS SCHEDULED TO RUN         03850024
038600*----------------------------------------------------------       03860024
038700     COPY EPWS140.                                                03870024
038800                                                                  03880024
038900*----------------------------------------------------------       03890030
039000* CC-TIME - COPYBOOK USED TO READ THE TIME CONTROL CARD           03900030
039100*----------------------------------------------------------       03910030
039200     COPY EPRD130.                                                03920030
039300                                                                  03930030
042200*----------------------------------------------------------       04220003
042300 PROCEDURE DIVISION.                                              04230003
042400*----------------------------------------------------------       04240003
042500 0000-MAINLINE.                                                   04250003
042600                                                                  04260003
042700     PERFORM 1000-INITIALIZATION.                                 04270003
042800                                                                  04280003
042900     PERFORM 2000-PROCESS-XREF                                    04290003
043000             UNTIL PS-END-OF-PROCESSING.                          04300003
043100                                                                  04310003
043200     PERFORM 9200-WRAPUP.                                         04320003
043300                                                                  04330003
043400     GOBACK.                                                      04340003
043500                                                                  04350003
043600*0000-EXIT.                                                       04360003
043800                                                                  04380003
043900*----------------------------------------------------------       04390003
044000* 1000-INITIALIZATION.                                            04400003
044100*     INITIALIZES VARIABLES, OPENS ANY FILES, AND READS           04410003
044200*     THE INPUT FILES, SAVES VARIABLES, AND CLOSES THE INPUT      04420003
044300*     FILES.                                                      04430003
044400*----------------------------------------------------------       04440003
044500 1000-INITIALIZATION.                                             04450003
044600                                                                  04460003
044700     DISPLAY '****************************************'.          04470003
044800     DISPLAY '**          EPKUT217 STARTED          **'.          04480003
044900     DISPLAY '****************************************'.          04490003
045000                                                                  04500003
045100     INITIALIZE PV-PROGRAM-VARIABLES.                             04510003
045200                                                                  04520003
045700     SET PS-NOT-END-XRF-FILE      TO TRUE.                        04570003
046200                                                                  04620003
046300     PERFORM 1100-OPEN-FILES.                                     04630003
046400                                                                  04640003
046610     PERFORM 1300-READ-TODAYS-DATE.                               04661024
046620                                                                  04662024
046630     PERFORM 1400-READ-TIME-CC.                                   04663029
046640                                                                  04664029
046700     PERFORM 6000-READ-XREF-FILE.                                 04670003
046800                                                                  04680003
047800     IF PS-END-OF-XRF-FILE                                        04780007
047900        DISPLAY '***    XREF EXTRACT FILE IS EMPTY    ****'       04790003
047910        SET PS-END-OF-PROCESSING TO TRUE                          04791004
048200     END-IF.                                                      04820003
048300                                                                  04830003
050900                                                                  05090003
051000*1000-EXIT.                                                       05100003
051200                                                                  05120003
051300*----------------------------------------------------------       05130003
051400* 1100-OPEN-FILES.                                                05140003
051500*     THIS PARAGRAPH OPENS ALL THE FILES IN MODE REQUIRED         05150003
051600*----------------------------------------------------------       05160003
051700 1100-OPEN-FILES.                                                 05170003
051800                                                                  05180003
051900     OPEN INPUT UPC-SKU-XREF-FILE                                 05190024
052000                 CC-TIME                                          05200029
052100                 CC-TODAYS-DATE.                                  05210029
052500                                                                  05250003
052600     OPEN OUTPUT FORMATTED-XREF-FILE.                             05260003
052700                                                                  05270003
052800*1100-EXIT.                                                       05280003
053000                                                                  05300003
063100*                                                                 06310031
063101*----------------------------------------------------------       06310124
063102* 1300-READ-TODAYS-DATE.                                          06310224
063103*     THIS PARAGRAPH GETS THE DB2 TIMESTAMP WHICH WILL BE         06310324
063104*     USED TO UPDATE THE CRT-TIMESTAMP ON THE HEADER RECORD       06310424
063105*----------------------------------------------------------       06310524
063106 1300-READ-TODAYS-DATE.                                           06310624
063108                                                                  06310824
063109     READ CC-TODAYS-DATE INTO CC-EPCC140-CONTROL-CARD             06310924
063110         AT END                                                   06311024
063111             SET PS-END-OF-TODAYS-DATE-FILE TO TRUE.              06311124
063112                                                                  06311224
063113     DISPLAY '    '                                               06311325
063114     DISPLAY '   TODAYS DATE CONTROL CARD   '.                    06311425
063115     DISPLAY CC-EPCC140-CONTROL-CARD-DISPLY.                      06311525
063116     DISPLAY '  '.                                                06311625
063117                                                                  06311725
063118     IF PS-END-OF-TODAYS-DATE-FILE                                06311824
063119         MOVE '1300-READ-TODAYS-DATE'  TO PV-PARAGRAPH-NAME       06311925
063120         MOVE 'EMPTY TODAYS DATE CC '   TO PV-OPERATION-MSG-1     06312024
063121         SET AC-INPUT-CONTROL-CARD-ERROR TO TRUE                  06312125
063122         PERFORM 9910-ABEND                                       06312225
063123     END-IF.                                                      06312324
063124                                                                  06312424
063125*                                                                 06312524
063126*-- CONVERT FORMAT OF DATE FROM CCYY-MM-DD TO CCYYMMDD            06312624
063127*                                                                 06312724
063128     MOVE CC-EPCC140-TODAY-DATE  TO PV-PLU-FILE-DIST-DTE.         06312827
063129                                                                  06312924
063130     MOVE PV-FILE-D-YYYY       TO PV-FORMAT-YYYY.                 06313027
063131     MOVE PV-FILE-D-MM         TO PV-FORMAT-MM.                   06313127
063132     MOVE PV-FILE-D-DD         TO PV-FORMAT-DD.                   06313227
063133                                                                  06313324
063134*1300-EXIT.                                                       06313424
063140                                                                  06314024
063141******************************************************************06314129
063142* 1400-READ-TIME-CC                                               06314229
063143******************************************************************06314329
063144                                                                  06314429
063145 1400-READ-TIME-CC.                                               06314529
063146                                                                  06314629
063147     READ CC-TIME INTO EP130-CC-CONTROL-CARD                      06314729
063148         AT END                                                   06314829
063149             SET PS-END-OF-TIME-FILE TO TRUE.                     06314929
063150                                                                  06315029
063151     DISPLAY '----------------------------------------'.          06315136
063152     DISPLAY EP130-CC-CONTROL-CARD-DISPLY.                        06315236
063153     DISPLAY '----------------------------------------'.          06315336
063154                                                                  06315436
063155     IF PS-END-OF-TIME-FILE                                       06315529
063156         MOVE '1400-READ-TIME-CC    '  TO PV-PARAGRAPH-NAME       06315629
063157         MOVE 'EMPTY TIME CC        '   TO PV-OPERATION-MSG-1     06315729
063158         SET AC-INPUT-CONTROL-CARD-ERROR TO TRUE                  06315829
063159         PERFORM 9910-ABEND                                       06315929
063160     ELSE                                                         06316029
063161         MOVE EP130-CC-FIRST-HEADER-TIME TO PC-TIME               06316129
063162                                            PV-TIME-CALC          06316229
063163     END-IF.                                                      06316329
063164                                                                  06316429
063165                                                                  06316529
063166     CLOSE CC-TIME.                                               06316629
063167                                                                  06316729
063168*1400-EXIT.                                                       06316829
063170                                                                  06317029
063200*----------------------------------------------------------       06320003
063300* 2000-PROCESS-XREF.                                              06330019
063400* ----------------------------                                    06340003
063500* THE PARAGRAPH WILL PERFORM THE FOLLOWING                        06350004
063800*                                                                 06380003
063900* (1) CREATE HEADER RECORD IF THE PREVIOUS STORE INFORMATION IS   06390004
064000*     DIFFERENT FROM THE CURRENT.                                 06400004
064200*                                                                 06420003
064300* (2) FORMAT THE DATA RECORD                                      06430004
065800*                                                                 06580003
065900*----------------------------------------------------------       06590003
066000 2000-PROCESS-XREF.                                               06600004
066100                                                                  06610003
066110**-- FORMAT HEADER RECORD                                         06611004
066111                                                                  06611127
066120     PERFORM 2050-CHECK-IF-HEADERS-NEEDED.                        06612027
066130                                                                  06613027
066700**-- INITIALIZE VARIABLES FOR DETAIL RECORD                       06670004
066710                                                                  06671004
066711     SET FORM-XRF-LEN TO +1.                                      06671104
066712     MOVE 0 TO PV-BYTE-COUNT.                                     06671204
066713     INITIALIZE FORMATTED-XREF-RECORD.                            06671304
066714                                                                  06671404
066720**-- FORMAT DETAIL RECORD                                         06672004
067000                                                                  06700004
067010     PERFORM 2500-MOVE-DELIMITER.                                 06701004
067100     PERFORM 2300-MOVE-TRIGGER-TYPE.                              06710004
067110                                                                  06711004
067200     INITIALIZE PV-VARIABLE-OUTPUT-FIELD.                         06720004
067300     INITIALIZE PV-TALLY.                                         06730004
070100                                                                  07010003
070101**-- FORMAT UPC-NBR                                               07010104
070102     EVALUATE TRUE                                                07010220
070103        WHEN EP218-UPC-NBR = 0                                    07010320
070104            PERFORM 2700-MOVE-ZERO                                07010420
070105        WHEN OTHER                                                07010520
070110            INSPECT EP218-UPC-NBR             TALLYING PV-TALLY   07011020
070120                FOR LEADING ZEROES                                07012020
070130            SET PV-BIT-IDX TO PV-TALLY                            07013020
070140            SET PV-BIT-IDX UP BY +1                               07014020
070150                                                                  07015020
070160            MOVE EP218-UPC-NBR      TO PV-VARIABLE-OUTPUT-FIELD   07016020
070170                                                                  07017020
070180            PERFORM 2400-FIELD-MOVER  VARYING PV-EOF-IDX          07018020
070190               FROM PV-BIT-IDX  BY 1                              07019020
070191               UNTIL PV-EOF-IDX > 15                              07019120
070192     END-EVALUATE.                                                07019220
070193                                                                  07019304
070194     PERFORM 2500-MOVE-DELIMITER.                                 07019404
070195                                                                  07019504
070196     INITIALIZE PV-VARIABLE-OUTPUT-FIELD.                         07019604
070197     INITIALIZE PV-TALLY.                                         07019704
070198                                                                  07019804
070199**-- FORMAT SKU-NBR                                               07019904
070200     EVALUATE TRUE                                                07020020
070201        WHEN EP218-SKU-NBR = 0                                    07020120
070202            PERFORM 2700-MOVE-ZERO                                07020220
070203        WHEN OTHER                                                07020320
070204            INSPECT EP218-SKU-NBR             TALLYING PV-TALLY   07020420
070205                FOR LEADING ZEROES                                07020520
070206            SET PV-BIT-IDX TO PV-TALLY                            07020620
070207            SET PV-BIT-IDX UP BY +1                               07020720
070208                                                                  07020820
070209            MOVE EP218-SKU-NBR      TO PV-VARIABLE-OUTPUT-FIELD   07020920
070210                                                                  07021020
070211            PERFORM 2400-FIELD-MOVER  VARYING PV-EOF-IDX          07021120
070212               FROM PV-BIT-IDX  BY 1                              07021220
070213               UNTIL PV-EOF-IDX > 8                               07021320
070214     END-EVALUATE.                                                07021420
070215                                                                  07021504
070216     PERFORM 2500-MOVE-DELIMITER.                                 07021604
070217                                                                  07021704
070218     PERFORM 2600-WRITE-DATA-RECORD.                              07021804
070219                                                                  07021904
070220     PERFORM 6000-READ-XREF-FILE.                                 07022004
070221                                                                  07022104
070222     IF PS-END-OF-XRF-FILE                                        07022207
070223        SET PS-END-OF-PROCESSING TO TRUE                          07022304
070224     END-IF.                                                      07022404
070225                                                                  07022504
070230*2000-EXIT.                                                       07023003
094500                                                                  09450003
094501******************************************************************09450127
094502* 2050-CHECK-IF-HEADERS-NEEDED.                                   09450227
094503*     DETERMINE IF A HEADER RECORD NEED TO BE WRITTEN TO OUTPUT   09450327
094504*     FILE                                                        09450427
094505******************************************************************09450527
094507 2050-CHECK-IF-HEADERS-NEEDED.                                    09450728
094508                                                                  09450828
094509     IF EP218-STR-GRP-TYP-CDE NOT = PV-STR-GRP-TYP-CDE            09450927
094510      OR EP218-STR-GRP-ID NOT = PV-STR-GRP-ID-GRP                 09451027
094511      OR EP218-FILE-ACT-TYP  NOT = PV-FILE-TYPE                   09451127
094513        PERFORM 2100-FORMAT-AND-WRITE-HDR                         09451327
094514     END-IF.                                                      09451427
094515                                                                  09451527
094516*2050-EXIT.                                                       09451627
094530                                                                  09453027
094600*-----------------------------------------------------------------09460003
094700* 2100-FORMAT-AND-WRITE-HDR                                       09470004
094800*  THIS PARAGRAPH MOVES APPROPRIATE VALUES TO THE EPRD200 COPYBOOK09480003
094900*  LAYOUT (BEFORE WRITING OUT THE HEADER RECORD)                  09490003
095000*----------------------------------------------------------------*09500003
095100 2100-FORMAT-AND-WRITE-HDR.                                       09510004
095200                                                                  09520003
095210     MOVE EP218-STR-GRP-TYP-CDE  TO PV-STR-GRP-TYP-CDE.           09521004
095220     MOVE EP218-STR-GRP-ID       TO PV-STR-GRP-ID-GRP.            09522008
095221     MOVE EP218-FILE-ACT-TYP     TO PV-FILE-TYPE.                 09522120
095222     MOVE EP218-XREF-EFFECT-DTE  TO PV-PRICG-EFFECT-DTE.          09522238
095230                                                                  09523004
095300     MOVE PC-HDR-IND             TO EP217-HDR-INDICATOR.          09530004
095400     MOVE EP218-STR-GRP-TYP-CDE  TO EP217-STR-GRP-TYP.            09540004
095410     MOVE EP218-STR-GRP-ID       TO EP217-STR-GRP-ID.             09541004
095700     MOVE PC-FIVE-ZERO           TO EP217-EXCO-STR-NBR.           09570004
095800     MOVE PV-FORMAT-HDR-DIST-DTE TO EP217-FILE-DIST-DATE.         09580004
095900     SET EP217-FILE-PRICING      TO TRUE.                         09590004
096000     MOVE PC-UNDER-SCORE         TO EP217-UNDERSCORE-1.           09600004
096010     SET EP217-XST-XREF          TO TRUE.                         09601015
096100     MOVE PC-UNDER-SCORE         TO EP217-UNDERSCORE-2.           09610004
096200     MOVE PC-UNDER-SCORE         TO EP217-UNDERSCORE-3.           09620004
096300     MOVE PC-UNDER-SCORE         TO EP217-UNDERSCORE-4.           09630004
096400     MOVE PC-UNDER-SCORE         TO EP217-UNDERSCORE-5.           09640004
096500     MOVE EP218-FILE-ACT-TYP     TO EP217-FILE-NAME-TYPE.         09650004
096501                                                                  09650104
096510     IF EP218-STR-GRP-TYP-CDE = PC-STORE-SPECIFIC-GRP             09651004
096520         MOVE PV-STR-GRP-ID          TO EP217-STORE-NBR           09652007
096530     ELSE                                                         09653004
096600         MOVE PC-FIVE-ZERO           TO EP217-STORE-NBR           09660004
096610     END-IF.                                                      09661004
096620                                                                  09662004
096630     MOVE PV-FORMAT-HDR-DIST-DTE TO PV-HDR-BATCH-DT.              09663030
096640     MOVE PV-TIME-CALC           TO PV-HDR-BATCH-TIME.            09664035
096650                                                                  09665030
096700     MOVE PV-HEADER-TMST         TO EP217-CRT-TIMESTAMP.          09670004
096800     MOVE EP218-APPLY-IND        TO EP217-FILE-TYPE-APPLY.        09680017
096900                                                                  09690003
097000     PERFORM 2200-WRITE-HDR-RECORD.                               09700004
097100                                                                  09710003
097200*2100-EXIT.                                                       09720004
097400                                                                  09740003
097500*-----------------------------------------------------------------09750003
097600* 2200-WRITE-HDR-RECORD                                           09760004
097700*  THIS PARAGRAPH WILL WRITE THE HEADER RECORD TO THE O/P FILE    09770003
097800*-----------------------------------------------------------------09780003
097900 2200-WRITE-HDR-RECORD.                                           09790004
098000                                                                  09800003
098110     PERFORM 5100-CALC-TIME.                                      09811030
098200                                                                  09820003
098300     MOVE 64                                                      09830003
098400       TO PV-BYTE-COUNT.                                          09840003
098500     WRITE FORMATTED-XREF-RECORD                                  09850004
098600       FROM EP217-HEADER-RECORD.                                  09860004
098700                                                                  09870003
098710     ADD 1 TO PV-HDR-REC-WRITEN.                                  09871004
098720                                                                  09872004
098800*2200-EXIT.                                                       09880004
099000                                                                  09900003
099010*-----------------------------------------------------------------09901004
099020* 2300-MOVE-TRIGGER-TYPE                                          09902004
099030*  THIS PARAGRAPH WILL MOVE TRIGGER TYPE TO OUTPUT FILE VARIABLE  09903004
099040*----------------------------------------------------------------*09904004
099050 2300-MOVE-TRIGGER-TYPE.                                          09905004
099060                                                                  09906004
099070     MOVE EP218-RECORD-ACTION                                     09907004
099080       TO FORM-XRF-FLD(FORM-XRF-LEN).                             09908004
099090     SET FORM-XRF-LEN                                             09909004
099091       UP BY +1.                                                  09909104
099092     ADD 1                                                        09909204
099093       TO PV-BYTE-COUNT.                                          09909304
099094     PERFORM 2500-MOVE-DELIMITER.                                 09909406
099095                                                                  09909504
099096*2300-EXIT.                                                       09909604
099099                                                                  09909904
099100*----------------------------------------------------------       09910004
099101* 2400-FIELD-MOVER                                                09910104
099102*     THIS PARAGRAPH MOVES A BIT OF DATA TO THE OUTPUT FILE RECORD09910204
099103*----------------------------------------------------------       09910304
099104 2400-FIELD-MOVER.                                                09910404
099105                                                                  09910504
099106     MOVE PV-BIT-VARIABLE(PV-EOF-IDX)                             09910612
099107       TO FORM-XRF-FLD(FORM-XRF-LEN).                             09910704
099108     SET FORM-XRF-LEN                                             09910804
099109       UP BY +1.                                                  09910904
099110     ADD 1                                                        09911004
099111       TO PV-BYTE-COUNT.                                          09911104
099112                                                                  09911204
099113*2400-EXIT.                                                       09911304
099115                                                                  09911504
099133*-----------------------------------------------------------------09913304
099134* 2500-MOVE-DELIMITER.                                            09913404
099135*  THIS PARAGRAPH WILL MOVE '|' TO THE OUTPUT FILE VARIABLE       09913504
099136*----------------------------------------------------------------*09913604
099137 2500-MOVE-DELIMITER.                                             09913704
099138                                                                  09913804
099139     MOVE PC-CSV-DELIMITER                                        09913904
099140       TO FORM-XRF-FLD(FORM-XRF-LEN).                             09914004
099141     SET FORM-XRF-LEN                                             09914104
099142       UP BY +1.                                                  09914204
099143     ADD 1                                                        09914304
099144       TO PV-BYTE-COUNT.                                          09914404
099145                                                                  09914504
099146*2500-EXIT.                                                       09914604
099148                                                                  09914804
099150*-----------------------------------------------------------------09915003
099200* 2600-WRITE-DATA-RECORD                                          09920004
099300*  THIS PARAGRAPH WILL WRITE THE DATA RECORD TO THE O/P FILE      09930003
099400*-----------------------------------------------------------------09940003
099500 2600-WRITE-DATA-RECORD.                                          09950004
099600                                                                  09960003
099700     WRITE FORMATTED-XREF-RECORD.                                 09970004
099800                                                                  09980003
099810     ADD 1 TO PV-DATA-REC-WRITEN.                                 09981004
099820                                                                  09982004
099900*2600-EXIT.                                                       09990020
100200                                                                  10020020
100300*-----------------------------------------------------------------10030020
100400* 2700-MOVE-ZERO                                                  10040020
100500*  THIS PARAGRAPH WILL MOVE '0' TO THE OUTPUT FILE VARIABLE       10050020
100600*----------------------------------------------------------------*10060020
100700 2700-MOVE-ZERO.                                                  10070020
100800                                                                  10080020
100900     MOVE PC-ONE-ZERO                                             10090020
101000       TO FORM-XRF-FLD(FORM-XRF-LEN).                             10100021
101100     SET FORM-XRF-LEN                                             10110020
101200       UP BY +1.                                                  10120020
101300     ADD 1                                                        10130020
101400       TO PV-BYTE-COUNT.                                          10140020
101500                                                                  10150020
101600*2700-EXIT.                                                       10160020
212600                                                                  21260003
212610******************************************************************21261029
212620* 5100-CALC-TIME.                                                 21262029
212630*     ADD 1 SECOND TO TIME FOR EACH HEADER RECORD WRITTEN         21263029
212640******************************************************************21264029
212650 5100-CALC-TIME.                                                  21265029
212660                                                                  21266029
212670     MOVE PV-TIME-CALC TO PV-TIME.                                21267029
212680                                                                  21268029
212690     IF PV-TIME-SS = 59                                           21269029
212691        IF PV-TIME-MM = 59                                        21269129
212692           IF PV-TIME-HH = 24                                     21269229
212693              MOVE ZEROES TO PV-TIME-HH                           21269329
212694           ELSE                                                   21269429
212695              ADD +1 TO PV-TIME-HH                                21269529
212696           END-IF                                                 21269629
212697           MOVE ZEROES TO PV-TIME-MM                              21269729
212698        ELSE                                                      21269829
212699           ADD +1 TO PV-TIME-MM                                   21269929
212700        END-IF                                                    21270029
212701        MOVE ZEROES TO PV-TIME-SS                                 21270129
212702     ELSE                                                         21270229
212703        ADD +1 TO PV-TIME-SS                                      21270329
212704     END-IF.                                                      21270429
212705                                                                  21270529
212706     MOVE PV-TIME TO PV-TIME-CALC.                                21270629
212707                                                                  21270729
212720*----------------------------------------------------------       21272004
212800* 6000-READ-XREF-FILE                                             21280004
212900*     THIS PARAGRAPH READS DATA FROM UPC-SKU-XREF-FILE INTO       21290004
213000*     COPYBOOK EPRD218                                            21300004
213100*----------------------------------------------------------       21310004
213200 6000-READ-XREF-FILE.                                             21320004
213300                                                                  21330004
213400     READ UPC-SKU-XREF-FILE                                       21340004
213500         INTO EP218-UPC-SKU-XREF-RECORD                           21350004
213600     AT END                                                       21360004
213700         SET PS-END-OF-XRF-FILE TO TRUE                           21370004
213800     END-READ.                                                    21380004
213810                                                                  21381043
213820     IF PS-NOT-END-XRF-FILE                                       21382043
213900        ADD +1 TO PV-RECORDS-READ                                 21390043
213901     END-IF.                                                      21390143
213910                                                                  21391004
214000*6000-EXIT.                                                       21400004
214200                                                                  21420004
253400******************************************************************25340003
253500*     CLOSES ALL FILES AND DISPLAYS ANY NEEDED INFORMATION.      *25350003
253600******************************************************************25360003
253700 9200-WRAPUP.                                                     25370003
253800     MOVE '9200-WRAPUP                     ' TO PV-PARAGRAPH-NAME.25380003
253900                                                                  25390003
254000     PERFORM 9920-DISPLAY-TOTALS.                                 25400003
254100                                                                  25410003
254200     DISPLAY '****************************************'.          25420003
254300     DISPLAY '**          EPKUT217 END              **'.          25430003
254400     DISPLAY '****************************************'.          25440003
254500                                                                  25450003
254600     CLOSE UPC-SKU-XREF-FILE                                      25460025
254700             CC-TODAYS-DATE.                                      25470027
255100                                                                  25510003
255200     CLOSE FORMATTED-XREF-FILE.                                   25520003
255300                                                                  25530003
255400*9200-EXIT.  EXIT.                                                25540003
257400******************************************************************25740003
257500*     ABEND PROGRAM WHEN A NON-DB2 ERROR OCCURS.              *   25750003
257600******************************************************************25760003
257700 9910-ABEND.                                                      25770003
257800                                                                  25780003
258100     DISPLAY '** ABEND           **'.                             25810003
258200     DISPLAY '** PROGRAM         ** = ' PC-PROGRAM-NAME.          25820003
258300     DISPLAY '** PARAGRAPH       ** = ' PV-PARAGRAPH-NAME.        25830003
258400     DISPLAY '** OPERATION       ** = ' PV-OPERATION-MSG-1.       25840003
258500     DISPLAY '**                 ** = ' PV-OPERATION-MSG-2.       25850003
258600                                                                  25860003
258610     PERFORM 9920-DISPLAY-TOTALS.                                 25861041
258620                                                                  25862041
258700     CALL 'ILBOABN0' USING AC-ABEND-CODE.                         25870003
258800                                                                  25880003
258900*9910-EXIT.  EXIT.                                                25890003
259000******************************************************************25900003
259100*     DISPLAY END OF JOB TOTALS                                  *25910003
259200******************************************************************25920003
259300 9920-DISPLAY-TOTALS.                                             25930003
259400                                                                  25940003
259500     DISPLAY '****************************************'.          25950003
259600     DISPLAY '**     STATISTICS  FOR  XREF FILE     **'.          25960005
259800     DISPLAY '****************************************'.          25980003
259900                                                                  25990003
260000     DISPLAY '** XREF EXTRACT RECORDS READ  ====> '               26000018
260100             PV-RECORDS-READ                                      26010018
260200             ' **'.                                               26020003
260210     DISPLAY '** XREF HEADER RECORDS WRITEN ====> '               26021018
260220             PV-HDR-REC-WRITEN                                    26022018
260230             ' **'.                                               26023018
260300     DISPLAY '** XREF DETAIL RECORDS WRITEN ====> '               26030003
260400             PV-DATA-REC-WRITEN                                   26040006
260500             ' **'.                                               26050003
261200     DISPLAY '****************************************'.          26120003
261300                                                                  26130003
261400*9920-EXIT.  EXIT.                                                26140003
261500                                                                  26150003
