000100 IDENTIFICATION DIVISION.                                         00010003
000200 PROGRAM-ID.     APKUP384.                                        00020003
000300 AUTHOR.         NANCY EILBES.                                    00030003
000400 DATE-WRITTEN.   MAY 2023.                                        00040003
000500******************************************************************00050003
000600*    COBOL 2  WITH SQL                                           *00060003
000700*                                                                *00070003
000800*    ADD INVOICE TERMS TO NEXUS INVOICES.                        *00080003
000900*                                                                *00090003
001000******************************************************************00100003
001100*                                                                *00110003
001200*    TINVOIC - ACCOUNTS PAYABLE NEW INVOICE TABLE                *00120003
001300*    TMDINVC - MERCHANDISE INVOICE TABLE                         *00130003
001400*    TINVCTM - INVOICE TERMS TABLE                               *00140003
001500*                                                                *00150003
001600******************************************************************00160003
001700* CHANGE LOG:                                                    *00170003
001800* DATE  05/23/2023                                               *00180003
001900*     CHANGE MADE: INITIAL IMPLEMENTATION.                       *00190003
002000*     MADE BY: NANCY EILBES            WR/IR #: CHG0289780       *00200004
002100******************************************************************00210003
002200                                                                  00220003
002300 ENVIRONMENT DIVISION.                                            00230003
002400 CONFIGURATION SECTION.                                           00240003
002500 SOURCE-COMPUTER.    IBM-3090.                                    00250003
002600 OBJECT-COMPUTER.    IBM-3090.                                    00260003
002700                                                                  00270003
002800 INPUT-OUTPUT SECTION.                                            00280003
002900 FILE-CONTROL.                                                    00290003
003000 DATA DIVISION.                                                   00300003
003100 FILE SECTION.                                                    00310003
003200                                                                  00320003
003300 WORKING-STORAGE SECTION.                                         00330003
003400                                                                  00340003
003500 01  FILLER                        PIC X(25) VALUE                00350003
003600                             'WS FOR APKUP384 BEGINS==>'.         00360003
003700 01  ABEND-CODE                    PIC S9(4) COMP SYNC            00370003
003800                                             VALUE ZEROS.         00380003
003900     88 AP-TABLE-FULL              VALUE +4004.                   00390003
004000     88 AP-EMPTY-FILE              VALUE +4005.                   00400003
004100     88 AP-DB2-ERROR               VALUE +4013.                   00410003
004200                                                                  00420003
004300 01  WS-ABEND-FIELDS.                                             00430003
004400     05  WS-ABEND-PROGRAM             PIC X(8)  VALUE 'APKUP384'. 00440003
004500     05  WS-ABEND-SQLCODE             PIC X(4)  VALUE SPACES.     00450003
004600     05  WS-ABEND-PARAGRAPH           PIC X(50) VALUE SPACES.     00460003
004700     05  WS-ABEND-OPERATION           PIC X(50) VALUE SPACES.     00470003
004800     05  WS-ABEND-STRUCTURE-1         PIC X(8)  VALUE SPACES.     00480003
004900     05  WS-ABEND-STRUCTURE-2         PIC X(8)  VALUE SPACES.     00490003
005000     05  WS-ABEND-STATUS              PIC XX    VALUE SPACES.     00500003
005100                                                                  00510003
005200 01  WS-WORK-AREA.                                                00520003
005300     05  PV-FETCH-COUNT          PIC 9(9)    VALUE ZEROS.         00530003
005400     05  PV-INSERT-COUNT         PIC 9(9)    VALUE ZEROS.         00540003
005500     05  PV-UPDATE-COUNT         PIC 9(9)    VALUE ZEROS.         00550003
005600     05  PV-PROGRAM-NAME         PIC X(08)   VALUE 'APKUP384'.    00560003
005700     05  PV-CKPT-STAT-CODE       PIC X(01)   VALUE SPACE.         00570003
005800                                                                  00580003
005900 01  WS-SWITCHES.                                                 00590003
006000     05  WS-END-OF-CURSOR-SW     PIC X(01) VALUE 'N'.             00600003
006100         88  END-OF-CURSOR                 VALUE 'Y'.             00610003
006200         88  NOT-END-OF-CURSOR             VALUE 'N'.             00620003
006300                                                                  00630003
006400 01  RUN-TIME.                                                    00640003
006500     05  R-HR                    PIC 99.                          00650003
006600     05  R-MIN                   PIC 99.                          00660003
006700     05  R-SEC                   PIC 99.                          00670003
006800     05  R-TH                    PIC 99.                          00680003
006900*                                                                 00690003
007000 01  DATE-IN.                                                     00700003
007100     05 DATE-IN-YY               PIC XX.                          00710003
007200     05 DATE-IN-MM               PIC XX.                          00720003
007300     05 DATE-IN-DD               PIC XX.                          00730003
007400                                                                  00740003
007500 01  FILLER                      PIC X(35)  VALUE                 00750003
007600     'END OF AP WORK RECORD AREA       **'.                       00760003
007700                                                                  00770003
007800     COPY DPWS004.                                                00780003
007900                                                                  00790003
008000******************************************************************00800003
008100*  COMMUNICATIONS AREA2 FOR DB2                                   00810003
008200******************************************************************00820003
008300     COPY SQLCA2.                                                 00830003
008400                                                                  00840003
008500     EXEC SQL                                                     00850003
008600          INCLUDE SQLCA                                           00860003
008700     END-EXEC.                                                    00870003
008800                                                                  00880003
008900     EXEC SQL                                                     00890003
009000          INCLUDE TINVOIC                                         00900003
009100     END-EXEC.                                                    00910003
009200                                                                  00920003
009300     EXEC SQL                                                     00930003
009400          INCLUDE TMDINVC                                         00940003
009500     END-EXEC.                                                    00950003
009600                                                                  00960003
009700     EXEC SQL                                                     00970003
009800          INCLUDE TINVCTM                                         00980003
009900     END-EXEC.                                                    00990003
010000                                                                  01000003
010100*----------------------------------------------------------------*01010003
010200*    INVOICE CURSOR SELECTING LI & FUNG INVOICES IN ENTERED STATUS01020003
010300*----------------------------------------------------------------*01030003
010400     EXEC SQL                                                     01040003
010500         DECLARE INVOICE_CSR CURSOR WITH HOLD FOR                 01050003
010600             SELECT A.PO_NBR                                      01060003
010700                  , A.INVC_ID                                     01070003
010800                  , B.TERM_SEL_CDE                                01080003
010900               FROM TINVOIC  A                                    01090003
011000                  , TMDINVC  B                                    01100003
011100              WHERE A.PO_NBR       =  B.PO_NBR                    01110003
011200                AND A.INVC_ID      =  B.INVC_ID                   01120003
011300                AND A.STATUS_CDE   =  'EN'                        01130003
011400                AND A.INVC_TYP_CDE =  'MI'                        01140003
011500                AND B.IMPRT_CHRG_PRC_CDE = '1NX'                  01150003
011600                AND NOT EXISTS (SELECT 1 FROM TINVCTM C           01160003
011700                                 WHERE  C.PO_NBR  =  A.PO_NBR     01170003
011800                                   AND  C.INVC_ID =  A.INVC_ID)   01180003
011900           ORDER BY A.PO_NBR                                      01190003
012000                  , A.INVC_ID                                     01200003
012100     END-EXEC.                                                    01210003
012200 01  FILLER                        PIC X(25) VALUE                01220003
012300          '<====WS FOR APKUP384 ENDS'.                            01230003
012400                                                                  01240003
012800 PROCEDURE DIVISION.                                              01280003
012900                                                                  01290003
013200     PERFORM B100-HOUSEKEEPING.                                   01320003
013300                                                                  01330003
013400     PERFORM B200-PROCESSING UNTIL END-OF-CURSOR.                 01340003
013500                                                                  01350003
013600     PERFORM B300-END-OF-JOB.                                     01360003
013700                                                                  01370003
013800     GOBACK.                                                      01380003
013900                                                                  01390003
014000                                                                  01400003
014100***************************************************************** 01410003
014200*    GET DATE, TIME, OPEN FILES, SET UP CONTROLS, ETC             01420003
014300***************************************************************** 01430003
014400 B100-HOUSEKEEPING.                                               01440003
014500                                                                  01450003
014600     INITIALIZE DCLTINVOIC.                                       01460003
014700     INITIALIZE DCLTMDINVC.                                       01470003
014800     INITIALIZE DCLTINVCTM.                                       01480003
014900                                                                  01490003
015000     PERFORM S100-OPEN-CURSOR.                                    01500003
015100     PERFORM S200-FETCH-INVOICE.                                  01510003
015200                                                                  01520003
015300     IF END-OF-CURSOR                                             01530003
015400         DISPLAY '**********************************'             01540003
015500         DISPLAY '*   NO NEXUS INVOICES FOUND      *'             01550003
015600         DISPLAY '*   PROGRAM ** = APKUP384        *'             01560003
015700         DISPLAY '**********************************'             01570003
015800     END-IF.                                                      01580003
015900                                                                  01590003
016000***************************************************************** 01600003
016100*     PROCESS NEXUS INVOICES:                                     01610003
016200*     -- SET UP THE INVOICE TERMS FIELDS AND INSERT A ROW.        01620003
016300*     -- UPDATE THE TERMS SELECT CODE ON TMDINVC                  01630003
016400***************************************************************** 01640003
016500 B200-PROCESSING.                                                 01650003
016600                                                                  01660003
016700     PERFORM C100-CREATE-INVCTM.                                  01670003
016800     PERFORM U100-UPDATE-TERMS-SELECT.                            01680003
016900     PERFORM U300-COMMIT.                                         01690003
017000                                                                  01700003
017100     PERFORM S200-FETCH-INVOICE.                                  01710003
017200                                                                  01720003
017300                                                                  01730003
017400***************************************************************** 01740003
017500*     CLOSE ALL FILES, REPORT ON NECESSARY TOTALS                 01750003
017600***************************************************************** 01760003
017700 B300-END-OF-JOB.                                                 01770003
017800                                                                  01780003
017900     DISPLAY '************************************************'.  01790003
018000     DISPLAY 'INVOICE ROWS FETCHED  = ' PV-FETCH-COUNT.           01800003
018100     DISPLAY 'TINVCTM ROWS INSERTED = ' PV-INSERT-COUNT.          01810003
018200     DISPLAY 'TMDINVC ROWS UPDATED  = ' PV-UPDATE-COUNT.          01820003
018300     DISPLAY '************************************************'.  01830003
018400                                                                  01840003
018500                                                                  01850003
018600     ACCEPT RUN-TIME FROM TIME.                                   01860003
018700     ACCEPT DATE-IN  FROM DATE.                                   01870003
018800                                                                  01880003
018900     DISPLAY ' RUN-DATE = ' DATE-IN '   RUN-TIME = ' RUN-TIME.    01890003
019000     DISPLAY '************************************************'.  01900003
019100                                                                  01910003
019200                                                                  01920003
019300***************************************************************** 01930003
019400*     MOVE THE DATA TO COMPLETE THE INVCTM ROW                    01940003
019500***************************************************************** 01950003
019600 C100-CREATE-INVCTM.                                              01960003
019700                                                                  01970003
019800     MOVE INVOIC-PO-NBR            TO INVCTM-PO-NBR.              01980003
019900     MOVE INVOIC-INVC-ID           TO INVCTM-INVC-ID.             01990003
020000     MOVE 1                        TO INVCTM-TERM-SEQ-NBR.        02000003
020100     MOVE '05'                     TO INVCTM-TERM-TYP-CDE.        02010003
020200     MOVE '02'                     TO INVCTM-TERM-BASIS-DTE-CDE.  02020003
020300     MOVE '9999-09-09'             TO INVCTM-EFF-DTE.             02030003
020400     MOVE ZERO                     TO INVCTM-DISC-PCT.            02040003
020500     MOVE ZERO                     TO INVCTM-DISC-AMT.            02050003
020600     MOVE '9999-09-09'             TO INVCTM-DISC-DUE-DTE.        02060003
020700     MOVE ZERO                     TO INVCTM-DISC-DUE-DAY-QTY.    02070003
020800     MOVE '9999-09-09'             TO INVCTM-NET-DUE-DTE.         02080003
020900     MOVE 60                       TO INVCTM-NET-DUE-DAY-QTY.     02090003
021000     MOVE ZERO                     TO INVCTM-EXTD-DAYS-QTY.       02100003
021100                                                                  02110003
021200     PERFORM I400-INSERT-INVCTM.                                  02120003
021300                                                                  02130003
021400***************************************************************** 02140003
021500*     INSERT THE INVCTM ROW FOR THIS INVOICE NUMBER               02150003
021600***************************************************************** 02160003
021700 I400-INSERT-INVCTM.                                              02170003
021800                                                                  02180003
021900     EXEC SQL                                                     02190003
022000         INSERT INTO TINVCTM                                      02200003
022100            ( PO_NBR                                              02210003
022200             ,INVC_ID                                             02220003
022300             ,TERM_SEQ_NBR                                        02230003
022400             ,TERM_TYP_CDE                                        02240003
022500             ,TERM_BASIS_DTE_CDE                                  02250003
022600             ,EFF_DTE                                             02260003
022700             ,DISC_PCT                                            02270003
022800             ,DISC_AMT                                            02280003
022900             ,DISC_DUE_DTE                                        02290003
023000             ,DISC_DUE_DAY_QTY                                    02300003
023100             ,NET_DUE_DTE                                         02310003
023200             ,NET_DUE_DAY_QTY                                     02320003
023300             ,EXTD_DAYS_QTY)                                      02330003
023400         VALUES                                                   02340003
023500             (:INVCTM-PO-NBR                                      02350003
023600             ,:INVCTM-INVC-ID                                     02360003
023700             ,:INVCTM-TERM-SEQ-NBR                                02370003
023800             ,:INVCTM-TERM-TYP-CDE                                02380003
023900             ,:INVCTM-TERM-BASIS-DTE-CDE                          02390003
024000             ,:INVCTM-EFF-DTE                                     02400003
024100             ,:INVCTM-DISC-PCT                                    02410003
024200             ,:INVCTM-DISC-AMT                                    02420003
024300             ,:INVCTM-DISC-DUE-DTE                                02430003
024400             ,:INVCTM-DISC-DUE-DAY-QTY                            02440003
024500             ,:INVCTM-NET-DUE-DTE                                 02450003
024600             ,:INVCTM-NET-DUE-DAY-QTY                             02460003
024700             ,:INVCTM-EXTD-DAYS-QTY)                              02470003
024800     END-EXEC.                                                    02480003
024900                                                                  02490003
025000     EVALUATE TRUE                                                02500003
025100         WHEN SQLCODE = ZERO                                      02510003
025200             ADD +1 TO PV-INSERT-COUNT                            02520003
025300                                                                  02530003
025400         WHEN SQLWARN0 NOT = SPACES                               02540003
025500         WHEN SQLCODE  NOT = ZERO                                 02550003
025600              MOVE 'I400-INSERT-TINVCTM ' TO WS-ABEND-PARAGRAPH   02560003
025800              MOVE 'UNSUCCESSFUL INSERT' TO WS-ABEND-OPERATION    02580003
026000              MOVE 'TINVCTM ' TO WS-ABEND-STRUCTURE-1             02600003
026100              MOVE SQLCODE    TO WS-ABEND-SQLCODE                 02610003
026200              PERFORM Z999-SQL-ERROR                              02620003
026300     END-EVALUATE.                                                02630003
026400                                                                  02640003
026500*----------------------------------------------------------------*02650003
026600* OPEN INVOICE CURSOR                                             02660003
026700*----------------------------------------------------------------*02670003
026800 S100-OPEN-CURSOR.                                                02680003
026900                                                                  02690003
027000                                                                  02700003
027100     EXEC SQL                                                     02710003
027200         OPEN INVOICE_CSR                                         02720003
027300     END-EXEC.                                                    02730003
027400                                                                  02740003
027500     EVALUATE TRUE                                                02750003
027600         WHEN SQLCODE = ZERO                                      02760003
027700             CONTINUE                                             02770003
027800                                                                  02780003
027900         WHEN SQLWARN0 NOT = SPACES                               02790003
028000         WHEN SQLCODE  NOT = ZERO                                 02800003
028100             MOVE SQLCODE    TO WS-ABEND-SQLCODE                  02810003
028200             MOVE 'S100-OPEN-CURSOR' TO WS-ABEND-PARAGRAPH        02820003
028400             MOVE 'UNSUCCESSFUL OPEN CURSOR' TO WS-ABEND-OPERATION02840003
028600             MOVE 'TINVOIC'  TO WS-ABEND-STRUCTURE-1              02860003
028700             MOVE 'TMDINVC'  TO WS-ABEND-STRUCTURE-2              02870003
028800             PERFORM Z999-SQL-ERROR                               02880003
028900     END-EVALUATE.                                                02890003
029000                                                                  02900003
029100*----------------------------------------------------------------*02910003
029200* FETCH INVOICE CURSOR                                            02920003
029300*----------------------------------------------------------------*02930003
029400 S200-FETCH-INVOICE.                                              02940003
029500                                                                  02950003
029600     EXEC SQL                                                     02960003
029700         FETCH INVOICE_CSR                                        02970003
029800          INTO :INVOIC-PO-NBR                                     02980003
029900             , :INVOIC-INVC-ID                                    02990003
030000             , :MDINVC-TERM-SEL-CDE                               03000003
030100     END-EXEC.                                                    03010003
030200                                                                  03020003
030300     EVALUATE TRUE                                                03030003
030400         WHEN SQLCODE = ZERO                                      03040003
030500             ADD +1 TO PV-FETCH-COUNT                             03050003
030600         WHEN SQLCODE = +100                                      03060003
030700             SET END-OF-CURSOR TO TRUE                            03070003
030800                                                                  03080003
030900         WHEN SQLWARN0 NOT = SPACES                               03090003
031000         WHEN SQLCODE  NOT = ZERO                                 03100003
031100           MOVE SQLCODE    TO WS-ABEND-SQLCODE                    03110003
031200           MOVE 'S200-FETCH-INVOICE      ' TO WS-ABEND-PARAGRAPH  03120003
031400           MOVE 'UNSUCCESSFUL FETCH CURSOR' TO WS-ABEND-OPERATION 03140003
031600           MOVE 'TINVOIC'  TO WS-ABEND-STRUCTURE-1                03160003
031700           MOVE 'TMDINVC'  TO WS-ABEND-STRUCTURE-2                03170003
031800           PERFORM Z999-SQL-ERROR                                 03180003
031900     END-EVALUATE.                                                03190003
032000                                                                  03200003
032100*----------------------------------------------------------------*03210003
032200* CLOSE INVOICE CURSOR                                            03220003
032300*----------------------------------------------------------------*03230003
032400 S300-CLOSE-CURSOR.                                               03240003
032600                                                                  03260003
032700     EXEC SQL                                                     03270003
032800         CLOSE INVOICE_CSR                                        03280003
032900     END-EXEC.                                                    03290003
033000                                                                  03300003
033100     EVALUATE TRUE                                                03310003
033200         WHEN SQLCODE = ZERO                                      03320003
033300           CONTINUE                                               03330003
033500         WHEN SQLWARN0 NOT = SPACES                               03350003
033600         WHEN SQLCODE  NOT = ZERO                                 03360003
033700           MOVE SQLCODE    TO WS-ABEND-SQLCODE                    03370003
033800           MOVE 'S300-CLOSE-CURSOR' TO WS-ABEND-PARAGRAPH         03380003
034000           MOVE 'UNSUCCESSFUL CLOSE CURSOR' TO WS-ABEND-OPERATION 03400003
034200           MOVE 'TINVOIC   '   TO WS-ABEND-STRUCTURE-1            03420003
034300           MOVE 'TMDINVC   '   TO WS-ABEND-STRUCTURE-2            03430003
034400           PERFORM Z999-SQL-ERROR                                 03440003
034500     END-EVALUATE.                                                03450003
034600                                                                  03460003
034700*--------------------------------------------------------------*  03470003
034800* UPDATES THE TERMS SELECT CODE ON TMDINVC AFTER THE NEW       *  03480003
034900* INVOICE TERMS HAVE BEEN INSERTED.                            *  03490003
035000*--------------------------------------------------------------*  03500003
035100 U100-UPDATE-TERMS-SELECT.                                        03510003
035200                                                                  03520003
035300     EXEC SQL                                                     03530003
035400         UPDATE TMDINVC                                           03540003
035500            SET TERM_SEL_CDE = 'I'                                03550003
035600          WHERE PO_NBR       = :INVOIC-PO-NBR                     03560003
035700            AND INVC_ID      = :INVOIC-INVC-ID                    03570003
035800     END-EXEC.                                                    03580003
035900                                                                  03590003
036000                                                                  03600003
036100     EVALUATE TRUE                                                03610003
036200         WHEN SQLCODE = ZERO                                      03620003
036300             ADD +1 TO PV-UPDATE-COUNT                            03630003
036400                                                                  03640003
036500         WHEN SQLWARN0 NOT = SPACES                               03650003
036600         WHEN SQLCODE  NOT = ZERO                                 03660003
036700             MOVE SQLCODE    TO WS-ABEND-SQLCODE                  03670003
036800             MOVE 'U100-UPDATE-TERMS-SELECT '                     03680003
036900                                 TO WS-ABEND-PARAGRAPH            03690003
037000             MOVE 'UNSUCCESSFUL UPDATE '                          03700003
037100                                 TO WS-ABEND-OPERATION            03710003
037200             MOVE 'TMDINVC   '   TO WS-ABEND-STRUCTURE-1          03720003
037300             MOVE '          '   TO WS-ABEND-STRUCTURE-2          03730003
037400             PERFORM Z999-SQL-ERROR                               03740003
037500     END-EVALUATE.                                                03750003
037600*----------------------------------------------------------------*03760003
037700*    COMMITS DB2 UPDATES FOR THE PO PROCESSED.                    03770003
037800*----------------------------------------------------------------*03780003
037900 U300-COMMIT.                                                     03790003
038000                                                                  03800003
038100     EXEC SQL                                                     03810003
038200         COMMIT                                                   03820003
038300     END-EXEC.                                                    03830003
038400                                                                  03840003
038500     EVALUATE TRUE                                                03850003
038600         WHEN SQLCODE = ZEROS                                     03860003
038700              CONTINUE                                            03870003
038800         WHEN OTHER                                               03880003
038900             MOVE SQLCODE    TO WS-ABEND-SQLCODE                  03890003
039000             MOVE 'U300-COMMIT' TO WS-ABEND-PARAGRAPH             03900003
039100             MOVE 'UNSUCCESSFUL COMMIT' TO WS-ABEND-OPERATION     03910003
039200             MOVE SPACES         TO WS-ABEND-STRUCTURE-1          03920003
039300                                    WS-ABEND-STRUCTURE-2          03930003
039400             PERFORM Z999-SQL-ERROR                               03940003
039500     END-EVALUATE.                                                03950003
039600                                                                  03960003
039700                                                                  03970003
039800                                                                  03980003
039900***************************************************************** 03990003
040000*     PROCESS DB2 ABENDS                                          04000003
040100***************************************************************** 04010003
040200 Z999-SQL-ERROR.                                                  04020003
040300                                                                  04030003
040400     DISPLAY 'PO NUMBER        = ' INVOIC-PO-NBR.                 04040003
040500     DISPLAY 'INVOICE NUMBER   = ' INVOIC-INVC-ID.                04050003
040600     DISPLAY '*** DB2 ERROR '.                                    04060003
040700     DISPLAY '*** SQL CODE = '  WS-ABEND-SQLCODE.                 04070003
040800     DISPLAY '*** PROGRAM   = ' WS-ABEND-PROGRAM.                 04080003
040900     DISPLAY '*** PARAGRAPH = ' WS-ABEND-PARAGRAPH.               04090003
041000     DISPLAY '*** OPERATION = ' WS-ABEND-OPERATION.               04100003
041100     DISPLAY '*** TABLE 1   = ' WS-ABEND-STRUCTURE-1.             04110003
041200     IF WS-ABEND-STRUCTURE-2 > SPACES                             04120003
041300         DISPLAY '*** TABLE 2   = ' WS-ABEND-STRUCTURE-2.         04130003
041400                                                                  04140003
041500     COPY DPPD004.                                                04150003
041600                                                                  04160003
041700     MOVE +4013                    TO ABEND-CODE.                 04170003
041800                                                                  04180003
041900     CALL 'ILBOABN0' USING ABEND-CODE.                            04190003
