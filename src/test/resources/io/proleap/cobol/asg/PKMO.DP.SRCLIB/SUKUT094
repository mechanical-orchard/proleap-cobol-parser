000100***************************************************************** 00010000
000200 IDENTIFICATION DIVISION.                                         00020000
000300***************************************************************** 00030000
000400                                                                  00040000
000500 PROGRAM-ID.             SUKUT094.                                00050000
000600 AUTHOR.                 CHERI PARMLEY.                           00060000
000700 INSTALLATION.           KOHLS DEPARTMENT STORES.                 00070000
000800 DATE-WRITTEN            MAY, 2016.                               00080000
000900 DATE-COMPILED.                                                   00090000
001000***************************************************************** 00100000
001200*                                                               * 00110000
001300*  THIS PROGRAM WILL CREATE AN EXTRACT FILE CONTAINING          * 00120000
001300*  TRACKING NUMBER HISTORY CREATED MORE THAN X(PARM VALUE)      * 00121000
001400*  NUMBER OF MONTHS OLD.                                        * 00130000
001410*  IT WILL CREATE AN EXTRACT RECORD FOR EACH TRACKING# IN THE   * 00140000
001420*  TRACKING NUMBER HISTORY DATABASE. THIS WILL BE USED TO       * 00141000
001430*  PURGE THE DATABASE.                                          * 00142000
001500***************************************************************** 00144000
002000***************************************************************** 00145000
002100 ENVIRONMENT DIVISION.                                            00146000
002200***************************************************************** 00147000
002300                                                                  00148000
002400 CONFIGURATION SECTION.                                           00149000
002500                                                                  00150000
002600 SOURCE-COMPUTER.        IBM-3090.                                00160000
002700 OBJECT-COMPUTER.        IBM-3090.                                00170000
002800                                                                  00180000
002900 INPUT-OUTPUT SECTION.                                            00190000
003000                                                                  00200000
003100 FILE-CONTROL.                                                    00210000
003200*                                                                 00220000
003600     SELECT SU-TRKG-EXTRACT-FILE                                  00230000
003700         ASSIGN TO OUT01.                                         00240000
004100*                                                                 00250000
004200***************************************************************** 00260000
004300 DATA DIVISION.                                                   00270000
004400***************************************************************** 00280000
004500*                                                                 00290000
004600 FILE SECTION.                                                    00300000
004700*                                                                 00310000
005500 FD  SU-TRKG-EXTRACT-FILE                                         00320000
005600     RECORDING MODE IS F                                          00330000
005700     BLOCK CONTAINS 0  RECORDS.                                   00340000
005800 01  SU-TRKG-EXTRACT-RECORD          PIC  X(100).                 00350000
005900*                                                                 00360000
006600                                                                  00370000
006700 WORKING-STORAGE SECTION.                                         00380000
006800*                                                                 00390000
006900 01  ABEND-CODE                      PIC S9(04)    VALUE +0       00400000
007000                                                   COMP SYNC.     00410000
007100*                                                                 00420000
007200 01  PROGRAM-SWITCHES.                                            00430000
007300     05  PS-EOF-TRK-CURSOR-SW        PIC  X(01)    VALUE 'N'.     00440000
007400         88  PS-EOF-TRK-CSR                        VALUE 'Y'.     00450000
007500         88  PS-NOT-EOF-TRK-CSR                    VALUE 'N'.     00460000
007540                                                                  00500000
007550 01  PC-PROGRAM-CONSTANTS.                                        00510000
007560     05  PC-CURRENT-PROGRAM-NAME    PIC  X(08)     VALUE          00520000
007570                                                   'SUKUT094'.    00530000
008740                                                                  00540000
009500 01  PV-PROGRAM-VARIABLES.                                        00550000
009510     05  PV-DISPLAY-PURGE-WEEKS      PIC  Z(09).                  00560000
009520     05  PV-PURGE-TMST               PIC  X(26).                  00570000
009521     05  PV-PURGE-DATE               PIC  X(10).                  00580000
009522                                                                  00590000
009530     05  PV-ABEND-PARAGRAPH          PIC  X(30)    VALUE SPACES.  00600000
009531     05  PV-PARAGRAPH-NAME           PIC  X(30)    VALUE SPACES.  00610000
009540     05  PV-DB2-OPERATION-ATTEMPTED  PIC  X(30)    VALUE SPACES.  00620000
009541                                                                  00630000
009590     05  PV-TRK-FETCH-CNT            PIC  9(09)    VALUE ZERO.    00640000
009700     05  PV-TRK-OUTPUT-CNT           PIC  9(09)    VALUE ZERO.    00660000
011400                                                                  00710000
011500 01  DK-DB-KEYS.                                                  00720000
011600     05  DK-PURGE-WEEKS              PIC S9(09)  COMP.            00730000
012100                                                                  00740000
013200 01  TRACKING-EXTRACT-FILE.                                       00750001
013300     COPY SURD115.                                                00760001
013400                                                                  00770000
013410/                                                                 00780000
013450******************************************************************00790000
013460*  DB2 FORMATTED MESSAGE AREA                                     00800000
013470******************************************************************00810000
013480     COPY DPWS004.                                                00820000
013490                                                                  00830000
013600******************************************************************00840000
014200*  COPY BOOK FOR THE PARAMETER TABLE                              00850000
014210******************************************************************00860000
014400     EXEC SQL                                                     00870000
014500          INCLUDE TKRPRPM                                         00880000
014600     END-EXEC.                                                    00890000
015500                                                                  00900000
015501******************************************************************00910000
015502*  COPY BOOK FOR THE TRACKING NUMBER HISTORY TABLE                00920001
015503******************************************************************00930000
015504     EXEC SQL                                                     00940000
015505          INCLUDE SUT00119                                        00950001
015506     END-EXEC.                                                    00960000
015507                                                                  00970000
015760******************************************************************01260000
017500*  DB2 COMMUNICATION AREA                                         01270000
017510******************************************************************01280000
017700     EXEC SQL                                                     01290000
017800         INCLUDE SQLCA                                            01300000
017900     END-EXEC.                                                    01310000
018000                                                                  01320000
018010******************************************************************01330000
018100*  DB2 COMMUNICATION AREA2                                        01340000
018110******************************************************************01350000
018300     COPY SQLCA2.                                                 01360000
018500                                                                  01370000
018600                                                                  01380000
018700     EXEC SQL                                                     01390000
018800       DECLARE TRK-CSR CURSOR FOR                                 01400000
018900         SELECT TRKG_NBR                                          01410001
019000               ,TRKG_STAT_CDE                                     01420001
019000               ,CRE_TMST                                          01421001
019000               ,PRCD_IND                                          01422002
019000               ,CRE_PGM_NM                                        01423002
019000               ,TRK_TMST                                          01424002
019500          FROM  SUT_TRKG_NBR_HIST                                 01430001
019700          WHERE DATE(CRE_TMST) < (CURRENT DATE -                  01440005
019800                           (:DK-PURGE-WEEKS * 7) DAYS)            01450000
019900     END-EXEC.                                                    01460000
020000                                                                  01470000
022900*                                                                 01590000
023000 PROCEDURE DIVISION.                                              01600000
023100*                                                                 01610000
023200 0000-MAINLINE-PROCESSING.                                        01620000
023300******************************************************************01630000
023400**  THIS IS THE MAIN DRIVER FOR THE PROGRAM.                      01640000
023500******************************************************************01650000
023600                                                                  01660000
023610     PERFORM 1000-INITIALIZATION.                                 01670000
023630                                                                  01680000
023640     PERFORM 2000-PROCESS-TRK                                     01690000
023650       UNTIL PS-EOF-TRK-CSR.                                      01700000
023670                                                                  01710000
023671     PERFORM 2300-CLOSE-TRK-CSR.                                  01720000
023672                                                                  01730000
023676                                                                  01770000
023677     DISPLAY 'TRK FETCHED=' PV-TRK-FETCH-CNT   '  **'.            01780000
023680     DISPLAY '                                 '.                 01800000
023681     DISPLAY 'TRK WRITTEN=' PV-TRK-OUTPUT-CNT  '  **'.            01810002
023687     DISPLAY '                                 '.                 01840000
023690                                                                  01870000
023691     CLOSE SU-TRKG-EXTRACT-FILE.                                  01880000
023692                                                                  01890000
023693     GOBACK.                                                      01900000
023694                                                                  01910000
023700                                                                  01920000
023800 1000-INITIALIZATION.                                             01930000
023900******************************************************************01940000
024000**  PERFORM THE INITIAL PROCESSING FOR THE PROGRAM.               01950000
024100******************************************************************01960000
024200                                                                  01970000
024400     OPEN OUTPUT SU-TRKG-EXTRACT-FILE.                            01980000
024600                                                                  01990000
024700     PERFORM 7000-GET-PURGE-WEEKS.                                02000000
024800                                                                  02010000
025000     DISPLAY '** SUKUT094 **'.                                    02020000
025100     DISPLAY '** PURGE ' PV-DISPLAY-PURGE-WEEKS ' WEEKS **'.      02030000
025200     DISPLAY '** DATE  ' PV-PURGE-DATE.                           02040000
025500                                                                  02050000
025510     SET  PS-NOT-EOF-TRK-CSR TO  TRUE.                            02060002
025530                                                                  02080000
025600     PERFORM 2100-OPEN-TRK-CSR.                                   02090000
025610     PERFORM 2200-FETCH-TRK-CSR.                                  02100000
025630                                                                  02120000
025700*                                                                 02130000
025800 2000-PROCESS-TRK.                                                02140000
025801                                                                  02150000
025830     INITIALIZE  SU115-EXTRACT-RECORD.                            02170002
025840                                                                  02180000
025850     MOVE SUT00119-TRKG-NBR      TO  SU115-TRKG-NBR.              02190002
025860     MOVE SUT00119-TRKG-STAT-CDE TO  SU115-TRKG-STAT-CDE.         02210002
025860     MOVE SUT00119-CRE-TMST      TO  SU115-CRE-TMST.              02211002
025860     MOVE SUT00119-PRCD-IND      TO  SU115-PRCD-IND.              02212002
025860     MOVE SUT00119-CRE-PGM-NM    TO  SU115-CRE-PGM-NM.            02213002
025860     MOVE SUT00119-TRK-TMST      TO  SU115-TRK-TMST.              02214002
026124     PERFORM 8000-WRITE-EXTRACT-RECORD.                           02310002
026122     ADD  1  TO  PV-TRK-OUTPUT-CNT.                               02320002
026501                                                                  02380000
026502     PERFORM 2200-FETCH-TRK-CSR.                                  02390000
026503                                                                  02400000
026510                                                                  02410000
026600 2100-OPEN-TRK-CSR.                                               02420000
026700     MOVE '2100-OPEN-TRK-CSR'    TO PV-ABEND-PARAGRAPH.           02430000
026800                                                                  02440000
027000     EXEC SQL                                                     02450000
027100          OPEN TRK-CSR                                            02460000
027200     END-EXEC.                                                    02470000
027800                                                                  02480000
027900     EVALUATE TRUE                                                02490000
028000         WHEN SQLCODE = 0                                         02500000
028200             CONTINUE                                             02510000
028300         WHEN SQLWARN0 NOT = SPACES                               02520000
028400         WHEN SQLCODE < ZERO                                      02530000
028500         WHEN SQLCODE > ZERO                                      02540000
028600             MOVE '2100-OPEN-TRK-CSR'                             02550000
028700                             TO PV-PARAGRAPH-NAME                 02560000
028800             MOVE 'OPEN THE TRK_CURSOR            '               02570000
028900                             TO PV-DB2-OPERATION-ATTEMPTED        02580000
029000             PERFORM 9100-SQL-ABEND                               02590000
029100     END-EVALUATE.                                                02600000
029200                                                                  02610000
029210                                                                  02620000
029300 2200-FETCH-TRK-CSR.                                              02630000
029400     MOVE '2200-FETCH-TRK-CSR'   TO PV-ABEND-PARAGRAPH.           02640000
029500                                                                  02650000
029700     EXEC SQL                                                     02660000
029800          FETCH TRK-CSR                                           02670000
029900          INTO  :SUT00119-TRKG-NBR                                02680002
030000              , :SUT00119-TRKG-STAT-CDE                           02690002
030000              , :SUT00119-CRE-TMST                                02691002
030000              , :SUT00119-PRCD-IND                                02692002
030000              , :SUT00119-CRE-PGM-NM                              02693002
030000              , :SUT00119-TRK-TMST                                02694002
030500     END-EXEC.                                                    02700000
031700                                                                  02710000
031800     EVALUATE TRUE                                                02720000
031900       WHEN SQLCODE = ZEROS                                       02730000
031910            ADD  1  TO  PV-TRK-FETCH-CNT                          02740000
032100       WHEN SQLCODE = +100                                        02750000
032200            SET PS-EOF-TRK-CSR  TO TRUE                           02760000
032300       WHEN SQLWARN0 NOT = SPACES                                 02770000
032400       WHEN SQLCODE < ZERO                                        02780000
032500       WHEN SQLCODE > ZERO                                        02790000
032600           MOVE '2200-FETCH-TRK-CSR'                              02800000
032700                               TO PV-PARAGRAPH-NAME               02810000
032800           MOVE 'FETCH TRK CURSOR '                               02820000
032900                               TO PV-DB2-OPERATION-ATTEMPTED      02830000
033000           PERFORM 9100-SQL-ABEND                                 02840000
033100     END-EVALUATE.                                                02850000
033200                                                                  02860000
033210                                                                  02870000
038500 2300-CLOSE-TRK-CSR.                                              02880000
038600     MOVE '2300-CLOSE-TRK-CSR'   TO PV-ABEND-PARAGRAPH.           02890000
038700                                                                  02900000
038900     EXEC SQL                                                     02910000
039000         CLOSE TRK-CSR                                            02920000
039100     END-EXEC.                                                    02930000
039700                                                                  02940000
039800     EVALUATE TRUE                                                02950000
039810         WHEN SQLCODE = ZERO                                      02960000
039900         WHEN SQLCODE = -904                                      02970000
040000         WHEN SQLCODE = -911                                      02980000
040100              CONTINUE                                            02990000
040200         WHEN SQLWARN0 NOT = SPACES                               03000000
040300         WHEN SQLCODE < ZERO                                      03010000
040400         WHEN SQLCODE > ZERO                                      03020000
040500              MOVE '2300-CLOSE-TRK-CSR'                           03030000
040600                              TO PV-PARAGRAPH-NAME                03040000
040700              MOVE 'CLOSE THE TRK-CSR              '              03050000
040800                              TO PV-DB2-OPERATION-ATTEMPTED       03060000
040900              PERFORM 9100-SQL-ABEND                              03070000
041200     END-EVALUATE.                                                03080000
041300                                                                  03090000
046865                                                                  04686400
046866 7000-GET-PURGE-WEEKS.                                            04686500
046867                                                                  04686600
046868     EXEC SQL                                                     04686700
046869         SELECT  FUNC_QTY                                         04686800
046873           INTO :DK-PURGE-WEEKS                                   04686900
046876           FROM TKRPRPM                                           04687000
046877          WHERE LOC_ID            =  90                           04687100
046878            AND INTFC_SYS_CDE     = 'KHL'                         04687200
046879            AND SYS_PRC_FUNC_CDE  = 'TKPURG'                      04687301
046880            AND FUNC_PRC_STAT_CDE = 'AC'                          04687400
046882     END-EXEC.                                                    04687500
046883                                                                  04687600
046884     EVALUATE TRUE                                                04687700
046885         WHEN SQLCODE = ZEROS                                     04687800
046886              MOVE  DK-PURGE-WEEKS  TO  PV-DISPLAY-PURGE-WEEKS    04687900
046887              PERFORM 7100-GET-PURGE-DATE                         04688000
046888         WHEN SQLCODE = +100                                      04688100
046889              CONTINUE                                            04688200
046890         WHEN SQLWARN0 NOT = SPACES                               04688300
046891         WHEN SQLCODE < ZERO                                      04688400
046892         WHEN SQLCODE > ZERO                                      04688500
046893             MOVE '7000-GET-PURGE-WEEKS'                          04688600
046894                             TO PV-PARAGRAPH-NAME                 04688700
046895             MOVE 'GET NUMBER OF WEEKS TO PURGE   '               04688800
046896                             TO PV-DB2-OPERATION-ATTEMPTED        04688900
046897             PERFORM 9100-SQL-ABEND                               04689000
046898     END-EVALUATE.                                                04689100
046899                                                                  04689200
046900                                                                  04689300
046910 7100-GET-PURGE-DATE.                                             04689400
046911                                                                  04689500
046920     EXEC SQL                                                     04689600
046930         SELECT  (CURRENT_DATE -                                  04689700
046960                  (:DK-PURGE-WEEKS * 7) DAYS)                     04689800
046970           INTO :PV-PURGE-DATE                                    04689900
046991           FROM TKRPRPM                                           04690000
046992          WHERE LOC_ID            =  90                           04691000
046993            AND INTFC_SYS_CDE     = 'KHL'                         04692000
046994            AND SYS_PRC_FUNC_CDE  = 'TKPURG'                      04693006
046995            AND FUNC_PRC_STAT_CDE = 'AC'                          04694000
046996     END-EXEC.                                                    04695000
046997                                                                  04696000
046998     EVALUATE TRUE                                                04697000
046999         WHEN SQLCODE = ZEROS                                     04698000
047000         WHEN SQLCODE = +100                                      04699000
047001              CONTINUE                                            04700000
047002         WHEN SQLWARN0 NOT = SPACES                               04700100
047003         WHEN SQLCODE < ZERO                                      04700200
047004         WHEN SQLCODE > ZERO                                      04700300
047005             MOVE '7100-GET-PURGE-DATE '                          04700400
047006                             TO PV-PARAGRAPH-NAME                 04700500
047007             MOVE 'CALCULATE PURGE DATE           '               04700600
047008                             TO PV-DB2-OPERATION-ATTEMPTED        04700700
047009             PERFORM 9100-SQL-ABEND                               04700800
047010     END-EVALUATE.                                                04700900
047020                                                                  04701000
047100                                                                  04702000
071800 8000-WRITE-EXTRACT-RECORD.                                       04703000
071900     WRITE SU-TRKG-EXTRACT-RECORD                                 04704003
072000       FROM SU115-EXTRACT-RECORD.                                 04705001
072400                                                                  04706000
073000                                                                  04707000
073100 9100-SQL-ABEND.                                                  04708000
073200******************************************************************04709000
073300*  PERFORMS THE ABEND FOR THE PROGRAM IN THE EVENT THAT AN SQL    04710000
073400*  ERROR OR WARNING CODE OCCURS.                                  04720000
073500******************************************************************04730000
073600     DISPLAY '9100-SQL-ABEND'.                                    04740000
073700     DISPLAY '** ABEND     **'.                                   04750000
073800     DISPLAY '** PROGRAM   ** = ' PC-CURRENT-PROGRAM-NAME.        04760000
073900     DISPLAY '** PARAGRAPH ** = ' PV-PARAGRAPH-NAME.              04770000
074000     DISPLAY '** OPERATION ** = ' PV-DB2-OPERATION-ATTEMPTED.     04780000
074100                                                                  04790000
074200******************************************************************04800000
074300* THIS COPY BOOK MEMBER CONTAINS THE PROCEDURE DIVISION STATE-    04810000
074400* MENTS THAT ARE REQUIRED TO UTILIZE THE DB2 ABEND MODULE         04820000
074500* 'DSNTIAR' AND CONVERT THE SQLCA INFORMATION INTO A READABLE     04830000
074600* FORMAT.                                                         04840000
074700******************************************************************04850000
074800     COPY DPPD004.                                                04860000
074900                                                                  04870000
075000     MOVE +4013                  TO ABEND-CODE.                   04880000
075100     CALL 'ILBOABN0' USING ABEND-CODE.                            04890000
075200                                                                  04900000
